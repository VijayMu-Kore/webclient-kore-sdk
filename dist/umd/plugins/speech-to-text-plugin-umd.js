!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.SpeechToTextPluginSDK=e():t.SpeechToTextPluginSDK=e()}(self,(function(){return(()=>{var t={50882:function(){function t(t,e,n,i,o){this.fromSampleRate=t,this.toSampleRate=e,this.channels=0|n,this.outputBufferSize=i,this.noReturn=!!o,this.initialize()}t.prototype.initialize=function(){if(!(this.fromSampleRate>0&&this.toSampleRate>0&&this.channels>0))throw new Error("Invalid settings specified for the resampler.");this.fromSampleRate==this.toSampleRate?(this.resampler=this.bypassResampler,this.ratioWeight=1):(this.compileInterpolationFunction(),this.resampler=this.interpolate,this.ratioWeight=this.fromSampleRate/this.toSampleRate,this.tailExists=!1,this.lastWeight=0,this.initializeBuffers())},t.prototype.compileInterpolationFunction=function(){for(var t="var bufferLength = Math.min(buffer.length, this.outputBufferSize);\tif ((bufferLength % "+this.channels+") == 0) {\t\tif (bufferLength > 0) {\t\t\tvar ratioWeight = this.ratioWeight;\t\t\tvar weight = 0;",e=0;e<this.channels;++e)t+="var output"+e+" = 0;";for(t+="var actualPosition = 0;\t\t\tvar amountToNext = 0;\t\t\tvar alreadyProcessedTail = !this.tailExists;\t\t\tthis.tailExists = false;\t\t\tvar outputBuffer = this.outputBuffer;\t\t\tvar outputOffset = 0;\t\t\tvar currentPosition = 0;\t\t\tdo {\t\t\t\tif (alreadyProcessedTail) {\t\t\t\t\tweight = ratioWeight;",e=0;e<this.channels;++e)t+="output"+e+" = 0;";for(t+="}\t\t\t\telse {\t\t\t\t\tweight = this.lastWeight;",e=0;e<this.channels;++e)t+="output"+e+" = this.lastOutput["+e+"];";for(t+="alreadyProcessedTail = true;\t\t\t\t}\t\t\t\twhile (weight > 0 && actualPosition < bufferLength) {\t\t\t\t\tamountToNext = 1 + actualPosition - currentPosition;\t\t\t\t\tif (weight >= amountToNext) {",e=0;e<this.channels;++e)t+="output"+e+" += buffer[actualPosition++] * amountToNext;";for(t+="currentPosition = actualPosition;\t\t\t\t\t\tweight -= amountToNext;\t\t\t\t\t}\t\t\t\t\telse {",e=0;e<this.channels;++e)t+="output"+e+" += buffer[actualPosition"+(e>0?" + "+e:"")+"] * weight;";for(t+="currentPosition += weight;\t\t\t\t\t\tweight = 0;\t\t\t\t\t\tbreak;\t\t\t\t\t}\t\t\t\t}\t\t\t\tif (weight == 0) {",e=0;e<this.channels;++e)t+="outputBuffer[outputOffset++] = output"+e+" / ratioWeight;";for(t+="}\t\t\t\telse {\t\t\t\t\tthis.lastWeight = weight;",e=0;e<this.channels;++e)t+="this.lastOutput["+e+"] = output"+e+";";t+='this.tailExists = true;\t\t\t\t\tbreak;\t\t\t\t}\t\t\t} while (actualPosition < bufferLength);\t\t\treturn this.bufferSlice(outputOffset);\t\t}\t\telse {\t\t\treturn (this.noReturn) ? 0 : [];\t\t}\t}\telse {\t\tthrow(new Error("Buffer was of incorrect sample length."));\t}',this.interpolate=Function("buffer",t)},t.prototype.bypassResampler=function(t){return this.noReturn?(this.outputBuffer=t,t.length):t},t.prototype.bufferSlice=function(t){if(this.noReturn)return t;try{return this.outputBuffer.subarray(0,t)}catch(e){try{return this.outputBuffer.length=t,this.outputBuffer}catch(e){return this.outputBuffer.slice(0,t)}}},t.prototype.initializeBuffers=function(t){try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(t){this.outputBuffer=[],this.lastOutput=[]}};var e,n,i=0,o=[];function r(t,e){for(var n=new Float32Array(e),i=0,o=0;o<t.length;o++)n.set(t[o],i),i+=t[o].length;return n}function s(t,e,n){for(var i=0;i<n.length;i++,e+=2){var o=Math.max(-1,Math.min(1,n[i]));t.setInt16(e,o<0?32768*o:32767*o,!0)}}function c(t,e,n){for(var i=0;i<n.length;i++)t.setUint8(e+i,n.charCodeAt(i))}function a(t){var e=new ArrayBuffer(2*t.length),n=new DataView(e);return s(n,0,t),n}this.onmessage=function(h){switch(h.data.command){case"init":u=h.data.config,e=u.sampleRate,n=new t(e,16e3,1,51200);break;case"record":l=h.data.buffer,o.push(l[0]),i+=l[0].length;break;case"exportWAV":!function(t){var n=(h=r(o,i),l=new ArrayBuffer(44+2*h.length),u=new DataView(l),c(u,0,"RIFF"),u.setUint32(4,32+2*h.length,!0),c(u,8,"WAVE"),c(u,12,"fmt "),u.setUint32(16,16,!0),u.setUint16(20,1,!0),u.setUint16(22,2,!0),u.setUint32(24,e,!0),u.setUint32(28,4*e,!0),u.setUint16(32,4,!0),u.setUint16(34,16,!0),c(u,36,"data"),u.setUint32(40,2*h.length,!0),s(u,44,h),u),a=new Blob([n],{type:t});var h,l,u;this.postMessage(a)}(h.data.type);break;case"exportRAW":!function(t){var e=a(r(o,i)),n=new Blob([e],{type:t});this.postMessage(n)}(h.data.type);break;case"export16kMono":!function(t){var e=r(o,i),s=a(n.resampler(e)),c=new Blob([s],{type:t});this.postMessage(c)}(h.data.type);break;case"getBuffer":!function(){var t=[];t.push(r(o,i)),this.postMessage(t)}();break;case"clear":i=0,o=[]}var l,u}}},e={};function n(i){var o=e[i];if(void 0!==o)return o.exports;var r=e[i]={exports:{}};return t[i].call(r.exports,r,r.exports,n),r.exports}n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var i={};return(()=>{"use strict";n.r(i),n.d(i,{SpeechToTextPlugin:()=>c});var t=n(50882);function e(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function o(t){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?e(Object(i),!0).forEach((function(e){s(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function r(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function s(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const c=function(){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"name","SpeechToTextPlugin"),s(this,"config",{isSpeechEnabled:!0,allowGoogleSpeech:!0}),s(this,"pickerHTML",void 0),s(this,"ttsAudioSource",null),s(this,"recognition",null),s(this,"isRecordingStarted",!1),s(this,"final_transcript",""),s(this,"recognizing",!1),s(this,"prevStr",""),s(this,"prevRange",void 0),s(this,"navigator",window.navigator),s(this,"isListening",!1),s(this,"mediaStream",void 0),s(this,"mediaStreamSource",void 0),s(this,"rec",void 0),s(this,"_connection",void 0),s(this,"intervalKey",void 0),s(this,"context",void 0),s(this,"_permission",!1),s(this,"sidToken",void 0),s(this,"two_line",/\n\n/g),s(this,"one_line",/\n/g),s(this,"speechPrefixURL",""),s(this,"userIdentity",void 0),s(this,"bearerToken",void 0),s(this,"assertionToken",void 0),t=t||{},this.config=o(o({},this.config),t)}var n,i,c;return n=e,(i=[{key:"onHostCreate",value:function(){var t=this,e=t.hostInstance;this.speechPrefixURL=t.hostInstance.config.botOptions.koreSpeechAPIUrl,this.userIdentity=t.hostInstance.config.botOptions.userIdentity,this.bearerToken=t.hostInstance.config.botOptions.bearer,e.on("viewInit",(function(e){t.onInit()}))}},{key:"onInit",value:function(){this.installSpeechToTextTemplate()}},{key:"appendPickerHTMLtoChatWindowFooter",value:function(t){this.hostInstance.chatEle.find(".kore-chat-footer .footerContainer").append(t)}},{key:"installSpeechToTextTemplate",value:function(){var t=this,e=t.hostInstance.$;t.pickerHTML=e(t.getSpeechToTextTemplateString()),t.appendPickerHTMLtoChatWindowFooter(t.pickerHTML),t.bindEvents()}},{key:"getSpeechToTextTemplateString",value:function(){return'<div class="sdkFooterIcon microphoneBtn">         <button class="notRecordingMicrophone" title="Microphone On">             <i class="microphone"></i>         </button>         <button class="recordingMicrophone" title="Microphone Off" >             <i class="microphone"></i>             <span class="recordingGif"></span>         </button>         <div id="textFromServer"></div>     </div>'}},{key:"bindEvents",value:function(){var t=this,e=t.hostInstance.$;e(t.pickerHTML).off("click",".notRecordingMicrophone").on("click",".notRecordingMicrophone",(function(e){this.ttsAudioSource&&this.ttsAudioSource.stop(),t.config.isSpeechEnabled&&t.getSIDToken()})),e(t.pickerHTML).off("click",".recordingMicrophone").on("click",".recordingMicrophone",(function(e){stop(),setTimeout((function(){t.setCaretEnd(document.getElementsByClassName("chatInputBox"))}),350)}))}},{key:"getSIDToken",value:function(){var t=this,e=t.hostInstance.$;if(this.userIdentity=t.hostInstance.config.botOptions.userIdentity,this.bearerToken=t.hostInstance.config.botOptions.bearer,t.getSpeechToText(),t.config.allowGoogleSpeech)this.recognition?t.startGoogleWebKitRecognization():t.micEnable();else{if(!this.speechPrefixURL)return console.warn("Please provide speech socket url"),!1;e.ajax({url:this.speechPrefixURL+"asr/wss/start?email="+this.userIdentity,type:"post",headers:{Authorization:this.bearerToken?this.bearerToken:this.assertionToken},dataType:"json",success:function(e){this.sidToken=e.link,t.micEnable()},error:function(t){console.log(t)}})}}},{key:"getSpeechToText",value:function(){var t=this,e=t.hostInstance.$;"webkitSpeechRecognition"in window&&t.isChrome()&&(this.recognition=new window.webkitSpeechRecognition,this.final_transcript="",this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.onstart=function(){this.prevStr="",this.recognizing=!0,e(".recordingMicrophone").css("display","block"),e(".notRecordingMicrophone").css("display","none")},this.recognition.onerror=function(t){console.log(t.error),e(".recordingMicrophone").trigger("click"),e(".recordingMicrophone").css("display","none"),e(".notRecordingMicrophone").css("display","block")},this.recognition.onend=function(){this.recognizing=!1,e(".recordingMicrophone").trigger("click"),e(".recordingMicrophone").css("display","none"),e(".notRecordingMicrophone").css("display","block")},this.recognition.onresult=function(n){this.final_transcript="";for(var i="",o=n.resultIndex;o<n.results.length;++o)n.results[o].isFinal?this.final_transcript+=n.results[o][0].transcript:i+=n.results[o][0].transcript;this.final_transcript=t.capitalize(this.final_transcript),this.final_transcript=t.linebreak(this.final_transcript),i=t.linebreak(i),""!==this.final_transcript&&(this.prevStr+=this.final_transcript),this.recognizing&&(e(".chatInputBox").html(this.prevStr+""+i),e(".sendButton").removeClass("disabled")),setTimeout((function(){t.setCaretEnd(document.getElementsByClassName("chatInputBox")),document.getElementsByClassName("chatInputBox")[0].scrollTop=document.getElementsByClassName("chatInputBox")[0].scrollHeight}),350)})}},{key:"startGoogleWebKitRecognization",value:function(){this.recognizing?this.recognition.stop():(this.final_transcript="",this.recognition.lang="en-US",this.recognition.start())}},{key:"micEnable",value:function(){this.isRecordingStarted||(navigator.getUserMedia||(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),navigator.getUserMedia?(this.isRecordingStarted=!0,navigator.getUserMedia({audio:!0},this.success,(function(t){this.isRecordingStarted=!1,alert("Please enable the microphone permission for this page")}))):(this.isRecordingStarted=!1,alert("getUserMedia is not supported in this browser.")))}},{key:"setCaretEnd",value:function(t){if(t&&t.item(0)&&t.item(0).innerText.length){var e=document.createRange();e.selectNodeContents(t[0]),e.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(e),this.prevRange=e}else this.prevRange=!1,t&&t[0]&&t[0].focus()}},{key:"isChrome",value:function(){var t=window.chrome,e=window.navigator,n=e.vendor,i=e.userAgent.indexOf("OPR")>-1,o=e.userAgent.indexOf("Edge")>-1;return!!e.userAgent.match("CriOS")||null!=t&&"Google Inc."===n&&!1===i&&!1===o}},{key:"success",value:function(e){if(this.isListening=!0,this.mediaStream=e,!this.context){var n=window.AudioContext||window.webkitAudioContext;this.context=new n}this.mediaStreamSource=this.context.createMediaStreamSource(this.mediaStream),window.userSpeechAnalyser=this.context.createAnalyser(),this.mediaStreamSource.connect(window.userSpeechAnalyser),console.log("Mediastream created"),this._connection&&(this._connection.close(),this._connection=null),this.rec&&(this.rec.stop(),this.rec.clear(),this.rec=null),this.rec=new Recorder(this.mediaStreamSource,{workerPath:t}),console.log("Recorder Initialized"),this._permission=!0,me.config.allowGoogleSpeech?me.startGoogleSpeech():me.afterMicEnable(),setTimeout((function(){me.setCaretEnd(document.getElementsByClassName("chatInputBox"))}),600)}},{key:"startGoogleSpeech",value:function(){this.rec&&(this.rec.record(),$(".recordingMicrophone").css("display","block"),$(".notRecordingMicrophone").css("display","none"),console.log("recording..."),this.intervalKey=setInterval((function(){this.rec.export16kMono((function(t){console.log(new Date),me.config.allowGoogleSpeech?sendBlobToSpeech(t,"LINEAR16",16e3):socketSend(t),this.rec.clear()}),"audio/x-raw")}),1e3))}},{key:"afterMicEnable",value:function(){if(navigator.getUserMedia){if(!this.rec)return this.isRecordingStarted=!1,void console.error("Recorder undefined");this._connection&&this.cancel();try{this._connection=this.createSocket()}catch(t){this.isRecordingStarted=!1,console.log(t),console.error("Web socket not supported in the browser")}}}},{key:"cancel",value:function(){var t=me.hostInstance.$;this.isRecordingStarted=!1,t(".recordingMicrophone")&&t(".recordingMicrophone").css("display","none"),t(".notRecordingMicrophone")&&t(".notRecordingMicrophone").css("display","block"),null!==this.mediaStream&&this.mediaStream&&this.mediaStream.getTracks()[0].enabled&&this.mediaStream.getTracks()[0].stop(),this._connection&&(this._connection.close(),this._connection=null),this.rec&&(this.rec.stop(),this.rec.clear()),this.sidToken=""}},{key:"socketSend",value:function(t){if(this._connection){var e=this._connection.readyState;1===e?t instanceof Blob?t.size>0&&this._connection.send(t):(console.log(t),this._connection.send(t)):(this.isRecordingStarted=!1,console.error("Web Socket readyState != 1: ",e,"failed to send :"+t.type+", "+t.size),this.cancel())}else this.isRecordingStarted=!1,console.error("No web socket connection: failed to send: ",t)}},{key:"linebreak",value:function(t){return t.replace(this.two_line,"<p></p>").replace(this.one_line,"<br>")}},{key:"capitalize",value:function(t){return t.replace(t.substr(0,1),(function(t){return t.toUpperCase()}))}},{key:"createSocket",value:function(){window.ENABLE_MICROPHONE=!0,window.SPEECH_SERVER_SOCKET_URL=this.sidToken;var t=window.SPEECH_SERVER_SOCKET_URL,e=this.userIdentity;window.WebSocket=window.WebSocket||window.MozWebSocket;var n=t+"&"+CONTENT_TYPE+"&email="+e,i=new WebSocket(n);return i.onopen=function(t){var e=this.hostInstance.$;console.log("User connected"),_user_connection=!0,this.rec.record(),e(".recordingMicrophone").css("display","block"),e(".notRecordingMicrophone").css("display","none"),console.log("recording..."),this.prevStr="",this.intervalKey=setInterval((function(){this.rec.export16kMono((function(t){socketSend(t),this.rec.clear()}),"audio/x-raw")}),INTERVAL)},i.onmessage=function(t){var e=this,n=e.hostInstance.$,i=t.data,o="";if(i instanceof Object&&!(i instanceof Blob))console.log("Got object that is not a blob");else if(i instanceof Blob)console.log("Got Blob");else{var r=JSON.parse(i);this.isListening&&0===r.status?(o=r.result.hypotheses[0].transcript,r.result.final&&(this.prevStr+=r.result.hypotheses[0].transcript+" ",o=""),console.log("Interm: ",o),console.log("final: ",this.prevStr),n(".chatInputBox").html(this.prevStr+""+o),setTimeout((function(){e.setCaretEnd(document.getElementsByClassName("chatInputBox")),document.getElementsByClassName("chatInputBox")[0].scrollTop=document.getElementsByClassName("chatInputBox")[0].scrollHeight}),350)):console.log("Server error : ",r.status)}},i.onclose=function(t){var e=this,n=e.hostInstance.$;""!==n(".chatInputBox").text()&&e.hostInstance.config.autoEnableSpeechAndTTS&&window.chatContainerConfig.sendMessage(n(".chatInputBox")),this.isRecordingStarted=!1,console.log("Server is closed"),console.log(t),e.cancel()},i.onerror=function(t){console.log("Error : ",t)},i}},{key:"stop",value:function(){var t=this.hostInstance.$;""!==t(".chatInputBox").text()&&this.hostInstance.config.autoEnableSpeechAndTTS&&window.chatContainerConfig.sendMessage(t(".chatInputBox")),t(".recordingMicrophone").css("display","none"),t(".notRecordingMicrophone").css("display","block"),this.rec?(this.rec.stop(),this.isListening=!1,console.log("stopped recording.."),setTimeout((function(){this._connection&&(this._connection.close(),this._connection=null)}),1e3),this.rec.export16kMono((function(t){socketSend(t),this.rec.clear(),this._connection&&this._connection.close(),this.mediaStream.getTracks()[0].stop(),this.rec.destroy(),this.isRecordingStarted=!1}),"audio/x-raw")):console.error("Recorder undefined"),this.recognizing&&(this.recognition.stop(),this.recognizing=!1)}}])&&r(n.prototype,i),c&&r(n,c),e}()})(),i})()}));