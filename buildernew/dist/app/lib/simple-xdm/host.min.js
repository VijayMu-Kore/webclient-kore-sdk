!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,(n.host||(n.host={})).min=e()}}(function(){return function e(n,t,i){function r(s,a){if(!t[s]){if(!n[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=t[s]={exports:{}};n[s][0].call(l.exports,function(e){var t=n[s][1][e];return r(t?t:e)},l,l.exports,e,n,t,i)}return t[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(e,n,t){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),s=e("./xdmrpc"),a=i(s),u=e("../common/util"),c=i(u),l=function(){function e(){r(this,e),this._xdm=new a["default"]}return o(e,[{key:"dispatch",value:function(e,n,t,i){return this._xdm.queueEvent(e,n,t,i),this.getExtensions(n)}},{key:"_createId",value:function(e){if(!e.addon_key||!e.key)throw Error("Extensions require addon_key and key");return e.addon_key+"__"+e.key+"__"+c["default"].randomString()}},{key:"create",value:function(e,n){var t=this.registerExtension(e,n),i={extension_id:t,api:this._xdm.getApiSpec(),origin:window.location.origin};return{id:t,name:JSON.stringify(i),src:e.url}}},{key:"registerExtension",value:function(e,n){var t=this._createId(e);return this._xdm.registerExtension(t,{extension:e,initCallback:n}),t}},{key:"defineModule",value:function(e,n){this._xdm.defineAPIModule(n,e)}},{key:"defineGlobals",value:function(e){this._xdm.defineAPIModule(e)}},{key:"getExtensions",value:function(e){return this._xdm.getRegisteredExtensions(e)}},{key:"unregisterExtension",value:function(e){return this._xdm.unregisterExtension(e)}}]),e}();n.exports=new l},{"../common/util":3,"./xdmrpc":4}],2:[function(e,n,t){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),s=e("./util"),a=i(s),u=function(){function e(n){r(this,e);var t=n||{};this._registerListener(t.listenOn)}return o(e,[{key:"_registerListener",value:function(e){e&&e.addEventListener||(e=window),e.addEventListener("message",a["default"]._bind(this,this._receiveMessage),!1)}},{key:"_receiveMessage",value:function(e){var n=e.data.eid,t=void 0;if(n&&this._registeredExtensions&&(t=this._registeredExtensions[n]),!this._checkOrigin(e,t))return!1;var i=this._messageHandlers[e.data.type];i&&i.call(this,e,t)}}]),e}();n.exports=u},{"./util":3}],3:[function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),o="[Simple-XDM] ",s=function(){function e(){i(this,e)}return r(e,[{key:"randomString",value:function(){return Math.floor(1e9*Math.random()).toString(16)}},{key:"isString",value:function(e){return"string"==typeof e||e instanceof String}},{key:"argumentsToArray",value:function(e){for(var n=[],t=0;t<e.length;t++)n.push(e[t]);return n}},{key:"hasCallback",value:function(e){var n=e.length;return n>0&&"function"==typeof e[n-1]}},{key:"error",value:function(e){window.console&&console.error(o+e)}},{key:"warn",value:function(e){window.console&&console.warn(o+e)}},{key:"_bind",value:function(e,n){return Function.prototype.bind?n.bind(e):function(){return n.apply(e,arguments)}}},{key:"each",value:function(e,n){var t,i;if(e)if(t=e.length,null!=t&&"function"!=typeof e)for(i=0;t>i&&n.call(e[i],i,e[i])!==!1;)i+=1;else for(i in e)if(e.hasOwnProperty(i)&&n.call(e[i],i,e[i])===!1)break}},{key:"extend",value:function(e){var n=arguments,t=[].slice.call(n,1,n.length);return t.forEach(function(n){Object.getOwnPropertyNames(n).forEach(function(t){e[t]=n[t]})}),e}}]),e}();n.exports=new s},{}],4:[function(e,n,t){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function o(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),a=function(e,n,t){for(var i=!0;i;){var r=e,o=n,s=t;a=c=u=void 0,i=!1,null===r&&(r=Function.prototype);var a=Object.getOwnPropertyDescriptor(r,o);if(void 0!==a){if("value"in a)return a.value;var u=a.get;return void 0===u?void 0:u.call(s)}var c=Object.getPrototypeOf(r);if(null===c)return void 0;e=c,n=o,t=s,i=!0}},u=e("../common/util"),c=i(u),l=e("../common/postmessage"),d=i(l),f=3e4,g=function(e){function n(e){r(this,n),e=e||{},a(Object.getPrototypeOf(n.prototype),"constructor",this).call(this,e),this._registeredExtensions=e.extensions||{},this._registeredAPIModules={},this._pendingCallbacks={},this._pendingEvents={},this._messageHandlers={init:this._handleInit,req:this._handleRequest,resp:this._handleResponse,event_query:this._handleEventQuery,broadcast:this._handleBroadcast}}return o(n,e),s(n,[{key:"_handleInit",value:function(e,n){this._registeredExtensions[n.extension_id].source=e.source,n.initCallback&&(n.initCallback(e.data.eid),delete n.initCallback)}},{key:"_handleResponse",value:function(e){var n=e.data,t=this._pendingCallbacks[n.mid];t&&(delete this._pendingCallbacks[n.mid],t.apply(window,n.args))}},{key:"_handleRequest",value:function(e,n){function t(){var t=c["default"].argumentsToArray(arguments);e.source.postMessage({mid:e.data.mid,type:"resp",args:t},n.extension.url)}var i=e.data,r=this._registeredAPIModules[i.mod];if(r){var o=r[i.fn];if(o){var s=i.args;t._context=this.getRegisteredExtensions(n.extension)[0],s.push(t),o.apply(r,s)}}}},{key:"_handleBroadcast",value:function(e,n){var t=e.data,i=function(e){return e.extension.addon_key===n.extension.addon_key&&e.extension_id!==n.extension_id};this.dispatch(t.etyp,i,t.evnt,null,null)}},{key:"defineAPIModule",value:function(e,n){return n||(this._registeredAPIModules._globals=e),this._registeredAPIModules[n]=e,this._registeredAPIModules}},{key:"_fullKey",value:function(e){var n=e.addon_key||"global";return e.key&&(n=n+"@@"+e.key),n}},{key:"queueEvent",value:function(e,n,t,i){var r,o=this._findRegistrations(n);r=o.some(function(e){return void 0!==e.registered_events},this),r?this.dispatch(e,n,t,i):this._pendingEvents[this._fullKey(n)]={type:e,targetSpec:n,event:t,callback:i,time:(new Date).getTime(),uid:c["default"].randomString()}}},{key:"_handleEventQuery",value:function(e,n){var t=this,i={},r=(new Date).getTime(),o=Object.keys(this._pendingEvents);return o.forEach(function(o){var s=t._pendingEvents[o];r-s.time<=f&&(i[o]=s,s.targetSpec.addon_key=n.extension.addon_key,s.targetSpec.key=n.extension.key,t.dispatch(s.type,s.targetSpec,s.event,s.callback,e.source)),delete t._pendingEvents[o]}),this._registeredExtensions[n.extension_id].registered_events=e.data.args,i}},{key:"dispatch",value:function(e,n,t,i,r){function o(n,t){if(!n.source)throw"Cannot send post message without a source";var r;i&&(r=c["default"].randomString(),this._pendingCallbacks[r]=i),n.source.postMessage({type:"evt",mid:r,etyp:e,evnt:t},n.extension.url)}var s=this._findRegistrations(n||{});s.forEach(function(e){r&&(e.source=r),c["default"]._bind(this,o)(e,t)},this)}},{key:"_findRegistrations",value:function(e){var n=this;if(0===this._registeredExtensions.length)return c["default"].error("no registered extensions",this._registeredExtensions),[];var t=Object.getOwnPropertyNames(e),i=Object.getOwnPropertyNames(this._registeredExtensions).map(function(e){return n._registeredExtensions[e]});return e instanceof Function?i.filter(e):i.filter(function(n){return t.every(function(t){return n.extension[t]===e[t]})})}},{key:"registerExtension",value:function(e,n){if(n.extension.addon_key&&n.extension.key){var t=this._findRegistrations({addon_key:n.extension.addon_key,key:n.extension.key});0!==t.length&&delete this._registeredExtensions[t[0].extension_id]}n.extension_id=e,this._registeredExtensions[e]=n}},{key:"getApiSpec",value:function(){function e(e){var t=n._registeredAPIModules[e];if(!t)throw new Error("unregistered API module: "+e);return Object.getOwnPropertyNames(t).reduce(function(e,n){return"function"==typeof t[n]&&(e[n]={}),e},{})}var n=this;return Object.getOwnPropertyNames(this._registeredAPIModules).reduce(function(n,t){return n[t]=e(t),n},{})}},{key:"_checkOrigin",value:function(e,n){var t=["init","event_query"],i=n&&!n.source&&t.indexOf(e.data.type)>-1,r=n&&e.source===n.source,o=n&&0===n.extension.url.indexOf(e.origin),s=o&&(i||r);return s||c["default"].warn("Failed to validate origin: "+e.origin),s}},{key:"getRegisteredExtensions",value:function(e){return e?this._findRegistrations(e):this._registeredExtensions}},{key:"unregisterExtension",value:function(e){var n=this._findRegistrations(e);0!==n.length&&n.forEach(function(e){delete this._registeredExtensions[e.extension_id]},this)}}]),n}(d["default"]);n.exports=g},{"../common/postmessage":2,"../common/util":3}]},{},[1])(1)});