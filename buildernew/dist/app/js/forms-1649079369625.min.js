/* minification dated 2022-04-04 */
!function(ng){"use strict";var _module=ng.module("bt-forms",["uuid4","app.helpers","services","bt-components","ngAnimate"]);_module.filter("sentence_case",function(){return _.memoize(function(x){var capitalize,fmt;if(ng.isString(x))return x=x.toLowerCase(),capitalize=function(str){return str+="",str.charAt(0).toUpperCase()+str.slice(1)},fmt=function(y){var capitalized;return capitalized=capitalize($.trim(y))},x=_.map(x.split("."),function(z){return fmt(z)}).join(". "),x=_.map(x.split("!"),function(z){return fmt(z)}).join("! "),x=_.map(x.split(","),function(z){return z}).join(", ")})}),_module.filter("replaceHtmlString",function(){return function(input){input=input||"";var out="";return out=input.replace(/&lt;/g,"<"),out=out.replace(/&gt;/g,">")}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.controller("BTAccountSetupCtrl",["$scope","$applicationService","$modal","security","mixPanel",function($scope,$applicationService,$modal,security,mixPanel){var userInfo={$email:$applicationService.userInfo().emailPhone,FirstName:$applicationService.userInfo().firstName,LastName:$applicationService.userInfo().lastName,Category:"Onboarding",SubCategory:"Join Existing Account","Event Description":"User is presented with the option to either create own account or join any of the existing accounts that match user's email domain"};mixPanel.postEvent("Join Existing Accounts Flow Started",userInfo),$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/join-accounts/join-accounts.html",controller:"joinAccountsCtrl",backdrop:"static",keyboard:!1,windowClass:"bt-account-setup-modal"}),$scope.$on("$destroy",function(){security.logout()})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("alertFieldForm",function(){return{restrict:"AE",scope:{mode:"@",onCancel:"&",onSave:"&",wfType:"@",setFieldData:"=",taskId:"=",nested:"=",view:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/alert-field-form/alert-field-form.html",controller:"alertFieldFormCtrl"}}),_module.directive("alertFieldModalForm",function(){return{restrict:"AE",scope:{mode:"@",onCancel:"&",onSave:"&",wfType:"@",isReport:"@",setFieldData:"=",taskId:"=",nested:"=",view:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/alert-field-form/alert-field-modal-form.html",controller:"alertFieldFormCtrl"}}),_module.controller("alertFieldFormCtrl",["$scope","form_util","patternFactory","$rootScope","urlutil","$filter","BTIdpService","NotificationService","$workflowService","$timeout","$translator","$q","BTStreamsService","$util","env_conf","i18n",function($scope,form_util,patternFactory,$rootScope,urlutil,$filter,BTIdpService,NotificationService,$workflowService,$timeout,$translator,$q,BTStreamsService,$util,env_conf,i18n){function getSelectedId(){$.map($scope.values,function(item,key){item.fieldName===$scope.fieldData.getFromSession.key&&item.context===$scope.fieldData.getFromSession.context&&($scope.fieldData.selectedId=key,$scope.showContextFields=!1)}),""===$scope.fieldData.selectedId&&$scope.fieldData.getFromSession&&$scope.fieldData.getFromSession.key&&$scope.fieldData.getFromSession.context&&($scope.showContextFields=!0,$scope.fieldData.selectedId=$scope.values.length-1),$scope.fieldData.actionFieldType||($scope.fieldData.actionFieldType="payloadfield",$scope.form.actionFieldType=!0)}function getSessions(){$scope.values=[],BTStreamsService.getSessions($scope.streamId).then(function(res){$.map(res.data,function(item,key){"UserContext"!==key&&$scope.contexts.push(key),$.each(item,function(index,value){var object={fieldName:value,context:key,label:value+" ( "+key+" )"};$scope.values.push(object)})}),getSelectedId(),$scope.values.push({fieldName:i18n.i18nString("field_name"),label:i18n.i18nString("label"),context:null})},function(err){$scope.values.push({fieldName:"add new",label:i18n.i18nString("label"),context:null})})}function getAlertObject(){var alrtobj={};switch(alrtobj.actionFieldType=$scope.fieldData.actionFieldType,alrtobj.title=$scope.fieldData.name,alrtobj.description=$scope.fieldData.description,alrtobj.key=$scope.fieldData.key,alrtobj.help=$scope.fieldData.help,$scope.fieldData.getFromSession.enabled?alrtobj.getFromSession=$scope.fieldData.getFromSession:(alrtobj.getFromSession={},alrtobj.getFromSession.enabled=!1),$scope.fieldData.dependsOn?alrtobj.dependsOn=$scope.fieldData.dependsOn.split(","):alrtobj.dependsOn=[],$scope.fieldData.visibility&&(alrtobj.visibility=$scope.fieldData.visibility),$scope.fieldData.mapping&&(alrtobj.mapping=$scope.fieldData.mapping),alrtobj.isRequired=$scope.fieldData.isRequired,alrtobj.isSearchable=$scope.fieldData.isSearchable,alrtobj.isMultiSelect=$scope.fieldData.isMultiSelect,_.addProps(!$scope.fieldData.untranspose,alrtobj,{transpose:!1}),alrtobj.metadata=$scope.fieldData.metadata,$scope.fieldData.datatype&&(alrtobj.type=$scope.fieldData.datatype.value),alrtobj.arrayElementType=$scope.fieldData.arrayElementType&&$scope.fieldData.arrayElementType.value,$scope.fieldData.fieldtype.value){case"textbox":case"url":case"textarea":case"email":alrtobj.placeholder=$scope.fieldData.textplaceholder,alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"file":alrtobj.placeholder=$scope.fieldData.textplaceholder,alrtobj.fieldType=$scope.fieldData.fieldtype.value,alrtobj.fileMeta=$scope.fieldData.fileMeta,alrtobj.allowMultiple=$scope.fieldData.allowMultiple;break;case"timezone":alrtobj.placeholder=$scope.fieldData.textplaceholder,alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"staticDropDown":case"staticDropdownCB":alrtobj.staticDropDownFields=jsonHelper($scope.fieldData.staticDropDownFields,alrtobj.type),alrtobj.fieldType=$scope.fieldData.fieldtype.value,alrtobj.value=$scope.fieldData.value;break;case"checkbox":alrtobj.checkbox=jsonHelper($scope.fieldData.staticDropDownFields,alrtobj.type),alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"password":alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"label":case"location":alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"date":case"datetime":alrtobj.fieldType=$scope.fieldData.fieldtype.value,alrtobj.placeholder=$scope.fieldData.textplaceholder,alrtobj.format=$scope.fieldData.format;break;case"nestedform":alrtobj.fieldType=$scope.fieldData.fieldtype.value,alrtobj.fields=$scope.fieldData.fields;break;case"search":case"directory":case"typeahead":case"dynamicDropDown":case"dynamicDropDownCB":var uriParser=window.URI,components=uriParser.parse($scope.fieldData.dynamicDropDownURL),rcEndpoint={host:components.host,port:components.port?components.port+"":components.port,path:components.path,protocol:components.scheme,"content-type":$scope.fieldData.dynamicDropDownContentType.value,method:$scope.fieldData.dynamicDropDownMethod,connectorEnabled:$scope.fieldData.dynamicDropdownConnectorEnabled};components.query&&(rcEndpoint.path+="?"+components.query),components.fragment&&(rcEndpoint.path+="#"+components.fragment),"boolean"===alrtobj.type&&($scope.fieldData.dynamicDropDownValueKey=$scope.fieldData.dynamicDropDownValueKey.split(",").map(function(value){return isTrueType(value)}).join(",")),alrtobj.dynamicDropDownInfo={endPoint:rcEndpoint,keyForLabel:$scope.fieldData.dynamicDropDownLabelKey,keyForValue:$scope.fieldData.dynamicDropDownValueKey,responsePath:$scope.fieldData.dynamicDropDownPath,payloadFields:$scope.fieldData.dynamicDropDownPayloadFields},alrtobj.editable=$scope.fieldData.editable,alrtobj.fieldType=$scope.fieldData.fieldtype.value}return alrtobj}function makeItClean(){var form=$scope.alertFieldsForm;for(var key in form)form.hasOwnProperty(key)&&"object"==typeof form[key]&&0!==key.indexOf("$")&&0!==key.indexOf("$$")&&(form[key].$dirty=!1);$scope.alertFieldsForm.__$invalid=!1,$scope.hideAdvancedOptions()}function jsonHelper(options,type){return options.map(function(option){switch(type){case"number":option.value=parseFloat(option.value);break;case"string":option.value=option.value+"";break;case"boolean":option.value=isTrueType(option.value)}return option})}function isTrueType(value){for(var values=["false",!1,0,"0","no","No","NO","False","FALSE"],i=0;i<values.length;i++)if(value===values[i])return!1;return!0}var _fieldData=$workflowService.seedData().fieldsData;$scope.isApplicable=!1,$scope.nestedFormField={},$scope.streamId=$workflowService.selectedStream()._id,$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.connectors=[]||$workflowService.botConnectors(),$scope.fieldData={},$scope.fieldData.selectedId="",$scope.form={},$scope.form.actionFieldType=!0,$scope.viewTask=i18n.i18nString("view_task_params"),$scope.setupTask=i18n.i18nString("setup_task_params"),$scope.fieldData.actionFieldType="payloadfield",$scope.showContextFields=!1,$scope.contexts=[],$scope.values=[],$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.promptMessageDescription=$rootScope.getSanitizedText($rootScope.lableData.bb516),getSessions(),$scope.formats={"dd-MM-yyyy":"dd-MM-YYYY","MM-dd-yyyy":"MM-dd-YYYY","dd-MM-yy":"dd-MM-YY","yyyy-MM-dd":"YYYY-MM-dd"},$scope.supportedDateFormats=["yyyy","yy","y","MMMM","MMM","MM","M","dd","d","EEEE","EEE","HH","H","hh","h","mm","m","ss","s","sss","a","Z","ww","w","G","GG","GGG","GGGG","ddThh","ssZ"],$scope.dateFormatSplitter=/[- :\/+T]/,$scope.validateDateFormat=function(typeOfFormat){var dateFormatArray=typeOfFormat.split($scope.dateFormatSplitter),isFormatExist=!0;return $.each(dateFormatArray,function(i,literal){return-1===$.inArray(literal,$scope.supportedDateFormats)?(isFormatExist=!1,!1):void 0}),isFormatExist},$scope.validateParamName=function(){var regexpObject=patternFactory.getRegularExpression("parameter"),regexp=regexpObject.regexp;return{test:function(value){return regexp.test(value)}}}(),$scope.keyvalueform={key:i18n.i18nString("keyvalueform_key"),value:i18n.i18nString("keyvalueform_value"),keyErrorMsg:i18n.i18nString("keyvalueform_keyErrorMsg"),valueErrorMsg:i18n.i18nString("keyvalueform_valueErrorMsg"),btnLabel:i18n.i18nString("keyvalueform_btnLabel"),btnText:i18n.i18nString("keyvalueform_btnText")},$scope.payloadfieldsform={key:i18n.i18nString("payloadfieldsform_key"),value:i18n.i18nString("payloadfieldform_value"),keyErrorMsg:i18n.i18nString("payloadfieldform_keyErrorMsg"),valueErrorMsg:i18n.i18nString("payloadfieldform_valueErrorMsg"),btnLabel:i18n.i18nString("payloadfieldform_btnLabel"),btnText:i18n.i18nString("payloadfieldform_btnText")},$scope._constants_=$rootScope._constants_,$scope.supportedDataTypes=_fieldData.dataType,$scope.supportedFilteredDataTypes=_.filter($scope.supportedDataTypes,function(datatype){return"Object"!==datatype.name}),$scope.supportedFieldTypes=_fieldData.fieldType,$scope.dynamicDropDownContentTypes=_fieldData.contentTypes=$workflowService.seedData().contentTypes,$scope.showTypeahead=!1,$scope.currentIdp={},$scope.testFormApi={},$scope.testingInProgress=!1,$scope.$watch("setFieldData",function(newVal,oldVal){if($(".modalPerfectScroll").scrollTop(0),$scope.fieldData={},$scope.fieldData.selectedId="",$scope.alertFieldsForm.__$invalid=!1,newVal&&newVal.getFromSession?$scope.fieldData.getFromSession=newVal.getFromSession:($scope.fieldData.getFromSession={},$scope.fieldData.getFromSession.enabled=!1),getSelectedId(),newVal&&newVal.fieldType)switch($scope.fieldData.fieldtype=$filter("filter")(_fieldData.fieldType,{value:newVal.fieldType})[0],"action"===$scope.wfType&&($scope.fieldData.actionFieldType=newVal.actionFieldType,"payloadfield"===$scope.fieldData.actionFieldType?$scope.form.actionFieldType=!0:$scope.form.actionFieldType=!1),$scope.fieldData.name=newVal.title,$scope.fieldData.key=newVal.key,$scope.fieldData.help=newVal.help,newVal.dependsOn&&($scope.fieldData.dependsOn=newVal.dependsOn.join()),newVal.visibility&&($scope.fieldData.visibility=newVal.visibility),newVal.mapping&&($scope.fieldData.mapping=newVal.mapping),$scope.fieldData.isRequired=newVal.isRequired,$scope.fieldData.isSearchable=newVal.isSearchable,$scope.fieldData.isMultiSelect=newVal.isMultiSelect,$scope.fieldData.untranspose=_.isUndefined(newVal.transpose)?!0:newVal.transpose,$scope.fieldData.metadata=newVal.metadata,newVal.type&&($scope.fieldData.datatype=$filter("filter")(_fieldData.dataType,{value:newVal.type})[0]),newVal.arrayElementType&&$timeout(function(){$scope.fieldData.arrayElementType=$filter("filter")(_fieldData.dataType,{value:newVal.arrayElementType})[0]},200),newVal.fieldType){case"textbox":case"textarea":case"url":case"email":case"file":$scope.fieldData.textplaceholder=newVal.placeholder,$scope.fieldData.fileMeta=newVal.fileMeta,$scope.fieldData.allowMultiple=newVal.allowMultiple;break;case"timezone":$scope.fieldData.textplaceholder=newVal.placeholder;break;case"datetime":case"date":$scope.fieldData.format=newVal.format,$scope.showDateField=_.indexOf(Object.keys($scope.formats),newVal.format)<0,$scope.fieldData.textplaceholder=newVal.placeholder;break;case"staticDropDown":case"staticDropdownCB":$scope.fieldData.staticDropDownFields=newVal.staticDropDownFields,$scope.fieldData.value=newVal.value;break;case"checkbox":$scope.fieldData.staticDropDownFields=newVal.checkbox;break;case"nestedform":$scope.fieldData.fields=newVal.fields;break;case"search":case"directory":case"typeahead":case"dynamicDropDown":case"dynamicDropDownCB":$scope.isApplicable=!0;var endPoint=newVal.dynamicDropDownInfo.endPoint,endPointUrl=(window.URI,urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":endPoint.port,protocol:endPoint.protocol}));$scope.fieldData.editable=newVal.editable,$scope.fieldData.dynamicDropDownURL=endPointUrl,$scope.fieldData.dynamicDropDownContentType=$filter("filter")(_fieldData.contentTypes,{value:newVal.dynamicDropDownInfo.endPoint["content-type"]})[0],$scope.fieldData.dynamicDropDownMethod=newVal.dynamicDropDownInfo.endPoint.method,$scope.fieldData.dynamicDropdownConnectorEnabled=newVal.dynamicDropDownInfo.endPoint.connectorEnabled,$scope.fieldData.dynamicDropDownLabelKey=newVal.dynamicDropDownInfo.keyForLabel,$scope.fieldData.dynamicDropDownValueKey=newVal.dynamicDropDownInfo.keyForValue,$scope.fieldData.dynamicDropDownPath=newVal.dynamicDropDownInfo.responsePath,$scope.fieldData.dynamicDropDownPayloadFields=newVal.dynamicDropDownInfo.payloadFields;break;default:$scope.isApplicable=!1}}),$scope.typeaheadDataProvider=$workflowService.sampleResponseKeys(),$scope.getFieldKey=function(data){$scope.fieldData.key=data.typeaheadOutput.name||data.typeaheadOutput,$scope.showTypeahead=!1},$scope.populateFieldDataTypes=function(val){$.each($scope._constants_.entityNlpFieldDataTypes,function(k,nlp){nlp.value===val&&($scope.fieldData.fieldtype||($scope.fieldData.fieldtype=$filter("filter")($scope.supportedFieldTypes,{value:nlp.fieldType})[0]),$scope.fieldData.datatype||($scope.fieldData.datatype=$filter("filter")($scope.supportedDataTypes,{value:nlp.dataType})[0]))})},$scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options"),$scope.showAdvancedOptions=function(){$scope.showadvancedoptions?($scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options"),$("#advancedoptdiv .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showadvancedoptions=!0,$scope.advancedoptiontext=i18n.i18nString("hide_advanced_options"),$("#advancedoptdiv .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down")),setTimeout(function(){PerfectScrollbar.update($(".alertFieldFormScroll")[0])},500)},$scope.hideAdvancedOptions=function(){$scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options"),$("#advancedoptdiv .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")},$scope.showDateTextField=function(format){return"_new_"===format?($scope.showDateField=!0,$scope.fieldData.format="",$scope.fieldData.dateFormat="",void($scope.dateFormat="")):void($scope.fieldData.format=format)},$scope.hideDateTextField=function(){$scope.showDateField=!1,$scope.fieldData.format="",$scope.fieldData.dateFormat="",$scope.dateFormat="",$("#alertFieldsFormDateTimeSelect").val("")},$scope.clearContext=function(){$scope.fieldData.getFromSession.context=null},$scope.$watch("fieldData.selectedId",function(newValue,oldValue){if($scope.fieldData.getFromSession||($scope.fieldData.getFromSession={}),$scope.values[newValue]){if(!$scope.values[newValue].context&&!$scope.showContextFields)return $scope.showContextFields=!0,$scope.fieldData.getFromSession.key="",void($scope.fieldData.getFromSession.context="");$scope.values[newValue].context&&($scope.showContextFields=!1,$scope.fieldData.getFromSession.key=$scope.values[newValue].fieldName,$scope.fieldData.getFromSession.context=$scope.values[newValue].context)}});$scope.invalidDateFormat=!1,$scope.saveAlertFieldObj=function(isValid,showIt,event,form){function triggerTaskFieldSave(){$scope.onSave({alertFieldDef:getAlertObject(),showIt:showIt,rqObjSave:!0}),$scope.fieldData={},$scope.fieldData.selectedId="",makeItClean()}var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");if(overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),($scope.keyvalueform.save||angular.noop)(),event&&event.preventDefault&&event.preventDefault(),form.__$invalid=!isValid,$scope.fieldData.getFromSession.enabled&&null===$scope.fieldData.getFromSession.context&&($scope.fieldData.getFromSession.key=""),!isValid||$scope.fieldData.getFromSession.enabled&&null===$scope.fieldData.getFromSession.context)return form_util.touch(form),void NotificationService.notify(i18n.i18nString("enter_mandatory_field"),"error");if("datetime"===$scope.fieldData.fieldtype.value){if(!$scope.validateDateFormat($scope.fieldData.format))return void($scope.invalidDateFormat=!0);$scope.invalidDateFormat=!1}triggerTaskFieldSave()},$scope.$watch("fieldData.actionFieldType",function(newVal,oldVal){newVal||(form_util.makeItClean($scope.alertFieldsForm),$scope.alertFieldsForm.__$invalid=!1)}),$scope.selectActionField=function(){$scope.form.actionFieldType?$scope.fieldData.actionFieldType="payloadfield":$scope.fieldData.actionFieldType="queryfield"},$scope.cancelFieldForm=function(){PerfectScrollbar.initialize($("#btFullpageModal .main-content")[0]),PerfectScrollbar.destroy($("#commonId .alertFieldFormScroll")[0]);var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),$(".modalPerfectScroll").scrollTop(0),$scope.onCancel({fieldForm:!1}),$scope.alertFieldsForm.$setPristine(),$scope.hideAdvancedOptions()},$(".alertFieldsModal").on("hidden.bs.modal",function(){$scope.alertFieldsForm.$setPristine(),$scope.$broadcast("onCancelFeildForm",{})}),$scope.isMultiRequired=function(type){var allowedTypes={dynamicDropDownCB:!0,dynamicDropDown:!0,staticDropDown:!0,staticDropdownCB:!0,textbox:!0,typeahead:!0};return allowedTypes[type]},$scope.hasDependsOn=function(type){var fieldsWithDependsOn={dynamicDropDown:!0,typeahead:!0,dynamicDropDownCB:!0};return fieldsWithDependsOn[type]},$scope.$watch("fieldData.fieldtype",function(newVal,oldValue){newVal&&"nestedform"===newVal.value?($scope.fieldData.datatype=$filter("filter")($scope.supportedDataTypes,{value:"array"})[0],$scope.fieldData.arrayElementType=$filter("filter")($scope.supportedDataTypes,{value:"object"})[0]):newVal&&"file"===newVal.value?($scope.fieldData.datatype=$filter("filter")($scope.supportedDataTypes,{value:"array"})[0],$scope.fieldData.arrayElementType=$filter("filter")($scope.supportedDataTypes,{value:"string"})[0]):newVal&&"location"===newVal.value&&($scope.fieldData.datatype=$filter("filter")($scope.supportedDataTypes,{value:"string"})[0])}),$scope.showNestedFieldForm=function(){$scope.nestedFormField={},$scope.showFieldForm=!$scope.showFieldForm};var editIndex="no-value";$scope.edit=function(index){editIndex=index,$timeout(function(){$scope.nestedFormField=_.clone($scope.fieldData.fields[index])}),$scope.showNestedFieldForm()},$scope["delete"]=function(index){$scope.fieldData.fields.splice(index,1)},$scope.moveUp=function(from){$util.swap([$scope.fieldData.fields],from,from-1)},$scope.moveDown=function(from){$util.swap([$scope.fieldData.fields],from,from+1)},$scope.nestedFormSave=function(field,showIt){$scope.fieldData.fields||($scope.fieldData.fields=[]),"no-value"!==editIndex?$scope.fieldData.fields[editIndex]=field:$scope.fieldData.fields.push(field),editIndex="no-value",showIt||($scope.showFieldForm=!1)},$scope.bindAutoComplete=function(iElement){$(".auto-complete-class").autocomplete({source:$scope.values,autoFocus:!0,appendTo:".ui-complete",select:function(event,ui){return $scope.fieldData.getFromSession.context=ui.item.context,$scope.fieldData.getFromSession.key=ui.item.fieldName,!0}}).data("ui-autocomplete")._renderItem=function(ul,item){return $("<li>").append(item.fieldName+" ( "+item.context+" ) ").appendTo(ul)}},$scope.nestedFormCancel=function(){$scope.showFieldForm=!1},setTimeout(function(){PerfectScrollbar.update($(".alertFieldFormScroll")[0])},500)}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("alertFilterForm",function(){return{restrict:"AE",scope:{displayMode:"@",onCancel:"&",onSave:"&",wfType:"@",setFilterData:"=",view:"=",filterFrm:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/alert-filter-form/alert-filter-form.html",controller:["$scope","$rootScope","form_util","urlutil","BTIdpService","$filter","NotificationService","BTFiltersService","BTParamMapService","$workflowService","$timeout","env_conf","i18n",function($scope,$rootScope,form_util,urlutil,BTIdpService,$filter,NotificationService,BTFiltersService,BTParamMapService,$workflowService,$timeout,env_conf,i18n){function makeItClean(){var form=$scope.forms.filterForm;for(var key in form)form.hasOwnProperty(key)&&"object"==typeof form[key]&&0!==key.indexOf("$")&&0!==key.indexOf("$$")&&(form[key].$dirty=!1);$scope.forms.filterForm.__$invalid=!1,$scope.bSave=!1,$scope.bSaveExit=!1}function getKeysInSampleResponse(response){BTParamMapService.getDotKeys(response).then(function(res){$scope.sampleResponseKeys=res.data},function(res){$scope.sampleResponseKeys=[]})}function getSampleResponseChunk(response){var _sKey,_sampleResponse,_sReqChain,obj=$workflowService.alertInfo();_sReqChain=obj.requestChain,_sampleResponse=response,"alert"===$scope.wfType?("webhook"===$workflowService.alertInfo().type&&(_sKey=$workflowService.alertInfo().alertsPath),getKeysInSampleResponse(_sKey&&response?_sampleResponse&&_sKey?resolveObjectPath(_sampleResponse,_sKey):_sampleResponse:response)):getKeysInSampleResponse(response)}function resolveObjectPath(source,path,result){return-1===path.indexOf("$.")&&(path="$.."+path),result=JSONPath({json:source,path:path})[0],result instanceof Array?result[0]:result}function concatUrl(path,fragment,query){var result=path;return query&&(result+="?"+query),fragment&&(result+="#"+fragment),result}$scope.resData={},$scope.showTypeahead=!1,$scope.hasOperations=!1,$scope.saveInProgress=!1,$scope.modalSlider={},$scope.forms={},$scope.operationArray=[],$scope.save=i18n.i18nString("save"),$scope.savingLabel=i18n.i18nString("saving"),$scope.exit=i18n.i18nString("save_exit"),$scope.typeaheadDataProvider=$workflowService.sampleResponseKeys(),$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.rightClass="right700";var seedData=$workflowService.seedData();$scope.operations=[],$scope._constants_=$rootScope._constants_,$scope.keyvalueform={key:i18n.i18nString("keyvalueform_key"),value:i18n.i18nString("keyvalueform_value"),keyErrorMsg:i18n.i18nString("keyvalueform_keyErrorMsg"),valueErrorMsg:i18n.i18nString("keyvalueform_valueErrorMsg"),btnLabel:i18n.i18nString("keyvalueform_btnLabel"),btnText:i18n.i18nString("keyvalueform_btnText")},$scope.$on("openFilterForm",function(){$scope.modalSlider.open("#alertFilterForm")}),$scope.$on("closeFilterForm",function(){$scope.modalSlider.close("#alertFilterForm")}),$scope.getFilterKey=function(data){$scope.resData.fieldName=data.typeaheadOutput.name||data.typeaheadOutput,$scope.showTypeahead=!1},$("body").on("click",".sumoSelect select",function(sumo){$(".alertFilterScroll").animate({scrollTop:193},"slow")}),$scope.$watch("setFilterData",function(newVal,oldVal){window.URI;if($scope.saveInProgress=!1,!newVal||0===Object.keys(newVal).length)return $scope.resData={supportedOperations:[]},makeItClean(),void($scope.forms.filterForm.__$invalid=!1);$scope.resData=angular.copy("object"==typeof newVal?newVal:$scope.resData),$scope.resData.fieldType&&($scope.resData.fieldType=$filter("filter")($scope.supportedfieldtypes,{value:$scope.resData.fieldType})[0]),$scope.resData.dataType&&($scope.resData.dataType=$filter("filter")($scope.supporteddatatypes,{value:$scope.resData.dataType})[0]);var rhsInputType=newVal.rhsInputType?newVal.rhsInputType:{};if($scope.resData.supportedOperations=newVal.supportedOperations,rhsInputType.inputInfo){switch(rhsInputType.inputType){case"staticDropdownCB":case"staticDropdown":$scope.resData.staticDropDownFields=rhsInputType.inputInfo.options;break;case"dynamicDropdown":case"typeahead":case"dynamicDropDownCB":if(rhsInputType.inputInfo&&($scope.resData.dynamicDropdownPath=rhsInputType.inputInfo.responsePath,$scope.resData.dynamicDropdownLabelKey=rhsInputType.inputInfo.keyForLabel,$scope.resData.dynamicDropdownValueKey=rhsInputType.inputInfo.keyForValue,rhsInputType.inputInfo.endPoint&&rhsInputType.inputInfo.endPoint.contentType&&($scope.resData.dynamicDropdownContentType=rhsInputType.inputInfo.endPoint.contentType.value),rhsInputType.inputInfo.endPoint)){var endPoint=rhsInputType.inputInfo.endPoint;$scope.resData.dynamicDropdownURL=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol})}$scope.resData.dynamicDropDownMethod="GET"}rhsInputType.inputInfo&&rhsInputType.inputInfo.placeholder&&($scope.resData.textplaceholder=rhsInputType.inputInfo.placeholder)}}),$scope.$watch("resData.dataType",function(newVal,oldVal){if(newVal)switch(newVal.value){case"array":$scope.operations=angular.copy(seedData.filterOperations.array);break;case"string":$scope.operations=angular.copy(seedData.filterOperations.string);break;case"number":$scope.operations=angular.copy(seedData.filterOperations.number);break;case"date":$scope.operations=angular.copy(seedData.filterOperations.date);break;default:$scope.operations=angular.copy(seedData.filterOperations.string)}}),$scope.operations=$workflowService.seedData().filterOperations.string,$scope.contenttypes=[{name:i18n.i18nString("json_label"),value:"json"},{name:i18n.i18nString("encoded"),value:"encoded json"},{name:i18n.i18nString("xml"),value:"xml"},{name:i18n.i18nString("rss"),value:"rss"},{name:i18n.i18nString("csv_label"),value:"csv"},{name:i18n.i18nString("text"),value:"text"}],$scope.supportedfieldtypes=seedData.filterLHSInputType,$scope.supporteddatatypes=seedData.filterKeyDataType,$timeout(function(){$scope.forms.filterForm.supportedOperations={$error:{required:!1},$dirty:!1}},100),$scope.filterScroll=function(){setTimeout(function(){PerfectScrollbar.update($(".alertFilterScroll")[0])},500)},$scope.$watchCollection("resData.supportedOperations",function(newVal,oldVal){$scope.resData.supportedOperations.length>0&&($scope.forms.filterForm.supportedOperations.$dirty=!1,$scope.forms.filterForm.supportedOperations.$error.required=!1)}),$scope.setFilterObject=function(isValid,showIt){function moveScrollToBottom(){var _fieldEle=$('[name="filterForm"] [name="supportedOperations"]');if(_fieldEle=_fieldEle.last()){var _container=_fieldEle.closest(".ps-container");if(_container){var _scrollHeight=_fieldEle.offset().top-_container.offset().top+_container.scrollTop();_container.scrollTop(_scrollHeight)}}}if(($scope.keyvalueform.save||angular.noop)(),$scope.forms.filterForm.__$invalid=!isValid,!isValid)return form_util.touch($scope.forms.filterForm),void($scope.resData.supportedOperations.length||($scope.forms.filterForm.supportedOperations.$dirty=!0,$scope.forms.filterForm.supportedOperations.$error.required=!0));if(!$scope.resData.supportedOperations.length)return $scope.forms.filterForm.supportedOperations.$dirty=!0,$scope.forms.filterForm.supportedOperations.$error.required=!0,void moveScrollToBottom();$scope.saveInProgress=!0,showIt?($scope.bSave=!0,$scope.bSaveExit=!1):($scope.bSave=!1,$scope.bSaveExit=!0);var filterObject={};switch(filterObject.name=$scope.resData.name,filterObject.type=$scope.resData.dataType.value,filterObject.isSearchable=$scope.resData.isSearchable,$scope.resData.fieldType.value){case"textbox":filterObject.rhsInputType={inputInfo:{placeholder:$scope.resData.textplaceholder},inputType:$scope.resData.fieldType.value};break;case"staticDropdown":case"staticDropdownCB":filterObject.rhsInputType={inputInfo:{options:$scope.resData.staticDropDownFields},inputType:$scope.resData.fieldType.value};break;case"textarea":filterObject.rhsInputType={inputInfo:{placeholder:$scope.resData.textplaceholder},inputType:$scope.resData.fieldType.value};break;case"dynamicDropdown":case"typeahead":case"dynamicDropDownCB":var uriParser=window.URI,components=uriParser.parse($scope.resData.dynamicDropdownURL);filterObject.rhsInputType={inputInfo:{endPoint:{host:components.host,port:components.port?components.port+"":"",path:concatUrl(components.path,components.fragment,components.query),protocol:components.scheme,contentType:$filter("filter")($scope.contenttypes,{value:$scope.resData.dynamicDropdownContentType})[0],method:$scope.resData.dynamicDropdownMethod},keyForLabel:$scope.resData.dynamicDropdownLabelKey,keyForValue:$scope.resData.dynamicDropdownValueKey,responsePath:$scope.resData.dynamicDropdownPath},inputType:$scope.resData.fieldType.value}}filterObject.help=$scope.resData.help,filterObject.lhsKey=$scope.resData.fieldName,filterObject.alertId=$workflowService.alertInfo()._id,filterObject.supportedOperations=$scope.resData.supportedOperations,filterObject.streamId=$workflowService.selectedStream()._id;var alertId=$workflowService.alertInfo()._id;filterObject.alertVersion=$workflowService.alertInfo().version||"1.0","edit"===$scope.displayMode?BTFiltersService.updateFilter($scope.resData._id,filterObject).then(function(res){filterObject._id=res.data._id,NotificationService.notify(i18n.i18nString("filter_success"),"success"),$scope.onSave({filterRequestObj:res.data,showIt:showIt})},function(res){NotificationService.notify(i18n.i18nString("filter_error"),"error")}).then(function(){$scope.saveInProgress=!1,makeItClean()}):BTFiltersService.createFilter(alertId,filterObject).then(function(res){NotificationService.notify(i18n.i18nString("filter_save_success"),"success"),filterObject._id=res.data._id,$scope.onSave({filterRequestObj:res.data,showIt:showIt})},function(res){NotificationService.notify(i18n.i18nString("filter_save_error"),"error")}).then(function(){$scope.saveInProgress=!1,makeItClean()})},$scope.cancelFilterForm=function(){$scope.saveInProgress=!1,$scope.onCancel({filterForm:!1})},"alert"===$scope.wfType&&getSampleResponseChunk($workflowService.alertInfo().sample),$scope.onKeySelect=function(data){$scope.resData.fieldName=data},setTimeout(function(){PerfectScrollbar.update($(".alertFilterScroll")[0])},500)}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("amendEntity",function(){return{restrict:"AE",scope:{callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/amend-entity/amend-entity.html",controller:"amendEntityCtrl"}}),_module.controller("amendEntityCtrl",["$scope","BTStreamsService","NotificationService","$workflowService","$applicationService","accessControlService","$timeout","i18n","env_conf",function($scope,BTStreamsService,NotificationService,$workflowService,$applicationService,accessControlService,$timeout,i18n,env_conf){
function prepareData(){"continueFromCurrentNode"===$scope.amendConfig.postAmend&&(delete $scope.amendConfig.clearDownstreamEntities,delete $scope.amendConfig.skipShownMessages),$scope.amendConfig.enabled&&($scope.amendConfig.allowHidden=$scope.amendConfig.allowHidden?$scope.amendConfig.allowHidden:!1),$scope.amendConfig.enabled||(delete $scope.amendConfig.allowHidden,delete $scope.amendConfig.postAmend)}function init(){BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){$scope.stream=res.data,$scope.stream&&$scope.stream.amendConfig?($scope.amendConfig=angular.copy($scope.stream.amendConfig),$scope.serverAmendConfig=angular.copy($scope.stream.amendConfig),$scope.amendConfig&&$scope.amendConfig.enabled&&($scope.amendConfig.allowHidden=$scope.amendConfig.hasOwnProperty("allowHidden")?$scope.amendConfig.allowHidden:!1)):$scope.amendConfig.enabled=!1})}function scrollToEle(element){var _PanelEle=$(element);if(_PanelEle){var _container=_PanelEle.closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=_PanelEle.offset().top;_container.animate({scrollTop:_scrollHeight},"slow")}}}$scope.accessRights=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.assetsBase=env_conf["assets-url"],$scope.callback.accessRights=$scope.accessRights,$scope.amendConfig={},$scope.$emit("nestedComponentLoaded",{id:"amendEntity",flag:!1}),$scope.streamdata=angular.copy($workflowService.selectedStream()),$scope.currentLanguage=$workflowService.currentLanguage(),$scope.showAmend=!1,$scope.amendEntityDescription=[{desc:i18n.i18nString("amend_desc_identify")},{desc:i18n.i18nString("amend_desc_behaviour")},{desc:i18n.i18nString("amend_desc_entity")},{desc:i18n.i18nString("amend_desc_dialog")},{desc:i18n.i18nString("amend_desc_context")}],$scope.callback.submitData=function(){prepareData();var payload={amendConfig:$scope.amendConfig};BTStreamsService.editNlSettings($workflowService.selectedStream()._id,payload).then(function(response){$scope.serverAmendConfig=response.data.amendConfig,$scope.amendConfig=angular.copy($scope.serverAmendConfig),$workflowService.selectedStream(response.data),NotificationService.notify(i18n.i18nString("notify_amend"),"success")},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.setDefault=function(){void 0===$scope.amendConfig.postAmend?$scope.amendConfig.postAmend="continueFromAmendedNode":void 0===$scope.serverAmendConfig?($scope.amendConfig.postAmend="continueFromAmendedNode",$scope.amendConfig.enabled=!0):$scope.amendConfig=angular.copy($scope.serverAmendConfig)},init(),$scope.showContent=function(key){"expand"==key?($timeout(function(){scrollToEle("#collapse")},0),$scope.showAllContent=!0):($scope.showAllContent=!1,scrollToEle("#amend-entity"))},$scope.amendToggleHandler=function(){$scope.amendConfig.enabled=!0,$scope.amendConfig.postAmend="continueFromAmendedNode",$timeout(function(){$scope.showAmend=!$scope.showAmend,$scope.callback.submitData(),$(".innerRightFooter").css({display:"block"}),scrollToEle("#amend-entity")},100)}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("authFieldForm",function(){return{restrict:"EA",scope:{fields:"=fields",mode:"="},controller:["$scope","form_util","$rootScope","NotificationService","i18n",function($scope,form_util,$rootScope,NotificationService,i18n){$scope.authField={};var editIndex=0,editInOperation=!1;$scope.authFormReset=function(){$scope.auth_field_form.$setPristine()},$scope._constants_=$rootScope._constants_,$scope.onSave=function(authField,form,index){return index>=0&&(editInOperation=!0,editIndex=index),form&&form.$invalid?void form_util.touch(form):(editInOperation?$scope.fields.splice(editIndex,1,angular.copy($scope.authField)):($scope.fields=$scope.fields?$scope.fields:[],$scope.fields.push(angular.copy(authField))),editInOperation=!1,$scope.authFieldForm=!1,void $scope.$emit("triggerShowOuterForm"))},$scope.$on("showAuthFieldForm",function(){$scope.showAuthFieldForm()}),$scope.$on("cancelAuthFieldForm",function(){$scope.onCancel()}),$scope.$on("saveAuthFieldForm",function(event,index){$scope.onSave($scope.authField,$scope.auth_field_form,index)}),$scope.$on("editAuthFieldData",function(evt,editFieldData){$scope.authField=ng.copy(editFieldData)}),$scope.showAuthFieldForm=function(){$scope.authField={},$scope.authFieldForm=!0},$scope.onCancel=function(){$scope.authField={},$scope.authFieldForm=!1,$scope.$emit("triggerShowOuterForm")},$scope.editField=function(index){editInOperation=!0,editIndex=index,$scope.authField=angular.copy($scope.fields[index]),$scope.authFieldForm=!0,$scope.$emit("triggerHideOuterForm")},$scope.deleteField=function(index){$scope.fields.splice(index,1)}}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/auth-fields/auth-fields.html",link:function(scope,element,attrs){}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("authFormFields",["$timeout",function($timeout){return{restrict:"EA",scope:{fields:"=",type:"@?",mode:"="},controller:["$scope","$rootScope","form_util","i18n",function($scope,$rootScope,form_util,i18n){$scope.field={title:"",key:"",help:"",type:"string",fieldType:"textbox",visibility:"visible",isRequired:!1},$scope._constants_=$rootScope._constants_,$scope.fieldCopy=ng.copy($scope.field);var fields,editIndex="noInsert";$timeout(function(argument){if(fields=$scope.fields,!fields){if($scope.fields=$scope.fields||[],$scope.fields.length>0)return;"api_key"===$scope.type?$scope.fields.push({title:i18n.i18nString("provide_key"),help:i18n.i18nString("account_usage"),key:"apiKey",type:"string",isRequired:!0,fieldType:"textbox",placeholder:""}):"basic"===$scope.type&&($scope.fields.push({title:i18n.i18nString("user_email"),placeholder:"",key:"username",type:"string",fieldType:"textbox",isRequired:!0}),$scope.fields.push({title:i18n.i18nString("password"),placeholder:"",key:"password",type:"string",fieldType:"password",isRequired:!0}))}}),$scope.onSave=function(valid,form,event,index){return editIndex=index>=0?index:"noInsert",valid?($scope.fields=$scope.fields||[],"noInsert"!==editIndex?$scope.fields[editIndex]=ng.copy($scope.field):$scope.fields.push(ng.copy($scope.field)),$scope.bshowForm=!1,$scope.$emit("triggerShowOuterForm"),void(editIndex="noInsert")):void form_util.touch(form)},$scope.deleteField=function(index){"noInsert"===editIndex&&($scope.fields[index].disabled=!$scope.fields[index].disabled,$scope.fields[index]=_.clone($scope.fields[index]))},$scope.editField=function(index){$scope.fields[index].disabled||(editIndex=index,$scope.field=ng.copy($scope.fields[index]),$scope.bshowForm=!0)},$scope.showForm=function(){$scope.field=ng.copy($scope.fieldCopy),$scope.bshowForm=!0},$scope.$on("showIDPFieldForm",function(){$scope.showForm()}),$scope.$on("cancelIDPFieldForm",function(){$scope.onCancel()}),$scope.$on("saveIDPFieldForm",function(event,index){$scope.onSave($scope.idpFieldsForm.$valid,$scope.idpFieldsForm,"",index)}),$scope.$on("editIDPFieldData",function(evt,editFieldData){$scope.field=ng.copy(editFieldData)}),$scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options"),$scope.showAdvancedOptions=function(){$scope.showadvancedoptions?($scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options"),$("#advancedoptdiv .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showadvancedoptions=!0,$scope.advancedoptiontext=i18n.i18nString("hide_advanced_options"),$("#advancedoptdiv .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"))},$scope.hideAdvancedOptions=function(){$scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options"),$("#advancedoptdiv .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")},$scope.onCancel=function(){$scope.field=ng.copy($scope.fieldCopy),$scope.bshowForm=!1,$scope.$emit("triggerShowOuterForm"),editIndex="noInsert",$("#authorizationModal .authFieldForm").scrollTop(0)}}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/auth-form-fields/auth-form-fields.html",link:function(scope,elem,attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("authForm",function(){return{restrict:"AE",scope:{wfType:"@",onComplete:"&",displayMode:"@",onCancel:"&",configure:"&",isFinishSetupLoading:"=",hooks:"=?callbacks",callback:"=",skipSaveConfirm:"@",resource:"=",nodeInfo:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/auth-form/auth-form.html",controller:"authorizationCtrl"}}),_module.controller("authorizationCtrl",["$scope","form_util","$timeout","$rootScope","$location","uuid4","BTIdpService","NotificationService","BTAlertsService","BTActionsService","$workflowService","$translator","$filter","$endpoints","$window","$applicationService","$routeParams","accessControlService","env_conf","i18n","jsEvents",function($scope,form_util,$timeout,$rootScope,$location,uuid4,BTIdpService,NotificationService,BTAlertsService,BTActionsService,$workflowService,$translator,$filter,$endpoints,$window,$applicationService,$routeParams,accessControlService,env_conf,i18n,jsEvents){function bindAuthMechanism(){var authMechanism;authMechanism="alert"===$scope.wfType?{name:$workflowService.alertInfo().idp||"",sso_type:$workflowService.alertInfo().sso_type||""}:"action"===$scope.wfType?{name:$workflowService.actionInfo().idp||"",sso_type:$workflowService.actionInfo().sso_type||""}:{name:"none",sso_type:"basic"};for(var i=0;i<$scope.authLists.length;i++)if($scope.authLists[i].name===authMechanism.name&&$scope.authLists[i].sso_type===authMechanism.sso_type)return"none"===$scope.authLists[i].sso_type&&($scope.isDirtyNone=!0,$timeout(function(){try{$scope.authForm.$dirty=!0}catch(ex){console.log(ex)}})),void($scope.newAuth.selected=$scope.authLists[i])}function sendEventToIframe(){var params={type:"closeAuthForm"};jsEvents.postMessageToChildIframes("closeAuthForm","#dialogIFrame",params)}function verifyAuthCheckUrl(url,authFields){if(!url||0===authFields.length)return!0;var result=!0,pathparams=authFields.map(function(field){return"pathparam"===field.type?field.key:null}).filter(function(key){return key});if(0===pathparams.length)return!0;for(var i=0;i<pathparams.length;i++)result=result&&-1!==url.indexOf("{{"+pathparams[i]+"}}");return result}function saveIDP(authObj){$scope.saveInProgress=!0,$scope.editInOperation?(delete authObj._id,BTIdpService.editIdp($scope.editedAuth._id,$workflowService.selectedStream()._id,authObj).then(function(res){$scope.callback&&$scope.callback.onEditIDP&&$scope.callback.onEditIDP(res.data),$(".authmodal").modal("hide"),$scope.closeAuthModal(),$scope.isLoading=!0,BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.authLists=res.data,$scope.btcallback||$scope.authLists.push({_id:"none",name:"none",sso_type:"none"}),$scope.newAuth.selected=$scope.authLists.filter(function(authItem){return authItem.name===authObj.name})[0],$scope.saveInProgress=!1,$scope.isLoading=!1},function(res){$scope.saveInProgress=!1,$scope.isLoading=!1})},function(error){$scope.saveInProgress=!1,$rootScope.saveAndExit=!1,NotificationService.notify(error.data.errors[0].msg,"error")}).then(function(){$scope.saveInProgress=!1,$scope.editInOperation=!1,$scope.editedAuth={}})):(delete authObj._id,BTIdpService.createIdp($workflowService.selectedStream()._id,authObj).then(function(res){$scope.callback&&$scope.callback.onCreateIDP&&$scope.callback.onCreateIDP(res.data),$(".authmodal").modal("hide"),$scope.closeAuthModal(),$scope.isLoading=!0,BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.authLists=res.data,$scope.btcallback||$scope.authLists.push({_id:"none",name:"none",sso_type:"none"}),$scope.newAuth.selected=$scope.authLists.filter(function(authItem){return authItem.name===authObj.name})[0],$scope.saveInProgress=!1,$scope.isLoading=!1},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,$scope.isLoading=!1,NotificationService.notify(i18n.i18nString("notify_idp"),"error")})},function(error){$scope.saveInProgress=!1,NotificationService.notify(error.data.errors[0].msg,"error")}).then(function(){$scope.editInOperation=!1,$scope.editedAuth={}}))}function closeAuthProfileTest(){$timeout(function(){var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),$scope.modalSlider.close("auth-form #authorizationProfileSlider"),$scope.modalSlider.close("#authorizationProfileSlider")}),$scope.callback&&$scope.callback.onModalShow&&$scope.callback.onModalShow(),sendEventToIframe()}function bindAuthDetails(auth){var prop,keys=[];switch($scope.newAuth.sso_type=_.filter($scope.authTypes,{value:auth.sso_type})[0],auth.sso_type){case"basic":case"custom":$scope.basicAuth.basicname=auth.name,$scope.basicAuth.basicdescription=auth.description,$scope.basicAuth.hastenancy=auth.hasTenancy,$scope.basicAuth.authCheckUrl=auth.authCheckUrl,$scope.basicAuth.basictenancyUrl=auth.appConfig?auth.appConfig.baseURL:"",$scope.basicAuth.connectorEnabled=auth.connectorEnabled,$scope.basicAuth.tokenurlmethod=auth.method,$scope.basicAuth.tokenUrlContentType=auth.contentType,_.addProps("custom"==auth.sso_type,$scope.basicAuth,{tokenUrl:auth.appConfig&&auth.appConfig.tokenURL,refreshTokenURL:auth.appConfig&&auth.appConfig.refreshTokenURL,authErrorStatusCode:auth.appConfig&&auth.appConfig.authErrorStatusCode});break;case"oauth":if($scope.v1Auth.name=auth.name,$scope.v1Auth.basicdescription=auth.description,0===Object.keys(auth.appConfig).length)return;$scope.v1Auth.requestTokenLink=auth.appConfig.requestTokenURL,$scope.v1Auth.accessTokenLink=auth.appConfig.accessTokenURL,$scope.v1Auth.consumerSecret=auth.appConfig.consumerSecret,$scope.v1Auth.consumerKey=auth.appConfig.consumerKey,$scope.v1Auth.authLink=auth.appConfig.userAuthorizationURL,$scope.v1Auth.refreshTokenURL=auth.appConfig.refreshTokenURL,$scope.v1Auth.hastenancy=auth.hasTenancy,$scope.v1Auth.connectorEnabled=auth.connectorEnabled,$scope.v2Auth.basictenancyUrl=auth.appConfig.baseURL,keys=["requestTokenURL","accessTokenURL","consumerKey","consumerSecret","userAuthorizationURL","hasTenancy","baseURL","refreshTokenURL"];for(prop in auth.appConfig)auth.appConfig.hasOwnProperty(prop)&&!keyIsThere(prop,keys)&&($scope.additionalFields[prop]=auth.appConfig[prop]);break;case"oauth2":if($scope.v2Auth.name=auth.name,$scope.v2Auth.basicdescription=auth.description,0===Object.keys(auth.appConfig).length)return;$scope.v2Auth.clientSecret=auth.appConfig.clientSecret,$scope.v2Auth.clientId=auth.appConfig.clientID,$scope.v2Auth.tokenURL=auth.appConfig.tokenURL,$scope.v2Auth.scope=auth.appConfig.scope,$scope.v2Auth.authUrl=auth.appConfig.authorizationURL,$scope.v2Auth.refreshTokenURL=auth.appConfig.refreshTokenURL,$scope.v2Auth.authErrorStatusCode=auth.appConfig.authErrorStatusCode,$scope.v2Auth.hastenancy=auth.hasTenancy,$scope.v2Auth.connectorEnabled=auth.connectorEnabled,$scope.v2Auth.basictenancyUrl=auth.appConfig.baseURL,keys=["clientSecret","clientID","tokenURL","scope","authorizationURL","hasTenancy","baseURL","refreshTokenURL"];for(prop in auth.appConfig)auth.appConfig.hasOwnProperty(prop)&&!keyIsThere(prop,keys)&&($scope.additionalFields[prop]=auth.appConfig[prop]);break;case"oauth2_client_credential":if($scope.oauth2_client_credential.name=auth.name,$scope.oauth2_client_credential.basicdescription=auth.description,0===Object.keys(auth.appConfig).length)return;$scope.oauth2_client_credential.refreshTokenURL=auth.appConfig.refreshTokenURL,$scope.oauth2_client_credential.clientSecret=auth.appConfig.clientSecret,$scope.oauth2_client_credential.clientId=auth.appConfig.clientID,$scope.oauth2_client_credential.tokenURL=auth.appConfig.tokenURL,$scope.oauth2_client_credential.scope=auth.appConfig.scope,$scope.oauth2_client_credential.connectorEnabled=auth.connectorEnabled,keys=["clientSecret","clientID","tokenURL","scope","refreshTokenURL"];break;case"api_key":$scope.apiKeyAuth.name=auth.name,$scope.apiKeyAuth.basicdescription=auth.description,$scope.apiKeyAuth.hastenancy=auth.hasTenancy,$scope.apiKeyAuth.authCheckUrl=auth.authCheckUrl,$scope.apiKeyAuth.basictenancyUrl=auth.appConfig?auth.appConfig.baseURL:"",$scope.apiKeyAuth.connectorEnabled=auth.connectorEnabled}$timeout(function(){$scope.authObj={fields:ng.copy(auth.fields),formfields:ng.copy(auth.formfields||[])}}),$scope.showAuthFormModal()}function getIdpDetails(id){return BTIdpService.getIdp(id,$workflowService.selectedStream()._id)}function keyIsThere(key,keys){for(var i=0;i<keys.length;i++)if(keys[i]===key)return!0;return!1}function bindEvents(){$scope.callback&&($scope.callback.createNewIDP=function(auth){$scope.showAuth(auth)})}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.forms={},$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.resetAuthForm=function(){$scope.newAuth={},$scope.v1Auth={},$scope.v2Auth={},$scope.basicAuth={},$scope.apiKeyAuth={},$scope.noneAuth={},$scope.oauth2_client_credential={},$scope.additionalFieldsForm={},$scope.additionalFields={},$scope.save=i18n.i18nString("save"),$scope.savingLabel=i18n.i18nString("saving"),$scope.showKeyValueForm=!1,$scope.showNewAuthForm=!1,$scope.saveInProgress=!1,$scope.authObj={fields:[]}},$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.backArrow=env_conf["context-url"]+"/assets/icons/backArrow.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.emptyStateIcon_auth_profiles=env_conf["context-url"]+"/assets/empty-state-images/empty-auth-profiles.png",$scope.rightClass="right700",$scope.btTestFormApi={},$scope.btTestStatus={},$scope.callback=$scope.callback||{},$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.connectors=[],$scope.hooks=$scope.hooks||{},$scope.afterSave=angular.noop,$scope.authFormPreviousStep=$scope.$parent.$parent.previousStep,$scope.baseurlDescription=$rootScope.getSanitizedText($rootScope.lableData&&$rootScope.lableData.bb507),$scope.authCheckurlDescription=$rootScope.getSanitizedText($rootScope.lableData&&$rootScope.lableData.bb510),$scope.authorizationurlDescription=$rootScope.getSanitizedText($rootScope.lableData&&$rootScope.lableData.bb511),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.closeCross=window.appConfig.CONTEXT_PATH+"/assets/landingImages/closeCross.png",$scope.backArrow=window.appConfig.CONTEXT_PATH+"/assets/icons/arrowGray.svg",$scope.isLoading=!1,function(){$scope.connectors=$workflowService.botConnectors()}(),$scope.authObj={fields:[]},$scope._constants_=$rootScope._constants_,$scope.resetAuthForm(),$scope._constants_=$rootScope._constants_;var uuid="ap-"+uuid4.generate();$scope.resetAddtionalFields=function(){$timeout(function(){switch($scope.newAuth.sso_type&&$scope.newAuth.sso_type.value){case"api_key":$scope.authObj={fields:[{type:"querystring",key:"api_key",value:"{{key}}"}]};break;case"oauth":$scope.authObj={fields:[]};break;case"oauth2":$scope.authObj={fields:[{type:"header",key:"Authorization",value:"Bearer {{accessToken}}"}]};break;case"basic":$scope.authObj={fields:[{type:"header",key:"Authorization",value:"Basic {{passphrase}}"}]};break;case"oauth2_client_credential":$scope.authObj={fields:[{type:"header",key:"Authorization",value:"Bearer {{access_token}}"}]};break;default:$scope.authObj={fields:[]}}$timeout(function(){$(".authFieldForm").scrollTop(2)},100)}),$scope.additionalFields={}};var _selectedStream=$workflowService.selectedStream();if("alert"===$scope.wfType&&$workflowService.alertInfo()&&($scope.alertType=$workflowService.alertInfo().type),!_selectedStream)return void alert(i18n.i18nString("stream_not_found"));if($scope.datatypes=$workflowService.seedData().contentTypes,$scope.authTypes=angular.copy($workflowService.seedData().authMechanisms).filter(function(map){return"none"!==map.value}),$scope.getselectedObj=function(auth){$scope.isDirtyNone=!1,$workflowService.authlist(auth)},$scope.isDirtyNone=!1,$rootScope.$on("goToAuthTab",function(){}),$scope.skipAuthRqObj=function(){$scope.onComplete()},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.callbackurl=res.data.callbackURL.split("/:idp")[0]}),$scope.setPristineForm=function(){$scope.authForm&&$scope.authForm.$setPristine&&$scope.authForm.$setPristine()},$scope.cancelNewAuthForm=function(){var newAuth=$scope.newAuth;$(".authmodal").modal("hide"),$scope.setPristineForm(),$scope.closeAuthModal(),$scope.resetAuthForm(),$scope.v1Auth={},$scope.v2Auth={},$scope.basicAuth={},$scope.apiKeyAuth={},$scope.basicAuth={},$scope.noneAuth={},$scope.oauth2_client_credential={},$scope.newAuth=newAuth,($scope.forms.oauthv1Form&&$scope.forms.oauthv1Form.$setPristine||angular.noop)(),($scope.forms.oauthv2Form&&$scope.forms.oauthv2Form.$setPristine||angular.noop)(),($scope.forms.basicForm&&$scope.forms.basicForm.$setPristine||angular.noop)(),($scope.forms.basicCustomForm&&$scope.forms.basicCustomForm.$setPristine||angular.noop)(),($scope.forms.apiKeyForm&&$scope.forms.apiKeyForm.$setPristine||angular.noop)(),($scope.forms.noneForm&&$scope.forms.noneForm.$setPristine||angular.noop)(),($scope.oauth2_client_credential&&$scope.oauth2_client_credential.$setPristine||angular.noop)(),$scope.showNewAuthForm=!1},$scope.isLoading=!0,BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.authLists=res.data,$scope.btcallback||$scope.authLists.push({_id:"none",name:"none",sso_type:"none"}),bindAuthMechanism(),$scope.isLoading=!1},function(res){NotificationService.notify(i18n.i18nString("notify_idp"),"error"),$scope.isLoading=!1}),$scope.showAuth=function(auth){if(auth)bindAuthDetails(auth);else{$scope.editInOperation=!1,$scope.editAuth={};var newAuth=$scope.newAuth;$scope.resetAuthForm(),$scope.newAuth=newAuth,$scope.newAuth.sso_type={},$scope.showAuthFormModal()}},$scope.modalSlider={},$scope.showAuthModal=function(){$timeout(function(){$scope.modalSlider.open("#authorizationModal"),$("#btFullpageModal .main-content").length&&(PerfectScrollbar.destroy($("#btFullpageModal .main-content")[0]),PerfectScrollbar.initialize($("#authorizationModal .authFieldForm")[0]));var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");overflowResult||$(".modal-body.modal-body-nopadding .creation .main-content").addClass("overflowUnset")}),$(".taskCreateOverlayModal.listOfValMain").length&&$(".taskCreateOverlayModal.listOfValMain").addClass("modalSmall"),$scope.callback&&$scope.callback.onModalShow&&$scope.callback.onModalShow()},$scope.closeAuthModal=function(){var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),$scope.modalSlider.close("#authorizationModal"),$("#btFullpageModal .main-content")&&$("#btFullpageModal .main-content").length>0&&(PerfectScrollbar.destroy($("#authorizationModal .authFieldForm")[0]),PerfectScrollbar.initialize($("#btFullpageModal .main-content")[0])),$(".taskCreateOverlayModal.listOfValMain").length&&$(".taskCreateOverlayModal.listOfValMain").removeClass("modalSmall"),$scope.callback&&$scope.callback.onModalClose&&$scope.callback.onModalClose()},$scope.showAuthFormModal=function(){uuid="ap-"+uuid4.generate(),$scope.showNewAuthForm=!0,$scope.showAuthModal(),$workflowService.registerModalHiddenEvent()},$scope.saveAuthorization=function(event){var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");switch(overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),$scope.newAuth.sso_type.value){case"oauth":$scope.saveoAuthV1($scope.forms.oauthv1Form.$valid,$scope.forms.oauthv1Form,event);break;case"oauth2":$scope.saveoAuthV2($scope.forms.oauthv2Form.$valid,$scope.forms.oauthv2Form,event);break;case"oauth2_client_credential":$scope.saveoAuth2_client_credential($scope.forms.oauthv2ClientCredentialForm.$valid,$scope.forms.oauthv2ClientCredentialForm,event);break;case"basic":$scope.saveBasicAuth(event,$scope.forms.basicForm.$valid,$scope.forms.basicForm);break;case"custom":$scope.saveBasicAuth(event,$scope.forms.basicCustomForm.$valid,$scope.forms.basicCustomForm,!0);break;case"api_key":$scope.saveApiKeyAuth($scope.$event,$scope.forms.apiKeyForm.$valid,$scope.forms.apiKeyForm);break;case"none":$scope.saveNoneAuth($scope.forms.noneForm.$valid,$scope.forms.noneForm)}sendEventToIframe()},$scope.saveBasicAuth=function(event,isValid,form,custom){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return void form_util.touch(form);var authObj={};authObj._id=uuid,authObj.sso_type=custom?"custom":"basic",authObj.name=$scope.basicAuth.basicname,authObj.description=$scope.basicAuth.basicdescription,authObj.streamId=_selectedStream._id,authObj.hasTenancy=$scope.basicAuth.hastenancy,authObj.fields=ng.copy($scope.authObj.fields)||{},authObj.appConfig=ng.copy($scope.additionalFields)||{},_.addProps($scope.basicAuth.hastenancy,authObj.appConfig,{baseURL:$scope.basicAuth.basictenancyUrl}),_.addProps(!$scope.basicAuth.hastenancy,authObj.appConfig,{baseURL:""}),_.addProps(custom,authObj.appConfig,{tokenURL:$scope.basicAuth.tokenUrl}),$scope.basicAuth.refreshTokenURL&&_.addProps(custom,authObj.appConfig,{refreshTokenURL:$scope.basicAuth.refreshTokenURL}),$scope.basicAuth.authErrorStatusCode&&_.addProps(custom,authObj.appConfig,{authErrorStatusCode:+$scope.basicAuth.authErrorStatusCode}),authObj.formfields=ng.copy($scope.authObj.formfields||[]).filter(function(field){return!field.disabled}),authObj.formfields=ng.copy(authObj.formfields).map(function(field){return delete field.disabled,field}),authObj.authCheckUrl=$scope.basicAuth.authCheckUrl,authObj.connectorEnabled=$scope.basicAuth.connectorEnabled,custom&&(authObj.method=$scope.basicAuth.tokenurlmethod,authObj.contentType=$scope.basicAuth.tokenUrlContentType),verifyAuthCheckUrl(authObj.authCheckUrl,authObj.fields)?saveIDP(authObj):NotificationService.notify(i18n.i18nString("auth_url_check"),"error")},$scope.saveNoneAuth=function(isValid,form){return isValid?void saveIDP({sso_type:"none",_id:uuid,name:$scope.noneAuth.nonename,streamId:_selectedStream._id}):void form_util.touch(form)},$scope.saveoAuthV1=function(isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return void form_util.touch(form);var authObj={};authObj._id=uuid,authObj.name=$scope.v1Auth.name,authObj.description=$scope.v1Auth.basicdescription,authObj.sso_type="oauth",authObj.hasTenancy=$scope.v1Auth.hastenancy,authObj.appConfig=ng.copy($scope.additionalFields)||{},$scope.v1Auth.hastenancy?authObj.appConfig.baseURL=$scope.v1Auth.basictenancyUrl:authObj.appConfig.baseURL="",$scope.v1Auth.refreshTokenURL&&(authObj.appConfig.refreshTokenURL=$scope.v1Auth.refreshTokenURL),authObj.streamId=_selectedStream._id,authObj.appConfig.requestTokenURL=$scope.v1Auth.requestTokenLink,authObj.appConfig.accessTokenURL=$scope.v1Auth.accessTokenLink,authObj.appConfig.userAuthorizationURL=$scope.v1Auth.authLink,authObj.appConfig.consumerKey=$scope.v1Auth.consumerKey,authObj.appConfig.consumerSecret=$scope.v1Auth.consumerSecret,authObj.appConfig.apiKey=$scope.v1Auth.apiKey,authObj.fields=ng.copy($scope.authObj.fields),authObj.connectorEnabled=$scope.v1Auth.connectorEnabled,saveIDP(authObj)},$scope.saveApiKeyAuth=function(event,isValid,form){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return void form_util.touch(form);var authObj={};authObj._id=uuid,authObj.streamId=_selectedStream._id,authObj.name=$scope.apiKeyAuth.name,authObj.description=$scope.apiKeyAuth.basicdescription,authObj.sso_type="api_key",authObj.hasTenancy=$scope.apiKeyAuth.hastenancy,authObj.appConfig=ng.copy($scope.additionalFields)||{},$scope.apiKeyAuth.hastenancy?authObj.appConfig.baseURL=$scope.apiKeyAuth.basictenancyUrl:authObj.appConfig.baseURL="",authObj.fields=ng.copy($scope.authObj.fields),authObj.formfields=ng.copy($scope.authObj.formfields).filter(function(field){return!field.disabled}),authObj.formfields=ng.copy(authObj.formfields).filter(function(field){return delete field.disabled,field}),authObj.authCheckUrl=$scope.apiKeyAuth.authCheckUrl,authObj.connectorEnabled=$scope.apiKeyAuth.connectorEnabled,verifyAuthCheckUrl(authObj.authCheckUrl,authObj.fields)?saveIDP(authObj):NotificationService.notify(i18n.i18nString("auth_url_check"),"error")},$scope.saveoAuthV2=function(isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return void form_util.touch(form);var authObj={};authObj._id=uuid,authObj.name=$scope.v2Auth.name,authObj.description=$scope.v2Auth.basicdescription,authObj.sso_type="oauth2",authObj.hasTenancy=$scope.v2Auth.hastenancy,authObj.appConfig=ng.copy($scope.additionalFields)||{},$scope.v2Auth.hastenancy?authObj.appConfig.baseURL=$scope.v2Auth.basictenancyUrl:authObj.appConfig.baseURL="",$scope.v2Auth.refreshTokenURL&&(authObj.appConfig.refreshTokenURL=$scope.v2Auth.refreshTokenURL),$scope.v2Auth.authErrorStatusCode&&(authObj.appConfig.authErrorStatusCode=+$scope.v2Auth.authErrorStatusCode),authObj.streamId=_selectedStream._id,authObj.appConfig.authorizationURL=$scope.v2Auth.authUrl,authObj.appConfig.tokenURL=$scope.v2Auth.tokenURL,authObj.appConfig.clientID=$scope.v2Auth.clientId,authObj.appConfig.clientSecret=$scope.v2Auth.clientSecret,authObj.appConfig.apiKey=$scope.v2Auth.apiKey,authObj.appConfig.scope=$scope.v2Auth.scope,authObj.fields=ng.copy($scope.authObj.fields),authObj.connectorEnabled=$scope.v2Auth.connectorEnabled,saveIDP(authObj)},$scope.saveoAuth2_client_credential=function(isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return void form_util.touch(form);var authObj={};authObj.appConfig={},authObj._id=uuid,authObj.name=$scope.oauth2_client_credential.name,authObj.description=$scope.oauth2_client_credential.basicdescription,authObj.sso_type="oauth2_client_credential",authObj.streamId=_selectedStream._id,$scope.oauth2_client_credential.refreshTokenURL&&(authObj.appConfig.refreshTokenURL=$scope.oauth2_client_credential.refreshTokenURL),authObj.appConfig.clientID=$scope.oauth2_client_credential.clientId,authObj.appConfig.clientSecret=$scope.oauth2_client_credential.clientSecret,authObj.connectorEnabled=$scope.oauth2_client_credential.connectorEnabled,authObj.appConfig.tokenURL=$scope.oauth2_client_credential.tokenURL,authObj.appConfig.scope=$scope.oauth2_client_credential.scope,authObj.fields=ng.copy($scope.authObj.fields),saveIDP(authObj)},$scope.getAdditionalFieldsLength=function(){return _.isObject($scope.additionalFields)?Object.keys($scope.additionalFields).length>0:!1},$scope.addAdditionalFields=function(isValid,form){return isValid?($scope.additionalFields[$scope.additionalFieldsForm.key]=$scope.additionalFieldsForm.value,$scope.__addFieldKey&&$scope.__addFieldKey!==$scope.additionalFieldsForm.key&&(delete $scope.additionalFields[$scope.__addFieldKey],$scope.__addFieldKey=""),$scope.additionalFieldsForm={},void($scope.showKeyValueForm=!1)):void form_util.touch(form)},$scope.editAdditionalField=function(key){$scope.additionalFieldsForm.key=key,$scope.additionalFieldsForm.value=$scope.additionalFields[key],$scope.__addFieldKey=key,$scope.showAdditionalFieldsForm()},$scope.removeAdditionalField=function(key){delete $scope.additionalFields[key]},$scope.showAdditionalFieldsForm=function(){$scope.showKeyValueForm=!0,$timeout(function(){$(".authFieldForm").scrollTop(0)},100),$timeout(function(){$rootScope.$emit("updateModalSize")},800)},$scope.cancelAdditionalFieldsForm=function(){
$scope.additionalFieldsForm={},$scope.showKeyValueForm=!1,$scope.hideOuterForm=!1,$scope.showOuterForm=!0,$timeout(function(){$rootScope.$emit("updateModalSize")},800)},$scope.additionalFieldsThere=function(){return Object.keys($scope.additionalFields).length>0},$scope.onAuthFormCancel=function(obj){closeAuthProfileTest(),bindAuthMechanism(),$scope.onCancel(),$scope.showTestAuthForm=!1,$scope.saveInProgress=!1,$location.path(window.appConfig.CONTEXT_PATH)},$scope.testIdp=function(idpId){$scope.btTestFormApi.afterInit=function(){$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success){success?NotificationService.notify(i18n.i18nString("auth_test_success"),"success"):NotificationService.notify(i18n.i18nString("auth_test_failed"),"error"),$scope.btTestFormApi.close()},$scope.btTestFormApi.init({_id:idpId?idpId:$scope.newAuth&&$scope.newAuth.selected._id,type:"idp",testFor:"idp"})},$scope.closeTaskModal=function(){$scope.$parent.onCancel()},$scope.closeModal=function(){$(".authmodal").modal("hide"),$scope.onCancel()},$scope.callback.setIDP=function(){$scope.setAuth()},$scope.setAuth=function(authForm,stopNavigation,successNotify){if($scope.stopNavigation=stopNavigation,$scope.saveInProgress=!0,!$scope.newAuth.selected)return NotificationService.notify(i18n.i18nString("select_auth_provider"),"error"),void($scope.saveInProgress=!1);var _authData={idp:$scope.newAuth.selected.name,sso_type:$scope.newAuth.selected.sso_type},entityName="Task";"alert"===$scope.wfType.toLowerCase()?entityName="Alert Task":"action"===$scope.wfType.toLowerCase()&&(entityName=$scope.resource.isReport?i18n.i18nString("info_task"):i18n.i18nString("action_task"));"action"===$scope.wfType.toLowerCase()?$scope._constants_.action:$scope._constants_.alert;$workflowService.authData(_authData);var resourceId="";if("alert"===$scope.wfType){var _alertObj;_alertObj=$workflowService.alertInfo(),resourceId=_alertObj._id,_authData.type=_alertObj.type,BTAlertsService.createBTAlertUp(resourceId,_authData).then(function(res){$scope.saveInProgress=!1,$workflowService.alertInfo(res.data),$scope.callback&&$scope.callback.onSetIDP&&$scope.callback.onSetIDP(_authData),successNotify?NotificationService.notify(i18n.i18nString("idpdata_saved",{entityName:entityName}),"success"):NotificationService.notify(i18n.i18nString("request_data"),"success"),stopNavigation||$scope.onComplete(),$scope.afterSave(),$scope.authForm.$dirty=!1,$scope.authForm.$setPristine(!0),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo)},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,successNotify?NotificationService.notify(i18n.i18nString("failed_idp_update"),"error"):NotificationService.notify(i18n.i18nString("failed_save_request"),"error")})}else"action"===$scope.wfType&&(resourceId=$workflowService.actionInfo()._id,BTActionsService.updateBTAction(resourceId,_authData).then(function(res){$scope.saveInProgress=!1,$workflowService.actionInfo(res.data),$scope.callback&&$scope.callback.onSetIDP&&$scope.callback.onSetIDP(_authData),successNotify?NotificationService.notify(i18n.i18nString("idpdata_saved",{entityName:entityName}),"success"):NotificationService.notify(i18n.i18nString("request_data"),"success"),stopNavigation||$scope.onComplete(),$scope.afterSave(),$scope.authForm.$dirty=!1,$scope.authForm.$setPristine(!0),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo)},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,successNotify?NotificationService.notify(i18n.i18nString("notify_idp"),"error"):NotificationService.notify(i18n.i18nString("failed_save_request"),"error")}))},$scope.$on("evt:nextActAuth",function(evt,data){$scope.moveTo=data,$scope.setAuth()}),$scope.authEdit=function(authID){$scope.editInOperation=!0,$scope.editedAuth={},authID=authID||$scope.newAuth.selected._id,getIdpDetails(authID).then(function(res){$scope.editedAuth=res.data,bindAuthDetails(res.data)},function(err){console.log(JSON.stringify(err.data))})},$scope.callback.authEdit=function(authID){$scope.editInOperation=!0,$scope.editedAuth={},authID=authID||$scope.newAuth.selected._id,getIdpDetails(authID).then(function(res){$scope.editedAuth=res.data,bindAuthDetails(res.data)},function(err){console.log(JSON.stringify(err.data))})},$scope.authView=function(){$scope.editInOperation=!0,$scope.editedAuth={},getIdpDetails($scope.newAuth.selected._id).then(function(res){$scope.editedAuth=res.data,bindAuthDetails(res.data)},function(err){console.log(JSON.stringify(err.data))})},$scope.callback.showAuthFormModal=function(){$scope.showAuthFormModal()},$scope.hooks.isChanged=function(){return $scope.authForm&&$scope.authForm.$dirty&&!$scope.isDirtyNone},$scope.hooks.triggerSave=function(callback){$scope.afterSave=callback||angular.noop,$scope.setAuth($scope.authForm.$valid,!0)},window.onbeforeunload=function(event){return $scope.authForm&&$scope.authForm.$dirty?i18n.i18nString("auth_form_alert"):void 0},$scope.resetFormHide=function(){$scope.hideOuterForm=!1,$scope.showOuterForm=!0},$scope.resetFormHide(),$scope.$on("triggerShowOuterForm",function(){$scope.hideOuterForm=!1,$scope.showOuterForm=!0}),$scope.$on("triggerHideOuterForm",function(evt,editFieldData,index,formType){$scope.hideOuterForm=!0,$scope.showOuterForm=!1,$scope.fieldIndex=index,$scope.innerFormType=formType,$timeout(function(){editFieldData&&("idp"===formType?$scope.$broadcast("editIDPFieldData",editFieldData,index):"authorization"===formType&&$scope.$broadcast("editAuthFieldData",editFieldData,index))}),$timeout(function(){$(".authMechanism.modalPerfectScroll").scrollTop(0)},200)}),$scope.authinnerform={},$scope.showModalInnerForm=function(formType){$scope.hideOuterForm=!0,$scope.showOuterForm=!1,$scope.innerFormType=formType,$scope.fieldIndex=-1,"idp"===formType?$scope.$broadcast("showIDPFieldForm"):$scope.$broadcast("showAuthFieldForm"),$timeout(function(){$rootScope.$emit("updateModalSize")},800)},$scope.cancelModalInnerForm=function(formType){return $scope.showKeyValueForm?void $scope.cancelAdditionalFieldsForm():("idp"===$scope.innerFormType?$scope.$broadcast("cancelIDPFieldForm"):$scope.$broadcast("cancelAuthFieldForm"),void $timeout(function(){$rootScope.$emit("updateModalSize")},800))},$scope.saveInnerForm=function(formType){return $scope.showKeyValueForm?void $scope.addAdditionalFields($scope.authinnerform.authAdditionalFieldsForm.$valid,$scope.authinnerform.authAdditionalFieldsForm):void("idp"===$scope.innerFormType?$scope.$broadcast("saveIDPFieldForm",$scope.fieldIndex):$scope.$broadcast("saveAuthFieldForm",$scope.fieldIndex))},$scope.isLoading=!0,$scope.btcallback){$scope.btcallback.loadIDPList=function(){_selectedStream=$workflowService.selectedStream(),BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.authLists=res.data,bindAuthMechanism(),$scope.isLoading=!1},function(res){NotificationService.notify(i18n.i18nString("notify_idp"),"error"),$scope.isLoading=!1})},$scope.btcallback.loadIDPList(),$scope.$on("rerenderIDPList",function(){$scope.btcallback.loadIDPList()}),$scope.deleteIDP=function(idpID){$scope.idpTodelete=idpID,NotificationService.alert(i18n.i18nString("delete_idp"),deleteIDPByID,arguments)};var deleteIDPByID=function(idpID){BTIdpService.deleteIdp($scope.idpTodelete,$workflowService.selectedStream()._id).then(function(res){$scope.btcallback.loadIDPList(),NotificationService.notify(i18n.i18nString("idp_delete_success"),"success")},function(error){error.data&&error.data.errors.length&&NotificationService.notify(error.data.errors[0].msg,"error")})};$scope.btcallback.showAuth=function(){$scope.editInOperation=!1,$scope.editAuth={};var newAuth=$scope.newAuth;$scope.resetAuthForm(),$scope.newAuth=newAuth,$scope.newAuth.sso_type={},$scope.showAuthFormModal()}}$scope.$on("$locationChangeStart",function(event,next,current){function successCb(){$scope.setAuth($scope.authForm.$valid)}function failCb(){$scope.authForm.$dirty=!1,$location.path(next)}$scope.skipSaveConfirm||!$scope.authForm.$dirty||$scope.isDirtyNone||"view"===$scope.displayMode||(event.preventDefault(),$scope.afterSave=failCb,NotificationService.confirm({msg:i18n.i18nString("before_proceeding"),successCb:successCb,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("save"),fail:i18n.i18nString("discard")}}))}),$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onFinishSetup=function(type){$scope.configure({type:type})},$scope.$emit("nestedComponentLoaded",{id:"authorization",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),function(){bindEvents()}()}])}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("authInnerForm",function(){return{restrict:"EA",scope:{innerForm:"@",showInnerForm:"&",fields:"=",type:"@?",mode:"="},name:"ctrl",controller:"@",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/auth-inner-form/auth-inner-form.html"}}),_module.controller("authIDPCtrl",["$scope","$rootScope","form_util","$timeout","i18n",function($scope,$rootScope,form_util,$timeout,i18n){$scope.nodeInfo||($scope.nodeInfo={displayMode:"edit"}),$scope.field={title:"",key:"",help:"",type:"string",fieldType:"textbox",visibility:"visible",isRequired:!1},$scope._constants_=$rootScope._constants_,$scope.enable=i18n.i18nString("enable_name"),$scope.disable=i18n.i18nString("Disable"),$scope.fieldCopy=ng.copy($scope.field),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png";var fields,editIndex="noInsert";$timeout(function(argument){if(fields=$scope.fields,!fields){if($scope.fields=$scope.fields||[],$scope.fields.length>0)return;"api_key"===$scope.type?$scope.fields.push({title:i18n.i18nString("provide_key"),help:i18n.i18nString("account_usage"),key:"apiKey",type:"string",isRequired:!0,fieldType:"textbox",placeholder:""}):"basic"===$scope.type&&($scope.fields.push({title:i18n.i18nString("user_email"),placeholder:"",key:"username",type:"string",fieldType:"textbox",isRequired:!0}),$scope.fields.push({title:i18n.i18nString("password"),placeholder:"",key:"password",type:"string",fieldType:"password",isRequired:!0}))}}),$scope.onSave=function(valid,form,event){return valid?($scope.fields=$scope.fields||[],"noInsert"!==editIndex?$scope.fields[editIndex]=ng.copy($scope.field):$scope.fields.push(ng.copy($scope.field)),$scope.bshowForm=!1,$scope.$emit("triggerShowOuterForm"),void(editIndex="noInsert")):void form_util.touch(form)},$scope.deleteField=function(index){"noInsert"===editIndex&&($scope.fields[index].disabled=!$scope.fields[index].disabled,$scope.fields[index]=_.clone($scope.fields[index]))},$scope.editField=function(index){$scope.fields[index].disabled||(editIndex=index,$scope.field=ng.copy($scope.fields[index]),$scope.bshowForm=!0,$scope.$emit("triggerHideOuterForm",$scope.field,editIndex,"idp"),setTimeout(function(){$(".modalBody.authFieldForm").scrollTop(0)},100))},$scope.showForm=function(){$scope.field=ng.copy($scope.fieldCopy),$scope.bshowForm=!0},$scope.$on("showIDPFieldForm",function(){$scope.showForm()}),$scope.onCancel=function(){$scope.field=ng.copy($scope.fieldCopy),$scope.bshowForm=!1,$scope.$emit("triggerShowOuterForm"),editIndex="noInsert"}}]),_module.controller("authFieldsCtrl",["$scope","form_util","$rootScope",function($scope,form_util,$rootScope){$scope.nodeInfo||($scope.nodeInfo={displayMode:"edit"}),$scope.authField={};var editIndex=0,editInOperation=!1;$scope._constants_=$rootScope._constants_,$scope.onSave=function(authField,form){return form&&form.$invalid?void form_util.touch(form):(editInOperation?$scope.fields.splice(editIndex,1,angular.copy($scope.authField)):($scope.fields=$scope.fields?$scope.fields:[],$scope.fields.push(angular.copy(authField))),editInOperation=!1,$scope.authFieldForm=!1,void $scope.$emit("triggerShowOuterForm"))},$scope.$on("showAuthFieldForm",function(){$scope.showAuthFieldForm()}),$scope.$on("cancelAuthFieldForm",function(){$scope.onCancel()}),$scope.$on("saveAuthFieldForm",function(){$scope.onSave($scope.authField,$scope.auth_field_form,$scope)}),$scope.showAuthFieldForm=function(){$scope.authField={},$scope.authFieldForm=!0,setTimeout(function(){$(".modalBody.authFieldForm").scrollTop(0)},100)},$scope.onCancel=function(){$scope.authField={},$scope.authFieldForm=!1,$scope.$emit("triggerShowOuterForm")},$scope.editField=function(index){editInOperation=!0,editIndex=index,$scope.authField=angular.copy($scope.fields[index]),$scope.authFieldForm=!0,$scope.$emit("triggerHideOuterForm",$scope.authField,editIndex,"authorization"),setTimeout(function(){$(".modalBody.authFieldForm").scrollTop(0)},100)},$scope.deleteField=function(index){$scope.fields.splice(index,1)}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("authTestForm",function(){return{restrict:"AE",scope:{onCancel:"&?",onTest:"&?",auth:"=?",idp:"=",type:"@",api:"=",testcontext:"=?",testOnProgress:"=",testStatus:"=",streamAccountId:"=?",callback:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/auth-test-form/auth-test-form.html",controller:["$scope","form_util","$rootScope","$workflowService","BTIdpService","$timeout","NotificationService","$endpoints","$applicationService","$filter","env_conf","BTStreamsService","$q","i18n",function($scope,form_util,$rootScope,$workflowService,BTIdpService,$timeout,NotificationService,$endpoints,$applicationService,$filter,env_conf,BTStreamsService,$q,i18n){function closeAuthProfileTest(){$timeout(function(){$scope.modalSlider.close("auth-form #authorizationProfileSlider"),$scope.modalSlider.close("#authorizationProfileSlider")}),$scope.callback&&$scope.callback.onModalShow&&$scope.callback.onModalShow()}function testIdp(data){var ssoType=$scope.idp.sso_type,idpName=$scope.idp.name;if(makeItClean(),$scope.testcontext=$scope.testcontext||{},$scope.idp.testResult="validating","basic"===ssoType||"api_key"===ssoType||"none"===ssoType||"custom"===ssoType)return $scope.auth={},void getIdpDetails($scope.idp._id).then(function(res){$scope.auth=res.data,showModalSlider("#authorizationProfileSlider"),$scope.showTestAuthForm=!0,$scope.testResponse=!1});$scope.testOnProgress=!0;var context={streamId:$workflowService.selectedStream()._id,idp:idpName,tenant:$scope.authTest.tenant||"",label:$filter("camelcasebreakword")(idpName)+" Account",rurl:env_conf.redirects.success,isDeveloper:!0};authorize(context,{}).then(function(res){var url=res.data.url;launchAuthWindow(url)},function(err){console.log(err)})}function launchAuthWindow(url){var childWindow,strWindowFeatures,title;title="idp"===$scope.type?"Authorization Test":"Request Chain Test",strWindowFeatures="_blank,rel=opener,menubar=no,resizable=no,location=no,toolbar=no,height=500,width=700,resizable=yes,scrollbars=yes,status=yes,left=350,top=80",childWindow=window.open(url,title,strWindowFeatures);var selfClose=!1,pollTimer=setInterval(function(){!selfClose&&childWindow&&childWindow.closed?($timeout(function(){$scope.idp.testResult="aborted",$scope.testOnProgress=!1}),clearInterval(pollTimer)):selfClose&&clearInterval(pollTimer)},1e3);window._succCallback=function(data){$timeout(function(){selfClose=!0,handleRedirectResponse(data,childWindow)})},window._failCallback=function(){$timeout(function(){selfClose=!0,$scope.idp.testResult="failed",$scope.testOnProgress=!1,childWindow.close(),NotificationService.notify(i18n.i18nString("valid_authorization"),"error")})},window._closeCallback=function(){$timeout(function(){selfClose||($scope.idp.testResult="aborted",$scope.testOnProgress=!1)})},childWindow?childWindow.focus():($scope.idp.testResult="",$scope.testOnProgress=!1,NotificationService.notify(i18n.i18nString("browser_popup"),"warning",5e3),childWindow&&childWindow.close())}function authorize(context,payload){return context.isDeveloper="true",BTStreamsService.authorizeIdp(context,payload)}function handleRedirectResponse(authResponse,childWindow){BTStreamsService.getAccounts($workflowService.selectedStream()._id,"true","true").then(function(res){var account=res.data[0];$scope.streamAccountId=account.streamAccountId,$scope.idp.streamAccountId=$scope.streamAccountId,$rootScope.$broadcast("streamAccountId",$scope.streamAccountId),childWindow.close(),$scope.callback?($scope.testOnProgress=!0,$scope.callback($scope.streamAccountId)):($scope.deleteAccount($scope.streamAccountId),$scope.idp.testResult="success",$scope.testOnProgress=!1)},function(err){$scope.idp.testResult="failed",$scope.testOnProgress=!1,childWindow.close()})}function makeItClean(){var form=$scope.authTestForm;for(var key in form)form.hasOwnProperty(key)&&"object"==typeof form[key]&&0!==key.indexOf("$")&&0!==key.indexOf("$$")&&(form[key].$dirty=!1)}function getIdpDetails(id){return id?BTIdpService.getIdp(id,$workflowService.selectedStream()._id):BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){return $scope.authList=res.data,{data:$scope.authList.filter(function(idp){return idp.name===$scope.idp.name})[0]}},function(err){return $q.reject()}).then(function(res){return res&&res.data?BTIdpService.getIdp(res.data._id,$workflowService.selectedStream()._id):BTIdpService.getIdp($scope.authList[0]._id,$workflowService.selectedStream()._id)})}$scope.authTest={},$scope.newAuth={},$scope.reqObj={},$scope.datatypes=$workflowService.seedData().contentTypes,$scope.testing=i18n.i18nString("testing_caps"),$scope.test=i18n.i18nString("test"),$scope.isFirst=!0,$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.custom=!1,$scope.$watch("auth",function(newVal,oldVal){newVal&&"object"==typeof newVal&&Object.keys(newVal).length>0?($scope.authTest.authCheckUrl=newVal.authCheckUrl,$scope.authTest.sso_type=newVal.sso_type,$scope.authTest.hasTenancy=newVal.hasTenancy,$scope.authTest.method="GET",$scope.custom="custom"==newVal.sso_type,$scope.custom&&($scope.authTest.authCheckUrl=newVal.appConfig&&newVal.appConfig.tokenURL||"",$scope.authTest.method=newVal.method,$scope.authTest.contentType=$filter("filter")($scope.datatypes,{value:newVal.contentType}),$scope.authTest.contentType=$scope.authTest.contentType&&$scope.authTest.contentType[0]),$scope.authTest.connectorEnabled=newVal.connectorEnabled):$scope.authTest={},$scope.idptestresponse=null}),$scope.testReqchainObj=function(isValid,form){var components,rcEndpoint,reqobj={},uriParser=window.URI;return isValid?($scope.authTest.hasTenancy&&$scope.authTest.tenant&&($scope.authTest.authCheckUrl=$scope.authTest.authCheckUrl.replace("{tenant}",$scope.authTest.tenant)),$scope.testcontext=angular.copy($scope.authTest),$scope.testOnProgress=!1,reqobj.name=$scope.authTest.name||"Auth Test",reqobj.streamId=$workflowService.selectedStream()._id,reqobj.streamName=$workflowService.selectedStream().name,reqobj.streamAccountId="",components=uriParser.parse($scope.authTest.authCheckUrl),rcEndpoint={host:components.host,port:components.port?components.port+"":"",path:components.path,protocol:components.scheme,contentType:$scope.authTest.contentType.value,method:$scope.authTest.method,connectorEnabled:$scope.authTest.connectorEnabled},rcEndpoint.query&&(rcEndpoint.path+="?"+rcEndpoint.query),rcEndpoint.fragment&&(rcEndpoint.path+="#"+rcEndpoint.fragment),$scope.authTest.userName&&(reqobj.userName=$scope.authTest.userName),$scope.authTest.password&&(reqobj.password=$scope.authTest.password),$scope.authTest.apiKey&&(reqobj.apiKey=$scope.authTest.apiKey),reqobj.endPoint=rcEndpoint,reqobj.method=$scope.authTest.method,void $scope.onAuthFormTest({requestObj:reqobj})):void form_util.touch(form)},$scope.cancelChainForm=function(){$timeout(function(){closeAuthProfileTest(),$scope.idp.testResult=""})};var showModalSlider=function(sliderForm){"showAlertFieldSlider"===sliderForm||"showProcForm"===sliderForm||"showReqForm"===sliderForm?($scope[sliderForm]=!0,setTimeout(function(){$scope.modalSlider.open("#commonId")},500)):setTimeout(function(){$scope.modalSlider.open(sliderForm)},500)};$scope.captureTenant=function(isValid,form){return isValid?($scope.testcontext=angular.copy($scope.auth),closeAuthProfileTest(),$scope.showTestAuthForm=!1,void $timeout(function(){testIdp()})):void form_util.touch(form)},$scope.auth={},$scope.testIdp=function(){var ssoType=$scope.idp.sso_type;$scope.idp.name;makeItClean(),"oauth"===ssoType||"oauth2"===ssoType?($scope.auth={},getIdpDetails($scope.idp._id).then(function(res){$scope.auth=res.data,$scope.auth.hasTenancy?(showModalSlider("#authorizationProfileSlider"),$scope.showTestAuthForm=!0):testIdp()})):testIdp()},$scope.onAuthFormTest=function(authFormObject){$scope.testOnProgress=!0,$scope.idptestresponse=null;var ssoType=$scope.idp.sso_type,idpName=$scope.idp.name,context={streamId:$workflowService.selectedStream()._id,idp:idpName,tenant:$scope.authTest.tenant||"",label:$filter("camelcasebreakword")(idpName)+" Account",rurl:env_conf.redirects.success,isDeveloper:!0},payload={tokens:{}};if("none"!==ssoType)"basic"===ssoType||"custom"===ssoType?payload.tokens={username:authFormObject.requestObj.userName,password:authFormObject.requestObj.password}:"api_key"===ssoType&&(payload.tokens={apiKey:authFormObject.requestObj.apiKey}),authorize(context,payload).then(function(res){var status=res&&res.status||500;return $scope.testOnProgress=!1,$scope.idp.testResult=300>+status?"success":"failed",$scope.idptestresponse={response:JSON.stringify({message:300>+status?"success":"failed"}),headers:{status:status},status:status},$scope.streamAccountId=res.data.streamAccountId,$scope.idp.streamAccountId=$scope.streamAccountId,void($scope.callback?($scope.callback($scope.streamAccountId),closeAuthProfileTest()):(300>+status?NotificationService.notify(i18n.i18nString("test_success",{name:$scope.idp.name}),"success"):NotificationService.notify(i18n.i18nString("test_fail",{name:$scope.idp.name}),"error"),$scope.deleteAccount(res.data&&res.data.streamAccountId)))},function(err){$scope.testOnProgress=!1,$scope.idp.testResult="failed",$scope.custom?$scope.idptestresponse={response:JSON.stringify(err.data),headers:{status:400},status:400}:closeAuthProfileTest(),NotificationService.notify(i18n.i18nString("test_fail",{name:$scope.idp.name}),"error")});else{var requestObj={sso_type:ssoType,idp:idpName,userId:$applicationService.userInfo().userId,streamAccountId:"",requestChain:[{linkType:"apiObject",linkDefinition:authFormObject.requestObj}]};$scope.streamAccountId=requestObj.streamAccountId,$scope.idp.streamAccountId=requestObj.streamAccountId,$rootScope.$broadcast("streamAccountId",$scope.idp.streamAccountId),$scope.callback&&$scope.callback($scope.streamAccountId)}},$scope.deleteAccount=function(streamAccountId){streamAccountId&&BTIdpService.deleteStreamUserAccount(streamAccountId).then(function(res){},function(err){})},$scope.$on("none-auth-test",function(evt,data){$scope.onAuthFormTest(data)}),$scope.api.testIdp=function(){$timeout(function(){$scope.testIdp()})},function(){$scope.connectors=$workflowService.botConnectors()}()}]}})}(angular),function(ng){var _module=ng.module("bt-forms");_module.directive("batchTesting",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/batch-testing/batch-testing.html",controller:["$scope","NotificationService","form_util","$workflowService","pollFactory","$timeout","$interval","env_conf","$applicationService","BTStreamsService","batchTestingService","accessControlService","$rootScope","_constants_","i18n","mixPanel",function($scope,NotificationService,form_util,$workflowService,pollFactory,$timeout,$interval,env_conf,$applicationService,BTStreamsService,batchTestingService,accessControlService,$rootScope,_constants_,i18n,mixPanel){function getDisplayTime(time){var parts=time.split(" "),timeParts=parts[1].split(":"),dateParts=parts[0].split("/");return 1==dateParts[0].length&&(dateParts[0]="0"+dateParts[0]),1==dateParts[1].length&&(dateParts[1]="0"+dateParts[1]),dateParts.join("-")+" "+timeParts[0]+":"+timeParts[1]+" "+parts[2]}$scope.parentDisplayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BATCH_TESTING"),$scope.assetsBase=env_conf["assets-url"],$scope.selectedStream=$workflowService.selectedStream(),$scope.userInfo=$applicationService.userInfo(),$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.chevronRight=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-right-gray.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.batchEmptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/empty-batch-testing.png",$scope.limit=5,$scope.rightClass="right700",$scope._constants_=_constants_,$scope.dataset={},$scope.dataset.type="json",$scope.streamstate={},$scope.streamstate.toggleState=$workflowService.selectedStreamState();var newProgressValues,moreAvailable=!1;$scope.RunReportPercentage={failure:0,success:0},$scope.data_set=i18n.i18nString("data_set"),$scope.file_is_required=i18n.i18nString("file_is_required"),$scope.update_label=i18n.i18nString("update"),$scope.create_label=i18n.i18nString("create_label"),$scope.char_remaining=i18n.i18nString("char_remaining"),$scope.update_test_suite=i18n.i18nString("batch_testing_update_test_suite"),$scope.new_test_suite=i18n.i18nString("batch_testing_new_test_suite"),$scope.loadingBatchTestSuits=!1,$scope.channel={enable:!0};var currentTestSuiteId="";$scope.graphData=[],$scope.checkForUniversal=function(){"universalbot"==$scope.selectedStream.type?$scope.isUniversalbot=!0:$scope.isUniversalbot=!1},$scope.checkForUniversal();var notify=function(msg,type){NotificationService.notify(msg,type)};$scope.testSuitRunning={};var resultTypeObject={TP:"True Positive",TN:"True Negative",FP:"False Positive",FN:"False Negative"};$scope.isTestSuitReport=!1;var poll;$scope.lastRunDetails=[{lastRunDate:"2016-08-28",successPercentage:"93%",f1Score:.99,precision:2.7,recall:1.5}],$scope.anyTaskAvailable=function(){return $scope.selectedStream._taskCounts.totalTasksInUse||$workflowService.alertTasks().length||$workflowService.actionTasks().length||$workflowService.dialogTasks().length||$workflowService.knowledgeTasks().length},$scope.lastRunDetails=[],$scope.batchTestingData={fileId:"",testSuits:[]},$scope.resetBatchingData=function(){$scope.batchTestingData.name="",$scope.batchTestingData.description="",$scope.batchTestingData.newSuitForm&&$scope.batchTestingData.newSuitForm.$setPristine()},$scope.openNewTestSuitModal=function(testSuitData,e){var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};if(mixPanel.postEvent("New Batch Test Creation",_botInfo),e&&e.stopImmediatePropagation(),$scope.deleteBatchFile(),$scope.openModalSlider("#batchTestingSlider"),$scope.testSuitIDToEdit="",testSuitData){$scope.batchTestingData.name=testSuitData.name,$scope.batchTestingData.description=testSuitData.description,$scope.batchTestingData.qafile={},$scope.batchTestingData.fileId=testSuitData.fileId,$scope.batchTestingData.qafile.fileName=testSuitData.fileName;var _ext=$scope.batchTestingData.qafile.fileName.substring($scope.batchTestingData.qafile.fileName.lastIndexOf("."));".json"===_ext?$scope.dataset.type="json":$scope.dataset.type="csv",$("#qafileimport").val(testSuitData.fileName),$scope.testSuitIDToEdit=testSuitData._id}$timeout(function(){$(".newTestSuitModal .ps-container").scrollTop(0)},500)},$scope.closeNewTestSuiteModal=function(){$scope.btCreationErrors=[],$scope.resetBatchingData(),$scope.closeModalSlider("#batchTestingSlider"),$scope.unmatchedIntents=[],$("[data-toggle=popover]").popover("hide"),$scope.creationErrorIntents={},$scope.creationError=""},$scope.deleteRunDetailsComplete=function(e,testSuitDetails){e.stopPropagation(),NotificationService.confirm({heading:i18n.i18nString("are_you_sure"),msg:i18n.i18nString("test_suite_delete_all"),headerClass:"confirmationHeader",bodyClass:"confirmationbody",successCb:function(){BTStreamsService.deleteRunDetailsAll($scope.selectedStream._id,testSuitDetails._id).then(function(res){$scope.getAllTestSuits(),console.log(res)},function(err){try{NotificationService.notify(err.data.errors[0].msg,"error")}catch(e){NotificationService.notify("Unable to delete run details","error")}})},failCb:function(){},isModal:!0,btnTexts:{success:i18n.i18nString("confirm"),fail:i18n.i18nString("cancel")}})},$scope.deleteRunDetails=function(runDetails){NotificationService.confirm({heading:i18n.i18nString("are_you_sure"),msg:i18n.i18nString("test_suite_delete"),headerClass:"confirmationHeader",bodyClass:"confirmationbody",successCb:function(){BTStreamsService.deleteRunDetails($scope.selectedStream._id,runDetails.testSuiteId,runDetails._id).then(function(res){$scope.viewReport(currentTestSuiteId,0),NotificationService.notify("Test Suite Execution results deleted successfully","success"),console.log(res)},function(err){try{NotificationService.notify(err.data.errors[0].msg,"error")}catch(e){NotificationService.notify("Unable to delete run details","error")}})},failCb:function(){},isModal:!0,btnTexts:{success:i18n.i18nString("confirm"),fail:i18n.i18nString("cancel")}})},$scope.getAllTestSuits=function(){$scope.loadingBatchTestSuits=!0,batchTestingService.getAllTestSuits($scope.userInfo.userId,$scope.selectedStream._id).then(function(response){$scope.batchTestingData.testSuits=response.data,$scope.batchTestingData.testSuits.length&&$scope.$emit("updateChecklist","batchTesting"),setTimeout(function(){$scope.loadingBatchTestSuits=!1},200)},function(error){}),console.log("get all test suites")},$scope.createTestSuit=function(){var payload={importType:"update",delimiter:","};return $scope.uploadedFileTYpe!==$scope.dataset.type?void notify(i18n.i18nString("selected_file_of_different_format"),"error"):(payload.fileType=$scope.dataset.type,payload.fileName=$scope.batchTestingData.fileId||"",payload.fileName||notify(i18n.i18nString("please_upload_json_before_proceed_noty"),"error"),payload.name=$scope.batchTestingData.name||"",payload.description=$scope.batchTestingData.description||"",batchTestingService.createTestSuit($scope.userInfo.userId,$scope.selectedStream._id,payload).then(function(res){$scope.btCreationErrors=[],res.data._id&&($scope.batchTestingData.testSuits.push(res.data),$scope.closeNewTestSuiteModal(),$scope.$emit("updateChecklist","batchTesting")),res.data.msg&&res&&res.data&&res.data.msg&&($scope.btCreationErrors=res.data.msg.split("\n")),res.data.msg&&!res.data.unmacthedIntents&&($scope.creationError=res.data.msg),res.data.msg&&res.data.unmacthedIntents&&($scope.unmatchedIntents=[],$scope.creationError="",$scope.unmatchedIntents=res.data.unmacthedIntents),setTimeout(function(){$(".innerRightBody").animate({scrollTop:$(".innerRightBody").height()},1e3),$(".batchTesting .ps-container").animate({scrollTop:$(".batchTesting .ps-container").height()},1e3)},500)},function(error){if(error.data.errors&&error.data.errors.length&&error.data.errors[0].msg)for(notify(i18n.i18nString("test_suite_creation_failed"),"error"),$scope.unmatchedIntents=[],$scope.creationError="",error&&error.data&&error.data.errors[0]&&error.data.errors[0].msg&&($scope.btCreationErrors=error.data.errors[0].msg.split("\n")),$scope.creationErrorIntents=error.data.errors[0].msg.split(","),$scope.creationError=$scope.creationErrorIntents[0],i=1;i<$scope.creationErrorIntents.length;i++)$scope.unmatchedIntents[i-1]=$scope.creationErrorIntents[i]}),void console.log("test suit creation"))},$scope.updateTestSuit=function(testSuitId){var payload={importType:"update",delimiter:","};return $scope.uploadedFileTYpe!=="."+$scope.dataset.type?void notify(i18n.i18nString("selected_file_of_different_format"),"error"):(payload.fileType=$scope.dataset.type,payload.fileName=$scope.batchTestingData.fileId||"",payload.fileName||notify(i18n.i18nString("please_upload_label_before_proceed",{dyn:$scope.dataset.type}),"error"),payload.name=$scope.batchTestingData.name||"",payload.description=$scope.batchTestingData.description||"",batchTestingService.updateTestSuit($scope.userInfo.userId,$scope.selectedStream._id,testSuitId,payload).then(function(res){
if($rootScope.$broadcast("getProgressDockStatus"),console.log(res),res.data._id){var index=_.findIndex($scope.batchTestingData.testSuits,{_id:testSuitId});$scope.batchTestingData.testSuits[index]=res.data,$scope.closeNewTestSuiteModal()}res.data.msg&&notify(res.data.msg,"error")},function(error){error.data.errors&&error.data.errors.length&&error.data.errors[0].msg&&notify(error.data.errors[0].msg,"error")}),void console.log("updating test suit"))},$scope.createOrUpdateTestSuit=function(_form){if(!_form.$valid)return void form_util.touch(_form);if($scope.testSuitIDToEdit){if($scope.batchTestingData.qafile.fileName){var _ext=$scope.batchTestingData.qafile.fileName.substring($scope.batchTestingData.qafile.fileName.lastIndexOf("."));$scope.uploadedFileTYpe=_ext}else $scope.uploadedFileTYpe="."+$scope.dataset.type;$scope.updateTestSuit($scope.testSuitIDToEdit)}else $scope.createTestSuit()},$scope.pollingPercentageWidth={},$scope.pollingPercentage={},$scope.progressStatus={},$scope.progressUttStatus={},$scope.runTestSuit=function(testSuitId){var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};if(mixPanel.postEvent("Run Batch Test",_botInfo),$scope.progressStatus[testSuitId]="0 records completed",0===$scope.anyTaskAvailable())return void notify(i18n.i18nString("no_tasks_are_available"),"error");var payload={timezone:moment.tz.guess()};$("#dev-"+testSuitId)[0]&&$("#dev-"+testSuitId)[0].checked===!0?payload.runType="inDevelopment":payload.runType="published",$scope.testSuitRunning[testSuitId]=!0,batchTestingService.runTestSuit($scope.userInfo.userId,$scope.selectedStream._id,testSuitId,payload).then(function(response){console.log(response),NotificationService.notify(i18n.i18nString("execution_of_batch_testing_in_progress"),"success"),$rootScope.$broadcast("getProgressDockStatus"),$(".trainingProgress").addClass("open");var testRunObject=response.data;$scope.pollingPercentageWidth[testSuitId]={width:"2px"},$scope.pollingPercentage[testSuitId]=0,$scope.progressUttStatus[testSuitId]=0,testRunObject.cb=$scope.getDetailsByTestRunID,$scope.batchTestingData[""+testSuitId]=$scope.batchTestingData[""+testSuitId]||{},$scope.batchTestingData[""+testSuitId].runHistory=$scope.batchTestingData[""+testSuitId].runHistory||[],$scope.batchTestingData[""+testSuitId].runHistory.push(response.data),pollFactory.subscribe(testRunObject),$scope.$emit("updateChecklist","batchTesting")},function(error){console.log(error),error.data.errors[0].msg==i18n.i18nString("ml_utterances_are_not_defined")?(notify(i18n.i18nString("ml_utterances_are_not_defined"),"error"),$scope.testSuitRunning[testSuitId]=!1):(notify(error.data.errors[0].msg,"error"),$scope.testSuitRunning[testSuitId]=!1)}),console.log("running test suit")},$scope.getDetailsByTestRunID=function(testSuitId,testRunID){var payload={};batchTestingService.getDetailsByTestRunID($scope.userInfo.userId,$scope.selectedStream._id,testSuitId,testRunID,payload).then(function(response){"running"==response.data.status&&($rootScope.$broadcast("getProgressDockStatus"),$scope.pollingPercentageWidth[testSuitId]={width:response.data.percentage},$scope.pollingPercentage[testSuitId]=response.data.percentage.toFixed(2),$scope.progressUttStatus[testSuitId]=response.data.utterance_ran+"/"+response.data.totalUtterances,newProgressValues=$scope.progressUttStatus[testSuitId],$scope.progressStatus[testSuitId]=response.data.utterance_ran+i18n.i18nString("out_of_label")+response.data.totalUtterances+i18n.i18nString("records_completed_label")),console.log(response),"running"!==response.data.status&&($rootScope.$broadcast("getProgressDockStatus"),$scope.pollingPercentage[testSuitId]=100,$scope.pollingPercentageWidth[testSuitId]={width:100},pollFactory.unSubscribe(response.data._id),$scope.viewReport(testSuitId),$scope.testSuitRunning[testSuitId]=!1)},function(error){console.log(error),$scope.testSuitRunning[testSuitId]=!1})},$scope.viewReport=function(testSuitId,offset){offset=offset||0,currentTestSuiteId=testSuitId;var payload={};$scope.fetching=!0,$timeout(function(){batchTestingService.viewReport($scope.userInfo.userId,$scope.selectedStream._id,testSuitId,payload,offset,$scope.limit).then(function(response){0===offset&&$scope.$broadcast("changeCurrentPage",1),$scope.batchTestingData[""+testSuitId]=$scope.batchTestingData[""+testSuitId]||{},$scope.batchTestingData[""+testSuitId].runHistory=response.data.results||[],$scope.fetching=!1,$scope.batchTestingData[""+testSuitId].runHistory.length>0&&$scope.checkForPendingRun($scope.batchTestingData[""+testSuitId].runHistory,testSuitId),moreAvailable=response.data.moreAvailable,$scope.totalItems=response.data.count,$timeout(function(){$('[data-toggle="popover"]').popover("destroy"),$('[data-toggle="popover"]').popover(),document.getElementById("dev-"+testSuitId)&&(document.getElementById("dev-"+testSuitId).checked=!0)},300)},function(error){$scope.fetching=!1,console.log(error)}),console.log("view report")},300)},$scope.openBatchReportModal=function(){$(".batchTestingModal").modal("show")},$scope.closeBatchReportModal=function(){$(".batchTestingModal").modal("hide")},$scope.getReportDetailsByRunID=function(testSuitId,testRunID){var payload={};batchTestingService.getDetailsByTestRunID($scope.userInfo.userId,$scope.selectedStream._id,testSuitId,testRunID,payload).then(function(response){$scope.isTestSuitReport=!0;var testSuitObject=_.find($scope.batchTestingData.testSuits,{_id:testSuitId});$scope.TestSuitname=testSuitObject&&testSuitObject.name||"",$scope.reportName=$scope.reportByname(response.data,$scope.TestSuitname),$scope.runReport=response.data,$scope.runReport.result&&$scope.runReport.result.results&&($scope.RunReportPercentage.success=$scope.runReport.result.results.success,$scope.RunReportPercentage.failure=$scope.runReport.result.results.failure)},function(error){console.log(error)})},$scope.downloadFile=function(data,index,evt,fileName){function startExport(){evt.preventDefault(),BTStreamsService.batchtestingReportLink($scope.selectedStream._id,data.fileId,"batchtesting").then(function(res){if(res&&res.data){$scope.hrefURL=res.data.fileUrl+"&clientfilename="+(fileName||"BatchTesting")+".csv&batchtesting=true";var xyz="#report"+index;$(xyz).attr("href",$scope.hrefURL),$(xyz).attr("download",!0),$(xyz).on("click",function(e){e.stopPropagation()}),$timeout(function(){$(xyz).get(0).click(function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()})},750)}})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export")):startExport()},$scope.reportByname=function(res,TestSuitname){return"AllMlUtterances"==res.testSuiteId?"Developer Defined Utterances":"Last100sentences"==res.testSuiteId?"Successful User Utterances":TestSuitname},$scope.getPercentage=function(totalSum,num){if(totalSum&&num){var _percentage=num/totalSum*100||0;return _percentage}return 0},$scope.succPercentage=function(trueResult,falseResult){var totalVal=(trueResult||0)+(falseResult||0),_percentage=trueResult/totalVal*100||0;return _percentage},$scope.isCollapsed=function(ele){return $(ele).hasClass("collapsed")},$scope.generatePieChart=function(){var results=$scope.runReport.result&&$scope.runReport.result.results||{};if(_.isEmpty(results)||!(results.FN||results.FP||results.TN||results.TP))return $("#chartContainter").html("<span style='text-align:center'>"+i18n.i18nString("reports_are_not_available")+"</span>"),void($scope.graphData=[]);var totalSum=results.FN+results.FP+results.TN+results.TP,fnPer=results.FN/totalSum*100||0,fpPer=results.FP/totalSum*100||0,tnPer=results.TN/totalSum*100||0,tpPer=results.TP/totalSum*100||0,dataFromYou=[{name:"Talks",children:[{name:i18n.i18nString("true_positive_label"),size:tpPer},{name:i18n.i18nString("true_negative_label"),size:tnPer},{name:i18n.i18nString("false_positive_label"),size:fpPer},{name:i18n.i18nString("false_negative_label"),size:fnPer}]}],data=dataFromYou[0].children,width=500,height=350,radius=100,r=100,labelr=r+30,color=d3.scaleOrdinal().range(["#d5d0b0","#739240","#c86000","#425227"]);$scope.graphData=[{color:"#d5d0b0",text:""},{color:"#739240",text:""},{color:"#c86000",text:""},{color:"#425227",text:""}],$scope.getTwoDeci=function(value,decimals){return Number(Math.round(value+"e"+decimals)+"e-"+decimals)},$.each(data,function(i,dd){$scope.graphData[i].text=$scope.getTwoDeci(dd.size,2)+"% "+dd.name});var outerRadius=radius,arc=d3.arc().outerRadius(outerRadius).innerRadius(0),pie=d3.pie().sort(null).value(function(d){return d.size});$("#chartContainter").html("");var svg=d3.select("#chartContainter").append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate("+2.23*outerRadius+","+1.5*outerRadius+")"),g=svg.selectAll(".arc").data(pie(data)).enter().append("g").attr("class","arc");g.append("path").attr("d",arc).style("fill",function(d){return color(d.data.name)}),g.append("text").attr("transform",function(d){d.outerRadius=outerRadius+50,d.innerRadius=outerRadius+45;var c=arc.centroid(d),x=c[0],y=c[1],h=Math.sqrt(x*x+y*y);return"translate("+x/(3*h)*labelr+","+y/h*labelr+")"}).attr("dy",".35em").style("font-size","16px").style("color","#333").style("font-family","Inter").attr("text-anchor",function(d){return(d.endAngle+d.startAngle)/2>Math.PI?"end":"start"}).text(function(d){return d.data.size?void 0:""})},$scope.viewTestSuites=function(){$scope.isTestSuitReport=!1,$scope.closeBatchReportModal(),$("#chartContainter").html("")},$scope.changeFile=function(event){event.target.value="",$scope.btCreationErrors=[]},$scope.uploadCSVorJSONFile=function(){if($scope.btCreationErrors=[],!$scope.batchTestingData.qaFile)return void($scope.isGlobalWorkProgress=!1);$scope.unmatchedIntents=[];var supportingFileFormats;$("[data-toggle=popover]").popover("hide"),$scope.creationErrorIntents={},$scope.creationError="",$scope.isGlobalWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("updating_data_label");var _ext="";if($scope.batchTestingData.qaFile.name&&(_ext=$scope.batchTestingData.qaFile.name.substring($scope.batchTestingData.qaFile.name.lastIndexOf(".")),"json"==$scope.dataset.type?supportingFileFormats=[".json"]:"csv"==$scope.dataset.type&&(supportingFileFormats=[".csv"]),-1===$.inArray(_ext,supportingFileFormats)))return notify(i18n.i18nString("upload_only_label_files",{dyn:$scope.dataset.type}),"error"),$scope.fileExtensionError=!0,void($scope.isGlobalWorkProgress=!1);$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.batchTestingData.qaFile),data.append("fileContext","bulkImport"),data.append("fileExtension",_ext.substring(_ext.lastIndexOf(".")+1)),data.append("Content-Type","txt/json"),$scope.qafileuploading=!0,BTStreamsService.uploadFAQFile($applicationService.userInfo().userId,data).then(function(response){$scope.uploadedFileTYpe=$scope.dataset.type;var fileUploaded={fileName:$scope.batchTestingData.qaFile.name,fileId:response.data.fileId};$scope.batchTestingData.fileId=response.data.fileId,$scope.batchTestingData.qafile=fileUploaded,$scope.isGlobalWorkProgress=!1,notify(fileUploaded.fileName+" "+i18n.i18nString("uploaded_label"),"success"),$scope.qafileuploading=!1},function(err){$scope.isGlobalWorkProgress=!1,err.data&&err.data.errors&&err.data.errors[0]&&notify(i18n.i18nString("oops_label")+err.data.errors[0].msg,"error"),notify(i18n.i18nString("oops_file_upload_failed"),"error"),$scope.qafileuploading=!1})},$scope.deleteBatchFile=function(){$scope.batchTestingData.qafile=null,$("#qaFile").val(""),$("#qafileimport").val(""),$scope.batchTestingData.fileId=""},$scope.stopPolling=function(){$interval.cancel(poll)},$scope.$on("$destroy",function(){$scope.stopPolling()}),$scope.getValue=function(value,defaultValue,fullDetailsFor){return"resultType"==fullDetailsFor&&(value=resultTypeObject[value]),value?value:defaultValue},$scope.checkForPendingRun=function(testSuitRuns,testSuitId){$scope.pollingPercentageWidth={},$scope.pollingPercentage={},$scope.progressStatus={},$scope.progressUttStatus={};var testRunObject=_.find(testSuitRuns,{status:"running"});testRunObject&&(testRunObject.cb=$scope.getDetailsByTestRunID,testRunObject._id=testRunObject._id||testRunObject.id,testRunObject.testSuiteId=testSuitId,$scope.pollingPercentageWidth[testSuitId]={width:"2px"},$scope.pollingPercentage[testSuitId]=0,$scope.progressUttStatus[testSuitId]=newProgressValues||0,$scope.testSuitRunning[testSuitId]=!0,pollFactory.unSubscribe(testRunObject._id),pollFactory.subscribe(testRunObject))},$scope.getLocaleTime=function(time,timeInAMPM){return time?(time=new Date(time).toLocaleString("en-US").replace(/-/g,"/"),time=getDisplayTime(time)):"--"};var init=function(){$scope.getAllTestSuits()};init(),$scope.$emit("nestedComponentLoaded",{id:"batchTesting",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-streams");_module.directive("botChannelResponseManage",["$timeout","$workflowService","$filter","BTFlowtaskService",function($timeout,$workflowService,$filter,BTFlowtaskService){return{restrict:"EA",scope:{streamId:"=",streamType:"=",searchTerm:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-channel-response-manage/bot-channel-response-manage.html",controller:["$scope","BTStreamsService","channelsConfig","$routeParams","$timeout","$location","NotificationService","$filter","env_conf","accessControlService","$interval","i18n","$applicationService",function($scope,BTStreamsService,channelsConfig,$routeParams,$timeout,$location,NotificationService,$filter,env_conf,accessControlService,$interval,i18n,$applicationService){function getLabel(obj,type){var curField=null,curTask=$scope.availableTasks.filter(function(task){return task._id===obj.taskId})[0];return curTask?"task"===type?curTask.label||curTask.name:curTask&&(curTask.alertFieldsDefinition||curTask.payloadField||curTask.queryField)?(curTask&&curTask.alertFieldsDefinition?$scope.availFields=curTask.alertFieldsDefinition||[]:curTask&&curTask.queryField&&curTask.payloadField&&($scope.availFields=curTask.queryField.concat(curTask.payloadField)||[]),curField=$scope.availFields.filter(function(field){return field.key===obj.fieldId})[0],curField.title):curTask&&curTask.nodes?(curField=$scope.availEntities.filter(function(_node){return _node._id===obj.fieldId})[0],curField&&curField.name?curField.name:""):void 0:""}function getOverrideValues(options){var valuesArray=[];if(!options||!options.length)return valuesArray;for(var i=0;i<options.length;i++){var subOption=options[i];if(subOption.hasOwnProperty("botUXMap")){var obj={channel:subOption.channel,_id:subOption._id,uXMap:subOption.botUXMap.uXMap,isMarkDown:subOption.botUXMap.isMarkDown,show:!1};"wfacebook"===subOption.channel&&subOption.isMention?(obj.channel="wfacebookG",obj.isMention=subOption.isMention):"wfacebook"!==subOption.channel||subOption.isMention||(obj.channel="wfacebookC",obj.isMention=subOption.isMention),valuesArray.push(obj)}if(subOption.hasOwnProperty("taskUXMaps"))for(var j=0;j<subOption.taskUXMaps.length;j++){var taskSpecific=subOption.taskUXMaps[j],obj1={channel:subOption.channel,_id:taskSpecific._id,taskId:taskSpecific.taskId,taskLabel:getLabel(taskSpecific,"task"),uXMap:taskSpecific.uXMap,isMarkDown:taskSpecific.isMarkDown,show:!1};"wfacebook"===subOption.channel&&subOption.isMention?(obj1.channel=i18n.i18nString("constants.iconsTooltips_Workplace For Groups"),obj1.isMention=subOption.isMention):"wfacebook"!==subOption.channel||subOption.isMention||(obj1.channel=i18n.i18nString("constants.iconsTooltips_Workplace For Chat"),obj1.isMention=subOption.isMention),valuesArray.push(obj1)}if(subOption.hasOwnProperty("fieldUXMaps"))for(var k=0;k<subOption.fieldUXMaps.length;k++){var fieldSpecific=subOption.fieldUXMaps[k],obj2={channel:subOption.channel,_id:fieldSpecific._id,taskId:fieldSpecific.taskId,taskLabel:getLabel(fieldSpecific,"task"),fieldId:fieldSpecific.fieldId,fieldLabel:getLabel(fieldSpecific,"field"),uXMap:fieldSpecific.uXMap,isMarkDown:fieldSpecific.isMarkDown,show:!1};"wfacebook"===subOption.channel&&subOption.isMention?(obj2.channel=i18n.i18nString("constants.iconsTooltips_Workplace For Groups"),obj2.isMention=subOption.isMention):"wfacebook"!==subOption.channel||subOption.isMention||(obj2.channel=i18n.i18nString("constants.iconsTooltips_Workplace For Chat"),obj2.isMention=subOption.isMention),valuesArray.push(obj2)}}for(var l=0;l<valuesArray.length;l++){var curValue=valuesArray[l];curValue.hasOwnProperty("fieldId")||(curValue.hasOwnProperty("taskId")?(curValue.fieldId="default",curValue.fieldLabel=i18n.i18nString("any_field")):"default"===curValue.channel?(curValue.taskLabel="-",curValue.fieldLabel="-"):(curValue.taskId="default",curValue.taskLabel=i18n.i18nString("any_task"),curValue.fieldLabel="-"))}return valuesArray}function getGenericMessages(streamId){BTStreamsService.getGenericMessages(streamId).then(function(res){for(var index=0;index<=_defaultOrder.length-1;index++)res.data&&res.data.messages&&res.data.messages[_defaultOrder[index]]&&($scope.categories.push({type:_defaultOrder[index],active:!1,searchResultsCount:0}),res.data.messages[_defaultOrder[index]].map(function(message){var obj={};obj.title=message.Condition,obj.key=message.Key,obj.type=_defaultOrder[index],obj.showAddOptions=!1,obj.editLocked=message.editLocked||!1,obj.hideMessage=message.hideOriginalMessages||!1,message["Original Message"]=convertTolistOfObjects(message["Original Message"]),obj.ivrOptions=message.ivrOptions,obj.value=message["Original Message"],obj.channelUXMaps=message.channelUXMaps?message.channelUXMaps:[],obj.override=getOverrideValues(obj.channelUXMaps),$scope.genericMessages.push(angular.copy(obj)),isGenMessAvail=!0}));messagesCopy=angular.copy($scope.genericMessages),$scope.categories[0].active=!0,$scope.currentCategory=$scope.categories[0].type,isCategoriesAval=!0,$scope.loading=!1},function(err){$scope.genericMessages=[],$scope.loading=!1})}function updateIvrStreamData(streamObj){BTStreamsService.editStream($workflowService.selectedStream()._id,streamObj).then(function(response){if(response.data.ivrSettings){$scope.enabled=response.data.ivrSettings.enable,$workflowService.selectedStream(response.data);$scope.enabled?i18n.i18nString("settings_enabled"):i18n.i18nString("settings_disabled");prepareIVRData()}})}function prepareIVRData(){("entity"===$scope.nodeInfo.dialogNodeInstance.type||"dialogAct"===$scope.nodeInfo.dialogNodeInstance.type||"message"===$scope.nodeInfo.dialogNodeInstance.type)&&($scope.headingsList.showIVRProperty.show=!0,$scope.isEnabled=!1,_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable&&($scope.isEnabled=_selectedStream.ivrSettings.enable,$scope.nodeInfo.nodeInfo&&!$scope.nodeInfo.nodeInfo.ivrOptions?($scope.nodeInfo.nodeInfo.ivrOptions={},angular.copy(_defaultIVRProps,$scope.nodeInfo.nodeInfo.ivrOptions)):$scope.nodeInfo.nodeInfo.ivrOptions&&!$scope.nodeInfo.nodeInfo.ivrOptions.errorPrompts&&($scope.nodeInfo.nodeInfo.ivrOptions.errorPrompts=[]),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&($scope.originalIvrGrammerCopy=angular.copy($scope.nodeInfo.nodeInfo.ivrOptions.grammars)),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.advance.properties&&($scope.originalIvrVxmlCopy=angular.copy($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties))))}function deleteOverrideFromUxMaps(channelUXMaps,override){return channelUXMaps.splice($scope.currentIndex,1),channelUXMaps}function updateChannelUXMaps(channelUXMaps){var curChannel;curChannel||(curChannel={channel:$scope.newOverride.channel},"Workplace For Groups"===curChannel.channel||"wfacebookG"===curChannel.channel?(curChannel.channel="wfacebook",curChannel.isMention=!0):("Workplace For Chat"===curChannel.channel||"wfacebookC"===curChannel.channel)&&(curChannel.channel="wfacebook",curChannel.isMention=!1),channelUXMaps.push(curChannel));var uXMap=$scope.newOverride.isMarkDown?$scope.newOverride.markdownValue:$scope.newOverride.jsEditorValue;if($scope.newOverride.isMarkDown||-1===uXMap.indexOf("<% ")&&-1===uXMap.lastIndexOf("%>")&&(uXMap="<% "+uXMap+" %>"),$scope.newOverride.hasOwnProperty("fieldId")&&$scope.newOverride.fieldId&&"default"!==$scope.newOverride.fieldId){curChannel.hasOwnProperty("fieldUXMaps")||(curChannel.fieldUXMaps=[]);var obj={taskId:$scope.newOverride.taskId,fieldId:$scope.newOverride.fieldId,uXMap:uXMap,isMarkDown:$scope.newOverride.isMarkDown};curChannel.fieldUXMaps.push(obj)}else if($scope.newOverride.hasOwnProperty("taskId")&&$scope.newOverride.taskId&&"default"!==$scope.newOverride.taskId){curChannel.hasOwnProperty("taskUXMaps")||(curChannel.taskUXMaps=[]);var obj1={taskId:$scope.newOverride.taskId,uXMap:uXMap,isMarkDown:$scope.newOverride.isMarkDown};curChannel.taskUXMaps.push(obj1)}else curChannel.hasOwnProperty("botUXMap")||(curChannel.botUXMap={}),curChannel.botUXMap.uXMap=uXMap,curChannel.botUXMap.isMarkDown=$scope.newOverride.isMarkDown;var msgsToSend=[];_.map(editingMessage.value,function(msg){msgsToSend.push(msg.message)}),$scope.message&&$scope.message.hideMessage===!1&&msgsToSend.forEach(function(obj,index){var _obj1={taskUXMaps:[],fieldUXMaps:[],channel:"default",botUXMap:{uXMap:obj,isMarkDown:!0}};channelUXMaps.push(_obj1)});var finalJSON={streamId:streamId,Condition:editingMessage.title,Key:editingMessage.key,"Original Message":msgsToSend,channelUXMaps:channelUXMaps,hideOriginalMessages:!0};return finalJSON}function getTaskFields(){if("default"!==$scope.newOverride.taskId){var currentTask=$scope.availableTasks.filter(function(task){return task._id===$scope.newOverride.taskId})[0];currentTask&&currentTask.alertFieldsDefinition?$scope.availableFields=currentTask.alertFieldsDefinition:currentTask&&currentTask.queryField&&currentTask.payloadField?$scope.availableFields=currentTask.queryField.concat(currentTask.payloadField):currentTask&&currentTask.nodes&&BTFlowtaskService.getFlowtaskComponents($workflowService.selectedStream()._id,currentTask._id).then(function(res){$scope.availableFields=_.filter(res.data,{type:"entity"})||[]})}}function openAddMessage(){$scope.openState=!0,$scope.openModalSlider("#standardResSlider")}function convertTitleValueToObjAndPullChanges(messages){var result={};return messages.map(function(message,index){message.value&&message.value.join(",")!=messagesCopy[index].value.join(",")&&(result[message.key]={Category:message.type,Condition:message.title,Key:message.key,"Original Message":message.value})}),result}function goToHome(){$location.path(window.appConfig.CONTEXT_PATH)}function unique(array){for(var a=array.concat(),i=0;i<a.length;++i)for(var j=i+1;j<a.length;++j)a[i]===a[j]&&a.splice(j--,1);return a}function convertTolistOfObjects(arr){var originalMsg=angular.copy(arr),res=[];return originalMsg.map(function(msg){res.push({message:msg,show:!1})}),res}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE");var streamId=$scope.streamId,streamType=$scope.streamType,messagesCopy=[];if($scope.assetsBase=env_conf["assets-url"],$scope.api={},$scope.rightClass="right700",$scope.message=[],$scope.save=i18n.i18nString("save"),$scope.savingLabel=i18n.i18nString("saving"),$scope.modalTitle=i18n.i18nString("edit_modal"),$scope.greenEllipsis=env_conf["context-url"]+"/assets/icons-new/ellipsis/ellipsis-green.svg",$scope.currentPage=1,$scope.edit=i18n.i18nString("edit"),$scope.add=i18n.i18nString("add_label"),$scope.loading=!0,$scope.editFlag=!1,$scope.isBasic=!0,$scope.isEnabled=!0,!streamId)return void goToHome();$scope.check="",$scope.genericMessages=[],$scope.categories=[],$scope.openState=!1,$scope.manage_var_channel_response={},$scope.manageVarChannelRespEnable=!1,$scope.newOverrideInProgress=!1,$scope.savingNewOverride=!1,$scope.newOverride={isMarkDown:!0},$scope.newGeneric={isMarkDown:!0},$scope.search={text:""};var _selectedStream=angular.copy($workflowService.selectedStream());$scope.stand_resp_voice_channels_all_cb={},$scope.isStandAllVoiceEnabled=!1;var isCategoriesAval=!1;$scope.searchTerm.appendSearch=function(text){$scope.search.text=text,$scope.FilterMessages(!0)},$scope.modalSlider={},$scope.newGenericInProgress=!1,$scope.savingNewGeneric=!1,$scope.newGeneric={},$scope.cbIvr={},$scope.allowNamespace=$workflowService.selectedStream().enableNameSpace,$scope.stream=$workflowService.selectedStream(),channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.availableChannels=Object.values(channelsConfig.channelsObject),$scope._channelConfig=channelsConfig;var isWFacebook=!1,wfacebookIndex=0,isGenMessAvail=!1;$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.pencilIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/pencilIconGreen.svg",$scope.trashIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/trash-green.svg",$scope.availableChannels=$scope.availableChannels.map(function(channel,i){return"wfacebook"===channel.id&&(isWFacebook=!0,wfacebookIndex=i),channel}),$scope.callbackSrIvr={},$scope.userAuthorizationFlag=!1,$scope.nodeInfo={nodeInfo:{ivrOptions:{initialPrompts:[],nomatchPrompts:[],timeoutPrompts:[],errorPrompts:[],grammars:[],advance:{timeout:1e4,retry_limit:3,bargein:!1,properties:[],enable_log:!1,recording:"stop"}}}},$scope.ivrSettingsDefault={ivrSettings:{asrConfidenceThreshold:{key:"confidenceLevel",value:0},extraction_key:"userinput",enable:!1,timeout:"30",enable_log:!0,retry_limit:"6",properties:[],enable_transcript:!1,transcript_tag:"",callTerminationHandler:"",bargein:!1,timeoutPrompts:[[{type:"text",value:""}]],nomatchPrompts:[[{type:"text",value:""}]],grammars:[]}},$scope.isIVREnabled=_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable||$scope.ivrSettingsDefault.ivrSettings.enable,$scope.availableChannels=_.filter($scope.availableChannels,{enable:!0}),$scope.availableTasks=[],$scope.availableFields=[],$scope.jsEditorCallbacks={},$scope.markdownCB1={},$scope.markdownCB2={};var alerts=$workflowService.alertTasks(),actions=$workflowService.actionTasks(),dailogs=$workflowService.dialogTasks(),currentOverrideMsg={};$scope.prepareTasks=function(){alerts=$workflowService.alertTasks(),actions=$workflowService.actionTasks(),dailogs=$workflowService.dialogTasks(),currentOverrideMsg={},$scope.tasksByType=[],alerts.length&&$scope.tasksByType.push({type:"Alert Tasks",tasks:alerts}),actions.length&&$scope.tasksByType.push({type:"Action Tasks",tasks:actions}),dailogs.length&&$scope.tasksByType.push({type:"Dialog Tasks",tasks:dailogs}),$scope.availableTasks=alerts.concat(actions),$scope.availableTasks=$scope.availableTasks.concat(dailogs)},$scope.prepareTasks(),$scope.getBotVariables=function(){BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$workflowService.botEnvVariables(res.data.variables)})},$scope.getBotVariables(),$scope.tasksByType=[],alerts.length&&$scope.tasksByType.push({type:"Alert Tasks",tasks:alerts}),actions.length&&$scope.tasksByType.push({type:"Action Tasks",tasks:actions}),dailogs.length&&$scope.tasksByType.push({type:"Dialog Tasks",tasks:dailogs}),$scope.availableTasks=alerts.concat(actions),$scope.availableTasks=$scope.availableTasks.concat(dailogs),$scope.alldailogs=BTFlowtaskService.getComponents($workflowService.selectedStream()._id).then(function(res){$scope.availEntities=_.filter(res.data,{type:"entity"}),getGenericMessages(streamId)},function(errRes){console.error("KORE-WEB:Failed loading dialog components"),getGenericMessages(streamId)}),$scope.categoryHeaders={Statements:i18n.i18nString("statements"),Queries:i18n.i18nString("queries"),"Error & Warnings":i18n.i18nString("error_warnings"),Choices:i18n.i18nString("choices"),Greeting:i18n.i18nString("greeting"),Questions:i18n.i18nString("questions")};var _defaultOrder;_defaultOrder="universalbot"===streamType?["Statements","Queries","Error & Warnings","Choices","Greeting"]:["Statements","Queries","Error & Warnings","Questions","Choices","Greeting"],$scope.activeTabType=function(type,prompt){var currentActiveTab=prompt.isMarkDown?"basic":"uXMap";if(type!==currentActiveTab)if("uXMap"===type){if(prompt.value&&prompt.value.trim()||prompt.markdownValue&&prompt.markdownValue.trim())return void NotificationService.notify(i18n.i18nString("advance_mode"));prompt.isMarkDown=!1,$scope.nofocus=!1}else if("basic"===type){if(prompt.jsEditorValue&&prompt.jsEditorValue.trim())return void NotificationService.notify(i18n.i18nString("standard_mode"));prompt.isMarkDown=!0,$scope.nofocus=!1}},$scope.saveGenericMessages=function(){var messages={messages:convertTitleValueToObjAndPullChanges($scope.genericMessages)};$scope.saving=!0,BTStreamsService.editGenericMessages(streamId,messages).then(function(res){$scope.saving=!1,NotificationService.notify(i18n.i18nString("msg_saved"),"success")},function(err){$scope.saving=!1,NotificationService.notify(err.data.errors[0].msg,"error")})};var editingMessage={},editGenericMsgIndex="no-index";$scope.selectMessage=function(message){$scope.prepareTasks(),editingMessage=message,$scope.editLocked=message.editLocked,message&&"You don't seem to have any registered <bot-name> accounts"===message.key?$scope.userAuthorizationFlag=!0:$scope.userAuthorizationFlag=!1},$scope.createNewOverride=function(message){$scope.newOverrideInProgress=!0,$scope.modalTitle=i18n.i18nString("add_channel"),$scope.check=!0,openAddMessage(),$scope.message=message},$scope.enableIvrsettings=function(){if(!$scope.isIVREnabled){$scope.isIVREnabled=!0,_selectedStream.ivrSettings.enable=!0;var btPostData={ivrSettings:{asrConfidenceThreshold:_selectedStream.ivrSettings.asrConfidenceThreshold||$scope.ivrSettingsDefault.ivrSettings.asrConfidenceThreshold,extraction_key:_selectedStream.ivrSettings.extraction_key||$scope.ivrSettingsDefault.ivrSettings.extraction_key,enable:$scope.isIVREnabled||$scope.ivrSettingsDefault.ivrSettings.enable,timeout:parseInt(1e3*_selectedStream.ivrSettings.timeout)||$scope.ivrSettingsDefault.ivrSettings.timeout,retry_limit:parseInt(_selectedStream.ivrSettings.retry_limit)||$scope.ivrSettingsDefault.ivrSettings.retry_limit,properties:_selectedStream.ivrSettings.properties||$scope.ivrSettingsDefault.ivrSettings.properties,enable_log:_selectedStream.ivrSettings.enable_log||$scope.ivrSettingsDefault.ivrSettings.enable_log,enable_transcript:_selectedStream.ivrSettings.enable_transcript||$scope.ivrSettingsDefault.ivrSettings.enable_transcript,transcript_tag:_selectedStream.ivrSettings.transcript_tag||$scope.ivrSettingsDefault.ivrSettings.transcript_tag,callTerminationHandler:_selectedStream.ivrSettings.callTerminationHandler||$scope.ivrSettingsDefault.ivrSettings.callTerminationHandler,bargein:_selectedStream.ivrSettings.bargein||$scope.ivrSettingsDefault.ivrSettings.bargein,grammars:_selectedStream.ivrSettings.grammars||$scope.ivrSettingsDefault.ivrSettings.grammars}};_selectedStream.ivrSettings&&_selectedStream.ivrSettings.timeoutPrompts?btPostData.ivrSettings.timeoutPrompts=[[angular.extend({type:"text"},_selectedStream.ivrSettings.timeoutPrompts[0][0])]]:btPostData.ivrSettings.timeoutPrompts=$scope.ivrSettingsDefault.ivrSettings.timeoutPrompts,_selectedStream.ivrSettings&&_selectedStream.ivrSettings.nomatchPrompts?btPostData.ivrSettings.nomatchPrompts=[[angular.extend({type:"text"},_selectedStream.ivrSettings.nomatchPrompts[0][0])]]:btPostData.ivrSettings.nomatchPrompts=$scope.ivrSettingsDefault.ivrSettings.nomatchPrompts,updateIvrStreamData(btPostData),$scope.callbackSrIvr.enableIvr(),$("#ivrNode").modal("hide")}},$scope.cbIvr.closeVoiceSlider=function(){$scope.isStandAllVoiceEnabled=!1},$scope.stand_resp_voice_channels_all_cb.closeVoiceSlider=$scope.cbIvr.closeVoiceSlider,
$scope.cbIvr.openChannelLevelTwilioVoice=function(){$scope.isStandAllVoiceEnabled=!0,setTimeout(function(){$scope.stand_resp_voice_channels_all_cb.openChannelLevelTwilioVoice()},100)},$scope.cbIvr.openAudioCodesVoiceProp=function(){$scope.isStandAllVoiceEnabled=!0,setTimeout(function(){$scope.stand_resp_voice_channels_all_cb.openAudioCodesVoiceProp()},500)},$scope.cbIvr.openBotLevelIVR=function(){$("#ivrNode").modal("hide"),$scope.enableIvrsettings(),$scope.openModalSlider("#ivrStandResp")},$scope.saveIvrStream=function(){$scope.callbackSrIvr.createIVRStream()},$scope.closeBotLevelIvr=function(){$scope.closeModalSlider("#ivrStandResp")},$scope.callbackSrIvr.closeBotLevelIvr=$scope.closeBotLevelIvr,$scope.manageVarSlider=function(){$scope.manageVarChannelRespEnable=!0,$scope.manage_var_channel_response.flagName="standardResponse",$scope.manage_var_channel_response.addedNamespaces=$scope.stream.krVNameSpace||[],$scope.manage_var_channel_response.state="indevelopment"==$workflowService.selectedStreamState()?"configured":$workflowService.selectedStreamState(),$scope.manage_var_channel_response.updateStandardRespNamespace=function(list){$scope.stream.krVNameSpace=list},setTimeout(function(){$scope.modalSlider.open("#manageVarNamespaceChannelResp")},200)},$scope.manage_var_channel_response.close=function(){$scope.manageVarChannelRespEnable=!1,$scope.modalSlider.close("#manageVarNamespaceChannelResp")},$scope.resetNewOverride=function(){$scope.newOverrideInProgress=!1,$scope.newOverride={isMarkDown:!0},editingMessage.channelUXMaps[$scope.currentIndex]&&editingMessage.channelUXMaps[$scope.currentIndex].channel&&$scope.message&&$scope.message.override&&($scope.message.override[$scope.currentIndex].channel=editingMessage.channelUXMaps[$scope.currentIndex].channel),Object.keys(currentOverrideMsg).length&&(currentOverrideMsg={}),$scope.modalTitle=i18n.i18nString("edit_modal")},$scope.editOverride=function(event,obj,index,message,parentIndex){$scope.message=message,$scope.currentIndex=index,$scope.parentIndex=parentIndex,event.isDefaultPrevented()||($scope.overrideObj=angular.copy(obj),angular.extend(currentOverrideMsg,obj),$scope.newOverrideInProgress=!0,$scope.newOverride=obj,$scope.modalTitle=i18n.i18nString("edit_channel"),$scope.editFlag=!0,openAddMessage(),obj.taskId&&getTaskFields(),obj.isMarkDown?$scope.newOverride.markdownValue=obj.uXMap:$scope.newOverride.jsEditorValue=obj.uXMap.substring(obj.uXMap.indexOf("<% ")+2,obj.uXMap.lastIndexOf("%>")))},$scope.deleteOverride=function(event,override,index){$scope.currentIndex=index,event.preventDefault();var channelUXMapsToSend=angular.copy(editingMessage.channelUXMaps),_defaultChannelList=_.filter(editingMessage.channelUXMaps,{channel:"default"});if(1===_defaultChannelList.length&&"default"===override.channel)return void NotificationService.notify(i18n.i18nString("atleast_one_channel"),"error");if(1===channelUXMapsToSend.length&&"default"!==override.channel)return void NotificationService.notify(i18n.i18nString("delete_res"),"warning");channelUXMapsToSend=deleteOverrideFromUxMaps(channelUXMapsToSend,override);var originalMessagesToSend=angular.copy(_.map(editingMessage.value,function(each){return each.message})),payload={streamId:streamId,Condition:editingMessage.title,Key:editingMessage.key,"Original Message":originalMessagesToSend,channelUXMaps:channelUXMapsToSend};BTStreamsService.editOverrideMessages(streamId,payload).then(function(res){var savedValues=getOverrideValues(res.data.channelUXMaps);editingMessage.channelUXMaps=res.data.channelUXMaps,editingMessage.override.length=0,angular.extend(editingMessage.override,savedValues),NotificationService.notify(i18n.i18nString("channel_override_delete"),"success")},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.saveNewOverride=function(){if($scope.newOverride.hasOwnProperty("isMarkDown")){var _defaultChannels=_.filter(editingMessage.channelUXMaps,{channel:"default"});if($scope.newOverride.isMarkDown){if(!$scope.newOverride.markdownValue||!$scope.newOverride.markdownValue.length)return;if(""===$scope.newOverride.markdownValue.trim())return void($scope.newOverride.markdownValue="")}else{if(!$scope.newOverride.jsEditorValue||!$scope.newOverride.jsEditorValue.length)return;if(""===$scope.newOverride.jsEditorValue.trim())return void($scope.newOverride.jsEditorValue="")}if(!$scope.savingNewOverride){if(_defaultChannels&&1===_defaultChannels.length&&editingMessage.channelUXMaps[$scope.currentIndex]&&"default"===editingMessage.channelUXMaps[$scope.currentIndex].channel&&$scope.editFlag&&"default"!==$scope.newOverride.channel)return void NotificationService.notify(i18n.i18nString("atleast_one_channel"),"error");$scope.savingNewOverride=!0;var channelUXMapsToSend=angular.copy(editingMessage.channelUXMaps);Object.keys(currentOverrideMsg).length&&(channelUXMapsToSend=deleteOverrideFromUxMaps(channelUXMapsToSend,currentOverrideMsg)),$scope.loading=!0,BTStreamsService.editOverrideMessages(streamId,updateChannelUXMaps(channelUXMapsToSend)).then(function(res){$scope.savingNewOverride=!1,$scope.editFlag=!1,$scope.closeAddMessage(),currentOverrideMsg={};var savedValues=getOverrideValues(res.data.channelUXMaps);editingMessage.channelUXMaps=res.data.channelUXMaps,editingMessage.override.length=0,angular.extend(editingMessage.override,savedValues),NotificationService.notify(i18n.i18nString("channel_overide_saved"),"success"),$scope.message=res.data,$scope.check?($scope.genericMessages=[],$scope.categories=[],getGenericMessages(streamId)):$scope.genericMessages[$scope.parentIndex].channelUXMaps=$scope.message.channelUXMaps,$scope.loading=!1},function(res){$scope.savingNewOverride=!1,$scope.loading=!1,NotificationService.notify(res.data.errors[0].msg,"error")})}}},$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.getJsSamples(),$scope.channelChanged=function(){$scope.newOverride.taskId=null,$scope.newOverride.fieldId=null},$scope.getTaskFields=function(){$scope.newOverride.fieldId=null,getTaskFields()},$scope.cancelResponse=function(){$scope.closeAddMessage()},$scope.alterTabs=function(isBasic){$scope.isBasic=isBasic},$scope.closeAddMessage=function(){$scope.openState=!1,$scope.closeModalSlider("#standardResSlider"),$scope.resetNewGeneric(),$scope.resetNewOverride()},$scope.showType=function(modifiedCategory,isGSearch){function showTy(){$scope.currentPage=1,$scope.categories.map(function(category){category.type!=modifiedCategory.type?category.active=!1:(category.active=!0,$scope.currentCategory=category.type)})}if(isGSearch)var selType=$interval(function(){showTy(),isCategoriesAval&&$interval.cancel(selType)},250);else showTy()},$scope.searchTerm.showType=$scope.showType,$scope.clearSearch=function(){$scope.$parent.goBack(".standard-responses-form"),$timeout(function(){$scope.search.text=""},150)},$scope.editGenericMsg=function(event,index){$scope.check=!1,$scope.currentIndex=index,event.isDefaultPrevented()||($scope.modalTitle=i18n.i18nString("edit_modal"),editGenericMsgIndex=index,$scope.newGenericInProgress=!0,$scope.newGeneric={value:editingMessage.value[index].message,isMarkDown:!0},openAddMessage())},$scope.resetNewGeneric=function(){$scope.newGenericInProgress=!1,$scope.newGeneric={},$scope.modalTitle=i18n.i18nString("edit_modal")},$scope.ivrBridge={},$scope.editIVR=!1,$scope.editIVRSettings=function(){$scope.ivrOptions=editingMessage.ivrOptions,$scope.editIVR=!0,$scope.openModalSlider("#IVRSettingsSlider")},$scope.closeIVRSettings=function(){$scope.editIVR=!1,$scope.closeModalSlider("#IVRSettingsSlider")},$scope.saveIVRSettings=function(flag,label){var payload={streamId:streamId,Condition:editingMessage.title,Key:editingMessage.key,ivrOptions:$scope.ivrBridge.getIVROptions(),"Original Message":_.pluck(editingMessage.value,"message"),channelUXMaps:editingMessage.channelUXMaps};BTStreamsService.editOverrideMessages(streamId,payload).then(function(res){NotificationService.notify(i18n.i18nString("ivrsettings_label",{dyn:label}),"success"),editingMessage.value.length=0,res.data["Original Message"]=convertTolistOfObjects(res.data["Original Message"]),angular.extend(editingMessage.value,res.data["Original Message"]),editingMessage.ivrOptions=res.data.ivrOptions||void 0,res.data&&($scope.ivrBridge.ivrOptions=res.data.ivrOptions,$scope.vxmlGlobalCopyKeys=_.pluck($scope.stream.ivrSettings.properties||[],"name"),$scope.vxmlNodeKeys=_.pluck(res.data.ivrOptions.advance.properties||[],"name"),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys)),$scope.cbIvr.updateVxmlGlobalKeys($scope.vxmlGlobalKeys)),setTimeout(function(){flag&&$scope.closeIVRSettings()},500)},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.addNewGeneric=function(){$scope.modalTitle="Add Response",$scope.newGenericInProgress=!0,$scope.newOverrideInProgress=!1,$scope.newGeneric={value:""},openAddMessage()},$scope.saveNewGeneric=function(){var editingMsgCopy,msgsToSend=[],payload={};if("default"!==$scope.newGeneric.channel&&0===editingMessage.channelUXMaps.length)return void NotificationService.notify(i18n.i18nString("atleast_one_channel"),"error");if("Simple Mode"===$(".btn.noBorderBtm.active").html()){if(!$scope.newGeneric.value||!$scope.newGeneric.value.length)return void NotificationService.notify(i18n.i18nString("res_empty"),"error");if(""===$scope.newGeneric.value.trim())return $scope.newGeneric.value="",void NotificationService.notify(i18n.i18nString("res_empty"),"error")}if("Advanced Mode"===$(".btn.noBorderBtm.active").html()){if(!$scope.newGeneric.jsEditorValue||!$scope.newGeneric.jsEditorValue.length)return void NotificationService.notify(i18n.i18nString("res_empty"),"error");if(""===$scope.newGeneric.jsEditorValue.trim())return $scope.newGeneric.jsEditorValue="",void NotificationService.notify(i18n.i18nString("res_empty"),"error")}$scope.savingNewGeneric||($scope.savingNewGeneric=!0,editingMsgCopy=angular.copy(editingMessage.value),msgsToSend=[],_.map(editingMsgCopy,function(msg){msgsToSend.push(msg.message)}),"number"==typeof editGenericMsgIndex&&msgsToSend.splice(editGenericMsgIndex,1),"Simple Mode"===$(".btn.noBorderBtm.active").html()?msgsToSend.push($scope.newGeneric.value):msgsToSend.push($scope.newGeneric.jsEditorValue),"default"===$scope.newGeneric.channel?msgsToSend.forEach(function(obj,index){var _obj1={taskUXMaps:[],fieldUXMaps:[],channel:"default",botUXMap:{uXMap:obj,isMarkDown:!0}};index===msgsToSend.length-1?($scope.newGeneric.isMarkDown||-1===$scope.newGeneric.jsEditorValue.indexOf("<% ")&&-1===$scope.newGeneric.jsEditorValue.lastIndexOf("%>")&&(obj="<% "+$scope.newGeneric.jsEditorValue+" %>"),_obj1.botUXMap={uXMap:obj,isMarkDown:"Simple Mode"===$(".btn.noBorderBtm.active").html()},_obj1.channel=$scope.newGeneric.channel):_obj1.channel="default",editingMessage.channelUXMaps.push(_obj1)}):msgsToSend.forEach(function(obj,index){var _obj1={taskUXMaps:[],fieldUXMaps:[],botUXMap:{uXMap:obj,isMarkDown:!0}};if(index===msgsToSend.length-1){$scope.newGeneric.isMarkDown||-1===$scope.newGeneric.jsEditorValue.indexOf("<% ")&&-1===$scope.newGeneric.jsEditorValue.lastIndexOf("%>")&&(obj="<% "+$scope.newGeneric.jsEditorValue+" %>");var curChannel;curChannel||(curChannel={channel:$scope.newGeneric.channel},"Workplace For Groups"===curChannel.channel||"wfacebookG"===curChannel.channel?(curChannel.channel="wfacebook",curChannel.isMention=!0):("Workplace For Chat"===curChannel.channel||"wfacebookC"===curChannel.channel)&&(curChannel.channel="wfacebook",curChannel.isMention=!1),editingMessage.channelUXMaps.push(curChannel)),$scope.newGeneric.hasOwnProperty("fieldId")&&$scope.newGeneric.fieldId&&"default"!==$scope.newGeneric.fieldId?(curChannel.hasOwnProperty("fieldUXMaps")||(curChannel.fieldUXMaps=[]),_obj1={taskId:$scope.newGeneric.taskId,fieldId:$scope.newGeneric.fieldId,uXMap:obj,isMarkDown:$scope.newGeneric.isMarkDown},curChannel.fieldUXMaps.push(_obj1)):$scope.newGeneric.hasOwnProperty("taskId")&&$scope.newGeneric.taskId&&"default"!==$scope.newGeneric.taskId?(curChannel.hasOwnProperty("taskUXMaps")||(curChannel.taskUXMaps=[]),_obj1={taskId:$scope.newGeneric.taskId,uXMap:obj,isMarkDown:$scope.newGeneric.isMarkDown},curChannel.taskUXMaps.push(_obj1)):(curChannel.hasOwnProperty("botUXMap")||(curChannel.botUXMap={}),_obj1={uXMap:obj,isMarkDown:"Simple Mode"===$(".btn.noBorderBtm.active").html()},_obj1.channel=$scope.newGeneric.channel,curChannel.botUXMap=_obj1)}else _obj1.channel="default",editingMessage.channelUXMaps.push(_obj1)}),payload={streamId:streamId,Condition:editingMessage.title,Key:editingMessage.key,"Original Message":msgsToSend,channelUXMaps:editingMessage.channelUXMaps,hideOriginalMessages:!0},$scope.loading=!0,BTStreamsService.editOverrideMessages(streamId,payload).then(function(res){$scope.savingNewGeneric=!1,editingMessage.value.length=0,res.data["Original Message"]=convertTolistOfObjects(res.data["Original Message"]),angular.extend(editingMessage.value,res.data["Original Message"]),$scope.closeAddMessage(),$scope.newGenericInProgress=!1,$scope.newGeneric={},editGenericMsgIndex="no-index",$scope.modalTitle=i18n.i18nString("edit_modal"),NotificationService.notify(i18n.i18nString("standard_res_save"),"success"),$scope.genericMessages=[],$scope.categories=[],getGenericMessages(streamId),$scope.loading=!1},function(res){$scope.savingNewGeneric=!1,NotificationService.notify(res.data.errors[0].msg,"error"),getGenericMessages(streamId),$scope.loading=!1}))},$scope.removeGenericMsg=function(event,index){if(event.preventDefault(),1===editingMessage.value.length)return void NotificationService.notify(i18n.i18nString("atleast_one_channel"),"error");var valuesToSend=angular.copy(_.map(editingMessage.value,function(each){return each.message}));valuesToSend.splice(index,1);var payload={streamId:streamId,Condition:editingMessage.title,Key:editingMessage.key,"Original Message":valuesToSend,channelUXMaps:editingMessage.channelUXMaps};BTStreamsService.editOverrideMessages(streamId,payload).then(function(res){editingMessage.value.length=0,res.data["Original Message"]=convertTolistOfObjects(res.data["Original Message"]),angular.extend(editingMessage.value,res.data["Original Message"]),NotificationService.notify(i18n.i18nString("standard_res_delete"),"success")},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.FilterMessages=function(isGlobalSearch){if(isGlobalSearch)var filterMess=$interval(function(){var filteredMessages=$filter("filter")($scope.genericMessages,$scope.search.text);$scope.categories=_.map($scope.categories,function(category){return category.searchResultsCount=_.filter(filteredMessages,{type:category.type}).length,category}),isGenMessAvail&&$interval.cancel(filterMess)},250);else{var filteredMessages=$filter("filter")($scope.genericMessages,$scope.search.text);$scope.categories=_.map($scope.categories,function(category){return category.searchResultsCount=_.filter(filteredMessages,{type:category.type}).length,category})}},$scope.resetResponse=function(message){$("#StandardResponseResetValues").modal("show"),editingMessage=message},$scope.closeResetConfirmationPopup=function(){$("#StandardResponseResetValues").modal("hide")},$scope.updateResponsesToDefault=function(){$("#StandardResponseResetValues").modal("hide");var payload={streamId:streamId,Condition:editingMessage.title,Key:editingMessage.key,reset:!0,hideOriginalMessages:!0};BTStreamsService.editOverrideMessages(streamId,payload).then(function(res){$scope.savingNewGeneric=!1,$scope.closeAddMessage(),$scope.newGenericInProgress=!1,$scope.newGeneric={},editGenericMsgIndex="no-index",$scope.genericMessages=[],$scope.categories=[],getGenericMessages(streamId),$scope.loading=!1},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})};var scope=angular.element("#inpSearchStandResp").scope();scope.FilterMessages(),$scope.updateFooterHeader=function(){return $scope.footerInfoTitle=i18n.i18nString("ddval_standard"),$scope.footerHeaderId="bt-channelresposeManage",$scope.footerPanelId="bt-channelresposeManage-panel",$scope.nameDescription=i18n.i18nString("standard_res_list"),!0},$scope.closeNodeVxmlProp=function(){$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""}};var vxmlflag=!1;$scope.addProperty=function(vprop){$scope.ivrBridge.ivrOptions=$scope.ivrBridge.getIVROptions(),$scope.ivrBridge.ivrOptions.advance.properties.push(vprop),$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""},$scope.saveIVRSettings(vxmlflag,"saved")},$scope.$emit("nestedComponentLoaded",{id:"standardResponses",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}]}}]),_module.filter("channelNameDisp",function(){return function(input){return"ivr"===input?i18n.i18nString("configurable_webhook_name"):"googleactions"===input?i18n.i18nString("Google_asstnt"):"hangoutchat"===input?i18n.i18nString("Hangouts"):input}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("botChatHistory",["$timeout","$workflowService","$filter",function($timeout,$workflowService,$filter){return{restrict:"EA",scope:{streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-kora-users/bt-kora-users.html",controller:"BTKoraUsersCtrl"}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("botChatScenarios",function(){return{restrict:"EA",scope:{stream:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-chat-scenarios/bot-chat-scenarios.html",controller:["$scope","BTStreamsService","_constants_","NotificationService","$q","$workflowService","$modal","i18n",function($scope,BTStreamsService,_constants_,NotificationService,$q,$workflowService,$modal,i18n){function getChatScenarios(result,offset){offset=offset||0;var searchParam=$scope.search||"";BTStreamsService.getBotChatScenarios($scope.stream._id,$scope.stream.name,result,offset,$scope.limit,searchParam).then(function(res){if(res.data.results=res.data.results.map(function(scenario){return scenario.time=new Date(scenario.time).toLocaleString(),scenario}),$scope.totalItems=res.data.count,"successintent"==result){var var_successChatScenarios=res.data.results;$scope.successChatScenarios=var_successChatScenarios}if("failintent"==result){var var_failedChatScenarios=res.data.results;$scope.failedChatScenarios=var_failedChatScenarios}$scope.dataLoaded=!0})}$scope.successChatScenarios=[],$scope.failedChatScenarios=[],$scope.successCurrentPage=1,$scope.failureCurrentPage=1,$scope.stream=$workflowService.selectedStream(),$scope.successSearch="",$scope.failSearch="",$scope.dataLoaded=!1,$scope.limit=10,$scope.$watch("limit",function(newVal,oldVal){$scope.limit=newVal}),$scope.updateLimit=function(limitToUpdate){$scope.limit=limitToUpdate},$scope.context={api:{}},$scope.views={successScenarios:!0,failedScenarios:!1},$scope.searchFilter=function(filter){return function(chatScenarios){return filter.input||filter.task||filter.time?chatScenarios.input[0]&&-1!==chatScenarios.input[0].toLowerCase().indexOf(filter.input&&filter.input.toLowerCase())||chatScenarios.task&&-1!==chatScenarios.task.toLowerCase().indexOf(filter.task&&filter.task.toLowerCase())||chatScenarios.time&&-1!==chatScenarios.time.toLowerCase().indexOf(filter.time&&filter.time.toLowerCase()):!0}},$scope.showType=function(screen){Object.keys($scope.views).map(function(key){$scope.views[key]=!1}),$scope.views[screen]=!0,$scope.clearSearch(),getChatScenarios("successScenarios"===screen?"successintent":"failintent")},$scope.clearSearch=function(){$scope.successSearch="",$scope.failSearch="",$scope.search=""},$scope.showTrainBot=function(log){$scope.$emit("openFullPageModal","trainBot"),$workflowService.nlpTrainInput({log:log})},$scope.searchChatScenarios=function(event){var result="successintent";$scope.views.failedScenarios&&(result="failintent"),(13==event.keyCode||13!==event.keyCode&&!$scope.search)&&getChatScenarios(result)},$scope.addPattern=function(text){$scope.context.api.addPattern(text)},$scope.addSynonym=function(text){$scope.context.api.addSynonym(text)},getChatScenarios("successintent"),$scope.getChatScenarios=getChatScenarios}]}})}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("botAdvancedSettings",function(){return{restrict:"EA",scope:{callback:"=",streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/bot-advancedsettings-form.html",controller:["$scope","form_util","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","env_conf","$timeout","$element","$window","accessControlService","i18n",function($scope,form_util,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,env_conf,$timeout,$element,$window,accessControlService,i18n){function tConvert(time){return time=time.toString().match(/^([01]\d|2[0-3])(:)([0-5]\d)(:[0-5]\d)?$/)||[time],time.length>1&&(time=time.slice(1),time[5]=+time[0]<12?"AM":"PM",time[0]=+time[0]%12||12),time.join("")}function timeConvert(time){var _hours=new Date(time).getHours().toString();1==_hours.length&&(_hours="0"+_hours);var _mins=new Date(time).getMinutes().toString();1==_mins.length&&(_mins="0"+_mins);var _sec=new Date(time).getSeconds().toString();return 1==_sec.length&&(_sec="0"+_sec),_hours+":"+_mins+":"+_sec}function formatDate(userDate,timeInAMPM){var parts=userDate.split(" ")[0].split("/");return 1==parts[0].length&&(parts[0]="0"+parts[0]),1==parts[1].length&&(parts[1]="0"+parts[1]),timeInAMPM?parts.join("/")+" "+tConvert(userDate.split(" ")[1]):parts.join("/")+" "+timeConvert(userDate)}function createMPStream(streamData){$workflowService.selectedStream()._id&&"edit"===$scope.displayMode?BTStreamsService.updateMPStream($workflowService.selectedStream()._id,streamData).then(function(response){$scope.callback.saveInprogress=!1,$scope.callback.saveSuccess=!0,NotificationService.notify(i18n.i18nString("interruption_saved_sucess_noty"),"success"),$workflowService.streamType("")},function(res){$scope.callback.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")}):BTStreamsService.createMPStream($applicationService.userInfo().userId,streamData).then(function(response){$scope.callback.saveInprogress=!1,NotificationService.notify(i18n.i18nString("interruption_saved_sucess_noty"),"success"),$scope.callback.saveSuccess=!0,$workflowService.streamType("")},function(res){$scope.callback.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")})}function createBTStream(streamData){$scope.duplicateStreamName=!1,$scope.callback.saveInprogress||($workflowService.selectedStream()._id&&"edit"===$scope.displayMode?($scope.callback.saveInprogress=!0,BTStreamsService.editStream($workflowService.selectedStream()._id,streamData).then(function(response){var mpPostData={};mpPostData._id=response.data._id,mpPostData.name=$scope.newStreamData.name,mpPostData["class"]=$scope.newStreamData["class"],mpPostData.description=$scope.newStreamData.description,mpPostData.tagline=$scope.newStreamData.tagline,mpPostData.categoryIds=$scope.newStreamData.categoryIds,mpPostData.icon=$scope.newStreamData.icon.fileId,mpPostData.websiteURL=$scope.newStreamData.websiteUrl,mpPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,mpPostData.botDocLink=$scope.newStreamData.botDocLink,mpPostData.keywords=$scope.newStreamData.keywords?$scope.newStreamData.keywords.split(","):[],mpPostData.languages=[],mpPostData.price=1,mpPostData.screenShots=[],mpPostData.namespace="private",mpPostData.namespaceIds=[],mpPostData.teamTaskListMsg=$scope.newStreamData.teamTaskListMsg,"color"===$scope.newStreamData.bbannerchoice?mpPostData.bBannerColor=$scope.newStreamData.bBannerColor=$scope.newStreamData.color:$scope.newStreamData.bBanner&&$scope.newStreamData.bBanner.fileId&&(mpPostData.bBanner=$scope.newStreamData.bBanner.fileId),"color"===$scope.newStreamData.sbannerchoice?mpPostData.sBannerColor=$scope.newStreamData.sBannerColor=$scope.newStreamData.color:$scope.newStreamData.sBanner&&$scope.newStreamData.sBanner.fileId&&(mpPostData.sBanner=$scope.newStreamData.sBanner.fileId),mpPostData.color=$scope.newStreamData.color,_.addProps($scope.newStreamData.purposeisRequired,mpPostData,{purpose:$scope.newStreamData.purpose}),mpPostData.profileRequired="true"===$scope.newStreamData.profileRequired,mpPostData.sendVcf="true"===$scope.newStreamData.sendVcf&&mpPostData.profileRequired,mpPostData.isNLEnabled="yes"==$scope.newStreamData.isNLEnabled,mpPostData.interruptsEnabled=$scope.newStreamData.interruptsEnabled,$workflowService.selectedStream(response.data),$scope.currentStream=$workflowService.selectedStream(),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data)}),createMPStream(mpPostData)},function(res){return $scope.callback.saveInprogress=!1,409===res.data.errors[0].code&&"Stream with same name already exists"===res.data.errors[0].msg?void($scope.duplicateStreamName=!0):void NotificationService.notify(res.data.errors[0].msg,"error")})):($scope.callback.saveInprogress=!0,BTStreamsService.createBTStream($applicationService.userInfo().userId,streamData).then(function(response){var mpPostData={};mpPostData._id=response.data._id,mpPostData.name=$scope.newStreamData.name,mpPostData.description=$scope.newStreamData.description,mpPostData["class"]=$scope.newStreamData["class"],mpPostData.categoryIds=$scope.newStreamData.categoryIds,mpPostData.icon=$scope.newStreamData.icon.fileId,mpPostData.keywords=$scope.newStreamData.keywords?$scope.newStreamData.keywords.split(","):[],mpPostData.languages=[],mpPostData.price=1,mpPostData.screenShots=[],mpPostData.namespace="private",mpPostData.namespaceIds=[],mpPostData.teamTaskListMsg=$scope.newStreamData.teamTaskListMsg,mpPostData.color=$scope.newStreamData.color,mpPostData.tagline=$scope.newStreamData.tagline,"color"===$scope.newStreamData.bbannerchoice?mpPostData.bBannerColor=$scope.newStreamData.bBannerColor=$scope.newStreamData.color:$scope.newStreamData.bBanner&&$scope.newStreamData.bBanner.fileId&&(mpPostData.bBanner=$scope.newStreamData.bBanner.fileId),"color"===$scope.newStreamData.sbannerchoice?mpPostData.sBannerColor=$scope.newStreamData.sBannerColor=$scope.newStreamData.color:$scope.newStreamData.sBanner&&$scope.newStreamData.sBanner.fileId&&(mpPostData.sBanner=$scope.newStreamData.sBanner.fileId),mpPostData.websiteURL=$scope.newStreamData.websiteUrl,mpPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,mpPostData.botDocLink=$scope.newStreamData.botDocLink,mpPostData.profileRequired="true"===$scope.newStreamData.profileRequired,mpPostData.sendVcf="true"===$scope.newStreamData.sendVcf&&mpPostData.profileRequired,mpPostData.interruptsEnabled=$scope.newStreamData.interruptsEnabled,$workflowService.selectedStream(response.data),$scope.currentStream=$workflowService.selectedStream(),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data)}),createMPStream(mpPostData)},function(res){return $scope.callback.saveInprogress=!1,409===res.data.errors[0].code&&"Stream with same name already exists"===res.data.errors[0].msg?void($scope.duplicateStreamName=!0):void NotificationService.notify(res.data.errors[0].msg,"error")})))}function initDragDropFile(){!function(window){function triggerCallback(e,callback){if(callback&&"function"==typeof callback){var files;e.dataTransfer?files=e.dataTransfer.files:e.target&&(files=e.target.files),callback.call(null,files)}}function makeDroppable(ele,callback){if(!($element.find('[type="file"]').length>0)){var input=document.createElement("input");input.setAttribute("type","file"),input.setAttribute("multiple",!0),input.style.display="none",input.id="fileInputID",input.addEventListener("change",function(e){triggerCallback(e,callback)}),ele=ele[0],ele.appendChild(input),ele.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.add("dragover")}),ele.addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover")}),ele.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover"),triggerCallback(e,callback)}),$(ele).find(".browseBtn")[0].addEventListener("click",function(){input.value=null,input.click()})}}window.makeDroppable=makeDroppable}(window),function(window){window.makeDroppable($(".fileDropContainer"),function(files){$scope.uploadFile(files[0])})}(window)}function startImportProgress(){$scope.totalProgress=1,progressInterval=setInterval(function(){$scope.totalProgress>90&&($scope.totalProgress=90),$scope.totalProgress+=.1},350)}function getBotFunctions(){BTStreamsService.getBotFunctions($workflowService.selectedStream()._id).then(function(res){$scope.file.fileData=res.data[0]},function(errRes){console.log("Failed getting bot functions")})}$scope.advancedDisplayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.dragDropIcon=window.appConfig.CONTEXT_PATH+"/assets/images/import.png",$scope.importingIcon=env_conf["context-url"]+"/assets/images/importing.png",$scope.importDoneIcon=env_conf["context-url"]+"/img/import-success.png";var enterpriseLicenseType=$rootScope.licenseType;$scope.manageResponseCB={},$scope.characters_remaining=i18n.i18nString("char_remaining"),$scope.onHoldQuality=["1","2","3","4","5","6","7","8","9","10"],$scope.callback=$scope.callback||{},$scope.displayMode="edit",$scope.snapshotsArray=[],$scope.currentStream=$workflowService.selectedStream(),$scope.currentStream&&$scope.currentStream.sbStreamId&&BTStreamsService.getBTStream($scope.currentStream.sbStreamId).then(function(res){$scope.parentSBStream=res.data}),$scope.getLocaleTime=function(time,timeInAMPM){return time?(time=new Date(time).toLocaleString().replace(/-/g,"/"),time=formatDate(time,timeInAMPM)):"--"},$scope.commandCtx={},$scope.isUploading=!1,$scope.errorInsideStream=!0,$scope.categories=$workflowService.seedData().category,$scope.duplicateStreamName=!1,$scope._constants_=$rootScope._constants_,$scope.botSetupConfirmationDescription=$rootScope.getSanitizedText($rootScope.lableData.bb012),$scope.sdkCallback={},$scope.assetsBase=env_conf["assets-url"],$scope.categoryConfig={allowclear:!0,multiple:!0,placeholder:"Select Category"},$scope.classConfig={allowclear:!0,multiple:!0,placeholder:"Select Class"},$scope.newStreamData={profileRequired:"true",purpose:enterpriseLicenseType?"employee":null,sbannerchoice:"image",bbannerchoice:"image",interruptsEnabled:!0},$scope.newStreamData.purposeisRequired=enterpriseLicenseType,$scope.myTeams=[],$scope.showNlpEnable=function(){return $rootScope.wfAdmin},$scope.callback.loadAdvancedSettings=function(){BTSeedDataService.getSeedCategories().then(function(res){$scope.categories=res.data.categories}),$("#noty_center_layout_container").empty();var loader;$scope.streamId=$workflowService.selectedStream()._id,$workflowService.selectedStream()._id&&BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){$scope.newStreamData={name:res.data.name,type:res.data.type||"taskbot",description:res.data.description,websiteUrl:res.data.websiteUrl,demoYoutubeLink:res.data.demoYoutubeLink,botDocLink:res.data.botDocLink,color:res.data.color,hasUserEndpoint:res.data.hasUserEndpoint,keywords:null,hasTenant:res.data.hasTenant?!0:!1,defaultUrl:res.data.baseUrl,helpHint:res.data.tenancy?res.data.tenancy.helpHint:null,sharing:{},offKoraConfirmation:res.data.offKoraConfirmation,synonyms:res.data.synonyms,purpose:res.data.purpose,skipMakeEditLinks:res.data.skipMakeEditLinks||!1,interruptOptions:res.data.interruptOptions},$scope.newStreamData.interruptOptions||($scope.newStreamData.interruptOptions={interruptsEnabled:!0,numTasksToHold:"1",smallTalkBehaviour:"respondAndResume",
faqBehaviour:"respondAndResume",type:{option:"endUser"},holdUxOptions:{option:"discardCurrTask"},resumeUxOptions:{option:"confFromUser",neverNotify:!1},ambiguousIntents:!1});try{$scope.newStreamData.interruptOptions.numTasksToHold=$scope.newStreamData.interruptOptions.numTasksToHold||"1",$scope.newStreamData.interruptOptions.faqBehaviour=$scope.newStreamData.interruptOptions.faqBehaviour||"respondAndResume",$scope.newStreamData.interruptOptions.ambiguousIntents=$scope.newStreamData.interruptOptions.showAmbiguous||!1,$scope.newStreamData.interruptOptions.smallTalkBehaviour=$scope.newStreamData.interruptOptions.smallTalkBehaviour||"respondAndResume",$scope.newStreamData.interruptOptions.type.option=$scope.newStreamData.interruptOptions.type.option||"endUser",$scope.newStreamData.interruptOptions.holdUxOptions.option=$scope.newStreamData.interruptOptions.holdUxOptions.option||"discardCurrTask",$scope.newStreamData.interruptOptions.resumeUxOptions.option=$scope.newStreamData.interruptOptions.resumeUxOptions.option||"confFromUser"}catch(e){$scope.newStreamData.interruptOptions={interruptsEnabled:!0,numTasksToHold:"1",faqBehaviour:"respondAndResume",smallTalkBehaviour:"respondAndResume",type:{option:"endUser",message:""},holdUxOptions:{option:"discardCurrTask",message:""},resumeUxOptions:{option:"confFromUser",message:""}}}res.data.interruptOptions&&($scope.newStreamData.interruptOptions.ambiguousIntents=res.data.interruptOptions.showAmbiguous||!1,$scope.newStreamData.interruptOptions.type=res.data.interruptOptions.type||{option:"endUser"},$scope.newStreamData.interruptOptions.interruptsEnabled=res.data.interruptOptions.interruptsEnabled,$scope.newStreamData.interruptOptions.faqBehaviour=res.data.interruptOptions.faqBehaviour||"respondAndResume",$scope.newStreamData.interruptOptions.smallTalkBehaviour=res.data.interruptOptions.smallTalkBehaviour||"respondAndResume",res.data.interruptOptions.holdUxOptions&&($scope.newStreamData.interruptOptions.holdUxOptions=res.data.interruptOptions.holdUxOptions,$scope.newStreamData.interruptOptions.holdUxOptions.option=res.data.interruptOptions.holdUxOptions.option),res.data.interruptOptions.resumeUxOptions&&($scope.newStreamData.interruptOptions.resumeUxOptions=res.data.interruptOptions.resumeUxOptions,$scope.newStreamData.interruptOptions.resumeUxOptions.option=res.data.interruptOptions.resumeUxOptions.option||"confFromUser"),$scope.newStreamData.interruptOptions.noNotify=res.data.interruptOptions.neverNotify,$scope.newStreamData.interruptOptions.numTasksToHold=""+(res.data.interruptOptions.numTasksToHold||"1"),$scope.newStreamData.interruptOptions.usePauseResume=res.data.interruptOptions.interruptsEnabled,"universalbot"===$scope.newStreamData.type&&($scope.newStreamData.interruptOptions.usePauseResume=!1),res.data.interruptOptions.resumeUxOptions&&res.data.interruptOptions.resumeUxOptions.neverNotify?$scope.newStreamData.interruptOptions.resumeUxOptions.neverNotify=res.data.interruptOptions.resumeUxOptions.neverNotify:$scope.newStreamData.interruptOptions.resumeUxOptions.neverNotify=!1,$scope.newStreamData.interruptOptions.resumeOptions=res.data.interruptOptions.resumeUxOptions||"mustConfirm",$scope.newStreamData.interruptOptions.discardOptions=res.data.interruptOptions.discardUxOptions||"ignoreInterrupt");try{$scope.newStreamData.sharing[res.data.visibility.namespace[0]]=!0,$scope.newStreamData.sharing[res.data.visibility.namespace[1]]=!0}catch(ex){}$scope.newStreamData.interruptOptions.interruptsEnabled||($scope.newStreamData.interruptOptions={type:{option:"doNotAllowHoldResume"},numTasksToHold:""+(res.data.interruptOptions.numTasksToHold||"1"),faqBehaviour:res.data.interruptOptions.faqBehaviour||"respondAndResume",ambiguousIntents:res.data.interruptOptions.showAmbiguous||!1,smallTalkBehaviour:res.data.interruptOptions.smallTalkBehaviour||"respondAndResume"}),res.data.errorCodes&&res.data.errorCodes.pollError&&($scope.newStreamData.pollError=res.data.errorCodes.pollError,$scope.newStreamData.errorCodes=res.data.errorCodes.pollError),res.data.visibility&&res.data.visibility.namespaceIds&&res.data.visibility.namespaceIds.forEach(function(item){for(var i=0;i<$scope.myTeams.length;i++)if($scope.myTeams[i].id===item){$scope.myTeams[i].selected=!0;break}}),res.data.sbStreamId&&($scope.newStreamData.inheritanceType=res.data.inheritanceType||1,$scope.newStreamData.allowInheritance=res.data.allowInheritance,$scope.newStreamData.sbStreamId=res.data.sbStreamId),$scope.currentStream=res.data}).then(function(){BTStreamsService.getMPStream($workflowService.selectedStream()._id).then(function(res){res.data&&($scope.newStreamData.categoryIds=res.data.categoryIds,$scope.newStreamData.websiteUrl=res.data.websiteURL,$scope.newStreamData.demoYoutubeLink=res.data.demoYoutubeLink,$scope.newStreamData.botDocLink=res.data.botDocLink,$scope.newStreamData["class"]=res.data["class"],$scope.newStreamData.tagline=res.data.tagline,$scope.newStreamData.teamTaskListMsg=res.data.teamTaskListMsg,$scope.newStreamData.profileRequired=res.data.profileRequired+"",$scope.newStreamData.sendVcf=res.data.sendVcf+"",$scope.newStreamData.purposeisRequired=enterpriseLicenseType,$scope.newStreamData.interruptsEnabled=res.data.interruptsEnabled,$scope.newStreamData.icon={fileName:"StreamIcon.png"},res.data.bBanner&&($scope.newStreamData.bBanner={fileName:"Big Banner.png"}),res.data.sBanner&&($scope.newStreamData.sBanner={fileName:"Small Banner.png"}),$scope.newStreamData.bBannerColor=res.data.bBannerColor,$scope.newStreamData.sBannerColor=res.data.sBannerColor,$scope.newStreamData.keywords=res.data.keywords&&res.data.keywords.length>0?res.data.keywords.join(","):null,$scope.newStreamData.isInMarket=$workflowService.selectedStream().isInMarket,$scope.newStreamData.bbannerchoice=res.data.bBanner?"image":"color",$scope.newStreamData.sbannerchoice=res.data.sBanner?"image":"color",$scope.newStreamData.isNLEnabled=res.data.isNLEnabled?"yes":"no",$scope.streamAdvancedForm.$setPristine(),loader())})})},$scope.$on("rerenderAdvancedSettings",function(){$scope.callback.loadAdvancedSettings()}),$scope.callback.loadAdvancedSettings(),$scope.callback.saveSuccess=!1,$scope.$watch("callback.saveSuccess",function(newVal,oldVal){$timeout(function(){$scope.callback.saveSuccess=!1},1e3)}),$scope.dissableInheritance=function(){function disable(){BTStreamsService.removeBotInheritance($workflowService.selectedStream()._id).then(function(response){$workflowService.selectedStream(response.data),$scope.currentStream=response.data,$scope.newStreamData.allowInheritance=response.data.allowInheritance,NotificationService.notify(i18n.i18nString("Inherit_removed_noty"),"success")},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})}function cancle(){}NotificationService.userConfirm(i18n.i18nString("Disable_inherit_userconfirm_noty"),[disable,cancle],{okText:i18n.i18nString("confirm"),btnClass:"redBtn"},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.checkInheritance=function(){return void 0===$scope.newStreamData.allowInheritance?!0:$scope.newStreamData.allowInheritance?!0:!1},$scope.onToggeleChange=function(){$scope.newStreamData.interruptOptions.faqBehaviour=$scope.newStreamData.interruptOptions.faqBehaviour||"respondAndResume",$scope.newStreamData.interruptOptions.numTasksToHold=$scope.newStreamData.interruptOptions.numTasksToHold||"1",$scope.newStreamData.interruptOptions.holdUxOptions=$scope.newStreamData.interruptOptions.holdUxOptions||{option:"discardCurrTask",message:""},$scope.newStreamData.interruptOptions.resumeUxOptions=$scope.newStreamData.interruptOptions.resumeUxOptions||{option:"confFromUser",message:""}},$scope.onToggeleChangeSmallTalk=function(){$scope.newStreamData.interruptOptions.smallTalkBehaviour=$scope.newStreamData.interruptOptions.smallTalkBehaviour||"respondAndResume",$scope.newStreamData.interruptOptions.numTasksToHold=$scope.newStreamData.interruptOptions.numTasksToHold||"1",$scope.newStreamData.interruptOptions.holdUxOptions=$scope.newStreamData.interruptOptions.holdUxOptions||{option:"discardCurrTask",message:""},$scope.newStreamData.interruptOptions.resumeUxOptions=$scope.newStreamData.interruptOptions.resumeUxOptions||{option:"confFromUser",message:""}},$scope.callback.saveInprogress=!1,$scope.validateTeamShare=function(){if($scope.myTeams){var selectedTeamCount=0;return $scope.myTeams.forEach(function(team){team.selected&&selectedTeamCount++}),selectedTeamCount>0?!0:!1}return!1},$scope.toggleResumeoptions=function(){$scope.newStreamData.interruptOptions.resumeUxOptions.neverNotify=$scope.newStreamData.interruptOptions.resumeUxOptions.neverNotify?!1:!0},$scope.getInteruptoptions=function(){var interruptOptions={numTasksToHold:$scope.newStreamData.interruptOptions.numTasksToHold,faqBehaviour:$scope.newStreamData.interruptOptions.faqBehaviour,smallTalkBehaviour:$scope.newStreamData.interruptOptions.smallTalkBehaviour,type:{option:$scope.newStreamData.interruptOptions.type.option,message:"endUser"===$scope.newStreamData.interruptOptions.type.option?$scope._constants_.pauseResumeMessages.allowEndUser.key:""}};return"doNotAllowHoldResume"===interruptOptions.type.option?interruptOptions={type:{option:"developer"},interruptsEnabled:!1,faqBehaviour:$scope.newStreamData.interruptOptions.faqBehaviour,smallTalkBehaviour:$scope.newStreamData.interruptOptions.smallTalkBehaviour}:(interruptOptions.interruptsEnabled=!0,"developer"===$scope.newStreamData.interruptOptions.type.option&&(interruptOptions.holdUxOptions={option:$scope.newStreamData.interruptOptions.holdUxOptions.option,message:""},"discardCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.discardCurrentTask.key:"continueCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.continueCurrentTask.key:interruptOptions.holdUxOptions.message=""),(interruptOptions.holdUxOptions&&"holdCurrTask"===interruptOptions.holdUxOptions.option||"endUser"===$scope.newStreamData.interruptOptions.type.option)&&(interruptOptions.resumeUxOptions={option:$scope.newStreamData.interruptOptions.resumeUxOptions.option||"confFromUser",message:""},$scope.newStreamData.interruptOptions&&$scope.newStreamData.interruptOptions.resumeUxOptions&&$scope.newStreamData.interruptOptions.resumeUxOptions.neverNotify?interruptOptions.resumeUxOptions.neverNotify=$scope.newStreamData.interruptOptions.resumeUxOptions.neverNotify:interruptOptions.resumeUxOptions.neverNotify=!1,"confFromUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.getConfirmatonWithUser.key:"notifyUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.notifyUserWithMessage.key:interruptOptions.resumeUxOptions.message="")),interruptOptions},$scope.callback.formInvalid=!1,$scope.callback.createStream=function(event){var errors;if(event&&event.preventDefault&&event.preventDefault(),!$scope.isFormValid($scope.streamAdvancedForm))return form_util.touch($scope.streamAdvancedForm),void($scope.callback.formInvalid=!0);$scope.callback.formInvalid=!1;var btPostData={};btPostData.name=$scope.newStreamData.name,btPostData.type=$workflowService.streamType()||"taskbot",btPostData.description=$scope.newStreamData.description,btPostData.color=$scope.newStreamData.color,btPostData.categoryIds=$scope.newStreamData.categoryIds,btPostData.websiteUrl=$scope.newStreamData.websiteUrl,btPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,btPostData.botDocLink=$scope.newStreamData.botDocLink,btPostData.hasTenant=$scope.newStreamData.hasTenant,btPostData.offKoraConfirmation=$scope.newStreamData.offKoraConfirmation,btPostData.synonyms=$scope.newStreamData.synonyms,btPostData.interruptOptions=$scope.getInteruptoptions(),btPostData.skipMakeEditLinks=$scope.newStreamData.skipMakeEditLinks||!1,btPostData.interruptOptions.showAmbiguous=$scope.newStreamData.interruptOptions.ambiguousIntents,$scope.checkInheritance()&&$scope.newStreamData.sbStreamId&&(btPostData.inheritanceType=$scope.newStreamData.inheritanceType),_.addProps($scope.newStreamData.purposeisRequired,btPostData,{purpose:$scope.newStreamData.purpose}),btPostData.hasTenant&&(btPostData.tenancy={},btPostData.tenancy.helpHint=$scope.newStreamData.helpHint,btPostData.baseUrl=$scope.newStreamData.defaultUrl),errors=angular.copy($scope.newStreamData.errorCodes),errors&&errors instanceof Array&&(errors=errors.map(function(obj){return delete obj.insert,obj})),errors=_.union(errors,$scope.newStreamData.pollError),errors=_.uniq(errors,function(error){return+error.statusCode}),btPostData.errorCodes={pollError:errors},btPostData.visibility={namespace:[],namespaceIds:[]},$scope.newStreamData.sharing&&$scope.newStreamData.sharing.enterprise&&btPostData.visibility.namespace.push("enterprise"),$scope.newStreamData.sharing&&$scope.newStreamData.sharing.team&&(btPostData.visibility.namespace.push("team"),btPostData.visibility.namespaceIds=[],$scope.myTeams&&$scope.myTeams.forEach(function(team){team.selected&&btPostData.visibility.namespaceIds.push(team.id)})),createBTStream(btPostData)},$scope.uploadStreamIcon=function(){if($scope.newStreamData.iconFile.name){var _ext=$scope.newStreamData.iconFile.name.substring($scope.newStreamData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.iconFile.name,fileId:response.data.fileId};$scope.newStreamData.icon=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label"),"success"),$scope.iconUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.iconUploading=!1})},$scope.deleteStreamIcon=function(){$scope.newStreamData.iconFile=null,$scope.newStreamData.icon=null,$("#iconFile").val("")},$scope.uploadLargeStreamBanner=function(){if($scope.newStreamData.bigBannerFile.name){var _ext=$scope.newStreamData.bigBannerFile.name.substring($scope.newStreamData.bigBannerFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bBfileExtensionError=!0)}$scope.bBfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.bigBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.bigBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.bigBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.bBanner=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label"),"success"),$scope.bigBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.bigBannerUploading=!1})},$scope.deleteStreamBBanner=function(){$scope.newStreamData.bigBannerFile=null,$scope.newStreamData.bBanner=null,$("#bigBannerFile").val("")},$scope.uploadSmallStreamBanner=function(){if($scope.newStreamData.smBannerFile.name){var _ext=$scope.newStreamData.smBannerFile.name.substring($scope.newStreamData.smBannerFile.name.lastIndexOf("."));if(".png"!==_ext&&".PNG"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bSfileExtensionError=!0)}$scope.bSfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.smBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.smBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.smBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.sBanner=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label"),"success"),$scope.smBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.smBannerUploading=!1})},$scope.deleteStreamSBanner=function(){$scope.newStreamData.smBannerFile=null,$scope.newStreamData.sBanner=null,$("#smBannerFile").val("")},$scope.onStreamFormCancel=function(){"edit"===$scope.displayMode?$location.path(window.appConfig.CONTEXT_PATH):($scope.newStreamData={},$scope.onCancel())},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.clearTenancy=function(){$scope.newStreamData.defaultUrl="",$scope.newStreamData.helpHint=""},$scope.goBack=function(){$scope.onBack()},$scope.clearTeams=function(){$scope.myTeams.map(function(team){team.selected=!1})};$scope.isFormValid=function(form){return!(form.$invalid||$scope.newStreamData.sharing&&$scope.newStreamData.sharing.team&&!$scope.validateTeamShare())},$scope.$on("evt:exitAct",function(evt,data){$scope.streamForm.$valid?$scope.callback.createStream(!0):NotificationService.notify(i18n.i18nString("enter_valid_data"),"error")}),$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$scope.showAdvancedOptions=function(){$scope.showadvancedoptions?($scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$("#advancedoptdivStream .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showadvancedoptions=!0,$scope.advancedoptiontext=i18n.i18nString("hide_advanced_options_label"),$("#advancedoptdivStream .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"))},$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation(),setTimeout(function(){$scope.manageResponseCB.title="Confirmation Dialog for component",$scope.manageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key];var _btnValue="close";$scope.manageResponseCB.openManageResponse(_btnValue),$scope.manageResponseCB.initMessages($scope.advancedDisplayMode)},200)},$scope.manageResponseCB.closeResponseScreen=function(){$scope.showStandardResponses=!1,$scope.manageResponseCB.conditionKey={}},$scope.validateBotName=function(){var regexp=/^[a-zA-Z0-9][a-zA-Z0-9_<>*. ]+$/,regexp2=/^[a-zA-Z0-9]/;return{test:function(value){return value&&1===value.length?regexp2.test(value):regexp.test(value)}}}(),$scope.validateYoutubeURL=function(){return{test:function(uri){var p=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return uri.match(p)?!0:!1}}}(),$scope.file={},$scope.uploadFile=function(fileObject){var _ext="";if(fileObject&&fileObject.name){_ext=fileObject.name.substring(fileObject.name.lastIndexOf("."));var supportingFileFormats=[".js"];if(-1===$.inArray(_ext,supportingFileFormats))return void NotificationService.notify(i18n.i18nString("upload_only_js_files"),"error")}var _fileLimit=5e5;if(fileObject.size>_fileLimit)return void NotificationService.notify(i18n.i18nString("file_size_shouldnot_exced_err_noty"),"warning");var data=new FormData;data.append("file",fileObject),data.append("fileContext","bulkImport"),data.append("fileExtension","txt"),data.append("Content-Type",fileObject.type),$scope.data=data,$scope.fileObject=fileObject,$scope.fileName=fileObject.name,$scope.fileuploading=!0,BTStreamsService.uploadBotFunctionsFile($applicationService.userInfo().userId,data).then(function(response){var fileUploaded={fileName:$scope.fileName,fileId:response.data.fileId};$scope.fileObject=fileUploaded,$scope.fileuploading=!1},function(err){NotificationService.notify(i18n.i18nString("oops_label")+err.data.errors[0].msg,"error"),$scope.fileuploading=!1})},$scope.importCustomScriptModal=function(){$scope.importStep=1,$(".import-customScript-modal").modal("show"),$timeout(function(){initDragDropFile()},500)},$scope.onCancelCustomScript=function(){$(".import-customScript-modal").modal("hide"),$scope.fileName=""},$scope.removeFile=function(){$scope.fileName=""};var progressInterval="";$scope.startImport=function(){BTFileUploadService.uploadFile($scope.data).then(function(response){$scope.importStep=3,$scope.totalProgress=1,$scope.qafileuploading=!0,$timeout(function(){if($scope.fileObject){var _parms={fileName:$scope.fileObject.fileName,fileId:$scope.fileObject.fileId};BTStreamsService.addBotFunctions($workflowService.selectedStream()._id,_parms).then(function(res){$scope.importStep=4,$scope.file.fileData=res.data,$scope.file.fileData.fileName=res.data.fileName,getBotFunctions(),startImportProgress(),NotificationService.notify(i18n.i18nString("saved"),"success")},function(errRes){$scope.importStep=2,NotificationService.notify(i18n.i18nString("failed_saving_err_noty"),"error")})}else NotificationService.notify(i18n.i18nString("please_choose_a_file_err"),"warning")},3e3)},function(response){$scope.totalProgress=100,$scope.importStep=2,$scope.errorMsg=response.data.errors})},$scope.deleteBotFunctions=function(file){NotificationService.alert(i18n.i18nString("do_you_want_to_delete_bot_function_label"),function(){var _parms={fileName:file.fileData.fileName,fileId:file.fileData.fileId};BTStreamsService.deleteBotFunctions($workflowService.selectedStream()._id,_parms).then(function(res){$scope.file.fileData.fileName="",NotificationService.notify(i18n.i18nString("bot_function_removed_sucess"),"success")},function(errRes){console.log("Failed deleting bot functions")})},{okText:i18n.i18nString("ok")})},$scope.getDate=function(){var timestamp=$scope.file.fileData.createdOn;return void 0===timestamp?"--":moment(timestamp).format("MM-DD-YYYY")},$scope.getTime=function(){var timestamp=$scope.file.fileData.createdOn;return void 0===timestamp?"--":moment(timestamp).format("h:mm A")},$scope.moveForward=function(stepNo){$scope.importStep=stepNo,1==stepNo&&$scope.removeFile()},$scope.goToStep=function(stepNo){1==stepNo&&$scope.moveForward(stepNo)},$scope.$emit("nestedComponentLoaded",{id:"advancedSettings",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("botAuthorization",function(){return{restrict:"AE",scope:{wfType:"@",onComplete:"&",displayMode:"@",onCancel:"&",configure:"&",isFinishSetupLoading:"=",hooks:"=?callbacks",callback:"=?",btcallback:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/bot-authorization-form.html",controller:"authorizationCtrl"}})}(angular),function(ng){var _module=ng.module("bt-forms");_module.directive("botChangeLog",function(){return{restrict:"EA",scope:{callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/bot-changelog-form.html",controller:["$scope","_constants_","$workflowService","$location","$timeout","BTStreamsService","$applicationService","i18n","env_conf","form_util","$filter","$rootScope",function($scope,_constants_,$workflowService,$location,$timeout,BTStreamsService,$applicationService,i18n,env_conf,form_util,$filter,$rootScope){function resolvedFields(uId){if($scope.resolvedFields&&$scope.resolvedFields.users&&$scope.resolvedFields.users.length){var findName=$scope.resolvedFields.users.find(function(item){return item._id===uId}),name=findName.hasOwnProperty("_id")?findName.firstName+" "+findName.lastName:findName._id;return" "===name&&(name=findName.emailId),name}}function filterDeveloperNames(){if(0===$scope.selectedContacts.selectedUsers.length&&($scope.filterChangeLogs.selectedDevloperNames=[]),$scope.selectedContacts.selectedUsers.length){var list=[];$scope.selectedContacts.selectedUsers.forEach(function(item){item.hasOwnProperty("_id")?list.push(item._id):console.log("Removed duplicates")}),$scope.filterChangeLogs.selectedDevloperNames=list}}function uIdToDeveloperList(list){var result=[];return list.length?(list.forEach(function(item){var findObj=$scope.usersList.find(function(uId){return uId._id===item});result.push(findObj)}),result):result}function init(){$scope.getDevelopersList(),$scope.sumocb={developerNamecb:{changeText:!0,selectAll:!0}},$scope.endDate=moment().toISOString(),$scope.startDate=moment().subtract(7,"d").toISOString(),$scope.filterTags.push({value:i18n.i18nString("last7_days"),type:"date",tooltipValue:moment($scope.startDate).format("MM-DD-YYYY")+i18n.i18nString("to_label_spaced")+moment($scope.endDate).format("MM-DD-YYYY"),count:7})}$scope._constants_=_constants_,$scope.callback=$scope.callback||{},$scope.stream=$workflowService.selectedStream(),$scope.logs=[],$scope.loading=!1,$scope.currentPage=1,$scope.offset=0,$scope.limit=10,$scope.count=0,$scope.moreAvailable=!1,$scope.modalSlider={},$scope.search="",$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.searchIcon=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.exportIcon=env_conf["context-url"]+"/assets/images/left-menu-img/export.svg",$scope.calendarIcon=env_conf["context-url"]+"/assets/ontology/calendar.svg",$scope.developerNames=[],$scope.filterChangeLogs={selectedDevloperNames:[]},$scope.startDate="",$scope.endDate="",$scope.days=7,$scope.defaultFilter=!0,$scope.defaultFilterMsg="",$scope.filterTags=[];var filterComponent={};$scope.filterPayload={},$scope.usersList=[],$scope.resolvedFields=[];var filterCompTemp={};return $scope.selectedContacts={selectedUsers:[]},0===Object.keys($scope.stream).length?void $location.path(window.appConfig.CONTEXT_PATH):($scope.$watch("currentPage",function(newVal){$scope.getDefaultFilter(7),$scope.offset=($scope.currentPage-1)*$scope.limit,$scope.callback.getChangeLogs()}),$scope.callback.getChangeLogs=function(offset){$scope.loading=!0,offset=offset||0,$scope.filterPayload={userIds:$scope.filterChangeLogs.selectedDevloperNames,startDate:$scope.startDate,endDate:$scope.endDate,search:$scope.search||""},BTStreamsService.getChangeLogFilter($scope.stream._id,offset,$scope.limit,$scope.filterPayload).then(function(res){0===offset&&$scope.$broadcast("changeCurrentPage",1),$scope.resolvedFields=res.data.resolvedFields,$scope.logs=res.data.btlogs.map(function(log){return log.created=new Date(log.createdOn).toLocaleString(),log.username=resolvedFields(log.userId),log}),$scope.loading=!1,$scope.count=res.data.count,moreAvailable=res.data.moreAvailable},function(err){$scope.logs=[],$scope.loading=!1})},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.$emit("nestedComponentLoaded",{id:"changeLogs",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.sortByDate=function(param){"new"===param?$scope.logs=$filter("orderBy")($scope.logs,"created",!0):"old"===param&&($scope.logs=$filter("orderBy")($scope.logs,"created",!1))},$scope.applyFilter=function(){moment($scope.endDate).format("YYYY-MM-DD")===moment().format("YYYY-MM-DD")&&($scope.endDate=moment().toISOString()),filterDeveloperNames(),filterComponent={startDate:$scope.startDate,endDate:$scope.endDate,developerNames:$scope.filterChangeLogs.selectedDevloperNames,days:$scope.days},filterCompTemp=angular.copy(filterComponent),$scope.filterTags=[];var daysCount,startDateTemp=moment(filterComponent.startDate).format("MM-DD-YYYY"),endDateTemp=moment(filterComponent.endDate).format("MM-DD-YYYY"),sD=new Date($scope.startDate),eD=new Date($scope.endDate),timeDiff=eD.getTime()-sD.getTime(),countDays=timeDiff/864e5;countDays&&countDays.toString()&&"undefined"!=typeof countDays.toString().split&&countDays.toString().split(".")&&countDays.toString().split(".")[0]&&countDays.toString().split(".")[0].length&&7!==filterComponent.days?countDays&&countDays.toString()&&"undefined"!=typeof countDays.toString().split&&countDays.toString().split(".")&&countDays.toString().split(".")[1]&&countDays.toString().split(".")[1].length&&countDays>8?(countDays+=1,daysCount=countDays.toString().split(".")[0]):"0"===countDays.toString().split(".")[0]?(countDays+=1,daysCount=countDays.toString().split(".")[0]):(countDays+=1,daysCount=countDays.toString().split(".")[0]):7!==filterComponent.days&&(daysCount=countDays),7===filterComponent.days?$scope.filterTags.push({value:i18n.i18nString("last7_days"),type:"date",tooltipValue:startDateTemp+i18n.i18nString("to_label_spaced")+endDateTemp,count:moment($scope.endDate).diff($scope.startDate,"days")}):-1===filterComponent.days?$scope.filterTags.push({value:i18n.i18nString("custom"),type:"date",tooltipValue:startDateTemp+i18n.i18nString("to_label_spaced")+endDateTemp,count:daysCount}):$scope.filterTags.push({value:i18n.i18nString("last_24_hours"),type:"date",tooltipValue:startDateTemp+i18n.i18nString("to_label_spaced")+endDateTemp,count:moment($scope.endDate).diff($scope.startDate,"days")}),filterComponent.developerNames.length>0&&($scope.filterTags.push({value:"Developer Name",type:"developerNames",tooltipValue:filterComponent.developerNames||"",count:filterComponent.developerNames.length}),$scope.getDeveloperNames()),$scope.filterPayload={userIds:$scope.filterChangeLogs.selectedDevloperNames,startDate:$scope.startDate,endDate:$scope.endDate,search:$scope.search||""},$scope.offset=0,BTStreamsService.getChangeLogFilter($scope.stream._id,$scope.offset,$scope.limit,$scope.filterPayload).then(function(res){0===$scope.offset&&($scope.$broadcast("changeCurrentPage",1),$scope.$broadcast("changeOffset",0)),$scope.resolvedFields=res.data.resolvedFields,$scope.logs=res.data.btlogs.map(function(log){return log.created=new Date(log.createdOn).toLocaleString(),log.username=resolvedFields(log.userId),log}),$scope.loading=!1,$scope.count=res.data.count,moreAvailable=res.data.moreAvailable},function(err){$scope.logs=[],$scope.loading=!1}),$scope.modalSliderClose()},$scope.clearFilterTags=function(){$scope.filterTags=[],filterComponent={endDate:moment().toISOString(),startDate:moment().subtract(7,"d").toISOString(),developerNames:[],days:7},$scope.filterChangeLogs.selectedDevloperNames=[],$scope.selectedContacts.selectedUsers=[],$scope.getDefaultFilter(7),$scope.filterTags.push({value:i18n.i18nString("last7_days"),type:"date",tooltipValue:moment($scope.startDate).format("MM-DD-YYYY")+i18n.i18nString("to_label_spaced")+moment($scope.endDate).format("MM-DD-YYYY"),count:filterComponent.days}),$scope.callback.getChangeLogs(0),filterCompTemp=angular.copy(filterComponent)},$scope.removeFilterTag=function(index,tag){"date"===tag.type?$scope.getDefaultFilter(7):"developerNames"===tag.type&&($scope.filterChangeLogs.selectedDevloperNames=[],$scope.selectedContacts.selectedUsers=[]),$scope.filterTags.splice(index,1),0===$scope.filterTags.length&&$scope.clearFilterTags(),filterComponent={startDate:$scope.startDate,endDate:$scope.endDate,developerNames:$scope.filterChangeLogs.selectedDevloperNames,days:$scope.days},$scope.callback.getChangeLogs(),filterCompTemp=angular.copy(filterComponent)},$scope.exportFile=function(){window.bootbox.dialog({message:i18n.i18nString("export_change_logs_description"),title:i18n.i18nString("export_change_logs"),className:"daas-confirm-dialog",onEscape:function(){},closeButton:!1,buttons:{success:{label:i18n.i18nString("confirm"),className:"btn_md",callback:function(){var payload={userIds:$scope.filterChangeLogs.selectedDevloperNames,startDate:$scope.startDate,endDate:$scope.endDate,search:$scope.search,timezone:moment.tz.guess()},reqStatus="configured",filetype="csv";BTStreamsService.getChangeLogExport($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload,reqStatus,filetype).then(function(response){console.log(response),"IN_PROGRESS"===response.data.status&&(NotificationService.notify("Exporting Change Logs","success"),$rootScope.$broadcast("getProgressDockStatus"),
$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open"))},function(error){console.log(error),NotificationService.notify(error.data.errors[0].msg,"error")})}},main:{label:i18n.i18nString("cancel"),className:"closeCancel",callback:function(){}}}})},$scope.resetFilter=function(){$scope.filterChangeLogs.selectedDevloperNames=[],$scope.selectedContacts.selectedUsers=[],$scope.getDefaultFilter(7)},$scope.openFilterSlider=function(){$scope.resetDefaultData(),$timeout(function(){$(".kore-chat-window")&&$(".kore-chat-window").length&&!$(".kore-chat-window").hasClass("minimize")&&$(".kore-chat-window .minimize-btn").trigger("click"),$scope.modalSlider.open("#changeLogsFilter"),$("#tagInput").focus()},500)},$scope.modalSliderClose=function(){$timeout(function(){$scope.modalSlider.close("#changeLogsFilter")},500)},$scope.resetDefaultData=function(){Object.keys(filterCompTemp).length&&($scope.filterChangeLogs.selectedDevloperNames=filterCompTemp.developerNames,$scope.selectedContacts.selectedUsers=uIdToDeveloperList(filterCompTemp.developerNames),$scope.startDate=filterCompTemp.startDate,$scope.endDate=filterCompTemp.endDate,$scope.getDefaultFilter(filterCompTemp.days))},$scope.getDefaultFilter=function(days){$scope.days=days,-1!==days&&($scope.appliedSelectedDays=days),-1!==days&&($scope.endDate=moment().toISOString(),$scope.startDate=moment().subtract(days,"d").toISOString()),-1==days&&(7==$scope.appliedSelectedDays?($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):1==$scope.appliedSelectedDays&&($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))))},$timeout(function(){daterangepickerInput=$('div[name="daterange"]').daterangepicker({startDate:moment(new Date($scope.startDate)).format("MM-DD-YYYY")||moment(),endDate:moment(new Date($scope.endDate)).format("MM-DD-YYYY")||moment(),maxDate:moment(new Date).format("MM-DD-YYYY"),opens:"left",customClass:"analyze-datepicker"}),$('div[name="daterange"]').on("apply.daterangepicker",function(ev,picker){$scope.appliedSelectedDays=-1,ev&&($scope.startDate=picker.startDate._d,$scope.endDate=picker.endDate._d),moment()._d.getDate()===$scope.endDate.getDate()&&moment()._d.getDay()===$scope.endDate.getDay()&&moment()._d.getYear()===$scope.endDate.getYear()&&($scope.endDate=moment()._d)}),$('div[name="daterange"]').on("cancel.daterangepicker",function(){7==$scope.appliedSelectedDays?($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):-1!==$scope.appliedSelectedDays&&($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),$scope.days=$scope.appliedSelectedDays}),$('div[name="daterange"]').on("outsideClick.daterangepicker",function(){7==$scope.appliedSelectedDays?($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):-1!==$scope.appliedSelectedDays&&($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),$scope.days=$scope.appliedSelectedDays})},300),$scope.searchChangeLogs=function(){return $scope.search=$scope.search.trim(),$scope.search?($scope.loading=!0,$scope.offset=0,$scope.filterPayload={userIds:$scope.filterChangeLogs.selectedDevloperNames,startDate:$scope.startDate,endDate:$scope.endDate,search:$scope.search||""},void BTStreamsService.getChangeLogFilter($scope.stream._id,$scope.offset,$scope.limit,$scope.filterPayload).then(function(res){0===$scope.offset&&($scope.$broadcast("changeCurrentPage",1),$scope.$broadcast("changeOffset",0)),$scope.resolvedFields=res.data.resolvedFields,$scope.logs=res.data.btlogs.map(function(log){return log.created=new Date(log.createdOn).toLocaleString(),log.username=resolvedFields(log.userId),log}),$scope.loading=!1,$scope.count=res.data.count,moreAvailable=res.data.moreAvailable},function(err){$scope.logs=[],$scope.loading=!1})):($scope.offset=0,0===$scope.offset&&$scope.$broadcast("changeOffset",0),void $scope.callback.getChangeLogs(0))},$scope.cancelSearch=function(){$scope.search="",$scope.offset=0,0===$scope.offset&&$scope.$broadcast("changeOffset",0),$scope.callback.getChangeLogs(0)},$scope.getDeveloperNames=function(tag){if(tag&&Object.keys(tag).length){if("developerNames"===tag.type){var resultArr=[];return tag.tooltipValue.forEach(function(uId,index){var name=$scope.usersList.find(function(item){return item._id===uId});resultArr.push(name.fullName)}),resultArr.join()||""}return tag.tooltipValue}},$scope.getDevelopersList=function(){BTStreamsService.getContacts($scope.stream._id).then(function(res){var contacts=[];res.data.map(function(contact){contact.isDeveloper&&"active"===contact.accountInfo.activationStatus&&contacts.push({_id:contact._id,fullName:contact.personalInfo.fullName,firstName:contact.personalInfo.firstName,lastName:contact.personalInfo.lastName,profColor:contact.accountInfo.profColour,profImage:contact.accountInfo.profImage,emailId:contact.orgDomain,jTitle:contact.accountInfo.jTitle})},function(error){}),$scope.usersList=contacts,$scope.developerNames=contacts,$scope.callback.unique=!0})},void init())}]}}),_module.filter("highlightKeywords",function($sce){var stringToArray=function(input){return input?input.match(/\S+/g):[]},getRegexPattern=function(keywordArray){var pattern="(^|\\b)("+keywordArray.join("|")+")";return new RegExp(pattern,"gi")};return function(textToHighlight,keywords){var filteredText=textToHighlight;if(""!==keywords){var keywordList=stringToArray(keywords),pattern=getRegexPattern(keywordList);filteredText=textToHighlight.replace(pattern,'<span class="highlighted">$2</span>')}return $sce.trustAsHtml(filteredText)}})}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("botGeneralSettings",function(){return{restrict:"EA",scope:{callback:"=",streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/bot-generalsettings-form.html",controller:["$scope","form_util","patternFactory","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","$timeout","env_conf","accessControlService","i18n",function($scope,form_util,patternFactory,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,$timeout,env_conf,accessControlService,i18n){function createMPStream(streamData){$workflowService.selectedStream()._id&&"edit"===$scope.displayMode?BTStreamsService.updateMPStream($workflowService.selectedStream()._id,streamData).then(function(response){$scope.callback.saveInprogress=!1,$scope.callback.saveSuccess=!0,slashCommand($workflowService.selectedStream()._id),$workflowService.streamType("")},function(res){$scope.callback.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")}):BTStreamsService.createMPStream($applicationService.userInfo().userId,streamData).then(function(response){$scope.callback.saveSuccess=!0,$scope.callback.saveInprogress=!1,slashCommand(streamData._id),$workflowService.streamType("")},function(res){$scope.callback.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")})}function createBTStream(streamData){$scope.duplicateStreamName=!1,$scope.callback.saveInprogress||($workflowService.selectedStream()._id&&"edit"===$scope.displayMode?($scope.callback.saveInprogress=!0,$scope.newStreamData.icon.fileId&&(streamData.icon=$scope.newStreamData.icon.fileId),BTStreamsService.editStream($workflowService.selectedStream()._id,streamData).then(function(response){var mpPostData={};$scope.$emit("savingInprogress",!1),mpPostData._id=response.data._id,mpPostData.name=$scope.newStreamData.name,mpPostData["class"]=$scope.newStreamData["class"],mpPostData.description=$scope.newStreamData.description,mpPostData.tagline=$scope.newStreamData.tagline,mpPostData.categoryIds=$scope.newStreamData.categoryIds,mpPostData.icon=$scope.newStreamData.icon.fileId,mpPostData.iconName=$scope.newStreamData.icon.fileName,mpPostData.websiteURL=$scope.newStreamData.websiteUrl,mpPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,mpPostData.botDocLink=$scope.newStreamData.botDocLink,mpPostData.keywords=$scope.newStreamData.keywords?$scope.newStreamData.keywords.split(","):[],mpPostData.languages=[],mpPostData.price=1,mpPostData.screenShots=[],mpPostData.namespace="private",mpPostData.namespaceIds=[],mpPostData.userTaskListMsg=$scope.newStreamData.userTaskListMsg,mpPostData.teamTaskListMsg=$scope.newStreamData.teamTaskListMsg,"color"===$scope.newStreamData.bbannerchoice?mpPostData.bBannerColor=$scope.newStreamData.bBannerColor=$scope.newStreamData.color:$scope.newStreamData.bBanner&&$scope.newStreamData.bBanner.fileId&&(mpPostData.bBanner=$scope.newStreamData.bBanner.fileId),"color"===$scope.newStreamData.sbannerchoice?mpPostData.sBannerColor=$scope.newStreamData.sBannerColor=$scope.newStreamData.color:$scope.newStreamData.sBanner&&$scope.newStreamData.sBanner.fileId&&(mpPostData.sBanner=$scope.newStreamData.sBanner.fileId),mpPostData.color=$scope.newStreamData.color,_.addProps(!0,mpPostData,{purpose:$scope.newStreamData.purpose}),mpPostData.profileRequired="true"===$scope.newStreamData.profileRequired,mpPostData.sendVcf="true"===$scope.newStreamData.sendVcf&&mpPostData.profileRequired,mpPostData.isNLEnabled="yes"==$scope.newStreamData.isNLEnabled,response.data&&response.data.welcomeMessage&&(response.data.welcomeMessage=$scope.welcomeMessages||[]),$workflowService.selectedStream(angular.merge($workflowService.selectedStream(),response.data)),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data),$scope.$emit("streamUpdate"),res.data&&res.data.forEach(function(obj){obj._id==$workflowService.selectedStream()._id&&($scope.welcomeMessages=obj.welcomeMessage||$scope.welcomeMessages||[])})}),response.data.languagePreferences&&(mpPostData.languagePreferences=response.data.languagePreferences),createMPStream(mpPostData)},function(res){return $scope.callback.saveInprogress=!1,$scope.$emit("savingInprogress",!1),409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("stream_duplicate")?void($scope.duplicateStreamName=!0):void NotificationService.notify(res.data.errors[0].msg,"error")})):($scope.callback.saveInprogress=!0,BTStreamsService.createBTStream($applicationService.userInfo().userId,streamData).then(function(response){var mpPostData={};$scope.$emit("savingInprogress",!1),mpPostData._id=response.data._id,mpPostData.name=$scope.newStreamData.name,mpPostData.description=$scope.newStreamData.description,mpPostData["class"]=$scope.newStreamData["class"],mpPostData.categoryIds=$scope.newStreamData.categoryIds,mpPostData.icon=$scope.newStreamData.icon.fileId,mpPostData.iconName=$scope.newStreamData.icon.fileName,mpPostData.keywords=$scope.newStreamData.keywords?$scope.newStreamData.keywords.split(","):[],mpPostData.languages=[],mpPostData.price=1,mpPostData.screenShots=[],mpPostData.namespace="private",mpPostData.namespaceIds=[],mpPostData.userTaskListMsg=$scope.newStreamData.userTaskListMsg,mpPostData.teamTaskListMsg=$scope.newStreamData.teamTaskListMsg,mpPostData.color=$scope.newStreamData.color,mpPostData.tagline=$scope.newStreamData.tagline,"color"===$scope.newStreamData.bbannerchoice?mpPostData.bBannerColor=$scope.newStreamData.bBannerColor=$scope.newStreamData.color:$scope.newStreamData.bBanner&&$scope.newStreamData.bBanner.fileId&&(mpPostData.bBanner=$scope.newStreamData.bBanner.fileId),"color"===$scope.newStreamData.sbannerchoice?mpPostData.sBannerColor=$scope.newStreamData.sBannerColor=$scope.newStreamData.color:$scope.newStreamData.sBanner&&$scope.newStreamData.sBanner.fileId&&(mpPostData.sBanner=$scope.newStreamData.sBanner.fileId),mpPostData.websiteURL=$scope.newStreamData.websiteUrl,mpPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,mpPostData.botDocLink=$scope.newStreamData.botDocLink,mpPostData.profileRequired="true"===$scope.newStreamData.profileRequired,mpPostData.sendVcf="true"===$scope.newStreamData.sendVcf&&mpPostData.profileRequired,$workflowService.selectedStream(response.data),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data),$scope.$emit("streamUpdate"),res.data&&res.data.forEach(function(obj){obj._id==$workflowService.selectedStream()._id&&($scope.welcomeMessages=obj.welcomeMessage||$scope.welcomeMessages||[])})}),createMPStream(mpPostData)},function(res){return $scope.callback.saveInprogress=!1,$scope.$emit("savingInprogress",!1),409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("stream_duplicate")?void($scope.duplicateStreamName=!0):void NotificationService.notify(res.data.errors[0].msg,"error")})))}function slashCommand(id){var msg=$routeParams.streamId?i18n.i18nString("updated"):i18n.i18nString("saved_name");if($scope.commandCtx.createSlashCommand){var command=$scope.newStreamData.command||{};return $scope.commandCtx.streamId=$workflowService.selectedStream()._id||id,0===Object.keys(command).length?void notifyStreamStatus($scope.newStreamData.name,msg):$scope.commandCtx.createSlashCommand().then(function(res){$scope.newStreamData.command._id=res.data._id,notifyStreamStatus($scope.newStreamData.name,msg)},function(err){var errorMsg=err.data.errors[0].msg;NotificationService.notify(errorMsg,"error")})}notifyStreamStatus($scope.newStreamData.name,msg)}function notifyStreamStatus(streamName,msg){NotificationService.notify(streamName+msg+i18n.i18nString("successfully"),"success"),$rootScope.$broadcast("evt:nextSucc")}function showErrorMessage(err){try{return NotificationService.notify(err.data.errors[0].msg,"error"),!0}catch(e){return!1}}function unique(array){for(var a=array.concat(),i=0;i<a.length;++i)for(var j=i+1;j<a.length;++j)a[i]===a[j]&&a.splice(j--,1);return a}var enterpriseLicenseType=$rootScope.licenseType;$scope.callback=$scope.callback||{},$scope.stream=$workflowService.selectedStream(),$scope.callback.modeOfAccess=accessControlService.setRetrieveValue(),$scope.selectedLanguage=$workflowService.currentLanguage(),$scope.displayMode="edit",$scope.editoption=i18n.i18nString("edit"),$scope.addoption=i18n.i18nString("add"),$scope.characters=i18n.i18nString("Generalform_charlimit"),$scope.snapshotsArray=[],$scope.universal=i18n.i18nString("universal_bot_purpose"),$scope.published=i18n.i18nString("bot_published"),$scope.commandCtx={},$scope.selectedStreamState=$workflowService.selectedStreamState(),$scope.isUploading=!1,$scope.errorInsideStream=!0,$scope.categories=$workflowService.seedData().category,$scope.duplicateStreamName=!1,$scope._constants_=$rootScope._constants_,$scope.sdkCallback={},$scope.welcomeMessagecb={},$scope.assetsBase=env_conf["assets-url"],$scope.currentStream=$workflowService.selectedStream(),$scope.currentStream&&$scope.currentStream.sbStreamId&&BTStreamsService.getMPStream($scope.currentStream.sbStreamId).then(function(res){$scope.parentSBStream=res.data}),$scope.checkInheritance=function(){return void 0===$scope.newStreamData.allowInheritance?!0:$scope.newStreamData.allowInheritance?!0:!1},$scope.getLocaleTime=function(timestamp,timeInAMPM){var d=moment(timestamp).format("MM-DD-YYYY"),dateStr=moment(timestamp).format("MMMM Do YYYY, h:mm:ss a").split(",")[1],timeStamp=dateStr.split(":");return d+","+timeStamp[0]+":"+timeStamp[1]+" "+timeStamp[2].split(" ")[1]},$scope.icons={spark:env_conf["context-url"]+"/img/spark.svg",msteams:env_conf["context-url"]+"/img/microsoft-teams-icon.png",syniverse:env_conf["context-url"]+"/img/syniverse.png",rcengage:env_conf["context-url"]+"/img/ringCentralEngage.png",slack:env_conf["context-url"]+"/img/slack.svg",sms:env_conf["context-url"]+"/img/sms.svg",twilio:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",email:env_conf["context-url"]+"/img/email.svg",skype:"",facebook:env_conf["context-url"]+"/img/facebook.svg",websdk:env_conf["context-url"]+"/img/slack.svg",kore:env_conf["context-url"]+"/img/kore.svg",rtm:env_conf["context-url"]+"/img/web-mobile.svg",widgetsdk:env_conf["context-url"]+"/img/widgetsdk.svg",twitter:env_conf["context-url"]+"/img/twitter.svg",skypeOnPrem:env_conf["context-url"]+"/img/skypebusiness.svg",cisco:env_conf["context-url"]+"/img/cisco-tropo-icon.png",wfacebook:env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Groups":env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Chat":env_conf["context-url"]+"/img/fb-workplace-icon.png",ringcentral:env_conf["context-url"]+"/img/ringCentralIcon.png",skypeforbusiness:env_conf["context-url"]+"/img/skypebusiness.svg",jabber:env_conf["context-url"]+"/img/jabbericon.jpg",yammer:env_conf["context-url"]+"/img/yammericon.png",telegram:env_conf["context-url"]+"/img/telegram-logo.png",alexa:env_conf["context-url"]+"/img/amazonalexa.png",twiliovoice:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",line:env_conf["context-url"]+"/img/line-logo.png",ivr:env_conf["context-url"]+"/img/webhook.png",liveperson:env_conf["context-url"]+"/img/live-person.png",ivrVoice:env_conf["context-url"]+"/assets/ivrIcons/ivrIcon.svg",wechat:env_conf["context-url"]+"/img/weChat.svg"},$scope.welcomeMessages=$scope.stream.welcomeMessage||[],$scope.cb={},$scope.botSetupConfirmationDescription=$rootScope.getSanitizedText($rootScope.lableData.bb012),$scope.char_remaining=i18n.i18nString("char_remaining"),$scope.If_universalbot=i18n.i18nString("If_universalbot"),$scope.not_universalbot=i18n.i18nString("not_universalbot"),$scope.edit=i18n.i18nString("edit"),$scope.add_label=i18n.i18nString("add_label"),$scope.parent_bot=i18n.i18nString("parent_bot"),$scope.js_msg=i18n.i18nString("js_msg"),$scope.categoryConfig={allowclear:!0,multiple:!0,placeholder:i18n.i18nString("select_category")},$scope.classConfig={allowclear:!0,multiple:!0,placeholder:i18n.i18nString("select_class")},$scope.newStreamData={profileRequired:"true",purpose:enterpriseLicenseType?"customer":null,sbannerchoice:"image",bbannerchoice:"image"},$scope.newStreamData.purposeisRequired=enterpriseLicenseType,$scope.myTeams=[],$scope.showBotNameHint=!1,$scope.bulbSvg=env_conf["context-url"]+"/assets/images/24x29-bulbicon.png",$scope.showNlpEnable=function(){return $rootScope.wfAdmin},$scope.universalBotPurposeError=!1;var allStreams=$workflowService.streamsAll();if(allStreams.length)var employeeBots=_.filter(allStreams,{purpose:"employee"}),customerBots=_.filter(allStreams,{purpose:"customer"});$scope.callback.loadGeneralSettings=function(){$scope.callback.loadingGeneralSettings=!0,BTSeedDataService.getSeedCategories().then(function(res){$scope.categories=res.data.categories}),$("#noty_center_layout_container").empty();$scope.streamId=$workflowService.selectedStream()._id,$workflowService.selectedStream()._id&&BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){$scope.currentStream=res.data,$scope.newStreamData={_id:res.data._id,type:res.data.type||"taskbot",websiteUrl:res.data.websiteUrl,demoYoutubeLink:res.data.demoYoutubeLink,botDocLink:res.data.botDocLink,color:res.data.color,hasUserEndpoint:res.data.hasUserEndpoint,keywords:null,hasTenant:res.data.hasTenant,defaultUrl:res.data.baseUrl,helpHint:res.data.tenancy?res.data.tenancy.helpHint:null,sharing:{},offKoraConfirmation:res.data.offKoraConfirmation,synonyms:res.data.synonyms,purpose:res.data.purpose,skipMakeEditLinks:res.data.skipMakeEditLinks||!1},res.data.sbStreamId&&($scope.newStreamData.inheritanceType=res.data.inheritanceType||1,$scope.newStreamData.allowInheritance=res.data.allowInheritance,$scope.newStreamData.sbStreamId=res.data.sbStreamId),res.data.description&&($scope.newStreamData.description=res.data.description.replace(/&gt;/g,">").replace(/&lt;/g,"<")),res.data.name&&($scope.newStreamData.name=res.data.name.replace(/&gt;/g,">").replace(/&lt;/g,"<").trim().replace(/\s\s+/g," ")),$scope.newStreamData.allowInheritance=res.data.allowInheritance,$scope.welcomeMessages=res.data.welcomeMessage||$scope.welcomeMessages||[],$scope.newStreamData.type=res.data.type,"universalbot"===res.data.type&&(res.data.awaitingApprovalBots.length>0||res.data.publishedBots.length>0||res.data.configuredBots.length>0)?$scope.newStreamData.isInMarket=!0:"private"!==res.data.visibility.namespace?$scope.newStreamData.isInMarket=!0:$scope.newStreamData.isInMarket=$workflowService.selectedStream().isInMarket;try{$scope.newStreamData.sharing[res.data.visibility.namespace[0]]=!0,$scope.newStreamData.sharing[res.data.visibility.namespace[1]]=!0}catch(ex){}res.data.errorCodes&&res.data.errorCodes.pollError&&($scope.newStreamData.pollError=res.data.errorCodes.pollError,$scope.newStreamData.errorCodes=res.data.errorCodes.pollError),res.data.visibility&&res.data.visibility.namespaceIds&&res.data.visibility.namespaceIds.forEach(function(item){for(var i=0;i<$scope.myTeams.length;i++)if($scope.myTeams[i].id===item){$scope.myTeams[i].selected=!0;break}})}).then(function(){BTStreamsService.getMPStream($workflowService.selectedStream()._id).then(function(res){res.data&&($scope.newStreamData.categoryIds=res.data.categoryIds,$scope.newStreamData.websiteUrl=res.data.websiteURL,$scope.newStreamData.demoYoutubeLink=res.data.demoYoutubeLink,$scope.newStreamData.botDocLink=res.data.botDocLink,$scope.newStreamData["class"]=res.data["class"],$scope.newStreamData.tagline=res.data.tagline,$scope.newStreamData.userTaskListMsg=res.data.userTaskListMsg,$scope.newStreamData.teamTaskListMsg=res.data.teamTaskListMsg,$scope.newStreamData.profileRequired=res.data.profileRequired+"",$scope.newStreamData.sendVcf=res.data.sendVcf+"",$scope.newStreamData.purposeisRequired=enterpriseLicenseType,res.data&&res.data.iconName?$scope.newStreamData.icon={fileName:res.data.iconName}:$scope.newStreamData.icon={fileName:"StreamIcon.png"},res.data.bBanner&&($scope.newStreamData.bBanner={fileName:"Big Banner.png"}),res.data.sBanner&&($scope.newStreamData.sBanner={fileName:"Small Banner.png"}),$scope.newStreamData.bBannerColor=res.data.bBannerColor,$scope.newStreamData.sBannerColor=res.data.sBannerColor,$scope.newStreamData.keywords=res.data&&res.data.keywords&&res.data.keywords.length>0?res.data.keywords.join(","):null,$scope.newStreamData.bbannerchoice=res.data.bBanner?"image":"color",$scope.newStreamData.sbannerchoice=res.data.sBanner?"image":"color",$scope.newStreamData.isNLEnabled=res.data.isNLEnabled?"yes":"no",$scope.commandCtx.streamId=$workflowService.selectedStream()._id,$scope.streamGeneralForm&&$scope.streamGeneralForm.$setPristine(),$scope.callback.loadingGeneralSettings=!1)})})},$scope.callback.saveSuccess=!1,$scope.$watch("callback.saveSuccess",function(newVal,oldVal){$timeout(function(){$scope.callback.saveSuccess=!1},1e3)});new Clipboard('[data-clipboard-target="#bot_id"]');$scope.callback.saveInprogress=!1,$scope.validateTeamShare=function(){if($scope.myTeams){var selectedTeamCount=0;return $scope.myTeams.forEach(function(team){team.selected&&selectedTeamCount++}),selectedTeamCount>0?!0:!1}return!1},$scope.callback.formInvalid=!1,$scope.callback.createStream=function(event,languageSettings){var errors;if(event&&event.preventDefault&&event.preventDefault(),!languageSettings&&!$scope.isFormValid($scope.streamGeneralForm))return form_util.touch($scope.streamGeneralForm),void($scope.callback.formInvalid=!0);if(!$scope.newStreamData.icon)return void($scope.iconRequiredError=!0);if("universalbot"!==$scope.newStreamData.type||!$scope.universalBotPurposeError){$scope.callback.formInvalid=!1;var btPostData={},botName=$scope.newStreamData.name;$scope.newStreamData.name&&(botName=$scope.newStreamData.name.trim().replace(/\s\s+/g," ")),$scope.newStreamData.name=botName,btPostData.name=botName,btPostData.type=$workflowService.streamType()||"taskbot",btPostData.description=$scope.newStreamData.description,btPostData.color=$scope.newStreamData.color,btPostData.categoryIds=$scope.newStreamData.categoryIds,btPostData.websiteUrl=$scope.newStreamData.websiteUrl,btPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,btPostData.botDocLink=$scope.newStreamData.botDocLink,btPostData.hasTenant=$scope.newStreamData.hasTenant,btPostData.offKoraConfirmation=$scope.newStreamData.offKoraConfirmation,btPostData.synonyms=$scope.newStreamData.synonyms,btPostData.skipMakeEditLinks=$scope.newStreamData.skipMakeEditLinks||!1,$scope.checkInheritance()&&$scope.newStreamData.sbStreamId&&(btPostData.inheritanceType=$scope.newStreamData.inheritanceType),_.addProps(!0,btPostData,{purpose:$scope.newStreamData.purpose}),btPostData.hasTenant&&(btPostData.tenancy={},btPostData.tenancy.helpHint=$scope.newStreamData.helpHint,btPostData.baseUrl=$scope.newStreamData.defaultUrl),errors=angular.copy($scope.newStreamData.errorCodes),errors&&errors instanceof Array&&(errors=errors.map(function(obj){return delete obj.insert,obj})),errors=_.union(errors,$scope.newStreamData.pollError),errors=_.uniq(errors,function(error){return+error.statusCode}),btPostData.errorCodes={pollError:errors},btPostData.visibility={namespace:[],namespaceIds:[]},$scope.newStreamData.sharing&&$scope.newStreamData.sharing.enterprise&&btPostData.visibility.namespace.push("enterprise"),$scope.newStreamData.sharing&&$scope.newStreamData.sharing.team&&(btPostData.visibility.namespace.push("team"),btPostData.visibility.namespaceIds=[],$scope.myTeams&&$scope.myTeams.forEach(function(team){team.selected&&btPostData.visibility.namespaceIds.push(team.id)})),languageSettings&&(btPostData.languagePreferences=languageSettings),createBTStream(btPostData)}},$scope.uploadStreamIcon=function(){if($scope.newStreamData.iconFile.name){var _ext=$scope.newStreamData.iconFile.name.substring($scope.newStreamData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.iconFile.name,fileId:response.data.fileId};$scope.newStreamData.icon=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.iconUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.iconUploading=!1})},$scope.deleteStreamIcon=function(){$scope.newStreamData.iconFile=null,$scope.newStreamData.icon=null,$("#iconFile").val("")},$scope.dissableInheritance=function(){function disable(){BTStreamsService.removeBotInheritance($workflowService.selectedStream()._id).then(function(response){$workflowService.selectedStream(response.data),$scope.currentStream=response.data,$scope.newStreamData.allowInheritance=response.data.allowInheritance,NotificationService.notify(i18n.i18nString("remove_inherit"),"success")},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})}function cancle(){}NotificationService.userConfirm(i18n.i18nString("disable_inherit_update"),[disable,cancle],{okText:i18n.i18nString("confirm"),btnClass:"redBtn"},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.uploadLargeStreamBanner=function(){if($scope.newStreamData.bigBannerFile.name){var _ext=$scope.newStreamData.bigBannerFile.name.substring($scope.newStreamData.bigBannerFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bBfileExtensionError=!0)}$scope.bBfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.bigBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.bigBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.bigBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.bBanner=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.bigBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.bigBannerUploading=!1})},$scope.deleteStreamBBanner=function(){$scope.newStreamData.bigBannerFile=null,$scope.newStreamData.bBanner=null,$("#bigBannerFile").val("")},$scope.uploadSmallStreamBanner=function(){if($scope.newStreamData.smBannerFile.name){var _ext=$scope.newStreamData.smBannerFile.name.substring($scope.newStreamData.smBannerFile.name.lastIndexOf("."));if(".png"!==_ext&&".PNG"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bSfileExtensionError=!0)}$scope.bSfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.smBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.smBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.smBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.sBanner=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.smBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.smBannerUploading=!1})},$scope.showModal=function(){$scope.stream.enableNameSpace?$("#enableNamespaceDialog").modal("show"):$("#disableNamespaceDialog").modal("show")},$scope.toggleNamespace=function(){$("#disableNamespaceDialog").modal("hide"),$("#enableNamespaceDialog").modal("hide");var payload={enableNameSpace:$scope.stream.enableNameSpace};BTStreamsService.enableNamespace($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload).then(function(res){$workflowService.selectedStream().enableNameSpace=res.data.enableNameSpace;res.data.enableNameSpace?NotificationService.notify(i18n.i18nString("ena_var_name_succ"),"success"):NotificationService.notify(i18n.i18nString("dis_var_name_err"),"success")},function(err){showErrorMessage(err)||NotificationService.notify(i18n.i18nString("dis_var_name_err_mess"),"error")})},$scope.callback.loadGeneralSettings(),$scope.deleteStreamSBanner=function(){$scope.newStreamData.smBannerFile=null,$scope.newStreamData.sBanner=null,$("#smBannerFile").val("")},$scope.onStreamFormCancel=function(){"edit"===$scope.displayMode?$location.path(window.appConfig.CONTEXT_PATH):($scope.newStreamData={},$scope.onCancel())},$scope.decodeJS=function(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}},$scope.editResponse=function(index){$scope.welcomeMessagecb.loadMessage($scope.welcomeMessages,index),$(".welcomeMessageModal").modal("show")},$scope.welcomeMessagecb.updateWelcomeMessages=function(res){$scope.welcomeMessages=res},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.clearTenancy=function(){$scope.newStreamData.defaultUrl="",$scope.newStreamData.helpHint=""},$scope.goBack=function(){$scope.onBack()},$scope.clearTeams=function(){$scope.myTeams.map(function(team){team.selected=!1})},$scope.purposeChanged=function(){
"universalbot"===$scope.newStreamData.type&&("employee"===$scope.newStreamData.purpose&&employeeBots&&employeeBots.length<2?($scope.universalBotPurposeError=!0,$scope.universalBotPurposeErrorMessage=i18n.i18nString("universal_employee")):"customer"===$scope.newStreamData.purpose&&customerBots&&customerBots.length<2?($scope.universalBotPurposeError=!0,$scope.universalBotPurposeErrorMessage=i18n.i18nString("universal_customer")):$scope.universalBotPurposeError=!1)};$scope.isFormValid=function(form){return!(form.$invalid||$scope.newStreamData.sharing&&$scope.newStreamData.sharing.team&&!$scope.validateTeamShare())},$scope.$on("savelanguageSettings",$scope.callback.createStream);var generalSettingsloadevent=$rootScope.$on("loadGeneralSettings",$scope.callback.loadGeneralSettings);$scope.$on("$destroy",function(){generalSettingsloadevent&&generalSettingsloadevent()}),$scope.$on("evt:exitAct",function(evt,data){$scope.streamForm.$valid?$scope.callback.createStream(!0):NotificationService.notify(i18n.i18nString("enter_valid_data"),"error")}),$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$scope.showAdvancedOptions=function(){$scope.showadvancedoptions?($scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$("#advancedoptdivStream .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showadvancedoptions=!0,$scope.advancedoptiontext=i18n.i18nString("hide_advanced_options"),$("#advancedoptdivStream .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"))},$scope.ivrBridge={},$scope.editIVR=!1,$scope.editIVRSettings=function(){$scope.stream=$workflowService.selectedStream(),$scope.ivrOptions=$scope.stream.welcomeIvrOptions,$scope.editIVR=!0,$scope.openModalSlider("#IVRSettingsSlider")},$scope.closeIVRSettings=function(){$scope.editIVR=!1,$scope.closeModalSlider("#IVRSettingsSlider")},$scope.saveIVRSettings=function(vxmlflag,label){$scope.stream=$workflowService.selectedStream();var payload={welcomeIvrOptions:$scope.ivrBridge.getIVROptions()};BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("ivrsettings_label",{dyn:label}),"success"),$workflowService.selectedStream(angular.extend($scope.stream,res.data)),res.data&&($scope.ivrBridge.ivrOptions=res.data.welcomeIvrOptions.advance.properties,$scope.vxmlGlobalCopyKeys=_.pluck($scope.stream.ivrSettings.properties||[],"name"),$scope.vxmlNodeKeys=_.pluck(res.data.welcomeIvrOptions.advance.properties||[],"name"),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys)),$scope.cb.updateVxmlGlobalKeys($scope.vxmlGlobalKeys)),setTimeout(function(){vxmlflag&&$scope.closeIVRSettings()},500)},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.validateBotName=function(){var regexpObject=patternFactory.getRegularExpression("stream"),regexp=regexpObject.regexp,regexp2=regexpObject.regexp2;return{test:function(value){return value&&1===value.length?regexp2.test(value):regexp.test(value)}}}(),$scope.validateYoutubeURL=function(){return{test:function(uri){var p=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return uri.match(p)?!0:!1}}}(),$scope.closeNodeVxmlProp=function(){$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""}};var vxmlflag=!1;$scope.addProperty=function(vprop){$scope.ivrBridge.ivrOptions=$scope.ivrBridge.getIVROptions(),$scope.ivrBridge.ivrOptions.advance.properties.push(vprop),$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""},$scope.saveIVRSettings(vxmlflag,"saved")},$scope.cb.call=function(label){$scope.saveIVRSettings(vxmlflag,label)},setTimeout(function(){"ar"===$scope.selectedLanguage&&($(".limitSet").removeClass("charactersLimit"),$(".limitSet").addClass("charactersLimitForArabric"))},1e3),$scope.$emit("nestedComponentLoaded",{id:"generalSettings",flag:!1})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("botSessionFlow",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/bot-session-flow.html",controller:"botSessionFlowController"}}),_module.controller("botSessionFlowController",["$scope","$workflowService","BTStreamsService","$applicationService","$timeout","$element","env_conf","$interval","$rootScope","$q","i18n",function($scope,$workflowService,BTStreamsService,$applicationService,$timeout,$element,env_conf,$interval,$rootScope,$q,i18n){function getCustomMetaTags(){BTStreamsService.metaTags($scope.stream._id,$scope.startDate,$scope.endDate).then(function(response){filterComponent.tags=response.data.tags,filterCompTemp.tags=response.data.tags,$scope.customTagsArray=response.data.tags,_.forEach($scope.customTagsArray,function(value){value.selectedValues=value.values})},function(error){})}function findParentDropOff(parentId,dataUnmod){for(var i=0;i<dataUnmod.length;i++)if(dataUnmod[i].id===parentId)return dataUnmod[i].exit;for(i=0;i<dataUnmod.length;i++)if(dataUnmod[i].values){var exitVal=findParentDropOff(parentId,dataUnmod[i].values);if(!isNaN(exitVal))return exitVal}}function findParentCount(parentId,dataUnmod){for(var i=0;i<dataUnmod.length;i++)if(dataUnmod[i].id===parentId)return dataUnmod[i].count;for(i=0;i<dataUnmod.length;i++)if(dataUnmod[i].values){var countVal=findParentCount(parentId,dataUnmod[i].values);if(!isNaN(countVal))return countVal}}function calculateData(sessionData,flag){var dropOffsHist=0;sessionData[0].parentId&&(dropOffsHist=findParentDropOff(sessionData[0].parentId,dataUnmodified.values));var currentNodeTotalInput=0;return"all"===flag?allNodes.forEach(function(val){currentNodeTotalInput+=val.count}):sessionData.forEach(function(val){currentNodeTotalInput+=val.count}),sessionData=sessionData.map(function(v){var o=Object.assign({},v);return o.totalInp=v.count/(currentNodeTotalInput+dropOffsHist)*100,o.totalInp=Math.round(o.totalInp),0===o.totalInp&&(o.totalInp=1),o.dropout=v.exit/v.count*100,o.totalNodesCount=totalNodesCount,isNaN(o.dropout)?o.dropout=0:o.dropout=Math.round(o.dropout),o})}function getDefaultFilter(days,str){$scope.defaultFilterMsg=i18n.i18nString("last_24_hours"),$scope.defaultFilterMsgTooltip=moment().subtract(1,"d").format("MM-DD-YYYY")+i18n.i18nString("to_label_spaced")+moment(filterComponent.endDate).format("MM-DD-YYYY")}function xssAttack(txtStr){var textHasXSS;return txtStr&&(textHasXSS=txtStr.isNotAllowedHTMLTags()),textHasXSS&&!textHasXSS.isValid&&(txtStr=txtStr.escapeHTML()),txtStr}function calculateUttData(utterances){var sum=0;utterances.forEach(function(val){sum=val.count+sum});for(var i=0;i<utterances.length;i++)utterances[i].prePercentage=utterances[i].count/sum*100}function putRootSessFlow(payload){function rootSessionFlow(){var deferred=$q.defer(),mode="async";return BTStreamsService.postRootSessionFlow($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.isConver.conversation?"timeline":"conversation",payload,mode).then(function(res){$scope.regroupDone.message=!1,deferred.resolve(res)},function(err){deferred.reject(err)}),deferred.promise}disableDbClick||(disableDbClick=!0,reloadDockStatus=!0,setTimeout(function(){disableDbClick=!1},500),$scope.sessionFlowLoading=!0,rootSessionFlow().then(function(res){$scope.checkDockStatus()},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),$scope.sessionFlowLoading=!1,otherNodesClickCount=0,$scope.isSessionFlowAvail=!1,$scope.isRequesting=!1}))}function asyncPutRootSessFlow(res){if($scope.sessionFlowLoading=!1,otherNodesClickCount=0,res.data&&0===res.data.length||res.data.nodes&&0===res.data.nodes.length)$scope.isSessionFlowAvail=!1;else{var changeOrder=function(){for(var tempId="",index=0,utteranceCompressed=[],i=0;i<data.values.length;i++){tempId=data.values[i].originalId,updatedUtterances[index]=[];for(var j=0;j<data.utterances.length;j++)data.utterances[j].nodeId===tempId&&(updatedUtterances[index].push(data.utterances[j]),data.values[i]&&data.values[i].type&&(updatedUtterances[index][updatedUtterances[index].length-1].type=data.values[i].type),data.values[i]&&data.values[i].nodeIds&&(updatedUtterances[index][updatedUtterances[index].length-1].nodeIds=data.values[i].nodeIds),updatedUtterances[index][updatedUtterances[index].length-1].grouped=!0,data.utterances[j].addedToNodes=!0);index++}for(i=0;i<updatedUtterances.length;i++){var othersList=updatedUtterances[i].filter(function(val){return"Others"==val.utteranceId}),nonOthersList=updatedUtterances[i].filter(function(val){return"Others"!=val.utteranceId});updatedUtterances[i]=nonOthersList.concat(othersList)}for(updatedUtterances[updatedUtterances.length]=[],data.utterances.forEach(function(val){val.addedToNodes||(updatedUtterances[updatedUtterances.length-1].push(val),val.addedToOthers=!0)}),updatedUtterances=updatedUtterances.filter(function(val){return val.length}),i=0;i<updatedUtterances.length;i++)utteranceCompressed[i]=updatedUtterances[i][0];data.utterances=utteranceCompressed},reorderNodes=function(){for(var faqIndex=-1,notHandledIndex=-1,smalltalkIndex=-1,temp=null,i=0;i<data.values.length;i++)"faq"===data.values[i].type?faqIndex=i:"nothandled"===data.values[i].type?notHandledIndex=i:"smalltalk"===data.values[i].type&&(smalltalkIndex=i);var startSwapping=function(){var pos=constantsList.conversationFlow.nodesToDisplay-2;-1!==faqIndex&&(temp=data.values[pos],data.values[pos]=data.values[faqIndex],data.values[faqIndex]=temp,pos--),-1!==notHandledIndex&&(temp=data.values[pos],data.values[pos]=data.values[notHandledIndex],data.values[notHandledIndex]=temp,pos--),-1!==smalltalkIndex&&(temp=data.values[pos],data.values[pos]=data.values[smalltalkIndex],data.values[smalltalkIndex]=temp,pos--)};startSwapping()};res.data.nodes.forEach(function(val){val.name||(val.name=""),val.originalId=val.id});var updatedUtterances=[],nodesList=[];allNodes=angular.copy(res.data.nodes),data={name:$scope.isConver.conversation?"Sessions":"Users",nodeId:"0",values:angular.copy(res.data.nodes)},res.data.utterances&&res.data.utterances.length&&(res.data.utterances.forEach(function(val){"Cluster 0"===val.utterance&&(val.utterance="Others")}),data.utterances=angular.copy(res.data.utterances));for(var m=0;m<data.values.length;m++)data.values[m].level=0,data.values[m].id=data.values[m].originalId+"level0order"+m;for(var j=0;j<allNodes.length;j++)allNodes[j].level=0,allNodes[j].id=allNodes[j].originalId+"level0order"+j;if(data.utterances&&0!==data.utterances.length){for(var k=0;k<allNodes.length;k++)for(var l=0;l<data.utterances.length;l++)if(data.utterances[l].nodeId===allNodes[k].originalId){data.utterances[l].morphedNodeId=allNodes[k].id;break}calculateUttData(data.utterances)}totalNodesCount=0;for(var i=0;i<res.data.nodes.length;i++)totalNodesCount+=res.data.nodes[i].count;data.values=calculateData(data.values,"all"),data.values=data.values.sort(function(a,b){return Number(a.totalInp)<Number(b.totalInp)?-1:Number(a.totalInp)>Number(b.totalInp)?1:0}).reverse(),res.data.nodes.length>constantsList.conversationFlow.nodesToDisplay&&(reorderNodes(),nodesList=data.values.slice(0,constantsList.conversationFlow.nodesToDisplay-1),data.values=angular.copy(nodesList)),data.utterances&&data.utterances.length&&(changeOrder(),data.updatedUtterances=angular.copy(updatedUtterances));var changeOrderLastClusters=function(lastClusters){for(var tempId="",lastUtterancesUpdated=[],i=0;i<res.data.nodes.length;i++){tempId=res.data.nodes[i].originalId;for(var j=0;j<lastClusters.length;j++)lastClusters[j].nodeId===tempId&&(lastUtterancesUpdated.push(lastClusters[j]),res.data.nodes[i]&&res.data.nodes[i].type&&(lastUtterancesUpdated[lastUtterancesUpdated.length-1].type=res.data.nodes[i].type),res.data.nodes[i]&&res.data.nodes[i].nodeIds&&(lastUtterancesUpdated[lastUtterancesUpdated.length-1].nodeIds=res.data.nodes[i].nodeIds),lastUtterancesUpdated[lastUtterancesUpdated.length-1].grouped=!0,lastClusters[j].addedToOthers=!0)}for(i=0;i<lastUtterancesUpdated.length;i++){var othersList=lastUtterancesUpdated.filter(function(val){return"Others"==val.utteranceId}),nonOthersList=lastUtterancesUpdated.filter(function(val){return"Others"!=val.utteranceId});lastUtterancesUpdated=nonOthersList.concat(othersList)}return data.utterances[data.utterances.length-1]=lastUtterancesUpdated[0],lastUtterancesUpdated};if(res.data.nodes.length>constantsList.conversationFlow.nodesToDisplay){var lastClusters=updatedUtterances.pop();lastClusters=changeOrderLastClusters(lastClusters),updatedUtterances.push(lastClusters),data.updatedUtterances=angular.copy(updatedUtterances)}var othersCount=allNodes.length-(constantsList.conversationFlow.nodesToDisplay+1),prePercentageOthers=0,countOthers=0,exitOthers=0;for(i=constantsList.conversationFlow.nodesToDisplay-1;i<allNodes.length;i++)prePercentageOthers+=allNodes[i].count/totalNodesCount*100,countOthers+=allNodes[i].count,exitOthers+=allNodes[i].exit;var totalLastUtterance=updatedUtterances[updatedUtterances.length-1].reduce(function(sum,item){return sum+item.count},0);console.log(totalLastUtterance,Math.round(totalLastUtterance/totalNodesCount*100)),res.data.nodes.length>constantsList.conversationFlow.nodesToDisplay&&data.values.push({count:countOthers,exit:exitOthers,id:"others-0",name:othersCount+"+ Intents",nodeId:"nodeId-0",originalId:"others-original-0",taskId:"taskId-re",type:"others",totalInp:Math.round(totalLastUtterance/totalNodesCount*100)}),dataUnmodified=angular.copy(data),dataUnmodified.origUtterances=angular.copy(res.data.utterances);JSON.stringify(data);initialize(),$scope.isSessionFlowAvail=!0,setTimeout(function(){PerfectScrollbar.update($("#viz_container")[0])},750)}$scope.isRequesting=!1}function isEven(n){return n=Number(n),0===n||!(!n||n%2)}function loadData(flag){if(flag){JSON.stringify(dataUnmodified);initialize(flag,dataClickedNode.id,data.values)}else{var tempPload=createPostPayload($scope.startDate,$scope.endDate,$scope.filterSession.selectedChannels,$scope.filterSession.selectedLanguages,$scope.filterSession.selectedSession,$scope.selectedTagsArray);putRootSessFlow(tempPload)}}function getListOfUtterances(utterancesList){$scope.modalSlider.open("#sessionFlowUtterance"),$element.find(".modalBody").scrollTop(0),$scope.utteranceGroups=utterancesList,$scope.gps.groupsShow=!0,$scope.gps.utterancesShow=!1,$scope.backArrow.utterances=!0}function getOutgoingNodeUtterances(id,offset,limit,hashId){var deferred=$q.defer(),utterancesPayload=createUtterancesPayload(id,offset,limit);return hashId&&(utterancesPayload.hashId=hashId),$scope.modalSlider.open("#sessionFlowUtterance"),$element.find(".modalBody").scrollTop(0),$scope.gps.utterancesShow=!0,$scope.stateLoad.utterances=!0,getOutgoingNodeTotalUtterancesCount(id,offset,limit,hashId),BTStreamsService.uttSessionOutgo($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,utterancesPayload).then(function(res){$scope.utterances=angular.copy(res.data),$scope.modalSlider.open("#sessionFlowUtterance"),$element.find(".modalBody").scrollTop(0),$scope.sFlow.text="",$scope.stateLoad.utterances=!1,$(".sessionFlowSearch").removeClass("searchExpand"),$(".searchBarUtt").removeClass("fa-remove").addClass("fa-search"),exportTypeOutgoing=!0,$scope.gps.utterancesShow=!0,deferred.resolve(res)},function(err){NotificationService.notify(i18n.i18nString("not_able_to_fetch_utterances"),"error"),$scope.stateLoad.utterances=!1,deferred.reject(err)}),deferred.promise}function getOutgoingNodeTotalUtterancesCount(id,offset,limit,hashId){var utterancesPayload=createUtterancesPayload(id,offset,limit);hashId&&(utterancesPayload.hashId=hashId),BTStreamsService.totalUtteranceCount($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,utterancesPayload).then(function(res){$scope.utterancesCount=res.data.total||0},function(err){NotificationService.notify(i18n.i18nString("some_error"),"error"),$scope.utterancesCount=0})}function createUtterancesPayload(id,offset,limit){return{start_date:$scope.startDate,end_date:$scope.endDate,id:id,offset:offset,limit:limit,lang:$scope.filterSession.selectedLanguages,channels:$scope.filterSession.selectedChannels,sessions:$scope.filterSession.selectedSession}}function getNodeUtterances(id,offset,limit,uttHashId){var deferred=$q.defer(),channels=$scope.filterSession.selectedChannels;$scope.channels.length===$scope.filterSession.selectedChannels.length&&(channels="");var utterancesPayload=createUtterancesPayload(id,offset,limit);return uttHashId&&(utterancesPayload.hashId=uttHashId),$scope.stateLoad.utterances=!0,$scope.modalSlider.open("#sessionFlowUtterance"),$element.find(".modalBody").scrollTop(0),BTStreamsService.utterancesSessionFlow($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,utterancesPayload).then(function(res){$scope.utterances=angular.copy(res.data),$scope.stateLoad.utterances=!1,$scope.modalSlider.open("#sessionFlowUtterance"),$element.find(".modalBody").scrollTop(0),$scope.sFlow.text="",$(".sessionFlowSearch").removeClass("searchExpand"),$(".searchBarUtt").removeClass("fa-remove").addClass("fa-search"),deferred.resolve(res)},function(err){NotificationService.notify(i18n.i18nString("unable_to_fetch_utterances"),"error"),$scope.stateLoad.utterances=!1,deferred.reject(err)}),deferred.promise}function getDropoffs(parent){var deferred=$q.defer(),payload={start_date:$scope.startDate,end_date:$scope.endDate,nodeIds:parent,lang:$scope.filterSession.selectedLanguages,channels:$scope.filterSession.selectedChannels,sessions:$scope.filterSession.selectedSession};return BTStreamsService.dropOffs($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,payload).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}),deferred.promise}function openUttModal(e,utterancesData){function scrollUtterances(e){if($(this).scrollTop()+$(this).innerHeight()>=.95*$(this)[0].scrollHeight&&$scope.utterancesCount){$("uttNodeList").off("scroll");var utterancesPayload={};if(utterancesData.hasOwnProperty("utterance")&&utterancesData.hasOwnProperty("utteranceId"))utterancesPayload=createUtterancesPayload(utterancesData.nodeId,200*countUttScroll,200);else{if(!utterancesData.hasOwnProperty("nodeIds"))return void($scope.cond.isMoreAvailable=!1);utterancesPayload=createUtterancesPayload(utterancesData.nodeIds,200*countUttScroll,200)}if($scope.utterancesCount<200*countUttScroll)return void($scope.cond.isMoreAvailable=!1);countUttScroll++,BTStreamsService.uttSessionOutgo($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,utterancesPayload).then(function(res){$("#uttNodeList").on("scroll",scrollUtterances),res.data.result&&res.data.result.length&&($scope.utterances.result=$scope.utterances.result.concat(res.data.result))},function(err){NotificationService.notify(i18n.i18nString("not_able_to_fetch_utterances"),"error")})}}function attachListeners(){document.getElementById("uttNodeList")&&(document.getElementById("uttNodeList").scrollTop=0),$("#uttNodeList").on("scroll",scrollUtterances),attachSearchUtterance()}return e.stopPropagation(),$("#uttNodeList").off("scroll"),idForUtt=utterancesData.nodeIds,"intent"==utterancesData.type&&utterancesData.grouped?($scope.utteranceHead=utterancesData.utterance,void(utterancesData.nodeId!=utterancesData.hashId?getOutgoingNodeUtterances(utterancesData.nodeIds,0,200,utterancesData.hashId).then(function(res){setTimeout(function(){attachListeners()},1e3)},function(err){console.log("Not able to fetch utterances")}):getOutgoingNodeUtterances(utterancesData.nodeIds,0,200,null).then(function(res){setTimeout(function(){attachListeners()},1e3)},function(err){console.log("Not able to fetch utterances")}))):"intent"!=utterancesData.type&&utterancesData.grouped?($scope.utteranceHead=utterancesData.utterance,$scope.gps.utterancesShow=!0,void(utterancesData.nodeId!=utterancesData.hashId?getNodeUtterances(utterancesData.nodeIds,0,200,utterancesData.hashId).then(function(res){setTimeout(function(){attachListeners()},1e3)},function(err){console.log("Not able to fetch utterances")}):getNodeUtterances(utterancesData.nodeIds,0,200,null).then(function(res){setTimeout(function(){attachListeners()},1e3)},function(err){console.log("Not able to fetch utterances")}))):utterancesData.type&&"intent"==utterancesData.type?($scope.utteranceHead=utterancesData.name,void getOutgoingNodeUtterances(utterancesData.nodeIds,0,200,null).then(function(res){setTimeout(function(){attachListeners()},1e3)},function(err){console.log("Not able to fetch utterances")})):utterancesData.type&&"intent"!=utterancesData.type?($scope.utteranceHead=utterancesData.name,$scope.gps.utterancesShow=!0,$scope.gps.groupsShow=!1,$scope.utteranceHead=utterancesData.utterance||utterancesData.name,void getNodeUtterances(utterancesData.nodeIds,0,200).then(function(res){setTimeout(function(){attachListeners()},1e3)},function(err){console.log("Not able to fetch utterances")})):utterancesData.clubbedGroups?void getListOfUtterances(utterancesData.slice(2)):void 0}function attachSearchUtterance(){$(".searchBarUtt").off("click"),$(".searchBarUtt").click(function(){$(this).hasClass("fa-remove")?($(".sessionFlowSearch").removeClass("searchExpand"),$(this).removeClass("fa-remove"),$(this).addClass("fa-search"),$scope.sFlow.text=""):($(".sessionFlowSearch").addClass("searchExpand"),$(this).addClass("fa-remove"),$(this).removeClass("fa-search"),$timeout(function(){$(".sessionFSearchInput").focus()},350))})}function moreNodesReq(){var availableIds=[];dataUnmodified.values.pop();for(var i=0;i<dataUnmodified.values.length;i++)availableIds.push(dataUnmodified.values[i].id);var unavailableNodes=allNodes.filter(function(val){return-1==availableIds.indexOf(val.id)});for(unavailableNodes=calculateData(unavailableNodes,"all"),i=0;i<unavailableNodes.length;i++)dataUnmodified.values.push(unavailableNodes[i]);dataUnmodified.values=dataUnmodified.values.sort(function(a,b){return Number(a.totalInp)<Number(b.totalInp)?-1:Number(a.totalInp)>Number(b.totalInp)?1:0}).reverse();var updatedUtterances=[],changeOrder=function(){var tempId="",index=0,utteranceCompressed=[];for(i=0;i<dataUnmodified.values.length;i++){tempId=dataUnmodified.values[i].originalId,updatedUtterances[index]=[];for(var j=0;j<dataUnmodified.origUtterances.length;j++)dataUnmodified.origUtterances[j].nodeId===tempId&&(updatedUtterances[index].push(dataUnmodified.origUtterances[j]),dataUnmodified.values[i]&&dataUnmodified.values[i].type&&(updatedUtterances[index][updatedUtterances[index].length-1].type=dataUnmodified.values[i].type),dataUnmodified.values[i]&&dataUnmodified.values[i].nodeIds&&(updatedUtterances[index][updatedUtterances[index].length-1].nodeIds=dataUnmodified.values[i].nodeIds),dataUnmodified.origUtterances[j].grouped=!0,dataUnmodified.origUtterances[j].addedToNodes=!0);index++}for(i=0;i<updatedUtterances.length;i++){var othersList=updatedUtterances[i].filter(function(val){return"Others"==val.utteranceId}),nonOthersList=updatedUtterances[i].filter(function(val){return"Others"!=val.utteranceId});updatedUtterances[i]=nonOthersList.concat(othersList)}for(updatedUtterances[updatedUtterances.length]=[],dataUnmodified.origUtterances.forEach(function(val){val.addedToNodes||(updatedUtterances[updatedUtterances.length-1].push(val),val.addedToOthers=!0)}),updatedUtterances=updatedUtterances.filter(function(val){return val.length}),i=0;i<updatedUtterances.length;i++)utteranceCompressed[i]=updatedUtterances[i][0];dataUnmodified.utterances=utteranceCompressed,dataUnmodified.updatedUtterances=angular.copy(updatedUtterances)};if(dataUnmodified.origUtterances&&0!==dataUnmodified.origUtterances.length){for(var k=0;k<allNodes.length;k++)for(var l=0;l<dataUnmodified.origUtterances.length;l++)if(dataUnmodified.origUtterances[l].nodeId===allNodes[k].originalId){dataUnmodified.origUtterances[l].morphedNodeId=allNodes[k].id;break}calculateUttData(dataUnmodified.origUtterances)}changeOrder(),initialize(!0)}function initialize(flag,dataClickId,dataVals){flag?data=angular.copy(dataUnmodified):(viz=vizuly.viz.weighted_tree(document.getElementById("viz_container"),{agentTransfer:agentSessionIcon,transition:transitionTypeIcon,triangle:triangleIcon,arrow:arrowIcon}),theme=vizuly.theme.weighted_tree(viz).skin("None"),attachSearchUtterance()),viz.data(data).width(600).height(600).children(function(d){return d.values}).key(function(d){return d.data.id}).fixedSpan(250).branchPadding(.12).label(function(d){return"smalltalk"===d.data.name.toLowerCase()?i18n.i18nString("small_talk"):"nothandled"===d.data.name.toLowerCase()?i18n.i18nString("not_handled"):trimLabel(d.data.name)}).on("mouseover",onMouseOver).on("mouseout",onMouseLeave).on("click",onClick),changeSize(d3.select("#currentDisplay").attr("item_value"),dataClickId,dataVals)}function trimLabel(label){return String(label).length>18?String(label).substr(0,16)+"..":label}function createEndOfDialogTooltip(x,y,endOfDialogData,payload,endOfSessions){var eodTooltip='<div class="textAlignCenter" style="width: 140px; background-opacity:.5; left: -15px"><i class="fa fa-spinner fa-spin"></i></div>';document.querySelector(".vz-weighted_tree-tip .tooltipViz")&&document.querySelector(".vz-weighted_tree-tip .tooltipViz").remove(),d3.select("div.bot-session-flow").append("div").attr("class","vz-weighted_tree-tip").style("position","absolute").style("top",y+"px").style("left",x+"px").style("opacity",0).html(eodTooltip).transition().style("opacity",1),getDropoffs(payload).then(function(data){var dropOffs=Math.round(endOfDialogData.data.exit/endOfDialogData.data.count*100),endOfSession=Math.round(data.endOfSessions/endOfDialogData.data.count*100);isNaN(dropOffs)&&(dropOffs=0),isNaN(endOfSession)&&(endOfSession=0);var ttViz=document.querySelector(".vz-weighted_tree-tip .tooltipViz");ttViz&&ttViz.remove(),endOfDialogData.data.exit===data.endOfSessions?(eodTooltip=eodTooltip.replace("textAlignCenter","tooltipViz textAlignCenter"),eodTooltip=eodTooltip.replace('<i class="fa fa-spinner fa-spin"></i>','<div class="user-dropoff-tt"><div class="ttBox"><span class="ttHead">End of Task - </span><span>'+endOfSession+"%</span></div></div>")):(eodTooltip=eodTooltip.replace("textAlignCenter","tooltipViz textAlignCenter"),eodTooltip=eodTooltip.replace('<i class="fa fa-spinner fa-spin"></i>','<div class="user-dropoff-tt"><div class="ttBox"><span class="ttHead">User Drop-offs - </span><span>'+dropOffs+'%</span></div><div class="ttBox"><span class="ttHead">End of Task - </span><span>'+endOfSession+"%</span></div></div>")),d3.select("div.bot-session-flow").append("div").attr("class","vz-weighted_tree-tip").style("position","absolute").style("top",y+10+"px").style("left",x+"px").style("opacity",0).html(eodTooltip).transition().style("opacity",1),setTimeout(function(){$(".tooltipViz.textAlignCenter").mouseleave(function(){this.remove()})})},function(err){NotificationService.notify(i18n.i18nString("no_end_of_task_data_available"),"error")})}function createRootDataTip(x,y,totalConversations,rootFlag){null!==document.querySelector(".vz-weighted_tree-tip")&&(document.querySelector(".vz-weighted_tree-tip").remove(),null!==ttRemoveTime&&clearTimeout(ttRemoveTime)),null!==document.querySelector(".vz-session-path_tree-tip .tooltipVizSession")&&(document.querySelector(".vz-session-path_tree-tip .tooltipVizSession").remove(),null!==ttRemovePath&&clearTimeout(ttRemovePath));var totalConvDataTip="";rootFlag?(totalConvDataTip='<div class="tooltipViz rootNode" style="width: 175px; padding:10px; background-opacity:.5"><p class="totalConv">'+totalConversations+'<span class="conv"> Conversations</span></p></div>',y-=67,x-=2):null===rootFlag&&(totalConvDataTip='<div class="tooltipViz rootNode" style="width: 175px; background-opacity:.5"><p class="totalConv">'+totalConversations+"</p></div>",y-=65,x-=10),d3.select("div.bot-session-flow").append("div").attr("class","vz-weighted_tree-tip").style("position","absolute").style("top",y+10+"px").style("left",x-25+"px").style("opacity",0).html(totalConvDataTip).transition().style("opacity",1)}function createDataTip(x,y,tipData,targetEl,nodeAttr){var datatip='<div class="tooltipViz node-tooltip" style="background-opacity:.5"><div class="header4">'+i18n.i18nString("header_4")+' </div><div class="header1">'+i18n.i18nString("header_1")+'<span class="sub-text">'+i18n.i18nString("conversation")+'</span></div><div class="header3">'+i18n.i18nString("header_3")+' </div><div class="header5 cursor-pointer" node_name="customNodeName" para_id="customParaId">'+i18n.i18nString("see_responses")+'<img class="arrow-icon" src="'+arrowIcon+'"</div></div>',ttViz=document.querySelector(".vz-weighted_tree-tip .tooltipViz"),ttVizSession=document.querySelector(".vz-session-path_tree-tip .tooltipVizSession");null!==ttViz&&(ttViz.remove(),null!==ttRemoveTime&&(clearTimeout(ttRemoveTime),ttRemoveTime=null)),null!==ttVizSession&&(ttVizSession.remove(),null!==ttRemovePath&&clearTimeout(ttRemovePath));var parentCount=0;tipData.parentId?parentCount=findParentCount(tipData.parentId,dataUnmodified.values):tipData.totalNodesCount&&(parentCount=tipData.totalNodesCount);var html=datatip.replace(i18n.i18nString("header_1"),(tipData.count||0)+"/"+parentCount);html=html.replace(i18n.i18nString("header_3"),(tipData.exit||0)+"/"+(tipData.count||0)+'<span class="sub-text"> '+i18n.i18nString("drop_offs_label")+"</span>"),html=tipData.name.length>18?html.replace(i18n.i18nString("header_4"),tipData.name):html.replace(i18n.i18nString("header_4_lower"),"ng-hide"),"message"===nodeAttr.node_type||"intent"===nodeAttr.node_type||"faq"===nodeAttr.node_type||"smalltalk"===nodeAttr.node_type?html=html.replace(i18n.i18nString("header_5_lower"),"header5 ng-hide"):(html=html.replace(i18n.i18nString("custom_node_name"),nodeAttr.node_name),html=html.replace(i18n.i18nString("custom_para_id"),nodeAttr.para_id)),$(targetEl).hasClass("vz-weighted_tree-node-rect")&&(targetEl.setAttribute("stroke","#f8e71c"),targetEl.setAttribute("stroke-width","1.5")),"agentTransfer"===tipData.type?($(targetEl).siblings("rect").show(),$(targetEl).siblings("text").show(),$(targetEl).siblings("g.agent-node-caret-down").show(),y-=50,x+=15):(y-=70,x+=30),d3.select("div.bot-session-flow").append("div").attr("class","vz-weighted_tree-tip").style("position","absolute").style("top",y-100+"px").style("left",x+"px").style("opacity",0).html(html).transition().style("opacity",1).duration(500);try{document.querySelector(".vz-weighted_tree-tip .tooltipViz").addEventListener("mouseenter",function(e){null!==ttRemoveTime&&(clearTimeout(ttRemoveTime),ttRemoveTime=null)}),document.querySelector(".vz-weighted_tree-tip .tooltipViz").addEventListener("mouseleave",function(){this.remove()})}catch(e){console.log("Tooltip not available")}"message"!==nodeAttr.node_type&&document.querySelector(".header5").addEventListener("click",function(e){e.stopPropagation(),$scope.utteranceHead=tipData.name;idForUtt=tipData.nodeIds,getOutgoingNodeUtterances(tipData.nodeIds,0,200).then(function(res){setTimeout(function(){function scrollUtterances(e){if($(this).scrollTop()+$(this).innerHeight()>=.95*$(this)[0].scrollHeight&&$scope.cond.isMoreAvailable){countUttScroll++;var utterancesPayload=createUtterancesPayload(idForUtt,200*countUttScroll,200);BTStreamsService.uttSessionOutgo($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,utterancesPayload).then(function(res){$scope.utterances.result&&0!==$scope.utterances.result.length?$scope.utterances.result=$scope.utterances.result.concat(angular.copy(res.data.result)):$scope.utterances.result=angular.copy(res.data.result),
$("#uttNodeList").off("scroll"),$("#uttNodeList").on("scroll",scrollUtterances)},function(err){NotificationService.notify(i18n.i18nString("unable_to_fetch_utterances"),"error")})}}document.getElementById("uttNodeList")&&(document.getElementById("uttNodeList").scrollTop=0),attachSearchUtterance(),$("#uttNodeList").off("scroll"),$("#uttNodeList").on("scroll",scrollUtterances)},1e3)},function(err){console.log("Unable to fetch utterances")})})}function onMouseOver(e,d,i){var ttVizSession=document.querySelector(".vz-session-path_tree-tip .tooltipVizSession"),x=this.clientX,y=this.clientY,rect=e.getBoundingClientRect(),isNotRootNode=!0;try{(!$scope.isConver.conversation&&"Users"===d.data.name||$scope.isConver.conversation&&"Sessions"===d.data.name&&"0"===d.data.nodeId)&&(isNotRootNode=!1)}catch(e){isNotRootNode=!0}if($(".user-dropoff-tt")&&$(".user-dropoff-tt").remove(),!(d&&d.data&&d.data.id&&0===d.data.id.indexOf("others-")||e.classList.contains(".vz-weighted_tree-node-post-percent-bg")||e.classList.contains(".post-percent-text"))){if(e.classList.contains("transparent-rect")&&0===$(".utterance-tooltip .tt-utterance").length&&d.utterance.length>16){var utteranceTooltip='<div class="tt-utterance"><p class="noMargin">'+d.utterance+"</p></div>";d3.select("div.bot-session-flow").append("div").attr("class","utterance-tooltip").style("position","absolute").style("top",e.getBoundingClientRect().y-70+"px").style("left",e.getBoundingClientRect().x+"px").style("opacity",0).html(utteranceTooltip).transition().style("opacity",1)}if(e.classList.contains("oval-small-path")){var bigC=".oval-path-"+this.target.getAttribute("targetNodeId"),textC=".circle-link-"+this.target.getAttribute("targetNodeId");this.target.style.display="none",$(bigC).show(),$(textC).show()}if(e.classList.contains("interrupt-path")||e.classList.contains("img-hold")){var interruptState="";switch(d.target.data.transitionType){case 1:interruptState=i18n.i18nString("current_task_is_interrupted");break;case 2:interruptState=i18n.i18nString("current_task_is_discarded");break;case 4:interruptState=i18n.i18nString("on_hold_task_is_resumed");break;default:interruptState=i18n.i18nString("task_is_interrupted")}var html='<div class="tooltipVizSession tt-interrupt-path" style="width: 175px; background-opacity:.5"><h5>Interruption</h5><p>'+interruptState+"</p></div>",ttInterrupt=document.querySelector(".vz-weighted_tree-tip .tt-interrupt-path");ttVizSession||ttInterrupt||d3.select("div.bot-session-flow").append("div").attr("class","vz-weighted_tree-tip").style("position","absolute").style("top",y-90+"px").style("left",x-125+"px").style("opacity",0).html(html).transition().style("opacity",1)}if((e.classList.contains("oval-path")||e.classList.contains("circle-link")||e.classList.contains("oval-small-path"))&&(ttCreationTime&&clearTimeout(ttCreationTime),ttCreationTime=setTimeout(function(){var htmlOval='<div class="tooltipVizSession" style="max-width: 210px; width: max-content" background-opacity:.5"><div class="header1 padding0">'+e.getAttribute("path-on-hover")+"</div></div>";ttVizSession||null===e.getAttribute("path-on-hover")||(clearTimeout(ttRemovePath),ttRemovePath=null,d3.select("div.bot-session-flow").append("div").attr("class","vz-session-path_tree-tip").style("position","absolute").style("top",y-130+"px").style("left",e.getBoundingClientRect().x-60+"px").html(htmlOval).transition().style("opacity",1))},500)),ttVizSession&&(ttVizSession.addEventListener("mouseenter",function(e){null!==ttRemovePath&&(clearTimeout(ttRemovePath),ttRemovePath=null)}),ttVizSession.addEventListener("mouseleave",function(){this.remove()})),!e.classList.contains("vz-weighted_tree-link")&&d!=data){if(d.target&&(d=d.target),!isNotRootNode&&d.children&&d.children.length){var tempSum=0;return d.children.forEach(function(val){tempSum+=val.data.count}),void createRootDataTip(rect.left,rect.top+.05*viz.height()-85,tempSum,!0)}if(isNotRootNode&&e.classList.contains("vz-weighted_tree-node-rect")){var ttInterr=document.querySelector(".vz-weighted_tree-tip .tt-interrupt-path");ttInterr&&ttInterr.remove();var nodeAttr={node_name:d.data.name,para_id:d.data.originalId,node_type:d.data.type};ttCreationTime&&clearTimeout(ttCreationTime),ttCreationTime=setTimeout(function(){createDataTip(rect.left-40,rect.top+.05*viz.height()-28,d.data,this.target,nodeAttr)},500)}}}}function onMouseLeave(e,d,i){if(ttCreationTime&&clearTimeout(ttCreationTime),null===ttRemoveTime?ttRemoveTime=setTimeout(function(){d3.selectAll(".vz-weighted_tree-tip").remove(),ttRemoveTime=null},400):(clearTimeout(ttRemoveTime),ttRemoveTime=null),null===ttRemovePath?ttRemovePath=setTimeout(function(){d3.selectAll(".vz-session-path_tree-tip").remove(),ttRemovePath=null},400):e.classList.contains("oval-path")||e.classList.contains("vz-weighted_tree-link")||(clearTimeout(ttRemovePath),ttRemovePath=null),$(".utterance-tooltip")&&$(".utterance-tooltip").remove(),$(".tooltipViz.rootNode")&&$(".tooltipViz.rootNode").remove(),e.classList.contains("oval-path")||e.classList.contains("circle-link")){var smallC=".oval-small-path-"+this.target.getAttribute("targetNodeId"),bigC=".oval-path-"+this.target.getAttribute("targetNodeId"),textC=".circle-link-"+this.target.getAttribute("targetNodeId");$(bigC).hide(),$(textC).hide(),$(smallC).show()}d.data&&d.data.type&&"agentTransfer"===d.data.type&&$(e).children("rect.agent-node-rec, text.agent-node-tex, g.agent-node-caret-down").hide()}function appendChildToNode(parentId,child,dataSession,level){for(var i=0;i<dataSession.length;i++)if(dataSession[i].id===parentId){dataClickedNode=dataSession[i];for(var j=0;j<child.length;j++)child[j].level=dataSession[i].level+1,child[j].id=child[j].originalId+"level"+child[j].level+"order"+globOrder,globOrder++;return dataSession[i].values=child,dataSession}for(i=0;i<dataSession.length;i++)if(dataSession[i].values){var tempData=appendChildToNode(parentId,child,dataSession[i].values,level++);if(tempData)return dataSession[i].values=tempData,dataSession}}function getSessionChildren(nodeData){var tempPload=createPostPayload($scope.startDate,$scope.endDate,$scope.filterSession.selectedChannels,$scope.filterSession.selectedLanguages,$scope.filterSession.selectedSession,$scope.selectedTagsArray,nodeData.originalID);tempPload.parent=nodeData.nodeIds,tempPload.parentId=nodeData.id,tempPload.level=nodeData.level,BTStreamsService.nodeSessionFlow($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.isConver.conversation?"timeline":"conversation",tempPload).then(function(res){var nodeClassName=".vz-id-"+nodeData.id.replace(/:/g,"-");if(res.data.nodes.forEach(function(val){val.originalId=val.id}),0!==res.data.nodes.length&&$(nodeClassName).length){var dataTemp=calculateData(res.data.nodes);dataTemp=dataTemp.sort(function(a,b){return Number(a.totalInp)<Number(b.totalInp)?-1:Number(a.totalInp)>Number(b.totalInp)?1:0}).reverse(),dataUnmodified.values=appendChildToNode(nodeData.id,dataTemp,dataUnmodified.values,1),loadData(!0),$("#"+nodeData.id.replace(/:/g,"-")).hide()}$("#viz_container").animate({scrollLeft:scrollLeftValue-200},800)},function(err){$("#"+nodeData.id.replace(/:/g,"-")).hide()})}function deleteNode(id,dataUn){for(var i=0;i<dataUn.length;i++)if(dataUn[i].id===id)return delete dataUn[i].values,dataUn[i];for(var j=0;j<dataUn.length;j++)if(dataUn[j].values&&null!==deleteNode(id,dataUn[j].values))return deleteNode(id,dataUn[j].values);return null}function removeAllTooltips(){var temp=null;temp=document.querySelector(".tooltipViz.rootNode")?document.querySelector(".tooltipViz.rootNode").remove():null,temp=document.querySelector(".utterance-tooltip")?document.querySelector(".utterance-tooltip").remove():null,temp=document.querySelector(".vz-weighted_tree-tip .tooltipViz")?document.querySelector(".vz-weighted_tree-tip .tooltipViz").remove():null,temp=document.querySelector(".vz-weighted_tree-tip")?document.querySelector(".vz-weighted_tree-tip").remove():null,temp=document.querySelector(".vz-session-path_tree-tip .tooltipVizSession")?document.querySelector(".vz-session-path_tree-tip .tooltipVizSession").remove():null,temp=document.querySelector(".vz-weighted_tree-tip .tt-interrupt-path")?document.querySelector(".vz-weighted_tree-tip .tt-interrupt-path").remove():null}function onClick(g,d,i){removeAllTooltips();var x=event.clientX-100,y=event.clientY-100;if(g&&g.data&&g.data.id&&0===g.data.id.indexOf("others-")&&event.target.classList.contains("vz-weighted_tree-node-pre-percent"))return void NotificationService.notify(i18n.i18nString("please_expand_the_flow_to_view"),"warning");if(g.clubbedGroups)return void openUttModal(event,g);if(g&&g.grouped)return void openUttModal(event,g);if(event.target.classList.contains("vz-weighted_tree-node-pre-percent"))return $(".vz-weighted_tree-tip").remove(),void openUttModal(event,g.data);if(g&&g.data&&g.data.id&&0===g.data.id.indexOf("others-"))return moreNodesReq(),void otherNodesClickCount++;if(event.target.classList.contains(".vz-weighted_tree-node-post-percent-bg")||event.target.classList.contains(".post-percent-text"))return void(g.data.parent instanceof Array?createEndOfDialogTooltip(x,y,g,g.data.parent):createEndOfDialogTooltip(x,y,g,g.data.nodeIds));if(g.data&&(g.data.x=g.x,g.data.y=g.y,g.data.x0=g.x0,g.data.y0=g.y0),100!==g.data.dropout)if(g.data.values){deleteNode(g.data.id,dataUnmodified.values);("Users"===g.data.name||"Sessions"===g.data.name)&&delete g.data.updatedUtterances,viz.toggleNode(g.data),$("#viz_container").animate({scrollLeft:scrollLeftValue-1e3},800)}else{if(g.data.parent&&g.data.parent.hasOwnProperty("endOfDialog")&&!$scope.isConver.conversation)return;if(g.data.id){var selectId=".vz-id-"+g.data.id.replace(/:/g,"-")+" .node-loading";$(selectId).show()}!$scope.isConver.conversation&&"Users"===g.data.name||$scope.isConver.conversation&&"Sessions"===g.data.name&&"0"===g.data.nodeId?loadData():getSessionChildren(g.data)}scrollLeftValue=navigator.userAgent.toLowerCase().indexOf("firefox")<0?event.offsetX:event.layerX}function changeSize(val,dataClickId,dataVals){var s=[$(window).width(),$(window).height()];viz_container.transition().duration(300).style("width",s[0]+"px"),0!==$("#viz_container").length&&viz&&viz.width(s[0]).height(.8*s[1]).update(null,dataClickId,dataVals)}function checkCustomTagValue(){var valueCheck=!1;return $scope.selectedTagsArray.forEach(function(value,key){value.name&&value.values&&""!==value.name&&0===value.values.length&&(valueCheck=!0)}),valueCheck}function createPostPayload(startDate,endDate,channels,lang,sessions,customTags,parentId){var tempPayload={};tempPayload.channels=channels,tempPayload.lang=lang,tempPayload.start_date=startDate,tempPayload.end_date=endDate,tempPayload.sessions=sessions,parentId&&(tempPayload.parent=parentId);var tempTags=prepareTagsPayload(customTags);return 1!==tempTags.and.length&&tempTags.and.pop(),($scope.stream&&$scope.stream.channels&&$scope.stream.channels.length===channels.length||0===channels.length)&&delete tempPayload.channels,($scope.stream.supportedLanguages.length===lang.length||0===lang.length)&&delete tempPayload.lang,sessions&&0===sessions.length&&delete tempPayload.sessions,tempPayload.tags=angular.copy(tempTags),tempPayload.sessionStatus=$scope.sessionStatus.value||"all","all"===$scope.sessionType.value?tempPayload.sessionCategory=[0,1]:"interactive"===$scope.sessionType.value?tempPayload.sessionCategory=[1]:"noninteractive"===$scope.sessionType.value?tempPayload.sessionCategory=[0]:tempPayload.sessionCategory=[0,1],tempPayload}function getLanguageName(type){for(var name="",i=0;i<$scope.seedSupportedLanguages.length;i++)if($scope.seedSupportedLanguages[i].value===type){name=$scope.seedSupportedLanguages[i].name;break}return name}function prepareTagsPayload(filterComponent){return filterComponent.tags={and:[]},$scope.selectedTagsArray.forEach(function(value,key){filterComponent.tags.and.push({name:value.name,values:value.values,type:value.type})}),filterComponent.tags}function getTemplate(msgData){try{var data=msgData;if("facebook"===data.channels[0].type){var channelMsg=JSON.parse(data.components[0].data.text);msgData=channelMsg.attachment}else{var templateData=msgData.components[0].data.text;msgData=JSON.parse(templateData)}return"button"===msgData.payload.template_type?$(buttonTemplate).tmpl({msgData:msgData}).html():"video"===msgData.type||"audio"===msgData.type||"link"===msgData.type||"image"===msgData.type?(msgData.extractedFileName=msgData.payload.url.replace(/^.*[\\\/]/,""),$(templateAttachment).tmpl({msgData:msgData}).html()):"error"===msgData.type||"message"===msgData.type?$(warningTemplate).tmpl({msgData:msgData}).html():"quick_replies"===msgData.payload.template_type?$(quickReplyTemplate).tmpl({msgData:msgData}).html():"list"===msgData.payload.template_type?$(listTemplate).tmpl({msgData:msgData}).html():msgData&&msgData.payload&&"mini_table"===msgData.payload.template_type&&"horizontal"===msgData.payload.layout?(setTimeout(function(){$scope.miniTemplateFn(data)}),$(miniTableHorizontalTemplate).tmpl({msgData:msgData}).html()):msgData&&msgData.payload&&"carousel"===msgData.payload.template_type||msgData&&msgData.payload&&"generic"===msgData.payload.template_type?(setTimeout(function(){$scope.carouselTemplateFn(data)}),$(carouselTemplate).tmpl({msgData:msgData}).html()):msgData&&msgData.payload&&"table"===msgData.payload.template_type?(setTimeout(function(){504==$(".botchatHistoryContainer").width()||$(".botchatHistoryContainer").width()<504?($(".accordionTable").each(function(){$(this).hasClass("responsive")&&$(this).addClass("hide")}),$(".tablechartDiv").each(function(){$(this).hasClass("regular")||$(this).removeClass("hide")})):($(".accordionTable").each(function(){$(this).hasClass("responsive")&&$(this).removeClass("hide")}),$(".tablechartDiv").each(function(){$(this).hasClass("regular")||$(this).addClass("hide")}))}),$(tableChartTemplate).tmpl({msgData:msgData}).html()):msgData&&msgData.payload&&"barchart"===msgData.payload.template_type?(setTimeout(function(){$scope.barChartFn(data)}),$(barchartTemplate).tmpl({msgData:msgData,data:data}).html()):msgData&&msgData.payload&&"piechart"===msgData.payload.template_type?(setTimeout(function(){$scope.pieChartFn(data)}),$(pieChartTemplate).tmpl({msgData:msgData,data:data}).html()):msgData&&msgData.payload&&"linechart"===msgData.payload.template_type?(setTimeout(function(){$scope.lineChartFn(data)}),$(linechartTemplate).tmpl({msgData:msgData,data:data}).html()):'<span class="messageBubble">'+i18n.i18nString("js_msg")+"</span>"}catch(error){return'<span class="messageBubble">'+i18n.i18nString("js_msg")+"</span>"}}function init(){$scope.sumocb={languagescb:{changeText:!0},channelscb:{changeText:!0},sessionscb:{changeText:!0}},$scope.channels=[],$scope.supportedLanguages=[],$scope.getDefaultFilter(1),$scope.stream&&$scope.stream.channels&&$scope.stream.channels.forEach(function(value,key){"audiocodes"===(value.name?value.name:value.type)?$scope.channels.push({value:"IVR - AudioCodes",type:value.type}):$scope.channels.push({value:value.name?value.name:value.displayName||value.type,type:value.type})}),$scope.stream.supportedLanguages.forEach(function(value,key){$scope.supportedLanguages.push({value:getLanguageName(value),type:value})});var screenWidth,screenHeight,rect;rect=self==top?document.body.getBoundingClientRect():parent.document.body.getBoundingClientRect(),screenWidth=rect.width<960?Math.round(.95*rect.width):Math.round(.95*(rect.width-210)),screenHeight=750,d3.select("#currentDisplay").attr("item_value",String(screenWidth)+","+String(screenHeight)).attr("class","selected").html("<a>"+screenWidth+"px - "+screenHeight+"px</a>"),viz_container=d3.selectAll("#viz_container").style("width",screenWidth+"px"),loadData()}$scope.rightClass="right500",$scope.modalSlider={},$scope.stream=$workflowService.selectedStream(),$scope.seedSupportedLanguages=$workflowService.seedData().supportedLanguages,$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.channels=[],$scope.supportedLanguages=[],$scope.filterSession={selectedLanguages:[],selectedChannels:[],selectedSession:[]},$scope.defaultFilter=!0,$scope.sessionFlowLoading=!0,$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.checkTickIcon=$scope.assetsBase+"headerIcons/checkTickIcon.svg";var agentSessionIcon=env_conf["context-url"]+"/assets/icons/agent-session-flow.png",transitionTypeIcon=env_conf["context-url"]+"/assets/icons/hold.png",triangleIcon=env_conf["context-url"]+"/assets/icons/trian.png",arrowIcon=env_conf["context-url"]+"/assets/icons/arrow.svg";$scope.botIcon=env_conf["context-url"]+"/assets/icons/bot.png",$scope.moveDownIcon=$scope.assetsBase+"landingImages/move-down.svg",$scope.moveUpIcon=$scope.assetsBase+"landingImages/move-up.svg",$scope.dateDisplayName=i18n.i18nString("24_hours"),$scope.messageIndex=0,$scope.search={nameSearchQuery:""},$scope.sFlow={text:""},$scope.stateLoad={utterances:!0},$scope.isRequesting=!1,$scope.rightArrow=$scope.assetsBase+"ivrIcons/rightArrow.svg",$scope.customTags="",$scope.startDate="",$scope.endDate="",$scope.days=1;var exportTypeOutgoing=!1;$scope.customTagsArray=[],$scope.selectedTagsArray=[],$scope.selectedTagsArray.push({name:"",values:"",type:""}),$scope.selectedTag="",$scope.isSessionFlowAvail=!0,$scope.utterancesCount=0,$scope.regroupDone={message:!1,progress:!1,error:"",dockError:!1};var carouselTemplateCount=0,carouselEles=[],available_charts=[],isClusterDoneToday=!1;$scope.utteranceHead="";var filterCompTemp={};$scope.winningIntentData="",$scope.disabledMinusIcon=$scope.assetsBase+"images/left-menu-img/disabledMinus.svg",$scope.minusIcon=$scope.assetsBase+"icons/minus-circle.svg",$scope.caretDown=$scope.assetsBase+"headerIcons/caretDown.svg",$scope.andIcon=$scope.assetsBase+"icons/andIcon.svg",$scope.downloadIcon=$scope.assetsBase+"kg/export.svg",$scope.groupingProgress=$scope.assetsBase+"icons/oval-2-copy-2.png",$scope.select=i18n.i18nString("select"),$scope.sessionTypeList=[{name:i18n.i18nString("all"),value:"all"},{name:i18n.i18nString("interactive"),value:"interactive"},{name:i18n.i18nString("non_interactive_label"),value:"noninteractive"}],$scope.sessionType={name:i18n.i18nString("all"),value:"all"},$scope.sessionStatusList=[{name:i18n.i18nString("active_label"),value:"active"},{name:i18n.i18nString("closed"),value:"closed"}],$scope.sessionStatus={name:i18n.i18nString("closed"),value:"closed"};var scrollLeftValue=0;$scope.filterTags=[],$scope.isConver={conversation:!1},$scope.backArrow={utterances:!1};var allNodes=[],otherNodesClickCount=0,filterComponent={endDate:moment().toISOString(),startDate:moment().subtract(1,"d").toISOString(),languages:[],channels:[],customTags:"",days:1,tags:{and:[]},sessions:[]};$scope.chat={slider:!1},$scope.gps={groupsShow:!1,utterancesShow:!1},$scope.utteranceGroups=[],$scope.messageIdClicked="";var constantsList=$rootScope._constants_,globOrder=0,ttRemoveTime=null,ttRemovePath=null,ttCreationTime=null,totalNodesCount=0,reloadDockStatus=!1;$scope.helpers={nl2br:function(str,runEmojiCheck){return runEmojiCheck&&(str=window.emojione.shortnameToImage(str)),str=str.replace(/(?:\r\n|\r|\n)/g,"<br />")},br2nl:function(str){return str=str.replace(/<br \/>/g,"\n")},formatAMPM:function(date){var hours=date.getHours(),minutes=date.getMinutes(),seconds=date.getSeconds(),ampm=hours>=12?"pm":"am";hours%=12,hours=hours?hours:12,minutes=10>minutes?"0"+minutes:minutes,seconds=10>seconds?"0"+seconds:seconds;var strTime=hours+":"+minutes+":"+seconds+" "+ampm;return strTime},formatDate:function(date){var d=new Date(date);return d.toDateString()+" at "+$scope.helpers.formatAMPM(d)},convertMDtoHTML:function(val,responseType){function matchmap(regexval,stringval){for(var da,matches=[];null!==(da=regexval.exec(stringval));){var keypair={};if(keypair.index=da.index,keypair.matchexp=da[0],da.length>1)for(var n=1;n<da.length;n++){var mstr="matchval"+n.toString();keypair[mstr]=da[n]}matches.push(keypair)}return matches}function ucreplacer(match){return match.toUpperCase()}function ignoreWords(str){var _words=["onclick","onmouse","onblur","onscroll","onStart"];return _words.forEach(function(word){var regEx=new RegExp(word,"ig");str=str.replace(regEx,"")}),str}function linkreplacer(match,p1,offset,string){var dummyString=string.replace(_regExForMarkdownLink,"[]");if(dummyString=ignoreWords(dummyString),-1!==dummyString.indexOf(match)){var _target,_link=p1.indexOf("http")<0?"http://"+match:match;return _target="target='_blank'","<span class='isLink' readlink=\""+_link+'" ><a '+_target+' href="'+_link+'">'+match+"</a></span>"}return match}var mdre={};mdre.date=new RegExp(/\\d\(\s*(.{10})\s*(?:,\s*["'](.+?)["']\s*)?\)/g),mdre.time=new RegExp(/\\t\(\s*(.{8}\.\d{0,3})\s*\)/g),mdre.datetime=new RegExp(/\\(d|dt|t)\(\s*([-0-9]{10}[T][0-9:.]{12})([z]|[Z]|[+-]\d{4})[\s]*,[\s]*["']([a-zA-Z\W]+)["']\s*\)/g),mdre.num=new RegExp(/\\#\(\s*(\d*.\d*)\s*\)/g),mdre.curr=new RegExp(/\\\$\((\d*.\d*)[,](\s*[\"\']\s*\w{3}\s*[\"\']\s*)\)|\\\$\((\d*.\d*)[,](\s*\w{3}\s*)\)/g);var regEx={};regEx.SPECIAL_CHARS=/[\=\`\~\!@#\$\%\^&\*\(\)_\-\+\{\}\:"\[\];\',\.\/<>\?\|\\]+/,regEx.EMAIL=/^[-a-z0-9~!$%^&*_=+}{\']+(\.[-a-z0-9~!$%^&*_=+}{\']+)*@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,255})+$/i,regEx.MENTION=/(^|\s|\\n|")@([^\s]*)(?:[\s]\[([^\]]*)\])?["]?/gi,regEx.HASHTAG=/(^|\s|\\n)#(\S+)/g,regEx.NEWLINE=/\n/g;var _regExForLink=/((?:http\:\/\/|https\:\/\/|www\.)+\S*\.(?:(?:\.\S)*[^\,\s\.])*\/?)/gi,_regExForMarkdownLink=/\[([^\]]+)\](|\s)+\(([^\)])+\)/g,str=val||"",mmntns={};mmntns.sd=new RegExp(/^(d{1})[^d]|[^d](d{1})[^d]/g),mmntns.dd=new RegExp(/^(d{2})[^d]|[^d](d{2})[^d]/g),mmntns.fy=new RegExp(/(y{4})|y{2}/g);for(var regexkeys=Object.keys(mdre),j=0;j<regexkeys.length;j++){var k;switch(regexkeys[j]){case"date":var strvald=str,datematcharray=matchmap(mdre.date,strvald);if(datematcharray.length)for(k=0;k<datematcharray.length;k++){var fdate=new Date(datematcharray[k].matchval1).toLocaleDateString();fdate=" "+fdate.toString()+" ",str=str.replace(datematcharray[k].matchexp.toString(),fdate)}break;case"time":var strvalt=str,timematcharray=matchmap(mdre.time,strvalt);if(timematcharray.length)for(k=0;k<timematcharray.length;k++){var ftime=new Date(timematcharray[k].matchval1).toLocaleTimeString();ftime=" "+ftime.toString()+" ",str=str.replace(timematcharray[k].matchexp.toString(),ftime)}break;case"datetime":var strvaldt=str,dtimematcharray=matchmap(mdre.datetime,strvaldt);if(dtimematcharray.length)for(k=0;k<dtimematcharray.length;k++){for(var ms="",mergekeylength=Object.keys(dtimematcharray[k]).length-2,l=2;mergekeylength>l;l++){var keystr="matchval"+l.toString();ms+=dtimematcharray[k][keystr]}var foptionstring="matchval"+mergekeylength.toString(),fmtstr=dtimematcharray[k][foptionstring];fmtstr=fmtstr.replace(mmntns.fy,ucreplacer),fmtstr=fmtstr.replace(mmntns.dd,ucreplacer),fmtstr=fmtstr.replace(mmntns.sd,ucreplacer);var fdtime=moment(ms).format(fmtstr);fdtime=" "+fdtime.toString()+" ",str=str.replace(dtimematcharray[k].matchexp.toString(),fdtime)}break;case"num":var strnumval=str,nummatcharray=matchmap(mdre.num,strnumval);if(nummatcharray.length)for(k=0;k<nummatcharray.length;k++){var fnum=Number(nummatcharray[k].matchval1).toLocaleString();fnum=" "+fnum.toString()+" ",str=str.replace(nummatcharray[k].matchexp.toString(),fnum)}break;case"curr":var strcurval=str,currmatcharray=matchmap(mdre.curr,strcurval),browserLang=window.navigator.language||window.navigator.browserLanguage,curcode=new RegExp(/\w{3}/);if(currmatcharray.length)for(k=0;k<currmatcharray.length;k++){var fcode,currops={};currops.style="currency",currmatcharray[k].matchval2&&(fcode=curcode.exec(currmatcharray[k].matchval2)),currops.currency=fcode[0].toString();var fcurr=Number(currmatcharray[k].matchval1).toLocaleString(browserLang,currops);fcurr=currmatcharray[k].matchval1.toString()===fcurr.toString()?" "+fcurr.toString()+" "+currops.currency:" "+fcurr.toString()+" ",str=str.replace(currmatcharray[k].matchexp.toString(),fcurr)}}}regEx.NEWLINE;try{str=decodeURIComponent(str)}catch(e){str=str||""}var wrapper1,x,aTags,newStr="",_hasHref=!1;if("user"===responseType){for(str=str.replace(/onerror=/gi,"abc-error="),wrapper1=document.createElement("div"),newStr=str.replace(//g,'"').replace(//g,'"'),newStr=newStr.replace(/</g,"&lt;").replace(/>/g,"&gt;"),wrapper1.innerHTML=xssAttack(newStr),aTags=wrapper1.getElementsByTagName("a").length>0?wrapper1.getElementsByTagName("a"):[],_hasHref=!1,x=0;x<aTags.length;x++)if(aTags[x].getAttribute("href").length>0){_hasHref=!0;break}str=_hasHref?newStr:newStr.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(_regExForLink,linkreplacer)}else{for(wrapper1=document.createElement("div"),wrapper1.innerHTML=xssAttack(str),aTags=wrapper1.getElementsByTagName("a").length>0?wrapper1.getElementsByTagName("a"):[],_hasHref=!1,x=0;x<aTags.length;x++)if(aTags[x].getAttribute("href").length>0){_hasHref=!0;break}if(_hasHref){var linkArray=str.match(/<a[^>]*>([^<]+)<\/a>/g);for(x=0;x<linkArray.length;x++){var _newLA=document.createElement("div");_newLA.innerHTML=linkArray[x],$(_newLA).find("a").attr("target","_blank"),str=str.replace(linkArray[x],_newLA.innerHTML)}}else str=wrapper1.innerHTML.replace(_regExForLink,linkreplacer)}return str=$scope.helpers.checkMarkdowns(str),"user"===responseType&&(str=str.replace(/abc-error=/gi,"onerror=")),$scope.helpers.nl2br(str,!0)},checkMarkdowns:function(val){for(var txtArr=val.split(/\r?\n/),i=0;i<txtArr.length;i++){var _lineBreakAdded=!1;0===txtArr[i].indexOf("#h6")||0===txtArr[i].indexOf("#H6")?(txtArr[i]="<h6>"+txtArr[i].substring(3)+"</h6>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h5")||0===txtArr[i].indexOf("#H5")?(txtArr[i]="<h5>"+txtArr[i].substring(3)+"</h5>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h4")||0===txtArr[i].indexOf("#H4")?(txtArr[i]="<h4>"+txtArr[i].substring(3)+"</h4>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h3")||0===txtArr[i].indexOf("#H3")?(txtArr[i]="<h3>"+txtArr[i].substring(3)+"</h3>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h2")||0===txtArr[i].indexOf("#H2")?(txtArr[i]="<h2>"+txtArr[i].substring(3)+"</h2>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h1")||0===txtArr[i].indexOf("#H1")?(txtArr[i]="<h1>"+txtArr[i].substring(3)+"</h1>",_lineBreakAdded=!0):0===txtArr[i].length?(txtArr[i]="\r\n",_lineBreakAdded=!0):0===txtArr[i].indexOf("*")?isEven(txtArr[i].split("*").length-1)||(txtArr[i]="\r\n&#9679; "+txtArr[i].substring(1),_lineBreakAdded=!0):0===txtArr[i].indexOf(">>")?(txtArr[i]='<p class="indent">'+txtArr[i].substring(2)+"</p>",_lineBreakAdded=!0):0===txtArr[i].indexOf("&gt;&gt;")?(txtArr[i]='<p class="indent">'+txtArr[i].substring(8)+"</p>",_lineBreakAdded=!0):(0===txtArr[i].indexOf("---")||0===txtArr[i].indexOf("___"))&&(txtArr[i]="<hr/>"+txtArr[i].substring(3),_lineBreakAdded=!0);var j,_matchImage=txtArr[i].match(/\!\[([^\]]+)\](|\s)+\(([^\)])+\)/g);if(_matchImage&&_matchImage.length>0)for(j=0;j<_matchImage.length;j++){var _imgTxt=_matchImage[j].substring(2,_matchImage[j].indexOf("]"));remainingString=_matchImage[j].substring(_matchImage[j].indexOf("]")+1).trim();var _imgLink=remainingString.substring(1,remainingString.indexOf(")"));_imgLink='<img src="'+_imgLink+'" alt="'+_imgTxt+'"/>';for(var _tempImg=txtArr[i].split(" "),k=0;k<_tempImg.length;k++)_tempImg[k]===_matchImage[j]&&(_tempImg[k]=_imgLink);txtArr[i]=_tempImg.join(" ")}var remainingString,_matchLink=txtArr[i].match(/\[([^\]]+)\](|\s)+\(([^\)])+\)/g);if(_matchLink&&_matchLink.length>0)for(j=0;j<_matchLink.length;j++){var _linkTxt=_matchLink[j].substring(1,_matchLink[j].indexOf("]"));remainingString=_matchLink[j].substring(_matchLink[j].indexOf("]")+1).trim();var _linkLink=remainingString.substring(1,remainingString.indexOf(")"));_linkLink='<span class="isLink" readlink="'+_linkLink+'"><a href="'+_linkLink+'" target="_blank">'+_linkTxt+"</a></span>",txtArr[i]=txtArr[i].replace(_matchLink[j],_linkLink)}var _matchAstrik=txtArr[i].match(/\*\S([^*]*?)\S\*/g);if(_matchAstrik&&_matchAstrik.length>0)for(j=0;j<_matchAstrik.length;j++){var _boldTxt=_matchAstrik[j];_boldTxt=_boldTxt.substring(1,_boldTxt.length-1),_boldTxt="<b>"+_boldTxt+"</b>",txtArr[i]=txtArr[i].replace(_matchAstrik[j],_boldTxt)}var _matchItalic=txtArr[i].match(/\~\S([^*]*?)\S\~/g);if(_matchItalic&&_matchItalic.length>0)for(j=0;j<_matchItalic.length;j++){var _italicTxt=_matchItalic[j];(0===txtArr[i].indexOf(_italicTxt)||" "===txtArr[i][txtArr[i].indexOf(_italicTxt)-1])&&(_italicTxt=_italicTxt.substring(1,_italicTxt.length-1),_italicTxt='<i class="markdownItalic">'+_italicTxt+"</i>",txtArr[i]=txtArr[i].replace(_matchItalic[j],_italicTxt))}var _matchPre=txtArr[i].match(/\`\`\`\S([^*]*?)\S\`\`\`/g),_matchPre1=txtArr[i].match(/\'\'\'\S([^*]*?)\S\'\'\'/g),_preTxt="";if(_matchPre&&_matchPre.length>0){for(j=0;j<_matchPre.length;j++)_preTxt=_matchPre[j],_preTxt=_preTxt.substring(3,_preTxt.length-3),_preTxt="<pre>"+_preTxt+"</pre>",txtArr[i]=txtArr[i].replace(_matchPre[j],_preTxt);_lineBreakAdded=!0}if(_matchPre1&&_matchPre1.length>0){for(j=0;j<_matchPre1.length;j++)_preTxt=_matchPre1[j],_preTxt=_preTxt.substring(3,_preTxt.length-3),_preTxt="<pre>"+_preTxt+"</pre>",txtArr[i]=txtArr[i].replace(_matchPre1[j],_preTxt);_lineBreakAdded=!0}!_lineBreakAdded&&i>0&&(txtArr[i]="\r\n"+txtArr[i])}return val=txtArr.join("")}},$scope.chatHistory={},getCustomMetaTags();var daterangepickerInput,viz_container,viz,theme,data={},dataUnmodified={},dataClickedNode={};$scope.cond={isMoreAvailable:!1};var idForUtt="";$scope.utterances=[];var countUttScroll=0;$scope.defaultFilterMsg="",$scope.defaultFilterMsgTooltip="",getDefaultFilter(1);$scope.checkForTemplate=function(msg){return msg&&-1!==msg.indexOf("{")?!0:!1},$scope.checkForCustomTemplate=function(msg){try{var msgCheck=JSON.parse(msg);if(msgCheck.payload&&"custom"===msgCheck.payload.template_type)return!0}catch(e){return!1}},$scope.showNextMessageTag=function(message,type){"showNextIcon"==type&&message.messageTagLength>=1&&($scope.previousMessageTag=!0,$scope.messageIndex=$scope.messageIndex+1,$scope.messageIndex>=message.messageTagLength&&($scope.nextMessageTag=!1)),"showPreviousIcon"==type&&($scope.nextMessageTag=!0,$scope.messageIndex=$scope.messageIndex-1,0===$scope.messageIndex&&($scope.previousMessageTag=!1))},$scope.onViewClick=function(){removeAllTooltips(),$("#viz_container").scrollTop(0),$scope.isRequesting=!0,$scope.regroupDone.message=!1;var tempPload=createPostPayload($scope.startDate,$scope.endDate,$scope.filterSession.selectedChannels,$scope.filterSession.selectedLanguages,$scope.filterSession.selectedSession,$scope.selectedTagsArray);putRootSessFlow(tempPload)};var disableDbClick=!1;$rootScope.$on("onDockStatus",function($event,data){if(reloadDockStatus)if(data&&"IN_PROGRESS"===data.status)$scope.sessionFlowLoading=!0;else if(data&&"SUCCESS"===data.status&&100===data.percentageComplete&&data.response){var response={data:data.response};asyncPutRootSessFlow(response),reloadDockStatus=!1}else data&&"FAILURE"===data.status&&100===data.percentageComplete&&($scope.sessionFlowLoading=!1,otherNodesClickCount=0,$scope.isSessionFlowAvail=!1,$scope.isRequesting=!1,reloadDockStatus=!1)}),$scope.checkDockStatus=function(){$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer")},$scope.closeModal=function(){$timeout(function(){$scope.modalSlider.close("#sessionFlowFilter")},500)},$scope.addCustomTags=function(index){$scope.selectedTagsArray.length===index+1&&$scope.selectedTagsArray.push({key:"",value:"",type:""})},$scope.removeCustomsTags=function(index){$scope.selectedTagsArray.splice(index,1),$($(".host .tags input")[index]).val("")},$scope.exportUtterances=function(){var utterancesPayload=createUtterancesPayload(idForUtt,null,null);delete utterancesPayload.offset,delete utterancesPayload.limit,exportTypeOutgoing&&(utterancesPayload.type="outgoing"),BTStreamsService.extractUtterance($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,utterancesPayload).then(function(res){
NotificationService.notify(i18n.i18nString("utterances_eport_in_progress"),"success"),$rootScope.$broadcast("startTimer")},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].code&&"RequestExists"===err.data.errors[0].code?NotificationService.notify(i18n.i18nString("request_exists_please_wait_noty"),"error"):NotificationService.notify(i18n.i18nString("unable_to_export_utterances"),"error")})},$scope.updateScrollfunction=function(){setTimeout(function(){PerfectScrollbar.update($("#scrollUpdateItems")[0])},750)},$scope.groupedEleShow=function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(e.target).closest(".parentGroupDivBlock").toggleClass("active"),$(e.target).siblings(".grouped").toggleClass("groupedElements"),$(e.target).siblings(".grouped").slideToggle()},$scope.groupEleHide=function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(e.target).closest(".parentGroupDivBlock").toggleClass("active"),$(e.target).closest(".parentGroupDivBlock").find(".grouped").toggleClass("groupedElements"),$(e.target).closest(".parentGroupDivBlock").find(".grouped").slideToggle()},$scope.openChatSlider=function(messageId,e){e.stopPropagation(),$scope.chat.slider=!0,$scope.messageIdClicked=messageId,BTStreamsService.getChatHistory($scope.stream._id,messageId,0,200).then(function(res){$scope.chatHistory=res.data;for(var i=0;i<$scope.chatHistory.messages.length;i++){if($scope.chatHistory.messages[i]._id===$scope.messageIdClicked)if("smalltalk"===$scope.utteranceHead.toLowerCase()||"nothandled"===$scope.utteranceHead.toLowerCase())$scope.winningIntentData="";else if("faq"===$scope.utteranceHead.toLowerCase()){$scope.chatHistory.messages[i+1].tN&&($scope.winningIntentData="Intent: "+$scope.chatHistory.messages[i+1].tN);var intentFaq=$scope.chatHistory.messages[i].components[0].data.text;intentFaq?$scope.winningIntentData="Intent: "+intentFaq.slice(0,intentFaq.length-1):$scope.winningIntentData="FAQ"}else $scope.winningIntentData="Intent: "+$scope.chatHistory.messages[i+1].tN;$scope.chatHistory.messages[i].ms&&($scope.chatHistory.messages[i].showUserMessage=$scope.chatHistory.messages[i].ms),$scope.chatHistory.messages[i].msgTagValue=$scope.chatHistory.messages[i].tags.messageTags,$scope.chatHistory.messages[i].msgTagValue.length>1&&($scope.nextMessageTag=!0,$scope.previousMessageTag=!1),$scope.chatHistory.messages[i].messageTagLength=$scope.chatHistory.messages[i].msgTagValue.length-1}$timeout(function(){var borderOrang=document.querySelector(".botchatHistoryContainer .borderOrange");borderOrang.scrollIntoView()},500)},function(err){console.log(err)})},$("#viz_container").scroll(function(){removeAllTooltips()}),$scope.listScrollTop=function(){document.getElementById("uttNodeList").scrollTop=0},$scope.sFUttModalClose=function(){$timeout(function(){$scope.modalSlider.close("#sessionFlowUtterance"),$scope.utterances=[],$scope.gps.utterancesShow=!1,$scope.gps.groupsShow=!1,$scope.backArrow.utterances=!1,$scope.chat.slider=!1,countUttScroll=0,exportTypeOutgoing=!1,$scope.utteranceGroups.forEach(function(val){val.isActive=!1})},500)},$rootScope.$on("scheduleClusterDone",function(){isClusterDoneToday||($scope.regroupDone.message=!0,$scope.regroupDone.progress=!1,isClusterDoneToday=!0)}),$rootScope.$on("scheduleClusterFailed",function(){isClusterDoneToday||($scope.regroupDone.progress=!1,$scope.regroupDone.dockError=!0,$scope.regroupDone.error=i18n.i18nString("regrouping_of_utterences_failed"))}),$scope.scheduleCluster=function(){$scope.regroupDone.dockError=!1,$scope.regroupDone.error="",BTStreamsService.scheduleCluster($workflowService.selectedStream()._id,{}).then(function(res){$rootScope.$broadcast("startTimer"),$scope.regroupDone.progress=!0},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&(1001===err.data.errors[0].code?($scope.regroupDone.progress=!0,$rootScope.$broadcast("startTimer")):1002===err.data.errors[0].code?isClusterDoneToday=!0:1003===err.data.errors[0].code&&($scope.regroupDone.progress=!1,$scope.regroupDone.message=!1,$scope.regroupDone.error=i18n.i18nString("regrouping_has_failed")))})},$scope.openGpsUttModal=function(e,uttData){$scope.utteranceGroups.forEach(function(val){val.isActive=!1}),$scope.backArrow.utterances=!1,$scope.utteranceHead=uttData.utterance,countUttScroll=0,uttData.isActive=!0,$scope.chat.slider=!1,openUttModal(e,uttData)},$(window).on("resize",changeSize);var loadFilter=function(res){$scope.filterSession.selectedLanguages=res.languages||[],$scope.filterSession.selectedChannels=res.channels||[],$scope.customTags=res.customTags,$scope.filterSession.selectedSession=res.sessions,$scope.endDate=res.endDate||$scope.endDate,$scope.startDate=res.startDate||$scope.startDate,$scope.days=res.days||$scope.days,$scope.appliedSelectedDays=angular.copy($scope.days),$scope.selectedTagsArray=[],$scope.customTagsArray=[],$scope.customTagsArray&&0===$scope.customTagsArray.length&&($scope.customTagsArray=res.tags,_.forEach($scope.customTagsArray,function(value){value.selectedValues=value.values})),res.customTags&&0!==res.customTags.length?$scope.selectedTagsArray=angular.copy(res.customTags):$scope.selectedTagsArray.push({name:"",values:[],type:""}),setTimeout(function(){$scope.sumocb.languagescb.selectAllByDefault&&$scope.defaultFilter&&$scope.sumocb.languagescb.selectAllByDefault(),$scope.sumocb.channelscb.selectAllByDefault&&$scope.defaultFilter&&$scope.sumocb.channelscb.selectAllByDefault()},150)};$scope.dynamicHeight=function(e,selectedTag){setTimeout(function(){var ele=e.target;ele.style.height="30px",$(ele).hasClass("ng-invalid")?(selectedTag.invalidValue=!0,$scope.isDisabled=!0,$(".disabledClass").attr("disabled","disabled")):(selectedTag.invalidValue=!1,$scope.isDisabled=!1,$(".disabledClass").removeAttr("disabled"))},150)},$scope.calculateHeight=function(e){var ele=e.target;ele.style.height="auto"},$scope.searchValues=function(term,value){return $scope.returnValue=[],value&&value.forEach(function(item){item.toLowerCase().indexOf(term.toLowerCase())>=0&&$scope.returnValue.push(item)}),$scope.returnValue},$scope.filterCustomTags=function(customTag){var _item=_.find($scope.selectedTagsArray,{name:customTag.name});return _item?!1:!0},$scope.applyFilter=function(){$scope.startDate=new Date($scope.startDate).toISOString(),$scope.endDate=new Date($scope.endDate).toISOString(),moment($scope.endDate).format("YYYY-MM-DD")===moment().format("YYYY-MM-DD")&&($scope.endDate=moment().toISOString());var filterComponent={startDate:$scope.startDate,endDate:$scope.endDate,languages:$scope.filterSession.selectedLanguages,channels:$scope.filterSession.selectedChannels,customTags:$scope.selectedTagsArray,days:$scope.days,sessions:$scope.filterSession.selectedSession};if(0!==$scope.selectedTagsArray.length&&""!==$scope.selectedTagsArray[0].name&&checkCustomTagValue())return NotificationService.notify(i18n.i18nString("check_custom_tag"),"warning"),!1;($scope.stream&&$scope.stream.channels&&$scope.stream.channels.length===$scope.filterSession.selectedChannels.length||0===$scope.filterSession.selectedChannels.length)&&(filterComponent.channels=[]),($scope.stream.supportedLanguages.length===$scope.filterSession.selectedLanguages.length||0===$scope.filterSession.selectedLanguages.length)&&(filterComponent.languages=[]),$scope.filterSession.selectedSession&&0===$scope.filterSession.selectedSession.length&&(filterComponent.sessions=[]),filterComponent.tags=prepareTagsPayload(filterComponent),1!==filterComponent.tags.and.length&&filterComponent.tags.and.pop(),filterCompTemp=angular.copy(filterComponent);var tempPload=createPostPayload($scope.startDate,$scope.endDate,$scope.filterSession.selectedChannels,$scope.filterSession.selectedLanguages,$scope.filterSession.selectedSession,$scope.selectedTagsArray);putRootSessFlow(tempPload),$scope.defaultFilter=!1,$scope.filterTags=[];var daysCount,stDate=new Date(filterComponent.startDate.slice(0,10)),enDate=new Date(filterComponent.endDate.slice(0,10)),stDateD=stDate.getDate()<10?"0"+stDate.getDate():stDate.getDate(),enDateD=enDate.getDate()<10?"0"+enDate.getDate():enDate.getDate(),stMonth=stDate.getMonth()+1?"0"+(stDate.getMonth()+1):stDate.getMonth()+1,enMonth=enDate.getMonth()+1?"0"+(enDate.getMonth()+1):enDate.getMonth()+1,sD=(stMonth+"-"+stDateD+"-"+stDate.getFullYear(),enMonth+"-"+enDateD+"-"+enDate.getFullYear(),new Date($scope.startDate)),eD=new Date($scope.endDate),timeDiff=eD.getTime()-sD.getTime(),countDays=timeDiff/864e5;countDays&&countDays.toString()&&"undefined"!=typeof countDays.toString().split&&countDays.toString().split(".")&&countDays.toString().split(".")[0]&&countDays.toString().split(".")[0].length&&7!==filterComponent.days?countDays&&countDays.toString()&&"undefined"!=typeof countDays.toString().split&&countDays.toString().split(".")&&countDays.toString().split(".")[1]&&countDays.toString().split(".")[1].length&&countDays>8?(countDays+=1,daysCount=countDays.toString().split(".")[0]):"0"===countDays.toString().split(".")[0]?(countDays+=1,daysCount=countDays.toString().split(".")[0]):(countDays+=1,daysCount=countDays.toString().split(".")[0]):7!==filterComponent.days&&(daysCount=countDays);var showCount;showCount=daysCount&&"1"===daysCount?daysCount+" Day":daysCount+" Days",7===filterComponent.days?$scope.filterTags.push({value:i18n.i18nString("last7_days"),type:"date",tooltipValue:moment(filterComponent.startDate).format("MM-DD-YYYY")+i18n.i18nString("to_label_spaced")+moment(filterComponent.endDate).format("MM-DD-YYYY"),count:"7 Days"}):-1===filterComponent.days?$scope.filterTags.push({value:i18n.i18nString("date_period"),type:"date",tooltipValue:moment(filterComponent.startDate).format("MM-DD-YYYY")+i18n.i18nString("to_label_spaced")+moment(filterComponent.endDate).format("MM-DD-YYYY"),count:showCount,datePeriodValue:!0}):$scope.filterTags.push({value:i18n.i18nString("last_24_hours"),type:"date",tooltipValue:moment(filterComponent.startDate).format("MM-DD-YYYY")+i18n.i18nString("to_label_spaced")+moment(filterComponent.endDate).format("MM-DD-YYYY"),count:"1 Day"}),filterComponent.channels.length>0&&$scope.filterTags.push({value:"Channel",type:"channel",tooltipValue:filterComponent.channels.join(),count:filterComponent.channels.length});var filterCompFlag=filterComponent.tags.and.filter(function(val){return val.hasOwnProperty("name")&&val.hasOwnProperty("values")?void 0!==val.name&&void 0!==val.values&&""!==val.name&&0!==val.values.length:val.hasOwnProperty("key")&&val.hasOwnProperty("value")?""!==val.key&&""!==val.value:void 0});filterCompFlag.length&&$scope.filterTags.push({value:"Custom Tags",type:"customTags",count:filterCompFlag.length}),filterComponent.languages.length>0&&$scope.filterTags.push({value:"Languages",type:"language",tooltipValue:filterComponent.languages.join(),count:filterComponent.languages.length}),filterComponent.sessions&&filterComponent.sessions.length>0&&$scope.filterTags.push({value:"Session type",type:"sessions",tooltipValue:filterComponent.sessions.join(),count:filterComponent.sessions.length}),$scope.closeModal()},$scope.closeUtterances=function(){$scope.gps.utterancesShow=!$scope.gps.utterancesShow,countUttScroll=0,$scope.utteranceGroups.forEach(function(val){val.isActive=!1})},$scope.clearFilterTags=function(){$scope.filterTags=[],filterComponent={endDate:moment().toISOString(),startDate:moment().subtract(7,"d").toISOString(),languages:[],channels:[],days:7,sessions:[],tags:{and:[]}},$scope.selectedTagsArray=[],$scope.selectedTagsArray.push({name:"",values:[],type:""}),$scope.defaultFilter=!0;var tempPload=createPostPayload(filterComponent.startDate,filterComponent.endDate,filterComponent.channels,filterComponent.languages,$scope.filterSession.selectedSession,filterComponent.tags.and);putRootSessFlow(tempPload),filterCompTemp=angular.copy(filterComponent)},$scope.showDateWarning=function(){NotificationService.notify(i18n.i18nString("date_filter_warning"),"warning")},$scope.removeFilterTag=function(index,tag){if("7 days"==tag.count.toLowerCase())return void $scope.showDateWarning();"date"===tag.type?($scope.endDate=moment().toISOString(),$scope.startDate=moment().subtract(1,"d").toISOString(),$scope.days=1):"language"===tag.type?$scope.filterSession.selectedLanguages=[]:"channel"===tag.type?$scope.filterSession.selectedChannels=[]:"sessions"===tag.type?$scope.filterSession.sessions=[]:"customTags"===tag.type&&($scope.customTags="",$scope.selectedTagsArray=[]),$scope.filterTags.splice(index,1),0===$scope.filterTags.length&&$scope.clearFilterTags(),filterComponent={startDate:$scope.startDate,endDate:$scope.endDate,languages:$scope.filterSession.selectedLanguages,channels:$scope.filterSession.selectedChannels,customTags:$scope.selectedTagsArray,days:$scope.days,sessions:$scope.filterSession.selectedSession},filterCompTemp=angular.copy(filterComponent),($scope.stream&&$scope.stream.channels&&$scope.stream.channels.length===filterComponent.channels.length||0===filterComponent.channels.length)&&(filterComponent.channels=[]),($scope.stream.supportedLanguages.length===filterComponent.languages.length||0===filterComponent.languages.length)&&(filterComponent.languages=[]);var tempPload={};0!==$scope.filterTags.length&&(""!==$scope.customTags&&$scope.selectedTagsArray.length>1?(tempPload=createPostPayload($scope.startDate,$scope.endDate,$scope.filterSession.selectedChannels,$scope.filterSession.selectedLanguages,$scope.filterSession.selectedSession,$scope.selectedTagsArray),putRootSessFlow(tempPload)):(tempPload=createPostPayload(filterComponent.startDate,filterComponent.endDate,filterComponent.channels,filterComponent.languages,filterComponent.sessions,[]),putRootSessFlow(tempPload)))},$scope.openFilterSlider=function(){getCustomMetaTags(),$timeout(function(){if($scope.search.nameSearchQuery="",$scope.modalSlider.open("#sessionFlowFilter"),$element.find(".modalBody").scrollTop(0),$scope.isDisabled=!1,filterCompTemp.tags&&filterCompTemp.tags.and){var tagsAndFl=filterCompTemp.tags.and.filter(function(val){return val.hasOwnProperty("name")&&val.hasOwnProperty("values")?void 0!==val.name&&void 0!==val.values&&""!==val.name&&0!==val.values.length:val.hasOwnProperty("key")&&val.hasOwnProperty("value")?""!==val.key&&""!==val.value:void 0});0===tagsAndFl.length&&(filterCompTemp.tags=[])}if(filterCompTemp.customTags){var customFil=filterCompTemp.customTags.filter(function(val){return val.hasOwnProperty("name")&&val.hasOwnProperty("values")?void 0!==val.name&&void 0!==val.values&&""!==val.name&&0!==val.values.length:val.hasOwnProperty("key")&&val.hasOwnProperty("value")?""!==val.key&&""!==val.value:void 0});0===customFil.length&&(filterCompTemp.customTags="")}loadFilter(0!==Object.keys(filterCompTemp).length&&filterCompTemp.constructor===Object?filterCompTemp:filterComponent)},500)},$scope.importModalSliderClose=function(){$timeout(function(){$scope.modalSlider.close("#sessionFlowFilter"),$("body").removeClass("bt-modal-open")},500)},$scope.getDefaultFilter=function(days){$scope.days=days,1===days?$scope.dateDisplayName=i18n.i18nString("24_hours"):7===days&&($scope.dateDisplayName=i18n.i18nString("last_seven_days")),-1!==days&&($scope.appliedSelectedDays=days),-1!==days&&($scope.endDate=moment().toISOString(),$scope.startDate=moment().subtract(days,"d").toISOString()),-1==days&&(7==$scope.appliedSelectedDays?($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):1==$scope.appliedSelectedDays&&($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")))),getCustomMetaTags()},$timeout(function(){$(".sessionType_help").popover({html:!0,content:"<p>"+i18n.i18nString("help_interactive")+"</p><p>"+i18n.i18nString("help_non_interactive")+'</p><p><a class="knowmore" target="_blank" href="https://github.com/Koredotcom/chatbot-test-runner">'+i18n.i18nString("knowMore")+"</a></p>",trigger:"hover",delay:{hide:1e3,show:100}})}),$timeout(function(){daterangepickerInput=$('div[name="daterange"]').daterangepicker({locale:{applyLabel:i18n.i18nString("apply"),cancelLabel:i18n.i18nString("close")},startDate:moment(new Date($scope.startDate)).format("MM-DD-YYYY")||moment(),endDate:moment(new Date($scope.endDate)).format("MM-DD-YYYY")||moment(),maxDate:moment(new Date).format("MM-DD-YYYY"),opens:"right",drops:"up",customClass:"analyze-datepicker"}),$(".daterangepicker").addClass("convflows-datepicker"),$('div[name="daterange"]').on("apply.daterangepicker",function(ev,picker){$scope.appliedSelectedDays=-1,ev&&($scope.startDate=moment(new Date(picker.startDate._d)).toISOString()||moment().toISOString(),$scope.endDate=moment(new Date(picker.endDate._d)).toISOString()||moment().toISOString(),$scope.dateDisplayName=moment($scope.startDate).format("MMM DD YYYY")+" - "+moment($scope.endDate).format("MMM DD YYYY")),getCustomMetaTags()}),$('div[name="daterange"]').on("cancel.daterangepicker",function(){7==$scope.appliedSelectedDays?($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):-1!==$scope.appliedSelectedDays&&($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),$scope.days=$scope.appliedSelectedDays}),$('div[name="daterange"]').on("outsideClick.daterangepicker",function(){7==$scope.appliedSelectedDays?($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):-1!==$scope.appliedSelectedDays&&($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),$scope.days=$scope.appliedSelectedDays}),$('input[name="daterangepicker_start"]').on("click",function(evt){evt.stopPropagation()}),$('input[name="daterangepicker_end"]').on("click",function(evt){evt.stopPropagation()}),$(".daterangepicker_input").on("click",function(evt){evt.stopPropagation()}),$(".calendar-table").on("click",function(evt){setTimeout(function(){$(".daterangeCustomDropdown").addClass("open")},0)})},300),$scope.resetFilter=function(){$scope.filterSession.selectedLanguages=[],$scope.filterSession.selectedChannels=[],$scope.customTags="",$scope.getDefaultFilter(1),$scope.endDate=moment().toISOString(),$scope.startDate=moment().subtract(1,"d").toISOString(),$scope.selectedTagsArray=[],$scope.filterSession.selectedSession=[],$scope.selectedTagsArray.push({name:"",values:"",type:""})},$scope.moreFilterModal=!1,$scope.moreFilterToggle=function(){$scope.moreFilterModal=!$scope.moreFilterModal},$scope.selectSessionType=function(item){$scope.sessionType=item},$scope.selectSessionStatus=function(item){$scope.sessionStatus=item},$scope.closeFilterDropdown=function(){$(".advancedFilters").dropdown("toggle")},$scope.addAdvancedFilters=function(event){$scope.closeFilterDropdown()},$scope.searchClick=function(event){event.preventDefault(),event.stopPropagation()},$scope.updatedropDown=function(tag,index){$scope.search.nameSearchQuery="",$scope.selectedTagsArray[index]=tag,$scope.selectedTagsArray[index].values=[],$scope.addCustomTags(index)},$(".clustering-progress").popover({trigger:"hover"}),$scope.scheduleCluster(),$scope.miniTemplateFn=function(data){$("[data-msg-id="+data._id+"] .carousel").addClass("carousel"+carouselTemplateCount);var count=$("[data-msg-id="+data._id+"] .carousel"+carouselTemplateCount).children().length;if(count>1){var carouselOneByOne=new PureJSCarousel({carousel:"[data-msg-id="+data._id+"] .carousel"+carouselTemplateCount,slide:".slide",oneByOne:!0});$(".carousel"+carouselTemplateCount).parent().show(),$(".carousel"+carouselTemplateCount).attr("style","height: 100% !important"),carouselEles.push(carouselOneByOne)}},$scope.carouselTemplateFn=function(data){$("[data-msg-id="+data._id+"] .carousel").addClass("carousel"+carouselTemplateCount);var count=$("[data-msg-id="+data._id+"] .carousel"+carouselTemplateCount).children().length;if(count>1){var carouselOneByOne=new PureJSCarousel({carousel:"[data-msg-id="+data._id+"] .carousel"+carouselTemplateCount,slide:".slide",oneByOne:!0});$(".carousel"+carouselTemplateCount).parent().show(),$(".carousel"+carouselTemplateCount).attr("style","height: 100% !important"),carouselEles.push(carouselOneByOne)}},$scope.barChartFn=function(data){var messageId=data._id,msgData=JSON.parse(data.components[0].data.text),barTemplateObj={message:[{component:msgData}]},dimens={};dimens.outerWidth=350,dimens.outerHeight=300,dimens.innerHeight=200,dimens.legendRectSize=15,dimens.legendSpacing=4,void 0===msgData.payload.direction&&(msgData.payload.direction="horizontal"),"horizontal"!==msgData.payload.direction||msgData.payload.stacked?"vertical"===msgData.payload.direction&&msgData.payload.stacked?setTimeout(function(){dimens.outerWidth=400,dimens.innerWidth=270;var _barchartObj={id:"barchart"+messageId,data:msgData,type:"stackedBarchart"};available_charts.push(_barchartObj),KoreGraphAdapter.drawD3barVerticalStackedChart(barTemplateObj,dimens,"#barchart"+messageId,12)},250):"horizontal"===msgData.payload.direction&&msgData.payload.stacked?setTimeout(function(){dimens.innerWidth=180;var _barchartObj={id:"barchart"+messageId,data:msgData,type:"stackedBarchart"};available_charts.push(_barchartObj),KoreGraphAdapter.drawD3barStackedChart(barTemplateObj,dimens,"#barchart"+messageId,12)},250):"vertical"!==msgData.payload.direction||msgData.payload.stacked||setTimeout(function(){dimens.innerWidth=240;var _barchartObj={id:"barchart"+messageId,data:msgData,type:"barchart"};available_charts.push(_barchartObj),KoreGraphAdapter.drawD3barChart(barTemplateObj,dimens,"#barchart"+messageId,12)},250):setTimeout(function(){dimens.innerWidth=180;var _barchartObj={id:"Legend_barchart"+messageId,data:msgData,type:"barchart"};available_charts.push(_barchartObj),KoreGraphAdapter.drawD3barHorizontalbarChart(barTemplateObj,dimens,"#barchart"+messageId,12)},250)},$scope.pieChartFn=function(data){var messageId=data._id,msgData=JSON.parse(data.components[0].data.text),pieTemplateObj={message:[{component:msgData}]};if(void 0===msgData.payload.pie_type&&(msgData.payload.pie_type="regular"),msgData.payload.pie_type){var dimens={};dimens.width=300,dimens.height=200,dimens.legendRectSize=10,dimens.legendSpacing=2.4,"regular"===msgData.payload.pie_type?setTimeout(function(){var _piechartObj={id:"piechart"+messageId,data:msgData,type:"regular"};available_charts.push(_piechartObj),KoreGraphAdapter.drawD3Pie(pieTemplateObj,dimens,"#piechart"+messageId,12)},150):"donut"===msgData.payload.pie_type?setTimeout(function(){var _piechartObj={id:"piechart"+messageId,data:msgData,type:"donut"};available_charts.push(_piechartObj),KoreGraphAdapter.drawD3PieDonut(pieTemplateObj,dimens,"#piechart"+messageId,12,"donut")},150):"donut_legend"===msgData.payload.pie_type&&setTimeout(function(){var _piechartObj={id:"piechart"+messageId,data:msgData,type:"donut_legend"};available_charts.push(_piechartObj),KoreGraphAdapter.drawD3PieDonut(pieTemplateObj,dimens,"#piechart"+messageId,12,"donut_legend")},150)}},$scope.lineChartFn=function(data){var messageId=data._id,msgData=JSON.parse(data.components[0].data.text),lineTemplateObj={message:[{component:msgData}]};setTimeout(function(){var dimens={};dimens.outerWidth=350,dimens.outerHeight=350,dimens.innerWidth=230,dimens.innerHeight=250,dimens.legendRectSize=15,dimens.legendSpacing=4;var _linechartObj={id:"linechart"+messageId,data:msgData,type:"linechart"};available_charts.push(_linechartObj),KoreGraphAdapter.drawD3lineChartV2(lineTemplateObj,dimens,"#linechart"+messageId,12)},250)},$scope.renderTemplate=function(msgData,ele){var _msgTemp=getTemplate(msgData);$("[data-msg-id="+msgData._id+"] .template").append(_msgTemp)};var buttonTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                         {{if msgData.payload}}                             <li class = "fromCurrentUser with-icon">                                 <div class="buttonTmplContent">                                     <ul class="buttonTmplContentBox">                                        <li class="buttonTmplContentHeading">                                             ${msgData.payload.text}                                         </li>                                        {{each(key, msgItem) msgData.payload.buttons}}                                             <li {{if msgItem.payload}} value="${msgItem.payload}" {{/if}} {{if msgItem.payload}} actual-value="${msgItem.payload}"{{/if}} {{if msgItem.url}}url="${msgItem.url}"{{/if}} class="buttonTmplContentChild" data-value="${msgItem.value}" type="${msgItem.type}">                                                ${msgItem.title}                                            </li>                                         {{/each}}                                     </ul>                                </div>                            </li>                         {{/if}}                     </script>',templateAttachment='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         {{each(key, msgItem) msgData.payload}}                             <li class = "fromCurrentUser with-icon">                                 {{if msgData.payload}}                                     <div class="messageBubble">                                         <div class="msgCmpt botResponseAttachments" fileid="${msgData.payload.url}">                                             <div class="uploadedFileIcon">                                                 {{if msgData.type == "image"}}                                                     <span class="icon cf-icon icon-photos_active"></span>                                                 {{else msgData.type == "audio"}}                                                    <span class="icon cf-icon icon-files_audio"></span>                                                 {{else msgData.type == "video"}}                                                     <span class="icon cf-icon icon-video_active fa fa-video-camera"></span>                                                 {{else msgData.type == "error"}}                                                 <span class="icon cf-icon icon-video_active fa fa-video-camera"></span>                                                 {{else}}                                                     {{if extension[1]=="xlsx" || extension[1]=="xls" || extension[1]=="docx" || extension[1]=="doc" || extension[1]=="pdf" || extension[1]=="ppsx" || extension[1]=="pptx" || extension[1]=="ppt" || extension[1]=="zip" || extension[1]=="rar"}}                                                        <span class="icon cf-icon icon-files_${extension[1]}"></span>                                                     {{else extension[1]}}                                                        <span class="icon cf-icon icon-files_other_doc"></span>                                                     {{/if}}                                                {{/if}}                                            </div>                                             <div class="botuploadedFileName">${msgData.extractedFileName}</div>                                         </div>                                     </div>                                 {{/if}}                             </li>                         {{/each}}                     {{/if}}                 </script>',warningTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.type  && msgData.type =="error"}}                         <div><span class="warningColor">${msgData.payload.text} </span></div>                        {{else}}                         {{if msgData && msgData.payload && msgData.payload.videoUrl}}                            <div class="messageBubble">                                 <div class="videoEle"><video width="250" controls><source src="${msgData.payload.videoUrl}" type="video/mp4"></video></div>                            </div>                         {{/if}}                    {{/if}}                 </script> ',quickReplyTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <div>                             <li class = "fromCurrentUser with-icon quickReplies">                                 <div class="buttonTmplContent">                                     {{if msgData.payload.text}}                                         <div class="buttonTmplContentHeading quickReply">                                             ${msgData.payload.text}                                        </div>                                    {{/if}}                                     {{if msgData.payload && msgData.payload.quick_replies && msgData.payload.quick_replies.length }}                                         <div class="fa fa-chevron-left quickreplyLeftIcon hide"></div><div class="fa fa-chevron-right quickreplyRightIcon hide"></div>                                            <div class="quick_replies_btn_parent"><div class="autoWidth">                                                {{each(key, msgItem) msgData.payload.quick_replies}}                                                     <div class="buttonTmplContentChild quickReplyDiv"> <span {{if msgItem.payload}}value="${msgItem.payload}"{{/if}} class="quickReply {{if msgItem.image_url}}with-img{{/if}}" type="${msgItem.content_type}">                                                        {{if msgItem.image_url}}<img src="${msgItem.image_url}">{{/if}} <span class="quickreplyText {{if msgItem.image_url}}with-img{{/if}}">${msgItem.title}</span></span>                                                    </div>                                                 {{/each}}                                             </div>                                        </div>                                    {{/if}}                                 </div>                            </li>                         </div>                     {{/if}}                 </script>',listTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class = "fromCurrentUser with-icon">                             <div class="listTmplContent">                                 <ul class="listTmplContentBox">                                     {{if msgData.payload.title || msgData.payload.heading}}                                         <li class="listTmplContentHeading">                                             ${msgData.payload.heading}                                         </li>                                     {{/if}}                                     {{each(key, msgItem) msgData.payload.elements}}                                         {{if msgData.payload.buttons}}                                             {{if key<= 2 }}                                                <li class="listTmplContentChild">                                                     {{if msgItem.image_url}}                                                         <div class="listRightContent" {{if msgItem.default_action && msgItem.default_action.url}}url="${msgItem.default_action.url}"{{/if}} {{if msgItem.default_action && msgItem.default_action.title}}data-value="${msgItem.default_action.title}"{{/if}} {{if msgItem.default_action && msgItem.default_action.type}}type="${msgItem.default_action.type}"{{/if}} {{if msgItem.default_action && msgItem.default_action.payload}} value="${msgItem.default_action.payload}"{{/if}}>                                                             <img alt="image" src="${msgItem.image_url}" onerror="this.onerror=null;this.src=\'../libs/img/no_image.png\';"/>                                                         </div>                                                     {{/if}}                                                     <div class="listLeftContent">                                                         <div class="listItemTitle">${msgItem.title}                                                         {{if msgItem.subtitle}}<div class="listItemSubtitle">${msgItem.subtitle}</div>{{/if}}                                                         {{if msgItem.default_action && msgItem.default_action.url}}<div class="listItemPath" type="url" url="${msgItem.default_action.url}">${msgItem.default_action.url}</div>{{/if}}                                                         {{if msgItem.buttons}}                                                        <div>                                                             <span class="buyBtn" {{if msgItem.buttons[0].type}}type="${msgItem.buttons[0].type}"{{/if}} {{if msgItem.buttons[0].url}}url="${msgItem.buttons[0].url}"{{/if}} {{if msgItem.buttons[0].payload}}value="${msgItem.buttons[0].payload}"{{/if}}>{{if msgItem.buttons[0].title}}${msgItem.buttons[0].title}{{else}}Buy{{/if}}</span>                                                         </div>                                                         {{/if}}                                                    </div>                                                </li>                                             {{/if}}                                        {{else}}                                             <li class="listTmplContentChild">                                                 {{if msgItem.image_url}}                                                     <div class="listRightContent" {{if msgItem.default_action && msgItem.default_action.url}}url="${msgItem.default_action.url}"{{/if}} {{if msgItem.default_action && msgItem.default_action.title}}data-value="${msgItem.default_action.title}"{{/if}} {{if msgItem.default_action && msgItem.default_action.type}}type="${msgItem.default_action.type}"{{/if}} {{if msgItem.default_action && msgItem.default_action.payload}} value="${msgItem.default_action.payload}"{{/if}}>                                                         <img alt="image" src="${msgItem.image_url}" onerror="this.onerror=null;this.src=\'../libs/img/no_image.png\';" />                                                     </div>                                                 {{/if}}                                                 <div class="listLeftContent">                                                     <div class="listItemTitle">${msgItem.title}</div>                                                     {{if msgItem.subtitle}}<div class="listItemSubtitle">${msgItem.subtitle}</div>{{/if}}                                                     {{if msgItem.default_action && msgItem.default_action.url}}<div class="listItemPath" type="url" url="${msgItem.default_action.url}">${msgItem.default_action.url}</div>{{/if}}                                                     {{if msgItem.buttons}}                                                    <div>                                                         <span class="buyBtn" {{if msgItem.buttons[0].type}}type="${msgItem.buttons[0].type}"{{/if}} {{if msgItem.buttons[0].url}}url="${msgItem.buttons[0].url}"{{/if}} {{if msgItem.buttons[0].payload}}value="${msgItem.buttons[0].payload}"{{/if}}>{{if msgItem.buttons[0].title}}${msgItem.buttons[0].title}{{else}}Buy{{/if}}</span>                                                     </div>                                                     {{/if}}                                                </div>                                            </li>                                         {{/if}}                                     {{/each}}                                     </li>                                     {{if msgData.AlwaysShowGlobalButtons || (msgData && msgData.payload.elements.length > 3 && msgData.payload.buttons)}}                                        <li class="viewMoreList">                                             <span class="viewMore" url="{{if msgData.payload.buttons[0].url}}${msgData.payload.buttons[0].url}{{/if}}" type="${msgData.payload.buttons[0].type}" value="{{if msgData.payload.buttons[0].payload}}${msgData.payload.buttons[0].payload}{{else}}${msgData.payload.buttons[0].title}{{/if}}">${msgData.payload.buttons[0].title}</span>                                         </li>                                     {{/if}}                                </ul>                             </div>                         </li>                     {{/if}}                 </script>',miniTableHorizontalTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class="fromCurrentUser with-icon tablechart">                             {{if msgData.payload.text}}                                 <div class="messageBubble tableChart">                                    <span>${msgData.payload.text}</span>                                </div>                             {{/if}}                            <div class="mini_template carousel" id="carousel-one-by-one" style="height: 0px;">                                {{each(key, table) msgData.payload.elements}}                                    <div class="slide">                                        <div class="minitableDiv">                                            <div style="overflow-x:auto; padding: 0 8px;">                                                <table cellspacing="0" cellpadding="0">                                                    <tr class="headerTitle">                                                        {{each(key, tableHeader) table.primary}}                                                             <th {{if tableHeader[1]}}style="text-align:${tableHeader[1]};" {{/if}}>${tableHeader[0]}</th>                                                        {{/each}}                                                     </tr>                                                    {{each(key, additional) table.additional}}                                                         <tr>                                                            {{each(cellkey, cellValue) additional}}                                                                 <td  {{if cellkey === additional.length-1}}colspan="2"{{/if}}  {{if table.primary[cellkey][1]}}style="text-align:${table.primary[cellkey][1]};" {{/if}}>${cellValue}</td>                                                            {{/each}}                                                         </tr>                                                    {{/each}}                                                 </table>                                            </div>                                        </div>                                    </div>                                {{/each}}                            </div>                        </li>                     {{/if}}                 </script>',carouselTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class = "fromCurrentUser with-icon">                             <div class="carousel" id="carousel-one-by-one" style="height: 0px;">                                {{each(key, msgItem) msgData.payload.elements}}                                     <div class="slide">                                        {{if msgItem.image_url}}                                             <div class="carouselImageContent" {{if msgItem.default_action && msgItem.default_action.url}}url="${msgItem.default_action.url}"{{/if}} {{if msgItem.default_action && msgItem.default_action.title}}data-value="${msgItem.default_action.title}"{{/if}} {{if msgItem.default_action && msgItem.default_action.type}}type="${msgItem.default_action.type}"{{/if}} {{if msgItem.default_action && msgItem.default_action.payload}} value="${msgItem.default_action.payload}"{{/if}}>                                                 <img alt="image" src="${msgItem.image_url}" onerror="this.onerror=null;this.src=\'../libs/img/no_image.png\';"/>                                             </div>                                         {{/if}}                                         <div class="carouselTitleBox">                                             <p class="carouselTitle"> ${msgItem.title}</p>                                             {{if msgItem.subtitle}}<p class="carouselDescription">${msgItem.subtitle}</p>{{/if}}                                             {{if msgItem.default_action && msgItem.default_action.type === "web_url"}}<div class="listItemPath carouselDefaultAction" type="url" url="${msgItem.default_action.url}">${msgItem.default_action.url}</div>{{/if}}                                             {{if msgItem.buttons}}                                                 {{each(key, msgBtn) msgItem.buttons}}                                                     <div {{if msgBtn.payload}}value="${msgBtn.payload}"{{/if}} {{if msgBtn.url}}url="${msgBtn.url}"{{/if}} class="listItemPath carouselButton" data-value="${msgBtn.value}" type="${msgBtn.type}">                                                        ${msgBtn.title}                                                    </div>                                                 {{/each}}                                             {{/if}}                                         </div>                                    </div>                                {{/each}}                             </div>                        </li>                     {{/if}}                </script>',tableChartTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class ="fromCurrentUser with-icon tablechart">                             <div class="tablechartDiv {{if msgData.payload.table_design && msgData.payload.table_design == "regular"}}regular{{else}}hide{{/if}}">                                <div style="overflow-x:auto; padding: 0 8px;">                                    <table cellspacing="0" cellpadding="0">                                        <tr class="headerTitle">                                            {{each(key, tableHeader) msgData.payload.columns}}                                                 <th {{if tableHeader[1]}}style="text-align:${tableHeader[1]};"{{/if}}>${tableHeader[0]}</th>                                            {{/each}}                                         </tr>                                        {{each(key, tableRow) msgData.payload.elements}}                                             {{if tableRow.Values.length>1}}                                                <tr {{if key > 4}}class="hide"{{/if}}>                                                    {{each(cellkey, cellValue) tableRow.Values}}                                                         <td  {{if cellkey === tableRow.Values.length-1}}colspan="2"{{/if}} class=" {{if key == 0}} addTopBorder {{/if}}" {{if msgData.payload.columns[cellkey][1]}}style="text-align:${msgData.payload.columns[cellkey][1]};" {{/if}}>${cellValue}</td>                                                    {{/each}}                                                 </tr>                                            {{/if}}                                        {{/each}}                                     </table>                                </div>                                {{if msgData.payload.elements.length > 4 && msgData.payload.table_design && msgData.payload.table_design == "regular"}}<div class="showMore">Show more</div>{{/if}}                            </div>                            <div class="accordionTable {{if msgData.payload.table_design && msgData.payload.table_design == "regular"}}hide{{else}}responsive{{/if}}">                                {{each(key, tableRow) msgData.payload.elements}}                                     {{if key < 4}}                                        <div class="accordionRow">                                            {{each(cellkey, cellValue) tableRow.Values}}                                                 {{if cellkey < 2}}                                                    <div class="accordionCol">                                                        <div class="colTitle hideSdkEle">${msgData.payload.columns[cellkey][0]}</div>                                                        <div class="colVal">${cellValue}</div>                                                    </div>                                                {{else}}                                                    <div class="accordionCol hideSdkEle">                                                        <div class="colTitle">${msgData.payload.columns[cellkey][0]}</div>                                                        <div class="colVal">${cellValue}</div>                                                    </div>                                                {{/if}}                                            {{/each}}                                             <span class="fa fa-caret-right tableBtn"></span>                                        </div>                                    {{/if}}                                {{/each}}                                 <div class="showMore">Show more</div>                            </div>                        </li>                     {{/if}}                 </script>',barchartTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class="fromCurrentUser with-icon barchart">                             {{if msgData.payload.text}}                                 <div class="messageBubble barchart">                                    <span>${msgData.payload.text}</span>                                </div>                             {{/if}}                            <div class="barchartDiv">                            <div class="lineChartChildDiv" id="barchart${data._id}"></div>                            </div>                        </li>                     {{/if}}                 </script>',pieChartTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class = "fromCurrentUser with-icon piechart">                             {{if msgData.payload.text}}                                <div class="messageBubble pieChart">                                    <span>${msgData.payload.text}</span>                                </div>                             {{/if}}                            <div class="piechartDiv">                                <div class="lineChartChildDiv" id="piechart${data._id}"></div>                            </div>                        </li>                     {{/if}}                 </script>',linechartTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class ="fromCurrentUser with-icon linechart">                             {{if msgData.payload.text}}                                <div class="messageBubble linechart">                                    <span>${msgData.payload.text}</span>                                </div>                             {{/if}}                            <div class="linechartDiv">                                <div class="lineChartChildDiv" id="linechart${data._id}"></div>                            </div>                        </li>                     {{/if}}                 </script>';
$scope.showJSON=function(message){var jsonDomEle=document.getElementById("chatHistoryJson");jsonDomEle&&(jsonDomEle.innerHTML=JSON.stringify(message,void 0,2)),$(".jsonResponseContainer").show()},$scope.closeChatHistoryJsonModal=function(){$(".jsonResponseContainer").hide()},init(),$scope.$emit("nestedComponentLoaded",{id:"sessionFlow",flag:!1})}])}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("botStoreSettings",function(){return{restrict:"EA",scope:{callback:"=",streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/bot-store-settings.html",controller:["$scope","form_util","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","$timeout","i18n","env_conf","patternFactory",function($scope,form_util,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,$timeout,i18n,env_conf,patternFactory){var enterpriseLicenseType=$rootScope.licenseType;$scope.uploadIndicatorIcon=env_conf["assets-url"]+"icons-new/upload/upload-indicator.png",$scope.uploadImgIcon=env_conf["assets-url"]+"icons-new/upload/upload-img-indicator.png",$scope.infoIcon=env_conf["assets-url"]+"icons-new/info/info-green.svg",$scope.searchIcon=env_conf["assets-url"]+"icons/search_gray.svg",$scope.fileNameIndicatorIcon=env_conf["assets-url"]+"icons-new/upload/filename-indicator.png",$scope.trashBlackIcon=env_conf["assets-url"]+"icons-new/delete-trash/trash-black.png",$scope.magentoIcon=env_conf["assets-url"]+"icons-new/upload/magento.png",$scope.shopifyIcon=env_conf["assets-url"]+"icons-new/upload/shopify.png",$scope.closeIcon=env_conf["context-url"]+"/assets/icons-new/close/close-dark.svg",$scope.infoBlueIcon=env_conf["context-url"]+"/assets/icons-new/info/info-blue.svg",$scope.uploadThumbnail=!1,$scope.specificdocumentUploading=!1,$scope.instructiondocumentUploading=!1,$scope.botBannerUploading=!1,$scope.iconUploading=!1,$scope.imageUrl=[{image:env_conf["context-url"]+"/assets/images/bx-pw-thumbnails/thumbnailTwo.png",active:!1,imageName:"thumbnailTwo.png",uploadPath:"/assets/images/bx-pw-thumbnails/thumbnailTwo.png"},{image:env_conf["context-url"]+"/assets/images/bx-pw-thumbnails/thumbnailThree.png",active:!1,imageName:"thumbnailThree.png",uploadPath:"/assets/images/bx-pw-thumbnails/thumbnailThree.png"},{image:env_conf["context-url"]+"/assets/images/bx-pw-thumbnails/thumbnailFour.png",active:!1,imageName:"thumbnailFour.png",uploadPath:"/assets/images/bx-pw-thumbnails/thumbnailFour.png"},{image:env_conf["context-url"]+"/assets/images/bx-pw-thumbnails/thumbnailFive.png",active:!1,imageName:"thumbnailFive.png",uploadPath:"/assets/images/bx-pw-thumbnails/thumbnailFive.png"},{image:env_conf["context-url"]+"/assets/images/bx-pw-thumbnails/thumbnailSix.png",active:!1,imageName:"thumbnailSix.png",uploadPath:"/assets/images/bx-pw-thumbnails/thumbnailSix.png"},{image:env_conf["context-url"]+"/assets/images/bx-pw-thumbnails/thumbnailSeven.png",active:!1,imageName:"thumbnailSeven.png",uploadPath:"/assets/images/bx-pw-thumbnails/thumbnailSeven.png"}],$scope.thumbnailOne=env_conf["context-url"]+"/assets/images/bx-pw-thumbnails/thumbnailOne.png";var localImagePath=$scope.thumbnailOne;$scope.defaultThumbnailIcon=new File([""],localImagePath),$scope.defaultThumbnailIcon.iconName=$scope.defaultThumbnailIcon.name.substring($scope.defaultThumbnailIcon.name.lastIndexOf("/")+1,$scope.defaultThumbnailIcon.name.length),$scope.defaultThumbnailIcon.uploadPath="/assets/images/bx-pw-thumbnails/thumbnailOne.png",$scope.thumbnailIcon={},$scope.showErrorThumbnail=!1,$scope.showFileUploadThumbnail=!0,$scope.thumbnailMainIcon=$scope.thumbnailOne,$scope.callback=$scope.callback||{},$scope.stream=$workflowService.selectedStream(),$scope.selectedAccount=$applicationService.userInfo().appControls.userInfo,$scope.visibilityOptions=[{name:"Public",key:"public"},{name:"Private",key:"private"},{name:"Hidden",key:"hidden"}],$scope.displayMode="edit",$scope.snapshotsArray=[],$scope.commandCtx={},$scope.isUploading=!1,$scope.errorInsideStream=!0,$scope.categories=$workflowService.seedData().domains,$scope.botFeatures=$workflowService.seedData().features,$scope.botProducts=$workflowService.seedData().products,$scope.botIntegrations=$workflowService.seedData().integrations,$scope.botFeatures=$workflowService.seedData().features,$scope.botIntegrations=$workflowService.seedData().integrations,$scope.duplicateStreamName=!1,$scope._constants_=$rootScope._constants_,$scope.sdkCallback={},$scope.char_remaining=i18n.i18nString("char_remaining"),$scope.selectedDomain={},$scope.complexity={},$scope.context={},$scope.integrationCopy=[],$scope.storeEditorCB={},$scope.onSubmit=!1,$scope.mewIntegration={},$scope.fileUploaders={},$scope.multiMediaList=[],$scope.integrationListCopy=JSON.parse(JSON.stringify($scope.botIntegrations)),$scope.selectedVisibilty=$scope.visibilityOptions[0],$scope.useCases=_.pluck($scope.categories,"name"),$scope.botProducts=_.filter($scope.botProducts,function(product){return"Process App"!==product}),$scope.categoryConfig={allowclear:!0,multiple:!0,placeholder:"Select Category"},$scope.classConfig={allowclear:!0,multiple:!0,placeholder:"Select Class"},$scope.newStreamData={profileRequired:"true",purpose:enterpriseLicenseType?"employee":null,sbannerchoice:"image",bbannerchoice:"image"},$scope.newStreamData.purposeisRequired=enterpriseLicenseType,$scope.myTeams=[],$scope.showNlpEnable=function(){return $rootScope.wfAdmin},$scope.showThumbnailModal=function(){$("#thumbnailCustomIcons .modal-header").find(".nav-link.active"),$("#thumbnailCustomIcons .modal-header").find(".nav-link.active").length&&($("#thumbnailCustomIcons").find(".nav-link.active").parent(),$("#thumbnailCustomIcons").find(".nav-link.active").parent().length&&($("#thumbnailCustomIcons").find(".nav-item.active").removeClass("active"),$("#thumbnailCustomIcons").find(".nav-link.active").parent().addClass("active"))),$("#thumbnailCustomIcons .modal-body").find("#Icons"),$("#thumbnailCustomIcons .modal-body").find("#Icons").length&&($("#thumbnailCustomIcons .modal-body").find("#Upload").removeClass("active"),$("#thumbnailCustomIcons .modal-body").find("#Icons").addClass("active")),_.forEach($scope.imageUrl,function(image){image.active=!1}),$scope.showThumbnailFooter=!0,$("#thumbnailCustomIcons").modal("show")},$scope.closeConfirmModal=function(){$scope.uploadThumbnail||($scope.showResetOption=!1,$scope.showFileUploadThumbnail=!0),$("#thumbnailCustomIcons").modal("hide")},$scope.showThumbnailFooter=!0,$scope.switchThumbnailTabs=function(value){"icons"===value?($scope.showThumbnailFooter=!0,console.log("ICONS")):($scope.showThumbnailFooter=!1,$scope.showResetOption=!1,$scope.showFileUploadThumbnail=!0,console.log("UPLOAD"))},$scope.loadSavedConfigSettings=function(loader){BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){if($workflowService.selectedStream(res.data),res){$scope.newStreamData={name:res.data.name,description:res.data.description,helpUrl:res.data.helpUrl,homePageUrl:res.data.homePageUrl,color:res.data.color,overview:res.data.overview,integrations:res.data.integrations||[],specificationDocument:res.data.specificationDocument,sbannerchoice:res.data.sbannerchoice,complexity:res.data.complexity,keywords:res.data.keywords&&res.data.keywords.length>0?res.data.keywords.join(","):null,bannerGraphics:"image",features:res.data.features,supportedProducts:res.data.supportedProducts},$scope.integrationCopy=JSON.parse(JSON.stringify($scope.newStreamData.integrations));var _addedIntegrations=_.pluck($scope.newStreamData.integrations,"name");if($scope.integrationListCopy=_.filter($scope.botIntegrations,function(integration){return-1==_addedIntegrations.indexOf(integration.name)?integration:void 0}),"string"==typeof res.data.demoVideoLink?$scope.multiMediaList.push(res.data.demoVideoLink):$scope.multiMediaList=res.data.demoVideoLink?res.data.demoVideoLink:[],$scope.newStreamData.demoVideoLink=angular.copy($scope.multiMediaList),$scope.newStreamData.solutionBotSettings={},$scope.newStreamData.instructionsFile={},res.data.solutionBotSettings&&($scope.newStreamData.solutionBotSettings.botDesc=res.data.solutionBotSettings.botDesc,$scope.newStreamData.solutionBotSettings.configInstURL=res.data.solutionBotSettings.configInstURL,$scope.newStreamData.solutionBotSettings.instructionsFile=res.data.solutionBotSettings.instructionsFile,$scope.newStreamData.instructionsFile.fileId=res.data.solutionBotSettings.configInstFileId,$scope.newStreamData.instructionsFile.configInstFileName=res.data.configInstFileName),res.data.icon&&($scope.newStreamData.icon={},$scope.newStreamData.icon.iconName=res.data.iconName?res.data.iconName:"",$scope.newStreamData.icon.fileId=res.data.icon),"image"===res.data.bannerGraphics&&($scope.newStreamData.botBanner=res.data.botBanner?res.data.botBanner:{}),$scope.newStreamData.promoteInStore=res.data.promoteInStore?res.data.promoteInStore:!1,res.data.complexity&&($scope.complexity.name=res.data.complexity),res.data.domainId){var result=_.find($scope.categories,{_id:res.data.domainId});result&&($scope.newStreamData.domainId=result._id,$scope.selectedDomain.domain=result)}if(res.data.features&&($scope.context.features=[],_.map(res.data.features,function(feature){$scope.context.features.push({text:feature})})),res.data&&res.data.botStoreDetails&&($scope.newStreamData.name=res.data.botStoreDetails.botTitle,$scope.newStreamData.description=res.data.botStoreDetails.botDescription),res.data.supportedProducts&&($scope.context.supportedProducts=[],_.map(res.data.supportedProducts,function(product){product=product.split("-").join(" "),$scope.context.supportedProducts.push({text:product})})),res.data.thumbnailURL)if(res.data.thumbnail&&res.data.thumbnail.thumbnailFileName){$scope.imageUrlName="",$scope.imageUrlValue="",_.forEach($scope.imageUrl,function(value){value.imageName===res.data.thumbnail.thumbnailFileName&&($scope.imageUrlName=value.imageName,$scope.imageUrlValue=value.image)}),$scope.imageUrlName===res.data.thumbnail.thumbnailFileName?$scope.thumbnailMainIcon=$scope.imageUrlValue:$scope.thumbnailMainIcon=res.data.thumbnailURL,$scope.defaultThumbnailIcon&&$scope.defaultThumbnailIcon.iconName&&$scope.defaultThumbnailIcon.iconName===res.data.thumbnail.thumbnailFileName&&($scope.thumbnailMainIcon=$scope.defaultThumbnailIcon.name)}else $scope.thumbnailMainIcon=res.data.thumbnailURL;res.data&&res.data.storeVisibility&&res.data.storeVisibility.namespace&&($scope.newStreamData.storeVisibility=res.data.storeVisibility,$scope.selectedVisibilty=_.find($scope.visibilityOptions,{key:res.data.storeVisibility.namespace}))}})},$scope.callback.loadGeneralSettings=function(){$("#noty_center_layout_container").empty();var loader;$scope.streamId=$workflowService.selectedStream()._id,$workflowService.selectedStream()._id&&$scope.loadSavedConfigSettings(loader)},$scope.callback.loadGeneralSettings(),$scope.callback.saveSuccess=!1,$scope.$watch("callback.saveSuccess",function(newVal,oldVal){$timeout(function(){$scope.callback.saveSuccess=!1},1e3)}),$scope.callback.saveInprogress=!1,$scope.validateTeamShare=function(){if($scope.myTeams){var selectedTeamCount=0;return $scope.myTeams.forEach(function(team){team.selected&&selectedTeamCount++}),selectedTeamCount>0?!0:!1}return!1};var preparePaylodUseCases=function(useCases){var addedUseCases=[];return _.forEach(useCases,function(usecase,i){var foundIndex=_.findIndex($scope.categories,function(category){return category.name===usecase.text?!0:void 0});-1!==foundIndex&&addedUseCases.push($scope.categories[foundIndex])}),addedUseCases},scrollToElement=function(id){var elementOffset=$("#"+id).offset().top,_container=$(".innerRight"),scrollHeight=elementOffset-_container.offset().top+_container.scrollTop();setTimeout(function(){$(".innerRight").animate({scrollTop:scrollHeight})},500)};$scope.callback.formInvalid=!1,$scope.callback.createStream=function(event){if($scope.onSubmit=!0,event&&event.preventDefault&&event.preventDefault(),!$scope.isFormValid($scope.botStoreSettingsForm)&&(form_util.touch($scope.botStoreSettingsForm),$scope.callback.formInvalid=!0,$scope.newStreamData&&!$scope.newStreamData.name||$scope.newStreamData&&!$scope.newStreamData.description))return void scrollToElement("name");if($scope.newStreamData.hasOwnProperty("overview")&&""===$scope.newStreamData.overview&&!$scope.newStreamData.overview.length||void 0===$scope.newStreamData.overview)return void scrollToElement("overview");if($scope.newStreamData&&!$scope.newStreamData.domainId)return void scrollToElement("domain");if($scope.newStreamData&&!$scope.newStreamData.complexity)return void scrollToElement("complexity");if(!($scope.context&&$scope.context.features&&$scope.context.features.length))return void scrollToElement("features");if($scope.newStreamData.features=_.pluck($scope.context.features,"text"),!($scope.context&&$scope.context.supportedProducts&&$scope.context.supportedProducts.length))return void scrollToElement("products");if($scope.newStreamData.supportedProducts=_.pluck($scope.context.supportedProducts,"text"),$scope.newStreamData.supportedProducts=_.map($scope.newStreamData.supportedProducts,function(product){return product=product.split(" ").join("-")}),!$scope.newStreamData.icon||$scope.newStreamData.hasOwnProperty("icon")&&""===$scope.newStreamData.icon.iconName&&!$scope.newStreamData.icon.iconName.length)return $scope.iconRequiredError=!0,void scrollToElement("icon");if(!($scope.newStreamData.solutionBotSettings.configInstURL&&$scope.newStreamData.solutionBotSettings.configInstURL.length||$scope.newStreamData.instructionsFile&&$scope.newStreamData.instructionsFile.configInstFileName))return NotificationService.notify(i18n.i18nString("provide_either_instdoc"),"error"),void scrollToElement("configInst");if(!($scope.newStreamData.solutionBotSettings.configInstURL&&$scope.newStreamData.solutionBotSettings.configInstURL.length||$scope.newStreamData.instructionsFile&&$scope.newStreamData.instructionsFile.configInstFileName))return void NotificationService.notify("Configuration Instruction or Url is required","error");$scope.context&&$scope.context.features&&($scope.newStreamData.features=_.pluck($scope.context.features,"text")),$scope.context&&$scope.context.useCases&&($scope.newStreamData.addedUseCases=preparePaylodUseCases($scope.context.useCases)),$scope.callback.formInvalid=!1;var btPostData={};btPostData.overview=$scope.newStreamData.overview,btPostData.complexity=$scope.newStreamData.complexity,btPostData.supportedProducts=$scope.newStreamData.supportedProducts,btPostData.features=$scope.newStreamData.features,btPostData.integrations=$scope.newStreamData.integrations,btPostData.homePageUrl=$scope.newStreamData.homePageUrl,btPostData.helpUrl=$scope.newStreamData.helpUrl,btPostData.keywords=$scope.newStreamData.keywords?$scope.newStreamData.keywords.split(","):[],btPostData.sBannerColor=$scope.newStreamData.sBannerColor?$scope.newStreamData.sBannerColor:$scope.newStreamData.color,btPostData.icon=$scope.newStreamData.icon.fileId,btPostData.specificationDocument=$scope.newStreamData.specificationDocument,btPostData.iconName=$scope.newStreamData.icon.iconName,btPostData.configInstFileName=$scope.newStreamData.instructionsFile.configInstFileName,btPostData.demoVideoLink=$scope.newStreamData.demoVideoLink,btPostData.features=$scope.newStreamData.features,btPostData.domainId=$scope.newStreamData.domainId,btPostData.storeVisibility=$scope.newStreamData.storeVisibility,btPostData.useCases=$scope.newStreamData.addedUseCases,btPostData.bannerGraphics=$scope.newStreamData.bannerGraphics,btPostData.thumbnail={},$scope.newStreamData.thumbnail&&$scope.newStreamData.thumbnail.fileId?(btPostData.thumbnail.fileId=$scope.newStreamData.thumbnail.fileId,btPostData.thumbnail.thumbnailFileName=$scope.newStreamData.thumbnail.iconName):"undefined"!=typeof $scope.newStreamData.thumbnail&&Object.keys($scope.newStreamData.thumbnail)||($scope.thumbnailIcon=$scope.defaultThumbnailIcon,$scope.thumbnailIcon.iconName=$scope.thumbnailIcon.name.substring($scope.thumbnailIcon.name.lastIndexOf("/")+1,$scope.thumbnailIcon.name.length),$scope.defaultThumbnailIcon.iconName=$scope.thumbnailIcon.iconName,$scope.uploadThumbailIcon($scope.defaultThumbnailIcon,"fromModal")),"image"===$scope.newStreamData.bannerGraphics&&(btPostData.botBanner=$scope.newStreamData.botBanner),btPostData.promoteInStore=$scope.newStreamData.promoteInStore?$scope.newStreamData.promoteInStore:!1,btPostData.solutionBotSettings={},btPostData.solutionBotSettings.botDesc=$scope.newStreamData.solutionBotSettings.botDesc,btPostData.solutionBotSettings.configInstURL=$scope.newStreamData.solutionBotSettings.configInstURL,btPostData.solutionBotSettings.configInstFileId=$scope.newStreamData.instructionsFile.fileId,btPostData.botStoreDetails={},btPostData.botStoreDetails.botTitle=$scope.newStreamData.name,btPostData.botStoreDetails.botDescription=$scope.newStreamData.description,$scope.callback.saveInprogress=!0,$scope.$emit("savingInprogress",!0),setTimeout(function(){$scope.newStreamData.thumbnail&&$scope.newStreamData.thumbnail.fileId&&(btPostData.thumbnail.fileId=$scope.newStreamData.thumbnail.fileId,btPostData.thumbnail.thumbnailFileName=$scope.newStreamData.thumbnail.iconName),BTStreamsService.updateBotConfigurations($workflowService.selectedStream()._id,btPostData).then(function(res){if(res){$scope.callback.saveInprogress=!1,$scope.$emit("savingInprogress",!1),$workflowService.selectedStream(angular.extend({},$scope.stream,res.data)),NotificationService.notify(i18n.i18nString("settings_saved"),"success"),$scope.onSubmit=!1,$scope.newStreamData={name:res.data.name,description:res.data.description,domainName:res.data.domain,demoVideoLink:res.data.demoVideoLink,helpUrl:res.data.helpUrl,homePageUrl:res.data.homePageUrl,color:res.data.color,keywords:res.data.keywords&&res.data.keywords.length>0?res.data.keywords.join(","):null,overview:res.data.overview,integrations:res.data.integrations,bannerGraphics:res.data.bannerGraphics,specificationDocument:res.data.specificationDocument,complexity:res.data.complexity,features:res.data.features,supportedProducts:res.data.supportedProducts,storeVisibility:res.data.storeVisibility,thumbnail:res.data.thumbnail},$scope.integrationCopy=JSON.parse(JSON.stringify($scope.newStreamData.integrations));var _addedIntegrations=_.pluck($scope.newStreamData.integrations,"name");if($scope.integrationListCopy=_.filter($scope.botIntegrations,function(integration){return-1==_addedIntegrations.indexOf(integration.name)?integration:void 0}),$scope.newStreamData.solutionBotSettings={},$scope.newStreamData.instructionsFile={},res.data.solutionBotSettings&&($scope.newStreamData.solutionBotSettings.botDesc=res.data.solutionBotSettings.botDesc,$scope.newStreamData.solutionBotSettings.configInstURL=res.data.solutionBotSettings.configInstURL,$scope.newStreamData.solutionBotSettings.configInstFileId=res.data.solutionBotSettings.configInstFileId,$scope.newStreamData.instructionsFile.fileId=res.data.solutionBotSettings.configInstFileId,$scope.newStreamData.instructionsFile.configInstFileName=res.data.configInstFileName),res.data.icon&&($scope.newStreamData.icon={},$scope.newStreamData.icon.iconName=res.data.iconName?res.data.iconName:"",$scope.newStreamData.icon.fileId=res.data.icon),res.data&&res.data.botStoreDetails&&($scope.newStreamData.name=res.data.botStoreDetails.botTitle,$scope.newStreamData.description=res.data.botStoreDetails.botDescription),$scope.multiMediaList=res.data.demoVideoLink?res.data.demoVideoLink:[],"image"===res.data.bannerGraphics&&($scope.newStreamData.botBanner=res.data.botBanner?res.data.botBanner:{}),$scope.newStreamData.promoteInStore=res.data.promoteInStore?res.data.promoteInStore:!1,res.data.complexity&&($scope.complexity.name=res.data.complexity),res.data.domainId){var result=_.find($scope.categories,{_id:res.data.domainId});result&&($scope.newStreamData.domainId=result._id,$scope.selectedDomain.domain=result)}res.data.features&&($scope.context.features=[],_.map(res.data.features,function(feature){$scope.context.features.push({text:feature})})),res.data.supportedProducts&&($scope.context.supportedProducts=[],_.map(res.data.supportedProducts,function(product){product=product.split("-").join(" "),$scope.context.supportedProducts.push({text:product})}))}},function(err){err&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})},2500)},$scope.uploadStreamIcon=function(){if($scope.newStreamData.iconFile.name){var _ext=$scope.newStreamData.iconFile.name.substring($scope.newStreamData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.fileUploaders.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.iconFile.name,fileId:response.data.fileId};$scope.newStreamData.icon=fileUploaded,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:fileUploaded.fileName}),"success"),$scope.fileUploaders.iconUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.fileUploaders.iconUploading=!1})},$scope.deleteStreamIcon=function(){$scope.newStreamData.iconFile=null,$scope.newStreamData.icon=null,$("#iconFile").val("")},$scope.uploadLargeStreamBanner=function(){if($scope.newStreamData.bigBannerFile.name){var _ext=$scope.newStreamData.bigBannerFile.name.substring($scope.newStreamData.bigBannerFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bBfileExtensionError=!0)}$scope.bBfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.bigBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.bigBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.bigBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.bBanner=fileUploaded,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:fileUploaded.fileName}),"success"),$scope.bigBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.bigBannerUploading=!1})},$scope.deleteStreamBBanner=function(){$scope.newStreamData.bigBannerFile=null,$scope.newStreamData.bBanner=null,$("#bigBannerFile").val("")},$scope.uploadSmallStreamBanner=function(){if($scope.newStreamData.smBannerFile.name){var _ext=$scope.newStreamData.smBannerFile.name.substring($scope.newStreamData.smBannerFile.name.lastIndexOf("."));if(".png"!==_ext&&".PNG"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bSfileExtensionError=!0)}$scope.bSfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.smBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.smBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.smBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.sBanner=fileUploaded,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:fileUploaded.fileName}),"success"),$scope.smBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.smBannerUploading=!1})},$scope.deleteStreamSBanner=function(){$scope.newStreamData.smBannerFile=null,$scope.newStreamData.sBanner=null,$("#smBannerFile").val("")},$scope.onStreamFormCancel=function(){"edit"===$scope.displayMode?$location.path(window.appConfig.CONTEXT_PATH):($scope.newStreamData={},$scope.onCancel())},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.clearTenancy=function(){$scope.newStreamData.defaultUrl="",$scope.newStreamData.helpHint=""},$scope.goBack=function(){$scope.onBack()},$scope.clearTeams=function(){$scope.myTeams.map(function(team){team.selected=!1})};$scope.isFormValid=function(form){return!(form.$invalid||$scope.newStreamData.sharing&&$scope.newStreamData.sharing.team&&!$scope.validateTeamShare())},$scope.$on("evt:exitAct",function(evt,data){$scope.streamForm.$valid?$scope.callback.createStream(!0):NotificationService.notify(i18n.i18nString("enter_valid_data"),"error")}),$scope.advancedoptiontext="Show Advanced Options",$scope.showAdvancedOptions=function(){$scope.showadvancedoptions?($scope.showadvancedoptions=!1,$scope.advancedoptiontext="Show Advanced Options",$("#advancedoptdivStream .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showadvancedoptions=!0,$scope.advancedoptiontext="Hide Advanced Options",$("#advancedoptdivStream .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"))},$scope.highlightThumbnail=!1,$scope.getFileId=function(fileId){BTStreamsService.downloadImageExportFile(fileId).then(function(res){res&&res.data&&($scope.thumbnailMainIcon=res.data.fileUrl)},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")})};var getFileBlob=function(url,cb){var xhr=new XMLHttpRequest;xhr.open("GET",url),xhr.responseType="blob",xhr.addEventListener("load",function(){cb(xhr.response)}),xhr.send()},blobToFile=function(blob,name){return blob.lastModifiedDate=new Date,blob.name=name,blob},getFileObject=function(filePathOrUrl,cb){var imageName=filePathOrUrl.substring(filePathOrUrl.lastIndexOf("/")+1,filePathOrUrl.length);getFileBlob(filePathOrUrl,function(blob){cb(blobToFile(blob,imageName))})};$scope.uploadThumbailIcon=function(image,fromModal){_.forEach($scope.imageUrl,function(image){image.active=!1}),image.active=!0;var url;url=env_conf["components-source"],getFileObject(url+image.uploadPath,function(fileObject){fromModal?$scope.saveThumbnailValues(fileObject):$scope.thumbnailIcon=fileObject,console.log(fileObject)})},$scope.saveThumbnailValues=function(fileObject){if($scope.saving=!0,fileObject&&($scope.thumbnailIcon=fileObject),$scope.thumbnailIcon&&$scope.thumbnailIcon.name){var data=new FormData;data.append("file",$scope.thumbnailIcon),data.append("fileContext","marketplace");var _ext=$scope.thumbnailIcon.name.substring($scope.thumbnailIcon.name.lastIndexOf("."));".png"===_ext.toLowerCase()?data.append("fileExtension","png"):data.append("fileExtension","svg"),$scope.fileUploaders.botIconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){$scope.showThumbnailFooter=!0,$scope.saving=!1;var fileUploaded={};fileUploaded=$scope.thumbnailIcon.iconName?{iconName:$scope.thumbnailIcon.iconName,fileId:response.data.fileId}:{iconName:$scope.thumbnailIcon.name,fileId:response.data.fileId},$scope.uploadThumbnail=!0,$scope.newStreamData.thumbnail=fileUploaded,$scope.fileUploaders.botIconUploading=!1,$scope.getFileId(response.data.fileId),$("#thumbnailCustomIcons").modal("hide"),NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:fileUploaded.iconName}),"success")},function(error){error&&error.data.errors&&($scope.fileUploaders.botIconUploading=!1,NotificationService.notify(i18n.i18nString(error.data.errors[0].msg),"error"))})}},$scope.resetThumbnail=function(){$scope.showFileUploadThumbnail=!0,$scope.thumbnailImage="",$scope.showResetOption=!1,$scope.showThumbnailFooter=!1},$scope.uploadThumbailBotIcon=function(){if($scope.file=botIcon1.files,$scope.file&&$scope.file.length&&$scope.file[0]&&($scope.profileImgLinkPrefix=URL.createObjectURL($scope.file[0])),$scope.thumbnailImage&&$scope.thumbnailImage.name){var _ext=$scope.thumbnailImage.name.substring($scope.thumbnailImage.name.lastIndexOf("."));if(".png"!==_ext.toLowerCase())return void($scope.showErrorThumbnail=!0);$scope.showResetOption=!0,$scope.showFileUploadThumbnail=!1,$scope.showThumbnailFooter=!0}botIcon1.value&&(botIcon1.value="")},$scope.uploadBotIcon=function(){if($scope.icon&&$scope.icon.name){var _ext=$scope.icon.name.substring($scope.icon.name.lastIndexOf("."));if(".png"!==_ext.toLowerCase())return void NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error");$scope.iconUploading=!0;var data=new FormData;data.append("file",$scope.icon),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.fileUploaders.botIconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={iconName:$scope.icon.name,fileId:response.data.fileId};$scope.iconUploading=!1,$scope.newStreamData.icon=fileUploaded,$scope.fileUploaders.botIconUploading=!1,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:fileUploaded.iconName}),"success")},function(error){error&&error.data.errors&&($scope.fileUploaders.botIconUploading=!1,NotificationService.notify(i18n.i18nString(error.data.errors[0].msg),"error"))})}},$scope.uploadBotBanner=function(){if($scope.botBanner&&$scope.botBanner.name){var _ext=$scope.botBanner.name.substring($scope.botBanner.name.lastIndexOf("."));if(".png"!==_ext.toLowerCase())return void NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error");$scope.botBannerUploading=!0,$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.botBanner),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.fileUploaders.botBanner=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={bannerFileName:$scope.botBanner.name,fileId:response.data.fileId};$scope.botBannerUploading=!1,$scope.newStreamData.botBanner=fileUploaded,NotificationService.notify(fileUploaded.bannerFileName+i18n.i18nString("uploaded_label"),"success"),$scope.fileUploaders.botBanner=!1},function(err){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.fileUploaders.botBanner=!1})}},$scope.instructionDocument=function(){if($scope.instructionsFile.name){var _ext=$scope.instructionsFile.name.substring($scope.instructionsFile.name.lastIndexOf("."));if(".pdf"!==_ext)return NotificationService.notify(i18n.i18nString("upload_only_pdf_files"),"error"),void($scope.fileExtensionError=!0)}$scope.instructiondocumentUploading=!0,$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.instructionsFile),data.append("fileContext","bulkImport"),data.append("fileExtension","pdf"),$scope.fileUploaders.instructionDocument=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={configInstFileName:$scope.instructionsFile.name,fileId:response.data.fileId};$scope.instructiondocumentUploading=!1,$scope.newStreamData.instructionsFile=fileUploaded,NotificationService.notify(fileUploaded.configInstFileName+i18n.i18nString("uploaded_label"),"success"),$scope.fileUploaders.instructionDocument=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.fileUploaders.instructionDocument=!1})},$scope.uploadSpecificationDocument=function(){if($scope.specificationDocument.name){var _ext=$scope.specificationDocument.name.substring($scope.specificationDocument.name.lastIndexOf("."));if(".pdf"!==_ext)return NotificationService.notify(i18n.i18nString("upload_only_pdf_files"),"error"),void($scope.fileExtensionError=!0)}$scope.specificdocumentUploading=!0,$scope.fileExtensionError=!1;var data=new FormData;
data.append("file",$scope.specificationDocument),data.append("fileContext","bulkImport"),data.append("fileExtension","pdf"),$scope.fileUploaders.specificationDocument=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={specDocumentInstFileName:$scope.specificationDocument.name,specDocumentInstFileId:response.data.fileId};$scope.specificdocumentUploading=!1,$scope.newStreamData.specificationDocument=fileUploaded,NotificationService.notify(fileUploaded.specDocumentInstFileName+i18n.i18nString("uploaded_label"),"success"),$scope.fileUploaders.specificationDocument=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.fileUploaders.specificationDocument=!1})},$scope.deleteBotIcon=function(){$scope.newStreamData.icon={},$scope.icon={},$("#botIcon").val("")},$scope.deleteBotBanner=function(){$scope.newStreamData.botBanner={},$scope.botBanner={},$("#botBanner").val("")},$scope.deletespecificationDocument=function(){$scope.newStreamData.specificationDocument={},$scope.specificationDocument={},$("#specificationDocument").val("")},$scope.deleteinstructionsFile=function(){$scope.newStreamData.instructionsFile={},$scope.instructionsFile={},$("#instructionDocument").val("")},$scope.selectDomain=function(domain){$scope.selectedDomain.domain=domain,$scope.newStreamData.domainId=domain._id},$scope.selectComplexity=function(complexityLevel){$scope.complexity.name=complexityLevel,$scope.newStreamData.complexity=complexityLevel},$scope.removeBotProduct=function(){$scope.newStreamData.supportedProducts=_.pluck($scope.context.supportedProducts,"text")},$scope.removeBotFeatures=function(){$scope.newStreamData.features=_.pluck($scope.context.features,"text")};var debounceES5=function(func,timeout){var debounceTimer=null;return function(){var context=this,args=arguments;clearTimeout(debounceTimer),debounceTimer=setTimeout(func.apply(context,args),timeout)}};$scope.addToIntegration=function(integration){var _foundIndex=_.findIndex($scope.integrationCopy,{name:integration.name});if(-1!==_foundIndex)return void NotificationService.notify("Bot Integration exists","error");$scope.integrationCopy.push(integration),_.remove($scope.integrationListCopy,{name:integration.name});var _payload={integrations:$scope.integrationCopy};BTStreamsService.updateBotConfigurations($workflowService.selectedStream()._id,_payload).then(function(response){NotificationService.notify(i18n.i18nString("integration_success"),"success"),$scope.newStreamData.integrations=response.data.integrations})},$scope.searchIntegrationList=function(searchText){function searchIntegration(){var _addedIntegrations=_.pluck($scope.newStreamData.integrations,"name");searchText&&searchText.length?$scope.integrationListCopy=_.filter($scope.botIntegrations,function(integration){var _expTask=new RegExp(searchText,"i"),searchResult=_expTask.test(integration.name);return searchResult&&-1==_addedIntegrations.indexOf(integration.name)?integration:void 0}):$scope.integrationListCopy=_.filter($scope.botIntegrations,function(integration){return-1==_addedIntegrations.indexOf(integration.name)?integration:void 0})}debounceES5(searchIntegration,500)()},$scope.addIntegrationModal=function(){$("#newIntegration").modal("show")},$scope.closeSearch=function(){$scope.search.configText="",$scope.searchIntegrationList($scope.search.configText)},$scope.uploadSmallStreamBanner=function(){if($scope.newStreamData.smBannerFile.name){var _ext=$scope.newStreamData.smBannerFile.name.substring($scope.newStreamData.smBannerFile.name.lastIndexOf("."));if(".png"!==_ext&&".PNG"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bSfileExtensionError=!0)}$scope.bSfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.smBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.smBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.smBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.sBanner=fileUploaded,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:fileUploaded.fileName}),"success"),$scope.smBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.smBannerUploading=!1})},$scope.uploadIntegrationIcon=function(){if($scope.newIntegration.integrationIcon.name){var _ext=$scope.newIntegration.integrationIcon.name.substring($scope.newIntegration.integrationIcon.name.lastIndexOf("."));if(".png"!==_ext&&".PNG"!==_ext)return void NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error")}var data=new FormData;data.append("file",$scope.newIntegration.integrationIcon),data.append("fileContext","marketplace"),data.append("fileExtension","png"),BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={name:$scope.newIntegration.integrationIcon.name,integrationFileId:response.data.fileId};$scope.newIntegration.integrationIcon=fileUploaded,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:fileUploaded.name}),"success")},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error")})},$scope.addToIntegrationList=function(integration){var result=$scope.botIntegrations.find(function(integrat){return integrat.name.toLowerCase()===integration.name.toLowerCase()?!0:void 0});if(result)return void NotificationService.notify("Integration already exists","error");$scope.newStreamData.integrations||($scope.newStreamData.integrations=[]),$scope.newStreamData.integrations.push({name:integration.name,integrationFileId:integration.integrationIcon.integrationFileId});var _payload={integrations:$scope.newStreamData.integrations};BTStreamsService.updateBotConfigurations($workflowService.selectedStream()._id,_payload).then(function(response){NotificationService.notify(i18n.i18nString("integration_success"),"success"),$scope.newStreamData.integrations=response.data.integrations,$scope.integrationCopy=JSON.parse(JSON.stringify(response.data.integrations)),$scope.integration=JSON.parse(JSON.stringify(response.data.integrations));var _foundIndex=_.findIndex($scope.newStreamData.integrations,{name:integration.name});if(_foundIndex){var botNewIntegration=$scope.newStreamData.integrations[_foundIndex];$scope.botIntegrations.push(botNewIntegration),$scope.integrationListCopy=JSON.parse(JSON.stringify($scope.botIntegrations))}$scope.closeIntegrationModal()})},$scope.closeIntegrationModal=function(){$scope.deleteIntegrationIcon(),$scope.newIntegration&&$scope.newIntegration.name&&($scope.newIntegration.name=""),$("#newIntegration").modal("hide")},$scope.deleteIntegrationIcon=function(){$scope.newIntegration&&$scope.newIntegration.integrationIcon&&($scope.newIntegration.integrationIcon={})},$scope.deleteIntegration=function(index){NotificationService.alert("Do you want to delete the integration",function(){$scope.newStreamData.integrations.splice(index,1);var _payload={integrations:$scope.newStreamData.integrations};BTStreamsService.updateBotConfigurations($workflowService.selectedStream()._id,_payload).then(function(res){$("#newIntegration").modal("hide"),NotificationService.notify(i18n.i18nString("integration_deleted_success"),"success"),$scope.newStreamData.integrations=res.data.integrations,$scope.integrationCopy=JSON.parse(JSON.stringify($scope.newStreamData.integrations));var _addedIntegrations=_.pluck($scope.newStreamData.integrations,"name");$scope.integrationListCopy=_.filter($scope.botIntegrations,function(integration){return-1==_addedIntegrations.indexOf(integration.name)?integration:void 0})},function(errRes){console.log("Failed deleting bot integrations")})},{okText:i18n.i18nString("ok")})},$scope.addMedia=function(form,videoLink){!form.videoLink.$invalid&&videoLink&&videoLink.length&&$scope.multiMediaList.length+1<=5&&(-1!==$scope.multiMediaList.indexOf(videoLink)?NotificationService.notify(i18n.i18nString("video_link_exists"),"error"):($scope.multiMediaList.push(videoLink),$scope.videoLink="",$scope.newStreamData.demoVideoLink=$scope.multiMediaList))},$scope.deleteMediaFile=function(index){$scope.multiMediaList.splice(index,1)},$scope.setVisibility=function(visibility){$scope.visibility=visibility,$scope.newStreamData.storeVisibility={},$scope.newStreamData.storeVisibility.namespace=visibility.key,"private"===$scope.newStreamData.storeVisibility.namespace?$scope.newStreamData.storeVisibility.namespaceIds=[$applicationService.userInfo().userId]:$scope.newStreamData.storeVisibility.namespaceIds=[],$scope.selectedVisibilty=visibility},$scope.validateBotName=function(){var regexpObject=patternFactory.getRegularExpression("stream"),regexp=regexpObject.regexp,regexp2=regexpObject.regexp2;return{test:function(value){return value&&1===value.length?regexp2.test(value):regexp.test(value)}}}(),$scope.$emit("nestedComponentLoaded",{id:"botStoreSettings",flag:!1}),$scope.validateYoutubeURL=function(){return{test:function(uri){var p=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return uri.match(p)?!0:!1}}}()}]}})}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("botUserShare",function(){return{restrict:"EA",scope:{callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/bot-usershare-form.html",controller:["$scope","$workflowService","BTStreamsService","$rootScope","NotificationService","$location","$endpoints","$applicationService","env_conf","accessControlService","$timeout","i18n","mixPanel",function($scope,$workflowService,BTStreamsService,$rootScope,NotificationService,$location,$endpoints,$applicationService,env_conf,accessControlService,$timeout,i18n,mixPanel){function loadUsers(){_.isArray($scope.codevelopers)&&_.isArray($scope.contacts)&&($scope.users=[],$scope.codevelopers.map(function(developer){$scope.contacts.map(function(contact){developer==contact._id&&(contact.fullName=contact.fullName||contact.firstName+" "+contact.lastName,$scope.users.push(angular.copy(contact)))})}))}function checkForDoneButton(){var codevelopers=[];$scope.contacts.map(function(contact){contact.isAdded&&codevelopers.push(contact._id)}),codevelopers.length?$scope.doneDisabled=!1:$scope.doneDisabled=!0}function prepareTaskListObject(permissions){var referenceObject=angular.copy($scope.completePermissionList);return referenceObject.forEach(function(component,index){var permissionKeys=Object.keys(permissions),result=permissionKeys.find(function(element,index){return element===component._id});result&&(component.operations=permissions[result])}),console.log(referenceObject),referenceObject}function loadContacts(){return $scope.loadingUser=!0,$scope.contacts=[],$scope.stream._id?void BTStreamsService.getContacts($scope.stream._id).then(function(res){var availableDevolpers=angular.copy($scope.codevelopers.users);res.data.map(function(contact){contact.isDeveloper&&"active"===contact.accountInfo.activationStatus&&$scope.contacts.push({_id:contact._id,fullName:contact.personalInfo.fullName,firstName:contact.personalInfo.firstName,lastName:contact.personalInfo.lastName,profColor:contact.accountInfo.profColour,profImage:contact.accountInfo.profImage,emailId:contact.orgDomain,jTitle:contact.accountInfo.jTitle,url:$scope.profileUrl.replace(":userId",contact._id),isAdded:-1!=availableDevolpers.map(function(developer){return developer._id}).indexOf(contact._id)})},function(error){$scope.loadingUser=!1}),$scope.usersList=$scope.contacts,$scope.loadingUser=!1}):void($scope.loadingUser=!1)}function loadRoles(){BTStreamsService.getRoles($scope.loggedInUserID,$scope.stream._id,$scope.organisationId).then(function(response){$scope.roles=response.data,$scope.changeownerList=$scope.roles.filter(function(value,index){return"Bot Owner"!==value.role}),$scope.defaultRole.role_id=$scope.changeownerList[0]._id})}function goToHome(){$rootScope.$emit("selectBot",$scope.stream)}function validateEmail(email){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(String(email).toLowerCase())}function initAutocomplete(){$("#advanceShareInput").autocomplete({minLength:2,source:function(request,response){var item;return response(function(){var i,len,ref,results,_users=angular.copy($scope.usersList);for(_users=_users.filter(function(contact){return!contact.isAdded}),ref=_users.map(function(a){return a&&(a.fullName+" ("+a.emailId||a.description+")")}),ref=ref.filter(function(element){return void 0!==element}),results=[],i=0,len=ref.length;len>i;i++)item=ref[i],-1!==item.toLowerCase().indexOf(request.term.toLowerCase())&&results.push(item);return results}())},highlight:!0,focus:function(_this){}(this),select:function(_this){return function(event,ui){var _str=ui.item.value;if(0!==_str.length){_str=_str.match(/\(([^)]+)\)/)[1].trim(),$scope.selectedContacts.selectedUsers=_.uniq($scope.selectedContacts.selectedUsers);for(var i=0;i<$scope.selectedContacts.selectedUsers.length;i++)if($scope.selectedContacts.selectedUsers[i].emailId===_str)return void(ui.item.value="");var _contact=$scope.usersList.filter(function(contact){return contact.emailId===_str});_contact&&_contact[0]&&($scope.selectedContacts.selectedUsers.push(_contact[0]),ui.item.value="")}}}(this)}).autocomplete("widget").addClass("contactsDropdown")}$scope.parentDisplayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_DEVELOPERS"),$scope.doneDisabled=!0,$scope.stream=$workflowService.selectedStream(),$scope.profileUrl=$endpoints.SERVER_URL+"/api/1.1/getMediaStream/profilePictures/:userId/r_64x64_profile.png",$scope.botOwner={},$scope.assetsBase=env_conf["assets-url"],$scope.callback=$scope.callback||{},$scope.callback.enable=!0,$scope.showAdvanced=!1,$scope.rightClass="right500",$scope.roles={},$scope.groupcb={users:{}},$scope.codevelopers={},$scope.codevelopers.users=[],$scope.codevelopers.groups=[],$scope.completePermissionList={},$scope.groups=[],$scope.changeownerList=[],$scope.group={},$scope.users=[],$scope.changeowner={},$scope.promoteUser={},$scope.shareDevelopersList=[],$scope.defaultRole={},$scope.bot_owner=i18n.i18nString("bot_owner"),$scope.regular_user=i18n.i18nString("regular_user"),$scope.brokenImageSmall=env_conf["context-url"]+"/assets/images/brokenImageSmall.png",$scope.group.selectedGroup=[],angular.element(".dropdown-toggle").dropdown(),_.isObject($scope.stream)&&Object.keys($scope.stream).length>0||$location.path(window.appConfig.CONTEXT_PATH),$scope.currentPage=1,console.log("applicationService",$applicationService.userInfo()),$scope.loggedInUserID=$applicationService.userInfo().userId,$scope.organisationId=$applicationService.userInfo().orgId,$scope.isEligibleToManageBot=function(stream){var createdBy=_.isObject(stream.createdBy)?stream.createdBy._id:stream.createdBy;return $rootScope.isManaged&&$applicationService.userInfo().userId===createdBy},$scope.callback.loadBotOwner=function(){$scope.stream=$workflowService.selectedStream(),BTStreamsService.getUserInfo(_.isObject($scope.stream.createdBy)?$scope.stream.createdBy._id:$scope.stream.createdBy).then(function(res){res.data.length>0?($scope.botOwner=res.data[0],$scope.botOwner.fullName=$scope.botOwner.firstName+" "+$scope.botOwner.lastName):$scope.botOwner={}},function(err){$scope.botOwner={}})},$scope.callback.loadBotOwner(),$scope.callback.loadCoDevelopers=function(){$scope.loading=!0,BTStreamsService.getCodevelopers($scope.loggedInUserID,$scope.stream._id).then(function(response){$scope.codevelopers.users=response.data.users,$scope.codevelopers.groups=response.data.groups,$scope.$emit("updateBotData",{updateKey:"codevelopers",value:response.data.users||[]}),$scope.codevelopers.users=(response.data.users||[]).map(function(developer){return _.isObject(developer)?developer:null}).filter(function(developer){return developer}),angular.forEach($scope.codevelopers.users,function(component,index){var result=_.find(component.roleInfo,{role:"Bot Owner"});if(result)return void($scope.currownerRoleId=result._id);var sharedevelopers=$scope.codevelopers.users.filter(function(component){return"Bot Owner"!==component.roleInfo[0].role});$scope.shareDevelopersList=_.uniq(sharedevelopers,"_id")}),angular.forEach($scope.codevelopers.groups,function(component,index){var result=_.find(component.roleInfo,{role:"Bot Owner"});return result?void($scope.currownerRoleId=result._id):void 0}),$scope.codevelopers.groups=(response.data.groups||[]).map(function(group){return _.isObject(group)?group:null}).filter(function(group){return group}),$scope.loading=!1},function(err){$scope.loading=!1})},$scope.callback.loadCoDevelopers(),$scope.users=[],$scope.contacts=[],$scope.usersList=[],$scope.selectedContacts={},$scope.selectedContacts.selectedUsers=[],$scope.$watch("codevelopers",function(newVal,oldVal){loadUsers()},!0),$scope.$watch("contacts",function(newVal,oldVal){loadUsers()},!0),$scope.selectContact=function(contact){contact.isAdded=!contact.isAdded,contact.isManullyAdded=!0,checkForDoneButton()},$scope.showingDevelopers=!1,$scope.addDeveloper=function(selectedgroupid,selectedusers,role_id){$scope.callback.inviteOtherDomainUser(null,{validateEmail:!0});var invalidEmailList=_.filter(selectedusers,{inValidEmail:!0});if(!selectedgroupid.length&&!selectedusers.length)return void NotificationService.notify(i18n.i18nString("bt_usershare_user_group_required"),"error");if(invalidEmailList&&invalidEmailList.length>0)return void NotificationService.notify(i18n.i18nString("bt_usershare_please_correct_the_invalid_email"),"error");var preparePayload={users:[],groups:[]};$scope.codevelopers.users.map(function(codeveloper){codeveloper._id?preparePayload.users.push({userId:codeveloper._id,roleId:codeveloper.roleInfo[0]._id}):codeveloper.otherDomain&&preparePayload.users.push({emailId:codeveloper.emailId,roleId:codeveloper.roleInfo[0]._id})}),$scope.codevelopers.groups.map(function(group){preparePayload.groups.push({groupId:group._id,roleId:group.roleInfo[0]._id})}),selectedusers.map(function(contact){contact._id?preparePayload.users.push({userId:contact._id,roleId:role_id}):contact.otherDomain&&preparePayload.users.push({emailId:contact.emailId,roleId:role_id})}),selectedgroupid.map(function(groupid){preparePayload.groups.push({groupId:groupid,roleId:role_id})});var payload={codevelopers:preparePayload};BTStreamsService.shareBot($scope.stream._id,payload).then(function(res){$scope.stream=_.merge($scope.stream,res.data),$workflowService.selectedStream($scope.stream),NotificationService.notify(i18n.i18nString("bt_usershare_shared_sucess"),"success"),$scope.closeDevolperList(),$scope.callback.loadCoDevelopers()},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bt_usershare_sharing_failed"),"error")})},$scope.callback.showDevolperList=function(){var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};mixPanel.postEvent("Share Bot",_botInfo),$scope.query="",$scope.openModalSlider("#inviteDeveloper"),BTStreamsService.getGroups($scope.loggedInUserID,$scope.stream._id,$scope.organisationId).then(function(response){$scope.groups=response.data}),setTimeout(function(){$("#tagInput").focus()},500),initAutocomplete(),$scope.showingDevelopers=!0;var availableDevolpers=angular.copy($scope.codevelopers.users);$scope.contacts.map(function(contact){contact.isAdded=-1!==availableDevolpers.map(function(developer){return developer._id}).indexOf(contact._id),contact.isManullyAdded=!1}),checkForDoneButton()},$scope.openSlider=function(user){$scope.openModalSlider("#editDeveloper"),$scope.userAccess=user,$scope.selectedRole=$scope.userAccess.roleInfo[0].role,BTStreamsService.getSharePermissions().then(function(response){$scope.completePermissionList=response.data}),$timeout(function(){$scope.permissions=$scope.userAccess.roleInfo[0].permissions,$scope.accessControls=prepareTaskListObject($scope.permissions)},500)},$scope.getPermissionsForRole=function(role){var result=_.find($scope.roles,{role:role});result&&BTStreamsService.getPermissionsForRole(result._id).then(function(response){$scope.accessControls=prepareTaskListObject(response.data.permissions)})},$scope.closeDevolperPermissions=function(){$scope.closeModalSlider("#editDeveloper")},$scope.closeDevolperList=function(){$scope.users=[],$scope.selectedContacts.selectedUsers=[],$scope.group.selectedGroup=[],$scope.query="",$scope.defaultRole.role_id=$scope.changeownerList[0]._id,$scope.closeModalSlider("#inviteDeveloper"),$(".myTabs").addClass("ps-active-y"),setTimeout(function(){$(".myTabs").animate({scrollTop:450},"slow")},300)},$scope.revokeAccess=function(user,index){var userId=user._id,userRoleId=user.roleInfo[0]._id,usersResult=$scope.codevelopers.users.filter(function(couser,i){var couserID=couser._id,couserRoleId=couser.roleInfo[0]._id;return couserID===userId&&couserRoleId===userRoleId?!1:!0}),groupResult=_.filter($scope.codevelopers.groups,function(cogroup){return cogroup._id!==user._id}),preparePayload={users:[],groups:[]};usersResult.map(function(developer){preparePayload.users.push({userId:developer._id,roleId:developer.roleInfo[0]._id})}),groupResult.map(function(group){preparePayload.groups.push({groupId:group._id,roleId:group.roleInfo[0]._id})});var payload={codevelopers:preparePayload};BTStreamsService.shareBot($scope.stream._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("bt_usershare_access_has_been_revoked_successfully"),"success"),loadContacts(),$scope.callback.loadCoDevelopers()},function(err){NotificationService.notify(i18n.i18nString("bt_usershare_revoking_failed"),"error")})};var reloadUserShareList=function(){$scope.callback.loadBotOwner(),$scope.callback.loadCoDevelopers()};$scope.promoteToOwner=function(usergrop,index){$scope.promoteUser=angular.copy(usergrop),$scope.promoteUser.fullName=$scope.getDisplayName(usergrop),$("#promoteowner").modal("show")},$scope.closePromoteOwner=function(){$("#promoteowner").modal("hide"),$scope.promoteUser={}},$scope.changeToOwner=function(){$("#changetoowner").modal("show")},$scope.closeChangeOwner=function(){$("#changetoowner").modal("hide"),$scope.changeowner={}},$scope.promoteOwnership=function(promoteowner){$scope.promoteownerformSave=!0;var payload={promoteuser:promoteowner._id,currOwnerRoleId:promoteowner.role_id};BTStreamsService.promoteToOwner($scope.stream._id,payload).then(function(res){$scope.promoteownerformSave=!1,$("#promoteowner").modal("hide"),NotificationService.notify(i18n.i18nString("bt_usershare_user_promoted_success"),"success"),$workflowService.selectedStream(res.data),$scope.$emit("streamUpdate"),reloadUserShareList(),setTimeout(function(){goToHome()},500)},function(err){NotificationService.notify(i18n.i18nString("bt_usershare_promoting_failed"),"error"),$("#promoteowner").modal("hide")})},$scope.changeOwnership=function(changeowner){$scope.changeOwnerformSave=!0;var payload={promoteuser:changeowner.user_id,currOwnerRoleId:changeowner.role_id};BTStreamsService.promoteToOwner($scope.stream._id,payload).then(function(res){$scope.changeOwnerformSave=!0,$("#changetoowner").modal("hide"),NotificationService.notify(i18n.i18nString("bt_usershare_changed_bot_owner_success"),"success"),$workflowService.selectedStream(res.data),$scope.$emit("streamUpdate"),reloadUserShareList(),setTimeout(function(){goToHome()},500)},function(err){$("#changetoowner").modal("hide"),NotificationService.notify(i18n.i18nString("bt_usershare_changing_bot_owner_failed"),"error"),403===err.status&&(reloadUserShareList(),setTimeout(function(){goToHome()},500))})},$scope.defaultRole={},loadContacts(),loadRoles(),$scope.getDisplayName=function(_contact){if(void 0!==_contact){if(_contact.gN||_contact.firstName&&_contact.lastName){var _str=_contact.gN?_contact.gN:_contact.firstName+" "+_contact.lastName;return _str}return _contact.gN||_contact.firstName&&_contact.lastName||!_contact.emailId?void 0:_contact.emailId}},$scope.getFirstLastName=function(_contact){if(_contact.gN||_contact.firstName&&_contact.lastName){var firstLetter=_contact.gN?_contact.gN.substr(0,2):_contact.firstName[0],lastLetter=_contact.lastName?_contact.lastName[0]:"";return firstLetter.concat(lastLetter).toUpperCase()}return _contact.gN||_contact.firstName&&_contact.lastName||!_contact.emailId?void 0:_contact.emailId.substr(0,2).toUpperCase()},$scope.getBotOwnerImageurl=function(user){var _owner=$scope.contacts.filter(function(contact){return contact._id===user._id});return _owner[0]&&_owner[0].url||""},$scope.deleteSelectedAdvancedContact=function(index){index>=0&&$scope.selectedContacts.selectedUsers&&$scope.selectedContacts.selectedUsers.length&&$scope.selectedContacts.selectedUsers.splice(index,1)},$scope.inviteOtherDomainUser=function(e){if(e&&13===e.keyCode){var _tagText=e.currentTarget.innerText.trim();if(0===_tagText.length)return void(e.currentTarget.innerText="");var _contact={emailId:_tagText.trim(),otherDomain:!0,inValidEmail:!validateEmail(_tagText)};$scope.selectedContacts.selectedUsers.push(_contact),$scope.selectedContacts.selectedUsers=_.uniq($scope.selectedContacts.selectedUsers),e.currentTarget.innerText=""}},$scope.deleteUser=function(codevelopers,index){var payload={};payload.users=[],payload.groups=[],codevelopers.users.splice(index,1),codevelopers.users.forEach(function(userComponent,index){payload.users.push({userId:userComponent._id,roleId:userComponent.roleInfo[0]._id})}),codevelopers.groups.forEach(function(groupComponent,index){payload.groups.push({groupId:groupComponent._id,roleId:groupComponent.roleInfo[0]._id})}),BTStreamsService.shareBot($scope.stream._id,payload).then(function(data){$scope.callback.loadCoDevelopers()})},$scope.disableInvite=function(){var _disable=!1;return $scope.selectedContacts.selectedUsers.forEach(function(_contact){_contact.otherDomain&&_contact.inValidEmail&&(_disable=!0)}),_disable},$scope.$emit("nestedComponentLoaded",{id:"developerShare",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}]}})}(angular),function(ng){var _module=ng.module("bt-forms");_module.directive("botVersion",function(){return{restrict:"EA",scope:{callback:"=",botVersionCb:"=",fullModalCallback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/bot-version/bot-version.html",controller:["$scope","_constants_","$workflowService","$location","$timeout","BTStreamsService","i18n","env_conf","form_util","$filter","$element","$rootScope","accessControlService","BTFlowtaskService",function($scope,_constants_,$workflowService,$location,$timeout,BTStreamsService,i18n,env_conf,form_util,$filter,$element,$rootScope,accessControlService,BTFlowtaskService){function removeValidations(form){for(var key in form)form.hasOwnProperty(key)&&-1===key.indexOf("$")&&(form[key].$dirty=!1)}function startPollExportStatus(timeout){return setInterval(function(){BTFlowtaskService.exportStatusBotVersion($scope.selectedStreamId).then(function(res){res&&res.data&&($rootScope.$broadcast("getProgressDockStatus"),"success"===res.data.status?($scope.exporttype=res.data.exportType.charAt(0).toUpperCase()+res.data.exportType.substr(1),$scope.downloadFlag=!1,$scope.createdOn=res.data.createdOn,$scope.downloadFileId=res.data.fileId,$scope.storeParams=res.data.store.urlParams,stopExportBotPolling("success")):"failed"===res.data.status&&(stopExportBotPolling("failed"),NotificationService.notify(i18n.i18nString("bot_export_version_failed"),"error")))},function(err){400==err.status&&$rootScope.$broadcast("getProgressDockStatus"),stopExportBotPolling();var _msg=i18n.i18nString("error_on_fetching_bot_export_version_status");err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(_msg,"error")})},timeout)}function stopExportBotPolling(_status){$scope._exportStatusInit&&(clearTimeout($scope._exportStatusInit),$scope._exportStatusInit=null),"success"===_status?finishedExport():$scope.exportStatus="failed"}function finishedExport(){$scope._exportStatusInit&&clearTimeout($scope._exportStatusInit),$scope.exportStatus="finished"}function checkForInheritance(){return $scope.selectedStream.sbStreamId&&$scope.selectedStream.allowInheritance?!0:!1}function startRestoreProgress(){$scope.totalProgress=0,progressInterval=setInterval(function(){$scope.totalProgress>90&&($scope.totalProgress=90),$scope.totalProgress+=.1},350)}function stopRestorePolling(){$scope._importStatusInit&&(clearTimeout($scope._importStatusInit),$scope._importStatusInit=null)}function startRestorePoll(statusId,timeout){return setInterval(function(){BTStreamsService.getRestoreStatus($scope.selectedStreamId,statusId).then(function(res){res&&res.data&&($scope.statusLogs=res.data.statusLogs||[],$scope.initializeScrollBar||(setTimeout(function(){$("#restoreModalProgress .modal-body").scrollTop(2)},100),$scope.initializeScrollBar=!0),"success"===res.data.status?(clearInterval(progressInterval),$scope.totalProgress=100,$scope.restoreVersionStatus="success",stopRestorePolling("success")):"failure"===res.data.status&&($scope.restoreVersionStatus="failure",clearInterval(progressInterval),stopRestorePolling("failed")))},function(err){clearInterval(progressInterval),stopRestorePolling(),err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})},timeout)}$scope.ellipsisDark=env_conf["context-url"]+"/assets/icons/overflow.svg",$scope.$emit("nestedComponentLoaded",{id:"botVersion",flag:!1}),$scope.sortBy="desc",$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.searchIcon=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.inspectingIcon=env_conf["context-url"]+"/assets/ontology/inspecting.svg",$scope.importingIcon=env_conf["context-url"]+"/assets/icons/importing.png",$scope.importSuccessIcon=env_conf["context-url"]+"/assets/icons/importsucess.png",$scope.reloadIcon=env_conf["context-url"]+"/assets/icons/icon-shape.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.emptyStateIcon_bot_versions=env_conf["context-url"]+"/assets/empty-state-images/empty-bot-versions.png",$scope.botVersionsList=[];var progressInterval=null;$scope.currentPage=1,$scope.itemsPerPage=10,$scope.limit=10,$scope.maxSize=5,$scope.rightClass="right1000",$scope.versionStatus="",$scope.version={},$scope.emptyState={},$scope.versionForm={},$scope.botState=$workflowService.selectedStream().state,$scope.restoreAccessRight=accessControlService.getAccessRight("BOTBUILDER_BOT_IMPORT"),$scope.createAccessRight=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.selectedStream=$workflowService.selectedStream(),$scope.selectedStreamId=$workflowService.selectedStream()._id,$scope.selectedBaseVersion={},$scope.selectedSecondaryVersion={},$scope.anotherBotVersionsList=[],$scope.versionComparisionParams={},$scope.selectedVersionInd=null,$scope.openVersion=function(){$scope.openModalSlider("#newVersion"),$timeout(function(){$("[name='versionname']")[0].focus()})},$scope.closeNewVersion=function(form,version){$scope.closeModalSlider("#newVersion"),form&&removeValidations(form),version&&(version.versionDesc="",version.versionName="")},$scope.getBotVersions=function(startDate,endDate){({start:10*($scope.currentPage-1),limit:10});startDate&&endDate?BTStreamsService.getBotVersionDateRange($scope.selectedStreamId,moment(new Date($scope.startDate)).toISOString(),moment(new Date($scope.endDate)).toISOString(),$scope.sortBy).then(function(response){$scope.totalVersionCount=response.data.totalCount,$scope.botVersionsList=response.data.versions,
$scope.emptyState.showEmpty=!1}):BTStreamsService.getBotVersions($scope.selectedStreamId,$scope.sortBy).then(function(response){$scope.totalVersionCount=response.data.totalCount,$scope.botVersionsList=response.data.versions,$scope.botVersionsList.length?$scope.emptyState.showEmpty=!1:$scope.emptyState.showEmpty=!0})},$scope.createVersion=function(form,version){if($scope.versionForm=form,form&&form.$invalid)return void form_util.touch(form);$scope.versionStatus="inprogress";var _payload={name:version.versionName,description:version.versionDesc};BTStreamsService.createVersion($scope.selectedStreamId,_payload).then(function(response){response&&response.data&&("success"===response.data.status.toLowerCase()?(version&&version.versionName&&NotificationService.notify("New Bot Version "+version.versionName+" is created.","success"),$scope.versionStatus="success",$scope.getBotVersions(),$scope.closeNewVersion(null,$scope.version)):"in_progress"===response.data.status.toLowerCase()?(NotificationService.notify("Creation of new Bot Version "+version.versionName+" is in progress.","success"),$scope.versionStatus="inprogress",$rootScope.$broadcast("getProgressDockStatus"),$scope.callback.startTimer()):"failure"===response.data.status.toLowerCase()&&($scope.versionStatus="failure",NotificationService.notify("Creation of new Bot Version "+version.versionName+" has failed.","error")))},function(err){$scope.versionStatus="failure",err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Creation of new Bot Version "+version.versionName+" has failed.","error")})},$scope.resetDate=function(){$scope.dateRange="",$scope.getBotVersions()},$scope.deleteVersion=function(version){function confirmDelete(){var _payload={type:version.type,name:version.name,createdOn:version.createdOn,createdBy:version.createdBy,description:version.description,streamId:$scope.selectedStreamId,streamVersionId:version.streamVersionId};BTStreamsService.deleteVersion($scope.selectedStreamId,_payload).then(function(response){response&&response.data&&(NotificationService.notify("Bot version "+version.name+" is deleted","success"),$scope.getBotVersions())},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService("Bot version "+version.name+" has failed","error")})}var msg=i18n.i18nString("delete_version");NotificationService.alert(msg,confirmDelete,{okText:i18n.i18nString("ok_uppercase")})},$scope.exportVersion=function(version){_payload={name:version.name,streamId:$scope.selectedStreamId,streamVersionId:version.streamVersionId},"universalbot"===$scope.selectedStream.type?(_payload.exportOptions={botComponents:["linkedBots","smallTalk"],nlpData:["training_data","bot_synonyms","nlpSettings","defaultDialog","standardResponses"],settings:["botSettings","botVariables","ivrSettings","ivrSettings"]},_payload.exportType="latest",_payload.IncludeDependentTasks=!0,_payload.customDashboards=!0):(_payload.exportOptions={tasks:["botTask","knowledgeGraph","smallTalk","forms"],nlpData:["nlpSettings","utterances","standardResponses"],settings:["botSettings","botVariables","ivrSettings"]},_payload.exportType="latest",_payload.IncludeDependentTasks=!0,_payload.customDashboards=!0,_payload.subTasks={dialogs:[],alerts:[],actions:[],forms:[]},_payload.IncludeFormDependentTasks=!0,_payload.allForms=!1,_payload.allTasks=!0),BTStreamsService.exportBotVersion($scope.selectedStreamId,_payload).then(function(response){if(response&&response.data&&($scope.refId=response.data._id,response&&"pending"===response.data.status?($scope.exportStatus=response.data.status,NotificationService.notify(i18n.i18nString("bt-export_version_in_progress"),"success"),$rootScope.$broadcast("getProgressDockStatus"),$scope._exportStatusInit=startPollExportStatus(3e3)):stopExportBotPolling("success"===response.data.status?"success":"failed"),response.data&&response.data.store&&response.data.store.timeoutMessage)){var msg=response.data.store.timeoutMessage;NotificationService.notify(msg,"warning")}},function(err){err&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_went_wrong_err_noty"),"error")})},$scope.sortByDate=function(param){"new"===param?$scope.botVersionsList=$filter("orderBy")($scope.botVersionsList,"createdOn",!0):"old"===param&&($scope.botVersionsList=$filter("orderBy")($scope.botVersionsList,"createdOn",!1))},$scope.showRestorModal=function(currentRestore){checkForInheritance()?$element.find("#inheritanceModal").removeClass("fade").addClass("show"):$element.find("#restoreModal").removeClass("fade").addClass("show"),$scope.currentRestore=currentRestore},$scope.closeInheritanceModal=function(){$element.find("#inheritanceModal").removeClass("show").addClass("fade")},$scope.closeRestoreModal=function(){$element.find("#restoreModal").removeClass("show").addClass("fade")},$scope.proceedRestore=function(){$element.find("#restoreModal").removeClass("show").addClass("fade");var _payload={type:$scope.currentRestore.type,name:$scope.currentRestore.name,streamId:$scope.selectedStreamId,streamVersionId:$scope.currentRestore.streamVersionId};$scope.restoreVersionStatus="inprogress",$element.find("#restoreModalProgress").removeClass("fade").addClass("show"),startRestoreProgress(),$timeout(function(){BTStreamsService.restoreBotVersion($scope.selectedStreamId,_payload).then(function(response){response&&response.data&&($scope.statusLogs=response.data.statusLogs,"pending"===response.data.status?$scope._importStatusInit=startRestorePoll(response.data._id,3e3):"success"===response.data.status.toLowerCase()?($scope.restoreVersionStatus="success",stopRestorePolling("success"),clearInterval(progressInterval),$scope.totalProgress=100,NotificationService.notify("Bot version "+$scope.currentRestore.name+" is restored successfully","success")):"failure"===response.data.status.toLowerCase()&&(NotificationService.notify("Bot version "+$scope.currentRestore.name+" restore has failed","error"),$scope.restoreVersionStatus="failure",clearInterval(progressInterval),stopRestorePolling("failed")))},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Bot version restoration failed","error"),$scope.restoreVersionStatus="failure",clearInterval(progressInterval),stopRestorePolling("failed")})})},$scope.manageVersionSlider=function(version){$scope.selectedBaseVersion=version,$scope.anotherBotVersionsList=$scope.botVersionsList.filter(function(item){return item._id!==$scope.selectedBaseVersion._id}),$timeout(function(){$scope.openModalSlider("#manageVersion")},500)},$scope.closeManageVersionSlider=function(){$timeout(function(){$scope.closeModalSlider("#manageVersion"),$scope.selectedBaseVersion={},$scope.selectedSecondaryVersion={},$scope.anotherBotVersionsList=[],$scope.selectedVersionInd=null},500)},$scope.changeSecondaryVersion=function(version,index){$scope.selectedSecondaryVersion=version,$scope.selectedVersionInd=index},$scope.proceedVersionComparision=function(){return console.log($scope.selectedBaseVersion,$scope.selectedSecondaryVersion),$scope.selectedBaseVersion&&!$scope.selectedBaseVersion._id?void NotificationService.notify("Select base version","warning"):$scope.selectedSecondaryVersion&&!$scope.selectedSecondaryVersion._id?void NotificationService.notify("Select secondary version","warning"):($scope.versionComparisionParams.type="versionComparision",$scope.versionComparisionParams.baseVersionId=$scope.selectedBaseVersion.streamVersionId,$scope.versionComparisionParams.secondaryVersionId=$scope.selectedSecondaryVersion.streamVersionId,$scope.versionComparisionParams.baseVersionDate=$scope.selectedBaseVersion.createdOn,$scope.versionComparisionParams.secondaryVersionDate=$scope.selectedSecondaryVersion.createdOn,$scope.versionComparisionParams.baseName=$scope.selectedBaseVersion.name,$scope.versionComparisionParams.secondaryName=$scope.selectedSecondaryVersion.name,$scope.versionComparisionParams.botType=$workflowService.selectedStream().type,$scope.versionComparisionParams.streamId=$workflowService.selectedStream()._id,$scope.versionComparisionParams.updateIframeData&&$scope.versionComparisionParams.updateIframeData(),void $scope.fullModalCallback.openFullPageModal(null,"versionComparision",null,$scope.versionComparisionParams))},$scope.closeRestoreProgress=function(){$element.find("#restoreModalProgress").removeClass("show").addClass("fade"),BTStreamsService.getBTStream($scope.selectedStreamId).then(function(response){if(response){var _currentLanguage=$workflowService.currentLanguage(),_configuredLanguages=Object.keys(response.data.languageConfigurations);_configuredLanguages&&-1==_configuredLanguages.indexOf(_currentLanguage)?$scope.callback.reloadToBots():$scope.$emit("loadBots",$workflowService.selectedStream())}})},$scope.pageChanged=function(currentPage){$scope.currentPage=currentPage};(function(){if(void 0!==$workflowService.createVersionStatus()){var _statusData=$workflowService.createVersionStatus();_statusData&&_statusData.status&&($scope.versionStatus=_statusData.status)}})();$scope.botVersionCb.updateVersionStatus=function(data){if(data){if($scope.versionStatus=data.status.toLowerCase(),"success"===$scope.versionStatus){var end=moment();$scope.endDate=end._d,$scope.getBotVersions(),$scope.closeNewVersion($scope.versionForm,$scope.version)}"failure"===$scope.versionStatus&&NotificationService.notify("Creation of new Bot Version "+data.store.name+" has failed.","error")}},$scope.redirectToLink=function(linkType){$rootScope.redirectToLink(linkType)},$scope.hasProp=function(ob,type){return ob.hasOwnProperty(type)},$timeout(function(){$('div[name="daterange"]').daterangepicker({startDate:moment().startOf("hour"),endDate:moment().startOf("hour").add(32,"hour"),maxDate:moment().startOf("hour").format("MM-DD-YYYY"),opens:"left",customClass:"analyze-datepicker"}),$('div[name="daterange"]').on("apply.daterangepicker",function(ev,picker){ev&&($scope.startDate=picker.startDate._d,$scope.endDate=picker.endDate._d,$scope.uiStartDate=picker.startDate.format("MM-DD-YYYY"),$scope.uiEndDate=picker.endDate.format("MM-DD-YYYY")),moment()._d.getDate()===$scope.endDate.getDate()&&moment()._d.getDay()===$scope.endDate.getDay()&&moment()._d.getYear()===$scope.endDate.getYear()&&($scope.endDate=moment()._d),$scope.dateRange=$scope.uiStartDate+" to "+$scope.uiEndDate,$scope.getBotVersions($scope.startDate,$scope.endDate)}),$scope.getBotVersions()},300)}]}}),_module.filter("customDate",function(){return function(timestamp){if(timestamp){var d=moment(timestamp).format("DD-MM-YYYY"),dateStr=moment(timestamp).format("MMMM Do YYYY, h:mm:ss a").split(",")[1],input=dateStr.split(":");return d+","+input[0]+":"+input[1]+" "+input[2].split(" ")[1]}return timestamp}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("botChannels",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/channel-forms/bot-channels-form.html",controller:"botChannelsController"}}),_module.controller("botChannelsController",["$scope","$window","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","NotificationService","$modal","env_conf","$q","BTSeedDataService","$filter","BTIdpService","$translator","$rootScope","$applicationService","$endpoints","i18n","mixPanel",function($scope,$window,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,NotificationService,$modal,env_conf,$q,BTSeedDataService,$filter,BTIdpService,$translator,$rootScope,$applicationService,$endpoints,i18n,mixPanel){function getChannelVisibilityStatus(channelId){return!_.find($scope.channelsSeedData,{id:"twilio"===channelId||"cisco"===channelId?"sms":channelId})}function getChannelMessageByID(channel){var msg="";msg="msteams"===getChannelNameByType(channel.type)?"<span >"+i18n.i18nString("bt_chnl_form_are_you_sure")+"</span> </br></br> <span class='fontSize16'>"+i18n.i18nString("bt_chnl_form_microsoft_teams_chnls_users")+"</span>":"<span>"+i18n.i18nString("bt_chnl_form_are_you_sure")+"</span> </br></br> <span class='fontSize16'>"+getChannelNameByType(channel.name,channel.displayName)+i18n.i18nString("bt_chnl_form_chnl_users_will_effected")+"</span>";var appendMsg="</br></br><span class='fontSize16'>"+i18n.i18nString("bt_chnl_from_you_can_still_talk_to_bot_via"),message=" ",enableChannelExisted=!1;return("twilio"===channel.id||"twilio"===channel.type)&&(channel.type="sms"),$scope.stream.channels.map(function(channelInfo,i){(channelInfo.type||channelInfo.id)!==(channel.type||channel.id)&&channelInfo.enable&&("msteams"===channelInfo.type?message=i18n.i18nString("bt_chnl_form_microsoft_teams_msg",{dyn:message}):(message=message+getChannelNameByType(channelInfo.name,channelInfo.displayName)+", ",enableChannelExisted=!0))}),enableChannelExisted?(message=message.substr(0,message.length-2),msg+appendMsg+message+"."):msg+"</span>"}function isLastEnabledChannel(channel){var enabledChannels=_.filter($scope.channels,{status:"Enabled"});return 1!==enabledChannels.length||enabledChannels[0].name.toLowerCase()!=channel.name.toLowerCase()||channel.displayName?!1:!0}function filterAdditionalIdentities(response){$scope.associatedIdentities=response.data,$scope.associatedIdentitiesFiltered=null,$scope.associatedIdentitiesFiltered={email:[],phone:[]};var emailIds=$scope.associatedIdentities.filter(function(id){return"email"===id.type});$scope.associatedIdentitiesFiltered.email=emailIds;var phoneIds=$scope.associatedIdentities.filter(function(id){return"phone"===id.type});$scope.associatedIdentitiesFiltered.phone=phoneIds,addChannelsToBot()}function getAdditionalIdenties(){BTStreamsService.getuserAdditionalIdentities($applicationService.userInfo().userId).then(function(res){filterAdditionalIdentities(res)},function(err){var errorMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||"";NotificationService.notify(errorMsg,"error")})}function getAppId(channelName){for(var i=0;i<$scope.stream.channels.length;i++){var curChannel=$scope.stream.channels[i];if(curChannel.type===channelName.toLowerCase())return curChannel.app_id}}function showAddToWidgetSdkModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-widgetsdk/bt-add-to-widgetsdk.html",controller:"BTAddToWidgetSdkCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddtoWebMobileClientModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-webmobile-client/bt-add-to-webmobile.html",controller:"BTAddToWebmobileCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddtoWorkplaceModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-workplace/bt-add-to-workplace.html",controller:"BTAddToWorkplaceCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddtoYammerModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-yammer/bt-add-to-yammer.html",controller:"BTAddToYammerCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddtoAlexaModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-alexa/bt-add-to-alexa.html",controller:"BTAddToAlexaCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddtoTwilioVoiceModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-twiliovoice/bt-add-to-twiliovoice.html",controller:"BTAddToTwilioVoiceCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:$scope.twiliovoice||source||{}}}}}})}function showTestEmailChannelModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-email/bt-add-to-email.html",controller:"BTAddToEmailCtrl",backdrop:"static",windowClass:"channelTestModal",resolve:{config:function(){return{component:{channelSource:source||{},additionalIdentities:$scope.associatedIdentitiesFiltered,botIcon:$scope.botIcon}}}}})}function showAddtoLineModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-line/bt-add-to-line.html",controller:"BTAddToLineCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddtoIVRModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-ivr/bt-add-to-ivr.html",controller:"BTAddToIVRCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddToAudioCodesModel(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-audiocodes/bt-add-to-audiocodes.html",controller:"BTAddToAudioCodesCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddtoIVRVoiceModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-ivrVoice/bt-add-to-ivrVoice.html",controller:"BTAddToIVRVoiceCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddToGoogleActionsModel(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-googleHome/bt-add-to-googleHome.html",controller:"BTAddToGoogleHomeCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddToWeChatModel(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-WeChat/bt-add-to-WeChat.html",controller:"BTAddToWeChatCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddToHangoutChatModel(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-hangoutChat/bt-add-to-hangoutChat.html",controller:"BTAddToHangoutChatCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddToWhatsappBusinessModel(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-whatsapp/bt-add-to-whatsapp.html",controller:"BTAddToWhatsappCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddToUnbluModel(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-unblu/bt-add-unblu.html",controller:"BTAddToUnbluCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddToLiveBankModel(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-liveBank/bt-add-to-liveBank.html",controller:"BTAddToLiveBankCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddToMatterMostModel(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-matterMost/bt-add-to-matterMost.html",controller:"BTAddToMatterMostCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showAddtoLivePersonModal(source){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-to-liveperson/bt-add-to-liveperson.html",controller:"BTAddToLivePersonCtrl",backdrop:"static",resolve:{config:function(){return{component:{channelSource:source||{}}}}}})}function showPopUpBlockedDialog(url,emitEvent){$scope.redirectURL=url;var dialog=window.bootbox.dialog({message:'<div class="dialog-content"><div class="symbol"><span class="fa fa-exclamation-circle"></span></div><div><div class="desc">'+i18n.i18nString("bt_chnl_fb_workplace_looks_like_popup_blocker")+'</div><div class="message"> '+i18n.i18nString("click_yes_to_proceed_further")+' </div><div class="popup-button-group"><button type="button" class="btn btn-primary popup-block-accept-btn" aria-label="Close">'+i18n.i18nString("yes")+"</button></div></div></div>",className:"alert-modal popup-block-warning"});dialog.init(function(){$(document).on("click",".popup-block-accept-btn",function(event){$window.open($scope.redirectURL,"_blank"),$(".popup-block-warning").modal("hide")})})}function getMessengerDomainUrl(){var url=$scope._constants_.messengerDomains[$endpoints.SERVER_URL],curUserDetails=$applicationService.userInfo();return url?curUserDetails.koreUserInfo.hasOwnProperty("emailId")?url:url:void NotificationService.notify(i18n.i18nString("bt_chnl_from_counldnot_find_url_noty",{dyn:$endpoints.SERVER_URL}),"error")}function b64EncodeUnicode(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode("0x"+p1)}))}function addToKore(source){var payload=({botId:$scope.stream._id},{channels:[{type:"kore",value:$applicationService.userInfo().userId}]});BTStreamsService.addChannelToBot($scope.stream._id,payload).then(function(response){NotificationService.notify(i18n.i18nString("bt_chnl_Added_to_your_kore_account_noty"),"success");var url=getMessengerDomainUrl();if(url){var childKoreWindow=$window.open(url,"_blank");childKoreWindow||showPopUpBlockedDialog(url)}},function(err){if($scope._constants_.config.collabSegregattion&&err&&err.data&&err.data.errors&&"CollabUserIdNotFound"===err.data.errors[0].code){var collabURL=err.data.errors[0].collabUrl,collabParams={userid:err.data.errors[0].userId,addBotToKore:!0};if(err.config&&err.config.url&&err.config.url.indexOf("/add")>-1){var _addURL=err.config.url;collabParams.botId=_addURL.substring(_addURL.indexOf("/add"),_addURL.indexOf("/bot")+5)}$scope._collabReqURL=collabURL+"#"+b64EncodeUnicode(JSON.stringify(collabParams));var dialog=window.bootbox.dialog({message:'<div class="dialog-content"><div class="symbol text-danger"><span class="fa fa-exclamation-triangle"></span></div><div><div class="desc">'+err.data.errors[0].msg+'.</div><div class="message">'+i18n.i18nString("please_login")+' </div><div class="popup-button-group"><button type="button" class="btn btn-primary popup-block-accept-btn" aria-label="Close">'+i18n.i18nString("ok_uppercase")+"</button></div></div></div>",className:"alert-modal popup-block-warning"});dialog.init(function(){$(document).on("click",".popup-block-accept-btn",function(event){$window.open($scope._collabReqURL,"_blank"),$(".popup-block-warning").modal("hide")})})}else{var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||"";NotificationService.notify(errMsg,"error")}})}function closeExternalAuthWindow(data){childWindow?(childWindow.close(),childWindow=null,childWindowOpened=!1):data.windowObj&&(data.windowObj.close(),childWindowOpened=!1)}function openAuthPage(data){var childWindow=$window.open(window.appConfig.CONTEXT_PATH+"/views/auth-redirect.html","_blank");childWindow||showPopUpBlockedDialog(data.url,!0);$scope.$on("OnChildLoadEvent",function(event,windowObj){windowObj?(windowObj.init(data.url),childWindowOpened=!0):(childWindow.init(data.url),childWindowOpened=!0)}),$scope.$on("ExternalAuthResponseEvent",function(event,data){if(childWindowOpened){closeExternalAuthWindow(data);var hashMessage=JSON.parse(atob(data.hash));console.log(hashMessage),"success"===hashMessage.event?NotificationService.notify(i18n.i18nString("bt_chnl_streamname_added_to_your_accnt",{dyn:$scope.stream.name}),"success"):"failure"===hashMessage.event?"Bot cannot be used as user"===hashMessage.msg?NotificationService.notify(i18n.i18nString("bt_chnl_failed_to_authorize_noty",{dyn:$scope.stream.name}),"error"):NotificationService.notify(i18n.i18nString("bt_chnl_couldnot_add_authorize_cancel_noty",{dyn:$scope.stream.name}),"error"):NotificationService.notify(i18n.i18nString("bt_chnl_couldnot_add_please_try_Again",{dyn:$scope.stream.name}),"error")}});childWindow&&childWindow.focus()}function authorizeChannel(source){var channelName=source.name.toLowerCase();"cisco webex teams"===channelName?channelName="spark":"facebook messenger"===channelName?channelName="facebook":"ringcentral glip"===channelName?channelName="ringcentral":"telegram"===channelName&&(channelName="telegram");var params={streamId:$scope.stream._id,channel:channelName,rurl:appUrl+"/auth-redirect.html"};source.installing=!0,BTStreamsService.testAuthorizeChannel($scope.stream._id,channelName,params.rurl,params).then(function(response){source.installing=!1;var data=response.data;"redirect"===data.event?(openAuthPage(data),$rootScope.$broadcast("redirectionSuccess",null)):$rootScope.$broadcast("redirectionSuccess",null),NotificationService.notify(i18n.i18nString("bt_chnl_redirected_success_noty"),"success")},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||"";NotificationService.notify(errMsg,"error")})}function addChannelsToBot(){if($scope._channelSource&&$scope._channelSource.name){var _channelConfigEvent={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Deploy","Channel Type":$scope._channelSource.type,"Channel Name":$scope._channelSource.name};mixPanel.postEvent("Deploy - Test configured channel",_channelConfigEvent)}var source=$scope._channelSource;if("slack"===source.name.toLowerCase()||"facebook messenger"===source.name.toLowerCase()||"cisco webex teams"===source.name.toLowerCase()||"twitter"===source.name.toLowerCase()||"ringcentral glip"===source.name.toLowerCase())authorizeChannel(source);else if("kore.ai"===source.name.toLowerCase())addToKore(source);else if("skype"===source.name.toLowerCase()){var url="https://join.skype.com/bot/"+getAppId(source.name);openAuthPage({url:url})}else if("Microsoft Teams"===source.name){var url1="https://teams.microsoft.com/l/chat/0/0?users=28:"+getAppId("msteams");console.log(url1),openAuthPage({url:url1})}else if("Workplace by Facebook"===source.name)showAddtoWorkplaceModal(source);else if("Email"===source.name||"Twilio"===source.name||"Cisco Tropo"===source.name)showTestEmailChannelModal(source);else if("Web / Mobile Client"===source.name)showAddtoWebMobileClientModal(source);else if("Widget SDK"===source.name)showAddToWidgetSdkModal(source);else if("Yammer"==source.name)showAddtoYammerModal(source);else if("Amazon Alexa"==source.name)showAddtoAlexaModal(source);else if("Twilio voice"==source.name)showAddtoTwilioVoiceModal(source);else if("Line"==source.name)showAddtoLineModal(source);else if("Webhook"==source.name||"ivr"==source["class"])showAddtoIVRModal(source);else if("IVR"==source.name)showAddtoIVRVoiceModal(source);else if("Telegram"==source.name){var urltelegram="https://web.telegram.org/#/im?p=@"+source.screen_name;openAuthPage({url:urltelegram})}else"LivePerson"===source.name?showAddtoLivePersonModal(source):"googleactions"===source.type?showAddToGoogleActionsModel(source):"wechat"===source.type?showAddToWeChatModel(source):"mattermost"===source.type?showAddToMatterMostModel(source):"hangoutchat"===source.type?showAddToHangoutChatModel(source):"livebank"===source.type?showAddToLiveBankModel(source):"whatsapp"===source.type?showAddToWhatsappBusinessModel(source):"unblu"===source.type?showAddToUnbluModel(source):"audiocodes"===source.type&&showAddToAudioCodesModel(source)}function getChannelNameByType(type,displayName){return"rtm"===type?type="Web / Mobile client":"sms"===type?type="twilio":"wfacebook"===type?type="Workplace by Facebook":"ringcentral"===type?type="Ringcentral Glip":"skypeforbusiness"===type?type="Skype for Business":"kore"===type?type="Kore.ai":"googleactions"===type?type="Google Assistant":"ivr"===type||type&&type.startsWith("ivrInst")?type=displayName||"ivr":"widgetsdk"==type?type="Widget SDK":"unblu"==type&&(type="Unblu"),type}function deleteChannelByChannelID(channel){var channel_type=channel.type;("twilio"===channel.type||"twilio"===channel.id)&&(channel_type="sms"),"cisco"===channel.type&&(channel_type="sms"),BTStreamsService.deleteChannel($scope.stream._id,channel_type||channel.id,channel.gateway?channel.gateway:"").then(function(res){channel.enable=!1,channel.status="Not Setup",NotificationService.notify(i18n.i18nString("bt_chnl_form_chnl_deleted_sucess_noty",{dyn:channel.name}),"success"),$scope.createdChannels[channel.id||channel.type]=!1,$.each($scope.stream.channels,function(i,channelData){return(channel.type||channel.id)===channelData.type?($scope.stream.channels.splice(i,1),!1):void 0});var tempChannel=channel_type||channel.id;(tempChannel.startsWith("ivr")||tempChannel.startsWith("ivrInst"))&&$scope.ivrchannels.splice(0,1),$.each($scope.channels,function(i,channelData){return(tempChannel.startsWith("ivr")||tempChannel.startsWith("ivrInst"))&&"ivrVoice"!==tempChannel&&channelData.id==tempChannel?($scope.channels.splice(i,1),!1):void 0}),$workflowService.selectedStream(angular.copy($scope.stream)),updateStreamData(),$scope.$emit("streamUpdate")},function(err){var errMsg=err&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("bt_chnl_form_chnl_delete_failed");NotificationService.notify(errMsg,"error")})}function setConfiguredChannels(createdChannels){var channels=Object.keys(createdChannels);channels.map(function(channel){_.find(registeredChannels,{type:channel})&&(createdChannels[channel]=!0)})}function updateStreamData(){BTStreamsService.getBTStream($scope.stream._id).then(function(res){$workflowService.selectedStream(angular.copy(res.data)),$scope.updateRegisteredChannels(),$scope.rcs.rcsStateCheck()},function(err){})}function arrangeChannels(channel){var index=getChannelIndex(channel);return _.isUndefined(index)?($scope.channelBeforeEdit=null,registeredChannels.push(channel)):($scope.channelBeforeEdit=registeredChannels[index],registeredChannels.splice(index,1,channel)),registeredChannels}function deleteChannel(channel){var index=getChannelIndex(channel);_.isUndefined(index)||($scope.channelBeforeEdit?registeredChannels[index]=$scope.channelBeforeEdit:registeredChannels.splice(index,1))}function getChannelIndex(channel){var index;return registeredChannels.map(function(channelInfo,i){channelInfo.type===channel.type&&channelInfo.id===channel.id&&(index=i)}),index}function getSmsSchema(){BTStreamsService.channelSchema().then(function(res){$scope.schema=res.data.filter(function(gateway){return"twilio"===gateway.id})[0],$scope.schema.fields.map(function(schema){Object.keys($scope.twilio).map(function(key){schema.key===key&&(schema.initial=$scope.twilio[key])})})})}function bindInitialChannelValues(channel,channelStatus){$scope.currentChannelStatus=channelStatus;var channelInfo;"sms"==channel?($scope.sms=registeredChannels.filter(function(chn){return chn.type==channel})[0]||$scope.sms,getSmsSchema()):"twilio"==channel?($scope.twilio={enable:!0},$scope.twilio=registeredChannels.filter(function(chn){return chn.gateway==channel})[0]||$scope.twilio):"email"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],channelInfo&&($scope.email.name=(channelInfo.email||"").replace($scope._constants_.emailchannelInfo.emailPostFix,""),$scope.email.enable=_.isUndefined(channelInfo.enable)?!0:channelInfo.enable)):"rtm"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],channelInfo&&($scope.rtm.app=channelInfo.app,$scope.rtm.isAlertsEnabled=channelInfo.isAlertsEnabled||!1,$scope.rtm.enable=_.isUndefined(channelInfo.enable)?!0:channelInfo.enable)):"widgetsdk"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],channelInfo&&($scope.widgetsdk.app=channelInfo.app,$scope.widgetsdk.isAlertsEnabled=channelInfo.isAlertsEnabled||!1,$scope.widgetsdk.enable=_.isUndefined(channelInfo.enable)?!0:channelInfo.enable)):"facebook"==channel?(channelInfo=registeredChannels.filter(function(chn){
return chn.type==channel})[0],$scope.facebook=channelInfo):"slack"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.slack=channelInfo):"msteams"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.ms=channelInfo):"syniverse"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.syniverse=channelInfo):"rcengage"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.rcengage=channelInfo):"skype"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.skype=channelInfo):"kore"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],channelInfo&&($scope.kore={enableKore:!0,enable:_.isUndefined(channelInfo.enable)?!0:channelInfo.enable})):"spark"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.spark=channelInfo):"twitter"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.twitter=channelInfo):"cisco"==channel?($scope.cisco={enable:!0},$scope.cisco=registeredChannels.filter(function(chn){return"tropo"===chn.gateway})[0]||$scope.cisco):"wfacebook"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.wfacebook=channelInfo):"ringcentral"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.ringcentral=channelInfo):"skypeforbusiness"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.skypeforbusiness=channelInfo):"telegram"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.telegram=channelInfo):"yammer"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.yammer=channelInfo):"jabber"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.jabber=channelInfo):"alexa"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.alexa=channelInfo):"twiliovoice"==channel?($scope.twiliovoice={enable:!0},$scope.twiliovoice=registeredChannels.filter(function(chn){return chn.type==channel})[0]||$scope.twiliovoice):"line"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.line=channelInfo):channel.startsWith("ivr")&&"Enabled"==channelStatus&&"ivrVoice"!==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.ivr=channelInfo):channel.startsWith("ivr")&&"Not Setup"==channelStatus&&"ivrVoice"!==channel?$scope.ivr=channelInfo:"liveperson"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.liveperson=channelInfo):"ivrVoice"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.ivrVoice=channelInfo):"googleactions"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.googleactions=channelInfo):"wechat"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.wechat=channelInfo):"mattermost"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.mattermost=channelInfo):"whatsapp"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.whatsapp=channelInfo):"unblu"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.unblu=channelInfo):"skypeOnPrem"==channel?(channelInfo=registeredChannels.filter(function(chn){return chn.type==channel})[0],$scope.skypeOnPrem=channelInfo):"audiocodes"==channel&&($scope.audiocodes=registeredChannels.filter(function(chn){return chn.type==channel})[0]),$scope.updateContextName(channel)}$scope.stream=$workflowService.selectedStream(),$scope.selectedStreamState=$workflowService.selectedStreamState(),$scope.channels=$workflowService.seedData().botChannelsTypes,$scope.rcs={popover:"",state:""},$scope.search={},$scope.channelsSeedData=angular.copy($scope.channels),$scope._constants_=_constants_,$scope.kore={enable:!0},$scope.saveInProgress=!1,$scope.noSearchResults=!1,$scope.noSearchEnterpriseResults=!1,$scope.channelBeforeEdit=null;var childWindow,appUrl=window.appConfig.CONTEXT_PATH,childWindowOpened=!1;$scope.isInCAP=$workflowService.isInCAP(),$scope.Ktasks=$workflowService.knowledgeTasks(),$scope.Ktasks.length&&($scope.isInCAP=!0),$scope.onMouseLeaveChannelMenuDiv=function(e){$(e.target).closest(".panel-dropdown").removeClass("open")},$scope.searchResults=function(){$(".configured").length||$(".configured.channelContainer.Enabled").length?$(".configured.channelContainer.Not.Setup").length&&!$(".configured.channelContainer.Enabled").length?$scope.noSearchResults=!0:$scope.noSearchResults=!1:$scope.noSearchResults=!0,$(".enterprise.channelContainer.ng-hide").length&&!$(".enterprise.channelContainer.Not.Setup").length?$scope.noSearchEnterpriseResults=!0:$scope.noSearchEnterpriseResults=!1},$scope.currentChannelStatus="Not Setup",$scope.botIcon=$scope.stream&&$scope.stream.icon?$scope.stream.icon:"",$scope.wfType="channel",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.errorWarning=env_conf["context-url"]+"/assets/icons/errorWarning.svg",$scope.showTestBtn=function(channel){var channelsToHideTest=["skypeforbusiness","jabber","livebank","rcs","skypeOnPrem","syniverse","rcengage"];return-1===$.inArray(channel.id,channelsToHideTest)&&-1===$.inArray(channel.type,channelsToHideTest)&&"Enabled"===channel.status&&$workflowService.isInCAP()&&"Enabled"===channel.status?!0:!1};var channelSliderOpen=function(){if($scope.openModalSlider&&$scope.chooseChannel){var channel=$scope.channels.filter(function(val){return val.id===$workflowService.storeSearchQry().navigateTo})[0];channel&&($scope.chooseChannel(channel,$scope.createdChannels[channel.id||channel.type]),$(".sliderBot #botModalSlider").hasClass("open")&&($workflowService.storeSearchQry().step||$workflowService.storeSearchQry({userNavigateFlag:!1,navigateTo:""})))}};$scope.channels=[{id:"email",name:i18n.i18nString("constants.iconsTooltips_email"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("email"),"class":"email",catagory:"other",icon:env_conf["context-url"]+"/img/email.svg"},{id:"twilio",name:i18n.i18nString("bt_chnl_twilioS_header"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("twilio"),gateway:"twilio","class":"twilio",catagory:"other",icon:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1"},{id:"kore",name:i18n.i18nString("constants.iconsTooltips_kore"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("kore"),"class":"kore-img",catagory:"enterprise",icon:env_conf["context-url"]+"/img/kore.svg"},{id:"facebook",name:i18n.i18nString("constants.iconsTooltips_facebook"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("facebook"),"class":"facebook",catagory:"social",icon:env_conf["context-url"]+"/img/facebook.svg"},{id:"slack",name:i18n.i18nString("constants.iconsTooltips_slack"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("slack"),"class":"slack",catagory:"enterprise",icon:env_conf["context-url"]+"/img/slack.svg"},{id:"rtm",name:i18n.i18nString("bt_chnl_web_mobile_header"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("rtm"),"class":"websdk",catagory:"webMobile",icon:env_conf["context-url"]+"/img/web-mobile.svg"},{id:"widgetsdk",name:i18n.i18nString("constants.iconsTooltips_widgetsdk"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("widgetsdk"),"class":"widgetsdk",catagory:"others",icon:env_conf["context-url"]+"/img/widgetsdk.svg"},{id:"spark",name:i18n.i18nString("constants.iconsTooltips_spark"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("spark"),"class":"spark",catagory:"enterprise",icon:env_conf["context-url"]+"/img/spark.svg"},{id:"twitter",name:i18n.i18nString("constants.iconsTooltips_twitter"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("twitter"),"class":"twitter",catagory:"social",icon:env_conf["context-url"]+"/img/twitter.svg"},{id:"skype",name:i18n.i18nString("constants.iconsTooltips_skype"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("skype"),"class":"fa-skype",catagory:"social",icon:""},{id:"msteams",name:i18n.i18nString("constants.iconsTooltips_msteams"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("msteams"),"class":"ms",catagory:"enterprise",icon:env_conf["context-url"]+"/img/microsoft-teams-icon.png"},{id:"rcengage",name:i18n.i18nString("constants.iconsTooltips_rcengage"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("rcengage"),"class":"ringCentralEngage",catagory:"enterprise",icon:env_conf["context-url"]+"/img/ringCentralEngage.png"},{id:"syniverse",name:i18n.i18nString("constants.iconsTooltips_Syniverse"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("syniverse"),"class":"ms",catagory:"others",icon:env_conf["context-url"]+"/img/syniverse.png"},{id:"cisco",name:i18n.i18nString("constants.iconsTooltips_cisco"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("cisco"),"class":"tropo",catagory:"enterprise",icon:env_conf["context-url"]+"/img/cisco-tropo-icon.png"},{id:"wfacebook",name:i18n.i18nString("bt_chnl_workplace_label"),isMention:!0,isChat:!0,enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("wfacebook"),"class":"wfacebook",catagory:"enterprise",icon:env_conf["context-url"]+"/img/fb-workplace-icon.png"},{id:"ringcentral",name:i18n.i18nString("constants.iconsTooltips_ringcentral"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("ringcentral"),"class":"ringcentral",catagory:"enterprise",icon:env_conf["context-url"]+"/img/ringCentralIcon.png"},{id:"skypeforbusiness",name:i18n.i18nString("constants.iconsTooltips_skypeforbusiness"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("skypeforbusiness"),hideTest:!0,"class":"skypeforbusiness",catagory:"enterprise",icon:env_conf["context-url"]+"/img/skypebusiness.svg"},{id:"telegram",name:i18n.i18nString("constants.iconsTooltips_telegram"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("telegram"),"class":"telegram",catagory:"social",icon:env_conf["context-url"]+"/img/telegram-logo.png"},{id:"yammer",name:i18n.i18nString("constants.iconsTooltips_yammer"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("yammer"),"class":"yammer",catagory:"enterprise",icon:env_conf["context-url"]+"/img/yammericon.png"},{id:"jabber",name:i18n.i18nString("bt_chnl_cisco_jabber_label"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("jabber"),hideTest:!0,"class":"jabber",catagory:"enterprise",icon:env_conf["context-url"]+"/img/jabbericon.jpg"},{id:"alexa",name:i18n.i18nString("constants.iconsTooltips_alexa"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("alexa"),"class":"alexa",catagory:"voice",icon:env_conf["context-url"]+"/img/amazonalexa.png"},{id:"twiliovoice",name:i18n.i18nString("constants.iconsTooltips_twiliovoice"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("twiliovoice"),"class":"twiliovoice",catagory:"voice",icon:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1"},{id:"line",name:i18n.i18nString("constants.iconsTooltips_line"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("line"),"class":"line",catagory:"social",icon:env_conf["context-url"]+"/img/line-logo.png"},{id:"ivrLocal",name:i18n.i18nString("constants.iconsTooltips_ivr"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("ivr"),"class":"ivr",catagory:"other",icon:env_conf["context-url"]+"/img/webhook.png"},{id:"liveperson",name:i18n.i18nString("constants.iconsTooltips_liveperson"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("liveperson"),"class":"liveperson",catagory:"enterprise",icon:env_conf["context-url"]+"/img/live-person.png"},{id:"ivrVoice",name:i18n.i18nString("constants.iconsTooltips_ivrVoice"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("ivrVoice"),"class":"ivrVoice",catagory:"voice",icon:env_conf["context-url"]+"/img/ivr-logo.png"},{id:"googleactions",name:i18n.i18nString("google_ass"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("googleactions"),"class":"googleHome",catagory:"enterprise",icon:env_conf["context-url"]+"/img/google-home.svg"},{id:"whatsapp",name:i18n.i18nString("bt_chnl_whatappb_header"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("whatsapp"),"class":"whatsappB",catagory:"enterprise",icon:env_conf["context-url"]+"/img/whatsapp-business.svg"},{id:"rcs",name:i18n.i18nString("bt_chnl_rcsB_header"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("rcs"),"class":"rcsBusinessM",catagory:"enterprise",icon:env_conf["context-url"]+"/img/rcsBusiness.png"},{id:"wechat",name:i18n.i18nString("constants.iconsTooltips_wechat"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("wechat"),"class":"wechat",catagory:"social",icon:env_conf["context-url"]+"/img/weChat.svg"},{id:"mattermost",name:i18n.i18nString("bt_chnl_mattermost_header"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("mattermost"),"class":"mattermost",catagory:"enterprise",icon:env_conf["context-url"]+"/img/matterMost.svg"},{id:"hangoutchat",name:i18n.i18nString("hangouts"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("hangoutchat"),"class":"hangout",catagory:"enterprise",icon:env_conf["context-url"]+"/img/hangoutchat.png"},{id:"livebank",name:i18n.i18nString("bt_chnl_liveBank_label"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("livebank"),"class":"livebank",icon:env_conf["context-url"]+"/img/livebank.png"},{id:"skypeOnPrem",name:i18n.i18nString("bt_chnl_form_skype_on_premise_label"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("skypeOnPrem"),"class":"skype-premise",catagory:"enterprise",icon:env_conf["context-url"]+"/img/skypebusiness.svg"},{id:"unblu",name:"Unblu",enable:!0,status:"Not Setup",catagory:"enterprise",hide:getChannelVisibilityStatus("unblu"),"class":"unblu",icon:env_conf["context-url"]+"/img/unblu-logo.svg"},{id:"audiocodes",name:i18n.i18nString("audiocodes"),enable:!0,status:"Not Setup",hide:getChannelVisibilityStatus("audiocodes"),"class":"audiocodes",catagory:"voice",icon:env_conf["context-url"]+"/img/audiocodes.png"}],$scope.rcs={},$scope.rcs.rcsStateCheck=function(){var rcsInfo=$scope.stream.channels.filter(function(val){return"rcs"===val.type})[0];(rcsInfo&&rcsInfo.status||rcsInfo&&rcsInfo.state)&&("requested"===rcsInfo.status||"requested"===rcsInfo.state?($scope.rcs.state="requested",$scope.rcs.popover=i18n.i18nString("bt_chnl_form_requested_popOver")):"readyToTest"===rcsInfo.status||"readyToTest"===rcsInfo.state?($scope.rcs.state="readyToTest",$scope.rcs.popover=i18n.i18nString("bt_chnl_form_readytoTest_popOver")):"readyToLaunch"===rcsInfo.status||"readyToLaunch"===rcsInfo.state?($scope.rcs.state="readyToLaunch",$scope.rcs.popover=i18n.i18nString("bt_chnl_form_readytoLaunch_popOver")):"launchInProgress"===rcsInfo.status||"launchInProgress"===rcsInfo.state?($scope.rcs.state="launchInProgress",$scope.rcs.popover=i18n.i18nString("bt_chnl_form_launchInProgress_popOver")):("launched"===rcsInfo.status||"launched"===rcsInfo.state)&&($scope.rcs.state="launched",$scope.rcs.popover=i18n.i18nString("bt_chnl_form_launched_popOver")))},$scope.rcs.rcsStateCheck(),$scope.showBotAdminConfirmation=function(channelType,msgContent){if(("twilio"===channelType||"tropo"===channelType)&&(channelType="sms"),!$workflowService.publishedOrSuspended()||-1===$.inArray(channelType,$scope.stream.approvedChannels)){var confirmationMessage=i18n.i18nString("bt_chnl_form_confirmation_msg");"private"==$scope.stream.visibility.namespace&&(confirmationMessage=i18n.i18nString("bt_chnl_form_confirmation_msg_private")),msgContent&&(confirmationMessage=confirmationMessage+". "+msgContent),window.bootbox.dialog({message:confirmationMessage,title:i18n.i18nString("configuration_saved"),className:"alert-modal",buttons:{main:{label:i18n.i18nString("ok_label"),className:"btn-primary",callback:function(){}}},onEscape:function(){}})}},$scope.isLastEnabledChannel=isLastEnabledChannel,$scope.enableordisableChannel=function(channel,enable){function modifyChannelStatus(){if("tropo"===channel.gateway){var twilioChannel=_.find($scope.channels,{gateway:"twilio"});if(twilioChannel&&"Enabled"===twilioChannel.status)return void NotificationService.confirmDialog(i18n.i18nString("bt_chnl_form_twilio_chnl_already_enabled"),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0},null,void 0,i18n.i18nString("are_you_sure_label"))}if("twilio"===channel.gateway){var tropoChannel=_.find($scope.channels,{gateway:"tropo"});if(tropoChannel&&"Enabled"===tropoChannel.status)return void NotificationService.confirmDialog(i18n.i18nString("bt_chnl_form_cisco_chnl_already_enabled"),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0},null,void 0,i18n.i18nString("are_you_sure_label"))}channel.enable=enable;var payload={channels:arrangeChannels(channel)},_channelType=channel.type;if("twilio"===channel.type&&(channel.type="sms",_channelType="sms"),"cisco"===channel.type&&(_channelType="sms"),("ivr"===channel.type||channel.type.startsWith("ivrInst"))&&channel.hasOwnProperty("createInstance")&&delete channel.createInstance,"rcengage"===channel.type&&channel.idp&&channel.idp._id){var channelPayload={type:"rcengage",idp:channel.idp._id,enable:channel.enable,host_url:channel.host_url};channel=channelPayload}BTStreamsService.createOrEditChannel($scope.stream._id,_channelType,channel).then(function(res){$workflowService.selectedStream().channels=payload.channels,$.each($scope.channels,function(i,channelData){"sms"===channel.type&&"twilio"===channel.gateway&&(channel.type="twilio"),(channelData.id===channel.type||channelData.type===channel.type)&&($scope.channels[i].enable=channel.enable,"rcs"===channelData.type&&($scope.channels[i].state=channelData.status),$scope.channels[i].status=channel.enable?"Enabled":"Disabled")}),$workflowService.selectedStream(res.data);var msgInfo=null;channel&&"ivrVoice"==channel.type&&channel.isSandboxEnabled&&channel.sandboxDetails&&channel.sandboxDetails.phoneNo&&(msgInfo="<br/><br/>"+i18n.i18nString("bt_chnl_form_ivr_msg_info")+"<br/><strong>"+i18n.i18nString("phne_number_label")+channel.sandboxDetails.phoneNo+"</strong><br/><strong>"+i18n.i18nString("pin_label")+channel.sandboxDetails.pin+"</strong> <br/><strong>"+i18n.i18nString("secret_label")+channel.sandboxDetails.secret+"</strong>"),$scope.$emit("streamUpdate"),enable&&$scope.showBotAdminConfirmation(channel.type,msgInfo),"msteams"===getChannelNameByType(channel.type)&&NotificationService.notify(enable?i18n.i18nString("bt_chnl_form_microsoft_teams_chnl_enabled"):i18n.i18nString("bt_chnl_form_microsoft_teams_chnl_disabled"),"info"),"rcengage"===getChannelNameByType(channel.type)?NotificationService.notify(enable?i18n.i18nString("bt_chnl_form_rcengage_chnl_enabled"):i18n.i18nString("bt_chnl_form_rcengage_chnl_disabled"),"info"):"ivr"===getChannelNameByType(channel.type)?NotificationService.notify(enable?i18n.i18nString("bt_chnl_form_chnl_webhook_enabled",{dyn:channel.displayName}):i18n.i18nString("bt_chnl_form_chnl_ivr_disabled",{dyn:channel.displayName}),"info"):NotificationService.notify(enable?i18n.i18nString("bt_chnl_form_chnl_enabled",{dyn:getChannelNameByType(channel.name)}):i18n.i18nString("bt_chnl_form_chnl_disabled",{dyn:getChannelNameByType(channel.name)}),"info"),updateStreamData()},function(err){console.log("error")})}return isLastEnabledChannel(channel)?(NotificationService.notify(i18n.i18nString("atleast_one_enabled_chnl_is_req"),"error"),!1):void(enable?modifyChannelStatus():NotificationService.confirmDialog(getChannelMessageByID(channel),modifyChannelStatus,{okText:i18n.i18nString("continue"),cancelText:i18n.i18nString("cancel")},null,void 0,i18n.i18nString("are_you_sure_label")))},$scope.addChannel=function(source){$scope._channelSource=source,getAdditionalIdenties()},$scope.isEligibleToshow=function(channel){return"kore"===(channel.type||channel.id)&&window.appConfig.ON_PREMISE&&(channel.hide=!0),"rcs"===channel.id&&"readyToTest"===$scope.rcs.state&&"published"===$scope.selectedStreamState?channel.hide=!0:"rcs"===channel.id&&"readyToTest"!==$scope.rcs.state&&"published"===$scope.selectedStreamState&&(channel.hide=!1),channel.hide},$scope.deleteChannel=function(channel){var enabledChannels=_.filter($scope.channels,{status:"Enabled"});if(1===enabledChannels.length&&enabledChannels[0].name===channel.name&&"private"===$workflowService.selectedStream().visibility.namespace)return void NotificationService.confirmDialog(i18n.i18nString("bt_chnl_users_of_this_bot_effected_noty"),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0},null,void 0," ");var msg="";msg="msteams"===channel.type?i18n.i18nString("bt_chnl_bot_will_not_available_microsoft_teams_chnl_noty"):"ivr"===channel.type?i18n.i18nString("bt_chnl_bot_will_not_available_noty",{dyn:getChannelNameByType(channel.name,channel.displayName)}):i18n.i18nString("bt_chnl_bot_will_not_available_noty",{dyn:getChannelNameByType(channel.name,channel.displayName)}),NotificationService.alert(msg,deleteChannelByChannelID,arguments)},$scope.createdChannels={email:!1,sms:!1,twilio:!1,slack:!1,facebook:!1,rtm:!1,widgetsdk:!1,kore:!1,spark:!1,twitter:!1,skype:!1,ms:!1,skypeforbusiness:!1,telegram:!1,jabber:!1,alexa:!1,twiliovoice:!1,line:!1,ivr:!1,liveperson:!1,ivrVoice:!1,googleactions:!1,wechat:!1,mattermost:!1,hangoutchat:!1,livebank:!1,whatsapp:!1,rcs:!1,unblu:!1,skypeOnPrem:!1,audiocodes:!1},$scope.stream.channels=$scope.stream.channels||[],$scope.ivrchannels=[],$.each($scope.stream.channels,function(i,channel){if($.each($scope.channels,function(j,innerChannel){"sms"===channel.type&&"twilio"===channel.gateway&&(channel.type="twilio"),"sms"===channel.type&&"tropo"===channel.gateway&&(channel.type="cisco"),channel.type===innerChannel.id&&(channel.status=channel.enable?"Enabled":"Disabled",$scope.createdChannels[channel.type||channel.id]=!0,channel.name=channel.name||$scope.channels[j].name,$scope.channels[j]=_.merge($scope.channels[j],channel))}),channel.type.startsWith("ivr")&&"ivrVoice"!==channel.type){var a=angular.copy(channel);a.type=channel.type,a.enable=channel.enable,a.status=a.enable?"Enabled":"Disabled",a.hide=!1,a.catagory="other",a["class"]="ivr",a.icon=env_conf["context-url"]+"/img/webhook.png",a.isAsync=channel.isAsync,a.name="Webhook",a.displayName=channel.displayName,a.id=channel.type,$scope.channels.push(a),$scope.ivrchannels.push(a)}});var registeredChannels=$scope.stream.channels||[];$scope.updateRegisteredChannels=function(){$scope.stream=$workflowService.selectedStream(),$scope.stream.channels=$scope.stream.channels||[],$.each($scope.stream.channels,function(i,channel){$.each($scope.channels,function(j,innerChannel){"sms"===channel.type&&"twilio"===channel.gateway&&(channel.type="twilio"),"sms"===channel.type&&"tropo"===channel.gateway&&(channel.type="cisco"),(channel.type||channel.id)===(innerChannel.type||innerChannel.id)&&("rcs"===channel.type&&(channel.state=channel.status),channel.status=channel.enable?"Enabled":"Disabled",$scope.createdChannels[channel.type||channel.id]=!0,channel.name=channel.name||$scope.channels[j].name,$scope.channels[j]=_.merge($scope.channels[j],channel))})}),registeredChannels=$scope.stream.channels||[]},$scope.email={disabled:!0,enable:!0},$scope.rtm={disabled:!0,name:$scope.stream.name,enable:!1},$scope.widgetsdk={disabled:!0,name:$scope.stream.name,enable:!0},$scope.sms={enable:!0},$scope.twilio={enable:!0},$scope.twitter={enable:!0},setConfiguredChannels($scope.createdChannels),_.isObject($scope.stream)&&$scope.stream.name||$location.path(window.appConfig.CONTEXT_PATH),$scope.channelContext={info:""},$scope.sections={emailCreate:!1,smsCreate:!1,fbCreate:!1,slackCreate:!1,rtmCreate:!1,koreCreate:!1,widgetsdkCreate:!1,sparkCreate:!1,twitterCreate:!1,skypeCreate:!1,skypeBusinessCreate:!1,twilioCreate:!1,msteamsCreate:!1,syniverseCreate:!1,rcengageCreate:!1,wfacebookCreate:!1,ringcentralCreate:!1,telegramCreate:!1,yammerCreate:!1,jabberCreate:!1,amazonAlexaCreate:!1,twilioVoiceCreate:!1,lineCreate:!1,ivrCreate:!1,livePersonCreate:!1,ivrVoiceCreate:!1,googleHomeCreate:!1,weChatCreate:!1,matterMostCreate:!1,hangoutCreate:!1,livebankCreate:!1,whatsappBusinessCreate:!1,rcsBusinessCreate:!1,unbluCreate:!1,skypeOnPremCreate:!1,audiocodesCreate:!1},$scope.updateContextName=function(obj){var channel=obj;if(channel){channel=channel.id||channel.type||channel;var selectedChnl=$scope.channels.filter(function(chn){return(chn.id||chn.type)===channel});selectedChnl&&selectedChnl[0]&&"Workplace by Facebook"===selectedChnl[0].name?$scope.context="Workplace By Facebook":selectedChnl&&selectedChnl[0]&&selectedChnl[0].name?$scope.context=selectedChnl[0].name+" channel":$scope.context="Enable channel"}},$scope.chooseChannel=function(channel,reject){if($(".kore-chat-window")&&$(".kore-chat-window").length&&!$(".kore-chat-window").hasClass("minimize")&&$(".kore-chat-window .minimize-btn").trigger("click"),Object.keys($scope.sections).map(function(section){$scope.sections[section]=!1}),"tropo"===channel.gateway){var twilioChannel=_.find($scope.channels,{gateway:"twilio"});if(twilioChannel&&"Enabled"===twilioChannel.status)return void NotificationService.confirmDialog(i18n.i18nString("bt_chnl_form_eanable_single_sms_provider_twilioChnl_enabled"),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0},null,void 0," ")}if("twilio"===channel.gateway){var tropoChannel=_.find($scope.channels,{gateway:"tropo"});if(tropoChannel&&"Enabled"===tropoChannel.status)return void NotificationService.confirmDialog(i18n.i18nString("bt_chnl_form_eanable_single_sms_provider_ciscoChnl_enabled"),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0},null,void 0," ")}"sms"===channel.type&&"twilio"===channel.gateway&&(channel.type="twilio"),$scope.openedChannel=channel.type||channel.id,$scope.sections[("facebook"===(channel.type||channel.id)?"fb":channel.type||channel.id)+"Create"]=!0,"skypeforbusiness"==(channel.id||channel.type)&&($scope.sections.skypeBusinessCreate=!0),"alexa"==(channel.id||channel.type)&&($scope.sections.amazonAlexaCreate=!0),"twiliovoice"==(channel.id||channel.type)&&($scope.sections.twilioVoiceCreate=!0),"line"==(channel.id||channel.type)&&($scope.sections.lineCreate=!0),(channel.id||channel.type).startsWith("ivr")&&"ivrVoice"!==(channel.id||channel.type)&&($scope.sections.ivrCreate=!0),"liveperson"==(channel.id||channel.type)&&($scope.sections.livePersonCreate=!0),"ivrVoice"==(channel.id||channel.type)&&($scope.sections.ivrVoiceCreate=!0),"googleactions"==(channel.id||channel.type)&&($scope.sections.googleHomeCreate=!0),"whatsapp"==(channel.id||channel.type)&&($scope.sections.whatsappBusinessCreate=!0),"wechat"==(channel.id||channel.type)&&($scope.sections.weChatCreate=!0),"mattermost"==(channel.id||channel.type)&&($scope.sections.matterMostCreate=!0),"hangoutchat"==(channel.id||channel.type)&&($scope.sections.hangoutCreate=!0),"livebank"==(channel.id||channel.type)&&($scope.sections.livebankCreate=!0),"rcs"==(channel.id||channel.type)&&($scope.sections.rcsBusinessCreate=!0),"unblu"==(channel.id||channel.type)&&($scope.sections.unbluCreate=!0),"audiocodes"==(channel.id||channel.type)&&($scope.sections.audiocodesCreate=!0),"skypeOnPrem"==(channel.id||channel.type)&&($scope.sections.skypeOnPremCreate=!0),$scope.updateContextName(channel),bindInitialChannelValues(channel.type||channel.id,channel.status),$scope.openModalSlider("#sliderBotChannels");var deployEvent={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Deploy","Channel Type":channel.type,"Channel Name":channel.name};mixPanel.postEvent("Deploy - Deploy Channel Selected",deployEvent)},$scope.goToHome=function(noStreamUpdate){Object.keys($scope.sections).map(function(section){$scope.sections[section]=!1}),noStreamUpdate||updateStreamData(),$("#channelsmodal").modal("hide"),$scope.closeModalSlider("#sliderBotChannels")},$scope.openChannelModal=function(){$("#channelsmodal").modal("show"),$scope.isChannelCreateorEdit=!0,$("#channelsmodal").off("shown.bs.modal").on("shown.bs.modal",function(){$("body").addClass("bt-modal-open")}),$("#channelsmodal").off("hidden.bs.modal").on("hidden.bs.modal",function(){$scope.isChannelCreateorEdit=!1,$("body").removeClass("bt-modal-open")})},$scope.closeSlider=function(){$scope.closeModalSlider("#sliderBotChannels")},$scope.save=function(channel,remove,hideMsg,sendContactCallback,channelName){if($scope.saveInProgress)return!1;$scope.audiocodeChannelAPPValue=angular.copy(channel);var sandboxDetails;if("ivrVoice"==channel.type&&channel.sandboxDetails&&(sandboxDetails=angular.copy(channel.sandboxDetails),delete channel.sandboxDetails),!channel.enable){var channelObject=angular.copy(channel),_type="sms"==channel.type?channel.gateway:channel.type;if(channelObject.name=getChannelNameByType(_type),isLastEnabledChannel(channelObject))return NotificationService.notify(i18n.i18nString("atleast_one_enabled_chnl_is_req"),"error"),!1}var _channelConfigEvent={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Deploy","Channel Type":channel.type,"Channel Name":channel.name};mixPanel.postEvent("Deploy - Deploy Channel integration initiated",_channelConfigEvent),channel.enable&&setTimeout(function(){mixPanel.postEvent("Deploy - Deploy Channel integration success",_channelConfigEvent)}),$scope.saveInProgress=!0,$scope.streamData=$workflowService.selectedStream(),$scope.streamData.isDeflect&&"audiocodes"==channel.type&&_.forEach($scope.streamData.channels,function(channelValue){"audiocodes"===channelValue.type&&(channelValue.phoneNumberConfigDetails&&(channel=angular.merge(channel,channelValue.phoneNumberConfigDetails),delete channelValue.phoneNumberConfigDetails),channelValue.sipConfigDetails&&(channel=angular.merge(channel,channelValue.sipConfigDetails),delete channelValue.sipConfigDetails),channel=angular.merge(channel,channelValue),channel.app=$scope.audiocodeChannelAPPValue.app)});var payload={channels:arrangeChannels(channel)};"ivr"===channel.type&&"Not Setup"===$scope.currentChannelStatus&&(channel.createInstance=!0);var msg;payload.channels=remove?channel:payload.channels,BTStreamsService.createOrEditChannel($scope.stream._id,channel.type,channel).then(function(res){$scope.saveInProgress=!1,$scope.createdChannels[channel.id||channel.type]=!0,$scope.streamChannelsData=res.data.channels,$scope.registeredChannels=res.data.channels,res.data.channels.length&&$scope.$emit("updateChecklist","channels"),$scope.ivrchannels=[],$.each($scope.streamChannelsData,function(i,specficChannel){if(specficChannel.type.startsWith("ivr")&&"ivrVoice"!==specficChannel.type){var a=angular.copy(channel);a.type=specficChannel.type,a.enable=specficChannel.enable,a.status=a.enable?"Enabled":"Disabled",a.hide=!1,a.catagory="other",a["class"]="ivr",a.icon=env_conf["context-url"]+"/img/webhook.png",a.isAsync=specficChannel.isAsync,a.name="Webhook",a.displayName=specficChannel.displayName,a.id=specficChannel.type,a.oAuthRedirectURI=specficChannel.url,$scope.isNewSetup="Enabled"===a.status,$scope.channels.push(a),$scope.ivrchannels.push(a)}"ivrVoice"==specficChannel.type&&specficChannel.isSandboxEnabled&&specficChannel.sandboxDetails&&specficChannel.sandboxDetails.phoneNo&&(channel.sandboxDetails=specficChannel.sandboxDetails,sandboxDetails=specficChannel.sandboxDetails)}),$scope.channels=_.unique($scope.channels,"id"),
$.each($scope.channels,function(i,channelData){"ivrVoice"===channel.type&&channel.isSandboxEnabled&&(channelData.sandboxDetails=sandboxDetails),"ivr"===channelData.type||channel.type.startsWith("ivrInst")||("sms"===channel.type&&"twilio"===channel.gateway&&(channel.type="twilio"),(channelData.id===channel.type||channelData.type===channel.type)&&($scope.isNewSetup="Not Setup"===$scope.channels[i].status,$scope.channels[i].enable=channel.enable,"rcs"===channelData.type&&($scope.channels[i].state=channelData.status),$scope.channels[i].status=channel.enable?"Enabled":"Disabled"))}),$workflowService.selectedStream(res.data),$scope.$emit("streamUpdate"),("twilio"===channel.type||"sms"===channel.type||"email"===channel.type)&&sendContactCallback();var msgInfo=null;channel&&"ivrVoice"==channel.type&&channel.isSandboxEnabled&&sandboxDetails&&sandboxDetails.phoneNo&&(msgInfo="<br/><br/> "+i18n.i18nString("bt_chnl_form_ivr_msg_info")+" <br/><strong>"+i18n.i18nString("phne_number_label")+sandboxDetails.phoneNo+"</strong><br/>  <strong>"+i18n.i18nString("pin_label")+sandboxDetails.pin+"</strong> <br/> <strong>"+i18n.i18nString("secret_label")+sandboxDetails.secret+"</strong>"),hideMsg||"ivr"===channel.type||channel.type.startsWith("ivrInst")?(msg=remove?i18n.i18nString("bt_chnl_chnl_removed_sucess_noty",{dyn:$scope.displayName}):channel.createInstance?i18n.i18nString("bt_chnl_chnl_added_sucess_noty",{dyn:$scope.displayName}):i18n.i18nString("bt_chnl_chnl_updated_scucess_noty",{dyn:$scope.displayName}),NotificationService.notify(msg,"success")):($scope.displayName=channel.displayName?channel.displayName:channelName,msg=remove?i18n.i18nString("bt_chnl_chnl_removed_sucess_noty",{dyn:$scope.displayName}):$scope.isNewSetup?i18n.i18nString("bt_chnl_chnl_added_sucess_noty",{dyn:$scope.displayName}):i18n.i18nString("bt_chnl_chnl_updated_scucess_noty",{dyn:$scope.displayName}),NotificationService.notify(msg,"success")),channel.enable&&$scope.showBotAdminConfirmation(channel.type,msgInfo),$scope.goToHome(),$scope.closeModalSlider("#sliderBotChannels")},function(err){deleteChannel(channel),$scope.saveInProgress=!1;var errMsg;err.data&&err.data.errors&&"ERR_CHANNEL_DISP_NAME_DUP"===err.data.errors[0].msg?(errMsg=i18n.i18nString("bt_chnl_from_duplicate_webhook_noty"),NotificationService.notify(errMsg,"error")):(errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("channel_config_failed"),NotificationService.notify(errMsg,"error"))})},$scope.invokeAction=function(){$scope.saveInProgress||($scope.kore&&$scope.kore.enableKore?$scope.addKoreAsChannel():$scope.kore&&$scope.kore.enableKore===!1&&$scope.removeKoreAsChannel())},$scope.addKoreAsChannel=function(){$scope.save({type:"kore",enable:$scope.kore.enable})},$scope.removeKoreAsChannel=function(){var hideMsg=!0,channels=$workflowService.selectedStream().channels||[];channels=channels.filter(function(channel){return hideMsg=hideMsg&&"kore"!=channel.type,"kore"!=channel.type}),$scope.save(channels,!0,hideMsg)},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.isChannelCreateOrEdit=function(){return $scope.isChannelCreateorEdit},$timeout(function(){$('[data-toggle="popover"]').popover()},100),$scope.channelsAvailable=function(filter,channelType){var _channelsFiltered=_.filter($scope.channels,function(channel){if(channelType){if(channel.status==filter&&channel.catagory==channelType)return channel}else if(channel.status==filter)return channel});return"Enabled"!=filter||_channelsFiltered.length||(_channelsFiltered=_.filter($scope.channels,{status:"Disabled"})),$workflowService.storeSearchQry()&&$workflowService.storeSearchQry().userNavigateFlag&&channelSliderOpen(),_channelsFiltered.length>0},$scope.clearSearch=function(){$scope.noSearchResults=!1,$scope.search.nameSearchQuery=""},$scope.$emit("nestedComponentLoaded",{id:"channels",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}])}(angular),function(ng){var _module=ng.module("bt-forms");_module.directive("manageSession",function(){return{restrict:"EA",scope:{callback:"=",streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/manage-session/manage-session.html",controller:["$scope","form_util","patternFactory","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","$timeout","env_conf","accessControlService","i18n",function($scope,form_util,patternFactory,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,$timeout,env_conf,accessControlService,i18n){function createMPStream(streamData){$workflowService.selectedStream()._id&&"edit"===$scope.displayMode?BTStreamsService.updateMPStream($workflowService.selectedStream()._id,streamData).then(function(response){$scope.callback.saveInprogress=!1,$scope.callback.saveSuccess=!0,slashCommand($workflowService.selectedStream()._id),$workflowService.streamType("")},function(res){$scope.callback.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")}):BTStreamsService.createMPStream($applicationService.userInfo().userId,streamData).then(function(response){$scope.callback.saveSuccess=!0,$scope.callback.saveInprogress=!1,slashCommand(streamData._id),$workflowService.streamType("")},function(res){$scope.callback.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")})}function createBTStream(streamData){$scope.duplicateStreamName=!1,$scope.callback.saveInprogress||($workflowService.selectedStream()._id&&"edit"===$scope.displayMode?($scope.callback.saveInprogress=!0,$scope.$emit("savingInprogress",!0),$scope.newStreamData.icon.fileId&&(streamData.icon=$scope.newStreamData.icon.fileId),BTStreamsService.editStream($workflowService.selectedStream()._id,streamData).then(function(response){var mpPostData={};$scope.$emit("savingInprogress",!1),mpPostData._id=response.data._id,mpPostData.name=$scope.newStreamData.name,mpPostData["class"]=$scope.newStreamData["class"],mpPostData.description=$scope.newStreamData.description,mpPostData.tagline=$scope.newStreamData.tagline,mpPostData.categoryIds=$scope.newStreamData.categoryIds,mpPostData.icon=$scope.newStreamData.icon.fileId,mpPostData.websiteURL=$scope.newStreamData.websiteUrl,mpPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,mpPostData.botDocLink=$scope.newStreamData.botDocLink,mpPostData.keywords=$scope.newStreamData.keywords?$scope.newStreamData.keywords.split(","):[],mpPostData.languages=[],mpPostData.price=1,mpPostData.screenShots=[],mpPostData.namespace="private",mpPostData.namespaceIds=[],mpPostData.userTaskListMsg=$scope.newStreamData.userTaskListMsg,mpPostData.teamTaskListMsg=$scope.newStreamData.teamTaskListMsg,$scope.newStreamData.hasSession?mpPostData.sessionClosureProcess=0:(mpPostData.sessionClosureProcess=1,mpPostData.skipSessionMessage=$scope.newStreamData.skipSessionMessage,mpPostData.sessionInactiveTime=6e4*parseFloat($scope.newStreamData.sessionInactiveTime)),"color"===$scope.newStreamData.bbannerchoice?mpPostData.bBannerColor=$scope.newStreamData.bBannerColor=$scope.newStreamData.color:$scope.newStreamData.bBanner&&$scope.newStreamData.bBanner.fileId&&(mpPostData.bBanner=$scope.newStreamData.bBanner.fileId),"color"===$scope.newStreamData.sbannerchoice?mpPostData.sBannerColor=$scope.newStreamData.sBannerColor=$scope.newStreamData.color:$scope.newStreamData.sBanner&&$scope.newStreamData.sBanner.fileId&&(mpPostData.sBanner=$scope.newStreamData.sBanner.fileId),mpPostData.color=$scope.newStreamData.color,_.addProps(!0,mpPostData,{purpose:$scope.newStreamData.purpose}),mpPostData.profileRequired="true"===$scope.newStreamData.profileRequired,mpPostData.sendVcf="true"===$scope.newStreamData.sendVcf&&mpPostData.profileRequired,mpPostData.isNLEnabled="yes"==$scope.newStreamData.isNLEnabled,response.data&&response.data.welcomeMessage&&(response.data.welcomeMessage=$scope.welcomeMessages||[]),$workflowService.selectedStream(angular.merge($workflowService.selectedStream(),response.data)),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data),$scope.$emit("streamUpdate"),res.data&&res.data.forEach(function(obj){obj._id==$workflowService.selectedStream()._id&&($scope.welcomeMessages=obj.welcomeMessage||$scope.welcomeMessages||[])})}),response.data.languagePreferences&&(mpPostData.languagePreferences=response.data.languagePreferences),createMPStream(mpPostData)},function(res){return $scope.callback.saveInprogress=!1,$scope.$emit("savingInprogress",!1),409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("stream_duplicate")?void($scope.duplicateStreamName=!0):void NotificationService.notify(res.data.errors[0].msg,"error")})):($scope.callback.saveInprogress=!0,$scope.$emit("savingInprogress",!0),BTStreamsService.createBTStream($applicationService.userInfo().userId,streamData).then(function(response){var mpPostData={};$scope.$emit("savingInprogress",!1),mpPostData._id=response.data._id,mpPostData.name=$scope.newStreamData.name,mpPostData.description=$scope.newStreamData.description,mpPostData["class"]=$scope.newStreamData["class"],mpPostData.categoryIds=$scope.newStreamData.categoryIds,mpPostData.icon=$scope.newStreamData.icon.fileId,mpPostData.keywords=$scope.newStreamData.keywords?$scope.newStreamData.keywords.split(","):[],mpPostData.languages=[],mpPostData.price=1,mpPostData.screenShots=[],mpPostData.namespace="private",mpPostData.namespaceIds=[],mpPostData.userTaskListMsg=$scope.newStreamData.userTaskListMsg,mpPostData.teamTaskListMsg=$scope.newStreamData.teamTaskListMsg,mpPostData.color=$scope.newStreamData.color,mpPostData.tagline=$scope.newStreamData.tagline,"color"===$scope.newStreamData.bbannerchoice?mpPostData.bBannerColor=$scope.newStreamData.bBannerColor=$scope.newStreamData.color:$scope.newStreamData.bBanner&&$scope.newStreamData.bBanner.fileId&&(mpPostData.bBanner=$scope.newStreamData.bBanner.fileId),"color"===$scope.newStreamData.sbannerchoice?mpPostData.sBannerColor=$scope.newStreamData.sBannerColor=$scope.newStreamData.color:$scope.newStreamData.sBanner&&$scope.newStreamData.sBanner.fileId&&(mpPostData.sBanner=$scope.newStreamData.sBanner.fileId),mpPostData.websiteURL=$scope.newStreamData.websiteUrl,mpPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,mpPostData.botDocLink=$scope.newStreamData.botDocLink,mpPostData.profileRequired="true"===$scope.newStreamData.profileRequired,mpPostData.sendVcf="true"===$scope.newStreamData.sendVcf&&mpPostData.profileRequired,$workflowService.selectedStream(response.data),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data),$scope.$emit("streamUpdate"),res.data&&res.data.forEach(function(obj){obj._id==$workflowService.selectedStream()._id&&($scope.welcomeMessages=obj.welcomeMessage||$scope.welcomeMessages||[])})}),createMPStream(mpPostData)},function(res){return $scope.callback.saveInprogress=!1,$scope.$emit("savingInprogress",!1),409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("stream_duplicate")?void($scope.duplicateStreamName=!0):void NotificationService.notify(res.data.errors[0].msg,"error")})))}function slashCommand(id){var msg=$routeParams.streamId?i18n.i18nString("updated"):i18n.i18nString("saved_name");if($scope.commandCtx.createSlashCommand){var command=$scope.newStreamData.command||{};return $scope.commandCtx.streamId=$workflowService.selectedStream()._id||id,0===Object.keys(command).length?void notifyStreamStatus($scope.newStreamData.name,msg):$scope.commandCtx.createSlashCommand().then(function(res){$scope.newStreamData.command._id=res.data._id,notifyStreamStatus($scope.newStreamData.name,msg)},function(err){var errorMsg=err.data.errors[0].msg;NotificationService.notify(errorMsg,"error")})}$scope.savedMessage=i18n.i18nString("conversation_session"),notifyStreamStatus($scope.savedMessage,msg)}function notifyStreamStatus(streamName,msg){NotificationService.notify(streamName+msg+i18n.i18nString("successfully"),"success"),$rootScope.$broadcast("evt:nextSucc")}function unique(array){for(var a=array.concat(),i=0;i<a.length;++i)for(var j=i+1;j<a.length;++j)a[i]===a[j]&&a.splice(j--,1);return a}$scope.manage={},$scope.advancedDisplayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.manage.sessionType="donotNotify",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/icons-new/bulb/bulb-blue.svg",$scope.showSession=function(type){type===!0?$scope.manageSession=!0:type===!1&&($scope.manageSession=!1)};var enterpriseLicenseType=$rootScope.licenseType;$scope.callback=$scope.callback||{},$scope.stream=$workflowService.selectedStream(),$scope.callback.modeOfAccess=accessControlService.setRetrieveValue(),$scope.selectedLanguage=$workflowService.currentLanguage(),$scope.displayMode="edit",$scope.editoption=i18n.i18nString("edit"),$scope.addoption=i18n.i18nString("add"),$scope.characters=i18n.i18nString("Generalform_charlimit"),$scope.snapshotsArray=[],$scope.universal=i18n.i18nString("universal_bot_purpose"),$scope.published=i18n.i18nString("bot_published"),$scope.commandCtx={},$scope.sessionClosure=!1,$scope.isUploading=!1,$scope.errorInsideStream=!0,$scope.categories=$workflowService.seedData().category,$scope.duplicateStreamName=!1,$scope._constants_=$rootScope._constants_,$scope.sdkCallback={},$scope.welcomeMessagecb={},$scope._constants_=$rootScope._constants_,$scope.assetsBase=env_conf["assets-url"],$scope.currentStream=$workflowService.selectedStream(),$scope.currentStream&&$scope.currentStream.sbStreamId&&BTStreamsService.getMPStream($scope.currentStream.sbStreamId).then(function(res){$scope.parentSBStream=res.data}),$scope.manageResponseCB={},$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation(),setTimeout(function(){$scope.manageResponseCB.title="Confirmation Dialog for component",$scope.manageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key];var _btnValue="close";$scope.manageResponseCB.openManageResponse(_btnValue),$scope.manageResponseCB.initMessages($scope.advancedDisplayMode)},500)},$scope.manageResponseCB.closeResponseScreen=function(){$scope.showStandardResponses=!1,$scope.manageResponseCB.conditionKey={}},$scope.onToggleChange=function(type){type===!0?$scope.newStreamData.skipSessionMessage=!0:$scope.newStreamData.skipSessionMessage=!1},$scope.checkInheritance=function(){return void 0===$scope.newStreamData.allowInheritance?!0:$scope.newStreamData.allowInheritance?!0:!1},$scope.getLocaleTime=function(timestamp,timeInAMPM){var d=moment(timestamp).format("MM-DD-YYYY"),dateStr=moment(timestamp).format("MMMM Do YYYY, h:mm:ss a").split(",")[1],timeStamp=dateStr.split(":");return d+","+timeStamp[0]+":"+timeStamp[1]+" "+timeStamp[2].split(" ")[1]},$scope.icons={spark:env_conf["context-url"]+"/img/spark.svg",msteams:env_conf["context-url"]+"/img/microsoft-teams-icon.png",syniverse:env_conf["context-url"]+"/img/syniverse.png",rcengage:env_conf["context-url"]+"/img/ringCentralEngage.png",slack:env_conf["context-url"]+"/img/slack.svg",sms:env_conf["context-url"]+"/img/sms.svg",twilio:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",email:env_conf["context-url"]+"/img/email.svg",skype:"",facebook:env_conf["context-url"]+"/img/facebook.svg",websdk:env_conf["context-url"]+"/img/slack.svg",kore:env_conf["context-url"]+"/img/kore.svg",rtm:env_conf["context-url"]+"/img/web-mobile.svg",widgetsdk:env_conf["context-url"]+"/img/widgetsdk.svg",twitter:env_conf["context-url"]+"/img/twitter.svg",skypeOnPrem:env_conf["context-url"]+"/img/skypebusiness.svg",cisco:env_conf["context-url"]+"/img/cisco-tropo-icon.png",wfacebook:env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Groups":env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Chat":env_conf["context-url"]+"/img/fb-workplace-icon.png",ringcentral:env_conf["context-url"]+"/img/ringCentralIcon.png",skypeforbusiness:env_conf["context-url"]+"/img/skypebusiness.svg",jabber:env_conf["context-url"]+"/img/jabbericon.jpg",yammer:env_conf["context-url"]+"/img/yammericon.png",telegram:env_conf["context-url"]+"/img/telegram-logo.png",alexa:env_conf["context-url"]+"/img/amazonalexa.png",twiliovoice:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",line:env_conf["context-url"]+"/img/line-logo.png",ivr:env_conf["context-url"]+"/img/webhook.png",liveperson:env_conf["context-url"]+"/img/live-person.png",ivrVoice:env_conf["context-url"]+"/assets/ivrIcons/ivrIcon.svg",wechat:env_conf["context-url"]+"/img/weChat.svg"},$scope.welcomeMessages=$scope.stream.welcomeMessage||[],$scope.cb={},$scope.botSetupConfirmationDescription=$rootScope.getSanitizedText($rootScope.lableData.bb012),$scope.char_remaining=i18n.i18nString("char_remaining"),$scope.If_universalbot=i18n.i18nString("If_universalbot"),$scope.not_universalbot=i18n.i18nString("not_universalbot"),$scope.edit=i18n.i18nString("edit"),$scope.add_label=i18n.i18nString("add_label"),$scope.parent_bot=i18n.i18nString("parent_bot"),$scope.js_msg=i18n.i18nString("js_msg"),$scope.categoryConfig={allowclear:!0,multiple:!0,placeholder:i18n.i18nString("select_category")},$scope.classConfig={allowclear:!0,multiple:!0,placeholder:i18n.i18nString("select_class")},$scope.newStreamData={profileRequired:"true",purpose:enterpriseLicenseType?"customer":null,sbannerchoice:"image",bbannerchoice:"image"},$scope.newStreamData.purposeisRequired=enterpriseLicenseType,$scope.myTeams=[],$scope.showBotNameHint=!1,$scope.bulbSvg=env_conf["context-url"]+"/assets/images/24x29-bulbicon.png",$scope.showNlpEnable=function(){return $rootScope.wfAdmin},$scope.universalBotPurposeError=!1;var allStreams=$workflowService.streamsAll();if(allStreams.length)var employeeBots=_.filter(allStreams,{purpose:"employee"}),customerBots=_.filter(allStreams,{purpose:"customer"});$scope.callback.loadGeneralSettings=function(){$scope.callback.loadingGeneralSettings=!0,BTSeedDataService.getSeedCategories().then(function(res){$scope.categories=res.data.categories}),$("#noty_center_layout_container").empty();$scope.streamId=$workflowService.selectedStream()._id,$workflowService.selectedStream()._id&&BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){$scope.currentStream=res.data,$scope.newStreamData={_id:res.data._id,type:res.data.type||"taskbot",websiteUrl:res.data.websiteUrl,demoYoutubeLink:res.data.demoYoutubeLink,botDocLink:res.data.botDocLink,color:res.data.color,hasUserEndpoint:res.data.hasUserEndpoint,keywords:null,hasTenant:res.data.hasTenant,hasSession:res.data.hasTenant,defaultUrl:res.data.baseUrl,helpHint:res.data.tenancy?res.data.tenancy.helpHint:null,sharing:{},offKoraConfirmation:res.data.offKoraConfirmation,synonyms:res.data.synonyms,purpose:res.data.purpose,skipMakeEditLinks:res.data.skipMakeEditLinks||!1,sessionClosureProcess:res.data.sessionClosureProcess},res.data.skipSessionMessage?$scope.newStreamData.skipSessionMessage=res.data.skipSessionMessage:$scope.newStreamData.skipSessionMessage=!1,res.data.sessionInactiveTime?$scope.newStreamData.sessionInactiveTime=parseFloat(res.data.sessionInactiveTime/6e4):$scope.newStreamData.sessionInactiveTime=15,1===$scope.newStreamData.sessionClosureProcess?$scope.newStreamData.hasSession=!1:$scope.newStreamData.hasSession=!0,res.data.sbStreamId&&($scope.newStreamData.inheritanceType=res.data.inheritanceType||1,$scope.newStreamData.allowInheritance=res.data.allowInheritance,$scope.newStreamData.sbStreamId=res.data.sbStreamId),res.data.description&&($scope.newStreamData.description=res.data.description.replace(/&gt;/g,">").replace(/&lt;/g,"<")),res.data.name&&($scope.newStreamData.name=res.data.name.replace(/&gt;/g,">").replace(/&lt;/g,"<").trim().replace(/\s\s+/g," ")),$scope.newStreamData.allowInheritance=res.data.allowInheritance,$scope.welcomeMessages=res.data.welcomeMessage||$scope.welcomeMessages||[],$scope.newStreamData.type=res.data.type,"universalbot"===res.data.type&&(res.data.awaitingApprovalBots.length>0||res.data.publishedBots.length>0||res.data.configuredBots.length>0)?$scope.newStreamData.isInMarket=!0:"private"!==res.data.visibility.namespace?$scope.newStreamData.isInMarket=!0:$scope.newStreamData.isInMarket=$workflowService.selectedStream().isInMarket;try{$scope.newStreamData.sharing[res.data.visibility.namespace[0]]=!0,$scope.newStreamData.sharing[res.data.visibility.namespace[1]]=!0}catch(ex){}res.data.errorCodes&&res.data.errorCodes.pollError&&($scope.newStreamData.pollError=res.data.errorCodes.pollError,$scope.newStreamData.errorCodes=res.data.errorCodes.pollError),res.data.visibility&&res.data.visibility.namespaceIds&&res.data.visibility.namespaceIds.forEach(function(item){for(var i=0;i<$scope.myTeams.length;i++)if($scope.myTeams[i].id===item){$scope.myTeams[i].selected=!0;break}})}).then(function(){BTStreamsService.getMPStream($workflowService.selectedStream()._id).then(function(res){res.data&&($scope.newStreamData.categoryIds=res.data.categoryIds,$scope.newStreamData.websiteUrl=res.data.websiteURL,$scope.newStreamData.demoYoutubeLink=res.data.demoYoutubeLink,$scope.newStreamData.botDocLink=res.data.botDocLink,$scope.newStreamData["class"]=res.data["class"],$scope.newStreamData.tagline=res.data.tagline,$scope.newStreamData.userTaskListMsg=res.data.userTaskListMsg,$scope.newStreamData.teamTaskListMsg=res.data.teamTaskListMsg,$scope.newStreamData.profileRequired=res.data.profileRequired+"",$scope.newStreamData.sendVcf=res.data.sendVcf+"",$scope.newStreamData.purposeisRequired=enterpriseLicenseType,$scope.newStreamData.icon={fileName:"StreamIcon.png"},res.data.bBanner&&($scope.newStreamData.bBanner={fileName:"Big Banner.png"}),res.data.sBanner&&($scope.newStreamData.sBanner={fileName:"Small Banner.png"}),$scope.newStreamData.bBannerColor=res.data.bBannerColor,$scope.newStreamData.sBannerColor=res.data.sBannerColor,$scope.newStreamData.keywords=res.data&&res.data.keywords&&res.data.keywords.length>0?res.data.keywords.join(","):null,$scope.newStreamData.bbannerchoice=res.data.bBanner?"image":"color",$scope.newStreamData.sbannerchoice=res.data.sBanner?"image":"color",$scope.newStreamData.isNLEnabled=res.data.isNLEnabled?"yes":"no",$scope.commandCtx.streamId=$workflowService.selectedStream()._id,$scope.streamGeneralForm&&$scope.streamGeneralForm.$setPristine(),$scope.callback.loadingGeneralSettings=!1)})})},$scope.callback.saveSuccess=!1,$scope.$watch("callback.saveSuccess",function(newVal,oldVal){$timeout(function(){$scope.callback.saveSuccess=!1},1e3)});new Clipboard('[data-clipboard-target="#bot_id"]');$scope.callback.saveInprogress=!1,$scope.validateTeamShare=function(){if($scope.myTeams){var selectedTeamCount=0;return $scope.myTeams.forEach(function(team){team.selected&&selectedTeamCount++}),selectedTeamCount>0?!0:!1}return!1},$scope.callback.formInvalid=!1,$scope.callback.createStream=function(event,languageSettings){var errors;if(event&&event.preventDefault&&event.preventDefault(),"universalbot"!==$scope.newStreamData.type||!$scope.universalBotPurposeError){$scope.callback.formInvalid=!1;var btPostData={},botName=$scope.newStreamData.name;$scope.newStreamData.name&&(botName=$scope.newStreamData.name.trim().replace(/\s\s+/g," ")),$scope.newStreamData.name=botName,btPostData.name=botName,btPostData.type=$workflowService.streamType()||"taskbot",btPostData.description=$scope.newStreamData.description,btPostData.color=$scope.newStreamData.color,btPostData.categoryIds=$scope.newStreamData.categoryIds,btPostData.websiteUrl=$scope.newStreamData.websiteUrl,btPostData.demoYoutubeLink=$scope.newStreamData.demoYoutubeLink,btPostData.botDocLink=$scope.newStreamData.botDocLink,btPostData.hasTenant=$scope.newStreamData.hasTenant,btPostData.hasSession=$scope.newStreamData.hasSession,btPostData.offKoraConfirmation=$scope.newStreamData.offKoraConfirmation,btPostData.synonyms=$scope.newStreamData.synonyms,btPostData.skipMakeEditLinks=$scope.newStreamData.skipMakeEditLinks||!1,$scope.checkInheritance()&&$scope.newStreamData.sbStreamId&&(btPostData.inheritanceType=$scope.newStreamData.inheritanceType),_.addProps(!0,btPostData,{purpose:$scope.newStreamData.purpose}),btPostData.hasSession?btPostData.sessionClosureProcess=0:(btPostData.sessionClosureProcess=1,btPostData.sessionInactiveTime=6e4*parseFloat($scope.newStreamData.sessionInactiveTime),btPostData.skipSessionMessage=$scope.newStreamData.skipSessionMessage),btPostData.hasTenant&&(btPostData.tenancy={},btPostData.tenancy.helpHint=$scope.newStreamData.helpHint,btPostData.baseUrl=$scope.newStreamData.defaultUrl),errors=angular.copy($scope.newStreamData.errorCodes),errors&&errors instanceof Array&&(errors=errors.map(function(obj){return delete obj.insert,obj})),errors=_.union(errors,$scope.newStreamData.pollError),errors=_.uniq(errors,function(error){return+error.statusCode}),btPostData.errorCodes={pollError:errors},btPostData.visibility={namespace:[],namespaceIds:[]},$scope.newStreamData.sharing&&$scope.newStreamData.sharing.enterprise&&btPostData.visibility.namespace.push("enterprise"),$scope.newStreamData.sharing&&$scope.newStreamData.sharing.team&&(btPostData.visibility.namespace.push("team"),btPostData.visibility.namespaceIds=[],$scope.myTeams&&$scope.myTeams.forEach(function(team){team.selected&&btPostData.visibility.namespaceIds.push(team.id)})),languageSettings&&(btPostData.languagePreferences=languageSettings),createBTStream(btPostData)}},$scope.uploadStreamIcon=function(){if($scope.newStreamData.iconFile.name){var _ext=$scope.newStreamData.iconFile.name.substring($scope.newStreamData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.iconFile.name,fileId:response.data.fileId};$scope.newStreamData.icon=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.iconUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.iconUploading=!1})},$scope.deleteStreamIcon=function(){$scope.newStreamData.iconFile=null,$scope.newStreamData.icon=null,$("#iconFile").val("")},$scope.dissableInheritance=function(){function disable(){BTStreamsService.removeBotInheritance($workflowService.selectedStream()._id).then(function(response){$workflowService.selectedStream(response.data),$scope.currentStream=response.data,$scope.newStreamData.allowInheritance=response.data.allowInheritance,NotificationService.notify(i18n.i18nString("remove_inherit"),"success")},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})}function cancle(){}NotificationService.userConfirm(i18n.i18nString("disable_inherit_update"),[disable,cancle],{okText:i18n.i18nString("confirm"),btnClass:"redBtn"},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.uploadLargeStreamBanner=function(){if($scope.newStreamData.bigBannerFile.name){var _ext=$scope.newStreamData.bigBannerFile.name.substring($scope.newStreamData.bigBannerFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bBfileExtensionError=!0)}$scope.bBfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.bigBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.bigBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.bigBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.bBanner=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.bigBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.bigBannerUploading=!1})},$scope.deleteStreamBBanner=function(){$scope.newStreamData.bigBannerFile=null,$scope.newStreamData.bBanner=null,$("#bigBannerFile").val("")},$scope.uploadSmallStreamBanner=function(){if($scope.newStreamData.smBannerFile.name){var _ext=$scope.newStreamData.smBannerFile.name.substring($scope.newStreamData.smBannerFile.name.lastIndexOf("."));if(".png"!==_ext&&".PNG"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bSfileExtensionError=!0)}$scope.bSfileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.smBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.smBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.smBannerFile.name,fileId:response.data.fileId};$scope.newStreamData.sBanner=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.smBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.smBannerUploading=!1})},$scope.callback.loadGeneralSettings(),$scope.deleteStreamSBanner=function(){$scope.newStreamData.smBannerFile=null,$scope.newStreamData.sBanner=null,$("#smBannerFile").val("")},$scope.onStreamFormCancel=function(){"edit"===$scope.displayMode?$location.path(window.appConfig.CONTEXT_PATH):($scope.newStreamData={},$scope.onCancel())},$scope.decodeJS=function(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}},$scope.editResponse=function(index){$scope.welcomeMessagecb.loadMessage($scope.welcomeMessages,index),$(".welcomeMessageModal").modal("show")},$scope.welcomeMessagecb.updateWelcomeMessages=function(res){$scope.welcomeMessages=res},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.clearTenancy=function(){$scope.newStreamData.defaultUrl="",$scope.newStreamData.helpHint=""},$scope.goBack=function(){$scope.onBack()},$scope.clearTeams=function(){$scope.myTeams.map(function(team){team.selected=!1})},$scope.purposeChanged=function(){"universalbot"===$scope.newStreamData.type&&("employee"===$scope.newStreamData.purpose&&employeeBots&&employeeBots.length<2?($scope.universalBotPurposeError=!0,$scope.universalBotPurposeErrorMessage=i18n.i18nString("universal_employee")):"customer"===$scope.newStreamData.purpose&&customerBots&&customerBots.length<2?($scope.universalBotPurposeError=!0,$scope.universalBotPurposeErrorMessage=i18n.i18nString("universal_customer")):$scope.universalBotPurposeError=!1)};$scope.isFormValid=function(form){return!(form.$invalid||$scope.newStreamData.sharing&&$scope.newStreamData.sharing.team&&!$scope.validateTeamShare())},$scope.$on("savelanguageSettings",$scope.callback.createStream),$rootScope.$on("loadGeneralSettings",$scope.callback.loadGeneralSettings),$scope.$on("evt:exitAct",function(evt,data){$scope.streamForm.$valid?$scope.callback.createStream(!0):NotificationService.notify(i18n.i18nString("enter_valid_data"),"error")}),$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$scope.showAdvancedOptions=function(){$scope.showadvancedoptions?($scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$("#advancedoptdivStream .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showadvancedoptions=!0,$scope.advancedoptiontext=i18n.i18nString("hide_advanced_options"),$("#advancedoptdivStream .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"));
},$scope.ivrBridge={},$scope.editIVR=!1,$scope.editIVRSettings=function(){$scope.stream=$workflowService.selectedStream(),$scope.ivrOptions=$scope.stream.welcomeIvrOptions,$scope.editIVR=!0,$scope.openModalSlider("#IVRSettingsSlider")},$scope.closeIVRSettings=function(){$scope.editIVR=!1,$scope.closeModalSlider("#IVRSettingsSlider")},$scope.saveIVRSettings=function(vxmlflag,label){$scope.stream=$workflowService.selectedStream();var payload={welcomeIvrOptions:$scope.ivrBridge.getIVROptions()};BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("ivrsettings_label",{dyn:label}),"success"),$workflowService.selectedStream(angular.extend($scope.stream,res.data)),res.data&&($scope.ivrBridge.ivrOptions=res.data.welcomeIvrOptions.advance.properties,$scope.vxmlGlobalCopyKeys=_.pluck($scope.stream.ivrSettings.properties||[],"name"),$scope.vxmlNodeKeys=_.pluck(res.data.welcomeIvrOptions.advance.properties||[],"name"),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys)),$scope.cb.updateVxmlGlobalKeys($scope.vxmlGlobalKeys)),setTimeout(function(){vxmlflag&&$scope.closeIVRSettings()},500)},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.validateBotName=function(){var regexpObject=patternFactory.getRegularExpression("stream"),regexp=regexpObject.regexp,regexp2=regexpObject.regexp2;return{test:function(value){return value&&1===value.length?regexp2.test(value):regexp.test(value)}}}(),$scope.validateYoutubeURL=function(){return{test:function(uri){var p=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return uri.match(p)?!0:!1}}}(),$scope.closeNodeVxmlProp=function(){$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""}};var vxmlflag=!1;$scope.addProperty=function(vprop){$scope.ivrBridge.ivrOptions=$scope.ivrBridge.getIVROptions(),$scope.ivrBridge.ivrOptions.advance.properties.push(vprop),$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""},$scope.saveIVRSettings(vxmlflag,"saved")},$scope.cb.call=function(label){$scope.saveIVRSettings(vxmlflag,label)},setTimeout(function(){"ar"===$scope.selectedLanguage&&($(".limitSet").removeClass("charactersLimit"),$(".limitSet").addClass("charactersLimitForArabric"))},1e3),$scope.$emit("nestedComponentLoaded",{id:"generalSettings",flag:!1})}]}})}(angular),function(ng){var _module=ng.module("bt-forms");_module.directive("processAssignments",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/process-assignments/process-assignment.html",controller:["$scope","_constants_","$workflowService","$location","$timeout","BTStreamsService","i18n","env_conf","form_util","$filter","$element","$rootScope","accessControlService","BTFlowtaskService",function($scope,_constants_,$workflowService,$location,$timeout,BTStreamsService,i18n,env_conf,form_util,$filter,$element,$rootScope,accessControlService,BTFlowtaskService){$scope.processApps=[],$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.emptyProcessLanding=env_conf["context-url"]+"/assets/processAssignments/process-landing.svg",$scope.addProcessApp=function(){$scope.openModalSlider("#processAssignment")},$scope.closeProcessSlider=function(){$scope.closeModalSlider("#processAssignment")}}]}})}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("sampleBotSettings",function(){return{restrict:"EA",scope:{streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/sample-bot-settings.html",controller:["$scope","form_util","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","env_conf","$timeout","i18n",function($scope,form_util,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,env_conf,$timeout,i18n){$scope.stream=$workflowService.selectedStream(),$scope.sampleBotSettings={},$scope._constants_=$rootScope._constants_,$scope.assetsBase=env_conf["assets-url"],$scope.importingSvg=env_conf["context-url"]+"/assets/images/importing.png",$scope.importSucessSvg=env_conf["context-url"]+"/assets/images/import-success.png",$scope.importErrorSvg=env_conf["context-url"]+"/assets/images/import-error.png",$scope.savinglabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.enableTryMode=_.isUndefined($scope.stream.canTryOut)?!1:$scope.stream.canTryOut,$scope.account=[],$scope.stream&&$scope.stream.solutionBotSettings?($scope.sampleBotSettings.description=$scope.stream.solutionBotSettings.botDesc,$scope.sampleBotSettings.instructionsURL=$scope.stream.solutionBotSettings.configInstURL,$scope.sampleBotSettings.uploadedfileId=$scope.stream.solutionBotSettings.configInstFileId):($scope.sampleBotSettings.description="",$scope.sampleBotSettings.instructionsURL="",$scope.sampleBotSettings.uploadedfileId=""),$scope.uploadInstructionsDocument=function(){if($scope.importBotInstructions&&$scope.importBotInstructions.name){var _ext=$scope.importBotInstructions.name.substring($scope.importBotInstructions.name.lastIndexOf("."));if(".pdf"!==_ext)return NotificationService.notify(i18n.i18nString("upload_only_pdf_files"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1,$scope.importBotInstructionsName=$scope.importBotInstructions.name;var data=new FormData;data.append("file",$scope.importBotInstructions),data.append("fileContext","workflows"),data.append("fileExtension","pdf"),$scope.fileUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){$scope.sampleBotSettings.uploadedfileId=response.data.fileId,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:$scope.importBotInstructions.name}),"success"),$scope.fileUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.fileUploading=!1})},$scope.saveSampleBotsettings=function(form){if($scope.saveInprogress=!0,$scope.sampleBotSettings&&!$scope.sampleBotSettings.instructionsURL)return NotificationService.notify(i18n.i18nString("provide_a_valid_url"),"error"),void($scope.saveInprogress=!1);var myPostData={};myPostData={solutionBotSettings:{botDesc:$scope.sampleBotSettings.description,configInstURL:$scope.sampleBotSettings.instructionsURL,configInstFileId:$scope.sampleBotSettings.uploadedfileId}},BTStreamsService.editStream($scope.stream._id,myPostData).then(function(res){$scope.sampleBotSettings.description=res.data.solutionBotSettings.botDesc,$scope.sampleBotSettings.instructionsURL=res.data.solutionBotSettings.configInstURL,$scope.sampleBotSettings.uploadedfileId=res.data.solutionBotSettings.configInstFileId,NotificationService.notify(i18n.i18nString("settings_saved_sucessfully"),"success"),$workflowService.selectedStream(res.data),$scope.saveInprogress=!1},function(res){$scope.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.$emit("nestedComponentLoaded",{id:"sampleBotSettings",flag:!1})}]}})}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("smartBotSettings",function(){return{restrict:"EA",scope:{streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/smart-bot-settings.html",controller:["$scope","form_util","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","env_conf","$timeout","accessControlService","i18n",function($scope,form_util,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,env_conf,$timeout,accessControlService,i18n){$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.stream=$workflowService.selectedStream(),$scope.smartBotSettings={},$scope.editorReadyOnly=!1,"VIEW"===$scope.displayMode&&($scope.editorReadyOnly=!0),$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.chooseFile=i18n.i18nString("choose_file"),$scope.uploading=i18n.i18nString("uploading_label"),$scope._constants_=$rootScope._constants_,$scope.assetsBase=env_conf["assets-url"],$scope.importingSvg=env_conf["context-url"]+"/assets/images/importing.png",$scope.importSucessSvg=env_conf["context-url"]+"/assets/images/import-success.png",$scope.importErrorSvg=env_conf["context-url"]+"/assets/images/import-error.png",$scope.enableTryMode=_.isUndefined($scope.stream.canTryOut)?!1:$scope.stream.canTryOut,$scope.account=[],$scope.importBotInstructions={},$scope.smartBotSettings.instructionsType="plainText",$scope.smartBotSettings.uploadedfileId="",$scope.stream&&$scope.stream.solutionBotSettings?($scope.smartBotSettings.description=$scope.stream.solutionBotSettings.botDesc,$scope.smartBotSettings.instructionsURL=$scope.stream.solutionBotSettings.configInstURL,$scope.stream.solutionBotSettings.configInst?($scope.smartBotSettings.configInst=$scope.stream.solutionBotSettings.configInst,$scope.smartBotSettings.instructionsType="plainText"):$scope.stream.solutionBotSettings.configInstFileId&&($scope.smartBotSettings.uploadedfileId=$scope.stream.solutionBotSettings.configInstFileId,$scope.smartBotSettings.instructionsType="pdfDoc",$scope.importBotInstructions.name="Instructions.pdf")):($scope.smartBotSettings.description="",$scope.smartBotSettings.instructionsURL="",$scope.smartBotSettings.uploadedfileId="",$scope.smartBotSettings.instructionsType="plainText"),$scope.uploadInstructionsDocument=function(){if($scope.importBotInstructions&&$scope.importBotInstructions.name){var _ext=$scope.importBotInstructions.name.substring($scope.importBotInstructions.name.lastIndexOf("."));if(".pdf"!==_ext)return NotificationService.notify(i18n.i18nString("upload_only_pdf_files"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1,$scope.importBotInstructionsName=$scope.importBotInstructions.name;var data=new FormData;data.append("file",$scope.importBotInstructions),data.append("fileContext","workflows"),data.append("fileExtension","pdf"),$scope.fileUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){$scope.smartBotSettings.uploadedfileId=response.data.fileId,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:$scope.importBotInstructions.name}),"success"),$scope.fileUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.fileUploading=!1})},$scope.saveSBsettings=function(form){if($scope.saveInprogress=!0,form&&form.$invalid){if(!$scope.smartBotSettings.description)return form_util.touch(form),void($scope.saveInprogress=!1);if(""!==$scope.smartBotSettings.instructionsURL&&form.instructionsURL&&form.instructionsURL.$invalid)return form_util.touch(form),NotificationService.notify(i18n.i18nString("provide_valid_instruction_url"),"error"),void($scope.saveInprogress=!1)}if($scope.smartBotSettings&&!$scope.smartBotSettings.instructionsURL&&!$scope.smartBotSettings.uploadedfileId&&!$scope.smartBotSettings.configInst)return NotificationService.notify(i18n.i18nString("provide_valid_instructions_url_or_instructions"),"error"),void($scope.saveInprogress=!1);var myPostData={};myPostData={solutionBotSettings:{botDesc:$scope.smartBotSettings.description,configInstURL:$scope.smartBotSettings.instructionsURL}},"pdfDoc"==$scope.smartBotSettings.instructionsType?myPostData.solutionBotSettings.configInstFileId=$scope.smartBotSettings.uploadedfileId:"plainText"==$scope.smartBotSettings.instructionsType&&(myPostData.solutionBotSettings.configInst=$scope.smartBotSettings.configInst),BTStreamsService.editStream($scope.stream._id,myPostData).then(function(res){res.data.solutionBotSettings&&res.data.solutionBotSettings.configInst?($scope.smartBotSettings.configInst=res.data.solutionBotSettings.configInst,$scope.smartBotSettings.instructionsType="plainText",$scope.importBotInstructions={}):res.data.solutionBotSettings&&res.data.solutionBotSettings.configInstFileId&&($scope.smartBotSettings.uploadedfileId=res.data.solutionBotSettings.configInstFileId,$scope.smartBotSettings.instructionsType="pdfDoc",$scope.importBotInstructions.name="Instructions.pdf"),NotificationService.notify(i18n.i18nString("settings_saved_sucessfully"),"success"),$scope.stream.solutionBotSettings=res.data.solutionBotSettings,$workflowService.selectedStream($scope.stream),$scope.saveInprogress=!1},function(res){$scope.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.$emit("nestedComponentLoaded",{id:"smartBotSettings",flag:!1})}]}})}(angular),function(ng){var _module=ng.module("bt-forms");_module.directive("botFunctions",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-functions/bot-functions.html",controller:["$scope","$workflowService","$location","$timeout","BTStreamsService","$element","env_conf","BTFileUploadService","$applicationService","accessControlService","_constants_","i18n",function($scope,$workflowService,$location,$timeout,BTStreamsService,$element,env_conf,BTFileUploadService,$applicationService,accessControlService,_constants_,i18n){function getBotFunctions(){BTStreamsService.getBotFunctions($workflowService.selectedStream()._id).then(function(res){$scope.file.fileData=res.data[0]},function(errRes){console.log("Failed getting bot functions")})}function initDragDropFile(){!function(window){function triggerCallback(e,callback){if(callback&&"function"==typeof callback){var files;e.dataTransfer?files=e.dataTransfer.files:e.target&&(files=e.target.files),callback.call(null,files)}}function makeDroppable(ele,callback){if(!($element.find('[type="file"]').length>0)){var input=document.createElement("input");input.setAttribute("type","file"),input.setAttribute("multiple",!0),input.style.display="none",input.id="fileInputID",input.addEventListener("change",function(e){triggerCallback(e,callback)}),ele=ele[0],ele.appendChild(input),ele.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.add("dragover")}),ele.addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover")}),ele.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover"),triggerCallback(e,callback)}),$(ele).find(".browseBtn")[0].addEventListener("click",function(){input.value=null,input.click()})}}window.makeDroppable=makeDroppable}(window),function(window){window.makeDroppable($(".fileDropContainer"),function(files){$scope.uploadFile(files[0])})}(window)}function startImportProgress(){$scope.totalProgress=1,progressInterval=setInterval(function(){$scope.totalProgress>90&&($scope.totalProgress=90),$scope.totalProgress+=.1},350)}function downloadBatchTestingURI(uri,name){var link=document.createElement("a");link.href=uri+"&clientfilename="+name+"&batchtesting=true",name&&(link.download=name),link.click()}$scope.advancedDisplayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.dragDropIcon=window.appConfig.CONTEXT_PATH+"/assets/images/import.png",$scope.importingIcon=env_conf["context-url"]+"/assets/images/importing.png",$scope.importDoneIcon=env_conf["context-url"]+"/img/import-success.png",$scope._constants_=_constants_,getBotFunctions(),$scope.stream=$workflowService.selectedStream(),$scope.file={},$scope.uploadFile=function(fileObject){var _ext="";if(fileObject&&fileObject.name){_ext=fileObject.name.substring(fileObject.name.lastIndexOf("."));var supportingFileFormats=[".js"];if(-1===$.inArray(_ext,supportingFileFormats))return void NotificationService.notify(i18n.i18nString("upload_only_js_files"),"error")}var _fileLimit=5e5;if(fileObject.size>_fileLimit)return void NotificationService.notify(i18n.i18nString("file_size_shouldnot_exced_err_noty"),"warning");var data=new FormData;data.append("file",fileObject),data.append("fileContext","bulkImport"),data.append("fileExtension","txt"),data.append("Content-Type",fileObject.type),$scope.data=data,$scope.fileObject=fileObject,$scope.fileName=fileObject.name,$scope.fileuploading=!0,BTStreamsService.uploadBotFunctionsFile($applicationService.userInfo().userId,data).then(function(response){var fileUploaded={fileName:$scope.fileName,fileId:response.data.fileId};$scope.fileObject=fileUploaded,$scope.fileuploading=!1},function(err){NotificationService.notify(i18n.i18nString("oops_label")+err.data.errors[0].msg,"error"),$scope.fileuploading=!1})},$scope.importCustomScriptModal=function(){$scope.importStep=1,$(".import-customScript-modal").modal("show"),$timeout(function(){initDragDropFile()},500)},$scope.onCancelCustomScript=function(){$(".import-customScript-modal").modal("hide"),$scope.fileName=""},$scope.startImport=function(){BTFileUploadService.uploadFile($scope.data).then(function(response){$scope.importStep=3,$scope.totalProgress=1,$scope.qafileuploading=!0,$timeout(function(){if($scope.fileObject){var _parms={fileName:$scope.fileObject.fileName,fileId:$scope.fileObject.fileId};BTStreamsService.addBotFunctions($workflowService.selectedStream()._id,_parms).then(function(res){$scope.importStep=4,$scope.file.fileData=res.data,$scope.file.fileData.fileName=res.data.fileName,getBotFunctions(),startImportProgress(),NotificationService.notify(i18n.i18nString("saved_successfully"),"success")},function(errRes){$scope.importStep=2,NotificationService.notify(i18n.i18nString("failed_saving_err_noty"),"error")})}else NotificationService.notify(i18n.i18nString("please_choose_a_file_err"),"warning")},3e3)},function(response){$scope.totalProgress=100,$scope.importStep=2,$scope.errorMsg=response.data.errors})},$scope.removeFile=function(){$scope.fileName=""},$scope.deleteBotFunctions=function(file){NotificationService.alert(i18n.i18nString("do_you_want_to_delete_bot_function_label"),function(){var _parms={fileName:file.fileData.fileName,fileId:file.fileData.fileId};BTStreamsService.deleteBotFunctions($workflowService.selectedStream()._id,_parms).then(function(res){$scope.file.fileData.fileName="",NotificationService.notify(i18n.i18nString("bot_function_removed_sucess"),"success")},function(errRes){console.log("Failed deleting bot functions")})},{okText:i18n.i18nString("ok_label")})},$scope.getDate=function(){var timestamp=$scope.file.fileData.createdOn;return void 0===timestamp?"--":moment(timestamp).format("MM-DD-YYYY")},$scope.getTime=function(){var timestamp=$scope.file.fileData.createdOn;return void 0===timestamp?"--":moment(timestamp).format("h:mm A")},$scope.downloadFile=function(){function startExport(){BTStreamsService.botFunctionsDownloadFile($scope.stream._id,$scope.file.fileData.fileId).then(function(res){res&&res.data&&downloadBatchTestingURI(res.data.fileUrl,$scope.file.fileData.fileName)})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("download_script")):startExport()},$scope.$emit("nestedComponentLoaded",{id:"botFunctions",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("botNlpMeta",function(){return{restrict:"EA",scope:{stream:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-nlp-meta/bot-nlp-meta.html",controller:["$scope","BTStreamsService","_constants_","NotificationService","$q","i18n",function($scope,BTStreamsService,_constants_,NotificationService,$q,i18n){$scope._constants_=_constants_,$scope.settings={},$scope.oldSettings={},$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.save=function(){$scope.oldSettings.profileRequired="true"===$scope.settings.profileRequired&&$scope.settings.profileRequired?!0:!1,$scope.oldSettings.sendVcf=$scope.oldSettings.profileRequired&&"true"===$scope.settings.sendVcf&&$scope.settings.sendVcf?!0:!1,$scope.oldSettings.offKoraConfirmation=$scope.settings.offKoraConfirmation,$scope.oldSettings.allowEdit=!0,BTStreamsService.editStream($scope.stream._id,$scope.oldSettings).then(function(res){NotificationService.notify(i18n.i18nString("nlp_settings_saved_success_noty"),"success")},function(err){NotificationService.notify(i18n.i18nString("nlp_settings_saved_failed_noty"),"error")})},$scope.cancel=function(){$scope.settings=angular.copy($scope.oldSettings)},$scope.getStream=function(id){$q.all([BTStreamsService.getBTStream(id),BTStreamsService.getMPStream(id)]).then(function(res){$scope.settings=angular.extend($scope.settings,res[0].data),$scope.settings=angular.extend($scope.settings,res[1].data),$scope.oldSettings=angular.copy($scope.settings),delete $scope.oldSettings._id},function(err){NotificationService.notify(i18n.i18nString("some_thing_went_wrong_label"),"error")})},$scope.getStream($scope.stream._id)}]}})}(angular),function(ng){var _botOntologyClassesForm=angular.module("bt-forms");_botOntologyClassesForm.directive("botOntologyClasses",function(){return{restrict:"EA",scope:{ontologyClassModal:"=?",callback:"=?",modalSlider:"=?",knowledgeTask:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-ontology-classes/bot-ontology-classes.html",controller:"botOntologyClassCtrl"}}),_botOntologyClassesForm.controller("botOntologyClassCtrl",["$scope","$rootScope","NotificationService","form_util","$timeout","botOntologyService","$workflowService","$applicationService","env_conf","i18n",function($scope,$rootScope,NotificationService,form_util,$timeout,botOntologyService,$workflowService,$applicationService,env_conf,i18n){$scope.stream=$workflowService.selectedStream(),$scope.userInfo=$applicationService.userInfo();var selectedLanguage=$workflowService.currentLanguage();$scope.rightClass="right900",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.forms={},$scope.forms.ontologyClassForm={},$scope.forms.ontologyClassUpdateForm={},$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.updating=i18n.i18nString("updating_label_1"),$scope.update=i18n.i18nString("update"),$scope.placeholder=i18n.i18nString("type_utterance"),$scope.limit=10;var hasOntologyClass=!1;$scope.$watch("limit",function(newVal,oldVal){$scope.limit=newVal}),$timeout(function(){$('input[name="newClassName"]').focus()},100),$scope.ontologyClasses={},$scope.ontologyClassModal={open:function(){$scope.modalSlider.open(".ontologyClassesModal"),hasOntologyClass=$("body").hasClass("ontologymodalopen"),hasOntologyClass&&$("body").removeClass("ontologymodalopen"),$scope.getClasses(),$timeout(function(){$('input[name="newClassName"]').focus()},500)},close:function(){$scope.modalSlider.close(".ontologyClassesModal"),hasOntologyClass&&$("body").addClass("ontologymodalopen"),$scope.cancelClassUpdate(),$scope.emptyClassForm()}},$scope.ontologyClasses.classes=[],$scope.emptyClassForm=function(){$scope.newClassName="",$scope.newUtterances=[],$scope.forms.ontologyClassForm.$setPristine(),$scope.showNewClassForm=!1},$scope.ontologyClasses.editIndex=-1,$scope.cancelClassUpdate=function(){$scope.ontologyClasses.classes[$scope.ontologyClasses.editIndex]=$scope.ontologyClasses.updateClassCopy,$scope.ontologyClasses.editIndex=-1},$scope.openEditClassForm=function(classToUpdate){$scope.showNewClassForm=!1,$scope.emptyClassForm(),$timeout(function(){$scope.ontologyClasses.updateClassCopy=angular.copy(classToUpdate),$('input[name="updateClassName"]').focus()},500)},$scope.cloneClass=function(classToClone){function confirmClone(){function findDupName(className){var duplicateName=_.find($scope.ontologyClasses.classes,{name:className});return dup=duplicateName?!0:!1}var classData=angular.copy(classToClone),dup=!1;for($scope.showNewClassForm=!1,$scope.emptyClassForm(),findDupName(classData.name);dup;)classData.name="Copy_of_"+classData.name,dup=findDupName(classData.name);var classPayload={name:classData.name,streamId:$scope.stream._id,botName:$scope.stream.name,utterances:classToClone.utterances,language:$scope.stream.defaultLanguage||"en"};$scope.saveInProgress=!0,botOntologyService.createClass($scope.userInfo.userId,$scope.stream._id,classPayload).then(function(res){$scope.ontologyClasses.editIndex=-1,$scope.getClasses(),$scope.emptyClassForm(),$rootScope.$emit("updateClasses"),$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("clone_class_success"),"success")},function(error){error.data.errors&&error.data.errors.length>0?NotificationService.notify(error.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_class_clone"),"error"),$scope.saveInProgress=!1})}function cancleClone(){}NotificationService.userConfirm(i18n.i18nString("duplicate_class"),[confirmClone,cancleClone],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("confirm_unlock_name"))},$scope.createClass=function(){if(!isValidForm($scope.forms.ontologyClassForm))return void form_util.touch($scope.forms.ontologyClassForm);if(!$scope.newUtterances.length)return void NotificationService.notify(i18n.i18nString("utterance_req"),"error");var classPayload={name:$scope.newClassName,streamId:$scope.stream._id,botName:$scope.stream.name,utterances:$scope.newUtterances,language:selectedLanguage||"en"};$scope.saveInProgress=!0,botOntologyService.createClass($scope.userInfo.userId,$scope.stream._id,classPayload).then(function(res){$scope.getClasses(),$scope.emptyClassForm(),$rootScope.$emit("updateClasses"),$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("class_saved"),"success")},function(error){error.data.errors&&error.data.errors.length>0?NotificationService.notify(error.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_save"),"error"),$scope.saveInProgress=!1})},$scope.updateClass=function(classId){if(!isValidForm($scope.forms.ontologyClassUpdateForm))return void form_util.touch($scope.forms.ontologyClassUpdateForm);var classObject=_.find($scope.ontologyClasses.classes,{_id:classId});if(!classObject.utterances.length)return void NotificationService.notify(i18n.i18nString("utterance_req"),"error");var classPayload={name:classObject.name,streamId:$scope.stream._id,botName:$scope.stream.name,utterances:classObject.utterances,language:$scope.stream.defaultLanguage||"en"};$scope.saveInProgress=!0,botOntologyService.updateClass($scope.userInfo.userId,$scope.stream._id,classPayload,classId).then(function(res){$scope.ontologyClasses.editIndex=-1,$rootScope.$emit("updateClasses"),$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("class_updated"),"success")},function(error){error.data.errors&&error.data.errors.length>0?NotificationService.notify(error.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_update"),"error"),$scope.saveInProgress=!1})},$scope.deleteClass=function(index,classId){function detete(){botOntologyService.deleteClass($scope.userInfo.userId,$scope.stream._id,classId).then(function(res){$scope.ontologyClasses.editIndex==index&&($scope.ontologyClasses.editIndex=-1),$rootScope.$emit("updateClasses"),$scope.getClasses(),NotificationService.notify(i18n.i18nString("class_remove"),"success")},function(error){})}NotificationService.alert("",detete,{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("class_delete"))},$scope.openAddClassForm=function(){$scope.ontologyClasses.editIndex=-1,$(".classesmodalbody").scrollTop(0),$timeout(function(){$('input[name="newClassName"]').focus()},100)},$scope.moreAvailable=!0,$scope.getClasses=function(offset,isFromPagination){if(isFromPagination){if(!$scope.moreAvailable||$scope.loadingPaginatedClasses)return;$scope.loadingPaginatedClasses=!0,offset=$scope.ontologyClasses.classes.length}offset=offset||0;var state=$scope.knowledgeTask.state;botOntologyService.getClasses($scope.userInfo.userId,$scope.stream._id,offset,$scope.limit,state).then(function(res){isFromPagination?$scope.ontologyClasses.classes=[].concat($scope.ontologyClasses.classes,res.data.classes):$scope.ontologyClasses.classes=res.data.classes||[],$scope.totalItems=res.data.count,$scope.moreAvailable=res.data.moreAvailable,$timeout(function(){$scope.bindScrollPagination()},200),$scope.loadingPaginatedClasses=!1},function(error){})};var isValidForm=function(form){return form.$valid};$scope.bindScrollPagination=function(){var formContainerEle=$(".classesmodalbody");formContainerEle.unbind("scroll").bind("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.getClasses("",!0)})}}])}(angular),function(ng){var _boqImportForm=angular.module("bt-forms");_boqImportForm.directive("botOntologyQaImport",function(){return{restrict:"EA",scope:{elem:"@?",importQaModal:"=",knowledgeTask:"=?",callback:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-ontology-qa-import/bot-ontology-qa-import.html",controller:"boqImportCtrl"}}),_boqImportForm.controller("boqImportCtrl",["$scope","env_conf","$interval","botOntologyService","$timeout","$applicationService","NotificationService","BTStreamsService","$workflowService","i18n","mixPanel",function($scope,env_conf,$interval,botOntologyService,$timeout,$applicationService,NotificationService,BTStreamsService,$workflowService,i18n,mixPanel){function startImportProgress(){$scope.totalProgress=1,progressInterval=setInterval(function(){$scope.totalProgress>90&&($scope.totalProgress=90),$scope.totalProgress+=.1},350)}function initDragDropFile(){!function(window){function triggerCallback(e,callback){if(callback&&"function"==typeof callback){var files;e.dataTransfer?files=e.dataTransfer.files:e.target&&(files=e.target.files),callback.call(null,files)}}function makeDroppable(ele,callback){var input=document.createElement("input");input.setAttribute("type","file"),input.setAttribute("multiple",!0),input.style.display="none",input.id="fileInputID",input.addEventListener("change",function(e){triggerCallback(e,callback)}),_.forEach(ele,function(element){$(element).hasClass("dragDrop")&&(ele=element)}),ele.appendChild(input),ele.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.add("dragover")}),ele.addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover")}),ele.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover"),triggerCallback(e,callback)});for(var i=0;i<$(".browseBtn").length;i++)$(".browseBtn")[i].addEventListener("click",function(){input.value=null,input.click()})}window.makeDroppable=makeDroppable}(this),function(window){window.makeDroppable($(".fileDropContainer"),function(files){console.log(files),$scope.uploadCSVorJSONFile(files[0])})}(this)}$scope.fileExtension="",$scope.importStep=1,$scope.showWarning=!1,$scope.contextUrl=env_conf["context-url"],$scope.assetsBase=env_conf["assets-url"];var hasOntologyClass=!1;$scope.importQaModal.openModal=function(){$("#"+$scope.elem).modal("show"),hasOntologyClass=$("body").hasClass("ontologymodalopen"),hasOntologyClass&&$("body").removeClass("ontologymodalopen"),$scope.importStep=1,$scope.removeFile()},$scope.importQaModal.closeModal=function(loadFAQs){$("#"+$scope.elem).modal("hide"),hasOntologyClass&&$("body").addClass("ontologymodalopen"),loadFAQs&&"ontology_qa_import1"!==$scope.elem&&$scope.callback.getKTData(!0),"ontology_qa_import1"===$scope.elem&&$scope.callback.getKnowledgeTasksOnto(),
$scope.importStep=1},$scope.moveForward=function(importStep){$scope.importStep=importStep,2==importStep&&($scope.removeFile(),$timeout(function(){initDragDropFile()},500))},$scope.goToStep=function(stepNo){$scope.importStep=stepNo,2==stepNo&&($scope.moveForward(stepNo),$scope.removeFile())},$scope.resetFileUploadData=function(){$("#fileInputID").val(""),$scope.fileName=""},$scope.confirmImport=function(){$scope.totalProgress=1,$scope.importStep=3,BTStreamsService.uploadFAQFile($applicationService.userInfo().userId,$scope.data).then(function(response){$scope.fileUploaded={fileName:$scope.fileObject.name,fileId:response.data.fileId},startImportProgress(),$scope.fileObject=$scope.fileUploaded,$scope.qafileuploading=!1,$scope.importFileByFileID()},function(response){response.data&&response.data.errors&&response.data.errors[0]&&response.data.errors[0].msg?$scope.errorMsg=response.data.errors[0].msg:$scope.errorMsg=response.statusText,clearInterval(progressInterval),progressInterval=null,$scope.totalProgress=100,$scope.importStep=5,$interval.cancel(statusInterval),$scope.qafileuploading=!1})},$scope.importFAQFileBYFileIDForce=function(){var requestData={fileName:$scope.fileUploaded.fileId,fileType:$scope.fileUploaded.fileName.substring($scope.fileUploaded.fileName.lastIndexOf(".")+1),importType:"override",delimiter:",",streamId:$workflowService.selectedStream()._id,knowledgeTaskId:$scope.knowledgeTask._id};BTStreamsService.importFAQFileBYFileIDForce($applicationService.userInfo.userId,requestData).then(function(response){$scope.getImportFAQStatus(),statusInterval=$interval(function(){$scope.getImportFAQStatus()},5e3),$scope.importStep=3},function(response){})},$scope.importFileByFileID=function(){var requestData={fileName:$scope.fileUploaded.fileId,fileType:$scope.fileUploaded.fileName.substring($scope.fileUploaded.fileName.lastIndexOf(".")+1),importType:"override",delimiter:",",streamId:$workflowService.selectedStream()._id,knowledgeTaskId:$scope.knowledgeTask._id};BTStreamsService.importFAQFileBYFileID($applicationService.userInfo.userId,requestData).then(function(response){$scope.getImportFAQStatus(),statusInterval=$interval(function(){$scope.getImportFAQStatus()},5e3),$scope.importStep=3},function(response){})};var statusInterval="",progressInterval="";$scope.totalProgress=1,$scope.getImportFAQStatus=function(){var callName="streams/"+$workflowService.selectedStream()._id+"/knowledgetask/"+$scope.knowledgeTask._id+"/importfaq";botOntologyService.getImportFAQStatus($applicationService.userInfo.userId,$workflowService.selectedStream()._id,callName).then(function(response){if($scope.importStep=3,"success"==response.data.status){response.data.raiseWarning&&($scope.showWarning=response.data.raiseWarning),clearInterval(progressInterval),progressInterval=null,$scope.totalProgress=100,$scope.importStep=4,$interval.cancel(statusInterval);var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Knowledge Graph","Knowledge import source":($scope.fileExtension||"").replace(".","").toUpperCase()};mixPanel.postEvent("Conversation - Knowledge graph imported",eventInfo)}else"failed"==response.data.status&&response.data.isOldFormat===!0?(clearInterval(progressInterval),progressInterval=null,$scope.totalProgress=100,$scope.importStep=6,$interval.cancel(statusInterval)):"failed"==response.data.status&&($scope.errorMsg=response.data.message,clearInterval(progressInterval),progressInterval=null,$scope.totalProgress=100,$scope.importStep=5,$interval.cancel(statusInterval))},function(response){})},$scope.fileUploaded={},$scope.uploadCSVorJSONFile=function(fileObject){var _ext="";if(fileObject.name){_ext=fileObject.name.substring(fileObject.name.lastIndexOf("."));var supportingFileFormats=[".csv",".json",".pdf",".zip"];if(-1===$.inArray(_ext,supportingFileFormats))return NotificationService.notify(i18n.i18nString("upload_only_csv_json_pdf_zip_file"),"error"),void($scope.fileExtensionError=!0);$scope.fileExtension=_ext}var reader=new FileReader;reader.readAsText(fileObject),reader.onload=function(e){var respnoseData=reader.result;if(!respnoseData||respnoseData&&!respnoseData.length)NotificationService.notify(i18n.i18nString("please_upload_a_valid_file",{dyn:_ext.slice(1).toUpperCase()}),"error"),$scope.fileEmptyError=!0;else{$scope.fileName=fileObject.name,$scope.fileExtensionError=!1;var data=new FormData;data.append("file",fileObject),data.append("fileContext","bulkImport"),data.append("fileExtension",_ext.substring(_ext.lastIndexOf(".")+1)),data.append("Content-Type",fileObject.type),$scope.qafileuploading=!0,$scope.data=data,$scope.fileObject=fileObject}}},$scope.removeFile=function(){$scope.fileName="",$scope.fileUploaded={}}}])}(angular),function(ng){var _botOntlogyQAForm=ng.module("bt-forms");_botOntlogyQAForm.directive("botOntologyQa",function(){return{restrict:"EA",scope:{boc:"=?",faqData:"=?",kt:"=?",nodeId:"=?",totalFaqs:"=?",nodeLabel:"=?",path:"=?",pathTags:"=?",termPath:"=?",levelOneNode:"=?",demoTemplates:"=",selectType:"=",navigateFrom:"@",faqSearchTerm:"@",callback:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-ontology-qa/bot-ontology-qa.html",controller:"botOntologyQACtrl"}}),_botOntlogyQAForm.controller("botOntologyQACtrl",["$rootScope","$scope","form_util","NotificationService","$timeout","BTStreamsService","$workflowService","botOntologyService","$applicationService","channelsConfig","env_conf","$element","_constants_","i18n","uuid","accessControlService","mixPanel",function($rootScope,$scope,form_util,NotificationService,$timeout,BTStreamsService,$workflowService,botOntologyService,$applicationService,channelsConfig,env_conf,$element,_constants_,i18n,uuid,accessControlService,mixPanel){function getTextEncoded(name){return name?name.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function getSecondLevelNodeOfNodeId(nodeId){var map=_.indexBy($scope.kt.taxonomy,"nodeId"),parents=[],rootNodeId=$scope.kt.taxonomy[0].nodeId;if(rootNodeId){for(var node=map[nodeId];node&&node.nodeId!==rootNodeId&&node.parent[0]!==rootNodeId;)node=map[node.parent[0]];node&&node.nodeId!==rootNodeId&&parents.push(node)}return parents[0]}function encodeJS(_obj){return encodeURIComponent(_obj)}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function scrollToEle(element){var _PanelEle=$(element);if(_PanelEle){var _container=_PanelEle.closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=_PanelEle.offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"slow")}}}function setTermUsageOnLoad(termUsageName){$(".dropdown-select").find(".selectfield")[0].innerText=termUsageName[0].toUpperCase().concat(termUsageName.slice(1,termUsageName.length)),angular.forEach($scope.termUsageTypes,function(term){term.id===termUsageName&&(term.selected=!0)})}function getBotSynonyms(){if($scope.botSynonyms.synonyms=[],$scope.boqObject.clickedTag){var _synonmysKeys,_synonymsValues;_synonmysKeys=JSON.stringify(Object.keys($scope.stream.synonyms||{})),_synonymsValues=Object.values($scope.stream.synonyms||{}),_synonmysKeys=_synonmysKeys.replace(/~/g,"");var _synonmysKeysArr=JSON.parse(_synonmysKeys),_termData=angular.copy($scope.boqObject.clickedTag);_termData.tag=_termData.tag.replace(/~/g,"");var _resultArray=[];_synonmysKeysArr.filter(function(value,index){value.toLowerCase()===_termData.tag.toLowerCase()&&_resultArray.push({value:value,index:index})}),_resultArray.length&&1===_resultArray.length?$scope.botSynonyms.synonyms=_synonymsValues[_resultArray[0].index]:_resultArray.length&&_resultArray.length>1?_.map(_resultArray,function(value,index){$scope.botSynonyms.synonyms=$scope.botSynonyms.synonyms.concat(_synonymsValues[_resultArray[index].index])}):_.isEmpty($scope.botSynonyms)||($scope.botSynonyms={})}}function validateEditors(){$.each($scope.rModel,function(i,rdata){rdata.text||(rdata.text=" "),rdata.addOnAns&&$.each(rdata.addOnAns,function(i,addOnAns){addOnAns.text||(addOnAns.text=" ")})})}function hasErrors(){var _error=!1,selectedChannels=_.pluck($scope.rModel,"channel");return-1===$.inArray("default",selectedChannels)&&(_error=!0),_error}function getTermGlobalSynonyms(){if($scope.boqObject.clickedTag){var offset="",limit="",search="",keyword=$scope.boqObject.clickedTag.tag,state=$scope.kt.state;BTStreamsService.getKtGlobalSynonyms($scope.stream._id,offset,limit,search,keyword,state,$scope.kt._id).then(function(res){$scope.tagResponseSynonyms=$workflowService.cloneData(res.data),$scope.placeholderMsg="  ",$scope.emptyPlaceHolder="  ",res.data.synonyms.length&&res.data.synonyms[0].synonyms?(res.data.synonyms[0].synonyms=_constants_.getAlphabeticallySortedArray(res.data.synonyms[0].synonyms),$scope.tagSynonyms=res.data.synonyms[0]):$scope.tagSynonyms=[],$scope.placeholderMsg="  ",$scope.emptyPlaceHolder="  "},function(err){NotificationService.notify(i18n.i18nString("error_fetch_synonyms"),"error")})}}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_KNOWLEDGE_GRAPH"),$scope.stream=$workflowService.selectedStream(),$scope.userInfo=$applicationService.userInfo(),$scope.assetsBase=env_conf["assets-url"],$scope.helpIcon=$scope.assetsBase+"icons/helpIcon.svg",$scope.knowledgeTask=$workflowService.taskEditInfo()||[],console.log($scope.totalFaqs),$scope.boqObject={},$scope.curBot={state:$workflowService.selectedStreamState()};$workflowService.currentLanguage();$scope.emptyPlaceHolder="  ",$scope.newOverride={},$scope.newOverride.isMarkDown=!0,$scope.faqDisplay={},$scope.enableDisable={},$scope.enableDisable.faqStatus=!0,$scope.gHelpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.caretDown=env_conf["context-url"]+"/assets/icons/caretDown.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.arrowAngle=window.appConfig.CONTEXT_PATH+"/assets/icons/arrowAngle.svg",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.infoGray=window.appConfig.CONTEXT_PATH+"/assets/icons-new/info/info-gray.svg",$scope.exclamationTriangleRed=window.appConfig.CONTEXT_PATH+"/assets/icons-new/exclamation-triangle/exclamation-triangle-red.svg",$scope.gHelpIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/gHelpIcon.svg",$scope.rightClass="right900",$scope.focusOutdisplay=!1,$scope.linkingFaqSliderOpen=!1,$scope.referenceId="",$scope.activeResponse="";var prevResponseType="",iniNavigation=!0;$scope.botSynonyms={},$scope.ontology={},$scope.ontology.allFAQsSelected=!1,$scope.showOntologyTagsModal=!1,$scope.ontology.allQAS=[],$scope.searchLinkFaq={},$scope.noeditLinkFaq=!1,$scope.hideListFaqs=!1,$scope.showProtipLinkFaq=!1,$scope.showEditButton=!1,$scope.faqstats={},$scope.faqstats.limit=30,$scope.intentFilter=[{name:"All",state:!0},{name:"FAQs",state:!1},{name:"Tasks",state:!1}],$scope.selectedFilter={val:""},$scope.navigate={from:""},$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.addUtterance=i18n.i18nString("add_utterance_kg"),$scope.addAltUtterance=i18n.i18nString("add_alt_utterance"),$scope.addQuestion=i18n.i18nString("add_question"),$scope.addAltQuestion=i18n.i18nString("add_alt_question"),$scope.data=[{nodeId:uuid.v4(),label:getTextEncoded($scope.stream.name),"class":"bgblack",level:"l0",parent:[],synonyms:[],nodes:[]}],$scope.tasks={searchString:""},$scope.dataContent={pattern:i18n.i18nString("alternate_ques")+' <a target="_blank" href="'+$rootScope.helpLinks.KG_FAQS_PATTERN+'">'+i18n.i18nString("know_more")+"</a>"},$scope.termUsageTypes=[{id:"default",name:i18n.i18nString("constants.propertyPanel_default"),description:i18n.i18nString("term_usage"),type:"default","class":"defaultColor"},{id:"mandatory",name:i18n.i18nString("mandatory"),description:i18n.i18nString("user_synonyms"),type:"mandatory","class":"mandatoryColor",icon:$rootScope.mandatory}],$scope.cancelFlag=!0,$scope.init=function(){$scope.cancelFlag=!0,$timeout(function(){$scope.cancelFlag=!1,$scope.ontologyQAForm&&$scope.ontologyQAForm.$setPristine(),$("[data-toggle=popover]").popover({html:!0,delay:{hide:1e3}})},1e3)},$scope.closeUpdateFaqModal=function(){$scope.linkingFaqSliderOpen=!1,$scope.linkFaqs=[],$scope.searchLinkFaq.faqLinkSearchTerm="",$scope.faqSelected.selected="",$scope.closeModalSlider("#linkingFaqModalSlider")},$scope.openLinkingFaqSlider=function(){$scope.linkingFaqSliderOpen=!0,$scope.getFaqsByKnowledge(),$scope.openModalSlider("#linkingFaqModalSlider")},$scope.searchFAQ=function(event){$scope.hideFaqLink=!1,$scope.showSearchResults=!1,event||($scope.searchLinkFaq.faqLinkSearchTerm="",$scope.getFaqsByKnowledge("","","","",$scope.hideFaqLink,!0)),!event||13!=event.keyCode&&$scope.searchLinkFaq.faqLinkSearchTerm||$scope.getFaqsByKnowledge("",!1,"","",$scope.hideFaqLink,!0)},$scope.moreAvailable=!0,$scope.getFaqsByKnowledge=function(offset,isFromNode,isFromPagination,isFKora,hideFaqLink,fromSearch){var searchParam=encodeJS($scope.searchLinkFaq.faqLinkSearchTerm)||"";if(offset=offset||0,void 0===isFromNode&&(isFromNode=!0),isFromNode&&($scope.faqsLoaded=!1,searchParam="",$scope.searchLinkFaq.faqLinkSearchTerm="",$scope.ontology.qas=[]),$scope.loadingFaqs=!0,isFromPagination){if(!$scope.moreAvailable||$scope.loadingPaginatedFAQs)return;$scope.faqPaginationFlag=!0,$scope.loadingPaginatedFAQs=!0,offset=$scope.ontology.qas.length}$scope.faqsFromNode=isFromNode,$workflowService.storeSearchQry().userSearchQueryFlag&&(searchParam=$workflowService.storeSearchQry().searchQry,$scope.searchLinkFaq.faqLinkSearchTerm=searchParam,$workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:""})),searchParam?$scope.isFromSearch=!0:$scope.isFromSearch=!1;var selFilter=$scope.intentFilter.filter(function(val){return val.state});selFilter&&selFilter[0]&&($scope.selectedFilter.val=selFilter[0].name.toLowerCase());var containerHeight=0,container=$("#faqsLinkedCollectectionBody");container&&container[0]&&container[0].scrollHeight&&(containerHeight=container[0].scrollHeight+20),$scope.withallchild=!0,$scope.knowledgeTask.length||($scope.knowledgeTask=$scope.kt),BTStreamsService.getOrSearchFAQS($applicationService.userInfo.userId,$scope.knowledgeTask._id,searchParam,offset,$scope.faqstats.limit,$scope.callback.parentId,""+$scope.withallchild,$scope.selectedFilter.val).then(function(response){(!$scope.linkFaqs||fromSearch)&&($scope.linkFaqs=[]),$scope.showSearchResults=!1,$scope.loadingFaqs=!1,_.forEach(response.data.faqs,function(eachFaq){eachFaq.path=$scope.callback.getFaqPath(eachFaq.parent),eachFaq.path||(eachFaq.path=eachFaq.leafterm),eachFaq&&!eachFaq.faqLinkedTo&&$scope.linkFaqs.push(eachFaq)}),$scope.linkFaqs.length||($scope.showSearchResults=!0),hideFaqLink&&($scope.linkFaqs=[]),response.data.count&&($scope.totalFaqCount=response.data.count),$scope.moreAvailable=response.data.moreAvailable,$.each(response.data.faqs,function(i,qa){$.map(qa.answerPayload,function(answerObject){return answerObject.text=decodeJS(answerObject.text),answerObject}),qa.questionPayload&&qa.questionPayload.question&&(qa.questionPayload.question=qa.questionPayload.question||""),$.each(qa.subAnswers,function(i,answerObject){$.map(answerObject,function(subanswerObject){return subanswerObject.text=decodeJS(subanswerObject.text),subanswerObject})})}),$scope.faqPaginationFlag=!1,isFromPagination?$scope.ontology.allQAS=[].concat($scope.ontology.allQAS,response.data.faqs):($scope.ontology.allQAS=response.data.faqs,$scope.faqsLoaded=!0),$scope.totalItems=response.data.count,$scope.ontology.qas=$scope.ontology.allQAS.reverse()||[],$scope.ontology.allQAS.length?($("body").addClass("ontologymodalopen"),$scope.showBulkImport=!1):$scope.withallchild&&$scope.activeNodeId==$scope.data[0].nodeId&&($scope.showBulkImport=!0,$("body").removeClass("ontologymodalopen")),isFromPagination||$("#faqsLinkedCollectectionBody").scrollTop(0),$timeout(function(){isFromPagination&&$("#faqsLinkedCollectectionBody").scrollTop(containerHeight),$scope.loadingPaginatedFAQs=!1,$timeout(function(){isFromPagination||$scope.bindScrollPagination()},200),$rootScope.$emit("pefectScrollUpdate"),$workflowService.storeSearchQry().userSearchQueryFlag&&$workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:"",navigateTo:""}),!isFKora&&$scope.isFromKora&&koraFaq&&$scope.showOntologyQAForm()},250)},function(error){$scope.loadingPaginatedFAQs=!1,$scope.faqsLoaded=!0})},console.log($scope.linkFaqs),$scope.bindScrollPagination=function(){var formContainerEle=$("#faqsLinkedCollectectionBody");formContainerEle.unbind("scroll").bind("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.7*$(this)[0].scrollHeight&&($scope.loadingPaginatedFAQs||$scope.getFaqsByKnowledge("","",!0))})},$scope.faqSelected={},$scope.selectFaqLink=function(index,linkFaq,scope,event){$scope.faqSelected.selected=linkFaq._id},$scope.selectLinkFaq=function(index,linkFaq,scope,event){return _.forEach($scope.linkFaqs,function(eachFAQ){eachFAQ._id==$scope.faqSelected.selected&&(linkFaq=eachFAQ)}),event&&13==event.keyCode?(event.stopPropagation(),event.stopImmediatePropagation(),!1):($scope.hideListFaqs=!0,$scope.returnValue=$scope.callback.openEditFAQ(index,linkFaq,scope,!0),$scope.closeModalSlider("#linkingFaqModalSlider"),$scope.faqData=$scope.returnValue,$scope.intent={selected:"faq"},$scope.faqData?($scope.faqData.questionPayload&&$scope.faqData.questionPayload.question&&($scope.qModel=[{question:$scope.faqData.questionPayload.question,tagsPayload:[].concat($scope.pathTags,$scope.faqData.questionPayload.tagsPayload)||[]}]),$scope.faqDisplay.faqReferenceId=$scope.faqData.referenceId,$scope.faqDisplay.faqDisplayName=$scope.faqData.label,$scope.faqData.responseType||($scope.faqData.answerPayload.length?$scope.faqData.responseType="message":"dialog"===$scope.faqData.responseType?$scope.faqData.responseType="dialog":$scope.faqData.responseType=""),$scope.faqData.subQuestions&&$scope.faqData.subQuestions.length>0&&$.each($scope.faqData.subQuestions,function(i,subquestion){var subQuestionObj={question:subquestion.question,tagsPayload:[].concat($scope.pathTags,subquestion.tagsPayload)||[]};$scope.qModel.push(subQuestionObj)}),"message"===$scope.faqData.responseType&&(reMapWfacebookChannel($scope.faqData.answerPayload[0]),$scope.rModel=[{_id:$scope.faqData.answerPayload[0]._id,text:$scope.faqData.answerPayload[0].text,type:$scope.faqData.answerPayload[0].type,channel:$scope.faqData.answerPayload[0].channel||"default",addOnAns:[]}],$scope.faqData.answerPayload&&$scope.faqData.answerPayload.length>0&&$.each($scope.faqData.answerPayload,function(i,answerPayload){if(i>0){var anspayload={_id:$scope.faqData.answerPayload[i]._id,text:$scope.faqData.answerPayload[i].text,type:$scope.faqData.answerPayload[i].type,channel:$scope.faqData.answerPayload[i].channel||"default"};$scope.rModel[0].addOnAns.push(anspayload)}}),$scope.faqData.subAnswers&&$scope.faqData.subAnswers.length>0&&$.each($scope.faqData.subAnswers,function(i,subanswer){reMapWfacebookChannel(subanswer[0]);var subAnswerObj={_id:subanswer[0]._id,text:subanswer[0].text,type:subanswer[0].type,channel:subanswer[0].channel||"default",addOnAns:[]};$.each(subanswer.slice(1),function(i,subAns){var addonans={_id:subAns._id,text:subAns.text,type:subAns.type,channel:subAns.channel||"default"};subAnswerObj.addOnAns.push(addonans)}),$scope.rModel.push(subAnswerObj)})),$scope.$$phase&&$scope.$apply(),prevResponseType=$scope.faqData.responseType,$timeout(function(){$scope.selectResponseType(prevResponseType)},500)):($scope.faqData={responseType:""},$scope.qModel=[{question:"",tagsPayload:$workflowService.cloneData($scope.pathTags)}],$scope.boc&&$scope.boc.isFromKora&&$scope.boc.koraFaq&&($scope.qModel[0].question=$scope.boc.koraFaq),$scope.faqData.selectedTaskId="",$scope.rModel=[{text:"",type:"basic",channel:"default",addOnAns:[]}]),$scope.alldialogTasks=$workflowService.dialogTasks(),$scope.alldialogTasks.forEach(function(val,ind){$scope.faqData&&$scope.faqData.dialogId&&$scope.faqData.dialogId===val.refId?(val.state=!0,$scope.task.selected=val.name):val.state=!1}),$scope.alldialogTasks=_.filter($scope.alldialogTasks,function(task){return task.isFollowUp?void 0:task}),$scope.referenceId=$scope.faqData.refId,$scope.noeditLinkFaq=!0,$scope.showProtipLinkFaq=!0,void $scope.closeDuplicateLinkModal(!0))},$scope.openSourceLinkFaqModal=function(){$("#sourceLinkFaqModal").modal("show")},$scope.closeSourceLinkModal=function(){$("#sourceLinkFaqModal").modal("hide")},$scope.closeDuplicateLinkModal=function(value){$("#DuplicateLinkFaqModal").modal("hide"),value&&($scope.showDuplicateSymbol=!1)},$scope.showOntologyQAForm=function(){$scope.callback.showOntologyQAForm("",!0)},$scope.redirectToFaq=function(redirectFaq){_.forEach($scope.callback.allFaqs,function(eachFaq){eachFaq.refId===redirectFaq.faqLinkedTo&&($scope.eachfaqData=eachFaq)}),$scope.callback.openEditFAQ("",$scope.eachfaqData),$scope.closeSourceLinkModal(),$scope.noeditLinkFaq=!1,$scope.showProtipLinkFaq=!1,$scope.showEditButton=!1,$scope.callback.showLinkQuestionValue=!1},$scope.callback.shownoEditLinkFaq&&($scope.showProtipLinkFaq=!0,$scope.noeditLinkFaq=!0),$scope.callback.showProtipLinkFaq&&($scope.showProtipLinkFaq=!0,$scope.showEditButton=!0,$scope.noeditLinkFaq=!0),$scope.faqData&&"dialog"===$scope.faqData.responseType&&!$scope.noeditLinkFaq?$scope.intent={selected:"task"}:$scope.faqData&&"message"===$scope.faqData.responseType&&!$scope.noeditLinkFaq?$scope.intent={selected:"faq"}:$scope.intent={selected:"faq"},$scope.faqData&&$scope.faqData.faqStatus===!1?$scope.enableDisable.faqStatus=$scope.faqData.faqStatus:$scope.enableDisable.faqStatus=!0,$scope.task={selected:i18n.i18nString("select_a_task")};var searchParam="";$scope.limit=100,$scope.kt&&($scope.ktid=$scope.kt._id,$scope.faqData&&($scope.faqParentTermlockState=getSecondLevelNodeOfNodeId($scope.faqData.parent))),$scope.selectResponseType=function(type){$scope.rModel||($scope.rModel=[{text:"",type:"basic",channel:"default",addOnAns:[]}]),$scope.faqData.responseType=type,$scope.activeResponse=type},$scope.iconContextPath=env_conf["context-url"]+"/assets/ontology",channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.availableChannels=Object.values(channelsConfig.channelsObject),$scope._channelConfig=channelsConfig,$scope.channelsDropdown=$scope.iconContextPath+"/channelsDropdownIcon.svg";var isWFacebook=!1,wfacebookIndex=0;$scope.availableChannels=$scope.availableChannels.map(function(channel,i){return"wfacebook"===channel.id&&(isWFacebook=!0,wfacebookIndex=i),channel}),isWFacebook&&$scope.availableChannels.splice(wfacebookIndex,1),$scope.availableChannels=_.filter($scope.availableChannels,{enable:!0});var checkAndUpdateWfacebook=function(curChannel){"Workplace For Groups"===curChannel.channel||"wfacebookG"===curChannel.channel?(curChannel.channel="wfacebook",curChannel.isMention=!0):("Workplace For Chat"===curChannel.channel||"wfacebookC"===curChannel.channel)&&(curChannel.channel="wfacebook",curChannel.isMention=!1)};$scope.placeholderQData=function(ind){return 0===ind?"Add Question":"Add Alternate Question"},$scope.boc.updateTraits=function(allTraits){$("#addTraitforKgTags").autocomplete({source:$scope.boc.allTraits})},$scope.intentChange=function(){"faq"===$scope.intent.selected?$scope.faqData.responseType="message":"task"===$scope.intent.selected&&($scope.faqData.responseType="dialog")},$scope.bindAuioCompleteForTags=function(){setTimeout(function(){var id="#addTraitforKgTags";setTimeout(function(){$(id).autocomplete({minLength:1,source:$scope.boc.allTraits,focus:function(event,ui){return $(id).val(ui.item.label),!1},position:{collision:"flip"},select:function(event,ui){return $(id).val(ui.item.label),!1}}).autocomplete("widget").addClass("contextTypeaheadDropdown")},200)},300)};var reMapWfacebookChannel=function(curChannel){"wfacebook"===curChannel.channel&&curChannel.isMention?curChannel.channel="wfacebookG":"wfacebook"!==curChannel.channel||curChannel.isMention||(curChannel.channel="wfacebookC")};$scope.faqData?($scope.faqData.questionPayload&&$scope.faqData.questionPayload.question&&($scope.qModel=[{question:$scope.faqData.questionPayload.question,tagsPayload:[].concat($scope.pathTags,$scope.faqData.questionPayload.tagsPayload)||[]}]),$scope.faqDisplay.faqReferenceId=$scope.faqData.referenceId,$scope.faqDisplay.faqDisplayName=$scope.faqData.label,$scope.faqData.responseType||($scope.faqData.answerPayload.length?$scope.faqData.responseType="message":"dialog"===$scope.faqData.responseType?$scope.faqData.responseType="dialog":$scope.faqData.responseType=""),$scope.faqData.subQuestions&&$scope.faqData.subQuestions.length>0&&$.each($scope.faqData.subQuestions,function(i,subquestion){var subQuestionObj={question:subquestion.question,tagsPayload:[].concat($scope.pathTags,subquestion.tagsPayload)||[]};$scope.qModel.push(subQuestionObj)}),"message"===$scope.faqData.responseType&&(reMapWfacebookChannel($scope.faqData.answerPayload[0]),$scope.rModel=[{_id:$scope.faqData.answerPayload[0]._id,text:$scope.faqData.answerPayload[0].text,type:$scope.faqData.answerPayload[0].type,channel:$scope.faqData.answerPayload[0].channel||"default",addOnAns:[]}],$scope.faqData.answerPayload&&$scope.faqData.answerPayload.length>0&&$.each($scope.faqData.answerPayload,function(i,answerPayload){if(i>0){var anspayload={_id:$scope.faqData.answerPayload[i]._id,text:$scope.faqData.answerPayload[i].text,type:$scope.faqData.answerPayload[i].type,channel:$scope.faqData.answerPayload[i].channel||"default"};$scope.rModel[0].addOnAns.push(anspayload)}}),$scope.faqData.subAnswers&&$scope.faqData.subAnswers.length>0&&$.each($scope.faqData.subAnswers,function(i,subanswer){reMapWfacebookChannel(subanswer[0]);var subAnswerObj={_id:subanswer[0]._id,text:subanswer[0].text,type:subanswer[0].type,channel:subanswer[0].channel||"default",addOnAns:[]};$.each(subanswer.slice(1),function(i,subAns){var addonans={_id:subAns._id,text:subAns.text,type:subAns.type,channel:subAns.channel||"default"};subAnswerObj.addOnAns.push(addonans)}),$scope.rModel.push(subAnswerObj)})),$scope.$$phase&&$scope.$apply(),prevResponseType=$scope.faqData.responseType,$timeout(function(){$scope.selectResponseType(prevResponseType)},500)):($scope.faqData={responseType:""},$scope.qModel=[{question:"",tagsPayload:angular.copy($scope.pathTags)}],$scope.boc&&$scope.boc.isFromKora&&$scope.boc.koraFaq&&($scope.qModel[0].question=$scope.boc.koraFaq),$scope.faqData.selectedTaskId="",$scope.rModel=[{text:"",type:"basic",channel:"default",addOnAns:[]}]),$scope.alldialogTasks=$workflowService.dialogTasks(),$scope.alldialogTasks.forEach(function(val,ind){$scope.faqData&&$scope.faqData.dialogId&&$scope.faqData.dialogId===val.refId?(val.state=!0,$scope.task.selected=val.name):val.state=!1}),$scope.alldialogTasks=_.filter($scope.alldialogTasks,function(task){return task.isFollowUp?void 0:task}),$scope.taskSelected=function(task){$scope.alldialogTasks.forEach(function(val,ind){val.state=!1}),task.state=!0,$scope.faqData.dialogId=task.refId,$scope.task.selected=task.name},$scope.botOntoQaCancel=function(){$scope.ontologyQAForm.$dirty?NotificationService.confirm({msg:i18n.i18nString("unsaved_changes"),successCb:function(){$scope.boc.isFromKora?$scope.boc.callFaqsForNode(!0):$scope.boc.callFaqsForNode(),$scope.boc.hideOntologyQAForm($scope.faqSearchTerm)},isModal:!0,btnTexts:{success:i18n.i18nString("yes"),fail:i18n.i18nString("no")}}):($scope.boc.isFromKora?$scope.boc.callFaqsForNode(!0):$scope.boc.callFaqsForNode(),$scope.boc.hideOntologyQAForm($scope.faqSearchTerm),$scope.callback.showProtipLinkFaq=!1)},$scope.ontologyTextErr=function(flag){return void 0!==flag?($scope.saveInProgress=!flag,flag):void 0},$scope.cancleResponse=function(){$scope.faqData.responseType="",$scope.faqData.dialogId="",$scope.rModel=[{text:"",type:"basic",channel:"default",addOnAns:[]}]},$scope.displayFocusOut=function(){$scope.faqDisplay.faqDisplayName&&($scope.focusOutdisplay=!0)},$scope.displayNameFocus=function(){$scope.boc.addDisplayName&&($scope.qModel[0]&&$scope.qModel[0].question&&$scope.qModel[0].question.length&&!$scope.faqDisplay.faqDisplayName?($scope.faqDisplay.faqDisplayName=$scope.qModel[0].question,$scope.focusOutdisplay=!1):$scope.qModel[0]&&$scope.qModel[0].question!==$scope.faqDisplay.faqDisplayName&&!$scope.focusOutdisplay&&($scope.faqDisplay.faqDisplayName=$scope.qModel[0].question)),$scope.showDuplicateSymbol=!1,_.forEach($scope.callback.allFaqs,function(eachFaq){$scope.qModel[0]&&$scope.qModel[0].question.toLowerCase()==eachFaq.questionPayload.question.toLowerCase()&&$scope.faqData&&!$scope.faqData._id&&($scope.showDuplicateSymbol=!0)})},$scope.addNewTextArea=function(event){var quesIndex=Number(event.currentTarget.getAttribute("name").slice(8));$scope.qModel.length===quesIndex+1&&($scope.qModel=$scope.qModel.filter(function(val,ind){return ind+1!==$scope.qModel.length?""!==val.question&&void 0!==val.question:!0}),addUserSaysRow())};var addUserSaysRow=function(){var userSaysObj={question:"",tagsPayload:angular.copy($scope.pathTags)};$scope.qModel.push(userSaysObj),$timeout(function(){iniNavigation?iniNavigation=!1:scrollToEle("#qdata"+($scope.qModel.length-2)),$("[data-toggle=popover]").popover({html:!0,delay:{hide:1e3}})},200)};$scope.addOnResponse=function(parentResponse,index){var addOnresponseObj={text:"",type:parentResponse.type,channel:parentResponse.channel};parentResponse.addOnAns.push(addOnresponseObj);var scrollIndex="#editor"+index+"_"+(parentResponse.addOnAns.length-1);$timeout(function(){scrollToEle(scrollIndex)},500)},$scope.addResponseRow=function(){var responseObj={text:"",type:"basic",channel:"default",addOnAns:[]};$scope.rModel.push(responseObj),$timeout(function(){scrollToEle("#rdata"+($scope.rModel.length-1))},200)},$scope.removeAddOnResponse=function(addOnres,index){addOnres.splice(index,1)},$scope.removeUserSaysRow=function(index){$scope.qModel.length>2&&$scope.qModel.splice(index,1)},$scope.removeResponseRow=function(index){$scope.rModel.splice(index,1)},$scope.checkKey=function(e){(33===e.which||34===e.which)&&e.preventDefault()},$scope.selectTermUsage=function(event,termUsageType,term){var _target=event.currentTarget;$(_target).parents(".dropdown-select").find(".btn-default .selectfield")[0].innerText=termUsageType.name,$(_target).parents(".dropdown-select").removeClass("open"),_.map($scope.termUsageTypes,function(term){term.selected=!1}),termUsageType.selected=!0,term.tagUsage=termUsageType.id},$scope.validateBotName=function(value){var regexp=/^[a-zA-Z0-9 ]*$/;value.match(regexp)?value.match(regexp)&&($scope.showErrorMessage=!1):$scope.showErrorMessage=!0},$scope.addOrUpdateFAQ=function(){function confirm(){$scope.faqData&&$scope.faqData.knowledgeTaskId&&!$scope.showProtipLinkFaq?$scope.updateFAQ():$scope.addFAQ()}function cancle(){}if($scope.showDuplicateSymbol&&"enable"==$scope.callback.configurationValue&&$scope.faqData&&!$scope.faqData._id&&($("#DuplicateLinkFaqModal").modal("show"),_.forEach($scope.callback.allFaqs,function(eachFaq){$scope.qModel[0]&&$scope.qModel[0].question==eachFaq.questionPayload.question&&!eachFaq.faqLinkedTo&&($scope.duplicateQuestion=eachFaq,$scope.duplicateFaqPath=$scope.callback.getFaqPath(eachFaq.parent))})),"dialog"===$scope.faqData.responseType){if(!$scope.faqData.dialogId)return void NotificationService.notify(i18n.i18nString("select_a_task"),"error");if(!$scope.qModel[0].question)return void NotificationService.notify(i18n.i18nString("provide_utterance"),"error")}if("message"===$scope.faqData.responseType){if(!$scope.qModel[0].question)return void NotificationService.notify(i18n.i18nString("provide_atleast_one_question"),"error");for(var j=0;j<$scope.qModel.length;j++)if("||"==$scope.qModel[j].question)return void NotificationService.notify(i18n.i18nString("provide_pattern"),"warning");
for(var i=0;i<$scope.rModel.length;i++)if(!$scope.rModel[i].text)return 0!==i?void NotificationService.notify(i18n.i18nString("provide_alt_res"),"error"):void NotificationService.notify(i18n.i18nString("provide_res"),"error")}return $scope.faqData&&$scope.levelOneNode&&$scope.faqData.editLocked?void NotificationService.userConfirm(i18n.i18nString("editing_res"),[confirm,cancle],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("confirm_proceed")):void confirm()},$scope.openUpdateTagModal=function($tag){$scope.originalTag=JSON.parse(JSON.stringify($tag,function(key,value){return"string"!=typeof key||"$"!==key.charAt(0)&&"this"!==key?value:void 0})),$scope.traitRuleForTag={},$scope.contextObj={},$tag.tagUsage=$tag.tagUsage||"default",setTermUsageOnLoad($tag.tagUsage),$scope.boqObject.clickedTag=$tag,$scope.contextObj.contextTags=$scope.boqObject.clickedTag.contextTags||[],$scope.contextObj.preConditions=$scope.boqObject.clickedTag.preConditions||[],$scope.boqObject.clickedTag&&$scope.boqObject.clickedTag.traitRule&&$scope.boqObject.clickedTag.traitRule.length&&$scope.boqObject.clickedTag.traitRule[0]&&$scope.boqObject.clickedTag.traitRule[0].length&&($scope.traitRuleForTag.traitRule=$scope.boqObject.clickedTag.traitRule[0][0]),$scope.boqObject.clickedTag&&$scope.boqObject.clickedTag.synonyms&&($scope.boqObject.clickedTag.synonyms=_constants_.getAlphabeticallySortedArray($scope.boqObject.clickedTag.synonyms)),$scope.placeholderMsg="  ",getBotSynonyms(),getTermGlobalSynonyms(),$scope.showOntologyTagsModal=!0,$scope.openModalSlider("#botOntologyModalSlider"),$scope.updateTraitRule=function(trait){var traitRules=[],rule=[];$scope.traitRuleForTag&&$scope.traitRuleForTag.traitRule&&(rule.push($scope.traitRuleForTag.traitRule),traitRules.push(rule)),$tag.traitRule=traitRules||[],$scope.boqObject.clickedTag.traitRule=traitRules||[]},$scope.contextObjUpdate=function(trait){$timeout(function(){$scope.boqObject.clickedTag.contextTags=$scope.contextObj.contextTags,$scope.boqObject.clickedTag.preConditions=$scope.contextObj.preConditions,$tag.contextTags=$scope.contextObj.contextTags,$tag.preConditions=$scope.contextObj.preConditions},400)},$scope.closeUpdateTagModal=function(){console.log($tag),$tag.synonyms=$scope.originalTag.synonyms||[],$tag.traitRule=$scope.originalTag.traitRule||[],$scope.boqObject.clickedTag.traitRule=$tag.traitRule||[],$scope.showOntologyTagsModal=!1,$scope.closeModalSlider("#botOntologyModalSlider")},$scope.addClassAndSynonyms=function(){if($scope.traitRuleForTag&&$scope.traitRuleForTag.traitRule){var characters=/[\=\`\~\!@#\$\%\^&\*\(\)\-\+\{\}\:"\[\];\',\.\/<>\?\|\\]+/;if(characters.test($scope.traitRuleForTag.traitRule))return NotificationService.notify(i18n.i18nString("trait_name"),"error"),!1}$scope.showOntologyTagsModal=!1,$scope.closeModalSlider("#botOntologyModalSlider")}},$scope.nofocus=!0;var focusInput=function(index){$scope.levelOneNode&&!$scope.levelOneNode.editLocked&&$scope.boc.isEditable()&&$timeout(function(){$("textarea[name=question"+index+"]").focus()},500)};focusInput(0),"faq"==$scope.navigateFrom?$timeout(function(){focusInput($scope.qModel.length-1)},500):"response"==$scope.navigateFrom&&$timeout(function(){$scope.addResponseRow()},500),$scope.allClasses=[],$scope.$on("updateTagSynonyms",function(e,data){getTermGlobalSynonyms(),$scope.emptyPlaceHolder="  ",$scope.placeholderMsg="  "}),$scope.getClasses=function(offset){offset=offset||0,botOntologyService.getClasses($scope.userInfo.userId,$scope.stream._id,offset,$scope.limit,$scope.kt.state).then(function(res){$scope.allClasses=res.data.classes||[]},function(error){})},$scope.childResChannelChange=function(rdata){$.each(rdata.addOnAns,function(i,ans){ans.channel=rdata.channel})},$scope.notifyUser=function(rdata,clickedMode){if(clickedMode!=rdata.type)if("uxmap"==rdata.type){if(rdata.text&&rdata.text.trim())return void NotificationService.notify(i18n.i18nString("advanced_mode_desc"));rdata.type="basic",$scope.nofocus=!1}else if("basic"==rdata.type){if(rdata.text&&rdata.text.trim())return void NotificationService.notify(i18n.i18nString("standard_mode_desc"));rdata.type="uxmap",$scope.nofocus=!1}},$scope.getClasses(),$rootScope.$on("updateClasses",function(evt){$scope.getClasses()}),$scope.addFAQ=function(){function proceedWithValidation(){if(!isValidForm($scope.ontologyQAForm))return void form_util.touch($scope.ontologyQAForm);var rModelTemp=[],allAnspayload=[];rModelTemp=angular.copy($scope.rModel),$.each(rModelTemp,function(i,ansPayload){var allAns=[];delete ansPayload.addOnAns,delete ansPayload._id,allAns[0]=ansPayload,allAns=allAns.concat($scope.rModel[i].addOnAns),allAnspayload.push(allAns)});var faqPayloadTemp={};$scope.showProtipLinkFaq?faqPayloadTemp={knowledgeTaskId:$scope.ktid,faqLinkedTo:$scope.faqData.refId,streamId:$scope.stream._id,parent:$scope.nodeId,leafterm:$scope.nodeLabel}:(faqPayloadTemp={questionPayload:$scope.qModel[0]||"",knowledgeTaskId:$scope.ktid,subQuestions:$scope.qModel.slice(1)||[],responseType:$scope.faqData.responseType,streamId:$scope.stream._id,parent:$scope.nodeId,leafterm:$scope.nodeLabel},faqPayloadTemp.faqStatus=$scope.enableDisable.faqStatus,faqPayloadTemp.label=$scope.faqDisplay.faqDisplayName,faqPayloadTemp.referenceId=$scope.faqDisplay.faqReferenceId,"message"===$scope.faqData.responseType?(faqPayloadTemp.answerPayload=allAnspayload[0]||[],faqPayloadTemp.subAnswers=allAnspayload.slice(1)||[]):"dialog"===$scope.faqData.responseType&&(faqPayloadTemp.dialogId=$scope.faqData.dialogId));var faqPayload=JSON.parse(JSON.stringify(faqPayloadTemp,function(key,value){return"string"!=typeof key||"$"!==key.charAt(0)&&"this"!==key?value:void 0}));faqPayload.questionPayload&&faqPayload.questionPayload.suggestedTags&&delete faqPayload.questionPayload.suggestedTags,faqPayload.questionPayload&&faqPayload.questionPayload.tagsPayload&&(faqPayload.questionPayload.tagsPayload=_.filter(faqPayload.questionPayload.tagsPayload,function(tagObject){return!tagObject.hideRemove})),faqPayload.subQuestions&&$.each(faqPayload.subQuestions,function(i,subquestion){subquestion.suggestedTags&&delete subquestion.suggestedTags,subquestion.tagsPayload=_.filter(subquestion.tagsPayload,function(tagObject){return!tagObject.hideRemove})}),"message"===$scope.faqData.responseType&&(faqPayload.answerPayload&&$.map(faqPayload.answerPayload,function(answerPayloadObj){return answerPayloadObj.text=encodeJS(answerPayloadObj.text),checkAndUpdateWfacebook(answerPayloadObj),answerPayloadObj}),faqPayload.subAnswers&&$.each(faqPayload.subAnswers,function(i,answerObject){checkAndUpdateWfacebook(answerObject[0]),$.map(answerObject,function(subanswerObject){return subanswerObject.text=encodeJS(subanswerObject.text),subanswerObject})})),$scope.saveInProgress=!0,faqPayload.subQuestions&&(faqPayload.subQuestions=faqPayload.subQuestions.filter(function(val){return""!==val.question})),botOntologyService.addFAQ($scope.userInfo.userId,faqPayload).then(function(response){console.log(response),$workflowService.knowledgeTasks()[0].state="configured",NotificationService.notify(i18n.i18nString("faq_added"),"success"),$scope.boc.getFaqsByKnowledge("","","",!0),$scope.boc.hideOntologyQAForm(),$scope.saveInProgress=!1,$scope.showEditButton=!0,$scope.boc.addDisplayName=!1;var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Knowledge Graph","Knowledge Category":$scope.faqData.leafterm};mixPanel.postEvent("Conversation - Question added",eventInfo)},function(error){error.data.errors&&error.data.errors.length>0&&"enable"!==$scope.callback.configurationValue?NotificationService.notify(error.data.errors[0].msg,"error"):"enable"!==$scope.callback.configurationValue?NotificationService.notify(i18n.i18nString("failed_to_save_faq"),"error"):error.data.errors&&error.data.errors.length>0&&"enable"===$scope.callback.configurationValue&&$scope.faqData&&$scope.faqData._id?NotificationService.notify(error.data.errors[0].msg,"error"):"enable"==$scope.callback.configurationValue&&$scope.faqData&&$scope.faqData._id?NotificationService.notify(i18n.i18nString("failed_to_save_faq"),"error"):error.data.errors&&error.data.errors.length>0&&"enable"===$scope.callback.configurationValue&&$scope.faqData&&!$scope.faqData._id&&!$scope.showDuplicateSymbol?NotificationService.notify(error.data.errors[0].msg,"error"):"enable"==$scope.callback.configurationValue&&$scope.faqData&&$scope.faqData._id&&!$scope.showDuplicateSymbol&&NotificationService.notify(i18n.i18nString("failed_to_save_faq"),"error"),$scope.saveInProgress=!1,$scope.boc.addDisplayName=!1,console.log(error)})}return validateEditors(),hasErrors()?($scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("atleast_one_response_with_chnls_mandatory"),"error"),!1):void $timeout(function(){proceedWithValidation()},700)},$scope.updateFAQ=function(faqID){function proceedWithValidation(){if(!isValidForm($scope.ontologyQAForm))return void form_util.touch($scope.ontologyQAForm);var rModelTemp=[],allAnspayload=[];"message"===$scope.faqData.responseType&&(rModelTemp=angular.copy($scope.rModel),$.each(rModelTemp,function(i,ansPayload){var allAns=[];delete ansPayload.addOnAns,allAns[0]=ansPayload,allAns=allAns.concat($scope.rModel[i].addOnAns),allAnspayload.push(allAns)}));var faqPayloadTemp={};faqPayloadTemp={_id:faqID||$scope.faqData._id,questionPayload:$scope.qModel[0]||"",knowledgeTaskId:$scope.ktid,subQuestions:$scope.qModel.slice(1)||[],responseType:$scope.faqData.responseType,streamId:$scope.stream._id,parent:$scope.nodeId,leafterm:$scope.nodeLabel},faqPayloadTemp.faqStatus=$scope.enableDisable.faqStatus,faqPayloadTemp.label=$scope.faqDisplay.faqDisplayName,faqPayloadTemp.referenceId=$scope.faqDisplay.faqReferenceId,"message"===$scope.faqData.responseType?(faqPayloadTemp.answerPayload=allAnspayload[0]||[],faqPayloadTemp.subAnswers=allAnspayload.slice(1)||[]):"dialog"===$scope.faqData.responseType&&(faqPayloadTemp.dialogId=$scope.faqData.dialogId);var faqPayload=JSON.parse(JSON.stringify(faqPayloadTemp,function(key,value){return"string"!=typeof key||"$"!==key.charAt(0)&&"this"!==key?value:void 0}));faqPayload.questionPayload&&faqPayload.questionPayload.suggestedTags&&delete faqPayload.questionPayload.suggestedTags,faqPayload.questionPayload&&faqPayload.questionPayload.tagsPayload&&(faqPayload.questionPayload.tagsPayload=_.filter(faqPayload.questionPayload.tagsPayload,function(tagObject){return!tagObject.hideRemove})),faqPayload.subQuestions&&(faqPayload.subQuestions=faqPayload.subQuestions.filter(function(val){return""!==val.question}),$.each(faqPayload.subQuestions,function(i,subquestion){subquestion.suggestedTags&&delete subquestion.suggestedTags,subquestion.tagsPayload=_.filter(subquestion.tagsPayload,function(tagObject){return!tagObject.hideRemove})})),"message"===$scope.faqData.responseType&&(faqPayload.answerPayload&&$.map(faqPayload.answerPayload,function(answerPayloadObj){return answerPayloadObj.text=encodeJS(answerPayloadObj.text),checkAndUpdateWfacebook(answerPayloadObj),answerPayloadObj}),faqPayload.subAnswers&&$.each(faqPayload.subAnswers,function(i,answerObject){checkAndUpdateWfacebook(answerObject[0]),$.map(answerObject,function(subanswerObject){return subanswerObject.text=encodeJS(subanswerObject.text),subanswerObject})})),$scope.saveInProgress=!0,BTStreamsService.updateFAQ($scope.userInfo.userId,faqPayload,faqPayload._id).then(function(response){$workflowService.knowledgeTasks()[0].state="configured",$scope.boc.getFaqsByKnowledge("","","",!0),$scope.boc.updateFaqCollection($scope.faqData),$scope.hideListFaqs||$scope.boc.hideOntologyQAForm(),$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("faq_update"),"success");var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Knowledge Graph"};mixPanel.postEvent("Conversation - Question edited",eventInfo)},function(error){console.log(error),$scope.saveInProgress=!1,error.data.errors&&error.data.errors.length>0&&"enable"!==$scope.callback.configurationValue?NotificationService.notify(error.data.errors[0].msg,"error"):"enable"!==$scope.callback.configurationValue?NotificationService.notify(i18n.i18nString("failed_to_save_faq"),"error"):error.data.errors&&error.data.errors.length>0&&"enable"===$scope.callback.configurationValue&&$scope.faqData&&$scope.faqData._id?NotificationService.notify(error.data.errors[0].msg,"error"):"enable"==$scope.callback.configurationValue&&$scope.faqData&&$scope.faqData._id?NotificationService.notify(i18n.i18nString("failed_to_save_faq"),"error"):error.data.errors&&error.data.errors.length>0&&"enable"===$scope.callback.configurationValue&&$scope.faqData&&!$scope.faqData._id&&!$scope.showDuplicateSymbol?NotificationService.notify(error.data.errors[0].msg,"error"):"enable"==$scope.callback.configurationValue&&$scope.faqData&&$scope.faqData._id&&!$scope.showDuplicateSymbol&&NotificationService.notify(i18n.i18nString("failed_to_save_faq"),"error")})}return $scope.faqData&&"dialog"!==$scope.faqData.responseType&&(validateEditors(),hasErrors())?($scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("atleast_one_response_with_chnls_mandatory"),"error"),!1):void $timeout(function(){proceedWithValidation()},700)},$scope.selectType&&"tasks"===$scope.selectType&&$timeout(function(){$scope.intent.selected="task",$scope.intentChange()}),$scope.getFAQ=function(){searchParam=searchParam||""},$scope.addTag=function(tagToAdd,qData){var tagToAddObject={tag:tagToAdd};qData.tagsPayload.push(tagToAddObject);var index=qData.suggestedTags.indexOf(tagToAdd);qData.suggestedTags.splice(index,1)},$scope.getPossibleTags=function(qData){var queryPayload={query:qData.question};BTStreamsService.getPossibleTags($scope.userInfo.userId,$scope.ktid,queryPayload).then(function(response){0!==response.data.length&&(response.data=response.data.filter(function(val,ind){return ind===response.data.lastIndexOf(val)})),qData.suggestedTags=response.data||[]},function(error){})},$scope.init(),$scope.selectResponseType("message"),addUserSaysRow();var isValidForm=function(form){return form.$valid}}]),_botOntlogyQAForm.filter("responseTypeFilter",function(){return function(name){if(name){if("message"===name)return"Send Message";if("dialog"===name)return"Run a Task"}}})}(angular),function(ng){var _boTermSettingsForm=ng.module("bt-forms");_boTermSettingsForm.directive("botOntologyTermSettings",function(){return{restrict:"EA",scope:{boc:"=?",saveInProgress:"=?",termData:"=?",isTermLocked:"=?",knowledgeTask:"=?",levelOneNode:"=?",navigateFrom:"@",isTermDisabled:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-ontology-term-settings/bot-ontology-term-settings.html",controller:"boTermSettingsCtrl"}}),_boTermSettingsForm.controller("boTermSettingsCtrl",["$scope","$rootScope","form_util","$timeout","botOntologyService","$workflowService","$applicationService","BTStreamsService","NotificationService","_constants_","env_conf","i18n",function($scope,$rootScope,form_util,$timeout,botOntologyService,$workflowService,$applicationService,BTStreamsService,NotificationService,_constants_,env_conf,i18n){function getBotSynonyms(){if($scope.botSynonyms.synonyms=[],$scope.term){var _synonmysKeys,_synonymsValues;_synonmysKeys=JSON.stringify(Object.keys($scope.stream.synonyms||{})),_synonymsValues=Object.values($scope.stream.synonyms||{}),_synonmysKeys=_synonmysKeys.replace(/~/g,"");var _synonmysKeysArr=JSON.parse(_synonmysKeys),_termData=angular.copy($scope.term);_termData.label=_termData.label.replace(/~/g,"");var _resultArray=[];_synonmysKeysArr.filter(function(value,index){value.toLowerCase()===_termData.label.toLowerCase()&&_resultArray.push({value:value,index:index})}),_resultArray.length&&1===_resultArray.length?$scope.botSynonyms.synonyms=_synonymsValues[_resultArray[0].index]:_resultArray.length&&_resultArray.length>1&&_.map(_resultArray,function(value,index){$scope.botSynonyms.synonyms=$scope.botSynonyms.synonyms.concat(_synonymsValues[_resultArray[index].index])})}}function getTermGlobalSynonyms(firstCall,secondCall){if(firstCall&&($scope.synonymsFirstCall=firstCall),$scope.term){var offset="",limit="",search="",keyword=$scope.term.label,state=$scope.knowledgeTask.state;BTStreamsService.getKtGlobalSynonyms($scope.stream._id,offset,limit,search,keyword,state,$scope.knowledgeTask._id).then(function(res){$scope.termResponseSynonyms=angular.copy(res.data),res.data.synonyms.length&&res.data.synonyms[0].synonyms?(res.data.synonyms[0].synonyms=_constants_.getAlphabeticallySortedArray(res.data.synonyms[0].synonyms),$scope.termSynonyms=res.data.synonyms[0]):$scope.termSynonyms=[]},function(err){NotificationService.notify(i18n.i18nString("error_fetch_synonyms"),"error")})}}function flattenNodes(selectedNodeData){var _payload=[],loopLevel=0,constructPayload=function(treeData){$.each(treeData,function(i,nodeData){var nodePayloadObj=angular.copy(nodeData);nodePayloadObj=_.omit(nodePayloadObj,["nodes","class","saveFail","isNewNode","defaultCollapse","labelpath","idsPath"]),nodePayloadObj.label&&nodePayloadObj.label.trim()&&_payload.push(nodePayloadObj),nodeData.nodes.length&&1>loopLevel&&(loopLevel+=1,constructPayload(nodeData.nodes))})};return constructPayload(selectedNodeData),_payload||{}}function setTermUsageOnLoad(termUsageName){$(".dropdown-select").find(".selectfield")[0].innerText=termUsageName[0].toUpperCase().concat(termUsageName.slice(1,termUsageName.length)),angular.forEach($scope.termUsageTypes,function(term){term.id===termUsageName&&(term.selected=!0)})}$scope.assetsBase=env_conf["assets-url"],$scope.stream=$workflowService.selectedStream(),$scope.userInfo=$applicationService.userInfo(),$scope.limit=1e3,$scope.traits={},$scope.termResponseSynonyms={},$scope.helpIcon=$scope.assetsBase+"icons/helpIcon.svg",$scope.enableToggle=$scope.assetsBase+"images/toggle-1.png",$scope.disableToggle=$scope.assetsBase+"images/left-menu-img/unselectedCheck.svg",$scope.warnUserIcon=env_conf["context-url"]+"/img/ontology/node_error.svg",$scope.emptyPlaceHolder="  ",$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.enableDisableStatus={},$scope.enableDisableStatus.termStatus=!0,$scope.selectedStreamState=$workflowService.selectedStreamState(),$scope.synonymsSelect2Options={maxTagLength:128};$workflowService.currentLanguage();$scope.botSynonyms={},$scope.botSynonyms.synonyms=[],$scope.termData.synonyms&&($scope.termData.synonyms=_constants_.getAlphabeticallySortedArray($scope.termData.synonyms)),$scope.termData.traitRule&&$scope.termData.traitRule.length&&$scope.termData.traitRule[0].length&&$scope.termData.traitRule[0][0]?$scope.traits.traitRule=angular.copy($scope.termData.traitRule[0][0]):$scope.traits.traitRule="",$scope.term=angular.copy($scope.termData),"organizer"==$scope.term.termUsage?($scope.isOrganizer=!0,$scope.term.hasOwnProperty("enableContext")?$scope.term.enableContext=$scope.term.enableContext:$scope.term.hasOwnProperty("enableContext")||$scope.term.contextTags.length||$scope.term.preConditions.length?$scope.term.enableContext=!0:$scope.term.enableContext=!1):$scope.isOrganizer=!1,$scope.bindAuioComplete=function(){setTimeout(function(){var id="#addTraitforKg";setTimeout(function(){$(id).autocomplete({minLength:0,source:$scope.boc.allTraits||[],focus:function(event,ui){return $(id).val(ui.item.label),!1},position:{collision:"flip"},select:function(event,ui){return $(id).val(ui.item.label),!1}}).autocomplete("widget").addClass("contextTypeaheadDropdown")},200)},300)},$scope.boc.updateTraits=function(allTraits){$("#addTraitforKg").autocomplete({source:$scope.boc.allTraits})},getTermGlobalSynonyms(!0),$scope.getTextEncoded=function(name){return name.replace(/</g,"&lt;").replace(/>/g,"&gt;")},$scope.termUsageTypes=[{id:"default",name:i18n.i18nString("constants.propertyPanel_default"),description:i18n.i18nString("term_usage"),type:"default","class":"defaultColor",selected:!1},{id:"mandatory",name:i18n.i18nString("mandatory"),description:i18n.i18nString("user_synonyms"),type:"mandatory","class":"mandatoryColor",icon:$rootScope.mandatory,selected:!1},{id:"organizer",name:i18n.i18nString("organizer_label"),description:i18n.i18nString("kg_term_organize"),type:"organizer","class":"organizerColor",icon:$rootScope.organizer,selected:!1}],$scope.allClasses=[],$scope.isTermLocked||!$scope.levelOneNode||$scope.levelOneNode.editLocked||$timeout(function(){$scope.boc.isEditable()&&$('input[name="parentTermName"]').focus()},100),$scope.$watch("termData",function(newVal,oldVal){$scope.term=angular.copy(newVal),getTermGlobalSynonyms(!1),getBotSynonyms(),$scope.term.termUsage=$scope.term.termUsage||"default",setTermUsageOnLoad($scope.term.termUsage),$scope.termData.traitRule&&$scope.termData.traitRule.length&&$scope.termData.traitRule[0]&&$scope.termData.traitRule[0].length&&$scope.termData.traitRule[0][0]?$scope.traits.traitRule=angular.copy($scope.termData.traitRule[0][0]):$scope.traits.traitRule=""}),$scope.$watch("term.termUsage",function(newVal,oldVal){"organizer"==$scope.term.termUsage?$scope.isOrganizer=!0:$scope.isOrganizer=!1}),$scope.$on("updateTermSynonyms",function(e,data){getTermGlobalSynonyms(!0),$scope.emptyPlaceHolder="  "}),$scope.checkIsDupe=function(termDetails,checkChilds){if(!$scope.isTermDisabled){var labelList=_.pluck(_.filter(_.where($scope.knowledgeTask.taxonomy,{parent:termDetails.parent}),function(val){return val.nodeId!=termDetails.nodeId}),"label");if(labelList=labelList.map(function(res){return res.toLowerCase()}),$scope.term.isDupe=_.indexOf(labelList,termDetails.label.toLowerCase())>-1,checkChilds&&$scope.term&&$scope.term.nodes&&$scope.term.nodes.length){var lbels=_.pluck($scope.term.nodes,"label");$scope.term.nodes&&$scope.term.nodes.length&&$.each($scope.term.nodes,function(i,childNode){childNode.isDupe=lbels.indexOf(childNode.label)!==lbels.lastIndexOf(childNode.label)})}}},$scope.checkAllDuplicateChilds=function(){if(!$scope.isTermDisabled){var lbels=_.pluck($scope.term.nodes,"label");$scope.term.nodes&&$scope.term.nodes.length&&$.each($scope.term.nodes,function(i,childNode){childNode.isDupe=lbels.indexOf(childNode.label)!==lbels.lastIndexOf(childNode.label)})}},$scope.checkIsDupeChild=function(nn){$scope.isTermDisabled||$scope.checkAllDuplicateChilds()},$scope.saveTermSettings=function(){return $scope.termSettingsForm.$valid?($scope.isTermDisabled||($scope.term.isDupe=_.pluck($scope.knowledgeTask.taxonomy,"label").indexOf($scope.term.label)>-1),void($scope.term&&"organizer"==$scope.term.termUsage?NotificationService.alert(i18n.i18nString("term_organizer_label"),[$scope.saveSetting,$scope.cancleSaveSetting],{okText:i18n.i18nString("proceed")},"",void 0,i18n.i18nString("are_you_sure_label")):$scope.saveSetting())):void form_util.touch($scope.termSettingsForm)},$scope.confirmContext=function(){$scope.term.enableContext=!0,$("#contextModalEnable").modal("hide")},$scope.openContextModal=function(){$scope.term.enableContext?$scope.term.enableContext=!1:$("#contextModalEnable").modal({backdrop:"static",keyboard:!1})},$scope.contextModalClose=function(){$("#contextModalEnable").modal("hide")},$scope.saveSetting=function(){$scope.saveInProgress=!0,$scope.term&&"organizer"==$scope.term.termUsage&&($scope.term.synonyms=[],$scope.term.classId&&delete $scope.term.classId);var kgTraitrules=[],rule=[];if($scope.traits&&$scope.traits.traitRule){var characters=/[\=\`\~\!@#\$\%\^&\*\(\)\-\+\{\}\:"\[\];\',\.\/<>\?\|\\]+/;if(characters.test($scope.traits.traitRule))return NotificationService.notify(i18n.i18nString("trait_name"),"error"),$scope.saveInProgress=!1,!1}rule.push($scope.traits.traitRule),$scope.traits.traitRule.trim()&&kgTraitrules.push(rule||[]),$scope.term.traitRule=kgTraitrules||[],$scope.termData=$scope.term,$scope.termData.label=$scope.getTextEncoded($scope.termData.label),$.each($scope.termData.nodes,function(i,data){data.label=$scope.getTextEncoded(data.label)});var callback={};callback={event:"update",data:$scope.termData},"organizer"==$scope.termData.termUsage&&($scope.termData.enableContext=$scope.term.enableContext);var _termDataCopy=$scope.termData;delete _termDataCopy.editLocked;var _termData=flattenNodes([_termDataCopy]);$scope.boc.cudOntologyNode("upsert",_termData,callback),$scope.boc.hideBotOntologyTermSettings(),$timeout(function(){$(".bgGreen .termInfo").trigger("click")},500)},$scope.cancleSaveSetting=function(){$scope.term=$scope.termData},$scope.toggleManageContext=function(){$scope.term.enableContext=!$scope.term.enableContext},"synonyms"===$scope.navigateFrom&&$timeout(function(){$scope.isOrganizer||(document.querySelector(".btsbody ").scrollTop=150,$(".synonymContainer .ng-valid-leftover-text .tags .input").eq(0).focus())},500),$scope.getClasses=function(offset){offset=offset||0,botOntologyService.getClasses($scope.userInfo.userId,$scope.stream._id,offset,$scope.limit,$scope.knowledgeTask.state).then(function(res){$scope.allClasses=res.data.classes||[];var classData=_.filter($scope.allClasses,function(classObject){return classObject._id==$scope.term.classId});classData&&classData.length?$("#classselect2").val($scope.term.classId).trigger("change"):$scope.term.classId&&($scope.term.classId="",$scope.boc.getAndUpdateOntology($scope.termData))},function(error){})},$scope.selectTermUsage=function(event,termUsageType,term){var _target=event.currentTarget;$(_target).parents(".dropdown-select").find(".btn-default .selectfield")[0].innerText=termUsageType.name,$(_target).parents(".dropdown-select").removeClass("open"),_.map($scope.termUsageTypes,function(term){term.selected=!1}),termUsageType.selected=!0,term.termUsage=termUsageType.id},setTimeout(function(){$scope.checkIsDupe($scope.term,!0)},200),$rootScope.$on("updateClasses",function(evt){})}]),_boTermSettingsForm.filter("formTT",function(){return function(input,node,scope){if(input)try{return _.where(scope.knowledgeTask.taxonomy,{nodeId:node.parent[0]})[0].label&&(input=input.replace("[]","'"+_.where(scope.knowledgeTask.taxonomy,{nodeId:node.parent[0]})[0].label+"'")),input}catch(e){return input}}})}(angular),function(ng){var _botOntologyForm=angular.module("bt-forms");_botOntologyForm.directive("botOntology",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-ontology/bot-ontology.html",controller:"botOntologyCtrl",scope:{callback:"=",parentCb:"="}}}),_botOntologyForm.controller("botOntologyCtrl",["$scope","$rootScope","$q","TimerNotification","patternFactory","env_conf","$interval","form_util","NotificationService","$timeout","BTStreamsService","$workflowService","botOntologyService","$applicationService","$filter","uuid","accessControlService","_constants_","BTFlowtaskService","$element","i18n","mixPanel",function($scope,$rootScope,$q,TimerNotification,patternFactory,env_conf,$interval,form_util,NotificationService,$timeout,BTStreamsService,$workflowService,botOntologyService,$applicationService,$filter,uuid,accessControlService,_constants_,BTFlowtaskService,$element,i18n,mixPanel){function getCountFaq(type){return $scope.extraction.qas.filter(function(val){return"addedQues"===type?!val.status:val.status}).length}function startKgHistInterval(flag,selected){var kgHistInter=$interval(function(){BTStreamsService.kgQuesAns($scope.stream._id,$scope.knowledgeExtractId._id,10*countStart,10,$scope.search.faq,$scope.filterType).then(function(res){$scope.extraction.qas=$scope.extraction.qas.concat(res.data.extractions),$scope.extraction.allQAS=$scope.extraction.allQAS.concat(res.data.extractions),"till10"===flag&&getCountFaq(selected)>9?($interval.cancel(kgHistInter),$scope.countFaqRow=!0,$scope.isFaqEmpty=!1):"tillEnd"===flag&&getCountFaq(selected)===countAllSelect&&($interval.cancel(kgHistInter),$scope.countFaqRow=countAllSelect>9,$scope.isFaqEmpty=!1),countStart++},function(err){$interval.cancel(kgHistInter)})},500)}function kgHistoryUpdate(selected){countAllSelect="addedQues"===selected?qna.added:qna.notAdded;var countFq=getCountFaq(selected);if(!countAllSelect)return $scope.countFaqRow=!1,void($scope.isFaqEmpty=!0);if(countAllSelect>0&&countAllSelect<11&&countAllSelect===countFq)return $scope.countFaqRow=countFq>9,void($scope.isFaqEmpty=!1);if(countAllSelect>0&&countAllSelect<11)startKgHistInterval("tillEnd",selected);else{if(countAllSelect>10&&10===countFq)return $scope.countFaqRow=countFq>9,void($scope.isFaqEmpty=!1);if(countAllSelect>10&&countFq===countAllSelect)return $scope.countFaqRow=countFq>9,void($scope.isFaqEmpty=!1);if(countAllSelect>10&&countFq>10)return $scope.countFaqRow=countFq>9,void($scope.isFaqEmpty=!1);countAllSelect>10&&startKgHistInterval("till10",selected)}}function getKgWordsManage(reset){BTStreamsService.getKgManageWords($workflowService.selectedStream()._id,$scope.knowledgeTask._id,reset).then(function(res){res.data&&res.data.stopWords&&(stopWordsGlobal=$workflowService.cloneData(res.data.stopWords),$scope.prepareStopWords(res.data.stopWords))},function(err){console.log(err)})}function saveMLSynonymSetting(stopList){BTStreamsService.updateKgManageWords($workflowService.selectedStream()._id,$scope.knowledgeTask._id,"false",{stopWords:stopList||[]}).then(function(res){$scope.lodingStopWords=!1,res.data&&res.data&&res.data.stopWords&&(stopWordsGlobal=$workflowService.cloneData(res.data.stopWords)),$scope.prepareStopWords(res.data.stopWords),NotificationService.notify(i18n.i18nString("stopwords_saved"),"success")},function(err){$scope.lodingStopWords=!1,NotificationService.notify(i18n.i18nString("error_smalltalk"),"error")})}function saveManageKtSynonymsForm(key,synonyms,form){var payload={keyword:key,streamId:$scope.stream._id,botName:$scope.stream.name,synonyms:synonyms,language:_selectedLanguage,knowledgeTaskId:$scope.knowledgeTask._id};BTStreamsService.addKtGlobalSynonyms($scope.stream._id,payload).then(function(res){$scope.manageKtSynonym={},form_util.makeItClean(form),$scope.manageGlobalSynonyms(),$scope.showCreateglobalSynonyms=!1,NotificationService.notify(i18n.i18nString("save_synonyms"),"success")},function(err){$scope.manageKtSynonym={},NotificationService.notify(i18n.i18nString("failed_synonyms"),"error")})}function kgHistApi(){BTStreamsService.kgHistory($workflowService.selectedStream()._id).then(function(res){$scope.knowledgeExtractList=$workflowService.cloneData(res.data.metaqnas)},function(err){})}function getNodesLockStatus(callbackMethod,showToast){botOntologyService.getNodesLockStatus($scope.userInfo.userId,$scope.knowledgeTask._id).then(function(res){var values=_.values(res.data),isResourceLocked=-1!==_.indexOf(values,!0)?!0:!1;isResourceLocked?showToast?NotificationService.notify(i18n.i18nString("nodes_lock_status"),"error"):NotificationService.confirmDialog(i18n.i18nString("nodes_lock_status"),$scope.getKTData,{okText:i18n.i18nString("ok"),noCancelBtn:!0}):callbackMethod()},function(err){})}function updateTermAndIDsPath(droppedNode,stopRecursion){var updateTermIDPath=function(childs,parentTermObject){$.each(childs,function(i,nodeData){nodeData.labelpath=(parentTermObject.labelpath||parentTermObject.label)+" > "+nodeData.label,nodeData.idsPath=(parentTermObject.idsPath||parentTermObject.nodeId)+" > "+nodeData.nodeId,nodeData.nodeIndexMap=parentTermObject.nodeIndexMap+" > "+JSON.stringify(i);var termsMapObject={nodeIds:nodeData.idsPath,path:nodeData.labelpath,termsMapObject:nodeData.nodeIndexMap};termsMap[nodeData.nodeId]=termsMapObject,nodeData.nodes.length&&!stopRecursion&&updateTermIDPath(nodeData.nodes,nodeData)})};updateTermIDPath(droppedNode.nodes,droppedNode)}function calculateViewWidth(){var containerWidth=($(".termContainer"),$(".ontologyContainerDrag").width());$(".mainContainer").width(containerWidth-$(".termContainer").width()-2)}function initContainerDrag(){var containerWidth;
calculateViewWidth();var resize=$(".termContainer");$(resize).resizable({handles:"e",maxWidth:900,minWidth:350,resize:function(event,ui){var currentWidth=ui.size.width,padding=1;$(this).width(currentWidth),$(".mainContainer").width(containerWidth-currentWidth-padding)}})}function getKgTaxonomyBased(){BTStreamsService.getAdvancedConfigurationsByName($workflowService.selectedStream()._id,"KG_Taxonomy_Based").then(function(res){$scope.isKg.loading=!1,$scope.callback.configurationValue=res.data.configurationValue,$scope.callback.showLinkQuestionValue=!1,"enable"==$scope.callback.configurationValue&&($scope.callback.showLinkQuestionValue=!0),$scope.isTermDisabled="enable"==res.data.configurationValue?!1:!0},function(err){$scope.isKg.loading=!1,console.log(err)})}function clearBuffer(){$scope.buffers.callback=null}function releaseSearchBatch(node,index){if(node){if(node&&(node.nodes.length&&node.nodes[index]&&(node.nodes[index].nodeBatch=$workflowService.cloneData($scope.nodeBatch),node.nodes[index].defaultCollapse=!0),$scope.currentSearchIndex&&$scope.currentSearchIndex.length)){var childTermIndex=parseInt($scope.currentSearchIndex.splice(0,1));releaseSearchBatch($scope.data[0],childTermIndex)}}else if($scope.data[0].nodeBatch=$workflowService.cloneData($scope.nodeBatch),$scope.currentSearchIndex&&$scope.currentSearchIndex.length){var parentTermIndex=parseInt($scope.currentSearchIndex.splice(0,1));releaseSearchBatch($scope.data[0],parentTermIndex)}}function scrollToNode(){var _container=$(".ontologyContainer.ps-container"),_ele=_container.find(".highlightnode"),_x_disp=_container.width()/2,_y_disp=_container.height()/2;$timeout(function(){_container.animate({scrollLeft:_ele.offset().left+150-_container.offset().left+_container.scrollLeft()-_x_disp,scrollTop:_ele.offset().top+_ele.height()/2-_container.offset().top+_container.scrollTop()-_y_disp},function(){var _selectedNode=_ele;_selectedNode&&(_selectedNode.addClass("highlight-glow"),$timeout(function(){_selectedNode.removeClass("highlight-glow")},3e3))})},500)}function getPayload(){var _payload=[],constructPayload=function(treeData){$.each(treeData,function(i,nodeData){var nodePayloadObj=$workflowService.cloneData(nodeData);nodePayloadObj=_.omit(nodePayloadObj,["nodes","class","saveFail","isNewNode","defaultCollapse","labelpath","idsPath","faqCount","deleted","nodeIndexMap","nodeBatch","showCheck"]),nodePayloadObj.label&&nodePayloadObj.label.trim()&&_payload.push(nodePayloadObj),nodeData.nodes.length&&constructPayload(nodeData.nodes)})};return constructPayload($scope.data),_payload||{}}function getTextEncoded(name){return name?name.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function toggleFreezeClass(action){$("body")[action]("screenFreeze")}function searchAttachClick(){$(".searchJQSelector").click(function(){$(this).hasClass("closeCross")?($(".closeCross").addClass("hide"),$(".searchIconGray").removeClass("hide"),$(".synSearch").removeClass("searchExpand"),$scope.search.faq=""):($(".synSearch").addClass("searchExpand"),$(".searchIconGray").addClass("hide"),$(".closeCross").removeClass("hide"),$timeout(function(){$(".synSearchInput").focus()},350))})}function prepareOntologyTree(){$scope.taxonomyObjectData={treeData:{},nodeObject:{},duplicates:{},childTermNames:{}};var totalTreeData=_.filter($scope.ontologytreetaxonomy,function(treeData){return"undefined"==typeof treeData.termStatus&&(treeData.termStatus=!0),treeData.nodeBatch=$workflowService.cloneData($scope.nodeBatch),$scope.taxonomyObjectData.nodeObject[treeData.nodeId]=treeData,treeData.parent&&treeData.parent.length&&($scope.taxonomyObjectData.treeData[treeData.parent[0]]||($scope.taxonomyObjectData.treeData[treeData.parent[0]]=[]),$scope.taxonomyObjectData.treeData[treeData.parent].push(treeData)),!treeData.parent||!treeData.parent.length});return totalTreeData}function checkForDuplicateChild(term,checkAllChilds){var childs=$scope.taxonomyObjectData.treeData[term.nodeId];if($scope.taxonomyObjectData.childTermNames[term.nodeId]={},$scope.taxonomyObjectData.duplicates[term.nodeId]=[],!$scope.isTermDisabled){var termNames={};childs&&childs.length&&($.each(childs,function(i,childterm){var label=childterm.label.toLowerCase();termNames[label]||(termNames[label]=[]),termNames[label].push(childterm.nodeId),termNames[label]&&termNames[label].length>1&&($scope.taxonomyObjectData.duplicates[term.nodeId]=$scope.taxonomyObjectData.duplicates[term.nodeId].concat(termNames[label]),$.each($scope.taxonomyObjectData.duplicates[term.nodeId],function(i,duplicateTerm){$scope.taxonomyObjectData.nodeObject[duplicateTerm].isDupe=!0,$scope.taxonomyObjectData.nodeObject[duplicateTerm].termIndex=i}))}),$scope.taxonomyObjectData.childTermNames[term.nodeId]=termNames)}}function showLockErrorMessage(error,full){try{error=error.errors;var msg=_.isArray(error)?error[0].msg:i18n.i18nString("some_error");$scope.lockErrorMsg=msg,NotificationService.notify(msg,"error")}catch(ex){console.log(ex)}}function ondragStart(e,u){_parentHeight=$(".ontologyContainer")[0].scrollHeight-300,_parentWidth=$(".ontologyContainer")[0].scrollWidth-50}function ondragging(event,ui){var $nodeHoveredEle=$(".nodehovered");if($nodeHoveredEle.is(":visible")){var hoveredNodeScope=$(".nodehovered").closest(".ontologytreenode").scope();hoveredNodeScope.expand(),registerDragDropEvents()}$(".ontologyContainer").each(function(){var $this=$(this),cOffset=$this.offset(),bottomPos=cOffset.top+$this.height();if(clearInterval($this.data("timerScroll")),$this.data("timerScroll",!1),event.pageX>=cOffset.left&&event.pageX<=cOffset.left+$this.width()){if(event.pageY>=bottomPos-triggerZone&&event.pageY<=bottomPos){var moveUp=function(){$this.scrollTop($this.scrollTop()+scrollSpeed)};$this.data("timerScroll",setInterval(moveUp,10)),moveUp()}if(event.pageY>=cOffset.top&&event.pageY<=cOffset.top+triggerZone){var moveDown=function(){$this.scrollTop($this.scrollTop()-scrollSpeed)};$this.data("timerScroll",setInterval(moveDown,10)),moveDown()}}})}function encodeJS(_obj){return encodeURIComponent(_obj)}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function getSecondLevelNodeOfNodeId(nodeId){var map=_.indexBy($scope.ontologytreetaxonomy,"nodeId"),parents=[],rootNodeId=$scope.data[0].nodeId;if(rootNodeId){for(var node=map[nodeId];node&&node.nodeId!==rootNodeId&&node.parent[0]!==rootNodeId;)node=map[node.parent[0]];node&&node.nodeId!==rootNodeId&&parents.push(node)}return parents[0]}function updateParentToChildAllData(termData){$scope.ontology.selectedTerm.label,_.pluck(_.where($scope.ontologytreetaxonomy,{level:$scope.ontology.selectedTerm.level}),"label");$scope.ontology.selectedTerm.label=termData.label,termData.displayName?$scope.ontology.selectedTerm.displayName=termData.displayName:$scope.ontology.selectedTerm.hasOwnProperty("displayName")&&delete $scope.ontology.selectedTerm.displayName,$scope.ontology.selectedTerm.autoQualify=termData.autoQualify,$scope.ontology.selectedTerm.nodes=termData.nodes,$scope.ontology.selectedTerm.synonyms=termData.synonyms,$scope.ontology.selectedTerm.traitRule=termData.traitRule,$scope.ontology.selectedTerm.termUsage=termData.termUsage||"default",$scope.ontology.selectedTerm.contextTags=termData.contextTags||[],$scope.ontology.selectedTerm.preConditions=termData.preConditions||[],"organizer"===termData.termUsage&&($scope.ontology.selectedTerm.enableContext=termData.enableContext),checkForDuplicateChild(termData,!0),termData.nodeId&&$scope.taxonomyObjectData.nodeObject[termData.nodeId]&&$scope.taxonomyObjectData.nodeObject[termData.nodeId].hasOwnProperty("isDupe")&&($scope.ontology.selectedTerm.isDupe=$scope.taxonomyObjectData.nodeObject[termData.nodeId].isDupe),termData.nodeId&&$scope.taxonomyObjectData.nodeObject[termData.nodeId]&&$scope.taxonomyObjectData.nodeObject[termData.nodeId].hasOwnProperty("hideWarn")&&($scope.ontology.selectedTerm.hideWarn=$scope.taxonomyObjectData.nodeObject[termData.nodeId].hideWarn);var findAndUpdateNode=function(treeData){$.each(treeData,function(i,nodeData){if(nodeData.nodeId==termData.nodeId){if(nodeData.label=termData.label,nodeData.nodes=termData.nodes,nodeData.synonyms=termData.synonyms,nodeData.traitRule=termData.traitRule,nodeData.termUsage=termData.termUsage||"default",nodeData.contextTags=termData.contextTags||[],nodeData.preConditions=termData.preConditions||[],$scope.breadCrumbData[$scope.breadCrumbData.length-1].nodeLabel=nodeData.label,nodeData&&nodeData.labelpath){var _labelPathArray=nodeData.labelpath.split(" > ");_labelPathArray[_labelPathArray.length-1]=nodeData.label,nodeData.labelpath=_labelPathArray.join(" > "),nodeData.idsPath=nodeData.idsPath,nodeData.nodeIndexMap=nodeData.nodeIndexMap;var termsMapObject1={nodeIds:nodeData.idsPath,path:nodeData.labelpath,nodeIndexMap:nodeData.nodeIndexMap};termsMap[nodeData.nodeId]=termsMapObject1}return void updateTermAndIDsPath(nodeData,!0)}nodeData.nodes.length&&findAndUpdateNode(nodeData.nodes)})};findAndUpdateNode($scope.data)}function kgHistCountUpdate(){BTStreamsService.kgHistory($workflowService.selectedStream()._id).then(function(res){var requiredKG=res.data.metaqnas.filter(function(val){return val._id===$scope.knowledgeExtractId._id})[0];qna.added=requiredKG.qnaAddedCount,qna.notAdded=requiredKG.qnaExtractedCount},function(err){console.error("Not able to hit the history API")})}function externalFaqSearch(event,text){$scope.faqSearch.faqSearchQuery=$workflowService.cloneData(text)||"",$scope.searchFAQ(event)}function fillChildrenOfParentId(taxonomy,nodes,parentTermObject){if(!parentTermObject.parent.length){parentTermObject.labelpath=parentTermObject.label,parentTermObject.idsPath=parentTermObject.nodeId,parentTermObject.nodeIndexMap="0";var termsMapObjectroot={nodeIds:parentTermObject.idsPath,path:parentTermObject.labelpath,nodeIndexMap:"0"};termsMap[parentTermObject.nodeId]=termsMapObjectroot}var childs=$scope.taxonomyObjectData.treeData[parentTermObject.nodeId];if(childs&&childs.length>0)for(var i=0;i<childs.length;i++){childs[i].defaultCollapse=!0,childs[i].labelpath=(parentTermObject.labelpath||parentTermObject.label)+" > "+childs[i].label,childs[i].idsPath=(parentTermObject.idsPath||parentTermObject.nodeId)+" > "+childs[i].nodeId,childs[i].nodeIndexMap=(parentTermObject.nodeIndexMap||"0")+" > "+i;var termsMapObject={nodeIds:childs[i].idsPath,path:childs[i].labelpath,nodeIndexMap:childs[i].nodeIndexMap};termsMap[childs[i].nodeId]=termsMapObject,nodes.push(JSON.parse(JSON.stringify(childs[i]))),nodes[nodes.length-1].nodes=[],fillChildrenOfParentId(taxonomy,nodes[nodes.length-1].nodes,childs[i])}}function expandAndGotoSpecificNode(nodeIdsString,indexMapString){var nodeIdsArray=nodeIdsString.split(" > "),indexMapArray=indexMapString.split(" > ");if(indexMapArray.splice(0,1),$scope.currentSearchIndex=$workflowService.cloneData(indexMapArray),!$("[nodeid="+nodeIdsArray[nodeIdsArray.length-1]+"] .ontologytreenode").is(":visible")){var makeExpandNodes=function(treeData){$.each(treeData,function(i,nodeData){if(-1!==$.inArray(nodeData.nodeId,nodeIdsArray)&&nodeIdsArray.length>1&&nodeData.nodes.length){nodeIdsArray.splice(0,1);var index=parseInt(indexMapArray.splice(0,1)),startIndex=index,endIndex=index+10;index>10?(startIndex=index-10,endIndex=index+10):(startIndex=0,endIndex=11);var batchLoad={startIndex:startIndex,endIndex:endIndex};nodeData.nodeBatch=batchLoad,nodeData.defaultCollapse=!1,$timeout(function(){makeExpandNodes(nodeData.nodes)},200)}return 1==nodeIdsArray.length?!1:void 0})};makeExpandNodes($scope.data)}var isNOdeVisible=!1,termDetectionInterval=$interval(function(){if(isNOdeVisible=$("[nodeid="+nodeIdsArray[nodeIdsArray.length-1]+"] .ontologytreenode").is(":visible")){$(".ontologytreenode").removeClass("matchednode"),$(".ontologytreenode").removeClass("highlightnode"),$("[nodeid="+nodeIdsArray[nodeIdsArray.length-1]+"] .ontologytreenode").addClass("highlightnode"),scrollToNode();var selectedNodeScope=$("[nodeid="+nodeIdsArray[nodeIdsArray.length-1]+"] .ontologytreenode").scope();$scope.getQASForThisTerm(selectedNodeScope),$interval.cancel(termDetectionInterval)}},100)}function drawDonutChart(element,percent,width,height,text_y){width="undefined"!=typeof width?width:60,height="undefined"!=typeof height?height:60,text_y="undefined"!=typeof text_y?text_y:"-.10em";var dataset={lower:calcPercent(0),upper:calcPercent(percent)},radius=Math.min(width,height)/2,pie=d3.pie().sort(null),arc=(d3.format(".0%"),d3.arc().innerRadius(radius-10).outerRadius(radius)),svg=d3.select(element).append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height/2+")"),path=svg.selectAll("path").data(pie(dataset.lower)).enter().append("path").attr("class",function(d,i){return"color"+i}).attr("d",arc).each(function(d){this._current=d}),text=svg.append("text").attr("text-anchor","middle").attr("dy","");if("string"==typeof percent)text.text("");else var progress=0,timeout=setTimeout(function(){clearTimeout(timeout),path=path.data(pie(dataset.upper)),path.transition().duration(duration).attrTween("d",function(a){var i=d3.interpolate(this._current,a);d3.interpolate(progress,percent);return this._current=i(0),function(t){return arc(i(t))}})},200)}function calcPercent(percent){return[percent,100-percent]}function orderInspectData(reportDetails){var _obj={},_finalObj=[],_zeroObj=[];angular.forEach(_inspectOrder,function(orderName){_obj[orderName]=_.filter(reportDetails.ontologyReport,{type:orderName}).sort(function(a,b){return a.count-b.count}).reverse()});var _errorArray=_obj.error,_warningArray=_obj.warning,_suggestionArray=_obj.suggestion;angular.forEach(_errorArray,function(obj,index){obj.count>0?_finalObj.push(obj):_zeroObj.push(obj)}),angular.forEach(_warningArray,function(obj,index){obj.count>0?_finalObj.push(obj):_zeroObj.push(obj)}),angular.forEach(_suggestionArray,function(obj,index){obj.count>0?_finalObj.push(obj):_zeroObj.push(obj)}),$scope.issueList=_finalObj.concat(_zeroObj)}function callAnalysisReport(dockId,status){botOntologyService.analysisReport($applicationService.userInfo().userId,$workflowService.selectedStream()._id,$scope.knowledgeTask._id,dockId,_selectedLanguage).then(function(response){$scope.inspectStatus="success",$scope.disabledRerun=!1,$scope.disableInspect=!1,$scope.reRunStatus=status;var _result=response.data.succcessSteps;$scope.resultData=Math.floor(_result/response.data.total*100),$scope.openAnalysisReport(),$timeout(function(){d3.selectAll("#donut > *").remove(),drawDonutChart("#donut",$scope.resultData,60,60,".35em")},1e3),$scope.reportDetails=response.data,$scope.reportDetails.issues=response.data.issues-(response.data.errors+response.data.suggestions),orderInspectData($scope.reportDetails),$scope.knowledgeTask.ontologyReport=!0},function(err){$scope.disableInspect=!1,NotificationService.notify(i18n.i18nString("some_error"),"error")})}function updateChangeLogs(obj,_trainOntology){var _payload={updatedConfig:"useBotSynonyms",useBotSynonyms:$scope.botSynonym.toggleValue,mode:"faq"};BTStreamsService.updateThresholds($workflowService.selectedStream()._id,_payload).then(function(res){$scope.stream.confidenceConfigs=res.data.confidenceConfigs,_trainOntology&&$scope.knowledgeTask._id&&$scope.trainBotOntology(),_trainOntology=!1,$workflowService.selectedStream($scope.stream,res.data),NotificationService.notify(i18n.i18nString("settings_saved"),"success")},function(err){err&&err.data&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error"),$scope.botSynonym.toggleValue=!$scope.botSynonym.toggleValue})}$scope.faqSearch={faqSearchQuery:""},$scope.userInfo=$applicationService.userInfo(),$scope.knowledgeDisplayMode=accessControlService.getAccessRight("BOTBUILDER_KNOWLEDGE_GRAPH"),$scope.nlPermision=$scope.knowledgeDisplayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.modalSlider={},$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.refreshIcon=env_conf["context-url"]+"/assets/icons/refreshIcon.svg",$scope.exportIcon=env_conf["context-url"]+"/assets/kg/export.svg",$scope.exclamationGray=env_conf["context-url"]+"/assets/icons/exclamationGray.svg",$scope.menuIcon=env_conf["context-url"]+"/assets/icons/menu-icon.svg",$scope.warnUserIcon=env_conf["context-url"]+"/img/ontology/node_error.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.knowledgeTask=$workflowService.taskEditInfo()||[],$scope.dialogTasks=$workflowService.dialogTasks(),$scope.constants=$rootScope._constants_,$scope.forms={},$scope.importModal={},$scope.ontologyClassModal={},$scope.faqstats={},$scope.countFaqRow=!1,$scope.faqstats.limit=30,$scope.isAvoidAddSub=!1,$scope.faqstats.path="",$scope.forms.termSettingsForm={},$scope.synonymkey={},$scope.synonymkey.searchQuery="",$scope.selectedFilter={val:""},$scope.pUpParent="",$scope.pUpChild="",$scope.trainOntologyStatus="",$scope.totalFaqCount=0,$scope.buffers={},$scope.bulbicon=env_conf["context-url"]+"/assets/images/24x29-bulbicon.png",$scope.kgGenerator="https://github.com/Koredotcom/KnowledgeGraphGenerator",$scope.botDetails={},$scope.iconsTag={mandatory:$rootScope.mandatory,organizer:$rootScope.organizer};var deletedNodeSiblingList=[],loadNextFaqsFlag=!0;$scope.botDetails.streamState=$workflowService.selectedStreamState(),$scope.allowNamespace=$workflowService.selectedStream().enableNameSpace,$workflowService.ontologyJobStatus()&&$workflowService.selectedStream()._id===$workflowService.ontologyJobStatus().streamId&&($workflowService.ontologyJobStatus()&&"IN_PROGRESS"===$workflowService.ontologyJobStatus().status||"QUEUED"===$workflowService.ontologyJobStatus().status||"PROCESSING"===$workflowService.ontologyJobStatus().status)?($scope.inspectStatus="inprogress",$scope.reRunStatus="inprogress"):($scope.inspectStatus="initial",$scope.reRunStatus="initial");var qna={added:"",notAdded:""};$scope.shift={key:!1},$scope.training_label=i18n.i18nString("training_label"),$scope.train_label=i18n.i18nString("train"),$scope.Inspecting=i18n.i18nString("inspecting_label"),$scope.Inspect=i18n.i18nString("inspect"),$scope.rightClass="right500";var countStart=1,backToFocusId="";$scope.knowledgeExtractList=[],$scope.isKgExtractHist=!0,$scope.searchWord={},$scope.searchWord.search="",$scope.ktSynonymObject=[],$scope.manageKtSynonym={};var stopWordsGlobal=[];$scope.placeholderMsg=i18n.i18nString("type_enter_add");var _selectedLanguage=$workflowService.currentLanguage();$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.helpIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/helpIcon.svg",$scope.gHelpIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/gHelpIcon.svg",$scope.searchIconGray=window.appConfig.CONTEXT_PATH+"/assets/icons/searchIconGray.svg",$scope.closeIconDark=window.appConfig.CONTEXT_PATH+"/assets/icons/closeIconDark.svg",$scope.arrowAngle=window.appConfig.CONTEXT_PATH+"/assets/icons/arrowAngle.svg",$scope.assetsBase=env_conf["assets-url"],$scope._constants_=_constants_,$scope.menuIconPath=$scope.assetsBase+"images/left-menu-img/task-gray.svg",$scope.rightArrow=$scope.assetsBase+"ivrIcons/rightArrow.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.inspectingIcon=env_conf["context-url"]+"/assets/ontology/inspecting.svg",$scope.reRunIcon=env_conf["context-url"]+"/assets/ontology/rerun.svg",$scope.analysisEmptyReport=env_conf["context-url"]+"/assets/ontology/analysisEmptyReport.svg",$scope.calendarIcon=env_conf["context-url"]+"/assets/ontology/calendar.svg",$scope.loadingIcon=env_conf["context-url"]+"/assets/ontology/loadingIcon.svg",$scope.unlinkIcon=env_conf["context-url"]+"/assets/icons-new/unlink/link.svg",$scope.warningIcon=env_conf["context-url"]+"/assets/icons-new/unlink/warning.svg",$scope.toggleIcon=$scope.assetsBase+"images/toggle-1.png",$scope.currentDockId=$workflowService.setCurrentDockId(),$scope.disabledRerun=!1,$scope.disableInspect=!1,$scope.search={faq:""},$scope.selectKgCheck={all:!1},$scope.currentSearchIndex=[],$scope.loadItemsPerBatch=300,$scope.nodeBatch={startIndex:0,endIndex:$scope.loadItemsPerBatch},$scope.isKg={loading:!0},$scope.batchLoader={},$scope.isTermDisabled=!1,$scope.openPath=!1,$scope.batchLoader.nextBatchLoading=!1,$scope.batchLoader.previousBatchLoading=!1,$scope.batchLoader.loadToRootNode=!1,$scope.botSynonym={};var idsList=[],_obj={},resetIntent=function(){$scope.intentFilter=[{name:"All",state:!0},{name:"FAQs",state:!1},{name:"Tasks",state:!1}],$scope.selectedFilter.val="all"};getKgTaxonomyBased(),$scope.hideBackButton=!1,$scope.navigate={from:""},$scope.showPublish=!1,$scope.kgGraph={offClass:!0},$scope.dyn={offset:-290},$scope.isFromKora=!1,$scope.toastMessageTitle="Knowledge Graph",$scope.manage_var_bot_onto_cb={},$scope.manageVarBotOntoEnable=!1;var koraFaq=null;$scope.isLoading=!1,$scope.manageVarNameBotOnto=function(){$scope.manageVarBotOntoEnable=!0,$scope.manage_var_bot_onto_cb.flagName="kg",$scope.manage_var_bot_onto_cb.addedNamespaces=$scope.knowledgeTask.vNameSpace,$scope.manage_var_bot_onto_cb.state=$scope.knowledgeTask.state,$scope.manage_var_bot_onto_cb._id=$scope.knowledgeTask._id,$scope.manage_var_bot_onto_cb.updateKgNamespaces=function(list){$scope.knowledgeTask.vNameSpace=list},setTimeout(function(){$scope.modalSlider.open("#manageVarNamespaceBotOnto")},200)},$scope.manage_var_bot_onto_cb.close=function(){$scope.modalSlider.close("#manageVarNamespaceBotOnto"),$scope.manageVarBotOntoEnable=!1},$scope.fromSmart=$workflowService.kgDataFromKora().fromSmart,$scope.fromWorkbench=$workflowService.kgDataFromKora().fromWorkbench,$scope.callback.showOntologyQAForm=function(flag,addFaqValue){$scope.showOntologyQAForm(flag,addFaqValue)},$scope.showOntologyQAForm=function(flag,addFaqValue){function proceed(){$scope.clickedTermParent={qaEditMode:!1},flag&&"tasks"===flag&&($scope.selectedFilter.val="tasks"),addFaqValue?($scope.isLoading=!0,$scope.showHideQACreateForm(!1),setTimeout(function(){$scope.showHideQACreateForm(!0),$scope.isLoading=!1},500)):$scope.showHideQACreateForm(!0),$scope.ontologyfaqsStats.editIndex=-1}$scope.callback.showLinkQuestionValue=!1,"enable"==$scope.callback.configurationValue&&($scope.callback.showLinkQuestionValue=!0,$scope.callback.shownoEditLinkFaq=!1,$scope.callback.showProtipLinkFaq=!1),$scope.cb.addDisplayName=!0;var secondLevelNode=({streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name},getSecondLevelNodeOfNodeId($scope.ontology.selectedTerm.nodeId));secondLevelNode?$scope.lockorCheckNode(secondLevelNode,proceed,!0):proceed()};var localPath=window.localStorage.getItem("previousState");$scope.dyn.offset=-200,localPath&&(localPath=JSON.parse(localPath),localPath&&localPath.isFromKora&&($workflowService.kgDataFromKora()&&$workflowService.kgDataFromKora().path.indexOf("/q/")>0&&(koraFaq=$workflowService.kgDataFromKora().path.slice($workflowService.kgDataFromKora().path.indexOf("/q/")+3)),$scope.hideBackButton=!0,$scope.dyn.offset=-240,$scope.showPublish=!0,$scope.kgGraph.offClass=!1,$scope.isFromKora=!0,$scope.toastMessageTitle="Knowledge Collection",$("body").addClass("kora-theme"),$scope.ecIcon=$scope.iconContextPath+"/excludechilds-kora.svg",$scope.toggleIcon=$scope.assetsBase+"images/toggle-1-kore.png",$scope.exportIcon=env_conf["context-url"]+"/assets/kg/export-kora.svg",$scope.reRunIcon=env_conf["context-url"]+"/assets/ontology/rerun-kora.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png"));var _inspectOrder=["error","warning","suggestion"];resetIntent(),$scope.updateTreeBatch=function(indexType,node){"rootNode"==indexType&&($scope.batchLoader.loadToRootNode=!0,$timeout(function(){node.nodeBatch.startIndex=0,node.nodeBatch.endIndex=$scope.loadItemsPerBatch,$timeout(function(){$scope.batchLoader.loadToRootNode=!1},1e3)},200)),"startIndex"==indexType&&($scope.batchLoader.previousBatchLoading=!0,$timeout(function(){node.nodeBatch.startIndex<$scope.loadItemsPerBatch?(node.nodeBatch.startIndex=0,node.nodeBatch.endIndex=$scope.loadItemsPerBatch):(node.nodeBatch.endIndex=node.nodeBatch.endIndex-$scope.loadItemsPerBatch,node.nodeBatch.startIndex=node.nodeBatch.endIndex-$scope.loadItemsPerBatch),$timeout(function(){$scope.batchLoader.previousBatchLoading=!1},1e3)},200)),"endIndex"==indexType&&($scope.batchLoader.nextBatchLoading=!0,$timeout(function(){node.nodeBatch.endIndex+$scope.loadItemsPerBatch>node.nodes.length-1||node.nodeBatch.endIndex+$scope.loadItemsPerBatch==node.nodes.length-1?(node.nodeBatch.endIndex=node.nodes.length,node.nodeBatch.startIndex=node.nodeBatch.endIndex-$scope.loadItemsPerBatch):(node.nodeBatch.endIndex=node.nodeBatch.endIndex+$scope.loadItemsPerBatch,node.nodeBatch.startIndex=node.nodeBatch.endIndex-$scope.loadItemsPerBatch),$timeout(function(){$scope.batchLoader.nextBatchLoading=!1},1e3)},200))},$scope.isFaqEmpty=!1,$scope.mlthreshold={},$scope.closeQuickTip=function(){$scope.showquicktip=!1};var allFaqsAvailable;$scope.extraction={qas:[],allQAS:[]},$scope.knowledgeExtractId={_id:""},$scope.editQnA={ques:"",ans:""},$scope.current={tag:"allQues"},$scope.statusEnabled=!0,$scope.delTerm={label:""},$scope.showQuickTip=function(){$scope.showquicktip=!0},$scope.curBot={state:$workflowService.taskMode()},$scope.closeManageTraits=function(){$(".talkToBot").removeClass("hide"),$scope.openTraits=!1,$scope.closeModalSlider("#manageTraits"),$scope.getTraitsGroupsApi()},$scope.openManageTraits=function(){$scope.openTraits=!0,$scope.traitsCb={},$scope.traitsCb.search="",$scope.traitsCb.type="KG",$scope.traitsCb.updateGroupViewForGK=function(allTraits){$scope.cb.allTraits=allTraits},$(".talkToBot").addClass("hide"),$scope.openModalSlider("#manageTraits")},$scope.$watch("faqstats.limit",function(newVal,oldVal){$scope.faqstats.limit=newVal}),$scope.treeFilter=$filter("uiTreeFilter"),$scope.payload={},$scope.availableFields=["label"],$scope.supportedFields=["label"],$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.icIcon=$scope.iconContextPath+"/includechilds.svg",$scope.ecIcon=$scope.iconContextPath+"/excludechilds.svg",$scope.stream=$workflowService.selectedStream();var faqEvents,termEvents;$scope.activeNodeId=1,$scope.faqsLoaded=!1,$scope.selectedQuestions=[],$scope.ontology={},$scope.ontology.allFAQsSelected=!1,$scope.ontology.allQAS=[];var nodeElem={};$scope["delete"]={type:"all"},$scope.callback.getFaqsByKnowledge=$scope.getFaqsByKnowledge,setTimeout(function(){$scope.dialogTasks=$workflowService.dialogTasks()},700),$scope.isEditable=function(){return"view"!==$workflowService.taskMode()},$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.getJsSamples(),$scope.removeNodeItem=function(scope,stopUpdate,fromFlag){function proceed(){$scope.isNewNodeSaveTriggered=!1;var callback="",parentScope=$("[nodeid='"+scope.$modelValue.parent[0]+"']").find("> .ontologytreenode").scope();scope.$modelValue.isNewNode?$scope.updateBreadCrumb(parentScope):callback={event:"delete",data:parentScope};var termName=scope.$modelValue.label;if(scope.remove(),"all"===fromFlag?scope.$modelValue.addToRoot=!1:"onlyTerm"===fromFlag&&(scope.$modelValue.addToRoot=!0),!stopUpdate){var messageNotify="";"noFaqs"===fromFlag?messageNotify=i18n.i18nString("term_delete_success",{termName:termName}):"all"===$scope["delete"].type?messageNotify=i18n.i18nString("term_associated",{termName:termName}):"onlyTerm"===$scope["delete"].type&&(messageNotify=i18n.i18nString("term_moved",{termName:termName})),$scope.cudOntologyNode("remove",scope.$modelValue,callback,messageNotify)}clearBuffer()}function confirmTermDelete(){function failCb(){console.log("on cancel callback")}fromFlag&&"noFaqs"!==fromFlag?fromFlag&&proceed():(NotificationService.confirm({heading:i18n.i18nString("delete_Term"),headerClass:"confirmationHeader",bodyClass:"confirmationbody",noteClass:"confirmationNote",msg:i18n.i18nString("confirm_deletion"),note:checkNodeState(scope.$modelValue,!0),successCb:proceed,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("delete"),fail:i18n.i18nString("cancel")}}),$timeout(function(){$(".i-am-new").addClass("delete-node-notify")},200))}if($scope.isNewNodeSaveTriggered)return void($scope.buffers.callback=confirmTermDelete);if(stopUpdate)return void proceed();var secondLevelNode=getSecondLevelNodeOfNodeId(scope.$modelValue.nodeId);secondLevelNode?$scope.lockorCheckNode(secondLevelNode,confirmTermDelete,!0):confirmTermDelete()},$scope.expandAllNodes=!1,$scope.updateCurrentTab=function(selected){if("addedQues"!==selected&&"notAdded"!==selected||""!==$scope.search.faq?""===$scope.search.faq&&($scope.isFaqEmpty=!1):(countStart=1,kgHistoryUpdate(selected)),$scope.selectKgCheck.all){$scope.selectKgCheck.all=!1;for(var i=0;i<$scope.extraction.qas.length;i++)$scope.extraction.qas[i].selected=!1}$scope.current.tag=selected,$timeout(function(){$(".kgFaqScroll").scrollTop(0)})},$scope.closeManageStopWordsModalSlider=function(){$(".talkToBot").removeClass("hide"),$scope.closeModalSlider("#manageStopWords")},$scope.activateWordSearch=function(){$(".stopWordsBody").scrollTop(0)},$scope.prepareStopWords=function(dataObj){$scope.mlthreshold.stopWords=[],dataObj&&($scope.mlthreshold.stopWords=dataObj,$scope.mlthreshold.stopWords=$scope.constants.getAlphabeticallySortedArray($scope.mlthreshold.stopWords))},getKgWordsManage("false"),$scope.deleteStopWordInSearch=function(text){$scope.lodingStopWords=!0,stopWordsGlobal&&stopWordsGlobal.splice(stopWordsGlobal.indexOf(text),1),saveMLSynonymSetting(stopWordsGlobal)},$scope.resetDefaultStopWords=function(){function resetStopwords(){BTStreamsService.resetKgManageWords($workflowService.selectedStream()._id).then(function(res){res.data&&res.data.stopWords&&(stopWordsGlobal=$workflowService.cloneData(res.data.stopWords),$scope.prepareStopWords(res.data.stopWords),NotificationService.notify(i18n.i18nString("stopwords_reset"),"success"))},function(err){console.log(err),NotificationService.notify(i18n.i18nString("unable_to_reset"),"success")})}function cancel(){}NotificationService.userConfirm(i18n.i18nString("reset_default_delete"),[resetStopwords,cancel],{okText:i18n.i18nString("confirm_reset"),btnClass:"redBtn"},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.editStopWords=function(){var tempStopwords="";setTimeout(function(){$.each($scope.mlthreshold.stopWords,function(i,stopword){tempStopwords=tempStopwords+stopword+","});var stopeWordsList=tempStopwords.trim().split(",");stopeWordsList.pop(),saveMLSynonymSetting(stopeWordsList)},100)},$scope.toggleNode=function(scope){function proceed(){return scope.collapsed&&(checkNodeState(scope.$modelValue),checkForDuplicateChild(scope.$modelValue)),scope.$modelValue["class"]?($scope.expandAllNodes=!$scope.expandAllNodes,$scope.expandAllNodes?$scope.expandAll():($scope.collapseAll(),scope.toggle()),clearBuffer(),void $timeout(function(){registerDragDropEvents()},500)):(scope.toggle(),clearBuffer(),void $timeout(function(){registerDragDropEvents()},500))}return $scope.isNewNodeSaveTriggered?void($scope.buffers.callback=proceed):void $scope.lockorCheckNode(scope.$modelValue,proceed)},$scope.expandDirectChildOfRoot=function(scope){$scope.collapseAll(),scope.toggle()},$scope.getDialogNameByRefId=function(id){var dialog=_.find($scope.dialogTasks,{refId:id});return dialog&&dialog.name?!dialog.child||"published"==$scope.knowledgeTask.state&&"suspended"===$scope.knowledgeTask.state?dialog.name:dialog.child[0].name:""},$scope.moreGlobalSynonymsAvailable=!0,$scope.manageGlobalSynonyms=function(bykeyword,searchkey,type,isSearch,cbType,isFromPagination){if($(".talkToBot").hide(),isFromPagination){
if(!$scope.moreGlobalSynonymsAvailable||$scope.loadingPaginatedSynonyms)return!1;$scope.loadingPaginatedSynonyms=!0}else $scope.loadingSynonyms=!0;$scope.placeholderMsg=i18n.i18nString("type_enter_add");var offset="",limit=20;isFromPagination&&(offset=$scope.ktSynonymObject.length);var search=searchkey||"",keyword=bykeyword||"",state=$scope.knowledgeTask.state;searchkey?$scope.isFromSynSearch=!0:$scope.isFromSynSearch=!1,"byEdit"==cbType?$scope.editCB=!0:$scope.editCB=!1,BTStreamsService.getKtGlobalSynonyms($scope.stream._id,offset,limit,search,keyword,state,$scope.knowledgeTask._id).then(function(res){$scope.manageKtSynonym={},$scope.synonymsCount=res.data.count,$scope.moreGlobalSynonymsAvailable=res.data.moreAvailable,isFromPagination?$scope.ktSynonymObject=$scope.ktSynonymObject.concat(_constants_.getAlphabeticallySortedArray(res.data.synonyms,"keyword","synonyms")):$scope.ktSynonymObject=_constants_.getAlphabeticallySortedArray(res.data.synonyms,"keyword","synonyms"),"edit"==type?$scope.changeEditKtSynonym($scope.currentEditKtSynonym,0):"add"==type&&($scope.editCB=!1,$scope.manageKtSynonym.keyword=$scope.addkeyword,$scope.showCreateSynonyms(!0)),$timeout(function(){$scope.loadingPaginatedSynonyms=!1,isFromPagination||($scope.loadingSynonyms=!1,$timeout(function(){$scope.bindGlobalSynonymsScrollPagination()},200))},350)},function(err){NotificationService.notify(i18n.i18nString("error_fetch_synonyms"),"error"),$scope.loadingSynonyms=!1}),$scope.showCreateglobalSynonyms=!1,$scope.stream.confidenceConfigs&&$scope.stream.confidenceConfigs.length&&(_obj.confidenceConfig=$workflowService.cloneData($scope.stream.confidenceConfigs),$scope.botSynonym.toggleValue=$scope.stream.confidenceConfigs[1].useBotSynonyms?$scope.stream.confidenceConfigs[1].useBotSynonyms:!1),$scope.openModalSlider("#ontologyGlobalSynonyms"),$(window).trigger("resize")},$scope.saveManageKTaskSynonym=function(form){form_util.makeItClean(form);var key,synonyms;return form.$invalid?void form_util.touch(form):(key=_.isObject($scope.manageKtSynonym.keyword)?$scope.manageKtSynonym.keyword.key:$scope.manageKtSynonym.keyword,synonyms=$scope.manageKtSynonym.synonyms||[],void saveManageKtSynonymsForm(key,synonyms,form))},$scope.filterExisted=function(synonym){var termexist=_.find($scope.ktSynonymObject,function(object){return synonym.label==object.keyword});return termexist?!1:!0},$scope.closeKgExtractModal=function(){$scope.closeModalSlider("#kgExtractModalSlider")},$scope.showKgExtractSlider=function(){var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Knowledge Graph"};mixPanel.postEvent("Conversation - Enter Review and Add",eventInfo),$scope.isKgExtractHist=!0,$scope.openModalSlider("#kgExtractModalSlider"),kgHistApi()},$scope.closeManageSynonyms=function(form){$scope.placeholderMsg=" ",$scope.manageKtSynonym={},$scope.currentEditKtSynonym=null,$scope.editKtSynonymId=null,$scope.activateNameSearch(!1),form_util.makeItClean(form),$(".talkToBot").show(),$scope.closeModalSlider("#ontologyGlobalSynonyms"),$scope.$broadcast("updateTermSynonyms"),$scope.$broadcast("updateTagSynonyms"),form.$setUntouched(),form.$setPristine()},$scope.changeEditKtSynonym=function(synonym,index){$scope.showCreateglobalSynonyms=!1,$scope.currenteditIndex=index,synonym&&synonym.keyword===$scope.editKtSynonymId+index?($scope.currentEditKtSynonym=null,$scope.editKtSynonymId=null):($scope.currentEditKtSynonym=synonym,$scope.editKtSynonymId=synonym.keyword+index,$timeout(function(){"#"+$scope.editKtSynonymId+index;$(".select2-input").focus()},500))},$scope.cbKtSynonym=function(data){var checkSearch=$(".synSearchInput").is(":focus");if(!checkSearch&&$scope.editKtSynonymId&&$scope.currenteditIndex)switch(data.event){case"OnEnter":$scope.editKtSynonym(data);break;case"default":}},$scope.editKtSynonym=function(synonyms){var payload={keyword:synonyms.keyword,streamId:$scope.stream._id,botName:$scope.stream.name,synonyms:synonyms.synonyms,language:_selectedLanguage,knowledgeTaskId:$scope.knowledgeTask._id};BTStreamsService.editKtGlobalSynonyms($scope.stream._id,synonyms._id,payload).then(function(res){$scope.ktSynonymObject[$scope.currenteditIndex]=res.data,NotificationService.notify(i18n.i18nString("save_synonyms"),"success"),$scope.editKtSynonymId=null},function(err){$scope.manageKtSynonym={},NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.deletKtSynonym=function(synonyms,event,parentIndex,object){$scope.currentEditKtSynonym=object,event.stopPropagation(),BTStreamsService.deleteKtGlobalSynonyms($scope.stream._id,$scope.currentEditKtSynonym._id).then(function(res){$scope.manageGlobalSynonyms(),$scope.currentEditKtSynonym=null,$scope.editKtSynonymId=null,NotificationService.notify(i18n.i18nString("synonyms_deleted_success"),"success")},function(err){$scope.manageKtSynonym={},$scope.currentEditKtSynonym=null,$scope.editKtSynonymId=null,NotificationService.notify(i18n.i18nString("failed_delete_synonyms"),"error")})},$scope.cancelEditDiv=function(){$scope.currentEditKtSynonym=null,$scope.editKtSynonymId=null},$scope.showCreateSynonyms=function(value){$scope.showCreateglobalSynonyms=value},$scope.activateNameSearch=function(show){show?$scope.showNameSearch=!0:($scope.manageGlobalSynonyms(),$scope.showNameSearch=!1),$scope.synonymkey.searchQuery="",setTimeout(function(){$(".focusNameSearch").focus()},100)},$scope.searchSynonyms=function(event){13!=event.keyCode&&$scope.synonymkey.searchQuery||$scope.manageGlobalSynonyms("",$scope.synonymkey.searchQuery,!0)},$scope.moveLastToTheBeginning=function(){var a=$scope.data.pop();$scope.data.splice(0,0,a)},$scope.treeOptions={accept:function(sourceNodeScope,destNodesScope,destIndex){return"undefined"!=typeof destNodesScope.node&&"uiTreeNode"===destNodesScope.$parent.$type?!0:!1},beforeDrop:function(e){},dropped:function(e){function proceedUpdateOnDragAndDrop(){sourceModelValue.parent[0]=destinationModalValue.nodeId,sourceModelValue.labelpath=(destinationModalValue.labelpath||destinationModalValue.label)+" > "+sourceModelValue.label,sourceModelValue.idsPath=(destinationModalValue.idsPath||destinationModalValue.nodeId)+" > "+sourceModelValue.nodeId,sourceModelValue.nodeIndexMap=destinationModalValue.nodeIndexMap||"0";var termsMapObject1={nodeIds:sourceModelValue.idsPath,path:sourceModelValue.labelpath,nodeIndexMap:sourceModelValue.nodeIndexMap};termsMap[sourceModelValue.nodeId]=termsMapObject1,updateTermAndIDsPath(sourceModelValue),$scope.updateOntology("","",!0)}console.log(e.source.nodeScope.$modelValue),$(".ontologyContainer").css({cursor:"default"}),console.log(e.dest);var sourceModelValue=e.source.nodeScope.$modelValue,destinationModalValue=e.dest.nodesScope.$nodeScope.$modelValue;return sourceModelValue.parent[0]!==destinationModalValue.nodeId?void getNodesLockStatus(proceedUpdateOnDragAndDrop):void(e.source.index==e.dest.index?console.log("same index"):getNodesLockStatus(proceedUpdateOnDragAndDrop))}},$scope.importOntology=function(){getNodesLockStatus($scope.importModal.openModal,!0)},$rootScope.$on("windowResize",function(){calculateViewWidth()}),$scope.callback.getFaqPath=function(parentID){var faqPaths=$scope.getFAQPath(parentID);return faqPaths},$scope.getFAQPath=function(parentID){if(termsMap&&termsMap[parentID]){var _faqPath=termsMap[parentID].path;if(_faqPath)return _faqPath;var term={},pathArray=[];do term=_.find($scope.ontologytreetaxonomy,{nodeId:parentID})||{},pathArray.push(term.label),parentID=term.parent&&term.parent[0];while(term.parent&&term.parent.length);return pathArray.reverse().join(" > ")}},$scope.publishKgCollection=function(){var kgId="";try{for(var str=$workflowService.kgDataFromKora().path,tempKg=str.split("/"),i=0;i<tempKg.length;i++)if("knowledge"==tempKg[i]){kgId=tempKg[i+1];break}}catch(e){console.log("Not able to get the knowledge id")}var payload={resources:[{namespace:"enterprise",resourceId:kgId,namespaceIds:[],resourceType:"knowledge",publishRoot:!0,nodesToPublish:[]}],publishAllComponents:!0,versionComment:i18n.i18nString("publish_kg")};BTStreamsService.standardPublish($workflowService.selectedStream()._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("published_kg"),"success")},function(err){NotificationService.notify(i18n.i18nString("unable_publish"),"error")})},$scope.getPathOfTerm=function(scope){var _termPath=[],allParents=$(scope.$element).parentsUntil(".termContainer").filter("[nodeid]");return allParents.each(function(k,l,m,n){var nodeObject={nodeLabel:$(this).attr("nodeLabel"),nodeId:$(this).attr("nodeID"),scope:$(this).scope()};_termPath.push(nodeObject)}),$scope._termPath=_termPath.reverse(),_.pluck($scope._termPath,"nodeLabel").join(" > ")},$scope.changeIntentFilter=function(intentFil){$scope.intentFilter.forEach(function(val){val.state=!1}),intentFil.state=!0,$scope.selectedFilter.val=intentFil.name.toLowerCase(),$scope.getFaqsByKnowledge()},$scope.onmMenuOptionClicked=function($event){if($event.stopPropagation(),$event.currentTarget){var _currEle=$($event.currentTarget);_currEle.siblings().removeClass("active"),_currEle.addClass("active"),_currEle.find(".dropdown").addClass("open")}},$scope.updateBreadCrumb=function(scope){var _breadCrumbData=[],_breadCrumbDataPath=[],_faqTagsPath=[];$("li").removeClass("pathColor"),$("li").removeClass("leftPathColor"),$("li").removeClass("topmostpath"),$(scope.$element).addClass("pathColor"),$(scope.$element).prevAll().addClass("leftPathColor");var allParents=$(scope.$element).parentsUntil(".termContainer").filter("[nodeid]");allParents.each(function(k,l,m,n){var nodeObject={nodeLabel:$(this).attr("nodeLabel"),tag:$(this).attr("nodeLabel"),nodeId:$(this).attr("nodeID"),scope:$(this).find(".ontologytreenode").scope(),hideRemove:!0},faqTagsObject={tag:$(this).attr("nodeLabel"),hideRemove:!0,tagUsage:$(this).attr("usageterm")};0===k&&(nodeObject["class"]="active"),$(this).addClass("pathColor"),$(this).prevAll().addClass("leftPathColor"),allParents.length-2==k&&$(this).addClass("topmostpath"),_breadCrumbData.push(nodeObject),_breadCrumbDataPath.push(nodeObject),_faqTagsPath.push(faqTagsObject)}),$scope.breadCrumbData=_breadCrumbData.reverse(),$scope.breadCrumbDataPath=_breadCrumbDataPath.reverse(),$scope.faqTagsPath=_faqTagsPath.reverse(),$scope.faqstats.path=_.pluck($scope.breadCrumbDataPath,"nodeLabel").join(" > ")},$scope.trainBotOntology=function(){var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};mixPanel.postEvent("KG Training initiated",_botInfo),$scope.trainOntologyStatus="in_progress",BTStreamsService.trainFaq($workflowService.selectedStream()._id,$scope.knowledgeTask._id).then(function(res){res&&res.data&&res.data.status&&"success"===res.data.status.toLowerCase()?($scope.trainOntologyStatus="success",NotificationService.notify(i18n.i18nString("kg_train"),"success")):res&&res.data&&res.data.status&&"in_progress"===res.data.status.toLowerCase()&&($rootScope.$broadcast("getProgressDockStatus"),$scope.trainOntologyStatus="in_progress",$scope.callback.startTimer())},function(err){if(err.data.errors.length>0){var _msg=err.data.errors[0].msg;NotificationService.notify(_msg,"error")}else NotificationService.notify(i18n.i18nString("problem_train"),"error");$scope.trainOntologyStatus="failure"})},$scope.callback.kgTrainingStatus=function(data){data&&($scope.trainOntologyStatus=data.status.toLowerCase(),"success"===$scope.trainOntologyStatus?(NotificationService.notify(i18n.i18nString("kg_train_success"),"success"),data.store&&data.store.heavyNodeCount&&($scope.heavyNodesCount=data.store.heavyNodeCount,NotificationService.notify(i18n.i18nString("training_heavynode"),"error"),$scope.knowledgeError=i18n.i18nString("knowledge_failed",{dyn:response.data.heavyNodeCount})+" "+i18n.i18nString("knowledge_failed_2",{dyn1:response.data.heavyNodeMinQuestions}),$scope.knowledgeErrorMsg=i18n.i18nString("knowledge_failed_1",{dyn:response.data.heavyNodeCount})+" "+i18n.i18nString("knowledge_failed_2",{dyn1:response.data.heavyNodeMinQuestions}),$("#trainfaq").modal({show:!0,backdrop:"static"}),$scope.csvDownloadId=response.data.fileId,$scope.storeUrl=response.data.store.urlParams)):NotificationService.notify(i18n.i18nString("training_failed"),"error"))},$scope.exportError=function(fileId){BTStreamsService.downloadProgressDockExportFile(fileId).then(function(res){if(res&&res.data){$scope.hrefURL=res.data.fileUrl+$scope.storeUrl;var element=document.createElement("a");element.setAttribute("href",$scope.hrefURL),element.setAttribute("target","_self"),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element),$("#trainfaq").modal("hide")}},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.hideDelModal=function(){$("#bulkDelete").modal("hide")},$scope.getTrainStatus=function(){var callName="streams/"+$workflowService.selectedStream()._id+"/knowledgetask/"+$scope.knowledgeTask._id+"/trainBot";botOntologyService.getTrainStatus($applicationService.userInfo.userId,$workflowService.selectedStream()._id,callName).then(function(response){if("success"==response.data.status)$rootScope.$broadcast("getProgressDockStatus"),$interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id]),$rootScope.statusInterval[$scope.knowledgeTask._id]="",$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=!1,NotificationService.notify(i18n.i18nString("kg_train_success"),"success");else if("failure"==response.data.status){$scope.heavyNodesCount=response.data.heavyNodeCount,response.data.heavyNodeCount&&NotificationService.notify(i18n.i18nString("training_heavynode"),"error"),$scope.knowledgeError=i18n.i18nString("knowledge_failed",{dyn:response.data.heavyNodeCount})+" "+i18n.i18nString("knowledge_failed_2",{dyn1:response.data.heavyNodeMinQuestions}),$scope.knowledgeErrorMsg=i18n.i18nString("knowledge_failed_1",{dyn:response.data.heavyNodeCount})+" "+i18n.i18nString("knowledge_failed_2",{dyn1:response.data.heavyNodeMinQuestions}),$("#trainfaq").modal({show:!0,backdrop:"static"}),$scope.csvDownloadId=response.data.fileId;var storeUrl=response.data.store.urlParams;$interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id]),$rootScope.statusInterval[$scope.knowledgeTask._id]="",$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=!1,$scope.exportError=function(fileId){BTStreamsService.downloadProgressDockExportFile(fileId).then(function(res){if(res&&res.data){$scope.hrefURL=res.data.fileUrl+storeUrl;var element=document.createElement("a");element.setAttribute("href",$scope.hrefURL),element.setAttribute("target","_self"),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element),$("#trainfaq").modal("hide"),$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=!1}},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")})}}},function(response){$rootScope.$broadcast("getProgressDockStatus"),$interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id]),$rootScope.statusInterval[$scope.knowledgeTask._id]="",$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=!1,NotificationService.notify(i18n.i18nString("problem_train"),"error")})},$scope.closeModal=function(){$("#trainfaq").modal("hide"),$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=!1},$scope.getQASForThisTerm=function(scope,isFromNode){function proceed(){function proceedClone(){$scope.hideOntologyQAForm(),$scope.selectTheClickedNode(scope),$scope.ontology.selectedTerm=scope.$modelValue,$scope.clickedNodeScope=scope,checkNodeState($scope.ontology.selectedTerm),$scope.ontology.selectedTerm.parent&&$scope.ontology.selectedTerm.parent.length||$scope.includeChildTermsQA(!0),$scope.showQuickTip(),$timeout(function(){$scope.closeQuickTip()},1e4),$scope.getFaqsByKnowledge("",isFromNode),clearBuffer()}$scope.showQAForm&&0===$("#noty_topCenter_layout_container").length?NotificationService.confirm({msg:i18n.i18nString("confirm_faq"),successCb:function(){proceedClone()},isModal:!0,btnTexts:{success:i18n.i18nString("yes"),fail:i18n.i18nString("no")}}):0===$("#noty_topCenter_layout_container").length&&proceedClone()}if(resetIntent(),$scope.isNewNodeSaveTriggered)return void($scope.buffers.callback=proceed);var secondLevelNode=getSecondLevelNodeOfNodeId(scope.$modelValue.nodeId);secondLevelNode?($scope.clickedTermParent=secondLevelNode,$scope.lockorCheckNode(secondLevelNode,proceed)):scope.$modelValue.nodeId==$scope.data[0].nodeId?($scope.lockorCheckNode(scope.$modelValue,proceed),$scope.clickedTermParent=$scope.ontology.selectedTerm):(proceed(),$scope.clickedTermParent=$scope.ontology.selectedTerm)},$scope.disableDrag=function(node){var _disableDrag=!1;return(!node.parent.length||node.isNewNode)&&(_disableDrag=!0),_disableDrag},$scope.showHideQACreateForm=function(show,resetShow){$scope.showQAForm=show,show?$scope.openModalSlider("#kgQaAddEditSlider"):resetShow||$scope.closeModalSlider("#kgQaAddEditSlider")};var highlightIndex=-1,_prevSearchTxt="",previousSearchTerm="",machedTerms=[],isFromSelect=!1;$scope.clearSearch=function(){releaseSearchBatch(),$scope.pattern="",$scope.searchTextInfo="",_prevSearchTxt="",$(".ontologytreenode").removeClass("matchednode"),$(".ontologytreenode").removeClass("highlightnode"),highlightIndex=-1,previousSearchTerm="",machedTerms=[],$scope.matchedTerms=[],$scope.currentSearchIndex=[]},$scope.highlightTermText=function(evt){if(!$scope.pattern)return void $scope.clearSearch();if(13==evt.keyCode){if(isFromSelect)return void(isFromSelect=!1);if($(evt.target).autocomplete("close"),previousSearchTerm!==$scope.pattern&&(machedTerms=[],machedTerms=_.filter($scope.ontologytreetaxonomy,function(nodeData){return-1!==nodeData.label.toLowerCase().indexOf($scope.pattern.toLowerCase())}),$scope.matchedTerms=machedTerms||[],previousSearchTerm=$scope.pattern,highlightIndex=-1),highlightIndex==machedTerms.length-1&&(highlightIndex=-1),machedTerms.length){highlightIndex+=1;var nodeIdsString=termsMap[machedTerms[highlightIndex].nodeId].nodeIds;$scope.searchTextInfo=highlightIndex+1+" of "+machedTerms.length,expandAndGotoSpecificNode(nodeIdsString)}else $scope.searchTextInfo=highlightIndex+1+" of "+machedTerms.length}},$scope.prevSearch=function(){$scope.navigateToSearch("backward")},$scope.nextSearch=function(){$scope.navigateToSearch("forward")},$scope.navigateToSearch=function(navigationType,index){if(navigationType=navigationType?navigationType:"forward",!machedTerms.length)return void($scope.searchTextInfo="");0===highlightIndex&&"backward"==navigationType?highlightIndex=machedTerms.length-1:highlightIndex>0&&"backward"==navigationType&&(highlightIndex-=1),highlightIndex==machedTerms.length-1&&"forward"==navigationType?highlightIndex=0:highlightIndex<machedTerms.length-1&&"forward"==navigationType&&(highlightIndex+=1),highlightIndex=-1==index?index+1:-1==highlightIndex?highlightIndex+1:highlightIndex,$(".angular-ui-tree-node .ontologytreenode").removeClass("highlightnode");var nodeIdsString=termsMap[machedTerms[highlightIndex].nodeId].nodeIds;$scope.searchTextInfo=highlightIndex+1+" of "+machedTerms.length,expandAndGotoSpecificNode(nodeIdsString)},$scope.updateScroll=function(scrollEle){$timeout(function(){PerfectScrollbar.update($(scrollEle)[0])},300)},$scope.bindGlobalSynonymsScrollPagination=function(){var formContainerEle=$("#globalSynonymSliderBody ");formContainerEle.unbind("scroll").bind("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&(console.log(event),$scope.manageGlobalSynonyms(null,null,null,null,null,!0))})},$scope.bindScrollPagination=function(){var formContainerEle=$("#faqsCollectectionBody");formContainerEle.unbind("scroll").bind("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&($scope.loadingPaginatedFAQs||$scope.getFaqsByKnowledge("","",!0))})},$scope.isRespEllipsisKgExtract=function(evt,qa){var _ellipsisEles=$(evt.target).closest(".row").find(".ellipsisview"),isElipsis=!1;return $.each(_ellipsisEles,function(i,elepsisEle){"true"==$(elepsisEle).attr("data-overflowed")&&(isElipsis=!0)}),(qa.answer&&qa.answer.length>110||qa.question&&qa.question.length>110)&&(isElipsis=!0),isElipsis},$scope.showFullResponse=function(qa){qa.fullView=!qa.fullView},$scope.checkCollapsed=function(scope){if($scope.expandAllNodes)return!0;var parentNode=$("[nodeid="+scope.node.parent[0]+"]").scope(),showNodes=parentNode.$modelValue["class"]?!0:!1;return showNodes},$scope.selectTheClickedNode=function(scope){if($scope.updateBreadCrumb(scope),$scope.resetFlags($scope.showFAQs),$scope.showFAQs=!0,$scope.activeNodeId=scope.$modelValue.nodeId,$scope.activeNodeLabel=scope.$modelValue.label,$(".ontologytreenode").removeClass("bgGreen"),scope.$modelValue.isNewNode){$("[nodeid='"+scope.$modelValue.parent[0]+"']").find("> .ontologytreenode").addClass("bgGreen");var parentScope=$("[nodeid='"+scope.$modelValue.parent[0]+"']").scope();$scope.activeNodeId=parentScope.$modelValue.nodeId,$scope.activeNodeLabel=parentScope.$modelValue.label,$scope.getFaqsByKnowledge()}else $(scope.$element).hasClass("ontologytreenode")?($($(scope.$element).closest(".ontologytreenode")[0]).addClass("bgGreen"),$("#nodeEle_"+scope.$modelValue.nodeId)&&$("#nodeEle_"+scope.$modelValue.nodeId).length&&$("#nodeEle_"+scope.$modelValue.nodeId).addClass("bgGreen")):$($(scope.$element).find("> .ontologytreenode")[0]).addClass("bgGreen")},$scope.withallchild=!0,$scope.includeChildTermsQA=function(dontCall){removeSelectedClass(),$scope.withallchild=!0,$scope.icIcon=$scope.iconContextPath+"/includechilds.svg",$scope.ecIcon=$scope.iconContextPath+"/excludechilds.svg",$scope.isFromKora&&($scope.ecIcon=$scope.iconContextPath+"/excludechilds-kora.svg"),$(".includechilds").addClass("selected"),dontCall||$scope.getFaqsByKnowledge("",!1)},$scope.excludeChildTermsQA=function(){removeSelectedClass(),$scope.withallchild=!1,$scope.ecIcon=$scope.iconContextPath+"/ecactive.svg",$scope.icIcon=$scope.iconContextPath+"/icinactive.svg",$scope.isFromKora&&($scope.icIcon=$scope.iconContextPath+"/icinactive-kora.svg"),$(".excludechilds").addClass("selected"),$scope.getFaqsByKnowledge("",!1)};var removeSelectedClass=function(){$(".eiicons").removeClass("selected")};$scope.resetFlags=function(){$scope.showBTS=!1,$scope.showHideQACreateForm(!1),$scope.showFAQs=!1},$scope.cancelWarn=function(){$(".warn-dup-sibling").modal("hide"),$("[nodeid="+backToFocusId+"]").find(".termname").focus()},$scope.newSubItem=function(scope){function proceed(){scope.expand();var nodeData=scope.$modelValue;checkNodeState(nodeData),nodeData.nodes=nodeData.nodes||[],scope.$modelValue.nodeBatch={startIndex:nodeData.nodes.length-$scope.loadItemsPerBatch,endIndex:nodeData.nodes.length+1};var newNodeID=uuid.v4(),newNodeObject={nodeId:newNodeID,label:"",level:"l"+scope.depth(),parent:[nodeData.nodeId],synonyms:[],nodes:[],traitRule:[],isNewNode:!0};nodeData.nodes.push(newNodeObject),$timeout(function(){$scope.selectTheClickedNode($("[nodeid="+newNodeID+"]").scope()),$("[nodeid="+newNodeID+"]").find(".termname").focus(),$scope.ontology.selectedTerm=$("[nodeid="+newNodeID+"]").scope().$modelValue,$scope.createNode=function(flag){newNodeObject.labelpath=(nodeData.labelpath||nodeData.label)+" > "+newNodeObject.label,newNodeObject.idsPath=(nodeData.idsPath||nodeData.nodeId)+" > "+newNodeObject.nodeId,newNodeObject.nodeIndexMap=(nodeData.nodeIndexMap||0)+" > "+JSON.stringify(nodeData.nodes.length-1),newNodeObject.nodeBatch=$workflowService.cloneData($scope.nodeBatch);var termsMapObject={nodeIds:newNodeObject.idsPath,path:newNodeObject.labelpath,nodeIndexMap:newNodeObject.nodeIndexMap};flag&&(newNodeObject.isDupe=!0,$(".warn-dup-sibling").modal("hide")),termsMap[newNodeObject.nodeId]=termsMapObject,nodeData.nodes[nodeData.nodes.length-1]=newNodeObject;var callback={};callback.method=$scope.openSettingsPanel,callback.data=$("[nodeid="+newNodeID+"]").scope(),callback.event="enter";var termData=callback.data.$modelValue;return termData.termStatus=!0,termData.label&&($scope.isNewNodeSaveTriggered||($scope.isNewNodeSaveTriggered=!0,$scope.cudOntologyNode("upsert",termData,callback),termData.label=getTextEncoded(termData.label))),!1},$("[nodeid="+newNodeID+"]").find(".termname").off("keydown").on("keydown",function(evt){if(13==evt.keyCode){var ua=window.navigator.userAgent,msie=ua.indexOf("MSIE ");if(msie>0||navigator.userAgent.match(/Trident.*rv\:11\./))$scope.isMSIE=!0,$("[nodeid="+newNodeID+"]").find(".termname").blur();else{var isDuplicate=!1;if(!$scope.isTermDisabled&&newNodeObject&&newNodeObject.parent&&newNodeObject.parent.length&&newNodeObject.parent[0])try{var parentId=newNodeObject.parent[0],siblingsNameList=$scope.taxonomyObjectData.childTermNames[parentId];siblingsNameList&&siblingsNameList[newNodeObject.label.toLowerCase()]&&(isDuplicate=!0,backToFocusId=newNodeID,$scope.pUpParent=$scope.taxonomyObjectData.nodeObject[parentId].label,$scope.pUpChild=newNodeObject.label,$(".warn-dup-sibling").modal("show"),$(".createNode").off("click").on("click",function(event){event.stopPropagation(),$scope.createNode(!0)}))}catch(e){console.log(e)}if(isDuplicate)return;$scope.createNode(null)}}}),$("[nodeid="+newNodeID+"]").find(".termname").off("blur").on("blur",function(evt){var proceedBlur=function(flag){flag&&$(".warn-dup-sibling").modal("hide"),newNodeObject.labelpath=(nodeData.labelpath||nodeData.label)+" > "+newNodeObject.label,newNodeObject.idsPath=(nodeData.idsPath||nodeData.nodeId)+" > "+newNodeObject.nodeId,newNodeObject.nodeIndexMap=(nodeData.nodeIndexMap||0)+" > "+JSON.stringify(nodeData.nodes.length-1),newNodeObject.nodeBatch=$workflowService.cloneData($scope.nodeBatch);var termsMapObject={nodeIds:newNodeObject.idsPath,path:newNodeObject.labelpath,nodeIndexMap:newNodeObject.nodeIndexMap};termsMap[newNodeObject.nodeId]=termsMapObject,nodeData.nodes[nodeData.nodes.length-1]=newNodeObject;var callback={};callback.method=$scope.openSettingsPanel,callback.data=$("[nodeid="+newNodeID+"]").scope(),callback.event="blur";var termData=callback.data.$modelValue;return $scope.stopUpdate?($scope.stopUpdate=!1,void(termData.label||$scope.removeNodeItem(callback.data,!0))):void(termData.label?($scope.isNewNodeSaveTriggered=!0,$scope.cudOntologyNode("upsert",termData,callback),termData.label=getTextEncoded(termData.label)):$scope.removeNodeItem(callback.data,!0))};if($scope.isMSIE){newNodeObject.labelpath=(nodeData.labelpath||nodeData.label)+" > "+newNodeObject.label,newNodeObject.idsPath=(nodeData.idsPath||nodeData.nodeId)+" > "+newNodeObject.nodeId,newNodeObject.nodeIndexMap=(nodeData.nodeIndexMap||0)+" > "+JSON.stringify(nodeData.nodes.length-1),newNodeObject.nodeBatch=$workflowService.cloneData($scope.nodeBatch);var ietermsMapObject={nodeIds:newNodeObject.idsPath,path:newNodeObject.labelpath,nodeIndexMap:newNodeObject.nodeIndexMap};termsMap[newNodeObject.nodeId]=ietermsMapObject,nodeData.nodes[nodeData.nodes.length-1]=newNodeObject;var iecallback={};iecallback.method=$scope.openSettingsPanel,iecallback.data=$("[nodeid="+newNodeID+"]").scope(),iecallback.event="enter";var ieTermData=iecallback.data.$modelValue;return ieTermData.label&&($scope.isNewNodeSaveTriggered=!0,$scope.cudOntologyNode("upsert",ieTermData,iecallback),ieTermData.label=getTextEncoded(ieTermData.label)),!1}if($scope.isTermDisabled||!$(".warn-dup-sibling").data("bs.modal")||!$(".warn-dup-sibling").data("bs.modal").isShown){if(!$scope.isTermDisabled&&newNodeObject&&newNodeObject.parent&&newNodeObject.parent.length&&newNodeObject.parent[0]){var isDuplicate=!1;try{var parentId=newNodeObject.parent[0],siblingsNameList=$scope.taxonomyObjectData.childTermNames[parentId];if(siblingsNameList&&siblingsNameList[newNodeObject.label.toLowerCase()])return isDuplicate=!0,backToFocusId=newNodeObject.nodeId,$scope.pUpParent=_.where($scope.ontologytreetaxonomy,{nodeId:newNodeObject.parent[0]})[0].label,$scope.pUpChild=newNodeObject.label,$(".warn-dup-sibling").modal("show"),void $(".createNode").off("click").on("click",function(event){event.stopPropagation(),proceedBlur(!0)})}catch(e){console.log(e)}if(isDuplicate)return}proceedBlur(null),$scope.isMSIE=!1}})},350),clearBuffer()}if($scope.isAvoidAddSub=!0,$timeout(function(){$scope.isAvoidAddSub=!1},100),$scope.isNewNodeSaveTriggered)return void($scope.buffers.callback=proceed);var secondLevelNode=getSecondLevelNodeOfNodeId(scope.$modelValue.nodeId);secondLevelNode?$scope.lockorCheckNode(secondLevelNode,proceed,!0):proceed()},$scope.collapseAll=function(){$scope.$broadcast("angular-ui-tree:collapse-all")},$scope.expandAll=function(){$scope.$broadcast("angular-ui-tree:expand-all")},$scope.data=[{nodeId:uuid.v4(),label:getTextEncoded($scope.stream.name),"class":"bgblack",level:"l0",parent:[],synonyms:[],nodes:[]}];getPayload();$scope.addNewRow=function(scope){$scope.ontology.selectedTerm=scope.$modelValue,$scope.ontology.selectedTerm.label&&$scope.ontology.selectedTerm.label.trim()&&$scope.updateOntology(),$timeout(function(){termEvents=new Events("[ui-tree-node]")},500)},$scope.ontologyfaqsStats={},$scope.openSettingsPanel=function(scope,isNewNodeFlow,isSaveFail){function proceed(){$scope.ontology.selectedTerm=scope.$modelValue,scope.$modelValue.parent.length||"undefined"!=typeof $scope.ontology.selectedTerm.termStatus||($scope.ontology.selectedTerm.termStatus=!0),checkNodeState($scope.ontology.selectedTerm),$scope.ontology.selectedTerm.saveFail=$scope.ontology.selectedTerm.saveFail||isSaveFail,$scope.selectTheClickedNode(scope),$scope.showBotOntologyTermSettings(),isNewNodeFlow&&$timeout(function(){$("#parentTermName").focus(),$("#parentTermName").select(),$(".ontologyContainer").scrollTop($(".bgGreen").offset().top)},150),clearBuffer()}if($scope.isNewNodeSaveTriggered)return void($scope.buffers.callback=proceed);var secondLevelNode=getSecondLevelNodeOfNodeId(scope.$modelValue.nodeId);secondLevelNode?($scope.clickedTermParent=secondLevelNode,$scope.lockorCheckNode(secondLevelNode,proceed)):proceed()},$scope.ontologyfaqsStats.editIndex=-1,$scope.openSynonyms=function(that,qaDetails){$timeout(function(){if($("#nodeEle_"+qaDetails.parent+" .nodeBTN.btn-xs.dispalyNone.cog").length)$("#nodeEle_"+qaDetails.parent+" .nodeBTN.btn-xs.dispalyNone.cog").trigger("click");else if(qaDetails.parent&&$scope.taxonomyObjectData.nodeObject[qaDetails.parent]){var scope={$modelValue:$scope.taxonomyObjectData.treeData[qaDetails.parent]};$scope.openSettingsPanel(scope)}else $("#nodeEle_"+qaDetails.parent+" .nodeBTN.btn-xs.dispalyNone.cog").trigger("click")},250)},$scope.hideOntologyQAForm=function(searchTerm){$scope.showHideQACreateForm(!1);var editIndex=$workflowService.cloneData($scope.ontologyfaqsStats.editIndex);$scope.ontologyfaqsStats.editIndex=-1,$timeout(function(){searchTerm&&($scope.faqSearch.faqSearchQuery=searchTerm,$scope.getFaqsByKnowledge("",!1)),-1!==editIndex?editIndex=-1:$(".faqcollection").scrollTop(0),registerDragDropEvents(),$scope.bindScrollPagination()},300)},$scope.showBotOntologyTermSettings=function(){$scope.showBTS=!0,$scope.openModalSlider("#qaEditTermSlider")},$scope.hideBotOntologyTermSettings=function(){$scope.closeModalSlider("#qaEditTermSlider"),$scope.showBTS=!1,$scope.getFaqsByKnowledge()},$scope.updateFaqCollection=function(faqData){$.each($scope.ontology.qas,function(i,faq){return faq._id==faqData._id?(faqData.faqPath=$scope.ontology.qas[i].faqPath||"",$scope.ontology.qas[i]=faqData,!1):void 0})},$scope.$watch("ontologyClassModal",function(newVal,oldVal){$scope.cb.ontologyClassModal=$scope.ontologyClassModal}),$scope.breadCrumbData=[],$scope.breadCrumbDataPath=[],$scope.faqTagsPath=[],$scope.selectAllQna=function(){
for(var currTag=$scope.current.tag,i=0;i<$scope.extraction.qas.length;i++){var qaStatus=$scope.extraction.qas[i].status;("allQues"===currTag||"addedQues"===currTag&&!qaStatus||"notAdded"===currTag&&qaStatus)&&($scope.extraction.qas[i].selected=!$scope.selectKgCheck.all)}},$scope.openKgExtractTwo=function(kgListData){if("success"===kgListData.status){$scope.search.faq="",$scope.openedKgName=kgListData.name,$scope.knowledgeExtractId._id=$workflowService.cloneData(kgListData._id),kgHistCountUpdate(),kgQuesAnsCall($scope.stream._id,kgListData._id,0,10,"","all"),$scope.selectKgCheck.all=!1,$scope.current.tag="allQues",$(".allQuestions").parent().children().removeClass("active"),$(".allQuestions").addClass("active");var loadNextFaqs=function(){var deferred=$q.defer();return BTStreamsService.kgQuesAns($scope.stream._id,$scope.knowledgeExtractId._id,10*countStart,10,$scope.search.faq,$scope.filterType).then(function(res){deferred.resolve(res)},function(err){deferred.reject(err)}),deferred.promise};$timeout(function(){document.getElementById("FaqKgList").addEventListener("scroll",function(e){$(this).scrollTop()+$(this).innerHeight()>=.95*$(this)[0].scrollHeight&&$scope.isMoreAvailable&&loadNextFaqsFlag&&(loadNextFaqsFlag=!1,loadNextFaqs().then(function(res){$scope.extraction.qas=$scope.extraction.qas.concat(res.data.extractions),$scope.extraction.allQAS=$scope.extraction.allQAS.concat(res.data.extractions),$scope.isMoreAvailable=res.data.moreAvailable,countStart++,loadNextFaqsFlag=!0,$timeout(function(){$scope.countFaqRow=$(".faqrow.checkboxWrap.qaCountSel").length>9,$scope.isFaqEmpty=0===$(".faqrow.checkboxWrap.qaCountSel").length,("addedQues"===$scope.current.tag&&getCountFaq("addedQues")===qna.added||"notAdded"===$scope.current.tag&&getCountFaq("notAdded")===qna.notAdded)&&($scope.countFaqRow=!1)},250)},function(err){NotificationService.notify(i18n.i18nString("unable_faq"),"error"),loadNextFaqsFlag=!0}))})},1e3)}else"inProgress"===kgListData.status?NotificationService.notify(i18n.i18nString("kg_extract_progress"),"error"):NotificationService.notify(i18n.i18nString("kg_request_failure"),"error")};var kgQuesAnsCall=function(streamId,knowledgeExtId,offset,limit,searchTerm,filterType,mess,flagFrom){BTStreamsService.kgQuesAns(streamId,knowledgeExtId,offset,limit,searchTerm,filterType).then(function(res){$scope.isKgExtractHist=!1,$scope.extraction.qas=$workflowService.cloneData(res.data.extractions),$scope.extraction.allQAS=$workflowService.cloneData(res.data.extractions),qna.added=res.data.qnaAddedCount,qna.notAdded=res.data.qnaExtractedCount,$scope.isMoreAvailable=res.data.moreAvailable,$scope.current.tag="allQues",$(".allQuestions").parent().children().removeClass("active"),$(".allQuestions").addClass("active");for(var tempQa={},tempQaCount=0,i=0;i<$scope.extraction.qas.length;i++)tempQa=$scope.extraction.qas[i],tempQaCount++;$scope.isFaqEmpty=0===tempQaCount,$scope.countFaqRow=tempQaCount>9,searchAttachClick(),"fromFilter"===flagFrom&&$(".kgFaqScroll").scrollTop(0),mess&&NotificationService.notify(mess,"success")},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")})};$scope.watchOutCancl=function(){$("#deleteNodeOption").removeClass("show").addClass("fade")},$scope.delteNode=function(elem){nodeElem=elem;var fqCount=null,fq=$scope.ontologytreetaxonomy.filter(function(val){return val.nodeId===elem.$modelValue.nodeId}),findId=function(id,list){return _.where(list,{nodeId:id}).length>0?(deletedNodeSiblingList=list,list):list.length>0?list.forEach(function(val){return val.nodes.length>0?findId(id,val.nodes):void 0}):void 0};$scope.isTermDisabled||findId(elem.$modelValue.nodeId,$scope.data[0].nodes),fq&&fq[0]&&fq[0].faqCount&&(fqCount=fq[0].faqCount),0===fqCount||null===fqCount?$scope.removeNodeItem(elem,null,"noFaqs"):($scope.delTerm.label=elem.$modelValue.label,$("#deleteNodeOption").removeClass("fade").addClass("show"))},$scope.watchOutCnfm=function(){$("#deleteNodeOption").removeClass("show").addClass("fade"),$scope.removeNodeItem(nodeElem,null,$scope["delete"].type)},$scope.logEvent=function(event){console.log(event+" "+moment().format("hh:mm:ss.SSS"))},$scope.getKTData=function(fromImport,fromTerm,kgList,knowledgeTasksByState){function buildKGraph(res){if($scope.logEvent("Received KG Data"),$workflowService.taskEditInfo()&&($scope.knowledgeTask=$workflowService.taskEditInfo()),res.data&&res.data[0]&&res.data[0].taxonomy&&(allFaqsAvailable=res.data[0].taxonomy),res.data.length){$scope.knowledgeTask=_.find(res.data,{_id:$scope.knowledgeTask._id}),$workflowService.knowledgeTasks(res.data),res.data=$scope.knowledgeTask||{},$scope.ontologytreetaxonomy=res.data.taxonomy.filter(function(val){return val.deleted!==!0}),$scope.loadingKnowledeGraph=!1,$scope.taxonomyObjectData={treeData:{},nodeObject:{},duplicates:{},childTermNames:{}},$scope.logEvent("Building KG tree started");var totalTreeData=prepareOntologyTree();$scope.logEvent("Building KG tree ended"),totalTreeData[0].nodes=[],totalTreeData[0]["class"]="bgblack",$scope.logEvent("Building parent child relation started"),fillChildrenOfParentId($scope.ontologytreetaxonomy,totalTreeData[0].nodes,totalTreeData[0]),$scope.logEvent("Building parent child relation ended"),$scope.data=totalTreeData.length&&totalTreeData||$scope.data,$scope.data&&$scope.data[0]&&$scope.data[0]&&($scope.logEvent("Checking for duplicates started"),checkForDuplicateChild($scope.data[0]),$scope.logEvent("Checking for duplicates ended")),$timeout(function(){if($scope.logEvent("Getting faqs for rootTerm"),fromTerm){var fromTermScope=$("[nodeid='"+fromTerm.nodeId+"'] .ontologytreenode").scope();$scope.openSettingsPanel(fromTermScope)}else{var rootNodeScope=$("[nodeid='"+$scope.data[0].nodeId+"'] .ontologytreenode").scope();$scope.getQASForThisTerm(rootNodeScope),$scope.expandDirectChildOfRoot(rootNodeScope)}initContainerDrag(),$scope.callback.openAnalysisFlag&&callAnalysisReport($scope.currentDockId),$scope.callback.openAnalysisFlag=!1,$scope.logEvent("Getting faqs for rootTerm ended")},500)}else $scope.loadingKnowledeGraph=!1,$scope.createOntology();$scope.logEvent("Completed KG Data Processing")}fromTerm||($scope.loadingKnowledeGraph=!0),fromImport&&($scope.data=[],$scope.ontology.qas=[]);var requestData={streamId:$workflowService.selectedStream()._id};if(knowledgeTasksByState&&0===knowledgeTasksByState.length){var taskStateResponse={};taskStateResponse.data=knowledgeTasksByState,$timeout(function(){buildKGraph(taskStateResponse)},500)}else if(kgList){var response={};response.data=kgList,$timeout(function(){buildKGraph(response)},500)}else BTStreamsService.getAllKtsList($applicationService.userInfo().userId,requestData).then(function(res){buildKGraph(res)},function(err){})},$scope.getAndUpdateOntology=function(fromTerm){$scope.getKTData(!1,fromTerm)},$scope.getTermLabelByID=function(id){var term=_.find($scope.ontologytreetaxonomy,{nodeId:id})||{};return term.label||""};var checkNodeState=function(term,fromDelete){var _nodesToPublish=$scope.knowledgeTask.nodesToPublish,awaitingApproFlag="awaitingApproval"===$scope.knowledgeTask.state;if(-1!==$.inArray(term.nodeId,_nodesToPublish)&&!fromDelete&&awaitingApproFlag)NotificationService.notify(i18n.i18nString("node_publishing",{term:term.label}));else if(-1!==$.inArray(term.nodeId,_nodesToPublish)&&fromDelete&&awaitingApproFlag)return i18n.i18nString("node_publishing",{term:term.label})};$scope.releaseLock=function(resourceID,hideMsg){return BTStreamsService.releaseLock(resourceID).then(function(res){hideMsg||NotificationService.notify(i18n.i18nString("edit_locked",{name:resource.name}),"success")},function(err){return hideMsg||NotificationService.notify(i18n.i18nString("edit_lock_failed",{name:resource.name}),"error"),$q.reject({data:{error:i18n.i18nString("lock_release_failed")}})})},$scope.lockResource=function(resourceID){return BTStreamsService.createLock(resourceID).then(function(res){},function(err){return showLockErrorMessage(err.data,err),$q.reject(err)})};var prevResourceId="";$scope.isTermLocked=!1,$scope.isFaqChecked=function(){return 0!==$(".faqCheckBox input:checked").length},$scope.editKgQnA=function(qaDetails){$(".editQnAForm").hide(),$(".editQnAForm[edit-id="+qaDetails._id+"]").show(),$(".qaFinder[qa-id="+qaDetails._id+"]").hide(),$scope.editQnA.ques=qaDetails.question,$scope.editQnA.ans=qaDetails.answer,$scope.statusEnabled=!1},$scope.saveEditQnA=function(details){var payload={question:$scope.editQnA.ques,answer:$scope.editQnA.ans};BTStreamsService.kgQnAUpdate($scope.stream._id,details.kEId,details._id,payload).then(function(res){$(".editQnAForm[edit-id="+details._id+"]").hide(),$(".qaFinder[qa-id="+details._id+"]").show(),$scope.editQnA.ques="",$scope.editQnA.ans="",kgQuesAnsCall($scope.stream._id,details.kEId,0,10,"",$scope.filterType,i18n.i18nString("faq_updated"))},function(err){NotificationService.notify(i18n.i18nString("unable_save"),"error")}),$scope.statusEnabled=!0},$scope.cancelEditQnA=function(details){$(".editQnAForm[edit-id="+details._id+"]").hide(),$(".qaFinder[qa-id="+details._id+"]").show(),$scope.editQnA.ques="",$scope.editQnA.ans="",$scope.statusEnabled=!0},$scope.deleteKgFAQ=function(delData){NotificationService.confirm({heading:i18n.i18nString("delete_faq"),headerClass:"confirmationHeader",msg:i18n.i18nString("are_delete"),successCb:function(){BTStreamsService.kgQnADel($scope.stream._id,delData.kEId,delData._id).then(function(res){kgQuesAnsCall($scope.stream._id,delData.kEId,0,10,"",$scope.filterType,i18n.i18nString("faq_deleted"))},function(err){console.log("Error ",err)})},failCb:function(){},isModal:!0,btnTexts:{success:i18n.i18nString("ok_label"),fail:i18n.i18nString("cancel")}})},$scope.goToKgExtractHist=function(){$scope.openedKgName="",$scope.isKgExtractHist=!0},$scope.delBulkOnto=function(){resetIntent(),$scope.ontology.allFAQsSelected=!1,$scope.hideDelModal();for(var $checked=$(".faqCheckBox input:checked"),payload={faqIds:[]},i=0;i<$checked.length;i++)payload.faqIds.push($checked[i].id);BTStreamsService.botOntoBulkDel($scope.userInfo.userId,payload).then(function(res){$scope.getFaqsByKnowledge(),NotificationService.notify(i18n.i18nString("success_deleted"),"success")},function(err){NotificationService.notify(i18n.i18nString("unable_delete_faq"),"error")})},$scope.lockorCheckNode=function(resource,cbMethod,stopOnError){if($scope.resourceCopy=$workflowService.cloneData(resource),!(resource.nodeId===$scope.data[0].nodeId||resource.parent&&resource.parent.length&&resource.parent[0]===$scope.data[0].nodeId&&$scope.isEditable()))return void cbMethod();var resourceID=resource.nodeId;resourceID=$scope.knowledgeTask._id+"@"+resourceID,prevResourceId&&prevResourceId!==resourceID&&$scope.releaseLock(prevResourceId,!0),resource.nodeId!==$scope.data[0].nodeId?$scope.lockResource(resourceID).then(function(res){prevResourceId=resourceID,$scope.isTermLocked=!1,cbMethod()},function(err){$scope.isTermLocked=!0,stopOnError||cbMethod()}):cbMethod()},$scope.getKTData(null,null,$scope.callback.knowledgetasksList,$scope.callback.knowledgeTasksByState);(function(){if(void 0!==$workflowService.kgTrainingStatus()){var _statusData=$workflowService.kgTrainingStatus();_statusData&&_statusData.status&&($scope.trainOntologyStatus=_statusData.status.toLowerCase())}})();$scope.callback.parentId=$scope.data[0].nodeId,$scope.callback.openEditFAQ=function(index,linkFaq,scope,returnValue){if(returnValue){var returnFaqValue=$scope.openEditFAQ(index,linkFaq,scope,returnValue);return returnFaqValue}$scope.openEditFAQ(index,linkFaq,scope,returnValue)},$scope.openEditFAQ=function(index,qa,scope,returnValue){if($scope.deleteFaqLinkedOpen=!1,!returnValue&&qa.faqLinkedTo){var faqID=qa._id,isFaqExist=!1;_.forEach($scope.callback.allFaqs,function(eachFaq){eachFaq.refId===qa.faqLinkedTo&&(isFaqExist=!0)}),isFaqExist||qa.faqLinkedBy.length||($scope.showHideQACreateForm(!1),$scope.deleteFaqLinkedOpen=!0,$("#deleteFaqLinked").modal({show:!0,backdrop:"static"})),$scope.removeFAQ=function(){BTStreamsService.removeFAQ($applicationService.userInfo.userId,faqID).then(function(response){$scope.getFaqsByKnowledge(),NotificationService.notify(i18n.i18nString("q&a_deleted"),"success"),_.forEach($scope.callback.allFaqs,function(qa,key){response&&response.data&&response.data._id&&qa&&qa._id&&response.data._id===qa._id&&$scope.callback.allFaqs.splice(key,1)}),$scope.closeDeleteModal(),$scope.closeDeleteFaqModal()},function(error){$("#noty_center_layout_container").empty(),NotificationService.notify(i18n.i18nString("failed_delete_q&a"),"error")})}}if(!$scope.deleteFaqLinkedOpen){var secondLevelNode=getSecondLevelNodeOfNodeId(qa.parent),currentNode={nodeId:$scope.activeNodeId,label:$scope.activeNodeLabel};if(checkNodeState(currentNode),secondLevelNode&&($scope.clickedTermParent=secondLevelNode,$scope.clickedTermParent.qaEditMode=!0),$scope.updatedQA=qa,qa.parent===$scope.data[0].nodeId?$scope.updatedQA.isRootTerm=!0:$scope.updatedQA.isRootTerm=!1,qa.faqLinkedTo&&($scope.callback.showProtipLinkFaq=!0),qa.faqLinkedBy&&qa.faqLinkedBy.length&&!returnValue?($scope.showHideQACreateForm(!1,!0),$scope.ontologyfaqsStats.editIndex=-1,setTimeout(function(){$scope.showHideQACreateForm(!0),$scope.ontologyfaqsStats.editIndex=0,qa.faqLinkedBy&&qa.faqLinkedBy.length&&($scope.callback.showProtipLinkFaq=!1)},100)):$scope.showHideQACreateForm(!0),$scope.updateTagPath(qa.parent),returnValue)return $scope.updatedQA}},$scope.updateTagPath=function(parentID){var term={},pathArray=[];do{term=_.find($scope.ontologytreetaxonomy,{nodeId:parentID})||{};var nodeObject={};nodeObject.tag=term.label,nodeObject.hideRemove=!0,pathArray.push(nodeObject),parentID=term.parent&&term.parent[0]}while(term.parent&&term.parent.length);$scope.faqEditTagsPath=pathArray.reverse()},$scope.toggleFAQSelection=function(){$.each($scope.ontology.qas,function(i,faq){faq.selected=$scope.ontology.allFAQsSelected})};var _parentHeight=0,_parentWidth=0,triggerZone=100,scrollSpeed=2,Events=function(element){this.element=element};Events.prototype.registerDrag=function(){$(this.element).draggable({appendTo:".ontology-form",cursor:"move",cursorAt:{top:-12,left:-20},zIndex:999999,containment:".ontology-form",scroll:!1,helper:function(event){if($scope.selectedQuestions&&$scope.selectedQuestions.length>0){var html='<div class="ui-widget-header tileParent" style="z-index:999999"><div class="child1"><div class="child2"><div class="child3"><span class="pull-right countercircle">'+$scope.selectedQuestions.length+'</span><span class="helperText">'+$scope.selectedQuestions[0].questionPayload.question+"</span></div></div></div></div>";return $scope.html=html,$(html)}},start:function(event,ui){$scope.dragInProgress=!0,ondragStart(event,ui)},stop:function(event,ui){$scope.dragInProgress=!1,$(".ontologyContainer").each(function(){clearInterval($(this).data("timerScroll")),$(this).data("timerScroll",!1)})},refreshPositions:!0,drag:function(event,ui){ondragging(event,ui)}})},$scope.exportOntology=function(fileType){function startExport(){var payload={exportType:fileType,streamId:$workflowService.selectedStream()._id,knowledgeTaskId:$workflowService.taskEditInfo()._id,getFileId:!0};botOntologyService.exportOntology($scope.userInfo.userId,payload).then(function(res){NotificationService.notify(i18n.i18nString("kg_export"),"success"),$rootScope.$broadcast("getProgressDockStatus"),$scope.$broadcast("startTimer")},function(err){err&&err.data&&err.data.errors[0]&&(403==err.data.errors[0].code?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_export"),"error"))}),$(".rightOptions .dropdown").removeClass("open")}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope.callback.exportOntology?$scope.callback.exportOntology(fileType):$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("download_graph")):startExport()};var checkAndUpdateWfacebook=function(curChannel){"Workplace For Groups"===curChannel.channel||"wfacebookG"===curChannel.channel?(curChannel.channel="wfacebook",curChannel.isMention=!0):("Workplace For Chat"===curChannel.channel||"wfacebookC"===curChannel.channel)&&(curChannel.channel="wfacebook",curChannel.isMention=!1)};Events.prototype.enableDrag=function(){$(this.element).hasClass("ui-draggable")&&$(this.element).draggable("enable")},Events.prototype.disableDrag=function(){$(this.element).hasClass("ui-draggable")&&$(this.element).draggable("disable")},Events.prototype.registerDrop=function(){$(this.element).droppable({hoverClass:"nodehovered",classes:{"ui-droppable-hover":"ui-state-hover"},tolerance:"pointer",drop:function(event,ui){console.log("dropped");var parent=$(event.target).closest("li").attr("nodeID"),leafterm=$(event.target).closest("li").attr("label"),hoverNodeScope=$("[nodeid='"+parent+"'] .ontologytreenode").scope(),faqCollectionPayload=($scope.getPathOfTerm(hoverNodeScope),_.map($scope.selectedQuestions,function(question){question.parent=parent,question.leafterm=leafterm,question.responseType||(question.answerPayload.length?question.responseType="message":"dialog"===question.responseType?question.responseType="dialog":$scope.faqData.responseType="");var faqPayload={_id:question._id,questionPayload:question.questionPayload||"",responseType:question.responseType,knowledgeTaskId:question.knowledgeTaskId,subQuestions:question.subQuestions||[],streamId:question.streamId,parent:question.parent,leafterm:question.leafterm||""};if("message"==question.responseType){var answerPayload=[];$.each(question.answerPayload,function(i,answers){var ans={};ans._id=answers._id,ans.text=encodeJS(answers.text),ans.type=answers.type,ans.channel=answers.channel||"default",answerPayload.push(ans)}),checkAndUpdateWfacebook(answerPayload[0]);var subAnswers=[];$.each(question.subAnswers,function(i,answerObject){checkAndUpdateWfacebook(question.answerPayload[0]);var answerPayloadObject=[];$.each(answerObject,function(i,subAnswerObject){var answerObject={_id:subAnswerObject._id,text:encodeJS(subAnswerObject.text),type:subAnswerObject.type,channel:subAnswerObject.channel||"default"};answerPayloadObject.push(answerObject)}),checkAndUpdateWfacebook(answerPayloadObject),subAnswers.push(answerPayloadObject)}),faqPayload.answerPayload=answerPayload||"",faqPayload.subAnswers=subAnswers||""}else"dialog"===question.responseType&&(faqPayload.dialogId=question.dialogId);return faqPayload}));$scope.ontology.qas=_.filter($scope.ontology.allQAS,function(qas){return!0})||[],$scope.faqBulkUpdate(faqCollectionPayload,hoverNodeScope)}})},$scope.$watch("ontology.qas",function(newVal,oldVal){$scope.selectedQuestions=_.filter($scope.ontology.qas,{selected:!0})||[],$scope.selectedQuestions&&!$scope.selectedQuestions.length&&faqEvents?$timeout(function(){console.log("disable drag"),faqEvents.disableDrag()},200):faqEvents&&$timeout(function(){faqEvents.enableDrag()},200)},!0),$scope.getThisQaTermLockstate=function(qa){var term=getSecondLevelNodeOfNodeId(qa.parent);return term?term.editLocked:void 0},$scope.checkLevel=function(node){var rootNodeId=$scope.data[0].nodeId;return node.parent[0]==rootNodeId&&node.editLocked?!0:!1},$scope.createConnections=function(){var _source=$(".angular-ui-tree-node"),_target=".angular-ui-tree-node .angular-ui-tree-node";_source.connections({to:_target,within:$(".angular-ui-tree-nodes")})},$scope.getFormattedData=function(){function format(json_string,key_to_skip){return JSON.parse(json_string,function(key,value){return key!==key_to_skip?value:void 0})}return format(JSON.stringify($scope.data),"isNewNode")};var saveAutoQualifyParent=function(parentNodeId,ids){var parentNode=_.where($scope.ontologytreetaxonomy,{nodeId:parentNodeId});if(parentNode.length>0){saveAutoQualifyParent(parentNode[0].parent[0],ids);var nodeDetails=_.where($scope.ontologytreetaxonomy,{nodeId:parentNodeId})[0],nodeDetailsPick=_.pick(_.where($scope.ontologytreetaxonomy,{nodeId:parentNodeId})[0],"parent","synonyms","preConditions","contextTags","enableContext","traitRule","isDummy","nodeId","label","level","termUsage");_.isEmpty(nodeDetailsPick)||(nodeDetails.autoQualify=!0,nodeDetailsPick.autoQualify=!0,nodeDetailsPick.operation="upsert",ids.push(nodeDetailsPick.nodeId),botOntologyService.cudOntologyNode($scope.userInfo.userId,$scope.stream._id,$scope.knowledgeTask._id,[nodeDetailsPick]).then(function(response){}))}};$scope.cudOntologyNode=function(operation,nodeData,cb,msg){var isFromSettings=_.isArray(nodeData);nodeData=_.isArray(nodeData)?nodeData:[nodeData],nodeData=_.map(nodeData,function(node){return node=_.omit(node,["nodes","class","saveFail","isNewNode","defaultCollapse","labelpath","idsPath","faqCount","deleted","nodeIndexMap","nodeBatch"]),node.operation=operation,node});var loader="";loader=cb&&"delete"==cb.event?NotificationService.loader(i18n.i18nString("deleting_term")):NotificationService.loader(i18n.i18nString("updating_kg")),toggleFreezeClass("addClass");try{""===nodeData[0].displayName&&delete nodeData[0].displayName}catch(e){console.log(e)}var nodeData2=$workflowService.cloneData(nodeData);nodeData2.map(function(val){return val.hasOwnProperty("isDupe")&&delete val.isDupe,val.hasOwnProperty("hideWarn")&&delete val.hideWarn,val}),botOntologyService.cudOntologyNode($scope.userInfo.userId,$scope.stream._id,$scope.knowledgeTask._id,nodeData2).then(function(response){function replaceParentAutoQualify(nodes,ids){0!==ids.length&&(_.findWhere(nodes,{nodeId:ids[0]}).autoQualify=!0,ids.shift(),0!==ids.length&&replaceParentAutoQualify(_.findWhere(nodes,{nodeId:ids[0]}).nodes,ids))}$scope.ontologytreetaxonomy=response.data.taxonomy,$scope.knowledgeTask.taxonomy=response.data.taxonomy,prepareOntologyTree();var findId=function(id,list){return _.where(list,{nodeId:id}).length>0?void 0:void list.forEach(function(val){return val.nodes.length>0?findId(id,val.nodes):void 0})};!$scope.isTermDisabled&&nodeData2&&nodeData2.length&&nodeData2[0]&&nodeData2[0].parent&&(checkForDuplicateChild($scope.taxonomyObjectData.nodeObject[nodeData2[0].parent],!0),nodeData2[0].autoQualify&&(idsList=[],nodeData2[0].parent&&nodeData2[0].parent[0]&&saveAutoQualifyParent(nodeData2[0].parent[0],idsList),idsList.shift(),$scope.data&&$scope.data[0]&&$scope.data[0].nodes&&($scope.data[0].autoQualify=!0,replaceParentAutoQualify($scope.data[0].nodes,idsList)))),isFromSettings&&updateParentToChildAllData(cb.data),$scope.isTermDisabled||("delete"==cb.event&&deletedNodeSiblingList.length>0?findId(deletedNodeSiblingList[0].nodeId,$scope.data[0].nodes):findId(nodeData2[0].nodeId,$scope.data[0].nodes)),nodeData2[0].parent.length||($scope.data[0].termStatus=nodeData2[0].termStatus);var parentNodeId=nodeData2[0].nodeId,updateData=(nodeData2[0].parent,function(nodes,termStatus){_.forEach(nodes,function(taxonomy){taxonomy.nodeId===parentNodeId&&(taxonomy.termStatus=nodeData2[0].termStatus),taxonomy.nodes.length&&updateData(taxonomy.nodes,termStatus)})});updateData($scope.data[0].nodes,!1),cb&&"enter"==cb.event?($scope.parentTermScope=$("[nodeid='"+cb.data.$modelValue.parent[0]+"']").scope(),$scope.stopUpdate=!0,delete $scope.ontology.selectedTerm.isNewNode,$scope.newSubItem($scope.parentTermScope),loader()):cb&&"delete"==cb.event?($scope.getQASForThisTerm(cb.data),loader()):loader(),toggleFreezeClass("removeClass"),$scope.buffers.callback&&(delete $scope.ontology.selectedTerm.isNewNode,$scope.buffers.callback()),delete $scope.ontology.selectedTerm.isNewNode,$scope.isNewNodeSaveTriggered=!1,$scope.ontology.selectedTerm.showCheck=!0;var _selectedTerm=$scope.ontology.selectedTerm;$timeout(function(){delete _selectedTerm.showCheck},1e3),msg=msg?msg:i18n.i18nString("terms_saved"),NotificationService.notify(msg,"success"),$scope.forms.saveInProgress=!1;$("[nodeid="+$scope.ontology.selectedTerm.nodeId+"] .ontologytreenode").removeClass("matchednode"),$("[nodeid="+$scope.ontology.selectedTerm.nodeId+"] .ontologytreenode").removeClass("highlightnode"),$scope.navigateToSearch("",-1),toggleFreezeClass("removeClass")},function(error){$scope.isNewNodeSaveTriggered=!1,loader(),toggleFreezeClass("removeClass")})},$scope.updateOntology=function(cb,msg,fromNodeDrop,termData){termData&&updateParentToChildAllData(termData);var payload={};payload.name=$scope.data&&$scope.data[0]&&$scope.data[0].label||$scope.knowledgeTask.name,payload.description=$scope.knowledgeTask.description||"",payload.taxonomy=getPayload(),payload.isGraph=!0,payload.visibility={namespace:$scope.knowledgeTask.visibility&&$scope.knowledgeTask.visibility.namespace,namespaceIds:$scope.knowledgeTask.visibility&&$scope.knowledgeTask.visibility.namespaceIds},payload.streamId=$scope.stream._id,payload._id=$scope.knowledgeTask._id,payload.metadata={taxonomy:$scope.getFormattedData()};var loader="";loader=cb&&"delete"==cb.event?NotificationService.loader(i18n.i18nString("deleting_term")):NotificationService.loader(i18n.i18nString("updating_kg")),toggleFreezeClass("addClass");try{payload.taxonomy.forEach(function(v){delete v.isDupe,delete v.hideWarn}),payload.metadata.taxonomy.forEach(function(v){delete v.isDupe,delete v.hideWarn})}catch(e){console.log("KG_Taxonomy_Based key not found")}botOntologyService.updateTerm($scope.userInfo.userId,payload).then(function(res){console.log(res),$scope.ontologytreetaxonomy=res.data.taxonomy,prepareOntologyTree(),checkForDuplicateChild($scope.ontologytreetaxonomy[0],!0),cb&&"enter"==cb.event?($scope.parentTermScope=$("[nodeid='"+cb.data.$modelValue.parent[0]+"']").scope(),$scope.stopUpdate=!0,delete $scope.ontology.selectedTerm.isNewNode,$scope.newSubItem($scope.parentTermScope),loader()):cb&&"delete"==cb.event?($scope.getQASForThisTerm(cb.data),loader()):(loader(),$scope.clickedNodeScope&&$scope.getQASForThisTerm($scope.clickedNodeScope,!0)),$scope.buffers.callback&&(delete $scope.ontology.selectedTerm.isNewNode,$scope.buffers.callback()),delete $scope.ontology.selectedTerm.isNewNode,$scope.isNewNodeSaveTriggered=!1,$scope.ontology.selectedTerm.showCheck=!0;var _selectedTerm=$scope.ontology.selectedTerm;$timeout(function(){delete _selectedTerm.showCheck},1e3),msg=msg?msg:i18n.i18nString("terms_saved"),NotificationService.notify(msg,"success"),$scope.forms.saveInProgress=!1,toggleFreezeClass("removeClass");var currentscope="";$(".ontologyContainer").find(".bgGreen").length&&fromNodeDrop?(currentscope=$(".ontologyContainer").find(".bgGreen").scope(),$scope.selectTheClickedNode(currentscope)):!$(".ontologyContainer").find(".bgGreen").length&&fromNodeDrop&&(currentscope=$("[nodeid='"+$scope.ontology.selectedTerm.nodeId+"']").find(".ontologytreenode").scope(),$scope.selectTheClickedNode(currentscope)),$("[nodeid="+$scope.ontology.selectedTerm.nodeId+"] .ontologytreenode").removeClass("matchednode"),$("[nodeid="+$scope.ontology.selectedTerm.nodeId+"] .ontologytreenode").removeClass("highlightnode"),$scope.navigateToSearch("",-1)},function(err){console.log(err),$scope.forms.saveInProgress=!1,toggleFreezeClass("removeClass"),cb&&$(cb.data.$element).find(".termname").focus(),cb&&"delete"==cb.event?(NotificationService.notify(i18n.i18nString("failed_term_delete"),"error"),loader()):NotificationService.notify(i18n.i18nString("failed_term_save"),"error")})},$scope.createOntology=function(){var payload={};payload.name=$workflowService.selectedStream().name,payload.description=i18n.i18nString("make_kg"),payload.taxonomy=getPayload(),payload.isGraph=!0,payload.visibility={namespace:"private",namespaceIds:[$scope.userInfo.userId]},payload.streamId=$scope.stream._id,payload.metadata={taxonomy:$scope.getFormattedData()},botOntologyService.createTerm($scope.userInfo.userId,payload).then(function(res){console.log(res),$scope.knowledgeTask=res.data,$scope.callback.getKnowledgeTasksOnto(),$scope.ontologytreetaxonomy=res.data.taxonomy,$scope.data=res.data.metadata&&res.data.metadata.taxonomy.length&&res.data.metadata.taxonomy||$scope.data,$timeout(function(){$timeout(function(){initContainerDrag()},600),$scope.getQASForThisTerm($(".bgblack").scope())},500)},function(err){console.log(err)})},$timeout(function(){var hoverTimer=$(document).on("mouseover",".ontologytreenode",function(evt){function scrollToViewPort(){evt.stopPropagation(),evt.stopImmediatePropagation(),evt.preventDefault();var offsetObj=$(evt.target).closest(".ontologytreenode").offset(),_scrollLeftPos=$(".ontologyContainer").scrollLeft(),_scrollUpto=0,totalWidthComparision=$(".ontologyContainer").width()<($(evt.target).closest(".ontologytreenode").width()+(offsetObj&&offsetObj.left)?offsetObj.left:0);offsetObj.left<0?(_scrollUpto=_scrollLeftPos+offsetObj.left,$(".ontologyContainer").scrollLeft(_scrollUpto)):offsetObj.left>0&&totalWidthComparision&&(_scrollUpto=_scrollLeftPos+offsetObj.left,$(".ontologyContainer").scrollLeft(_scrollUpto))}hoverTimer=$timeout(function(){scrollToViewPort()},500)}).on("mouseout",".ontologytreenode",function(evt){$timeout.cancel(hoverTimer)})},1e3),$scope.faqBulkUpdate=function(faqCollectionPayload,scope){var _faqCollectionPayload={faqs:faqCollectionPayload};BTStreamsService.faqBulkUpdate($scope.userInfo.userId,_faqCollectionPayload).then(function(resonse){$scope.getQASForThisTerm(scope),$scope.ontology.allFAQsSelected=!1,NotificationService.notify(i18n.i18nString("faq_moved"),"success")},function(err){if(err&&err.data&&err.data.errors[0]){var error=err.data.errors,msg=_.isArray(error)?error[0].msg:i18n.i18nString("failed_faq");NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("failed_faq"),"error")})},$scope.checkFaqSearchInp=function(e){16===e.which?$scope.shift.key=!0:$scope.shift.key&&13===e.which?$scope.shift.key=!1:13===e.which&&($scope.shift.key=!1,e.preventDefault(),$scope.isFromSearch=!0,$scope.searchKgFaq())},$scope.searchKgFaq=function(){$scope.countFaqScroll=0,kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,0,10,$scope.search.faq,$scope.filterType)},$scope.$watch("search.faq",function(newVal,oldVal){""===newVal&&""!==$scope.knowledgeExtractId._id&&($scope.searchKgFaq(),$scope.isFromSearch=!1)}),$scope.addQnAExtractToKnowledge=function(){var data;data=$scope.ontology.selectedTerm?$scope.ontology.selectedTerm:$scope.data[0];var selectedQues=$scope.extraction.qas.filter(function(val){return val.selected}),payload=[];selectedQues.forEach(function(val,ind){var faqPayload={questionPayload:{question:val.question,tagsPayload:[]},answerPayload:[{text:val.answer,type:"basic",channel:"default"}],knowledgeTaskId:$scope.knowledgeTask._id,subQuestions:[],responseType:"message",subAnswers:[],streamId:val.streamId,parent:data.nodeId,leafterm:data.label,qsId:val._id};payload.push(faqPayload)});var payloadFaqs={faqs:payload};BTStreamsService.kgDragDropFaq($applicationService.userInfo().userId,payloadFaqs).then(function(res){res.data.message?NotificationService.notify(res.data.message,"warning"):NotificationService.notify(i18n.i18nString("selected_added_kg"),"success"),kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,0,10,"","all"),kgHistCountUpdate(),$(".kgFaqScroll").scrollTop(0),$scope.updateCurrentTab("allQues"),$scope.getFaqsByKnowledge("",!0)},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg?(NotificationService.notify(err.data.errors[0].msg,"error"),409===err.data.errors[0].code&&kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,0,10,"","")):console.error("Error Detected ",err)})},$scope.callback.externalFaqSearch=externalFaqSearch,$scope.searchFAQ=function(event){event||($scope.faqSearch.faqSearchQuery="",$scope.getFaqsByKnowledge("",!1)),!event||13!=event.keyCode&&$scope.faqSearch.faqSearchQuery||$scope.getFaqsByKnowledge("",!1)},$scope.showNodeSuggestions=!0,$scope.closeNodeSuggestions=function(){
$scope.showNodeSuggestions=!1;var parentTermScope=$(".bgblack").scope();$scope.newSubItem(parentTermScope)};var registerDragDropEvents=function(){$timeout(function(){faqEvents=new Events(".faqsbody"),termEvents=new Events(".tree-node-content"),faqEvents.registerDrag(),termEvents.registerDrop()},200)};$scope.checkFromSearch=function(){return $scope.isFromSearch},$scope.checkFromSynSearch=function(){return $scope.isFromSynSearch},$scope.moreAvailable=!0,$scope.getFaqsByKnowledge=function(offset,isFromNode,isFromPagination,isFKora){var searchParam=encodeJS($scope.faqSearch.faqSearchQuery)||"";if(offset=offset||0,void 0===isFromNode&&(isFromNode=!0),isFromNode&&($scope.faqsLoaded=!1,searchParam="",$scope.faqSearch.faqSearchQuery="",$scope.ontology.qas=[]),isFromPagination){if(!$scope.moreAvailable||$scope.loadingPaginatedFAQs)return;$scope.faqPaginationFlag=!0,$scope.loadingPaginatedFAQs=!0,offset=$scope.ontology.qas.length}$scope.faqsFromNode=isFromNode,$workflowService.storeSearchQry().userSearchQueryFlag&&(searchParam=$workflowService.storeSearchQry().searchQry,$scope.faqSearch.faqSearchQuery=searchParam,$workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:""})),searchParam?$scope.isFromSearch=!0:$scope.isFromSearch=!1;var selFilter=$scope.intentFilter.filter(function(val){return val.state});selFilter&&selFilter[0]&&($scope.selectedFilter.val=selFilter[0].name.toLowerCase());var containerHeight=0,container=$("#faqsCollectectionBody");container&&container[0]&&container[0].scrollHeight&&(containerHeight=container[0].scrollHeight+20),$scope.callback.selectedFilter=$scope.selectedFilter,BTStreamsService.getOrSearchFAQS($applicationService.userInfo.userId,$scope.knowledgeTask._id,searchParam,offset,$scope.faqstats.limit,$scope.activeNodeId,""+$scope.withallchild,$scope.selectedFilter.val).then(function(response){if(response.data.count){$scope.totalFaqCount=response.data.count,$scope.callback.totalFaqCount=response.data.count;for(var i=0;i<$scope.ontologytreetaxonomy.length;i++)$scope.ontologytreetaxonomy[i].nodeId===$scope.activeNodeId&&($scope.ontologytreetaxonomy[i].faqCount=response.data.count)}$scope.callback.allFaqs||($scope.callback.allFaqs={}),$scope.activeNodeId!=$scope.data[0].nodeId||$scope.isFromSearch?_.forEach(response.data.faqs,function(faq){var isExist=!1;_.forEach($scope.callback.allFaqs,function(qa){faq._id===qa._id&&(isExist=!0)}),!isExist&&_.isArray($scope.callback.allFaqs)&&$scope.callback.allFaqs.push(faq)}):$scope.callback.allFaqs=response.data.faqs,$scope.moreAvailable=response.data.moreAvailable,$.each(response.data.faqs,function(i,qa){$.map(qa.answerPayload,function(answerObject){return answerObject.text=decodeJS(answerObject.text),answerObject}),qa.questionPayload&&qa.questionPayload.question&&(qa.questionPayload.question=qa.questionPayload.question||""),$.each(qa.subAnswers,function(i,answerObject){$.map(answerObject,function(subanswerObject){return subanswerObject.text=decodeJS(subanswerObject.text),subanswerObject})})}),$scope.faqPaginationFlag=!1,isFromPagination?$scope.ontology.allQAS=[].concat($scope.ontology.allQAS,response.data.faqs):($scope.ontology.allQAS=response.data.faqs,$scope.faqsLoaded=!0),$scope.totalItems=response.data.count,$scope.ontology.qas=$scope.ontology.allQAS.reverse()||[],$scope.ontology.allQAS.length?($("body").addClass("ontologymodalopen"),$scope.showBulkImport=!1,$scope.callback.parentId=$scope.data[0].nodeId):$scope.withallchild&&$scope.activeNodeId==$scope.data[0].nodeId&&($scope.showBulkImport=!0,$("body").removeClass("ontologymodalopen")),registerDragDropEvents(),isFromPagination||$("#faqsCollectectionBody").scrollTop(0),$timeout(function(){isFromPagination&&$("#faqsCollectectionBody").scrollTop(containerHeight),$scope.loadingPaginatedFAQs=!1,$timeout(function(){isFromPagination||$scope.bindScrollPagination()},200),$rootScope.$emit("pefectScrollUpdate"),faqEvents.disableDrag(),$workflowService.storeSearchQry().userSearchQueryFlag&&$workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:"",navigateTo:""}),!isFKora&&$scope.isFromKora&&koraFaq&&$scope.showOntologyQAForm()},250)},function(error){$scope.loadingPaginatedFAQs=!1,$scope.faqsLoaded=!0})},$scope.getJSCount=function(qa){var count=0,jsResponses=_.filter(qa.subAnswers,function(subans){return"uxmap"==subans.type})||[];return count=jsResponses.length,qa&&qa.answerPayload&&"uxmap"==qa.answerPayload.type&&(count+=1),count-1},$scope.removeFAQByID=function(faq){function proceed(){function failCb(){console.log("on cancel callback")}function removeFAQ(){BTStreamsService.removeFAQ($applicationService.userInfo.userId,faqID).then(function(response){$scope.getFaqsByKnowledge(),NotificationService.notify(i18n.i18nString("q&a_deleted"),"success"),_.forEach($scope.callback.allFaqs,function(qa,key){response&&response.data&&response.data._id&&qa&&qa._id&&response.data._id===qa._id&&$scope.callback.allFaqs.splice(key,1)}),$scope.closeDeleteModal(),$scope.closeDeleteFaqModal()},function(error){$("#noty_center_layout_container").empty(),NotificationService.notify(i18n.i18nString("failed_delete_q&a"),"error")})}var _msg="";faq.parent===$scope.data[0].nodeId&&faq.editLocked&&(_msg=i18n.i18nString("removeFAQByID"));var faqID=faq._id;faq.faqLinkedBy&&faq.faqLinkedBy.length?$("#deleteLinked").modal({show:!0,backdrop:"static"}):NotificationService.confirm({heading:i18n.i18nString("delete_faq"),headerClass:"confirmationHeader",bodyClass:"confirmationbody",msg:_msg||i18n.i18nString("delete_faq_desc"),successCb:removeFAQ,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("ok_label"),fail:i18n.i18nString("cancel")}}),$scope.removeFAQ=function(){removeFAQ()}}var secondLevelNode=getSecondLevelNodeOfNodeId(faq.parent);return secondLevelNode&&secondLevelNode.editLocked&&!$scope.ontology.selectedTerm.parent.length?void NotificationService.notify(i18n.i18nString("second_level_question",{label:secondLevelNode.label}),"error"):void(secondLevelNode?$scope.lockorCheckNode(secondLevelNode,proceed,!0):proceed())},$scope.closeDeleteModal=function(){$("#deleteLinked").modal("hide")},$scope.closeDeleteFaqModal=function(){$("#deleteFaqLinked").modal("hide")},$scope.setWordsscrollToBottom=function(){setTimeout(function(){$(".input").first().focus()},1e3),setTimeout(function(){$(".searchBar").off("click").on("click",function(){$scope.searchWord.search="",$(this).hasClass("btx-close")?($(".stopWordsSearch").removeClass("searchExpand"),$(this).removeClass("btx-close"),$(this).addClass("btx-search"),$scope.searchWord.search=""):($(".stopWordsSearch").addClass("searchExpand"),$(this).addClass("btx-close"),$(this).removeClass("btx-search"),$timeout(function(){$(".stopWordsSearchInput").focus()},350))});var ele=$(".stopWordsBody"),bodyHeight=ele[0].scrollHeight;ele.scrollTop(bodyHeight)},500)},$scope.manageStopWords=function(){getKgWordsManage("false"),$(".stopWordsSearch").removeClass("searchExpand"),$(".searchBar").removeClass("btx-close"),$(".searchBar").addClass("btx-search"),$scope.searchWord.search="",$(".talkToBot").addClass("hide"),$scope.openModalSlider("#manageStopWords"),$scope.setWordsscrollToBottom()},$scope.unlockTerm=function(node){function confirmUnlock(){var payload={nodeId:node.nodeId};BTStreamsService.ktNodeUnlock($scope.stream._id,$scope.knowledgeTask._id,payload).then(function(response){$scope.getKTData(),NotificationService.notify(i18n.i18nString("node_unlocked"),"success")},function(error){NotificationService.notify(i18n.i18nString("failed_node_lock"),"error")})}function cancleUnlock(){}NotificationService.userConfirm(i18n.i18nString("unlock_term"),[confirmUnlock,cancleUnlock],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("confirm_unlock_name"))};var termsMap={};$scope.validateTermName=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression();return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,{test:function(value){return _selectedLanguage&&"en"!==_selectedLanguage?regexp2.test(value):regexp.test(value)}}}();var searchTermEle=$("#termsearchid");searchTermEle.bind("keydown",function(event){event.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&event.preventDefault()}).autocomplete({minLength:3,source:function(request,response){return $scope.triggeredFromSelect?void($scope.triggeredFromSelect=!1):void response($.map($.ui.autocomplete.filter($scope.ontologytreetaxonomy,$scope.pattern),function(item){var labelPathArray=termsMap[item.nodeId]&&termsMap[item.nodeId].path.split(" > ");labelPathArray[labelPathArray.length-1]="<span class='pathleafterm'>"+labelPathArray[labelPathArray.length-1]+"</span>";var lablePathString=labelPathArray.join(" > ");return{label:lablePathString,value:termsMap[item.nodeId]&&termsMap[item.nodeId].nodeIds,indexMap:termsMap[item.nodeId]&&termsMap[item.nodeId].nodeIndexMap||"0"}}))},focus:function(event,ui){event.preventDefault()},select:function(e,ui){return isFromSelect=!0,expandAndGotoSpecificNode(ui.item.value,ui.item.indexMap),!1},position:{collision:"flip"},open:function(event,ui){if($(".ui-autocomplete:visible").css({left:"+="+5*$scope.caretPos}),window.outerWidth-210<$(".ui-autocomplete:visible").offset().left){var _leftToReposition=$(".ui-autocomplete:visible").offset().left-(window.outerWidth-210)+10;$(".ui-autocomplete:visible").css({left:"-="+_leftToReposition})}}}).autocomplete("instance")._renderItem=function(ul,item){return $("<li>").append(item.label).appendTo(ul)},searchTermEle.autocomplete("widget").addClass("ontologysearchautocomplete"),$scope.addnewGlobalSynonyms=function(keyword){$scope.placeholderMsg=i18n.i18nString("type_enter_add"),$scope.addkeyword=keyword,$(".updateTagModal").modal("hide"),$scope.manageGlobalSynonyms(null,null,"add",null,"byEdit"),$scope.manageKtSynonym.keyword=$scope.addkeyword},$(".select2-input").click(function(){$scope.placeholderMsg=i18n.i18nString("type_enter_add")}),$scope.editGlobalSynonyms=function(keyword,synonymdata){$scope.placeholderMsg=i18n.i18nString("type_enter_add"),$scope.currentEditKtSynonym=synonymdata,$(".updateTagModal").modal("hide");$scope.manageGlobalSynonyms(keyword,null,"edit",null,"byEdit")},$scope.clearSetUpLocalStorageFortask=function(setTaskId){var localPath=window.localStorage.getItem("previousState");localPath&&(localPath=JSON.parse(localPath),localPath.selectedTaskType&&!setTaskId&&delete localPath.selectedTaskType,localPath.selectedTaskId&&!setTaskId&&delete localPath.selectedTaskId,setTaskId&&(localPath.selectedTaskId=setTaskId),window.localStorage.setItem("previousState",JSON.stringify(localPath)))},$scope.closeOntologyModalByClass=function(){if($rootScope.$emit("updateSummaryData"),$scope.resourceCopy&&$scope.resourceCopy.nodeId){var resourceID=$scope.knowledgeTask._id+"@"+$scope.resourceCopy.nodeId;$scope.releaseLock(resourceID,!0)}$scope.clearSetUpLocalStorageFortask(),$scope.callback.closeModalOnto(".ontology-form")},$scope.callFaqsForNode=function(isFKora){isFKora?$scope.getFaqsByKnowledge("",$scope.activeNodeId,"",!0):$scope.getFaqsByKnowledge("",$scope.activeNodeId)},$scope.initiateOntologyAnalysis=function(){var _selectedLanguage=$workflowService.currentLanguage(),_payload={knowledgeTaskId:$scope.knowledgeTask._id,language:_selectedLanguage};BTStreamsService.initiateOntologyAnalysis(_payload).then(function(response){"inprogress"===response.data.status&&NotificationService.notify(i18n.i18nString("ontology_progress"),"success"),$rootScope.$broadcast("getProgressDockStatus"),$scope.$broadcast("startTimer")})},$scope.openAnalysisReport=function(){$timeout(function(){$scope.openModalSlider("#analysis-report"),$("body").addClass("analyzeReport")},500)};var duration=500;$scope.openPathInfo=function($event,pathInfo){$scope.openPath=!0,$scope.pathDetails=pathInfo,angular.element(".tableContainer .panel-table-body").removeClass("active"),$event.currentTarget.className+=" active",setTimeout(function(){$(".pathModal").animate({scrollTop:0})},0)},$scope.closePathInfo=function(){$timeout(function(){$scope.openPath=!1})},$scope.closeReport=function(){$scope.closeModalSlider("#analysis-report"),$("body").removeClass("analyzeReport"),$scope.openPath=!1,"IN_PROGRESS"===$workflowService.ontologyJobStatus().status||"QUEUED"===$workflowService.ontologyJobStatus().status||"PROCESSING"===$workflowService.ontologyJobStatus().status?$scope.inspectStatus="inprogress":$scope.inspectStatus="initial"},$scope.inspectKg=function(){return"indevelopment"!==$scope.botDetails.streamState||0!==$scope.data.length&&0!==$scope.ontology.allQAS.length?($scope.disableInspect=!0,void($scope.knowledgeTask.ontologyReport?callAnalysisReport($scope.currentDockId,$scope.reRunStatus):botOntologyService.getOntologyReport($applicationService.userInfo().userId,$workflowService.selectedStream()._id,$scope.knowledgeTask._id,_selectedLanguage).then(function(response){response&&response.data&&("success"===response.data.status.toLowerCase()?(NotificationService.notify(i18n.i18nString("kg_inspection"),"success"),$scope.disableInspect=!0,$scope.inspectStatus="inprogress",$scope.openAnalysisReport(),$rootScope.$broadcast("getProgressDockStatus"),$scope.callback.startTimer()):"failure"===response.data.status.toLowerCase()&&(NotificationService.notify(i18n.i18nString("kg_inspection_failed"),"error"),$scope.disableInspect=!1))},function(err){err.data&&err.data.errors&&403===err.status?(NotificationService.notify(i18n.i18nString("request_exists"),"error"),$scope.disableInspect=!1):($scope.disableInspect=!1,NotificationService.notify(i18n.i18nString("some_error"),"error"))}))):void NotificationService.notify(i18n.i18nString("no_kg_faq"),"error")},$scope.ViewReport=function(){callAnalysisReport($scope.currentDockId)},$scope.reRun=function(){$scope.disabledRerun=!0,$scope.reRunStatus="inprogress",botOntologyService.getOntologyReport($applicationService.userInfo().userId,$workflowService.selectedStream()._id,$scope.knowledgeTask._id,_selectedLanguage).then(function(response){response&&response.data&&("success"===response.data.status.toLowerCase()?(NotificationService.notify(i18n.i18nString("kg_inspection"),"success"),$scope.reRunStatus="inprogress",$rootScope.$broadcast("getProgressDockStatus"),$scope.callback.startTimer()):"failure"===response.data.status.toLowerCase()&&(NotificationService.notify(i18n.i18nString("kg_inspection_failed"),"error"),$scope.disabledRerun=!1))},function(err){$scope.disabledRerun=!1,$scope.reRunStatus="initial",err.data&&err.data.errors&&403===err.status&&NotificationService.notify(i18n.i18nString("request_exists"),"error")})},$scope.callback.callAnalysisReport=function(dockId,status){var _dockId;_dockId=$workflowService.setCurrentDockId()?$workflowService.setCurrentDockId():dockId,callAnalysisReport(_dockId,status)},$scope.exportOntologyReport=function(){$scope.disableExport=!0,botOntologyService.exportOntologyReport($applicationService.userInfo().userId,$workflowService.selectedStream()._id,$scope.knowledgeTask._id,_selectedLanguage).then(function(response){response&&response.data&&("IN_PROGRESS"===response.data.status&&NotificationService.notify(i18n.i18nString("kg_inspect_export"),"success"),$rootScope.$broadcast("getProgressDockStatus"),$scope.callback.startTimer(),$scope.disableExport=!1)},function(err){$scope.disableExport=!1,err.data&&409==err.data.errors[0].code&&NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.sortBy=function(type){$scope.propertyType=type,$scope.reverse=!$scope.reverse},$scope.showKgSynonymModal=function(){$element.find("#warningKgSynonymModal").removeClass("fade").addClass("show")},$scope.closeKgSynonymModal=function(){$element.find("#warningKgSynonymModal").removeClass("show").addClass("fade")},$scope.proceedKgSynonyms=function(){var _trainOntology;_obj.confidenceConfig[1].useBotSynonyms=$scope.botSynonym.toggleValue,_trainOntology=$scope.botSynonym.toggleValue,$element.find("#warningKgSynonymModal").removeClass("show").addClass("fade"),updateChangeLogs(_obj,_trainOntology)},$scope.openAutoGenerateModal=function(){$("#auto-generate").modal("show")},$scope.closeAutoGenerate=function(){$("#auto-generate").modal("hide")},$scope.cb={showOntologyQAForm:$scope.showOntologyQAForm,hideOntologyQAForm:$scope.hideOntologyQAForm,showBotOntologyTermSettings:$scope.showBotOntologyTermSettings,hideBotOntologyTermSettings:$scope.hideBotOntologyTermSettings,updateOntology:$scope.updateOntology,ontologyClassModal:$scope.ontologyClassModal,updateFaqCollection:$scope.updateFaqCollection,getFaqsByKnowledge:$scope.getFaqsByKnowledge,getKTData:$scope.getKTData,exportOntology:$scope.exportOntology,getAndUpdateOntology:$scope.getAndUpdateOntology,cudOntologyNode:$scope.cudOntologyNode,isEditable:$scope.isEditable,prevResourceId:prevResourceId,isTermLocked:$scope.isTermLocked,addnewGlobalSynonym:$scope.addnewGlobalSynonyms,editGlobalSynonyms:$scope.editGlobalSynonyms,callFaqsForNode:$scope.callFaqsForNode,openManageTraits:$scope.openManageTraits,isFromKora:$scope.isFromKora,koraFaq:koraFaq},$scope.getTraitsGroupsApi=function(){return"NO"===$scope.nlPermision?void($scope.cb.allTraits=[]):void BTStreamsService.getTraitGroups($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$scope.traitGroups=$workflowService.cloneData(res.data),$scope.cb.allTraits=[];var alltraitsArr=[];$.each($scope.traitGroups,function(i,traits){$.each(traits.traits,function(j,trait){({groupId:traits._id,traitId:trait.traitId||j,traitName:trait.traitName});alltraitsArr.push(trait.traitName)})}),$scope.cb.allTraits=_.uniq(alltraitsArr),$scope.cb.updateTraits&&$scope.cb.updateTraits($scope.cb.allTraits)},function(err){$scope.loadingTraits=!1,NotificationService.notify(i18n.i18nString("failed_traits"),"error")})},$scope.getBotVariables=function(){BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,$scope.stream._id).then(function(res){$workflowService.botEnvVariables(res.data.variables)})},$scope.getBotVariables(),"NO"!==accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE")&&$scope.getTraitsGroupsApi(),setTimeout(function(){$scope.dialogTasks=$workflowService.dialogTasks()},1e3),$scope.$emit("nestedComponentLoaded",{id:"ontologyForm",flag:!1})}]),_botOntologyForm.filter("shortenEllipsisString",function(){return function(input){return input?(input=input.trim().replace(/\n/g,"<br>"),input.length>110?input.slice(0,110)+"...":input):void 0}}),_botOntologyForm.filter("nodeTT",function(){return function(input,node,scope){if(input)try{return _.where(scope.ontologytreetaxonomy,{nodeId:node.parent[0]})[0].label&&(input=input.replace("[]","["+_.where(scope.ontologytreetaxonomy,{nodeId:node.parent[0]})[0].label+"]")),input}catch(e){return input}}}),_botOntologyForm.filter("nextLineFilter",function(){return function(input){return input?input.trim().replace(/\n/g,"<br>"):void 0}})}(angular),function(ng){var _module=angular.module("bt-forms");_module.controller("taskGeneralInfoCtrl",["$scope","$rootScope","parms","$workflowService","form_util","BTAlertsService","BTActionsService","$modalInstance","NotificationService","BTStreamsService","$applicationService","i18n",function($scope,$rootScope,parms,$workflowService,form_util,BTAlertsService,BTActionsService,$modalInstance,NotificationService,BTStreamsService,$applicationService,i18n){function createBTAlert(){$scope.saveInProgress||(_alert={name:$scope.introObj.name,label:$scope.introObj.name,shortDesc:$scope.introObj.shortdescription,ignoreWords:$scope.introObj.ignoreWords,longDesc:$scope.introObj.longdescription,welcomeMsg:$scope.introObj.welcomemsg,type:$scope.introObj.type.value,streamId:_selectedStream._id,sourceStream:_selectedStream.name,needsTopic:!1,subtype:$scope.introObj.subtype||"rest",hasActions:$scope.introObj.hasActions,helpLink:$scope.introObj.helpLink,demoYoutubeLink:$scope.introObj.demoYoutubeLink,offKoraConfirmation:$scope.introObj.offKoraConfirmation,isAuthRequiredForWsdl:$scope.introObj.isAuthRequiredForWsdl},$scope.saveInProgress=!0,$scope.isWorkProgress=!0,BTAlertsService.createBTAlert(_alert).then(function(res){$scope.alertid=res.data._id,$workflowService.alertInfo(res.data),createMPAlert(_alert,!0)},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.saveAndExit=!1,$scope.alertid=null,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_alert"),"error")}))}function createMPAlert(mpalert,create){var mpAlertObj;mpAlertObj=$workflowService.alertInfo(),mpalert._id=$scope.alertid,mpalert.namespace="private",mpalert.namespaceIds=[],mpalert.userAlertMsg=$scope.introObj.userAlertMsg,mpalert.teamAlertMsg=$scope.introObj.teamAlertMsg,mpalert.keywords=[],mpalert.contents=$scope.introObj.contents,$workflowService.alertData(mpalert),BTAlertsService.createMPAlert(mpalert).then(function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$workflowService.mpAlertInfo(res.data),$rootScope.$emit("onedittask",$workflowService.alertInfo(),$scope.wfType),$scope.closeGeneralInfoModal(),$rootScope.$emit("insertOrUpdateTask","alert",$workflowService.alertInfo(),!0)},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,$scope.isWorkProgress=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_alert"),"error"),BTAlertsService.deleteBTAlert($scope.alertid),$scope.alertid=null})}function createBTAction(){var _actionIntro={name:$scope.introObj.name,ignoreWords:$scope.introObj.ignoreWords,shortDesc:$scope.introObj.shortdescription,longDesc:$scope.introObj.longdescription,welcomeMsg:$scope.introObj.welcomemsg,type:$scope.introObj.type.value,subtype:$scope.introObj.subtype||"rest",streamId:_selectedStream._id,targetStream:_selectedStream.name,helpLink:$scope.introObj.helpLink,isReport:$scope.isReport,demoYoutubeLink:$scope.introObj.demoYoutubeLink,offKoraConfirmation:$scope.introObj.offKoraConfirmation,isAuthRequiredForWsdl:$scope.introObj.isAuthRequiredForWsdl};$scope.saveInProgress||($scope.saveInProgress=!0,$scope.isWorkProgress=!0,BTActionsService.createBTAction(_actionIntro).then(function(res){$workflowService.actionInfo(res.data),$scope.actionid=res.data._id,createMPAction(_actionIntro,!0)},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.saveAndExit=!1,$scope.actionid=null,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_action"),"error")}))}function createMPAction(_action,create){_action.targetStream=_selectedStream.name,_action.contents=$scope.introObj.contents,_action.mappedOnly=$scope.introObj.mappedOnly,"string"==typeof $scope.introObj.keywords?_action.keywords=$scope.introObj.keywords.split(","):"object"==typeof $scope.introObj.keywords&&$scope.introObj.keywords.length>0?_action.keywords=$scope.introObj.keywords:_action.keywords=[],_action.namespace="private",_action.namespaceIds=[],_action._id=$scope.actionid,BTActionsService.createMPAction(_action).then(function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$workflowService.mpActionInfo(res.data),$rootScope.$emit("onedittask",$workflowService.actionInfo(),$scope.wfType),$scope.closeGeneralInfoModal(),$rootScope.$emit("insertOrUpdateTask","action",$workflowService.actionInfo(),!0)},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.saveAndExit=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_action"),"error"),BTActionsService.deleteBTAction($scope.actionid),$scope.actionid=null})}function createKnowledgeTask(ktData){$scope.saveInProgress||($scope.saveInProgress=!0,ktData.streamId=$workflowService.selectedStream()._id,BTStreamsService.createKnowledgeTask($applicationService.userInfo().userId,ktData).then(function(response){$scope.saveInProgress=!1,$scope.closeModal(),NotificationService.notify(i18n.i18nString("kg_saved"),"success"),response.data.taskType="knowledgeTask",$workflowService.taskEditInfo(response.data),$workflowService.taskMode("edit"),$rootScope.$broadcast("updateEditTask",!0)},function(res){$scope.saveInProgress=!1,409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("kg_duplicate")&&($scope.duplicateKTName=!0),NotificationService.notify(res.data.errors[0].msg,"error")}))}$scope.wfType=parms.taskType,$scope.isReport=parms.isReport,$scope.introObj={},$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$scope.info=i18n.i18nString("create_info"),$scope.action=i18n.i18nString("create_action"),$scope.alert=i18n.i18nString("create_alert"),$scope.charRemaining=i18n.i18nString("Generalform_charlimit"),$scope.infoRequired=i18n.i18nString("info_required"),$scope.actionRequired=i18n.i18nString("action_required"),$scope.alertRequired=i18n.i18nString("alert_required"),$scope.infoAllows=i18n.i18nString("info_allows"),$scope.actionAllows=i18n.i18nString("action_allows"),$scope.alertAllows=i18n.i18nString("alert_allows"),$scope.infoNObot=i18n.i18nString("info_Nobot"),$scope.actionNObot=i18n.i18nString("action_Nobot"),$scope.alertNObot=i18n.i18nString("alert_Nobot"),$scope.infoName=i18n.i18nString("info_Name"),$scope.actionName=i18n.i18nString("action_Name"),$scope.alertName=i18n.i18nString("alert_Name"),$scope.displayinfoName=i18n.i18nString("info_DisplayName"),$scope.displayactionName=i18n.i18nString("action_DisplayName"),$scope.displayalertName=i18n.i18nString("alert_DisplayName"),$scope.connInfoName=i18n.i18nString("info_connName"),$scope.connActionName=i18n.i18nString("action_connName"),$scope.connAlertName=i18n.i18nString("alert_connName"),$scope.subtypeInfoName=i18n.i18nString("info_subtype"),$scope.subtypeActionName=i18n.i18nString("action_subtype"),$scope.subtypeAlertName=i18n.i18nString("alert_subtype"),$scope.infoContext=i18n.i18nString("info_context"),$scope.actionContext=i18n.i18nString("action_context"),$scope.alertContext=i18n.i18nString("alert_context"),$scope.infoDesc=i18n.i18nString("info_Desc"),$scope.actionDesc=i18n.i18nString("action_Desc"),$scope.alertDesc=i18n.i18nString("alert_Desc"),$scope.infoLong=i18n.i18nString("info_Long"),$scope.actionLong=i18n.i18nString("action_Long"),$scope.alertLong=i18n.i18nString("alert_Long");var _selectedStream=null;if($scope.closeModal=function(){$scope.closeGeneralInfoModal(),$("#taskCreateOverlayModal").show(),$(".taskTypeDiv ").removeClass("selected"),$modalInstance.close()},$scope.$watch("saveInProgress",function(newValue,oldValue,scope){$rootScope.$emit("showOrHideStatusLoader",newValue)}),"alert"===$scope.wfType){$scope.alerttypes=$workflowService.seedData().alertTypes||[];for(var i=0;i<$scope.alerttypes.length;i++)if("email"===$scope.alerttypes[i].value){$scope.alerttypes.splice(i,1);break}}else"action"===$scope.wfType?($scope.alerttypes=[{name:"Web Service",value:"webservice"}],$scope.introObj.type=$scope.alerttypes[0]):"flowTask"===$scope.wfType&&($scope.alerttypes=[{name:"Flow Task",value:"flowtask"}],$scope.introObj.type="flowTask");$scope.subtypes=$workflowService.seedData().webserviceTypes,$scope.saveIntro=function(isValid,form){return isValid?(_selectedStream=$workflowService.selectedStream(),$scope.introObj.needsAuth="webservice"===$scope.introObj.type.value?!0:$scope.introObj.needsAuth,void("alert"===$scope.wfType?createBTAlert():"action"===$scope.wfType?createBTAction():"flowTask"===$scope.wfType&&createFlowTask())):void form_util.touch(form)},$scope.closeGeneralInfoModal=function(){$(".task-generalinfo-modal").modal("hide"),$modalInstance.close()},$scope.invalidWordCount=!1,$scope.taskgen={},$scope.checkTaskWordCount=function(){return $scope.introObj.name?void($scope.introObj.name.split(" ").length<2||$scope.introObj.name.split(" ").length>5?($scope.invalidWordCount=!0,$scope.taskgen.taskGeneralInfoForm.name.$valid=!1):($scope.invalidWordCount=!1,$scope.taskgen.taskGeneralInfoForm.name.$valid=$scope.taskgen.taskGeneralInfoForm.name.$valid||!0)):void($scope.invalidWordCount=!1)},$scope.saveKnowledgeTask=function(isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return form_util.touch(form),void($scope.isFromModalOpen=!1);var btPostData={};btPostData.name=$scope.knowledgeData.name,btPostData.description=$scope.knowledgeData.description,createKnowledgeTask(btPostData)},$scope.kt={},$scope.knowledgeData={},$scope.isFormValid=function(isSaveKnoledgeTask){return isSaveKnoledgeTask?$scope.kt.streamktform&&$scope.kt.streamktform.name.$valid&&$scope.kt.streamktform.description.$valid:void 0},$scope.botNameMatched=!1,$scope.validateTaskName=function(){var regexp=/^[a-zA-Z0-9][a-zA-Z0-9_<>*. ]+$/,regexp2=/^[a-zA-Z0-9]/;return{test:function(value){var regexBotname=new RegExp($workflowService.selectedStream().name,"i");return(value.match(regexBotname)||[]).length?($scope.botNameMatched=!0,!1):($scope.botNameMatched=!1,value&&1===value.length?regexp2.test(value):regexp.test(value))}}}()}])}(angular),function(ng){"use strict";var _module=ng.module("bt-streams");_module.directive("botTestResult",[function(){return{restrict:"EA",scope:{nlp:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-test-result/bot-test-result.html",controller:["$scope","$workflowService","$location","$routeParams","BTStreamsService","$q","BTAlertsService","BTActionsService","$timeout","color","$filter","_constants_","NotificationService","$modal","i18n",function($scope,$workflowService,$location,$routeParams,BTStreamsService,$q,BTAlertsService,BTActionsService,$timeout,color,$filter,_constants_,NotificationService,$modal,i18n){function arrangeData(data){var entities=[];return data=angular.copy(data),data.Entities&&data.Entities.map(function(entity){if(entity.field){var obj={};obj.name=entity.field,obj.type=entity.metadata,obj.value=entity.value,obj.taskType=entity.taskType,entities.push(obj)}}),data.Entities=entities,data}function goBack(){$location.path(window.appConfig.CONTEXT_PATH)}function loadingEntities(id){$scope.tasks=$scope.tasks.concat($workflowService.alertTasks()),$scope.tasks=$scope.tasks.concat($workflowService.actionTasks()),$scope.tasks=$scope.tasks.map(function(task){return _.isArray(task.alertFieldsDefinition)?task.fields=_.clone(task.alertFieldsDefinition||[]):_.isArray(task.payloadField)&&_.isArray(task.queryField)&&(task.fields=(task.payloadField||[]).concat(task.queryField)),task})}function getErrorMsg(err,defaultMsg){return err=err&&err.data,err&&err.errors&&err.errors[0]&&err.errors[0].msg||defaultMsg}var streamId=$routeParams.botId;return $scope.verifying=!1,$scope.pattern={},$scope.synonym={},$scope.addmeta={},$scope.constants=_constants_,$scope.stream=$workflowService.selectedStream(),$scope.tasks=[],$scope.nlp=$scope.nlp||{text:""},$scope.context={api:{}},!_.isObject($scope.stream)||_.isObject($scope.stream)&&0===Object.keys($scope.stream).length?void goBack():($scope.showTrainBot=function(log){$scope.$emit("openFullPageModal","trainBot"),$workflowService.nlpTrainInput({log:{input:[$scope.nlp.text]}})},$scope.editEntityType=function(task,field){$scope.addmeta={task:task,field:field},$scope.openEntity()},$scope.cancelEntity=function(){$timeout(function(){$(".add-meta").modal("hide")})},$scope.saveEntity=function(){var payload,task=$scope.tasks.filter(function(task){return task.name==$scope.addmeta.task})[0],id=task._id;task.alertFieldsDefinition?(task.alertFieldsDefinition.map(function(field){field.title===$scope.addmeta.field&&(field.metadata=$scope.addmeta.metadata)}),payload={alertFieldsDefinition:task.alertFieldsDefinition,allowEdit:!0},BTAlertsService.createBTAlertUp(id,payload).then(function(res){$scope.cancelEntity(),NotificationService.notify(i18n.i18nString("entity_type_added_sucess_noty"),"success")},function(err){var msg=getErrorMsg(err,i18n.i18nString("synonyms_adding_failed"));
NotificationService.notify(msg,"error")})):(task.payloadField.map(function(field){field.title===$scope.addmeta.field&&(field.metadata=$scope.addmeta.metadata)}),task.queryField.map(function(field){field.title===$scope.addmeta.field&&(field.metadata=$scope.addmeta.metadata)}),payload={payloadField:task.payloadField,queryField:task.queryField,allowEdit:!0},BTActionsService.updateBTAction(id,payload).then(function(res){$scope.cancelEntity(),NotificationService.notify(i18n.i18nString("entity_type_added_sucess_noty"),"success")},function(err){var msg=getErrorMsg(err,i18n.i18nString("synonyms_adding_failed"));NotificationService.notify(msg,"error")}))},$scope.openEntity=function(){$timeout(function(){$(".add-meta").modal("show")})},$scope.eventHandlers={onKeyDown:function(event){13==event.keyCode&&"keydown"==event.type&&$scope.nlp.text&&$timeout($scope.verify)}},$scope.verify=function(){$scope.testing=!0,$scope.nlp.text=$scope.nlp.text||$workflowService.nlpText(),$scope.nlp.text=($scope.nlp.text||"").replace(/&lt;/g,"<").replace(/&gt;/g,">"),$scope.verifying=!1;var payload={input:$scope.nlp.text,streamName:$scope.stream.name};BTStreamsService.testNlp($scope.stream._id,payload).then(function(res){var data=JSON.stringify(res.data);data=data.replace(/emptystring/g,""),data=JSON.parse(data),$scope.intent=arrangeData(data),$scope.intent.nlptext=$scope.nlp.text,$scope.intent.pattern=i18n.i18nString("intent_identified_based_on_pattern_match"),$scope.verifying=!0,($scope.intent.Entities||[]).map(function(entity,i){entity.color=$scope.constants.entityColors[i%12+""]}),$scope.testing=!1},function(err){var msg=getErrorMsg(err,i18n.i18nString("nlp_verification_failed"));NotificationService.notify(msg,"error"),$scope.verifying=!1,$scope.intent={},$scope.testing=!1})},$scope.clear=function(){$scope.nlp={text:""},$scope.intent={},$scope.verifying=!1,$scope.testing=!1},$scope.goBack=goBack,void function(id){loadingEntities(id)}(streamId))}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btWelcomeMessage",function(){return{restrict:"EAQ",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-welcomeMessages/bot-welcomeMessages.html",controller:["$scope","$element","$rootScope","$workflowService","channelsConfig","env_conf","BTFlowtaskService","NotificationService","BTStreamsService","i18n",function($scope,$element,$rootScope,$workflowService,channelsConfig,env_conf,BTFlowtaskService,NotificationService,BTStreamsService,i18n){function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function encodeJS(_obj){try{return encodeURIComponent(_obj)}catch(e){return _obj}}function isMarkUp(markup){return markup.jsCode&&""!==markup.jsCode.trim()?!1:!0}$scope.stream=$workflowService.selectedStream(),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope._constants_=$rootScope._constants_,$scope.standardPrompts=[],$scope.channelPrompts=[],$scope.loadEditor=!1,$scope.currEditPromptIndex=-1,$scope.assetsBase=env_conf["assets-url"],$scope.selectedState=$workflowService.selectedStreamState(),$scope.rightArrow=$scope.assetsBase+"ivrIcons/rightArrow.svg";var isWFacebook=!1,wfacebookIndex=0;$scope.editMode=!1,$scope.currentEditMessageIndex=0,$scope.displayMode=$scope.displayMode||"edit",channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channels=Object.values(channelsConfig.channelsObject),$scope._channelConfig=channelsConfig,$scope.savingInProgress=!1,$scope.demoTemplates=[],$scope.isChannelSpecific=!1,$scope.isLoader=!0,$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.addResponse=i18n.i18nString("add_response_label"),$scope.editResponse=i18n.i18nString("edit_modal"),$scope.channels=$scope.channels.map(function(channel,i){return channel.used=!1,"wfacebook"===channel.id&&(isWFacebook=!0,wfacebookIndex=i),channel}),isWFacebook&&$scope.channels.splice(wfacebookIndex,1),$scope.channels=_.filter($scope.channels,{enable:!0}),$scope.currentTabIndexOfPage1=0,$scope.currentTabIndexOfPage2=-1,$scope.editMessageIndex=0,$scope.editingMessage={},$scope.type=$scope.isPrompt?"Prompt":"message",$scope._constants_=$rootScope._constants_,$scope.contextCondition=[{key:"",value:""}],$scope.editors={},$scope.jsEditorCbs={},$scope.markdownCbs={},$scope.jsEditorCbs.displayMode=$scope.displayMode,$scope.markdownCbs.displayMode=$scope.displayMode,$scope.contexts=[],$scope.contextsData=[],$scope.textAdd=!1,$scope.markdownCbs.switchEditor=function(type){"javaScriptEditor"===type?$scope.alterTabsOfPage2(1):"promptsPreview"===type&&$scope.alterTabsOfPage2(2)},$scope.markdownCbs.onFocus=function(){$scope.showProtip=!0},$scope.markdownCbs.onBlur=function(){$scope.showProtip=!1},$scope.markdownCbs.isFromUserPrompt=!0,$scope.jsEditorCbs.onFocus=function(){$scope.showProtip=!0},$scope.jsEditorCbs.onBlur=function(){$scope.showProtip=!1},$scope.welcomeMessCallback={},$scope.selectedChannel={},$scope.selectedChannel.channel="default",$scope.alterTabsOfPage2=function(tabIndex){$scope.loadEditor=!0,$scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim()&&0===tabIndex?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_js_notify")):$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()&&1===tabIndex?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_markup_notify")):$scope.currentTabIndexOfPage2=tabIndex,2===tabIndex&&($scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim().length>0||$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim().length>0?$scope.disablePreviewBtn=!1:$scope.disablePreviewBtn=!0,$scope.preview="")},$scope.closeModal=function(){$(".welcomeMessageModal").modal("hide"),!$scope.cb||"channelIvr"!==$scope.cb.isFrom&&"twilioVoicePP"!=$scope.cb.isFrom&&"audiocodes"!==$scope.cb.isFrom&&"propPanelAudiocodes"!==$scope.cb.isFrom||$scope.cb.closeAddResponseModal(),!$scope.cb||"events"!==$scope.cb.isFrom&&"dialogs"!==$scope.cb.isFrom||($scope.cb.openEventSliderCb(),$scope.cb.isAddResponseEnabled=!1,$scope.cb.changeToShowMessage()),$scope.cb&&"dialogs"===$scope.cb.isFrom&&$scope.cb.scrollDownDialog(),$scope.currentTabIndexOfPage2=-1},$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.clearJsEditor=function(){$scope.editingMessage.jsCode="",$scope.welcomeMessCallback.resetTemplate&&$scope.welcomeMessCallback.resetTemplate()},$scope.getJsSamples(),$scope.getPreviewData=function(){var _context={},_isValidContext=!0;if($scope.contextCondition.length>0&&$.each($scope.contextCondition,function(k,context){var _contextKey=context.key?context.key.trim():"";if(""!==_contextKey){if(0!==_contextKey.toLowerCase().indexOf("context."))return _isValidContext=!1,!1;var _tempObj={};_contextKey=_contextKey.substr(8),_contextKey.split(".").reverse().forEach(function(_parsedKey){var _t={};_t[_parsedKey]=Object.keys(_tempObj).length?_tempObj:context.value.trim(),_tempObj=_t}),angular.merge(_context,_tempObj)}}),!_isValidContext)return void NotificationService.notify(i18n.i18nString("bot_welcomeMessage_keys_should_be_prefixed_notify"),"warning");$scope.previewIsOn=!0;var markup=isMarkUp($scope.editingMessage),payload={message:$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()?$scope.editingMessage.markUp:$scope.editingMessage.jsCode,type:markup?"basic":"uxmap",context:JSON.stringify(_context)};$scope.isError=!1,$scope.preview="",BTFlowtaskService.messagePreviewFlowtask($workflowService.selectedStream()._id,"taskId","nodeId",payload).then(function(res){var _ele=document.createElement("div");_ele.innerHTML=res.data&&(res.data.resolvedPayload||res.data.resolvedData);var lnkEle=$(_ele).find("a");lnkEle.length>0&&$.each(lnkEle,function(k,ele){$(ele).attr("target","_blank")}),$scope.preview=_ele.innerHTML,$scope.previewIsOn=!1},function(err){var error=err.data&&err.data.errors&&err.data.errors[0].msg||err.data;try{error=JSON.parse(error),error.errors&&error.errors[0].msg&&($scope.preview=error.errors[0].msg)}catch(e){$scope.preview=error}$scope.previewIsOn=!1,$scope.isError=!0})},$scope.openPreviewWithSample=function(){$scope.previewIsOn=!1,$scope.preview=$scope.editingMessage.markUp?$scope.editingMessage.markUp:$scope.editingMessage.jsCode},$scope.cb.openResponseSliderIvr=function(){$scope.currentTabIndexOfPage2=0,$scope.textAdd=!0},$scope.cb.loadMessage=function(responses,index,isChannelSpec,channelId){$scope.currentResponses=responses,$scope.isChannelSpecific=isChannelSpec,$scope.currentResponses.forEach(function(message){message.text=decodeJS(message.text)});var channelName="";if(!$scope.cb||"events"!==$scope.cb.isFrom&&"dialogs"!==$scope.cb.isFrom||($scope.textAdd=!0),index>=0)$scope.currentEditMessageIndex=index,$scope.editMode=!0,$scope.currMsg=responses[index],"basic"===$scope.currMsg.type?($scope.editingMessage={},$scope.editingMessage.markUp=$scope.currMsg.text,$scope.currentTabIndexOfPage2=0):($scope.currentTabIndexOfPage2=1,$scope.editingMessage={},$scope.editingMessage.jsCode=$scope.currMsg.text,setTimeout(function(){$scope.markdownCbs.switchEditor("javaScriptEditor")})),$scope.selectedChannel={},"wfacebook"===$scope.currMsg.channel&&$scope.currMsg.isMention?$scope.currMsg.channel="wfacebookG":"wfacebook"!==$scope.currMsg.channel||$scope.currMsg.isMention||($scope.currMsg.channel="wfacebookC"),$scope.selectedChannel.channel=$scope.currMsg.channel;else{if($scope.editMode=!1,$scope.currentTabIndexOfPage2=0,$scope.selectedChannel={},isChannelSpec){for(var i=0;i<$scope.channels.length;i++)$scope.channels[i].id===channelId&&(channelName=$scope.channels[i].id);$scope.selectedChannel.channel=channelName}else $scope.selectedChannel.channel="default";$scope.editingMessage={},$scope.editingMessage.markUp=""}setTimeout(function(){$scope.markdownCbs.focusEditor(),$(".welcomeMessageModal .ace_content").trigger("click")},1e3),setTimeout(function(){$(".welcomeMessageModal .ace_content").trigger("click")},1e3)},setTimeout(function(){$scope.isLoader=!1},500),$scope.disableSaveBtn=function(){return"edit"!==$scope.displayMode?!0:$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()||$scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim()?!1:!0},$scope.cb.deleteMessage=function(responses,index){if(!$scope.savingInProgress&&($scope.savingInProgress=!0,$scope.currentResponses=responses,index>=0)){$scope.welcomeMessageCopy=angular.copy($scope.currentResponses),$scope.welcomeMessageCopy.splice(index,1),$scope.welcomeMessageCopy.forEach(function(message){message.text=encodeJS(message.text)});var payload={welcomeMessage:$scope.welcomeMessageCopy};BTStreamsService.updateWelcomeMessages($scope.stream._id,payload).then(function(res){$scope.savingInProgress=!1,res&&res.data&&(NotificationService.notify(i18n.i18nString("message_deleted_success_notify"),"success"),$scope.welcomeMessageCopy.forEach(function(msg,index){msg._id=res.data.welcomeMessage[index]}),$scope.currentResponses=angular.copy($scope.welcomeMessageCopy),res.data.welcomeMessage=$scope.currentResponses,$scope.cb.updateWelcomeMessages($scope.currentResponses),$workflowService.selectedStream(res.data),$scope.currentResponses.forEach(function(message){message.text=decodeJS(message.text)}))},function(err){$scope.savingInProgress=!1;var errMsg=err.data.errors&&err.data.errors[0]&&err.data.errors[0]&&err.data.errors[0].msg||"Failed to delete welcome message";NotificationService.notify(errMsg,"error")})}},$scope.saveMessage=function(){var markup=isMarkUp($scope.editingMessage),msg={};if($scope.cb&&$scope.cb.hasOwnProperty("isAPICall")&&$scope.cb.isAPICall){if($scope.savingInProgress)return;$scope.savingInProgress=!0,msg={text:$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()?$scope.editingMessage.markUp:$scope.editingMessage.jsCode,type:markup?"basic":"uxmap",channel:$scope.selectedChannel.channel,_id:""},"Workplace For Groups"===msg.channel||"wfacebookG"===msg.channel?(msg.channel="wfacebook",msg.isMention=!0):("Workplace For Chat"===msg.channel||"wfacebookC"===msg.channel)&&(msg.channel="wfacebook",msg.isMention=!1),$scope.welcomeMessageCopy=angular.copy($scope.currentResponses),$scope.editMode?(msg._id=$scope.welcomeMessageCopy[$scope.currentEditMessageIndex]._id,$scope.welcomeMessageCopy[$scope.currentEditMessageIndex]=msg):$scope.welcomeMessageCopy.push(msg),$scope.welcomeMessageCopy.forEach(function(message){message.text=encodeJS(message.text)});var payload={welcomeMessage:$scope.welcomeMessageCopy};BTStreamsService.updateWelcomeMessages($scope.stream._id,payload).then(function(res){$scope.savingInProgress=!1,res&&res.data&&($scope.editMode?NotificationService.notify(i18n.i18nString("message_updated_success_notify"),"success"):(NotificationService.notify(i18n.i18nString("message_created_success_notify"),"success"),$scope.closeModal()),$scope.welcomeMessageCopy.forEach(function(msg,index){msg._id=res.data.welcomeMessage[index]}),$scope.currentResponses=angular.copy($scope.welcomeMessageCopy),res.data.welcomeMessage=$scope.currentResponses,$scope.cb.updateWelcomeMessages($scope.currentResponses),$workflowService.selectedStream(res.data),$scope.currentResponses.forEach(function(message){message.text=decodeJS(message.text)}))},function(err){$scope.savingInProgress=!1;var errMsg=err.data.errors&&err.data.errors[0]&&err.data.errors[0]&&err.data.errors[0].msg||"Failed to save welcome message";NotificationService.notify(errMsg,"error")})}else msg={text:$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()?$scope.editingMessage.markUp:$scope.editingMessage.jsCode,type:markup?"basic":"uxmap",channel:$scope.selectedChannel.channel,_id:""},msg.text=encodeJS(msg.text),"Workplace For Groups"===msg.channel||"wfacebookG"===msg.channel?(msg.channel="wfacebook",msg.isMention=!0):("Workplace For Chat"===msg.channel||"wfacebookC"===msg.channel)&&(msg.channel="wfacebook",msg.isMention=!1),$scope.currentResponses.forEach(function(message){message.text=encodeJS(message.text)}),$scope.welcomeMessageCopy=angular.copy($scope.currentResponses),$scope.cb.isAddResponseEnabled=!1,$scope.editMode&&""!==$scope.welcomeMessageCopy[$scope.currentEditMessageIndex]._id?(msg._id=$scope.welcomeMessageCopy[$scope.currentEditMessageIndex]._id,$scope.closeModal(),$scope.cb.getObjResponse(msg,!0)):$scope.editMode&&""===$scope.welcomeMessageCopy[$scope.currentEditMessageIndex]._id?($scope.welcomeMessageCopy[$scope.currentEditMessageIndex]=msg,$scope.closeModal(),$scope.cb.getObjResponseEdit($scope.welcomeMessageCopy)):($scope.closeModal(),$scope.cb.getObjResponse(msg))}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btChatHistory",function(){return{restrict:"EAQ",scope:{cb:"=",nlpData:"=",type:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/botChatHistory/botChatHistory.html",controller:["$scope","$window","$element","$timeout","$rootScope","env_conf","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","i18n",function($scope,$window,$element,$timeout,$rootScope,env_conf,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,i18n){function loadChatHistory(msgId,direction,limit,fromScroll){function confirmLink(){window.open($scope.redirectLink,"_blank")}function cancelLink(){}if(!$scope.loading){$scope.loading=!0;var showTimeLines=!0;BTStreamsService.getChatHistory($scope.stream._id,msgId,direction,limit,showTimeLines).then(function(res){if(res.data){if(fromScroll){var data=res.data.messages;-1===direction?(res.data.moreAvailable||($scope.moreAvailableTop=!1),data.splice(-1,1),data=data.concat($scope.chatHistory.messages),$scope.chatHistory.messages=data):1===direction&&(res.data.moreAvailable||($scope.moreAvailableBottom=!1),data.shift(),$scope.chatHistory.messages=$scope.chatHistory.messages.concat(data),setTimeout(function(){$(".isLink").click(function(evt){evt.preventDefault(),evt.stopPropagation(),$scope.redirectLink=$(this).attr("readlink"),NotificationService.userConfirm(i18n.i18nString("malicious"),[confirmLink,cancelLink],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("open_link"))})},150))}else $scope.chatHistory=res.data,$timeout(function(){$scope.loaded=!0},2e3);$scope.chatHistory.messages.forEach(function(msg){var taskids=_.pluck($scope.tasks,"_id");-1==taskids.indexOf($scope.originalIntent.taskId)&&"SMALLTALK"!==$scope.originalIntent.resourceInfo.type?msg.intentData=i18n.i18nString("intent_not_ava"):-1!==taskids.indexOf($scope.originalIntent.taskId)&&"dialog"==$scope.originalIntent.resourceInfo.type?$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)]&&$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)].localeData&&$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)].localeData[$scope.currentLanguage]&&$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)].localeData[$scope.currentLanguage].name&&(msg.intentData=i18n.i18nString("intent_label")+" : "+$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)].localeData[$scope.currentLanguage].name):-1!==taskids.indexOf($scope.originalIntent.taskId)&&"FAQ"==$scope.originalIntent.resourceInfo.type?$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)]&&$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)].questionPayload&&$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)].questionPayload.question&&(msg.intentData=i18n.i18nString("intent_label")+" : "+$scope.tasks[taskids.indexOf($scope.originalIntent.taskId)].questionPayload.question):"SMALLTALK"==$scope.originalIntent.resourceInfo.type&&$scope.originalIntent&&$scope.originalIntent.resourceInfo&&$scope.originalIntent.resourceInfo.name&&(msg.intentData=$scope.originalIntent.resourceInfo.name),msg.ms&&(msg.showUserMessage=msg.ms),msg.msgTagValue=msg.tags.messageTags,msg.msgTagValue.length>1&&($scope.nextMessageTag=!0,$scope.previousMessageTag=!1),msg.messageTagLength=msg.msgTagValue.length-1,$scope.originalIntent.input&&msg.components[0].data.text===$scope.originalIntent.input&&($scope.cb.winningIntentMsgId=msg._id)}),$scope.loading=!1}},function(error){$scope.loading=!1,NotificationService.notify(i18n.i18nString("fail_history"),"error")})}}function xssAttack(txtStr){var textHasXSS;return txtStr&&(textHasXSS=txtStr.isNotAllowedHTMLTags()),textHasXSS&&!textHasXSS.isValid&&(txtStr=txtStr.escapeHTML()),txtStr}function isEven(n){return n=Number(n),0===n||!(!n||n%2)}function getTemplate(msgData){try{var data=msgData;if("facebook"===data.channels[0].type){var channelMsg=JSON.parse(data.components[0].data.text);msgData=channelMsg.attachment}else{var templateData=msgData.components[0].data.text;msgData=JSON.parse(templateData)}return"button"===msgData.payload.template_type?$(buttonTemplate).tmpl({msgData:msgData}).html():"video"===msgData.type||"audio"===msgData.type||"link"===msgData.type||"image"===msgData.type?(msgData.extractedFileName=msgData.payload.url.replace(/^.*[\\\/]/,""),$(templateAttachment).tmpl({msgData:msgData}).html()):"error"===msgData.type||"message"===msgData.type?$(warningTemplate).tmpl({msgData:msgData}).html():"quick_replies"===msgData.payload.template_type?$(quickReplyTemplate).tmpl({msgData:msgData}).html():"list"===msgData.payload.template_type?$(listTemplate).tmpl({msgData:msgData}).html():msgData&&msgData.payload&&"mini_table"===msgData.payload.template_type&&"horizontal"===msgData.payload.layout?(setTimeout(function(){$scope.miniTemplateFn(data)}),$(miniTableHorizontalTemplate).tmpl({msgData:msgData}).html()):msgData&&msgData.payload&&"carousel"===msgData.payload.template_type||msgData&&msgData.payload&&"generic"===msgData.payload.template_type?(setTimeout(function(){$scope.carouselTemplateFn(data)}),$(carouselTemplate).tmpl({msgData:msgData}).html()):msgData&&msgData.payload&&"table"===msgData.payload.template_type?(setTimeout(function(){504==$(".botchatHistoryContainer").width()||$(".botchatHistoryContainer").width()<504?($(".accordionTable").each(function(){$(this).hasClass("responsive")&&$(this).addClass("hide")}),$(".tablechartDiv").each(function(){$(this).hasClass("regular")||$(this).removeClass("hide")})):($(".accordionTable").each(function(){$(this).hasClass("responsive")&&$(this).removeClass("hide")}),$(".tablechartDiv").each(function(){$(this).hasClass("regular")||$(this).addClass("hide")}))}),$(tableChartTemplate).tmpl({msgData:msgData}).html()):msgData&&msgData.payload&&"barchart"===msgData.payload.template_type?(setTimeout(function(){$scope.barChartFn(data)}),$(barchartTemplate).tmpl({msgData:msgData,data:data}).html()):msgData&&msgData.payload&&"piechart"===msgData.payload.template_type?(setTimeout(function(){$scope.pieChartFn(data)}),$(pieChartTemplate).tmpl({msgData:msgData,data:data}).html()):msgData&&msgData.payload&&"linechart"===msgData.payload.template_type?(setTimeout(function(){$scope.lineChartFn(data)}),$(linechartTemplate).tmpl({msgData:msgData,data:data}).html()):'<span class="messageBubble">"'+i18n.i18nString("js_msg")+'"</span>'}catch(error){return'<span class="messageBubble">"'+i18n.i18nString("js_msg")+'"</span>'}}$scope.stream=$workflowService.selectedStream(),$scope._constants_=$rootScope._constants_,$scope.assetsBase=env_conf["assets-url"],$scope.moveDownIcon=$scope.assetsBase+"landingImages/move-down.svg",$scope.moveUpIcon=$scope.assetsBase+"landingImages/move-up.svg",$scope.winningIntentData="",$scope.IntentData="",$scope.moreAvailableTop=!0,$scope.moreAvailableBottom=!0,$scope.loading=!1,$scope.messageIndex=0;var carouselTemplateCount=0,carouselEles=[],available_charts=[];$scope.tasks=[],$scope.recordTags=[],$scope.currentLanguage=$workflowService.currentLanguage(),$scope.cb.loadChatNLPData=function(task,nlpData,originalIntent,intentId,taskValue){$scope.moreAvailableTop=!0,$scope.moreAvailableBottom=!0,$scope.nlpData=nlpData,$scope.task=task,$scope.originalIntent=originalIntent,$scope.winningIntentData="",taskValue&&($scope.tasks=taskValue.tasks),nlpData.finalResolver&&nlpData.finalResolver.Entities&&nlpData.finalResolver.Entities.length>0&&($scope.winningIntentData+=i18n.i18nString("entity_dots")+JSON.stringify(nlpData.finalResolver.Entities)),loadChatHistory($scope.originalIntent.messageId,0,30,!1)},$scope.checkForTemplate=function(msg){return msg&&-1!==msg.indexOf("{")?!0:!1},$scope.checkForCustomTemplate=function(msg){try{var msgCheck=JSON.parse(msg);if(msgCheck.payload&&"custom"===msgCheck.payload.template_type)return!0}catch(e){return!1}},$scope.showNextMessageTag=function(message,type){"showNextIcon"==type&&message.messageTagLength>=1&&($scope.previousMessageTag=!0,$scope.messageIndex=$scope.messageIndex+1,$scope.messageIndex>=message.messageTagLength&&($scope.nextMessageTag=!1)),"showPreviousIcon"==type&&($scope.nextMessageTag=!0,$scope.messageIndex=$scope.messageIndex-1,0===$scope.messageIndex&&($scope.previousMessageTag=!1))},$scope.showJSON=function(message){var jsonDomEle=document.getElementById("chatHistoryJson");jsonDomEle&&(jsonDomEle.innerHTML=JSON.stringify(message,void 0,2)),$(".jsonResponseContainer").show()};var pinnedContainer=$(".analyzeEditTask .tab-content #chatHistory .chatHistoryScroll");pinnedContainer.on("scroll",function(event){$(this).scrollTop()<80&&2===$scope.type?(0===$(this).scrollTop()&&$(".analyzeEditTask .tab-content #chatHistory .chatHistoryScroll").scrollTop(2),$scope.moreAvailableTop&&$scope.cb.scrollCompleted&&loadChatHistory($scope.chatHistory.messages[0]._id,-1,10,!0)):$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&2===$scope.type&&$scope.chatHistory.messages.length>1&&$scope.moreAvailableBottom&&$scope.cb.scrollCompleted&&loadChatHistory($scope.chatHistory.messages[$scope.chatHistory.messages.length-1]._id,1,10,!0)}),String.prototype.isNotAllowedHTMLTags=function(){var wrapper=document.createElement("div");wrapper.innerHTML=this;var setFlags={isValid:!0,key:""};return($(wrapper).find("script").length||$(wrapper).find("video").length||$(wrapper).find("audio").length)&&(setFlags.isValid=!1),$(wrapper).find("link").length&&-1!==$(wrapper).find("link").attr("href").indexOf("script")&&(detectScriptTag.test($(wrapper).find("link").attr("href"))?setFlags.isValid=!1:setFlags.isValid=!0),$(wrapper).find("a").length&&-1!==$(wrapper).find("a").attr("href").indexOf("script")&&(detectScriptTag.test($(wrapper).find("a").attr("href"))?setFlags.isValid=!1:setFlags.isValid=!0),$(wrapper).find("img").length&&-1!==$(wrapper).find("img").attr("src").indexOf("script")&&(detectScriptTag.test($(wrapper).find("img").attr("href"))?setFlags.isValid=!1:setFlags.isValid=!0),$(wrapper).find("object").length&&(setFlags.isValid=!1),setFlags},String.prototype.escapeHTML=function(){var escapeTokens={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"},htmlTags=/[<>"']/g;return(""+this).replace(htmlTags,function(match){return escapeTokens[match]})},$scope.helpers={nl2br:function(str,runEmojiCheck){return runEmojiCheck&&(str=window.emojione.shortnameToImage(str)),str=str.replace(/(?:\r\n|\r|\n)/g,"<br />")},br2nl:function(str){return str=str.replace(/<br \/>/g,"\n")},formatAMPM:function(date){var hours=date.getHours(),minutes=date.getMinutes(),seconds=date.getSeconds(),ampm=hours>=12?"pm":"am";hours%=12,hours=hours?hours:12,minutes=10>minutes?"0"+minutes:minutes,seconds=10>seconds?"0"+seconds:seconds;var strTime=hours+":"+minutes+":"+seconds+" "+ampm;return strTime},formatDate:function(date){var d=new Date(date);return d.toDateString()+" at "+$scope.helpers.formatAMPM(d)},convertMDtoHTML:function(val,responseType){function matchmap(regexval,stringval){for(var da,matches=[];null!==(da=regexval.exec(stringval));){var keypair={};if(keypair.index=da.index,keypair.matchexp=da[0],da.length>1)for(var n=1;n<da.length;n++){var mstr="matchval"+n.toString();keypair[mstr]=da[n]}matches.push(keypair)}return matches}function ucreplacer(match){return match.toUpperCase()}function ignoreWords(str){var _words=["onclick","onmouse","onblur","onscroll","onStart"];return _words.forEach(function(word){var regEx=new RegExp(word,"ig");str=str.replace(regEx,"")}),str}function linkreplacer(match,p1,offset,string){var dummyString=string.replace(_regExForMarkdownLink,"[]");if(dummyString=ignoreWords(dummyString),-1!==dummyString.indexOf(match)){var _target,_link=p1.indexOf("http")<0?"http://"+match:match;return _target="target='_blank'","<span class='isLink' readlink='"+_link+"' ><a "+_target+" href='"+_link+"'>"+match+"</a></span>"}return match}var mdre={};mdre.date=new RegExp(/\\d\(\s*(.{10})\s*(?:,\s*["'](.+?)["']\s*)?\)/g),mdre.time=new RegExp(/\\t\(\s*(.{8}\.\d{0,3})\s*\)/g),mdre.datetime=new RegExp(/\\(d|dt|t)\(\s*([-0-9]{10}[T][0-9:.]{12})([z]|[Z]|[+-]\d{4})[\s]*,[\s]*["']([a-zA-Z\W]+)["']\s*\)/g),mdre.num=new RegExp(/\\#\(\s*(\d*.\d*)\s*\)/g),mdre.curr=new RegExp(/\\\$\((\d*.\d*)[,](\s*[\"\']\s*\w{3}\s*[\"\']\s*)\)|\\\$\((\d*.\d*)[,](\s*\w{3}\s*)\)/g);var regEx={};regEx.SPECIAL_CHARS=/[\=\`\~\!@#\$\%\^&\*\(\)_\-\+\{\}\:"\[\];\',\.\/<>\?\|\\]+/,regEx.EMAIL=/^[-a-z0-9~!$%^&*_=+}{\']+(\.[-a-z0-9~!$%^&*_=+}{\']+)*@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,255})+$/i,regEx.MENTION=/(^|\s|\\n|")@([^\s]*)(?:[\s]\[([^\]]*)\])?["]?/gi,regEx.HASHTAG=/(^|\s|\\n)#(\S+)/g,regEx.NEWLINE=/\n/g;var _regExForLink=/((?:http\:\/\/|https\:\/\/|www\.)+\S*\.(?:(?:\.\S)*[^\,\s\.])*\/?(?="))/gi,_regExForMarkdownLink=/\[([^\]]+)\](|\s)+\(([^\)])+\)/g,str=val||"",mmntns={};mmntns.sd=new RegExp(/^(d{1})[^d]|[^d](d{1})[^d]/g),mmntns.dd=new RegExp(/^(d{2})[^d]|[^d](d{2})[^d]/g),mmntns.fy=new RegExp(/(y{4})|y{2}/g);for(var regexkeys=Object.keys(mdre),j=0;j<regexkeys.length;j++){var k;switch(regexkeys[j]){case"date":var strvald=str,datematcharray=matchmap(mdre.date,strvald);if(datematcharray.length)for(k=0;k<datematcharray.length;k++){var fdate=new Date(datematcharray[k].matchval1).toLocaleDateString();fdate=" "+fdate.toString()+" ",str=str.replace(datematcharray[k].matchexp.toString(),fdate)}break;case"time":var strvalt=str,timematcharray=matchmap(mdre.time,strvalt);if(timematcharray.length)for(k=0;k<timematcharray.length;k++){var ftime=new Date(timematcharray[k].matchval1).toLocaleTimeString();ftime=" "+ftime.toString()+" ",str=str.replace(timematcharray[k].matchexp.toString(),ftime)}break;case"datetime":var strvaldt=str,dtimematcharray=matchmap(mdre.datetime,strvaldt);if(dtimematcharray.length)for(k=0;k<dtimematcharray.length;k++){for(var ms="",mergekeylength=Object.keys(dtimematcharray[k]).length-2,l=2;mergekeylength>l;l++){var keystr="matchval"+l.toString();ms+=dtimematcharray[k][keystr]}var foptionstring="matchval"+mergekeylength.toString(),fmtstr=dtimematcharray[k][foptionstring];fmtstr=fmtstr.replace(mmntns.fy,ucreplacer),fmtstr=fmtstr.replace(mmntns.dd,ucreplacer),fmtstr=fmtstr.replace(mmntns.sd,ucreplacer);var fdtime=moment(ms).format(fmtstr);fdtime=" "+fdtime.toString()+" ",str=str.replace(dtimematcharray[k].matchexp.toString(),fdtime)}break;case"num":var strnumval=str,nummatcharray=matchmap(mdre.num,strnumval);if(nummatcharray.length)for(k=0;k<nummatcharray.length;k++){var fnum=Number(nummatcharray[k].matchval1).toLocaleString();fnum=" "+fnum.toString()+" ",str=str.replace(nummatcharray[k].matchexp.toString(),fnum)}break;case"curr":var strcurval=str,currmatcharray=matchmap(mdre.curr,strcurval),browserLang=window.navigator.language||window.navigator.browserLanguage,curcode=new RegExp(/\w{3}/);if(currmatcharray.length)for(k=0;k<currmatcharray.length;k++){var fcode,currops={};currops.style="currency",currmatcharray[k].matchval2&&(fcode=curcode.exec(currmatcharray[k].matchval2)),currops.currency=fcode[0].toString();var fcurr=Number(currmatcharray[k].matchval1).toLocaleString(browserLang,currops);fcurr=currmatcharray[k].matchval1.toString()===fcurr.toString()?" "+fcurr.toString()+" "+currops.currency:" "+fcurr.toString()+" ",str=str.replace(currmatcharray[k].matchexp.toString(),fcurr)}}}regEx.NEWLINE;try{str=decodeURIComponent(str)}catch(e){str=str||""}var wrapper1,x,aTags,newStr="",_hasHref=!1;if("user"===responseType){for(str=str.replace(/onerror=/gi,"abc-error="),wrapper1=document.createElement("div"),newStr=str.replace(//g,'"').replace(//g,'"'),newStr=newStr.replace(/</g,"&lt;").replace(/>/g,"&gt;"),wrapper1.innerHTML=xssAttack(newStr),aTags=wrapper1.getElementsByTagName("a").length>0?wrapper1.getElementsByTagName("a"):[],_hasHref=!1,x=0;x<aTags.length;x++)if(aTags[x].getAttribute("href").length>0){_hasHref=!0;break}str=_hasHref?newStr:newStr.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(_regExForLink,linkreplacer)}else{for(wrapper1=document.createElement("div"),wrapper1.innerHTML=xssAttack(str),aTags=wrapper1.getElementsByTagName("a").length>0?wrapper1.getElementsByTagName("a"):[],_hasHref=!1,x=0;x<aTags.length;x++)if(aTags[x].getAttribute("href").length>0){_hasHref=!0;break}if(_hasHref){var linkArray=str.match(/<a[^>]*>([^<]+)<\/a>/g);for(x=0;x<linkArray.length;x++){var _newLA=document.createElement("div");_newLA.innerHTML=linkArray[x],$(_newLA).find("a").attr("target","_blank"),str=str.replace(linkArray[x],_newLA.innerHTML)}}else str=wrapper1.innerHTML.replace(_regExForLink,linkreplacer)}return str=$scope.helpers.checkMarkdowns(str),"user"===responseType&&(str=str.replace(/abc-error=/gi,"onerror=")),$scope.helpers.nl2br(str,!0)},checkMarkdowns:function(val){for(var txtArr=val.split(/\r?\n/),i=0;i<txtArr.length;i++){var _lineBreakAdded=!1;0===txtArr[i].indexOf("#h6")||0===txtArr[i].indexOf("#H6")?(txtArr[i]="<h6>"+txtArr[i].substring(3)+"</h6>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h5")||0===txtArr[i].indexOf("#H5")?(txtArr[i]="<h5>"+txtArr[i].substring(3)+"</h5>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h4")||0===txtArr[i].indexOf("#H4")?(txtArr[i]="<h4>"+txtArr[i].substring(3)+"</h4>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h3")||0===txtArr[i].indexOf("#H3")?(txtArr[i]="<h3>"+txtArr[i].substring(3)+"</h3>",_lineBreakAdded=!0):0===txtArr[i].indexOf("#h2")||0===txtArr[i].indexOf("#H2")?(txtArr[i]="<h2>"+txtArr[i].substring(3)+"</h2>",
_lineBreakAdded=!0):0===txtArr[i].indexOf("#h1")||0===txtArr[i].indexOf("#H1")?(txtArr[i]="<h1>"+txtArr[i].substring(3)+"</h1>",_lineBreakAdded=!0):0===txtArr[i].length?(txtArr[i]="\r\n",_lineBreakAdded=!0):0===txtArr[i].indexOf("*")?isEven(txtArr[i].split("*").length-1)||(txtArr[i]="\r\n&#9679; "+txtArr[i].substring(1),_lineBreakAdded=!0):0===txtArr[i].indexOf(">>")?(txtArr[i]='<p class="indent">'+txtArr[i].substring(2)+"</p>",_lineBreakAdded=!0):0===txtArr[i].indexOf("&gt;&gt;")?(txtArr[i]='<p class="indent">'+txtArr[i].substring(8)+"</p>",_lineBreakAdded=!0):(0===txtArr[i].indexOf("---")||0===txtArr[i].indexOf("___"))&&(txtArr[i]="<hr/>"+txtArr[i].substring(3),_lineBreakAdded=!0);var j,_matchImage=txtArr[i].match(/\!\[([^\]]+)\](|\s)+\(([^\)])+\)/g);if(_matchImage&&_matchImage.length>0)for(j=0;j<_matchImage.length;j++){var _imgTxt=_matchImage[j].substring(2,_matchImage[j].indexOf("]"));remainingString=_matchImage[j].substring(_matchImage[j].indexOf("]")+1).trim();var _imgLink=remainingString.substring(1,remainingString.indexOf(")"));_imgLink='<img src="'+_imgLink+'" alt="'+_imgTxt+'"/>';for(var _tempImg=txtArr[i].split(" "),k=0;k<_tempImg.length;k++)_tempImg[k]===_matchImage[j]&&(_tempImg[k]=_imgLink);txtArr[i]=_tempImg.join(" ")}var remainingString,_matchLink=txtArr[i].match(/\[([^\]]+)\](|\s)+\(([^\)])+\)/g);if(_matchLink&&_matchLink.length>0)for(j=0;j<_matchLink.length;j++){var _linkTxt=_matchLink[j].substring(1,_matchLink[j].indexOf("]"));remainingString=_matchLink[j].substring(_matchLink[j].indexOf("]")+1).trim();var _linkLink=remainingString.substring(1,remainingString.indexOf(")"));_linkLink='<span class="isLink" readlink="'+_linkLink+'"><a href="'+_linkLink+'" target="_blank">'+_linkTxt+"</a></span>",txtArr[i]=txtArr[i].replace(_matchLink[j],_linkLink)}var _matchAstrik=txtArr[i].match(/\*\S([^*]*?)\S\*/g);if(_matchAstrik&&_matchAstrik.length>0)for(j=0;j<_matchAstrik.length;j++){var _boldTxt=_matchAstrik[j];_boldTxt=_boldTxt.substring(1,_boldTxt.length-1),_boldTxt="<b>"+_boldTxt+"</b>",txtArr[i]=txtArr[i].replace(_matchAstrik[j],_boldTxt)}var _matchItalic=txtArr[i].match(/\~\S([^*]*?)\S\~/g);if(_matchItalic&&_matchItalic.length>0)for(j=0;j<_matchItalic.length;j++){var _italicTxt=_matchItalic[j];(0===txtArr[i].indexOf(_italicTxt)||" "===txtArr[i][txtArr[i].indexOf(_italicTxt)-1])&&(_italicTxt=_italicTxt.substring(1,_italicTxt.length-1),_italicTxt='<i class="markdownItalic">'+_italicTxt+"</i>",txtArr[i]=txtArr[i].replace(_matchItalic[j],_italicTxt))}var _matchPre=txtArr[i].match(/\`\`\`\S([^*]*?)\S\`\`\`/g),_matchPre1=txtArr[i].match(/\'\'\'\S([^*]*?)\S\'\'\'/g),_preTxt="";if(_matchPre&&_matchPre.length>0){for(j=0;j<_matchPre.length;j++)_preTxt=_matchPre[j],_preTxt=_preTxt.substring(3,_preTxt.length-3),_preTxt="<pre>"+_preTxt+"</pre>",txtArr[i]=txtArr[i].replace(_matchPre[j],_preTxt);_lineBreakAdded=!0}if(_matchPre1&&_matchPre1.length>0){for(j=0;j<_matchPre1.length;j++)_preTxt=_matchPre1[j],_preTxt=_preTxt.substring(3,_preTxt.length-3),_preTxt="<pre>"+_preTxt+"</pre>",txtArr[i]=txtArr[i].replace(_matchPre1[j],_preTxt);_lineBreakAdded=!0}!_lineBreakAdded&&i>0&&(txtArr[i]="\r\n"+txtArr[i])}return val=txtArr.join("")}},$scope.miniTemplateFn=function(data){$("[data-msg-id="+data._id+"] .carousel").addClass("carousel"+carouselTemplateCount);var count=$("[data-msg-id="+data._id+"] .carousel"+carouselTemplateCount).children().length;if(count>1){var carouselOneByOne=new PureJSCarousel({carousel:"[data-msg-id="+data._id+"] .carousel"+carouselTemplateCount,slide:".slide",oneByOne:!0});$(".carousel"+carouselTemplateCount).parent().show(),$(".carousel"+carouselTemplateCount).attr("style","height: 100% !important"),carouselEles.push(carouselOneByOne)}},$scope.carouselTemplateFn=function(data){$("[data-msg-id="+data._id+"] .carousel").addClass("carousel"+carouselTemplateCount);var count=$("[data-msg-id="+data._id+"] .carousel"+carouselTemplateCount).children().length;if(count>1){var carouselOneByOne=new PureJSCarousel({carousel:"[data-msg-id="+data._id+"] .carousel"+carouselTemplateCount,slide:".slide",oneByOne:!0});$(".carousel"+carouselTemplateCount).parent().show(),$(".carousel"+carouselTemplateCount).attr("style","height: 100% !important"),carouselEles.push(carouselOneByOne)}},$scope.barChartFn=function(data){var messageId=data._id,msgData=JSON.parse(data.components[0].data.text),barTemplateObj={message:[{component:msgData}]},dimens={};dimens.outerWidth=350,dimens.outerHeight=300,dimens.innerHeight=200,dimens.legendRectSize=15,dimens.legendSpacing=4,void 0===msgData.payload.direction&&(msgData.payload.direction="horizontal"),"horizontal"!==msgData.payload.direction||msgData.payload.stacked?"vertical"===msgData.payload.direction&&msgData.payload.stacked?setTimeout(function(){dimens.outerWidth=400,dimens.innerWidth=270;var _barchartObj={id:"barchart"+messageId,data:msgData,type:"stackedBarchart"};available_charts.push(_barchartObj),KoreGraphAdapter.drawD3barVerticalStackedChart(barTemplateObj,dimens,"#barchart"+messageId,12)},250):"horizontal"===msgData.payload.direction&&msgData.payload.stacked?setTimeout(function(){dimens.innerWidth=180;var _barchartObj={id:"barchart"+messageId,data:msgData,type:"stackedBarchart"};available_charts.push(_barchartObj),KoreGraphAdapter.drawD3barStackedChart(barTemplateObj,dimens,"#barchart"+messageId,12)},250):"vertical"!==msgData.payload.direction||msgData.payload.stacked||setTimeout(function(){dimens.innerWidth=240;var _barchartObj={id:"barchart"+messageId,data:msgData,type:"barchart"};available_charts.push(_barchartObj),KoreGraphAdapter.drawD3barChart(barTemplateObj,dimens,"#barchart"+messageId,12)},250):setTimeout(function(){dimens.innerWidth=180;var _barchartObj={id:"Legend_barchart"+messageId,data:msgData,type:"barchart"};available_charts.push(_barchartObj),KoreGraphAdapter.drawD3barHorizontalbarChart(barTemplateObj,dimens,"#barchart"+messageId,12)},250)},$scope.pieChartFn=function(data){var messageId=data._id,msgData=JSON.parse(data.components[0].data.text),pieTemplateObj={message:[{component:msgData}]};if(void 0===msgData.payload.pie_type&&(msgData.payload.pie_type="regular"),msgData.payload.pie_type){var dimens={};dimens.width=300,dimens.height=200,dimens.legendRectSize=10,dimens.legendSpacing=2.4,"regular"===msgData.payload.pie_type?setTimeout(function(){var _piechartObj={id:"piechart"+messageId,data:msgData,type:"regular"};available_charts.push(_piechartObj),KoreGraphAdapter.drawD3Pie(pieTemplateObj,dimens,"#piechart"+messageId,12)},150):"donut"===msgData.payload.pie_type?setTimeout(function(){var _piechartObj={id:"piechart"+messageId,data:msgData,type:"donut"};available_charts.push(_piechartObj),KoreGraphAdapter.drawD3PieDonut(pieTemplateObj,dimens,"#piechart"+messageId,12,"donut")},150):"donut_legend"===msgData.payload.pie_type&&setTimeout(function(){var _piechartObj={id:"piechart"+messageId,data:msgData,type:"donut_legend"};available_charts.push(_piechartObj),KoreGraphAdapter.drawD3PieDonut(pieTemplateObj,dimens,"#piechart"+messageId,12,"donut_legend")},150)}},$scope.lineChartFn=function(data){var messageId=data._id,msgData=JSON.parse(data.components[0].data.text),lineTemplateObj={message:[{component:msgData}]};setTimeout(function(){var dimens={};dimens.outerWidth=350,dimens.outerHeight=350,dimens.innerWidth=230,dimens.innerHeight=250,dimens.legendRectSize=15,dimens.legendSpacing=4;var _linechartObj={id:"linechart"+messageId,data:msgData,type:"linechart"};available_charts.push(_linechartObj),KoreGraphAdapter.drawD3lineChartV2(lineTemplateObj,dimens,"#linechart"+messageId,12)},250)},$scope.renderTemplate=function(msgData,ele){var _msgTemp=getTemplate(msgData);$("[data-msg-id="+msgData._id+"] .template").append(_msgTemp)};var buttonTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                         {{if msgData.payload}}                             <li class = "fromCurrentUser with-icon">                                 <div class="buttonTmplContent">                                     <ul class="buttonTmplContentBox">                                        <li class="buttonTmplContentHeading">                                             ${msgData.payload.text}                                         </li>                                        {{each(key, msgItem) msgData.payload.buttons}}                                             <li {{if msgItem.payload}} value="${msgItem.payload}" {{/if}} {{if msgItem.payload}} actual-value="${msgItem.payload}"{{/if}} {{if msgItem.url}}url="${msgItem.url}"{{/if}} class="buttonTmplContentChild" data-value="${msgItem.value}" type="${msgItem.type}">                                                ${msgItem.title}                                            </li>                                         {{/each}}                                     </ul>                                </div>                            </li>                         {{/if}}                     </script>',templateAttachment='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         {{each(key, msgItem) msgData.payload}}                             <li class = "fromCurrentUser with-icon">                                 {{if msgData.payload}}                                     <div class="messageBubble">                                         <div class="msgCmpt botResponseAttachments" fileid="${msgData.payload.url}">                                             <div class="uploadedFileIcon">                                                 {{if msgData.type == "image"}}                                                     <span class="icon cf-icon icon-photos_active"></span>                                                 {{else msgData.type == "audio"}}                                                    <span class="icon cf-icon icon-files_audio"></span>                                                 {{else msgData.type == "video"}}                                                     <span class="icon cf-icon icon-video_active fa fa-video-camera"></span>                                                 {{else msgData.type == "error"}}                                                 <span class="icon cf-icon icon-video_active fa fa-video-camera"></span>                                                 {{else}}                                                     {{if extension[1]=="xlsx" || extension[1]=="xls" || extension[1]=="docx" || extension[1]=="doc" || extension[1]=="pdf" || extension[1]=="ppsx" || extension[1]=="pptx" || extension[1]=="ppt" || extension[1]=="zip" || extension[1]=="rar"}}                                                        <span class="icon cf-icon icon-files_${extension[1]}"></span>                                                     {{else extension[1]}}                                                        <span class="icon cf-icon icon-files_other_doc"></span>                                                     {{/if}}                                                {{/if}}                                            </div>                                             <div class="botuploadedFileName">${msgData.extractedFileName}</div>                                         </div>                                     </div>                                 {{/if}}                             </li>                         {{/each}}                     {{/if}}                 </script>',warningTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.type  && msgData.type =="error"}}                         <div><span class="warningColor">${msgData.payload.text} </span></div>                        {{else}}                         {{if msgData && msgData.payload && msgData.payload.videoUrl}}                            <div class="messageBubble">                                 <div class="videoEle"><video width="250" controls><source src="${msgData.payload.videoUrl}" type="video/mp4"></video></div>                            </div>                         {{/if}}                    {{/if}}                 </script> ',quickReplyTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <div>                             <li class = "fromCurrentUser with-icon quickReplies">                                 <div class="buttonTmplContent">                                     {{if msgData.payload.text}}                                         <div class="buttonTmplContentHeading quickReply">                                             ${msgData.payload.text}                                        </div>                                    {{/if}}                                     {{if msgData.payload && msgData.payload.quick_replies && msgData.payload.quick_replies.length }}                                         <div class="fa fa-chevron-left quickreplyLeftIcon hide"></div><div class="fa fa-chevron-right quickreplyRightIcon hide"></div>                                            <div class="quick_replies_btn_parent"><div class="autoWidth">                                                {{each(key, msgItem) msgData.payload.quick_replies}}                                                     <div class="buttonTmplContentChild quickReplyDiv"> <span {{if msgItem.payload}}value="${msgItem.payload}"{{/if}} class="quickReply {{if msgItem.image_url}}with-img{{/if}}" type="${msgItem.content_type}">                                                        {{if msgItem.image_url}}<img src="${msgItem.image_url}">{{/if}} <span class="quickreplyText {{if msgItem.image_url}}with-img{{/if}}">${msgItem.title}</span></span>                                                    </div>                                                 {{/each}}                                             </div>                                        </div>                                    {{/if}}                                 </div>                            </li>                         </div>                     {{/if}}                 </script>',listTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class = "fromCurrentUser with-icon">                             <div class="listTmplContent">                                 <ul class="listTmplContentBox">                                     {{if msgData.payload.title || msgData.payload.heading}}                                         <li class="listTmplContentHeading">                                             ${msgData.payload.heading}                                         </li>                                     {{/if}}                                     {{each(key, msgItem) msgData.payload.elements}}                                         {{if msgData.payload.buttons}}                                             {{if key<= 2 }}                                                <li class="listTmplContentChild">                                                     {{if msgItem.image_url}}                                                         <div class="listRightContent" {{if msgItem.default_action && msgItem.default_action.url}}url="${msgItem.default_action.url}"{{/if}} {{if msgItem.default_action && msgItem.default_action.title}}data-value="${msgItem.default_action.title}"{{/if}} {{if msgItem.default_action && msgItem.default_action.type}}type="${msgItem.default_action.type}"{{/if}} {{if msgItem.default_action && msgItem.default_action.payload}} value="${msgItem.default_action.payload}"{{/if}}>                                                             <img alt="image" src="${msgItem.image_url}" onerror="this.onerror=null;this.src=\'../libs/img/no_image.png\';"/>                                                         </div>                                                     {{/if}}                                                     <div class="listLeftContent">                                                         <div class="listItemTitle">${msgItem.title}                                                         {{if msgItem.subtitle}}<div class="listItemSubtitle">${msgItem.subtitle}</div>{{/if}}                                                         {{if msgItem.default_action && msgItem.default_action.url}}<div class="listItemPath" type="url" url="${msgItem.default_action.url}">${msgItem.default_action.url}</div>{{/if}}                                                         {{if msgItem.buttons}}                                                        <div>                                                             <span class="buyBtn" {{if msgItem.buttons[0].type}}type="${msgItem.buttons[0].type}"{{/if}} {{if msgItem.buttons[0].url}}url="${msgItem.buttons[0].url}"{{/if}} {{if msgItem.buttons[0].payload}}value="${msgItem.buttons[0].payload}"{{/if}}>{{if msgItem.buttons[0].title}}${msgItem.buttons[0].title}{{else}}Buy{{/if}}</span>                                                         </div>                                                         {{/if}}                                                    </div>                                                </li>                                             {{/if}}                                        {{else}}                                             <li class="listTmplContentChild">                                                 {{if msgItem.image_url}}                                                     <div class="listRightContent" {{if msgItem.default_action && msgItem.default_action.url}}url="${msgItem.default_action.url}"{{/if}} {{if msgItem.default_action && msgItem.default_action.title}}data-value="${msgItem.default_action.title}"{{/if}} {{if msgItem.default_action && msgItem.default_action.type}}type="${msgItem.default_action.type}"{{/if}} {{if msgItem.default_action && msgItem.default_action.payload}} value="${msgItem.default_action.payload}"{{/if}}>                                                         <img alt="image" src="${msgItem.image_url}" onerror="this.onerror=null;this.src=\'../libs/img/no_image.png\';" />                                                     </div>                                                 {{/if}}                                                 <div class="listLeftContent">                                                     <div class="listItemTitle">${msgItem.title}</div>                                                     {{if msgItem.subtitle}}<div class="listItemSubtitle">${msgItem.subtitle}</div>{{/if}}                                                     {{if msgItem.default_action && msgItem.default_action.url}}<div class="listItemPath" type="url" url="${msgItem.default_action.url}">${msgItem.default_action.url}</div>{{/if}}                                                     {{if msgItem.buttons}}                                                    <div>                                                         <span class="buyBtn" {{if msgItem.buttons[0].type}}type="${msgItem.buttons[0].type}"{{/if}} {{if msgItem.buttons[0].url}}url="${msgItem.buttons[0].url}"{{/if}} {{if msgItem.buttons[0].payload}}value="${msgItem.buttons[0].payload}"{{/if}}>{{if msgItem.buttons[0].title}}${msgItem.buttons[0].title}{{else}}Buy{{/if}}</span>                                                     </div>                                                     {{/if}}                                                </div>                                            </li>                                         {{/if}}                                     {{/each}}                                     </li>                                     {{if msgData.AlwaysShowGlobalButtons || (msgData && msgData.payload.elements.length > 3 && msgData.payload.buttons)}}                                        <li class="viewMoreList">                                             <span class="viewMore" url="{{if msgData.payload.buttons[0].url}}${msgData.payload.buttons[0].url}{{/if}}" type="${msgData.payload.buttons[0].type}" value="{{if msgData.payload.buttons[0].payload}}${msgData.payload.buttons[0].payload}{{else}}${msgData.payload.buttons[0].title}{{/if}}">${msgData.payload.buttons[0].title}</span>                                         </li>                                     {{/if}}                                </ul>                             </div>                         </li>                     {{/if}}                 </script>',miniTableHorizontalTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class="fromCurrentUser with-icon tablechart">                             {{if msgData.payload.text}}                                 <div class="messageBubble tableChart">                                    <span>${msgData.payload.text}</span>                                </div>                             {{/if}}                            <div class="mini_template carousel" id="carousel-one-by-one" style="height: 0px;">                                {{each(key, table) msgData.payload.elements}}                                    <div class="slide">                                        <div class="minitableDiv">                                            <div style="overflow-x:auto; padding: 0 8px;">                                                <table cellspacing="0" cellpadding="0">                                                    <tr class="headerTitle">                                                        {{each(key, tableHeader) table.primary}}                                                             <th {{if tableHeader[1]}}style="text-align:${tableHeader[1]};" {{/if}}>${tableHeader[0]}</th>                                                        {{/each}}                                                     </tr>                                                    {{each(key, additional) table.additional}}                                                         <tr>                                                            {{each(cellkey, cellValue) additional}}                                                                 <td  {{if cellkey === additional.length-1}}colspan="2"{{/if}}  {{if table.primary[cellkey][1]}}style="text-align:${table.primary[cellkey][1]};" {{/if}}>${cellValue}</td>                                                            {{/each}}                                                         </tr>                                                    {{/each}}                                                 </table>                                            </div>                                        </div>                                    </div>                                {{/each}}                            </div>                        </li>                     {{/if}}                 </script>',carouselTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class = "fromCurrentUser with-icon">                             <div class="carousel" id="carousel-one-by-one">                                {{each(key, msgItem) msgData.payload.elements}}                                     <div class="slide">                                        {{if msgItem.image_url}}                                             <div class="carouselImageContent" {{if msgItem.default_action && msgItem.default_action.url}}url="${msgItem.default_action.url}"{{/if}} {{if msgItem.default_action && msgItem.default_action.title}}data-value="${msgItem.default_action.title}"{{/if}} {{if msgItem.default_action && msgItem.default_action.type}}type="${msgItem.default_action.type}"{{/if}} {{if msgItem.default_action && msgItem.default_action.payload}} value="${msgItem.default_action.payload}"{{/if}}>                                                 <img alt="image" src="${msgItem.image_url}" onerror="this.onerror=null;this.src=\'../libs/img/no_image.png\';"/>                                             </div>                                         {{/if}}                                         <div class="carouselTitleBox">                                             <p class="carouselTitle"> ${msgItem.title}</p>                                             {{if msgItem.subtitle}}<p class="carouselDescription">${msgItem.subtitle}</p>{{/if}}                                             {{if msgItem.default_action && msgItem.default_action.type === "web_url"}}<div class="listItemPath carouselDefaultAction" type="url" url="${msgItem.default_action.url}">${msgItem.default_action.url}</div>{{/if}}                                             {{if msgItem.buttons}}                                                 {{each(key, msgBtn) msgItem.buttons}}                                                     <div {{if msgBtn.payload}}value="${msgBtn.payload}"{{/if}} {{if msgBtn.url}}url="${msgBtn.url}"{{/if}} class="listItemPath carouselButton" data-value="${msgBtn.value}" type="${msgBtn.type}">                                                        ${msgBtn.title}                                                    </div>                                                 {{/each}}                                             {{/if}}                                         </div>                                    </div>                                {{/each}}                             </div>                        </li>                     {{/if}}                </script>',tableChartTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class ="fromCurrentUser with-icon tablechart">                             <div class="tablechartDiv {{if msgData.payload.table_design && msgData.payload.table_design == "regular"}}regular{{else}}hide{{/if}}">                                <div style="overflow-x:auto; padding: 0 8px;">                                    <table cellspacing="0" cellpadding="0">                                        <tr class="headerTitle">                                            {{each(key, tableHeader) msgData.payload.columns}}                                                 <th {{if tableHeader[1]}}style="text-align:${tableHeader[1]};"{{/if}}>${tableHeader[0]}</th>                                            {{/each}}                                         </tr>                                        {{each(key, tableRow) msgData.payload.elements}}                                             {{if tableRow.Values.length>1}}                                                <tr {{if key > 4}}class="hide"{{/if}}>                                                    {{each(cellkey, cellValue) tableRow.Values}}                                                         <td  {{if cellkey === tableRow.Values.length-1}}colspan="2"{{/if}} class=" {{if key == 0}} addTopBorder {{/if}}" {{if msgData.payload.columns[cellkey][1]}}style="text-align:${msgData.payload.columns[cellkey][1]};" {{/if}}>${cellValue}</td>                                                    {{/each}}                                                 </tr>                                            {{/if}}                                        {{/each}}                                     </table>                                </div>                                {{if msgData.payload.elements.length > 4 && msgData.payload.table_design && msgData.payload.table_design == "regular"}}<div class="showMore">Show more</div>{{/if}}                            </div>                            <div class="accordionTable {{if msgData.payload.table_design && msgData.payload.table_design == "regular"}}hide{{else}}responsive{{/if}}">                                {{each(key, tableRow) msgData.payload.elements}}                                     {{if key < 4}}                                        <div class="accordionRow">                                            {{each(cellkey, cellValue) tableRow.Values}}                                                 {{if cellkey < 2}}                                                    <div class="accordionCol">                                                        <div class="colTitle hideSdkEle">${msgData.payload.columns[cellkey][0]}</div>                                                        <div class="colVal">${cellValue}</div>                                                    </div>                                                {{else}}                                                    <div class="accordionCol hideSdkEle">                                                        <div class="colTitle">${msgData.payload.columns[cellkey][0]}</div>                                                        <div class="colVal">${cellValue}</div>                                                    </div>                                                {{/if}}                                            {{/each}}                                             <span class="fa fa-caret-right tableBtn"></span>                                        </div>                                    {{/if}}                                {{/each}}                                 <div class="showMore">Show more</div>                            </div>                        </li>                     {{/if}}                 </script>',barchartTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class="fromCurrentUser with-icon barchart">                             {{if msgData.payload.text}}                                 <div class="messageBubble barchart">                                    <span>${msgData.payload.text}</span>                                </div>                             {{/if}}                            <div class="barchartDiv">                            <div class="lineChartChildDiv" id="barchart${data._id}"></div>                            </div>                        </li>                     {{/if}}                 </script>',pieChartTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class = "fromCurrentUser with-icon piechart">                             {{if msgData.payload.text}}                                <div class="messageBubble pieChart">                                    <span>${msgData.payload.text}</span>                                </div>                             {{/if}}                            <div class="piechartDiv">                                <div class="lineChartChildDiv" id="piechart${data._id}"></div>                            </div>                        </li>                     {{/if}}                 </script>',linechartTemplate='<script id="chat_message_tmpl" type="text/x-jqury-tmpl">                     {{if msgData.payload}}                         <li class ="fromCurrentUser with-icon linechart">                             {{if msgData.payload.text}}                                <div class="messageBubble linechart">                                    <span>${msgData.payload.text}</span>                                </div>                             {{/if}}                            <div class="linechartDiv">                                <div class="lineChartChildDiv" id="linechart${data._id}"></div>                            </div>                        </li>                     {{/if}}                 </script>'}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btChatHistoryDetails",function(){return{restrict:"EAQ",scope:{cb:"=",nlpData:"=",type:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/botChatHistoryDetails/botChatHistoryDetails.html",
controller:["$scope","$window","$element","$timeout","$rootScope","env_conf","$routeParams","$workflowService","$applicationService","BTFlowtaskService","NotificationService","BTStreamsService","channelsConfig","i18n",function($scope,$window,$element,$timeout,$rootScope,env_conf,$routeParams,$workflowService,$applicationService,BTFlowtaskService,NotificationService,BTStreamsService,channelsConfig,i18n){function init(type,dateObj,dateRange,dateRangeObj,timeStampValue,sessionuserIdValue){$scope.cb.loading=!0,$scope.startDate="",$scope.endDate="";var channels=[];if($scope.limit=4,$scope.checkbox={},$scope.checkbox.selected=!0,$scope.startDateMilliseconds="",$scope.endDateMilliseconds="",$scope.conversationSessions=[],$scope.duplicateConversationArray=[],$scope.orderType="-sessionEndTime","conversation"==type||"conversation"==$scope.cb.panelType){if(dateObj){$scope.filterComponent={startDate:dateObj.from,endDate:dateObj.to};var dateObjCustom=getISOdates(dateObj.days,$scope.filterComponent);$scope.startDate=dateObjCustom.from,$scope.endDate=dateObjCustom.to}else if(dateRange){$scope.filterComponent={startDate:dateRange.startDate,endDate:dateRange.endDate};var dateRangeCustom=getISOdates($scope.days,$scope.filterComponent);$scope.startDate=dateRangeCustom.from,$scope.endDate=dateRangeCustom.to}else if(dateRangeObj){$scope.filterComponent={startDate:dateRangeObj.startDate,endDate:dateRangeObj.endDate};var dateRangeObjCustom=getISOdates($scope.days,$scope.filterComponent);$scope.startDate=dateRangeObjCustom.from,$scope.endDate=dateRangeObjCustom.to}var params={from:$scope.startDate,to:$scope.endDate,userId:sessionuserIdValue,streamId:$workflowService.selectedStream()._id,show:"all"};$scope.startDate=moment(params.from).format("MM-DD-YYYY"),$scope.endDate=moment(params.to).format("MM-DD-YYYY"),BTStreamsService.userConversation(params).then(function(res){console.log(res),$scope.conversationSessions=res.data.conversationSessions,$scope.dialogFlow=[],$scope.resolvedFields=res.data.resolvedFields;var count=-1;_.forEach($scope.conversationSessions,function(conversation){if($scope.sessionStartDate=new Date(conversation.sessionStartTime),$scope.sessionEndDate=new Date(conversation.sessionEndTime),count+=1,$scope.startDateMilliseconds=new Date(conversation.sessionStartTime).getTime(),$scope.endDateMilliseconds=new Date(conversation.sessionEndTime).getTime(),$scope.timeStampValue=timeStampValue,$scope.timeStampValue>=$scope.startDateMilliseconds&&$scope.timeStampValue<=$scope.endDateMilliseconds){conversation.active=!0}else{var countValues=count;setTimeout(function(){(!$("#collapse"+countValues).hasClass("collapse")||$("#collapse"+countValues).hasClass("in"))&&($("#collapse"+countValues).removeClass("in"),conversation.active=!1)},0)}var showCount=count;setTimeout(function(){$("#collapse"+showCount).find(".showMoreData")&&$("#collapse"+showCount).find(".showMoreData").text()&&$("#collapse"+showCount).find(".showMoreData").text().length&&$("#collapse"+showCount).find(".showMoreData").text().length<900?(conversation.showMoreButton=!1,conversation.showLessButton=!1):conversation.showMoreButton=!0},0),conversation.dialogFlow&&($scope.dialogFlow=conversation.dialogFlow,conversation.dialogFlow=[],_.forEach($scope.dialogFlow,function(dialog){conversation.dialogFlow.push(dialog)}),_.forEach(conversation.dialogFlow,function(eachdialog){var conversationValues={};if(_.forEach($scope.resolvedFields.tasks,function(resolvedField){eachdialog.taskId==resolvedField._id&&(conversation.conversationPaths||(conversation.conversationPaths=[]),conversationValues=resolvedField)}),conversationValues&&conversationValues.localeData||conversationValues&&conversationValues.questionPayload){var dialogValues={};conversationValues&&conversationValues.localeData&&conversationValues.localeData.en&&conversationValues.localeData.en.name&&(dialogValues={name:conversationValues.localeData.en.name,result:eachdialog.result}),conversationValues&&conversationValues.questionPayload&&conversationValues.questionPayload.question&&(dialogValues={name:conversationValues.questionPayload.question,result:eachdialog.result}),conversation.conversationPaths.push(dialogValues),conversationValues={}}else{conversation.conversationPaths||(conversation.conversationPaths=[]);var dialogValue={name:"Deleted "+eachdialog.taskType+" "+eachdialog.taskId,result:eachdialog.result};conversation.conversationPaths.push(dialogValue)}}))}),console.log($scope.conversationSessions),$scope.conversationSessionsCopy=angular.copy($scope.conversationSessions),channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channelsConfig=channelsConfig,_.forEach($scope.conversationSessions,function(conversation){var objectKeys=Object.keys(conversation);_.forEach(objectKeys,function(key){if("channel"==key){var channelsArray={key:conversation[key],selected:!0,name:channelsConfig.channelsObject[conversation.channel].name};channels.push(channelsArray)}})}),_.forEach(channels,function(channel){var isExisting=!1;$scope.duplicateConversationArray.length?(_.forEach($scope.duplicateConversationArray,function(val){val.key==channel.key&&(isExisting=!0)}),isExisting||$scope.duplicateConversationArray.push(channel)):$scope.duplicateConversationArray.push(channel)}),$scope.cb.loading=!1,setTimeout(function(){$(".conversationSession .dropdown.dropdown-open.open").length&&$(".conversationSession .dropdown.dropdown-open").removeClass("open")},0)},function(err){$scope.isWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}),$scope.appliedSelectedDays=angular.copy($scope.days)}else if("profile"==type||"profile"==$scope.cb.panelType){var param={userId:sessionuserIdValue,streamId:$workflowService.selectedStream()._id,show:"all"};BTStreamsService.userProfileDetails(param).then(function(res){console.log(res),$scope.koreUserId=sessionuserIdValue,$scope.userProfile=res.data,channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channelsConfig=channelsConfig,$scope.recentConversationFlows={},$scope.recentConversationFlows.result=[],$scope.recentConversationFlows.tasks=[],res.data.recentConversationFlows&&res.data.recentConversationFlows.result&&($scope.result=res.data.recentConversationFlows.result),res.data.recentConversationFlows&&res.data.recentConversationFlows.tasks&&($scope.tasks=res.data.recentConversationFlows.tasks),_.forEach($scope.result,function(result){$scope.recentConversationFlows.result.push(result)}),_.forEach($scope.tasks,function(task){$scope.recentConversationFlows.tasks.push(task)}),$scope.recentFlowData=[],_.forEach($scope.recentConversationFlows.result,function(resultData){var eachRecentData=[],recentTaskData={};_.forEach(resultData.dialogFlow,function(dialogFlowData){var taskValues={};_.forEach($scope.recentConversationFlows.tasks,function(taskData){dialogFlowData.taskId==taskData._id&&(taskValues=taskData)}),taskValues&&taskValues.localeData||taskValues&&taskValues.questionPayload?(taskValues&&taskValues.localeData&&taskValues.localeData.en&&taskValues.localeData.en.name&&(recentTaskData={name:taskValues.localeData.en.name,result:dialogFlowData.result}),taskValues&&taskValues.questionPayload&&taskValues.questionPayload.question&&(recentTaskData={name:taskValues.questionPayload.question,result:dialogFlowData.result}),eachRecentData.push(recentTaskData),taskValues={}):(recentTaskData={name:"Deleted "+dialogFlowData.taskType+" "+dialogFlowData.taskId,result:dialogFlowData.result},eachRecentData.push(recentTaskData))}),$scope.recentFlowData.push(eachRecentData)}),$scope.cb.loading=!1},function(err){$scope.isWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})}}function getISOdates(days,filterComponent){filterComponent&&($scope.filterComponent=filterComponent);var dateObj={};return-1===days?(dateObj.from=$scope.filterComponent.startDate.toISOString(),dateObj.to=$scope.filterComponent.endDate.toISOString()):(dateObj.from=moment().subtract(days,"d").toISOString(),dateObj.to=moment().toISOString()),dateObj}var daterangepickerInput;$scope.sessionuserId="",$scope.closeCross=env_conf["context-url"]+"/assets/icons/close-new.svg",$scope.sortIcon=env_conf["context-url"]+"/assets/landingImages/sort.svg",$scope.dropDownIcon=env_conf["context-url"]+"/assets/landingImages/dropdown.svg",$scope.chevronRight=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-right-gray.svg",$scope.iscollapsed=function(ele,event,conversationSession,index){var count=-1;_.forEach($scope.conversationSessions,function(conversationForIndex){count+=1,count!=index&&conversationForIndex.active&&(conversationForIndex.active=!1)}),conversationSession.active?conversationSession.active=!1:conversationSession.active=!0},$scope.collapseAccordion=function(ele,event,channelData,index){var count=-1;_.forEach($scope.userProfile.channelData,function(channelIndex){count+=1,count!=index&&channelIndex.active&&(channelIndex.active=!1)}),channelData.active?channelData.active=!1:channelData.active=!0},$scope.checkbox={selected:!0},$scope.selectCheckbox=function(channel,event){if(console.log(event.target.tagName),"selectAll"==channel)$scope.checkbox.selected?($scope.conversationSessions=[],_.forEach($scope.duplicateConversationArray,function(val){val.selected=!0}),$scope.conversationSessions=angular.copy($scope.conversationSessionsCopy)):$scope.checkbox.selected||($scope.conversationSessions=[],_.forEach($scope.duplicateConversationArray,function(val){val.selected=!1}));else{$scope.checkbox.selected=!1,$scope.conversationSessions=[];var count=0;channel.selected&&_.forEach($scope.conversationSessionsCopy,function(conversation){conversation.channel==channel.key&&channel.selected&&$scope.conversationSessions.push(conversation)}),_.forEach($scope.conversationSessionsCopy,function(conversation){_.forEach($scope.duplicateConversationArray,function(val){conversation.channel==val.key&&val.key!==channel.key&&val.selected&&$scope.conversationSessions.push(conversation)})}),_.forEach($scope.duplicateConversationArray,function(val){val.selected&&(count+=1)}),count==$scope.duplicateConversationArray.length&&($scope.checkbox.selected=!0)}},$scope.showMore=function(conversationSession,event){$(event.currentTarget).parent().removeClass("showMoreData"),conversationSession.showMoreButton=!1,conversationSession.showLessButton=!0,event.stopPropagation()},$scope.showLess=function(conversationSession,event){$(event.currentTarget).parent().addClass("showMoreData"),conversationSession.showMoreButton=!0,conversationSession.showLessButton=!1,event.stopPropagation()},$scope.sortTaskList=function(sortType){"startDate"==sortType&&("sessionStartTime"==$scope.orderType?$scope.orderType="-sessionStartTime":$scope.orderType="sessionStartTime"),"endDate"==sortType&&("sessionEndTime"==$scope.orderType?$scope.orderType="-sessionEndTime":$scope.orderType="sessionEndTime")},$scope.cb.initPanel=function(type,dateObj,timeStampValue,sessionuserId){$scope.days=dateObj.days,$timeout(function(){daterangepickerInput=$('.mainConversationcomponent div[name="daterange"]').daterangepicker({startDate:moment(new Date($scope.startDate)).startOf("hour").format("MM-DD-YYYY")||moment(),endDate:moment(new Date($scope.endDate)).startOf("hour").add(32,"hour").format("MM-DD-YYYY")||moment(),maxDate:moment(),opens:"left",timePicker:!1,customClass:"analyze-datepicker"}),$('.mainConversationcomponent div[name="daterange"]').on("apply.daterangepicker",function(ev,picker){$scope.appliedSelectedDays=-1,ev&&($scope.startDate=picker.startDate._d,$scope.endDate=picker.endDate._d),moment()._d.getDate()===$scope.endDate.getDate()&&moment()._d.getDay()===$scope.endDate.getDay()&&moment()._d.getYear()===$scope.endDate.getYear()&&($scope.endDate=moment()._d);var dateRange={};dateRange.startDate=$scope.startDate,dateRange.endDate=$scope.endDate,dateRange.appliedSelectedDays=$scope.appliedSelectedDays,init("conversation","",dateRange,"","",$scope.sessionuserId)}),$('.mainConversationcomponent div[name="daterange"]').on("cancel.daterangepicker",function(){7==$scope.appliedSelectedDays?($('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):-1!==$scope.appliedSelectedDays&&($('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),$scope.days=$scope.appliedSelectedDays}),$('.mainConversationcomponent div[name="daterange"]').on("outsideClick.daterangepicker",function(){7==$scope.appliedSelectedDays?($('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):-1!==$scope.appliedSelectedDays&&($('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),$scope.days=$scope.appliedSelectedDays})},300),$scope.sessionuserId=sessionuserId||$scope.sessionuserId,init(type,dateObj,"","",timeStampValue,$scope.sessionuserId)},$scope.closePanel=function(){$scope.cb.closeProfilePanel()},$scope.getDefaultFilters=function(days){$scope.days=days;var dateRangeObj={};-1!==days&&($scope.appliedSelectedDays=days),-1!==days&&($scope.endDate=moment().toISOString(),$scope.startDate=moment().subtract(days,"d").toISOString(),dateRangeObj.startDate=moment($scope.startDate),dateRangeObj.endDate=moment($scope.endDate),dateRangeObj.appliedSelectedDays=$scope.appliedSelectedDays,init("conversation","","",dateRangeObj,"",$scope.sessionuserId)),-1==days&&(7==$scope.appliedSelectedDays?($('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),dateRangeObj.startDate=moment($scope.startDate),dateRangeObj.endDate=moment($scope.endDate),dateRangeObj.appliedSelectedDays=$scope.appliedSelectedDays):1==$scope.appliedSelectedDays&&($('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('.mainConversationcomponent div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),dateRangeObj.startDate=moment($scope.startDate),dateRangeObj.endDate=moment($scope.endDate),dateRangeObj.appliedSelectedDays=$scope.appliedSelectedDays))},$scope.getDate=function(timestamp){var date=new Date(timestamp);return date=moment().format("MM-DD-YYYY")}}]}}),_module.filter("channelNameDisp",function(){return function(input){return"googleactions"===input?"Google Assistant":"hangoutchat"===input?"Hangouts Chat":input}})}(angular),function(ng){var _mod=ng.module("bt-forms");_mod.directive("botPublish",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bots-landing-forms/bot-publish/bot-publish.html",controller:"botPublishCtrl"}}]),_mod.controller("botPublishCtrl",["$scope","$rootScope","$q","env_conf","$routeParams","$location","$applicationService","$translator","BTAlertsService","BTActionsService","BTFlowtaskService","BTStreamsService","BTTeamsService","NotificationService","BTParamMapService","form_util","$workflowService","flowsUtil","$timeout","BTIdpService","BTFileUploadService","$element","$endpoints","channelsConfig","localstore","i18n","mixPanel",function($scope,$rootScope,$q,env_conf,$routeParams,$location,$applicationService,$translator,BTAlertsService,BTActionsService,BTFlowtaskService,BTStreamsService,BTTeamsService,NotificationService,BTParamMapService,form_util,$workflowService,flowsUtil,$timeout,BTIdpService,BTFileUploadService,$element,$endpoints,channelsConfig,localstore,i18n,mixPanel){function updateStream(stream){$scope.stream=stream||$workflowService.selectedStream(),$scope.publishViews.solutionBotPublish||"solution"==$scope.stream.type?$scope.stream.publishType="smartbot":$scope.publishViews.sampleBotPublish||"sample"==$scope.stream.type?$scope.stream.publishType="samplebot":$scope.stream.publishType="standardbot",_.forEach($scope.stream.supportedLanguages,function(value){$scope.stream.multiLingualConfigurations&&Object.keys($scope.stream.multiLingualConfigurations)?$scope.inputGenericTranslation=!0:$scope.stream.enableInputTranslation||"ge"!==value||($scope.inputGenericTranslation=!1)}),$scope.checkForGenericLanguage()}function getDeletedLanguages(){var _totalPublishedLang=[],result=[];if($scope.stream&&$scope.stream.languageConfigurations&&null!==$scope.stream.languageConfigurations){$scope.stream&&$scope.stream.taskApprovedLanguages&&(_totalPublishedLang=_totalPublishedLang.concat($scope.stream.taskApprovedLanguages)),$scope.stream&&$scope.stream.publishedDisabledLangs&&$scope.stream.publishedDisabledLangs.length&&(_totalPublishedLang=_totalPublishedLang.concat($scope.stream.publishedDisabledLangs));var _configuredLangs=Object.keys($scope.stream.languageConfigurations);return result=_.filter(_totalPublishedLang,function(lang){return-1===_configuredLangs.indexOf(lang)?lang:void 0})}return result}function mapValues(fn){var result=fn();return result&&result.length?_.filter(availableLanguages,function(lang){return-1!==result.indexOf(lang.value)?lang:void 0}):result}function prepareChannelData(){$scope.enabledChannelsForBot={channelTypes:[],channelNames:[]};var channels=[];if($scope.approvedChannels=[],channelsConfig.getDynamicChannels($scope.stream),$scope.allChannels=angular.copy(channelsConfig.channelsObject),$scope.stream&&$scope.stream.channels&&$scope.stream.channels.length&&$scope.stream.channels.map(function(channel){channel.enable&&($scope.enabledChannelsForBot.channelTypes.push(channel.type),$scope.enabledChannelsForBot.channelNames.push(channel.name))}),$scope.stream&&$scope.stream.hasOwnProperty("channelStatus"))if($scope.stream.channelStatus){Object.keys($scope.stream.channelStatus).map(function(k){var channelObj={};return void 0===$scope.allChannels[k]||"Webhook"===$scope.allChannels[k].name?(channelObj.name=$scope.stream.channelStatus[k].name,channelObj.type=k,channelObj.selected=!0,channelObj.icon=env_conf["context-url"]+"/img/webhook.png",channelObj.status=$scope.stream.channelStatus[k].state,channels.push(channelObj),$scope.approvedChannels.push(k),[{k:$scope.stream.channelStatus[k]}]):(channelObj.name=$scope.allChannels[k].name,channelObj.type=$scope.allChannels[k].id,channelObj.selected=!0,channelObj.icon=$scope.allChannels[k].icon,channelObj.status=$scope.stream.channelStatus[k].state||$scope.stream.channelStatus[k],channels.push(channelObj),$scope.approvedChannels.push($scope.allChannels[k].id),[{k:$scope.stream.channelStatus[k]}])})}else channels=[];else $scope.stream.channels.map(function(channel){var channelObj={};channelObj.name=$scope.allChannels[channel.type].name,channelObj.type=$scope.allChannels[channel.type].id,channelObj.selected=!0,channelObj.icon=$scope.allChannels[channel.type].icon,channels.push(channelObj),$scope.approvedChannels.push($scope.allChannels[channel.type].id)});if($scope.stream.channels.length>0&&channels.length>0){var rcs=$scope.stream.channels.filter(function(val){return"rcs"===val.type});rcs&&rcs[0]&&"readyToTest"!==rcs[0].state&&(channels=channels.filter(function(val){return"rcs"!==val.type}),$scope.approvedChannels=$scope.approvedChannels.filter(function(val){return"rcs"!==val}))}return channels}function getLangName(lan){return _.filter($scope.languages.disabledLanguages,{value:lan})[0].name}function getDomain(email){if(email){var atRateIndex=email.indexOf("@");return email.substr(atRateIndex+1)}}function getAppControls(){var url="mp.user.appControlList",params={userId:currentUser.userInfo.id};return $translator.translate(url,params)}function hasOptionsStep(){return!0}function prepareStepsAndViews(){$scope.steps=[{name:"Publish",id:"defineDeployment"},{name:"Enable try mode",id:"enableTryMode"},{name:"Options",id:"options"}]}function showStep(stepNo){("private"!=$scope.stream.visibility.namespace||advsettingsFirstTimepublish())&&(tasksSelected()||advSettSelected()||(NotificationService.notify(i18n.i18nString("please_select_atleast_one_task_module_noty"),"warning"),stepNo=$scope.currentStep),$scope.currentStep=stepNo,$scope.steps.map(function(step,index){index===$scope.currentStep?step.active=!0:step.active=!1}),collectSelectedTasks())}function checkUpgrade(task){var deferred=$q.defer();return"l"===task._id[0]?BTAlertsService.checkUpgrade(task._id).then(function(res){task.upgradeInfo=res.data,task.versionType="selectable"===task.upgradeInfo.versionChange?"minor":task.upgradeInfo.versionChange,task.upgradeType="mandatory",deferred.resolve(res)},function(err){deferred.reject(err),console.log(err)}):"a"===task._id[0]?BTActionsService.checkUpgrade(task._id).then(function(res){task.upgradeInfo=res.data,task.versionType="selectable"===task.upgradeInfo.versionChange?"minor":task.upgradeInfo.versionChange,task.upgradeType="mandatory",deferred.resolve(res)},function(err){deferred.reject(err),console.log(err)}):"d"===task._id[0]&&console.log("d"),deferred.promise}function fetchFlows(task){var taskInfo;taskInfo=$scope.allTasks.filter(function(item){return item._id==task.parentId})[0],taskInfo&&("l"===task._id[0]?$q.all([BTParamMapService.getMappedAlerts(task._id,taskInfo.version),BTParamMapService.getMappedDialogs(task._id,taskInfo.version)]).then(function(res){task.flows=flowsUtil.arrangeFlows(res[0].data),task.flows=task.flows.concat(flowsUtil.arrangeFlows(res[1].data))},function(err){task.flows=[]}):"a"===task._id[0]?BTParamMapService.getMappedActions(task._id,taskInfo.version).then(function(res){task.flows=flowsUtil.arrangeFlows(res.data)},function(err){task.flows=[]}):"d"===task._id[0]&&BTParamMapService.getMappedDialogs(task.parentId,taskInfo.version).then(function(res){task.flows=flowsUtil.arrangeFlows(res.data)},function(err){task.flows=[]}))}function assignFlowsToTask(){var deferred=$q.defer(),_promises=[];return $scope.alerts=$scope.alerts||[],$scope.actions=$scope.actions||[],$scope.information=$scope.information||[],$scope.dialogs=$scope.dialogs||[],$scope.alerts.map(function(alert){alert._selected=!0,alert.parentId&&(fetchFlows(alert),_promises.push(checkUpgrade(alert)))}),$scope.actions.map(function(action){action._selected=!0,action.parentId&&(fetchFlows(action),_promises.push(checkUpgrade(action)))}),$scope.information.map(function(info){info._selected=!0,info.parentId&&(fetchFlows(info),_promises.push(checkUpgrade(info)))}),$scope.dialogs.map(function(dialog){dialog._selected=!0,dialog.parentId&&($scope.configuredDialogFlowId=dialog._id,fetchFlows(dialog))}),$scope.panels.map(function(panel){panel._selected=!0}),$scope.widgets.map(function(widget){widget._selected=!0}),$scope.botUIForms.map(function(form){form._selected=!0}),$q.all(_promises).then(function(res){deferred.resolve()}),deferred.promise}function tasksSelected(){return collectSelectedTasks(),$scope.tasks.length>0||$scope.smallTalk.showSmallTalkComponent&&$scope.smallTalk._selected||$scope.selectedNodes.length>0||$scope.selectedRootTermQuestions.length>0}function advsettingsFirstTimepublish(){if(!tasksSelected())return NotificationService.notify(i18n.i18nString("please_select_atleast_one_task_to_publish"),"warning"),!1;if(!$scope.advancedPublishOptions.nl.selectedModules.length)return NotificationService.notify(i18n.i18nString("select_nl"),"warning"),!1;if(!$scope.advancedPublishOptions.channels.selectedModules.length)return NotificationService.notify(i18n.i18nString("select_channels"),"warning"),!1;if(!$scope.advancedPublishOptions.settings.selectedModules.length)return NotificationService.notify(i18n.i18nString("select_general_settings_noty"),"warning"),!1;if(!$scope.advancedPublishOptions.botLanguage.modules.enabledLanguages.length)return NotificationService.notify(i18n.i18nString("select_language"),"warning"),!1;if($scope.advancedPublishOptions.nl.selectedModules.length){var nlvalidator={};if($.each($scope.advancedPublishOptions.nl.selectedModules,function(i,mod){"settings"==mod&&(nlvalidator.settings=!0)}),!nlvalidator.settings)return NotificationService.notify(i18n.i18nString("select_nl_settings_noty"),"warning"),!1}if($scope.advancedPublishOptions.settings.selectedModules.length){var validator={};if($.each($scope.advancedPublishOptions.settings.selectedModules,function(i,mod){"general"==mod&&(validator.general=!0),"hold_resume"==mod&&(validator.hold_resume=!0),"advanced"==mod&&(validator.advanced=!0)}),!validator.general)return NotificationService.notify(i18n.i18nString("select_generalsettings"),"warning"),!1;if(!validator.hold_resume)return NotificationService.notify(i18n.i18nString("select_holdresume"),"warning"),!1;if(!validator.advanced)return NotificationService.notify(i18n.i18nString("select_advancesettings"),"warning"),!1}return!0}function advSettSelected(){return $scope.advancedPublishOptions.nl.selectedModules.length>0||$scope.advancedPublishOptions.settings.selectedModules.length>0||$scope.advancedPublishOptions.channels.selectedModules.length>0||$scope.advancedPublishOptions.extensions.selectedModules.length>0||$scope.advancedPublishOptions.botLanguage.modules.enabledLanguages&&$scope.advancedPublishOptions.botLanguage.modules.enabledLanguages.length>0||$scope.advancedPublishOptions.botLanguage.modules.disabledLanguages&&$scope.advancedPublishOptions.botLanguage.modules.disabledLanguages.length>0}function updateHasUpgradedTask(task){task.parentId&&($scope.hasUpgradedTasks=!0)}function collectSelectedTasks(){$scope.hasUpgradedTasks=!1,$scope.tasks=[],$scope.alerts=$scope.alerts||[],$scope.actions=$scope.actions||[],$scope.information=$scope.information||[],$scope.dialogs=$scope.dialogs||[],$scope.allNodesCollection=$scope.allNodesCollection||[],$scope.panels=$scope.panels||[],$scope.widgets=$scope.widgets||[],$scope.botUIForms=$scope.botUIForms||[],$scope.selectedNodes=[],$scope.selectedRootTermQuestions=[],$scope.alerts.map(function(alert){alert.approvedLanguages=angular.copy(alert.approvedLanguagesCopy),alert.approvedLangString=convertToString(alert.approvedLanguages),alert._selected&&($scope.streamPublishInfo.published&&(alert.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),alert.taskType="alert",updateHasUpgradedTask(alert),$scope.tasks.push(angular.copy(alert)))}),$scope.actions.map(function(action){action.approvedLanguages=angular.copy(action.approvedLanguagesCopy),action.approvedLangString=convertToString(action.approvedLanguages),action._selected&&($scope.streamPublishInfo.published&&(action.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),action.taskType="action",updateHasUpgradedTask(action),$scope.tasks.push(angular.copy(action)))}),$scope.information.map(function(info){info.approvedLanguages=angular.copy(info.approvedLanguagesCopy),info.approvedLangString=convertToString(info.approvedLanguages),info._selected&&($scope.streamPublishInfo.published&&(info.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),info.taskType="action",updateHasUpgradedTask(info),$scope.tasks.push(angular.copy(info)))}),$scope.dialogs.map(function(dialog){dialog.approvedLanguages=angular.copy(dialog.approvedLanguagesCopy),dialog.approvedLangString=convertToString(dialog.approvedLanguages),dialog._selected&&($scope.streamPublishInfo.published&&(dialog.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),dialog.taskType="dialog",updateHasUpgradedTask(dialog),$scope.tasks.push(angular.copy(dialog)))}),$scope.panels.map(function(panel){panel.approvedLanguages=angular.copy(panel.approvedLanguagesCopy),panel.approvedLangString=convertToString(panel.approvedLanguages),panel._selected&&($scope.streamPublishInfo.published&&(panel.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),panel.taskType="panel",updateHasUpgradedTask(panel),$scope.tasks.push(angular.copy(panel)))}),$scope.widgets.map(function(widget){widget.approvedLanguages=angular.copy(widget.approvedLanguagesCopy),widget.approvedLangString=convertToString(widget.approvedLanguages),widget._selected&&($scope.streamPublishInfo.published&&(widget.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),widget.taskType="widget",updateHasUpgradedTask(widget),$scope.tasks.push(angular.copy(widget)))}),$scope.botUIForms.map(function(form){form.approvedLanguages=angular.copy(form.approvedLanguagesCopy),form.approvedLangString=convertToString(form.approvedLanguages),form._selected&&($scope.streamPublishInfo.published&&(form.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),form.taskType="widget",updateHasUpgradedTask(form),$scope.tasks.push(angular.copy(form)))}),$.each($scope.allNodesCollection,function(i,allNodes){$.each(allNodes,function(i,node){node._selected&&node.parent&&node.parent.length>0&&$scope.selectedNodes.push(angular.copy(node))}),allNodes.rootTermQuestions._selected&&$scope.selectedRootTermQuestions.push(allNodes.rootTermQuestions)}),$scope.partialLanguageTasks=$scope.getPartialLanguageTasks($scope.tasks)||[],$scope.assignDefaultPublishDestination()}function publishBotTasks(payload){$scope.messages=[];var service="smartbot"==$scope.stream.publishType?BTStreamsService.solutionPublish:BTStreamsService.standardPublish;"samplebot"===$scope.stream.publishType&&(service=BTStreamsService.sampleBotPublish),$scope.allComponentsSelected?payload.publishAllComponents=!0:payload.publishAllComponents=!1,payload.versionComment=$scope.botPublishObject.upgradeVersionComment||"","default"===$scope.stream.type&&$scope.planSelectionCb&&$scope.planSelectionCb.publishSubmitToAdmin===!0&&(payload.doManualApproval=!0),$scope.checkDockStatus(),service($scope.stream._id,payload).then(function(res){function processTasks(){res.data.length&&res.data.map(function(message){var _msg=taskMap[message.resourceId];void 0===_msg&&(message.result&&message.result.name?_msg=message.result.name||message.result.resourceId:message.result&&"smalltalk"===message.resourceType&&!message.result.name&&(_msg="Small Talk")),"SUCCESS"===message.status?messages.push({type:"success",state:"published",message:$scope.streamPublishInfo.enterprise?_msg:_msg}):"FAILURE"===message.status&&messages.push({type:"error",error:getErrorMsg(message.result),message:_msg,context:getResource(payload,message.resourceId),taskId:message.resourceId})}),$scope.messages=messages,$scope.appControls.isBillingEnabled&&"sample"!==$scope.stream.type&&"solution"!==$scope.stream.type&&"private"===$scope.stream.visibility.namespace&&$scope.appControls&&$scope.selectedAccount.adminPreferences&&$scope.selectedAccount.adminPreferences.autoApproval&&$scope.selectedAccount.accountType&&1===$scope.selectedAccount.accountType?$scope.publishInTrailMsg=!0:$scope.publishInTrailMsg=!1,$scope.openModal()}var _publishConfigEvent={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Deploy","Channel Type":$scope.enabledChannelsForBot.channelTypes||[],"Channel Name":$scope.enabledChannelsForBot.channelNames||[]};mixPanel.postEvent("Deploy - Publish complete",_publishConfigEvent),$scope.$emit("updateChecklist","publish"),$scope.allowRetry=!0,$scope.publishInProgress=!1;var messages=[];$scope.taskState="";processTasks()},function(err){$scope.publishInProgress=!1,$scope.allowRetry=!0;var msg=err.data.errors[0].msg||i18n.i18nString("something_went_wrong_try_again");
NotificationService.notify(msg,"error")})}function publishTasks(payload){if($scope.showVisibiltyForSmartBot()||(delete payload.isChat,delete payload.isMention),$scope.alertDialogMappingsToPublish.length){var alertDialogMappingPayloadPromise=[];$scope.alertDialogMappingsToPublish=_.uniq($scope.alertDialogMappingsToPublish),$.each($scope.alertDialogMappingsToPublish,function(i,flow){var promise=BTStreamsService.publishAlertDialogFlow(flow);alertDialogMappingPayloadPromise.push(promise)}),$q.all(alertDialogMappingPayloadPromise).then(function(results){publishBotTasks(payload)},function(err){publishBotTasks(payload)})}else publishBotTasks(payload)}function getErrorMsg(message){var msg=message&&message.errors&&message.errors[0].msg||i18n.i18nString("something_went_wrong_try_again");return msg}function getResource(publishInfo,id){var payload={},resource=publishInfo.resources.filter(function(resource){return resource.resourceId===id});return"smartbot"==$scope.stream.publishType&&(payload={botDesc:publishInfo.botDesc,configInst:publishInfo.configInst,configInstURL:publishInfo.configInstURL}),payload.resources=resource,payload}function verifyFlowsStatus(callback){var errorMsg,ok=!0,allFilled=!0,namespaceTo=!0,messages=(i18n.i18nString("fill_publish"),{flow:i18n.i18nString("please_verify_all_the_flows"),upgrade:publishCommentWarnMsg+" "+i18n.i18nString("of_all_the_respective_tasks"),namespace:i18n.i18nString("please_select_the_destination")});return($scope.tasks||[]).map(function(task){"l"===task._id[0]&&"major"===task.versionType&&"mandatory"===task.upgradeType&&(task.parentId&&"manual"===task.upgradeInfo.upgrade?!task.parentId||task.upgradeShortMessage&&task.upgradeLongMessage||(allFilled=!1,errorMsg=i18n.i18nString("please_fill_up_short_and_long")):task.parentId&&"automatic"===task.upgradeInfo.upgrade&&"major"===task.versionType&&task.parentId&&!task.upgradeShortMessage&&(allFilled=!1,errorMsg=i18n.i18nString("please_fill_up_short_msg"))),$scope.botPublishObject.upgradeVersionComment||(allFilled=!1,errorMsg=messages.upgrade),task.namespaceTo||task.parentId||(namespaceTo=task.namespaceTo,errorMsg=messages.namespace),(task.flows||[]).map(function(flow){"active"!=flow.state&&(ok=!1)})}),$scope.tasks.length||!$scope.allNodesCollection||$scope.botPublishObject.upgradeVersionComment?void(ok?allFilled&&namespaceTo?checkForMandatoryFieldsOfSolutionBot(callback):NotificationService.notify(errorMsg,"warning"):(NotificationService.notify(messages.flow,"warning"),$timeout(function(){$(".alertsWrap .expandTask").click()},200))):void NotificationService.notify(publishCommentWarnMsg,"warning")}function checkForMandatoryFieldsOfSolutionBot(callback){var ok=!0;return ok?void checkForVersionTypeAndUpgrade(callback):void NotificationService.notify(i18n.i18nString("please_fill_up_all_required_fields"),"warning")}function checkForVersionTypeAndUpgrade(callback){var ok=!0;if(($scope.tasks||[]).map(function(task){task._id&&0===task._id.indexOf("dg-")||!task.parentId||task.upgradeType&&task.versionType||(ok=!1)}),!ok)return void NotificationService.notify(i18n.i18nString("please_upgrade_version_type_details"),"warning");if("smartbot"==$scope.stream.publishType)return void callback();if("smartbot"!==$scope.stream.publishType&&"samplebot"!==$scope.stream.publishType&&"public"===$scope.streamPublishInfo.namespaceTo&&!$scope.streamPublishInfo.botStoreSettingsCheck&&$rootScope.wfAdmin)return void NotificationService.notify(i18n.i18nString("please_check_to_confirm_bot_store_settings"),"warning");var confirmationMessage="",botVisbilityMessage="";"employee"===$scope.stream.purpose?botVisbilityMessage=i18n.i18nString("you_are_about_to_publish")+" <b>"+$scope.getTextIncludingTags($scope.stream.name)+" </b>"+i18n.i18nString("for_use_by_selected_users"):"customer"===$scope.stream.purpose&&(botVisbilityMessage=i18n.i18nString("auto_approve_to_publish",{plan:"<b>Standard</b>",link:"https://developer.kore.ai/docs/bots/chatbot-overview/koreai-platform/"})),confirmationMessage="enterprise"===$scope.streamPublishInfo.namespaceTo?botVisbilityMessage:i18n.i18nString("you_are_about_to_publish")+" <b>"+$scope.getTextIncludingTags($scope.stream.name)+" </b>"+i18n.i18nString("into_kore_ai_bots_store"),callback()}function deleteMapping(flow,index,task){flow.targetResourceId?BTParamMapService.deleteMappedAlertDialog(flow.mapId).then(function(res){task.flows.splice(index,1),NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("flow_deleted_sucess"),"success")},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),i18n.i18nString("flow_deletion_failed"),"error")}):BTParamMapService.deleteMappedAlertAction(flow.mapId).then(function(res){task.flows.splice(index,1),NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("flow_deleted_sucess"),"success")},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),i18n.i18nString("flow_deletion_failed"),"error")})}function isAnyCommunicationModeSelected(){return $scope.upgrade.isChat||$scope.upgrade.isMention}function convertToString(approvedLanguages){return approvedLanguages&&approvedLanguages.length?approvedLanguages.length<=2?approvedLanguages.join(", "):approvedLanguages[0]+", "+approvedLanguages[1]+"<span class='ovalcountcircle'>+"+(approvedLanguages.length-2)+"</span>":""}$scope.selectedAccount=$workflowService.selectedAccount(),$scope.showfreeTrailProTip=$scope.selectedAccount&&$scope.selectedAccount.licenses&&$scope.selectedAccount.licenses.length&&"free"===$scope.selectedAccount.licenses[0].costCateogory,$scope._constants_=$rootScope._constants_,$scope.freeTrailSupportUrl=$scope._constants_.config.freeTrailSupportUrl,$scope.selectedAccount=$workflowService.selectedAccount(),$scope.partialImportAllowed=!$scope.selectedAccount.platformVersion||!$scope.selectedAccount.accountType,$scope.allTasksSelected={isSelected:!0},$scope.selectAllLanguage={selected:!0},$scope.allTaskSelectionEle=!0,$scope.stream=$workflowService.selectedStream(),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.chevronRight=window.appConfig.CONTEXT_PATH+"/assets/icons-new/chevron/chevron-right-gray.svg",$scope.closeDark=window.appConfig.CONTEXT_PATH+"/assets/icons-new/close/close-dark.svg",$scope.chevronDownDark=window.appConfig.CONTEXT_PATH+"/assets/icons-new/chevron/chevron-down-dark.svg",$scope.appControls=$applicationService.userInfo().appControls,$scope.q_and_a_label=i18n.i18nString("q_and_a_label"),$scope.view_nodes_label=i18n.i18nString("view_nodes_label"),$scope.manage_nodes_label=i18n.i18nString("manage_nodes_label"),$scope.knowledge_graph=i18n.i18nString("knowledge_graph"),$scope.alert_tasks_label=i18n.i18nString("alert_tasks_label"),$scope.action_tasks_label=i18n.i18nString("action_tasks_label"),$scope.information_tasks_label=i18n.i18nString("information_tasks_label"),$scope.dialog_tasks_label=i18n.i18nString("dialog_tasks_label"),$scope.uiforms_label=i18n.i18nString("ui_forms_label"),$scope.panels_label=i18n.i18nString("panels_label"),$scope.widgets_label=i18n.i18nString("widgets_label"),$scope.upgrade_label=i18n.i18nString("upgrade"),$scope.new_deployment_label=i18n.i18nString("new_deployment_label"),$scope.show_less_label2=i18n.i18nString("show_less_label2"),$scope.tasks_label2=i18n.i18nString("tasks_label2"),$scope.retry_label=i18n.i18nString("retry"),$scope.retrying_label=i18n.i18nString("retrying_label"),$scope.retry_all=i18n.i18nString("retry_all"),$scope.saving_label=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.license={},$scope.planValidationDetails={},$scope.planValHeaders=[],$scope.planSelectionCb=$scope.planSelectionCb&&$scope.planSelectionCb.license?$scope.planSelectionCb:{},$scope.checkForGenericLanguage=function(){$scope.showGenericPublishProtip=!1,$scope.seedDataNluSupportedLanguages=$workflowService.seedData().nluSupportedLanguages,_.forEach($scope.stream.supportedLanguages,function(value){"ge"===value&&($scope.showGenericPublishProtip=!0)}),$workflowService.selectedStream().enableInputTranslation&&!$workflowService.selectedStream().multiLingualConfigurations?$scope.inputTranslation=!0:$workflowService.selectedStream().multiLingualConfigurations&&($scope.inputTranslation=!1)},updateStream($workflowService.selectedStream()),$scope.smallTalk={},$scope.smallTalk._selected=$scope.stream.isSmalltalkMigrated||!1,$scope.smallTalk.showSmallTalkComponent=$scope.stream.isSmalltalkMigrated||!1,$scope.checkUncheckSmallTalk=function(e,smallTalk){$scope.smallTalk&&$scope.smallTalk._selected?$scope.smallTalk._selected=!1:$scope.smallTalk._selected=!0,$timeout(function(){$scope.intermediateSelection(null,null,!0)},200)};var publishCommentWarnMsg=i18n.i18nString("fill_publish");$scope.stream&&$scope.stream.visibility&&"private"!==$scope.stream.visibility.namespace&&(publishCommentWarnMsg=i18n.i18nString("fill_upgrade")),$scope.assetsBase=env_conf["assets-url"];var availableLanguages=angular.copy($workflowService.seedData().supportedLanguages);$scope.enableDisableLanguages=$scope.stream.languageConfigurations?$scope.stream.languageConfigurations:$scope.stream.supportedLanguages,$scope.defaultLanguage=$scope.stream.defaultLanguage,$scope.languages={},$scope.languages.enabledLanguages=[],$scope.languages.disabledLanguages=[],$scope.languages.deletedLanguages=mapValues(getDeletedLanguages),$scope.languages.enabledLanguages=_.filter(availableLanguages,function(lan){return $scope.enableDisableLanguages[lan.value]&&$scope.enableDisableLanguages[lan.value].hasOwnProperty("enabled")&&$scope.enableDisableLanguages[lan.value].enabled?(lan.enabled=$scope.enableDisableLanguages[lan.value].enabled,lan.selected=!0,lan):void 0}),$scope.languages.disabledLanguages=_.filter(availableLanguages,function(lan){return $scope.enableDisableLanguages[lan.value]&&$scope.enableDisableLanguages[lan.value].hasOwnProperty("enabled")&&!$scope.enableDisableLanguages[lan.value].enabled?(lan.enabled=$scope.enableDisableLanguages[lan.value].enabled,lan.selected=!0,lan):void 0}),$scope.languages.disabledLanguages&&($scope.languages.disabledLanguages=_.map($scope.languages.disabledLanguages,function(language){return $scope.stream.publishedDisabledLangs&&$scope.stream.publishedDisabledLangs.length&&$scope.stream.publishedDisabledLangs.indexOf(language.value)>=0?language.isDisabled=!0:language.isDisabled=!1,language})),$scope.languages.enabledLanguages&&($scope.languages.enabledLanguages=_.map($scope.languages.enabledLanguages,function(language){return $scope.stream.taskApprovedLanguages&&$scope.stream.taskApprovedLanguages.indexOf(language.value)>=0?language.isDisabled=!0:language.isDisabled=!1,language})),$scope.enabledChannelsForBot={channelTypes:[],channelNames:[]},$scope.advancedPublishOptions={nl:{resourceId:"NL",resourceType:"NL",allSelected:!0,selectedNlpData:"full",allModules:[{type:"nl_model",name:i18n.i18nString("Bt_publish_nl_model_label"),selected:!0,discription:i18n.i18nString("Bt_publish_nl_model_desc")},{type:"settings",name:i18n.i18nString("Bt_publish_settings_label"),selected:!0,discription:i18n.i18nString("Bt_publish_settings_shortdesc")}],selectedModules:["nl_model","settings"],approvalRequestedLanguages:["en"]},botLanguage:{resourceId:"BOTLANGUAGES",resourceType:"BOTLANGUAGES",modules:{}},channels:{resourceId:"CHANNELS",resourceType:"CHANNELS",allSelected:!0,allModules:prepareChannelData(),selectedModules:$scope.approvedChannels,approvalRequestedLanguages:["en"]},extensions:{resourceId:"EXTENSIONS",resourceType:"EXTENSIONS",allSelected:!0,allModules:[{type:"events",name:i18n.i18nString("event_handlers"),selected:!0},{type:"botkit",name:i18n.i18nString("bot_kit_label"),selected:!0},{type:"agent_transfer",name:i18n.i18nString("agent_transfer"),selected:!0},{type:"websdk",name:i18n.i18nString("web_mobile_sdk"),selected:!0}],selectedModules:["botkit","agent_transfer","websdk","events"],approvalRequestedLanguages:["en"]},settings:{resourceId:"SETTINGS",resourceType:"SETTINGS",allSelected:!0,allModules:[{type:"general",name:i18n.i18nString("generalSettings"),selected:!0},{type:"bot_variables",name:i18n.i18nString("bot_variables"),selected:!0},{type:"pii",name:i18n.i18nString("pii_settings"),selected:!0},{type:"ivr",name:i18n.i18nString("ivr_properties_normal"),selected:!0},{type:"hold_resume",name:i18n.i18nString("hold_and_resume"),selected:!0},{type:"custom_script",name:i18n.i18nString("custom_script"),selected:!0},{type:"advanced",name:i18n.i18nString("advanced_settings"),selected:!0}],selectedModules:["general","bot_variables","pii","ivr","hold_resume","custom_script","advanced"],approvalRequestedLanguages:["en"]}},$scope.languages.enabledLanguages.length&&($scope.enabledLanguages=_.pluck($scope.languages.enabledLanguages,"value"),$scope.advancedPublishOptions.botLanguage.modules.enabledLanguages=$scope.enabledLanguages),$scope.languages.disabledLanguages.length&&($scope.disabledLanguages=_.pluck($scope.languages.disabledLanguages,"value"),$scope.advancedPublishOptions.botLanguage.modules.disabledLanguages=$scope.disabledLanguages),$scope.checkOrUncheckAlltasks=function(value,event){event&&event.stopPropagation(),value.isSelected=!value.isSelected,$scope.allTasksSelected.selectAllAlerts=value.isSelected,$scope.selectAll($scope.allTasksSelected.selectAllAlerts,".publishAlertTask"),$scope.allTasksSelected.selectAllActions=value.isSelected,$scope.selectAll($scope.allTasksSelected.selectAllActions,".publishActionTask"),$scope.allTasksSelected.selectAllDialogTask=value.isSelected,$scope.selectAll($scope.allTasksSelected.selectAllDialogTask,".publishDialogTask"),$scope.allTasksSelected.selectAllPanelTasks=value.isSelected,$scope.selectAll($scope.allTasksSelected.selectAllPanelTasks,".publishPanelTask"),$scope.allTasksSelected.selectAllWidgetTasks=value.isSelected,$scope.selectAll($scope.allTasksSelected.selectAllWidgetTasks,".publishWidgetTask"),$scope.allTasksSelected.selectAllFormTask=value.isSelected,$scope.selectAll($scope.allTasksSelected.selectAllFormTask,".publishFormTask"),$scope.allTasksSelected.selectAllInformation=value.isSelected,$scope.selectAll($scope.allTasksSelected.selectAllInformation,".publishInfoTask"),$scope.smallTalk._selected=value.isSelected,$.each($scope.allNodesCollection,function(i,allNodes){allNodes[0]._selected=value.isSelected,$scope.checkUncheckNodes(null,allNodes[0],allNodes)}),$scope.allTasksSelected.selectAllAlerts=value.isSelected,$scope.allTasksSelected.selectAllKgs=value.isSelected,$(".kgCheckBox").click()},$scope.selectAllLanguages=function(event,value,type){event.stopPropagation(),$scope.advancedPublishOptions[type].modules={},$scope.advancedPublishOptions[type].modules.enabledLanguages=[],$scope.advancedPublishOptions[type].modules.disabledLanguages=[],_.map($scope.languages.enabledLanguages,function(language){language.selected=value.selected,value.selected&&$scope.advancedPublishOptions[type].modules.enabledLanguages.push(language.value)}),_.map($scope.languages.disabledLanguages,function(language){language.selected=value.selected,value.selected&&$scope.advancedPublishOptions[type].modules.disabledLanguages.push(language.value)})},$scope.checkUncheckLanguage=function(element,parent,type){if($scope.advancedPublishOptions[type].modules={},$scope.advancedPublishOptions[type].modules.enabledLanguages=[],$scope.advancedPublishOptions[type].modules.disabledLanguages=[],$scope.languages&&$scope.languages.enabledLanguages&&($scope.unPublishLang=_.filter($scope.languages.enabledLanguages,{selected:!1}),_.map($scope.languages.enabledLanguages,function(language){language.selected&&$scope.advancedPublishOptions[type].modules.enabledLanguages.push(language.value)})),$scope.languages&&$scope.languages.disabledLanguages&&_.map($scope.languages.disabledLanguages,function(language){language.selected&&$scope.advancedPublishOptions[type].modules.disabledLanguages.push(language.value)}),$scope.advancedPublishOptions[type].modules.disabledLanguages.length){var lang=[];_.map($scope.advancedPublishOptions[type].modules.disabledLanguages,function(lan,index){var langName=getLangName(lan);lang.push(langName)})}$scope.intermediateSelection(element,parent)},$scope.selectAllAdvanced=function(type,value,event){event&&event.stopPropagation(),$scope.advancedPublishOptions[type].selectedModules=[],value.allSelected=!value.allSelected,$scope.advancedPublishOptions[type].allModules.map(function(module){module.selected=value.allSelected,value.allSelected&&$scope.advancedPublishOptions[type].selectedModules.push(module.type)})},$scope.changeAdvPubControls=function(e,module,control,element,parent){control.selectedModules=[],control.allModules.map(function(module){module.selected&&control.selectedModules.push(module.type)}),$scope.intermediateSelection(element,parent)},$scope.intermediateSelection=function(element,parent,checkAllTasks){function doChecks(ele,par){for(var checkboxes=$(ele).find("input"),checkall=$(par),checkedCount=$(ele).find("input:checked").length,i=0;i<checkboxes.length;i++)checkall[0].checked=checkedCount>0,checkall[0].indeterminate=checkedCount>0&&checkedCount<checkboxes.length;checkAllTasks&&(checkall[0].checked&&!checkall[0].indeterminate?$scope.allTaskSelectionEle=!0:$scope.allTaskSelectionEle=!1)}element&&parent&&doChecks(element,parent),checkAllTasks&&doChecks("#alltasksBodyData","#allTasksCheckUncheck")},$scope.bindcheckBox=function(element,e){for(var checkboxes=document.querySelectorAll("input.thing"),checkall=document.getElementById("checkall"),i=0;i<checkboxes.length;i++)checkboxes[i].onclick=function(){var checkedCount=document.querySelectorAll("input.thing:checked").length;checkall.checked=checkedCount>0,checkall.indeterminate=checkedCount>0&&checkedCount<checkboxes.length}},$scope.currentLanguage=$workflowService.currentLanguage(),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.infoIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/informationIcon.svg",$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.seedSupportedLanguages=$workflowService.seedData().supportedLanguages,$scope.freePlan=$workflowService.seedData().freePlan||{},$scope.freePlan.validityStr=Math.round(moment.duration($scope.freePlan.validity,"minutes").asDays()),$scope.supportedLangMap={},$scope.seedSupportedLanguages&&$scope.seedSupportedLanguages.length&&$scope.seedSupportedLanguages.forEach(function(lang){$scope.supportedLangMap[lang.value]=lang.name}),updateStream($workflowService.selectedStream()),$scope.stream.showInMp=$scope.stream.showInMp||!1,$scope.authLists=null,$scope.dataloaded=!1,$scope.needAuth=!1,$scope.isTryModeUpdated=!1,$scope.account=[],$scope.trymodecallback={},$scope.botPublishObject={},$scope.currentStep=0,$scope.steps=[],$scope.tryMode=!1,$scope.alertDialogMappingsToPublish=[],$scope.publishInProgress=!1;var currentUser=localstore.getAuthData().currentAccount;if($scope.isDomainKore="kore"===getDomain(currentUser.userInfo.emailId).split(".")[0],getAppControls().then(function(res){$scope.appControls=res.data;var _selectedAccount=$workflowService.selectedAccount();if(_selectedAccount&&_selectedAccount.accountId){var selectedAccount=_.find($scope.appControls.associatedAccounts,{accountId:_selectedAccount.accountId});$scope.selectedAccount&&($workflowService.selectedAccount(selectedAccount),$scope.selectedAccount=$workflowService.selectedAccount())}}),$scope.showVisibilty=function(){return $rootScope.wfAdmin&&"customer"===$scope.stream.purpose&&"standardbot"===$scope.stream.publishType&&!$scope.stream.isInMarket&&$scope.isDomainKore},$scope.showVisibiltyForSmartBot=function(){return $rootScope.wfAdmin&&"smartbot"===$scope.stream.publishType&&$scope.isDomainKore},$scope.changeVisibility=function(){BTStreamsService.editStream($scope.stream._id,{showInMp:$scope.stream.showInMp}).then(function(response){$workflowService.selectedStream(angular.extend($scope.stream,response.data))},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.bulbSvg=env_conf["context-url"]+"/assets/images/bulbicon.svg",prepareStepsAndViews(),$scope.btTestFormApi={},$scope.btTestStatus={},0===Object.keys($scope.stream).length)return void $location.path(window.appConfig.CONTEXT_PATH);$scope.upgrade={description:$scope.stream.botDesc,instructions:$scope.stream.configInst,instructionsURL:$scope.stream.configInstURL,botType:$scope.stream.botType||"enterprise",isChat:!0,isMention:!0},$scope.canShowNext=function(){var knowledgelength=0;return $scope.knowledgeTasks&&$scope.knowledgeTasks.length&&$.each($scope.knowledgeTasks,function(i,knowledgeTask){knowledgeTask.faqCount>0&&(knowledgelength=1)}),($scope.alerts||[]).length||($scope.actions||[]).length||($scope.information||[]).length||($scope.dialogs||[]).length||($scope.allNodesCollection||[]).length>0&&knowledgelength>0||$scope.stream.isSmalltalkMigrated||($scope.widgets||[]).length||($scope.panels||[]).length||($scope.botUIForms||[]).length||"private"!==$scope.stream.visibility.namespace},$scope.currentStep="defineDeployment",$scope.navigateToStep=function(currentStep,level){$scope.currentStep=currentStep,"defineDeployment"==$scope.currentStep?$scope.updatePublishBC("Publish",level):"type"==$scope.currentStep?$scope.updatePublishBC("Type",level):"enableTryMode"==$scope.currentStep?$scope.updatePublishBC("Enable try mode",level):"options"==$scope.currentStep&&$scope.updatePublishBC("Options",level)},$scope.nextStep=function(){var _publishAttempt={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Deploy","Channel Type":$scope.enabledChannelsForBot.channelTypes||[],"Channel Name":$scope.enabledChannelsForBot.channelNames||[]};if("private"!=$scope.stream.visibility.namespace||advsettingsFirstTimepublish())if($scope.advancedPublishOptions.nl.allModules.length===$scope.advancedPublishOptions.nl.selectedModules.length?$scope.allNlSelectionEle=!0:$scope.allNlSelectionEle=!1,$scope.advancedPublishOptions.channels.allModules.length===$scope.advancedPublishOptions.channels.selectedModules.length?$scope.allChennalSelectionEle=!0:$scope.allChannalSelectionEle=!1,$scope.advancedPublishOptions.extensions.allModules.length===$scope.advancedPublishOptions.extensions.selectedModules.length?$scope.allApiSelectionEle=!0:$scope.allApiSelectionEle=!1,$scope.advancedPublishOptions.settings.allModules.length===$scope.advancedPublishOptions.settings.selectedModules.length?$scope.allSettingsSelectionEle=!0:$scope.allSettingsSelectionEle=!1,$scope.allTaskSelectionEle&&$scope.allNlSelectionEle&&$scope.allApiSelectionEle&&$scope.allSettingsSelectionEle&&$scope.allChennalSelectionEle?$scope.allComponentsSelected=!0:$scope.allComponentsSelected=!1,"defineDeployment"==$scope.currentStep){if(!tasksSelected()&&!advSettSelected())return NotificationService.notify(i18n.i18nString("please_select_atleast_one_task_component_noty"),"warning"),void(stepNo=$scope.currentStep);var isEventsSelected=$scope.advancedPublishOptions.extensions.allModules.filter(function(val){return"events"===val.type})[0].selected;if(!isEventsSelected){var isError=!1;if($scope.dialogs.length&&($scope.dialogs.forEach(function(val,ind){"configured"===val.state&&val.onTaskFailure&&val.onTaskFailure.enabled&&val._selected&&(NotificationService.notify(i18n.i18nString("please_include_event_handlers_noty"),"error"),isError=!0)}),isError))return}if(!hasOptionsStep())return void $scope.confirm();$scope.currentStep="options",mixPanel.postEvent("Deploy - Publish attempted",_publishAttempt),$scope.updatePublishBC("Options","secondLevel"),collectSelectedTasks()}else if("type"==$scope.currentStep){if(!tasksSelected())return NotificationService.notify(i18n.i18nString("please_select_atleast_one_task_to_publish"),"warning"),void(stepNo=$scope.currentStep);$scope.currentStep="options",$scope.updatePublishBC("Options","thirdLevel"),collectSelectedTasks()}else if("enableTryMode"==$scope.currentStep){var updateStep=function(){$scope.currentStep="options",$scope.updatePublishBC("Options","fourthLevel")};$scope.trymodecallback.updateTryMode("",updateStep)}},$scope.selectComponent=function(innerRightViewElement){$scope.$parent.setSubMenuToOpen(innerRightViewElement)},$scope.publishBotLoader=!1,$scope.deployStandardBot=function(){$scope.selectedAccount.adminPreferences&&$scope.selectedAccount.adminPreferences.autoApproval&&($scope.publishBotLoader=!0,$scope.closeCustomModal("prePublishWarning"),$scope.confirm(!0))},$scope.customPublishFlow=function(){$scope.planSelectionCb&&$scope.planSelectionCb.publishFreeBot&&$scope.openCustomModal("prePublishWarning")},$scope.checkPlanValidation=function(){$scope.planSelectionCb&&$scope.planSelectionCb.publishFreeBot?($scope.nextStep(),$scope.confirm()):$scope.planSelectionCb&&$scope.planSelectionCb.publishSubmitToAdmin&&($scope.nextStep(),$scope.confirm())},setTimeout(function(){$scope.checkPlanValidation()},100),$scope.openPlanUsage=function(planType){$scope.closeCustomModal("upDownRequired"),"plan"===planType?($scope.planSelectionCb.page="publish",$scope.planSelectionCb.planSelection=!0,$scope.planSelectionCb.supportSelection=!1):"support"===planType&&($scope.planSelectionCb.planSelection=!1,$scope.planSelectionCb.supportSelection=!0),$scope.planSelectionCb.license=$scope.license,$scope.planSelectionCb.plansSlider=!0},$scope.planSelectionCb.close=function(){$scope.closeModalSlider("#managePlanSelectionSlider")},$scope.checkPlanDetails=function(){$scope.planValidationDetails&&$scope.planValidationDetails.warningMessage&&$scope.license&&$scope.license.planName&&$scope.openCustomModal("upDownRequired")},$scope.closePlanValidation=function(){$("#planValidationModal").modal("hide")},$scope.openCustomModal=function(targetId){targetId&&$("#"+targetId).modal("show")},$scope.closeCustomModal=function(targetId){targetId&&$("#"+targetId).modal("hide")},$scope.getLicenseInfo=function(){BTStreamsService.getBTStream($scope.streamId).then(function(res){$workflowService.selectedStream(res.data),updateStream($workflowService.selectedStream()),$scope.stream&&"default"===$scope.stream.type&&1===$scope.selectedAccount.accountType?($scope.stream.license&&($scope.license=$scope.stream.license,$scope.license.totalCredits=$scope.license.baseAllowedCredits+$scope.license.extraCredits-$scope.license.creditsUsed,$scope.license.totalSessions=$scope.license.baseAllowedSessions+$scope.license.extraSessions-$scope.license.sessionsUsed,$scope.license.totalRequests=$scope.license.baseAllowedRequests-$scope.license.requestsUsed),$scope.stream.planValidationDetails&&$scope.license&&($scope.planValidationDetails=$scope.stream.planValidationDetails,$scope.planValidationDetails&&($scope.planValHeaders=Object.keys($scope.planValidationDetails.exceededData))),console.log("Plan exceed details",$scope.planValidationDetails)):("default"!==$scope.stream.type||1!==$scope.selectedAccount.accountType)&&($scope.license=null)},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.getLicenseInfo(),$scope.checkPublishModal=function(){return $scope.planSelectionCb.publishSubmitToAdmin?"ADMIN":$scope.planSelectionCb.publishFreeBot?"FREE":$scope.planSelectionCb.publishPaidBot?"PAID":$scope.license&&$scope.license.planName&&"paid"===$scope.license.billingType?"SUBSEQUENT":$scope.selectedAccount.adminPreferences&&$scope.selectedAccount.adminPreferences.autoApproval===!1?"MANUAL":"DEFAULT"},$scope.previousStep=function(){if("options"==$scope.currentStep)$scope.currentStep="defineDeployment",$scope.updatePublishBC("Publish","firstLevel");else if("enableTryMode"==$scope.currentStep){if($scope.publishViews.solutionBotPublish)return $scope.currentStep="defineDeployment",void $scope.updatePublishBC("Publish","firstLevel");$scope.currentStep="type",$scope.updatePublishBC("Type","secondLevel")}else"type"==$scope.currentStep&&($scope.currentStep="defineDeployment",$scope.updatePublishBC("Publish","firstLevel"))},$scope.updatePublishBC=function(name,actionType){var _selectedStep=_.find($scope.steps,{name:name}),arr_breadCrumb=[],obj_breadCrumb={name:name,cbMethod:$scope.navigateToStep.bind(null,_selectedStep.id,actionType)};arr_breadCrumb.push(obj_breadCrumb);$element.find(".contentScrollDiv").scrollTop(0)},$scope.updatePublishBC("Publish","firstLevel"),$scope.getTermsCount=function(terms){if("options"!==$scope.currentStep)return terms.length;var selectedTerms=_.filter(terms,{_selected:!0}),selectedTermsCount=(selectedTerms||[]).length;return selectedTermsCount?selectedTermsCount:selectedTermsCount+1},$scope.checkUncheckRQ=function(event,allNodes,index){allNodes&&allNodes.rootTermQuestions&&allNodes.rootTermQuestions._selected?allNodes.rootTermQuestions._selected=!0:allNodes.rootTermQuestions._selected=!1;var _selectedNodes=_.filter(allNodes,{_selected:!0});allNodes[0]._selected&&_selectedNodes.length==allNodes.length&&allNodes.rootTermQuestions._selected?allNodes[0]._selected=!0:allNodes[0]._selected=!1},$scope.checkUncheckRoot=function(event,node,allnodes){event.stopPropagation(),event.stopImmediatePropagation(),event.preventDefault(),node._selected=!node._selected,$scope.checkUncheckNodes(event,node,allnodes)},$scope.checkUncheckallRoot=function(event,value){$.each($scope.allNodesCollection,function(i,nodes){nodes[0]._selected=value,$scope.checkUncheckNodes(event,nodes[0],nodes)})},$scope.checkUncheckNodes=function(event,node,allnodes,element,parent){if(node.deleted){for(var parentDelNodeId,isParentDelSelected,parentName,i=0;i<allnodes.length;i++)if("l0"==allnodes[i].level&&allnodes[i].deleted===!0){parentDelNodeId=allnodes[i].nodeId,isParentDelSelected=allnodes[i]._selected,parentName=allnodes[i].label;break}if(node.parent&&1==node.parent.length&&node.parent[0]==parentDelNodeId&&isParentDelSelected)return NotificationService.notify("Please uncheck the "+parentName+"(Deleted) root node","error"),void(node._selected=!0)}$.each(allnodes,function(i,_node){if(node.parent&&node.parent.length){var _selectedNodes=_.filter(allnodes,{_selected:!0});allnodes[0]._selected&&_selectedNodes.length==allnodes.length&&allnodes.rootTermQuestions._selected?allnodes[0]._selected=!0:allnodes[0]._selected=!1}else _node._selected=node._selected,allnodes.rootTermQuestions._selected=node._selected}),$scope.intermediateSelection(element,parent,!0)},$scope.manageNodess=function(rootNodeID){$(".primaryNodes").slideToggle()},$scope.prepareKnowledgeTaskData=function(){function isNodeParentRoot(parentId,rootNd){for(var i=0;i<rootNd.length;i++)if(parentId===rootNd[i].nodeId)return!0;return!1}if($scope.allNodesCollection=[],$scope.knowledgeTask=null,$scope.knowledgeTasks&&$scope.knowledgeTasks.length){$scope.knowledgeTasks;$.each($scope.knowledgeTasks,function(i,knowledgeCollection){var ontologyNodes=[];if("configured"==knowledgeCollection.state||"awaitingApproval"==knowledgeCollection.state||"rejected"===knowledgeCollection.state){$scope.knowledgeTask=knowledgeCollection,ontologyNodes=knowledgeCollection.taxonomy;var rootNode=_.filter(ontologyNodes,function(node){return node._selected=!0,node.language=knowledgeCollection.language,!node.parent||!node.parent.length}),primaryNodes=_.filter(ontologyNodes,function(node){return node._selected=!0,node.parent&&node.parent.length&&isNodeParentRoot(node.parent[0],rootNode)&&(!isNodePublished(node)||isNodeRejected(node)&&isNodeDeleted(node))}),_allNodesCollection=[];rootNode&&(_allNodesCollection=[].concat(rootNode,primaryNodes)),_allNodesCollection.language=knowledgeCollection.language,_allNodesCollection.rootTermQuestions={_selected:!0,_id:knowledgeCollection._id},_allNodesCollection.KTdata=knowledgeCollection,$scope.allNodesCollection.push(_allNodesCollection||[])}})}$scope.noTasks=$scope.isPublishView($scope.publishViews.initialView)};var isNodePublished=function(term){var cb=!1;return $.each($scope.knowledgeTasks,function(i,knowledgeTask){var _nodesToPublish=knowledgeTask.nodesToPublish;-1!==$.inArray(term.nodeId,_nodesToPublish)&&(cb=!0);
}),cb},isNodeRejected=function(term){var cb=!1;return $.each($scope.knowledgeTasks,function(i,knowledgeTask){"rejected"===knowledgeTask.state&&(cb=!0)}),cb},isNodeDeleted=function(term){var cb=!1;return $.each($scope.knowledgeTasks,function(i,knowledgeTask){knowledgeTask.deleted&&(cb=!0)}),cb};$scope.streamPublishInfo={published:!1,visibility:$scope.stream.visibility,enterprise:"enterprise"==$scope.stream.visibility.namespace||"enterpriseNpublic"==$scope.stream.visibility.namespace},$scope.streamPublishInfo.published=$rootScope.hasPublishedAlerts||$rootScope.hasPublishedActions||$rootScope.hasPublishedFlowtasks,$scope.isAuthorized=function(){return $rootScope.wfAdmin||window.localStorage.enablePublish},$scope.trymodecallback.showStep=showStep,$scope.stepClick=function(step){step-1>1&&!$scope.isTryModeUpdated&&"smartbot"===$scope.stream.publishType?$scope.trymodecallback.updateTryMode(step-1):showStep(step-1)},$scope.helpLink=$rootScope.helpLinks.DEPLOYMENTTAB_HELP,$scope.next=function(){var step=$scope.currentStep+1;$scope.helpLink=$rootScope.helpLinks.CONFIRMTAB_HELP,1===$scope.currentStep&&step>1?$scope.trymodecallback.updateTryMode(step):showStep(step)},$scope.back=function(){$scope.currentStep--},$scope.cancel=function(){$scope.onClose(!1)},$scope.getType=function(id){return"l"===id[0]?"Alert Task":"d"===id[0]?"Dialog Task":"Action Task"},$scope.assignDefaultPublishDestination=function(){"smartbot"==$scope.stream.publishType||"samplebot"==$scope.stream.publishType?($scope.streamPublishInfo.namespaceTo="public",$scope.streamPublishInfo.namespaceHide=!0):"smartbot"!=$scope.stream.publishType&&"samplebot"!==$scope.stream.publishType&&$rootScope.isManaged&&!$rootScope.wfAdmin?($scope.streamPublishInfo.namespaceTo="enterprise",$scope.streamPublishInfo.namespaceHide=!0):$scope.streamPublishInfo.published&&($scope.streamPublishInfo.namespaceHide=!0,$scope.streamPublishInfo.namespaceTo=$scope.streamPublishInfo.visibility.namespace),$scope.streamPublishInfo.namespaceTo="enterprise",$scope.tasks.map(function(task){task.namespaceTo=$scope.streamPublishInfo.namespaceTo})},$scope.allTasks=[],$scope.alerts=[],$scope.actions=[],$scope.information=[],$scope.dialogtask=[],$scope.mappings=[],$scope.panels=[],$scope.widgets=[],$scope.botUIForms=[],$scope.deletedTaskList=[],$scope.deletedSmallTalkNodes=[],$scope.alertLoading=!0,$scope.actionLoading=!0,$scope.dialogLoading=!0,$scope.loadingFlows=!0;var requestData={streamId:$scope.stream._id,language:"all"};(function(){if($scope.stream.permissions&&"FULL"===$scope.stream.permissions.BOTBUILDER_TASKS[0]){var languages=[];BTStreamsService.getSmallTalk($scope.stream._id).then(function(response){$scope.smallTalkData=response.data,angular.forEach($scope.smallTalkData,function(task){languages.push(task.language),task&&"published"===task.state&&task.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:task.name,type:"Small Talk",language:task.language,_id:"smallTalk"})),task&&"published"===task.state&&task.isDeletedNodes&&$scope.deletedSmallTalkNodes.push(task)}),languages&&languages.length&&($scope.smallTalk.supportedLanguages=_.map(_.union(languages||[]),function(each){var slObject={};return slObject.selected=!1,slObject.value=each,0===languages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(languages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value==$scope.stream.defaultLanguage&&(slObject.disable=!0),slObject}))})}})(),function(){$scope.stream.permissions&&"NO"===$scope.stream.permissions.BOTBUILDER_TASKS[0]&&"FULL"===$scope.stream.permissions.BOTBUILDER_KNOWLEDGE_GRAPH[0]&&BTStreamsService.ktGetAllLanguage("",requestData).then(function(result){$scope.knowledgeTasks=result.data,angular.forEach(result.data,function(task){task&&task.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:task.name,type:"Knowledge Task",language:task.language,_id:"kg"}))}),$scope.prepareKnowledgeTaskData()})}();$q.all([BTAlertsService.getAlerts($scope.stream._id),BTActionsService.getActions($scope.stream._id),BTFlowtaskService.getFlowtaks($scope.stream._id),BTStreamsService.getMappings($scope.stream._id),BTStreamsService.ktGetAllLanguage("",requestData),BTStreamsService.getBotPanels($scope.stream._id),BTStreamsService.getBotWidgets($scope.stream._id),BTStreamsService.getBotUiForms($scope.stream._id)]).then(function(results){$scope.allTasks=$scope.allTasks.concat(results[0].data),angular.forEach(results[0].data,function(task){task&&task.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:task.name,type:"Alert Task",_id:"alert"}))}),$scope.allTasks=$scope.allTasks.concat(results[1].data),angular.forEach(results[1].data,function(task){task&&task.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:task.name,type:"Action Task",_id:"action"}))}),$scope.allTasks=$scope.allTasks.concat(results[2].data),angular.forEach(results[2].data,function(task){task&&task.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:task.name,type:"Dialog Task",_id:"dialog"}))}),$scope.knowledgeTasks=results[4].data,angular.forEach(results[4].data,function(task){task&&task.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:task.name,type:"Knowledge Task",language:task.language,_id:"kg"}))}),results[5]&&results[5].data&&($scope.panels=results[5].data,angular.forEach(results[5].data,function(task){task&&task.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:task.name,type:"Panel",_id:"panel"}))})),results[6]&&results[6].data&&($scope.widgets=results[6].data,angular.forEach(results[6].data,function(task){task&&task.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:task.name,type:"Widget",_id:"widget"}))})),$scope.alerts=results[0].data.filter(function(alert){return alert.supportedLanguages=_.map(_.union($scope.stream.supportedLanguages,alert.approvedLanguages||[]),function(each){alert.approvedLanguages=alert.approvedLanguages||[];var slObject={};return 0===alert.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(alert.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject.value==$scope.stream.defaultLanguage&&(slObject.disable=!0),slObject}),alert.supportedLanguages=_.sortBy(alert.supportedLanguages,"selected"),alert.approvedLanguagesCopy=[],_.map(alert.supportedLanguages,function(lang){lang.selected&&alert.approvedLanguagesCopy.push(lang.value)}),alert.approvedLanguages=angular.copy(alert.approvedLanguagesCopy),alert.approvedLangString=convertToString(alert.approvedLanguagesCopy),"configured"===alert.state}),$scope.actions=results[1].data.filter(function(action){return action.supportedLanguages=_.map(_.union($scope.stream.supportedLanguages,action.approvedLanguages),function(each){var slObject={};return action.approvedLanguages=action.approvedLanguages||[],0===action.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(action.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject.value==$scope.stream.defaultLanguage&&(slObject.disable=!0),slObject}),action.supportedLanguages=_.sortBy(action.supportedLanguages,"selected"),action.approvedLanguagesCopy=[],_.map(action.supportedLanguages,function(lang){lang.selected&&action.approvedLanguagesCopy.push(lang.value)}),action.approvedLanguages=angular.copy(action.approvedLanguagesCopy),action.approvedLangString=convertToString(action.approvedLanguagesCopy),"configured"===action.state&&!action.isReport}),$scope.information=results[1].data.filter(function(info){return info.supportedLanguages=_.map(_.union($scope.stream.supportedLanguages,info.approvedLanguages),function(each){var slObject={};return info.approvedLanguages=info.approvedLanguages||[],0===info.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(info.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject.value==$scope.stream.defaultLanguage&&(slObject.disable=!0),slObject}),info.supportedLanguages=_.sortBy(info.supportedLanguages,"selected"),info.approvedLanguagesCopy=[],_.map(info.supportedLanguages,function(lang){lang.selected&&info.approvedLanguagesCopy.push(lang.value)}),info.approvedLanguages=angular.copy(info.approvedLanguagesCopy),info.approvedLangString=convertToString(info.approvedLanguagesCopy),"configured"===info.state&&info.isReport}),$scope.dialogs=results[2].data.filter(function(dialog){return dialog.supportedLanguages=_.map(_.union($scope.stream.supportedLanguages,dialog.approvedLanguages),function(each){var slObject={};return dialog.approvedLanguages=dialog.approvedLanguages||[],0===dialog.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(dialog.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject.value==$scope.stream.defaultLanguage&&(slObject.disable=!0),slObject}),dialog.supportedLanguages=_.sortBy(dialog.supportedLanguages,"selected"),dialog.approvedLanguagesCopy=[],_.map(dialog.supportedLanguages,function(lang){lang.selected&&dialog.approvedLanguagesCopy.push(lang.value)}),dialog.approvedLanguages=angular.copy(dialog.approvedLanguagesCopy),dialog.approvedLangString=convertToString(dialog.approvedLanguagesCopy),"configured"===dialog.state}),results[5]&&results[5].data&&($scope.panels=results[5].data.filter(function(panel){return panel.supportedLanguages=_.map(_.union($scope.stream.supportedLanguages,panel.approvedLanguages||[]),function(each){var slObject={};return panel.approvedLanguages=panel.approvedLanguages||[],0===panel.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(panel.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject.value==$scope.stream.defaultLanguage&&(slObject.disable=!0),slObject}),panel.supportedLanguages=_.sortBy(panel.supportedLanguages,"selected"),panel.approvedLanguagesCopy=[],_.map(panel.supportedLanguages,function(lang){lang.selected&&panel.approvedLanguagesCopy.push(lang.value)}),panel.approvedLanguages=angular.copy(panel.approvedLanguagesCopy),panel.approvedLangString=convertToString(panel.approvedLanguagesCopy),"configured"===panel.state})),results[6]&&results[6].data&&($scope.widgets=results[6].data.filter(function(widget){return widget.supportedLanguages=_.map(_.union($scope.stream.supportedLanguages,widget.approvedLanguages||[]),function(each){var slObject={};return widget.approvedLanguages=widget.approvedLanguages||[],0===widget.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(widget.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject.value==$scope.stream.defaultLanguage&&(slObject.disable=!0),slObject}),widget.supportedLanguages=_.sortBy(widget.supportedLanguages,"selected"),widget.approvedLanguagesCopy=[],_.map(widget.supportedLanguages,function(lang){lang.selected&&widget.approvedLanguagesCopy.push(lang.value)}),widget.approvedLanguages=angular.copy(widget.approvedLanguagesCopy),widget.approvedLangString=convertToString(widget.approvedLanguagesCopy),"configured"===widget.state})),results[7]&&results[7].data&&($scope.botUIForms=results[7].data.filter(function(dialog){return dialog&&dialog.isDeleted&&($scope.deletedTaskList=$scope.deletedTaskList.concat({taskName:dialog.name,type:"Digital Form"})),dialog.supportedLanguages=_.map(_.union($scope.stream.supportedLanguages,dialog.approvedLanguages),function(each){var slObject={};return dialog.approvedLanguages=dialog.approvedLanguages||[],0===dialog.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(dialog.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject.value==$scope.stream.defaultLanguage&&(slObject.disable=!0),slObject}),dialog.supportedLanguages=_.sortBy(dialog.supportedLanguages,"selected"),dialog.approvedLanguagesCopy=[],_.map(dialog.supportedLanguages,function(lang){lang.selected&&dialog.approvedLanguagesCopy.push(lang.value)}),dialog.approvedLanguages=angular.copy(dialog.approvedLanguagesCopy),dialog.approvedLangString=convertToString(dialog.approvedLanguagesCopy),"configured"===dialog.state&&(!dialog.isPublishedVersion||dialog.approvedLanguages.length!=dialog.supportedLanguages.length)})),$scope.mappings=results[3].data,$scope.mappings=flowsUtil.arrangeFlows($scope.mappings),assignFlowsToTask().then(function(){$scope.alertLoading=!1,$scope.actionLoading=!1,$scope.dialogLoading=!1,$scope.loadingFlows=!1}),$scope.prepareKnowledgeTaskData(),$timeout(function(){PerfectScrollbar.update($element.find(".bot-publish [perfect-scroll]")[0])},300),$scope.partialImportAllowed||$scope.nextStep()},function(err){$scope.alerts=[],$scope.actions=[],$scope.information=[],$scope.mappings=[],$scope.alertLoading=!1,$scope.actionLoading=!1,$scope.loadingFlows=!1,$scope.dialogLoading=!1}),$scope.isPublishView=function(view){return"private"==$scope.stream.visibility.namespace?($scope.alerts||[]).length||($scope.actions||[]).length||($scope.information||[]).length||($scope.dialogs||[]).length||($scope.allNodesCollection||[]).length||$scope.stream.isSmalltalkMigrated||($scope.widgets||[]).length||($scope.panels||[]).length||($scope.botUIForms||[]).length?!1:view:!1},$scope.checkTaskAvailable=function(){return($scope.alerts||[]).length||($scope.actions||[]).length||($scope.information||[]).length||($scope.dialogs||[]).length||($scope.allNodesCollection||[]).length||$scope.stream.isSmalltalkMigrated||($scope.widgets||[]).length||($scope.panels||[]).length||($scope.botUIForms||[]).length?!0:!1},$scope.hasUpgradedTasks=!1;var taskMap={};$scope.doubleClick=!1,$scope.planSelectionCb.confirmPublish=function(){$scope.doubleClick||($scope.doubleClick=!0,$timeout(function(){$scope.doubleClick=!1},1e3),$scope.confirm())},$scope.confirm=function(directPublish){function triggerPublish(){if("default"===$scope.stream.type&&!directPublish&&$scope.appControls.isBillingEnabled&&1===$scope.selectedAccount.accountType&&$scope.selectedAccount.adminPreferences&&$scope.selectedAccount.adminPreferences.autoApproval&&"private"===$scope.stream.visibility.namespace){if($scope.tasks&&0===$scope.tasks.length&&$scope.knowledgeTasks&&0===$scope.knowledgeTasks.length)return void NotificationService.notify(i18n.i18nString("select_atleast_one_task"),"warning");if($scope.stream&&$scope.license&&!$scope.license.planName&&"private"===$scope.stream.visibility.namespace&&$scope.planSelectionCb&&!$scope.planSelectionCb.publishFreeBot&&!$scope.planSelectionCb.publishSubmitToAdmin&&!$scope.planSelectionCb.publishPaidBot)return void $scope.openPlanUsage("plan");$scope.closeCustomModal("prePublishWarning")}else if($scope.planValidationDetails&&$scope.planValidationDetails.exceededData&&$scope.license&&$scope.license.planName&&$scope.planValidationDetails.exceededData[$scope.license.planId]&&!$scope.planSelectionCb.publishFreeBot&&!$scope.planSelectionCb.publishSubmitToAdmin&&!$scope.planSelectionCb.publishPaidBot)return void $scope.openCustomModal("upDownRequired");$scope.publishInProgress=!0;var payload={resources:[]};$scope.tasks.map(function(task){var parent;task.parentId&&(parent=$scope.allTasks.filter(function(item){return item._id===task.parentId})[0]||{}),task.approvedLanguagesCopy&&delete task.approvedLanguagesCopy;var taskUpgradeInfo={namespace:task.parentId?"enterpriseNpublic"==parent.visibility.namespace?"enterprise":task.namespaceTo:"enterpriseNpublic"==task.namespaceTo?"enterprise":task.namespaceTo,resourceId:task._id,namespaceIds:task.parentId?parent.visibility.namespaceIds:task.namespaceIds||[],resourceType:getType(task._id),upgradeShortMsg:task.upgradeShortMessage,upgradeLongMsg:task.upgradeLongMessage,versionComment:$scope.botPublishObject.upgradeVersionComment,approvalRequestedLanguages:task.approvedLanguages};"enterprise"===taskUpgradeInfo.namespace?taskMap[task._id]=task.name:(taskMap[task.parentId?task.parentId:task._id]=task.name,taskMap[task._id]=task.name),task.parentId&&(taskUpgradeInfo.versionType=task.versionType,_.addProps(task.upgradeInfo&&"automatic"!==task.upgradeInfo.upgrade,taskUpgradeInfo,{upgradeType:task.upgradeType})),payload.resources.push(taskUpgradeInfo)}),$.each($scope.allNodesCollection,function(i,allnodes){var _selectedNodes=_.filter(allnodes,function(node){return node._selected&&node.parent&&node.parent.length>0?node:void 0});if(($scope.selectedNodes.length||$scope.selectedRootTermQuestions.length)&&(_selectedNodes.length||allnodes.rootTermQuestions._selected)){var nodePublishInfo={namespace:$scope.streamPublishInfo.namespaceTo,resourceId:allnodes.KTdata._id,namespaceIds:allnodes.KTdata.namespaceIds||[],resourceType:"knowledge",versionComment:allnodes.KTdata.upgradeVersionComment,publishRoot:allnodes.rootTermQuestions._selected,nodesToPublish:[].concat(_.pluck(_selectedNodes,"nodeId"),allnodes.KTdata.nodesToPublish||[])};"rejected"===allnodes.KTdata.state&&(nodePublishInfo.nodesToPublish=[],nodePublishInfo.nodesToPublish=[].concat(_.pluck(_selectedNodes,"nodeId"))),payload.resources.push(nodePublishInfo)}}),$scope.smallTalk._selected&&$scope.smallTalk.showSmallTalkComponent&&payload.resources.push({resourceId:"smalltalk",resourceType:"smalltalk",approvalRequestedLanguages:$scope.smallTalk.approvedLanguages,namespace:$scope.streamPublishInfo.namespaceTo||"enterprise"}),$scope.botUIForms._selected&&$scope.botUIForms.showSmallTalkComponent&&payload.resources.push({resourceId:"smalltalk",resourceType:"smalltalk",approvalRequestedLanguages:$scope.botUIForms.approvedLanguages,namespace:$scope.streamPublishInfo.namespaceTo||"enterprise"}),$scope.advancedPublishOptions.nl.selectedModules.length&&payload.resources.push({resourceId:"NL",resourceType:"NL",modules:$scope.advancedPublishOptions.nl.selectedModules}),$scope.advancedPublishOptions.channels.selectedModules.length&&payload.resources.push({resourceId:"CHANNELS",resourceType:"CHANNELS",modules:$scope.advancedPublishOptions.channels.selectedModules}),$scope.advancedPublishOptions.extensions.selectedModules.length&&payload.resources.push({resourceId:"EXTENSIONS",resourceType:"EXTENSIONS",modules:$scope.advancedPublishOptions.extensions.selectedModules}),$scope.advancedPublishOptions.settings.selectedModules.length&&payload.resources.push({resourceId:"SETTINGS",resourceType:"SETTINGS",modules:$scope.advancedPublishOptions.settings.selectedModules}),$scope.selectAllLanguage.selected&&$scope.advancedPublishOptions.botLanguage.modules&&payload.resources.push({resourceId:"BOTLANGUAGES",resourceType:"BOTLANGUAGES",modules:$scope.advancedPublishOptions.botLanguage.modules}),"smartbot"==$scope.stream.publishType&&(payload.botType=$scope.upgrade.botType,$scope.isDomainKore||(payload.botType="enterprise")),publishTasks(payload)}function getType(id){return"p"==id[0]?"panel":"w"==id[0]?"widget":"f"==id[0]?"form":"l"==id[0]?"alert":"d"==id[0]?"dialog":"action"}({streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name});directPublish&&collectSelectedTasks(),verifyFlowsStatus(triggerPublish)},$scope.checkDockStatus=function(){$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open")},$scope.getTextIncludingTags=function(name){return name?name.escapeHTML():void 0},String.prototype.escapeHTML=function(){var escapeTokens={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"},htmlTags=/[<>"']/g;return(""+this).replace(htmlTags,function(match){return escapeTokens[match]})},$scope.expandTask=function(task){$scope.tasks&&$scope.tasks.length&&$scope.tasks.forEach(function(taskItem){task._id!==taskItem._id&&(taskItem.subView=!1)}),task.subView=!task.subView},$scope.openModal=function(){$("#errorMsgStatus").modal({backdrop:"static",show:!0})},$scope.closeModal=function(){$("#errorMsgStatus").modal("hide"),$timeout(function(){$("body").removeClass("modal-open")});var stream=$workflowService.selectedStream();stream.visibility.namespace="enterpriseNpublic",$scope.$emit("loadBots",stream),$rootScope.$broadcast("getProgressDockStatus")},$scope.allowRetry=!0,$scope.retry=function(payload){$scope.allowRetry=!1;var service="smartbot"==$scope.stream.publishType?BTStreamsService.solutionPublish:BTStreamsService.standardPublish;"smartbot"!==$scope.stream.publishType&&"samplebot"!==$scope.stream.publishType&&(payload.publishAllComponents=!1,payload.versionComment=$scope.botPublishObject.upgradeVersionComment||""),"default"===$scope.stream.type&&$scope.planSelectionCb&&$scope.planSelectionCb.publishSubmitToAdmin===!0&&(payload.doManualApproval=!0),service($scope.stream._id,payload.context).then(function(res){$scope.allowRetry=!0;var messages=[];res.data.map(function(message){var _msg=taskMap[message.resourceId];void 0===_msg&&message.result&&message.result.name&&(_msg=message.result.name),"SUCCESS"===message.status?messages.push({type:"success",taskId:message.resourceId,message:_msg+" published successfully"}):"FAILURE"===message.status&&messages.push({type:"error",error:getErrorMsg(message.result),message:_msg+" publish failed ",context:getResource(payload.context,message.resourceId),taskId:message.resourceId})}),messages.map(function(message){var msgIndex=_.findIndex($scope.messages,{taskId:message.taskId});-1!==msgIndex&&($scope.messages[msgIndex]=message)})},function(err){$scope.allowRetry=!0;var msg=err.data.errors[0].msg||i18n.i18nString("something_went_wrong_try_again");NotificationService.notify(msg,"error")})},$scope.showBTStoreSettingsModal=!1,$scope.bssCallback={},$scope.openBotStoreSettingsModal=function(){$scope.showBTStoreSettingsModal=!0,$(".botStoreSettingsModal").modal("show"),$timeout(function(){$scope.bssCallback.loadGeneralSettings()})},$scope.closeBotStoreSettingsModal=function(){$scope.showBTStoreSettingsModal=!1,$(".botStoreSettingsModal").modal("hide")},$scope.retryAll=function(){$scope.allowRetry=!1;var payload={resources:[]},publishInfo=$scope.messages.filter(function(message){return"error"===message.type});"smartbot"==$scope.stream.publishType&&(payload={botDesc:publishInfo[0].context.botDesc,configInst:publishInfo[0].context.configInst,configInstURL:publishInfo[0].context.configInstURL,resources:[]}),publishInfo.map(function(info){payload.resources.push(info.context.resources[0])}),publishTasks(payload)},$scope.deleteMapping=function(){NotificationService.alert(i18n.i18nString("you_really_want_to_delete_this_flow"),deleteMapping,arguments)},$scope.updateMapping=function(flow){flow.targetResourceId?BTStreamsService.validateAlertDialogFlow(flow.mapId,$scope.configuredDialogFlowId).then(function(res){$scope.alertDialogMappingsToPublish.push(flow.mapId)},function(err){console.log(err),flow.state=!1}):BTStreamsService.publishFlow(flow.mapId).then(function(res){},function(err){console.log(err),flow.state=!1})},$scope.$watch("upgrade.isChat",function(newVal,oldVal){isAnyCommunicationModeSelected()||(NotificationService.notify(i18n.i18nString("atleast_one_communication_mode"),"warning"),$scope.upgrade.isChat=oldVal)}),$scope.$watch("upgrade.isMention",function(newVal,oldVal){isAnyCommunicationModeSelected()||(NotificationService.notify(i18n.i18nString("atleast_one_communication_mode"),"warning"),$scope.upgrade.isMention=oldVal)}),$scope.changeWorkPlaceCommunication=function(){},$scope.publishPageTitle=function(){return"smartbot"===$scope.stream.publishType?i18n.i18nString("deploySmartBot"):"samplebot"===$scope.stream.publishType?i18n.i18nString("deploySampleBot"):i18n.i18nString("deployStandardBot")},$scope.updateFooterHeader=function(){return $scope.footerInfoTitle=i18n.i18nString("publishing_tasks"),$scope.footerHeaderId="bt-botpublish",$scope.footerPanelId="bt-botpublish-panel",$scope.nameDescription=i18n.i18nString("after_you_have_defined_and_saved"),!0},$scope.uploadInstructionsDocument=function(){if($scope.upgrade.instructionsFile.name){var _ext=$scope.upgrade.instructionsFile.name.substring($scope.upgrade.instructionsFile.name.lastIndexOf("."));if(".pdf"!==_ext)return NotificationService.notify(i18n.i18nString("upload_only_pdf_files"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1,$scope.upgrade.instructionsFileName=$scope.upgrade.instructionsFile.name;var data=new FormData;data.append("file",$scope.upgrade.instructionsFile),data.append("fileContext","workflows"),data.append("fileExtension","pdf"),$scope.fileUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){$scope.upgrade.instructions=response.data.fileId,NotificationService.notify($scope.upgrade.instructionsFile.name+i18n.i18nString("uploaded_label"),"success"),$scope.fileUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.fileUploading=!1})},$scope.smallTalkLanguageUpdates=function(e,language,smallTalk){language.disable||(language.selected?(language.selected=!1,smallTalk.approvedLanguagesCopy&&smallTalk.approvedLanguagesCopy.splice(_.indexOf(smallTalk.approvedLanguagesCopy,language.value),1),smallTalk.approvedLanguages&&smallTalk.approvedLanguages.splice(_.indexOf(smallTalk.approvedLanguages,language.value),1)):(language.selected=!0,(smallTalk.approvedLanguagesCopy||[]).push(language.value),(smallTalk.approvedLanguages||[]).push(language.value)))},$scope.addLanguage=function(e,language,task,dontUpdateLang){if(dontUpdateLang&&(language.selected?(language.selected=!0,task.approvedLanguagesCopy.push(language.value),(task.approvedLanguages||[]).push(language.value)):(language.selected=!1,task.approvedLanguagesCopy.splice(_.indexOf(task.approvedLanguagesCopy,language.value),1),task.approvedLanguages&&task.approvedLanguages.splice(_.indexOf(task.approvedLanguages,language.value),1))),!dontUpdateLang){if(language.disable)return;language.selected?(language.selected=!1,task.approvedLanguagesCopy.splice(_.indexOf(task.approvedLanguagesCopy,language.value),1),task.approvedLanguages&&task.approvedLanguages.splice(_.indexOf(task.approvedLanguages,language.value),1)):(language.selected=!0,task.approvedLanguagesCopy.push(language.value),(task.approvedLanguages||[]).push(language.value))}task.approvedLangString=convertToString(task.approvedLanguages),task._selected=!0;var _selectedLanguages=task.supportedLanguages.filter(function(lang){return lang.selected}),_defaultApprovedLanguages=task.supportedLanguages.filter(function(lang){return lang.disable});_selectedLanguages&&0===_selectedLanguages.length&&"published"!==task.state&&0===_defaultApprovedLanguages.length&&(task._selected=!1)},$scope.$on("$destroy",function(){$scope.planSelectionCb&&($scope.planSelectionCb={})}),$scope.allTasksSelected.selectAllAlerts=!0,$scope.allTasksSelected.selectAllActions=!0,$scope.allTasksSelected.selectAllInformation=!0,$scope.allTasksSelected.selectAllDialogTask=!0,$scope.allTasksSelected.selectAllPanelTasks=!0,$scope.allTasksSelected.selectAllWidgetTasks=!0,$scope.allTasksSelected.selectAllFormTask=!0,$scope.allTasksSelected.selectAllKgs=!0,$scope.selectAll=function(selectAll,selector,e){if(!$scope.selectionInPogress){$scope.selectionInPogress=!0;var allCheckBoxes=$(""+selector+' .checkbox [type="checkbox"]');selectAll?$.each(allCheckBoxes,function(i,element){if($(element).is(":not(:checked)"))if(".publishDialogTask"===selector){$(element)[0].checked=!0;var taskId=$(element)[0].id;taskIndex=_.findIndex($scope.dialogs,{_id:taskId}),".publishDialogTask"===selector&&taskIndex>-1&&($scope.dialogs[taskIndex]._selected=!0,$scope.editTask(e,$scope.dialogs[taskIndex]))}else $(element).click()}):$.each(allCheckBoxes,function(i,element){if($(element).is(":checked"))if(".publishDialogTask"===selector){$(element)[0].checked=!1;var taskId=$(element)[0].id;taskIndex=_.findIndex($scope.dialogs,{_id:taskId}),".publishDialogTask"===selector&&taskIndex>-1&&($scope.dialogs[taskIndex]._selected=!1,$scope.editTask(e,$scope.dialogs[taskIndex]))}else $(element).click()}),$scope.selectionInPogress=!1}},$scope.editTask=function(e,task,element,parent,taskId){var _defaultApprovedLanguages=task.supportedLanguages.filter(function(lang){return lang.disable});if(task._selected&&"published"!==task.state&&0===_defaultApprovedLanguages.length)for(var i=0;i<task.supportedLanguages.length;i++)task.supportedLanguages[i].selected=!0,$scope.addLanguage(e,task.supportedLanguages[i],task,!0);else if("published"!==task.state&&0===_defaultApprovedLanguages.length)for(var j=0;j<task.supportedLanguages.length;j++)task.supportedLanguages[j].selected=!1,$scope.addLanguage(e,task.supportedLanguages[j],task,!0);!$scope.selectionInPogress&&element&&parent&&$scope.intermediateSelection(element,parent,!0)},$scope.getNameByValue=function(langValueString,task){if(!langValueString)return"";var langvalueArray=task.approvedLanguages||[],langNames=_.map(langvalueArray,function(langValue){var langObject=_.find($scope.seedSupportedLanguages,{value:langValue});return langObject.name});return langNames},$scope.getPartialLanguageTasks=function(tasks){var filteredTasks=_.filter(tasks,function(task){return!task.nodeId&&task.approvedLanguages&&task.approvedLanguages.length!==task.supportedLanguages.length});return filteredTasks},$scope.openLanguageGenericModal=function(){$("#languageModalGeneric").modal("show")},$scope.$emit("nestedComponentLoaded",{id:"publish",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}]),_mod.filter("localString",function(){return function(input){return input&&input.toLocaleString()?input.toLocaleString():input}})}(angular),function(ng){var botTasksCreationForm=ng.module("bt-forms");botTasksCreationForm.directive("botTasksCreationForm",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bots-landing-forms/bot-tasks-creation-form/bot-tasks-creation-form.html",controller:"botTasksCreationFormCtrl"}}),botTasksCreationForm.controller("botTasksCreationFormCtrl",["$scope","$rootScope","$filter","$timeout","$workflowService","patternFactory","form_util","BTAlertsService","BTActionsService","NotificationService","BTStreamsService","$applicationService","i18n","mixPanel",function($scope,$rootScope,$filter,$timeout,$workflowService,patternFactory,form_util,BTAlertsService,BTActionsService,NotificationService,BTStreamsService,$applicationService,i18n,mixPanel){function resetForm(){$scope.introObj.name="",$scope.introObj.shortdescription=""}function updateIgnoreWordsVis(){if($scope.callbacks.menuSelectionData&&$scope.callbacks.menuSelectionData.length)for(var i=0;i<$scope.callbacks.menuSelectionData.length;i++)if($scope.callbacks.menuSelectionData[i]._id){if("ignoreWords"===$scope.callbacks.menuSelectionData[i]._id){$scope.callbacks.menuSelectionData[i].visibility=!0;break}}else if("ignoreWords"===$scope.callbacks.menuSelectionData[i].id){$scope.callbacks.menuSelectionData[i].visibility=!0;break}}function updateTaskMeta(){if($scope.wfType=tasksObject[$scope.taskType],"alertTasks"===$scope.taskType){$scope.alerttypes=$workflowService.seedData().alertTypes||[],$scope.alerttypes.length&&"Webservice"!==$scope.alerttypes[0].name&&$scope.alerttypes.reverse();for(var i=0;i<$scope.alerttypes.length;i++)if("email"===$scope.alerttypes[i].value){$scope.alerttypes.splice(i,1);break}}else"actionTasks"===$scope.taskType||"informationTasks"===$scope.taskType?($scope.alerttypes=[{name:"Web Service",value:"webservice"}],$scope.introObj.type=$scope.alerttypes[0]):"dialogTasks"===$scope.taskType&&($scope.alerttypes=[{name:"Flow Task",value:"flowtask"}],$scope.introObj.type="flowTask")}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage()},event="";if("creatAlert"===type)try{var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),
Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Alert Task","Connection Type":connectionType[$scope.introObj.type],"Connection Mode":connectionMode[$scope.introObj.subtype]};mixPanel.postEvent("Conversation - Alert Task configured",eventInfo)}catch(e){console.log(e)}else event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function createBTAlert(){$scope.saveInProgress||(_alert={name:$scope.introObj.name,label:$scope.introObj.name,shortDesc:$scope.introObj.shortdescription,ignoreWords:$scope.introObj.ignoreWords,longDesc:$scope.introObj.longdescription,welcomeMsg:$scope.introObj.welcomemsg,type:$scope.introObj.type,streamId:_selectedStream._id,sourceStream:_selectedStream.name,needsTopic:!1,subtype:$scope.introObj.subtype||"rest",hasActions:$scope.introObj.hasActions,helpLink:$scope.introObj.helpLink,demoYoutubeLink:$scope.introObj.demoYoutubeLink,offKoraConfirmation:$scope.introObj.offKoraConfirmation,isAuthRequiredForWsdl:$scope.introObj.isAuthRequiredForWsdl,contextTags:$scope.manageContext.contextTags,preConditions:$scope.manageContext.preConditions},$scope.saveInProgress=!0,BTAlertsService.createBTAlert(_alert).then(function(res){$scope.alertid=res.data._id,$workflowService.alertInfo(res.data),mixpanelEvent("creatAlert"),createMPAlert(_alert,!0),updateIgnoreWordsVis()},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.$emit("updateGlobalWorkProgress",!1),$rootScope.saveAndExit=!1,$scope.alertid=null,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_alert"),"error")}))}function createMPAlert(mpalert,create){var mpAlertObj;mpAlertObj=$workflowService.alertInfo(),mpalert._id=$scope.alertid,mpalert.namespace="private",mpalert.namespaceIds=[],mpalert.userAlertMsg=$scope.introObj.userAlertMsg,mpalert.teamAlertMsg=$scope.introObj.teamAlertMsg,mpalert.keywords=[],mpalert.contents=$scope.introObj.contents,$workflowService.alertData(mpalert),BTAlertsService.createMPAlert(mpalert).then(function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$workflowService.mpAlertInfo(res.data),$rootScope.$emit("onedittask",$workflowService.alertInfo(),$scope.wfType),$scope.closeGeneralInfoModal(),$rootScope.$emit("insertOrUpdateTask","alert",$workflowService.alertInfo(),!0),$scope.updateStep(3,"",!0)},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,$scope.isWorkProgress=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_alert"),"error"),BTAlertsService.deleteBTAlert($scope.alertid),$scope.alertid=null})}function createBTAction(){var _actionIntro={name:$scope.introObj.name,ignoreWords:$scope.introObj.ignoreWords,shortDesc:$scope.introObj.shortdescription,longDesc:$scope.introObj.longdescription,welcomeMsg:$scope.introObj.welcomemsg,type:$scope.introObj.type,subtype:$scope.introObj.subtype||"rest",streamId:_selectedStream._id,targetStream:_selectedStream.name,helpLink:$scope.introObj.helpLink,isReport:$scope.isReport,demoYoutubeLink:$scope.introObj.demoYoutubeLink,offKoraConfirmation:$scope.introObj.offKoraConfirmation,isAuthRequiredForWsdl:$scope.introObj.isAuthRequiredForWsdl,contextTags:$scope.manageContext.contextTags,preConditions:$scope.manageContext.preConditions};$scope.saveInProgress||($scope.saveInProgress=!0,BTActionsService.createBTAction(_actionIntro).then(function(res){$workflowService.actionInfo(res.data),$scope.actionid=res.data._id,createMPAction(_actionIntro,!0),updateIgnoreWordsVis()},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.$emit("updateGlobalWorkProgress",!1),$rootScope.saveAndExit=!1,$scope.actionid=null,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_action"),"error")}))}function createMPAction(_action,create){_action.targetStream=_selectedStream.name,_action.contents=$scope.introObj.contents,_action.mappedOnly=$scope.introObj.mappedOnly,"string"==typeof $scope.introObj.keywords?_action.keywords=$scope.introObj.keywords.split(","):"object"==typeof $scope.introObj.keywords&&$scope.introObj.keywords.length>0?_action.keywords=$scope.introObj.keywords:_action.keywords=[],_action.namespace="private",_action.namespaceIds=[],_action._id=$scope.actionid,BTActionsService.createMPAction(_action).then(function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$workflowService.mpActionInfo(res.data),$rootScope.$emit("onedittask",$workflowService.actionInfo(),$scope.wfType),$scope.closeGeneralInfoModal(),$rootScope.$emit("insertOrUpdateTask","action",$workflowService.actionInfo(),!0)},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.saveAndExit=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_action"),"error"),BTActionsService.deleteBTAction($scope.actionid),$scope.actionid=null})}function createKnowledgeTask(ktData){$scope.saveInProgress||($scope.saveInProgress=!0,ktData.streamId=$workflowService.selectedStream()._id,BTStreamsService.createKnowledgeTask($applicationService.userInfo().userId,ktData).then(function(response){$scope.saveInProgress=!1,$scope.closeModal(),NotificationService.notify(i18n.i18nString("kg_saved"),"success"),response.data.taskType="knowledgeTask",$workflowService.taskEditInfo(response.data),$workflowService.taskMode("edit"),$scope.updateStep(3,"",!0),$timeout(function(){$rootScope.$emit("updateEditTask",!0)})},function(res){$scope.saveInProgress=!1,409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("kg_duplicate")&&($scope.duplicateKTName=!0),NotificationService.notify(res.data.errors[0].msg,"error")}))}$scope.introObj={},$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$scope.savingAlert=i18n.i18nString("saving"),$scope.createProceed=i18n.i18nString("create_proceed"),$scope.charremaining=i18n.i18nString("Generalform_charlimit"),$scope.infoName=i18n.i18nString("info_Name"),$scope.actionName=i18n.i18nString("action_Name"),$scope.alertName=i18n.i18nString("alert_Name"),$scope.infoRequired=i18n.i18nString("info_required"),$scope.actionRequired=i18n.i18nString("action_required"),$scope.alertRequired=i18n.i18nString("alert_required"),$scope.infoAllows=i18n.i18nString("info_allows"),$scope.actionAllows=i18n.i18nString("action_allows"),$scope.alertAllows=i18n.i18nString("alert_allows"),$scope.infoNObot=i18n.i18nString("info_Nobot"),$scope.actionNObot=i18n.i18nString("action_Nobot"),$scope.alertNObot=i18n.i18nString("alert_Nobot"),$scope.displayinfoName=i18n.i18nString("info_DisplayName"),$scope.displayactionName=i18n.i18nString("action_DisplayName"),$scope.displayalertName=i18n.i18nString("alert_DisplayName"),$scope.infoContext=i18n.i18nString("info_context"),$scope.actionContext=i18n.i18nString("action_context"),$scope.alertContext=i18n.i18nString("alert_context"),$scope.infoDesc=i18n.i18nString("info_Desc"),$scope.actionDesc=i18n.i18nString("action_Desc"),$scope.alertDesc=i18n.i18nString("alert_Desc"),$scope.infoLong=i18n.i18nString("info_Long"),$scope.actionLong=i18n.i18nString("action_Long"),$scope.alertLong=i18n.i18nString("alert_Long"),$scope.stream=$workflowService.selectedStream(),$scope.caretIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/caretDown.svg",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png";var connectionType={},connectionMode={},_selectedStream=($workflowService.currentLanguage(),null);_selectedStream=$workflowService.selectedStream(),$scope.manageContext={preConditions:[],contextTags:[]},$scope.goToTasks=function(){$scope.$emit("resetCreateConditions")};var footerInfo={alertTasks:{title:i18n.i18nString("alert_right")},actionTasks:{title:i18n.i18nString("action_right")},informationTasks:{title:i18n.i18nString("information_right")},dialogTasks:{title:i18n.i18nString("intent_right")},knowledgeCollection:{title:i18n.i18nString("kg_right")}};$scope.closeModal=function(){$scope.closeGeneralInfoModal(),$("#taskCreateOverlayModal").show(),$(".taskTypeDiv ").removeClass("selected")},$scope.updateFooterHeader=function(){"informationTasks"==$scope.taskType?"information":$scope.wfType;return $scope.isReport="informationTasks"==$scope.taskType?!0:!1,$scope.taskType&&"flows"!=$scope.taskType?($scope.footerInfoTitle=footerInfo[$scope.taskType].title,$scope.footerHeaderId="bt-task-creation",$scope.footerPanelId="bt-task-creation-panel","knowledgeCollection"===$scope.taskType?$scope.nameDescription=i18n.i18nString("name_kg"):$scope.nameDescription=i18n.i18nString("task_warning"),$scope.taskgen.taskGeneralInfoForm&&$scope.taskgen.taskGeneralInfoForm.$setPristine(),updateTaskMeta(),!0):!0},$scope.updateStep=function(stepNo){$scope.$emit("updateStep",stepNo)},$scope.$watch("taskType",function(newValue,oldValue,scope){"flows"!=$scope.taskType&&(resetForm(),$scope.updateFooterHeader())}),$scope.getSentenceCase=function(value){return _selectedStream.defaultLanguage&&"en"!==_selectedStream.defaultLanguage?value:$filter("sentence_case")(value)};var tasksObject={dialogTasks:"flowTask",alertTasks:"alert",actionTasks:"action",informationTasks:"action"};updateTaskMeta(),$scope.subtypes=$workflowService.seedData().webserviceTypes,$scope.activeEntityFlow={},$scope.saveIntro=function(isValid,form){return isValid?($rootScope.$emit("updateGlobalWorkProgress",!0),_selectedStream=$workflowService.selectedStream(),$scope.introObj.needsAuth="webservice"===$scope.introObj.type?!0:$scope.introObj.needsAuth,void("alert"===$scope.wfType?createBTAlert():"action"===$scope.wfType?createBTAction():"flowTask"===$scope.wfType&&createFlowTask())):void form_util.touch(form)},$scope.closeGeneralInfoModal=function(){$rootScope.$emit("updateGlobalWorkProgress",!1),$(".task-generalinfo-modal").modal("hide")},$scope.alerttypes.forEach(function(value){connectionType[value.value]=value.name}),$scope.subtypes.forEach(function(value){connectionMode[value.value]=value.name}),$scope.invalidWordCount=!1,$scope.taskgen={},$scope.checkTaskWordCount=function(){return $scope.introObj.name?($scope.introObj.name.split(" ").length<2||$scope.introObj.name.split(" ").length>5?($scope.invalidWordCount=!0,$scope.taskgen.taskGeneralInfoForm.name.$valid=!1):($scope.invalidWordCount=!1,$scope.taskgen.taskGeneralInfoForm.name.$valid=$scope.taskgen.taskGeneralInfoForm.name.$valid||!0),void($scope.introObj.shortdescription||($scope.introObj.shortdescription=$scope.introObj.name))):void($scope.invalidWordCount=!1)},$scope.saveKnowledgeTask=function(isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return form_util.touch(form),void($scope.isFromModalOpen=!1);var btPostData={};btPostData.name=$scope.knowledgeData.name,btPostData.description=$scope.knowledgeData.description,createKnowledgeTask(btPostData)},$scope.data=[{nodeId:"1",label:_selectedStream.name,"class":"bgblack",level:"l0",parent:[],synonyms:[],nodes:[],metadata:$scope.data}],$scope.kt={},$scope.knowledgeData={},$scope.isFormValid=function(isSaveKnoledgeTask){return isSaveKnoledgeTask?$scope.kt.streamktform&&$scope.kt.streamktform.name.$valid&&$scope.kt.streamktform.description.$valid:void 0},setTimeout(function(){$(".alertsModalSliderBody").scrollTop(1)},1e3),$scope.botNameMatched=!1,$scope.validateTaskName=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression();return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,{test:function(value){var _selectedLanguage=$workflowService.currentLanguage();return _selectedLanguage&&"en"===_selectedLanguage?regexp.test(value):regexp2.test(value)}}}()}])}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("botsContentPanel",function(){return{transclude:!0,templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bots-landing-forms/bots-content-panel/bots-content-panel.html",controller:"botsContentPanelCtrl",link:function(scope,elem,attrs){}}}),_module.controller("botsContentPanelCtrl",["$scope","$rootScope","$window","_constants_","$interval","$timeout","i18n",function($scope,$rootScope,$window,_constants_,$interval,$timeout,i18n){var _whatfixFlowsMap=_constants_.config.whatfix.flowsMap;$scope.standardBot=window.appConfig.CONTEXT_PATH+"/assets/landingImages/icons/standard-bot.png",$scope.importBot=window.appConfig.CONTEXT_PATH+"/assets/landingImages/icons/import-bot.png",$scope.template=window.appConfig.CONTEXT_PATH+"/assets/landingImages/icons/template.png",$scope.welcome=window.appConfig.CONTEXT_PATH+"/assets/landingImages/welcome.png",$scope.aha=window.appConfig.CONTEXT_PATH+"/assets/landingImages/aha.png",$scope.placeHolderOne=window.appConfig.CONTEXT_PATH+"/assets/landingImages/placeHolder-1.png",$scope.dialog=window.appConfig.CONTEXT_PATH+"/assets/landingImages/icons/dialog.png",$scope.nlp=window.appConfig.CONTEXT_PATH+"/assets/landingImages/icons/nlp.png",$scope.sampleTask=window.appConfig.CONTEXT_PATH+"/assets/landingImages/icons/sampleTask.png",$scope.task=window.appConfig.CONTEXT_PATH+"/assets/landingImages/icons/task.png",$scope.carousalArrow=window.appConfig.CONTEXT_PATH+"/assets/images/carousalArrow.svg",$scope.slides=[{heading:i18n.i18nString("platform_videos"),taskType:i18n.i18nString("learn_bot_building"),description:i18n.i18nString("complex_conversation"),image:window.appConfig.CONTEXT_PATH+"/assets/images/demoVideos.png",videoLink:"openVediosPage"},{heading:i18n.i18nString("bot_task"),taskType:i18n.i18nString("lamultiple_usecasesng"),description:i18n.i18nString("bots_servicecall"),image:window.appConfig.CONTEXT_PATH+"/assets/images/botTasks.png",videoLink:"https://www.youtube.com/watch?v=nlYuObkQMHw",linkKey:"BOT_TASKS_HELP"},{heading:i18n.i18nString("knowledge_graph"),taskType:i18n.i18nString("bot_ontology_faq"),description:i18n.i18nString("kg_static_faqs"),image:window.appConfig.CONTEXT_PATH+"/assets/images/knowledgeGraph.png",videoLink:"https://www.youtube.com/watch?v=d25sUgjKKJc",linkKey:"KNOWLEDGE_GRAPH"},{heading:i18n.i18nString("nl_process"),taskType:i18n.i18nString("dual_pronged"),description:i18n.i18nString("hybrid_nlp"),image:window.appConfig.CONTEXT_PATH+"/assets/images/nlProcessing.png",videoLink:"https://www.youtube.com/watch?v=d25sUgjKKJc",linkKey:"BOT_NL_HELP"}],$scope.triggerTour=function(e,tourId){var _loader=$(e.currentTarget).find(".guide-loader");_loader.removeClass("hide"),$(".scrollDiv").scrollTop(0);var _keepChecking=$interval(function(){$(".WFEMEU").length&&($interval.cancel(_keepChecking),_loader.addClass("hide"))},500);tourId&&_whatfixFlowsMap[tourId]&&(window._wfx_flow=_whatfixFlowsMap[tourId],window._wfx_live&&window._wfx_live())},$scope.changeCourosel=function(ele){$(ele).click()},$scope.$on("updateStore",function(e,value){value.hasOwnProperty("loadStore")&&$scope.$apply(function(){$scope.loadingStore=value.loadStore,$scope.iframeLoadingStore=!1})}),$scope.$on("iframeLoadStoreEvent",function(e){$scope.$apply(function(){$scope.iframeLoadingStore=!1})})}])}(angular),function(ng){var _botsHome=ng.module("bt-forms");_botsHome.controller("botsHomeCtrl",["$scope","$rootScope","builderUtility","$window","$timeout","env_conf","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","$q","security","$translator","$ocLazyLoad","$compile","templateCompiler","$location","shortcutKeys","navigator","interactiveHelp","localstore","versionMonitor","i18n","AuthService","jsEvents","mixPanel",function($scope,$rootScope,builderUtility,$window,$timeout,env_conf,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,$q,security,$translator,$ocLazyLoad,$compile,templateCompiler,$location,shortcutKeys,navigator,interactiveHelp,localstore,versionMonitor,i18n,AuthService,jsEvents,mixPanel){function checkforVariablesConfig(){var stream=$workflowService.selectedStream(),variables=$workflowService.botEnvVariables()||[],validVariables=_.filter(variables,function(variable){return variable.key&&variable.value}),configCompleted=!0;return"setup"===stream.state&&(configCompleted=!1),variables&&variables.length&&variables.length!==validVariables.length&&(configCompleted=!1),configCompleted}function openChatWindow(){$scope.closeHelpModal(),$(".runBotBtn").click(),$scope.callbacks.setChecklistValues("openChat")}function openProcessAppFlow(screen){$scope.changeOverText=!1;var quickguideObj={_id:screen._id,checkedValue:screen.checkedValue,type:screen.type};"appSetup"==screen._id||"instruction"==screen._id?("instruction"==screen._id&&($scope.changeOverText=!0),$("#helpModal").find("#botModalSlider").addClass("unsetLeft")):("portal"==screen._id&&$("#navigateToProcessPortal").click(),$scope.changeOverText=!1,jsEvents.postMessageToChildIframes("closeSetupSliderModal","#processFlowsFrame"),$scope.closeHelpModal()),jsEvents.postMessageToChildIframes("navigateToProcessScreen","#processFlowsFrame",quickguideObj)}function openSampleBotInstalation(id,getoptions){var options={showTemplateInstalation:!0,initialSetup:$scope.callbacks.invokeSetUp,id:id,openChat:openChatWindow};return $scope.helpGuideOptions&&$scope.helpGuideOptions.setTabs&&($scope.helpGuideOptions.setTabs(options),options.setTabs=$scope.helpGuideOptions.setTabs),getoptions?options:void($scope.checkForSmapleBot($workflowService.selectedStream())&&$scope.showInstallationModal(null,options,id))}function openDialogSlider(id){var options={showTaskCreation:!0,taskType:"dialogTasks",id:id};$scope.showInstallationModal(null,options)}function prepareHelpSliderObjs(){"bots"==$scope.selectedHomeTab&&($scope.quickStartGuideObject=[{text:i18n.i18nString("design_conversations"),icon:$scope.maintenance,values:[{_id:"dialogTasks",name:i18n.i18nString("ddval_dialog"),icon:$scope.messaging,selectedIcon:$scope.messagingGreen,type:"dialogTasks",checkedValue:!1,description:i18n.i18nString("build_multiTurn"),linkTextForHelp:i18n.i18nString("help_section"),linkForHelp:"https://developer.kore.ai/docs/bots/bot-builder-tool/dialog-task/dialog-tasks/#creating-a-dialog-task",button:i18n.i18nString("create_dialog"),action:openDialogSlider},{_id:"knowledgeCollection",name:i18n.i18nString("kg_faqs"),icon:$scope.faq,selectedIcon:$scope.faqGreen,type:"knowledgeCollection",checkedValue:!1,description:i18n.i18nString("add_frequent_Asked"),linkMainTextForHelp:i18n.i18nString("learn_more_label"),linkForHelp:"https://developer.kore.ai/docs/bots/bot-builder/defining-bot-tasks/kore-ai-knowledge-graph/creating-a-knowledge-graph/",button:i18n.i18nString("createKnowledgeGraph")}]},{text:i18n.i18nString("train_assistant"),icon:$scope.administratorGuide,values:[{_id:"machineLearningUtterances",name:i18n.i18nString("add_utterances_label"),icon:$scope.talk,selectedIcon:$scope.talkGreen,type:"machineLearningUtterances",checkedValue:!1,description:i18n.i18nString("train_assistant_identify"),linkMainTextForHelp:i18n.i18nString("learn_more_label"),linkForHelp:"https://developer.kore.ai/docs/bots/bot-builder-tool/train-nlp-optimization/machine-learning/user-utterances/",button:i18n.i18nString("proceed")}]},{text:i18n.i18nString("test"),icon:$scope.testPassed,values:[{_id:"openChat",name:i18n.i18nString("Simulate"),icon:$scope.simulateIcon,type:"openChat",selectedIcon:$scope.simulateIconGreen,checkedValue:!1,action:openChatWindow,description:i18n.i18nString("test_your_virtual"),button:i18n.i18nString("proceed")},{_id:"testTrain",name:i18n.i18nString("utterance_testing"),icon:$scope.utteranceIcon,type:"testTrain",checkedValue:!1,selectedIcon:$scope.utteranceIconGreen,description:i18n.i18nString("test_intent_entity"),button:i18n.i18nString("proceed")},{_id:"batchTesting",name:i18n.i18nString("batch_testing"),icon:$scope.passFail,type:"batchTesting",checkedValue:!1,selectedIcon:$scope.passFailGreen,description:i18n.i18nString("create_testCases"),button:i18n.i18nString("proceed")},{_id:"conversationTesting",name:i18n.i18nString("Conversation_Testing"),icon:$scope.communication,type:"conversationTesting",selectedIcon:$scope.communicationGreen,checkedValue:!1,description:i18n.i18nString("record_conversation_create"),button:i18n.i18nString("proceed")}]},{text:i18n.i18nString("nav_tab_name_deploy"),icon:$scope.rocket,values:[{_id:"channels",name:i18n.i18nString("configure_channel"),icon:$scope.multiChannel,type:"channels",checkedValue:!1,description:i18n.i18nString("configure_virtual_assistants"),button:i18n.i18nString("proceed"),selectedIcon:$scope.multiChannelGreen},{_id:"publish",name:i18n.i18nString("publish"),icon:$scope.noChat,type:"publish",checkedValue:!1,description:i18n.i18nString("make_virtual_assistant"),button:i18n.i18nString("proceed"),selectedIcon:$scope.noChatGreen}]}],$scope.quickStartObjectFromTemplate=[{text:i18n.i18nString("template_setup"),icon:$scope.TemplateIcon,values:[{_id:"overview",name:i18n.i18nString("overview"),description:i18n.i18nString("explore_capabilities"),hideText:i18n.i18nString("hide_overview"),checkedValue:!0,action:openSampleBotInstalation,button:i18n.i18nString("show_overview"),icon:$scope.bulletListedOverview,type:"overview",selectedIcon:$scope.bulletListedOverview},{_id:"configure",name:i18n.i18nString("configure_params"),description:i18n.i18nString("complete_template"),checkedValue:checkforVariablesConfig(),action:openSampleBotInstalation,button:i18n.i18nString("configure"),icon1:$scope.configureVariable,icon2:$scope.configureError,type:"configure"}]},{text:i18n.i18nString("review_skills"),icon:$scope.maintenance,values:[{_id:"dialogTasks",name:i18n.i18nString("ddval_dialog"),icon:$scope.messaging,type:"dialogTasks",checkedValue:!1,description:i18n.i18nString("explore_multiturn"),linkTextForHelp:i18n.i18nString("help_section"),linkForHelp:"https://developer.kore.ai/docs/bots/bot-builder-tool/dialog-task/dialog-tasks/#creating-a-dialog-task",button:"setup"===$workflowService.selectedStream().state&&$workflowService.selectedStream().taskCounts&&$workflowService.selectedStream().taskCounts.dialogs&&$workflowService.selectedStream().taskCounts.dialogs.length?"View Dialog":i18n.i18nString("create_dialog"),action:"setup"!==$workflowService.selectedStream().state?openDialogSlider:"",selectedIcon:$scope.messagingGreen},{_id:"knowledgeCollection",name:i18n.i18nString("kg_faqs"),icon:$scope.faq,type:"knowledgeCollection",checkedValue:!1,description:i18n.i18nString("explore_frequently"),linkMainTextForHelp:i18n.i18nString("learn_more"),linkForHelp:"https://developer.kore.ai/docs/bots/bot-builder-tool/dialog-task/dialog-tasks/#creating-a-dialog-task",button:"setup"===$workflowService.selectedStream().state&&$workflowService.selectedStream().taskCounts&&$workflowService.selectedStream().taskCounts.ktasks&&0!==$workflowService.selectedStream().taskCounts.ktasks.length?"View Knowledge Graph":"Create Knowledge Graph",selectedIcon:$scope.faqGreen}]},{text:i18n.i18nString("review_training_label"),icon:$scope.administratorGuide,values:[{_id:"machineLearningUtterances",name:i18n.i18nString("training_utterance"),icon:$scope.talk,type:"machineLearningUtterances",checkedValue:!1,description:i18n.i18nString("review_train_assistant"),linkMainTextForHelp:i18n.i18nString("learn_more"),linkForHelp:"https://developer.kore.ai/docs/bots/bot-builder-tool/dialog-task/dialog-tasks/#creating-a-dialog-task",button:i18n.i18nString("proceed"),selectedIcon:$scope.talkGreen}]},{text:i18n.i18nString("test"),icon:$scope.testPassed,values:[{_id:"openChat",name:i18n.i18nString("Simulate"),icon:$scope.simulateIcon,type:"openChat",checkedValue:!1,action:openChatWindow,description:i18n.i18nString("test_your_virtual"),button:i18n.i18nString("proceed"),selectedIcon:$scope.simulateIconGreen},{_id:"testTrain",name:i18n.i18nString("utterance_testing"),icon:$scope.utteranceIcon,type:"testTrain",checkedValue:!1,description:i18n.i18nString("test_intent_entity"),button:i18n.i18nString("proceed"),selectedIcon:$scope.utteranceIconGreen},{_id:"batchTesting",name:i18n.i18nString("batch_testing"),icon:$scope.passFail,type:"batchTesting",checkedValue:!1,selectedIcon:$scope.passFailGreen,description:i18n.i18nString("create_testCases"),button:i18n.i18nString("proceed")},{_id:"conversationTesting",name:i18n.i18nString("Conversation_Testing"),icon:$scope.communication,selectedIcon:$scope.communicationGreen,type:"conversationTesting",checkedValue:!1,description:i18n.i18nString("record_conversation_create"),button:i18n.i18nString("proceed")}]},{text:i18n.i18nString("nav_tab_name_deploy"),icon:$scope.rocket,values:[{_id:"channels",name:i18n.i18nString("configure_channel"),icon:$scope.multiChannel,type:"channels",checkedValue:!1,description:i18n.i18nString("configure_virtual_assistants"),button:i18n.i18nString("proceed"),selectedIcon:$scope.multiChannelGreen},{_id:"publish",name:i18n.i18nString("publish"),icon:$scope.noChat,type:"publish",checkedValue:!1,description:i18n.i18nString("make_virtual_assistant"),button:i18n.i18nString("proceed"),selectedIcon:$scope.noChatGreen}]}],$scope.quickStartGuideUniversalObject=[{text:i18n.i18nString("design_conversations"),icon:$scope.maintenance,values:[{_id:"linkedBots",name:i18n.i18nString("linked_bots"),icon:$scope.messaging,selectedIcon:$scope.messagingGreen,type:"linkedBots",checkedValue:!1,description:i18n.i18nString("linked_bot_tooltip"),linkTextForHelp:i18n.i18nString("help_section"),linkForHelp:"https://developer.kore.ai/docs/bots/advanced-topics/universal-bot/creating-a-universal-bot/#Step_2_Add_Linked_Bots",button:i18n.i18nString("link_bots")}]},{text:i18n.i18nString("train_assistant"),icon:$scope.administratorGuide,values:[{_id:"linkedBotTraining",name:i18n.i18nString("add_utterances_label"),icon:$scope.talk,selectedIcon:$scope.talkGreen,type:"linkedBotTraining",checkedValue:!1,description:i18n.i18nString("train_assistant_identify"),linkMainTextForHelp:i18n.i18nString("learn_more"),linkForHelp:"https://developer.kore.ai/docs/bots/bot-builder-tool/train-nlp-optimization/machine-learning/user-utterances/",button:i18n.i18nString("proceed")}]},{text:i18n.i18nString("test"),icon:$scope.testPassed,values:[{_id:"openChat",name:i18n.i18nString("Simulate"),icon:$scope.simulateIcon,type:"openChat",selectedIcon:$scope.simulateIconGreen,checkedValue:!1,action:openChatWindow,description:i18n.i18nString("test_your_virtual"),button:i18n.i18nString("proceed")},{_id:"testTrain",name:i18n.i18nString("utterance_testing"),icon:$scope.utteranceIcon,type:"testTrain",checkedValue:!1,selectedIcon:$scope.utteranceIconGreen,description:i18n.i18nString("test_intent_entity"),button:i18n.i18nString("proceed")},{_id:"batchTesting",name:i18n.i18nString("batch_testing"),icon:$scope.passFail,type:"batchTesting",checkedValue:!1,selectedIcon:$scope.passFailGreen,description:i18n.i18nString("create_testCases"),button:i18n.i18nString("proceed")},{_id:"conversationTesting",name:i18n.i18nString("Conversation_Testing"),icon:$scope.communication,type:"conversationTesting",selectedIcon:$scope.communicationGreen,checkedValue:!1,description:i18n.i18nString("record_conversation_create"),button:i18n.i18nString("proceed")}]},{text:i18n.i18nString("nav_tab_name_deploy"),icon:$scope.rocket,values:[{_id:"channels",name:i18n.i18nString("configure_channel"),icon:$scope.multiChannel,type:"channels",checkedValue:!1,description:i18n.i18nString("configure_virtual_assistants"),button:i18n.i18nString("proceed"),selectedIcon:$scope.multiChannelGreen},{_id:"publish",name:i18n.i18nString("publish"),icon:$scope.noChat,type:"publish",checkedValue:!1,description:i18n.i18nString("make_virtual_assistant"),button:i18n.i18nString("proceed"),selectedIcon:$scope.noChatGreen}]}],Object.keys($workflowService.selectedStream())&&$scope.checkForSmapleBot($workflowService.selectedStream())?$scope.quickStartGuideMainObject=$scope.quickStartObjectFromTemplate:Object.keys($workflowService.selectedStream())&&$workflowService.selectedStream().type&&"universalbot"===$workflowService.selectedStream().type?$scope.quickStartGuideMainObject=$scope.quickStartGuideUniversalObject:$scope.quickStartGuideMainObject=$scope.quickStartGuideObject),"processApps"==$scope.selectedHomeTab&&($scope.quickStartGuideProcessTemplateObject=[{text:"Template Setup",icon:$scope.template,values:[{_id:"instruction",name:i18n.i18nString("instructions"),icon:$scope.messaging,type:"instructions",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("instructions_desc"),hideText:i18n.i18nString("hide_overview"),button:i18n.i18nString("show_overview"),selectedIcon:$scope.overviewGreen},{_id:"appSetup",name:i18n.i18nString("configure_parameters"),icon:$scope.workflow,type:"appSetup",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("configure_parameters_desc"),button:i18n.i18nString("configure"),selectedIcon:$scope.variableNewGreen}]},{text:"Build",icon:$scope.maintenanceBuild,values:[{_id:"reviewFlow",name:i18n.i18nString("flow"),icon:$scope.workflow,type:"reviewFlow",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("flow_review_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.workflowGreen},{_id:"reviewForms",name:i18n.i18nString("forms"),icon:$scope.form,type:"reviewForms",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("forms_review_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.formGreen},{_id:"channels",name:i18n.i18nString("channels"),icon:$scope.testPassed,type:"reviewChannels",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("channels_review_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.multiChannelTypeGreen},{_id:"simulation",name:i18n.i18nString("Simulate"),icon:$scope.simulate,type:"simulation",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("simulate_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.simulateGreen}]},{text:"Deploy",icon:$scope.deploy,values:[{_id:"visibility",name:i18n.i18nString("visibility"),icon:$scope.eye,type:"visibility",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("visibility_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.eyeGreen},{_id:"portal",name:i18n.i18nString("portal"),icon:$scope.www,type:"portal",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("portal_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.wwwGreen},{_id:"publish",name:i18n.i18nString("publish"),icon:$scope.publishIcon,type:"publish",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("publish_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.publishGreen}]}],$scope.quickStartGuideProcessScratchObject=[{text:"Build",icon:$scope.maintenanceBuild,values:[{_id:"flowSetup",name:i18n.i18nString("flow"),icon:$scope.workflow,type:"flowSetup",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("flow_setup_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.workflowGreen},{_id:"formsSetup",name:i18n.i18nString("forms"),icon:$scope.form,type:"formsSetup",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("forms_setup_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.formGreen},{_id:"channels",name:i18n.i18nString("channels"),icon:$scope.multiChannel,type:"channelSetup",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("channels_setup_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.multiChannelTypeGreen},{_id:"simulation",name:i18n.i18nString("Simulate"),icon:$scope.simulate,type:"simulation",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("simulate_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.simulateGreen}]},{text:"Deploy",icon:$scope.deploy,values:[{_id:"visibility",name:i18n.i18nString("visibility"),icon:$scope.eye,type:"visibility",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("visibility_desc"),
button:i18n.i18nString("proceed"),selectedIcon:$scope.eyeGreen},{_id:"portal",name:i18n.i18nString("portal"),icon:$scope.www,type:"portal",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("portal_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.wwwGreen},{_id:"publish",name:i18n.i18nString("publish"),icon:$scope.publishIcon,type:"publish",checkedValue:!1,action:openProcessAppFlow,description:i18n.i18nString("publish_desc"),button:i18n.i18nString("proceed"),selectedIcon:$scope.publishGreen}]}])}function checkForPermissions(){$scope.selectedAccount=$workflowService.selectedAccount(),$scope.selectedAccount.roles.length&&($scope.permissionValue=$scope.selectedAccount.permissions.some(function(permission){return-1!==$.inArray(permission,userPermissionList)?!0:!1}))}function loadDirective(formType){if(_loadingDirScript)return!1;$location.search({}),$location.hash("");var dirObj=templateCompiler.getDirectiveObject(formType),_ele=$('script[src="'+window.appConfig.TMPLT_PRE_PATH+dirObj.js+'"]');_ele&&_ele.length?(angular.element(".botsHome").hasClass(formType)||(angular.element(".botsHome").addClass(formType),addDirective(dirObj)),$scope.directiveLoading=!1):(_loadingDirScript=!0,$ocLazyLoad.load(window.appConfig.TMPLT_PRE_PATH+dirObj.js).then(function(){_loadingDirScript=!1,angular.element(".botsHome").addClass(formType),addDirective(dirObj),"botsForm"!==formType&&"botDetailsForm"!==formType&&$timeout(function(){$scope.directiveLoading=!1},0)},function(e){console.error("Failed Loading directive"),$scope.directiveLoading=!1}))}function addDirective(dirObj){var el,elToAppend;el=angular.element(".botsHome");var compileFn;dirObj.compileFn?compileFn=dirObj.compileFn:(compileFn=$compile(dirObj.template),templateCompiler.setCompileFn(dirObj.id,compileFn)),elToAppend=compileFn($scope,function(clonedElement,scope){el.append(clonedElement)})}function BotsCollection(){return _botsCollection?_botsCollection:(this.allBots=[],this.recentBots=[],this.yourBots=[],void(this.sharedBots=[]))}function getAppControls(){var url="mp.user.appControlList",params={userId:_userInfo.userId};return $translator.translate(url,params)}function createAccount(){var _accountName=$(".accountname-capture input").val();_accountName?($(".accounts-warn-modal .create-account").html("Creating...."),$translator.translate("bt.account.activate",{accountId:_userInfo.appControls.accountId},{accountName:_accountName}).then(function(res){getAppControls().then(function(res){var _appControlsData=res.data,_selfAccount=_.find(_appControlsData.associatedAccounts,function(account){return account.self});_selfAccount&&(selfAccountCreated(_selfAccount),$rootScope.$emit("onAccountsUpdate",_selfAccount))})})):NotificationService.notify(i18n.i18nString("notify_account"),"warning")}function selfAccountCreated(selfAccount){tempSelfAccount=selfAccount,_noSelfAccountDialog&&_noSelfAccountDialog.modal("hide"),window.bootbox.dialog({message:'<div class="accountname-capture sucessDiv">\n                                <img src="'+$scope.sucessTickGreen+'">\n                                <div class="col-xs-12">\n                                    <h5>'+i18n.i18nString("account_success")+'</h5>\n                                </div>\n                                <div class="col-xs-12">\n                                     <a class="goto-self-account">'+i18n.i18nString("ddval_goto")+" "+(selfAccount&&selfAccount.displayName?selfAccount.displayName:"")+"<a/>\n                                </div>\n                            </div>",title:i18n.i18nString("success"),className:"accounts-warn-modal",buttons:{main:{label:i18n.i18nString("ok"),className:"btn create-account",callback:function(){$scope.canCreateAccount=!1,$scope.accounts.push(selfAccount)}}}})}function showNoSelfAccount(){_noSelfAccountDialog=window.bootbox.dialog({message:'<div class="accountname-capture"><div class="col-xs-12"><label class="required-field pull-left"> '+i18n.i18nString("accountname_capture")+' </label></div><div class="col-xs-12"><input placeholder='+i18n.i18nString("accountname_placeholder")+' class="form-control  account-name"></div><div class="col-xs-12"><p class="description">'+i18n.i18nString("account_desc")+"</p></div></div>",title:i18n.i18nString("account_title"),className:"accounts-warn-modal",buttons:{main:{label:i18n.i18nString("account_create"),className:"create-account",callback:function(){return createAccount(),!1}},success:{label:i18n.i18nString("account_cancel"),className:"closeCancel",callback:function(){$scope.accounts.length||security.logout()}}}})}function showNoDeveloperAccounts(){window.bootbox.dialog({message:'<div class="text-center" >'+i18n.i18nString("no_developer_account")+"</div>",title:i18n.i18nString("no_developer_account_title"),className:"accounts-warn-modal",buttons:{success:{label:i18n.i18nString("no_developer_account_label"),className:"btn closeCancel",callback:function(){security.logout()}}}})}function checkOpeningKnowledgeGraph(){var previousStateObj,options=$workflowService.kgDataFromKora(),storeOptions=$workflowService.sampleBotDataFromBotStore();if(options&&options.isFromKora){var streamId,kgId,dgId,path=options.path;if(path.indexOf("/knowledge")>0){streamId=path.substring(path.indexOf("/kora")+6,path.indexOf("/knowledge")),kgId=path.substring(path.indexOf("/knowledge")+11,path.length);for(var tempKg=path.split("/"),i=0;i<tempKg.length;i++)if("knowledge"==tempKg[i]){kgId=tempKg[i+1];break}}path.indexOf("/dialog")>0&&(streamId=path.substring(path.indexOf("/kora")+6,path.indexOf("/dialog")),dgId=path.substring(path.indexOf("/dialog")+8,path.length)),streamId&&kgId?(previousStateObj={path:["botDetailsForm","botTasks","knowledgeCollection"],selectedStream:{_id:streamId,accountId:$workflowService.selectedAccount().accountId},selectedStreamState:"indevelopment",selectedTaskType:"knowledgeTask",selectedTaskId:kgId,selectedLanguage:$workflowService.currentLanguage(),appVersion:versionMonitor.getAppVersion(),account:$workflowService.selectedAccount(),isFromKora:!0,menu:"knowledgeCollection",tab:"skills"},window.localStorage.setItem("previousState",JSON.stringify(previousStateObj))):streamId&&dgId&&(previousStateObj={path:["botDetailsForm","botTasks","dialogTasks"],selectedStream:{_id:streamId,accountId:$workflowService.selectedAccount().accountId},selectedStreamState:"indevelopment",selectedLanguage:$workflowService.currentLanguage(),selectedTaskType:"flowtaskEdit",selectedTaskId:dgId,appVersion:versionMonitor.getAppVersion(),account:$workflowService.selectedAccount(),isFromKora:!0,menu:"dialogTasks",tab:"skills"},window.localStorage.setItem("previousState",JSON.stringify(previousStateObj)))}if(options&&options.landOnKg?(previousStateObj={path:["botDetailsForm","botTasks","knowledgeCollection"],selectedStream:{_id:options.streamId,accountId:options.selectedAccount},selectedLanguage:$workflowService.currentLanguage(),selectedStreamState:"indevelopment",selectedTaskType:"knowledgeTask",selectedTaskId:options.kgId,smartassist:!0,appVersion:versionMonitor.getAppVersion(),account:$workflowService.selectedAccount(),menu:"knowledgeCollection",tab:"skills"},window.localStorage.setItem("previousState",JSON.stringify(previousStateObj))):options&&options.landOnDialog?(previousStateObj={path:["botDetailsForm","botTasks","dialogTasks"],selectedStream:{_id:options.streamId,accountId:options.selectedAccount},selectedStreamState:options.state,selectedLanguage:$workflowService.currentLanguage(),selectedTaskType:"published"==options.state?"flowtaskView":"flowtaskEdit",selectedTaskId:options.dgId,smartassist:!0,menu:"dialogTasks",tab:"skills",appVersion:versionMonitor.getAppVersion(),account:$workflowService.selectedAccount()},window.localStorage.setItem("previousState",JSON.stringify(previousStateObj))):options&&options.landOnPublish&&(previousStateObj={path:["botDetailsForm","publish"],selectedStream:{_id:options.streamId,accountId:options.accountId},selectedLanguage:$workflowService.currentLanguage(),selectedStreamState:"indevelopment",smartassist:!0,menu:"publish",tab:"deploy",appVersion:versionMonitor.getAppVersion(),account:$workflowService.selectedAccount()},window.localStorage.setItem("previousState",JSON.stringify(previousStateObj))),options&&options.landOnStream){$scope.isFromKora=options.isFromKora;var prevStateObj={path:["botDetailsForm","botTasks","dialogTasks"],selectedStream:{_id:options.streamId,accountId:$workflowService.selectedAccount().accountId},selectedStreamState:"indevelopment",selectedLanguage:$workflowService.currentLanguage(),appVersion:versionMonitor.getAppVersion(),account:$workflowService.selectedAccount(),isFromKora:$scope.isFromKora};window.localStorage.setItem("previousState",JSON.stringify(prevStateObj))}if(storeOptions&&storeOptions.landOnSummary){var prevStateObjStore={path:["botDetailsForm","botSummary"],selectedStream:{_id:storeOptions.streamId,accountId:$workflowService.selectedAccount().accountId},selectedStreamState:"indevelopment",selectedLanguage:$workflowService.currentLanguage(),appVersion:versionMonitor.getAppVersion(),account:$workflowService.selectedAccount()};window.localStorage.setItem("previousState",JSON.stringify(prevStateObjStore)),storeOptions={},$workflowService.sampleBotDataFromBotStore(storeOptions),$scope.callbacks.invokeSetUp=!0}var previousState=window.localStorage.getItem("previousState");previousState&&(previousState=JSON.parse(previousState),previousState&&previousState.isFromKora&&($scope.isFromKora=!0))}function getPinnedmenus(){BTStreamsService.getPinnedMenus($applicationService.userInfo().userId).then(function(res){$scope.getPinnedMenus=res.data,$scope.builderNavigator.preparePinnedMenu($scope.getPinnedMenus,!0)},function(err){})}function load(botData,checkForReload){if($rootScope.showLoginLoader=!1,_userInfo=$applicationService.userInfo(),_userInfo.appControls&&_userInfo.appControls.associatedAccounts&&_userInfo.appControls.associatedAccounts.length){if(_userInfo.appControls.associatedAccounts.length>=1&&($scope.builderHeader.menuItems.accounts=!0),_userInfo.appControls.associatedAccounts=_.filter(_userInfo.appControls.associatedAccounts,function(account){return account.isDeveloper||!1}),_userInfo.appControls.associatedAccounts.length<=0)return showNoDeveloperAccounts(),!1;$scope.defaultAccountId=_userInfo.appControls.defaultAccountId||"",_selectetedAccount=_userInfo.appControls.associatedAccounts[0];var _selfAccount=_.find(_userInfo.appControls.associatedAccounts,function(account){return account.self});_selfAccount?_selectetedAccount=_selfAccount:($scope.canCreateAccount=!0,_userInfo.appControls.self_signup_enabled||($scope.canCreateAccount=!1));var _defaultAccountId=_.find(_userInfo.appControls.associatedAccounts,function(account){return $scope.defaultAccountId===account.accountId});_defaultAccountId&&(_selectetedAccount=_defaultAccountId);var _chosenAccount=_.find(_userInfo.appControls.associatedAccounts,function(account){return _userInfo.appControls.chosenAccountId===account.accountId});_chosenAccount&&(_selectetedAccount=_chosenAccount);var _fromSelection=localstore.getSelectedAccount();_fromSelection?(_selectetedAccount=_fromSelection,_selectetedAccount=_.find(_userInfo.appControls.associatedAccounts,{accountId:_fromSelection.accountId})):localstore.setSelectedAccount(_selectetedAccount);var options=$workflowService.kgDataFromKora();if(options&&options.landOnStream&&options.selectedAccount){var _accountFromURl=_.find(_userInfo.appControls.associatedAccounts,function(account){return options.selectedAccount===account.accountId});_accountFromURl&&(_selectetedAccount=_accountFromURl,localstore.setSelectedAccount(_selectetedAccount))}checkForWhiteList(_selectetedAccount,botData,checkForReload)}}function loadBotPrimaryDependentApis(botData,checkForReload){loadSubFunction(botData,checkForReload),getPinnedmenus()}function checkForWhiteList(_selectetedAccount,botData,checkForReload){var storeOptions=$workflowService.sampleBotDataFromBotStore();if(storeOptions&&storeOptions.landOnSummary&&storeOptions.accountId){var storeAccountUrl=_.find(_userInfo.appControls.associatedAccounts,function(account){return storeOptions.accountId===account.accountId});storeAccountUrl&&(_selectetedAccount=storeAccountUrl,localstore.setSelectedAccount(_selectetedAccount))}$translator.translate("bt.post.IpWhiteList",{},{accountId:_selectetedAccount.accountId}).then(function(res){res&&200==res.status?(setAccount(),checkForBotInstalations(_selectetedAccount,botData,checkForReload)):NotificationService.notify("Something went wrong!","error")},function(error){console.error(error)})}function checkForBotInstalations(_selectetedAccount,botData,checkForReload){globalStoreOptions&&globalStoreOptions.streamId?($scope.installingBot=!0,BTStreamsService.installSampleBotFromStore(globalStoreOptions.streamId).then(function(res){if($workflowService.globalStoreQueryParams({}),"pending"===res.data.status.toLowerCase())$scope.statusPollInit=startInstallPoll(res.data._id,3e3,_selectetedAccount);else if("success"===res.data.status.toLowerCase()){var _botData={_id:res.data.streamId};res&&200==res.status?loadBotPrimaryDependentApis(_botData,!1):(loadBotPrimaryDependentApis(_botData,!1),NotificationService.notify("Something went wrong!","error")),stopStatusPoll();var eventObj={Category:"Activation","Sub Category":"Activation - VA",Level:"ONBOARDING AND ACTIVATION",streamId:botData._id};mixPanel.postEvent("VA - Install App Completed",eventObj)}else"failure"===res.data.status.toLowerCase()&&(stopStatusPoll(),loadBotPrimaryDependentApis(botData,!1),NotificationService.notify("Bot Installation Failed","error"))},function(err){loadBotPrimaryDependentApis(botData,!1),$scope.installingBot=!1,NotificationService.notify(err.data.errors[0].msg,"error"),$scope.isWorkProgress=!1})):loadBotPrimaryDependentApis(botData,checkForReload)}function startInstallPoll(statusId,timeout,_selectetedAccount){return setInterval(function(){BTStreamsService.sampleBotpollStatus($applicationService.userInfo().userId,statusId).then(function(res){if(res&&res.data)if("success"===res.data.status.toLowerCase()){stopStatusPoll();var _sampleObj={landOnSummary:!0,streamId:res.data.streamId,accountId:_selectetedAccount.accountId};$workflowService.sampleBotDataFromBotStore(_sampleObj);var botData={_id:res.data.streamId};loadBotPrimaryDependentApis(botData,!1);var eventObj={Category:"Activation","Sub Category":"Activation - VA",Level:"ONBOARDING AND ACTIVATION",streamId:botData._id};mixPanel.postEvent("VA - Install App Completed",eventObj)}else"failure"===res.data.status.toLowerCase()&&(stopStatusPoll(),clearInterval(this.progressInterval),loadBotPrimaryDependentApis(null,!1),NotificationService.notify("Bot Installation Failed","error"));else loadBotPrimaryDependentApis(null,!1),stopStatusPoll()},function(err){loadBotPrimaryDependentApis(null,!1),stopStatusPoll(),err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})},timeout)}function stopStatusPoll(){$scope.statusPollInit&&(clearTimeout($scope.statusPollInit),$scope.statusPollInit=null)}function setAccount(){var _fromSSOSelection=localStorage.getItem("selectedSSOAccount");if(_fromSSOSelection){if(_fromSelection=JSON.parse(_fromSSOSelection),_fromSelection.client_email!==_userInfo.authObj.identity)return window.bootbox.dialog({message:i18n.i18nString("sso_selection_message"),title:i18n.i18nString("sso_selection_title"),className:"alert-modal bt-modal-wrong-sso",closeButton:!1,buttons:{main:{label:i18n.i18nString("sso_selection_label"),className:"btn-primary",callback:function(){localStorage.removeItem("selectedSSOAccount"),security.logout()}}}}),!1;_selectetedAccount=_fromSelection,localstore.setSelectedAccount(_selectetedAccount),localStorage.removeItem("selectedSSOAccount")}$workflowService.selectedAccount(_selectetedAccount),$scope.accounts=_userInfo.appControls.associatedAccounts,$scope.selectedAccount=_selectetedAccount,$scope.hasDataTabAccess=_selectetedAccount.hasDataTableAndViewAccess,$scope.hasProcessAppTabAccess=_selectetedAccount.isAppDeveloper}function loadSubFunction(botData,checkForReload){function getDomain(email){if(email){var atRateIndex=email.indexOf("@");return email.substr(atRateIndex+1)}}function changePattern(name){return name?name.replace(/&gt;/g,">").replace(/&lt;/g,"<"):name}$workflowService.globalStoreQueryParams({}),$scope.installingBot=!1,globalStoreOptions=null,$scope.loadingBots=!0;var fromLoginScreen=localstore.getFromLoginScreenFlag();fromLoginScreen&&(AuthService.sendLoginAuditEvent(),localstore.removeFromLoginScreenFlag()),checkOpeningKnowledgeGraph(),$scope.appVersion=env_conf["app-version"],$workflowService&&$workflowService.btAppVersion&&$workflowService.btAppVersion($scope.appVersion);var _tempBuilderHistory=JSON.parse(window.localStorage.getItem("previousState"));_tempBuilderHistory&&_tempBuilderHistory.appVersion==$scope.appVersion?$scope.builderLocalHistory=_tempBuilderHistory:localStorage.removeItem("previousState"),checkForPermissions();var currentUser=localstore.getAuthData().currentAccount;$scope.isDomainKore="kore"===getDomain(currentUser.userInfo.emailId).split(".")[0],checkForReload&&$scope.builderLocalHistory&&$scope.builderLocalHistory.selectedStream&&$scope.builderLocalHistory.account&&$scope.builderLocalHistory.account.accountId==$workflowService.selectedAccount().accountId&&$scope.builderLocalHistory.path&&($scope.builderLocalHistory.path.length>1&&"botsForm"==$scope.builderLocalHistory.path[0]||"botDetailsForm"===$scope.builderLocalHistory.path[0])?($scope.resumingBuilder=!0,$scope.restorePreviousState($scope.builderLocalHistory.selectedStream,$scope.builderLocalHistory.selectedStreamState,$scope.builderLocalHistory.selectedLanguage)):BTStreamsService.getStreams().then(function(res){_botsCollection=new BotsCollection;for(var i=0;i<res.data.length;i++)res.data[i].description=changePattern(res.data[i].description),res.data[i].name=changePattern(res.data[i].name);if(res.data.length){if(_botsCollection.categorizeBots(res.data),$scope.loadingBots=!1,$scope.allBots=_botsCollection.getBots("allBots"),$scope.recentBots=_botsCollection.getBots("recentBots"),$scope.yourBots=_botsCollection.getBots("yourBots"),$scope.sharedBots=_botsCollection.getBots("sharedBots"),$workflowService.streamsAll($scope.allBots),""!==$workflowService.importedNewBotId().trim()){var importedBot=$scope.allBots.filter(function(bot){return $workflowService.importedNewBotId()===bot._id});if(importedBot&&importedBot.length>0){var _importedBot=angular.extend(botData,importedBot[0]);$workflowService.selectedStream(_importedBot),$workflowService.currentLanguage(importedBot[0].defaultLanguage),$scope.currentLanguage=importedBot[0].defaultLanguage,botData||(botData=$workflowService.selectedStream())}$workflowService.importedNewBotId(" ")}if(botData){var _streamDataFromAll=_.find(res.data,{_id:botData._id});$scope.botSelected(_streamDataFromAll),$workflowService.currentLanguage(_streamDataFromAll.defaultLanguage),botData=angular.extend(botData,_streamDataFromAll),botData=_.find(res.data,{_id:botData._id});var language=$workflowService.currentLanguage();botData.defaultLanguage=language,$workflowService.selectedStream(botData),builderUtility.rmBTModalOpenClass(),showView("botDetailsForm"),$scope.callbacks&&$scope.callbacks.getStream?$scope.callbacks.getStream(botData):$scope.callbacks.viewBotDeatils(botData)}else showView("botsForm",!0)}else $scope.loadingBots=!1,showView("noBotsForm"),$workflowService.streamsAll(res.data)},function(err){$scope.loadingBots=!1,err.data&&err.data.error&&"403.503"==err.data.error.code?console.log(err.data.error.msg):NotificationService.notify(i18n.i18nString("loading_error"),"error")}),$scope.bredCrumbLoading=!1}function setupchecklist(ignoreServerFetch,id){id||"bots"!==$scope.selectedHomeTab?"processApps"===$scope.selectedHomeTab&&prepareHelpSliderObjs():prepareHelpSliderObjs(),$scope.updateQuickStartGuideButtonActions(),"bots"==$scope.selectedHomeTab&&!ignoreServerFetch&&$workflowService.selectedStream()&&$workflowService.selectedStream()._id&&($scope.checklistLength=0,$scope.checkEnabledLength=0,BTStreamsService.setupchecklist($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(response){response&&response.data&&!response.data.checklistInfo||!Object.keys(response.data.checklistInfo).length?($scope.checklistResponse={dialogTasks:!1,knowledgeCollection:!1,machineLearningUtterances:!1,openChat:!1,testTrain:!1,batchTesting:!1,conversationTesting:!1,channels:!1,publish:!1},expandUnfinishedGuide()):(response&&response.data&&response.data.checklistInfo&&response.data.checklistInfo.length||Object.keys(response.data.checklistInfo)&&Object.keys(response.data.checklistInfo).length)&&($scope.checklistResponse=response.data.checklistInfo,$scope.updateDynamicquickstartObject(response.data.checklistInfo))},function(err){}))}function expandUnfinishedGuide(){setTimeout(function(){if($scope.callbacks.invokeSetUp)$scope.showExpandedContent="overview";else if("overview"!==$scope.showExpandedContent){var uncheckedItems=$("#helpGuideComponentUnChecked"),top=$(uncheckedItems[0]).offset().top;uncheckedItems&&uncheckedItems.length&&($(".listCards").animate({scrollTop:top-300},500),$(uncheckedItems[0]).click())}},800)}function setChecklistValues(id){if(!$scope.checklistResponse||!$scope.checklistResponse[id]||$scope.checklistResponse[id]!==!0){$scope.checklistResponse[id]=!0;var checkListApi=BTStreamsService.updateChecklist;checkListApi($applicationService.userInfo().userId,$workflowService.selectedStream()._id,$scope.checklistResponse).then(function(response){response&&response.data&&response.data.checklistInfo&&$scope.updateDynamicquickstartObject(response.data.checklistInfo)},function(err){})}}var _userInfo=null,_botsCollection=null;$scope._default=i18n.i18nString("default_lan"),$scope.defaultLabel=i18n.i18nString("default_label"),$scope.disabledLabel=i18n.i18nString("disabled_label_braces"),$scope.getMenuPath=angular.noop(),$scope.obj={},$rootScope.showLoginLoader=!0,$scope.showQuickStartformType="",$scope.botstate={},$scope.botstate.filterToggle="indevelopment",$scope.BuilderContextUrl=env_conf["context-url"],$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.selectedBot={},$scope.loadInstallation=!1,$scope.selectedProcessApp="",$scope.tSearch={text:""},$scope.callback={},$scope.builderNavigator=navigator;var globalStoreOptions=$workflowService.globalStoreQueryParams();globalStoreOptions&&globalStoreOptions.processId?$scope.selectedHomeTab="processApps":$scope.selectedHomeTab="bots",$scope.fullModalCallback={},$scope.chooseLangOption=i18n.i18nString("choose_an_option"),$scope.gSearchPlaceHold=i18n.i18nString("gSearchPlaceHold"),$scope.go_to=i18n.i18nString("ddval_goto"),$scope.Knowledge_collection=i18n.i18nString("ddval_kg"),$scope.assetsBase=env_conf["assets-url"],$scope.caretDown=$scope.assetsBase+"headerIcons/caretDown.svg",$scope.hamburger=$scope.assetsBase+"headerIcons/hamburger.svg",$scope.notifications=$scope.assetsBase+"headerIcons/notifications.svg",$scope.checkTickIcon=$scope.assetsBase+"headerIcons/checkTickIcon.svg",$scope.poweroffIcon=$scope.assetsBase+"headerIcons/poweroffIcon.svg",$scope.koreLogo=env_conf["context-url"]+"/assets/landingImages/kore-logo.svg",$scope.backArrow=env_conf["context-url"]+"/assets/icons/backArrow.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.sucessTickGreen=env_conf["context-url"]+"/assets/icons/sucessTickGreen.svg",$scope.closeWhiteIcon=env_conf["context-url"]+"/assets/icons/closeWhiteIcon.svg",$scope.gHelpIcon=env_conf["context-url"]+"/assets/icons/gHelpIcon.svg",$scope.timerBG=env_conf["context-url"]+"/assets/images/timerBG.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.caretDownGray=env_conf["context-url"]+"/assets/icons-new/caret/caret-down-gray.svg",$scope.arrowLeftWhiteIcon=env_conf["context-url"]+"/assets/icons-new//arrow/arrow-left-white.svg",$scope.nudge=env_conf["context-url"]+"/assets/billing/nudge.svg",$scope.storeImage=env_conf["context-url"]+"/assets/icons-new/store/store.svg",$scope.koreIcon=env_conf["context-url"]+"/assets/logo/kore-icon.svg",$scope.smartKoreIcon=env_conf["context-url"]+"/assets/logo/smart-logo.svg",$scope.brokenImageSmall=env_conf["context-url"]+"/assets/images/brokenImageSmall.png",$scope.maintenance=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/maintenance.svg",$scope.TemplateIcon=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/Template.svg",$scope.administratorGuide=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/administratorGuide.svg",$scope.testPassed=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/testPassed.svg",$scope.rocket=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/rocket.svg",$scope.configureError=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/Error.svg",$scope.bulletListedOverview=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/BulletedList.svg",$scope.configureVariable=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/Variable.svg",$scope.handshake=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/handshake.svg",$scope.messaging=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/messaging.svg",$scope.faq=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/faq.svg",$scope.talk=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/talk.svg",$scope.addList=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/addList.svg",$scope.passFail=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/passFail.svg",$scope.communication=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/communication.svg",$scope.variable=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/variable.svg",$scope.noChat=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/noChat.svg",$scope.simulateIcon=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/circledPlay.svg",$scope.utteranceIcon=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/Advice.svg",$scope.multiChannel=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/Multichannel.svg",$scope.deleteMessage=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/deleteMessage.svg",$scope.paperPlane=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/paperPlane.svg",$scope.handshakeGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/handshake.svg",$scope.messagingGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/messaging.svg",$scope.faqGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/faq.svg",$scope.talkGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/Talk.svg",$scope.addListGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/addList.svg",$scope.passFailGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/passFail.svg",$scope.communicationGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/communication.svg",$scope.variableGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/variable.svg",$scope.noChatGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/noChat.svg",$scope.simulateIconGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/circledPlay.svg",$scope.utteranceIconGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/Advice.svg",$scope.multiChannelGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/Multichannel.svg",$scope.deleteMessageGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/deleteMessage.svg",$scope.paperPlaneGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/small/green/paperPlane.svg",$scope.atSign=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/atSign.svg",$scope.form=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/form.svg",$scope.inspection=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/inspection.svg",$scope.microsoftTeams=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/microsoftTeams.svg",$scope.slackNew=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/slackNew.svg",$scope.template=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/template.svg",$scope.workflow=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/workflow.svg",$scope.eye=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/eye.svg",$scope.passOrFail=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/passOrFail.svg",$scope.upload=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/upload.svg",$scope.projectSetup=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/projectSetup.svg",$scope.userManual=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/userManual.svg",$scope.quickModeOn=env_conf["context-url"]+"/assets/help-slider-icons/min/quick-mode-on.svg",$scope.minIcon=env_conf["context-url"]+"/assets/help-slider-icons/min/minIcon.svg",$scope.deploy=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/deploy.svg",$scope.maintenanceBuild=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/maintenanceBuild.svg",$scope.multiChannelType=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/multiChannel.svg",$scope.simulate=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/simulate.svg",$scope.workflow=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/workflow.svg",$scope.www=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/www.svg",$scope.publishIcon=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/publish.svg",$scope.overviewGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/overview-green.svg",$scope.variableNewGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/variable-green.svg",$scope.workflowGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/workflow-green.svg",$scope.formGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/form-green.svg",$scope.multiChannelTypeGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/multi-channel-type-green.svg",$scope.simulateGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/simulate-green.svg",$scope.eyeGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/eye-green.svg",$scope.wwwGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/www-green.svg",$scope.publishGreen=env_conf["context-url"]+"/assets/help-slider-icons/quick-start-guide/process-app/green/publish-green.svg",$scope.views={noBotsForm:!1,botsForm:!1,botDetailsForm:!1,botsBillingForm:!1,teamForm:!1,profileForm:!1},$scope.hasDataTabAccess=!1,$scope.hasProcessAppTabAccess=!1,$scope.gSearchInp=!1,
$scope.statusPollInit=null,$scope.selectedValue={key:"en",value:"English (United States)"},$scope.fromSmart=$workflowService.kgDataFromKora().fromSmart,$scope.fromWorkbench=$workflowService.kgDataFromKora().fromWorkbench,$scope.languageArray=[{key:"en",value:"English (United States)"},{key:"ja",value:"Japanese (Japan)"},{key:"ko",value:"Korean"}],$scope.showGenericProtip=!1;var streamData=$workflowService.selectedStream();_.forEach(streamData.supportedLanguages,function(value){"ge"===value&&($scope.showGenericProtip=!0)}),$scope.selectedContacts={},$scope.selectedContacts.selectedUsers=[],$scope.selectedDD=i18n.i18nString("gSearchPlaceHold");var userPermissionList=["INVITE","IMPORT_USR_SYNC","IMPORT_AD_SYNC"];$scope.loadBotStore=!1,$rootScope.changeLanguage(),$scope.shortcutKeys={goTo:[{name:i18n.i18nString("go_home"),key:"g then h"},{name:i18n.i18nString("go_dashboard"),key:"g then d"},{name:i18n.i18nString("go_summary"),key:"g then s"},{name:i18n.i18nString("go_tasks"),key:"g then b"},{name:i18n.i18nString("go_test"),key:"g then t"},{name:i18n.i18nString("go_utterance"),key:"g then u"},{name:i18n.i18nString("go_publish"),key:"g then p"},{name:i18n.i18nString("go_metrics"),key:"g then m"}],Others:[{name:i18n.i18nString("inivite_developer_summary"),key:"o then i"},{name:i18n.i18nString("open_help"),key:"o then h"},{name:i18n.i18nString("open_shortcuts"),key:"o then g"},{name:i18n.i18nString("search_name"),key:"/"},{name:i18n.i18nString("open_bot"),key:"o then n"},{name:i18n.i18nString("import_bot"),key:"o then m"},{name:i18n.i18nString("dialog_zoom"),key:"ctrl + alt + +"},{name:i18n.i18nString("dialog_zoom_in"),key:"ctrl + alt + -"},{name:i18n.i18nString("zoom_restore"),key:"ctrl + alt + 0"},{name:i18n.i18nString("swicth_publish_mode"),key:"ctrl + alt + p"},{name:i18n.i18nString("switch_indevelopment"),key:"ctrl + alt + d"}],Talktobot:[{name:i18n.i18nString("launch_talk"),key:"o then t"},{name:i18n.i18nString("toggle_debug"),key:"o then d"},{name:i18n.i18nString("min_bot"),key:"ctrl + alt + m"},{name:i18n.i18nString("restore_bot"),key:"ctrl + alt + r"}]},$scope.setSelectedProcessAppdata=function(data){data&&"processApps"==$scope.selectedHomeTab?(prepareHelpSliderObjs(),$scope.selectedProcessApp||($scope.selectedProcessApp=data),$scope.selectedProcessApp&&data.reviewSetupStatus?($scope.quickStartGuideMainObject=$scope.quickStartGuideProcessTemplateObject,$scope.updateDynamicquickstartObject(data.reviewSetupStatus)):$scope.selectedProcessApp&&data.setupStatus&&($scope.quickStartGuideMainObject=$scope.quickStartGuideProcessScratchObject,$scope.updateDynamicquickstartObject(data.setupStatus))):($scope.selectedProcessApp="",$scope.completedPercentage||($scope.completedPercentage=0))},$scope.builderNavigator.prepareHelpSliderObjs=prepareHelpSliderObjs,$scope.quickStartGuideMainObject=[],$scope.checkForSmapleBot=function(stream){return stream&&(stream.sbStreamId||"default"===stream.type&&stream.solutionBotSettings)?!0:!1},$scope.expandSelectedText=function(value){$scope.showExpandedContent=value._id},$scope.hideOverView=function(){"bots"===$scope.selectedHomeTab&&($scope.helpGuideOptions.showTemplateInstalation=!1),"processApps"===$scope.selectedHomeTab&&($scope.changeOverText=!1,jsEvents.postMessageToChildIframes("closeSetupSliderModal","#processFlowsFrame"))},$scope.reDirectionToTabs=function(value){return value&&value.action?void("processApps"==$scope.selectedHomeTab?value.action(value):value.action(value._id)):($(".flowTaskForm.expandedView #dialogCloseAction").length&&$(".flowTaskForm.expandedView #dialogCloseAction").click(),$(".knowledgeGraph .closeBtn").length&&$(".knowledgeGraph .closeBtn").click(),$(".modal-header.bt-modal-header.alertActionHeader .closeBtn").length&&$(".modal-header.bt-modal-header.alertActionHeader .closeBtn").click(),$(".btSmallTalk .smallTalkFullContainer .closeBtn").length&&$(".btSmallTalk .smallTalkFullContainer .closeBtn").click(),$("#manageInteruptions .btx-close").length&&$("#manageInteruptions .btx-close").click(),$("#manageComponentsForDialog .closeBtn").length&&$("#manageComponentsForDialog .closeBtn").click(),void($scope.builderNavigator.tabPermisionList[value._id]&&"conversationTesting"!==value._id&&"testTrain"!==value._id?("eventsManage"==value._id?$workflowService.storeSearchQry(value):$workflowService.storeSearchQry({}),"dialogTasks"==value._id?$scope.callbacks.navigateTo(null,"storyboard"):$scope.callbacks.navigateTo(null,value._id),$scope.closeHelpModal()):($scope.callbacks.navigateTo(null,value._id),$scope.closeHelpModal())))},$scope.license={},$scope.supportPlan={},$scope.planSelectionCb={},$scope.selectedStream={},$scope.planValidationDetails={},$scope.globalhelpId="",$scope.showTemplateModal=function(value,helpId){if("quickStart"===value)$scope.loadQuickStart=!0,$scope.loadSupport=!1,$scope.loadHelpContent=!1,$scope.callback.showHeader=!1,99===$scope.completedPercentage||100===$scope.completedPercentage?($(".progress-bar").css("width","100%").attr("aria-valuenow","100%"),$scope.loadQuickStart=!1,$scope.loadSupport=!0):$(".progress-bar").css("width",$scope.completedPercentage+"%").attr("aria-valuenow",$scope.completedPercentage);else if("support"===value)$scope.loadSupport=!0,$scope.loadQuickStart=!1,$scope.loadHelpContent=!1,$scope.callback.showHeader=!1,$scope.callback.openQuickStartSlider=!1;else if("helpContent"===value){var faqMixpanelEvent={Level:"Support",Category:"Support","Sub Category":"Help"};mixPanel.postEvent("Enter FAQs",faqMixpanelEvent),$scope.loadSupport=!1,$scope.loadQuickStart=!1,("bots"==$scope.selectedHomeTab&&"botsForm"!==$scope.showQuickStartformType||"processApps"==$scope.selectedHomeTab&&$scope.selectedProcessApp)&&($scope.callback.showHeader=!0),$scope.loadHelpContent=!0,$scope.globalhelpId?$scope.helpId=$scope.globalhelpId||"":"bots"===helpId?$scope.helpId="":$scope.helpId=helpId||""}},$scope.getFirstLastName=function(_contact){if(_contact.gN||_contact.firstName&&_contact.lastName){var firstLetter=_contact.gN?_contact.gN.substr(0,2):_contact.firstName[0],lastLetter=_contact.lastName?_contact.lastName[0]:"";return firstLetter.concat(lastLetter).toUpperCase()}return _contact.gN||_contact.firstName&&_contact.lastName||!_contact.emailId?void 0:_contact.emailId.substr(0,2).toUpperCase()},$scope.expandSelectedBot=function(bot){$scope.selectedBot._id===bot._id?$scope.selectedBot={}:$scope.selectedBot=bot},$scope.selectedWorkflowServicesReset=function(){$workflowService.importedNewBotId(" "),$workflowService.selectedStream({})},$scope.restorePreviousState=function(bot,state,language){$scope.callbacks.changeFilterval(state),language?$workflowService.currentLanguage(language):$workflowService.currentLanguage(bot.defaultLanguage),BTStreamsService.getBTStream(bot._id).then(function(res){var permissionStreamData=$workflowService.selectedStream(res.data);language?$workflowService.currentLanguage(language):$workflowService.currentLanguage(permissionStreamData.defaultLanguage),shortcutKeys.updateStreamData(res.data),$scope.callbacks.streamData=permissionStreamData,showView("botDetailsForm"),$scope.loadingBots=!1},function(err){$scope.resumingBuilder=!1,$scope.callbacks.changeFilterval("indevelopment"),showView("botsForm"),NotificationService.notify(err.data.errors[0].msg,"error"),$scope.loadingBots=!1}),BTStreamsService.getStreams().then(function(res){$scope.allBots=res.data,$workflowService.streamsAll(res.data),$workflowService.selectedStream()&&"universalbot"===$workflowService.selectedStream().type&&$scope.callbacks&&$scope.callbacks.storeUnlinkBots&&$scope.callbacks.storeUnlinkBots(res.data)})},$scope.builderHeader={},$scope.builderHeader.menuItems={upgrade:!1,accounts:!1,settings:!1,profile:!0,notifications:!1,bots:!0,admin:$rootScope.isAdmin()||!1},$scope.noResult=function(){return 0===$(".gSearchDrpDwn .searchItm").length};var term;$scope.updateBreadCrumbHome=function(){var arr_breadCrumb=[],obj_breadCrumb={name:"",cbMethod:""};arr_breadCrumb.push(obj_breadCrumb);var options={action:"",activeId:"",breadCrumb:arr_breadCrumb};$scope.$emit("updateBreadCrumb",options),$scope.bredCrumbLoading=!1},$scope.selectHomeTab=function(tab){"bots"===tab?$scope.showBotsScreen("botsForm"):$scope.showBotsScreen(tab)},$scope.showBotsScreen=function(type){if("botsForm"===type){$scope.selectedHomeTab="bots";var data={type:"closeModal"};jsEvents.postMessageToChildIframes("daasEvent","daasIframeEvent",data)}else $scope.selectedHomeTab=type,setTimeout(function(){$(".notificationHeader").css("height","0px")},1500)},$rootScope.$on("updateProcessData",function(){$scope.allProcessApps=$workflowService.processAppsData()||[]}),$rootScope.$on("refreshCheckList",function(event,appId){});var showView=function(formType,stopLoad){if($scope.showQuickStartformType=formType,"botsForm"!==formType?$scope.loadQuickStart=!0:$scope.loadQuickStart=!1,$scope.tSearch.text="",$scope.selectedDD=i18n.i18nString("ddval_goto"),$scope.gSearchPlaceHold=i18n.i18nString("gSearchPlaceHold"),$rootScope.currSelectedBot={},"botsForm"!==formType&&$(".notificationHeader").css("height","0"),$scope.callbacks._loggerInstance&&$scope.callbacks._loggerInstance.isRecording)$scope.callbacks.checkForLoggerInstance(formType);else{$scope.directiveLoading=!0,$scope.bredCrumbLoading=!0,"botsForm"===formType&&($scope.selectedWorkflowServicesReset(),$(".kore-chat-window").css("display","none")),loadDirective(formType);for(var key in $scope.views)$scope.views.hasOwnProperty(key)&&($scope.completedPercentage||($scope.completedPercentage=0),$scope.views[key]=!1);$timeout(function(){$scope.$emit("updateBreadCrumb",{action:"zeroLevel",breadCrumb:[formType],path:[formType]}),"botsForm"!==formType&&($scope.views[formType]=!0,$scope.completedPercentage||($scope.completedPercentage=0)),"botsForm"===formType&&(stopLoad?$scope.views[formType]=!0:($workflowService.selectedStreamState("indevelopment"),$scope.botstate.filterToggle="indevelopment",load()),$scope.completedPercentage||($scope.completedPercentage=0)),"profileForm"==formType&&$scope.updateBreadCrumbHome(),$workflowService.taskMode("edit")},0)}};$scope.isUniversalBot=function(){return"universalbot"===$workflowService.selectedStream().type},$scope.showGSearchDD=function(){$(".mainHeaderToggle.gSearchWrap").addClass("open")};var _loadingDirScript;$scope.$on("homeDirectivesLoaded",function(){$scope.directiveLoading=!1,$timeout(function(){window.inline_manual_player&&window.inline_manual_player.update()},3e3)}),$scope.$on("mixPanelEvent",function(event,data){if(data.payload&&data.payload.eventPayload&&"Conversational-App"===data.payload.product)if("Activation"===data.payload.eventPayload.Category){var customEvent=data.payload.eventPayload;$scope.allBots&&$scope.allBots.length?mixPanel.postEvent(data.payload.event,customEvent):(customEvent.Category="Engagement L1",customEvent["Sub Category"]="VA - Bot Store",customEvent.Level="Engagement L1",mixPanel.postEvent(data.payload.event,customEvent))}else mixPanel.postEvent(data.payload.event,data.payload.eventPayload);else data.payload&&data.payload.eventPayload&&"Process-App"===data.payload.product&&mixPanel.postEvent(data.payload.event,data.payload.eventPayload)}),$scope.$on("gSearchLoad",function(event){var userQryFlag=$workflowService.storeSearchQry().userSearchQueryFlag,userNaviFlag=$workflowService.storeSearchQry().userNavigateFlag,navigationPath=$workflowService.storeSearchQry().navigateTo;userQryFlag&&$scope.callbacks.appendSearchQry($workflowService.storeSearchQry()),navigationPath&&$scope.callbacks.selectType(navigationPath),(!userQryFlag&&!userNaviFlag||userNaviFlag)&&($scope.tSearch.text="",$scope.selectedDD=i18n.i18nString("ddval_goto"),$scope.gSearchPlaceHold=i18n.i18nString("gSearchPlaceHold")),userQryFlag&&"Knowledge Collection"!==navigationPath&&$workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:""}),userNaviFlag&&"Knowledge Collection"!==navigationPath&&$workflowService.storeSearchQry({userNavigateFlag:!1,navigateTo:""})});var timeOut=null;$scope.$on("nestedComponentLoaded",function(event,compInfo){clearTimeout(timeOut),$scope.resumingBuilder=compInfo.flag,timeOut=setTimeout(function(){$scope.callbacks.rightNavAccordianEvents&&$scope.callbacks.rightNavAccordianEvents()},200)}),$scope.$on("resetFilterValue",function(){$workflowService.selectedStreamState("indevelopment"),$scope.botstate.filterToggle="indevelopment"}),$rootScope.$on("reloadBotDetail",function(){var _path=$scope.getMenuPath();$scope.views.botDetailsForm=!1,$scope.directiveLoading=!0,$timeout(function(){$scope.mainMenuSelected=_path[0],$scope.subMenuSelected=_path[1],$scope.views.botDetailsForm=!0,$scope.completedPercentage||($scope.completedPercentage=0),$scope.directiveLoading=!1},800)}),$scope.onSearchFocusOut=function(){$("#searchForMenu").closest(".dropdown").hasClass("open")},$scope.showBotDropdown=function(evt){$(".botDropdown").find(".botSearchInput").val(""),$scope.$emit("clearBotDropdownSearch"),$timeout(function(){$(".botDropdown").find(".botSearchInput").focus()})},$scope.handleBotSearchDropdown=function(e){e.stopPropagation(),e.stopImmediatePropagation()},$scope.gSearchDropDown=[{name:i18n.i18nString("ddval_goto"),_id:"goTo",subId:""},{name:i18n.i18nString("ddval_dialog"),_id:"dialogTasks",subId:""},{name:i18n.i18nString("ddval_kg"),_id:"knowledgeCollection",subId:""},{name:i18n.i18nString("ddval_synonyms"),_id:"synonyms",subId:"botsynonyms"},{name:i18n.i18nString("ddval_entity"),_id:"synonyms",subId:"entity"},{name:i18n.i18nString("ddval_pattern"),_id:"patterns",subId:"entity"},{name:i18n.i18nString("ddval_intent"),_id:"patterns",subId:"intents"},{name:i18n.i18nString("ddval_standard"),_id:"standardResponses",subId:""}],$scope.nlSubTabs=["botsynonyms","entity","intents"],$scope.gSearchDDUniversal=[{name:i18n.i18nString("ddval_goto"),_id:"goTo"},{name:i18n.i18nString("ddval_standard"),_id:"standardResponses"}],$scope.redirectDD=function(ddVal,ddValObj){$(".dropdown-submenu .subMenu").next("ul").toggle(),$scope.selectedDD=ddVal,$scope.tSearch.text="",term=ddValObj,ddVal===i18n.i18nString("ddval_goto")?$scope.gSearchPlaceHold=i18n.i18nString("gSearchPlaceHold"):ddVal===i18n.i18nString("ddval_kg")?$scope.gSearchPlaceHold=i18n.i18nString("gSearchPlaceHold_kg"):ddVal===i18n.i18nString("ddval_dialog")?$scope.gSearchPlaceHold=i18n.i18nString("gsearchPlaceHold_dialog"):ddVal===i18n.i18nString("ddval_standard")?$scope.gSearchPlaceHold=i18n.i18nString("gsearchPlaceHold_standard"):ddVal===i18n.i18nString("ddval_synonyms")?$scope.gSearchPlaceHold=i18n.i18nString("gsearchPlaceHold_synonyms"):ddVal===i18n.i18nString("ddval_entity")?$scope.gSearchPlaceHold=i18n.i18nString("gsearchPlaceHold_entity"):ddVal===i18n.i18nString("ddval_intent")?$scope.gSearchPlaceHold=i18n.i18nString("gsearchPlaceHold_intent"):ddVal===i18n.i18nString("ddval_pattern")?$scope.gSearchPlaceHold=i18n.i18nString("gsearchPlaceHold_pattern"):ddVal===i18n.i18nString("ddval_negative_pattern")?$scope.gSearchPlaceHold=i18n.i18nString("gSearchPlaceHold_negative_pattern"):term={}},$scope.viewCheckHome=function(fromHtmlFlag){$scope.callbacks.viewCheck(term,!0,fromHtmlFlag)},$scope.botmeta={};var isBotSearchModeDropdown=!1;$scope.botmeta.searchedBotsInDropDown=[],$scope.clearBotSearchInDropdown=function(){isBotSearchModeDropdown=!1,$scope.botmeta.searchedBotsInDropDown=[]};var iframeNotificationEvent=$scope.$on("iframeNotificationEvent",function(e,data){data.payload&&data.payload.message&&data.payload.type&&NotificationService.notify(data.payload.message,data.payload.type)});$scope.$on("$destroy",function(){updateChecklist&&updateChecklist(),iframeNotificationEvent&&iframeNotificationEvent()}),$scope.$on("clearBotDropdownSearch",function(evt){$scope.clearBotSearchInDropdown()}),$scope.checkTheKey=function($event){var keyCode=$event.which||$event.keyCode;""===$scope.tSearch.text&&$scope.selectedDD!==i18n.i18nString("ddval_kg")?$scope.viewCheckHome():$scope.selectedDD!==i18n.i18nString("ddval_kg")&&""!==$scope.tSearch.viewChecktext&&$scope.callbacks.viewCheck(term,!1),13===keyCode&&-1===$scope.nlSubTabs.indexOf(term.subId)?(setWFSearchQry(angular.copy($scope.tSearch.text),term._id),$scope.callbacks.navigateTo(null,term._id)):13===keyCode&&-1!==$scope.nlSubTabs.indexOf(term.subId)&&$scope.callbacks&&$scope.callbacks&&("botsynonyms"===term.subId&&$scope.tSearch.text.length&&$scope.tSearch.text.startsWith("~")?(setSubTabSearchQry(angular.copy($scope.tSearch.text),"concepts"),$scope.callbacks.setSubTabToOpen("machineLearningUtterances","concepts")):(setSubTabSearchQry(angular.copy($scope.tSearch.text),term.subId),$scope.callbacks.setSubTabToOpen("machineLearningUtterances",term.subId)))},$scope.clearSearch=function(){$scope.callbacks&&$scope.callbacks.clearSearch&&$scope.callbacks.clearSearch()},$scope.searchBotsInDropdown=function(){return $scope.botmeta.botSearchInput?void($scope.botmeta.botSearchInput.length>=1&&($scope.botmeta.searchedBotsInDropDown=_.filter($scope.allBots,function(bot){return bot.name&&-1!==bot.name.toLowerCase().indexOf($scope.botmeta.botSearchInput.toLowerCase())}),isBotSearchModeDropdown=!0)):void $scope.clearBotSearchInDropdown()},$scope.updateFilterValue=function(filterVal,bot){var selectedBot=$workflowService.selectedStream();if(bot&&bot._id&&selectedBot){if(bot._id!==selectedBot._id){var _filterVal="indevelopment"===filterVal?"published":"indevelopment";$("body").click(),$scope.callbacks.selectBot(bot,null,_filterVal),$rootScope.$emit("stopAutoTrainStatusPoll"),$scope.callbacks&&$scope.callbacks.progressBridge&&$scope.callbacks.progressBridge.stopProgressDock&&$scope.callbacks.progressBridge.stopProgressDock();var selectedStreamIndex=_.findIndex($scope.allBots,{_id:bot._id});if(selectedStreamIndex>-1){var stream=$scope.allBots[selectedStreamIndex];$scope.allBots.splice(selectedStreamIndex,1),$scope.allBots.unshift(stream)}return!1}if($scope.callbacks.rightPanel&&$scope.callbacks.rightPanel.innerRightPanel&&"publish"===$scope.callbacks.rightPanel.innerRightPanel.view)return NotificationService.notify(i18n.i18nString("publish_warning"),"warning"),$scope.botstate.filterToggle="indevelopment","indevelopment"}if(selectedBot&&"private"==selectedBot.visibility.namespace&&"indevelopment"==filterVal)return NotificationService.notify(i18n.i18nString("notify_notPublished"),"error"),$scope.botstate.filterToggle="indevelopment","indevelopment";$scope.botstate.filterToggle="indevelopment"===filterVal?"published":"indevelopment",$("body").click(),$workflowService.selectedStreamState($scope.botstate.filterToggle);var toSetInLocalStorage=JSON.parse(window.localStorage.getItem("previousState"));toSetInLocalStorage&&(toSetInLocalStorage.selectedStreamState=$scope.botstate.filterToggle,window.localStorage.setItem("previousState",JSON.stringify(toSetInLocalStorage)));var _selectedStreamIndex=_.findIndex($scope.allBots,{_id:bot._id});if(_selectedStreamIndex>-1){var streamData=$scope.allBots[_selectedStreamIndex];$scope.allBots.splice(_selectedStreamIndex,1),$scope.allBots.unshift(streamData)}return $rootScope.$broadcast("updateStreamState",$scope.botstate.filterToggle),$scope.botstate.filterToggle},$scope.botSelected=function(stream){if(stream=stream||$workflowService.selectedStream(),setupchecklist(),$scope.allBots=$workflowService.streamsAll(),$scope.allBots&&$scope.allBots.length){var selectedStreamIndex=_.findIndex($scope.allBots,{_id:stream._id});selectedStreamIndex>-1&&($scope.allBots.splice(selectedStreamIndex,1),$scope.allBots.unshift(stream))}},$scope.$on("streamUpdate",function(){$scope.updatingBotsList=!0,$scope.allBots=$workflowService.streamsAll(),$.each($scope.allBots,function(i,bot){bot._id===$workflowService.selectedStream()._id&&(bot=$workflowService.selectedStream())}),$scope.botSelected(),$scope.updatingBotsList=!1}),$scope.openCloseBotSelectionDrop=function(){$(".botStatusScroll").scrollTop(1),$scope.selectedBot=$rootScope.currSelectedBot},$scope.isBotSearchModeInDropdown=function(){return isBotSearchModeDropdown},$scope.gSearchFilter=function(item){var sText=$scope.tSearch.text.toLowerCase();return!$scope.tSearch.text||item.name&&-1!==item.name.toLowerCase().indexOf(sText)||-1!==item.subMenuFirstLevel.toString().toLowerCase().indexOf(sText)||item.header&&-1!==item.header.toString().toLowerCase().indexOf(sText)||item.headerName&&-1!==item.headerName.toString().toLowerCase().indexOf(sText)?!0:!1},BotsCollection.prototype.categorizeBots=function(botsData){this.allBots=[],this.yourBots=[],this.sharedBots=[],this.recentBots=[];var _self=this;if($.each(botsData,function(i,bot){bot.createdBy.id==_userInfo.userId?(bot.isShared=!1,_self.yourBots.push(bot)):(bot.isShared=!0,_self.sharedBots.push(bot))}),$scope.yourBotsEmpty=[],$scope.sharedBotsEmpty=[],_self.yourBots.length>0&&_self.yourBots.length<4)for(var i=0;i<4-_self.yourBots.length;i++)$scope.yourBotsEmpty.push({});if(_self.sharedBots.length>0&&_self.sharedBots.length<4)for(var j=0;j<4-_self.sharedBots.length;j++)$scope.sharedBotsEmpty.push({});this.allBots=botsData,_self.recentBots=_.filter(botsData,function(bot){return bot.lastAccessedOn}),_self.recentBots.length>6&&(_self.recentBots=_self.recentBots.slice(0,8)),$scope.mainCntrlCb.sharedBots=_self.sharedBots},BotsCollection.prototype.getBots=function(category){return this[category]};var setWFSearchQry=function(searchQry,pathName){$workflowService.storeSearchQry({userSearchQueryFlag:!0,searchQry:searchQry,navigateTo:pathName})},setSubTabSearchQry=function(searchQry,subTab){$workflowService.subTabSearchQuery({searchQry:searchQry,subTab:subTab}),$scope.callbacks.resetGSearchText()};$(navigator).on("navigateTo",function(e,data){"botsForm"===data.id?$scope.callbacks.showView("botsForm"):$scope.callbacks.navigateTo(null,data.id)});var tempSelfAccount;$("body").on("click",".goto-self-account",function(){tempSelfAccount&&(localstore.setSelectedAccount(tempSelfAccount),$timeout(function(){window.location.reload()},2e3))});var _noSelfAccountDialog;$rootScope.$on("selectedAccountUpdate",function(e,_selectetedAccount){if(localstore.setSelectedAccount(_selectetedAccount),$workflowService.selectedAccount(_selectetedAccount),$scope.selectedAccount=_selectetedAccount,$scope.accounts&&$scope.accounts.length){var _updatedAccountIndex=_.findIndex($scope.accounts,{accountId:_selectetedAccount.accountId});_updatedAccountIndex>=0&&($scope.accounts[_updatedAccountIndex]=_selectetedAccount)}});var _selectetedAccount={};if($scope.callbacks={showView:showView},$scope.callbacks.botSelected=$scope.botSelected,$scope.updateFilter=function(){$scope.botstate.filterToggle=$workflowService.selectedStreamState()||$scope.botstate.filterToggle||"indevelopment"},$scope.callbacks.searchNavigation=function(navigateObj,searchObj){searchObj&&!navigateObj&&searchObj&&searchObj.elements&&searchObj.elements.length&&(navigateObj=searchObj.elements[searchObj.elements.length-1]),navigateObj&&("tab"===navigateObj.type?$scope.callbacks.navigateTo(navigateObj._id):"tabMenu"===navigateObj.type?$scope.callbacks.navigateTo(navigateObj._id):"menu"===navigateObj.type&&(navigateObj.internalMenu?$workflowService.storeSearchQry({userNavigateFlag:!0,navigateTo:navigateObj.internalMenu}):$workflowService.storeSearchQry({userNavigateFlag:!1,navigateTo:""}),$scope.callbacks.navigateTo(null,navigateObj._id))),$scope.callbacks.resetGSearchText()},$scope.callbacks.progressBridge={},$scope.$on("getProgressDockStatus",function($event){$scope.callbacks.progressBridge&&$scope.callbacks.progressBridge.cb&&$scope.callbacks.progressBridge.cb()}),$scope.getUserProfile=function(){return $rootScope.profileImgLinkPrefix},$rootScope.$on("botIconUpdate",function($event,profile){$scope.updatingIcon=!0,$rootScope.profileImgLinkPrefix=-1===$rootScope.profileImgLinkPrefix.indexOf("?")?$rootScope.profileImgLinkPrefix+"?v=1.1"+$rootScope.profileImgLinkPrefix+1e3*Math.random():$rootScope.profileImgLinkPrefix+1e3*Math.random(),setTimeout(function(){$scope.updatingIcon=!1},200)}),$rootScope.$on("installProcessAppFromBT",function(event,payload){$scope.selectedHomeTab="processApps",jsEvents.postMessageToChildIframes("processStore","#processFlowsFrame",payload),setTimeout(function(){$rootScope.$broadcast("closeWelcomeModel")},500)}),$rootScope.$on("createNewProcessApp",function(event){$scope.selectedHomeTab="processApps",jsEvents.postMessageToChildIframes("createApp","#processFlowsFrame"),setTimeout(function(){$rootScope.$broadcast("closeWelcomeModel")},200)}),$rootScope.$on("importNewProcessApp",function(event){$scope.selectedHomeTab="processApps"}),$scope.$on("startTimer",function($event){$scope.callbacks.progressBridge.timer()}),$scope.$on("selectDefaultBotScreen",function($event){$scope.selectedHomeTab="bots"}),$scope.callbacks.enable=!0,$scope.callbacks.changeFilterval=function(value){$workflowService.selectedStreamState(value),$scope.botstate.filterToggle=value||"indevelopment"},$scope.callbacks.resetFilter=function(){$scope.selectedDD=i18n.i18nString("ddval_goto"),$scope.gSearchPlaceHold=i18n.i18nString("gSearchPlaceHold")},$scope.$on("loadBots",function(evt,data,sideBarView){$scope.callbacks.streamData=data,$(".kore-chat-header .close-btn").trigger("click"),$workflowService.sideBarView(sideBarView),load(data)}),$rootScope.$on("loadNewStream",function(evt,data,sideBarView){$scope.callbacks.streamData=data,$(".kore-chat-header .close-btn").trigger("click"),$workflowService.sideBarView(sideBarView),load(data)}),$scope.$on("reloadBots",function(evt,data,sideBarView){$scope.callbacks.streamData=data,$(".kore-chat-header .close-btn").trigger("click"),$workflowService.sideBarView(sideBarView),loadBotPrimaryDependentApis(data,!0)}),security.isAuthenticated())load(null,!0);else var unregisterEvent=$rootScope.$on("security:loadbotshome",function(){load(null,!0),unregisterEvent()});$scope.linkEvent=function(type){var event="",eventInfo={Level:"Support",Category:"Support","Sub Category":"Academy"};"document"===type?(event="Enter Documentation",eventInfo["Sub Category"]="Documentation"):"community"===type?(event="Enter Community",eventInfo["Sub Category"]="Community"):"faq"===type?(event="Open FAQs",eventInfo["Sub Category"]="FAQs"):(event="Enter Academy",eventInfo["Sub Category"]="Academy"),event&&mixPanel.postEvent(event,eventInfo)},$scope.navigateTo=function(to){var language,targetURL="";localstore.getAuthData();language=localStorage.getItem("queryParamLang");var adminUrl;switch(adminUrl=window.appConfig.BOT_ADMIN_URL,adminUrl.split("?")[1]||(adminUrl=window.appConfig.BOT_ADMIN_URL+"?lang="+language),to){case"botAdmin":targetURL=adminUrl;break;case"storyBoard":targetURL=window.appConfig.API_SERVER_URL+"/storyboard/stories/"+$rootScope.currSelectedBot._id;break;case"portal":targetURL=window.appConfig.API_SERVER_URL+"/processportal/home";break;default:console.log("default")}if(targetURL){var _account=$workflowService.selectedAccount(),accounthashQuary=btoa(JSON.stringify({routeData:{accountId:_account.accountId},routeKey:"setAccount"}));_account&&_account.accountId&&(targetURL=targetURL+"#"+accounthashQuary),$window.open(targetURL,"_blank")}},$scope.toggleAccountsDropdown=function(){$timeout(function(){$("#headeraccountsList").scrollTop(2)},100)},$scope.prepareStreams=function(){BTStreamsService.getStreams().then(function(res){_botsCollection=new BotsCollection;for(var i=0;i<res.data.length;i++)res.data[i].description=changePattern(res.data[i].description),res.data[i].name=changePattern(res.data[i].name);res.data.length&&(_botsCollection.categorizeBots(res.data),$scope.loadingBots=!1,$scope.allBots=_botsCollection.getBots("allBots"),$scope.recentBots=_botsCollection.getBots("recentBots"),$scope.yourBots=_botsCollection.getBots("yourBots"),$scope.sharedBots=_botsCollection.getBots("sharedBots"),$workflowService.streamsAll($scope.allBots))},function(err){})},$scope.builderState=[],$scope.$on("updateBreadCrumb",function(evt,options){var _previousBuilderState=[];$workflowService&&$workflowService.builderResumeState&&$workflowService.builderResumeState().path&&(_previousBuilderState=$workflowService.builderResumeState().path||[]);var _previousBreadCrumb=$workflowService.breadCrumb()||[];"zeroLevel"==options.action?$scope.builderState=options.path:0===_previousBreadCrumb.length||"firstLevel"==options.action?($scope.breadCrumb=options.breadCrumb,$scope.builderState=[].concat([_previousBuilderState[0]],options.path)):"secondLevel"==options.action?($scope.breadCrumb=[].concat([_previousBreadCrumb[0]],options.breadCrumb),$scope.builderState=[].concat([_previousBuilderState[0],_previousBuilderState[1]],options.path)):"thirdLevel"==options.action?$scope.breadCrumb=[].concat([_previousBreadCrumb[0]],[_previousBreadCrumb[1]],options.breadCrumb):($scope.breadCrumb=[].concat(_previousBreadCrumb,options.breadCrumb),$scope.builderState=[].concat(_previousBuilderState,options.path)),$scope.resumingBuilder||options.resuming||$workflowService&&$workflowService.builderResumeState&&$workflowService.builderResumeState($scope.builderState),$workflowService.breadCrumb($scope.breadCrumb),$scope.bredCrumbLoading=!1,options.path=angular.copy($scope.builderState);var _userInfo=$applicationService.userInfo(),fName=_userInfo.koreUserInfo.firstName+" "+_userInfo.koreUserInfo.lastName,version=$scope.appVersion;$rootScope.newChangesUpgradeMsg=i18n.i18nString("upgrade_version_tooltip",{dyn:fName,dyn1:version}),_userInfo.koreUserInfo.enableTips&&_userInfo.koreUserInfo.isBotsOnboarded&&(setTimeout(function(){("botsForm"===$scope.builderState[0]||"noBotsForm"===$scope.builderState[0])&&interactiveHelp.openHelp("TAKE_TOUR")},1500),AuthService.profileUpdate({enableTips:!1}).then(function(res){_userInfo.koreUserInfo.enableTips=!1},function(err){console.error("Error updating enableTips info")}))}),$scope.showProfile=function(){$scope.loadProfile=!0,$scope.openModalSlider("#profileModal")},$scope.showLangModal=function(){var selectedLanguages=localStorage.getItem("currentBotLanguage");_.forEach($scope.languageArray,function(lang){lang.key==selectedLanguages&&($scope.selectedValue.value=lang.value,$scope.selectedValue.key=lang.key)}),$("#languageModal").modal("show")},$scope.changeLanguageSelected=function(language){$scope.selectedValue.value=language.value,$scope.selectedValue.key=language.key},$scope.loadLanguage=function(){var langKey=$scope.selectedValue.key,_usrInfo=$applicationService.userInfo();$scope.userProfile=$applicationService.userInfo().koreUserInfo,$scope.selectedAccount=$workflowService.selectedAccount(),$scope.userProfileform=_usrInfo.appControls.userInfo;var emailID=$scope.userProfile.emailId,domainName=emailID.split("@");$scope.userProfile.companyName=domainName[1],$scope.userProfile.accountName=$scope.selectedAccount.accountName,langKey&&($scope.payload={personalInfo:{language:langKey}}),AuthService.profileUpdate($scope.payload).then(function(res){var _usrInfo=$applicationService.userInfo();_usrInfo.koreUserInfo=$scope.userProfile,_usrInfo.appControls.userInfo.personalInfo.language=$scope.payload.personalInfo.language,$applicationService.userInfo(_usrInfo),NotificationService.notify(i18n.i18nString("lang_saved"),"success"),$("#languageModal").modal("hide");var jStorage=localstore.getAuthData(),userInform=jStorage;_usrInfo&&_usrInfo.appControls&&_usrInfo.appControls.userInfo&&_usrInfo.appControls.userInfo.personalInfo&&_usrInfo.appControls.userInfo.personalInfo.language&&userInform&&userInform.currentAccount&&userInform.currentAccount.userInfo&&userInform.currentAccount.userInfo.personalInfo&&(userInform.currentAccount.userInfo.personalInfo.language=_usrInfo.appControls.userInfo.personalInfo.language),localstore.setAuthData(userInform),localStorage.setItem("queryParamLang",langKey),localStorage.setItem("currentBotLanguage",langKey),window.location.reload()},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("save_Failed");NotificationService.notify(errMsg,"error")})},$scope.closeProfileModal=function(){$scope.loadProfile=!1,$scope.closeModalSlider("#profileModal")},$scope.callback.showShortcut=function(value){
value||$scope.closeHelpModal(),$timeout(function(){$scope.shortCutFlag=!0,$scope.openBottomModalSlider("#keyboardShortCuts")},0)},$scope.closeShortCutModal=function(){$scope.closeBottomModalSlider("#keyboardShortCuts")},$scope.rightClass="right700",$scope.bottomClass="bottom250",$scope.checklistLength=0,$scope.checkEnabledLength=0,$scope.checklistResponse={},$scope.updateQuickStartGuideButtonActions=function(){_.forEach($scope.quickStartGuideMainObject,function(eachMenu){_.forEach(eachMenu.values,function(eachSubMenu){($workflowService.selectedStream()&&"setup"===$workflowService.selectedStream().state||eachSubMenu.checkedValue)&&("dialogTasks"===eachSubMenu._id&&$workflowService.selectedStream()&&$workflowService.selectedStream().taskCounts&&$workflowService.selectedStream().taskCounts.dialogs&&$workflowService.selectedStream().taskCounts.dialogs.length&&(eachSubMenu.button=i18n.i18nString("proceed"),eachSubMenu.action=""),"knowledgeCollection"===eachSubMenu._id&&$workflowService.selectedStream()&&$workflowService.selectedStream().taskCounts&&($workflowService.selectedStream().taskCounts.faqCount||$workflowService.selectedStream().taskCounts.ktasks&&$workflowService.selectedStream().taskCounts.ktasks.length)&&(eachSubMenu.button=i18n.i18nString("proceed"),eachSubMenu.action=""))})})},$scope.updateDynamicquickstartObject=function(data){var responseValue=data||[];$scope.checkForSmapleBot($workflowService.selectedStream())&&(responseValue.overview||(responseValue.overview=!0)),$scope.checklistLength=0,$scope.checkEnabledLength=0,$scope.completedPercentage||($scope.completedPercentage=0),_.forEach($scope.quickStartGuideMainObject,function(quickStart){_.forEach(quickStart.values,function(eachValue){responseValue[eachValue.type]?(eachValue.checkedValue=!0,$scope.checkEnabledLength=$scope.checkEnabledLength+1):$scope.checkForSmapleBot($workflowService.selectedStream())&&(eachValue.checkedValue=eachValue.checkedValue||!1,eachValue.checkedValue&&($scope.checkEnabledLength=$scope.checkEnabledLength+1)),$scope.checklistLength=$scope.checklistLength+1})}),console.log($scope.checklistLength);var individualPercent=100/$scope.checklistLength;individualPercent&&$scope.checkEnabledLength&&($scope.completedPercentage=Math.round(individualPercent*$scope.checkEnabledLength)),99===$scope.completedPercentage?($(".progress-bar").css("width","100%").attr("aria-valuenow","100%"),$scope.loadQuickStart=!1,$scope.loadSupport=!0):$(".progress-bar").css("width",$scope.completedPercentage+"%").attr("aria-valuenow",$scope.completedPercentage),expandUnfinishedGuide(),$scope.updateQuickStartGuideButtonActions()};var updateChecklist=$scope.$on("updateChecklist",function(event,id){setChecklistValues(id)});$scope.callbacks.setChecklistValues=setChecklistValues,$scope.showInstallationModal=function(helpId,options,id){var deployEvent={Level:"Support",Category:"Support","Sub Category":"Help"};mixPanel.postEvent("Enter Help Section",deployEvent),$scope.helpGuideOptions=null,$scope.globalhelpId=helpId,$scope.loadInstallation=!0,$scope.loadHelpContent=!1,$scope.callback.showHeader=!1,"bots"==$scope.selectedHomeTab&&"botsForm"!==$scope.showQuickStartformType&&$scope.completedPercentage<99||"processApps"==$scope.selectedHomeTab&&$scope.selectedProcessApp&&$scope.completedPercentage<99?($scope.loadQuickStart=!1,$scope.loadSupport=!0):($scope.loadQuickStart=!1,$scope.loadSupport=!0,$scope.callback.openQuickStartSlider=!1),$scope.showSetupMin=!0;var clearPercentage=!1,pendingTemplateConfig=!1;_.forEach($scope.quickStartGuideMainObject,function(eachMenu){_.forEach(eachMenu.values,function(eachSubMenu){"overview"===eachSubMenu._id&&eachSubMenu.checkedValue&&(clearPercentage=!0),"configure"!==eachSubMenu._id||eachSubMenu.checkedValue||(pendingTemplateConfig=!0)})}),clearPercentage&&!id?($scope.callbacks.invokeSetUp?(options=openSampleBotInstalation("overview",!0),expandUnfinishedGuide(),$scope.callbacks.invokeSetUp=!1,$scope.showExpandedContent="overview"):pendingTemplateConfig&&(options=openSampleBotInstalation("configure",!0),expandUnfinishedGuide()),setChecklistValues("overview")):id||"bots"!=$scope.selectedHomeTab||($(".progress-bar").css("width","0%").attr("aria-valuenow","0%"),$scope.completedPercentage||($scope.completedPercentage=0)),setupchecklist(options,id),$scope.helpModalActive=!0,$scope.openModalSlider("#helpModal"),options&&($scope.helpGuideOptions=options)},$scope.builderNavigator.showInstallationModal=$scope.showInstallationModal,$scope.showHelpModal=function(helpId){$scope.loadHelpContent=!0,$scope.helpId=helpId||""},$scope.showSetupMin=!0,$scope.closeHelpModal=function(clearSetupMin){$scope.closeModalSlider("#helpModal"),$(".listCards").scrollTop(1),clearSetupMin&&($scope.showSetupMin=!1),"processApps"===$scope.selectedHomeTab&&($scope.changeOverText=!1,jsEvents.postMessageToChildIframes("closeSetupSliderModal","#processFlowsFrame")),$scope.loadHelpContent=!1,$scope.helpModalActive=!1,$scope.showExpandedContent=null,$scope.helpGuideOptions=null,$scope.loadInstallation=!1,$("#helpModal").find("#botModalSlider").removeClass("unsetLeft"),$timeout(function(){window.inline_manual_player&&window.inline_manual_player.update()},1e3)},$scope.onCancelLeftModal=function(closeHelp){$scope.helpGuideOptions=null,closeHelp&&$scope.closeHelpModal()},$scope.showTrainingVideoModal=function(videoId){$scope.loadWatchVideos=!0,$scope.videoId=videoId||"",$("#watchModal").modal("show")},$scope.closeTrainingVideoModal=function(){$scope.loadWatchVideos=!1,$("#watchModal").modal("hide")},$scope.$on("showTrainingVideo",function(evt,videoId){$scope.showTrainingVideoModal(videoId||"")}),$scope.$on("guidedTour",function(evt,guideId){$scope.showWelcomeForm(guideId||null)}),$scope.$on("showHelp",function(e,data){$scope.setSelectedProcessAppdata(data.processCheckListData),$scope.showInstallationModal(data.helpId)}),$scope.$on("setSelectedProcessApp",function(e,data){$scope.setSelectedProcessAppdata(data)}),$scope.$on("closeHelp",function(e){$scope.closeHelpModal()}),$scope.$on("loadVirtualAsst",function(e){$("#virtualAsstTab").trigger("click")}),$(document).on("click","[kr-show-help]",function(e){var _hid=$(e.currentTarget).attr("kr-show-help");$scope.showInstallationModal(_hid)}),$(document).on("click","[start-guided-help]",function(e){var _hid=$(e.currentTarget).attr("start-guided-help");$scope.showWelcomeForm(_hid||null)}),$scope.scrollUpdate=function(){setTimeout(function(){$rootScope.$emit("pefectScrollUpdate")},500)},$scope.createAccount=function(){showNoSelfAccount()},$scope.setFavoriteAccount=function(account){account.updating=!0,$translator.translate("bt.prefs.update",{},{defaultAccountId:account.accountId}).then(function(res){account.updating=!1,$scope.defaultAccountId=account.accountId,NotificationService.notify(i18n.i18nString("default_account"),"success")})},$scope.callbacks.resetGSearchText=function(){$scope.tSearch.text=""},$scope.inviteDeveloper=function(){$("#inviteDeveloperLanding").modal("show"),setTimeout(function(){$("#tagInput").focus()},500)},$scope.callbacks.gSearchSamePage=function(fromHtmlFlag){fromHtmlFlag?$scope.callbacks.appendSearchQry({navigateTo:term.name,searchQry:""}):$scope.callbacks.appendSearchQry({navigateTo:term.name,searchQry:$scope.tSearch.text})},$scope.closeInviteModal=function(){$("#inviteDeveloperLanding").modal("hide"),$scope.selectedContacts.selectedUsers=[]},$scope.closeInviteSent=function(){$("#inviteSent").modal("hide")},$scope.inviteSent=function(){$("#inviteSent").modal("show")},$scope.closeCountDownTimerCloseBtn=function(){document.getElementById("secssionTimeoutCountDown").classList.remove("active")};$scope.inviteShareDeveloper=function(){$scope.callbacks.inviteOtherDomainUser(null,{validateEmail:!0});var payload={},developerEmailList=_.pluck($scope.selectedContacts.selectedUsers,"emailId"),invalidEmailList=_.filter($scope.selectedContacts.selectedUsers,{inValidEmail:!0}),invalidEmailMsg=invalidEmailList.length>0?i18n.i18nString("invalid_email"):"",emptyDeveloperList=0===developerEmailList.length?i18n.i18nString("enter_valid_email"):"";invalidEmailList.length>0?NotificationService.notify(invalidEmailMsg,"error"):0===developerEmailList.length?NotificationService.notify(emptyDeveloperList,"error"):(payload.emailIds=[],developerEmailList.forEach(function(emailId){payload.emailIds.push({emailId:emailId})}),BTStreamsService.inviteUser($applicationService.userInfo().userId,payload).then(function(response){$scope.closeInviteModal(),setTimeout(function(){$scope.inviteSent()},0)}))},$scope.openPlanUsage=function(planType){"plan"===planType?($scope.planSelectionCb.planSelection=!0,$scope.planSelectionCb.supportSelection=!1):"reload"===planType?($scope.planSelectionCb.planSelection=!1,$scope.planSelectionCb.reloadAmount=!0):"support"===planType&&($scope.planSelectionCb.planSelection=!1,$scope.planSelectionCb.supportSelection=!0),$scope.planSelectionCb.license=$scope.license,$scope.planSelectionCb.plansSlider=!0,$scope.planSelectionCb.navigateTo=$scope.callbacks.navigateTo},$scope.planSelectionCb.close=function(){$scope.closeModalSlider("#managePlanSelectionSlider"),$scope.planSelectionCb={}},$scope.getLicenseInfo=function(){$scope.license={},$scope.supportPlan={},$scope.selectedStream=$workflowService.selectedStream(),$scope.appControls=$applicationService.userInfo().appControls,$scope.selectedStream&&($scope.selectedStream.license&&($scope.license=$scope.selectedStream.license,$scope.license.totalCredits=$scope.license.baseAllowedCredits+$scope.license.extraCredits-$scope.license.creditsUsed||0,$scope.license.totalSessions=$scope.license.baseAllowedSessions+$scope.license.extraSessions-$scope.license.sessionsUsed||0,$scope.license.totalRequests=$scope.license.baseAllowedRequests-$scope.license.requestsUsed||0),$scope.selectedStream.supportplan&&($scope.supportPlan=$scope.selectedStream.supportplan),$scope.selectedStream.planValidationDetails&&($scope.planValidationDetails=$scope.selectedStream.planValidationDetails),$scope.planSelectionCb={})},$scope.callbacks.getLicenseInfo=$scope.getLicenseInfo,$rootScope.$on("keyBoardShortCut",function(e,info){$scope.shortCutFlag=info.shortCutFlag,$scope.openBottomModalSlider("#keyboardShortCuts")}),$(".takeTourbtn").on("click",function(){interactiveHelp.openHelp("TAKE_TOUR")}),$scope.openSubMenu=function(event){event.stopPropagation(),event.preventDefault(),$(".dropdown-submenu .subMenu").next("ul").toggle();var negativePatternObj=_.find($scope.gSearchDropDown,{_id:"negativePattern"});$workflowService.selectedStream()&&$workflowService.selectedStream().enableNegativePatterns&&!negativePatternObj&&$scope.gSearchDropDown.push({name:i18n.i18nString("ddval_negative_pattern"),_id:"negativePattern",subId:"intents"})},$scope.redirectSmart=function(){window.open($rootScope.resolveHostUrl()+"smartassist/config/usecases","_self")},$scope.acceptUpdatedLicense=function(showTerms,event){showTerms&&$rootScope.redirectToLink("KORE_AI_TERMS",event);var url="mp.user.acceptbtlicense",params={userId:$applicationService.userInfo().userId};$translator.translate(url,params).then(function(){$rootScope.licenseUpdate=!1},function(){})},$scope.redirectWorkbench=function(){window.open($rootScope.resolveWorkbenchHostUrl(),"_self")},$scope.$on("loadBotsForm",function(e){showView("botsForm"),$scope.loadBotStore=!0}),$scope.$on("homeDirectivesLoaded",function(){$scope.loadBotStore&&($scope.callbacks.loadStore(),$scope.loadBotStore=!1)}),$scope.launchBotStore=function(){mixPanel.postEvent("Launch Botstore"),$scope.message={action:"initialCallDetail",userId:$applicationService.userInfo().userId,loadBot:"reloadBotstore"},"bots"===$scope.selectedHomeTab?$scope.callbacks.loadStore():"processApps"===$scope.selectedHomeTab&&jsEvents.postMessageToChildIframes("loadStore","#processFlowsFrame"),document.getElementById("storeFrame").contentWindow.postMessage($scope.message,"*")}}]),_botsHome.filter("headerFilter",function(i18n){return function(input){return input?"nl"===input?i18n.i18nString("natural_langname"):"management"===input?i18n.i18nString("bot_management"):"configurations"===input?i18n.i18nString("config_settings"):"agents"===input?i18n.i18nString("api_extensions"):"botTasks"===input?i18n.i18nString("task_name"):"batchTesting"===input?i18n.i18nString("batch_testing"):"standardResponses"===input?i18n.i18nString("ddval_standard"):"nlAdvancedSettings"===input?i18n.i18nString("advanced_settings"):"advancedSettings"===input?i18n.i18nString("manage_interruptions"):"synonyms"===input?i18n.i18nString("synonyms_label"):"machineLearningUtterances"===input?i18n.i18nString("ml_utterance_name"):"ignoreWords"===input?i18n.i18nString("ignore_words"):"botTesting"===input?i18n.i18nString("testing"):"mlThresholds"===input?i18n.i18nString("mlThresholds_label"):"defaultConversation"===input?i18n.i18nString("nl_default"):"Spark"===input?i18n.i18nString("constants.iconsTooltips_spark"):"Skype Messaging"===input?i18n.i18nString("constants.iconsTooltips_skype"):"channels"===input?i18n.i18nString("channels"):input:void 0}})}(angular),function(ng){var _breadCrumb=ng.module("bt-forms");_breadCrumb.directive("breadCrumb",function(){return{restrict:"EA",scope:{breadCrumb:"=?breadcrumb",streamState:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bots-landing-forms/bread-crumb/bread-crumb.html",controller:"breadCrumbCtrl"}}),_breadCrumb.controller("breadCrumbCtrl",["$scope","env_conf","i18n",function($scope,env_conf,i18n){$scope.assetsBase=env_conf["assets-url"],$scope.eyeimage=$scope.assetsBase+"landingImages/icons/eye.svg",$scope.betaIcon=env_conf["context-url"]+"/assets/icons/betaIcon.svg"}])}(angular),function(ng){var _rightPanelForm=ng.module("bt-forms");_rightPanelForm.directive("rightPanel",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bots-landing-forms/right-panel/right-panel.html",controller:"rightPanelCtrl"}}),_rightPanelForm.controller("rightPanelCtrl",["$scope","env_conf","$rootScope","$timeout","$workflowService","accessControlService","BTStreamsService","NotificationService","$q","navigator","BTFlowtaskService","$element","i18n","$applicationService","mixPanel","jsEvents",function($scope,env_conf,$rootScope,$timeout,$workflowService,accessControlService,BTStreamsService,NotificationService,$q,navigator,BTFlowtaskService,$element,i18n,$applicationService,mixPanel,jsEvents){function checkForCheckListUpdate(view){var stream=$workflowService.selectedStream(),taskCount=0;stream&&(stream.sbStreamId||"default"===stream.type&&stream.solutionBotSettings)?("dialogTasks"===view||"knowledgeCollection"===view||"machineLearningUtterances"===view||"batchTesting"===view||"conversationTesting"===view||"testTrain"===view||"channels"===view||"publish"===view)&&("dialogTasks"===view?(taskCount=$scope.dialogTasks.length,taskCount&&$scope.callbacks.setChecklistValues(view)):"knowledgeCollection"===view&&stream.taskCounts&&stream.taskCounts.ktasks?(taskCount=stream.taskCounts.ktasks.length,taskCount&&$scope.callbacks.setChecklistValues(view)):("channels"===view||"publish"===view)&&(taskCount=stream.channels.length,taskCount&&$scope.callbacks.setChecklistValues(view)),taskCount||"channels"===view||"dialogTasks"===view||"knowledgeCollection"===view||$scope.callbacks.setChecklistValues(view)):("default"===stream.type&&!stream.solutionBotSettings||"universalbot"===stream.type||"sample"==stream.type||"solution"===stream.type)&&("dialogTasks"===view||"knowledgeCollection"===view||"testTrain"===view||"channels"===view||"linkedBotTraining"===view||"linkedBots"===view)&&("channels"===view&&(taskCount=stream.channels.length),"knowledgeCollection"===view&&stream.taskCounts&&stream.taskCounts.ktasks&&(taskCount=stream.taskCounts.ktasks.length),"linkedBots"===view&&(taskCount=stream.configuredBots.length),taskCount||"channels"===view||"knowledgeCollection"===view?!taskCount||"channels"!==view&&"linkedBots"!==view&&"knowledgeCollection"!==view||$scope.callbacks.setChecklistValues(view):$scope.callbacks.setChecklistValues(view))}function getDefaultMenu(){var menu="botSummary",dialogPermission=$scope.callbacks.getAllAccessRights(navigator.tabPermisionList.dialogTasks),storyPermission=$scope.callbacks.getAllAccessRights(navigator.tabPermisionList.storyboard);return("NO"!==dialogPermission||"NO"!==storyPermission)&&(navigator.navigationTree.menuItem.storyboard&&navigator.navigationTree.menuItem.storyboard.showMenu?menu="storyboard":navigator.navigationTree.menuItem.dialogTasks&&navigator.navigationTree.menuItem.dialogTasks.showMenu&&(menu="dialogTasks")),menu}function closeEditLinkModal(){$scope.closeModalSlider("#editLinkBot"),$scope.showEditLink=!1,$scope.callbacks.fetchLinkedBots()}function upgradeUniversalServiceCall(){var deferred=$q.defer(),_payload={universalBotVersion:2};return BTStreamsService.upgradeUniversalBot($applicationService.userInfo().userId,$scope.stream._id,_payload).then(function(response){deferred.resolve(response)},function(err){deferred.reject(response)}),deferred.promise}function mapSupportedLanguages(){var availableLanguages=$workflowService.cloneData($workflowService.seedData().supportedLanguages);return $scope.configuredLanguages=$workflowService.selectedStream().languageConfigurations?$workflowService.selectedStream().languageConfigurations:$scope.stream.supportedLanguages,"indevelopment"===$workflowService.selectedStreamState()?($scope.languages=_.filter(availableLanguages,function(lan){return $scope.configuredLanguages&&$scope.configuredLanguages[lan.value]&&$scope.configuredLanguages[lan.value].hasOwnProperty("enabled")?(lan.enabled=$scope.configuredLanguages[lan.value].enabled,lan):void 0}),$scope.languages):"published"===$workflowService.selectedStreamState()?($scope.taskApprovedLanguages=$workflowService.selectedStream().taskApprovedLanguages,$scope.taskDisabledLanguages=$workflowService.selectedStream().publishedDisabledLangs,$scope.languages=_.filter(availableLanguages,function(lan){return $scope.taskApprovedLanguages&&-1!==$scope.taskApprovedLanguages.indexOf(lan.value)?(lan.enabled=!0,lan):$scope.taskDisabledLanguages&&-1!==$scope.taskDisabledLanguages.indexOf(lan.value)?(lan.enabled=!1,lan):void 0}),$scope.languages):void 0}function startPollExportStatus(timeout){return setInterval(function(){BTFlowtaskService.exportStatusBot($scope.stream._id).then(function(res){res&&res.data&&($rootScope.$broadcast("getProgressDockStatus"),$scope.bot.exportType=res.data.exportType,"success"===res.data.status?($scope.exporttype=res.data.exportType.charAt(0).toUpperCase()+res.data.exportType.substr(1),$scope.downloadFileId=res.data.fileId,$scope.storeParams=res.data.store.urlParams,stopExportBotPolling("success")):"failed"===res.data.status&&(NotificationService.notify(i18n.i18nString("botExport_failed"),"error"),stopExportBotPolling("failed")))},function(err){stopExportBotPolling();var _msg=i18n.i18nString("error_on_fetching_bot_export_status");err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(_msg,"error")})},timeout)}function stopExportBotPolling(_status){$scope._exportStatusInit&&(clearTimeout($scope._exportStatusInit),$scope._exportStatusInit=null),"success"===_status?finishedExport():$scope.exporting="failed"}function finishedExport(){$scope._exportStatusInit&&clearTimeout($scope._exportStatusInit),$scope.exporting="finished"}function eligibleToShowType(type){return"flows"==type?$scope.stream&&$scope.stream._taskCounts?$scope.stream._taskCounts.alerts.indevelopment+$scope.stream._taskCounts.alerts.indevelopment:!1:!0}function getBotVariables(){BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$workflowService.botEnvVariables(res.data.variables),navigator.prepareHelpSliderObjs&&navigator.prepareHelpSliderObjs()},function(err){NotificationService.notify("Failed to load bot variables","error")})}function mixpanelEvent(type,tab){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L1",Category:"Engagement L1"},event="";if("deploy"===tab){var deployEvent={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Deploy"};mixPanel.postEvent("Deploy - Enter Deploy Section",deployEvent)}"storyboard"===type&&(_botInfo["Sub Category"]="Conversation - Storyboard",event="Conversation - Enter Storyboard"),"dialogTasks"===type&&(_botInfo["Sub Category"]="Conversation - Dialog Task",event="Conversation - Enter Dialog task"),"knowledgeCollection"===type&&(_botInfo["Sub Category"]="Conversation - Knowledge",event="Conversation - Enter Knowledge graph"),"uiForms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="Digital Tasks - Digital Forms",event="Digital Tasks - Enter Digital Forms"),"widgets"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="Digital Tasks - Digital Views",event="Digital Tasks - Enter Digital Views"),"smallTalk"===type&&(_botInfo.Level="Engagement L2",_botInfo.Category="Engagement L2",_botInfo["Sub Category"]="Conversation - Small Talk",event="Conversation - Enter Small Talk"),"alertTasks"===type&&(_botInfo.Level="Engagement L2",_botInfo.Category="Engagement L2",_botInfo["Sub Category"]="Conversation - Alert Task",event="Conversation - Alert Task entered"),"machineLearningUtterances"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Enter NLP Training"),"publish"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="Deploy",event="Deploy - Enter Publish section"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function closeSelectionModal(){$scope.closeModalSlider("#linkBot")}window.appConfig.CONTEXT_PATH+"/assets/",window.appConfig.CONTEXT_PATH+"/assets/landingImages/";$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.loadingDialogsTemplate=!0,$scope.amendEntityCb={},$scope.channels=$workflowService.seedData().botChannelsTypes,$scope.channelsSeedData=$workflowService.cloneData($scope.channels),$scope.editLinkCb={},$scope.loaderIcon=env_conf["context-url"]+"/assets/ontology/inspecting.svg",$scope.searchIcon=env_conf["context-url"]+"/assets/icons-new/search/search-gray.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/icons/close.svg",$scope.exportOptions={},$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.switchingTo=i18n.i18nString("switching_to"),$scope.published=i18n.i18nString("right_panel_published_state"),$scope.indevelopment=i18n.i18nString("right_panel_indevelopment_State"),$scope.noquestions=i18n.i18nString("no_questions"),$scope.notasks=i18n.i18nString("right_panel_no_tasks"),$scope.tasks=i18n.i18nString("tasks"),$scope.task=i18n.i18nString("task"),$scope.botInString=i18n.i18nString("bot"),$scope.noBots=i18n.i18nString("right_panel_no_bots"),$scope.questionsAnswers=i18n.i18nString("right_panel_questions_answers"),$scope.noFlows=i18n.i18nString("right_panel_noFlows"),$scope.widegets=i18n.i18nString("right_panel_widgets"),$scope.widget=i18n.i18nString("right_panel_widget"),$scope.noWidgets=i18n.i18nString("right_panel_no_widgets"),$scope.panels=i18n.i18nString("Panels_label"),$scope.panel=i18n.i18nString("panel_label"),$scope.noPanels=i18n.i18nString("right_panel_noPanels"),$scope.groups=i18n.i18nString("groups_label"),$scope.groupLabel=i18n.i18nString("group"),$scope.noGroups=i18n.i18nString("right_panel_no_groups"),$scope.forms=i18n.i18nString("forms"),$scope.form=i18n.i18nString("form"),$scope.noForms=i18n.i18nString("right_panel_no_forms"),$scope.bots=i18n.i18nString("constants.bots"),$scope.flows=i18n.i18nString("constants.flows"),$scope.flow=i18n.i18nString("constants.flow"),$scope.loadingBots=i18n.i18nString("right_panel_loading_bots"),$scope.loadingDialogs=i18n.i18nString("right_panel_loading_dialogs"),$scope.universalLink="https://developer.kore.ai/docs/bots/advanced-topics/universal-bot/universal-bots/#ub2.0",$scope.disableUpgrade=!1,$scope.showUpgradeUniversal=!1,$scope.streamstate={},$scope.streamstate.toggleState=$workflowService.selectedStreamState(),$scope.showSolutionBotSetup=$scope.callbacks.showSolutionBotSetup,$scope.assetsBase=env_conf["assets-url"],$scope.addIcon=$scope.assetsBase+"images/left-menu-img/addIcon.svg",$scope.gearHover=env_conf["context-url"]+"/assets/icons/gearHover.svg",$scope.ellipsisDark=env_conf["context-url"]+"/assets/icons/ellipsisDark.svg",$scope.upgradeUniversalIcon=env_conf["context-url"]+"/assets/ub2/universal2.svg",$scope.uiFormsEmptyState=env_conf["context-url"]+"/assets/icons/ui-forms-intro.svg",$scope.ellipsisDark=env_conf["context-url"]+"/assets/icons/ellipsisDark.svg",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.emptyStateIcon_kg=env_conf["context-url"]+"/assets/empty-state-images/kg-empty-graph.png",$scope.emptyStateIcon_aleart=env_conf["context-url"]+"/assets/empty-state-images/empty-aleart-task.png",$scope.emptyStateIcon_smalltalk=env_conf["context-url"]+"/assets/empty-state-images/empty_small_talk.png",$scope.emptyStateIcon_smalltalk_proceed=env_conf["context-url"]+"/assets/empty-state-images/smalltalk-proceed.svg",$scope.emptyStateIcon_digital_form=env_conf["context-url"]+"/assets/empty-state-images/empty-digital-form.png",$scope.reloadpng=env_conf["context-url"]+"/assets/images/reload.png",$scope.importingSvg=env_conf["context-url"]+"/assets/images/importing.png",$scope.chooseLang=env_conf["context-url"]+"/assets/languages/chooseLang.png",$scope.tasks={},$scope.streamdata={},$scope.loadingDialogsTemplate=!0,$scope.stream=$workflowService.selectedStream(),$scope.btTestFormApi={},$scope.btTestStatus={},$scope.lmmCallback={},$scope.utterancesCb={},$scope.planSelectionCb={},$scope.searchLanguage={},$scope.searchLanguage.languageSelect="",$scope.setStoryboardTab=function(tab){"faq"===tab?$q.all([$scope.callbacks.getKnowledgeTasks($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id)]).then(function(res){var kgStatusConfigured=res[0].data.filter(function(v){return"configured"===v.state})[0];$workflowService.taskEditInfo(kgStatusConfigured),$workflowService.taskMode("edit"),$scope.storyBoardCotainer={selector:"storyboard",selectedTab:tab||("universalbot"===$workflowService.selectedStream().type?"faq":"dialog")}},function(error){deferred.reject(error)}):"story"===tab?$scope.callbacks.getScenes($workflowService.selectedStream()._id).then(function(res){$scope.storyBoardCotainer={selectedTab:tab||("universalbot"===$workflowService.selectedStream().type?"faq":"dialog")}},function(err){}):$scope.storyBoardCotainer={selectedTab:tab||("universalbot"===$workflowService.selectedStream().type?"faq":"dialog")}},$scope.setStoryboardTab();$workflowService.cloneData($workflowService.selectedStream().channels);$scope.hasSaveButton={generalSettings:!0,manageSessions:!0,botStoreSettings:!0,ivrSettings:!0,customLibrary:!0,amendEntity:!0},$scope.fullWidthPanels={botDashboard:!0,metrics:!1,standardResponses:!0,batchTesting:!0,apps:!0},$scope.innerScrollItems={testTrain:!0,batchTesting:!0,metrics:!0,publish:!0,sessionFlow:!0,synonyms:!0,patterns:!0,standardResponses:!0,machineLearningUtterances:!0,traits:!0,widgets:!0,apps:!0,botSummary:!0,storyboard:!0,containmentDashboard:!0,conversations:!0,performance:!0,negativePatterns:!0,customDashboard:!0,conversationTesting:!0},$scope.getAllTasks=function(){var deferred=$q.defer();return $q.all([$scope.callbacks.getAlerts($workflowService.selectedStream()._id),$scope.callbacks.getActions($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.callbacks.getKnowledgeTasks($workflowService.selectedStream()._id)]).then(function(res){deferred.resolve(res)},function(error){deferred.reject(error)}),deferred.promise},$scope.importExportCb={activeTab:"IMPORT",getAllTasks:$scope.getAllTasks},$scope.updateSupportedLanguage=function(){$scope.supportedLanguages=mapSupportedLanguages(),$workflowService.supportedLanguages($scope.supportedLanguages),$scope.callbacks.supportedLanguages=$scope.supportedLanguages;var seedDataNLUSupportedLanguages=$workflowService.seedData().nluSupportedLanguages,multiLingualConfigurations=$workflowService.selectedStream().multiLingualConfigurations;if(multiLingualConfigurations&&_.forEach($scope.callbacks.supportedLanguages,function(lang){multiLingualConfigurations[lang.value]&&multiLingualConfigurations[lang.value].nluLanguage&&_.forEach(seedDataNLUSupportedLanguages,function(eachNlu){eachNlu.value===multiLingualConfigurations[lang.value].nluLanguage&&(lang.nluLanguage=eachNlu.name)})}),$workflowService.selectedStream().supportedLanguages){var genericLanguage={},genericlang=!1;_.forEach($workflowService.selectedStream().supportedLanguages,function(valueLang){"ge"===valueLang&&(genericLanguage={value:"ge",dvalue:"ge",name:"Generic",enabled:!0},genericlang=!0)}),$rootScope.seedLanguages||($rootScope.seedLanguages={}),$rootScope.seedLanguages.ge={},genericlang&&($scope.callbacks.supportedLanguages.push(genericLanguage),$rootScope.seedLanguages.ge={value:"ge",dvalue:"ge",name:"Generic",enabled:!0})}},$scope.callbacks.updateSupportedLanguage=$scope.updateSupportedLanguage,$scope.lmmCallback.updateSupportedLanguage=$scope.updateSupportedLanguage;var viewList=navigator.tabPermisionList;$scope.setView=function(view){$scope.stream=$workflowService.selectedStream(),"universalbot"===$workflowService.selectedStream().type?$workflowService.selectedStream().universalBotVersion&&1!==$workflowService.selectedStream().universalBotVersion||"linkedBotTraining"!==view?$scope.showUpgradeUniversal=!1:($scope.showUpgradeUniversal=!0,$scope.upgradeAccessRights=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE")):$scope.showUpgradeUniversal=!1,$("iframe").removeClass("expanded"),$scope.rightNavAccordianEvents(),$(".innerRight").scrollTop(1),navigator.navigationTree.menuItem[view]||(view="botSummary"),$scope.callbacks.getAllAccessRights(navigator.tabPermisionList[view]),$scope.showNavPopover.hovered=null,$(".navLinks").popover("hide"),checkForCheckListUpdate(view),$scope.rightPanel.innerRightPanel.view=view;var previousNavigationObj=JSON.parse(JSON.stringify(navigator.currentNavigationObj));navigator.setNavigation(view);var navigationObj=JSON.parse(JSON.stringify(navigator.currentNavigationObj));navigationObj.menu=view,navigationObj.selectedTab!==previousNavigationObj.selectedTab?mixpanelEvent(view,navigationObj.selectedTab):mixpanelEvent(view),navigator.setORGetPreviousState(navigationObj),$timeout(function(){"botSummary"===view&&$("#rightPanelLoadingSpin").hide(),$(window).trigger("resize"),$(".innerRight").scrollTop(1),$(".fullRightContainrLoader").fadeTo(700,0),$scope.expandToMenu(navigationObj),$("#rightPanelScrollContents").scrollTop(1)},300),$timeout(function(){$("#rightPanelScrollContents").scrollTop(1),$scope.startStopPanelLoading(),"dialogTasks"==view&&$workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:""})},1e3),$scope.callbacks&&$scope.callbacks.getLicenseInfo&&$scope.callbacks.getLicenseInfo(),$timeout(function(){window.inline_manual_player&&window.inline_manual_player.update()},3e3)},$scope.expandToMenu=function(navigationObj){var menuElement=$("#rightNavAccordian").find("#menuItem_"+navigationObj.selectedTabMenu),menuElements=$(menuElement).find(".koreMenuItems").length;menuElements&&menuElement&&menuElement.length&&!menuElement.hasClass("in")&&($("#menuHeader_"+navigationObj.selectedTabMenu).click(),menuElement.parent().hasClass("active")||menuElement.parent().addClass("active"))},$scope.startGuidedTour=function(menuItem){$workflowService.selectedStream();
},$scope.startStopPanelLoading=function(start){$("#rightPanelLoadingSpin").show(),start?($scope.loadingPanel=!0,$(".fullRightContainrLoader").fadeTo(0,1),$scope.loadingRightPannel=!0):($scope.loadingRightPannel=!1,$scope.loadingPanel=!1,$(".fullRightContainrLoader").fadeTo(0,1))},$scope.checkUbVersion=function(){return 1!==$scope.stream.universalBotVersion&&$scope.stream.universalBotVersion?2:1},$scope.reloadPanel=function(){$scope.streamstate.toggleState=$workflowService.selectedStreamState(),$scope.switchingState=!0;var requests=[BTStreamsService.getBTStream($scope.stream._id),BTStreamsService.getMPStream($scope.stream._id)];$q.all(requests).then(function(res){null===res[0].data.icon&&delete res[0].data.icon,$scope.streamdata=angular.extend({},res[1].data,res[0].data),$scope.streamdata.isInMarket=!0,$workflowService.selectedStream($scope.streamdata),$scope.stream=$workflowService.selectedStream(),$scope.stream.hasOwnProperty("enableAutoUtteranceAddition")&&$scope.autotrainData&&($scope.autotrainData.enableAutoUtteranceAddition=$scope.stream.enableAutoUtteranceAddition),$scope.rightPanel&&$scope.rightPanel.innerRightPanel&&"training"===$scope.rightPanel.innerRightPanel.view&&"universalbot"===$scope.stream.type&&($scope.stream.universalBotVersion&&1!==$scope.stream.universalBotVersion?($scope.showUpgradeUniversal=!1,$scope.callbacks.fetchLinkedBots()):($scope.showUpgradeUniversal=!0,$scope.upgradeAccessRights=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"))),$scope.rightPanel&&$scope.rightPanel.innerRightPanel&&"smallTalk"===$scope.rightPanel.innerRightPanel.view&&$scope.callbacks.getSmallTalkGroups($scope.streamdata._id),$scope.rightPanel&&$scope.rightPanel.innerRightPanel&&"linkedBots"===$scope.rightPanel.innerRightPanel.view&&$scope.callbacks.fetchLinkedBots(),$scope.switchingState=!1},function(err){NotificationService.notify(err.data.errors[0].msg,"error"),$scope.switchingState=!1})},$scope.openLanguageGenericModal=function(){$("#languageModalGeneric").modal("show")},$scope.checkForGenericLanguage=function(){$scope.searchLanguage={},$scope.searchLanguage.languageSelect="",$scope.showGenericProtip=!1,$scope.callbacks.showGenericProtip=!1,$scope.seedDataNluSupportedLanguages=$workflowService.seedData().nluSupportedLanguages,_.forEach($scope.stream.supportedLanguages,function(value){"ge"===value&&($scope.showGenericProtip=!0,$scope.callbacks.showGenericProtip=!0)}),$workflowService.selectedStream().enableInputTranslation&&!$workflowService.selectedStream().multiLingualConfigurations?$scope.inputTranslation=!0:$workflowService.selectedStream().multiLingualConfigurations&&($scope.inputTranslation=!1),$scope.showSelectedLanguage="",_.forEach($scope.stream.supportedLanguages,function(value){"ge"===value&&$("#languageModalGeneric").modal("show")})},$scope.setLanguageCode=function(lang){$scope.showSelectedLanguage=lang,$scope.searchLanguage.languageSelect=""},$scope.openLanguageSlider=function(){$scope.rightPanel&&$scope.rightPanel.innerRightPanel&&$scope.rightPanel.innerRightPanel.showView&&"languageManagement"!==$scope.rightPanel.innerRightPanel.view?($workflowService.storeSearchQry({userSearchQueryFlag:!0,searchQry:"openLanguageTranslation"}),$scope.rightPanel.innerRightPanel.showView("languageManagement")):$scope.openModalSlider("#listLanguageManagement")},$scope.initRightpanel=function(){$scope.callbacks.setSaveCallbacks(),navigator.resetNavigator(),navigator.prepareNavigationTree();var previousState="null";JSON.parse(JSON.stringify(navigator.currentNavigationObj));previousState=navigator.setORGetPreviousState();var rightPanel=getDefaultMenu();previousState&&previousState.tab&&previousState.menu&&"NO"!==$scope.getPermissionMode(navigator.tabPermisionList[previousState.menu])&&(rightPanel=previousState.menu),"NO"!==accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS")&&getBotVariables(),$scope.navigateTo(null,rightPanel);$workflowService.newBotSetupProgress();$workflowService.newBotSetupProgress({}),$scope.seedDataSupportedLanguages=$workflowService.seedData().supportedLanguages,_.forEach($workflowService.selectedStream().supportedLanguages,function(value){var newvalues=_.filter($scope.seedDataSupportedLanguages,function(item){return item.value!==value});$scope.seedDataSupportedLanguages=newvalues}),$scope.checkForGenericLanguage()};var addNewSupportedLanguage=function(){var payload={preferredData:["definition","training","faqs","ontology","smalltalk","traits"],baseLanguage:"ge"};payload.multiLingualConfigurations={},payload.multiLingualConfigurations[$scope.showSelectedLanguage.value]={nluLanguage:$scope.showSelectedLanguage.value};var selectedNluLanguage=!1;_.forEach($scope.seedDataSupportedLanguages,function(eachLanguage){eachLanguage.value===$scope.showSelectedLanguage.value&&(selectedNluLanguage=!0)}),selectedNluLanguage?payload.multiLingualConfigurations[$scope.showSelectedLanguage.value]={nluLanguage:$scope.showSelectedLanguage.value}:payload.multiLingualConfigurations[$scope.showSelectedLanguage.value]={nluLanguage:"ge"},BTStreamsService.addSupportedLanguage($workflowService.selectedStream()._id,$scope.showSelectedLanguage.value,payload).then(function(res){$("#languageModalGeneric").modal("hide"),$scope.showGenericProtip=!1,$scope.inputTranslation=!1;var index=$scope.callbacks.supportedLanguages.findIndex(function(lang){return"ge"===lang.value});$scope.callbacks.supportedLanguages.splice(index,1),$scope.callbacks.updateSupportedLanguage(),console.log($scope.callbacks.supportedLanguages)})["catch"](function(res){})};$scope.proceedLanguageEnable=function(){BTStreamsService.disableLanguage($workflowService.selectedStream()._id,"ge").then(function(response){response&&($scope.selectedStream=response.data,NotificationService.notify("Generic language is now changed to "+$scope.showSelectedLanguage.name,"success"),$workflowService.selectedStream(response.data),addNewSupportedLanguage())},function(errors){errors&&errors.data&&errors.data.errors&&errors.data.errors.length&&errors.data.errors[0]&&errors.data.errors[0].msg&&NotificationService.notify(errors.data.errors[0].msg,"error")})},$scope.loadMenuDependencies=function(view,successCb,subtab){switch(view){case"storyboard":$scope.callbacks.updateAllowNamespace(),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id).then(function(res){$scope.setView(view)},function(params){$scope.startStopPanelLoading()});break;case"defaultDialogUniversal":$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id).then(function(res){$scope.callbacks.prepareDefautDialogData(res.data),$scope.setView(view)},function(params){$scope.startStopPanelLoading()});break;case"eventsManage":$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id).then(function(res){$scope.setView(view)},function(params){$scope.startStopPanelLoading()});break;case"widgets":$q.all([$scope.callbacks.getForms($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id)]).then(function(res){$scope.setView(view),$scope.callbacks.fetchLinkedBots()},function(params){$scope.startStopPanelLoading()});break;case"dialogTasks":$scope.callbacks.updateAllowNamespace(),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id).then(function(res){$scope.setView(view)},function(params){$scope.startStopPanelLoading()}),$workflowService.storeSearchQry().userSearchQueryFlag&&"dialogTasks"===$workflowService.storeSearchQry().navigateTo&&$workflowService.storeSearchQry().searchQry&&$scope.callbacks.appendSearchQry($workflowService.storeSearchQry()),$scope.callbacks.appendSearchInDialogs("");break;case"linkedBots":$scope.callbacks.fetchLinkedBots(),$scope.callbacks.fetchUnlinkBots(),$scope.callbacks.trainStatus(),$scope.setView(view);break;case"uiForms":$scope.callbacks.getForms($workflowService.selectedStream()._id),$scope.setView(view);break;case"manageSessions":$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.setView(view);break;case"exportBot":$q.all([$scope.callbacks.getAlerts($workflowService.selectedStream()._id),$scope.callbacks.getActions($workflowService.selectedStream()._id),$scope.callbacks.getForms($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.callbacks.getMappings($workflowService.selectedStream()._id)]).then(function(res){$scope.setView(view)},function(params){$scope.startStopPanelLoading()});break;case"botImportExport":$scope.callbacks.getForms($workflowService.selectedStream()._id),$scope.setView(view);break;case"advancedSettings":$q.all([$scope.callbacks.getAlerts($workflowService.selectedStream()._id),$scope.callbacks.getActions($workflowService.selectedStream()._id),$scope.callbacks.getForms($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.callbacks.getMappings($workflowService.selectedStream()._id)]).then(function(res){$scope.setView(view)},function(params){$scope.startStopPanelLoading()});break;case"knowledgeCollection":$scope.callbacks.getKnowledgeTasks($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.setView(view);break;case"alertTasks":$scope.callbacks.updateAllowNamespace(),$scope.callbacks.getAlerts($workflowService.selectedStream()._id),$scope.setView(view);break;case"informationTasks":$scope.callbacks.updateAllowNamespace(),$scope.callbacks.getActions($workflowService.selectedStream()._id),$scope.setView(view);break;case"actionTasks":$scope.callbacks.updateAllowNamespace(),$scope.callbacks.getActions($workflowService.selectedStream()._id),$scope.setView(view);break;case"flows":$q.all([$scope.callbacks.getAlerts($workflowService.selectedStream()._id),$scope.callbacks.getActions($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.callbacks.getMappings($workflowService.selectedStream()._id),$scope.callbacks.getAlertDialogMappings($workflowService.selectedStream()._id)]),$scope.setView(view);break;case"sentimentManagement":$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id).then(function(response){$scope.setView(view)},function(params){$scope.startStopPanelLoading()});break;case"smallTalk":$scope.callbacks.updateAllowNamespace(),$scope.callbacks.getSmallTalkGroups($workflowService.selectedStream()._id),$scope.setView(view);break;case"nlAdvancedSettings":$scope.autotrainData.enableAutoUtteranceAddition=$workflowService.selectedStream().enableAutoUtteranceAddition||!1,$scope.setView(view);break;case"linkedBotTraining":$workflowService.selectedStream().universalBotVersion&&1!==$workflowService.selectedStream().universalBotVersion?($scope.showUpgradeUniversal=!1,$scope.callbacks.fetchLinkedBots()):($scope.showUpgradeUniversal=!0,$scope.upgradeAccessRights=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE")),$scope.fetchStreamData(),$scope.setView(view);break;case"mlThresholds":$scope.callbacks.getKnowledgeTasks($workflowService.selectedStream()._id).then(function(response){$scope.setView(view)},function(params){$scope.startStopPanelLoading()});break;case"generalSettings":$scope.callback=$scope.callbacks.saveBtnCallbacks.generalSettings,$scope.setView(view);break;case"languageManagement":$scope.setView(view),$timeout(function(){$scope.loadGeneralSettingAsDependent=!0,$(".innerRight").scrollTop(1)},800);break;case"variableManagement":$timeout(function(){$scope.variableMngtCallback&&$scope.variableMngtCallback.stopFetching&&$scope.variableMngtCallback.stopFetching()},200),$scope.setView(view);break;case"variableManagementContent":$timeout(function(){$scope.variableMngtCallback&&$scope.variableMngtCallback.stopFetching&&$scope.variableMngtCallback.stopFetching()},200),$scope.setView(view);break;case"standardResponses":$q.all([$scope.callbacks.getAlerts($workflowService.selectedStream()._id),$scope.callbacks.getActions($workflowService.selectedStream()._id),$scope.callbacks.getForms($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.callbacks.getMappings($workflowService.selectedStream()._id)]).then(function(res){$scope.setView(view)},function(params){$scope.startStopPanelLoading()});break;case"botTesting":$workflowService.nlpTrainInput({}),$scope.setView(view);break;case"publish":if($scope.callbacks.fetchLinkedBots(),"solution"==$scope.stream.type&&!$scope.stream.solutionBotSettings){NotificationService.notify(i18n.i18nString("publish_smartbot"),"warning"),$scope.startStopPanelLoading();break}if("sample"==$scope.stream.type&&!$scope.stream.solutionBotSettings){NotificationService.notify(i18n.i18nString("publish_samplebot"),"warning"),$scope.startStopPanelLoading();break}var callback=function(params){$scope.setView(view)};$scope.callbacks.preparePublishPage(callback);break;case"botSummary":"universalbot"===$scope.stream.type&&$scope.callbacks.fetchLinkedBots(),$scope.setView(view);break;case"metrics":$q.all([$scope.callbacks.getAlerts($workflowService.selectedStream()._id),$scope.callbacks.getActions($workflowService.selectedStream()._id),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.callbacks.getKnowledgeTasks($workflowService.selectedStream()._id)]).then(function(res){$scope.setView(view)},function(error){$scope.startStopPanelLoading()});break;case"dashboard":$scope.$emit("homeDirectivesLoaded"),$scope.setView(view);break;case"botDashboard":$scope.$emit("homeDirectivesLoaded"),$scope.setView(view);break;case"machineLearningUtterances":$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id),$scope.setView(view),$timeout(function(){$scope.startStopPanelLoading()}),subtab&&setTimeout(function(){$scope.utterancesCb.showActiveType(subtab)},500);break;case"botImportExport":break;default:$scope.setView(view)}},$scope.activeTypeRegiters=function(menuId){$scope.stream=$workflowService.selectedStream(),$workflowService.storeSearchQry().userSearchQueryFlag&&"Knowledge Collection"===$workflowService.storeSearchQry().navigateTo&&!$workflowService.taskEditInfo()&&getKnowledgeTasks(),"botDashboard"!==menuId&&($(".rightPanel").removeClass("realTimeDashboardDiv"),$(".rightPanel").removeClass("fakeDataDivChild")),"storyboard"===menuId?($scope.iframeLoding=!0,$("body").addClass("storyboard")):"storyboard"!==menuId&&$("body").removeClass("storyboard")},$scope.universalBotVersion=function(){return $scope.stream.universalBotVersion},$scope.rightPanel={innerLeftPanel:$scope.rightPannelMenu,innerRightPanel:{view:getDefaultMenu(),showView:function(view,cb,subtab){return $("body").removeClass("bt-welcome-modal-open"),$(".botDetailsForm").removeClass("dialogModalOpen"),$scope.stream=$workflowService.selectedStream(),$scope.botDetails.streamState=$workflowService.selectedStreamState(),$("#searchForMenu").closest(".dropdown").hasClass("open")&&$("#searchForMenu").dropdown("toggle"),$scope.startStopPanelLoading(!0),$scope.callbacks.updateSupportedLanguage(),$scope.activeTypeRegiters(),$scope.getPermissionMode(viewList[view]),"setup"===$scope.stream.state&&$scope.stream.sbStreamId&&"dialogs"!==view&&"botSummary"!==view?(NotificationService.notify(i18n.i18nString("setup_bot_access"),"warning"),void $scope.startStopPanelLoading()):"deleteBot"==view?("VIEW"===$scope.callbacks.modeOfAccess?$(".blockMain.deleteBot").css({"pointer-events":"none"}):$scope.deleteStream($scope.stream,view),void $scope.startStopPanelLoading()):"launchMigrationTool"==view?($scope.launchMigrationTool($scope.stream),void $scope.startStopPanelLoading()):("knowledgeCollection"==view?$scope.knowledgeDisplayMode():"negativePatterns"!=view||$scope.stream.enableNegativePatterns||(view="patterns"),$scope.rightPanel.innerRightPanel.view!=view&&($scope.orderType="-lMod"),$scope.resumingBuilder?setTimeout(function(){$scope.loadMenuDependencies(view,null,subtab)},500):$scope.loadMenuDependencies(view,null,subtab),$scope.creationForm=!1,$scope.taskType="",void $(".innerRight").scrollTop(0))},canShow:function(view){switch("taskbot"===$scope.stream.type&&($scope.stream.type="default"),view){case"actionTasks":return $workflowService.actionTasks().length;case"informationTasks":return $workflowService.informationTasks().length;case"storyboard":return"default"===$scope.stream.type||"sample"===$scope.stream.type;case"ivrSettings":return $scope._constants_.config.ENABLE_IVR;case"botStoreSettings":return $scope.isWorkFlowAdmin()&&$scope.isSampleBot();case"deleteBot":return $scope.isEligibleForDeleteBot($scope.stream);case"launchMigrationTool":return $scope.isWorkFlowAdmin();case"smartBotSettings":return $scope.isSmartBot();case"sampleBotSettings":return!1;case"IIPMasking":return!0;case"developerShare":return $scope.isEligibleToShare();case"languageManagement":return $scope._constants_.config.supportI18N;case"customLibrary":return $scope._constants_.config.customLibrary;case"flows":return eligibleToShowType(view);case"tryMode":return $scope.publishViews.hasPublishedTasks&&$scope.stream.isSolutionBot&&!1;case"machineLearningUtterances":return"universalbot"!==$scope.stream.type;case"ignoreWords":return $scope.getIgnoreWordsVisisbility();case"negativePatterns":return $workflowService.selectedStream().enableNegativePatterns;default:return!0}},canShowChildren:function(view){switch(view){case"greteing":return!$scope.stream.isSmalltalkMigrated;default:return!0}},doAction:function(event){switch($scope.rightPanel.innerRightPanel.view){case"generalSettings":$scope.gsCallback.createStream(event);break;case"manageSessions":$scope.msCallback.createStream(event);break;case"languageManagement":$scope.$broadcast("updateLanguageSettings");break;case"botStoreSettings":$scope.bssCallback.createStream(event);break;case"authorization":break;case"variableManagement":break;case"variableManagementContent":break;case"developerShare":break;case"changeLogs":break;case"advancedSettings":$scope.asCallback.createStream(event);break;case"ivrSettings":$scope.asIVRCallback.createIVRStream(event);break;case"customLibrary":$scope.customLibrary.botFunctionTemplate(event);break;case"amendEntity":$scope.amendEntityCb.submitData();break;case"botImportExport":"IMPORT"===$scope.importExportCb.activeTab?$scope.$broadcast("updateBotImport"):$scope.$broadcast("updateBotExport")}}}},$scope.callbacks.rightPanel=$scope.rightPanel;var formEventForCreation=$scope.$on("resetCreateConditions",function(evt){$scope.closeDialogCreation(),$scope.creationForm=!1,$scope.taskType=""}),savingLang=$scope.$on("savingInprogress",function(evt,saving){$scope.rightPanel.innerRightPanel.saveInprogress=saving});$scope.$on("$destroy",function(){formEventForCreation(),savingLang()}),$scope.closeUpgradeModal=function(){$element.find("#upgradeUniversal").removeClass("show").addClass("fade"),$scope.disableUpgrade=!1},$scope.upgradeUniversalModal=function(){$element.find("#upgradeUniversal").removeClass("fade").addClass("show"),$scope.disableUpgrade=!0},$scope.editLinkBot=function(bot){$scope.linkBot=bot,$scope.showEditLink=!0,BTStreamsService.getLinkBot($scope.stream._id,$scope.linkBot._id).then(function(response){response&&response.data&&response.data.result&&($scope.openModalSlider("#editLinkBot"),$scope.editLinkTrainingData=response.data.result)},function(err){NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})},$scope.upgradeUniversalBot=function(){NotificationService.notify(i18n.i18nString("bot_upgrade_progress"),"success"),$element.find("#upgradeUniversal").removeClass("show").addClass("fade"),upgradeUniversalServiceCall().then(function(response){response&&($scope.stream.universalBotVersion=response.data.universalBotVersion,$workflowService.selectedStream($scope.stream),$scope.initRightpanel(),NotificationService.notify(i18n.i18nString("bot_upgrade_success"),"success"),$scope.disableUpgrade=!1)},function(err){NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})},$scope.enableDisablePreferredBot=function(e,linkedBot){if(e&&(e.stopPropagation(),e.stopImmediatePropagation()),linkedBot){if(linkedBot.inclusiveBot&&linkedBot.preferredBotStatus)return linkedBot.preferredBotStatus=!linkedBot.preferredBotStatus,void NotificationService.notify(i18n.i18nString("linked_marked"),"error");var _payload={preferredBot:linkedBot.preferredBotStatus,botId:linkedBot._id};BTStreamsService.addTrainingData($scope.stream._id,_payload).then(function(response){if(linkedBot.preferredBotStatus?NotificationService.notify(i18n.i18nString("added_fallback_Bots",{dyn:linkedBot.botName}),"success"):linkedBot.preferredBotStatus||NotificationService.notify(i18n.i18nString("removed_fallback_Bots",{dyn:linkedBot.botName}),"success"),$workflowService.selectedStream(response.data),response.data&&response.data.upgradedBots){var filteredResults=_.filter(response.data.upgradedBots,{_id:linkedBot._id});filteredResults&&(linkedBot.state="linked")}},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):linkedBot.preferredBotStatus?NotificationService.notify(i18n.i18nString("error_fallback",{dyn:linkedBot.botName}),"error"):linkedBot.preferredBotStatus||NotificationService.notify(i18n.i18nString("error_removing_fallback",{dyn:linkedBot.botName}),"error"),linkedBot.preferredBotStatus=!linkedBot.preferredBotStatus})}},$scope.enabledDisableInclusiveBot=function(e,linkedBot){if(e.stopPropagation(),linkedBot){if(linkedBot.preferredBotStatus&&linkedBot.inclusiveBot)return linkedBot.inclusiveBot=!linkedBot.inclusiveBot,void NotificationService.notify(i18n.i18nString("linked_marked"),"error");var _payload={inclusiveBot:linkedBot.inclusiveBot,botId:linkedBot._id};BTStreamsService.addTrainingData($scope.stream._id,_payload).then(function(response){if(linkedBot.inclusiveBot?NotificationService.notify(i18n.i18nString("added_inclusive",{dyn:linkedBot.botName}),"success"):linkedBot.inclusiveBot||NotificationService.notify(i18n.i18nString("remove_inclusive",{dyn:linkedBot.botName}),"success"),$workflowService.selectedStream(response.data),response.data&&response.data.upgradedBots){var filteredResults=_.filter(response.data.upgradedBots,{_id:linkedBot._id});filteredResults&&(linkedBot.state="linked")}},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):linkedBot.inclusiveBot?NotificationService.notify(i18n.i18nString("error_adding_inclusive",{dyn:linkedBot.botName}),"error"):linkedBot.inclusiveBot||NotificationService.notify(i18n.i18nString("error_removing_inclusive",{dyn:linkedBot.botName}),"error"),linkedBot.inclusiveBot=!linkedBot.inclusiveBot})}},$scope.streamUpdateCB=function(streamdata){$scope.stream=streamdata},$scope.update.updateStreamData=function(stream){$scope.stream=stream},$scope.getDescription=function(){return i18n.i18nString("bot_synonym_desc")},$scope.exportBot=function(){$scope.exportOptions.botComponents=[],$scope.exportOptions.nlpData=[],$scope.exportOptions.settings=[],$scope.linkedBots=[{task:i18n.i18nString("linked_bots"),value:"linkedBots",selected:!0},{task:i18n.i18nString("small_talk"),value:"smallTalk",selected:!0}],$scope.settings=[{task:i18n.i18nString("bot_settings"),value:"botSettings",selected:!0},{task:i18n.i18nString("ivr_settings"),value:"ivrSettings",selected:!0}],$scope.nlp=[{task:i18n.i18nString("training_data"),value:"training_data",selected:!0},{task:i18n.i18nString("Bot_synonyms_label"),value:"bot_synonyms",selected:!0},{task:i18n.i18nString("settings"),value:"nlpSettings",selected:!0},{task:i18n.i18nString("default_dialog"),value:"defaultDialog",selected:!0},{task:i18n.i18nString("ddval_standard"),value:"standardResponses",selected:!0}],$scope.categories=[{key:"Bot Components",list:$scope.linkedBots,selected:!0},{key:i18n.i18nString("nlp_data"),list:$scope.nlp,selected:!0},{key:i18n.i18nString("settings"),list:$scope.settings,selected:!0},{key:i18n.i18nString("custonDashboards"),selected:!0}],taskResult=$scope.categories[0].list.forEach(function(key,value){key.selected===!0&&$scope.exportOptions.botComponents.push(key.value)}),nlpdata=$scope.categories[1].list.forEach(function(key,value){key.selected===!0&&$scope.exportOptions.nlpData.push(key.value)}),showFailedErrors=$scope.categories[2].list.forEach(function(key,value){key.selected===!0&&$scope.exportOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.categories[3].key&&($scope.customDashboards=!0);var _payload={exportOptions:$scope.exportOptions};BTFlowtaskService.exportBot($scope.stream._id,_payload).then(function(res){if(res&&res.data&&($scope.bot.exportType=res.data.exportType,$scope.streamRefId=res.data._id||"",$scope.statusLogs=res.data.statusLogs||[],"pending"===res.data.status?($scope.exporting=res.data.status,$rootScope.$broadcast("getProgressDockStatus"),$scope._exportStatusInit=startPollExportStatus(3e3)):"success"===res.data.status?($rootScope.$broadcast("getProgressDockStatus"),$scope.exporttype=res.data.exportType.charAt(0).toUpperCase()+res.data.exportType.substr(1),stopExportBotPolling("success")):stopExportBotPolling("failed"),res.data&&res.data.store&&res.data.store.timeoutMessage)){var msg=res.data.store.timeoutMessage;NotificationService.notify(msg,"warning")}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("bt_export_unexpected_err_while_exporting"),"error");if("RequestExists"===error.data.errors[0].code){var _msg1=error.data.errors[0].code;NotificationService.notify(_msg1,"warning")}})},$scope.updatePScroll=function(){return $(".innerRightBody").scrollTop(0),!1},$scope.$parent.getMenuPath=function(){return[$scope.activeType,$scope.rightPanel.innerRightPanel.view]},$scope.isEnabled=function(){return"ivrSettings"==$scope.rightPanel.innerRightPanel.view?$scope.asIVRCallback.enabled?!1:!0:!1},$scope.getIgnoreWordsVisisbility=function(){var flag=!0;return"universalbot"==$scope.stream.type&&(flag=!1),$scope.stream.taskCounts&&!$scope.stream.taskCounts.alerts.length&&$scope.stream.taskCounts&&!$scope.stream.taskCounts.actions.length&&(flag=!1),flag},$scope.knowledgeDisplayMode=function(){return accessControlService.getAccessRight("BOTBUILDER_KNOWLEDGE_GRAPH")},$scope.isSmartBot=function(){return"solution"===$scope.stream.type?!0:!1},$scope.isSampleBot=function(){return"sample"===$scope.stream.type?!0:!1},$scope.getMenuName=function(menuType){return"developerShare"===menuType?(menuName=i18n.i18nString("inivite_developer_summary"),$scope.stream.codevelopers&&$scope.stream.codevelopers.length&&(menuName=i18n.i18nString("manage_developer"))):"synonyms"===menuType&&("universalbot"===$scope.stream.type?menuName=i18n.i18nString("ddval_synonyms"):menuName=i18n.i18nString("synonyms_label")),menuName},$scope.fetchStreamData=function(){BTStreamsService.getBTStream($scope.stream._id).then(function(response){response&&$workflowService.selectedStream(response.data)})},$scope.getPermissionMode=function(_componentid,menuId){return _componentid||(_componentid=viewList[$scope.rightPanel.innerRightPanel.view]),$scope.callbacks.modeOfAccess=accessControlService.getAccessRight(_componentid),accessControlService.setRetrieveValue($scope.callbacks.modeOfAccess),$scope.callbacks.modeOfAccess},$scope.redirectToLink=function(linkType,e){e&&e.stopPropagation(),$rootScope.redirectToLink(linkType)},$scope.loaded=function(){$scope.$emit("homeDirectivesLoaded")},$scope.openDialogCreation=function(){$scope.openModalSlider("#createtask")},$scope.closeDialogCreation=function(){$scope.creationForm=!1,$scope.closeModalSlider("#createtask")},$scope.showForm=function(event,type){var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};if(event&&(event.preventDefault(),event.stopPropagation()),"dialogTasks"===type&&$scope.openDialogCreation(),"alertTasks"===type){$scope.openDialogCreation();var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Alert Task"};mixPanel.postEvent("Conversation - Alert Task initiated",eventInfo)}$scope.taskType=type,"flows"!==type&&"knowledgeCollection"!==type?$scope.creationForm=!0:"knowledgeCollection"==type?(mixPanel.postEvent("New KG Creation",_botInfo),$workflowService.resetTaskEditInfo(),$workflowService.taskMode("edit"),"storyboard"===$scope.rightPanel.innerRightPanel.view?$scope.storyBoardCotainer.createFaq=!0:$scope.openOntologyModel(),$scope.callbacks.setChecklistValues(type)):($scope.fullModalCallback.openFullPageModal(3),$timeout(function(){$rootScope.$emit("createFlowOptions")}))},$scope.editLinkCb={closeEditLinkModal:closeEditLinkModal},$scope.botSelectionCb={closeSelectionModal:closeSelectionModal},$scope.callbacks.showForm=$scope.showForm,$scope.initRightpanel(),$scope.canShowFooter=function(ele){if(ele){var noFooterActiveType=["botTasks","agents","nl","testTrain","batchTesting","training","defaultConversation"];if(-1!==$.inArray($scope.activeType,noFooterActiveType))return!1;var noFooterArray=["authorization","variableManagement","variableManagementContent","developerShare","changeLogs","botImportExport","importBot","tryMode","exportBot","smartBotSettings","sampleBotSettings","customLibrary","IIPMasking","errorMessage","botFunctions","ignoreWords","multiIntentDetection","sentimentManagement","botVersion","botImportExport"];return-1==$.inArray($scope.rightPanel.innerRightPanel.view,noFooterArray)?!0:!1}},$scope.dialogTemplateLoadFlag=function(){$scope.loadingDialogsTemplate=!1,$scope.setStoryboardTab()},$scope.dialogTemplateLoaded=function(){$scope.resumingBuilder&&$scope.botDetails&&$scope.botDetails.builderState&&"botTasks"==$scope.botDetails.builderState.path[0]&&$scope.botDetails.builderState.selectedTaskId?$scope.$emit("nestedComponentLoaded",{id:"botTasks",flag:!0}):$scope.$emit("nestedComponentLoaded",{id:"botTasks",flag:!1});var naviFlag=$workflowService.storeSearchQry().userNavigateFlag,searchQryFlag=$workflowService.storeSearchQry().userSearchQueryFlag;naviFlag&&"agents"===$workflowService.storeSearchQry().rightPanel&&$timeout(function(){$scope.$emit("gSearchLoad")}),searchQryFlag&&"botTasks"===$scope.activeType&&$timeout(function(){$scope.$emit("gSearchLoad")})},$scope.bulderReloaded=function(){$timeout(function(){$scope.$emit("nestedComponentLoaded",{id:"botTasks",flag:!1}),$workflowService.storeSearchQry().userNavigateFlag&&"botTasks"===$workflowService.storeSearchQry().rightPanel&&$timeout(function(){$scope.$emit("gSearchLoad")})},2e3)},$scope.getCount=function(type){var totalTasks;if("smallTalk"==type&&(type="smallTalkByState",tasktype=type),"widgets"===type){if($scope.stream._taskCounts&&$scope.stream._taskCounts.widgets&&$scope.stream._taskCounts.panels){var widgetsCount=$scope.stream._taskCounts.widgets[$scope.streamstate.toggleState],panelsCount=$scope.stream._taskCounts.panels[$scope.streamstate.toggleState],count_text=widgetsCount?widgetsCount>1?widgetsCount+i18n.i18nString("right_panel_widgets"):widgetsCount+i18n.i18nString("right_panel_widgets"):i18n.i18nString("right_panel_no_widget");return count_text+=panelsCount?panelsCount>1?panelsCount+i18n.i18nString("right_panel_panels"):panelsCount+i18n.i18nString("right_panel_panel"):i18n.i18nString("right_panel_no_panel")}return!1}if("knowledgeCollection"!=type&&void 0===$scope[type])return!1;if("knowledgeCollection"==type&&void 0===$scope.knowledgeTasks)return!1;var tasktype=$workflowService.cloneData(type);"dialogTasks"==type&&(tasktype="dialogTasksByState"),"actionTasks"==type&&(tasktype="actionTasksByState"),"alertTasks"==type&&(tasktype="alertTasksByState"),"informationTasks"==type&&(tasktype="informationTasksByState");var count=0;if("knowledgeCollection"===type)return $.each($scope.knowledgeTasksByState,function(i,knowledge){
count+=knowledge.faqCount}),count=count?count+i18n.i18nString("right_panel_questions_answers"):i18n.i18nString("no_questions");if("smallTalkByState"===type)return totalTasks=$scope[tasktype],count=(totalTasks||[]).length,count=count?count>1?count+i18n.i18nString("groups_label"):count+i18n.i18nString("group"):i18n.i18nString("right_panel_no_groups");tasktype="flows"==type?"mappingTasks":tasktype,totalTasks=$scope[tasktype],"linkedBots"==tasktype&&(totalTasks="published"==$scope.streamstate.toggleState?$scope.publishedLinkedBots:$scope[tasktype]),$scope.totalTasks=totalTasks,count=(totalTasks||[]).length,"uiForms"===type&&(count=$scope.sortedUiFormsData[$scope.streamstate.toggleState].length,!count&&$scope.stream._taskCounts&&$scope.stream._taskCounts.forms&&(count=$scope.stream._taskCounts.forms[$scope.streamstate.toggleState]));var subText="";return count?subText=count>1?"universalbot"==$scope.stream.type?i18n.i18nString("bots_label"):"uiForms"==type?i18n.i18nString("forms"):"mappingTasks"==type?i18n.i18nString("right_panel_flows"):i18n.i18nString("tasks"):"universalbot"===$scope.stream.type?i18n.i18nString("bot_label"):"uiForms"==type?i18n.i18nString("form"):"mappingTasks"==type?i18n.i18nString("right_panel_flow"):i18n.i18nString("task"):count="universalbot"===$scope.stream.type?i18n.i18nString("right_panel_no_bots"):"uiForms"==type?i18n.i18nString("right_panel_no_forms"):"mappingTasks"==type?i18n.i18nString("right_panel_noFlows"):i18n.i18nString("right_panel_no_tasks"),count+" "+subText},$scope.callbacks.viewCheck=function(currView,doClear,fromHtmlFlag){currView._id===$scope.rightPanel.innerRightPanel.view&&($scope.callbacks.gSearchSamePage(fromHtmlFlag),doClear&&($scope.callbacks.resetFilter(),$scope.callbacks.resetGSearchText()))},$scope.utterancesCb.showView=$scope.rightPanel.innerRightPanel.showView,$scope.callbacks.clearSearch=function(){$scope.utterancesCb&&$scope.utterancesCb.clearSearch&&($scope.utterancesCb.clearSearch(),$scope.callbacks.resetGSearchText())}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("appCreation",function(){return{restrict:"EA",scope:{newStreamData:"=",streamId:"=?",callback:"=",sdkConf:"=?",sdkConfOnModal:"=?",callFrom:"=",hideUi:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-appCreation/app-creation.html",controller:["$scope","form_util","$routeParams","env_conf","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","$timeout","BTAlertsService","$translator","AppsDataService","$q","channelsConfig","BTFlowtaskService","i18n","$element","accessControlService",function($scope,form_util,$routeParams,env_conf,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,$timeout,BTAlertsService,$translator,AppsDataService,$q,channelsConfig,BTFlowtaskService,i18n,$element,accessControlService){function updateIvrStreamData(streamObj){BTStreamsService.editStream($workflowService.selectedStream()._id,streamObj).then(function(response){if(response.data.ivrSettings){$scope.enabled=response.data.ivrSettings.enable,$workflowService.selectedStream(response.data);$scope.enabled?i18n.i18nString("settings_enabled"):i18n.i18nString("settings_disabled");prepareIVRData()}})}function prepareIVRData(){("entity"===$scope.nodeInfo.dialogNodeInstance.type||"dialogAct"===$scope.nodeInfo.dialogNodeInstance.type||"message"===$scope.nodeInfo.dialogNodeInstance.type)&&($scope.headingsList.showIVRProperty.show=!0,$scope.isEnabled=!1,_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable&&($scope.isEnabled=_selectedStream.ivrSettings.enable,$scope.nodeInfo.nodeInfo&&!$scope.nodeInfo.nodeInfo.ivrOptions?($scope.nodeInfo.nodeInfo.ivrOptions={},angular.copy(_defaultIVRProps,$scope.nodeInfo.nodeInfo.ivrOptions)):$scope.nodeInfo.nodeInfo.ivrOptions&&!$scope.nodeInfo.nodeInfo.ivrOptions.errorPrompts&&($scope.nodeInfo.nodeInfo.ivrOptions.errorPrompts=[]),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&($scope.originalIvrGrammerCopy=angular.copy($scope.nodeInfo.nodeInfo.ivrOptions.grammars)),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.advance.properties&&($scope.originalIvrVxmlCopy=angular.copy($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties))))}function encodeJS(_obj){return encodeURIComponent(_obj)}function isBotPublished(){return"private"!==$scope.stream.visibility.namespace}function filterFn(task){return task&&task.isDeleted?!1:"published"===$scope.streamState?"published"===task.status?!0:!1:"published"===task.status?task.isParent?!1:!0:"published"!==task.status?!0:!1}function getSelectedEventIds(){var selectedSubscribed=_.pluck($scope.selectedEvents,"id");return $scope.stream.sdkSubscription&&$scope.stream.sdkSubscription.subscribedFor&&$scope.stream.sdkSubscription.subscribedFor.length>0?(selectedSubscribed.push("onAgentTransfer"),$scope.stream.sdkSubscription.subscribedFor.push("onAgentTransfer"),$workflowService.selectedStream($scope.stream)):($scope.stream.sdkSubscription||($scope.stream.sdkSubscription={}),$scope.stream.sdkSubscription&&!$scope.stream.sdkSubscription.subscribedFor&&($scope.stream.sdkSubscription.subscribedFor=[]),$scope.stream.sdkSubscription.subscribedFor.push("onAgentTransfer"),$workflowService.selectedStream($scope.stream)),selectedSubscribed}function loadSelectedEvents(eventIds){$scope.sdkConf.events.forEach(function(event){event.checked=!1});eventIds&&eventIds.length&&eventIds.forEach(function(event){var _eve=_.find($scope.sdkConf.events,{id:event});_eve&&(_eve.checked=!0)})}function deleteScopeCheck(index,app){$scope.ignoreScopeCheck=!1,NotificationService.alert(i18n.i18nString("delete_app_scope"),function(){$scope.ignoreScopesCheck=!0;var svcname="bt.apps.delete";$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.delete"),$translator.translate(svcname,{appId:app.clientId,streamId:$workflowService.selectedStream()._id},{ignoreScopesCheck:$scope.ignoreScopesCheck}).then(function(res){if(res&&200===res.status){_.find($scope.manageApps,function(val,i){val.clientId==app.clientId&&(index=i)});$scope.manageApps.splice(index,1),$scope.apps.splice(index,1),NotificationService.notify(i18n.i18nString("app_deleted"),"success",1500)}else NotificationService.notify(i18n.i18nString("error_alert"),"error")},function(errRes){errRes&&errRes.data&&errRes.data.errors.length?NotificationService.notify(errRes.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})},{okText:i18n.i18nString("ok_uppercase")},"",void 0,i18n.i18nString("confirm"))}function format(icon){var originalOption=icon.element;return'<i class="fa '+$(originalOption).data("icon")+'"></i> '+icon.text}var appnameToRetain="";$scope.sdk={},$scope.streamState=$workflowService.selectedStreamState(),$scope.props={},$scope.search={},$scope.done=i18n.i18nString("done"),$scope.next=i18n.i18nString("next"),$scope.editIvr=i18n.i18nString("edit_ivr_settings"),$scope.addIvr=i18n.i18nString("add_ivr_settings"),$scope.stream=$workflowService.selectedStream(),$scope.upgradedTasks=[],$scope.isEnabled=!0,$scope.tmpltPrePath=$scope.$root.tmpltPrePath;var _selectedStream=angular.copy($workflowService.selectedStream());$scope.piiMasking={PIIMaskingDisabledForAgentTransfer:!1},$scope.allVoiceChannelsSlider=!1,$scope.stream&&$scope.stream.sdkSubscription&&($scope.piiMasking.PIIMaskingDisabledForAgentTransfer=$scope.stream.sdkSubscription.PIIMaskingDisabledForAgentTransfer||!1),$scope.callback.updateLocalStream=function(stream){stream&&stream.sdkSubscription&&($scope.piiMasking.PIIMaskingDisabledForAgentTransfer=stream.sdkSubscription.PIIMaskingDisabledForAgentTransfer||!1)},$scope.algthms=[{id:"RS256",label:"RS256"},{id:"HS256",label:"HS256"}],$scope.events_audio_codes_cb={},$scope.props.connectorEnabled=!0,$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.arrowAngle=window.appConfig.CONTEXT_PATH+"/assets/icons/arrowAngle.svg",$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.searchIcon=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.assetsBase=env_conf["assets-url"],$scope.ivrAudio=$scope.assetsBase+"ivrIcons/ivr-audio.svg",$scope.ivrMove=$scope.assetsBase+"ivrIcons/ivr-move.svg",$scope.ivrJS=$scope.assetsBase+"ivrIcons/ivr-js.svg",$scope.ivrTextGreen=$scope.assetsBase+"ivrIcons/ivr-text.svg",$scope.ivrTextBlack=$scope.assetsBase+"ivrIcons/ivr-text-black.svg",$scope.ivrText=$scope.ivrTextGreen,$scope.ivrIcon=$scope.assetsBase+"ivrIcons/ivrIcon.svg",$scope.ivrIconGray=$scope.assetsBase+"ivrIcons/ivrIconGray.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/Manage Apps.png",$scope.noneSelected=!1,$scope.showProceedTip=!1,$scope.replaceAppDetails=!0,$scope.rightClass="right700",$scope.isIvrTwilioEnabled=!1,$scope.connectors=[],$scope.connectors=$workflowService.botConnectors(),$scope.showCallBackProtip=!1,$scope.APIScopes=$workflowService.seedData().appScopes,$scope.currentScope=[],$scope.check=!1,$scope.creation=!1,$scope.search={},$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.selectedState=$workflowService.selectedStreamState(),$scope.channelsConfig=channelsConfig,$scope.jweEnforce={isJtiEnforced:!1,isJweEnforced:!1,jtiEnforced:{},jweEnforced:{}};var supportedEventsUB=["End of Conversation","Facebook Welcome Event","On Connect","Telegram Welcome Event","Telephony Welcome Event","Welcome Event","Intent not Identified"];$scope.eventConfig={proceed:"initiate_task"},$scope.greetings={sel:"greetings_0"},$scope.faq={sel:"faq_0"},$scope.task={sel:"task_0"},$scope.sMgreetings={sel:"sMgreetings_0"},$scope.sMfaq={sel:"sMfaq_0"},$scope.sMtask={sel:"sMtask_0"},$scope.vprop={name:"",value:""},$scope.isRCS=!1,$scope.cb={},$scope.globScriptText="",$scope.welcomeMessages=$scope.stream.welcomeMessage||[],$scope.welcomeMessagecbs={},$scope.welcomeMessagecbs.isAddResponseEnabled=!1,$scope.welcomeMessagecbs.isFrom="events",$scope.welcomeMessagecbs.isAPICall=!1,$scope.responseObj=[],$scope.eventsData=angular.copy($workflowService.seedData().botEvents),$scope.dialogsName=[],$scope.selected={dialog:""},$scope.eventConfigUB={linkedBotId:"",linkedTask:""},$scope.wfAdminScopes=[],$workflowService.seedData().wfAdminScopes&&$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.wfAdmin&&($scope.wfAdminScopes=$workflowService.seedData().wfAdminScopes,$scope.APIScopes=$scope.APIScopes.concat($scope.wfAdminScopes)),$scope.ivrSettingsDefault={ivrSettings:{asrConfidenceThreshold:{key:"confidenceLevel",value:0},extraction_key:"userinput",enable:!1,timeout:"30",enable_log:!0,retry_limit:"6",properties:[],enable_transcript:!1,transcript_tag:"",callTerminationHandler:"",bargein:!1,timeoutPrompts:[[{type:"text",value:""}]],nomatchPrompts:[[{type:"text",value:""}]],grammars:[]}};$scope.isIVREnabled=_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable||$scope.ivrSettingsDefault.ivrSettings.enable,$scope.checkStreamState=function(){return $scope.streamState=$workflowService.selectedStreamState(),"published"==$scope.streamState?!0:!1},$scope.eventNameOpened="",$scope.inp={scriptText:""},$scope.isIVREntered=!1,$scope.globSelDialog="",$scope.isAddRespEdited=!1,$scope.eventNameDisp="",$scope.globOpenedSlider="",$scope.eventCategory="",$scope.isSaveDisabled=!0,$scope.openSliderCallFrom="",$scope.globIsChannelSpecific=null,setTimeout(function(){$rootScope.$emit("pefectScrollUpdate")},2e3),$scope.isWelcome=!1,$scope.events_voice_channels_all_cb={};var isFromTelephonyEvent=!1;$scope.IVRForm={},$scope.vprop={},$scope.vxmlCopy=[],$scope.isEventsPage=!0,$scope.isTwilioVoiceWelcome=!1,$scope.vxmlGlobalKeys=[];var _emptyPrompt={type:"text",value:""},_emptyIVRProp={value:""};$scope.timeoutPrompt=angular.copy(_emptyPrompt),$scope.intialPrompt=angular.copy(_emptyPrompt),$scope.nomatchPrompt=angular.copy(_emptyPrompt),$scope.errorPrompt=angular.copy(_emptyPrompt),$scope.ivrTimeouts=[];for(var i=1;60>=i;i++)$scope.ivrTimeouts[1e3*i]=i+(i>1?" secs":" sec");$scope.ivrRetries=[];for(var j=1;10>=j;j++)$scope.ivrRetries[j]=j;var _emptyVxmlProp={name:"",value:""};$scope.vxmlProp=angular.copy(_emptyVxmlProp),$scope.deleteVxmlPrompt=function(e,index,array,saveIndicatorSelector,label){array.splice(index,1)};var ivrPromptSortableCallback=function(e,ui){$timeout(function(){$scope.saveIVROptions()},300)};$scope.closeBotLevelIvr=function(){$scope.closeModalSlider("#ivrEventLevel")},$scope.callback.closeBotLevelIvr=$scope.closeBotLevelIvr,$scope.ivrPromptsSortableOptions={handle:".sortBar","ui-floating":!0,update:ivrPromptSortableCallback},$scope.nodeInfo={nodeInfo:{ivrOptions:{initialPrompts:[],nomatchPrompts:[],timeoutPrompts:[],errorPrompts:[],grammars:[],advance:{timeout:1e4,retry_limit:3,bargein:!1,properties:[],enable_log:!1,recording:"stop"}}}},$(".JSONDiv a").click(function(){$("#JWTToken").show()}),$scope.saveIVROptions=function(){$scope.originalIvrGrammerCopy=angular.copy($scope.nodeInfo.nodeInfo.ivrOptions.grammars),$scope.isSaveDisabled=!1},$scope.toInt=function(val){return parseInt(val,10)},$scope.deleteGrammar=function(index){$scope.nodeInfo.nodeInfo.ivrOptions.grammars.splice(index,1),$scope.hasUnsavedConnections=!0},$scope.addprompt=function(e,label,item,array,saveIndicatorSelector,ignoreKey){if($scope.readonly)return!1;var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;(ignoreKey||13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)&&(ignoreKey||e.preventDefault(),(ignoreKey||item&&item.value)&&(array.push([angular.copy(item)]),$scope.saveIVROptions(),$scope.timeoutPrompt=angular.copy(_emptyPrompt),$scope.intialPrompt=angular.copy(_emptyPrompt),$scope.nomatchPrompt=angular.copy(_emptyPrompt),$scope.errorPrompt=angular.copy(_emptyPrompt),$scope.vxmlProp=angular.copy(_emptyIVRProp)))},$scope.jsPromptCB={},$scope.jsPromptCB.onMinimize=function(editor,ele){$(ele).closest(".textbox-jseditor").find(".save").click()},$scope.editIVRScript=function(ele){console.log("element",ele),console.log($(ele.target.closest(".textbox-jseditor")).find("[acify] .resizeToggle")),$(ele.target.closest(".textbox-jseditor")).find("[acify] .resizeToggle").click()},$scope.addAltPrompt=function(prompt){"file"===prompt.type&&(prompt.alt=[{type:"text",value:""}])},$scope.saveIvrStream=function(){$scope.callback.createIVRStream()},$scope.enableIvrsettings=function(){if(!$scope.isIVREnabled){$scope.isIVREnabled=!0,_selectedStream.ivrSettings.enable=!0;var btPostData={ivrSettings:{asrConfidenceThreshold:_selectedStream.ivrSettings.asrConfidenceThreshold||$scope.ivrSettingsDefault.ivrSettings.asrConfidenceThreshold,extraction_key:_selectedStream.ivrSettings.extraction_key||$scope.ivrSettingsDefault.ivrSettings.extraction_key,enable:$scope.isIVREnabled||$scope.ivrSettingsDefault.ivrSettings.enable,timeout:parseInt(1e3*_selectedStream.ivrSettings.timeout)||$scope.ivrSettingsDefault.ivrSettings.timeout,retry_limit:parseInt(_selectedStream.ivrSettings.retry_limit)||$scope.ivrSettingsDefault.ivrSettings.retry_limit,properties:_selectedStream.ivrSettings.properties||$scope.ivrSettingsDefault.ivrSettings.properties,enable_log:_selectedStream.ivrSettings.enable_log||$scope.ivrSettingsDefault.ivrSettings.enable_log,enable_transcript:_selectedStream.ivrSettings.enable_transcript||$scope.ivrSettingsDefault.ivrSettings.enable_transcript,transcript_tag:_selectedStream.ivrSettings.transcript_tag||$scope.ivrSettingsDefault.ivrSettings.transcript_tag,callTerminationHandler:_selectedStream.ivrSettings.callTerminationHandler||$scope.ivrSettingsDefault.ivrSettings.callTerminationHandler,bargein:_selectedStream.ivrSettings.bargein||$scope.ivrSettingsDefault.ivrSettings.bargein,grammars:_selectedStream.ivrSettings.grammars||$scope.ivrSettingsDefault.ivrSettings.grammars}};_selectedStream.ivrSettings&&_selectedStream.ivrSettings.timeoutPrompts?btPostData.ivrSettings.timeoutPrompts=[[angular.extend({type:"text"},_selectedStream.ivrSettings.timeoutPrompts[0][0])]]:btPostData.ivrSettings.timeoutPrompts=$scope.ivrSettingsDefault.ivrSettings.timeoutPrompts,_selectedStream.ivrSettings&&_selectedStream.ivrSettings.nomatchPrompts?btPostData.ivrSettings.nomatchPrompts=[[angular.extend({type:"text"},_selectedStream.ivrSettings.nomatchPrompts[0][0])]]:btPostData.ivrSettings.nomatchPrompts=$scope.ivrSettingsDefault.ivrSettings.nomatchPrompts,updateIvrStreamData(btPostData),$scope.callback.enableIvr(),$("#ivrNode").modal("hide")}},$scope.deletealtPrompt=function(index,baseIndex,prompt){var altTab=prompt[baseIndex].alt;altTab.splice(index,1)},$scope.cb.openChannelLevelTwilioVoice=function(){$scope.allVoiceChannelsSlider=!0,setTimeout(function(){$scope.events_voice_channels_all_cb.openChannelLevelTwilioVoice()},100)},$scope.cb.openAudioCodesVoiceProp=function(){$scope.allVoiceChannelsSlider=!0,setTimeout(function(){$scope.events_voice_channels_all_cb.openAudioCodesVoiceProp()},500)},$scope.events_voice_channels_all_cb.closeVoiceSlider=function(){$scope.allVoiceChannelsSlider=!1},$scope.cb.openBotLevelIVR=function(){$("#ivrNode").modal("hide"),$scope.enableIvrsettings(),$scope.openModalSlider("#ivrEventLevel")},$scope.selectJSprompt=function(ele){$timeout(function(){$(ele.target.closest(".ivr-propmpt")).find("[acify] .resizeToggle").click()},300)},$scope.deletePrompt=function(e,baseIndex,index,array,saveIndicatorSelector,label){return $scope.readonly?!1:(array[baseIndex].splice(index,1),0===array[baseIndex].length&&array.splice(baseIndex,1),void $scope.saveIVROptions())},$scope.addSubPrompt=function(e,array,saveIndicatorSelector,label){array.push(angular.copy(_emptyPrompt)),$scope.saveIVROptions()},$scope.showSaveCancel=function(flag){$scope.hasUnsavedConnections=!0,"add"==flag&&$timeout(function(){var elmnt=document.getElementById("grammarSave");elmnt.scrollIntoView({behavior:"smooth",block:"center"}),document.querySelector('textarea[name="grammarPattern'+($scope.nodeInfo.nodeInfo.ivrOptions.grammars.length-1)+'"]').focus()},500)},$scope.saveIVRGrammarOptions=function(saveIndicatorSelector,label,msg,form){return form&&form.$invalid?(form_util.touch(angular.forEach(form,function(key,value){})),void NotificationService.notify(i18n.i18nString("valid_grammer"),"warning",2e3)):void(form&&form.$valid&&($scope.nodeInfo.nodeInfo.ivrOptions.grammars=_.map($scope.nodeInfo.nodeInfo.ivrOptions.grammars,function(o){return"twiliovoice"==o.channel||"audiocodes"==o.channel?{channel:o.channel,value:o.value}:o}),$scope.saveIVROptions(),$scope.cancelUnsavedGrammar("postSave")))},$scope.selectVXMLProp=function(prop){var _selectedGlobalProp;if(prop&&prop.name){var _globalProps=$scope.nodeInfo.nodeInfo.ivrOptions.advance.properties;_globalProps&&_globalProps.length&&(_selectedGlobalProp=_.find(_globalProps,{name:prop.name}),void 0!==_selectedGlobalProp&&$scope.nodeInfo.nodeInfo.ivrOptions.advance.properties.push(_selectedGlobalProp))}$scope.vxmlProp=angular.copy(_emptyIVRProp)},$scope.cancelUnsavedGrammar=function(flag){$scope.hasUnsavedConnections=!1,$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&($scope.originalIvrGrammerCopy||($scope.originalIvrGrammerCopy=[]),$scope.nodeInfo.nodeInfo.ivrOptions.grammars=angular.copy($scope.originalIvrGrammerCopy),"postSave"!=flag&&$("#eventManageSlider .selectAppModal .modalBody").scrollTop(0))},$scope.addGrammar=function(){var grammar={};_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable_transcript?(grammar=angular.copy(_defaultGrammar),grammar.type="disable"):$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&(grammar=angular.copy(_defaultGrammar),grammar.type="custom"),$scope.nodeInfo.nodeInfo.ivrOptions.grammars.push(grammar),$scope.showSaveCancel("add")},$scope.addNodeVxmlProp=function(){$("#vxml-add").modal("show"),isFromTelephonyEvent=!0,$scope.vprop={name:"",value:""}},$scope.initializeData=function(){$scope.sdkConf={appName:"",noSDKConf:!0,clientID:"",clientSecret:"",cbUrl:"",eventSelector:[],showModalFullSection:!0,appMode:"edit",showCallbackProtip:!1,algorithm:""},$scope.sdkConf.events=[{name:i18n.i18nString("on_message"),id:"onMessage"},{name:i18n.i18nString("on_hooknode"),id:"onHook"},{name:i18n.i18nString("on_event"),id:"onEvent"},{name:i18n.i18nString("on_alert"),id:"onAlert"},{name:i18n.i18nString("on_variable"),id:"onVariableUpdate"}],$scope.noneSelected=!1,$scope.sdkConfOnModal={appName:"",createAppSuccess:!1,eventSelector:[],clientID:"",cbUrl:""},$scope.streamId=$workflowService.selectedStream()._id,$scope.botName=$workflowService.selectedStream().name},$scope.icons={spark:env_conf["context-url"]+"/img/spark.svg",msteams:env_conf["context-url"]+"/img/microsoft-teams-icon.png",syniverse:env_conf["context-url"]+"/img/syniverse.png",rcengage:env_conf["context-url"]+"/img/ringCentralEngage.png",slack:env_conf["context-url"]+"/img/slack.svg",sms:env_conf["context-url"]+"/img/sms.svg",twilio:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",email:env_conf["context-url"]+"/img/email.svg",skype:"",facebook:env_conf["context-url"]+"/img/facebook.svg",websdk:env_conf["context-url"]+"/img/slack.svg",kore:env_conf["context-url"]+"/img/kore.svg",rtm:env_conf["context-url"]+"/img/web-mobile.svg",widgetsdk:env_conf["context-url"]+"/img/widgetsdk.svg",twitter:env_conf["context-url"]+"/img/twitter.svg",skypeOnPrem:env_conf["context-url"]+"/img/skypebusiness.svg",cisco:env_conf["context-url"]+"/img/cisco-tropo-icon.png",wfacebook:env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Groups":env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Chat":env_conf["context-url"]+"/img/fb-workplace-icon.png",ringcentral:env_conf["context-url"]+"/img/ringCentralIcon.png",skypeforbusiness:env_conf["context-url"]+"/img/skypebusiness.svg",jabber:env_conf["context-url"]+"/img/jabbericon.jpg",yammer:env_conf["context-url"]+"/img/yammericon.png",telegram:env_conf["context-url"]+"/img/telegram-logo.png",alexa:env_conf["context-url"]+"/img/amazonalexa.png",twiliovoice:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",line:env_conf["context-url"]+"/img/line-logo.png",ivr:env_conf["context-url"]+"/img/webhook.png",liveperson:env_conf["context-url"]+"/img/live-person.png",ivrVoice:env_conf["context-url"]+"/assets/ivrIcons/ivrIcon.svg",wechat:env_conf["context-url"]+"/img/weChat.svg"},$scope.welcomeIVRTemp={},$scope.ivrBridge={},$scope.editIVR=!1,$scope.isIvrEnabled=!1,$scope.openedKey="";var vxmlflag=!1,propertiesList=[],isVxml=!1,_defaultGrammar={inputMode:"speech",type:"custom",value:""};$scope.addProperty=function(vprop){isFromTelephonyEvent?($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties.push(vprop),$scope.vxmlGlobalKeys=_.pluck($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties||[],"name"),$scope.vxmlGlobalKeys=$scope.vxmlGlobalKeys.filter(function(val,ind){return $scope.vxmlGlobalKeys.lastIndexOf(val)==ind?!0:void 0}),$("#vxml-add").modal("hide"),isFromTelephonyEvent=!1,$scope.saveIVROptions()):(propertiesList.push(vprop),$scope.ivrBridge.ivrOptions=$scope.ivrBridge.getIVROptions(),$scope.ivrBridge.ivrOptions.advance.properties.push(vprop),isVxml=!0,$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""},$scope.saveIVRSettings(vprop,"vxmlAdded"))},$scope.closeNodeVxmlProp=function(){$("#vxml-add").modal("hide"),isFromTelephonyEvent=!1,$scope.vprop={name:"",value:""}},$scope.welcomeMessagecbs.call=function(label){$scope.saveIVRSettings(vxmlflag,label)},$scope.cb.call=function(label){$scope.saveIVRSettings(vxmlflag,label)},$scope.editIVRSettings=function(){$scope.stream=$workflowService.selectedStream(),$scope.ivrOptions=angular.copy($scope.welcomeIVRTemp.welcomeIvrOptions),$scope.ivrOptions&&$scope.ivrOptions.grammars&&0===$scope.ivrOptions.grammars.length&&$scope.ivrOptions.grammars.push(_defaultGrammar),$scope.editIVR=!0,$scope.isIvrEnabled=!0},$scope.closeIVRSettings=function(label){if(isVxml&&"notVxml"!==label){for(var tempProps=angular.copy($scope.ivrBridge.ivrOptions.advance.properties),i=0;i<tempProps.length;i++)for(var j=0;j<propertiesList.length;j++)propertiesList[j].name===tempProps[i].name&&propertiesList[j].value===tempProps[i].value&&(tempProps[i]={});tempProps=tempProps.filter(function(v){return v==={}}),$scope.ivrBridge.ivrOptions.advance.properties=tempProps;var tempNames=tempProps.map(function(v,i){return v.name});$scope.cb.updateVxmlCancel(tempNames)}$scope.editIVR=!1,$timeout(function(){$scope.eventConfig.proceed="show_mess"},100),$scope.isIvrEnabled=!1},$scope.saveEnaDis=function(radioSel){"initiate_task"===radioSel?"universalbot"===$scope.stream.type?$scope.isSaveDisabled=void 0===$scope.currentTask.name||$scope.currentTask._id===$scope.eventConfigUB.linkedTask:$scope.isSaveDisabled=void 0===$scope.selected.dialog||""===$scope.selected.dialog||$scope.globSelDialog===$scope.selected.dialog:"run_script"===radioSel?$scope.isSaveDisabled=""===$scope.inp.scriptText||$scope.globScriptText===$scope.inp.scriptText:"show_mess"===radioSel&&($scope.isSaveDisabled=$scope.responseObj.length<1||!$scope.isAddRespEdited),"show_standard"===radioSel&&($scope.isSaveDisabled=!1)},$scope.selectValChange=function(e){"universalbot"!==$scope.stream.type&&$scope.selected&&$scope.selected.dialog?$scope.isSaveDisabled=!1:"universalbot"===$scope.stream.type&&($scope.isSaveDisabled=!1)},$scope.changeSaveEnabled=function(){$scope.responseObj.length>0&&($scope.isSaveDisabled=!1)},$scope.changeSaveEnabledTask=function(){""!==$scope.selected.dialog&&($scope.isSaveDisabled=!1)},$scope.$watch("inp.scriptText",function(newScrpt,oldScrpt){$scope.isSaveDisabled=""===newScrpt||$scope.globScriptText===$scope.inp.scriptText}),$scope.deleteMessage=function(response,index){function delMessage(){$scope.isAddRespEdited=!0;for(var i=0;i<$scope.responseObj.length;i++)if(""!==$scope.responseObj[i]._id&&$scope.responseObj[i]._id===response._id&&$scope.responseObj[i].channel===response.channel||$scope.responseObj[i].text===response.text&&$scope.responseObj[i].channel===response.channel){$scope.responseObj.splice(i,1);break}$scope.responseObj.length>0&&("Task Execution Failure"===$scope.globOpenedSlider||"Welcome Event"===$scope.globOpenedSlider)&&$scope.isIVREntered?$scope.isSaveDisabled=!1:$scope.responseObj.length>0&&($scope.isSaveDisabled=!1),0===$scope.responseObj.length&&"Task Execution Failure"!==$scope.globOpenedSlider&&"Welcome Event"!==$scope.globOpenedSlider&&$scope.isIVREntered&&($scope.isSaveDisabled=!0)}var numOfAllChannels=$scope.responseObj.filter(function(v){return"default"===v.channel}).length;$scope.globIsChannelSpecific||"default"!==response.channel||1!==numOfAllChannels?delMessage():NotificationService.confirm({msg:i18n.i18nString("channel_mandatory"),successCb:function(){delMessage()},isModal:!0,btnTexts:{success:i18n.i18nString("yes"),fail:i18n.i18nString("no")}})},$scope.redirectToLink=function(link,e){e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()),$rootScope.redirectToLink(link,e)},$scope.welcomeMessagecbs.changeToShowMessage=function(){$scope.eventConfig.proceed="show_mess"},$scope.taskFailClose=function(){$("#task-fail-confirm").removeClass("show").addClass("fade")},$scope.preSaveButton=function(){if("ivr_settings"===$scope.eventConfig.proceed){if(0===$scope.nodeInfo.nodeInfo.ivrOptions.initialPrompts.length)return NotificationService.notify(i18n.i18nString("initial_prompts_error"),"error"),void $("#eventManageSlider .selectAppModal .modalBody").scrollTop(0);if($scope.hasUnsavedConnections){var elmnt=document.getElementById("grammarSave");return elmnt.scrollIntoView({behavior:"smooth"}),void NotificationService.notify(i18n.i18nString("update_grammar_details"),"error")}return void $scope.eventSaveButton()}var flagAllChannel=!1;for(var key in $scope.eventsData)if($scope.eventsData[key].name===$scope.globOpenedSlider){$scope.openedKey=key;break}if($workflowService.seedData().botEvents[$scope.openedKey].channelSpecific)flagAllChannel=!0;else for(var j=0;j<$scope.responseObj.length;j++)if("default"===$scope.responseObj[j].channel){flagAllChannel=!0;break}"TASK_FAILURE_EVENT"!==$scope.openedKey||flagAllChannel||"show_mess"!==$scope.eventConfig.proceed?"TASK_FAILURE_EVENT"===$scope.openedKey?$("#task-fail-confirm").removeClass("fade").addClass("show"):$scope.eventSaveButton():NotificationService.notify(i18n.i18nString("chnl_msg_mandatory"),"error")},$scope.eventSaveButton=function(){if("Telephony Welcome Event"===$scope.globOpenedSlider&&"ivr_settings"===$scope.eventConfig.proceed){if(0===$scope.nodeInfo.nodeInfo.ivrOptions.initialPrompts.length)return NotificationService.notify(i18n.i18nString("initial_prompts_error"),"error"),void $("#eventManageSlider .selectAppModal .modalBody").scrollTop(0);if($scope.hasUnsavedConnections){var elmnt=document.getElementById("grammarSave");return elmnt.scrollIntoView({behavior:"smooth"}),void NotificationService.notify(i18n.i18nString("update_grammar_details"),"error")}}$scope.callback.updateEventList($scope.globOpenedSlider);var payload={botEvent:{}},flagAllChannel=!1;for(var key in $scope.eventsData)if($scope.eventsData[key].name===$scope.globOpenedSlider){$scope.openedKey=key;break}if("TASK_FAILURE_EVENT"===$scope.openedKey&&$("#task-fail-confirm").removeClass("show").addClass("fade"),"show_standard"!==$scope.eventConfig.proceed&&(payload.botEvent[$scope.openedKey]={},payload.botEvent[$scope.openedKey].enabled=!0),"INTENT_UNIDENTIFIED_EVENT"!==$scope.eventCategory&&"universalbot"!==$scope.stream.type&&(payload.botEvent[$scope.openedKey].manageFirstMessage={}),"initiate_task"===$scope.eventConfig.proceed)if(payload.botEvent[$scope.openedKey].action="triggerDialog",flagAllChannel=!0,payload.botEvent[$scope.openedKey].manageFirstMessage={},"WELCOME_EVENT"===$scope.eventCategory&&(payload.botEvent[$scope.openedKey].manageFirstMessage={greetings:"greetings_0"===$scope.greetings.sel?"respondToUserInput":"triggerWelcomeDialog",faq:"faq_0"===$scope.faq.sel?"respondToUserInput":"triggerWelcomeDialog",task:"task_0"===$scope.task.sel?"respondToUserInput":"triggerWelcomeDialog"}),payload.botEvent[$scope.openedKey].script=".",payload.botEvent[$scope.openedKey].welcomeIvrOptions=[],"INTENT_UNIDENTIFIED_EVENT"===$scope.eventCategory&&(payload.botEvent[$scope.openedKey].linkedBotStreamId=""),payload.botEvent[$scope.openedKey].msg=[],$scope.welcomeIVRTemp={},payload.botEvent[$scope.openedKey].linkedBotStreamId=null,"universalbot"===$scope.stream.type)_.forEach($scope.totalLinkedBots,function(linkedBot){linkedBot._id===$scope.eventConfigUB.linkedBotId&&(payload.botEvent[$scope.openedKey].linkedBotStreamId=$scope.eventConfigUB.linkedBotId)}),payload.botEvent[$scope.openedKey].task=$scope.eventConfigUB.linkedTask;else{for(var dialogId="",i=0;i<$scope.dialogsName.length;i++)if($scope.dialogsName[i].name===$scope.selected.dialog){dialogId=$scope.dialogsName[i].id;break}payload.botEvent[$scope.openedKey].task=dialogId}else if("run_script"===$scope.eventConfig.proceed)payload.botEvent[$scope.openedKey].action="runScript",flagAllChannel=!0,payload.botEvent[$scope.openedKey].script=encodeJS($scope.inp.scriptText),payload.botEvent[$scope.openedKey].welcomeMsg=[],payload.botEvent[$scope.openedKey].welcomeIvrOptions=[],$scope.welcomeIVRTemp={},payload.botEvent[$scope.openedKey].task="";else if("show_mess"===$scope.eventConfig.proceed){if(payload.botEvent[$scope.openedKey].action="showMsg",payload.botEvent[$scope.openedKey].script=".",payload.botEvent[$scope.openedKey].msg=$scope.responseObj,
"WELCOME_EVENT"===$scope.eventCategory&&(payload.botEvent[$scope.openedKey].manageFirstMessage={greetings:"sMgreetings_0"===$scope.sMgreetings.sel?"displayWelcomeMsg":"discardWelcomeMsg",faq:"sMfaq_0"===$scope.sMfaq.sel?"displayWelcomeMsg":"discardWelcomeMsg",task:"sMtask_0"===$scope.sMtask.sel?"displayWelcomeMsg":"discardWelcomeMsg"}),$workflowService.seedData().botEvents[$scope.openedKey].channelSpecific)flagAllChannel=!0;else for(var j=0;j<$scope.responseObj.length;j++)if("default"===$scope.responseObj[j].channel){flagAllChannel=!0;break}if("WELCOME_EVENT"===$scope.eventCategory&&$scope.stream.ivrSettings&&$scope.stream.ivrSettings.enable&&$scope.ivrBridge.getIVROptions&&$scope.ivrBridge.getIVROptions()&&$scope.isIVREntered){payload.botEvent[$scope.openedKey].welcomeIvrOptions=$scope.ivrBridge.getIVROptions();var ivrPayload=payload.botEvent[$scope.openedKey].welcomeIvrOptions;ivrPayload&&ivrPayload.grammars&&angular.forEach(ivrPayload.grammars,function(element,index){""===element.value&&"disable"!==element.type&&ivrPayload.grammars.splice(index,1)})}else $scope.welcomeIVRTemp&&$scope.welcomeIVRTemp.welcomeIvrOptions?payload.botEvent[$scope.openedKey].welcomeIvrOptions=$scope.welcomeIVRTemp.welcomeIvrOptions:payload.botEvent[$scope.openedKey].welcomeIvrOptions=[]}else"ivr_settings"===$scope.eventConfig.proceed?(payload.botEvent.TELEPHONY_WELCOME_EVENT.welcomeIvrOptions=$scope.nodeInfo.nodeInfo.ivrOptions,payload.botEvent.TELEPHONY_WELCOME_EVENT.action="voiceProp",payload.botEvent.TELEPHONY_WELCOME_EVENT.script="."):"show_standard"===$scope.eventConfig.proceed&&(payload.botEvent.INTENT_UNIDENTIFIED||(payload.botEvent.INTENT_UNIDENTIFIED={}),flagAllChannel=!0,payload.botEvent.INTENT_UNIDENTIFIED.action="showMsg",payload.botEvent.INTENT_UNIDENTIFIED.enabled=!0,payload.botEvent.INTENT_UNIDENTIFIED.manageFirstMessage={},payload.botEvent.INTENT_UNIDENTIFIED.msg=["Intent Not Found"],payload.botEvent.INTENT_UNIDENTIFIED.script=".",payload.botEvent.INTENT_UNIDENTIFIED.welcomeIvrOptions=[]);flagAllChannel||"ivr_settings"===$scope.eventConfig.proceed?(BTStreamsService.newEvent($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload).then(function(res){"fromEdit"===$scope.openSliderCallFrom?NotificationService.notify($scope.globOpenedSlider+i18n.i18nString("success_updated"),"success"):"fromConfigured"===$scope.openSliderCallFrom?NotificationService.notify($scope.globOpenedSlider+i18n.i18nString("success_saved"),"success"):NotificationService.notify($scope.globOpenedSlider+i18n.i18nString("success_saved"),"success"),$scope.eventManageClose(),res.data.botEvents&&res.data.botEvents.TASK_FAILURE_EVENT&&($workflowService.selectedStream().botEvents.TASK_FAILURE_EVENT=angular.copy(res.data.botEvents.TASK_FAILURE_EVENT)),res.data.botEvents&&res.data.botEvents.INTENT_UNIDENTIFIED&&($workflowService.selectedStream().botEvents.INTENT_UNIDENTIFIED=angular.copy(res.data.botEvents.INTENT_UNIDENTIFIED))},function(err){NotificationService.notify(err.data.errors[0].msg),$scope.eventManageClose()}),$scope.callback.toggleTrue(),$scope.isSaveDisabled=!0):NotificationService.notify(i18n.i18nString("chnl_msg_mandatory"),"error")},$scope.prepareDialogData=function(){$scope.dialogsName=[];var ind=0;$workflowService.dialogTasks().forEach(function(val){val.isFollowUp||($scope.dialogsName[ind]={},$scope.dialogsName[ind].name=val.name,$scope.dialogsName[ind].id=val.refId,ind++)})},$scope.saveIVRSettings=function(vprop,label){if($scope.isSaveDisabled=!1,"Welcome Event"==$scope.globOpenedSlider||"Task Execution Failure"==$scope.globOpenedSlider){if($scope.stream=$workflowService.selectedStream(),"vxmlAdded"!==label&&"deleted"!==label&&"saved"!==label){var payload={welcomeIvrOptions:$scope.ivrBridge.getIVROptions()};$scope.welcomeIVRTemp=angular.copy(payload),$scope.closeIVRSettings("notVxml")}if($timeout(function(){$scope.eventConfig.proceed="show_mess"},100),0!==$scope.responseObj.length&&($scope.isSaveDisabled=!1),$scope.isIVREntered=!0,vprop&&vprop.name)if($scope.ivrBridge.getIVROptions().advance.properties.length){var vpropName=$scope.ivrBridge.getIVROptions().advance.properties.map(function(v){return v.name});vpropName.push(vprop.name),$scope.cb.updateVxmlGlobalKeysShare(vpropName)}else $scope.cb.updateVxmlGlobalKeysShare(vprop.name);NotificationService.notify(i18n.i18nString("ivr_settings_save"),"success"),$scope.isSaveDisabled=!1}},$scope.welcomeMessagecbs.openEventSliderCb=function(){$timeout(function(){$scope.openModalSlider("#eventManageSlider")},500),"universalbot"!==$scope.stream.type&&$scope.prepareDialogData()},$scope.editResponse=function(index){var isChannelSpec,channelId;$scope.welcomeMessagecbs.isAddResponseEnabled=!0;for(var key in $scope.eventsData)if($scope.eventsData[key].name===$scope.globOpenedSlider){isChannelSpec=$scope.eventsData[key].channelSpecific,channelId=$scope.eventsData[key].channel;break}$timeout(function(){try{$scope.welcomeMessagecbs.loadMessage($scope.responseObj,index,isChannelSpec,channelId)}catch(error){console.log(error)}},350),$(".welcomeMessageModal").modal("show")},$scope.welcomeMessagecbs.updateWelcomeMessages=function(res){$scope.welcomeMessages=res},$scope.welcomeMessagecbs.getObjResponse=function(obj,isEdit){if($scope.isSaveDisabled=!1,$scope.isAddRespEdited=!0,isEdit){for(var i=0;i<$scope.responseObj.length;i++)if($scope.responseObj[i]._id===obj._id){$scope.responseObj.splice(i,1,obj);break}}else $scope.responseObj.push(obj)},$scope.welcomeMessagecbs.getObjResponseEdit=function(obj){$scope.isAddRespEdited=!0,$scope.isSaveDisabled=!1,$scope.responseObj=[],$scope.responseObj=angular.copy(obj)},$scope.decodeJS=function(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}};var getLinkedBots=function(){$scope.publishedBots=$scope.stream.publishedBots.filter(function(bot){return _.filter($scope.stream.unpublishedBots.concat($scope.stream.awaitingApprovalBots),{_id:bot._id}).length?void 0:bot}),"indevelopment"===$scope.streamState?$scope.totalLinkedBots=$scope.stream.configuredBots.concat($scope.publishedBots,$scope.stream.awaitingApprovalBots):"published"===$scope.streamState&&($scope.totalLinkedBots=$scope.stream.publishedBots)};$scope.manageResponseCB={},$scope.advancedDisplayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope._constants_=$rootScope._constants_,$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation(),setTimeout(function(){$scope.manageResponseCB.title="Confirmation Dialog for component",$scope.manageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key];var _btnValue="close";$scope.manageResponseCB.openManageResponse(_btnValue),$scope.manageResponseCB.initMessages($scope.advancedDisplayMode)},500)},$scope.callback.openEventSlider=function(name,callFrom){function isEmpty(obj){for(var key in obj)if(obj.hasOwnProperty(key))return!1;return!0}$scope.welcomeIVRTemp={},$scope.openSliderCallFrom=callFrom,$scope.isStreamLoading=!0,$scope.isIVREntered=!1,$scope.callback.updateToggleEventName(name),$scope.isRCS="RCS Opt-In Event"===name||"RCS Opt-Out Event"===name,$scope.isIntentEvents="Intent not Identified"===name||"Ambiguous Intents Identified"===name,$scope.isIntentEvents&&($scope.openSliderCallFrom="fromEdit");var botEventClickedKey="";$scope.eventNameDisp=name,$scope.selected.dialog="",$scope.isIntentEvents?$scope.isSaveDisabled=!1:$scope.isSaveDisabled=!0,$scope.inp.scriptText="",-1!==supportedEventsUB.indexOf(name)&&"universalbot"===$scope.stream.type&&getLinkedBots(),"Telephony Welcome Event"==name?($scope.nodeInfo={nodeInfo:{ivrOptions:{initialPrompts:[],nomatchPrompts:[],timeoutPrompts:[],errorPrompts:[],grammars:[],advance:{timeout:1e4,retry_limit:3,bargein:!1}}}},$scope.isTwilioVoiceWelcome=!0):$scope.isTwilioVoiceWelcome=!1;for(var k=0;k<$workflowService.selectedStream().channels.length;k++)if("ivrVoice"==$workflowService.selectedStream().channels[k].type&&$workflowService.selectedStream().channels[k].enable||"twiliovoice"==$workflowService.selectedStream().channels[k].type&&$workflowService.selectedStream().channels[k].enable){$scope.isIvrTwilioEnabled=!0;break}$scope.prepareDialogData();for(var key in $scope.eventsData)if($scope.eventsData[key].name===name){botEventClickedKey=key,$scope.globIsChannelSpecific=$scope.eventsData[key].channelSpecific;break}$scope.globOpenedSlider=name,$scope.eventCategory=$workflowService.seedData().botEvents[botEventClickedKey].category,$scope.isRCS?$scope.eventConfig={proceed:"show_mess"}:"universalbot"!==$scope.stream.type&&"TASK_FAILURE_EVENT"!==$scope.eventCategory&&"INTENT_UNIDENTIFIED_EVENT"!==$scope.eventCategory?$scope.eventConfig={proceed:"initiate_task"}:"INTENT_UNIDENTIFIED_EVENT"===$scope.eventCategory&&"universalbot"!==$scope.stream.type?$scope.eventConfig={proceed:"show_standard"}:"INTENT_UNIDENTIFIED_EVENT"===$scope.eventCategory&&"universalbot"===$scope.stream.type?$scope.eventConfig={proceed:"initiate_task"}:$scope.eventConfig={proceed:"run_script"},BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){if(res.data.botEvents&&res.data.botEvents[botEventClickedKey])if(res.data.botEvents[botEventClickedKey].action){var selectedLinkedBot=[];if("WELCOME_MESSAGE_EVENT"==botEventClickedKey){$scope.isWelcome=!0;res.data.botEvents[botEventClickedKey].welcomeIvrOptions}if("triggerDialog"===res.data.botEvents[botEventClickedKey].action){if("universalbot"!==$scope.stream.type||"TASK_FAILURE_EVENT"!==$scope.eventCategory?($scope.eventConfig.proceed="initiate_task",$scope.isSaveDisabled=!0):$scope.eventConfig.proceed="run_script","universalbot"===$scope.stream.type&&$scope.totalLinkedBots&&$scope.totalLinkedBots.length&&(selectedLinkedBot=_.filter($scope.totalLinkedBots,{_id:res.data.botEvents[botEventClickedKey].linkedBotStreamId}),selectedLinkedBot.length&&($scope.eventConfigUB.linkedBotId=selectedLinkedBot[0]?selectedLinkedBot[0]._id:"",$scope.selectedLinkedBot=selectedLinkedBot[0],$scope.getLinkedBotTasks($scope.selectedLinkedBot,res.data.botEvents[botEventClickedKey].task))),0!==$scope.dialogsName.length){var selectedDialog=$scope.dialogsName.filter(function(v,i){return v.id==res.data.botEvents[botEventClickedKey].task});$scope.selected.dialog=selectedDialog[0]?selectedDialog[0].name:"","universalbot"!==$scope.stream.type||selectedLinkedBot.length||($scope.eventConfigUB.linkedTask=res.data.botEvents[botEventClickedKey].task,$scope.eventConfigUB.linkedBotId=res.data.botEvents[botEventClickedKey]["linkedBotStreamId;"],$scope.currentTask=selectedDialog[0],$scope.selectedLinkedBot=angular.copy($scope.stream))}else $scope.selected.dialog="";$scope.globSelDialog=$scope.selected.dialog,$scope.responseObj=[],$scope.sMgreetings.sel="sMgreetings_0",$scope.sMfaq.sel="sMfaq_0",$scope.sMtask.sel="sMtask_0",res.data.botEvents[botEventClickedKey].manageFirstMessage&&($scope.greetings.sel=res.data.botEvents[botEventClickedKey].manageFirstMessage&&"respondToUserInput"===res.data.botEvents[botEventClickedKey].manageFirstMessage.greetings?"greetings_0":"greetings_1",$scope.faq.sel=res.data.botEvents[botEventClickedKey].manageFirstMessage&&"respondToUserInput"===res.data.botEvents[botEventClickedKey].manageFirstMessage.faq?"faq_0":"faq_1",$scope.task.sel=res.data.botEvents[botEventClickedKey].manageFirstMessage&&"respondToUserInput"===res.data.botEvents[botEventClickedKey].manageFirstMessage.task?"task_0":"task_1")}else"runScript"===res.data.botEvents[botEventClickedKey].action?($scope.eventConfig.proceed="run_script",$scope.responseObj=[],$scope.selected.dialog="",$scope.inp.scriptText=$scope.decodeJS(res.data.botEvents[botEventClickedKey].script),$scope.globScriptText=$scope.decodeJS(res.data.botEvents[botEventClickedKey].script)):"showMsg"===res.data.botEvents[botEventClickedKey].action?("INTENT_UNIDENTIFIED_EVENT"===$scope.eventCategory?$scope.eventConfig.proceed="show_standard":$scope.eventConfig.proceed="show_mess",$scope.responseObj=[],$scope.greetings.sel="greetings_0",$scope.faq.sel="faq_0",$scope.task.sel="task_0",$scope.responseObj=angular.copy(res.data.botEvents[botEventClickedKey].msg),res.data.botEvents[botEventClickedKey].manageFirstMessage&&($scope.sMgreetings.sel="displayWelcomeMsg"===res.data.botEvents[botEventClickedKey].manageFirstMessage.greetings?"sMgreetings_0":"sMgreetings_1",$scope.sMfaq.sel="displayWelcomeMsg"===res.data.botEvents[botEventClickedKey].manageFirstMessage.faq?"sMfaq_0":"sMfaq_1",$scope.sMtask.sel="displayWelcomeMsg"===res.data.botEvents[botEventClickedKey].manageFirstMessage.task?"sMtask_0":"sMtask_1"),isEmpty(res.data.botEvents[botEventClickedKey].welcomeIvrOptions)||($scope.welcomeIVRTemp.welcomeIvrOptions=angular.copy(res.data.botEvents[botEventClickedKey].welcomeIvrOptions))):"voiceProp"===res.data.botEvents[botEventClickedKey].action&&($scope.eventConfig.proceed="ivr_settings",$scope.nodeInfo.nodeInfo.ivrOptions=res.data.botEvents[botEventClickedKey].welcomeIvrOptions,$scope.originalIvrGrammerCopy=angular.copy($scope.nodeInfo.nodeInfo.ivrOptions.grammars),$scope.vxmlGlobalKeys=_.pluck($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties||[],"name"))}else $scope.isRCS?$scope.eventConfig={proceed:"show_mess"}:"universalbot"!==$scope.stream.type&&"TASK_FAILURE_EVENT"!==$scope.eventCategory&&"INTENT_UNIDENTIFIED_EVENT"!==$scope.eventCategory?$scope.eventConfig.proceed="initiate_task":"INTENT_UNIDENTIFIED_EVENT"===$scope.eventCategory?$scope.eventConfig={proceed:"show_standard"}:$scope.eventConfig.proceed="run_script";else $scope.isRCS?$scope.eventConfig={proceed:"show_mess"}:"universalbot"!==$scope.stream.type&&"TASK_FAILURE_EVENT"!==$scope.eventCategory&&"INTENT_UNIDENTIFIED_EVENT"!==$scope.eventCategory?$scope.eventConfig.proceed="initiate_task":"INTENT_UNIDENTIFIED_EVENT"===$scope.eventCategory&&"universalbot"!==$scope.stream.type?$scope.eventConfig={proceed:"show_standard"}:"INTENT_UNIDENTIFIED_EVENT"===$scope.eventCategory&&"universalbot"===$scope.stream.type?$scope.eventConfig={proceed:"initiate_task"}:$scope.eventConfig.proceed="run_script";$scope.isStreamLoading=!1},function(err){$scope.isStreamLoading=!1,console.log(err)}),$scope.openModalSlider("#eventManageSlider")},$scope.$watch("isSaveDisabled",function(ov,nv){console.log(ov,nv)}),$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},$scope.getLinkedBotTasks=function(linkedBot,selectedTaskId){$scope.selectedLinkedBot=linkedBot,$scope.eventConfigUB.linkedBotId=linkedBot._id,$scope.currentTask={},BTFlowtaskService.getFlowtaks(linkedBot._id,null,$workflowService.selectedStream()._id).then(function(res){if(res.data=res.data.map(function(task){return task.state&&(task.status=task.state.toLowerCase()),"published"!==task.status&&!task.hide&&isBotPublished()&&(task.taskstate="@development"),task}),$scope.tasks=[],$scope.tasks=$scope.tasks.concat(res.data),$scope.findParenttasks($scope.tasks),$scope.tasks=$scope.tasks.filter(function(task){return filterFn(task)}),selectedTaskId){var selectedLinkedTask=_.find($scope.tasks,{refId:selectedTaskId});selectedLinkedTask&&($scope.eventConfigUB.linkedTask=selectedLinkedTask._id,$scope.currentTask=selectedLinkedTask)}})},$scope.selectTask=function(task,linkedBot){$scope.currentTask=task,"universalbot"===linkedBot.type?$scope.eventConfigUB.linkedTask=task.id:$scope.eventConfigUB.linkedTask=task.refId},$scope.getTasksUb=function(ubBot){$scope.selectedLinkedBot=ubBot,$scope.currentTask={},$scope.eventConfigUB.linkedBotId=ubBot._id,$scope.prepareDialogData()},$scope.checkForSaveRDelete=function(item,baseIndex,index,array,saveIndicatorSelector,noEmptyDelete){return $scope.readonly?!1:(noEmptyDelete||!item||item.value||(array[baseIndex].splice(index,1),0===array[baseIndex].length&&array.splice(baseIndex,1)),void($scope.isSaveDisabled=!1))},$scope.resetSDKConfOnModal=function(){$scope.sdkConfOnModal={appName:"",createAppSuccess:!1,eventSelector:[],clientID:"",cbUrl:""}},$scope._constants_=$rootScope._constants_,$scope.isSafari=!1,$timeout(function(){var clipboard=new Clipboard("[data-clipboard-target]");clipboard.on("success",function(e){}),clipboard.on("error",function(e){$scope.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$scope.hidePassword=!0,$scope.showOrHideCSKey=function($event,index){if("edit"===$scope.sdkConf.appMode){var $csID1=$("#CLIENT_SECRET"+$scope.callFrom);if("manageApps"===$scope.callFrom||"apps"===$scope.callFrom)$csID1=$("#CLIENT_SECRETSlider"+$scope.callFrom+"API"),$scope.hidePassword="text"===$csID1.attr("type")?!1:!0;else{var $ele1=$($event.currentTarget);"View"===$ele1.text()?$ele1.text("Hide"):$ele1.text("View")}"text"===$csID1.attr("type")?$csID1.attr("type","password"):$csID1.attr("type","text")}else{var $csID=$("#CLIENT_SECRET"+$scope.callFrom);("manageApps"===$scope.callFrom||"apps"===$scope.callFrom)&&($csID=$("#CLIENT_SECRETSlider"+$scope.callFrom+index));var $ele=$($event.currentTarget);"text"===$csID.attr("type")?$csID.attr("type","password"):$csID.attr("type","text");$scope.hidePassword="text"===$csID.attr("type")?!1:!0;"View"===$ele.text()?$ele.text("Hide"):$ele.text("View")}},$scope.showOrHideCSKeyManageApps=function($event,index){if("manageApps"===$scope.callFrom||"apps"===$scope.callFrom){var $csID1=$("#CLIENT_SECRETSlider"+$scope.callFrom+"APPS"+index);$($event.currentTarget),"text"===$csID1.attr("type")?$csID1.attr("type","password"):$csID1.attr("type","text");$scope.hidePassword="text"===$csID1.attr("type")?!1:!0}},$scope.showOrHideCSKeyApps=function($event,index){if("manageApps"===$scope.callFrom||"apps"===$scope.callFrom){var $csID=$("#CLIENT_SECRETSlider"+$scope.callFrom+"API");$($event.currentTarget),"text"===$csID.attr("type")?$csID.attr("type","password"):$csID.attr("type","text");$scope.hidePassword="text"===$csID.attr("type")?!1:!0}},$scope.showOrHideCSKeyNewAppsDefinition=function($event){if("manageApps"===$scope.callFrom||"apps"===$scope.callFrom){var $csID1=$("#CLIENT_SECRETSlider"+$scope.callFrom+"Definition");$($event.currentTarget),"text"===$csID1.attr("type")?$csID1.attr("type","password"):$csID1.attr("type","text");$scope.hidePassword="text"===$csID1.attr("type")?!1:!0}},$scope.showOrHideCSKeyNewAppCreation=function($event){var $csID=$("#CLIENT_SECRET2"+$scope.callFrom);$($event.currentTarget),"text"===$csID.attr("type")?$csID.attr("type","password"):$csID.attr("type","text");$scope.hidePassword="text"===$csID.attr("type")?!1:!0},$scope.dropDownLength=function(){$.each($scope.apps,function(i,app){app.isVisible=!0,$.each(app.scope,function(j){app.scope[j].bot===$workflowService.selectedStream()._id&&(app.isVisible=!1)})})},$scope.checkBotState=function(){return $scope.streamState=$workflowService.selectedStreamState(),"published"==$scope.streamState?!0:!1},$scope.closeAppModal=function(loadApps){if($("#managingApps").find("#botModalSlider").hasClass("open")&&setTimeout(function(){$("body").addClass("bt-modal-open")},250),$scope.existingAppObj&&$scope.existingAppObj.sdkConf&&($scope.sdkConf=$scope.existingAppObj.sdkConf,$scope.existingAppObj={}),$scope.manageApps=angular.copy($scope.apps),$scope.manageApps)for(var i=0;i<$scope.manageApps.length;i++)$scope.manageApps[i]&&$scope.manageApps[i].appName&&($scope.manageApps[i].appName=$scope.manageApps[i].appName.replace(/&lt;/g,"<").replace(/&gt;/g,">"));$scope.sdkConf.appName=$scope.sdkConf.clientID,$scope.sdkConf.appMode="create",$scope.sdk.appCSForm.$setPristine(),$scope.closeModalSlider("#createNewApp"),$("body").removeClass("modal-open"),getApps(null,!0)},$scope.openAppModal=function(){$scope.openModalSlider("#createNewApp"),$(".selectAppModal").on("hidden.bs.modal",function(){$("body").removeClass("modal-open"),$scope.resetSDKConfOnModal()}),$scope.callback.appCreated=!1},$scope.activateNameSearch=function(show){show?($scope.showNameSearch=!0,$(".manageAppsSearchBlock").addClass("hide")):($(".manageAppsSearchBlock").removeClass("hide"),$scope.search.nameSearchQuery="",$scope.showNameSearch=!1),setTimeout(function(){$(".focusNameSearch").focus()},100)},$scope.selectEvents=function(){$scope.selectedEvents=$filter("filter")($scope.sdkConf.events,{checked:!0})},$scope.isOptionsRequired=function(){return!$scope.sdkConf.events.some(function(options){return options.checked})},$scope.$watch(function(ov,nv){$scope.selectEvents()}),$scope.processModal=function(){$scope.callback.appCreated?($scope.sdkConf.appMode="create",$scope.closeAppModal(!0)):$scope.callback.createApp()},$scope.enableJtiEnforce=function(app,type,index){var _params={},_urlParams={streamId:$workflowService.selectedStream()._id};_params={appName:app.appName,algorithm:app.algorithm,pushNotifications:app.pushNotifications,bots:app.bots},$scope.jweEnforce.jtiEnforced[index]?_params.isJtiEnforced=!0:_params.isJtiEnforced=!1,$scope.jweEnforce.jweEnforced[index]?_params.isJweEnforced=!0:_params.isJweEnforced=!1,_urlParams.appId=app.clientId,_urlParams.streamId=$scope.stream._id,$translator.translate("bt.apps.edit",_urlParams,_params).then(function(res){res&&res.data&&200===res.status&&($scope.saveInProgress=!1,NotificationService.notify("Updated successfully","success"))},function(err){$scope.saveInProgress=!1,err.data&&err.data.errors[0]&&err.data.errors[0].code?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})},$scope.callback.createApp=function(form){var _params={},_urlParams={streamId:$workflowService.selectedStream()._id};if(""!==$scope.sdkConfOnModal.appName){$scope.appName=$scope.sdkConfOnModal.appName,_params={appName:$scope.sdkConfOnModal.appName,scope:[],pushNotifications:{enable:!1,webhookUrl:""}},"webMobileSDK"!==$scope.callFrom?_params.algorithm="HS256":(_params.algorithm=$scope.sdkConf.label.id,"RS256"===_params.algorithm&&(_params.key=$scope.sdkConf.publicKey)),_params.bots=[$workflowService.selectedStream()._id],$scope.saveInProgress=!0;var svcname="bt.apps.create";$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.create"),$scope.jweEnforce.isJtiEnforced?_params.isJtiEnforced=!0:_params.isJtiEnforced=!1,$scope.jweEnforce.isJweEnforced?_params.isJweEnforced=!0:_params.isJweEnforced=!1,$translator.translate(svcname,_urlParams,_params).then(function(res){res&&res.data&&200===res.status?($scope.callback.appCreated=!0,$scope.saveInProgress=!1,$scope.sdkConfOnModal.createAppSuccess=!0,$scope.sdkConfOnModal.clientID=res.data.clientId,$scope.sdkConf.clientID=res.data.clientId,$scope.sdkConf.clientSecret=res.data.clientSecret,$scope.sdkConf.algorithm=res.data.algorithm,NotificationService.notify(i18n.i18nString("app_created"),"success"),$scope.sdkConf.showModalFullSection=!0,$scope.replaceAppDetails=!1,appnameToRetain=res.data.clientId,loadSelectedEvents($scope.sdkConf.eventSelector),$scope.callback.apps.push(res.data),$scope.apps=angular.copy($scope.callback.apps)):($scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("error_alert"),"error"))},function(errRes){$scope.saveInProgress=!1,errRes&&errRes.data&&errRes.data.errors.length?"AppAlreadyExists"===errRes.data.errors[0].code?NotificationService.notify(i18n.i18nString("App_Already_Exists"),"error"):NotificationService.notify(errRes.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})}},$scope.sdk={},$scope.callback.saveSuccess=!1,$scope.$watch("callback.saveSuccess",function(newVal,oldVal){$timeout(function(){$scope.callback.saveSuccess=!1},1e3)}),$scope.callback.formInvalid=!1,$scope.editApp=function(){$scope.sdkConf.appMode="edit",$scope.openAppModal()},$scope.callback.editApps=function(mode,app){$scope.curentAppInfo=app,$scope.openNewAppModal(),mode&&"edit"===mode&&($scope.sdkConf.appMode="edit"),$scope.sdkConfOnModal.appName=app.appName,$scope.appName=app.appName,$scope.sdkConf.clientID=app.clientId,$scope.sdkConf.clientSecret=app.clientSecret,$scope.sdk.botId=$scope.stream._id},$scope.resetClientId=function(app){NotificationService.alert(i18n.i18nString("req_api_sdk"),function(){var svcname="bt.apps.regenerate.key";$applicationService.userInfo().appControls&&(svcname="bt.org.apps.regenerate.key"),$scope.secretKeyInProgress=!0,$scope.sdkConf.appMode="edit",$translator.translate(svcname,{appId:$scope.sdkConf.clientID,streamId:$workflowService.selectedStream()._id},{}).then(function(res){res&&res.data&&200===res.status?($scope.sdkConf.clientSecret=res.data.clientSecret,$scope.appName=res.data.appName,NotificationService.notify(i18n.i18nString("client_secret_reset"),"success"),$rootScope.$emit("app.updated")):NotificationService.notify(i18n.i18nString("error_alert"),"error"),$scope.secretKeyInProgress=!1},function(errRes){$scope.secretKeyInProgress=!1,NotificationService.notify(i18n.i18nString("error_alert"),"error")})},{okText:i18n.i18nString("ok_uppercase")},"",void 0,i18n.i18nString("confirm"))},$scope.resetClientIdManageApps=function(app,index){NotificationService.alert(i18n.i18nString("req_api_sdk"),function(){var svcname="bt.apps.regenerate.key";$applicationService.userInfo().appControls&&(svcname="bt.org.apps.regenerate.key"),$scope.secretKeyInProgress=!0,$scope.sdkConf.appMode="edit","manageApps"===$scope.titleCheck&&($scope.sdkConf.clientID=app.clientId,$scope.sdkConf.appName=app.appName),$translator.translate(svcname,{appId:$scope.sdkConf.clientID,streamId:$workflowService.selectedStream()._id},{}).then(function(res){res&&res.data&&200===res.status?($scope.sdkConf.clientSecret=res.data.clientSecret,$scope.appName=res.data.appName,$scope.manageApps[index].clientSecret=res.data.clientSecret,NotificationService.notify(i18n.i18nString("client_secret_reset"),"success"),$rootScope.$emit("app.updated")):NotificationService.notify(i18n.i18nString("error_alert"),"error"),$scope.secretKeyInProgress=!1},function(errRes){$scope.secretKeyInProgress=!1,NotificationService.notify(i18n.i18nString("error_alert"),"error")})},{okText:i18n.i18nString("ok_uppercase")},"",void 0,i18n.i18nString("confirm"))},$scope.deleteAppName=function(index,app,e){e.stopPropagation(),NotificationService.alert(i18n.i18nString("delete_app"),function(){var svcname="bt.apps.delete";$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.delete"),$translator.translate(svcname,{appId:app.clientId,streamId:$workflowService.selectedStream()._id},{}).then(function(res){if(res){$scope.search.nameSearchQuery="",$scope.showNameSearch=!1;_.find($scope.manageApps,function(val,i){val.clientId==app.clientId&&(index=i)});$scope.manageApps.splice(index,1),$scope.apps.splice(index,1),NotificationService.notify(i18n.i18nString("app_deleted"),"success",1500)}},function(errRes){errRes.data&&409===errRes.data.errors[0].code?NotificationService.notify(i18n.i18nString("app_associated"),"error"):($scope.search.nameSearchQuery="",$scope.showNameSearch=!1,deleteScopeCheck(index,app))})},{okText:i18n.i18nString("ok_uppercase")},"",void 0,i18n.i18nString("confirm"))},$scope.callback.manageApps=function(){$scope.openNewAppModal()},$scope.callback.appDefinitionDataSlider=function(app,index){$scope.check=!0,$scope.creation=!1,$scope.currentIndex=index,$scope.sdkConf.appName="",$scope.sdkConf.clientID="",$scope.sdkConf.clientSecret="",$scope.sdkConf.appName=app.appName,$scope.sdkConf.clientID=app.clientId,$scope.sdkConf.appMode="edit",$scope.sdkConf.clientSecret=app.clientSecret,$scope.APIScopes.forEach(function(eachScope){eachScope.flag=!1,eachScope.selectedVal=!1,"universalbot"===$scope.stream.type?("bot_definition:bot_export"===eachScope.scope||"knowledge_graph_export:knowledge_graph_export"===eachScope.scope)&&(eachScope.flag=!0):"universalbot"!==$scope.stream.type&&"link_external_bots:link_external_bots"===eachScope.scope&&(eachScope.flag=!0)}),app&&($scope.sdkConf.appName=app.clientId,app&&app.scope&&app.scope.length&&app.scope.forEach(function(selectScope){selectScope.bot===$workflowService.selectedStream()._id&&$scope.APIScopes.forEach(function(eachScope){selectScope.scopes.indexOf(eachScope.scope)>-1?eachScope.selectedVal=!0:eachScope.selectedVal=!1})})),$scope.openModalSlider("#newAppDefinition")},$scope.appDefinitionDataSliderclose=function(){$scope.closeModalSlider("#newAppDefinition")},$scope.openNewAppModal=function(){$scope.openAppModal(),$scope.noneSelected=!0,$scope.sdkConf.clientID="",$scope.sdkConf.clientSecret="",$scope.sdkConf.appName="none",$scope.sdkConf.cbUrl="",$scope.callback.appSelected=!1,$scope.appName="",$scope.sdkConf.appMode="create",$scope.sdkConf.showModalFullSection=!1,$scope.sdkConfOnModal.appName="",$scope.sdkConf.publicKey="",$scope.sdkConf.label&&($scope.sdkConf.label.id="")},$scope.callback.APIScopeMappingSlider=function(){$scope.check=!1,$scope.creation=!0,$scope.openModalSlider("#apiScopeMapping"),$scope.dropDownLength(),$scope.sdkConf.appName="",$scope.sdkConf.clientID="",$scope.sdkConf.clientSecret="",$scope.sdkConf.appMode="create",$scope.APIScopes.forEach(function(eachScope){eachScope.flag=!1,eachScope.selectedVal=!1,"universalbot"===$scope.stream.type?("bot_definition:bot_export"===eachScope.scope||"knowledge_graph_export:knowledge_graph_export"===eachScope.scope)&&(eachScope.flag=!0):"universalbot"!==$scope.stream.type&&"link_external_bots:link_external_bots"===eachScope.scope&&(eachScope.flag=!0)})},$scope.APIScopeMappingSliderClose=function(){$scope.closeModalSlider("#apiScopeMapping")},$scope.manageAppsSlider=function(){if($scope.titleCheck="manageApps",$scope.openModalSlider("#managingApps"),$scope.manageApps=angular.copy($scope.apps),$scope.manageApps&&$scope.manageApps.length)for(var i=0;i<$scope.manageApps.length;i++)$scope.manageApps[i]&&$scope.manageApps[i].appName&&($scope.manageApps[i].appName=$scope.manageApps[i].appName.replace(/&lt;/g,"<").replace(/&gt;/g,">"))},$scope.appsManagement=function(){if($scope.titleCheck="manageApps",$scope.manageApps=angular.copy($scope.apps),$scope.manageApps&&$scope.manageApps.length)for(var i=0;i<$scope.manageApps.length;i++)$scope.manageApps[i]&&$scope.manageApps[i].appName&&($scope.manageApps[i].appName=$scope.manageApps[i].appName.replace(/&lt;/g,"<").replace(/&gt;/g,">"))},$scope.registerEvent=function(app){setTimeout(function(){$("#"+app.clientId).on("click",function(e){var openAccordian=!1;$(this).hasClass("active")||(openAccordian=!0),$(".accBody").removeClass("open"),$(".header").removeClass("active"),$(".accBody").css("display","none"),e.stopImmediatePropagation(),e.stopPropagation(),openAccordian&&($(this).toggleClass("active"),$(this).siblings().toggleClass("open").stop().slideToggle()),$(".modalBody").animate({scrollTop:e.currentTarget.offsetTop-350},1e3)})},100)},$scope.eventManageClose=function($event){var successCb=function(){"fromToggle"===$scope.openSliderCallFrom&&$event&&"appSliderClose"===$event.target.className&&$scope.callback.toggleFalse($scope.eventNameDisp),$scope.selectedLinkedBot&&($scope.selectedLinkedBot={}),$scope.responseObj=[],$scope.closeModalSlider("#eventManageSlider")},cancelCb=function(){};"published"===$scope.selectedState||$scope.isSaveDisabled||"show_standard"!==$scope.eventConfig.proceed&&"initiate_task"!==$scope.eventConfig.proceed||!$scope.selected.dialog?("fromToggle"===$scope.openSliderCallFrom&&$event&&"appSliderClose"===$event.target.className&&$scope.callback.toggleFalse($scope.eventNameDisp),$scope.responseObj=[],$scope.closeModalSlider("#eventManageSlider"),$scope.selectedLinkedBot&&($scope.selectedLinkedBot={})):(NotificationService.alert(i18n.i18nString("unsaved_msg"),[successCb,cancelCb],{okText:i18n.i18nString("yes"),cancelText:i18n.i18nString("no"),
icon:"warn"},"",void 0,i18n.i18nString("confirm")),$timeout(function(){$(".i-am-new").addClass("events-notify")},100))},$scope.manageAppsSliderClose=function(){setTimeout(function(){$("body").addClass("bt-modal-open")},250),$scope.closeModalSlider("#managingApps"),$(".header").removeClass("active"),$(".accBody").css("display","none"),$scope.sdkConf.clientSecret="",$scope.sdkConf.clientID="",$scope.sdkConf.appName="",$scope.search.nameSearchQuery="",$scope.showNameSearch=!1,$scope.dropDownLength()},$scope.creatingNewApp=function(){$(".header").removeClass("active"),$(".accBody").css("display","none"),$scope.existingAppObj={sdkConf:angular.copy($scope.sdkConf)},$scope.noneSelected=!0,$scope.sdkConf.clientID="",$scope.sdkConf.clientSecret="",$scope.sdkConf.appName="none",$scope.sdkConf.cbUrl="",$scope.callback.appSelected=!1,$scope.appName="",$scope.sdkConf.appMode="create",$scope.sdkConf.showModalFullSection=!1,$scope.sdkConfOnModal.appName="",$scope.callback.appCreated=!1,$scope.search.nameSearchQuery="",$scope.showNameSearch=!1,$scope.openModalSlider("#createNewApp"),$scope.jweEnforce.isJtiEnforced=!1,$scope.jweEnforce.isJweEnforced=!1},$scope.callback.disableSaveBtn=function(){return $scope.selectEvents(),"botkitSDk"===$scope.callFrom||"agentTransfer"===$scope.callFrom?""===$scope.sdkConf.appName||$scope.callback.saveInprogress||""===$scope.sdkConf.cbUrl?!0:"botkitSDk"===$scope.callFrom&&0===$scope.selectedEvents.length?!0:!1:""===$scope.sdkConf.appName||$scope.callback.saveInprogress?!0:!1},$scope.saveRTM=function(channel){return $scope.callback.saveInprogress?!1:($scope.callback.saveInprogress=!0,void BTStreamsService.createOrEditChannel($scope.stream._id,channel.type,channel).then(function(res){$scope.callback.saveInprogress=!1,$workflowService.selectedStream(res.data),NotificationService.notify(i18n.i18nString("channel_info_saved"),"success")},function(err){deleteChannel(channel),$scope.callback.saveInprogress=!1;var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")}))},$scope.callback.addAppToStream=function(){if($scope.callback.saveInprogress)return!1;$scope.callback.saveInprogress=!0;var payload={appPreferences:{rtmAppId:$scope.sdkConf.appName}};BTStreamsService.editStream($scope.stream._id,payload).then(function(response){$scope.callback.saveInprogress=!1,NotificationService.notify(i18n.i18nString("app_registered"),"success"),$workflowService.selectedStream(angular.merge($workflowService.selectedStream(),response.data)),$scope.stream=$workflowService.selectedStream();for(var channelRtm=null,channelWidgetSdk=null,i=0;i<$scope.stream.channels.length;i++)"rtm"===$scope.stream.channels[i].type&&(channelRtm=$scope.stream.channels[i]),"widgetsdk"===$scope.stream.channels[i].type&&(channelWidgetSdk=$scope.stream.channels[i]);if(channelRtm){var _currApp=$scope.apps.filter(function(app){return app.clientId===$scope.sdkConf.appName});channelRtm.app.clientId=_currApp[0].clientId,channelRtm.app.appName=_currApp[0].appName,$scope.saveRTM(channelRtm)}if(channelWidgetSdk){var _currAppWidget=$scope.apps.filter(function(app){return app.clientId===$scope.sdkConf.appName});channelWidgetSdk.app.clientId=_currAppWidget[0].clientId,channelWidgetSdk.app.appName=_currAppWidget[0].appName,$scope.saveRTM(channelWidgetSdk)}},function(res){$scope.callback.saveInprogress=!1,NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.callback.createAppCredentials=function(isFromSdConf,form){var _payload={};form=form||$scope.sdk.sdkConfForm;var noneSelected="none"===$scope.sdkConf.appName;if($scope.sdkConf.clientID||noneSelected)return _payload={subscribedFor:getSelectedEventIds(),sdkClientId:$scope.sdkConf.clientID,sdkHostUri:$scope.sdkConfOnModal.cbUrl,connectorEnabled:$scope.props.connectorEnabled},isFromSdConf&&(_payload.subscribedFor=getSelectedEventIds(),_payload.sdkHostUri=$scope.sdkConf.cbUrl,_payload.PIIMaskingDisabledForAgentTransfer=$scope.piiMasking.PIIMaskingDisabledForAgentTransfer),"agentTransfer"===$scope.callFrom&&_payload.subscribedFor.push("onAgentTransfer"),_payload.subscribedFor=_.uniq(_payload.subscribedFor),$scope.callback.saveInprogress=!0,"none"===$scope.sdkConf.appName?(_payload={},void BTStreamsService.deleteSDKSubscription($workflowService.selectedStream()._id,_payload).then(function(res){$scope.callback.saveInprogress=!1,$scope.callback.saveSuccess=!0,$workflowService.selectedStream(res.data),$scope.$emit("streamUpdate"),isFromSdConf||($scope.sdkConf.appName="",$(".selectAppModal").modal("hide"),$("body").removeClass("modal-open")),$scope.callback.loadSDKConf(),NotificationService.notify(i18n.i18nString("subscription_deleted"),"success")},function(error){$scope.callback.saveInprogress=!1,error.data.errors.length>0?NotificationService.notify(error.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")})):void BTStreamsService.makeSDKSubscription($workflowService.selectedStream()._id,_payload).then(function(res){$scope.callback.saveInprogress=!1,$scope.callback.saveSuccess=!0,$scope.sdkConf.noSDKConf=!1,$scope.sdkConf.clientID=res.data.sdkSubscription.sdkClientId,$scope.sdkConf.cbUrl=res.data.sdkSubscription.sdkHostUri,$scope.props.connectorEnabled=res.data.sdkSubscription.connectorEnabled,loadSelectedEvents(res.data.sdkSubscription.subscribedFor),$scope.stream.sdkSubscription=res.data.sdkSubscription,$scope.sdkConf.eventSelector=getSelectedEventIds(),$workflowService.selectedStream(res.data),$scope.$emit("streamUpdate"),isFromSdConf||($scope.sdkConf.appName="",$(".selectAppModal").modal("hide"),$("body").removeClass("modal-open"),getApps(!0)),appnameToRetain=$scope.sdkConf.appName,NotificationService.notify(i18n.i18nString("subscribed_success"),"success")},function(error){$scope.callback.saveInprogress=!1,error.data.errors.length>0?NotificationService.notify(error.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")})},$scope.callback.loadData=function(callFrom){$scope.callFrom=callFrom,"webMobileSDK"!==callFrom?$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId&&($scope.sdkConf.appName=$workflowService.selectedStream().sdkSubscription.sdkClientId,$scope.mapSelectedAppData($workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId||$scope.sdkConf.clientID||"")):($scope.sdkConf.appName=$workflowService.selectedStream().appPreferences&&$workflowService.selectedStream().appPreferences.rtmAppId||"",$scope.mapSelectedAppData($workflowService.selectedStream().appPreferences&&$workflowService.selectedStream().appPreferences.rtmAppId||""))},$scope.mapSelectedAppData=function(clientIdToMap){if($scope.noneSelected="none"===clientIdToMap,$scope.callback.appSelected=!1,!clientIdToMap)return void($scope.noneSelected=!0);if($scope.noneSelected)return void($scope.callback.appSelected=!0);if($scope.callback&&$scope.callback.apps&&$scope.apps&&$scope.callback.apps.length>$scope.apps.length&&($scope.apps=angular.copy($scope.callback.apps)),"createApp"===clientIdToMap)$scope.openAppModal(),$scope.noneSelected=!0,$scope.sdkConf.clientID="",$scope.sdkConf.clientSecret="",$scope.sdkConf.appName="none",$scope.sdkConf.cbUrl="",$scope.callback.appSelected=!1,$scope.appName="",$scope.sdkConfOnModal.appName="",$scope.sdkConf.appMode="create",$scope.sdkConf.showModalFullSection=!1;else{var selectedApp=_.filter($scope.apps,function(app){return app.clientId==clientIdToMap});selectedApp.length>0?($scope.sdkConf.clientID=selectedApp[0].clientId,$scope.sdkConf.clientSecret=selectedApp[0].clientSecret,$scope.callback.appSelected=!0,$scope.appName=selectedApp[0].appName,$scope.sdkConfOnModal.appName=selectedApp[0].appName,$scope.sdkConf.showModalFullSection=!0,$scope.sdkConf.algorithm=selectedApp[0].algorithm,$scope.sdkConf.publicKey=selectedApp[0].key,$scope.selectedAppView=selectedApp[0]):($scope.sdkConf.clientID="",$scope.sdkConf.clientSecret="",$scope.sdkConf.appName="none",$scope.callback.appSelected=!1,$scope.appName="",$scope.sdkConf.algorithm="",$scope.sdkConf.publicKey="")}},$scope.createClientApp=function(event){"webMobileSDK"!==$scope.callFrom&&13===event.keyCode&&""!==$scope.sdkConfOnModal.appName&&$scope.callback.createApp()},$scope.checkCreateApp=function(){return""===$scope.appName?!1:!0},$scope.handlecbUrl=function(event){$scope.sdkConf.cbUrl=event.currentTarget.value};var getApps=function(isFromCreateSubscription,fromSlider){$scope.fetchAppUsage=!1,$scope.callFrom&&"apps"===$scope.callFrom&&($scope.fetchAppUsage=!0),fromSlider||($scope.loadingApps=!0),$q.all([AppsDataService.getAppsList($scope.stream._id,$scope.fetchAppUsage)]).then(function(res){if(setTimeout(function(){$scope.loadingApps=!1},500),res[1]&&res[1].data?$scope.avalSreams=res[1].data:$scope.avalSreams=[],res[0]&&res[0].data&&res[0].data.apps){$scope.apps=res[0].data.apps,$.each($scope.apps,function(i,app){app.lastModifiedOn=moment(app.lastModifiedOn).format("MM/DD/YYYY - hh:mmA"),app.lastModifiedBy&&app.lastModifiedBy.firstName&&(app.lastModifiedByName=app.lastModifiedBy.firstName+" "+app.lastModifiedBy.lastName),app.isJtiEnforced&&($scope.jweEnforce.jtiEnforced[i]=app.isJtiEnforced),app.isJweEnforced&&($scope.jweEnforce.jweEnforced[i]=app.isJweEnforced)}),$scope.callback.apps=res[0].data.apps,$scope.JWEPublicKey=res[0].data.publicKeys.keys[0];var a_appClientIds=_.pluck($scope.callback.apps,"clientId");if($workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId&&-1===$.inArray($workflowService.selectedStream().sdkSubscription.sdkClientId,a_appClientIds)){var appObject=$workflowService.selectedStream().sdkSubscription;appObject.clientId=appObject.sdkClientId,$scope.callback.apps.push(appObject)}$scope.replaceAppDetails?("webMobileSDK"===$scope.callFrom?$scope.sdkConf.appName=$workflowService.selectedStream().appPreferences&&$workflowService.selectedStream().appPreferences.rtmAppId:$scope.sdkConf.appName=$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId||$scope.sdkConf.clientID,appnameToRetain=$scope.sdkConf.appName,$scope.sdkConf.connectorEnabled=$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.connectorEnabled||!1,$scope.props.connectorEnabled=$scope.sdkConf.connectorEnabled,$scope.sdkConf.cbUrl=$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkHostUri||$scope.sdkConf.cbUrl,$scope.sdkConf.eventSelector=$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.subscribedFor||$scope.sdkConf.eventSelector,loadSelectedEvents($scope.sdkConf.eventSelector),$scope.mapSelectedAppData($workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId||$scope.sdkConf.clientID||"")):(loadSelectedEvents($scope.sdkConf.eventSelector),$scope.mapSelectedAppData($scope.sdkConf.clientID||""),$scope.replaceAppDetails=!0)}else $scope.apps=[],$scope.callback.apps=[];$scope.filteringSelectedApp($scope.sdkConf,$scope.apps),$scope.contentLoading=!1,"apps"===$scope.callFrom&&$scope.appsManagement()},function(err){$scope.loadingApps=!1,$scope.contentLoading=!1,NotificationService.alertNotify(i18n.i18nString("get_apps"))})};$scope.filteringSelectedApp=function(appInfo,apps){var a=_.filter(apps,function(app){return app.clientId===appInfo.appName?app:void 0});a&&a.length&&($scope.sdkConf.algorithm=a[0].algorithm),a&&a.length&&"RS256"===$scope.sdkConf.algorithm&&($scope.sdkConf.publicKey=a[0].key)},$scope.callback.loadSDKConf=function(){$scope.initializeData(),$scope.contentLoading=!0,$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId?($scope.sdkConf.noSDKConf=!1,getApps()):($scope.sdkConf.noSDKConf=!0,getApps())},$scope.callback.deleteScopes=function(app){$scope.check=!1,$scope.creation=!1,app&&($scope.sdkConf.clientID=app.clientId,$scope.sdkConfOnModal.appName=app.appName),$scope.processModalSave(!0)},$scope.processModalSave=function(isdeleteScopes){for(var _params={},_urlParams={streamId:$workflowService.selectedStream()._id},scopesValue=[],i=0;i<$scope.APIScopes.length;i++)$scope.APIScopes[i].selectedVal&&scopesValue.push($scope.APIScopes[i].scope);var appsCopy=angular.copy($scope.apps);if(isdeleteScopes&&$.each(appsCopy,function(i,app){app.clientId===$scope.sdkConf.clientID&&($scope.deleteCheck=_.filter(app.scope,function(scope){return scope.bot===$workflowService.selectedStream()._id?!1:!0}))}),$scope.check&&$.each($scope.apps,function(i,app){app.clientId===$scope.sdkConf.clientID&&$.each(app.scope,function(j){app.scope[j].bot===$workflowService.selectedStream()._id&&(app.scope[j].scopes=scopesValue,$scope.appScopes=app.scope)})}),$scope.creation&&($scope.currentScope=_.filter($scope.apps,function(app){return app.clientId===$scope.sdkConf.clientID?app.scope:void 0})),_params={appName:$scope.sdkConfOnModal.appName,algorithm:"HS256",pushNotifications:{enable:!1,webhookUrl:""}},_params.bots=[$workflowService.selectedStream()._id],$scope.creation&&(_params.scope=$scope.currentScope[0].scope||[],_params.scope.push({bot:$workflowService.selectedStream()._id,scopes:scopesValue})),isdeleteScopes&&(_params.scope=$scope.deleteCheck),$scope.check&&(_params.scope=$scope.appScopes),$scope.saveInProgress=!0,$scope.closeModalSlider("#newAppDefinition"),$scope.closeModalSlider("#apiScopeMapping"),isdeleteScopes)NotificationService.alert(i18n.i18nString("delete_api_scope"),function(){_urlParams.appId=$scope.sdkConf.clientID,_urlParams.streamId=$scope.stream._id;var svcname="bt.apps.edit";$translator.translate(svcname,_urlParams,_params).then(function(res){res&&res.data&&200===res.status?(getApps(),$scope.saveInProgress=!1,$scope.sdkConfOnModal.createAppSuccess=!0,$scope.sdkConfOnModal.clientID=res.data.clientId,$scope.sdkConf.clientID=res.data.clientId,$scope.sdkConf.clientSecret=res.data.clientSecret,$scope.sdkConf.algorithm=res.data.algorithm,isdeleteScopes?NotificationService.notify(i18n.i18nString("api_scope_deleted"),"success"):"edit"===$scope.sdkConf.appMode?NotificationService.notify(i18n.i18nString("api_scope_updated"),"success"):NotificationService.notify(i18n.i18nString("api_scope_created"),"success")):($scope.saveInProgress=!1,alert(i18n.i18nString("error_alert")))},function(errRes){$scope.saveInProgress=!1,alert(i18n.i18nString("error_alert"))})},{okText:i18n.i18nString("ok_uppercase")},"",void 0,i18n.i18nString("confirm"));else{var svcname="bt.apps.edit";_urlParams.appId=$scope.sdkConf.clientID,_urlParams.streamId=$scope.stream._id,$translator.translate(svcname,_urlParams,_params).then(function(res){res&&res.data&&200===res.status?(getApps(),$scope.saveInProgress=!1,$scope.sdkConfOnModal.createAppSuccess=!0,$scope.sdkConfOnModal.clientID=res.data.clientId,$scope.sdkConf.algorithm=res.data.algorithm,$scope.sdkConf.clientID=res.data.clientId,$scope.sdkConf.clientSecret=res.data.clientSecret,isdeleteScopes?NotificationService.notify(i18n.i18nString("api_scope_deleted"),"success"):"edit"===$scope.sdkConf.appMode?NotificationService.notify(i18n.i18nString("api_scope_updated"),"success"):NotificationService.notify(i18n.i18nString("api_scope_created"),"success")):($scope.saveInProgress=!1,alert(i18n.i18nString("error_alert")))},function(errRes){$scope.saveInProgress=!1,alert(i18n.i18nString("error_alert"))})}},$scope.disableAppScopeSave=function(){for(var scopesValue=[],i=0;i<$scope.APIScopes.length;i++)$scope.APIScopes[i].selectedVal&&scopesValue.push($scope.APIScopes[i].scope);return""!==$scope.sdkConf.appName&&scopesValue.length?!1:!0},$scope.callback.loadSDKConf(),$scope.$watch("sdkConf.appName",function(newVal,oldVal){$scope.mapSelectedAppData(newVal)}),$scope.$on("rerenderSDKConf",function(){$scope.callback.loadSDKConf()}),$scope.isFormValid=function(form){return!form.$invalid},$scope.clientSecretCopy=function(){NotificationService.notify(i18n.i18nString("client_secret_copy"),"success")},$scope.copyJWTToken=function(containerid){var textarea=document.createElement("textarea");textarea.id="temp_element",textarea.style.height=0,document.body.appendChild(textarea),textarea.value=document.getElementById(containerid).innerText;var selector=document.querySelector("#temp_element");selector.select(),document.execCommand("copy"),document.body.removeChild(textarea),NotificationService.notify(i18n.i18nString("jwe_key_copy"),"success")},$scope.clearSearch=function(){$scope.search.nameSearchQuery=""},$scope.selectConfig={formatResult:format}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btDebugConsolePanel",function(){return{restrict:"EAQ",scope:{debugInfo:"=",debugRaw:"=",debugContext:"=",isResized:"=",debuggerConsole:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-debug-console/bt-debug-console-panel.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","i18n",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,i18n){function intialize(){}$scope.stream=$workflowService.selectedStream(),$scope._constants_=$rootScope._constants_;$workflowService.selectedStream();$scope.isOpen=!1,$scope.isAccordionOpen=!1,$scope.hasDebugObj=!1,$scope.jsEditorCbsRequest={},$scope.jsEditorCbsResponse={},intialize(),$scope.options={mode:"code",ace:window.ace,theme:"ace/theme/clouds_white"},$scope.openSessionAccordion=function(){$scope.isAccordionOpen=!$scope.isAccordionOpen},$scope.somethingClicked=function(e){e.preventDefault(),e.stopPropagation()},$scope.copyDebugToClipboard=function(e){function copyToClipboardFF(text){window.prompt(i18n.i18nString("copy_clipboard"),text)}e.preventDefault(),e.stopPropagation();var selection,success=!0,range=document.createRange(),input=JSON.stringify($scope.debugRaw);if(window.clipboardData)success=window.clipboardData.setData("Text",input);else{var tmpElem=$("<div>");tmpElem.css({position:"absolute",left:"-1000px",top:"-1000px"}),tmpElem.text(input),$("body").append(tmpElem),range.selectNodeContents(tmpElem.get(0)),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range);try{success=document.execCommand("copy",!1,null)}catch(e){copyToClipboardFF(input)}finally{tmpElem.remove()}}success&&NotificationService.notify(i18n.i18nString("json_copied"),"success")},$scope.$watch("debugRaw",function(newVal,oldVal){newVal?$scope.hasDebugObj=!0:$scope.hasDebugObj=!1}),$scope.$watch("isAccordionOpen",function(newVal,oldVal){var _consoleHeight;oldVal===!0&&newVal===!1?(_consoleHeight=parseInt($element.parent().height())-60,$element.find(".debug-console-body .log-console-body").css("height",_consoleHeight+"px")):oldVal===!1&&newVal===!0&&(_consoleHeight=parseInt($element.parent().height())-60-250,$element.find(".debug-console-body .panel .panel-body").css("height",_consoleHeight+"px"))}),$scope.$watch("isResized",function(newVal,oldVal){var _conHeight;newVal!==oldVal&&(_conHeight=parseInt($element.parent().height())-60,$scope.isAccordionOpen?(_conHeight-=250,$element.find(".debug-console-body .panel .panel-body").css("height",_conHeight+"px")):$element.find(".debug-console-body .log-console-body").css("height",_conHeight+"px"))})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.controller("BTGuidedTour",["$scope","$translator","$modalInstance","config","$filter","$rootScope","$routeParams","$timeout","$location","$applicationService","scriptLoader","env_conf","security","$workflowService","AuthService","interactiveHelp","i18n","mixPanel",function($scope,$translator,$modalInstance,config,$filter,$rootScope,$routeParams,$timeout,$location,$applicationService,scriptLoader,env_conf,security,$workflowService,AuthService,interactiveHelp,i18n,mixPanel){$scope.productTour=env_conf["context-url"]+"/assets/images/productTour.svg",$scope.skipTour=function(){$scope.updateOnboarding(),$modalInstance.close()},$scope.updateOnboarding=function(skip){AuthService.profileUpdate({isBotsOnboarded:!0,enableTips:!1}).then(function(res){skip&&mixPanel.postEvent("Onboarding Journey Skiped"),localStorage.removeItem("koreOnBoardingProgress"),$(".notificationHeader").css("height",0),$rootScope.koreUserInfo.isBotsOnboarded=!0,$applicationService.userInfo()&&$applicationService.userInfo().koreUserInfo&&($applicationService.userInfo().koreUserInfo.enableTips=!1,$applicationService.userInfo().koreUserInfo.isBotsOnboarded=!0),$modalInstance.close(),console.log(i18n.i18nString("update_board"))},function(err){console.error(i18n.i18nString("error_updating")),$modalInstance.close()})},$scope.takeTour=function(){AuthService.profileUpdate({isBotsOnboarded:!0,enableTips:!1}).then(function(res){localStorage.removeItem("koreOnBoardingProgress"),$(".notificationHeader").css("height",0),$rootScope.koreUserInfo.isBotsOnboarded=!0,$rootScope.koreUserInfo.isBotsOnboarded=!0,$applicationService.userInfo()&&$applicationService.userInfo().koreUserInfo&&($applicationService.userInfo().koreUserInfo.enableTips=!1,$applicationService.userInfo().koreUserInfo.isBotsOnboarded=!0),$timeout(function(){interactiveHelp.openHelp("BOT_WALK_THROUGH")}),$modalInstance.close(),console.log(i18n.i18nString("update_board"))},function(err){console.error(i18n.i18nString("error_updating")),$modalInstance.close()})}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btIipMasking",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-iip-masking/bt-iip-masking.html",controller:"BtIipMasking",scope:{callback:"="}}}),_module.controller("BtIipMasking",["$scope","$element","$compile","$translator","$filter","$rootScope","$routeParams","$timeout","$location","$workflowService","NotificationService","$applicationService","BTFlowtaskService","BTStreamsService","env_conf","accessControlService","i18n","$window",function($scope,$element,$compile,$translator,$filter,$rootScope,$routeParams,$timeout,$location,$workflowService,NotificationService,$applicationService,BTFlowtaskService,BTStreamsService,env_conf,accessControlService,i18n,$window){function importModalSliderOpen(){$timeout(function(){$scope.modalSlider.open("#iipSlider"),$element.find(".modalBody").scrollTop(0),$scope.isDisabled=!1,document.getElementById("infoType").focus(),$element.find("#regexType, #infoType").removeClass("invalid-input")},500)}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS");var _selectedStream=$workflowService.selectedStream(),_piiInformationSystem=angular.copy($workflowService.seedData().pii.patterns),_piiInformationSystemCopy=angular.copy($workflowService.seedData().pii.patterns);$workflowService.seedData().pii.patterns.length;$scope.rightClass="right500",$scope.modalSlider={},$scope.newInfoType={infoType:"",dispType:"",source:"System",action:!0},$scope.regexInp={regexInput:""},$scope.patternInp={patternInput:""},$scope.entitySelected={entityId:""},$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.assetsBase=env_conf["assets-url"],$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.emptyStateIcon_pii=env_conf["context-url"]+"/assets/empty-state-images/empty-pii.png",$scope.piiSettings=[],$scope.showLanding="",$scope.connectionFlag=$scope.addNewEnabled=$scope.loading=!0,$scope.isDisabled=$scope.systemEdit=$scope.enableDisableFlag=$scope.editFlag=$scope.deleteFlag=!1,$scope.index=-1,$scope.payload={pii_patterns:[],strict_pii:!0},$scope.entitiesList=[],$scope.entitySelLabels=[],$scope.maskVals={maskWith:"",skipRight:"",skipLeft:""},$scope.selDisplay={},$scope.charSkip=[0,1,2,3,4,5,6,7,8,9,10],$scope.masks=["+","#"],$scope.repVal={replaceValue:""},$scope.newOrEdit="",BTStreamsService.getBTStream(_selectedStream._id).then(function(res){res.data.pii_patterns&&0!==res.data.pii_patterns.length?($scope.landingToggleHandler(),$scope.addNewEnabled=res.data.enable_pii,$scope.payload.enable_pii=res.data.enable_pii,populatePiiSettings(res.data.pii_patterns)):populatePiiSettings([]),$scope.showLanding=res.data.enable_pii,$scope.loading=!1},function(error){console.error("getStreams Failed",error),$scope.loading=!1}),BTFlowtaskService.getComponentsByType(_selectedStream._id,"entity","true").then(function(res){res.data.forEach(function(d,i){$scope.entitiesList[i]={},$scope.entitiesList[i]={name:d.name,compId:d._id}})},function(error){console.log(error)}),$scope.landingToggleHandler=function(){$scope.showLanding=!$scope.showLanding,$scope.payload.enable_pii=$scope.showLanding,editStream("")},$scope.importModalSliderClose=function(){$scope.editFlag=!1,$element.find("#regexType, #infoType").removeClass("invalid-input"),$timeout(function(){$scope.modalSlider.close("#iipSlider")},500)},$scope.addNewPii=function(){$scope.newOrEdit="New",$scope.systemEdit=!1,$scope.selDisplay={},$scope.entitySelLabels=[],$scope.newInfoType.infoType=$scope.regexInp.regexInput=$scope.patternInp.patternInput=$scope.entitySelected.entityId=$scope.repVal.replaceValue=$scope.maskVals.maskWith=$scope.maskVals.skipRight=$scope.maskVals.skipLeft="",$scope.newInfoType.dispType="redaction",importModalSliderOpen()};var editStream=function(mess){BTStreamsService.editStream(_selectedStream._id,$scope.payload).then(function(res){"undefined"!=typeof mess&&""!==mess&&NotificationService.notify(mess,"success"),res.data.pii_patterns&&showDataLanding(res.data.pii_patterns,res.data.enable_pii),$scope.connectionFlag=$scope.isDisabled=!0,$scope.importModalSliderClose(),$scope.enableDisableFlag||resetValues(),$scope.enableDisableFlag=!1,_selectedStream.pii_patterns=res.data.pii_patterns,_selectedStream.enable_pii=res.data.enable_pii,$workflowService.selectedStream(_selectedStream)},function(error){null===error.data?$scope.connectionFlag=!1:($element.find("#regexType").removeClass("invalid-input"),"Invalid Regex for undefined"===error.data.errors[0].msg&&(NotificationService.notify(i18n.i18nString("invalid_regex"),"error"),$element.find("#regexType").addClass("invalid-input")),$scope.editFlag||$scope.payload.pii_patterns.pop())})};$scope.entityChange=function(val){-1===$scope.entitySelLabels.indexOf(val)&&$scope.entitySelLabels.push(val),$scope.entitySelected.entityId=""},$scope.toggleAllPii=function(){$scope.addNewEnabled=!$scope.addNewEnabled,$scope.payload.enable_pii=!$scope.payload.enable_pii,editStream(i18n.i18nString("updated_sucessfully"))},$scope.delEntity=function(e){$scope.entitySelLabels.splice($scope.entitySelLabels.indexOf(e.target.parentElement.innerText),1)},$scope.deleteIipList=function(index){var confirmDeletePii=function(){$scope.payload.pii_patterns.splice(index,1),$scope.editFlag=$scope.deleteFlag=!0,$scope.index=index,editStream(i18n.i18nString("the_pii_information_has_been_deleted"))},msg=i18n.i18nString("pii_information_type")+$scope.payload.pii_patterns[index].pii_type+i18n.i18nString("pii_will_be_deleted")+" "+i18n.i18nString("this_will_permanently_delete_pii");NotificationService.confirm({heading:i18n.i18nString("are_you_sure"),headerClass:"confirmationHeader",msg:msg,successCb:confirmDeletePii,failCb:function(){},isModal:!0,btnTexts:{success:i18n.i18nString("ok_uppercase"),fail:i18n.i18nString("cancel")}})},$scope.deleteRegexList=function($event){$event.currentTarget.parentElement.parentElement.remove()},$scope.enableDisableReq=function(index,details){$scope.editFlag=$scope.enableDisableFlag=!0,$scope.index=index,details.action&&0===$scope.payload.pii_patterns[index].mappedEntities.length?$("#warningModal").removeClass("fade").addClass("show"):($scope.payload.pii_patterns[index].enabled=details.action,editStream(i18n.i18nString("updated_sucessfully")))},$scope.confirmWarningDialog=function(){$("#warningModal").removeClass("show").addClass("fade"),$scope.payload.pii_patterns[$scope.index].enabled=!0,editStream(i18n.i18nString("updated_sucessfully"))},$scope.closeModal=function(){$("#warningModal").removeClass("show").addClass("fade"),editStream()};var changePattern=function(str){try{return str.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(error){return str}},showDataLanding=function(details,flag){if(!$scope.editFlag&&(details.length!==$scope.piiSettings.length||details.length<$scope.piiSettings.length)){var obj={infoType:changePattern(details[details.length-1].pii_type),source:details[details.length-1].sourceType,action:details[details.length-1].enabled,dispType:details[details.length-1].display.type};$scope.piiSettings.push(obj)}else $scope.deleteFlag?$scope.piiSettings.splice($scope.index,1):-1!==$scope.index&&($scope.piiSettings[$scope.index]={infoType:changePattern(details[$scope.index].pii_type),source:details[$scope.index].sourceType,action:details[$scope.index].enabled,dispType:details[$scope.index].display.type});$scope.addNewEnabled=flag,$scope.editFlag=$scope.deleteFlag=!1,$scope.index=-1},populatePiiSettings=function(details){var tempDetails=angular.copy(details);details&&(tempDetails=tempDetails.filter(function(val){return"system"!==val.sourceType||isSeedData(val,_piiInformationSystem)}),tempDetails.forEach(function(valTemp){_piiInformationSystem=_piiInformationSystem.filter(function(valPii){return valTemp.pii_type!==valPii.pii_type})})),_piiInformationSystem.forEach(function(val){val.enabled=!1,val.mappedEntities=[]}),Array.prototype.push.apply(tempDetails,_piiInformationSystem),$scope.payload.pii_patterns=tempDetails;for(var i=0;i<tempDetails.length;i++){var obj={infoType:changePattern(tempDetails[i].pii_type),source:tempDetails[i].sourceType,action:tempDetails[i].enabled,dispType:tempDetails[i].display.type};$scope.piiSettings.push(obj)}},resetValues=function(){$timeout(function(){$scope.newInfoType={infoType:"",dispType:"",source:"System",action:!0}},600)},isSeedData=function(resData,seedData){return 0!==seedData.filter(function(val){return val.pii_type===resData.pii_type&&val.sourceType===resData.sourceType}).length};$scope.editIipElement=function($event){if($scope.index=$event.currentTarget.getAttribute("data-ind"),$event.target.classList.contains("FuncCall")){switch($scope.systemEdit=isSeedData($scope.payload.pii_patterns[$scope.index],_piiInformationSystemCopy),$scope.editFlag=!0,$scope.newOrEdit="Edit",$scope.newInfoType.infoType=changePattern($scope.payload.pii_patterns[$scope.index].pii_type),$scope.regexInp.regexInput=$scope.payload.pii_patterns[$scope.index].regex,$scope.newInfoType.dispType=$scope.payload.pii_patterns[$scope.index].display.type,$scope.newInfoType.dispType){case"redaction":$scope.repVal.replaceValue=$scope.maskVals.skipLeft=$scope.maskVals.skipRight=$scope.maskVals.maskWith="";break;case"replacement":$scope.repVal.replaceValue=$scope.payload.pii_patterns[$scope.index].display.replaceValue,$scope.maskVals.skipRight=$scope.maskVals.skipLeft=$scope.maskVals.maskWith="";break;case"masking":$scope.maskVals.maskWith=$scope.payload.pii_patterns[$scope.index].display.maskingProps["char"],$scope.maskVals.skipRight=$scope.payload.pii_patterns[$scope.index].display.maskingProps.mr,$scope.maskVals.skipLeft=$scope.payload.pii_patterns[$scope.index].display.maskingProps.ml,$scope.repVal.replaceValue="";break;default:console.log("No Matches")}$scope.entitySelected.entityId="",$scope.entitySelLabels=[];for(var i=0;i<$scope.payload.pii_patterns[$scope.index].mappedEntities.length;i++)for(var j=0;j<$scope.entitiesList.length;j++)$scope.payload.pii_patterns[$scope.index].mappedEntities[i]===$scope.entitiesList[j].compId&&$scope.entitySelLabels.push($scope.entitiesList[j].name);$scope.entitySelLabels=$scope.entitySelLabels.filter(function(val){return void 0!==val}),importModalSliderOpen()}},$scope.saveMaskEntity=function(details){if($element.find("#infoType, #regexType").removeClass("invalid-input"),
""===$scope.newInfoType.infoType)return void NotificationService.notify(i18n.i18nString("please_provide_info_type"),"error");var namesList=[];if($scope.payload.pii_patterns.forEach(function(val,ind){namesList.push(changePattern(val.pii_type))}),$scope.newInfoType.infoType.length>32)return NotificationService.notify(i18n.i18nString("info_type_warning"),"error"),void $element.find("#infoType").addClass("invalid-input");if(-1!==namesList.indexOf($scope.newInfoType.infoType)&&!$scope.editFlag)return void NotificationService.notify(i18n.i18nString("duplicate_info_type"),"error");if(""===$scope.regexInp.regexInput)return NotificationService.notify(i18n.i18nString("please_provide_regex_value"),"error"),void $element.find("#regexType").addClass("invalid-input");if(""===$scope.newInfoType.dispType)return void NotificationService.notify(i18n.i18nString("please_provide_display_type"),"error");if("replacement"===$scope.newInfoType.dispType&&""===$scope.repVal.replaceValue)return void NotificationService.notify(i18n.i18nString("please_provide_replacement_value"),"error");if("masking"===$scope.newInfoType.dispType&&(""===$scope.maskVals.maskWith||""===$scope.maskVals.skipRight||""===$scope.maskVals.skipLeft))return void NotificationService.notify(i18n.i18nString("please_provide_all_Values_for_masking"),"error");("undefined"==typeof $scope.selDisplay.type||$scope.selDisplay.type!==$scope.newInfoType.dispType)&&($scope.selDisplay={},$scope.selDisplay.type=$scope.newInfoType.dispType);var findIndex=$scope.payload.pii_patterns.findIndex(function(item){return item.pii_type===$scope.newInfoType.infoType});$scope.editFlag&&$scope.index&&(findIndex=$scope.index),"masking"===$scope.selDisplay.type&&(-1!==findIndex?($scope.payload.pii_patterns[findIndex].display={},$scope.payload.pii_patterns[findIndex].display.type=$scope.newInfoType.dispType,$scope.payload.pii_patterns[findIndex].display.maskingProps={},$scope.payload.pii_patterns[findIndex].display.maskingProps={"char":$scope.maskVals.maskWith,mr:$scope.maskVals.skipRight,ml:$scope.maskVals.skipLeft}):(findIndex=$scope.payload.pii_patterns.length,$scope.payload.pii_patterns[findIndex]={},$scope.payload.pii_patterns[findIndex].display={},$scope.payload.pii_patterns[findIndex].display.type=$scope.newInfoType.dispType,$scope.payload.pii_patterns[findIndex].display.maskingProps={},$scope.payload.pii_patterns[findIndex].display.maskingProps={"char":$scope.maskVals.maskWith,mr:$scope.maskVals.skipRight,ml:$scope.maskVals.skipLeft})),"replacement"==$scope.selDisplay.type&&(-1!==findIndex?($scope.payload.pii_patterns[findIndex].display={},$scope.payload.pii_patterns[findIndex].display.type=$scope.newInfoType.dispType,$scope.payload.pii_patterns[findIndex].display.replaceValue=$scope.repVal.replaceValue):(findIndex=$scope.payload.pii_patterns.length,$scope.payload.pii_patterns[findIndex]={},$scope.payload.pii_patterns[findIndex].display={},$scope.payload.pii_patterns[findIndex].display.type=$scope.newInfoType.dispType,$scope.payload.pii_patterns[findIndex].display.replaceValue=$scope.repVal.replaceValue)),"redaction"==$scope.selDisplay.type&&(-1!==findIndex?($scope.payload.pii_patterns[findIndex].display={},$scope.payload.pii_patterns[findIndex].display.type=$scope.newInfoType.dispType):(findIndex=$scope.payload.pii_patterns.length,$scope.payload.pii_patterns[findIndex]={},$scope.payload.pii_patterns[findIndex].display={},$scope.payload.pii_patterns[findIndex].display.type=$scope.newInfoType.dispType));var message,ind,arr=[];$scope.entitySelLabels.forEach(function(vS,iS){arr[iS]=$scope.entitiesList.filter(function(vL,iL){return vS==vL.name})[0].compId}),$scope.connectionFlag&&($scope.editFlag?(ind=$scope.index,message=i18n.i18nString("updated_sucessfully")):("masking"===$scope.selDisplay.type||"replacement"==$scope.selDisplay.type||"redaction"==$scope.selDisplay.type?ind=findIndex:($scope.payload.pii_patterns[$scope.payload.pii_patterns.length]={},ind=$scope.payload.pii_patterns.length-1),message=i18n.i18nString("saved_successfully")),$scope.payload.pii_patterns[ind].pii_type=$scope.newInfoType.infoType,$scope.payload.pii_patterns[ind].regex=$scope.regexInp.regexInput,$scope.payload.pii_patterns[ind].enabled=$scope.payload.pii_patterns[ind].enabled===!1?!1:!0,$scope.payload.pii_patterns[ind].ignoreCase=!0,$scope.payload.pii_patterns[ind].mappedEntities=arr,$scope.payload.pii_patterns[ind].display=-1!==findIndex?$scope.payload.pii_patterns[findIndex].display:$scope.selDisplay,$scope.payload.pii_patterns[ind].sourceType=$scope.payload.pii_patterns[ind].sourceType||"developer"),editStream(message)},$scope.$emit("nestedComponentLoaded",{id:"IIPMasking",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.redirectToLink=function(linkType){var targetURL=$rootScope.helpLinks[linkType];$window.open(targetURL,"_blank")}}])}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("btIvrSettings",function(){return{restrict:"EA",scope:{callback:"=",streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-ivr-settings/bt-ivr-settings.html",controller:["$scope","form_util","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","env_conf","$timeout","accessControlService","channelsConfig","BTFlowtaskService","$q","i18n",function($scope,form_util,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,env_conf,$timeout,accessControlService,channelsConfig,BTFlowtaskService,$q,i18n){function getDialogs(){var deferred=$q.defer();return $scope.dialogsName=[],BTFlowtaskService.getFlowtaks($workflowService.selectedStream()._id).then(function(res){var ind=0,refIds=[];res.data.forEach(function(val){-1==refIds.indexOf(val.refId)&&refIds.push(val.refId)}),res.data.forEach(function(val){(!val.isFollowUp&&refIds.indexOf(val.refId)>-1||!val.isDeleted)&&($scope.dialogsName[ind]={},$scope.dialogsName[ind].name=val.name,$scope.dialogsName[ind].id=val.refId,refIds.splice(refIds.indexOf(val.refId),1),ind++)}),deferred.resolve($scope.dialogsName)},function(err){console.log(err),deferred.reject(err)}),deferred.promise}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function createConversationEndPayload(){var payload={CONVERSATION_END:{}};if("initiate"===$scope.events.config){payload.CONVERSATION_END.action="triggerDialog",payload.CONVERSATION_END.script=".",payload.CONVERSATION_END.msg=[];for(var dialogId="",i=0;i<$scope.dialogsName.length;i++)if($scope.dialogsName[i].name===$scope.selected.dialog){dialogId=$scope.dialogsName[i].id;break}payload.CONVERSATION_END.task=dialogId}else"runScript"===$scope.events.config?(payload.CONVERSATION_END.action="runScript",payload.CONVERSATION_END.script=$scope.inp.scriptText,payload.CONVERSATION_END.task="",payload.CONVERSATION_END.welcomeMsg=[]):"showMessage"===$scope.events.config&&(payload.CONVERSATION_END.action="showMsg",payload.CONVERSATION_END.script=".",payload.CONVERSATION_END.msg=$scope.responseObj);return payload.CONVERSATION_END.enabled=!0,payload.CONVERSATION_END.manageFirstMessage={},payload.CONVERSATION_END.welcomeIvrOptions=[],payload}function createBTStream(streamData,cb,vxmlFlag){var streamobj=angular.copy(streamData);streamobj.ivrSettings&&streamobj.ivrSettings.grammars&&angular.forEach(streamobj.ivrSettings.grammars,function(element,index){""===element.value&&"disable"!==element.type&&streamobj.ivrSettings.grammars.splice(index,1)});var convPayload={};isConversationEvent&&!fromEnableFlag&&"terminate"!==$scope.conver.value?(convPayload=createConversationEndPayload(),streamobj.botEvent=convPayload,isConversationEvent=!0):isConversationEvent||fromEnableFlag||"terminate"===$scope.conver.value?isConversationEvent&&!fromEnableFlag&&"terminate"===$scope.conver.value&&(convPayload=createConversationEndPayload(),streamobj.botEvent=convPayload,isConversationEvent=!0):(convPayload=createConversationEndPayload(),streamobj.botEvent=convPayload,isConversationEvent=!0),"terminate"===$scope.conver.value&&streamobj.botEvent&&streamobj.botEvent.CONVERSATION_END&&(streamobj.botEvent.CONVERSATION_END.enabled=!1),BTStreamsService.editStream($workflowService.selectedStream()._id,streamobj).then(function(response){var grammar={};if($scope.callback&&$scope.callback.closeBotLevelIvr&&$scope.callback.closeBotLevelIvr(),$workflowService.selectedStream(response.data),response.data.ivrSettings&&response.data.ivrSettings.grammars&&response.data.ivrSettings.enable_transcript&&0===response.data.ivrSettings.grammars.length?($scope.newStreamData.ivrSettings.grammars=response.data.ivrSettings.grammars,grammar=angular.copy(_defaultGrammar),grammar.type="disable",$scope.newStreamData.ivrSettings.grammars.push(grammar)):response.data.ivrSettings&&response.data.ivrSettings.grammars&&0===response.data.ivrSettings.grammars.length&&($scope.newStreamData.ivrSettings.grammars=response.data.ivrSettings.grammars,grammar=angular.copy(_defaultGrammar),grammar.type="custom",$scope.newStreamData.ivrSettings.grammars.push(grammar)),$scope.callback&&$scope.callback.closeModal&&!vxmlFlag&&$scope.callback.closeModal(),$scope.isEnabled=response.data.ivrSettings.enable,$scope.callback.enabled=$scope.isEnabled,$scope.newStreamData.ivrSettings.transcript_tag=response.data.ivrSettings.transcript_tag,$scope.newStreamData.ivrSettings=angular.copy(response.data.ivrSettings),$scope.tempProperty=$scope.newStreamData.ivrSettings.properties,$scope.xmlProperties=$scope.newStreamData.ivrSettings.properties,$scope.newStreamData.ivrSettings.timeout=""+$scope.newStreamData.ivrSettings.timeout/1e3,$scope.newStreamData.ivrSettings.retry_limit=""+$scope.newStreamData.ivrSettings.retry_limit,cb){$scope.isEnabled?i18n.i18nString("settings_enabled"):i18n.i18nString("settings_disabled")}else NotificationService.notify(i18n.i18nString("settings_saved"),"success")},function(res){cb&&($scope.isEnabled=!1,$scope.callback.enabled=$scope.isEnabled),NotificationService.notify(res.data.errors[0].msg,"error")})}$scope.ivrDisplayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.displayMode="edit",$scope.modalSlider={},$scope.jsMsg=i18n.i18nString("js_msg"),$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.isUploading=!1,$scope.showEnable=!1,$scope.errorInsideStream=!0,$scope.showadvancedoptions=!1,$scope.callback=$scope.callback||{},$scope.callback.enabled=$scope.callback.enabled||!1,$scope.assetsBase=env_conf["assets-url"],$scope.newStreamData=[],$scope.streamdata=angular.copy($workflowService.selectedStream()),$scope.ivr=[],$scope.grammerVals=[],$scope.grammer={},$scope.isDialogsAvailable=!1,$scope.grammerVals.custom="",$scope.grammer.link="",$scope.jsEditorCbs={};var isConversationEvent=!1;$scope.rightClass="right500",$scope.channelsConfig=channelsConfig,$scope.dialogsName=[],$scope.backArrow=env_conf["context-url"]+"/assets/icons/rightArrow.svg",$scope.conver={value:"trigger"};var _defaultGrammar={inputMode:"speech",type:"custom",value:""};$scope.selected={dialog:""};var fromEnableFlag=!1;$scope.streamdata&&$scope.streamdata.ivrSettings&&$scope.streamdata.ivrSettings.enable_transcript&&(_defaultGrammar.type="disable"),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.events={config:"initiate"},$scope.inp={scriptText:""},$scope.welcomeMessagecbs={},$scope.welcomeMessagecbs.isAddResponseEnabled=!1,$scope.welcomeMessagecbs.isFrom="channelIvr",$scope.welcomeMessagecbs.isAPICall=!1,$scope.responseObj=[],$scope.upgradedTasks=[],$scope.filterToggle=$workflowService.selectedStreamState(),$scope.welcomeMessagecbs.closeAddResponseModal=function(){$scope.welcomeMessagecbs.isAddResponseEnabled=!1,$scope.showEnable=!1,$scope.modalSlider.close("#vxmlProp")},$scope.welcomeMessagecbs.getObjResponse=function(obj,isEdit){if($scope.isSaveDisabled=!1,$scope.isAddRespEdited=!0,isEdit){for(var i=0;i<$scope.responseObj.length;i++)if($scope.responseObj[i]._id===obj._id){$scope.responseObj.splice(i,1,obj);break}}else $scope.responseObj.push(obj)},$scope.welcomeMessagecbs.getObjResponseEdit=function(obj){$scope.isAddRespEdited=!0,$scope.isSaveDisabled=!1,$scope.responseObj=[],$scope.responseObj=angular.copy(obj)},$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},getDialogs().then(function(data){$scope.isDialogsAvailable=!0},function(err){$scope.isDialogsAvailable=!0,$scope.dialogsName=[]}),$scope.ivrSettingsDefault={ivrSettings:{asrConfidenceThreshold:{key:"confidenceLevel",value:0},extraction_key:"userinput",enable:!1,timeout:"30",enable_log:!0,retry_limit:"6",properties:[],enable_transcript:!1,transcript_tag:"",callTerminationHandler:"",bargein:!1,timeoutPrompts:[[{type:"text",value:""}]],nomatchPrompts:[[{type:"text",value:""}]],grammars:[_defaultGrammar]}},$scope.isEnabled=$scope.ivrSettingsDefault.ivrSettings.enable,$scope.callback.enabled=$scope.isEnabled,$scope.streamdata&&$scope.streamdata.ivrSettings&&Object.keys($scope.streamdata.ivrSettings).length?$scope.newStreamData.ivrSettings=$scope.streamdata.ivrSettings:$scope.newStreamData.ivrSettings=angular.copy($scope.ivrSettingsDefault.ivrSettings),$scope.streamdata&&$scope.streamdata.ivrSettings&&Object.keys($scope.streamdata.ivrSettings).length&&($scope.newStreamData.ivrSettings.timeout=""+$scope.streamdata.ivrSettings.timeout/1e3||"30",$scope.newStreamData.ivrSettings.retry_limit=""+$scope.streamdata.ivrSettings.retry_limit||"6",$scope.newStreamData.ivrSettings.transcript_tag=$scope.streamdata.ivrSettings.transcript_tag||"",$scope.newStreamData.ivrSettings.extraction_key=$scope.streamdata.ivrSettings.extraction_key||"userinput",$scope.newStreamData.ivrSettings.callTerminationHandler=$scope.streamdata.ivrSettings.callTerminationHandler||"",$scope.newStreamData.ivrSettings.bargein=$scope.streamdata.ivrSettings.bargein||!1,$scope.newStreamData.ivrSettings.timeoutPrompts=$scope.streamdata.ivrSettings.timeoutPrompts||[],$scope.newStreamData.ivrSettings.nomatchPrompts=$scope.streamdata.ivrSettings.nomatchPrompts||[],$scope.newStreamData.ivrSettings&&$scope.newStreamData.ivrSettings.grammars&&0===$scope.newStreamData.ivrSettings.grammars.length&&$scope.newStreamData.ivrSettings.grammars.push(angular.copy(_defaultGrammar)),$scope.newStreamData.ivrSettings.grammars=$scope.streamdata.ivrSettings.grammars||[_defaultGrammar],$scope.newStreamData.ivrSettings.asrConfidenceThreshold=$scope.streamdata.ivrSettings.asrConfidenceThreshold||{key:"confidenceLevel",value:0}),$scope.isEnabled=$scope.newStreamData.ivrSettings.enable,$scope.callback.enabled=$scope.isEnabled,$scope.tempProperty=$scope.newStreamData.ivrSettings.properties,$scope.xmlProperties=$scope.newStreamData.ivrSettings.properties,$scope.showIvrsettings=function(){$scope.isEnabled||($scope.isEnabled=!0,$scope.callback.enabled=$scope.isEnabled,$scope.callback.createIVRStream(null,!0,!0))},$scope.callback.showIvrsettings=$scope.showIvrsettings,$scope.timeIntervels=[],$scope.retriesCount=[];for(var maxTimeinSecs=60,k=1;maxTimeinSecs>=k;k++)$scope.timeIntervels.push(k);for(var j=1;10>=j;j++)$scope.retriesCount.push(j);$scope.callback.enableIvr=function(){$scope.isEnabled=!0},$scope.resetGrammarValue=function(grammar){grammar.value=""},$scope.addGrammar=function(){var grammar={};$scope.newStreamData&&$scope.newStreamData.ivrSettings&&$scope.newStreamData.ivrSettings.enable_transcript?(grammar=angular.copy(_defaultGrammar),grammar.type="disable"):$scope.newStreamData.ivrSettings&&$scope.newStreamData.ivrSettings.grammars&&(grammar=angular.copy(_defaultGrammar),grammar.type="custom"),$scope.newStreamData.ivrSettings.grammars.push(angular.copy(grammar))},$scope.deleteGrammar=function(index){$scope.newStreamData.ivrSettings.grammars.splice(index,1)},$scope.activateNameSearch=function(show){$scope.showValueSearch=!1,show?$scope.showNameSearch=!0:$scope.showNameSearch=!1,$scope.ivr.nameSearchQuery="",$scope.tempProperty=$scope.newStreamData.ivrSettings.properties,setTimeout(function(){$(".focusNameSearch").focus()},100)},$scope.editResponse=function(index){var isChannelSpec=!1,channelId="all";$scope.welcomeMessagecbs.isAddResponseEnabled=!0,$scope.showEnable=!0,$timeout(function(){$scope.modalSlider.open("#vxmlProp"),$scope.welcomeMessagecbs.loadMessage($scope.responseObj,index,isChannelSpec,channelId),$scope.welcomeMessagecbs.openResponseSliderIvr(),$(".welcomeMessageModal").modal("show")},100)},$scope.decodeJS=function(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}},$scope.activateValueSearch=function(show){$scope.showNameSearch=!1,show?$scope.showValueSearch=!0:$scope.showValueSearch=!1,$scope.ivr.nameSearchQuery="",$scope.tempProperty=$scope.newStreamData.ivrSettings.properties,setTimeout(function(){$(".focusValueSearch").focus()},100)},$scope.trackSearch=function(event){27===event.keyCode&&($scope.showValueSearch=!1,$scope.showNameSearch=!1,$scope.ivr.nameSearchQuery="",$scope.tempProperty=$scope.newStreamData.ivrSettings.properties)},$scope.searchRecords=function(key){""!==$scope.ivr.nameSearchQuery&&($scope.showNameSearch||$scope.showValueSearch)?$scope.tempProperty=$scope.tempProperty.filter(function(variable){return"name"===key?0===variable.name.indexOf($scope.ivr.nameSearchQuery):0===variable.value.indexOf($scope.ivr.nameSearchQuery)}):$scope.tempProperty=angular.copy($scope.newStreamData.ivrSettings.properties)},$scope.jsEditorCbs.onFocus=function(){$scope.showProtip=!0},$scope.jsEditorCbs.onBlur=function(){$scope.showProtip=!1},$scope.transcriptToggle=function(enable){enable?"disable"===$scope.newStreamData.ivrSettings.grammars[0].type&&($scope.newStreamData.ivrSettings.grammars[0].type="custom"):$scope.streamdata&&$scope.streamdata.ivrSettings&&$scope.streamdata.ivrSettings.enable_transcript&&""===$scope.newStreamData.ivrSettings.grammars[0].value&&($scope.newStreamData.ivrSettings.grammars[0].type="disable")},$scope.addProperty=function(key){angular.element("#saveBtn").removeClass("zIndex"),"add"==key&&($scope.saveEdit=!1,$scope.showEnable=!0,$timeout(function(){$scope.modalSlider.open("#vxmlProp")},100),$scope.vxmlproperty={},$scope.vxmlproperty.name="",$scope.vxmlproperty.value="")},$scope.editProperty=function(index){$scope.saveEdit=!0,$scope.showEnable=!0,$.each($scope.newStreamData.ivrSettings.properties,function(i,property){index===i&&($scope.editIndex=i,$scope.vxmlproperty=angular.copy(property))}),$timeout(function(){$scope.modalSlider.open("#vxmlProp")},100)},$scope.deleteProperty=function(index){$scope.newStreamData.ivrSettings.properties.splice(index,1),$scope.tempProperty=$scope.newStreamData.ivrSettings.properties,$scope.xmlProperties=$scope.newStreamData.ivrSettings.properties},$scope.createProperty=function(type){return""===$scope.vxmlproperty.name?void NotificationService.notify(i18n.i18nString("valid_property_name"),"error"):""===$scope.vxmlproperty.value?void NotificationService.notify(i18n.i18nString("valid_property_value"),"error"):("new"===type?($scope.newStreamData.ivrSettings.properties.push($scope.vxmlproperty),$scope.tempProperty=$scope.newStreamData.ivrSettings.properties,$scope.xmlProperties=$scope.newStreamData.ivrSettings.properties,$scope.modalSlider.close("#vxmlProp")):"edit"===type&&($scope.newStreamData.ivrSettings.properties[$scope.editIndex]=$scope.vxmlproperty,$scope.tempProperty=$scope.newStreamData.ivrSettings.properties,$scope.xmlProperties=$scope.newStreamData.ivrSettings.properties,$scope.modalSlider.close("#vxmlProp")),$scope.showEnable=!1,$scope.vxmlFlag=!0,void $scope.callback.createIVRStream(null,null,null,$scope.vxmlFlag))},$scope.cancleCreate=function(){$scope.saveEdit||($scope.vxmlproperty.name="",$scope.vxmlproperty.value=""),angular.element("#saveBtn").addClass("zIndex"),$scope.modalSlider.close("#vxmlProp"),$scope.showEnable=!1},BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){var convEnd=res.data.botEvents.CONVERSATION_END;if(convEnd&&convEnd.enabled)if(isConversationEvent=!0,"triggerDialog"===convEnd.action){var dialogName="";$scope.events.config="initiate";for(var i=0;i<$scope.dialogsName.length;i++)if($scope.dialogsName[i].id===convEnd.task){dialogName=$scope.dialogsName[i].name;break}$scope.selected.dialog=dialogName}else"runScript"===convEnd.action?($scope.events.config="runScript",$scope.inp.scriptText=decodeJS(convEnd.script)):"showMsg"===convEnd.action&&($scope.events.config="showMessage",$scope.responseObj=angular.copy(res.data.botEvents.CONVERSATION_END.msg));else res.data.ivrSettings&&res.data.ivrSettings.enable&&($scope.conver.value="terminate")},function(err){}),$scope.deleteMessage=function(response,index){function delMessage(){$scope.isAddRespEdited=!0;for(var i=0;i<$scope.responseObj.length;i++)if(""!==$scope.responseObj[i]._id&&$scope.responseObj[i]._id===response._id&&$scope.responseObj[i].channel===response.channel||$scope.responseObj[i].text===response.text&&$scope.responseObj[i].channel===response.channel){$scope.responseObj.splice(i,1);break}}var numOfAllChannels=$scope.responseObj.filter(function(v){return"default"===v.channel}).length;"default"===response.channel&&1===numOfAllChannels?NotificationService.confirm({msg:i18n.i18nString("channel_mandatory"),successCb:function(){delMessage()},isModal:!0,btnTexts:{success:i18n.i18nString("yes"),fail:i18n.i18nString("no")}}):delMessage()},$scope.callback.createIVRStream=function(event,cb,fromEnable,vxmlFlag){if(event&&event.preventDefault&&event.preventDefault(),"trigger"===$scope.conver.value&&"showMessage"===$scope.events.config){var numOfAllChannels=$scope.responseObj.filter(function(v){return"default"===v.channel}).length;if(0===numOfAllChannels)return void NotificationService.notify(i18n.i18nString("one_channel_res"),"error")}if($scope.ivrSettingsForm&&$scope.ivrSettingsForm.$invalid&&!fromEnable)return void form_util.touch($scope.ivrSettingsForm);var properties=$scope.newStreamData.ivrSettings.properties,timeout=1e3*$scope.newStreamData.ivrSettings.timeout;if($scope.newStreamData.ivrSettings.enable_transcript&&""===$scope.newStreamData.ivrSettings.transcript_tag)return void NotificationService.notify(i18n.i18nString("engine_source"),"error");fromEnableFlag=fromEnable;var btPostData=[];btPostData={ivrSettings:{asrConfidenceThreshold:$scope.newStreamData.ivrSettings.asrConfidenceThreshold,extraction_key:$scope.newStreamData.ivrSettings.extraction_key,enable:$scope.isEnabled,timeout:parseInt(timeout),retry_limit:parseInt($scope.newStreamData.ivrSettings.retry_limit),properties:properties,enable_log:$scope.newStreamData.ivrSettings.enable_log,enable_transcript:$scope.newStreamData.ivrSettings.enable_transcript,transcript_tag:$scope.newStreamData.ivrSettings.transcript_tag,callTerminationHandler:$scope.newStreamData.ivrSettings.callTerminationHandler,bargein:$scope.newStreamData.ivrSettings.bargein,timeoutPrompts:[[angular.extend({type:"text"},$scope.newStreamData.ivrSettings.timeoutPrompts[0][0])]],nomatchPrompts:[[angular.extend({type:"text"},$scope.newStreamData.ivrSettings.nomatchPrompts[0][0])]],grammars:$scope.newStreamData.ivrSettings.grammars}},createBTStream(btPostData,cb,vxmlFlag)},$scope.isFormValid=function(form){},$scope.advancedoptiontext=i18n.i18nString("show_advanced_options"),$scope.$emit("nestedComponentLoaded",{id:"ivrSettings",flag:!1})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btLinkedTask",function(){return{restrict:"EAQ",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-linked-tasks/bt-linked-tasks.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","i18n",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,i18n){function clearAllData(){$scope.editIndex=-1,$scope.currentEntities=[],$scope.showmorePreassign=!1,$scope.showmorePostassign=!1,$scope.ifOperatorList=[{name:"Exists",val:"exst"},{name:"equals to",val:"eq"},{name:"greater than equals to",val:"gte"},{name:"less than equals to",val:"lte"},{name:"not equals to",val:"neq"},{name:"greater than",val:"gt"},{name:"less than",val:"lt"}],$scope.connections=[],$scope.currentEntities=[],$scope.editIndex=-1}$scope.stream=$workflowService.selectedStream(),$scope.selecedStreamState=$workflowService.selectedStreamState(),$scope.taskStreamStateMapping={indevelopment:{configured:!0,awaitingApproval:!0,rejected:!0},published:{published:!0,suspended:!0}},$scope._constants_=$rootScope._constants_,$scope.assetsBase=env_conf["assets-url"],$scope.backArrow=env_conf["context-url"]+"/assets/landingImages/backArrow.png",$scope.createMode=!1,$scope.andif=i18n.i18nString("and_if"),$scope["if"]=i18n.i18nString("if"),$scope.seeall=i18n.i18nString("see_all"),$scope.showless=i18n.i18nString("show_less"),$scope.showStandardResponses=!1,$scope.parentTaskNodes=[],$scope.selectedTask=null,$scope.manageResponseCB={},$scope.linkedTaskavailableNodesNames={mappedIntents:[],entities:[],nodes:[]},$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.ifOperatorList=[{name:"Exists",val:"exst"},{name:"equals to",val:"eq"},{name:"greater than equals to",val:"gte"},{name:"less than equals to",val:"lte"},{name:"not equals to",val:"neq"},{name:"greater than",val:"gt"},{name:"less than",val:"lt"}],$scope.connections=[],$scope.currentEntities=[],$scope.interruptOptions={type:{option:"developer",message:""},holdUxOptions:{option:"holdCurrTask",message:""},resumeUxOptions:{option:"notifyUser",message:"",neverNotify:!1},exitUxOptions:{option:"resumeToTask",resumeToNodeOptions:{nodeId:""}}},$scope.cb.dialogObj&&$scope.cb.dialogObj.followUpIntents&&($scope.cb.tasksList=$scope.cb.dialogObj.followUpIntents,$scope.interruptOptions=$scope.cb.editTask.interruptOptions||$scope.interruptOptions),$scope.contextMap={preassign:[],postassign:[]},$scope.editIndex=-1,$scope.onInterruptOptionsChange=function(priority){$scope.interruptOptions.holdUxOptions=$scope.interruptOptions.holdUxOptions||{option:"holdCurrTask",message:""},$scope.interruptOptions.type=$scope.interruptOptions.type||{option:"developer",message:""},$scope.interruptOptions.resumeUxOptions=$scope.interruptOptions.resumeUxOptions||{option:"notifyUser",message:"",neverNotify:!1},"developer"===$scope.interruptOptions.type.option||"endUser"===$scope.interruptOptions.type.option?$scope.interruptOptions.interruptsEnabled=!0:$scope.interruptOptions.interruptsEnabled=!1,$scope.interruptOptions.exitUxOptions=$scope.interruptOptions.exitUxOptions||{option:"resumeToTask",resumeToNodeOptions:{nodeId:""}}},$scope.getDialogTaskName=function(refId){var _selectedTask=$scope.cb.alldialogTasks.filter(function(task){return task.refId==refId});return _selectedTask[0]?_selectedTask[0].name:""},$scope.clearIfConditionDetails=function(index){$scope.connections[index].entity="",$scope.connections[index].ifOperator="",$scope.connections[index].value="",$scope.connections[index].ifCondition=""},$scope.fetchEntities=function(task,callback){var _taskId=task._id;task.nodes&&task.nodes.length>0&&(task.child&&(_taskId=task.child._id),BTFlowtaskService.getFlowtaskComponents($scope.stream._id,task._id).then(function(res){var _res=res&&res.data||[],_tempComponents=[];$.each(_res,function(k,component){_tempComponents.push(component)}),callback(_tempComponents)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("some_error_occured"),"error")}))},$scope.editLinkedTask=function(editTask,index){$scope.cb.processEntities(),$scope.contextMap.preassign=[],$scope.contextMap.postassign=[],$scope.editIndex=1,$scope.currentEditIndex=index,$scope.createMode=!0;var _selectedNode=null;$scope.currEditTask=angular.copy(editTask);var _selectedTask=$scope.cb.alldialogTasks.filter(function(task){return task.refId==editTask.refId});if($scope.selectedTask=_selectedTask[0]||null,_selectedTask&&_selectedTask.length&&_selectedTask[0].child&&_selectedTask[0].child.length&&($scope.selectedTask=_selectedTask[0].child[0]),("published"===$scope.cb.currFlowTask.state||"suspended"===$scope.cb.currFlowTask.state)&&_selectedTask.length>1){var publishedSelectedTask=_selectedTask.filter(function(task){return"published"==task.state||"suspended"==task.state});publishedSelectedTask&&publishedSelectedTask.length&&($scope.selectedTask=publishedSelectedTask[0]||null)}$scope.selectedTaskId=$scope.selectedTask._id,$scope.fetchEntitiesForCurrentTask($scope.selectedTask._id,!0),editTask.transitions&&(editTask.transitions.length>0&&($scope.connections=[]),editTask.transitions.forEach(function(transition){var _tempObj={};transition["if"].context?(_tempObj.ifConditionPrefix="context",_tempObj.ifCondition=transition["if"].context,_tempObj.ifOperator=transition["if"].op||"",_tempObj.value=transition["if"].value||"",$scope.connections.push(_tempObj)):(_tempObj.ifConditionPrefix="field",_tempObj.ifOperator=transition["if"].op||"",_tempObj.value=transition["if"].value||"",_selectedNode=$scope.cb.currFlowTask.nodes.filter(function(node){return node.nodeId==transition["if"].entity}),_selectedNode=_selectedNode[0]||null,_tempObj.entity=_selectedNode.componentId,$scope.connections.push(_tempObj))})),$scope.interruptOptions=editTask.interruptOptions,$scope.interruptOptions.interruptsEnabled?$scope.interruptOptions.type=editTask.interruptOptions.type:$scope.interruptOptions.type={option:"doNotAllowHoldResume"},$scope.interruptOptions.priority=editTask.interruptOptions.priority||"task",$scope.interruptOptions.holdUxOptions&&($scope.interruptOptions.holdUxOptions.option=editTask.interruptOptions.holdUxOptions.option,$scope.interruptOptions.holdUxOptions.message=editTask.interruptOptions.holdUxOptions.message),editTask.interruptOptions.resumeUxOptions&&($scope.interruptOptions.resumeUxOptions.option=editTask.interruptOptions.resumeUxOptions.option,$scope.interruptOptions.resumeUxOptions.message=editTask.interruptOptions.resumeUxOptions.message,$scope.interruptOptions.resumeUxOptions.neverNotify=editTask.interruptOptions.resumeUxOptions.neverNotify),editTask.interruptOptions.exitUxOptions&&($scope.interruptOptions.exitUxOptions.option=editTask.interruptOptions.exitUxOptions.option,"resumeToNode"===$scope.interruptOptions.exitUxOptions.option&&($scope.interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId=editTask.interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId)),setTimeout(function(){$(".modalBody.btlinkedtask").scrollTop(2)},200)},$scope.cb.processEntities=function(){$scope.contextMap.preassign=[];var _task={};_task=$scope.cb&&$scope.cb.currFlowTask&&$scope.cb.currFlowTask.child?$scope.cb.currFlowTask.child[0]:$scope.cb.currFlowTask,$scope.fetchEntities($scope.cb.currFlowTask,function(nodes){$scope.component={},$scope.nodeObjCount={},$scope.parentTaskNodes=$scope.cb.currFlowTask.nodes,$scope.parentEntities=[],$.each(nodes,function(k,component){$scope.component[component._id]=component,"entity"===component.type&&($scope.parentEntities.push(component),$scope.contextMap.postassign.push({key:component.name,val:"",existed:!0,preDefined:!0,entityId:component._id,refId:component.refId,entityType:component.entityType||""}))}),$.each($scope.parentTaskNodes,function(k,nodeele){$scope.nodeObjCount[nodeele.componentId]||($scope.nodeObjCount[nodeele.componentId]={count:0},$scope.nodeObjCount[nodeele.componentId][nodeele.nodeId]=$scope.nodeObjCount[nodeele.componentId].count),
$scope.nodeObjCount[nodeele.componentId].count=$scope.nodeObjCount[nodeele.componentId].count+1,$scope.nodeObjCount[nodeele.componentId][nodeele.nodeId]=$scope.nodeObjCount[nodeele.componentId].count,nodeele.count=$scope.nodeObjCount[nodeele.componentId].count}),$scope.cb.editTask.interruptOptions.parameterMap.postAssignments.forEach(function(keys,vals){var mapKey="";keys&&Object.keys(keys)&&Object.keys(keys).length&&$.each(keys,function(key,val){"entityId"!==key&&"preDefined"!==key&&"refId"!==key&&(mapKey=key)}),mapKey&&(keys.preDefined?$.each($scope.contextMap.postassign,function(i,value){keys.preDefined&&!keys.entityId&&value.key==mapKey&&($scope.contextMap.postassign[i].val=keys[mapKey]),keys.entityId&&value.entityId!==keys.entityId&&value.key==mapKey&&($scope.contextMap.postassign[i].val=keys[mapKey]),value.entityId===keys.entityId&&($scope.contextMap.postassign[i].val=keys[mapKey])}):keys.preDefined||$scope.contextMap.postassign.push({key:mapKey,val:keys[mapKey],existed:!0,preDefined:keys.preDefined,entityId:keys.entityId||""}))})})},$scope.fetchEntitiesForCurrentTask=function(taskId){var _selectedTask=null;$scope.cb.alldialogTasks.filter(function(task){return task._id==taskId?(_selectedTask=task,!1):task&&task.child&&task.child.length&&task.child[0]._id===taskId?(_selectedTask=task.child[0],!1):void 0});$scope.currentEntities=[];try{_selectedTask=JSON.parse(_selectedTask)}catch(err){}_selectedTask&&($scope.contextMap.preassign=[],$scope.selectedTask=_selectedTask,$scope.fetchEntities(_selectedTask,function(nodes){$scope.currentEntities=[],$.each(nodes,function(k,component){"intent"===component.type&&$scope.firstNodeComponentId!==component._id?$scope.linkedTaskavailableNodesNames.mappedIntents.push(component.name):"entity"===component.type?$scope.linkedTaskavailableNodesNames.entities.push(component.name):$scope.linkedTaskavailableNodesNames.nodes.push(component.name),"entity"===component.type&&component.status===$scope.cb.currFlowTask.state&&($scope.currentEntities.push(component),$scope.contextMap.preassign.push({key:component.name,val:"",existed:!0,preDefined:!0,entityId:component._id,refId:component.refId,entityType:component.entityType||""}))}),$scope.cb.editTask.interruptOptions.parameterMap.preAssignments.forEach(function(keys,vals){var mapKey="";keys&&Object.keys(keys)&&Object.keys(keys).length&&$.each(keys,function(key,val){"entityId"!==key&&"preDefined"!==key&&"refId"!==key&&(mapKey=key)}),mapKey&&(keys.preDefined?$.each($scope.contextMap.preassign,function(i,value){keys.entityId||value.key!=mapKey||($scope.contextMap.preassign[i].val=keys[mapKey]),value.entityId===keys.entityId&&($scope.contextMap.preassign[i].val=keys[mapKey])}):keys.preDefined||$scope.contextMap.preassign.push({key:mapKey,val:keys[mapKey],existed:!0,preDefined:keys.preDefined,entityId:keys.entityId||""}))})}))},$scope.autoGrowTextArea=function(e){var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+1+"px"},$scope.addNewPreAssignment=function(){$workflowService.dialogNodesNames($scope.cb.parentTaskContextdata),$scope.showmorePreassign=!0,$scope.contextMap.preassign.push({key:"",val:"",existed:!1,preDefined:!1}),$(".modalBody.btlinkedtask").animate({scrollTop:$(".postAssignmentLabel").offset().top},1500),setTimeout(function(){$(".preAssignContextDiv input").last().focus()},100)},$scope.deletePreAssignment=function(index){$scope.contextMap.preassign.splice(index,1)},$scope.deletePostAssignment=function(index){$scope.contextMap.postassign.splice(index,1)},$(".preconditionBlock").click(function(){$workflowService.dialogNodesNames($scope.linkedTaskavailableNodesNames)}),$scope.addNewPostAssignment=function(){$workflowService.dialogNodesNames($scope.linkedTaskavailableNodesNames),$scope.showmorePostassign=!0,$scope.contextMap.postassign.push({key:"",val:"",existed:!1,preDefined:!1}),$(".modalBody.btlinkedtask").animate({scrollTop:$(".modalBody.btlinkedtask").height()},1500),setTimeout(function(){$(".postAssignContextDiv input").last().focus()},100)},$scope.closeModal=function(){$(".linkedTasks").modal("hide"),$scope.cb.open=!1},$scope.cancelCreateMode=function(){$scope.createMode=!1,clearAllData()},$scope.goToHome=function(){$scope.$emit("updateInterruptsStep",1),$workflowService.dialogNodesNames($scope.cb.parentTaskContextdata)},$scope.addDefaultConnection=function(){$workflowService.dialogNodesNames($scope.cb.parentTaskContextdata),$scope.connections.push({ifConditionPrefix:"field",entity:"",ifOperator:"",ifCondition:""})},$scope.removeConnection=function(index){$scope.connections.splice(index,1)},$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation(),$scope.manageResponseCB.title=i18n.i18nString("confirm_dialog_Task"),$scope.manageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key];var access="FULL";$scope.cb.viewMode&&(access="VIEW"),setTimeout(function(){$scope.manageResponseCB.openManageResponse(),$scope.manageResponseCB.initMessages(access)},100)},$scope.manageResponseCB.closeResponseScreen=function(){$scope.manageResponseCB.conditionKey={},$scope.showStandardResponses=!1,setTimeout(function(){$(".builderMaincontainer").addClass("bt-modal-open")},300)},$scope.getFocusedAssignmentType=function(type){"preAssign"===type?$workflowService.dialogNodesNames($scope.cb.parentTaskContextdata):"postAssign"===type&&$workflowService.dialogNodesNames($scope.linkedTaskavailableNodesNames)},$scope.diableSaveBtn=function(){for(var i=0;i<$scope.connections.length;i++){if("field"===$scope.connections[i].ifConditionPrefix&&""===$scope.connections[i].entity)return!0;if("context"===$scope.connections[i].ifConditionPrefix&&!$scope.connections[i].ifCondition)return!0}return"resumeToNode"===$scope.interruptOptions.exitUxOptions.option&&""===$scope.interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId?!0:!1},$scope.cb.editTask&&$scope.editLinkedTask($scope.cb.editTask,$scope.cb.editTaskIndex),$scope.getInteruptoptions=function(){var interruptOptions={numTasksToHold:$scope.interruptOptions.numTasksToHold,type:{option:$scope.interruptOptions.type.option,message:"endUser"===$scope.interruptOptions.type.option?$scope._constants_.pauseResumeMessages.allowEndUser.key:""}};if("doNotAllowHoldResume"===interruptOptions.type.option)interruptOptions={type:{option:"developer"},interruptsEnabled:!1};else if(interruptOptions.interruptsEnabled=!0,"developer"===$scope.interruptOptions.type.option&&(interruptOptions.holdUxOptions={option:$scope.interruptOptions.holdUxOptions.option,message:""},"discardCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.discardCurrentTask.key:"continueCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.continueCurrentTask.key:interruptOptions.holdUxOptions.message=""),(interruptOptions.holdUxOptions&&"holdCurrTask"===interruptOptions.holdUxOptions.option||"endUser"===$scope.interruptOptions.type.option)&&(interruptOptions.resumeUxOptions={option:$scope.interruptOptions.resumeUxOptions.option||"confFromUser",message:""},$scope.interruptOptions&&$scope.interruptOptions.resumeUxOptions&&$scope.interruptOptions.resumeUxOptions.neverNotify?interruptOptions.resumeUxOptions.neverNotify=$scope.interruptOptions.resumeUxOptions.neverNotify:interruptOptions.resumeUxOptions.neverNotify=!1,"confFromUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.getConfirmatonWithUser.key:"notifyUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.notifyUserWithMessage.key:interruptOptions.resumeUxOptions.message=""),(interruptOptions.holdUxOptions&&"holdCurrTask"===$scope.interruptOptions.holdUxOptions.option||"endUser"===$scope.interruptOptions.type.option)&&(interruptOptions.exitUxOptions={},interruptOptions.exitUxOptions.option=$scope.interruptOptions.exitUxOptions.option,"resumeToNode"===$scope.interruptOptions.exitUxOptions.option)){if(""===$scope.interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId)return void NotificationService.notify(i18n.i18nString("exit_behavior_details"),"error");interruptOptions.exitUxOptions.resumeToNodeOptions={},interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId=$scope.interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId}return interruptOptions},$scope.addLinkedTask=function(key){var payload={refId:$scope.selectedTask.refId,transitions:[]};payload.interruptOptions=$scope.getInteruptoptions(),payload.interruptOptions.parameterMap={},payload.interruptOptions.parameterMap.preAssignments=[],payload.interruptOptions.parameterMap.postAssignments=[];var _obj={};$scope.contextMap.preassign.forEach(function(assignment){_obj={},_obj[assignment.key]=assignment.val,_obj.preDefined=assignment.preDefined,_obj.entityId=assignment.entityId||"",_obj.refId=assignment.refId||"",""!==assignment.key&&payload.interruptOptions.parameterMap.preAssignments.push(_obj)}),$scope.contextMap.postassign.forEach(function(assignment){_obj={},_obj[assignment.key]=assignment.val,_obj.preDefined=assignment.preDefined,_obj.entityId=assignment.entityId||"",_obj.refId=assignment.refId||"",""!==assignment.key&&payload.interruptOptions.parameterMap.postAssignments.push(_obj)});for(var i=0;i<$scope.connections.length;i++)if("context"===$scope.connections[i].ifConditionPrefix)$scope.connections[i].ifCondition&&""!==$scope.connections[i].ifCondition&&""!==$scope.connections[i].ifOperator&&("exst"===$scope.connections[i].ifOperator?payload.transitions.push({"if":{context:$scope.connections[i].ifCondition,op:$scope.connections[i].ifOperator||"",value:""}}):($scope.connections[i].value||""!==$scope.connections[i].value)&&payload.transitions.push({"if":{context:$scope.connections[i].ifCondition,op:$scope.connections[i].ifOperator||"",value:$scope.connections[i].value||""}}));else if($scope.selectedTask){var _selectedNode=$scope.cb.currFlowTask.nodes.filter(function(node){return node.componentId==$scope.connections[i].entity});_selectedNode.length&&""!==$scope.connections[i].ifOperator&&("exst"===$scope.connections[i].ifOperator?(_selectedNode=_selectedNode[0]||null,payload.transitions.push({"if":{entity:_selectedNode.nodeId,op:$scope.connections[i].ifOperator||"",value:""}})):($scope.connections[i].value||""!==$scope.connections[i].value)&&(_selectedNode=_selectedNode[0]||null,payload.transitions.push({"if":{entity:_selectedNode.nodeId,op:$scope.connections[i].ifOperator||"",value:$scope.connections[i].value||""}})))}setTimeout(function(){var _payloadObj=[];_payloadObj=_payloadObj.concat($scope.cb.tasksList),_payloadObj[$scope.currentEditIndex]=payload,BTFlowtaskService.addlinkedtasks($scope.stream._id,$scope.cb.currFlowTask._id,_payloadObj).then(function(res){res&&res.data&&($scope.cb.updateFollowUpIntents($scope.cb.currFlowTask,res.data.followUpIntents),$scope.goToHome(),NotificationService.notify(i18n.i18nString("exceptions"),"success"),$scope.cb.currFlowTask.followUpIntents=res.data.followUpIntents||[],$scope.cb.tasksList=$scope.cb.currFlowTask.followUpIntents||[],key||$scope.cancelCreateMode())},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_exception"),"error")})},500)}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btAddInteruption",function(){return{restrict:"EAQ",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-manage-interruption/bt-add-interruption.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","i18n",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,i18n){function clearAllData(){$scope.cb.suggestedIntent=null,$scope.editIndex=-1,$scope.contextMap.preassign=[],$scope.currentEntities=[],$scope.showmorePreassign=!1,$scope.showmorePostassign=!1,$scope.connections=[],$scope.currentEntities=[]}$scope.stream=$workflowService.selectedStream(),$scope._constants_=$rootScope._constants_,$scope.assetsBase=env_conf["assets-url"],$scope.backArrow=env_conf["context-url"]+"/assets/icons/rightArrow.svg",$scope.createMode=!1,$scope.showStandardResponses=!1,$scope.parentTaskNodes=[],$scope.selectedTask=null,$scope.manageResponseCB={},$scope.taskSelect={selectedTaskIds:""},$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.ifOperatorList=[{name:"Exists",val:"exst"},{name:"equals to",val:"eq"},{name:"greater than equals to",val:"gte"},{name:"less than equals to",val:"lte"},{name:"not equals to",val:"neq"},{name:"greater than",val:"gt"},{name:"less than",val:"lt"}],$scope.selectedTasks=[],$scope.connections=[],$scope.currentEntities=[],$scope.interruptOptions={interruptsEnabled:!0,type:{option:"developer",message:""},holdUxOptions:{option:"holdCurrTask",message:""},resumeUxOptions:{option:"notifyUser",message:"",neverNotify:!1},exitUxOptions:{option:"resumeToTask",resumeToNodeOptions:{nodeId:""}}},$scope.contextMap={preassign:[],postassign:[]},$scope.fetchEntities=function(task,callback){task.nodes&&task.nodes.length>0&&BTFlowtaskService.getFlowtaskComponents($scope.stream._id,task._id).then(function(res){var _res=res&&res.data||[],_tempComponents=[];$.each(_res,function(k,component){_tempComponents.push(component)}),callback(_tempComponents)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("some_error_occured"),"error")})},$scope.cb.processEntities=function(){$scope.contextMap.preassign=[],$scope.fetchEntities($scope.cb.currFlowTask,function(nodes){$scope.parentTaskNodes=nodes,$scope.parentEntities=[],$.each(nodes,function(k,component){"entity"===component.type&&($scope.parentEntities.push(component),$scope.contextMap.postassign.push({key:component.name,val:"",existed:!0,preDefined:!0,entityId:component._id}))})})},$scope.cb.processEntities(),$scope.prepareDialogData=function(){$scope.cb.alldialogTasks?$scope.dialogListDropDown=_.uniq($scope.cb.alldialogTasks,"refId"):$scope.dialogListDropDown=[]},$scope.prepareDialogData(),$scope.getDialogTaskName=function(refId){var _selectedTask=$scope.cb.alldialogTasks.filter(function(task){return task.refId==refId});return _selectedTask[0]?_selectedTask[0].name:""},$scope.selectedIds=[],$("select").on("keydown",function(e){return 37===e.keyCode||38===e.keyCode||39===e.keyCode||40===e.keyCode?(e.preventDefault(),!1):void 0}),$scope.selectTasks=function(refId,suggestedIntent){if(""!==refId){var _selectedTask=_.find($scope.cb.alldialogTasks,function(task){return task.refId===refId});suggestedIntent||($scope.taskSelect.selectedTaskIds=""),_selectedTask&&$scope.selectedTasks.push(_selectedTask)}},$scope.cb&&$scope.cb.suggestedIntent&&($scope.taskSelect.selectedTaskIds=$scope.cb.suggestedIntent.dialogRefId,$scope.selectTasks($scope.cb.suggestedIntent.dialogRefId,!0)),$scope.delTask=function(index){$scope.selectedTasks.splice(index,1)},$scope.onInterruptOptionsChange=function(priority){"task"===$scope.interruptOptions.priority&&($scope.interruptOptions.holdUxOptions=$scope.interruptOptions.holdUxOptions||{option:"holdCurrTask",message:""},$scope.interruptOptions.type=$scope.interruptOptions.type||{option:"developer",message:""},$scope.interruptOptions.resumeUxOptions=$scope.interruptOptions.resumeUxOptions||{option:"notifyUser",message:"",neverNotify:!1},"developer"===$scope.interruptOptions.type.option||"endUser"===$scope.interruptOptions.type.option?$scope.interruptOptions.interruptsEnabled=!0:$scope.interruptOptions.interruptsEnabled=!1)},$scope.autoGrowTextArea=function(e){var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+1+"px"},$scope.cancelCreateMode=function(){$scope.createMode=!1,clearAllData()},$scope.addTask=function(){$scope.selectedTaskId="",$scope.selectedTask=null,clearAllData(),$scope.createMode=!0,setTimeout(function(){$(".modalBody.btlinkedtask").scrollTop(2)},200),$scope.contextMap.postassign=[],$scope.parentEntities=[],$.each($scope.parentTaskNodes,function(k,component){"entity"===component.type&&($scope.parentEntities.push(component),$scope.contextMap.postassign.push({key:component.name,val:"",existed:!0,preDefined:!0,entityId:component._id}))})},$scope.goToHome=function(){$scope.cb.suggestedIntent=null,$scope.$emit("updateInterruptsStep",1)},$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation(),$scope.manageResponseCB.title=i18n.i18nString("confirm_dialog_Task"),$scope.manageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key];var access="FULL";$scope.cb.viewMode&&(access="VIEW"),setTimeout(function(){$scope.manageResponseCB.openManageResponse(),$scope.manageResponseCB.initMessages(access)},100)},$scope.manageResponseCB.closeResponseScreen=function(){$scope.manageResponseCB.conditionKey={},$scope.showStandardResponses=!1,setTimeout(function(){$(".builderMaincontainer").addClass("bt-modal-open")},300)},$scope.diableSaveBtn=function(){return"resumeToNode"===$scope.interruptOptions.exitUxOptions.option&&""===$scope.interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId?!0:!1},$scope.getInteruptoptions=function(){var interruptOptions={numTasksToHold:$scope.interruptOptions.numTasksToHold,type:{option:$scope.interruptOptions.type.option,message:"endUser"===$scope.interruptOptions.type.option?$scope._constants_.pauseResumeMessages.allowEndUser.key:""}};if("doNotAllowHoldResume"===interruptOptions.type.option)interruptOptions={type:{option:"developer"},interruptsEnabled:!1};else if(interruptOptions.interruptsEnabled=!0,"developer"===$scope.interruptOptions.type.option&&(interruptOptions.holdUxOptions={option:$scope.interruptOptions.holdUxOptions.option,message:""},"discardCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.discardCurrentTask.key:"continueCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.continueCurrentTask.key:interruptOptions.holdUxOptions.message=""),(interruptOptions.holdUxOptions&&"holdCurrTask"===interruptOptions.holdUxOptions.option||"endUser"===$scope.interruptOptions.type.option)&&(interruptOptions.resumeUxOptions={option:$scope.interruptOptions.resumeUxOptions.option||"confFromUser",message:""},$scope.interruptOptions&&$scope.interruptOptions.resumeUxOptions&&$scope.interruptOptions.resumeUxOptions.neverNotify?interruptOptions.resumeUxOptions.neverNotify=$scope.interruptOptions.resumeUxOptions.neverNotify:interruptOptions.resumeUxOptions.neverNotify=!1,"confFromUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.getConfirmatonWithUser.key:"notifyUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.notifyUserWithMessage.key:interruptOptions.resumeUxOptions.message=""),("holdCurrTask"===$scope.interruptOptions.holdUxOptions.option||"endUser"===$scope.interruptOptions.type.option)&&(interruptOptions.exitUxOptions={},interruptOptions.exitUxOptions.option=$scope.interruptOptions.exitUxOptions.option,"resumeToNode"===$scope.interruptOptions.exitUxOptions.option)){if(""===$scope.interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId)return void NotificationService.notify(i18n.i18nString("exit_behavior_details"),"error");interruptOptions.exitUxOptions.resumeToNodeOptions={};var _currSelectedNode=$scope.cb.currFlowTask.nodes.filter(function(node){return node.componentId===$scope.interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId});_currSelectedNode=_currSelectedNode[0]||null,_currSelectedNode&&(interruptOptions.exitUxOptions.resumeToNodeOptions.nodeId=_currSelectedNode.nodeId)}return interruptOptions},$scope.addLinkedTask=function(key){var payload={};payload.interruptOptions=$scope.getInteruptoptions(),payload.interruptOptions.parameterMap={},payload.interruptOptions.parameterMap.preAssignments=[],payload.interruptOptions.parameterMap.postAssignments=[],$scope.contextMap.postassign.forEach(function(assignment){var _obj={};_obj[assignment.key]=assignment.val,_obj.preDefined=assignment.preDefined,_obj.entityId=assignment.entityId,""!==assignment.key&&payload.interruptOptions.parameterMap.postAssignments.push(_obj)}),setTimeout(function(){var _payloadObj=[];_payloadObj=_payloadObj.concat($scope.cb.tasksList),$.each($scope.selectedTasks,function(i,task){var obj={};obj.interruptOptions=angular.copy(payload.interruptOptions),obj.refId=angular.copy(task.refId),_payloadObj.push(angular.copy(obj))}),BTFlowtaskService.addlinkedtasks($scope.stream._id,$scope.cb.currFlowTask._id,_payloadObj).then(function(res){res&&res.data&&(NotificationService.notify(i18n.i18nString("exceptions_added"),"success"),$scope.cb.currFlowTask.followUpIntents=res.data.followUpIntents||[],$scope.cb.tasksList=$scope.cb.currFlowTask.followUpIntents||[],key||$scope.cancelCreateMode(),$scope.goToHome())},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_adding_exceptions"),"error")})},500)}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btManageInteruptions",function(){return{restrict:"EAQ",scope:{cb:"=",onCancel:"=",stepUpdate:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-manage-interruption/bt-manage-interruption.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","form_util","i18n",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,form_util,i18n){function saveDialogSettings(settings){var _params={};_params.streamId=$workflowService.selectedStream()._id,_params.name=$scope.settings.name,_params.shortDesc=$scope.settings.shortDesc,_params.visibility=$scope.configData.dialogObj.visibility,_params.interruptOptions=$scope.getInteruptoptions(),BTFlowtaskService.updateFlowtask($workflowService.selectedStream()._id,$scope.configData.dialogObj._id,_params).then(function(res){$scope.configData.dialogObj=res&&res.data,res&&res.data&&(NotificationService.notify(i18n.i18nString("interruptions"),"success",2e3),$scope.cb.updateDialog(res.data))},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function getComponents(){$scope.thisDialogNodes=[],BTFlowtaskService.getComponents($scope.stream._id).then(function(res){$scope.dialogComponents=res&&res.data,$.each($scope.objectList,function(j,objectList){var currentNode=_.find($scope.dialogComponents,function(node){return objectList.componentId===node._id});currentNode&&$scope.thisDialogNodes.push(currentNode)}),updateContextDialogInfo()},function(error){NotificationService.notify(i18n.i18nString("error_dialog_components"),"error")})}function updateContextDialogInfo(){$scope.availableNodesNames={nodes:[],entities:[],mappedIntents:[]},$.each($scope.thisDialogNodes,function(k,obj){"intent"===obj.type&&$scope.firstNodeComponentId!==obj._id?$scope.availableNodesNames.mappedIntents.push(obj.name):"entity"===obj.type?$scope.availableNodesNames.entities.push(obj.name):$scope.availableNodesNames.nodes.push(obj.name)}),$scope.availableNodesNames.mappedIntents=_.uniq($scope.availableNodesNames.mappedIntents),$scope.availableNodesNames.entities=_.uniq($scope.availableNodesNames.entities),$scope.availableNodesNames.nodes=_.uniq($scope.availableNodesNames.nodes),$workflowService.dialogNodesNames($scope.availableNodesNames)}$scope.configData=$scope.cb;var userInform=window.localStorage.getItem("jStorage");userInform&&(userInform=JSON.parse(userInform)),userInform&&userInform.currentAccount&&userInform.currentAccount.userInfo&&userInform.currentAccount.userInfo.personalInfo&&userInform.currentAccount.userInfo.personalInfo.language&&"ja"===userInform.currentAccount.userInfo.personalInfo.language&&$("#continueCurrTaskNode").length&&$("#continueCurrTaskNode").parent()&&$("#continueCurrTaskNode").parent().parent()&&$("#continueCurrTaskNode").parent().parent().addClass("japaneseManageinterruption"),$scope.stream=$workflowService.selectedStream(),$scope.selectedStreamState=$workflowService.selectedStreamState(),$scope._constants_=$rootScope._constants_,$scope.manageResponseCB={},$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.showStandardResponses=!1,$scope.hasContextConditions=!1,$scope.cb.tasksList=[],$scope.taskskByState={indevelopment:{},published:{}},$scope.taskStateKeys={configured:"indevelopment",awaitingApproval:"indevelopment",rejected:"indevelopment",published:"published",suspended:"published"},$scope.ifOperatorList=[{name:"exists",val:"exst"},{name:"equals to",val:"eq"},{name:"greater than equals to",val:"gte"},{name:"less than equals to",val:"lte"},{name:"not equals to",val:"neq"},{name:"greater than",val:"gt"},{name:"less than",val:"lt"}],$scope.allInterruptOptions={developer:i18n.i18nString("Allow_interruptions_label"),"false":i18n.i18nString("Donot_allow_interrptions_label"),endUser:i18n.i18nString("Allow_the_end_user"),holdCurrTask:i18n.i18nString("Hold_the_curr_label"),discardCurrTask:i18n.i18nString("allinterruptions_discardcurrtask"),continueCurrTask:i18n.i18nString("allinterruptions_continuecurrtask"),confFromUser:i18n.i18nString("allinterruptions_conffromuser"),notifyUser:i18n.i18nString("allinterruptions_notifyuser"),noConfFromUser:i18n.i18nString("allinterruptions_noconffromuser"),discardCurrTaskNoNotify:i18n.i18nString("allinterruptions_discardtasknonotify")},$scope.getIntentSuggestions=function(){BTFlowtaskService.getIntentSuggestions($workflowService.selectedStream()._id,$scope.configData.dialogObj._id).then(function(res){$scope.intentSuggestions=res.data||[],$scope.intentSuggestions.length?$scope.hasContextConditions=!0:$scope.hasContextConditions=!1},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.getIntentSuggestions(),$scope.getInteruptoptions=function(){var interruptOptions={numTasksToHold:$scope.interruptOptions.numTasksToHold,type:{option:$scope.interruptOptions.type.option,message:"endUser"===$scope.interruptOptions.type.option?$scope._constants_.pauseResumeMessages.allowEndUser.key:""}};return"task"===$scope.interruptOptions.priority?(interruptOptions.priority="task","doNotAllowHoldResume"===interruptOptions.type.option?interruptOptions={type:{option:"developer"},interruptsEnabled:!1,priority:"task"}:(interruptOptions.interruptsEnabled=!0,"developer"===$scope.interruptOptions.type.option&&(interruptOptions.holdUxOptions={option:$scope.interruptOptions.holdUxOptions.option,message:""},"discardCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.discardCurrentTask.key:"continueCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.continueCurrentTask.key:interruptOptions.holdUxOptions.message=""),(interruptOptions.holdUxOptions&&"holdCurrTask"===interruptOptions.holdUxOptions.option||"endUser"===$scope.interruptOptions.type.option)&&(interruptOptions.resumeUxOptions={option:$scope.interruptOptions.resumeUxOptions.option||"confFromUser",message:""},$scope.interruptOptions&&$scope.interruptOptions.resumeUxOptions&&$scope.interruptOptions.resumeUxOptions.neverNotify?interruptOptions.resumeUxOptions.neverNotify=$scope.interruptOptions.resumeUxOptions.neverNotify:interruptOptions.resumeUxOptions.neverNotify=!1,"confFromUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.getConfirmatonWithUser.key:"notifyUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.notifyUserWithMessage.key:interruptOptions.resumeUxOptions.message=""))):interruptOptions={priority:"bot"},interruptOptions},$scope.onInterruptOptionsChange=function(priority){"task"===$scope.interruptOptions.priority&&($scope.interruptOptions.holdUxOptions=$scope.interruptOptions.holdUxOptions||{option:"holdCurrTask",message:""},$scope.interruptOptions.type=$scope.interruptOptions.type||{option:"developer",message:""},$scope.interruptOptions.resumeUxOptions=$scope.interruptOptions.resumeUxOptions||{option:"notifyUser",message:"",neverNotify:!1},"developer"===$scope.interruptOptions.type.option||"endUser"===$scope.interruptOptions.type.option?$scope.interruptOptions.interruptsEnabled=!0:$scope.interruptOptions.interruptsEnabled=!1),saveDialogSettings()},$scope.removeLinkedTask=function(editTask,event,index){event.stopImmediatePropagation(),event.stopPropagation(),event.preventDefault();var _payloadObj=[];$scope.cb.tasksList.splice(index,1),_payloadObj=_payloadObj.concat($scope.cb.tasksList),BTFlowtaskService.addlinkedtasks($scope.stream._id,$scope.cb.currFlowTask._id,_payloadObj).then(function(res){res&&res.data&&(NotificationService.notify(i18n.i18nString("exception_deleted"),"success"),$scope.cb.currFlowTask.followUpIntents=res.data.followUpIntents||[],$scope.cb.tasksList=$scope.cb.currFlowTask.followUpIntents||[],$scope.getIntentSuggestions())},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_delete_exception"),"error")})},$scope.updateStep=function(stepNo){$scope.$emit("updateInterruptsStep",stepNo)},$scope.getDialogTaskName=function(refId){var _selectedTask=$scope.cb.alldialogTasks.filter(function(task){return task.refId===refId});return _selectedTask[0]?_selectedTask[0].name:""},$scope.addTask=function(){$scope.updateStep(3)},$scope.prepareTaskCatagory=function(){$scope.taskskByState={indevelopment:{},published:{}};var dialogTasks=$workflowService.dialogTasksByState();dialogTasks&&dialogTasks.length&&$.each(dialogTasks,function(i,task){"configured"===task.state||"awaitingApproval"===task.state||"rejected"===task.state?$scope.taskskByState.indevelopment[task.refId]=task:$scope.taskskByState.published[task.refId]=task})},$scope.prepareTaskCatagory(),$scope.openEditLinkedTask=function(editTask,index){("published"!==$scope.cb.currFlowTask.state||editTask&&$scope.taskStateKeys[$scope.cb.currFlowTask.state]&&$scope.taskskByState[$scope.taskStateKeys[$scope.cb.currFlowTask.state]]&&$scope.taskskByState[$scope.taskStateKeys[$scope.cb.currFlowTask.state]][editTask.refId])&&($scope.cb.editTask=angular.copy(editTask),
$scope.cb.editTaskIndex=index,$scope.cb.parentTaskContextdata=angular.copy($scope.availableNodesNames)||$workflowService.dialogNodesNames(),$scope.updateStep(2))},$scope.defineSuggestedIntent=function(suggestedIntent,index){$scope.cb.suggestedIntent=suggestedIntent,$scope.updateStep(3)},$scope.init=function(){$scope.tasksLoading=!0,$scope.interruptOptions={interruptsEnabled:!1,priority:"bot",type:{option:"developer",message:""},holdUxOptions:{option:"holdCurrTask",message:""},resumeUxOptions:{option:"notifyUser",message:"",neverNotify:!1}},$scope.settings=angular.copy($scope.configData.dialogObj||{}),$scope.interruptOptions=$scope.settings.interruptOptions||$scope.interruptOptions,$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.warnIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/errorWarning.svg","bot"===$scope.interruptOptions.priority||$scope.interruptOptions.interruptsEnabled||($scope.interruptOptions.type={option:"doNotAllowHoldResume"}),$scope.cb.alldialogTasks=[],$scope.cb.tasksList=$scope.cb.currFlowTask.followUpIntents||[],$scope.cb.alldialogTasks=angular.copy($scope.cb.dialogTasks)},$scope.objectList=angular.copy($scope.cb.currFlowTask.nodes),getComponents(),$scope.showTask=function(taskId){if(1===$scope.editIndex)return!0;for(var i=0;i<$scope.cb.tasksList.length;i++)if($scope.cb.tasksList[i].refId===taskId)return!1;return!0},$scope.init(),$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation(),$scope.manageResponseCB.title=i18n.i18nString("confirm_dialog_task"),$scope.manageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key];var access="FULL";$scope.cb.viewMode&&(access="VIEW"),setTimeout(function(){var _btnValue="close";$scope.manageResponseCB.openManageResponse(_btnValue),$scope.manageResponseCB.initMessages(access)},100)},$scope.fetchEntities=function(task,callback){task.nodes&&task.nodes.length>0&&BTFlowtaskService.getFlowtaskComponents($scope.stream._id,task._id).then(function(res){var _res=res&&res.data||[],_tempComponents=[];$.each(_res,function(k,component){_tempComponents.push(component)}),callback(_tempComponents)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("some_error_occured"),"error")})},$scope.getTransitionText=function(transition,task,index){var msg="",operator={};if(transition["if"].hasOwnProperty("context")&&(operator=_.find($scope.ifOperatorList,function(list){return list.val===transition["if"].op?list:void 0}),operator||(operator={name:""}),msg=" If "+transition["if"].context+" "+operator.name+" "+transition["if"].value+" "),transition["if"].hasOwnProperty("entity")){operator=_.find($scope.ifOperatorList,function(operator){return operator.val===transition["if"].op?operator.name:void 0}),operator||(operator={name:""});var _selectedNode=$scope.cb.currFlowTask.nodes.filter(function(node){return node.nodeId==transition["if"].entity});_selectedNode=_selectedNode[0]||null;var currentNode=_.find($scope.dialogComponents,function(node){return _selectedNode.componentId===node._id});msg=currentNode?"If "+currentNode.name+" "+operator.name+" "+transition["if"].value+" ":"If "+transition["if"].entity+" "+operator.name+" "+transition["if"].value+" "}return msg},$scope.goToHome=function(){$scope.onCancel()},$scope.manageResponseCB.closeResponseScreen=function(){$scope.manageResponseCB.conditionKey={},$scope.showStandardResponses=!1,setTimeout(function(){$(".builderMaincontainer").addClass("bt-modal-open")},300)},$scope.saveSettings=function(form){saveDialogSettings($scope.settings)}}]}})}(angular),function(ng){var _btMlSynonymsPatterns=ng.module("bt-forms");_btMlSynonymsPatterns.directive("btMlSynonymsPatterns",function(){return{restrict:"EA",scope:{taskDetails:"=",synonyms:"=",formNoIntent:"@?",trainBot:"&",nlpText:"=?",trainUtterance:"=?",universalBot:"=",getAlltasks:"&",allTraits:"=",winingIntent:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-ml-synonyms-patterns/bt-ml-synonyms-patterns.html",controller:"btMlSynonymsPatternsController"}}),_btMlSynonymsPatterns.controller("btMlSynonymsPatternsController",["$scope","$element","$timeout","_constants_","$rootScope","BTStreamsService","BTFlowtaskService","$workflowService","$q","BTActionsService","BTAlertsService","NotificationService","env_conf","$filter","i18n","$sce","mixPanel",function($scope,$element,$timeout,_constants_,$rootScope,BTStreamsService,BTFlowtaskService,$workflowService,$q,BTActionsService,BTAlertsService,NotificationService,env_conf,$filter,i18n,$sce,mixPanel){function getComponents(cmpId){$scope.taskDetails.task_patterns=[];var currStreamId=angular.copy(streamId);$scope.universalBot&&$scope.taskDetails&&(currStreamId=$scope.taskDetails.streamId),BTFlowtaskService.getComponents(currStreamId,cmpId).then(function(res){res.data&&($scope.traitRules=angular.copy(res.data),$scope.traitRules.traitMappings=angular.copy(res.data.traitRules)||[]),res.data&&res.data.patterns&&($scope.taskDetails.task_patterns=preparePatternObject(res.data))},function(error){})}function saveTaskSynonyms(streamId,name,synonyms,forStream){var payload={},deferred=$q.defer(),currStreamId=$scope.stream._id;return $scope.universalBot&&$scope.taskDetails&&(currStreamId=$scope.taskDetails.streamId),forStream?(synonyms=angular.copy($scope.synonyms),synonyms=transformSynonymsToObject(synonyms),BTStreamsService.postSynonyms(currStreamId,{synonyms:synonyms}).then(function(res){return $workflowService.selectedStream(res.data),$workflowService.nlpStream(res.data),mergeNewSyonymsToLocalStream(res.data.synonyms),transformBotSynonyms(!0),deferred.resolve(res)},function(err){return $q.reject(err)})):(payload[name.toLowerCase()]=synonyms,BTStreamsService.postSynonyms(streamId,{synonyms:payload}).then(function(res){return $workflowService.selectedStream(res.data),$workflowService.nlpStream(res.data),mergeNewSyonymsToLocalStream(res.data.synonyms),transformBotSynonyms(!0),deferred.resolve(res)},function(err){return $q.reject(err)}))}function mergeNewSyonymsToLocalStream(synonyms){synonyms=synonyms||{},$scope.stream.synonyms=$scope.stream.synonyms||{},Object.keys(synonyms).map(function(key){$scope.stream.synonyms[key]=synonyms[key]})}function transformSynonymsToObject(synonyms){var result={};return synonyms.map(function(synonym){result[synonym.key]=synonym.value}),result}function transformBotSynonyms(dontAssignTosynonyms){synonyms=[],Object.keys($scope.stream.synonyms||{}).map(function(key){var obj={};obj.key=key,obj.value=$scope.constants.getAlphabeticallySortedArray($scope.stream.synonyms[key]),synonyms.push(angular.copy(obj))}),dontAssignTosynonyms||($scope.synonyms=angular.copy(synonyms)),$scope.oldSynonyms=angular.copy(synonyms)}function saveEditedUtterance(payload,index){BTStreamsService.editUtterances(payload,$scope.utterences[index]._id).then(function(res){finishSaving(".utteranceInput"+$scope.utterences[index]._id),NotificationService.notify(i18n.i18nString("utterences_update_sucess_noty"),"info"),$scope.utterencesCopy[index].sentence=$scope.utterences[index].sentence,$scope.entityCmpt.fromEdit=!0,$scope.utterences[index].sentence=res.data.sentence,$scope.utterences[index].entities=res.data.entities||[],mapColorEntityToWord($scope.utterences[index]),setTimeout(function(){$scope.editId=-1},500)},function(err){409===err.status&&(finishSaving(".utteranceInput"+$scope.utterences[index]._id,"error"),$scope.utterences[index].sentence=$scope.utterencesCopy[index].sentence,$scope.editThis(index),NotificationService.notify(i18n.i18nString("utterences_dupli_err_noty"),"error"),setTimeout(function(){$scope.editId=-1},500))})}function startSaving(className){$element.find(className).closest(".utterance-spin").show(),$scope.editSaveText="Saving...",$element.find(className).addClass("fa fa-refresh fa-spin")}function finishSaving(className,isError){$element.find(className).removeClass("fa fa-refresh fa-spin"),"error"===isError?($scope.editSaveText="",$element.find(className).addClass("fa fa-times")):($scope.editSaveText="Saved",$element.find(className).addClass("fa fa-check")),setTimeout(function(){$scope.editSaveText="",$element.find(className).removeClass("fa fa-check fa-times"),$element.find(className).closest(".utterance-spin").hide()},3e3)}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createUtterance"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Utterance Added"),"createPattern"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Pattern Added"),"createTraits"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Rule Added"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function preparePatternObject(component){return component.patterns.map(function(pattern,index){pattern.intend=component.intent,pattern.key=index}),component.patterns}function getColorByEntity(entityName){return entityColors[entityName]?entityColors[entityName]:(entityColors[entityName]=$scope.constants.entityColors[Math.floor(12*Math.random())+1],entityColors[entityName])}function mapColorEntityToWord(utterance){function getSentenceByEntity(triplets,str){String.prototype.replaceBetween=function(start,end,what){var value=this.substring(0,start+1)+what+this.substring(end);return value},triplets.sort(function(a,b){return b[0]-a[0]});for(var triplet,ii=0;triplet=triplets[ii];ii++){var result=mapIndex(triplet[0],triplet[1],ii,triplets);result&&(str=str.replaceBetween(triplet[0]-1,triplet[1],triplet[2]))}return str}if($scope.constants.config.hideMLEE)return!1;if(utterance.entities&&utterance.entities.length){var _parentArray=[];$.each(utterance.entities,function(i,entity){var _childArray=[entity.startIndex,entity.endIndex,'<span contenteditable="true" class="spantags" entityIndex="'+i+'" startIndex="'+entity.startIndex+'" endIndex="'+entity.endIndex+'"  entityId="'+entity.entityId+'" style="cursor:pointer;font-weight:bold;color:'+getColorByEntity(entity.entityName)+'">'+utterance.sentence.substring(entity.startIndex,entity.endIndex)+"</span>"];_parentArray.push(_childArray)}),utterance.sentence=getSentenceByEntity(_parentArray,utterance.sentence),$("#"+utterance._id).html(utterance.sentence)}else $("#"+utterance._id).html(utterance.sentence)}function getUtterances(){$scope.moreAvailable?BTStreamsService.getUtterances(getTaskID(),0,500).then(function(res){focusInputEle(),$timeout(function(){$("#utterance-text").focus()},1e3),$scope.utterences=[],res.data.Sentences=_.filter(res.data.Sentences,function(sentence){return!sentence.isAutoAdded}),$scope.utterences=$scope.utterences.concat(res.data.Sentences),$.each($scope.utterences,function(i,utterance){mapColorEntityToWord(utterance)}),$scope.utterencesCopy=angular.copy($scope.utterences),$scope.moreAvailable=!0,$scope.count=res.data.count,$scope.fetching=!1},function(err){$scope.fetching=!1}):$scope.fetching=!1}function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}$scope.newPattern={},$scope.stream=$workflowService.selectedStream(),$scope.newUtterance={};var streamId=$scope.stream._id;$scope.assetsBase=env_conf["assets-url"],$scope.intentTabs=[{name:i18n.i18nString("Utterances"),id:"machineLearning"},{name:i18n.i18nString("rule_base"),id:"synonymsPatterns"}],$scope.constants=_constants_,$scope.activeType="synonymsPatterns",$scope.entityCallbacks={},$scope.entityCmpt={},$scope.entityCmpt.showentityDropdown=!1,$scope.entityCmpt.fromEdit=!1,$scope.entityCmpt.offsetObject={},$scope.showMoreUtterances=!1,$scope.showMorePatterns=!1,$scope.trainingLabel=i18n.i18nString("training_label"),$scope.save=i18n.i18nString("save"),$scope.placeholderMsg=i18n.i18nString("type_and__enter_placeholder"),$scope.finishedFetching=!1,$scope.closeIconDark=$scope.assetsBase+"icons/closeIconDark.svg",$scope.orIcon=$scope.assetsBase+"icons/orIcon.svg",$scope.minusCircle=$scope.assetsBase+"icons/minus-circle.svg",$scope.editPattern={},$scope.editPattern.editIntentPattern="",$scope.showMoreUtterancesList=function(){$scope.showMoreUtterances=!0},$scope.showMorePatternsList=function(){$scope.showMorePatterns=!0},$scope.openSynonymTags=function(event){$(event.currentTarget).hasClass("open")&&!$("tags-input .tags").hasClass("focused")?$(event.currentTarget).removeClass("open"):($(".synonymsTagsParentDiv").removeClass("open"),$(event.currentTarget).addClass("open"),setTimeout(function(){$(".synonymsTagsParentDiv tags-input .tags .input").trigger("focus")},350))},$scope.$watchCollection("trainUtterance",function(newVal,oldVal){$scope.trainUtterance&&$scope.trainUtterance._id&&$scope.getUtterances()}),$scope.isCollapsed=function(ele){return $(ele).hasClass("collapsed")},$scope.showType=function(type){$scope.activeType=type,"machineLearning"===$scope.activeType?getUtterances():"synonymsPatterns"===$scope.activeType&&("dialog"===$scope.taskDetails.taskType&&($scope.taskDetails.task_patterns=[],getComponents($scope.taskDetails.nodes[0].componentId)),$scope.finishedFetching=!1,setTimeout(function(){$scope.finishedFetching=!0},1e3),$scope.renderSynonyms(),focusInputEle())};var focusInputEle=function(inputEle){$timeout(function(){$("#utterance-text").focus()},200)};$scope.ml={},$scope.utterences=[],$scope.ml.utteranceText="";var previousUtteranceIndex=-1;$scope.moreAvailable=!0;var getTaskType=function(){return"dialog"===$scope.taskDetails.taskType?"DialogIntent":$scope.taskDetails.taskType},getTaskID=function(){return"dialog"===$scope.taskDetails.taskType?$scope.taskDetails.nodes[0].componentId:$scope.taskDetails._id},dummy_traitAnd=[];$scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.urlValidation=!1,$scope.traitRules={},$scope.loadTags=function(query){return $timeout("!"==query[0]?function(){return $scope.allTraits.negativeTraits.filter(function(traitName){return traitName.startsWith(query)})}:function(){return $filter("filter")($scope.allTraits.traits,query)})},$scope.bindAuioComplete=function(index,ele){var id="#addTrait_"+index;ele&&(id="#addTrait"+ele+index),setTimeout(function(){$(id).autocomplete({minLength:1,source:$scope.allTraits,focus:function(event,ui){return $(id).val(ui.item.label),!1},position:{collision:"flip"},select:function(event,ui){return $(id).val(ui.item.label),!1}}).autocomplete("widget").addClass("contextTypeaheadDropdown")},200)},$scope.mapTraitsForComponent=function(traitsPayload,updateType){var _streamId,deferred=$q.defer();return _streamId="universalbot"===$scope.stream.type?$scope.winingIntent.streamId:$scope.stream._id,BTFlowtaskService.updateComponentTraits(_streamId,$scope.traitRules._id,traitsPayload).then(function(res){mixpanelEvent("createTraits"),$scope.traitRules.traitMappings=traitsPayload.traitRules,$scope.traitRules.traitMappings.traitRules=res.data.traitRules,deferred.resolve(traitsPayload)},function(err){NotificationService.notify(i18n.i18nString("fail_traits"),"error"),deferred.reject({data:[]})}),deferred.promise},$scope.addTraitAndCondition=function(event,orIndex,rulesArray){setTimeout(function(){var mappings={traitRules:$scope.traitRules.traitMappings};$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("success_traits"),"success")})},700)},$scope.addTraitDummyAndCondition=function(index){$timeout(function(){var condition=$scope.dummyTraitOrCondition[index];if(!condition[0])return!1;var trait=angular.copy(condition[0]),mappings={traitRules:[]},andCondition=[];mappings.traitRules=angular.copy($scope.traitRules.traitMappings)||[],andCondition.push(trait),mappings.traitRules.push(andCondition),$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("success_traits"),"success"),$scope.dummyTraitOrCondition.length>1?$scope.dummyTraitOrCondition.splice(index,1):1==$scope.dummyTraitOrCondition.length&&($scope.dummyTraitOrCondition=[],$timeout(function(){$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$("#addTraitRulesTestNTrain"+($scope.traitRules.traitMappings.length-1))&&$("#addTraitRulesTestNTrain"+($scope.traitRules.traitMappings.length-1)).find(".input")&&$("#addTraitRulesTestNTrain"+($scope.traitRules.traitMappings.length-1)).find(".input").length&&$("#addTraitRulesTestNTrain"+($scope.traitRules.traitMappings.length-1)).find(".input")[0].focus()},300))},function(err){err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errrors[0].msg,"error")})},500)},$scope.addTraitOrCondition=function(event,index,condition){if($scope.constants.checkForSecialChar(condition.traitName,!0,"traits"))return!1;if(!condition.traitName)return!1;var trait=angular.copy(condition.traitName.replace(/\s/g,"")),mappings={traitRules:[]},andCondition=[];mappings.traitRules=angular.copy($scope.traitRules.traitMappings)||[],event&&13==event.keyCode&&(andCondition.push(trait),mappings.traitRules.push(andCondition),$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("success_traits"),"success"),$scope.dummyTraitOrCondition.length>1?$scope.dummyTraitOrCondition.splice(index,1):1==$scope.dummyTraitOrCondition.length&&($scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)))}))},$scope.deleteOrRule=function(orIndex){var mappings={traitRules:[]};mappings.traitRules=angular.copy($scope.traitRules.traitMappings)||[],mappings.traitRules.splice(orIndex,1),$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("success_traits"),"success")})},$scope.addOrDummy=function(){$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd))},$scope.saveSynonyms=function(newVal,oldVal){setTimeout(function(){saveTaskSynonyms(null,null,null,!0)},200)},$scope.upgrade=function(){$scope.isGlobalWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("upgrading_task");var taskType=$scope.getTaskType($scope.taskDetails);$scope.upgradeWorkflow($scope.taskDetails,taskType),$scope.taskDetails.isPublishedVersion&&$scope.addUtterance($scope.newUtterance,"","hidePublishedmode")},$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?task.isReport?"information":"action":task&&"dialog"==task.taskType?"flowtask":""},$scope.upgradeWorkflow=function(task,type){"alert"===type?BTAlertsService.upgradeBTAlert(task._id).then(function(response){BTAlertsService.upgradeMPAlert(task._id,response.data._id).then(function(upgradeRes){BTAlertsService.configured(upgradeRes.data._id).then(function(configRes){$scope.taskDetails=configRes.data[0],$scope.taskDetails.taskType="alert",$scope.getAlltasks(),"addPattern"==$scope.currentCb?$scope.addPattern($scope.currentPatternData,$scope.currentFromMatchedIntent):"updatePatterns"==$scope.currentCb?$scope.updatePatterns($scope.currentCmpId,$scope.currentpatterns):"deletePattern"==$scope.currentCb?$scope.deletePattern($scope.currentIntent,$scope.currentpatterns):"addUtterance"==$scope.currentCb?$scope.addUtterance($scope.currentUtterence):"deleteUtterance"==$scope.currentCb?$scope["delete"]($scope.currentIndextoDelete):"editUtterence"==$scope.currentCb?$scope.editUtterence($scope.editUtterenceIndex,$scope.currentUtterence):"deleteEntityToWordMap"==$scope.currentCb?$scope.deleteEntityToWordMap($scope.currentUtterence,$scope.currentuUterenceIndex,$scope.currentEntityIndex):"mapEntityToWord"==$scope.currentCb&&$scope.mapEntityToWord($scope.currentUtterence,$scope.currentEntityID),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type||"information"===type?BTActionsService.upgradeBTAction(task._id).then(function(response){BTActionsService.upgradeMPAction(task._id,response.data._id).then(function(upgradeRes){BTActionsService.configured(upgradeRes.data._id).then(function(configRes){$scope.taskDetails=configRes.data[0],$scope.taskDetails.taskType="action",$scope.getAlltasks(),"addPattern"==$scope.currentCb?$scope.addPattern($scope.currentPatternData,$scope.currentFromMatchedIntent):"updatePatterns"==$scope.currentCb?$scope.updatePatterns($scope.currentCmpId,$scope.currentpatterns):"deletePattern"==$scope.currentCb?$scope.deletePattern($scope.currentIntent,$scope.currentpatterns):"addUtterance"==$scope.currentCb?$scope.addUtterance($scope.currentUtterence):"deleteUtterance"==$scope.currentCb?$scope["delete"]($scope.currentIndextoDelete):"editUtterence"==$scope.currentCb?$scope.editUtterence($scope.editUtterenceIndex,$scope.currentUtterence):"deleteEntityToWordMap"==$scope.currentCb?$scope.deleteEntityToWordMap($scope.currentUtterence,$scope.currentuUterenceIndex,$scope.currentEntityIndex):"mapEntityToWord"==$scope.currentCb&&$scope.mapEntityToWord($scope.currentUtterence,$scope.currentEntityID),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,task._id).then(function(res){res.data.taskType="dialog",$scope.taskDetails=res.data,$scope.getAlltasks(),"addPattern"==$scope.currentCb?$scope.addPattern($scope.currentPatternData,$scope.currentFromMatchedIntent):"updatePatterns"==$scope.currentCb?$scope.updatePatterns($scope.currentCmpId,$scope.currentpatterns):"deletePattern"==$scope.currentCb?$scope.deletePattern($scope.currentIntent,$scope.currentpatterns):"addUtterance"==$scope.currentCb?$scope.addUtterance($scope.currentUtterence):"deleteUtterance"==$scope.currentCb?$scope["delete"]($scope.currentIndextoDelete):"editUtterence"==$scope.currentCb?$scope.editUtterence($scope.editUtterenceIndex,$scope.currentUtterence):"deleteEntityToWordMap"==$scope.currentCb&&$scope.deleteEntityToWordMap($scope.currentUtterence,$scope.currentuUterenceIndex,$scope.currentEntityIndex),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.checkstate=function(taskselected){return"published"===taskselected.state?!1:!0},$scope.renderSynonyms=function(){if($scope.synonyms=[],$scope.taskDetails.name){var tokens=$scope.taskDetails.name.split(/\b\s+(?!$)/),tokeSynonyms={};tokens.length&&(tokens.forEach(function(token){tokeSynonyms[token]=$scope.stream.synonyms&&$scope.stream.synonyms[token]?$scope.stream.synonyms[token]:[]}),Object.keys(tokeSynonyms||{}).map(function(key){var obj={};obj.key=key,obj.value=$scope.constants.getAlphabeticallySortedArray(tokeSynonyms[key]),$scope.synonyms.push(angular.copy(obj))}),$scope.stream.synonyms=$scope.stream.synonyms?$scope.stream.synonyms:[],Object.keys($scope.stream.synonyms).map(function(key){var obj={};obj.key=key,obj.value=$scope.constants.getAlphabeticallySortedArray($scope.stream.synonyms[key]),obj.hide=!0,tokeSynonyms[key]||$scope.synonyms.push(angular.copy(obj))}),$scope.oldSynonyms=angular.copy($scope.synonyms))}},$scope.context={},$scope.context.mapEntityToWord=function(selectedSentence,entityID){var key="state";if("DialogIntent"===$scope.taskDetails.taskType&&(key="status"),"published"==$scope.taskDetails[key])NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade_small")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{console.log(selectedSentence),console.log(entityID);var focusedUtterance=$scope.entityCmpt.focusedUtterance&&$scope.entityCmpt.focusedUtterance.trim();console.log(focusedUtterance),console.log($scope.entityCmpt.selectedUtteranceIndex),console.log($scope.entityCmpt.startEndIndex);var payload={taskId:$scope.taskDetails.nodes[0].componentId,sentence:focusedUtterance,streamId:streamId,taskName:$scope.taskDetails.name,type:getTaskType()};$scope.universalBot&&$scope.taskDetails&&(payload.streamId=$scope.taskDetails.streamId),selectedSentence=$scope.entityCmpt.focusedUtterance.substring($scope.entityCmpt.startEndIndex.start,$scope.entityCmpt.startEndIndex.end);var indexAfterTrim=selectedSentence.length-selectedSentence.trim().length;payload.entities=[];var sentenceEntObject={startIndex:$scope.entityCmpt.startEndIndex.start,endIndex:$scope.entityCmpt.startEndIndex.end-indexAfterTrim,entityId:entityID};if(payload.entities.push(sentenceEntObject),$scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities&&$scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities.length){$.each($scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities,function(i,entity){($scope.entityCmpt.startEndIndex.start<=entity.startIndex&&$scope.entityCmpt.startEndIndex.end>=entity.startIndex||$scope.entityCmpt.startEndIndex.start<=entity.endIndex&&$scope.entityCmpt.startEndIndex.end>=entity.endIndex||$scope.entityCmpt.startEndIndex.start>=entity.startIndex&&$scope.entityCmpt.startEndIndex.end<=entity.endIndex||$scope.entityCmpt.startEndIndex.start<=entity.startIndex&&$scope.entityCmpt.startEndIndex.end>=entity.endIndex)&&delete $scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities[i]});var tempEntitesArray=$scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities||[];tempEntitesArray=_.without(tempEntitesArray,null),tempEntitesArray=_.without(tempEntitesArray,void 0),payload.entities=[].concat(payload.entities,tempEntitesArray)}$scope.entityCallbacks.updateDropDownPostion(!1,$scope.entityCmpt.offsetObject),startSaving(".utteranceInput"+$scope.utterences[$scope.entityCmpt.selectedUtteranceIndex]._id),saveEditedUtterance(payload,parseInt($scope.entityCmpt.selectedUtteranceIndex))}},$scope.trustAsHtml=function(utterenceSentence){return $sce.trustAsHtml(utterenceSentence)},$scope.addUtterance=function(utterance,manualTrain,value){if($scope.ml.utteranceText){var key="state";if("DialogIntent"===$scope.taskDetails.taskType&&(key="status"),"published"==$scope.taskDetails[key])$scope.currentCb="addUtterance",$scope.currentUtterence=$scope.ml.utteranceText,NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade_small")},"",void 0,i18n.i18nString("add_utter_published_noty"));else if($scope.taskDetails.isPublishedVersion&&!value)$scope.taskDetails._id=$scope.taskDetails.parentId,$scope.newUtterance=utterance,NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{utterance&&($scope.ml.utteranceText=utterance);var payload={taskId:getTaskID(),sentence:$scope.ml.utteranceText,streamId:streamId,taskName:$scope.taskDetails.name,type:getTaskType()};$scope.universalBot&&(payload.streamId=$scope.taskDetails.streamId),"information"===$scope.taskDetails.taskType&&(payload.type="action"),$scope.ml.utteranceText="",manualTrain?$scope.training=!1:$scope.training=!0,$rootScope.$broadcast("getProgressDockStatus"),$(".trainingProgress").addClass("open"),BTStreamsService.createUtterances(payload).then(function(res){mixpanelEvent("createUtterance"),$scope.$emit("updateChecklist","machineLearningUtterances"),$scope.utterences.push(res.data),$scope.count++,manualTrain||$scope.trainBot(),NotificationService.notify(i18n.i18nString("utterence_created_sucess_noty"),"info")},function(err){$scope.training=!1,err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("problm_in_training_utter_noty"),"error")})}}},$scope.canshowmlhelp=function(){return $scope.ml.utteranceText&&$scope.ml.utteranceText.length},$scope.editThis=function(index){-1===previousUtteranceIndex||$scope.utterences[previousUtteranceIndex].sentence&&(savedUtteranceFlag||$scope.utterences[previousUtteranceIndex].sentence===previousUnsavedUtteranceValue)||($scope.utterences[previousUtteranceIndex].sentence=$scope.utterencesCopy[previousUtteranceIndex].sentence),savedUtteranceFlag=!1,previousUtteranceIndex=index,previousUnsavedUtteranceValue=$scope.utterences[index].sentence,$scope.editId=index,setTimeout(function(){$('input[name="utterance-text"]').focus()},100)},$scope.cancelEditUtterance=function(){setTimeout(function(){$scope.editId=-1,savedUtteranceFlag=!0},5)},$scope["delete"]=function(index){var key="state";if("DialogIntent"===$scope.taskDetails.taskType&&(key="status"),"published"==$scope.taskDetails[key])$scope.currentCb="deleteUtterance",$scope.currentIndextoDelete=index,NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade_small")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{var payload={taskId:getTaskID(),sentence:$scope.utterences[index].sentence,streamId:streamId,type:getTaskType(),taskName:$scope.taskDetails.name};$scope.universalBot&&$scope.taskDetails&&(payload.streamId=$scope.taskDetails.streamId),BTStreamsService.deleteUtterances(payload,$scope.utterences[index]._id).then(function(res){var _utteranceID=angular.copy($scope.utterences[index]._id);$scope.$emit("checkAndRemoveUtterance",_utteranceID),$scope.utterences.splice(index,1),$scope.trainBot(),$scope.count--,NotificationService.notify(i18n.i18nString("utterance_deleted"),"info")},function(err){})}},$scope.editUtterence=function(index,utterance){if($scope.utterences[index].sentence){var focusedUtterance,key="state";if("DialogIntent"===$scope.taskDetails.taskType&&(key="status"),"published"==$scope.taskDetails[key])$scope.currentCb="editUtterence",$scope.editUtterenceIndex=index,$scope.currentUtterence=$scope.entityCmpt.focusedUtterance&&$scope.entityCmpt.focusedUtterance.trim(),NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade_small")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{savedUtteranceFlag=!0,focusedUtterance=utterance?utterance:$scope.entityCmpt.focusedUtterance&&$scope.entityCmpt.focusedUtterance.trim();var payload={taskId:getTaskID(),sentence:focusedUtterance,streamId:streamId,type:getTaskType(),taskName:$scope.taskDetails.name,entities:$scope.utterences[index].entities||[]};$scope.universalBot&&$scope.taskDetails&&(payload.streamId=$scope.taskDetails.streamId),BTStreamsService.editUtterances(payload,$scope.utterences[index]._id).then(function(res){$scope.trainBot(),NotificationService.notify(i18n.i18nString("utterences_update_sucess_noty"),"info")},function(err){}),$scope.editId=-1}}},$scope.addPattern=function(patternData,isFromMatchedIntent,index,pattern){var task=$scope.taskDetails,payload={input:$scope.newPattern.value,intend:task.name,resourceId:task._id},currStreamId=$scope.stream._id;if($scope.universalBot&&$scope.taskDetails&&(currStreamId=$scope.taskDetails.streamId),index>=0){pattern.saving=!0;var updatedPatterns=[];task.task_patterns&&task.task_patterns.map(function(obj){updatedPatterns.push(obj.original)});var arrayLength=updatedPatterns.length,actualIndex=arrayLength-index-1;updatedPatterns[actualIndex]=updatedPatterns[actualIndex].replace(updatedPatterns[actualIndex],$scope.editPattern.editIntentPattern),
$scope.updatePatterns(task.nodes[0].componentId,updatedPatterns,index,pattern),$(".hidingIntentPatterns"+index).removeClass("hide"),$(".editingIntentPatterns"+index).addClass("hide"),$(".patternSave"+index).addClass("intentPatternSaving")}else{$scope.addPatternSaving=!0;var key="state";if("DialogIntent"===$scope.taskDetails.taskType&&(key="status"),"published"==$scope.taskDetails[key])$scope.currentCb="addPattern",$scope.currentPatternData=patternData,$scope.currentFromMatchedIntent=isFromMatchedIntent,NotificationService.alert("",[$scope.upgrade,$scope.cancleUpgrade],{okText:i18n.i18nString("upgrade_small")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{if("dialog"===task.taskType){var patterns=[];return patterns.push($scope.newPattern.value),task.task_patterns&&task.task_patterns.map(function(obj){patterns.push(obj.original)}),void $scope.updatePatterns(task.nodes[0].componentId,patterns)}BTStreamsService.createPattern(currStreamId,payload).then(function(res){$scope.addPatternSaving=!1,isFromMatchedIntent?$scope.taskDetails.task_patterns=res.data:$scope.taskDetails.task_patterns=res.data,$scope.newPattern.value=""},function(err){var msg=getErrorMsg(err,i18n.i18nString("pattern_adding"));NotificationService.notify(msg,"error"),$scope.addPatternSaving=!1})}}},$scope.cancleUpgrade=function(){$scope.addPatternSaving=!1},$scope.updatePatterns=function(cmpId,patterns,index,pattern){var currStreamId=$scope.stream._id;$scope.universalBot&&$scope.taskDetails&&(currStreamId=$scope.taskDetails.streamId);var key="state";"DialogIntent"===$scope.taskDetails.taskType&&(key="status"),"published"==$scope.taskDetails[key]?($scope.currentCmpId=cmpId,$scope.currentpatterns=patterns,$scope.currentCb="updatePatterns",NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade_small")},"",void 0,i18n.i18nString("add_utter_published_noty"))):BTFlowtaskService.updateComponentPatterns(currStreamId,cmpId,{patterns:patterns}).then(function(res){mixpanelEvent("createPattern"),res&&res.data&&($scope.addPatternSaving=!1,$scope.newPattern.value="",$scope.taskDetails.task_patterns=preparePatternObject(res.data)),pattern&&(pattern.saving=!1),index>=0?NotificationService.notify(i18n.i18nString("patrn_module_pattern_updated_success"),"success"):0>index?NotificationService.notify(i18n.i18nString("pattern_deleted"),"success"):NotificationService.notify(i18n.i18nString("patrn_module_added_sucess"),"success")},function(err){err&&err.data&&err.data.errors&&err.data.errors[0].msg&&(NotificationService.notify(err.data.errors[0].msg,"error"),$scope.addPatternSaving=!1),pattern&&(pattern.saving=!1)})},$scope.deletePattern=function(e,intent,pattern){function confirmDeletePattern(){if("dialog"===intent.taskType){$scope.taskDetails.task_patterns=_.filter($scope.taskDetails.task_patterns,function(_pattern){return _pattern.key!==pattern.key});var patterns=[],index=-1;return $scope.taskDetails.task_patterns.map(function(obj){patterns.push(obj.original)}),void $scope.updatePatterns($scope.taskDetails.nodes[0].componentId,patterns,index)}var context={resourceId:intent._id,patternId:pattern.key,streamId:$scope.stream._id};$scope.universalBot&&$scope.taskDetails&&(context.streamId=$scope.taskDetails.streamId),BTStreamsService.deletePattern(context).then(function(res){$scope.taskDetails.task_patterns=_.filter($scope.taskDetails.task_patterns,function(_pattern){return _pattern.key!==pattern.key}),NotificationService.notify(i18n.i18nString("pattern_deleted"),"success")},function(err){NotificationService.notify(i18n.i18nString("pattern_delete"),"error")})}event&&(event.preventDefault(),event.stopPropagation());var key="state";if("DialogIntent"===$scope.taskDetails.taskType&&(key="status"),"published"==$scope.taskDetails[key])$scope.currentIntent=intent,$scope.currentpatterns=pattern,$scope.currentCb="deletePattern",NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade_small")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{var msg=i18n.i18nString("confirm_delete_pattern");$rootScope.showConfirmationPopup(msg,confirmDeletePattern)}},$scope.deleteEntityToWordMap=function(utterence,utterenceIndex,entityIndex){var key="state";if("DialogIntent"===$scope.taskDetails.taskType&&(key="status"),"published"==$scope.taskDetails[key])$scope.currentUtterence=utterence,$scope.currentuUterenceIndex=utterenceIndex,$scope.currentEntityIndex=entityIndex,$scope.currentCb="deleteEntityToWordMap",NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade_small")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{utterence.entities.splice(entityIndex,1);var payload={taskId:utterence.taskId,sentence:$("<div>"+utterence.sentence+"<div>").text(),streamId:utterence.streamId,taskName:utterence.taskName,type:utterence.type,entities:utterence.entities||[]};startSaving(".utteranceInput"+$scope.utterences[utterenceIndex]._id),saveEditedUtterance(payload,utterenceIndex)}};var mapIndex=function(start,end,currentIndex,triplets){if(currentIndex>0){var previousIndex=currentIndex-1,currentTriplet=triplets[currentIndex],previousTriplet=triplets[previousIndex];return currentTriplet[0]===previousTriplet[0]&&currentTriplet[1]===previousTriplet[1]?!1:!0}return!0},entityColors={};$scope.getColorByEntity=getColorByEntity,$scope.entityCallbacks.mapColorEntityToWord=mapColorEntityToWord,$scope.getUtterances=function(){$scope.activeType="machineLearning",getUtterances()};var utteranceNames=[];$scope.$watch("utterences",function(newVal,oldVal){utteranceNames=_.pluck(newVal,"sentence");var nlpText=$scope.nlpText&&$scope.nlpText.trim(),matchedSentence="";nlpText&&(matchedSentence=_.find(utteranceNames,function(name){return name==nlpText})),matchedSentence||($scope.ml.utteranceText=nlpText)});var init=function(){$scope.showType("synonymsPatterns"),$scope.showType("machineLearning")};$scope.clickIntentPattern=function(index,pattern){$(".intentPatternClass").removeClass("hide"),$(".inputIntentClass").addClass("hide"),$scope.editPattern.editIntentPattern=decodePattern(pattern.original),$(".hidingIntentPatterns"+index).addClass("hide"),$(".editingIntentPatterns"+index).removeClass("hide"),$(".fieldPatternInput").focus()},$scope.$on("trainFinished",function(){$scope.training=!1}),$scope.$on("reloadML",function(){$timeout(function(){init()},500),$timeout(function(){$("#utterance-text").focus()},3e3)}),init()}])}(angular),function(ng){var panelsWidgetsForm=ng.module("bt-forms");panelsWidgetsForm.directive("btPanelsWidgets",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-panels-widgets/bt-panels-widgets.html",controller:"btPanelsWidgetsCtrl"}}),panelsWidgetsForm.controller("btPanelsWidgetsCtrl",["$scope","form_util","env_conf","$rootScope","$timeout","$workflowService","accessControlService","BTStreamsService","NotificationService","$q","navigator","BTFlowtaskService","BTFileUploadService","$translator","$applicationService","i18n","$sce","mixPanel",function($scope,form_util,env_conf,$rootScope,$timeout,$workflowService,accessControlService,BTStreamsService,NotificationService,$q,navigator,BTFlowtaskService,BTFileUploadService,$translator,$applicationService,i18n,$sce,mixPanel){function triggerLock(sliderType,dataItem){$scope.$emit("lockTaskEvent",dataItem,"panel",{success:function(){$scope.sliderAction("open",sliderType,dataItem)},failure:function(){console.log("Task locked")}})}function prepareWidgetsData(widgets){$scope.widgetObj={indevelopment:{},published:{}},$scope.universalBot?$scope.widgets=_.filter(widgets,function(widget){return $scope.linkedUbWidgets[widget.refId]}):$scope.widgets=widgets,"indevelopment"===$scope.streamState&&($scope.widgets=_.filter($scope.widgets,function(widget){return!widget.isDeleted})),$.each($scope.widgets,function(i,widget){widget&&widget.meta&&widget.meta.previewJson&&widget.meta.previewJson.data&&widget.meta.previewJson.data.length?widget.preview=$scope.getWidgetPreview(null,widget._id,widget.meta.previewJson.data[0]):widget.preview=null,"published"===widget.state||"suspended"===widget.state?$scope.widgetObj.published[widget.refId]=widget:("configured"===widget.state||"awaitingApproval"===widget.state||"rejected"===widget.state)&&($scope.widgetObj.indevelopment[widget.refId]=widget)}),$scope.getPanelsOrWidgetsCountByState()}function getBase64(file){var _reader=new FileReader;_reader.onloadend=function(){$scope.ImgString=_reader.result},_reader.readAsDataURL(file)}function getJWT(callback){$translator.translate("bt.post.stsV2",{}).then(function(res){callback&&res&&res.data&&res.data.jwt&&callback(res.data.jwt)},function(err){})}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function encodeJS(_obj){return encodeURIComponent(_obj)}_userInfo=$applicationService.userInfo();var wizSelector={menu:".kr-wiz-menu-chat",content:".kr-wiz-content-chat"},botOptions={};$scope.widgetPreviewObj={testPreview:!1,loadingPreview:!0,selectedWidget:null,preview:null},$scope.brokenImageSmall=env_conf["context-url"]+"/assets/images/brokenImageSmall.png",$scope.bluePanelIcon=env_conf["context-url"]+"/assets/icons/dumy-img.svg",$scope.appliedFilterObj={},$scope.linkedbotWidgets={},$scope.linkedUbWidgets={},$scope.supportedWidgetTYpes=[{name:i18n.i18nString("list"),type:"List"},{name:i18n.i18nString("pie_chart"),type:"piechart"},{name:i18n.i18nString("bar_chart"),type:"barchart"},{name:i18n.i18nString("line_chart"),type:"linechart"}],window.baseUrl=window.appConfig.API_SERVER_URL,botOptions.logLevel="debug",botOptions.koreAPIUrl=window.appConfig.API_SERVER_URL,botOptions.userIdentity="",_userInfo&&_userInfo.koreUserInfo&&_userInfo.koreUserInfo.emailId&&(botOptions.userIdentity=_userInfo.koreUserInfo.emailId),botOptions.botInfo={name:$workflowService.selectedStream().name,_id:$workflowService.selectedStream()._id,icon:$workflowService.selectedStream().icon};var widgetConfig={botOptions:botOptions};$scope.webFormIntigration={formDialogIntegration:"",formId:""},widgetConfig.direction="left",widgetConfig.userInfo={id:""},widgetConfig.onEvent=function(event,data){"postback"===event&&$(".chatInputBox").text(data.postbackValue)};var wSdk=new KoreWidgetSDK(widgetConfig),panelLoadTimeOut=null;wSdk.events.onPanelsLoaded=function(data){clearTimeout(panelLoadTimeOut),panelLoadTimeOut=$timeout(function(){if($scope.testPanel){var panelMenu=$(".kr-wiz-menu-chat .menuItem[panels-menu-id='"+$scope.testPanel+"']");if(panelMenu.length)return wSdk.openPanel($scope.testPanel),!1;NotificationService.notify("warning",i18n.i18nString("panel_unavailable")),$scope.testPanel=null}},700)},$scope.panelsByState=[],$scope.selectedWidget={},$scope.enable=i18n.i18nString("Enable"),$scope.disable=i18n.i18nString("Disable"),$scope.selectWidget=i18n.i18nString("select_widget"),$scope.noWidgetsAdd=i18n.i18nString("no_widgets"),$scope.edit=i18n.i18nString("edit"),$scope.view=i18n.i18nString("view"),$scope.widgetsByState=$scope.stream=$workflowService.selectedStream(),$scope.selectedBot={},$scope.botsObj={},$scope.universalBot="universalbot"===$workflowService.selectedStream().type,$scope.filterByWidget=function(bot,addAll,removeall){removeall?$scope.appliedFilterObj[bot._id]=!1:addAll&&($scope.appliedFilterObj[bot._id]=!0);var appliedFilter=[];$.each($scope.appliedFilterObj,function(key,val){val&&appliedFilter.push(key)}),$scope.appliedFilter=appliedFilter},$scope.universalBot&&$.each($scope.linkedBots,function(i,bot){$scope.linkedbotWidgets[bot._id]={},$scope.botsObj[bot._id]=bot,$scope.filterByWidget(bot,!0)}),$scope.accessRights=accessControlService.getAccessRight("BOTBUILDER_TASKS"),"VIEW"===$scope.accessRights&&($scope.displayMode="view"),$scope.updateStreamState=function(evn,streamState){$scope.loaders.fetchingWidgets=!0,$scope.loaders.fetchingPanels=!0,$scope.streamState=$workflowService.selectedStreamState(),$scope.streamState=streamState,$scope.accessRights=accessControlService.getAccessRight(),$scope.updateViewIntems(),$scope.getPanelsAndWidgets()};var btstreamUpdatelistener=$rootScope.$on("updateStreamState",$scope.updateStreamState);$scope.$on("$destroy",function(){btstreamUpdatelistener&&btstreamUpdatelistener()}),$scope.visibleStates={},$scope.streamState=$workflowService.selectedStreamState(),$scope.updateViewIntems=function(initial){"published"===$scope.streamState?$scope.visibleStates={published:!0,suspended:!0}:$scope.visibleStates={awaitingApproval:!0,configured:!0,rejected:!0},initial||$scope.getPanelsOrWidgetsCountByState(),$(".panelsListing").scrollTop(0),$(".widgetListing").scrollTop(0)},$scope.updateViewIntems(!0),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.assetsPath=window.appConfig.CONTEXT_PATH+"/assets/",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.panelIcon=env_conf["context-url"]+"/assets/botIcons/1.svg",$scope.expandGreen=env_conf["context-url"]+"/assets/icons/expandGreen.svg",$scope.expandGray=env_conf["context-url"]+"/assets/icons/expandGray.svg",$scope.trashIconGray=env_conf["context-url"]+"/assets/icons/trashIconGray.svg",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.pencilIcon=env_conf["context-url"]+"/assets/icons/pencilIcon.svg",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.refreshIconGreen=env_conf["context-url"]+"/assets/icons/refreshIconGreen.svg",$scope.grid=env_conf["context-url"]+"/assets/icons/grid.svg",$scope.formIcon=env_conf["context-url"]+"/assets/icons/formIcon.svg",$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.emptyPreview=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/tasksPerformance.svg",$scope.panelsAndWidgets=env_conf["context-url"]+"/assets/images/panelsAndWidgets.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/empty-panel-widget.png",$scope.emptyStateWidgetIcon=env_conf["context-url"]+"/assets/empty-state-images/empty-widget.png",$scope.emptyStatePanelIcon=env_conf["context-url"]+"/assets/empty-state-images/empty-panel.png",$scope.$emit("nestedComponentLoaded",{id:"widgets",flag:!1}),$scope.flowtaskBridge={},$scope.flowtaskBridge.type="widgets",$scope.loaders={},$scope.panels=[],$scope.widgets=[],$scope.newfilteredPanels=[],$scope.newfilteredWidgets=[],$scope.panelWidgetMapping={},$scope.widgetObj={indevelopment:{},published:{}},$scope.panelObj={indevelopment:{},published:{}},$scope.searchItem={widgetSearch:"",panelSearch:""},$scope.contextVariable=[],$scope.loaders.loadingWidgets=!0,$scope.loaders.loadingPanels=!0,$scope.currentTabIndexOfJson=0,$scope.tempPannelId=1,$scope.sliderHeader={createWidget:i18n.i18nString("new_widget"),createPanel:i18n.i18nString("new_panel"),panelManagement:i18n.i18nString("panel_manage"),addNewWidget:i18n.i18nString("panel_manage"),addForm:i18n.i18nString("panel_manage"),addExistingWidget:i18n.i18nString("panel_manage"),editPanel:i18n.i18nString("edit_panel"),editWidget:i18n.i18nString("edit_widget"),testPreview:i18n.i18nString("preview_name")},$scope.sliderViewHeader={createWidget:i18n.i18nString("new_widget"),createPanel:i18n.i18nString("new_panel"),panelManagement:i18n.i18nString("panel_manage"),addNewWidget:i18n.i18nString("panel_manage"),addForm:i18n.i18nString("panel_manage"),addExistingWidget:i18n.i18nString("view_panel_manage"),editPanel:i18n.i18nString("view_panel"),editWidget:i18n.i18nString("view_widget"),testPreview:i18n.i18nString("preview_name")},$scope.panelWidgetState={configured:{displayState:i18n.i18nString("constants.states_inProgress"),displayMode:"edit"},awaitingApproval:{displayState:i18n.i18nString("constants.states_awaitingApproval"),displayMode:"edit"},rejected:{displayState:i18n.i18nString("constants.states_rejected"),displayMode:"edit"},published:{displayState:i18n.i18nString("constants.states_published"),displayMode:"view"},suspended:{displayState:i18n.i18nString("constants.states_suspended"),displayMode:"view"}},$scope.stream&&$scope.stream.taskCounts&&Object.keys($scope.stream.taskCounts).length&&$scope.stream.taskCounts.panels&&$scope.stream.taskCounts.panels.length&&($scope.newfilteredPanels=[],$scope.stream.taskCounts.panels.length&&$scope.stream.taskCounts.panels[0]&&"configured"===$scope.stream.taskCounts.panels[0].state&&"indevelopment"==$scope.streamState?$scope.newfilteredPanels.length=$scope.stream.taskCounts.panels[0].count:$scope.stream.taskCounts.panels.length&&$scope.stream.taskCounts.panels[0]&&"published"===$scope.stream.taskCounts.panels[0].state&&"published"===$scope.streamState?$scope.newfilteredPanels.length=$scope.stream.taskCounts.panels[0].count:$scope.stream.taskCounts.panels.length&&$scope.stream.taskCounts.panels[1]&&"configured"===$scope.stream.taskCounts.panels[1].state&&"indevelopment"==$scope.streamState?$scope.newfilteredPanels.length=$scope.stream.taskCounts.panels[1].count:$scope.stream.taskCounts.panels.length&&$scope.stream.taskCounts.panels[1]&&"published"===$scope.stream.taskCounts.panels[1].state&&"published"===$scope.streamState&&($scope.newfilteredPanels.length=$scope.stream.taskCounts.panels[1].count)),$scope.stream&&$scope.stream.taskCounts&&Object.keys($scope.stream.taskCounts).length&&$scope.stream.taskCounts.widgets&&$scope.stream.taskCounts.widgets.length&&($scope.newfilteredWidgets=[],$scope.stream.taskCounts.widgets.length&&$scope.stream.taskCounts.widgets[0]&&"configured"===$scope.stream.taskCounts.widgets[0].state&&"indevelopment"==$scope.streamState?$scope.newfilteredWidgets.length=$scope.stream.taskCounts.widgets[0].count:$scope.stream.taskCounts.widgets.length&&$scope.stream.taskCounts.widgets[0]&&"published"===$scope.stream.taskCounts.widgets[0].state&&"published"===$scope.streamState?$scope.newfilteredWidgets.length=$scope.stream.taskCounts.widgets[0].count:$scope.stream.taskCounts.widgets.length&&$scope.stream.taskCounts.widgets[1]&&"configured"===$scope.stream.taskCounts.widgets[1].state&&"indevelopment"==$scope.streamState?$scope.newfilteredWidgets.length=$scope.stream.taskCounts.widgets[1].count:$scope.stream.taskCounts.widgets.length&&$scope.stream.taskCounts.widgets[1]&&"published"===$scope.stream.taskCounts.widgets[1].state&&"published"===$scope.streamState&&($scope.newfilteredWidgets.length=$scope.stream.taskCounts.widgets[1].count)),$scope.isSmartBot=function(){return"solution"===$scope.stream.type?!0:!1},$scope.isSampleBot=function(){return"sample"===$scope.stream.type?!0:!1},$scope.showForms=!$scope.isSmartBot()&&!$scope.isSampleBot()&&!$scope.universalBot,$scope.is_url=function(str){return regexp=/^(?:(?:https?|ftp):\/\/)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/,regexp.test(str)?!0:!1},$scope.checkImageValidations=function(){$scope.createPanelObj&&($scope.createPanelObj.invalidImage=!1)},$scope.checkImage=function(url,callback){var img=new Image;img.onerror=img.onabort=function(){callback(url,"error")},img.onload=function(){callback(url,"success")},img.src=url},$scope.entityTypes={preAssign:"Pre-assign",runTime:"Run-time",before:"Before"},$scope.autoRefereshIntervals=[2,5,10,15,30,60],$scope.markdownCbs={},$scope.jsEditorCbs={},$scope.jsEditorCbs.displayMode=$scope.universalBot?"view":$scope.displayMode,$scope.markdownCbs.displayMode=$scope.universalBot?"view":$scope.displayMode,$scope.markdownCbs.switchEditor=function(type){"javaScriptEditor"===type&&$scope.selectJsonEditor("json")},$scope.closeFlowtask=function(){$scope.showDialogContainer=!1},$scope.intigrateWebForm=function(form){if(!$scope.savingIntigration){var payload=$scope.webFormIntigration;$scope.savingIntigration=!0,BTStreamsService.intigrateFormToPanel($scope.stream._id,$scope.selectedPanelToEdit._id,payload).then(function(res){$scope.selectedPanelToEdit=res.data;var updatedIndex=-1;$.each($scope.panels,function(i,panel){panel._id===$scope.selectedPanelToEdit._id&&(updatedIndex=i,$scope.panelObj&&$scope.panelObj.indevelopment&&$scope.panelObj.indevelopment[$scope.selectedPanelToEdit._id]&&($scope.panelObj.indevelopment[panel.refId]=res.data))}),null!==updatedIndex&&updatedIndex>-1&&($scope.panels[updatedIndex]=res.data),$scope.formDialogIntegrations||($scope.formDialogIntegrations={}),$scope.formDialogIntegrations[$scope.webFormIntigration.formId]=$scope.webFormIntigration.formDialogIntegration,$scope.getWidgets(),$scope.webFormIntigration={formDialogIntegration:"",formId:""},form&&form_util.makeItClean(form),$scope.savingIntigration=!1},function(error){if($scope.savingIntigration=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("form_to_panel_intigration_failed"),"error")})}},$scope.getDialogIdps=function(flowtaskId){$scope.authProfiles=[],BTFlowtaskService.getDialogIdps($workflowService.selectedStream()._id,flowtaskId).then(function(res){res&&res.data&&($scope.authProfiles=res.data)})},$scope.intigrations=function(){$scope.formDialogIntegrations={},this.webforms&&this.webforms[$scope.streamState]&&this.webforms[$scope.streamState].length&&$.each($scope.webforms[$scope.streamState],function(i,form){var intigrationFound=!1;form&&form.integrations&&form.integrations.length&&$.each(form.integrations,function(i,intigration){"dialog"!==intigration.type||intigration.resourceMeta&&intigration.resourceMeta.componentId||intigrationFound||(intigrationFound=!0,$scope.formDialogIntegrations[form.refId]=intigration.resourceId)})})},$scope.selectIntigrationDilaog=function(type){"create"===type&&$scope.webFormIntigration&&$scope.webFormIntigration.formId&&$scope.formDialogIntegrations&&$scope.formDialogIntegrations[$scope.webFormIntigration.formId]&&($scope.webFormIntigration.formDialogIntegration=$scope.formDialogIntegrations[$scope.webFormIntigration.formId]),"edit"===type&&$scope.createWidgetObj&&this.createWidgetObj.source&&$scope.createWidgetObj.source.resource&&$scope.formDialogIntegrations&&$scope.formDialogIntegrations[$scope.createWidgetObj.source.resource]&&($scope.createWidgetObj.formDialogIntegration=$scope.formDialogIntegrations[$scope.createWidgetObj.source.resource])},$scope.flowtaskBridge.closeFlowTaskEvent=$scope.closeFlowtask,$scope.dialogTasksforWidget=$workflowService.dialogTasksByState()||[],$scope.webforms=$workflowService.uiFormsTasksByState(),$scope.intigrations(),$scope.getComponents=function(flowtaskId){var dialog=_.find($scope.dialogTasksforWidget,{refId:flowtaskId});dialog&&dialog._id&&(BTFlowtaskService.getFlowtaskComponents($workflowService.selectedStream()._id,dialog._id).then(function(res){res&&res.data&&($scope.prePopulations=[],$scope.dialogEntities=_.filter(res.data,function(item){return"entity"==item.type||"dialogAct"===item.type?($scope.prePopulations.push(item.name),item.name):void 0}))}),$scope.getDialogIdps(dialog._id))},$scope.scrollToTop=function(eleClass){setTimeout(function(){$("."+eleClass).length&&$("."+eleClass).scrollTop(0)},300)},$scope.step=function(form,sliderToswitch){$scope.selectedSlider=sliderToswitch},$scope.switchSliderStep=function(type,form,itemInfo){$scope.tempObj={addPreAssighment:angular.copy($scope.entityPreDummy),entityPreAssign:[],contextMap:[]},form&&form_util.makeItClean(form),"panelManagement"===type?BTStreamsService.releaseLock(itemInfo._id).then(function(){$scope.selectedSlider=type,$scope.createWidgetObj={name:"",title:"",templateType:"",autoRefresh:{enabled:!0,interval:"2"},source:{type:"dialog",payload:{}},fields:[],contextMap:"",authProfiles:[]}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("release_lock"),"error")}):$scope.selectedSlider=type},$scope.sliderAction=function(method,type,itemInfo,ignorePanelProgress){if($scope.universalBot){if(itemInfo&&itemInfo.source&&itemInfo.source.resource&&itemInfo.source.resource.refId){var resource=_.cloneDeep(itemInfo.source.resource);$scope.webforms={published:[],indevelopment:[]},$scope.webforms.published.push(resource),$scope.webforms.indevelopment.push(resource),itemInfo&&itemInfo.formDialogIntegration&&itemInfo.formDialogIntegration.refId&&($scope.dialogTasksforWidget.push(itemInfo.formDialogIntegration),itemInfo.formDialogIntegration=itemInfo.formDialogIntegration.refId),$scope.dialogTasksforWidget.push(resource),itemInfo.source.resource=itemInfo.source.resource.refId}itemInfo&&itemInfo.formDialogIntegration&&itemInfo.formDialogIntegration.refId&&($scope.dialogTasksforWidget.push(itemInfo.formDialogIntegration),itemInfo.formDialogIntegration=itemInfo.formDialogIntegration.refId)}else $scope.webforms=$workflowService.uiFormsTasksByState(),$scope.dialogTasksforWidget=$workflowService.dialogTasksByState();$scope.intigrations(),$scope.showDialogContainer=!1;({streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name});if(("addNewWidget"===type||"addExistingWidget"===type)&&!$scope.universalBot&&$scope.widgets&&!$scope.widgets.length)return NotificationService.notify(i18n.i18nString("no_widgets"),"error"),!1;if($scope.selectedSlider=type,"addNewWidget"===type||"addExistingWidget"===type||"createWidget"===type){var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Digital Tasks - Digital Views"};mixPanel.postEvent("Digital Tasks - Digital View Panel Widget Initiated",eventInfo)}if("panelManagement"===type||"addNewWidget"===type||"addExistingWidget"===type||"addForm"===type?$scope.$emit("lockTaskEvent",itemInfo,"panel",{success:function(){$scope.panelManagementInProgress=!0,$scope.selectedPanelToEdit=angular.copy(itemInfo),$scope.getAvailableWidgetsForPanel(itemInfo),setTimeout(function(){$(".modalBody").length&&$(".modalBody").scrollTop(0)},300),$scope.openModalSlider("#pannelsWidgetsSlider")},failure:function(){console.log("Task locked")}}):"editWidget"===type?$scope.panelManagementInProgress=$scope.panelManagementInProgress:$scope.panelManagementInProgress=!1,"createWidget"===type&&(itemInfo?$scope.panelManagementInProgress=!0:$scope.panelManagementInProgress=!1),"editWidget"===type&&($scope.panelManagementInProgress=!0,$scope.createWidgetObj=angular.copy(itemInfo),$scope.createWidgetObj.autoRefresh.interval=""+itemInfo.autoRefresh.interval,$scope.createWidgetObj.title=itemInfo.title||itemInfo.title,$scope.createWidgetObj.templateType||($scope.createWidgetObj.templateType=""),itemInfo&&itemInfo.source&&"dialog"===itemInfo.source.type&&itemInfo.source.resource&&$scope.getComponents(itemInfo.source.resource),itemInfo&&itemInfo.source&&"json"===itemInfo.source.type&&itemInfo.source.resource&&"basic"===itemInfo.source.resource.type?(itemInfo.source.resource.type="uxmap",$scope.createWidgetObj.source.resource.jsCode=decodeJS(itemInfo.source.resource.text)||"",$scope.createWidgetObj.source.resource.isMarkDown=!1):itemInfo&&itemInfo.source&&"json"===itemInfo.source.type&&itemInfo.source.resource&&"uxmap"===itemInfo.source.resource.type&&($scope.createWidgetObj.source.resource.jsCode=decodeJS(itemInfo.source.resource.text)||"",$scope.createWidgetObj.source.resource.isMarkDown=!1),itemInfo.contextMap&&itemInfo.contextMap.trim()))try{$scope.contextVariable=JSON.parse(itemInfo.contextMap)}catch(e){$scope.contextVariable={}}if("editPanel"===type&&($scope.createPanelObj=angular.copy(itemInfo),$scope.createPanelObj.iconInfo=itemInfo.icon,$scope.createPanelObj.autoRefresh.interval=""+itemInfo.autoRefresh.interval),"testPreview"===type){itemInfo&&($scope.testPanel=itemInfo);var testeventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Digital Tasks - Digital Views"};mixPanel.postEvent("Digital Tasks - Digital View Panel Test",testeventInfo),$timeout(function(){$(".kore-chat-window .kore-chat-body:visible").length<1&&$(".runBotBtn").click(),$timeout(function(){$(".kore-chat-window").addClass("with-widgets"),$(".kore-chat-window").addClass("defaultTheme-kore")},750),$timeout(function(){$scope.loadingPreview=!0,$scope.closeModalSlider("#pannelsWidgetsSlider"),$translator.translate("bt.post.stsV2",{}).then(function(res){var data=res.data;$scope.jwtToken=data.jwt,wSdk.setJWT(data.jwt),widgetConfig.widgetSDKInstace=wSdk,widgetConfig.botOptions.botInfo.botState="indevelopment"===$scope.streamState?"configured":"published",$rootScope.koreBot.setWidgetInstance(wSdk),wSdk.show(widgetConfig,wizSelector),setTimeout(function(){$scope.loadingPreview=!1},200)},function(err){$scope.loadingPreview=!1})},200)},0)}"open"===method?(setTimeout(function(){$(".modalBody").length&&$(".modalBody").scrollTop(0)},300),"testPreview"!==type&&"panelManagement"!==type&&"addForm"!==type&&"addNewWidget"!==type&&"addExistingWidget"!==type&&$scope.openModalSlider("#pannelsWidgetsSlider")):($(".modalBody").length&&$(".modalBody").scrollTop(0),$scope.closeModalSlider("#pannelsWidgetsSlider"),setTimeout(function(){$scope.selectedSlider=null,$scope.panelManagementInProgress=!1,$scope.cleanSliderVariablesVariables()},200))},$scope.entityPreDummy={label:"",dataType:"string",fieldType:"preAssign",defaultValue:"",visibility:"mandatory"},$scope.contextPreDummy={key:"",value:""},$scope.contextPreAssignInputEevents=function(type,text,index){"new"==type&&text&&""!==text.trim()&&$scope.tempObj.contextMap.length===index+1&&$scope.tempObj.contextMap.push(angular.copy($scope.contextPreDummy))},$scope.addEditEntityPreAssignment=function(type){"new"==type&&$scope.tempObj.addPreAssighment&&$scope.tempObj.addPreAssighment.label&&""!==$scope.tempObj.addPreAssighment.label.trim()&&$scope.tempObj.entityPreAssign.push(angular.copy($scope.tempObj.addPreAssighment)),$scope.tempObj.addPreAssighment=angular.copy($scope.entityPreDummy)},$scope.deleteContextPreAssignments=function(index,type){"new"===type&&$scope.tempObj.contextMap.length>1?$scope.tempObj.contextMap.splice(index,1):"existing"===type&&$scope.contextVariable&&$scope.contextVariable.length&&$scope.contextVariable.splice(index,1)},$scope.deleteEntityPreAssignments=function(index,type){"new"===type?$scope.tempObj.entityPreAssign.splice(index,1):"existing"===type&&$scope.createWidgetObj&&$scope.createWidgetObj.fields&&$scope.createWidgetObj.fields.length&&$scope.createWidgetObj.fields.splice(index,1)},$scope.triggerLock=triggerLock,$scope.editPanel=function(event,panel,sliderType){$("body").click();var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Digital Tasks - Digital Views"};mixPanel.postEvent("Digital Tasks - Digital View Panel Modification initiated",eventInfo);var target=event.target.id;(!target||"panelEditDropdownAnchor"!==target&&"panelEditDropdown"!==target&&!target.startsWith("button"))&&triggerLock(sliderType,panel)},$scope.editWidget=function(event,widget,sliderType){var target=event.target.id;(!target||"widgetEditDropdownAnchor"!==target&&"widgetEditDropdown"!==target&&!target.startsWith("button"))&&triggerLock(sliderType,widget)},$scope.cleanSliderVariablesVariables=function(closeSlider,form,itemInfo){function proceedClear(){
$scope.authProfiles=[],$scope.createPanelObj={name:"",title:"",fileId:"",autoRefresh:{enabled:!0,interval:"2"},icon:"",iconInfo:{fileName:"",fileId:""}},$scope.webFormIntigration={formDialogIntegration:"",formId:""},$scope.tempObj={addPreAssighment:angular.copy($scope.entityPreDummy),entityPreAssign:[],contextMap:[]},$scope.widgetPreviewObj={testPreview:!1,loadingPreview:!0,selectedWidget:null,preview:null,previewObj:null},$scope.panelManagementOpen=!1,$scope.contextVariable=[],$scope.selectedPanelToEdit=null,$scope.selectedWidget={},$scope.panelManagementInProgress=!1,$scope.tempObj.contextMap.push(angular.copy($scope.contextPreDummy)),$scope.createWidgetObj={name:"",title:"",templateType:"",autoRefresh:{enabled:!0,interval:"2"},source:{type:"dialog",payload:{}},fields:[],contextMap:"",authProfiles:[],formDialogIntegration:""},closeSlider&&$scope.sliderAction("close",null),$scope.selectedWidget={},$scope.selectedBot={},form&&form_util.makeItClean(form)}"editWidget"===$scope.selectedSlider||"panelManagement"==$scope.selectedSlider||"editPanel"==$scope.selectedSlider?itemInfo&&BTStreamsService.releaseLock(itemInfo._id).then(function(){proceedClear()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("release_lock"),"error")}):proceedClear()},$scope.cleanSliderVariablesVariables(),$scope.updatePannelById=function(panelId,form,payload,type){return form&&form.$invalid?void form_util.touch(form):void($scope.savingPannel||($scope.savingPannel=!0,payload||(payload={name:$scope.createPanelObj.name,title:$scope.createPanelObj.title,widgets:$scope.createPanelObj.widgets,autoRefresh:$scope.createPanelObj.autoRefresh,icon:$scope.createPanelObj.fileId,meta:$scope.createPanelObj.meta||{}},$scope.universalBot&&(payload={name:$scope.createPanelObj.name,title:$scope.createPanelObj.title,linkedBotWidgets:$scope.createPanelObj.linkedBotWidgets,autoRefresh:$scope.createPanelObj.autoRefresh,icon:$scope.createPanelObj.fileId,meta:$scope.createPanelObj.meta||{}})),BTStreamsService.updatePannelById($workflowService.selectedStream()._id,panelId,payload).then(function(res){if($scope.universalBot)return $scope.getPanels(),$scope.savingPannel=!1,"addNewWidget"===$scope.selectedSlider||"panelManagement"===$scope.selectedSlider||"addExistingWidget"===$scope.selectedSlider?(form&&form_util.makeItClean(form),"addExistingWidget"===$scope.selectedSlider&&($scope.selectedSlider="panelManagement"),$scope.getAvailableWidgetsForPanel(res.data),$scope.selectedWidget={},$scope.selectedBot={}):$scope.cleanSliderVariablesVariables(!0,null,res.data),void("add"===type?NotificationService.notify(i18n.i18nString("sucess_widget_add_to_panel"),"success"):"remove"===type?NotificationService.notify(i18n.i18nString("sucess_widget_remove_from_panel"),"success"):NotificationService.notify(i18n.i18nString("sucess_panel_update"),"success"));var updatedIndex=-1;$.each($scope.panels,function(i,panel){panel._id===panelId&&(updatedIndex=i,$scope.panelObj&&$scope.panelObj.indevelopment&&$scope.panelObj.indevelopment[panelId]&&($scope.panelObj.indevelopment[panel.refId]=res.data))}),null!==updatedIndex&&updatedIndex>-1&&($scope.panels[updatedIndex]=res.data),$scope.savingPannel=!1,"addNewWidget"===$scope.selectedSlider||"panelManagement"===$scope.selectedSlider||"addExistingWidget"===$scope.selectedSlider?(form&&form_util.makeItClean(form),"addExistingWidget"===$scope.selectedSlider&&($scope.selectedSlider="panelManagement"),$scope.getAvailableWidgetsForPanel(res.data),$scope.selectedWidget={},$scope.selectedBot={}):$scope.cleanSliderVariablesVariables(!0,null,res.data),"add"===type?NotificationService.notify(i18n.i18nString("sucess_widget_add_to_panel"),"success"):"remove"===type?NotificationService.notify(i18n.i18nString("sucess_widget_remove_from_panel"),"success"):NotificationService.notify(i18n.i18nString("sucess_panel_update"),"success"),$scope.updatepanelWidgetmapping()},function(error){if($scope.loaders.loadingPanels=!1,$scope.savingPannel=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_panel_update"),"error")})))},$scope.getPanelByid=function(panelId){BTStreamsService.getPannelById($workflowService.selectedStream()._id,panelId).then(function(res){$timeout(function(){$scope.panels.push(res.data)},300)},function(error){if($scope.loaders.loadingPanels=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_fetching_panel"),"error")})},$scope.deleteConfirmation=function(id,index,type,editItem){function cancelDelete(){$scope.deleteInfo={}}var msg,header;itemType="";var confirmDelete;if($scope.deleteInfo={id:id,deleteIndex:index},"panelDelete"===type){if(editItem&&editItem.refId&&$scope.widgetObj&&$scope.panelObj.published[editItem.refId])return;msg=i18n.i18nString("confirm_delete_panels"),header=i18n.i18nString("Delete_Panel"),itemType="panel",confirmDelete=function(){$scope.deletePannel(id,index)}}if("widgetDelete"===type){if(editItem&&editItem.refId&&$scope.widgetObj&&$scope.widgetObj.published[editItem.refId])return;itemType="widget",msg=i18n.i18nString("confirm_delete_widget"),header=i18n.i18nString("Delete_Widget"),confirmDelete=function(){$scope.deleteWidget(id,index)}}"removePanelWidget"===type&&(itemType="panel",msg=i18n.i18nString("confirm_delete_panel"),header=i18n.i18nString("remove_Widget"),confirmDelete=function(){$scope.removeExistingWidgets(id,index)}),$scope.$emit("lockTaskEvent",editItem,itemType,{success:function(){NotificationService.alert(msg,[confirmDelete,cancelDelete],{okText:i18n.i18nString("delete"),cancelText:i18n.i18nString("cancel"),addHtmlContent:!0},"",void 0,header)},failure:function(){console.log("Task locked")}})},$scope.deletePannel=function(panelId,index){BTStreamsService.deletePanel($workflowService.selectedStream()._id,panelId).then(function(res){var deleteIndex=-1,panel=null;$.each($scope.panels,function(i,panelData){panelId===panelData._id&&(deleteIndex=i,panel=angular.copy(panelData))}),deleteIndex>-1&&($scope.panels.splice(deleteIndex,1),$scope.newfilteredPanels=[]),$scope.panels&&$scope.panels.length&&($scope.newfilteredPanels=[],_.forEach($scope.panels,function(panel){"configured"===panel.state&&$scope.newfilteredPanels.push(panel)})),panel&&$scope.panelObj&&$scope.panelObj.indevelopment&&$scope.panelObj.indevelopment[panel.refId]&&delete $scope.panelObj.indevelopment[panel.refId],$scope.universalBot&&$scope.getWidgets(),$scope.stream._taskCounts&&$scope.stream._taskCounts.panels&&($scope.stream._taskCounts.panels.indevelopment=Object.keys($scope.panelObj.indevelopment).length,$scope.stream._taskCounts.totalIndevelopment=$scope.stream._taskCounts.totalIndevelopment-1,$scope.stream._taskCounts.totalTasks=$scope.stream._taskCounts.totalTasks-1,$scope.stream._taskCounts.totalTasksInUse=$scope.stream._taskCounts.totalTasksInUse-1,$scope.update&&$scope.updateStreamData&&$scope.updateStreamData($scope.stream)),$scope.getPanelsOrWidgetsCountByState(),NotificationService.notify(i18n.i18nString("panel_deleted"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_deleting_panel"),"error")})},$scope.deleteWidget=function(widgetId,index){$scope.panelManagementInProgress=!0,BTStreamsService.deleteWidget($workflowService.selectedStream()._id,widgetId).then(function(res){var widget=null,deleteIndex=-1;$.each($scope.widgets,function(i,widgetData){widgetId===widgetData._id&&(deleteIndex=i,widget=angular.copy(widgetData))}),deleteIndex>-1&&($scope.widgets.splice(deleteIndex,1),$scope.newfilteredWidgets=[]),$scope.widgets&&$scope.widgets.length&&($scope.newfilteredWidgets=[],_.forEach($scope.widgets,function(widget){"configured"===widget.state&&$scope.newfilteredWidgets.push(widget)})),widget&&$scope.widgetObj&&$scope.widgetObj.indevelopment&&$scope.widgetObj.indevelopment[widget.refId]&&delete $scope.widgetObj.indevelopment[widget.refId],$scope.stream._taskCounts&&$scope.stream._taskCounts.widgets&&($scope.stream._taskCounts.widgets.indevelopment=Object.keys($scope.widgetObj.indevelopment).length,$scope.stream._taskCounts.totalIndevelopment=$scope.stream._taskCounts.totalIndevelopment-1,$scope.stream._taskCounts.totalTasks=$scope.stream._taskCounts.totalTasks-1,$scope.stream._taskCounts.totalTasksInUse=$scope.stream._taskCounts.totalTasksInUse-1,$scope.update&&$scope.updateStreamData&&$scope.updateStreamData($scope.stream)),$scope.getPanelsOrWidgetsCountByState(),NotificationService.notify(i18n.i18nString("widget_deleted"),"success"),$timeout(function(){$scope.panelManagementInProgress=!1})},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_deleting_widget"),"error")})};var bindSearch=function(type){"panels"===type&&setTimeout(function(){$(".panelSearchContainer .searchIconGray").click(function(){$(".panelSearchContainer").addClass("searchInputExpand"),$(".panelTitle").addClass("hide")}),$(".panelSearchContainer .closeCross").click(function(){$scope.searchItem.panelSearch="",$(".panelSearchContainer").removeClass("searchInputExpand"),$(".panelTitle").removeClass("hide")})},500),"widgets"===type&&setTimeout(function(){$(".widgetSearchContainer .searchIconGray").click(function(){$(".widgetSearchContainer").addClass("searchInputExpand"),$(".widgetTitle").addClass("hide")}),$(".widgetSearchContainer .closeCross").click(function(){$scope.searchItem.widgetSearch="",$(".widgetSearchContainer").removeClass("searchInputExpand"),$(".widgetTitle").removeClass("hide")})},500)};$scope.getPanelsOrWidgetsCountByState=function(){$scope.panelObj&&$scope.panelObj[$scope.streamState]&&($scope.panelsCountByState=Object.keys($scope.panelObj[$scope.streamState])),$scope.widgetObj&&$scope.widgetObj[$scope.streamState]&&($scope.widgetsCountByState=Object.keys($scope.widgetObj[$scope.streamState]))},$scope.bindSearch=bindSearch,$scope.getPanels=function(){$scope.panelObj={indevelopment:{},published:{}},$scope.linkedUbWidgets={},BTStreamsService.getBotPanels($workflowService.selectedStream()._id).then(function(res){$scope.loaders.loadingPanels=!1,$scope.panels=res.data,"indevelopment"===$scope.streamState&&($scope.panels=_.filter($scope.panels,function(panel){return!panel.isDeleted}));var panelWidgetMapping={};$.each($scope.panels,function(i,panel){panel.linkedBotWidgets&&$.each(panel.linkedBotWidgets,function(stream,widgetref){widgetref&&widgetref.length&&$.each(widgetref,function(i,widRe){panel.widgets.push(widRe.widgetRefId),$scope.linkedUbWidgets[widRe.widgetRefId]=stream})}),panel&&panel.widgets&&panel.widgets.length&&$.each(panel.widgets,function(i,widget){panelWidgetMapping[widget]||(panelWidgetMapping[widget]={indevelopment:[],published:[]}),"published"===panel.state||"suspended"===panel.state?panelWidgetMapping[widget].published.push(panel):("configured"===panel.state||"awaitingApproval"===panel.state||"rejected"===panel.state)&&panelWidgetMapping[widget].indevelopment.push(panel)}),"published"===panel.state||"suspended"===panel.state?$scope.panelObj.published[panel.refId]=panel:("configured"===panel.state||"awaitingApproval"===panel.state||"rejected"===panel.state)&&($scope.panelObj.indevelopment[panel.refId]=panel)}),$scope.panelWidgetMapping=panelWidgetMapping,$scope.selectedPanelToEdit&&$scope.selectedPanelToEdit.refId&&$scope.panelObj.indevelopment[$scope.selectedPanelToEdit.refId]&&($scope.selectedPanelToEdit=$scope.panelObj.indevelopment[$scope.selectedPanelToEdit.refId]),$scope.getWidgets(),setTimeout(function(){$scope.loaders.fetchingPanels=!1}),$scope.getPanelsOrWidgetsCountByState(),$scope.bindSearch("panels")},function(error){if($scope.loaders.loadingPanels=!1,$scope.loaders.fetchingPanels=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_fetching_panel"),"error")})},$scope.resetWidgetPreviw=function(widget){widget.preview=null,setTimeout(function(){widget&&widget.meta&&widget.meta.previewJson&&widget.meta.previewJson.data&&widget.meta.previewJson.data.length?widget.preview=$scope.getWidgetPreview(null,widget._id,widget.meta.previewJson.data[0]):widget.preview=null},100)},$scope.getWidgets=function(botid){$scope.loaders.loadingLinkedBotWidgets=!0;var streamId=botid||$workflowService.selectedStream()._id;BTStreamsService.getBotWidgets(streamId).then(function(res){botid?($scope.linkedbotWidgets[botid]=_.filter(res.data,function(widget){return!widget.isDeleted&&("configured"===widget.state||"awaitingApproval"===widget.state||"rejected"===widget.state)}),$scope.linkedbotWidgets[botid].length||NotificationService.notify(i18n.i18nString("no_widgets"),"error"),$scope.loaders.loadingLinkedBotWidgets=!1):(prepareWidgetsData(res.data),setTimeout(function(){$scope.loaders.loadingWidgets=!1,$scope.loaders.fetchingWidgets=!1}),$scope.bindSearch("widgets"))},function(error){if($scope.loaders.loadingLinkedBotWidgets=!1,$scope.loaders.loadingWidgets=!1,$scope.loaders.fetchingWidgets=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_fetching_panel"),"error")})},$scope.updatepanelWidgetmapping=function(){var panelWidgetMapping={};$.each($scope.panels,function(i,panel){panel.linkedBotWidgets&&$.each(panel.linkedBotWidgets,function(stream,widgetref){widgetref&&widgetref.length&&$.each(widgetref,function(i,widRe){panel.widgets.push(widRe.widgetRefId),$scope.linkedUbWidgets[widRe.widgetRefId]=stream})}),panel&&panel.widgets&&panel.widgets.length&&$.each(panel.widgets,function(i,widget){panelWidgetMapping[widget]||(panelWidgetMapping[widget]={indevelopment:[],published:[]}),"published"===panel.state||"suspended"===panel.state?panelWidgetMapping[widget].published.push(panel):("configured"===panel.state||"awaitingApproval"===panel.state||"rejected"===panel.state)&&panelWidgetMapping[widget].indevelopment.push(panel)}),"published"===panel.state||"suspended"===panel.state?$scope.panelObj.published[panel.refId]=panel:("configured"===panel.state||"awaitingApproval"===panel.state||"rejected"===panel.state)&&($scope.panelObj.indevelopment[panel.refId]=panel)}),$scope.panelWidgetMapping=panelWidgetMapping},$scope.getPanelsAndWidgets=function(){$scope.getPanels()},$scope.getWidgetPreview=function(panelId,widgetId,templateInfo){if(templateInfo){var templateData=angular.copy(templateInfo);if(templateData.templateType){var panelDetail={subpanel:widgetId,widgetTemplate:templateData.templateType,viewmore:!1,showAll:!0,builderRequest:!0},template=wSdk.getHTMLTemplate(templateData,{passedkey:panelDetail});return $(template).wrapAll("<div>").parent().html()}}},$scope.getPanelsAndWidgets(),$scope.savePannel=function(form){function proceedSave(){var payload={};$scope.createPanelObj&&$scope.createPanelObj._id?(payload={name:$scope.createPanelObj.name,title:$scope.createPanelObj.title,widgets:$scope.createPanelObj.widgets,autoRefresh:$scope.createPanelObj.autoRefresh,icon:$scope.createPanelObj.icon,meta:$scope.createPanelObj.meta||{}},$scope.universalBot&&(payload={name:$scope.createPanelObj.name,title:$scope.createPanelObj.title,autoRefresh:$scope.createPanelObj.autoRefresh,icon:$scope.createPanelObj.icon,meta:$scope.createPanelObj.meta||{}},payload.linkedBotWidgets=$scope.createPanelObj.linkedBotWidgets),$scope.updatePannelById($scope.createPanelObj._id,null,payload,"update")):($scope.savingPannel=!0,payload={name:$scope.createPanelObj.name,title:$scope.createPanelObj.title,widgets:[],autoRefresh:$scope.createPanelObj.autoRefresh},$scope.createPanelObj.icon&&""!==$scope.createPanelObj.icon.trim()&&(payload.icon=$scope.createPanelObj.icon),BTStreamsService.createPanel($workflowService.selectedStream()._id,payload).then(function(res){var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Digital Tasks - Digital Views"};mixPanel.postEvent("Digital Tasks - Digital View Panel Created",eventInfo),$scope.panels.push(res.data),$scope.panels&&$scope.panels.length&&($scope.newfilteredPanels=[],_.forEach($scope.panels,function(panel){"configured"===panel.state&&$scope.newfilteredPanels.push(panel)})),res.data&&res.data.refId&&($scope.panelObj.indevelopment[res.data.refId]=res.data),NotificationService.notify(i18n.i18nString("panel_created"),"success"),$scope.stream._taskCounts&&$scope.stream._taskCounts.panels&&($scope.stream._taskCounts.panels.indevelopment=Object.keys($scope.panelObj.indevelopment).length,$scope.stream._taskCounts.totalIndevelopment=$scope.stream._taskCounts.totalIndevelopment+1,$scope.stream._taskCounts.totalTasks=$scope.stream._taskCounts.totalTasks+1,$scope.stream._taskCounts.totalTasksInUse=$scope.stream._taskCounts.totalTasksInUse+1,$scope.update&&$scope.updateStreamData&&$scope.updateStreamData($scope.stream)),$scope.cleanSliderVariablesVariables(!0),form_util.makeItClean(form),$scope.savingPannel=!1,$scope.getPanelsOrWidgetsCountByState()},function(error){if($scope.savingPannel=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_create_panel"),"error")}))}if(form&&form.$invalid)return void form_util.touch(form);if(!$scope.savingPannel)if($scope.createPanelObj&&$scope.createPanelObj._id||($scope.savingPannel=!0),$scope.createPanelObj.icon&&$scope.createPanelObj.icon.trim()){var validUrl=!1,checkingUrl=!1;if(validUrl=$scope.is_url($scope.createPanelObj.icon),!validUrl){var urlCallback=function(url,status){"success"===status?(validUrl=!0,$scope.createPanelObj.checkingUrl=!1,$scope.createPanelObj.invalidImage=!1,proceedSave()):($scope.savingPannel=!1,$scope.createPanelObj.invalidImage=!0),checkingUrl=!1,$scope.createPanelObj.checkingUrl=!1};checkingUrl||(checkingUrl=!0,$scope.createPanelObj.checkingUrl=!0,$scope.checkImage($scope.createPanelObj.icon,urlCallback))}if(!validUrl&&checkingUrl)return!1;if(!validUrl)return $scope.createPanelObj.invalidImage=!0,$scope.savingPannel=!1,!1;proceedSave(),$scope.createPanelObj.invalidImage=!1}else proceedSave()},$scope.selectBot=function(bot){$scope.selectedBot=bot,$scope.getWidgets(bot._id)},$scope.selectWidgetFromDropDown=function(widget){$scope.selectedWidget=widget,$scope.selectedWidget.preview=$scope.getWidgetPreview(null,widget._id,widget.meta.previewJson.data[0])},$scope.addExistingWidgets=function(selectedWidget){$scope.selectedPanelToEdit.widgets||($scope.selectedPanelToEdit.widgets=[]),selectedWidget&&$scope.selectedPanelToEdit.widgets.push(selectedWidget),$scope.selectedPanelToEdit.widgets=_.uniq($scope.selectedPanelToEdit.widgets);var payload={name:$scope.selectedPanelToEdit.name,title:$scope.selectedPanelToEdit.title,widgets:$scope.selectedPanelToEdit.widgets,autoRefresh:$scope.selectedPanelToEdit.autoRefresh,icon:$scope.selectedPanelToEdit.icon,meta:$scope.selectedPanelToEdit.meta||{}};if(this.universalBot){payload={name:$scope.selectedPanelToEdit.name,title:$scope.selectedPanelToEdit.title,linkedBotWidgets:$scope.selectedPanelToEdit.linkedBotWidgets||{},autoRefresh:$scope.selectedPanelToEdit.autoRefresh,icon:$scope.selectedPanelToEdit.icon,meta:$scope.selectedPanelToEdit.meta||{}},payload.linkedBotWidgets[$scope.selectedBot._id]||(payload.linkedBotWidgets[$scope.selectedBot._id]=[]);var tempObj={widgetRefId:selectedWidget,name:$scope.selectedWidget.name},widget=_.find(payload.linkedBotWidgets[$scope.selectedBot._id],{widgetRefId:selectedWidget});if(widget&&widget.widgetRefId)return void NotificationService.notify(i18n.i18nString("selected_widget_is_already_part_of")+$scope.selectedPanelToEdit.name);payload.linkedBotWidgets[$scope.selectedBot._id].push(tempObj)}$scope.updatePannelById($scope.selectedPanelToEdit._id,null,payload,"add")},$scope.switchTopanel=function(){$scope.selectedSlider="panelManagement",$scope.selectedWidget={}},$scope.removeExistingWidgets=function(removedWidget,index){var deleteWidgetId=$scope.selectedPanelToEdit.widgets[index];removedWidget&&$scope.selectedPanelToEdit.widgets.splice(index,1);var payload={name:$scope.selectedPanelToEdit.name,title:$scope.selectedPanelToEdit.title,widgets:$scope.selectedPanelToEdit.widgets,autoRefresh:$scope.selectedPanelToEdit.autoRefresh,icon:$scope.selectedPanelToEdit.icon,meta:$scope.selectedPanelToEdit.meta||{}};$scope.universalBot&&($scope.selectedPanelToEdit.linkedBotWidgets&&$.each($scope.selectedPanelToEdit.linkedBotWidgets,function(stream,widgetref){if(widgetref&&widgetref.length){var removeIndex=-1;$.each(widgetref,function(i,widRe){deleteWidgetId===widRe.widgetRefId&&(removeIndex=i)}),removeIndex>-1&&widgetref.splice(removeIndex,1)}}),payload={name:$scope.selectedPanelToEdit.name,title:$scope.selectedPanelToEdit.title,linkedBotWidgets:$scope.selectedPanelToEdit.linkedBotWidgets,autoRefresh:$scope.selectedPanelToEdit.autoRefresh,icon:$scope.selectedPanelToEdit.icon,meta:$scope.selectedPanelToEdit.meta||{}}),$scope.updatePannelById($scope.selectedPanelToEdit._id,null,payload,"remove")},$scope.saveWidget=function(form,editWidget,updatePreview){if("json"===$scope.createWidgetObj.source.type){if($scope.createWidgetObj.source.resource.isMarkDown&&(!$scope.createWidgetObj.source.resource.markUp||$scope.createWidgetObj.source.resource.markUp&&!$scope.createWidgetObj.source.resource.markUp.trim()))return void NotificationService.notify(i18n.i18nString("please_provide_json"),"error");if(!$scope.createWidgetObj.source.resource.isMarkDown&&(!$scope.createWidgetObj.source.resource.jsCode||$scope.createWidgetObj.source.resource.jsCode&&!$scope.createWidgetObj.source.resource.jsCode.trim()))return void NotificationService.notify(i18n.i18nString("please_provide_json"),"error")}if(form&&form.$invalid)return void form_util.touch(form);if((!$scope.savingWidget||updatePreview)&&(!updatePreview||!$scope.savingWidgetPreview)&&$scope.createWidgetObj.source.resource){updatePreview?$scope.savingWidgetPreview=!0:$scope.savingWidget=!0;var payload={name:$scope.createWidgetObj.name,title:$scope.createWidgetObj.title,cacheInterval:30,autoRefresh:{enabled:$scope.createWidgetObj.autoRefresh.enabled,interval:$scope.createWidgetObj.autoRefresh.interval},source:{type:$scope.createWidgetObj.source.type,resource:""},fields:[],contextMap:"",authProfiles:[]};if($scope.createWidgetObj.templateType&&$scope.createWidgetObj.templateType&&(payload.templateType=$scope.createWidgetObj.templateType),$scope.createWidgetObj.description&&"string"==typeof $scope.createWidgetObj.description&&$scope.createWidgetObj.description.trim()&&(payload.description=$scope.createWidgetObj.description.trim()),$scope.createWidgetObj.meta&&$scope.createWidgetObj.meta&&(payload.meta=$scope.createWidgetObj.meta),"json"===$scope.createWidgetObj.source.type)payload.source.resource={type:"uxmap",text:encodeJS($scope.createWidgetObj.source.resource.jsCode)},(!payload.source.resource.text||payload.source.resource.text&&!payload.source.resource.text.trim())&&NotificationService.notify(i18n.i18nString("please_provide_json"),"error");else if(("dialog"==$scope.createWidgetObj.source.type||"form"==$scope.createWidgetObj.source.type)&&(payload.source.resource=$scope.createWidgetObj.source.resource,!payload.source.resource&&"form"==$scope.createWidgetObj.source.type))return void NotificationService.notify(i18n.i18nString("please_select_form"),"error");"form"==$scope.createWidgetObj.source.type&&(payload.formDialogIntegration=$scope.createWidgetObj.formDialogIntegration,payload.autoRefresh.enabled=!1);var tempContextValue=$scope.contextVariable.concat($scope.tempObj.contextMap),validContext=[];if(tempContextValue&&tempContextValue.length&&(validContext=_.filter(tempContextValue,function(item){return item.key&&""!==item.key.trim()?item:void 0})),validContext&&validContext.length&&(payload.contextMap=JSON.stringify(validContext)),$scope.createWidgetObj.fields&&$scope.createWidgetObj.fields.length){var existingfields=_.filter($scope.createWidgetObj.fields,function(item){return item.label&&""!==item.label.trim()?item:void 0});existingfields&&existingfields.length&&(payload.fields=payload.fields.concat(existingfields))}if($scope.tempObj.entityPreAssign&&$scope.tempObj.entityPreAssign.length){var fields=_.filter($scope.tempObj.entityPreAssign,function(item){return item.label&&""!==item.label.trim()?item:void 0});fields&&fields.length&&(payload.fields=payload.fields.concat(fields))}"editWidget"===$scope.selectedSlider||editWidget?BTStreamsService.updateWidgetById($workflowService.selectedStream()._id,$scope.createWidgetObj._id,payload).then(function(res){var editIndex=-1;$.each($scope.widgets,function(i,item){item._id===res.data._id&&(editIndex=i)}),$scope.widgets[editIndex].loadingPreview=!0,res.data.loadingPreview=!0,res.data&&res.data.meta&&res.data.meta.previewJson&&res.data.meta.previewJson.data&&res.data.meta.previewJson.data.length?res.data.preview=$scope.getWidgetPreview(null,res.data._id,res.data.meta.previewJson.data[0]):res.data.preview=null,"configured"==res.data.state||"awaitingApproval"==res.data.state||"rejected"===res.data.state?$scope.widgetObj.indevelopment[res.data.refId]=res.data:$scope.widgetObj.published[res.data.refId]=res.data,editIndex>-1&&($scope.widgets[editIndex]=res.data,setTimeout(function(){$scope.widgets[editIndex].loadingPreview=!1},300)),updatePreview?$scope.closeRunPreview():($scope.selectedPanelToEdit&&$scope.selectedPanelToEdit._id?$scope.switchSliderStep("panelManagement",form,$scope.createWidgetObj):$scope.cleanSliderVariablesVariables(!0,form,$scope.createWidgetObj),form_util.makeItClean(form)),$scope.savingWidget=!1,$scope.savingWidgetPreview=!1;var msg=i18n.i18nString("widget_updated");updatePreview&&(msg=i18n.i18nString("widget_preview")),NotificationService.notify(msg,"success")},function(error){var msg=i18n.i18nString("error_update_widget");if(updatePreview&&(msg=i18n.i18nString("error_widget_preview")),$scope.savingWidget=!1,$scope.savingWidgetPreview=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg1=error.errors[0].msg;NotificationService.notify(msg1,"error")}else NotificationService.notify(msg,"error")}):BTStreamsService.createWidget($workflowService.selectedStream()._id,payload).then(function(res){try{var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L3",Category:"Engagement L3","Sub Category":"Digital Tasks - Digital Views"};res.data.source&&res.data.source.type&&(eventInfo["DV Widget Type"]=res.data.source.type),mixPanel.postEvent("Digital Tasks - Digital View Panel Widget Added",eventInfo)}catch(e){console.log(e)}if($scope.widgets.push(res.data),$scope.widgets&&$scope.widgets.length&&($scope.newfilteredWidgets=[],_.forEach($scope.widgets,function(widget){"configured"===widget.state&&$scope.newfilteredWidgets.push(widget)})),$scope.widgetObj||($scope.widgetObj={indevelopment:{},published:{}}),$scope.widgetObj.indevelopment[res.data.refId]=res.data,$scope.savingWidget=!1,$scope.selectedPanelToEdit&&$scope.selectedPanelToEdit._id?($scope.addExistingWidgets(res.data.refId),form&&form_util.makeItClean(form),form_util.makeItClean(form),$scope.selectedSlider="panelManagement"):(NotificationService.notify(i18n.i18nString("widget_success"),"success"),$scope.cleanSliderVariablesVariables(!0),form_util.makeItClean(form)),$scope.stream._taskCounts&&$scope.stream._taskCounts.widgets){$scope.stream._taskCounts.widgets.indevelopment=Object.keys($scope.widgetObj.indevelopment).length,$scope.stream._taskCounts.totalIndevelopment=$scope.stream._taskCounts.totalIndevelopment+1,$scope.stream._taskCounts.totalTasks=$scope.stream._taskCounts.totalTasks+1,$scope.stream._taskCounts.totalTasksInUse=$scope.stream._taskCounts.totalTasksInUse+1;var stream=$scope.stream;$scope.update&&$scope.updateStreamData&&$scope.updateStreamData(stream)}$scope.getPanelsOrWidgetsCountByState()},function(error){if($scope.savingWidget=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_widget"),"error")})}},$scope.uploadStreamIcon=function(showNotification){$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.createPanelObj.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.createPanelObj.iconFile.name,fileId:response.data.fileId};$scope.createPanelObj.iconInfo=fileUploaded,showNotification&&NotificationService.notify(i18n.i18nString("filename_uploaded",{fileName:fileUploaded.fileName}),"success"),getBase64($scope.createPanelObj.iconFile),$scope.iconUploading=!1},function(response){showNotification&&NotificationService.notify(i18n.i18nString("oops")+response.data.errors[0].msg,"error"),$scope.iconUploading=!1})},$scope.runPreview=function(run){$scope.widgetPreviewObj={testPreview:!0,loadingPreview:!0,selectedWidget:$scope.createWidgetObj,preview:null,previewObj:null},runWidget=function(jwtInfo){var url="widgetsdk/"+$workflowService.selectedStream()._id+"/widgets/"+$scope.createWidgetObj._id,method="post",payload={from:botOptions.userIdentity||"user-name",inputs:{}},userInputs={};return $scope.createWidgetObj&&$scope.createWidgetObj.fields&&$scope.createWidgetObj.fields.length&&$.each($scope.createWidgetObj.fields,function(index,field){field&&field.label&&(userInputs[field.label]||(userInputs[field.label]=field.defaultValue))}),payload.inputs=userInputs,url=$scope.resolveUrl(url,{userId:$applicationService.userInfo()},!1),$.ajax({url:window.baseUrl+"/"+url,type:method,data:JSON.stringify(payload),contentType:"application/json",async:!0,beforeSend:function(xhr){xhr.setRequestHeader("Authorization","bearer "+jwtInfo)},success:function(responseData){responseData&&responseData.data&&responseData.data.length&&(responseData.data[0].elements&&1===responseData.data[0].elements.length&&responseData.data[0].elements[0].title&&"Access Required"===responseData.data[0].elements[0].title&&responseData.data[0].elements[0].text&&responseData.data[0].elements[0].text.startsWith(i18n.i18nString("click_grant"))?($scope.widgetPreviewObj.previewObj=responseData,$scope.widgetPreviewObj.authorizationNeeded=responseData.data[0].elements[0],
$scope.widgetPreviewObj.preview=null):($scope.widgetPreviewObj.authorizationNeeded=null,$scope.widgetPreviewObj.previewObj=responseData,"string"==typeof responseData.data[0]||"object"==typeof responseData.data[0]&&(!responseData.data[0].formLink&&!responseData.data[0].elements||responseData.data[0].elements&&!responseData.data[0].elements.length)?$scope.widgetPreviewObj.previewObj=null:responseData.data[0].formLink?($scope.widgetPreviewObj.disableSave=!0,$scope.widgetPreviewObj.preview=$scope.getWidgetPreview(null,$scope.createWidgetObj._id,responseData.data[0],!0)):$scope.widgetPreviewObj.preview=$scope.getWidgetPreview(null,$scope.createWidgetObj._id,responseData.data[0]))),setTimeout(function(){$scope.widgetPreviewObj.loadingPreview=!1},100)},error:function(err){var panelDetail={subpanel:$scope.createWidgetObj._id,viewmore:!1,showAll:!0,builderRequest:!0},xhrObject={},dataHTML=$(wSdk.getTemplate("ErrorTemplate")).tmplProxy({tempdata:xhrObject,panelDetail:panelDetail});$scope.widgetPreviewObj.preview=dataHTML[0].outerHTML,$scope.widgetPreviewObj.loadingPreview=!1}})},getJWT(runWidget)},$scope.authorization=function(){function checkChild(){child&&"object"==typeof child&&child.closed&&($scope.runPreview(),clearInterval(timer))}var child;if($scope.widgetPreviewObj.authorizationNeeded&&$scope.widgetPreviewObj.authorizationNeeded.defaultAction&&$scope.widgetPreviewObj.authorizationNeeded.defaultAction.url){child=window.open($scope.widgetPreviewObj.authorizationNeeded.defaultAction.url);var timer=setInterval(checkChild,500)}},$scope.closeRunPreview=function(){$scope.widgetPreviewObj={testPreview:!1,loadingPreview:!0,selectedWidget:null,preview:null,previewObj:null}},$scope.saveWidgetPreview=function(form){$scope.widgetPreviewObj.previewObj&&($scope.createWidgetObj.meta={previewJson:$scope.widgetPreviewObj.previewObj}),$scope.saveWidget(form,!0,!0)},$scope.selectWidgetSourceType=function(type){"json"==type?($scope.createWidgetObj.autoRefresh.enabled=!0,$scope.createWidgetObj.source.resource={type:"uxmap",isMarkDown:!1}):"form"===type?($scope.createWidgetObj.source.resource="",$scope.createWidgetObj.autoRefresh.enabled=!1):($scope.createWidgetObj.autoRefresh.enabled=!0,$scope.createWidgetObj.source.resource="")},$scope.selectJsonEditor=function(type){if(type&&"uxmap"===type){if($scope.createWidgetObj.source.resource.markUp&&$scope.createWidgetObj.source.resource.markUp.trim())return void NotificationService.notify(i18n.i18nString("standard_mode"));$scope.createWidgetObj.source.resource={type:"uxmap",isMarkDown:!1}}else{if($scope.createWidgetObj.source.resource.jsCode&&$scope.createWidgetObj.source.resource.jsCode.trim())return void NotificationService.notify(i18n.i18nString("standard_mode"));$scope.createWidgetObj.source.resource={type:"basic"}}$scope.nofocus=!1},$scope.getAvailableWidgetsForPanel=function(panel){$scope.selectedWidget={};var availableWidgets=[];$scope.selectedPanelToEdit&&($scope.selectedPanelToEdit.availableWidgetsToAdd=angular.copy($scope.widgets),panel&&panel.widgets.length&&$scope.selectedPanelToEdit.availableWidgetsToAdd.length&&($.each($scope.selectedPanelToEdit.availableWidgetsToAdd,function(i,widget){var widgetAdded=!1;$.each(panel.widgets,function(j,refId){widget.refId===refId&&(widgetAdded=!0)}),widgetAdded||availableWidgets.push(widget)}),$scope.selectedPanelToEdit.availableWidgetsToAdd=availableWidgets))},$scope.selectDialog=function(id){_.find($scope.dialogTasksforWidget,{refId:$scope.createWidgetObj.source.payload.resource});$workflowService.flowtaskInfo(entity),entity.taskType="flowTask",locked?entity.editComponentLockInView=!0:entity.editComponentLockInView=!1,$workflowService.taskEditInfo(entity),$workflowService.flowtaskInfo(entity),$workflowService.taskMode("view"),$scope.selectedDialogData=entity},$scope.openDialogFlow=function(dialog){if(dialog){var entity=_.find($scope.dialogTasksforWidget,{refId:dialog});entity&&($workflowService.flowtaskInfo(entity),entity.taskType="flowTask",$workflowService.taskEditInfo(entity),$workflowService.flowtaskInfo(entity),$workflowService.taskMode("view"),$scope.selectedDialogData=entity,setTimeout(function(){$("body").hasClass("bt-modal-open")||$("body").addClass("bt-modal-open"),$scope.showDialogContainer=!0})),console.log("dialog not found")}else NotificationService.notify(i18n.i18nString("please_select_dialog"),"error")},$scope.resolveUrl=function(toResolveUrl,values,deleteProp){var _regExToParamName=/\:([a-zA-Z]+)/g;return toResolveUrl.replace(_regExToParamName,function(matchStr,valName){var r=values[valName];return"undefined"!=typeof r&&null!==typeof r?(deleteProp&&delete values[valName],r):matchStr})},$scope.autocomplete=function(e,list,index){function addActive(x){return x?(removeActive(x),currentFocus>=x.length&&(currentFocus=0),0>currentFocus&&(currentFocus=x.length-1),void x[currentFocus].classList.add("autocomplete-active")):!1}function removeActive(x){for(var i=0;i<x.length;i++)x[i].classList.remove("autocomplete-active")}function closeAllLists(elmnt){for(var x=document.getElementsByClassName("autocomplete-items"),i=0;i<x.length;i++)elmnt!=x[i]&&elmnt!=inp&&x[i].parentNode.removeChild(x[i])}var documentEvent=function(e){closeAllLists(e.target)};$scope.currentFocussedIndex=index;var inp,arr;if($scope.prePopulations&&$scope.prePopulations.length){if(arr=$scope.prePopulations,!e)return;inp=document.getElementById(e.currentTarget.id);var currentFocus,inputEvent=function(e){var a,b,i,val=this.value;if(closeAllLists(),!val)return!1;for(currentFocus=-1,a=document.createElement("DIV"),a.setAttribute("id",this.id+"autocomplete-list"),a.setAttribute("class","autocomplete-items"),this.parentNode.appendChild(a),i=0;i<arr.length;i++)arr[i].substr(0,val.length).toUpperCase()==val.toUpperCase()&&(b=document.createElement("DIV"),b.innerHTML="<strong>"+arr[i].substr(0,val.length)+"</strong>",b.innerHTML+=arr[i].substr(val.length),b.innerHTML+="<input type='hidden' value='"+arr[i]+"'>",b.addEventListener("click",function(e){list&&list.length&&list[$scope.currentFocussedIndex]?list[$scope.currentFocussedIndex].label=this.getElementsByTagName("input")[0].value:$scope.tempObj.addPreAssighment.label=this.getElementsByTagName("input")[0].value,inp.value=this.getElementsByTagName("input")[0].value,closeAllLists()}),a.appendChild(b))},keydownEvent=function(e){var x=document.getElementById(this.id+"autocomplete-list");x&&(x=x.getElementsByTagName("div")),40==e.keyCode?(currentFocus++,addActive(x)):38==e.keyCode?(currentFocus--,addActive(x)):13==e.keyCode&&(e.preventDefault(),currentFocus>-1&&x&&x[currentFocus].click())};inp.removeEventListener("input",inputEvent),inp.addEventListener("input",inputEvent),inp.removeEventListener("keydown",keydownEvent),inp.addEventListener("keydown",keydownEvent),document.removeEventListener("click",documentEvent),document.addEventListener("click",documentEvent)}},$scope.focusOnViewsInput=function(value){"panelValue"===value?$(".panelsHeader .languageSettingsdropdown .searchComponent").css("border","1px solid #0D6EFD"):"widgetsValue"==value&&$(".widgetsHeader .languageSettingsdropdown .searchComponent").css("border","1px solid #0D6EFD")},$scope.focusOutViewsInput=function(value){"panelValue"===value?$(".panelsHeader .languageSettingsdropdown .searchComponent").css("border","none"):"widgetsValue"==value&&$(".widgetsHeader .languageSettingsdropdown .searchComponent").css("border","none")},$scope.clearSearch=function(value){"panelValue"===value?($(".panelsHeader .languageSettingsdropdown .searchComponent").css("border","none"),$scope.searchItem.panelSearch=""):"widgetsValue"==value&&($(".widgetsHeader .languageSettingsdropdown .searchComponent").css("border","none"),$scope.searchItem.widgetSearch="")}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("scrollPaginate",function(){return{restrict:"EA",link:function($scope,element,attrs){var _batchSize=10;element.bind("scroll",function(e){var _currEle=e.currentTarget;_currEle.scrollTop+_currEle.offsetHeight>=.9*_currEle.scrollHeight&&($scope.loadingClientBatch=!0,$scope.updateClientBatch(_batchSize))})}}}),_module.directive("focusIn",function(){return{restrict:"AE",link:function($scope,$element,$attrs){$element.on("click",function(){$element.addClass("noBackGround")}),$element.on("focusout",function(){$element.removeClass("noBackGround")})}}}),_module.directive("btPattern",[function(){return{restrict:"EA",scope:{selectedTask:"=?",type:"@",cb:"=",tasks:"=",viewMode:"=",showTrain:"=?",saveStatusPattern:"=?",views:"=?",showIntentsLabel:"=?",search:"=?",iPatterns:"=?",upgradeTask:"=?",flowTaskMode:"@",upgradeViewMode:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-pattern/bt-pattern.html",controller:["$scope","_constants_","$workflowService","env_conf","BTStreamsService","BTFlowtaskService","i18n","$timeout","BTAlertsService","BTActionsService","$rootScope","$q","$applicationService","$filter","$element","mixPanel",function($scope,_constants_,$workflowService,env_conf,BTStreamsService,BTFlowtaskService,i18n,$timeout,BTAlertsService,BTActionsService,$rootScope,$q,$applicationService,$filter,$element,mixPanel){function sortableCallback(e,ui){$timeout(function(){$scope.selectedTask||($scope.selectedTask=$scope.entityPatternsObject.filter(function(item){return item.entity._id===$scope.clickedEntityIndex}));var sortIndex=0;saveEntityPatterns($scope.selectedTask,!0,void 0,sortIndex)},200)}function sortableCallback1(e,ui){$timeout(function(){var sortIndex=0;saveIntentPatterns($scope.selectedTask,!0,void 0,sortIndex)},200)}function sortableCallback2(e,ui){$timeout(function(){if($scope.selectedTask){for(var payload={patterns:[]},i=0;i<$scope.selectedTask.patterns.length;i++){var pattern={};pattern.intend=$scope.selectedTask.patterns[i].intend,pattern.key=$scope.selectedTask.patterns[i].key,pattern.input=$scope.selectedTask.patterns[i].original,payload.patterns.push(pattern)}payload.resourceId=$scope.selectedTask._id,BTStreamsService.taskPattern($scope.stream._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("patrn_module_reorderd_sucess"),"success")})}},200)}function sortableCallback3(e,ui){$timeout(function(){if($scope.selectedTask){for(var payload={fieldPatterns:[]},i=0;i<$scope.selectedTask.fieldPatterns[$scope.currentField].length;i++){var pattern={};pattern.key=$scope.selectedTask.fieldPatterns[$scope.currentField][i].key,pattern.input=$scope.selectedTask.fieldPatterns[$scope.currentField][i].original,payload.fieldPatterns.push(pattern)}payload.fieldName=$scope.currentField,payload.resourceId=$scope.selectedTask._id?$scope.seletedTask._id:$scope.selectedTask.taskId,BTStreamsService.fieldPatternSortOrEdit($scope.stream._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("patrn_module_reorderd_sucess"),"success")})}},200)}function isBotPublished(){return"private"!==$scope.stream.visibility.namespace}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createPattern"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Pattern Added"),"deletePattern"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Pattern Deleted"),"createEntityPattern"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Entity Pattern Added"),"deleteEntityPattern"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Entity Pattern Deleted"),"createTraits"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Rule Added"),"deleteTraits"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Rule Deleted"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function onClickTask(selectedTask,type){selectedTask.intentSection="patterns",$scope.selectedTask=selectedTask,$scope.intent=selectedTask,$(".patternForm-body").animate({scrollTop:0}),type&&($scope.selectedTask.type="alert"===type?"webservice":type),$scope.viewMode&&($scope.displayMode=$scope.viewMode.toUpperCase()),$timeout(function(){$scope.cb.loadingPatterns=!1},200)}function onClickEntity(selectedEntity,type){$scope.selectedTask=selectedEntity,$(".patternForm-body").animate({scrollTop:0}),$scope.ePatterns={},$scope.ePatterns.newEntityPattern="",$scope._type&&($scope._type=""),type&&($scope.selectedTask.type=type),$scope.viewMode&&($scope.displayMode=$scope.viewMode.toUpperCase()),$timeout(function(){$scope.cb.loadingPatterns=!1},200)}function onClickField(selectedField,currentFieldId){$(".patternForm-body").animate({scrollTop:0}),$scope.currentField=currentFieldId,$scope.selectedTask=selectedField,$scope._type="FieldIntent",$scope.viewMode&&($scope.displayMode=$scope.viewMode.toUpperCase()),$scope.upgradeViewMode&&($scope.upgradeDisplayMode=$scope.upgradeViewMode),$scope.tPattern={},$scope.tPattern.newTaskPattern="",$timeout(function(){$scope.cb.loadingPatterns=!1},200)}function onClickTraits(selectedTask,type,traitRules){$scope.selectedTask=selectedTask,$scope.selectedTask.intentSection="traits",$scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.traitRules.traitMappings=JSON.parse(JSON.stringify(traitRules.traitMappings||[])),getTraitsGroupsApi(),type&&($scope.selectedTask.type=type),$scope.viewMode&&($scope.displayMode=$scope.viewMode.toUpperCase()),$timeout(function(){$scope.cb.loadingPatterns=!1},200)}function validateEntityPattern(value){return value&&value.split("*").length-1>=1?!0:!1}function validateFieldPattern(value){return value&&value.split("*").length-1>=1?!0:!1}function getErrorMsg(err,defaultMsg){return err=err&&err.data,err&&err.errors&&err.errors[0]&&err.errors[0].msg||defaultMsg}function createPattern(task,text,isInlineMode){var payload={input:text,intend:task.name,resourceId:task._id};$scope.saving=!0,$scope.saveStatusPattern={initial:!1,pending:!0,completed:!1,failed:!1},BTStreamsService.createPattern($scope.stream._id,payload).then(function(res){isInlineMode||$scope.cancelAddPattern(),$scope.tPattern.newTaskPattern="",$scope.selectedTask.patterns=res.data,$scope.editTaskPattern=null,$scope.saving=!1,$scope.saveStatusPattern={initial:!1,pending:!1,completed:!0,failed:!1},NotificationService.notify(i18n.i18nString("patrn_module_added_sucess"),"success"),$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)},function(err){var msg=getErrorMsg(err,i18n.i18nString("patrn_module_adding_field"));NotificationService.notify(msg,"error"),$scope.saving=!1,$scope.saveStatusPattern={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)})}$scope.iPatterns={},$scope.ePatterns={},$scope.tPattern={},$scope.upgradedTasks=[],$scope.upgradeCopy={},$scope.viewMode&&($scope.displayMode=$scope.viewMode.toUpperCase()),$scope.assetsBase=env_conf["assets-url"],$scope.pencilIcon=env_conf["context-url"]+"/assets/icons/pencilIcon.svg",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.searchClose=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.orIcon=$scope.assetsBase+"icons/orIcon.svg",$scope.stream=$workflowService.selectedStream(),$scope.filterToggle=$workflowService.selectedStreamState(),$scope.constants=_constants_,$scope.emptyPattern=env_conf["context-url"]+"/assets/icons/empty-illustration.svg",$scope.viewImage=env_conf["context-url"]+"/assets/landingImages/icons/eye.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.searchQuery="",$scope._type="",$scope.traitRules={},$scope.upgradeCopyTraits={};var _offset={};_offset.start=0,_offset.limit=10;var dummy_traitAnd=[];$scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.trainStatus={success:!1,failed:!1,saving:!1},$scope.searchIcon=env_conf["context-url"]+"/assets/icons/search.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/icons-new/close/close-dark.svg",setTimeout(function(){"VIEW"!==$scope.displayMode&&$(".newPatternInput").trigger("focus")},350),$scope.back=function(){$scope.closeSearch&&$scope.closeSearch(),$scope.cb.updatePropertyPanel&&$scope.cb.updatePropertyPanel($scope.selectedTask,$scope.traitRules),$(".pattern-modal").modal("hide"),$timeout(function(){$scope.searchQuery="",$scope._type=""})};var returnTraitRules=function(){return $scope.traitRules};$scope.sortableOptions={handle:".sortBar","ui-floating":!0,update:sortableCallback},$scope.sortableOptions1={handle:".sortBar1","ui-floating":!0,update:sortableCallback1},$scope.sortableOptions2={handle:".sortBar2","ui-floating":!0,update:sortableCallback2},$scope.sortableOptions3={handle:".sortBar3","ui-floating":!0,update:sortableCallback3},$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},$scope.showUpgradedAlerts=function(type,upgradedData){var _selectedIntent;_selectedIntent=_.find($scope.alertTasks,{_id:upgradedData._id}),$scope.selectedTask=_selectedIntent,$scope.selectedTask.intentSection="patterns",NotificationService.notify(i18n.i18nString("upgraded_success"),"success"),upgradedData&&"addPattern"===$scope.upgradeCopy.upgradeType&&$scope.saveTaskPatternsObject($scope.selectedTask)},$scope.showUpgradedPattern=function(type,upgradedData){var _selectedNode,_selectedIntent;_selectedNode=_.filter(upgradedData.nodes,{nodeId:"intent0"})[0],_selectedIntent=_.find($scope.tasks,{_id:_selectedNode.componentId}),$scope.selectedTask=_selectedIntent,$scope.selectedTask.intentSection="patterns",NotificationService.notify(i18n.i18nString("upgraded_success"),"success"),upgradedData&&"addPattern"===$scope.upgradeCopy.upgradeType&&saveIntentPatterns($scope.selectedTask)},$scope.showUpgradeRule=function(type,upgradedData){var _selectedNode,_selectedIntent;upgradedData&&"addRule"===$scope.upgradeCopy.upgradeType?("DialogIntent"===type?(_selectedNode=_.filter(upgradedData.nodes,{nodeId:"intent0"})[0],_selectedIntent=_.find($scope.tasks,{_id:_selectedNode.componentId})):_selectedIntent=_.find($scope.tasks,{_id:upgradedData._id}),$scope.selectedTask=_selectedIntent,$scope.selectedTask.intentSection="traits",NotificationService.notify(i18n.i18nString("upgraded_success"),"success"),$scope.traitRules.traitMappings=JSON.parse(JSON.stringify($scope.upgradeCopy.traitMappings||[])),$scope.upgradeCopy&&$scope.upgradeCopy.isDummyTrait?$scope.addTraitDummyAndCondition(0):$scope.addTraitAndCondition()):("DialogIntent"===type?(_selectedNode=_.filter(upgradedData.nodes,{nodeId:"intent0"})[0],_selectedIntent=_.find($scope.tasks,{_id:_selectedNode.componentId}),$scope.selectedTask=_selectedIntent):_selectedIntent=_.find($scope.tasks,{_id:upgradedData._id}),$scope.selectedTask=_selectedIntent,$scope.selectedTask.intentSection="traits",NotificationService.notify(i18n.i18nString("upgraded_success"),"success"))},$scope.resolveAlerts=function(type,upgradedAlerts){BTAlertsService.getAlerts($scope.stream._id).then(function(res){res.data=res.data.map(function(task){return task.taskType="alert",task.intentTypeName="Alert",task.state=task.state.toLowerCase(),("inprogress"===task.state||"suspended"===task.state||"rejected"===task.state)&&(task.hide=!0),task}),res.data=_.filter(res.data,function(d){return!d.hide}),$scope.alertTasks=res.data,$scope.findParenttasks($scope.alertTasks),mapPatternsArray($scope.alertTasks),$scope.showUpgradedAlerts(type,upgradedAlerts),$timeout(function(){$scope.cb.loadingPatterns=!1},500)},function(err){$scope.patternsCB.loadingPatterns=!1,err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})};var mapPatternsArray=function(tasks){tasks.forEach(function(task){task.patterns=task.patterns||[],task.patternsArray=[],task.patterns.forEach(function(msg){msg.original=decodePattern(msg.original),task.patternsArray.push(msg.original)})})};$scope.resolveIntents=function(type,upgradedNodes){$q.all([BTFlowtaskService.getEntitiesOrIntents($scope.stream._id,"intents"),BTFlowtaskService.getFlowtaks($scope.stream._id)]).then(function(res){var componentIDs=[],_filteredNodes=[],filteredDialogTasks=[],_hiddenDialogTaskIds=[];filteredDialogTasks=_.filter(res[1].data,function(task,i){return"inprogress"!==task.state&&"suspended"!==task.state&&"rejected"!==task.state||!task.isDeleted}),$.each(filteredDialogTasks,function(i,dialog){_filteredNodes=_filteredNodes.concat(_.filter(dialog.nodes,{nodeId:"intent0"}))}),_.map(filteredDialogTasks,function(task){task.isDeleted&&_hiddenDialogTaskIds.push(task._id)});var hiddenHelpNodes=_.filter(filteredDialogTasks,function(dialog){return dialog.isHidden}),hiddenHelpIds=_.pluck(hiddenHelpNodes,"_id"),dialogSubIntents=_.filter(filteredDialogTasks,function(dialog){return dialog.isFollowUp});_.pluck(dialogSubIntents,"_id");componentIDs=_.pluck(_filteredNodes,"componentId"),res[0].data=res[0].data.map(function(task){return task.taskType="DialogIntent",task.intentTypeName="Dialog Intent",task.status&&(task.status=task.status.toLowerCase()),task.hasOwnProperty("dialogId")||(task.hide=!0),-1!==$.inArray(task.dialogId,hiddenHelpIds)&&(task.isHidden=!0),-1!==$.inArray(task.dialogId,_hiddenDialogTaskIds)&&(task.isDeleted=!0),"published"!==task.status&&!task.hide&&isBotPublished()&&(task.taskstate="@development"),task}),res[0].data=_.filter(res[0].data,function(task){return!task.hide}),$scope.intentdata=res[0].data,$scope.tasks=[],$scope.tasks=$scope.tasks.concat(res[0].data),$scope.findParenttasks($scope.tasks),mapPatternsArray($scope.tasks),"rules"===$scope.upgradeCopy.upgradeFrom?$scope.showUpgradeRule(type,upgradedNodes):"patterns"===$scope.upgradeCopy.upgradeFrom&&$scope.showUpgradedPattern(type,upgradedNodes),$timeout(function(){$scope.cb.loadingPatterns=!1},500)},function(err){$scope.cb.loadingPatterns=!1,err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.cancelUpgrade=function(){$scope.deleting=!1},$scope.upgradeWorkflow=function(task,type,selectedType,clickedIntentIndex){"alert"===type?BTAlertsService.upgradeBTAlert(task._id).then(function(response){BTAlertsService.upgradeMPAlert(task._id,response.data._id).then(function(upgradeRes){BTAlertsService.configured(upgradeRes.data._id).then(function(configRes){$scope.resolveAlerts(null,configRes.data[0]),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,$scope.cb.loadingPatterns=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,$scope.cb.loadingPatterns=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type?BTActionsService.upgradeBTAction(task._id).then(function(response){BTActionsService.upgradeMPAction(task._id,response.data._id).then(function(upgradeRes){BTActionsService.configured(upgradeRes.data._id).then(function(configRes){$scope.intentPatternsObject[$scope.currenttaskIndex].isParent=!0,loadAlerts(null,configRes.data[0]),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,task.dialogId).then(function(res){$scope.isGlobalWorkProgress=!1,$scope.resolveIntents("DialogIntent",res.data)},function(err){$scope.isGlobalWorkProgress=!1,$scope.cb.loadingPatterns=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?task.isReport?"information":"action":task&&"DialogIntent"==task.taskType?"flowtask":""},$scope.upgrade=function(){$scope.isGlobalWorkProgress=!0,$scope.cb.loadingPatterns=!0,$scope.loaderMessage=i18n.i18nString("upgrading_task_label");var taskType=$scope.getTaskType($scope.currentTask);$scope.upgradeWorkflow($scope.currentTask,taskType),$scope.deleting=!1};var updateComponentPatterns=function(component,msg,index,sortIndex,patternAction){$scope.saveStatusPattern.pending=!0,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1,$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusPattern),BTFlowtaskService.updateComponentPatterns($scope.stream._id,component._id,{patterns:component.patternsArray}).then(function(res){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!0,$scope.saveStatusPattern.failed=!1,$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusPattern),"DialogIntent"!=component.type&&"intent"!=component.type||"deletePattern"!==patternAction?"deleteEntityPattern"===patternAction&&(mixpanelEvent("deleteEntityPattern"),$scope.selectedTask.patterns=res.data.patterns||[],$scope.entities=$scope.selectedTask):(mixpanelEvent("deletePattern"),$scope.selectedTask.patterns=res.data.patterns||[]),"DialogIntent"!=component.type&&"intent"!=component.type||"intentPatternAdded"!==patternAction?"entityPatternAdded"===patternAction&&(mixpanelEvent("createEntityPattern"),$scope.selectedTask.patterns=res.data.patterns||[],$scope.entities=$scope.selectedTask):(mixpanelEvent("createPattern"),$scope.selectedTask.patterns=res.data.patterns||[]),index>=0?NotificationService.notify(i18n.i18nString("patrn_module_pattern_updated_success"),"success"):sortIndex>=0?NotificationService.notify(i18n.i18nString("patrn_module_reorderd_sucess"),"success"):(msg=msg||i18n.i18nString("patrn_module_added_sucess"),NotificationService.notify(msg,"success")),"DialogIntent"==component.type||"intent"==component.type?($scope.iPatterns.newIntentPattern="",$scope.iPatterns.editIntentPattern=""):($scope.ePatterns.newEntityPattern="",$scope.ePatterns.editEntityPattern="",$scope.tPattern.editTaskPattern=""),$timeout(function(){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!0,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1,$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusPattern)},3e3)},function(err){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!0,$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusPattern),err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error"),$timeout(function(){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!0,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1,$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusPattern)},3e3)})},saveIntentPatterns=function(intent,isIntentSortFrom,index,sortIndex,pattern){if("indevelopment"===$scope.filterToggle){var key="state";if("DialogIntent"===intent.type&&(key="status"),"published"==intent[key])$scope.currentTask=intent,$scope.upgradeCopy.upgradeFrom="patterns",void 0===index&&($scope.currentPattern=$scope.iPatterns.newIntentPattern,$scope.upgradeCopy.upgradeType="addPattern"),NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else if(index>=0){var newIndex;intent.patternsArray=_.pluck(intent.patterns||[],"original")||[],_.forEach(intent.patternsArray,function(value,i){$scope.currentPatternValue&&$scope.currentPatternValue.original&&value===$scope.currentPatternValue.original&&(newIndex=i)}),intent.patternsArray[newIndex]=intent.patternsArray[newIndex].replace(intent.patternsArray[newIndex],$scope.iPatterns.editIntentPattern),updateComponentPatterns(intent,"",newIndex,"","intentPatternAdded"),$(".hidingIntentPatterns"+index).removeClass("hide"),$(".editingIntentPatterns"+index).addClass("hide")}else intent.patternsArray=_.pluck(intent.patterns||[],"original")||[],!isIntentSortFrom&&intent.patternsArray&&intent.patternsArray.length?(intent.patternsArray.push($scope.iPatterns.newIntentPattern),updateComponentPatterns(intent,"",void 0,sortIndex,"intentPatternAdded")):isIntentSortFrom?updateComponentPatterns(intent,"",void 0,sortIndex,"intentPatternAdded"):($scope.currentPattern&&"addPattern"===$scope.upgradeType?intent.patternsArray.push($scope.currentPattern):intent.patternsArray.push($scope.iPatterns.newIntentPattern),updateComponentPatterns(intent,"",void 0,sortIndex,"intentPatternAdded"))}};$scope.saveIntentPatternsObject=function(e,intent,isIntentSortFrom,index,sortIndex,pattern){e&&13===e.keyCode&&(pattern=sortIndex&&sortIndex.original?sortIndex.original:sortIndex,saveIntentPatterns(intent,isIntentSortFrom,index,sortIndex,pattern))},$scope.deleteComponentPattern=function(component,pattern,$event){if(!$scope.deleting&&($scope.deleting=!1,$event.stopPropagation(),"indevelopment"===$scope.filterToggle)){var key="state";if("DialogIntent"===component.type&&(key="status"),"published"==component[key])$scope.currentTask=component,NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{var msg=i18n.i18nString("do_you_want_to_delete_this_pattern"),confirmDeletePattern=function(){component.patternsArray=_.filter(component.patterns,function(patternObject,i){return pattern.original!==patternObject.original})||[],component.patternsArray=_.pluck(component.patternsArray,"original");var msg=i18n.i18nString("patrn_module_patrn_deleted_success"),patternMsg="";patternMsg="DialogIntent"==component.type||"intent"==component.type?"deletePattern":"deleteEntityPattern",updateComponentPatterns(component,msg,"","",patternMsg),$scope.deleting=!1};NotificationService.alert(msg,confirmDeletePattern,arguments)}}};var decodePattern=function(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}};$scope.removeEditMode=function(index){if(index>=0){var _ele=$(".hidingIntentPatterns"+index);$(".hidingIntentPatterns"+index).removeClass("hide"),$(".editingIntentPatterns"+index).addClass("hide"),setTimeout(function(){_ele.parent().hasClass("noBackGround")&&_ele.parent().removeClass("noBackGround")},200)}},$scope.removeEditModeEntity=function(index){if(index>=0){var _ele=$(".hidingEntityPatterns"+index);$(".hidingEntityPatterns"+index).removeClass("hide"),$(".editingEntityPatterns"+index).addClass("hide"),setTimeout(function(){_ele.parent().hasClass("noBackGround")&&_ele.parent().removeClass("noBackGround")},200)}},$scope.currentPatternValue=" ",$scope.clickIntentPattern=function(index,pattern){$scope.currentPatternValue=angular.copy(pattern),$(".intentPatternClass").removeClass("hide"),$(".inputIntentClass").addClass("hide"),$scope.iPatterns.editIntentPattern=decodePattern(pattern.original),$scope.tPattern.editTaskPattern=decodePattern(pattern.original),$(".hidingIntentPatterns"+index).addClass("hide"),
$(".editingIntentPatterns"+index).removeClass("hide"),$(".intentPatternInput"+index).focus()},$scope.clickEntityPattern=function(index,pattern){$(".entityPatternClass").removeClass("hide"),$(".inputEntityClass").addClass("hide"),$scope.ePatterns.editEntityPattern=decodePattern(pattern.original),$(".hidingEntityPatterns"+index).addClass("hide"),$(".editingEntityPatterns"+index).removeClass("hide"),$(".hidingEntityPatterns"+index).focus()};var saveEntityPatterns=function(entity,isFromSort,index,sortIndex){if(index>=0){if(!isFromSort&&!validateEntityPattern($scope.ePatterns.editEntityPattern))return void NotificationService.notify(i18n.i18nString("patrn_module_enter_valid_pattern"),"error");entity.patternsArray[index]=entity.patternsArray[index].replace(entity.patternsArray[index],$scope.ePatterns.editEntityPattern),updateComponentPatterns(entity,"",index,"","entityPatternAdded"),$(".hidingEntityPatterns"+index).removeClass("hide"),$(".editingEntityPatterns"+index).addClass("hide")}else{if(!isFromSort&&!validateEntityPattern($scope.ePatterns.newEntityPattern))return void NotificationService.notify(i18n.i18nString("patrn_module_enter_valid_pattern"),"error");entity.patternsArray=_.pluck(entity.patterns||[],"original")||[],!isFromSort&&entity.patternsArray&&entity.patternsArray.length?(entity.patternsArray.push($scope.ePatterns.newEntityPattern),updateComponentPatterns(entity,"",void 0,sortIndex,"entityPatternAdded")):isFromSort?updateComponentPatterns(entity,"",void 0,sortIndex,"entityPatternAdded"):(entity.patternsArray.push($scope.ePatterns.newEntityPattern),updateComponentPatterns(entity,"",void 0,sortIndex,"entityPatternAdded"))}};$scope.saveEntityPatternsObject=function(e,entity,isFromSort,index,sortIndex){e&&13===e.keyCode&&saveEntityPatterns(entity,isFromSort,index,sortIndex)},$scope.saveOrUpdateFieldPatterns=function(task){var taskId=task._id?task._id:task.taskId;$scope.saveFieldPattern(taskId,$scope.currentField,$scope.tPattern.newTaskPattern)},$scope.getSelectedTaskForPattern=function(){var task=$scope.tasks.filter(function(task){return task._id==($scope.pattern&&$scope.pattern.intent)})[0];return task},$scope.saveFieldPattern=function(taskId,field,input,hideNotify){if(!validateFieldPattern($scope.tPattern.newTaskPattern))return void NotificationService.notify(i18n.i18nString("patrn_module_valid_field_err"),"error");var task=$scope.getSelectedTaskForPattern(),type="l"==(taskId||task._id||task.taskId)[0]?"alert":"action",payload={fieldName:field||$scope.pattern.field,input:input||$scope.pattern.text};taskId=taskId||task._id||task.taskId,field=field||$scope.pattern.field,$scope.saveStatusPattern.pending=!0,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1,$scope.saving=!1,"alert"==type?BTAlertsService.createFieldPattern(taskId,field,payload).then(function(res){hideNotify||NotificationService.notify(i18n.i18nString("patrn_module_added_sucess"),"success"),$scope.selectedTask.fieldPatterns?$scope.selectedTask.fieldPatterns[$scope.currentField]=res.data[$scope.currentField]:($scope.selectedTask.fieldPatterns={},$scope.selectedTask.fieldPatterns[$scope.currentField]=res.data[$scope.currentField]),$scope.saving=!1,$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!0,$scope.saveStatusPattern.failed=!1,$timeout(function(){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!0,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1},3e3),$scope.tPattern.newTaskPattern=""},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("patrn_module_adding_field");hideNotify||NotificationService.notify(msg,"error"),$scope.saving=!1,$scope.tPattern.newTaskPattern="",$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!0,$timeout(function(){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!0,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1},3e3)}):"action"==type&&BTActionsService.createFieldPattern(taskId,field,payload).then(function(res){hideNotify||(NotificationService.notify(i18n.i18nString("patrn_module_added_sucess"),"success"),$scope.cancelFieldPattern()),$scope.selectedTask.fieldPatterns=res.data,$scope.saving=!1,$scope.tPattern.newTaskPattern=""},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("patrn_module_adding_field");hideNotify||NotificationService.notify(msg,"error"),$scope.saving=!1})},$scope.editFieldPatternData=function(selectedTask,index,currentField){if(!validateFieldPattern($scope.tPattern.editTaskPattern))return void NotificationService.notify(i18n.i18nString("patrn_module_valid_field_err"),"error");$scope.saveStatusPattern.pending=!0,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1,selectedTask.fieldPatterns[currentField][index].original=selectedTask.fieldPatterns[currentField][index].original.replace(selectedTask.fieldPatterns[currentField][index].original,$scope.tPattern.editTaskPattern);for(var payload={fieldPatterns:[]},i=0;i<selectedTask.fieldPatterns[currentField].length;i++){var pattern={};pattern.key=selectedTask.fieldPatterns[currentField][i].key,pattern.input=selectedTask.fieldPatterns[currentField][i].original,payload.fieldPatterns.push(pattern)}payload.fieldName=currentField,payload.resourceId=selectedTask._id?seletedTask._id:selectedTask.taskId,BTStreamsService.fieldPatternSortOrEdit($scope.stream._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("patrn_module_pattern_updated_success"),"success"),$(".hidingIntentPatterns"+index).removeClass("hide"),$(".editingIntentPatterns"+index).addClass("hide"),$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!0,$scope.saveStatusPattern.failed=!1,$timeout(function(){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!0,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1},3e3)},function(err){err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error"),$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!0,$timeout(function(){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!0,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1},3e3)})},$scope.deleteFieldPattern=function(intent,pattern,fieldName,hideNotify,stopLoading,$event){function triggerDelete(intent,pattern,fieldName,hideNotify){$scope.saveStatusPattern={initial:!1,pending:!0,completed:!1,failed:!1},$scope.saveStatusPattern.pending=!0,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1,"alert"==type?(context={alertId:intent._id?intent._id:intent.taskId,patternId:pattern.key,streamId:$scope.stream._id,fieldName:fieldName||pattern.fieldName},BTAlertsService.deleteFieldPattern(context).then(function(res){stopLoading||($scope.selectedTask.fieldPatterns=res.data.fieldPatterns),hideNotify||NotificationService.notify(i18n.i18nString("patrn_module_patrn_deleted_success"),"success"),$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!0,$scope.saveStatusPattern.failed=!1,$scope.deleting=!1,$timeout(function(){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!0,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1},3e3)},function(err){hideNotify||NotificationService.notify(i18n.i18nString("patrn_module_patrn_delete_failed"),"error"),$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!1,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!0,$scope.deleting=!1,$timeout(function(){$scope.saveStatusPattern.pending=!1,$scope.saveStatusPattern.initial=!0,$scope.saveStatusPattern.completed=!1,$scope.saveStatusPattern.failed=!1},3e3)})):"action"==type&&(context={actionId:intent._id,patternId:pattern.key,streamId:$scope.stream._id,fieldName:fieldName||pattern.fieldName},BTActionsService.deleteFieldPattern(context).then(function(res){hideNotify||NotificationService.notify(i18n.i18nString("patrn_module_patrn_deleted_success"),"success"),$scope.deleting=!1,$scope.saveStatusPattern={initial:!1,pending:!1,completed:!0,failed:!1},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)},function(err){hideNotify||NotificationService.notify(i18n.i18nString("patrn_module_patrn_delete_failed"),"error"),$scope.deleting=!1,$scope.saveStatusPattern={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)}))}function confirmFieldPatternDeletion(){triggerDelete(intent,pattern,fieldName,hideNotify)}if($event.stopPropagation(),$scope.deleting)return void NotificationService.notify("please wait until previous pattern is deleted","warning");$scope.deleting=!0;var type="l"==(intent._id||intent.taskId)[0]?"alert":"action",context={};_.isArray(pattern.key)&&_.isArray(pattern.value)?pattern.key.map(function(key,i){NotificationService.alert(i18n.i18nString("do_you_want_to_delete_this_pattern"),function(){triggerDelete(intent,{key:key,fieldName:pattern.fieldName},fieldName,!0,i!=pattern.key.length-1)},{okText:i18n.i18nString("ok_uppercase")})}):NotificationService.alert(i18n.i18nString("do_you_want_to_delete_this_pattern"),[confirmFieldPatternDeletion,$scope.cancelFieldPatternDeletion],{okText:i18n.i18nString("ok_uppercase")})},$scope.cancelFieldPatternDeletion=function(){$scope.deleting=!1},$scope.saveTaskPatternsObject=function(task){if("indevelopment"===$scope.filterToggle){var key="state";if("published"==task[key])$scope.currentTask=task,$scope.upgradeCopy.upgradeFrom="patterns",$scope.currentPattern=$scope.tPattern.newTaskPattern,$scope.upgradeCopy.upgradeType="addPattern",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{task.newTaskPattern&&null!==task.newTaskPattern&&""!==task.newTaskPattern?createPattern($scope.editTaskPattern,task.newTaskPattern,!0):null!==$scope.tPattern.newTaskPattern&&""!==$scope.tPattern.newTaskPattern&&createPattern(task,$scope.tPattern.newTaskPattern,!0)}}},$scope.deletePattern=function(intent,pattern,$event){if($event.stopPropagation(),"indevelopment"===$scope.filterToggle){var key="state";if("published"==intent[key])$scope.currentTask=intent,$scope.upgradeCopy.upgradeFrom="patterns",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{var confirmDeletePattern=function(){var context={resourceId:intent._id,patternId:pattern.key,streamId:$scope.stream._id};$scope.saveStatusPattern={initial:!1,pending:!0,completed:!1,failed:!1},BTStreamsService.deletePattern(context).then(function(res){$scope.editTaskPattern=null,$scope.selectedTask.patterns=res.data.patterns,$scope.saveStatusPattern={initial:!1,pending:!1,completed:!0,failed:!1},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3),NotificationService.notify(i18n.i18nString("patrn_module_patrn_deleted_success"),"success")},function(err){NotificationService.notify(i18n.i18nString("patrn_module_patrn_delete_failed"),"error"),$scope.saveStatusPattern={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)})},msg=i18n.i18nString("do_you_want_to_delete_this_pattern");NotificationService.alert(msg,confirmDeletePattern,arguments)}}},$scope.editTaskPatternFn=function(selectedTask,index,event){if("indevelopment"===$scope.filterToggle&&13===event.keyCode){var key="state";if("published"==selectedTask[key])$scope.currentTask=selectedTask,$scope.upgradeCopy.upgradeFrom="patterns",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{selectedTask.patterns[index].original=selectedTask.patterns[index].original.replace(selectedTask.patterns[index].original,$scope.tPattern.editTaskPattern);for(var payload={patterns:[]},i=0;i<$scope.selectedTask.patterns.length;i++){var pattern={};pattern.intend=$scope.selectedTask.patterns[i].intend,pattern.key=$scope.selectedTask.patterns[i].key,pattern.input=$scope.selectedTask.patterns[i].original,payload.patterns.push(pattern)}payload.resourceId=$scope.selectedTask._id,$scope.saveStatusPattern={initial:!1,pending:!0,completed:!1,failed:!1},BTStreamsService.taskPattern($scope.stream._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("patrn_module_pattern_updated_success"),"success"),$(".hidingIntentPatterns"+index).removeClass("hide"),$(".editingIntentPatterns"+index).addClass("hide"),$scope.saveStatusPattern={initial:!1,pending:!1,completed:!0,failed:!1},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)},function(err){$scope.saveStatusPattern={initial:!1,pending:!1,completed:!1,failed:!0},err&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error"),$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)})}}};var mapPatterns={DialogIntent:function(){return $scope.selectedTask.patterns},webservice:function(){return $scope.selectedTask.patterns},DialogEntity:function(){return $scope.selectedTask.patterns},FieldIntent:function(){return $scope.selectedTask.fieldPatterns[$scope.currentField]}};$scope.clearSearch=function(e){e&&e.stopPropagation(),$(".patternForm-body").animate({scrollTop:0}),$scope.searchQuery=""},$scope.searchPatterns=function(e,searchQuery){if(e&&13===e.keyCode&&searchQuery.length){var _type=$scope._type&&$scope._type.length>0?$scope._type:$scope.selectedTask.type,_totalPatterns=mapPatterns[_type]();$scope.totalSearchRecords=_.filter(_totalPatterns,function(pattern){var _expTask=new RegExp(searchQuery,"i"),searchResult=_expTask.test($scope.constants.replaceSpecialChar(pattern.original));return searchResult?pattern:void 0}),$scope.uiCopyPatterns=$scope.totalSearchRecords.slice(0,10)}else searchQuery.length||$scope.clearSearch()},$scope.redirectToLink=function(linkType){$rootScope.redirectToLink(linkType)},$scope.cancelTraitUpgrade=function(){$scope.traitRules.traitMappings=angular.copy($scope.selectedTask.traitRules)},$scope.addTraitAndCondition=function(event,orIndex,rulesArray){if("indevelopment"===$scope.filterToggle){var key="state";"DialogIntent"===$scope.selectedTask.type&&(key="status"),"published"==$scope.selectedTask[key]?($scope.currentTask=$scope.selectedTask,$scope.upgradeCopy.upgradeFrom="rules",$scope.upgradeCopy.upgradeType="addRule",$scope.upgradeCopy.isDummyTrait=!1,$timeout(function(){$scope.upgradeCopy.traitMappings=angular.copy($scope.traitRules.traitMappings)},200),NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelTraitUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"))):setTimeout(function(){var mappings={traitRules:$scope.traitRules.traitMappings};$scope.saveStatusPattern={initial:!1,pending:!0,completed:!1,failed:!1},$scope.mapTraitsForComponent(mappings,"orCondition","deleteTraits").then(function(res){NotificationService.notify(i18n.i18nString("success_rule"),"success"),$scope.saveStatusPattern={initial:!1,pending:!1,completed:!0,failed:!1},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)},function(err){err&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error"),$scope.saveStatusPattern={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)})},700)}},$scope.mapTraitsForComponent=function(traitsPayload,condition,mixPanelAction){var componentId=$scope.selectedTask._id,payload={traitRules:[]};$.each(traitsPayload.traitRules,function(i,eachRule){(eachRule.length>1||1==eachRule.length&&eachRule[0])&&payload.traitRules.push(eachRule)});var deferred=$q.defer();return BTFlowtaskService.updateComponentTraits($scope.stream._id,componentId,payload).then(function(res){"createTraits"===mixPanelAction&&mixpanelEvent("createTraits"),"deleteTraits"===mixPanelAction&&mixpanelEvent("deleteTraits"),$scope.selectedTask&&($scope.selectedTask.traitRules=res.data.traitRules,$scope.traitRules.traitMappings=JSON.parse(JSON.stringify(res.data.traitRules))),$scope.cb.updateIntentPattern&&$scope.cb.updateIntentPattern(res.data),deferred.resolve(traitsPayload)},function(err){NotificationService.notify(i18n.i18nString("fail_traits"),"error"),deferred.resolve({data:[]})}),deferred.promise},$scope.addTraitOrCondition=function(event,index,condition){if($scope._constants_.checkForSecialChar(condition.traitName,!0,"traits"))return!1;if(!condition.traitName)return!1;var trait=angular.copy(condition.traitName.replace(/\s/g,"")),mappings={traitRules:[]},andCondition=[];mappings.traitRules=angular.copy($scope.traitRules.traitMappings)||[],event&&13==event.keyCode&&(andCondition.push(trait),mappings.traitRules.push(andCondition),$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("success_rule"),"success"),$scope.dummyTraitOrCondition.length>1?$scope.dummyTraitOrCondition.splice(index,1):1==$scope.dummyTraitOrCondition.length&&($scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)))}))},$scope.cancelTraitDummyUpgrade=function(){$scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd))},$scope.addTraitDummyAndCondition=function(index){var mappings={traitRules:[]};if("indevelopment"===$scope.filterToggle){var key="state";"DialogIntent"===$scope.selectedTask.type&&(key="status"),"published"==$scope.selectedTask[key]?($scope.currentTask=$scope.selectedTask,$scope.upgradeCopy.upgradeFrom="rules",$scope.upgradeCopy.upgradeType="addRule",$scope.upgradeCopy.isDummyTrait=!0,$scope.upgradeCopy.traitMappings=angular.copy($scope.traitRules.traitMappings),NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelTraitDummyUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"))):$timeout(function(){var condition=$scope.dummyTraitOrCondition[index];if(!condition[0])return!1;var trait=angular.copy(condition[0]),andCondition=[];$scope.saveStatusPattern={initial:!1,pending:!0,completed:!1,failed:!1},mappings.traitRules=angular.copy($scope.traitRules.traitMappings)||[],andCondition.push(trait),mappings.traitRules.push(andCondition),$scope.mapTraitsForComponent(mappings,"orCondition","createTraits").then(function(res){NotificationService.notify(i18n.i18nString("success_rule"),"success"),$scope.dummyTraitOrCondition.length>1?$scope.dummyTraitOrCondition.splice(index,1):1==$scope.dummyTraitOrCondition.length&&($scope.dummyTraitOrCondition=[],$timeout(function(){$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$("#addTraitRulesPatterns"+($scope.traitRules.traitMappings.length-1))&&$("#addTraitRulesPatterns"+($scope.traitRules.traitMappings.length-1)).find(".input")&&$("#addTraitRulesPatterns"+($scope.traitRules.traitMappings.length-1)).find(".input").length&&$("#addTraitRulesPatterns"+($scope.traitRules.traitMappings.length-1)).find(".input")[0].focus()})),$scope.saveStatusPattern={initial:!1,pending:!1,completed:!0,failed:!1},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)},function(err){$scope.saveStatusPattern={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatusPattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)})})}},$scope.deleteOrRule=function(orIndex){var mappings={traitRules:[]};mappings.traitRules=angular.copy($scope.traitRules.traitMappings)||[],mappings.traitRules.splice(orIndex,1),$scope.mapTraitsForComponent(mappings,"orCondition","deleteTraits").then(function(res){NotificationService.notify(i18n.i18nString("delete_trait"),"success")})},$scope.addOrDummy=function(){$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd))},$scope.loadTags=function(query){return $timeout("!"==query[0]?function(){return $scope.allTraitsNegations.filter(function(traitName){return traitName.startsWith(query)})}:function(){return $filter("filter")($scope.allTraits,query)})};var getTraitsGroupsApi=function(){BTStreamsService.getTraitGroups($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$scope.traitGroups=angular.copy(res.data),$scope.allTraits=[],$scope.allTraitsNegations=[];var alltraitsArr=[],allTraitsNegations=[];$.each($scope.traitGroups,function(i,traits){$.each(traits.traits,function(j,trait){({groupId:traits._id,traitId:trait.traitId||j,traitName:trait.traitName});alltraitsArr.push(trait.traitName),allTraitsNegations.push("!"+trait.traitName)})}),$scope.allTraits=_.uniq(alltraitsArr),$scope.allTraitsNegations=_.uniq(allTraitsNegations)},function(err){"NO"!==$scope.displayMode&&NotificationService.notify(i18n.i18nString("failed_rules"),"error")})};$scope.cb.onClickTask=onClickTask,$scope.cb.onClickEntity=onClickEntity,$scope.cb.onClickField=onClickField,$scope.cb.onClickTraits=onClickTraits,$scope.cb.returnTraitRules=returnTraitRules}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("sdkApps",function(){return{restrict:"EAQ",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-sdkApps/sdk-apps.html",controller:["$scope","$element","patternFactory","$filter","$timeout","$rootScope","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","$modal","urlutil","env_conf","BTFileUploadService","$applicationService","$translator","accessControlService","i18n",function($scope,$element,patternFactory,$filter,$timeout,$rootScope,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,$modal,urlutil,env_conf,BTFileUploadService,$applicationService,$translator,accessControlService,i18n){function triggerSlider(){$scope.searchQuery&&$scope.searchQuery.triggerId&&("WELCOME_EVENT"===$scope.searchQuery.triggerId?($scope.searchQuery.eventName="welcome",$scope.searchQuery.name="Welcome Event"):"CONVERSATION_END"===$scope.searchQuery.triggerId&&($scope.searchQuery.eventName="welcome",$scope.searchQuery.name="End of Conversation"),$scope.onEventDescClick($scope.searchQuery.name,"",$scope.searchQuery.eventName),$scope.searchQuery="")}$scope._constants_=$rootScope._constants_,$scope.stream=$workflowService.selectedStream(),$scope.streamState=$workflowService.selectedStreamState(),$scope.sdkCallback={isFromSettings:!0},$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.APIScopes=$workflowService.seedData().appScopes,$scope.eventsData=angular.copy($workflowService.seedData().botEvents),$scope.selectedState=$workflowService.selectedStreamState(),$scope.allowNamespace=$workflowService.selectedStream().enableNameSpace,$scope.isEventsAvail=void 0!==$scope.eventsData,$scope.eventsList=[],$scope.searchQuery=$workflowService.storeSearchQry(),$workflowService.storeSearchQry({}),$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.assetsBase=env_conf["assets-url"],$scope.searchIcon=env_conf["context-url"]+"/assets/icons/searchIconGreen.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.greenEllipsis=env_conf["context-url"]+"/assets/icons-new/ellipsis/ellipsis-green.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/API Scopes.png",$scope.status={task_fail:!0},$scope.manage_var_events__cb={},$scope.resumingBuilder&&$scope.botDetails&&$scope.botDetails.builderState&&("agents"==$scope.botDetails.builderState.path[1]||"eventsManage"===$scope.botDetails.builderState.path[2])&&$scope.$emit("nestedComponentLoaded",{id:"agents",flag:!1}),$scope.wfAdminScopes=[],$workflowService.seedData().wfAdminScopes&&$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.wfAdmin&&($scope.wfAdminScopes=$workflowService.seedData().wfAdminScopes,$scope.APIScopes=$scope.APIScopes.concat($scope.wfAdminScopes)),$scope.toggleEventName="",$scope.welcomeEvents=[],$scope.channelEvents=[],$scope.intentsEvents=[];for(var key in $scope.eventsData)$scope.eventsData[key].name&&$scope.eventsData[key].desc&&!$scope.eventsData[key].channelSpecific&&"INTENT_UNIDENTIFIED_EVENT"!==$scope.eventsData[key].category?($scope.welcomeMessage="Conversation Events",$scope.welcomeEvents[$scope.welcomeEvents.length]={},$scope.welcomeEvents[$scope.welcomeEvents.length-1].name=$scope.eventsData[key].name,$scope.welcomeEvents[$scope.welcomeEvents.length-1].trigger=$scope.eventsData[key].desc,$scope.welcomeEvents[$scope.welcomeEvents.length-1].id=$scope.eventsData[key].category):$scope.eventsData[key].name&&$scope.eventsData[key].desc&&$scope.eventsData[key].channelSpecific?($scope.channelMessage="Channel Events",$scope.channelEvents[$scope.channelEvents.length]={},$scope.channelEvents[$scope.channelEvents.length-1].name=$scope.eventsData[key].name,$scope.channelEvents[$scope.channelEvents.length-1].trigger=$scope.eventsData[key].desc,$scope.channelEvents[$scope.channelEvents.length-1].id=$scope.eventsData[key].category):$scope.eventsData[key].name&&$scope.eventsData[key].desc&&!$scope.eventsData[key].channelSpecific&&"INTENT_UNIDENTIFIED_EVENT"===$scope.eventsData[key].category&&($scope.intentMessage="Intent Events",$scope.intentsEvents[$scope.intentsEvents.length]={},$scope.intentsEvents[$scope.intentsEvents.length-1].name=$scope.eventsData[key].name,$scope.intentsEvents[$scope.intentsEvents.length-1].trigger=$scope.eventsData[key].desc,$scope.intentsEvents[$scope.intentsEvents.length-1].id=$scope.eventsData[key].category);$scope.sdkCallback.updateToggleEventName=function(name){$scope.toggleEventName=name},$scope.sdkCallback.toggleTrue=function(){var i;for(i=0;i<$scope.welcomeEvents.length;i++)$scope.welcomeEvents[i].name===$scope.toggleEventName&&($scope.welcomeEvents[i].enabled=!0);for(i=0;i<$scope.channelEvents.length;i++)$scope.channelEvents[i].name===$scope.toggleEventName&&($scope.channelEvents[i].enabled=!0);for(i=0;i<$scope.intentsEvents.length;i++)$scope.intentsEvents[i].name===$scope.toggleEventName&&($scope.intentsEvents[i].enabled=!0)},$scope.sdkCallback.toggleFalse=function(name){var i;for(i=0;i<$scope.welcomeEvents.length;i++)$scope.welcomeEvents[i].name===name&&($scope.welcomeEvents[i].enabled=!1);for(i=0;i<$scope.channelEvents.length;i++)$scope.channelEvents[i].name===name&&($scope.channelEvents[i].enabled=!1);for(i=0;i<$scope.intentsEvents.length;i++)$scope.intentsEvents[i].name===name&&($scope.intentsEvents[i].enabled=!1)},$scope.sdkCallback.updateEventList=function(name){var i;for(i=0;i<$scope.welcomeEvents.length;i++)$scope.welcomeEvents[i].name===name&&($scope.welcomeEvents[i].configured=!1);for(i=0;i<$scope.channelEvents.length;i++)$scope.channelEvents[i].name===name&&($scope.channelEvents[i].configured=!1);for(i=0;i<$scope.intentsEvents.length;i++)$scope.intentsEvents[i].name===name&&($scope.intentsEvents[i].configured=!1)},$scope.onEventDescClick=function(name,isEnabled,eventName){var i,isConfigured;if("welcome"===eventName)for(i=0;i<$scope.welcomeEvents.length;i++)$scope.welcomeEvents[i].name===name&&(isConfigured=$scope.welcomeEvents[i].configured);else if("intent"===eventName)for(i=0;i<$scope.intentsEvents.length;i++)$scope.intentsEvents[i].name===name&&(isConfigured=$scope.intentsEvents[i].configured,isEnabled=!0);else if("channel"===eventName)for(i=0;i<$scope.channelEvents.length;i++)$scope.channelEvents[i].name===name&&(isConfigured=$scope.channelEvents[i].configured);void 0!==isConfigured&&!isConfigured&&isEnabled?$scope.sdkCallback.openEventSlider(name,"fromEdit"):$scope.sdkCallback.openEventSlider(name,"fromConfigured")},$scope.toggleClickHandler=function(name,onOff){for(var key in $scope.eventsData)if($scope.eventsData[key].name===name){var openedKey=key;break}BTStreamsService.getBTStream($scope.stream._id).then(function(res){if(res.data.botEvents&&res.data.botEvents[openedKey]){var payload={botEvent:{}};payload.botEvent[openedKey]=res.data.botEvents[openedKey],payload.botEvent[openedKey].enabled=onOff,BTStreamsService.newEvent($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload).then(function(){onOff?NotificationService.notify(name+" "+i18n.i18nString("enable"),"success"):NotificationService.notify(name+i18n.i18nString("disable"),"success")},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})}else onOff&&$scope.sdkCallback.openEventSlider(name,"fromToggle")},function(err){console.log(err)})},BTStreamsService.getBTStream($scope.stream._id).then(function(res){$scope.newStreamData=res.data,$scope.sdkCallback&&$scope.sdkCallback.updateLocalStream&&$scope.sdkCallback.updateLocalStream(res.data);for(var key in res.data.botEvents)if("enabled"in res.data.botEvents[key]){var i;for(i=0;i<$scope.welcomeEvents.length;i++)if($scope.eventsData[key]&&$scope.welcomeEvents[i].name===$scope.eventsData[key].name){$scope.welcomeEvents[i].enabled=res.data.botEvents[key].enabled;break}for(i=0;i<$scope.channelEvents.length;i++)if($scope.eventsData[key]&&$scope.channelEvents[i].name===$scope.eventsData[key].name){$scope.channelEvents[i].enabled=res.data.botEvents[key].enabled;break}for(i=0;i<$scope.intentsEvents.length;i++)if($scope.eventsData[key]&&$scope.intentsEvents[i].name===$scope.eventsData[key].name){$scope.intentsEvents[i].enabled=res.data.botEvents[key].enabled;break}}var j;for(j=0;j<$scope.welcomeEvents.length;j++)"enabled"in $scope.welcomeEvents[j]?$scope.welcomeEvents[j].configured=!1:$scope.welcomeEvents[j].configured=!0;for(j=0;j<$scope.channelEvents.length;j++)"enabled"in $scope.channelEvents[j]?$scope.channelEvents[j].configured=!1:$scope.channelEvents[j].configured=!0;for(j=0;j<$scope.intentsEvents.length;j++)"enabled"in $scope.intentsEvents[j]?$scope.intentsEvents[j].configured=!1:$scope.intentsEvents[j].configured=!0;triggerSlider()},function(err){console.log(err)}),$scope.searchInput=!1,$scope.eventData={name:""},$scope.search={name:""},$scope.searchInputBlur=function(){$scope.search.name="",$scope.searchInput=!1,$scope.eventData={name:""}},$scope.searchClickHandle=function(){$scope.searchInput=!$scope.searchInput,$timeout(function(){$element.find(".eventSearch")[0].focus()},500)},$scope.checkBotState=function(){return $scope.streamState=$workflowService.selectedStreamState(),"published"==$scope.streamState?!0:!1},$scope.getScopeDisplayNames=function(app){var displayName=[];return $.each(app.scope,function(i,scopes){if(scopes.bot===$scope.stream._id&&scopes.scopes&&scopes.scopes.length>0){var scopesObj=scopes.scopes;for(displayName=[],i=0;i<scopesObj.length;i++)$scope.APIScopes.forEach(function(obj){obj.scope===scopesObj[i]&&displayName.push(obj.displayName)});return displayName.join(", ")}}),displayName.join(", ")},$scope.emptyAppScopes=function(){return $(".appScopesContainer")&&$(".appScopesContainer").children().length},$scope.emptySentiment=function(){return $(".sentimentContainer")&&$(".sentimentContainer").children().length},$scope.openManageVarSdk=function(){$scope.manageVarEventsEnable=!0,$scope.manage_var_events__cb.flagName="events",$scope.manage_var_events__cb.addedNamespaces=$scope.stream.evVNameSpace||[],$scope.manage_var_events__cb.state="indevelopment"==$workflowService.selectedStreamState()?"configured":$workflowService.selectedStreamState(),
$scope.manage_var_events__cb.updateEventsNamespace=function(list){$scope.stream.evVNameSpace=list},setTimeout(function(){$scope.modalSlider.open("#manageVarNamespaceEventsForm")},200)},$scope.manage_var_events__cb.close=function(){$scope.modalSlider.close("#manageVarNamespaceEventsForm"),setTimeout(function(){$scope.manageVarEventsEnable=!1},200)},$scope.canDisplayApp=function(app){var returnVal=!1;return $.each(app.scope,function(i,scopes){scopes.bot===$scope.stream._id&&scopes.scopes&&scopes.scopes.length>0&&(returnVal=!0)}),returnVal},$scope.deleteAppName=function(index,app){NotificationService.alert(i18n.i18nString("delete_app"),function(){var svcname="bt.apps.delete";$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.delete"),$translator.translate(svcname,{appId:app.clientId,streamId:$workflowService.selectedStream()._id},{}).then(function(res){res&&200===res.status?($scope.sdkCallback.apps.splice(index,1),NotificationService.notify(i18n.i18nString("app_deleted"),"success",1500)):NotificationService.notify(i18n.i18nString("error_alert"),"error")},function(errRes){errRes&&errRes.data&&errRes.data.errors.length?NotificationService.notify(errRes.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})},{okText:i18n.i18nString("ok")})},$(".task-fail-toggle").popover({placement:"top",html:!0,delay:{hide:500},trigger:"hover"})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btSessioncontextVariables",function(){return{restrict:"EAQ",scope:{sessionInfo:"=",options:"=",isBirightModeActive:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-sessioncontext-variables/bt-sessioncontext-variables.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","i18n",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,i18n){function prepareSessionData(){$scope.sessionContextObj={context:{},messageTone:{},dialogTone:{},history:{}},$scope.selectedJsonObjIndex=-1,$scope.sessionContextObj.selectedJsonObj=$scope.sessionInfo,$scope.sessionInfoCopy=angular.copy($scope.sessionInfo),$scope.sessionInfoCopy.message_tone&&($scope.sessionContextObj.messageTone=angular.copy($scope.sessionInfoCopy.message_tone),delete $scope.sessionInfoCopy.message_tone),$scope.sessionInfoCopy.dialog_tone&&($scope.sessionContextObj.dialogTone=angular.copy($scope.sessionInfoCopy.dialog_tone),delete $scope.sessionInfoCopy.dialog_tone),$scope.sessionInfoCopy.history&&($scope.sessionContextObj.history=angular.copy($scope.sessionInfoCopy.history),delete $scope.sessionInfoCopy.history),$scope.sessionInfoCopy.previousNodeName&&($scope.sessionContextObj.previousNodeName=angular.copy($scope.sessionInfoCopy.previousNodeName),delete $scope.sessionInfoCopy.previousNodeName),$scope.sessionInfoCopy.currentNodeName&&($scope.sessionContextObj.currentNodeName=angular.copy($scope.sessionInfoCopy.currentNodeName),delete $scope.sessionInfoCopy.currentNodeName),$scope.sessionInfoCopy.intent&&($scope.sessionContextObj.intent=angular.copy($scope.sessionInfoCopy.intent),delete $scope.sessionInfoCopy.intent),$scope.sessionInfoCopy.entities&&($scope.sessionContextObj.context.entities=angular.copy($scope.sessionInfoCopy.entities),delete $scope.sessionInfoCopy.entities),$scope.sessionInfoCopy.session&&($scope.sessionContextObj.context=angular.extend($scope.sessionContextObj.context,$scope.sessionInfoCopy.session),delete $scope.sessionInfoCopy.session),delete $scope.sessionInfoCopy.bot,delete $scope.sessionInfoCopy.botid,delete $scope.sessionInfoCopy.count,delete $scope.sessionInfoCopy.currentNodeId,delete $scope.sessionInfoCopy.entityErrorCount,delete $scope.sessionInfoCopy.intent,delete $scope.sessionInfoCopy.intentType,delete $scope.sessionInfoCopy.previousNodeId,delete $scope.sessionInfoCopy.taskid,delete $scope.sessionInfoCopy.updatedOn,delete $scope.sessionInfoCopy.userInputs,$scope.sessionContextObj.context.customVariables=$scope.sessionInfoCopy}$scope.assetsBase=env_conf["assets-url"],$scope.sessionInfoCopy=angular.copy($scope.sessionInfo),$scope.showJsoneditor=!1,$scope.selectedJsonObjIndex=-1,$scope.stringfyVal=function(val){var tempVal=angular.copy(val);return JSON.stringify(tempVal).slice(0,60)+"...."},$scope.sessionContextObj={context:{},messageTone:{},dialogTone:{},history:{}},$scope.toggleAcc=function(status){status&&($scope.selectedJsonObjIndex=-1)},prepareSessionData(),$scope.getKeyTitle={entities:i18n.i18nString("Entities_label"),customVariables:i18n.i18nString("custom_variable"),BotContext:i18n.i18nString("bot_context"),BotUserSession:i18n.i18nString("bot_user"),EnterpriseContext:i18n.i18nString("enterprise_context"),UserContext:i18n.i18nString("user_context"),UserSession:i18n.i18nString("user_session"),opts:i18n.i18nString("opts")},$scope.getCopypath={entities:"entities",customVariables:"customVariables",BotContext:"session.BotContext",BotUserSession:"session.BotUserSession",EnterpriseContext:"session.EnterpriseContext",UserContext:"session.UserContext",UserSession:"session.UserSession",opts:"session.opts"},$scope.checkForObj=function(value){var isObj="obj";return"object"!=typeof value||Array.isArray(value)||null===value||_.isEmpty(value)&&(isObj="undefined"),void 0===value||null===value?isObj="undefined":("number"==typeof value&&isFinite(value)||"string"==typeof value||value instanceof String||"boolean"==typeof value)&&(isObj="string"),isObj},$scope.checkForArray=function(value){var isArrayVal=!1;return Array.isArray(value)&&null!==value&&(isArrayVal=!0),isArrayVal},$scope.$watch("sessionInfo",function(newVal,oldValue){prepareSessionData()}),$scope.openJsonEditor=function(jsonObj,fullJson,variable,index,e){e&&(e.preventDefault(),e.stopImmediatePropagation()),$scope.sessionContextObj.selectedJsonObj=jsonObj,$scope.selectedVariable=variable,fullJson?$scope.showJsoneditor=!0:$scope.selectedJsonObjIndex==index?$scope.selectedJsonObjIndex=-1:$scope.selectedJsonObjIndex=index},$scope.closeJsonEditor=function(fullJson){fullJson?$scope.showJsoneditor=!1:($("#jsEditorModal").modal("hide"),$(".kore-chat-window").removeClass("jsonModalOpen"),$scope.showJsonModal=!1)}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btSmallTalk",function(){return{scope:{groupDetails:"=",newGroup:"=",groups:"=",callback:"="},restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-small-talk/bt-small-talk.html",controller:"BTSmallTalkCtrl"}}),_module.controller("BTSmallTalkCtrl",["$scope","$element","$rootScope","env_conf","$timeout","$workflowService","BTStreamsService","uuid","channelsConfig","accessControlService","_constants_","$applicationService","i18n","mixPanel","BTFlowtaskService",function($scope,$element,$rootScope,env_conf,$timeout,$workflowService,BTStreamsService,uuid,channelsConfig,accessControlService,_constants_,$applicationService,i18n,mixPanel,BTFlowtaskService){function getTextEncoded(name){return name?name.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function getPayload(){var _payload=[],constructPayload=function(treeData){$.each(treeData,function(i,nodeData){var nodePayloadObj=angular.copy(nodeData);nodePayloadObj=_.omit(nodePayloadObj,["nodes","defaultCollapse"]),_payload.push(nodePayloadObj),nodeData.nodes.length&&constructPayload(nodeData.nodes)})};return constructPayload($scope.data),_payload||{}}function prepareTreeData(result){result.nodes=[],$scope.data.push(result)}function fillChildren(taxonomy,nodes,parentTermObject){var childs=_.filter(taxonomy,function(node){return node.parentId===parentTermObject.nodeId?(parentTermObject.defaultCollapse=!0,!0):void 0});if(childs&&childs.length>0)for(var i=0;i<childs.length;i++)nodes.push(JSON.parse(JSON.stringify(childs[i]))),nodes[nodes.length-1].nodes=[],fillChildren(taxonomy,nodes[nodes.length-1].nodes,childs[i])}function domLoading(){setTimeout(function(){$scope.domLoading=!1},100)}function setAccessRights(){$scope.accessRights=accessControlService.getAccessRight("BOTBUILDER_TASKS")}function ifDataSorted(treeData){for(var i=0;i<treeData.length-1;i++)if(treeData[i].seq>treeData[i+1].seq){sorted=!1;break}}function sortItemsBasedOnSeq(treeData){return sorted?treeData:treeData.sort(function(firstEle,secondEle){return firstEle.seq-secondEle.seq})}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function encodeJS(_obj){return encodeURIComponent(_obj)}function initDragDropFile(){!function(window){function triggerCallback(e,callback){if(callback&&"function"==typeof callback){var files;e.dataTransfer?files=e.dataTransfer.files:e.target&&(files=e.target.files),callback.call(null,files)}}function makeDroppable(ele,callback){if(!($element.find('[type="file"]').length>0)){var input=document.createElement("input");input.setAttribute("type","file"),input.setAttribute("multiple",!0),input.style.display="none",input.id="fileInputID",input.addEventListener("change",function(e){triggerCallback(e,callback)}),ele=ele[0],ele.appendChild(input),ele.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.add("dragover")}),ele.addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover")}),ele.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover"),triggerCallback(e,callback)}),$(ele).find(".browseBtn")[0].addEventListener("click",function(){input.value=null,input.click()})}}window.makeDroppable=makeDroppable}(window),function(window){window.makeDroppable($(".smallTalkFileDrop"),function(files){$scope.uploadJSONFile(files[0])})}(window)}function startAutoTrain(){$scope.trainBot()}function startPollImportStatus(timeout){return setInterval(function(){BTStreamsService.statusImportingSmallTalk($scope.userInfo.userId,$scope.stream._id).then(function(res){res&&res.data&&($scope.statusLogs=res.data.statusLogs||[],"success"===res.data.status?(stopImportBotPolling(),startAutoTrain(),$scope.importing=res.data.status):"failed"===res.data.status&&($scope.importmessage=res.data.message,$scope.showFailedErrors=!1,stopImportBotPolling(),$scope.importing=res.data.status))},function(err){$scope.importing="failed",stopImportBotPolling();var _msg;err.data&&err.data.errors&&err.data.errors.length>0?_msg=err.data.errors[0].msg:(_msg=i18n.i18nString("bot_import_error"),NotificationService.notify(_msg,"error"))})},timeout)}function stopImportBotPolling(){$scope._importStatusInit&&(clearTimeout($scope._importStatusInit),clearInterval(progressInterval),$scope._importStatusInit=null,progressInterval=null)}function startImportProgress(){$scope.totalProgress=1,progressInterval=setInterval(function(){$scope.totalProgress>90&&($scope.totalProgress=90),$scope.totalProgress+=.1},350)}function getGroups(){BTStreamsService.getSmallTalkGroups($scope.stream._id).then(function(response){response.data&&($scope.smallTalkGroups.groupData=response.data)},function(err){err.data.errors.length>0&&NotificationService.notify(err.data.errors[0].msg,"error")})}function fillChildrenSearch(taxonomy,nodes,parentTermObject){var childs=_.filter(taxonomy,function(node){return node.parentId===parentTermObject.nodeId?!0:void 0});if(childs&&childs.length>0)for(var i=0;i<childs.length;i++)childs[i].defaultCollapse=!1,nodes.push(JSON.parse(JSON.stringify(childs[i]))),nodes[nodes.length-1].nodes=[],fillChildrenSearch(taxonomy,nodes[nodes.length-1].nodes,childs[i])}function checkSmallTalkSyncStatus(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithSmallTalk")?$scope.showTrainBtn=!0:$scope.showTrainBtn=!1,"Finished"===res.data.trainingStatus&&res.data.isMlInSyncWithSmallTalk?($scope.trainStatus.saving=!1,$scope.trainStatus.success=!0):"Failed"===res.data.trainingStatus?($scope.trainStatus.saving=!1,$scope.trainStatus.success=!1):"Finished"!==res.data.trainingStatus||res.data.isMlInSyncWithSmallTalk?($scope.trainStatus.saving=!0,$scope.trainStatus.success=!1):($scope.trainStatus.saving=!1,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!1)},function(err){if($scope.trainStatus.saving=!1,$scope.trainStatus.success=!1,err.data.errors.length>0)NotificationService.notify(err.data.errors[0].msg,"error");else{var _msg=i18n.i18nString("fetching_ML");NotificationService.notify(_msg,"error")}})}$scope.$emit("nestedComponentLoaded",{id:"smallTalk",flag:!1}),$scope.addsmalltalk=env_conf["context-url"]+"/assets/smalltalk/addsmalltalk.svg",$scope.editSmalltalk=env_conf["context-url"]+"/assets/smalltalk/editSmalltalk.svg",$scope.settingSmalltalk=env_conf["context-url"]+"/assets/smalltalk/settingSmalltalk.svg",$scope.trashSmalltalk=env_conf["context-url"]+"/assets/smalltalk/trashSmalltalk.svg",$scope.arrowGraySmalltalk=env_conf["context-url"]+"/assets/smalltalk/arrowGraySmalltalk.svg",$scope.dragDropIcon=env_conf["context-url"]+"/assets/images/import.png",$scope.groupingIcon=env_conf["context-url"]+"/assets/images/grouping.png",$scope.primary={},$scope.ellipsisDark=env_conf["context-url"]+"/assets/icons/ellipsisDark.svg",$scope.backArrow=env_conf["context-url"]+"/assets/icons/backArrow.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/smalltalk/close.svg",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.saveIcon=env_conf["context-url"]+"/assets/smalltalk/save.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/smalltalk/emptyState.png",$scope.importingIcon=env_conf["context-url"]+"/assets/images/importing.png",$scope.wentWrongIcon=env_conf["context-url"]+"/assets/images/wentwrong.png",$scope.importDoneIcon=env_conf["context-url"]+"/img/import-success.png",$scope.assetsBase=env_conf["assets-url"],$scope.rightClass="right700",$scope.allowedDepth=window.appConfig.SMALLTALK_DEPTH,$scope.stream=$workflowService.selectedStream(),$scope.currentGroup={},$scope.currentGroup.nodes=[],$scope.currentNodeData={},$scope.smallTalkGroups={},$scope.smallTalkGroups.groupData=[],$scope.data=[],$scope.primary={},$scope.checkArray=[],$scope.node={},$scope.search={},$scope.trained=i18n.i18nString("trained"),$scope.training=i18n.i18nString("training_label"),$scope.train=i18n.i18nString("train"),$scope.tagClicked={},$scope.check=[];$scope._constants_=_constants_,$scope.demoTemplates=[],$scope.enableProceed=!0;var progressInterval="";$scope.totalProgress=1;var sorted=!0;$scope.eyeimage=env_conf["assets-url"]+"landingImages/icons/eye.svg",$scope.fileUploadData={downloadURL:"",label:getTextEncoded($scope.stream.name)},$scope.userInfo=$applicationService.userInfo(),$scope.trainStatus={success:!1,failed:!1,saving:!1},$scope.showTrainBtn=!0;$scope.isDataAvailable=!1,$scope.accessRights=accessControlService.getAccessRight("BOTBUILDER_TASKS"),$scope.nlpPermission=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.clientNodes=[],$scope.uiNodes=[],$scope.maxLength=2048,$scope.bridge={};var skip=0,_offset={};$scope.getBotVariables=function(){BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$workflowService.botEnvVariables(res.data.variables)})},$scope.getBotVariables(),$scope.availableChannels=Object.values(channelsConfig.channelsObject),$scope._channelConfig=channelsConfig;var isWFacebook=!1,wfacebookIndex=0;$scope.availableChannels=$scope.availableChannels.map(function(channel,i){return"wfacebook"===channel.id&&(isWFacebook=!0,wfacebookIndex=i),channel}),$scope.onCancel=function(){$timeout(function(){$("#btFullpageModal").modal("hide"),$("body").removeClass("bt-modal-open smalltalk-modal"),angular.forEach($scope.check,function(value,index){$scope.check[index].editMode=!1}),$scope.data=[],$scope.search.searchUtterance="",skip=0,$scope.callback.getGroups($scope.stream._id),$rootScope.$emit("updateSummaryData")})},$scope.checkForEdit=function(e,check,index,prev){e.stopPropagation(),e.stopImmediatePropagation(),void 0!==prev&&check[prev].editMode&&(check[prev].editMode=!1),check[index].editMode=!0,$scope.prev=index,$scope.smallTalkGroups=angular.copy($scope.originalCopy)},$scope.openSmallTalkBlock=function(event){$(".smallTalkContainer .blockContent").hasClass("selected")&&$(".smallTalkContainer .blockContent").removeClass("selected");var _this=event.currentTarget;$(_this).parent(".blockContent").addClass("selected")},$scope.updateSmallTalk=function(termData){getPayload()},$scope.collapseAll=function(){$scope.$broadcast("angular-ui-tree:collapse-all")},$scope.expandAll=function(){$scope.$broadcast("angular-ui-tree:expand-all")},$scope.editGroup=function(e,group,check,index){if(e.stopPropagation(),e.stopImmediatePropagation(),13===e.keyCode||1===e.which){var _payload={groupName:group.groupName};check[index].editMode=!check[index].editMode,BTStreamsService.updateGroup(_payload,$scope.stream._id,group.groupId).then(function(response){response&&angular.forEach($scope.originalCopy.groupData,function(group){group.groupId===response.data.groupId&&(group.groupName=response.data.groupName)})},function(err){err.data&&err.data.errors&&409===err.status?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")})}},$scope.closeEdit=function(e,check,index){e.stopPropagation(),e.stopImmediatePropagation(),check[index].editMode=!check[index].editMode,$scope.smallTalkGroups=angular.copy($scope.originalCopy)},$scope.cudSmallTalk=function(operation,nodeData,targetGroup,_msg,originalNodeData,draggedScope,droppedIndex){nodeData=_.isArray(nodeData)?nodeData:[nodeData],nodeData=_.map(nodeData,function(node){return node=_.omit(node,["nodes","defaultCollapse"])});var _payload;"create"===operation&&BTStreamsService.creteNewNode(nodeData[0],$scope.stream._id,$scope.currentGroup.groupId).then(function(response){if(response.data){originalNodeData.nodeId=response.data.nodeId,$scope.currentGroup.nodes.push(response.data),$scope.smallTalkTaxonomy=angular.copy($scope.currentGroup.nodes);_.filter($scope.smallTalkTaxonomy,function(treeData){return!treeData.parentId});NotificationService.notify(_msg,"success"),$scope.trainStatus.saving=!1,$scope.trainStatus.failed=!1,$scope.trainStatus.success=!1}},function(err){409==err.data.errors[0].code?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")}),"update"===operation&&BTStreamsService.updateNode(nodeData[0],$scope.stream._id,$scope.currentGroup.groupId).then(function(response){var updatedTermData=response.data;angular.forEach($scope.currentGroup.nodes,function(node){node.nodeId===updatedTermData.nodeId&&(node.userUtterances=updatedTermData.userUtterances,node.botUtterances=updatedTermData.botUtterances)}),NotificationService.notify(_msg,"success"),$scope.trainStatus.saving=!1,$scope.trainStatus.failed=!1,$scope.trainStatus.success=!1},function(err){err.data&&409==err.data.errors[0].code?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")}),"remove"===operation&&BTStreamsService.deleteNode(nodeData[0].nodeId,$scope.stream._id,$scope.currentGroup.groupId).then(function(response){response.data&&(NotificationService.notify(i18n.i18nString("delete_smalltalk_group_success"),"success"),$scope.currentGroup=response.data,$scope.totalSequence=$scope.currentGroup.count,$scope.trainStatus.saving=!1,$scope.trainStatus.failed=!1,$scope.trainStatus.success=!1)},function(err){NotificationService.notify(i18n.i18nString("some_error"),"error")}),"reorder"===operation&&(_payload={nodeId:nodeData[0].nodeId,destGroupId:targetGroup.groupId,sourceGroupId:$scope.currentGroup.groupId},BTStreamsService.reOderSmallTalk($scope.stream._id,_payload).then(function(response){response.data&&($scope.currentGroup.nodes=response.data.nodes,draggedScope.remove(),$scope.smallTalkTaxonomy=angular.copy($scope.currentGroup.nodes),NotificationService.notify(_msg,"success"),$scope.trainStatus.saving=!1,$scope.trainStatus.failed=!1,$scope.trainStatus.success=!1)},function(err){NotificationService.notify(i18n.i18nString("some_error"),"error")})),"dragdrop"===operation&&(_payload={fromSeqId:draggedScope.seq,toSeqId:droppedIndex},BTStreamsService.reOrderQuestions($scope.stream._id,targetGroup.groupId,draggedScope.nodeId,_payload).then(function(response){NotificationService.notify(_msg,"success"),$scope.trainStatus.saving=!1,$scope.trainStatus.failed=!1,$scope.trainStatus.success=!1},function(err){NotificationService.notify(i18n.i18nString("some_error"),"error")}))},$scope.treeOptions={accept:function(sourceNodeScope,destNodesScope,destIndex){var data=sourceNodeScope.$element.attr("parent-data"),destType=destNodesScope.$element.attr("parent-data");return console.log(data,destType),data===destType?!0:!1},dropped:function(e){console.log(e);var _msg,sourceModelValue=e.source.nodeScope.$modelValue;if(e.source.index!==e.dest.index&&e.dest&&e.dest.nodesScope&&!e.dest.destScope.block){var _destIndex=(e.dest.nodesScope.$modelValue,_.findIndex(e.dest.nodesScope.$modelValue,{nodeId:sourceModelValue.nodeId}));_msg=i18n.i18nString("que_reordered"),$scope.cudSmallTalk("dragdrop",null,$scope.currentGroup,_msg,null,sourceModelValue,_destIndex)}else e.dest.destScope&&e.dest.destScope.block&&e.dest.destScope.block.groupId!==$scope.currentGroup.groupId&&(_msg=i18n.i18nString("qa_reorder"),$scope.cudSmallTalk("reorder",sourceModelValue,e.dest.destScope.block,_msg,null,e.source.nodeScope))}},$scope.newItem=function(node){var newNodeObject={userUtterances:[],botUtterances:[]};$scope.totalSequence||0===$scope.totalSequence?$scope.totalSequence=$scope.totalSequence+1:$scope.totalSequence=0,newNodeObject.seq=$scope.totalSequence,newNodeObject.userUtterances.push({text:$scope.node.userSays}),$scope.channelObj={channel:"default",type:"basic",_id:"",text:$scope.node.botSays},newNodeObject.botUtterances.push($scope.channelObj),BTStreamsService.creteNewNode(newNodeObject,$scope.stream._id,$scope.currentGroup.groupId).then(function(response){if(response){var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Small Talk"};mixPanel.postEvent("Conversation - Small Talk Entry added",eventInfo),$scope.node={};var nodeData=response.data;NotificationService.notify(i18n.i18nString("que_ans_added"),"success");var refNodeData=angular.copy(nodeData);$scope.currentGroup.nodes.push(nodeData),prepareTreeData(refNodeData),$scope.trainStatus.saving=!1,$scope.trainStatus.failed=!1,$scope.trainStatus.success=!1}},function(err){err.data&&409==err.data.errors[0].code?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")})},$scope.onEnterNewItem=function(e,form,node){13===e.keyCode&&form.$valid&&$scope.newItem(node)},$scope.onTagAddedUser=function(tag,nodeData){var termData,_msg;tag.editable?(_.filter(nodeData.userUtterances,function(node){node.hasOwnProperty("editable")&&delete node.editable}),termData=nodeData,_msg=i18n.i18nString("que_updated"),$scope.cudSmallTalk("update",termData,null,_msg)):(nodeData.userUtterances[nodeData.userUtterances.length-1].text=tag.text,termData=nodeData,!termData.nodeId&&nodeData.botUtterances.length?(_msg=1===nodeData.botUtterances.length?i18n.i18nString("que_ans_added"):i18n.i18nString("que_added"),$scope.cudSmallTalk("create",termData,null,_msg)):nodeData.botUtterances.length&&termData.nodeId&&(_msg=i18n.i18nString("que_added"),$scope.cudSmallTalk("update",termData,null,_msg)))},$scope.onTagAddedBot=function(tag,nodeData){var termData,_msg;if(tag.editable)_.filter(nodeData.botUtterances,function(node){node.hasOwnProperty("editable")&&delete node.editable}),termData=nodeData,_msg=i18n.i18nString("ans_updated"),$scope.cudSmallTalk("update",termData,null,_msg);else{nodeData.botUtterances[nodeData.botUtterances.length-1].channel="default",nodeData.botUtterances[nodeData.botUtterances.length-1].type="basic",nodeData.botUtterances[nodeData.botUtterances.length-1]._id="",nodeData.botUtterances[nodeData.botUtterances.length-1].text=tag.text;var nodeDataCopy=angular.copy(nodeData);_.filter(nodeDataCopy.botUtterances,function(n){n.uiText&&delete n.uiText}),termData=nodeDataCopy,!termData.nodeId&&nodeData.userUtterances.length?(_msg=1===nodeData.userUtterances.length?i18n.i18nString("que_ans_added"):i18n.i18nString("answer_added"),$scope.cudSmallTalk("create",termData,null,_msg,nodeData)):termData.nodeId&&nodeData.userUtterances.length&&(_msg=i18n.i18nString("answer_added"),$scope.cudSmallTalk("update",termData,null,_msg))}},$scope.onTagRemovedUser=function(tag,nodeData){function success(){}var _msg,termData;return tag||1!==nodeData.userUtterances.length?(_.remove(nodeData.userUtterances,function(node){return node.text===tag.text}),termData=nodeData,void(termData.nodeId&&(_msg=i18n.i18nString("que_removed"),$scope.cudSmallTalk("update",termData,null,_msg)))):void NotificationService.suggestion({heading:"Warning",headerClass:"confirmationHeader",bodyClass:"confirmationbody","class":"hide",msg:i18n.i18nString("atleast_que"),successCb:success,cancelCb:function(){return!1},isModal:!0})},$scope.onTagRemovedBot=function(tag,nodeData){function success(){}var _msg;if(!tag&&1===nodeData.botUtterances.length)return void NotificationService.suggestion({heading:"Warning",headerClass:"confirmationHeader",bodyClass:"confirmationbody","class":"hide",msg:i18n.i18nString("atleast_req"),successCb:success,cancelCb:function(){return!1},isModal:!0});_.remove(nodeData.botUtterances,function(node){return node.text===tag.text});var termData=nodeData;termData.nodeId&&(_msg=i18n.i18nString("ans_moved"),$scope.cudSmallTalk("update",termData,null,_msg))},$scope.newSubItem=function(scope){function confirmation(){}$timeout(function(){if(scope.depth()<=$scope.allowedDepth){var nodeData=scope.$modelValue,newNodeObject={seq:nodeData.nodes.length?nodeData.nodes.length:0,parentId:nodeData.nodeId,userUtterances:[],botUtterances:[]};if(newNodeObject.nodes=[],nodeData.userUtterances.length&&nodeData.botUtterances.length)nodeData.nodes.length?(nodeData.nodes[nodeData.nodes.length-1].userUtterances.length||nodeData.nodes[nodeData.nodes.length-1].botUtterances.length)&&(nodeData.nodes.push(newNodeObject),scope.expand()):(nodeData.nodes.push(newNodeObject),scope.expand());else{var msg=i18n.i18nString("atleast_onequeres");NotificationService.alert(msg,confirmation,{okText:i18n.i18nString("ok_label")})}setTimeout(function(){nodeData.nodeId?$("[nodeid="+nodeData.nodeId+"]").find(".userSays:last input").focus():$("[nodeid="+nodeData.parentId+"]").find(".userSays:last input").focus()},200)}})};var checkNodeState=function(term){console.log(term)};$scope.deleteNode=function(scope){function proceed(){nodeElem.nodeId?($scope.cudSmallTalk("remove",nodeElem),currentScope.remove()):currentScope.remove()}function failCb(){console.log("on cancel callback")}var _msg,nodeElem=scope.$modelValue;nodeElem.botUtterances.length||nodeElem.userUtterances.length||scope.remove(),_msg=nodeElem.nodes.length?i18n.i18nString("sure_delete_que"):i18n.i18nString("confirm_delete_question");var currentScope=scope;NotificationService.confirm({heading:i18n.i18nString("delete_qa"),"class":"hide",headerClass:"confirmationHeader",bodyClass:"confirmationbody",noteClass:"confirmationNote",msg:_msg,note:checkNodeState(scope.$modelValue),successCb:proceed,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("ok"),fail:i18n.i18nString("cancel")}})},$scope.getNodesCurrentTab=function(currentGroup){$scope.domLoading=!0,_offset={skip:0,limit:60},BTStreamsService.paginateSmallTalk($scope.stream._id,currentGroup.groupId,_offset).then(function(response){if(response){$scope.currentGroup=response.data,$scope.totalSequence=$scope.currentGroup.count,response.data&&response.data.hasOwnProperty("isDataAvailable")&&($scope.isDataAvailable=response.data.isDataAvailable),angular.forEach($scope.currentGroup.nodes,function(node,index){node.botUtterances.length&&node.userUtterances.length?_.map(node.botUtterances,function(message){message.text=decodeJS(message.text),"uxmap"===message.type&&(message.uiText=i18n.i18nString("js_Msg"))}):$scope.currentGroup.nodes.splice(index,1)}),$scope.smallTalkTaxonomy=angular.copy($scope.currentGroup.nodes);var totalTreeData=_.filter($scope.smallTalkTaxonomy,function(treeData){return!treeData.parentId});ifDataSorted(totalTreeData);var _sortedData=sortItemsBasedOnSeq(totalTreeData);_.map(_sortedData,function(treeData,index){treeData.nodes=[],fillChildren($scope.smallTalkTaxonomy,treeData.nodes,treeData)}),$scope._originalData=angular.copy(_sortedData),$scope.clientNodes=_sortedData.slice(0,20),$scope.data=$scope.clientNodes,$timeout(function(){domLoading()}),$(".smTalkContainer").animate({scrollTop:0})}},function(err){$scope.domLoading=!1,NotificationService.notify(i18n.i18nString("some_error"),"error")})},$scope.selectedChannel={},$scope.selectedChannel.channel="default",$scope.openSmallTalkResponses=function(event,nodeData,tag){event&&event.stopPropagation(),$scope.refCopyNodeData=nodeData,$scope.currentNodeData=angular.copy(nodeData);var _currentIndex;$scope.botUtterances=$scope.currentNodeData.botUtterances,$scope.botUtterances&&($scope.standardPrompts=[],$scope.channelPrompts=[],$scope._allPrompts=[],$scope.botUtterances&&$scope.botUtterances.length>0&&$scope.botUtterances.map(function(message){message.text=message.text,"default"===message.channel?$scope.standardPrompts.push(message):("wfacebook"===message.channel&&(message.channel=message.isMention?"wfacebookG":"wfacebookC"),$scope.channelPrompts.push(message))}),$scope._allPrompts=$scope._allPrompts.concat($scope.standardPrompts),$scope._allPrompts=$scope._allPrompts.concat($scope.channelPrompts),$scope._allPrompts.forEach(function(obj){obj.isOpen=!1})),tag&&(_currentIndex=_.findIndex($scope.currentNodeData.botUtterances,{text:tag.text}),$timeout(function(){$("#promptHeader-"+_currentIndex).trigger("click")},500)),$scope.openModalSlider("#manageSmallTalkResponse")},$scope.bridge.openEditSlider=function(e,nodeData,tagData){$scope.openSmallTalkResponses(null,nodeData,tagData)},$scope.editPrompt=function(prompt,index,isOpen){$scope.currEditPromptIndex=index,$scope.editMessageIndex=index,$scope.selectedChannel.channel=index>=0?$scope._allPrompts[index].channel:"",index>=0&&"basic"===$scope._allPrompts[index].type?$scope.currentTabIndex=0:$scope.currentTabIndex=1,prompt.text=$scope._allPrompts[index].text,"wfacebook"===$scope.selectedChannel.channel&&($scope.selectedChannel.channel=$scope._allPrompts[index].isMention?"wfacebookG":"wfacebookC")},$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.getJsSamples(),$scope.saveUserPromptMessages=function(index,_isFrmDelete,_isFrmCreate){var _tempMessage=[];$scope._allPrompts&&$scope._allPrompts.length>0&&$.each($scope._allPrompts,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebookG"===_tempMessageObject.channel||"wfacebookC"===_tempMessageObject.channel||"wfacebook"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFrmDelete&&_tempMessage.splice(index,1),$scope.currentNodeData.botUtterances=_tempMessage;var nodeData=$scope.currentNodeData;nodeData=_.isArray(nodeData)?nodeData:[nodeData],
nodeData=_.map(nodeData,function(node){return node=_.omit(node,["nodes","defaultCollapse"])}),BTStreamsService.updateNode(nodeData[0],$scope.stream._id,$scope.currentGroup.groupId).then(function(response){var updatedTermData=response.data;angular.forEach(updatedTermData.botUtterances,function(messObj){messObj.text=decodeURIComponent(messObj.text),"uxmap"===messObj.type&&(messObj.uiText=i18n.i18nString("js_Msg"))}),$scope.refCopyNodeData.botUtterances=updatedTermData.botUtterances,$scope._allPrompts=angular.copy(updatedTermData.botUtterances),angular.forEach($scope.currentGroup.nodes,function(node){node.nodeId===updatedTermData.nodeId&&(node=response.data)}),$scope.trainStatus.saving=!1,$scope.trainStatus.failed=!1,$scope.trainStatus.success=!1},function(err){err.data&&err.data.errors&&err.data.errors.length>0&&NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.saveMessage=function(index,prompt){if($scope._allPrompts=$scope._allPrompts||[],1===$scope._allPrompts.length&&"default"!==$scope._allPrompts[0].channel)return void NotificationService.notify(i18n.i18nString("atleast_res"),"error");if($scope._allPrompts.length>1){var filteredPrompts=_.filter($scope._allPrompts,{channel:"default"});if(!filteredPrompts.length)return void NotificationService.notify(i18n.i18nString("atleast_res"),"error")}var _isFrmCreate=!1,messageObject={};return messageObject.channel=prompt.channel,"wfacebookG"===messageObject.channel?(messageObject.channel="wfacebook",messageObject.isMention=!0):"wfacebookC"===messageObject.channel&&(messageObject.channel="wfacebook",messageObject.isMention=!1),""===prompt.text?void NotificationService.notify(i18n.i18nString("please_add_res"),"error"):(messageObject.text=prompt.text,messageObject.type="uxmap"===prompt.type?"uxmap":"basic",-1===$scope.editMessageIndex&&prompt.text?(messageObject._id="",$scope._allPrompts[$scope._allPrompts.length-1].text=messageObject.text,$scope._allPrompts[$scope._allPrompts.length-1].type=messageObject.type):(messageObject._id=$scope._allPrompts[$scope.editMessageIndex]._id,$scope._allPrompts[$scope.editMessageIndex]=messageObject),$scope._allPrompts[$scope.editMessageIndex]||(_isFrmCreate=!0),$scope.saveUserPromptMessages(index,!1,_isFrmCreate),void($scope.currentTabIndex=0))},$scope.closeSmallTalkResponse=function(){$scope.closeModalSlider("#manageSmallTalkResponse")},$scope.editSmallTalk=function(event){$timeout(function(){var _parentElement=$(event.currentTarget).parents(".angular-ui-tree-handle");_parentElement.find(".tag-item").removeAttr("style"),_parentElement.find(".count").removeClass("count")})},$scope.uploadJSONFile=function(fileObject){var _ext="";if(fileObject.name){_ext=fileObject.name.substring(fileObject.name.lastIndexOf(".")),_ext.slice(1).toUpperCase();var supportingFileFormats=[".json",".tsv"];if(-1===$.inArray(_ext,supportingFileFormats))return NotificationService.notify(i18n.i18nString("upload_file_desc"),"error"),void($scope.fileExtensionError=!0)}var reader=new FileReader;reader.readAsText(fileObject),reader.onload=function(e){var respnoseData=reader.result;if($scope.jsonData=respnoseData,!respnoseData||respnoseData&&!respnoseData.length)NotificationService.notify(i18n.i18nString("file_valid_content",{ext:_ext.slice(1).toUpperCase()}),"error"),$scope.fileEmptyError=!0;else{$scope.fileName=fileObject.name,$scope.fileExtensionError=!1;var data=new FormData;data.append("file",fileObject),data.append("fileContext","bulkImport"),data.append("fileExtension",_ext.substring(_ext.lastIndexOf(".")+1)),data.append("Content-Type",fileObject.type),$scope.fileUploadData=data,$scope.fileObject=fileObject}}},$scope.importSmallTalk=function(){$scope.importing="initial",$(".import-small-talkImport").modal("show"),$timeout(function(){initDragDropFile()},500)},$scope.removeFile=function(){$scope.fileName=""},$scope.closeModal=function(){$(".import-small-talkImport").modal("hide"),$scope.removeFile()},$scope.onDone=function(){$(".import-small-talkImport").modal("hide"),$scope.fileName="",$scope.onCancel()},$scope.startImport=function(){$scope.importing="pending",$scope.totalProgress=1,BTStreamsService.uploadBotFunctionsFile($scope.userInfo.userId,$scope.fileUploadData).then(function(res){var fileUploaded={fileName:res.data.fileId,fileType:$scope.fileObject.name.substring($scope.fileObject.name.lastIndexOf(".")+1),importType:"override",streamId:$scope.stream._id};startImportProgress(),BTStreamsService.startImporting($scope.stream._id,fileUploaded).then(function(res){res&&res.data&&($scope.streamRefId=res.data._id||"",$scope.statusLogs=res.data.statusLogs||[],"pending"===res.data.status?($scope._importStatusInit=startPollImportStatus(3e3),$scope.importing=res.data.status):"success"===res.data.status?($scope.totalProgress=100,stopImportBotPolling(),startAutoTrain(),$scope.importing=res.data.status):"failed"===res.data.status?($scope.totalProgress=100,stopImportBotPolling(),$scope.importing=res.data.status):(stopImportBotPolling(),clearInterval(progressInterval),NotificationService.notify(i18n.i18nString("some_error"),"error")))},function(err){$scope.importing="failed",$scope.errorMsg=err.data.errors,clearInterval(progressInterval),progressInterval=null,err.data&&err.data.errors&&err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")})})},$scope.moveForward=function(step){"initial"===step&&($scope.importing="initial",$scope.removeFile())},$scope.goToStep=function(status){$scope.importing=status,$scope.moveForward(status)},$scope.exportSmallTalk=function(fileType){$scope.callback.exportFile(fileType)},$scope.$watch("groupDetails",function(newVal,oldVal){newVal&&$timeout(function(){$scope.currentGroup=newVal,$scope.currentTab=newVal.groupName,"VIEW"!==$scope.accessRights&&angular.element(".userSays input")[0].focus(),$scope.smallTalkGroups.groupData.length||getGroups(),setAccessRights(),$scope.getNodesCurrentTab($scope.currentGroup),checkSmallTalkSyncStatus(),$("body").addClass("smalltalk-modal")})}),$scope.$watch("groups",function(newVal,oldVal){newVal&&($scope.smallTalkGroups.groupData=newVal,$scope.originalCopy=angular.copy($scope.smallTalkGroups))}),$scope.$watch("newGroup",function(newVal,oldVal){newVal&&($scope.smallTalkGroups.groupData.push(newVal),$scope.smallTalkGroups.groupData=_.unique($scope.smallTalkGroups.groupData,"groupId"),$scope.currentGroup=newVal,$scope.currentTab=newVal.groupName,setAccessRights(),$scope.getNodesCurrentTab($scope.currentGroup),$timeout(function(){angular.element(".userSays input")[0].focus(),$("body").addClass("smalltalk-modal")},500),checkSmallTalkSyncStatus())}),$scope.setCurrentTab=function(currentGroup,index,check){check[index].editMode||($scope.currentTab=currentGroup.groupName,setTimeout(function(){angular.element(".userSays input")[0].focus()},100),$scope.search.searchUtterance="",$scope.getNodesCurrentTab(currentGroup))},$scope.activeTabType=function(type,prompt){var currentActiveTab="basic"===prompt.type?"basic":"uxmap";if(type!==currentActiveTab)if("uxmap"===type){if(prompt.text&&prompt.text.trim())return void NotificationService.notify(i18n.i18nString("advance_mode"));prompt.type=type}else if("basic"===type){if(prompt.text&&prompt.text.trim())return void NotificationService.notify(i18n.i18nString("standard_mode"));prompt.type=type}},$scope.addNewResponse=function(){var _obj={channel:"default",text:"",type:"basic",_id:""};if($scope._allPrompts.length){var _prevObj=$scope._allPrompts[$scope._allPrompts.length-1];if(""===_prevObj.text||void 0===_prevObj.text)return}$scope._allPrompts.push(_obj),$scope._allPrompts[$scope._allPrompts.length-1].isOpen=!1,$scope.editMessageIndex=-1},$scope.deleteResponse=function(index,e){if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),""===$scope._allPrompts[index].text)return $scope._allPrompts.splice(index,1),void NotificationService.notify(i18n.i18nString("bot_Res_deleted"),"success");var _defaultChannelCount=$scope._allPrompts.reduce(function(n,prompt){return n+("default"===prompt.channel)},0);if(_defaultChannelCount>1)$scope.saveUserPromptMessages(index,!0,!1);else{if("default"===$scope._allPrompts[index].channel)return void NotificationService.notify(i18n.i18nString("atleast_res"),"error");$scope.saveUserPromptMessages(index,!0,!1)}},$scope.loadMore=function(){0===skip&&(skip=1),$scope.isDataAvailable?(_offset.skip=60*skip-5,_offset.limit=65,BTStreamsService.paginateSmallTalk($scope.stream._id,$scope.currentGroup.groupId,_offset).then(function(response){if(response){var _concatedData;$scope.loading=!1,$scope.currentGroup&&$scope.currentGroup.nodes&&(_concatedData=$scope.currentGroup.nodes.concat(response.data.nodes)),$scope.currentGroup.nodes=_.uniq(_concatedData,function(obj){return obj.seq}),$scope.isDataAvailable=response.data.isDataAvailable,angular.forEach($scope.currentGroup.nodes,function(node,index){node.userUtterances.length&&node.botUtterances.length?_.map(node.botUtterances,function(message){message.text=decodeJS(message.text),"uxmap"===message.type&&(message.uiText=i18n.i18nString("js_Msg"))}):$scope.currentGroup.nodes.splice(index,1)}),$scope.smallTalkTaxonomy=angular.copy($scope.currentGroup.nodes);var totalTreeData=_.filter($scope.smallTalkTaxonomy,function(treeData){return!treeData.parentId});ifDataSorted(totalTreeData);var _sortedData=sortItemsBasedOnSeq(totalTreeData);_.map(_sortedData,function(treeData,index){treeData.nodes=[],fillChildren($scope.smallTalkTaxonomy,treeData.nodes,treeData)}),$scope._originalData=angular.copy(_sortedData),skip++,$scope.loadingBatch=!1,$timeout(function(){var _container=$(".smTalkContainer");_container.scrollTop(.9*_container[0].clientHeight)})}})):($scope.loading=!1,$scope.loadingBatch=!1,$scope.isDataAvailable=!1,skip=0)},$scope.searchUserUtterance=function(search,event){search.searchUtterance.length>=1&&13===event.keyCode?BTStreamsService.searchUserSays($scope.stream._id,$scope.currentGroup.groupId,search.searchUtterance).then(function(response){$scope.searchedResults=response.data,angular.forEach($scope.searchedResults.nodes,function(node){_.map(node.botUtterances,function(message){message.text=decodeJS(message.text),"uxmap"===message.type&&(message.uiText=i18n.i18nString("js_Msg"))})}),$scope.searchTaxonomy=angular.copy($scope.searchedResults.nodes);var searchTreeData=_.filter($scope.searchTaxonomy,function(treeData){return!treeData.parentId});_.map(searchTreeData,function(treeData,index){treeData.nodes=[],fillChildrenSearch($scope.searchTaxonomy,treeData.nodes,treeData)}),$scope.data=searchTreeData}):0===search.searchUtterance.length&&$scope.getNodesCurrentTab($scope.currentGroup)},$scope.trainBot=function(){$scope.trainStatus.saving=!0,BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Small Talk"};mixPanel.postEvent("Conversation - Small Talk Bot trained",eventInfo),$scope.trainStatus.saving=!0,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!1,$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$broadcast("getProgressDockStatus"),NotificationService.notify(i18n.i18nString("bot_train"),"info")},function(err){$scope.trainStatus.saving=!1,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!0,"NO"!==$scope.nlpPermission&&(err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error"))})},$rootScope.$on("SmallTalkTrainFinished",function($event){$scope.trainStatus={success:!0,failed:!1,saving:!1}}),$rootScope.$on("SmallTalkTrainFailed",function($event){$scope.trainStatus={success:!1,failed:!0,saving:!1}});var Events=function(element){this.element=element};Events.prototype.enableDrag=function(){$(this.element).hasClass("ui-draggable")&&$(this.element).draggable("enable")},Events.prototype.disableDrag=function(){$(this.element).hasClass("ui-draggable")&&$(this.element).draggable("disable")},Events.prototype.registerDrop=function(){$(this.element).droppable({hoverClass:"nodehovered",accept:function(droppedElement){return $(droppedElement).parent().hasClass("noLeftBorder")?!0:!1},classes:{"ui-droppable-hover":"ui-state-hover"},tolerance:"pointer",drop:function(event,ui){setTimeout(function(){var _targetGroup=$(event.target).scope().block,_dragggedNode=$(ui.draggable).scope().$modelValue,_draggedScope=$(ui.draggable).scope();if(void 0!==_targetGroup&&void 0!==_dragggedNode){var _msg=i18n.i18nString("qa_reorder");return void $scope.cudSmallTalk("reorder",_dragggedNode,_targetGroup,_msg,null,_draggedScope)}},500)}})},Events.prototype.registerDrag=function(){$(this.element).draggable({appendTo:".smallTalkContainer",cursor:"move",zIndex:999999,scroll:!1,containment:"document",helper:function(event){var _primaryQuestionValue,currentNodeScope=$(event.currentTarget).scope().$nodeScope;currentNodeScope&&currentNodeScope.$modelValue.userUtterances&&(_primaryQuestionValue=currentNodeScope.$modelValue.userUtterances[0].text);var html='<div class="ui-widget-header tileParent" style="z-index:999999"><div class="child1"><div class="child2"><div class="child3"><span class="helperText">'+_primaryQuestionValue+"</span></div></div></div></div>";return $scope.html=html,$(html)},start:function(event,ui){$scope.dragInProgress=!0},stop:function(event,ui){$scope.dragInProgress=!1},refreshPositions:!0})},$scope.pushBatch=function(bufferSize,start){if(start!==$scope.totalSequence&&start+1!==$scope.totalSequence){var _tempData=$scope._originalData.slice(start,start+bufferSize);_tempData.length>=10?$scope.uiNodes=_.uniq($scope.clientNodes.concat(_tempData),function(obj){return obj.seq}):_tempData.length<10&&(_tempData=$scope._originalData.slice(start-10,start+bufferSize),$scope.uiNodes=_.uniq($scope.clientNodes.concat(_tempData),function(obj){return obj.seq})),$scope.data=$scope.uiNodes,$scope.clientNodes=$scope.uiNodes,$scope.clientNodes.length>=2*bufferSize&&$scope.clientNodes.splice(0,bufferSize),$timeout(function(){var _container=$(".smTalkContainer");_container.scrollTop(.9*_container[0].clientHeight),$scope.loadingClientBatch=!1})}},$scope.popBatch=function(bufferSize,start){var _tempData,_container;start>bufferSize?(_tempData=$scope._originalData.slice(start-bufferSize,start),$scope.clientNodes=_tempData,$scope.data=$scope.clientNodes,$timeout(function(){_container=$(".smTalkContainer"),_container.animate({scrollTop:30}),$scope.loadingClientBatch=!1})):bufferSize>=start&&(_tempData=$scope._originalData.slice(0,bufferSize),$scope.clientNodes=_tempData,$scope.data=$scope.clientNodes,$timeout(function(){_container=$(".smTalkContainer"),_container.animate({scrollTop:0}),$scope.setToInitialContion()}))}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btStandardResponse",function(){return{restrict:"EAQ",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-standard-response/bt-standard-response.html",controller:["$scope","$rootScope","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","channelsConfig","i18n",function($scope,$rootScope,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,channelsConfig,i18n){function getLabel(obj,type){var curField=null,curTask=$scope.availableTasks.filter(function(task){return task._id===obj.taskId})[0];return curTask?"task"===type?curTask.label||curTask.name:curTask&&(curTask.alertFieldsDefinition||curTask.payloadField||curTask.queryField)?(curTask&&curTask.alertFieldsDefinition?$scope.availFields=curTask.alertFieldsDefinition||[]:curTask&&curTask.queryField&&curTask.payloadField&&($scope.availFields=curTask.queryField.concat(curTask.payloadField)||[]),curField=$scope.availFields.filter(function(field){return field.key===obj.fieldId})[0],curField.title):curTask&&curTask.nodes?(curField=$scope.availEntities.filter(function(_node){return _node._id===obj.fieldId})[0],curField&&curField.name||"default"):void 0:""}function getTaskFields(taskId,panelOpen,index,parentIndex){if(!panelOpen&&"default"!==taskId){var currentTask=$scope.availableTasks.filter(function(task){return task._id===taskId})[0];currentTask&&currentTask.alertFieldsDefinition?$scope.availableFields=currentTask.alertFieldsDefinition:currentTask&&currentTask.queryField&&currentTask.payloadField?$scope.availableFields=currentTask.queryField.concat(currentTask.payloadField):currentTask&&currentTask.nodes&&BTFlowtaskService.getFlowtaskComponents($workflowService.selectedStream()._id,currentTask._id).then(function(res){$scope.availableFields=_.filter(res.data,{type:"entity"})||[]}),setTimeout(function(){scrollToEle("promptHeader-"+parentIndex+"."+index)},200)}}function scrollToEle(element){var _PanelEle=$(element);if(_PanelEle){var _container=_PanelEle.closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=_PanelEle.offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"slow")}}}function getOverrideValues(options){var valuesArray=[];if(!options||!options.length)return valuesArray;for(var i=0;i<options.length;i++){var subOption=options[i];if(subOption.hasOwnProperty("botUXMap")&&subOption.botUXMap.hasOwnProperty("uXMap")){var obj={channel:subOption.channel,_id:subOption._id,uXMap:subOption.botUXMap.uXMap,isMarkDown:subOption.botUXMap.isMarkDown,show:!1};"wfacebook"===subOption.channel&&subOption.isMention?(obj.channel="Workplace For Groups",obj.isMention=subOption.isMention):"wfacebook"!==subOption.channel||subOption.isMention||(obj.channel="Workplace For Chat",obj.isMention=subOption.isMention),valuesArray.push(obj)}if(subOption.hasOwnProperty("taskUXMaps"))for(var j=0;j<subOption.taskUXMaps.length;j++){var taskSpecific=subOption.taskUXMaps[j],obj1={channel:subOption.channel,_id:taskSpecific._id,taskId:taskSpecific.taskId,taskLabel:getLabel(taskSpecific,"task"),uXMap:taskSpecific.uXMap,isMarkDown:taskSpecific.isMarkDown,show:!1};"wfacebook"===subOption.channel&&subOption.isMention?(obj1.channel="Workplace For Groups",obj1.isMention=subOption.isMention):"wfacebook"!==subOption.channel||subOption.isMention||(obj1.channel="Workplace For Chat",obj1.isMention=subOption.isMention),valuesArray.push(obj1)}if(subOption.hasOwnProperty("fieldUXMaps"))for(var k=0;k<subOption.fieldUXMaps.length;k++){var fieldSpecific=subOption.fieldUXMaps[k],obj2={channel:subOption.channel,_id:fieldSpecific._id,taskId:fieldSpecific.taskId,taskLabel:getLabel(fieldSpecific,"task"),fieldId:fieldSpecific.fieldId,fieldLabel:getLabel(fieldSpecific,"field"),uXMap:fieldSpecific.uXMap,isMarkDown:fieldSpecific.isMarkDown,show:!1};"wfacebook"===subOption.channel&&subOption.isMention?(obj2.channel="Workplace For Groups",obj2.isMention=subOption.isMention):"wfacebook"!==subOption.channel||subOption.isMention||(obj2.channel="Workplace For Chat",obj2.isMention=subOption.isMention),valuesArray.push(obj2)}}for(var l=0;l<valuesArray.length;l++){var curValue=valuesArray[l];curValue.hasOwnProperty("fieldId")||(curValue.hasOwnProperty("taskId")?(curValue.fieldId="default",curValue.fieldLabel="Any Field"):"default"===curValue.channel?(curValue.taskLabel="-",curValue.fieldLabel="-"):(curValue.taskId="default",curValue.taskLabel="Any Task",curValue.fieldLabel="-"))}return valuesArray}function convertTolistOfObjects(arr){var originalMsg=angular.copy(arr),res=[];return originalMsg.map(function(msg){res.push({message:msg,show:!1})}),res}function getGenericMessages(streamId){$scope.loadingPrompts=!0,BTStreamsService.getGenericMessages(streamId).then(function(res){$scope.completeMsgData=[],setTimeout(function(){$scope.loadingPrompts=!1},100),$scope.responses=[],$scope.cb.conditionKey.key&&$scope.cb.conditionKey.key.forEach(function(key){var _msgs={};$scope.allCategoryRes=[].concat(res.data.messages.Choices,res.data.messages["Error & Warnings"],res.data.messages.Greeting,res.data.messages.Statements,res.data.messages.Queries,res.data.messages.Questions),$scope.allCategoryRes.forEach(function(val){if(val&&val.Key===key){_msgs=val;var obj={};obj.title=_msgs.Condition,obj.key=_msgs.Key,obj.showAddOptions=!1,_msgs["Original Message"]=convertTolistOfObjects(_msgs["Original Message"]),obj.ivrOptions=_msgs.ivrOptions,obj.value=_msgs["Original Message"],obj.channelUXMaps=_msgs.channelUXMaps?_msgs.channelUXMaps:[],obj.override=getOverrideValues(obj.channelUXMaps),obj.hideOriginalMessages=val.hideOriginalMessages||!1;var _responses=[];obj.value&&!obj.hideOriginalMessages&&obj.value.forEach(function(obj){var _obj1={fieldId:"",isMarkDown:!0,taskId:"",uxMap:obj.message,channel:"default"};_responses.push(_obj1)});for(var i=0;i<obj.channelUXMaps.length;i++)"wfacebook"===obj.channelUXMaps[i].channel&&obj.channelUXMaps[i].isMention?obj.channelUXMaps[i].channel="wfacebookG":"wfacebook"!==obj.channelUXMaps[i].channel||obj.channelUXMaps[i].isMention||(obj.channelUXMaps[i].channel="wfacebookC");obj.channelUXMaps.forEach(function(obj1){if(obj1.botUXMap&&obj1.botUXMap.uXMap){var msg=obj1.botUXMap,_obj1={fieldId:"",isMarkDown:msg.isMarkDown,taskId:"default",uxMap:msg.uXMap,channel:obj1.channel};msg.isMarkDown||(_obj1.jsEditorValue=msg.uXMap.substring(msg.uXMap.indexOf("<% ")+2,msg.uXMap.lastIndexOf("%>")),_obj1.uxMap=""),_responses.push(_obj1)}obj1.fieldUXMaps&&obj1.fieldUXMaps.length&&obj1.fieldUXMaps.forEach(function(msg){var _obj1={fieldId:msg.fieldId,isMarkDown:msg.isMarkDown,taskId:msg.taskId,uxMap:msg.uXMap,channel:obj1.channel};msg.isMarkDown||(_obj1.jsEditorValue=msg.uXMap.substring(msg.uXMap.indexOf("<% ")+2,msg.uXMap.lastIndexOf("%>")),_obj1.uxMap=""),_responses.push(_obj1)}),obj1.taskUXMaps&&obj1.taskUXMaps.length&&obj1.taskUXMaps.forEach(function(msg){var _obj1={fieldId:"default",isMarkDown:msg.isMarkDown,taskId:msg.taskId,uxMap:msg.uXMap,channel:obj1.channel};msg.isMarkDown||(_obj1.jsEditorValue=msg.uXMap.substring(msg.uXMap.indexOf("<% ")+2,msg.uXMap.lastIndexOf("%>")),_obj1.uxMap=""),_responses.push(_obj1)})}),$scope.completeMsgData.push(obj),_responses.condition=obj.title,_responses.key=obj.key,$scope.responses.push(_responses),$scope.originalResponse=angular.copy($scope.responses)}})})},function(err){$scope.loadingPrompts=!1})}$scope.stream=$workflowService.selectedStream(),$scope.botState=$workflowService.selectedStreamState(),$scope._constants_=$rootScope._constants_,$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.assetsBase=env_conf["assets-url"];var editingMessage={};$scope.responses=[],$scope.availEntities=[],$scope.rightClass="right700",$scope.loadingPrompts=!1,$scope.loadingEntities=!0,$scope.demoTemplates=[],$scope.btnValue="back",channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.availableChannels=Object.values(channelsConfig.channelsObject),$scope._channelConfig=channelsConfig;var isWFacebook=!1,wfacebookIndex=0;$scope.availableChannels=$scope.availableChannels.map(function(channel,i){return"wfacebook"===channel.id&&(isWFacebook=!0,wfacebookIndex=i),channel}),isWFacebook&&$scope.availableChannels.splice(wfacebookIndex,1),$scope.availableChannels=_.filter($scope.availableChannels,{enable:!0}),$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.getJsSamples(),$scope.availableTasks=[],$scope.availableFields=[],$scope.jsEditorCallbacks={},$scope.markdownCB1={},$scope.markdownCB2={};var alerts=$workflowService.alertTasksByState(),actions=$workflowService.actionTasksByState(),dailogs=$workflowService.dialogTasksByState();$scope.tasksByType=[],alerts.length&&$scope.tasksByType.push({type:i18n.i18nString("alert_tasks"),tasks:alerts}),actions.length&&$scope.tasksByType.push({type:i18n.i18nString("constants.actions"),tasks:actions}),dailogs.length&&$scope.tasksByType.push({type:i18n.i18nString("constants.flowTasks"),tasks:dailogs}),$scope.availableTasks=alerts.concat(actions),$scope.availableTasks=$scope.availableTasks.concat(dailogs),$scope.alldailogs=BTFlowtaskService.getComponents($workflowService.selectedStream()._id).then(function(res){$scope.availEntities=_.filter(res.data,{type:"entity"}),$scope.loadingEntities=!1},function(err){$scope.loadingEntities=!1}),$scope.getTaskFields=function(taskId){getTaskFields(taskId)},$scope.newOverride={isMarkDown:!0,taskId:null,fieldId:null},getTaskFields(),$scope.selectMessage=function(message){editingMessage=message},$scope.channelChanged=function(){$scope.newOverride.taskId=null,$scope.newOverride.fieldId=null},$scope.setPosition=function(index){setTimeout(function(){scrollToEle("#prompt-"+index)},300)},$scope.addNewResponse=function(response,index){if(response.length==$scope.originalResponse[index].length){var _obj={fieldId:"",isMarkDown:!0,taskId:"",uxMap:"",isOpen:!0,channel:""};response.push(_obj),setTimeout(function(){scrollToEle("#prompt-"+(response.length-1))},200)}else response[response.length-1].isOpen=!0,setTimeout(function(){scrollToEle("#prompt-"+(response.length-1))},200)},$scope.saveMessage=function(index,parentIndex,callType){var _responses=[];if(1===$scope.responses[parentIndex].length&&"default"!==$scope.responses[parentIndex][0].channel)return void NotificationService.notify(i18n.i18nString("allchannels_res"),"error");_responses=$scope.responses[parentIndex].length!==$scope.originalResponse[parentIndex].length&&"delete"===callType?angular.copy($scope.originalResponse):angular.copy($scope.responses);for(var channelUXMaps=[],i=0;i<_responses[parentIndex].length;i++){var _obj={channel:_responses[parentIndex][i].channel};"default"===_responses[parentIndex][i].channel||"default"===_responses[parentIndex][i].taskId?(_obj.botUXMap={},_obj.botUXMap={isMarkDown:_responses[parentIndex][i].isMarkDown,uXMap:_responses[parentIndex][i].isMarkDown?_responses[parentIndex][i].uxMap:"<% "+_responses[parentIndex][i].jsEditorValue+" %>"}):""===_responses[parentIndex][i].fieldId||"default"===_responses[parentIndex][i].fieldId?(_obj.taskUXMaps=[],_obj.taskUXMaps.push({isMarkDown:_responses[parentIndex][i].isMarkDown,taskId:_responses[parentIndex][i].taskId,uXMap:_responses[parentIndex][i].isMarkDown?_responses[parentIndex][i].uxMap:"<% "+_responses[parentIndex][i].jsEditorValue+" %>"})):(_obj.fieldUXMaps=[],_obj.fieldUXMaps.push({fieldId:_responses[parentIndex][i].fieldId,isMarkDown:_responses[parentIndex][i].isMarkDown,taskId:_responses[parentIndex][i].taskId,uXMap:_responses[parentIndex][i].isMarkDown?_responses[parentIndex][i].uxMap:"<% "+_responses[parentIndex][i].jsEditorValue+" %>"})),channelUXMaps.push(_obj)}if(channelUXMaps=angular.copy(channelUXMaps),$scope.responses[parentIndex].length>1&&"delete"===callType)channelUXMaps.splice(index,1);else if("delete"===callType&&!index&&1===$scope.responses[parentIndex].length)return void NotificationService.notify(i18n.i18nString("delete_res"),"warning");$scope.saveMessages(channelUXMaps,index,parentIndex,callType)},$scope.cb.initMessages=function(accessRight){$scope.accessRight=accessRight,$scope.markdownCB2.displayMode=$scope.accessRight,getGenericMessages($scope.stream._id)},$scope.cb.openManageResponse=function(_btnValue){$scope.rightClass="right700",$scope.openModalSlider("#manageResSlider"),$scope.btnValue=_btnValue},$scope.handleBackBtn=function(){$scope.closeModalSlider("#manageResSlider"),$scope.cb.closeResponseScreen()},$scope.closeManageResponse=function(){$scope.closeModalSlider("#manageResSlider")},$scope.deleteStandardResponse=function(index,parentIndex,event){return event.preventDefault(),1===$scope.responses[parentIndex].length&&"default"===$scope.responses[parentIndex][0].channel?void NotificationService.notify(i18n.i18nString("atleast_one_channel"),"error"):$scope.responses[parentIndex].length!==$scope.originalResponse[parentIndex].length&&index===$scope.responses[parentIndex].length-1?void $scope.responses[parentIndex].splice(index,1):void $scope.saveMessage(index,parentIndex,"delete")},$scope.activeTabType=function(type,prompt){var currentActiveTab=prompt.isMarkDown?"basic":"uXMap";if(type!==currentActiveTab)if("uXMap"===type){if(prompt.uxMap&&prompt.uxMap.trim())return void NotificationService.notify(i18n.i18nString("advanced_mode_desc"));prompt.isMarkDown=!1,$scope.nofocus=!1}else if("basic"===type){if(prompt.jsEditorValue&&prompt.jsEditorValue.trim())return void NotificationService.notify(i18n.i18nString("standard_mode_desc"));prompt.isMarkDown=!0,$scope.nofocus=!1}},$scope.saveMessages=function(channelUXMaps,index,parentIndex,callType){var msgsToSend=[];if(msgsToSend=$scope.completeMsgData[parentIndex].value.map(function(value){return value.message}),!$scope.savingNewOverride){var channelUxIndex=index||channelUXMaps.length-1;if(!callType&&channelUXMaps[channelUxIndex].channel){if("default"!==channelUXMaps[channelUxIndex].channel){if(channelUXMaps[channelUxIndex].taskUXMaps&&""===channelUXMaps[channelUxIndex].taskUXMaps[0].taskId)return void NotificationService.notify(i18n.i18nString("please_task"),"error");if(channelUXMaps[channelUxIndex].fieldUXMaps&&""===channelUXMaps[channelUxIndex].fieldUXMaps[0].taskId)return void NotificationService.notify(i18n.i18nString("please_task"),"error");if(channelUXMaps[channelUxIndex].fieldUXMaps&&""===channelUXMaps[channelUxIndex].fieldUXMaps[0].fieldId)return void NotificationService.notify(i18n.i18nString("please_field"),"error");if(channelUXMaps[channelUxIndex].taskUXMaps&&(""===channelUXMaps[channelUxIndex].taskUXMaps[0].uXMap.trim()||"<% undefined %>"===channelUXMaps[channelUxIndex].taskUXMaps[0].uXMap.trim()||"<%  %>"===channelUXMaps[channelUxIndex].taskUXMaps[0].uXMap)||channelUXMaps[channelUxIndex].fieldUXMaps&&(""===channelUXMaps[channelUxIndex].fieldUXMaps[0].uXMap||"<% undefined %>"===channelUXMaps[channelUxIndex].fieldUXMaps[0].uXMap.trim()||"<%  %>"===channelUXMaps[channelUxIndex].fieldUXMaps[0].uXMap))return void NotificationService.notify(i18n.i18nString("please_add_res"),"error")}if(("default"===channelUXMaps[channelUxIndex].channel||channelUXMaps[channelUxIndex].channel)&&channelUXMaps[channelUxIndex].botUXMap&&channelUXMaps[channelUxIndex].botUXMap.uXMap&&(""===channelUXMaps[channelUxIndex].botUXMap.uXMap.trim()||"<% undefined %>"===channelUXMaps[channelUxIndex].botUXMap.uXMap.trim()||"<%  %>"===channelUXMaps[channelUxIndex].botUXMap.uXMap))return void NotificationService.notify(i18n.i18nString("please_add_res"),"error")}else if(!callType)return void NotificationService.notify(i18n.i18nString("please_channel"),"error");$scope.savingNewOverride=!0;for(var payload={streamId:$scope.stream._id,Condition:$scope.responses[parentIndex].condition,Key:$scope.responses[parentIndex].key,"Original Message":msgsToSend,channelUXMaps:channelUXMaps,hideOriginalMessages:!0},i=0;i<payload.channelUXMaps.length;i++)"Workplace For Groups"===payload.channelUXMaps[i].channel||"wfacebookG"===payload.channelUXMaps[i].channel?(payload.channelUXMaps[i].channel="wfacebook",payload.channelUXMaps[i].isMention=!0):("Workplace For Chat"===payload.channelUXMaps[i].channel||"wfacebookC"===payload.channelUXMaps[i].channel)&&(payload.channelUXMaps[i].channel="wfacebook",payload.channelUXMaps[i].isMention=!1);$scope.loadingPrompts=!0,BTStreamsService.editOverrideMessages($scope.stream._id,payload).then(function(res){$scope.savingNewOverride=!1,$scope.loadingPrompts=!1,index&&"delete"==callType?($scope.responses[parentIndex].splice(index,1),$scope.originalResponse[parentIndex].splice(index,1),NotificationService.notify(i18n.i18nString("channel_override_delete"),"success")):($scope.originalResponse.push(res.data),getGenericMessages($scope.stream._id),NotificationService.notify(i18n.i18nString("channel_overide_saved"),"success"))},function(res){$scope.loadingPrompts=!1,$scope.savingNewOverride=!1,NotificationService.notify(res.data.errors[0].msg,"error");
})}}}]}})}(angular),function(ng){var _btSynonymsPatterns=ng.module("bt-forms");_btSynonymsPatterns.directive("btSynonymsPatterns",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-synonyms-patterns/bt-synonyms-patterns.html",controller:"btSynonymsPatternsController"}}),_btSynonymsPatterns.controller("btSynonymsPatternsController",["$scope","i18n","BTFlowtaskService","mixPanel",function($scope,i18n,BTFlowtaskService,mixPanel){function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createPattern"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Pattern Added"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function updateComponentPatterns(component,msg,index,sortIndex,pattern){var updatedPatterns=_.pluck(component.patterns||[],"value")||[];BTFlowtaskService.updateComponentPatterns($scope.stream._id,component._id,{patterns:updatedPatterns}).then(function(res){mixpanelEvent("createPattern"),res&&res.data&&setTimeout(function(){pattern.saving&&(pattern.saving=!1),component.patterns=res.data.patterns},100)},function(err){if(pattern.saving&&(pattern.saving=!1),err&&err.data&&err.data.errors&&"DENIED_ACTION"===err.data.errors[0].code)NotificationService.notify(err.data.errors[0].msg,"error");else{var msg=i18n.i18nString("patrn_module_dup_patrn_err");NotificationService.notify(msg,"error")}})}function validateEntityPattern(value){return value&&value.split("*").length-1>=1?!0:!1}$scope.ePatterns={},$scope.entityPatternsObject=[],$scope.patternModuleObj={triggeredFromSelect:!1},$scope.removeEditMode=function(index){$scope.selectedPattern=""},$scope.saveEntityPatternsObject=function(entity,isFromSort,index,pattern){if(index>=0){if(pattern.saving=!0,!isFromSort&&!validateEntityPattern($scope.ePatterns.editEntityPattern))return void NotificationService.notify(i18n.i18nString("patrn_module_enter_valid_pattern"),"error");entity.patterns[index].original&&entity.patterns[index].value?(entity.patterns[index].original=entity.patterns[index].original.replace(entity.patterns[index].original,$scope.ePatterns.editEntityPattern),entity.patterns[index].value=entity.patterns[index].value.replace(entity.patterns[index].value,$scope.ePatterns.editEntityPattern)):entity.patterns[index]=entity.patterns[index].replace(entity.patterns[index],$scope.ePatterns.editEntityPattern),updateComponentPatterns(entity,"",index,"",pattern),$(".hidingEntityPatterns"+index).removeClass("hide"),$(".editingEntityPatterns"+index).addClass("hide")}else{if(!isFromSort&&!validateEntityPattern($scope.ePatterns.newEntityPattern))return void NotificationService.notify(i18n.i18nString("patrn_module_enter_valid_pattern"),"error");entity.patterns=_.pluck(entity.patterns||[],"original")||[],!isFromSort&&entity.patterns&&entity.patterns.length?-1==$.inArray(entity.patterns,$scope.ePatterns.newEntityPattern)?(entity.patterns.push($scope.ePatterns.newEntityPattern),updateComponentPatterns(entity,"",void 0,sortIndex)):NotificationService.notify(i18n.i18nString("patrn_module_patrn_already_exists"),"error"):isFromSort?updateComponentPatterns(entity,"",void 0,sortIndex):(entity.patterns.push($scope.ePatterns.newEntityPattern),updateComponentPatterns(entity,"",void 0,sortIndex))}},$scope.clickEntityPattern=function(index,pattern){$scope.ePatterns.editEntityPattern=decodePattern(pattern.original),$scope.selectedPattern="editingEntityPatterns"+index,setTimeout(function(){$("#"+$scope.selectedPattern).focus()},500)}}])}(angular),function(ng){var _taskCreationForm=ng.module("bt-forms");_taskCreationForm.directive("btTaskCreationForm",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-task-creation-form/bt-task-creation-form.html",controller:"btTaskCreationFormCtrl"}}),_taskCreationForm.controller("btTaskCreationFormCtrl",["$scope","$rootScope","$filter","$timeout","$workflowService","patternFactory","form_util","BTAlertsService","BTActionsService","NotificationService","BTStreamsService","$applicationService","i18n","mixPanel",function($scope,$rootScope,$filter,$timeout,$workflowService,patternFactory,form_util,BTAlertsService,BTActionsService,NotificationService,BTStreamsService,$applicationService,i18n,mixPanel){function createBTAlert(){if(!$scope.saveInProgress){_alert={name:$scope.introObj.name,label:$scope.introObj.name,shortDesc:$scope.introObj.shortdescription,ignoreWords:$scope.introObj.ignoreWords,longDesc:$scope.introObj.longdescription,welcomeMsg:$scope.introObj.welcomemsg,type:$scope.introObj.type,streamId:_selectedStream._id,sourceStream:_selectedStream.name,needsTopic:!1,subtype:$scope.introObj.subtype||"rest",hasActions:$scope.introObj.hasActions,helpLink:$scope.introObj.helpLink,demoYoutubeLink:$scope.introObj.demoYoutubeLink,offKoraConfirmation:$scope.introObj.offKoraConfirmation,isAuthRequiredForWsdl:$scope.introObj.isAuthRequiredForWsdl};var connectionType={},connectionMode={};$scope.alerttypes.forEach(function(value){connectionType[value.value]=value.name}),$scope.subtypes.forEach(function(value){connectionMode[value.value]=value.name}),$scope.saveInProgress=!0,BTAlertsService.createBTAlert(_alert).then(function(res){$scope.alertid=res.data._id,$workflowService.alertInfo(res.data),createMPAlert(_alert,!0);var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Alert Task","Connection Type":connectionType[$scope.introObj.type],"Connection Mode":connectionMode[$scope.introObj.subtype]};mixPanel.postEvent("Conversation - Alert Task configured",eventInfo)},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.saveAndExit=!1,$scope.alertid=null,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_alert"),"error")})}}function createMPAlert(mpalert,create){var mpAlertObj;mpAlertObj=$workflowService.alertInfo(),mpalert._id=$scope.alertid,mpalert.namespace="private",mpalert.namespaceIds=[],mpalert.userAlertMsg=$scope.introObj.userAlertMsg,mpalert.teamAlertMsg=$scope.introObj.teamAlertMsg,mpalert.keywords=[],mpalert.contents=$scope.introObj.contents,$workflowService.alertData(mpalert),BTAlertsService.createMPAlert(mpalert).then(function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$workflowService.mpAlertInfo(res.data),$rootScope.$emit("onedittask",$workflowService.alertInfo(),$scope.wfType),$scope.closeGeneralInfoModal(),$rootScope.$emit("insertOrUpdateTask","alert",$workflowService.alertInfo(),!0),$scope.updateStep(3,"",!0)},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,$scope.isWorkProgress=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_alert"),"error"),BTAlertsService.deleteBTAlert($scope.alertid),$scope.alertid=null})}function createBTAction(){var _actionIntro={name:$scope.introObj.name,ignoreWords:$scope.introObj.ignoreWords,shortDesc:$scope.introObj.shortdescription,longDesc:$scope.introObj.longdescription,welcomeMsg:$scope.introObj.welcomemsg,type:$scope.introObj.type,subtype:$scope.introObj.subtype||"rest",streamId:_selectedStream._id,targetStream:_selectedStream.name,helpLink:$scope.introObj.helpLink,isReport:$scope.isReport,demoYoutubeLink:$scope.introObj.demoYoutubeLink,offKoraConfirmation:$scope.introObj.offKoraConfirmation,isAuthRequiredForWsdl:$scope.introObj.isAuthRequiredForWsdl};$scope.saveInProgress||($scope.saveInProgress=!0,BTActionsService.createBTAction(_actionIntro).then(function(res){$workflowService.actionInfo(res.data),$scope.actionid=res.data._id,createMPAction(_actionIntro,!0)},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.saveAndExit=!1,$scope.actionid=null,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_action"),"error")}))}function createMPAction(_action,create){_action.targetStream=_selectedStream.name,_action.contents=$scope.introObj.contents,_action.mappedOnly=$scope.introObj.mappedOnly,"string"==typeof $scope.introObj.keywords?_action.keywords=$scope.introObj.keywords.split(","):"object"==typeof $scope.introObj.keywords&&$scope.introObj.keywords.length>0?_action.keywords=$scope.introObj.keywords:_action.keywords=[],_action.namespace="private",_action.namespaceIds=[],_action._id=$scope.actionid,BTActionsService.createMPAction(_action).then(function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$workflowService.mpActionInfo(res.data),$rootScope.$emit("onedittask",$workflowService.actionInfo(),$scope.wfType),$scope.closeGeneralInfoModal(),$rootScope.$emit("insertOrUpdateTask","action",$workflowService.actionInfo(),!0)},function(res){$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$rootScope.saveAndExit=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("fail_action"),"error"),BTActionsService.deleteBTAction($scope.actionid),$scope.actionid=null})}function createKnowledgeTask(ktData){$scope.saveInProgress||($scope.saveInProgress=!0,ktData.streamId=$workflowService.selectedStream()._id,BTStreamsService.createKnowledgeTask($applicationService.userInfo().userId,ktData).then(function(response){$scope.saveInProgress=!1,$scope.closeModal(),NotificationService.notify(i18n.i18nString("kg_saved"),"success"),response.data.taskType="knowledgeTask",$workflowService.taskEditInfo(response.data),$workflowService.taskMode("edit"),$scope.updateStep(3,"",!0),$timeout(function(){$rootScope.$emit("updateEditTask",!0)})},function(res){$scope.saveInProgress=!1,409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("kg_duplicate")&&($scope.duplicateKTName=!0),NotificationService.notify(res.data.errors[0].msg,"error")}))}$scope.introObj={},$scope.saveInProgress=!1,$scope.isWorkProgress=!1,$scope.creating=i18n.i18nString("creating"),$scope.create=i18n.i18nString("account_create"),$scope.stream=$workflowService.selectedStream(),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png";var _selectedStream=($workflowService.currentLanguage(),null);_selectedStream=$workflowService.selectedStream(),$scope.info=i18n.i18nString("create_info"),$scope.action=i18n.i18nString("create_action"),$scope.alert=i18n.i18nString("create_alert"),$scope.infoName=i18n.i18nString("info_Name"),$scope.actionName=i18n.i18nString("action_Name"),$scope.alertName=i18n.i18nString("alert_Name"),$scope.infoRequired=i18n.i18nString("info_required"),$scope.actionRequired=i18n.i18nString("action_required"),$scope.alertRequired=i18n.i18nString("alert_required"),$scope.infoAllows=i18n.i18nString("info_allows"),$scope.actionAllows=i18n.i18nString("action_allows"),$scope.alertAllows=i18n.i18nString("alert_allows"),$scope.infoNObot=i18n.i18nString("info_Nobot"),$scope.actionNObot=i18n.i18nString("action_Nobot"),$scope.alertNObot=i18n.i18nString("alert_Nobot"),$scope.charRemaining=i18n.i18nString("Generalform_charlimit"),$scope.displayinfoName=i18n.i18nString("info_DisplayName"),$scope.displayactionName=i18n.i18nString("action_DisplayName"),$scope.displayalertName=i18n.i18nString("alert_DisplayName"),$scope.infoContext=i18n.i18nString("info_context"),$scope.actionContext=i18n.i18nString("action_context"),$scope.alertContext=i18n.i18nString("alert_context"),$scope.infoDesc=i18n.i18nString("info_Desc"),$scope.actionDesc=i18n.i18nString("action_Desc"),$scope.alertDesc=i18n.i18nString("alert_Desc"),$scope.infoLong=i18n.i18nString("info_Long"),$scope.actionLong=i18n.i18nString("action_Long"),$scope.alertLong=i18n.i18nString("alert_Long");var footerInfo={alert:{title:i18n.i18nString("alert_right")},action:{title:i18n.i18nString("action_right")},information:{title:i18n.i18nString("information_right")},flowTask:{title:i18n.i18nString("intent_right")},knowledge:{title:i18n.i18nString("kg_right")}};if($scope.closeModal=function(){$scope.closeGeneralInfoModal(),$("#taskCreateOverlayModal").show(),$(".taskTypeDiv ").removeClass("selected")},$scope.updateFooterHeader=function(){var wfType=$scope.isReport?"information":$scope.wfType;return $scope.footerInfoTitle=footerInfo[wfType].title,$scope.footerHeaderId="bt-task-creation",$scope.footerPanelId="bt-task-creation-panel","knowledge"===wfType?$scope.nameDescription=i18n.i18nString("name_kg"):$scope.nameDescription=i18n.i18nString("task_warning"),!0},$scope.updateStep=function(stepNo){$scope.$emit("updateStep",stepNo)},$scope.$watch("saveInProgress",function(newValue,oldValue,scope){}),$scope.getSentenceCase=function(value){return _selectedStream.defaultLanguage&&"en"!==_selectedStream.defaultLanguage?value:$filter("sentence_case")(value)},"alert"===$scope.wfType){$scope.alerttypes=$workflowService.seedData().alertTypes||[],$scope.alerttypes.length&&"Webservice"!==$scope.alerttypes[0].name&&$scope.alerttypes.reverse();for(var i=0;i<$scope.alerttypes.length;i++)if("email"===$scope.alerttypes[i].value){$scope.alerttypes.splice(i,1);break}}else"action"===$scope.wfType?($scope.alerttypes=[{name:"Web Service",value:"webservice"}],$scope.introObj.type=$scope.alerttypes[0]):"flowTask"===$scope.wfType&&($scope.alerttypes=[{name:"Flow Task",value:"flowtask"}],$scope.introObj.type="flowTask");$scope.subtypes=$workflowService.seedData().webserviceTypes,$scope.activeEntityFlow={},$scope.saveIntro=function(isValid,form){return isValid?(_selectedStream=$workflowService.selectedStream(),$scope.introObj.needsAuth="webservice"===$scope.introObj.type?!0:$scope.introObj.needsAuth,void("alert"===$scope.wfType?createBTAlert():"action"===$scope.wfType?createBTAction():"flowTask"===$scope.wfType&&createFlowTask())):void form_util.touch(form)},$scope.closeGeneralInfoModal=function(){$(".task-generalinfo-modal").modal("hide")},$scope.invalidWordCount=!1,$scope.taskgen={},$scope.checkTaskWordCount=function(){return $scope.introObj.name?($scope.introObj.name.split(" ").length<2||$scope.introObj.name.split(" ").length>5?($scope.invalidWordCount=!0,$scope.taskgen.taskGeneralInfoForm.name.$valid=!1):($scope.invalidWordCount=!1,$scope.taskgen.taskGeneralInfoForm.name.$valid=$scope.taskgen.taskGeneralInfoForm.name.$valid||!0),void($scope.introObj.shortdescription||($scope.introObj.shortdescription=$scope.introObj.name))):void($scope.invalidWordCount=!1)},$scope.saveKnowledgeTask=function(isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return form_util.touch(form),void($scope.isFromModalOpen=!1);var btPostData={};btPostData.name=$scope.knowledgeData.name,btPostData.description=$scope.knowledgeData.description,createKnowledgeTask(btPostData)},$scope.data=[{nodeId:"1",label:_selectedStream.name,"class":"bgblack",level:"l0",parent:[],synonyms:[],nodes:[],metadata:$scope.data}],$scope.kt={},$scope.knowledgeData={},$scope.isFormValid=function(isSaveKnoledgeTask){return isSaveKnoledgeTask?$scope.kt.streamktform&&$scope.kt.streamktform.name.$valid&&$scope.kt.streamktform.description.$valid:void 0},$scope.botNameMatched=!1,$scope.validateTaskName=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression();return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,{test:function(value){var _selectedLanguage=$workflowService.currentLanguage();return _selectedLanguage&&"en"===_selectedLanguage?regexp.test(value):regexp2.test(value)}}}()}])}(angular),function(ng){var _taskEditForm=ng.module("bt-forms");_taskEditForm.directive("btTaskEditForm",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-task-edit-form/bt-task-edit-form.html",controller:"btTaskEditFormCtrl"}}),_taskEditForm.controller("btTaskEditFormCtrl",["$scope","$rootScope","$workflowService","$timeout","accessControlService",function($scope,$rootScope,$workflowService,$timeout,accessControlService){$scope.isEditTask=!0,$scope.taskEditInfo=$workflowService.taskEditInfo(),$scope.$on("switchDialogTask",function(event,taskState){$scope.checkFlag=!1,$scope.switchingDialogTask=!0;var accessRight=accessControlService.getAccessRight("BOTBUILDER_TASKS");"published"!==taskState&&"suspended"!==taskState&&"VIEW"!==accessRight?$scope.displayMode="edit":$scope.displayMode="view",$timeout(function(){$scope.checkFlag=!0,$scope.switchingDialogTask=!1})}),$rootScope.$on("updateEditTask",function(event,flag){flag&&($scope.checkFlag=!1,$timeout(function(){$scope.taskEditInfo=$workflowService.taskEditInfo(),$scope.conversationBuilder=!1,$scope.taskEditInfo.sceneRefId&&($scope.conversationBuilder=!0),$scope.taskType=$scope.taskEditInfo.taskType,$scope.checkFlag=!0,$scope.wfType=$scope.taskType;var accessRight=accessControlService.getAccessRight("BOTBUILDER_TASKS");"VIEW"===accessRight?$scope.displayMode="view":$scope.displayMode=$workflowService.taskMode()})),$scope.isEditTask=flag}),$rootScope.$on("createFlowOptions",function(event){$scope.taskType="flows",$scope.wfType=$scope.taskType})}])}(angular),function(ng){var _module=ng.module("bt-forms");_module.directive("btTestForm",[function(){return{restrict:"E",scope:{api:"=",status:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-test-form/bt-test-form.html",controller:["$scope","$q","BTAlertsService","BTActionsService","$filter","$workflowService","BTIdpService","BTStreamsService","env_conf","$timeout","$rootScope","NotificationService","form_util","$applicationService","$element","i18n",function($scope,$q,BTAlertsService,BTActionsService,$filter,$workflowService,BTIdpService,BTStreamsService,env_conf,$timeout,$rootScope,NotificationService,form_util,$applicationService,$element,i18n){function initTaskConfig(config){return _.isObject(config.definition)&&Object.keys(config.definition).length>0?arrangeTaskConfig(config.definition):config._id&&config.type?getTask(config).then(function(task){return arrangeTaskConfig(task)}):($scope.status.context=config,$scope.status.testResult=i18n.i18nString("id_missing"),$scope.status.error=new Error(CONSTANTS.UNSUPPORTED_CONFIG_ERROR),$scope.api.onError(),void 0)}function initIdpConfig(config){if(_.isObject(config.definition)&&Object.keys(config.definition).length>0)return arrangeIdpConfig(config.definition);if(config._id&&config.type)return getIdp(config).then(function(idp){return arrangeIdpConfig(idp)});$scope.status.context=config,$scope.status.testResult=i18n.i18nString("id_missing"),$scope.status.error=new Error(CONSTANTS.UNSUPPORTED_CONFIG_ERROR);var errorObject={errCode:40,errMessage:i18n.i18nString("auth_mandatory")};return $scope.api.onError(errorObject),$q.reject({status:$scope.status.error})}function getTask(config){var taskP;return config.type===CONSTANTS.TASKS.ALERT?taskP=BTAlertsService.getBTAlert(config._id):config.type===CONSTANTS.TASKS.ACTION&&(taskP=BTActionsService.getBTAction(config._id)),taskP.then(function(res){return $q.resolve(res.data)},function(err){return $scope.status.context=config,$scope.status.testResult=i18n.i18nString("taskdef_failed"),$scope.status.error=err,$scope.api.onError(),$q.reject(err)})}function getIdp(config){var idpP=BTIdpService.getIdp(config._id,$workflowService.selectedStream()._id);return idpP.then(function(res){return $q.resolve(res.data)},function(err){return $scope.status.context=config,$scope.status.testResult=i18n.i18nString("idpdef_failed"),$scope.status.error=err,$scope.api.onError(),$q.reject(err)})}function arrangeTaskConfig(config){return $scope.task=config,$q.resolve(config)}function arrangeIdpConfig(config){return config&&"object"==typeof config&&Object.keys(config).length>0?($scope.auth=config||{},$scope.auth.authCheckUrl=config.authCheckUrl,$scope.auth.sso_type=config.sso_type,$scope.auth.hasTenancy=config.hasTenancy,$scope.auth.methodDefined=angular.copy(config.method),$scope.auth.method=config.method||"GET",$scope.custom="custom"==config.sso_type,$scope.custom&&($scope.auth.authCheckUrl=config.appConfig&&config.appConfig.tokenURL||"",$scope.auth.method=config.method,$scope.auth.contentType=$filter("filter")($scope.datatypes,{value:config.contentType}),$scope.auth.contentType=$scope.auth.contentType&&$scope.auth.contentType[0],$scope.auth.contentTypeDefined=angular.copy($scope.auth.contentType)),$scope.auth.connectorEnabled=config.connectorEnabled,$scope.auth.formfields&&$scope.auth.formfields.length?$scope.auth.dynFields=$scope.auth.formfields.map(function(field){return field["default"]&&(field.value=field["default"]),field}):$scope.auth.dynFields=[],$q.resolve($scope.auth)):($scope.status.context=config,$scope.status.testResult="config error",$scope.status.error=new Error(CONSTANTS.CONFIG_ERROR),$scope.api.onError(),$q.reject(new Error(CONSTANTS.CONFIG_ERROR)))}function handleAuthTestFlow(){var ssoType=$scope.auth.sso_type,idpName=$scope.config.isTryOutUserConnection?$scope.auth.idpName||$scope.auth.name:$scope.auth.name;if(makeItClean(),$scope.testcontext=$scope.testcontext||{},$scope.status.testResult="validating","basic"===ssoType||"api_key"===ssoType||"none"===ssoType||"custom"===ssoType)return $("[data-parent='#requestAccordion'][href='#authPannel']")&&$("[data-parent='#requestAccordion'][href='#authPannel']").length?$("[data-parent='#requestAccordion'][href='#authPannel']").hasClass("collapsed")?$("[data-parent='#requestAccordion'][href='#taskExecution']").hasClass("collapsed")||showModalSlider("#authorizationProfileSlider"):showModalSlider("auth-form #authorizationProfileSlider"):showModalSlider($scope.isFromtestReq?".serviceNodeTestChain #authorizationProfileSlider":"#authorizationProfileSlider"),$scope.api.onAuthTestModalOpen(),void($scope.testResponse=!1);$scope.testOnProgress=!0;var context={streamId:$workflowService.selectedStream()._id,idp:idpName,tenant:$scope.auth.tenant||"",label:$filter("camelcasebreakword")(idpName)+" Account",rurl:env_conf.redirects.success,isTryOutUserConnection:$scope.config.isTryOutUserConnection?"true":"false",isDeveloper:"true"};authorize(context,{}).then(function(res){var url=res.data.url;"oauth2_client_credential"===$scope.auth.sso_type?res.data&&"success"===res.data.status?($scope.api.afterTest(!0),$scope.status.testResult="success"):($scope.status.context=context,$scope.status.testResult="failed",$scope.testOnProgress=!1,$scope.api.afterTest(!1),$scope.status.error=err,$scope.api.onError(),NotificationService.notify(i18n.i18nString("valid_authorization"),"error")):launchAuthWindow(url)},function(err){$scope.status.context=context,$scope.status.testResult=i18n.i18nString("test_failed"),$scope.status.error=err,$scope.api.onError(),NotificationService.notify(i18n.i18nString("auth_test_failed"),"error")})}function closeAuthProfileTest(){$timeout(function(){$("[data-parent='#requestAccordion'][href='#authPannel']")&&$("[data-parent='#requestAccordion'][href='#authPannel']").length?$("[data-parent='#requestAccordion'][href='#authPannel']").hasClass("collapsed")?$("[data-parent='#requestAccordion'][href='#taskExecution']").hasClass("collapsed")||$scope.modalSlider.close("#authorizationProfileSlider"):$scope.modalSlider.close("auth-form #authorizationProfileSlider"):$scope.isFromtestReq?$scope.modalSlider.close(".serviceNodeTestChain #authorizationProfileSlider"):$scope.modalSlider.close("bot-authorization #authorizationProfileSlider")}),$scope.callback&&$scope.callback.onModalShow&&$scope.callback.onModalShow(),$scope.api&&$scope.api.isConversationTesting&&$scope.modalSlider.close("#authorizationProfileSlider")}function launchAuthWindow(url){var childWindow,strWindowFeatures,title;title="idp"===$scope.type?i18n.i18nString("auth_Test"):i18n.i18nString("requestchain"),strWindowFeatures="_blank,rel=opener,menubar=no,resizable=no,location=no,toolbar=no,height=500,width=700,resizable=yes,scrollbars=yes,status=yes,left=350,top=80",childWindow=window.open(url,title,strWindowFeatures);var selfClose=!1,pollTimer=setInterval(function(){!selfClose&&childWindow&&childWindow.closed?($timeout(function(){$scope.status.testResult="aborted",$scope.testOnProgress=!1,$scope.api.onError()}),clearInterval(pollTimer)):selfClose&&($scope.api.onError(),clearInterval(pollTimer))},1e3);window._succCallback=function(data){$timeout(function(){selfClose=!0,handleRedirectResponse(data,childWindow)})},window._failCallback=function(){$timeout(function(){selfClose=!0,$scope.status.testResult="failed",$scope.testOnProgress=!1,childWindow.close(),$scope.api.onError(),NotificationService.notify(i18n.i18nString("valid_authorization"),"error")})},window._closeCallback=function(){$timeout(function(){selfClose||($scope.status.testResult="aborted",$scope.testOnProgress=!1)})},childWindow?childWindow.focus():($scope.status.testResult="",$scope.testOnProgress=!1,NotificationService.notify(i18n.i18nString("browser_popup"),"warning",5e3),childWindow&&childWindow.close())}function authorize(context,payload){return context.isDeveloper="true",BTStreamsService.authorizeIdp(context,payload)}function handleRedirectResponse(authResponse,childWindow){var wfAccountApi="";wfAccountApi=$scope.config.isFromRingCentral?BTStreamsService.getRingCentralAccount:BTStreamsService.getAccounts,wfAccountApi($workflowService.selectedStream()._id,"true",$scope.config.isTryOutUserConnection?"true":"false",$scope.auth.name||$scope.auth.idpName).then(function(res){$scope.api.onNewAccounts(res.data);var account=res.data[0];$scope.streamAccountId=account&&account.streamAccountId,$scope.status.streamAccountId=$scope.streamAccountId,$rootScope.$broadcast("streamAccountId",$scope.streamAccountId),childWindow.close(),$scope.api.afterTest(!0,account),$scope.status.testResult="success"},function(err){$scope.api.onNewAccounts([]),$scope.testOnProgress=!1,$scope.status.context={},$scope.status.testResult=i18n.i18nString("test_failed"),$scope.status.error=err,$scope.api.onError(),childWindow.close()})}function makeItClean(){var form=$scope.formHolder.authForm;for(var key in form)form.hasOwnProperty(key)&&"object"==typeof form[key]&&0!==key.indexOf("$")&&0!==key.indexOf("$$")&&(form[key].$dirty=!1)}function clone(fields){try{return JSON.parse(JSON.stringify(fields))}catch(ex){return fields}}function replaceTenant(fields){var tenant=$scope.status.auth&&$scope.status.tenant;return fields=angular.copy(fields||[]),tenant?fields=fields.map(function(field){return field.dynamicDropDownInfo&&(field.dynamicDropDownInfo.endPoint.path=field.dynamicDropDownInfo.endPoint.path&&field.dynamicDropDownInfo.endPoint.path.replace("{tenant}",tenant),field.dynamicDropDownInfo.endPoint.host=field.dynamicDropDownInfo.endPoint.host&&field.dynamicDropDownInfo.endPoint.host.replace("{tenant}",tenant)),field}):fields}function makeTestApiRequest(fields){var chains,wfType="l"==$scope.task._id[0]?"alert":"action",defaults={},now=new Date,lastRun=new Date,tenant=$scope.status.auth&&$scope.status.auth.tenant||"";fields=fields||{},lastRun.setDate(lastRun.getDate()-3),defaults.tenant=tenant,defaults.now=now.toISOString(),defaults.lastRun=lastRun.toISOString(),defaults.StartDateAndTimeOfTheCurrentDay=defaults.now,defaults.EndDateAndTimeOfTheCurrentDay=defaults.now,defaults.StartDateAndTimeOfTheCurrentWeek=defaults.now,defaults.EndDateAndTimeOfTheCurrentWeek=defaults.now,chains=fillUpDefaultsPlaceholders(angular.copy($scope.task.requestChain),defaults),$scope.reqchaintestresponse=null,$scope.requestChainTest=!0;var requestObj={idp:$scope.task.idp,fields:fields||{},tenant:tenant,entity:{type:wfType,id:$scope.task._id},sso_type:$scope.task.sso_type,userId:$applicationService.userInfo().userId,streamAccountId:$scope.status.streamAccountId,requestChain:chains};"alert"===wfType?requestObj.alertId=$scope.task._id:"action"===wfType&&(requestObj.actionId=$scope.task._id),$scope.api.makeRequest(requestObj)}function fillUpDefaultsPlaceholders(_reqObjsToSend,context){context=angular.copy(context),Object.keys(context).map(function(key){_.isObject(context[key])&&(void 0===context[key].value?delete context[key]:context[key]=context[key].value)});for(var i=0;i<_reqObjsToSend.length;i++)_reqObjsToSend[i]&&_reqObjsToSend[i].linkDefinition&&_reqObjsToSend[i].linkDefinition.endPoint&&Object.keys(context).map(function(key){var searchKey="{"+key+"}";_reqObjsToSend[i].linkDefinition.endPoint.host=replaceIt(_reqObjsToSend[i].linkDefinition.endPoint.host,searchKey,context[key]),_reqObjsToSend[i].linkDefinition.endPoint.path=replaceIt(_reqObjsToSend[i].linkDefinition.endPoint.path,searchKey,context[key])});return _reqObjsToSend}function replaceIt(string,placeholder,value){return string=string||"",string=string.replace(placeholder,value),-1===string.indexOf(placeholder)?string:void(string=replaceIt(placeholder,string))}function assignSampleResposne(data){var alertsPath,sample={},chainLength=$scope.task.requestChain.length;"l"==$scope.task._id[0]&&chainLength>0&&$scope.task.requestChain[chainLength-1].alertsPath?(alertsPath=$scope.task.requestChain[chainLength-1].alertsPath,sample[alertsPath]=data):sample=data,$scope.status.uxjson=_.clone(sample)}$scope.datatypes=$workflowService.seedData().contentTypes,$scope.customAuth=!1,$scope.dynFieldsBridge={},$scope.modalSlider={},$scope.rightClass="right500",$scope.testing=i18n.i18nString("testing_caps"),$scope.test=i18n.i18nString("test"),$scope.success=i18n.i18nString("request_chain_success"),$scope.failure=i18n.i18nString("request_chain_failure"),$scope.authSuccess=i18n.i18nString("auth_success"),$scope.authFailure=i18n.i18nString("auth_failed"),$scope.api.modalSlider=$scope.modalSlider||{},$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.tmpltPrePath=$scope.$root.tmpltPrePath;var CONSTANTS={UNSUPPORTED_CONFIG_ERROR:i18n.i18nString("unsupported_entity"),CONFIG_ERROR:i18n.i18nString("proper_entity"),SUPPORTED_TESTS:{TASK:"task",IDP:"idp"},TASKS:{ALERT:"alert",ACTION:"action"}};if($scope.options={mode:"code",ace:window.ace},$scope.task={},$scope.auth={},$scope.status=$scope.status||{},$scope.formHolder={},$scope.initConfig={_id:"",type:"",testFor:"",definition:{}},$scope.config=angular.copy($scope.initConfig),$scope.api=_.isObject($scope.api)?$scope.api:{afterInit:angular.noop,afterTest:angular.noop,afterClose:angular.noop,onError:angular.noop,onCancel:angular.noop,onNewAccounts:angular.noop,onAuthTestModalOpen:angular.noop,onAuthTestModalClose:angular.noop},$timeout(function(){["afterInit","afterTest","afterClose","onError","onCancel","onNewAccounts","onAuthTestModalOpen","onAuthTestModalClose"].map(function(operation){$scope.api[operation]=$scope.api[operation]?$scope.api[operation]:angular.noop})}),$scope.api.serviceNodeTestInfo=function(data){$scope.isFromtestReq=data.isFromtestReq||!1},$scope.api.init=function(config,callback,serviceAuth){$scope.idptestresponse=null,$scope.reqchaintestresponse=null,config||($scope.status.context=config,$scope.status.testResult="empty configuration",$scope.api.onError()),$scope.config=config||$scope.config,$scope.callbackModalClose=callback,$scope.config.testFor===CONSTANTS.SUPPORTED_TESTS.TASK?initTaskConfig(config).then(function(){$scope.api.afterInit()}):$scope.config.testFor===CONSTANTS.SUPPORTED_TESTS.IDP?initIdpConfig(config).then(function(){$scope.api.afterInit(serviceAuth)}):($scope.status.context=config,$scope.status.testResult="invalid configuration",$scope.status.error=new Error(CONSTANTS.UNSUPPORTED_CONFIG_ERROR),$scope.api.onError())},$scope.api.test=function(serviceAuth){$scope.config.testFor===CONSTANTS.SUPPORTED_TESTS.TASK?$scope.triggerTestTask():$scope.config.testFor===CONSTANTS.SUPPORTED_TESTS.IDP?$scope.triggerTestIdp(serviceAuth):($scope.status.context=$scope.config,
$scope.status.testResult="tryping test unsupported type",$scope.status.error=new Error(CONSTANTS.UNSUPPORTED_CONFIG_ERROR),$scope.api.onError())},$scope.api.close=function(){},$scope.api.closeModal=function(){$(".rqTestModal").modal("hide"),$scope.testOnProgress=!1,$scope.requestChainTest=!1},$scope.api.makeRequest){var func=$scope.api.makeRequest;$scope.api.makeRequest=function(){var params=arguments;$timeout(function(){func.apply($scope.api,params)})}}else $scope.api.makeRequest=function(requestObj){var wfType="l"==$scope.task._id[0]?"alert":"action";BTIdpService.testRequestChain(requestObj).then(function(res){var status=res.data&&res.data.headers&&res.data.headers.status||400;$scope.reqchaintestresponse=angular.copy(res.data),"action"===wfType&&$scope.reqchaintestresponse&&$scope.reqchaintestresponse.response&&_.isArray($scope.reqchaintestresponse.response.response)&&($scope.reqchaintestresponse.response.response=$scope.reqchaintestresponse.response.response[0]),$scope.status.testFinalResponse=$scope.reqchaintestresponse.response,assignSampleResposne($scope.reqchaintestresponse.response),$scope.reqchaintestresponse.response=$scope.reqchaintestresponse.response,$scope.requestChainTest=!1,$scope.reqchaintestresponse.status=status,$scope.api.afterTest(300>+status),$scope.api.onResponse(300>+status,$scope.reqchaintestresponse.response),$timeout(function(){$rootScope.$emit("updateModalSize")},200)},function(err){$scope.reqchaintestresponse={},$scope.reqchaintestresponse.response=err.data,$scope.status.testFinalResponse=$scope.reqchaintestresponse.response,$scope.requestChainTest=!1,$scope.reqchaintestresponse.status=400,$scope.api.afterTest(!1)})};$scope.isHidden=function(){var hidden=!0;if($scope.config.definition&&$scope.config.definition.alertFieldsDefinition){for(var i=0;i<$scope.config.definition.alertFieldsDefinition.length;i++)if(!$scope.config.definition.alertFieldsDefinition[i].visibility){hidden=!1;break}return hidden}},$scope.triggerTestIdp=function(serviceAuth){makeItClean(),("oauth"===$scope.auth.sso_type||"oauth2"===$scope.auth.sso_type)&&$scope.auth.hasTenancy?(showModalSlider(serviceAuth?".serviceNodeTestChain #authorizationProfileSlider":"bot-authorization #authorizationProfileSlider"),$scope.api.onAuthTestModalOpen()):handleAuthTestFlow()},$scope.$watch("auth",function(nv,ov){}),$scope.triggerTestTask=function(){angular.copy($scope.config);$scope.openFieldsForm()},$scope.captureCredentials=function(isValid,form){var components,rcEndpoint,_dynPayload,reqobj={},uriParser=window.URI;return _dynPayload=$scope.dynFieldsBridge.save?$scope.dynFieldsBridge.save():[],isValid&&_dynPayload?($scope.auth.hasTenancy&&$scope.auth.tenant&&($scope.auth.authCheckUrl=$scope.auth.authCheckUrl.replace("{tenant}",$scope.auth.tenant)),$scope.testcontext=angular.copy($scope.auth),$scope.testOnProgress=!1,reqobj.name=$scope.auth.name||"Auth Test",reqobj.streamId=$workflowService.selectedStream()._id,reqobj.streamName=$workflowService.selectedStream().name,reqobj.streamAccountId="",components=uriParser.parse($scope.auth.authCheckUrl),rcEndpoint={host:components.host,port:components.port?components.port+"":"",path:components.path,protocol:components.scheme,contentType:$scope.auth.contentType.value,method:$scope.auth.method,connectorEnabled:$scope.auth.connectorEnabled},"basic"===$scope.auth.sso_type&&(reqobj.authCheckUrl=$scope.auth.authCheckUrl),rcEndpoint.query&&(rcEndpoint.path+="?"+rcEndpoint.query),rcEndpoint.fragment&&(rcEndpoint.path+="#"+rcEndpoint.fragment),reqobj.authFormFields=_dynPayload,$scope.auth.apiKey&&(reqobj.apiKey=$scope.auth.apiKey),reqobj.endPoint=rcEndpoint,reqobj.method=$scope.auth.method,$scope.triggerAuthTest({requestObj:reqobj}),void closeAuthProfileTest()):void form_util.touch(form)},$scope.cancelAuthForm=function(){this.formHolder.authForm&&form_util.makeItClean(this.formHolder.authForm),$scope.auth.sso_type="",$timeout(function(){closeAuthProfileTest(),$scope.status.testResult="",$scope.api.afterClose&&$scope.api.afterClose()}),$scope.api.onAuthTestModalClose&&!$scope.api.isConversationTesting&&$scope.api.onAuthTestModalClose(),$scope.modalSlider.close("#authorizationProfileSlider")},$scope.captureTenant=function(isValid,form){return isValid?($scope.status.auth=angular.copy($scope.auth),closeAuthProfileTest(),$scope.api.onAuthTestModalClose(),void $timeout(function(){handleAuthTestFlow()})):void form_util.touch(form)},$scope.triggerAuthTest=function(authFormObject){$scope.testOnProgress=!0,$scope.idptestresponse=null;var ssoType=$scope.auth.sso_type,idpName=$scope.auth.name,context={streamId:$workflowService.selectedStream()._id,idp:idpName,tenant:$scope.auth.tenant||"",label:$filter("camelcasebreakword")(idpName)+" Account",rurl:env_conf.redirects.success,isTryOutUserConnection:$scope.config.isTryOutUserConnection?"true":"false",isDeveloper:"true"};$scope.status.auth=angular.copy($scope.auth);var payload={tokens:{}};if("none"!==ssoType)"basic"===ssoType||"custom"===ssoType?(payload.tokens={},payload.tokens=angular.copy(authFormObject.requestObj.authFormFields),"basic"===$scope.auth.sso_type&&(payload.authCheckUrl=authFormObject.requestObj.authCheckUrl)):"api_key"===ssoType&&(payload.tokens={apiKey:authFormObject.requestObj.apiKey}),authorize(context,payload).then(function(res){var status=res&&res.status||500;$scope.testOnProgress=!1,$scope.status.testResult=300>+status?"success":"failed",$scope.idptestresponse={response:JSON.stringify({message:300>+status?"success":"failed"}),headers:{status:status},status:status},$scope.streamAccountId=res.data.streamAccountId,$scope.status.streamAccountId=$scope.streamAccountId,$scope.api.onNewAccounts([res.data]),$scope.api.afterTest(300>+status),$scope.api.onAuthTestModalClose()},function(err){$scope.testOnProgress=!1,$scope.status.testResult="failed",$scope.idptestresponse={response:JSON.stringify(err.data),headers:{status:400},status:400},NotificationService.notify(i18n.i18nString("auth_test_Failed",{name:$scope.auth.name}),"error")});else{var requestObj={sso_type:ssoType,idp:idpName,userId:$applicationService.userInfo().userId,streamAccountId:"",requestChain:[{linkType:"apiObject",linkDefinition:authFormObject.requestObj}]};$scope.streamAccountId=requestObj.streamAccountId,$scope.status.streamAccountId=requestObj.streamAccountId}},$scope.deleteAccount=function(streamAccountId){streamAccountId&&BTIdpService.deleteStreamUserAccount(streamAccountId).then(function(res){},function(err){})},$scope.deleteAccount=angular.noop,function(){$scope.connectors=$workflowService.botConnectors()}();var showModalSlider=function(sliderForm){"showAlertFieldSlider"===sliderForm||"showProcForm"===sliderForm||"showReqForm"===sliderForm?($scope[sliderForm]=!0,setTimeout(function(){$scope.modalSlider.open("#commonId")},500)):setTimeout(function(){$scope.modalSlider.open(sliderForm)},500)};$scope.openFieldsForm=function(){var fields,wfType="l"==$scope.task._id[0]?"alert":"action";"alert"==wfType?fields=angular.copy($scope.task.alertFieldsDefinition):"action"==wfType&&(fields=angular.copy($scope.task.payloadField.concat($scope.task.queryField)),fields=$filter("orderBy")(fields,"fieldIndex")),fields&&fields.length>0?(fields=replaceTenant(fields),showModalSlider("#alertRequestTestSlider"),setTimeout(function(){$("request-object-form .modalBody.alertRequestTestSliderScroll.ps-active-y").scrollTop(0)},1e3),$scope.totalFields={sso_type:$scope.task.sso_type,userId:$applicationService.userInfo().userId,fields:clone(fields),streamAccountId:$scope.status.streamAccountId}):(replaceTenant(),makeTestApiRequest())},$scope.testClick=function(){$scope.dynFieldsBridge.submit()},$scope.fieldFormSave=function(data){makeTestApiRequest(data)};var hideModalSlider=function(sliderForm){setTimeout(function(){$scope.modalSlider.close(sliderForm)},500)};$scope.fieldFormCancel=function(){hideModalSlider("#alertRequestTestSlider"),$scope.api.close(),$scope.api.afterClose(),$scope.api.onCancel(),$scope.testOnProgress=!1,$scope.requestChainTest=!1}}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btTrainNlpanalysisEdit",function(){return{restrict:"EAQ",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-train-nlpAnalysis-edit/bt-train-nlpAnalysis-edit.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","$filter","i18n",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,$filter,i18n){function mapWords(identifiedIntents,type){angular.forEach($scope.nlpData.nlProcessing.wordAnalysis,function(wordArray,sentIndex){_.map(identifiedIntents,function(intent,index){$scope.dependency.scoreBreakdown=[],sentIndex===intent.sentence&&(intent.dependencySenetence="",_.map(wordArray,function(word){"definite"===intent.matchType&&(intent.dependencySenetence=intent.dependencySenetence+word.original+" "),intent.scoreBreakdown[word.id]&&("FM"===type&&$scope.dependency.scoreBreakdown.push({score:intent.scoreBreakdown[word.id].score,word:word.original,matchedHead:intent.scoreBreakdown[word.id].matchedHead}),"RAR"===type&&$scope.dependency.rarBreakDown.push({score:intent.scoreBreakdown[word.id].score,word:word.original,matchedHead:intent.scoreBreakdown[word.id].matchedHead,intent:intent.activity}))}),intent.dependency=$scope.dependency.scoreBreakdown)})}),console.log(identifiedIntents),console.log($scope.dependency.rarBreakDown)}function mapRelativeWords(){$scope.dependency.wordAnalysis=[],angular.forEach($scope.nlpData.nlProcessing.wordAnalysis,function(wordArray,index){$scope.dependency.wordAnalysis[index]=[],_.map(wordArray,function(word){var _res=_.find(wordArray,{id:word.head});_res?$scope.dependency.wordAnalysis[index].push({original:word.original,upos:word.upos,deprel:word.deprel,head:_res.original}):$scope.dependency.wordAnalysis[index].push({original:word.original,upos:word.upos,deprel:word.deprel,head:""})})}),console.log($scope.dependency.wordAnalysis)}function setOffset(){var height,result,_accordionHeight;if($("div.process").hasClass("active")){var _initial=0,_defaultOffset=250;_accordionHeight=$(".accTable").outerHeight(),$scope.offsetValue=_initial-(parseInt(_defaultOffset)+parseInt(_accordionHeight)),height=angular.element(".scrollFm").height(),result=height-_accordionHeight,angular.element(".scrollFm").height(result),$scope.$apply()}else $scope.offsetValue=-250,_accordionHeight=$(".accTable").outerHeight(),height=angular.element(".scrollFm").height(),result=height+_accordionHeight,angular.element(".scrollFm").height(result),$scope.$apply();setTimeout(function(){$(".accTable").animate({scrollTop:0},"slow")},0)}function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}function mapBotIcon(qualifiedBots){angular.forEach(qualifiedBots,function(bot){botIconResults[bot.streamId]=bot.botIconUrl})}function init(){if($scope.dataAvailable=!1,$scope.titleMessage="","MathedTraits"==$scope.panel.type)$scope.allTasks=[],$scope.nlpData.traits&&$scope.nlpData.traits.identified&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.traits.identified),$scope.titleMessage=inWords($scope.nlpData.traits.identified.length)+($scope.nlpData.traits.identified.length>1?" traits ":" trait ")+"matched");else if("Traits"==$scope.panel.type)$scope.allTasks=[],$scope.nlpData.traits&&$scope.nlpData.traits.definitive&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.traits.definitive),$scope.titleMessage=inWords($scope.nlpData.traits.definitive.length)+i18n.i18nString("definitive_Found"));else if("FM"==$scope.panel.type)$scope.allTasks=[],$scope.nlpData.fm&&$scope.nlpData.fm.possible&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.fm.possible),$scope.titleMessage+=inWords($scope.nlpData.fm.possible.length)+i18n.i18nString("possible_Found"),$scope.titleMessage+=$scope.nlpData.fm.definitive?" and ":"","dependency"===$scope.nlpData.scoringModel&&mapWords($scope.nlpData.fm.possible,$scope.panel.type)),$scope.nlpData.fm&&$scope.nlpData.fm.definitive&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.fm.definitive),$scope.titleMessage=inWords($scope.nlpData.fm.definitive.length)+i18n.i18nString("definitive_Found"),"dependency"===$scope.nlpData.scoringModel&&mapWords($scope.nlpData.fm.definitive,$scope.panel.type)),$scope.nlpData.fm&&$scope.nlpData.fm.eliminated&&($scope.dataAvailable=!0),"dependency"===$scope.nlpData.scoringModel&&mapRelativeWords(),setTimeout(function(){$(".eachChildAcc").on("click",function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(this).find(".inner").toggleClass("open").slideToggle(),$(this).find(".innerHeader").toggleClass("open"),$(this).toggleClass("fa-caret-down fa-caret-right")}),$(".accordionDiv .header").on("click",function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(this).toggleClass("active"),$(this).siblings().toggleClass("open").stop().slideToggle()}),$(".accordionDiv .process").on("click",function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(this).toggleClass("active"),$(this).siblings().toggleClass("open").stop().slideToggle(),$(this).find("i").toggleClass("fa-caret-down fa-caret-right"),$(".scrollFm").animate({scrollTop:0},"slow"),setOffset()})},500);else if("FAQ"===$scope.panel.type)$scope.allTasks=[],$scope.nlpData.faq&&$scope.nlpData.faq.possible&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.faq.possible),$scope.titleMessage+=inWords($scope.nlpData.faq.possible.length)+i18n.i18nString("possible_Found"),$scope.titleMessage+=$scope.nlpData.faq.definitive?" and ":""),$scope.nlpData.faq&&$scope.nlpData.faq.definitive&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.faq.definitive),$scope.titleMessage=inWords($scope.nlpData.faq.definitive.length)+i18n.i18nString("definitive_Found")),$scope.nlpData.faq&&$scope.nlpData.faq.eliminated&&($scope.dataAvailable=!0),setTimeout(function(){$(".accordianHead").on("click",function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(this).siblings().toggleClass("open").stop().slideToggle(),$(this).toggleClass("active"),$(this).find("i").toggleClass("fa-chevron-right fa-chevron-down")})},500);else if("ML"===$scope.panel.type)$scope.allTasks=[],$scope.nlpData.ml&&$scope.nlpData.ml.definitive&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.ml.definitive),$scope.titleMessage=inWords($scope.nlpData.ml.definitive.length)+i18n.i18nString("definitive_Found"),$scope.titleMessage+=$scope.nlpData.ml.possible?" and ":""),$scope.nlpData.ml&&$scope.nlpData.ml.possible&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.ml.possible),$scope.titleMessage+=inWords($scope.nlpData.ml.possible.length)+i18n.i18nString("possible_Found")),$scope.nlpData.ml&&$scope.nlpData.ml.eliminated&&($scope.dataAvailable=!0);else if("RAR"===$scope.panel.type){if($scope.allTasks=[],$scope.allTasksDefinitive=[],$scope.dependency.rarBreakDown=[],$scope.nlpData.ml&&$scope.nlpData.ml.definitive&&($scope.dataAvailableDefinitive=!0,$scope.allTasksDefinitive=$scope.allTasksDefinitive.concat($scope.nlpData.ml.definitive)),$scope.nlpData.fm&&$scope.nlpData.fm.definitive&&($scope.dataAvailableDefinitive=!0,$scope.allTasksDefinitive=$scope.allTasksDefinitive.concat($scope.nlpData.fm.definitive)),$scope.nlpData.faq&&$scope.nlpData.faq.definitive&&($scope.dataAvailableDefinitive=!0,$scope.allTasksDefinitive=$scope.allTasksDefinitive.concat($scope.nlpData.faq.definitive)),$scope.nlpData.ml&&$scope.nlpData.ml.possible&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.ml.possible)),$scope.nlpData.fm&&$scope.nlpData.fm.possible&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.fm.possible),"dependency"===$scope.nlpData.scoringModel&&mapWords($scope.nlpData.fm.possible,$scope.panel.type)),$scope.nlpData.fm&&$scope.nlpData.fm.definitive&&"dependency"===$scope.nlpData.scoringModel&&mapWords($scope.nlpData.fm.definitive,$scope.panel.type),$scope.nlpData.faq&&$scope.nlpData.faq.possible&&($scope.dataAvailable=!0,$scope.allTasks=$scope.allTasks.concat($scope.nlpData.faq.possible)),$scope.nlpData&&$scope.nlpData.smallTalk){$scope.dataAvailableSmallTalk=!0;var build_tree=function(startIndex,treeArray){var depth=treeArray.length-1,leaf=[{title:treeArray[startIndex]}];return depth>startIndex&&(leaf[0].tree=build_tree(startIndex+1,treeArray)),leaf[0].tree&&leaf[0].tree[0]?leaf[0].tree[0].title=decodePattern(leaf[0].tree[0].title):leaf[0].tree=decodePattern(leaf[0].tree),leaf[0].title=decodePattern(leaf[0].title),leaf},result=build_tree(0,$scope.nlpData.smallTalk[0].graph);$scope.tree=result}var common=0;if($scope.nlpData.ml&&$scope.nlpData.ml.possible&&$scope.nlpData.fm&&$scope.nlpData.fm.possible)for(var i=0;i<$scope.nlpData.fm.possible.length;i++)for(var j=0;j<$scope.nlpData.ml.possible.length;j++)$scope.nlpData.fm.possible[i].task==$scope.nlpData.ml.possible[j].task&&common++;if("universalbot"!==$scope.stream.type)$scope.nlpData&&$scope.nlpData.finalResolver&&$scope.nlpData.finalResolver.ranking&&$scope.nlpData.finalResolver.ranking[0]&&$scope.nlpData.finalResolver.ranking[0].matchedPattern&&($scope.nlpData.finalResolver.ranking[0].matchedPattern=decodePattern($scope.nlpData.finalResolver.ranking[0].matchedPattern)),$scope.nlpData&&$scope.nlpData.finalResolver&&$scope.nlpData.finalResolver.winningIntent&&$scope.nlpData.finalResolver.winningIntent[0]&&$scope.nlpData.finalResolver.winningIntent[0].intent&&($scope.nlpData.finalResolver.winningIntent[0].intent=decodePattern($scope.nlpData.finalResolver.winningIntent[0].intent)),$scope.dataAvailableDefinitive&&!$scope.dataAvailableSmallTalk&&($scope.allTasksDefinitive=$scope.allTasksDefinitive.filter(function(task){var _filteredResults=_.filter($scope.nlpData.finalResolver.ranking,{intent:task.task});return _filteredResults&&_filteredResults.length>0?task:void 0})),$scope.allTasksDefinitive&&$scope.allTasksDefinitive.length?$scope.titleMessage=inWords($scope.allTasksDefinitive.length)+$scope.allTasksDefinitive.length>1?i18n.i18nString("definitive_Found"):i18n.i18nString("definitive_found"):$scope.dataAvailable&&!$scope.dataAvailableSmallTalk?common>0&&2===$scope.allTasks.length?$scope.titleMessage=inWords(common)+i18n.i18nString("possible_Match"):common>0&&$scope.allTasks.length>2?$scope.titleMessage=inWords(common)+i18n.i18nString("possible_Found"):$scope.titleMessage=inWords($scope.allTasks.length)+i18n.i18nString("possible_Found"):$scope.dataAvailableSmallTalk?$scope.titleMessage=i18n.i18nString("small_talk_identified"):$scope.titleMessage=i18n.i18nString("no_possible");else if("universalbot"===$scope.stream.type){var botMsg="";$scope.nlpData&&$scope.nlpData.scopedBots&&$scope.nlpData.scopedBots.qualifiedBots&&mapBotIcon($scope.nlpData.scopedBots.qualifiedBots),$scope.dataAvailableDefinitive&&!$scope.dataAvailableSmallTalk&&($scope.allTasksDefinitive=$scope.allTasksDefinitive.filter(function(task){var _filteredResults=_.find($scope.nlpData.finalResolver.ranking,{intent:task.task});return _filteredResults?(_filteredResults.botIconUrl=botIconResults[task.streamId],$scope.linkedBotsDefinitive.push(_filteredResults),task):void 0})),$scope.dataAvailable&&!$scope.dataAvailableSmallTalk&&($scope.allTasks=$scope.allTasks.filter(function(task){var _filteredResults=_.find($scope.nlpData.finalResolver.ranking,{intent:task.task});return _filteredResults?(_filteredResults.botIconUrl=botIconResults[task.streamId],$scope.linkedBotsPossible.push(_filteredResults),task):void 0})),$scope.allTasksDefinitive&&$scope.allTasksDefinitive.length?($scope.titleMessage=$scope.allTasksDefinitive.length>1?i18n.i18nString("mutiple_definitive"):i18n.i18nString("single_definitive"),botMsg=$scope.linkedBots.length>1?i18n.i18nString("multiple_bots"):i18n.i18nString("single_bot"),$scope.titleMessage=$scope.titleMessage+" "+botMsg):$scope.dataAvailable&&$scope.allTasks&&$scope.allTasks.length&&!$scope.dataAvailableSmallTalk?($scope.titleMessage=$scope.allTasks.length>1?i18n.i18nString("multiple_possible"):i18n.i18nString("single_possible"),botMsg=$scope.linkedBots.length>1?i18n.i18nString("multiple_bots"):i18n.i18nString("single_bot"),$scope.titleMessage=$scope.titleMessage+" "+botMsg):$scope.dataAvailableSmallTalk?$scope.titleMessage=i18n.i18nString("small_talk_identified"):$scope.titleMessage=i18n.i18nString("no_definitive")}$scope.nlpData.finalResolver&&$scope.nlpData.finalResolver.ranking&&($scope.eliminatedIntents=_.filter($scope.nlpData.finalResolver.ranking,function(task){return task&&task.hasOwnProperty("eliminationInfo")?task:void 0})),getRankingResolverMeg(),setTimeout(function(){$(".accordionDiv .header").on("click",function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(this).toggleClass("active"),$(this).siblings().toggleClass("open").stop().slideToggle()})},500),setTimeout(function(){$(".eachChildAcc").on("click",function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(this).find(".inner").toggleClass("open").slideToggle(),$(this).find(".innerHeader").toggleClass("open"),$(this).toggleClass("fa-caret-down fa-caret-right")}),$(".accordionDiv .header").on("click",function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(this).toggleClass("active"),$(this).siblings().toggleClass("open").stop().slideToggle()})},500)}else"botScope"===$scope.panel.type&&"universalbot"===$scope.stream.type&&($scope.inclusiveBots=_.filter($scope.nlpData.scopedBots.qualifiedBots,{botType:"inclusive"}),$scope.fallBackBots=_.filter($scope.nlpData.scopedBots.qualifiedBots,{botType:"fallback"}))}function sortProperties(obj){var sortable=[];for(var key in obj)obj.hasOwnProperty(key)&&sortable.push([key,obj[key]]);return sortable.sort(function(a,b){var x=a[1],y=b[1];return x>y?-1:y>x?1:0}),sortable}function inWords(amount){var words=[];words[0]="",words[1]="One",words[2]="Two",words[3]="Three",words[4]="Four",words[5]="Five",words[6]="Six",words[7]="Seven",words[8]="Eight",words[9]="Nine",words[10]="Ten",words[11]="Eleven",words[12]="Twelve",words[13]="Thirteen",words[14]="Fourteen",words[15]="Fifteen",words[16]="Sixteen",words[17]="Seventeen",words[18]="Eighteen",words[19]="Nineteen",words[20]="Twenty",words[30]="Thirty",words[40]="Forty",words[50]="Fifty",words[60]="Sixty",words[70]="Seventy",words[80]="Eighty",words[90]="Ninety",amount=amount.toString();var i,j,atemp=amount.split("."),number=atemp[0].split(",").join(""),n_length=number.length,words_string="";if(9>=n_length){var n_array=new Array(0,0,0,0,0,0,0,0,0),received_n_array=[];for(i=0;n_length>i;i++)received_n_array[i]=number.substr(i,1);for(i=9-n_length,j=0;9>i;i++,j++)n_array[i]=received_n_array[j];for(i=0,j=1;9>i;i++,j++)(0===i||2===i||4==i||7===i)&&1==n_array[i]&&(n_array[j]=10+parseInt(n_array[j]),n_array[i]=0);var value="";for(i=0;9>i;i++)value=0===i||2===i||4===i||7===i?10*n_array[i]:n_array[i],0!==value&&(words_string+=words[value]+" "),(1===i&&0!==value||0===i&&0!==value&&0===n_array[i+1])&&(words_string+="Crores "),(3===i&&0!==value||2===i&&0!==value&&0===n_array[i+1])&&(words_string+="Lakhs "),(5===i&&0!==value||4===i&&0!==value&&0===n_array[i+1])&&(words_string+="Thousand "),6===i&&0!==value&&0!==n_array[i+1]&&0!==n_array[i+2]?words_string+="Hundred and ":6===i&&0!==value&&(words_string+="Hundred ");words_string=words_string.split("  ").join(" ")}return words_string}function getProbabaleCount(){var _possibleMatch=0;return $scope.nlpData&&$scope.nlpData.fm&&$scope.nlpData.fm.possible&&$scope.nlpData.fm.possible.length&&(_possibleMatch+=$scope.nlpData.fm.possible.length),$scope.nlpData&&$scope.nlpData.ml&&$scope.nlpData.ml.possible&&$scope.nlpData.ml.possible.length&&(_possibleMatch+=$scope.nlpData.ml.possible.length),$scope.nlpData&&$scope.nlpData.faq&&$scope.nlpData.faq.possible&&$scope.nlpData.faq.possible.length&&(_possibleMatch+=$scope.nlpData.faq.possible.length),_possibleMatch}function getDefinitiveCount(){var _definitiveMatch=0;return $scope.nlpData&&$scope.nlpData.fm&&$scope.nlpData.fm.definitive&&$scope.nlpData.fm.definitive.length&&(_definitiveMatch+=$scope.nlpData.fm.definitive.length),$scope.nlpData&&$scope.nlpData.ml&&$scope.nlpData.ml.definitive&&$scope.nlpData.ml.definitive.length&&(_definitiveMatch+=$scope.nlpData.ml.definitive.length),$scope.nlpData&&$scope.nlpData.faq&&$scope.nlpData.faq.definitive&&$scope.nlpData.faq.definitive.length&&(_definitiveMatch+=$scope.nlpData.faq.definitive.length),_definitiveMatch}function getRankingResolverMeg(){function getMsg(){var _match;return _probableCount&&_definitiveCount?(_match=_probableCount>1?"matches":"match",_overallStr=_overallStr+_definitiveCount+" definitive and "+_probableCount+" probable "+_match+" are found ."):_definitiveCount&&!_probableCount?_overallStr=_overallStr+_definitiveCount+" definitive and no probable matches are found .":!_definitiveCount&&_probableCount&&(_match=_probableCount>1?"matches":"match",_overallStr=_overallStr+"No  definitive and "+_probableCount+" probable "+_match+" are found ."),_overallStr}$scope.overallStr="";var result,_probableCount=getProbabaleCount(),_definitiveCount=getDefinitiveCount(),_resultMsg="",_overallStr="";return _definitiveCount||_probableCount||($scope.overallStr="No matches are found ."),1!==_definitiveCount||_probableCount?_definitiveCount||1!==_probableCount?$scope.nlpData.intentRescoring&&$scope.nlpData.isPreferDefinitiveMatch?(result=getMsg,_resultMsg=result(),$scope.overallStr=_resultMsg+" All identified probables matches are rescored ."):$scope.nlpData.intentRescoring&&!$scope.nlpData.isPreferDefinitiveMatch?(result=getMsg,_resultMsg=result(),$scope.overallStr=_resultMsg+" All matches are rescored ."):!$scope.nlpData.intentRescoring&&$scope.nlpData.isPreferDefinitiveMatch?(result=getMsg,_resultMsg=result(),$scope.overallStr=_resultMsg+" No matches are rescored"):(result=getMsg,_resultMsg=result(),$scope.overallStr=_resultMsg+" No matches are rescored ."):$scope.overallStr="No definitive and 1 probable match is found .":$scope.overallStr=$scope.overallStr+_definitiveCount+" definitive and no probable matches are found .",$scope.overallStr}$scope.stream=$workflowService.selectedStream(),$scope._constants_=$rootScope._constants_,$scope.rightEditPanelHeightDefault=-57,$scope.offsetValue=-250,$scope.allTasks=[],$scope.panel={},$scope.enabled=i18n.i18nString("enabled"),$scope.disabled=i18n.i18nString("disabled"),$scope.utterance=i18n.i18nString("matched_utterance"),$scope.questions=i18n.i18nString("matched_question"),$scope.exclamationGray=env_conf["context-url"]+"/assets/icons/exclamationGray.svg",$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.advancedSettingsIcon=env_conf["context-url"]+"/assets/nlIcons/advancedSettingsIcon.svg",$scope.advancedSettingsIconGray=env_conf["context-url"]+"/assets/nlIcons/advancedSettingsIconGray.svg",$scope.infoIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/helpIcon.svg",$scope.smallTalkIcon=env_conf["context-url"]+"/assets/smalltalk/faq.svg",$scope.bulbBlue=env_conf["context-url"]+"/assets/icons-new/bulb/bulb-blue.svg",$scope.chevronRightIcon=env_conf["context-url"]+"/assets/icons-new/caret/caret-right-dark.svg",$scope.eliminationReasons={foundEarlierPattern:i18n.i18nString("intent_ele1"),foundDefinitive:i18n.i18nString("intent_ele2"),foundDefinitiveInEarlierSentence:i18n.i18nString("intent_ele3"),outsideProximity:i18n.i18nString("intent_ele4"),searchInAnswer:i18n.i18nString("intent_ele5"),negativePattern:i18n.i18nString("intent_ele6"),preconditionNotSatisfied:i18n.i18nString("intent_ele7"),noWordMatch:i18n.i18nString("intent_ele8"),verbMatchOnly:i18n.i18nString("intent_ele9"),entityMatchOnly:i18n.i18nString("intent_ele10"),foundHighConfidence:i18n.i18nString("intent_ele11"),outsideFMProximity:i18n.i18nString("intent_ele4"),belowDependencyThreshold:i18n.i18nString("intent_ele12"),withinAnotherTask:i18n.i18nString("intent_ele13")},$scope.dependency={},$scope.linkedBots=[],$scope.linkedBotsPossible=[],$scope.linkedBotsDefinitive=[],$scope.invocationInfo="Words used for identifying the linked bot using invocation phrases are not used for intent detection.";var botIconResults={};$scope.compareNlpWord=function(word,index){if(!word.ignored){if(word.processedWord===word.original&&word.original!==word.word)return $($(".accTable").find(".ignored")[index]).addClass("procsWord"),word.word;if(word.processedWord===word.original)return"/no change/";if(word.processedWord!==word.original)return $($(".accTable").find(".ignored")[index]).addClass("procsWord"),word.processedWord}},$scope.addGreenBorder=function(str){return"#"===str[0]?!0:!1},$scope.processFAQText=function(str){"#"===str.charAt(0)&&(str=str.substr(1));var arr=str.split("(");return arr[0]},$scope.convertArrToString=function(arr){return arr?arr.join(", "):""},$scope.getMatchedItems=function(path){if(path){for(var matchedItems=[],i=0;i<path.length;i++)"#"===path[i].charAt(0)&&matchedItems.push($scope.processFAQText(path[i]));return $scope.convertArrToString(matchedItems)}return"---"},$scope.getQuestionSynonyms=function(str){return"#"===str.charAt(0)&&(str=str.substr(1)),-1!==str.indexOf("(")?str=str.replace("(","  ("):""},$scope.hasClass=function(str){if(-1!==str.indexOf(":")){var arr=str.split(":");return arr[1]}return""},$scope.initiatePopover=function(data,index){setTimeout(function(){$(".knowMore"+index).popover({html:!0,content:function(){var heading='<p class="boldText">"'+i18n.i18nString("training_utterances")+'"</p>',sampleHtml="",processedData=data.scoring.processedUtterances,result=sortProperties(processedData);return $.each(result,function(key,value){var score;score=Math.round(value[1]),score=$filter("number")(score,0),sampleHtml=sampleHtml+'<div class="col-xs-9 noPadding">'+value[0]+'</div><div class="col-xs-3 left10">'+score+"</div>"}),heading.concat(sampleHtml)},trigger:"hover"})},500)},$scope.initiateInvocationPopver=function(){$("#phraseInfo .infoIcon").popover()},$scope.activateTask=function(task){$scope.processedUtterancesData="",task.scoring&&task.scoring.processedUtterances&&($scope.processedUtterancesData=task.scoring.processedUtterances),task.active?task.active=!1:task.active=!0},$scope.closePanel=function(){$scope.cb.closeEditPanel()},$scope.cb.initEditPanel=function(nlpData,trainBotCB,expandIndex){$scope.panel.type=$scope.cb.type,$scope.nlpData=nlpData,$scope.cb.loading=!1,init(),"MathedTraits"==$scope.panel.type&&$timeout(function(){$("#matchedTraitAccordion"+expandIndex)&&$("#matchedTraitAccordion"+expandIndex).click()},500)},$scope.checkUndefined=function(ele){return void 0===typeof ele?!1:!0},$scope.processData=function(word){return word?(word=word.charAt(0).toUpperCase()+word.substr(1),word.match(/[A-Z][a-z]+|[0-9]+/g).join(" ")):void 0},$scope.getThresholdDetailsMl=function(){$scope.stream&&$scope.stream.confidenceConfigs&&$scope.stream.confidenceConfigs.length&&(setTimeout(function(){PerfectScrollbar.initialize($("#mlConfigPanel .panel-body")[0])},100),$scope.mlDetails=$scope.stream.confidenceConfigs[0],BTStreamsService.getMLSynonym($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data[0]&&($scope.mlDetails=angular.extend($scope.mlDetails,res.data[0].intentParams,res.data[0].nerParams)),$scope.mlDetails.ngram&&0===$scope.mlDetails.ngram.length&&($scope.mlDetails.ngram[0]=0,$scope.mlDetails.ngram[1]=0)}))},$scope.getThresholdDetailsFaq=function(){$scope.stream&&$scope.stream.confidenceConfigs&&$scope.stream.confidenceConfigs.length&&(setTimeout(function(){PerfectScrollbar.initialize($("#faqConfigPanel .panel-body")[0])},100),$scope.faqDetails=$scope.stream.confidenceConfigs[1],$scope.stream.confidenceConfigs[1]&&void 0===$scope.stream.confidenceConfigs[1].searchInAnswer&&($scope.stream.confidenceConfigs[1].searchInAnswer={},
$scope.stream.confidenceConfigs[1].searchInAnswer.enabled=!1),$scope.stream.confidenceConfigs[1]&&void 0===$scope.stream.confidenceConfigs[1].longResponses&&($scope.stream.confidenceConfigs[1].longResponses={},$scope.stream.confidenceConfigs[1].longResponses.readMore=!1))},$scope.getThresholdDetailsFm=function(){$scope.stream&&$scope.stream.confidenceConfigs&&$scope.stream.confidenceConfigs.length&&($scope.csDetails=$scope.stream.confidenceConfigs[2],$scope.csDetails.taskMatchTolerance=void 0===$scope.stream.confidenceConfigs[2]?2:void 0!==$scope.stream.confidenceConfigs[2].taskMatchTolerance?$scope.stream.confidenceConfigs[2].taskMatchTolerance:2)}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btTrainNlpanalysis",function(){return{restrict:"EAQ",scope:{cb:"=",nlpData:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-train-nlpAnalysis/bt-train-nlpAnalysis.html",controller:["$scope","$window","$element","$timeout","env_conf","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","i18n",function($scope,$window,$element,$timeout,env_conf,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,i18n){function initLines(){"universalbot"==$scope.stream.type&&2===$scope.stream.universalBotVersion?$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 83px !important;}</style>"):($("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 103px !important;}</style>"),$("head").append("<style>.analyzeTrain .intentTitle:after{margin-top: 103px !important;}</style>"))}function updateRightLines(updateAnalyze){$timeout(function(){var rightLineHeight=0,rightLineHeight1=0,rightLineHeight2=0,rightLineMarginTop=0,traitsBlockLength=0,rightLineMarginTop1=0,rightLineMarginTop2=0,scopeHeight=0;$scope.nlpData&&$scope.nlpData.scopedBots&&"universalbot"==$scope.stream.type&&2===$scope.stream.universalBotVersion&&(scopeHeight=$(".intentTitle.botScope").height()),$scope.nlpData.traits&&$scope.nlpData.traits.definitive&&$scope.nlpData.traits.definitive.length&&(traitsBlockLength=$(".eachModel.traitRules").height()),$scope.nlpData.ml&&$scope.nlpData.ml.definitive?(rightLineHeight=$(".bt-train-bot-modal .eachModel.mlm").height()+22+$(".bt-train-bot-modal .eachModel.fmm").height()+$(".bt-train-bot-modal .eachModel.kc").height()+traitsBlockLength-20,rightLineHeight1=$(".analyzeTrain .eachModel.mlm").height()+22+$(".analyzeTrain .eachModel.fmm").height()+$(".analyzeTrain  .eachModel.kc").height()+traitsBlockLength-20,rightLineHeight2=$(".analyzeEditNLP .eachModel.mlm").height()+22+$(".analyzeEditNLP  .eachModel.fmm").height()+$(".analyzeEditNLP  .eachModel.kc").height()+traitsBlockLength-20,scopeHeight?($("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 128px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top: 128px !important;}</style>")):($("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 148px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top: 148px !important;}</style>")),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{height:"+rightLineHeight+"px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{height:"+rightLineHeight2+"px !important;}</style>"),updateAnalyze||(scopeHeight?$("head").append("<style>.analyzeTrain .intentTitle:after{margin-top: 128px !important;}</style>"):$("head").append("<style>.analyzeTrain .intentTitle:after{margin-top: 148px !important;}</style>"),$("head").append("<style>.analyzeTrain .intentTitle:after{height:"+rightLineHeight1+"px !important;}</style>"))):$scope.nlpData.fm&&$scope.nlpData.fm.definitive?(rightLineHeight=$(".bt-train-bot-modal .eachModel.fmm").height()+$(".bt-train-bot-modal .eachModel.kc").height()+traitsBlockLength-15,rightLineHeight1=$(".analyzeTrain .eachModel.fmm").height()+$(".analyzeTrain  .eachModel.kc").height()+traitsBlockLength-15,rightLineHeight2=$(".analyzeEditNLP .eachModel.fmm").height()+$(".analyzeEditNLP  .eachModel.kc").height()+traitsBlockLength-15,rightLineMarginTop=84+($(".bt-train-bot-modal .eachModel.mlm").height()+22+Math.round($(".bt-train-bot-modal .eachModel.fmm .model").outerHeight())+$(".bt-train-bot-modal .eachModel.fmm .possibleMatch.definitive").first().outerHeight()/2+10-scopeHeight),rightLineMarginTop1=84+($(".analyzeTrain .eachModel.mlm").height()+22+Math.round($(".analyzeTrain .eachModel.fmm .model").outerHeight())+$(".analyzeTrain .eachModel.fmm .possibleMatch.definitive").first().outerHeight()/2+10-scopeHeight),rightLineMarginTop2=84+($(".analyzeEditNLP .eachModel.mlm").height()+22+Math.round($(".analyzeEditNLP .eachModel.fmm .model").outerHeight())+$(".analyzeEditNLP .eachModel.fmm .possibleMatch.definitive").first().outerHeight()/2+10-scopeHeight),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 263px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top: 263px !important;}</style>"),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{height:"+rightLineHeight+"px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{height:"+rightLineHeight2+"px !important;}</style>"),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top:"+rightLineMarginTop+"px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top:"+rightLineMarginTop2+"px !important;}</style>"),updateAnalyze||($("head").append("<style>.analyzeTrain .intentTitle:after{margin-top: 263px !important;}</style>"),$("head").append("<style>.analyzeTrain .intentTitle:after{height:"+rightLineHeight1+"px !important;}</style>"))):$scope.nlpData.faq&&$scope.nlpData.faq.definitive?(rightLineHeight=$(".bt-train-bot-modal .eachModel.kc").height()+traitsBlockLength-30,rightLineHeight1=$(".analyzeTrain  .eachModel.kc").height()+traitsBlockLength-30,rightLineHeight2=$(".analyzeEditNLP  .eachModel.kc").height()+traitsBlockLength-30,rightLineMarginTop=84+($(".bt-train-bot-modal .eachModel.mlm").height()+22+($(".bt-train-bot-modal .eachModel.kc").height()/2+22)+($(".bt-train-bot-modal .eachModel.fmm").height()+22)-scopeHeight),rightLineMarginTop1=84+($(".analyzeTrain .eachModel.mlm").height()+22+($(".analyzeTrain .eachModel.kc").height()/2+22)+($(".analyzeTrain .eachModel.fmm").height()+22)-scopeHeight),rightLineMarginTop2=84+($(".analyzeEditNLP .eachModel.mlm").height()+22+($(".analyzeEditNLP .eachModel.kc").height()/2+22)+($(".analyzeEditNLP .eachModel.fmm").height()+22)-scopeHeight),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 351px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top: 3451px !important;}</style>"),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{height:"+rightLineHeight+"px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{height:"+rightLineHeight2+"px !important;}</style>"),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top:"+rightLineMarginTop+"px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top:"+rightLineMarginTop2+"px !important;}</style>"),updateAnalyze||($("head").append("<style>.analyzeTrain .intentTitle:after{margin-top: 3451px !important;}</style>"),$("head").append("<style>.analyzeTrain .intentTitle:after{height:"+rightLineHeight1+"px !important;}</style>"))):$scope.nlpData.traits&&$scope.nlpData.traits.definitive&&$scope.nlpData.traits.definitive.length?(rightLineHeight=$(".bt-train-bot-modal .eachModel.traitRules").height()-70,rightLineHeight1=$(".analyzeTrain  .eachModel.traitRules").height(),rightLineHeight2=$(".analyzeEditNLP  .eachModel.traitRules").height(),rightLineMarginTop=84+($(".bt-train-bot-modal .eachModel.mlm").height()+22+($(".bt-train-bot-modal .eachModel.kc").height()+22)+($(".bt-train-bot-modal .eachModel.fmm").height()+22)+($(".bt-train-bot-modal .eachModel.traitRules").height()/2+22)-scopeHeight),rightLineMarginTop1=84+($(".analyzeTrain .eachModel.mlm").height()+22+($(".analyzeTrain .eachModel.kc").height()+22)+($(".analyzeTrain .eachModel.fmm").height()+22)+($(".analyzeTrain .eachModel.traitRules").height()/2+22)-scopeHeight),rightLineMarginTop2=84+($(".analyzeEditNLP .eachModel.mlm").height()+22+($(".analyzeEditNLP .eachModel.kc").height()+22)+($(".analyzeEditNLP .eachModel.fmm").height()+22)+($(".analyzeEditNLP .eachModel.traitRules").height()/2+22)-scopeHeight),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 441px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top: 441px !important;}</style>"),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{height:"+rightLineHeight+"px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{height:"+rightLineHeight2+"px !important;}</style>"),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top:"+rightLineMarginTop+"px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top:"+rightLineMarginTop2+"px !important;}</style>"),updateAnalyze||($("head").append("<style>.analyzeTrain .intentTitle:after{margin-top: 441px !important;}</style>"),$("head").append("<style>.analyzeTrain .intentTitle:after{height:"+rightLineHeight1+"px !important;}</style>"))):(rightLineHeight=$(".bt-train-bot-modal .eachModel.mlm").height()+20+($(".bt-train-bot-modal .eachModel.fmm").height()+20)+($(".bt-train-bot-modal .eachModel.kc").height()+20)+(traitsBlockLength?traitsBlockLength+20:0-scopeHeight),rightLineHeight1=$(".analyzeTrain .eachModel.mlm").height()+20+($(".analyzeTrain .eachModel.fmm").height()+20)+($(".analyzeTrain  .eachModel.kc").height()+20)+(traitsBlockLength?traitsBlockLength+20:0),rightLineHeight2=$(".analyzeEditNLP .eachModel.mlm").height()+20+($(".analyzeEditNLP .eachModel.fmm").height()+20)+($(".analyzeEditNLP  .eachModel.kc").height()+20)+(traitsBlockLength?traitsBlockLength+20:0),$scope.nlpData.ml&&$scope.nlpData.ml.definitive&&$scope.nlpData.finalResolver&&$scope.nlpData.finalResolver.ranking?(rightLineHeight-=30,rightLineHeight1-=30,rightLineHeight2-=30,$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 148px !important;}</style>"),$("head").append("<style>.analyzeTrain .intentTitle:after{margin-top: 148px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top: 128px !important;}</style>")):$scope.nlpData.ml&&$scope.nlpData.ml.definitive&&(rightLineHeight-=70,$("head").append("<style>.bt-train-bot-modal .intentTitle:after{margin-top: 148px !important;}</style>"),$("head").append("<style>.analyzeTrain .intentTitle:after{margin-top: 148px !important;}</style>")),"universalbot"==$scope.stream.type&&2===$scope.stream.universalBotVersion?$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top: 98px !important;}</style>"):$("head").append("<style>.analyzeEditNLP .intentTitle:after{margin-top: 118px !important;}</style>"),$("head").append("<style>.bt-train-bot-modal .intentTitle:after{height:"+rightLineHeight+"px !important;}</style>"),$("head").append("<style>.analyzeEditNLP .intentTitle:after{height:"+rightLineHeight2+"px !important;}</style>"),updateAnalyze||$("head").append("<style>.analyzeTrain .intentTitle:after{height:"+rightLineHeight1+"px !important;}</style>")),updateLeftLines()},750)}function updateLeftLines(){var traitsBlockLength=0;$scope.nlpData.traits&&$scope.nlpData.traits.definitive&&$scope.nlpData.traits.definitive.length&&(traitsBlockLength=$(".eachModel.traitRules").height()),$timeout(function(){var analyzeLeftLineHeight=$(".analyzeTrain .eachModel.mlm").height()+30+$(".analyzeTrain .eachModel.fmm").height()+$(".analyzeTrain .eachModel.kc").height()+(traitsBlockLength?traitsBlockLength:-70);$("head").append("<style>.analyzeTrain .intentTitle:before{height:"+analyzeLeftLineHeight+"px !important;}</style>");var analyzeLeftLineHeight1=$(".analyzeEditNLP .eachModel.mlm").height()+30+$(".analyzeEditNLP .eachModel.fmm").height()+$(".analyzeEditNLP .eachModel.kc").height()+(traitsBlockLength?traitsBlockLength:-70);$("head").append("<style>.analyzeEditNLP .intentTitle:before{height:"+analyzeLeftLineHeight1+"px !important;}</style>");var leftLineHeight=$(".bt-train-bot-modal .eachModel.mlm").height()+30+$(".bt-train-bot-modal .eachModel.fmm").height()+$(".bt-train-bot-modal .eachModel.kc").height()+(traitsBlockLength?traitsBlockLength:-70);$("head").append("<style>.bt-train-bot-modal .intentTitle:before{height:"+leftLineHeight+"px !important;}</style>")},1750)}function prepareFinalMsg(){$scope.finalMsg=i18n.i18nString("multiple_matches");var definitiveCount=0;$scope.nlpData.ml&&$scope.nlpData.ml.definitive&&(definitiveCount+=$scope.nlpData.ml.definitive.length),$scope.nlpData.fm&&$scope.nlpData.fm.definitive&&(definitiveCount+=$scope.nlpData.fm.definitive.length),$scope.nlpData.faq&&$scope.nlpData.faq.definitive&&(definitiveCount+=$scope.nlpData.faq.definitive.length),$scope.nlpData.traits&&$scope.nlpData.traits.definitive&&$scope.nlpData.traits.definitive.length&&(definitiveCount+=$scope.nlpData.traits.definitive.length),1===definitiveCount?$scope.finalMsg=i18n.i18nString("definitive_found"):definitiveCount>1&&($scope.finalMsg=i18n.i18nString("definitive_multiple"))}$scope.stream=$workflowService.selectedStream(),$scope._constants_=$rootScope._constants_,$scope.assetsBase=env_conf["assets-url"],$scope.copyImage=env_conf["context-url"]+"/assets/images/copy.svg",$scope.lightModeImage=env_conf["context-url"]+"/assets/images/lightmode.svg",$scope.darkModeImage=env_conf["context-url"]+"/assets/images/loader.svg",$scope.loadingGraph=!1,$scope.cb.showTitle=$scope.cb.showTitle?$scope.cb.showTitle:"true",$scope.finalMsg="",$scope.state="initial",$scope.smallTalkIcon=env_conf["context-url"]+"/assets/smalltalk/faq.svg",$scope.brightModeActive=!0,$scope.active=!1,$scope.options={mode:"code",ace:window.ace,theme:"ace/theme/clouds_midnight",aceViewMode:!0},setTimeout(function(){updateLeftLines(),updateRightLines()},500),$scope.cb.loadData=function(nlpData){$scope.nlpData=nlpData,prepareFinalMsg(),$scope.loadingGraph=!0,initLines(),setTimeout(function(){updateLeftLines()},500),setTimeout(function(){updateLeftLines(),updateRightLines()},1250),setTimeout(function(){var analyzeLeftLineHeight=$(".analyzeTrain .eachModel.mlm").height()+22+($(".analyzeTrain .eachModel.fmm").height()+22)+($(".analyzeTrain .eachModel.kc").height()+22)+($(".analyzeTrain .eachModel.traitRules").height()+22);$("head").append("<style>.analyzeTrain .intentTitle:before{height:"+analyzeLeftLineHeight+"px !important;}</style>");var leftLineHeight=$(".bt-train-bot-modal .eachModel.mlm").height()+20+($(".bt-train-bot-modal .eachModel.fmm").height()+20)+($(".analyzeTrain .eachModel.kc").height()+20)+($(".analyzeTrain .eachModel.traitRules").height()+20);$("head").append("<style>.bt-train-bot-modal .intentTitle:before{height:"+leftLineHeight+"px !important;}</style>"),updateRightLines(),updateLeftLines()},1750),setTimeout(function(){$scope.loadingGraph=!1,updateRightLines(),updateLeftLines(),$scope.state="final"},3e3)},$scope.cb.reloadLines=function(){$scope.loadingGraph=!0,setTimeout(function(){updateLeftLines(),updateRightLines(!0),$scope.loadingGraph=!1},350)},$scope.showLine=function(){return $scope.nlpData&&($scope.nlpData.ml&&$scope.nlpData.ml.definitive||$scope.nlpData.fm&&$scope.nlpData.fm.definitive||$scope.nlpData.faq&&$scope.nlpData.faq.definitive||$scope.nlpData.traits&&$scope.nlpData.traits.definitive&&$scope.nlpData.traits.definitive.length)?!1:!0},$scope.showTraitsSection=function(){return $scope.nlpData.traits&&$scope.nlpData.traits.definitive&&$scope.nlpData.traits.definitive.length},$scope.openClick=function(type,$event,index){$scope.cb.type=type,$scope.loading=!0,$scope.cb.openEditPanel($scope.cb.type,index),$(".model").removeClass("active"),$(".traitMatchCount")&&$(".traitMatchCount").removeClass("active"),$event.currentTarget.className+=" active"},$scope.toggleView=function(e){var _this=e.currentTarget;$(_this).parent().next().hasClass("in")?($(_this)[0].innerText=i18n.i18nString("json_View"),setTimeout(function(){$(".intentTitle.traitMatch .traitMatchsCount").removeClass("opacity")},500),$scope.active=!1):($(_this)[0].innerText=i18n.i18nString("summary_view"),$(".intentTitle.traitMatch .traitMatchsCount").addClass("opacity"),$scope.active=!0),$(".toggleView.collapse").collapse("toggle")},$scope.openBotScope=function(type){$scope.cb.type=type,$scope.cb.openEditPanel($scope.cb.type)},$scope.copyToClipboard=function(e){function copyToClipboardFF(text){window.prompt(i18n.i18nString("copy_clipboard"),text)}e.preventDefault(),e.stopPropagation();var selection,success=!0,range=document.createRange(),input=JSON.stringify($scope.nlpData);if(window.clipboardData)success=window.clipboardData.setData("Text",input);else{var tmpElem=$("<div>");tmpElem.css({position:"absolute",left:"-1000px",top:"-1000px"}),tmpElem.text(input),$("body").append(tmpElem),range.selectNodeContents(tmpElem.get(0)),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range);try{success=document.execCommand("copy",!1,null)}catch(e){copyToClipboardFF(input)}finally{tmpElem.remove()}}success&&NotificationService.notify(i18n.i18nString("json_copied"),"success")},"DarkTheme"==$workflowService.saveThemeMode()?$scope.brightModeActive=!1:$scope.brightModeActive=!0,$scope.switchMode=function(){$scope.brightModeActive=$scope.brightModeActive?!1:!0,$workflowService.saveThemeMode($scope.brightModeActive?i18n.i18nString("LightTheme"):i18n.i18nString("DarkTheme"))};var appWindow=angular.element($window);appWindow.bind("resize",function(){var _conwidth=$(".nlpAnalysis").width()+10;$(".analyzePanel .editNlpAnalysis").css("right",_conwidth+"px")})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("traitCount",function(){return{restrict:"AE",link:{post:function($scope,$element,attr){function cb(){var _elements=$element.find(".utteranceTag");$scope.filteredValues=[];var filteredElements,_countEle=$element.next("div");if(_.map(_elements,function(e,i){$(e).offset().top>$($(_elements)[0]).offset().top&&$(e).css({display:"none"}),filteredElements=_.filter(_elements,function(e,i){return!$(e).is(":visible")}).length}),filteredElements>0){var _countTag=filteredElements;$(_countEle).find(".count")[0].innerText=_countTag,$(_countEle).css({display:"block"})}else $(_countEle).css({display:"none"})}$element.ready(cb)}}}}),_module.directive("btTraits",[function(){return{restrict:"EA",scope:{callBack:"=",cb:"=?",gSearch:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-traits/bt-traits-training.html",controller:["$window","$scope","$rootScope","$workflowService","$location","_constants_","BTStreamsService","BTFlowtaskService","$timeout","$routeParams","env_conf","form_util","$filter","NotificationService","$applicationService","accessControlService","i18n","mixPanel",function($window,$scope,$rootScope,$workflowService,$location,_constants_,BTStreamsService,BTFlowtaskService,$timeout,$routeParams,env_conf,form_util,$filter,NotificationService,$applicationService,accessControlService,i18n,mixPanel){function checkMLSyncStatus(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithTraits")&&!res.data.isMlInSyncWithTraits?($scope.showTrainBtn=!0,$scope.cb&&$scope.cb.prepareTrainLabel(res.data)):$scope.showTrainBtn=!1,"Finished"===res.data.trainingStatus?($scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1):"Failed"===res.data.trainingStatus?($scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1):($scope.showTrainSavingDiv=!0,$scope.trainStatus.saving=!0)},function(err){$scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1,$scope.err_onfetching_msg=i18n.i18nString("err_on_fetching_msg"),NotificationService.notify($scope.err_onfetching_msg,"error")})}function traitSortableCallback(e,ui){$timeout(function(){console.log("trait_sorted")},200)}function formatTooltip(val,slider){slider?$(slider).find(".tooltip-inner").text(val):$("#mlTraitGroupThreshold-slider").find(".tooltip-inner").text(val)}function registerSlider(ele,obj){var slider=$(ele).bootstrapSlider(obj);return $(ele).slider().on("slideStop ",function(ev){onSliderChanged(ele,ev.value)}),$(ele).slider().on("slide",function(ev){formatTooltip(ev.value,ele)}),slider}function deRegisterSlider(ele){$(ele)&&($(ele).slider().off("slideStop "),$(ele).slider().off("slide"))}function prepareSliders(sliderValueSet){var mlTraitSkipDistance,mlTraitnGramSequenceLength,groupThresholdvalue=.5,mlTraitSequenceLength=2;$scope.traits.addEditTraits.scoreThreshold>-1&&(groupThresholdvalue=$scope.traits.addEditTraits.scoreThreshold),"skip_gram"===$scope.traits.addEditTraits.algo&&(mlTraitSequenceLength=$scope.traits.addEditTraits.configuration.skip_gram.seqLength||2,mlTraitSkipDistance=$scope.traits.addEditTraits.configuration.skip_gram.maxSkipDistance||1),"n_gram"===$scope.traits.addEditTraits.algo&&(mlTraitnGramSequenceLength=$scope.traits.addEditTraits.configuration.n_gram.maxVal||1),s1=registerSlider("#mlTraitGroupThreshold",{tooltip:"always",tooltip_position:"bottom"}),s2=registerSlider("#mlTraitSequenceLength",{tooltip:"always",tooltip_position:"bottom"}),s3=registerSlider("#mlTraitSkipDistance",{tooltip:"always",tooltip_position:"bottom"}),s4=registerSlider("#mlTraitnGramSequenceLength",{tooltip:"always",tooltip_position:"bottom"}),formatTooltip(groupThresholdvalue,"#mlTraitGroupThreshold"),formatTooltip(mlTraitSequenceLength,"#mlTraitSequenceLength"),formatTooltip(mlTraitSkipDistance,"#mlTraitSkipDistance"),formatTooltip(mlTraitnGramSequenceLength,"#mlTraitnGramSequenceLength")}function onSliderChanged(mode,val){$(".save-tip").show().text("Saving..."),"#mlTraitGroupThreshold"==mode?$scope.groupConfigs.scoreThreshold=val:"#mlTraitSequenceLength"==mode?$scope.groupConfigs.configuration.skip_gram.seqLength=val:"#mlTraitSkipDistance"==mode?($scope.groupConfigs.configuration.skip_gram.maxSkipDistance=val,$scope.groupConfigs.skipDistance=val):"#mlTraitnGramSequenceLength"==mode&&($scope.groupConfigs.configuration.n_gram.maxVal=val)}function fetchBotComponentsByType(){var state="published";("indevelopment"===$scope.viewState.toggleState||"configured"===$scope.viewState.toggleState)&&(state="configured"),BTFlowtaskService.getComponentsByTypeAndState($scope.stream._id,"intent",state).then(function(res){$scope._botComponents=[],res&&res.data&&res.data.length>0&&($scope._botComponents=res.data)},function(error){if(_botComponents=[],error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("fetch_error"),"error")})}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createTraits"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - New Trait Added"),"deleteTraits"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Trait Deleted"),"createRuleTraits"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Trait mapped to Intent"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}$scope.$emit("nestedComponentLoaded",{id:"traits",flag:!1}),$scope.traits={},$scope.add={traitName:""},$scope.callBack&&"KG"==$scope.callBack.type?$scope.traitsOffsetValue=-115:$scope.traitsOffsetValue=-260,$scope.viewState={},$scope.viewState.toggleState=$workflowService.selectedStreamState(),$scope.viewState.permission=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.loadingTraits=!0,$scope.stream=$workflowService.selectedStream(),$scope.trainStatus={success:!0,failed:!1,saving:!1};var streamId=$scope.stream._id;$scope.traits.search="",$scope.showMaptraitsSlider=!1,$scope.search={traitSearch:"",globalSearch:"",utteranceSearch:""},$scope.defaultGroupConfigs={matchStrategy:"probability",scoreThreshold:.5,algo:"n_gram",configuration:{skip_gram:{seqLength:2,maxSkipDistance:1},n_gram:{minVal:1,maxVal:1}}},$scope.groupConfigs=angular.copy($scope.defaultGroupConfigs),$scope.traits.traitGroups=[],$scope.traits.addEditTraits={},$scope.traits.selectedtrait="";var s1,s2,s3,s4;$scope.rightClass="right400",$scope.assetsBase=env_conf["assets-url"],$scope.emptyTraits=env_conf["context-url"]+"/assets/empty-state-images/traits.svg",$scope.backArrow=env_conf["context-url"]+"/assets/landingImages/backArrow.png",$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.errorWarning=env_conf["context-url"]+"/assets/icons/errorWarning.svg",$scope.trashIconGray=env_conf["context-url"]+"/assets/icons/trashIconGray.svg",$scope.pencilIcon=env_conf["context-url"]+"/assets/icons/pencilIcon.svg",$scope.arrowAngle=env_conf["context-url"]+"/assets/icons/arrowAngle.svg",$scope.ellipsisGray=env_conf["context-url"]+"/assets/icons/ellipsisGray.svg",$scope.grouping=env_conf["context-url"]+"/assets/images/grouping.png",$scope.pencilIconGreen=env_conf["context-url"]+"/assets/icons/pencilIconGreen.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.backArrow=env_conf["context-url"]+"/assets/icons/backArrow.svg",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.training_in_progress_desc1=i18n.i18nString("training_in_progress_desc1"),$scope.view_label=i18n.i18nString("view"),$scope.edit_label=i18n.i18nString("edit"),$scope.utterancesLabel=i18n.i18nString("utterences_label"),$scope.utteranceLabel=i18n.i18nString("utterence_label"),$scope.patterns_label=i18n.i18nString("patterns_label_space"),$scope.pattern_label=i18n.i18nString("pattern_label_space"),$scope.showless_label=i18n.i18nString("showless_label"),$scope.showall_label=i18n.i18nString("showall_label"),$scope.saving_label=i18n.i18nString("saving"),$scope.save_label=i18n.i18nString("save"),$scope.save_label_rule=i18n.i18nString("save_rule"),$scope.training_label=i18n.i18nString("training_label"),$scope.train_label=i18n.i18nString("train"),$scope.addutterences_or_phrases_label=i18n.i18nString("add_utterences_phrases"),$scope.training_in_progress_desc2=i18n.i18nString("training_in_progress_desc2"),$scope.modalSlider={},$scope.editTrait={},$scope.getTraitsGroupsApi=function(initial){initial&&($scope.loadingTraits=!0),BTStreamsService.getTraitGroups($applicationService.userInfo().userId,streamId).then(function(res){$scope.traits.traitGroups=angular.copy(res.data),$scope.cb&&($scope.cb.traitGroups=angular.copy(res.data)),$scope.callBack&&($scope.callBack.traitGroups=angular.copy(res.data));var allTraitskeys={},tempTraitkey="",alltraitsArr=[],allTraitsNegations=[];$scope.traits.traitGroups&&$scope.traits.traitGroups.length?$.each($scope.traits.traitGroups,function(i,traits){$.each(traits.traits,function(j,trait){({groupId:traits._id,traitId:trait.traitId||j,traitName:trait.traitName});alltraitsArr.push(trait.traitName),allTraitsNegations.push("!"+trait.traitName),tempTraitkey=angular.copy(trait.traitName.toUpperCase()),allTraitskeys[tempTraitkey]?allTraitskeys[tempTraitkey].count=allTraitskeys[tempTraitkey].count+1:allTraitskeys[tempTraitkey]={count:1},$scope.allTraits=_.uniq(alltraitsArr),$scope.allTraitsNegations=_.uniq(allTraitsNegations)})}):($scope.allTraits=_.uniq(alltraitsArr),$scope.allTraitsNegations=_.uniq(allTraitsNegations)),$scope.callBack&&$scope.callBack.updateGroupViewForGK&&$scope.callBack.updateGroupViewForGK($scope.allTraits),$scope.loadingTraits=!1,$scope.traits.traitGroups.length||$timeout(function(){$(".noTraits").scrollTop(3)},100),$scope.traitCounts=allTraitskeys},function(err){$scope.loadingTraits=!1,"NO"!==accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE")&&NotificationService.notify(i18n.i18nString("failed_traits"),"error")})},$scope.trainBot=function(){$scope.showTrainSavingDiv=!0,$scope.trainStatus={success:!1,failed:!1,saving:!0},BTStreamsService.trainUtterances(streamId).then(function(res){$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$emit("clearTestTrainText"),$rootScope.$broadcast("getProgressDockStatus"),$(".trainingProgress").addClass("open"),NotificationService.notify(i18n.i18nString("traits_training_initiated_noty"),"info"),$scope.trainTitle=""},function(err){$scope.trainStatus={success:!1,failed:!0,saving:!1},err.data.errors.length>0?(NotificationService.notify(err.data.errors[0].msg,"error"),$scope.trainTitle=err.data.errors[0].msg):($scope.trainTitle=i18n.i18nString("problen_in_training_traits"),NotificationService.notify(i18n.i18nString("problen_in_training_traits"),"error"))})},checkMLSyncStatus(),$scope.getTraitGroupById=function(groupId,traitKey){BTStreamsService.getTraitGroupById($applicationService.userInfo().userId,streamId,groupId).then(function(res){$scope.traits.addEditTraits=angular.copy(res.data),traitKey||($scope.traits.addEditTraits.traitsArray=[],$.each($scope.traits.addEditTraits.traits,function(key,value){value.key=key,$scope.traits.addEditTraits.traitsArray.push(value)}),$scope.groupConfigs.matchStrategy=res.data.matchStrategy||"probability",$scope.groupConfigs.algo=res.data.algo||"n_gram",res.data.scoreThreshold>-1?$scope.groupConfigs.scoreThreshold=res.data.scoreThreshold:$scope.groupConfigs.scoreThreshold=.5,$scope.groupConfigs.configuration=res.data.configuration,$scope.groupConfigs.configuration={skip_gram:res.data.configuration.skip_gram||angular.copy($scope.defaultGroupConfigs.configuration.skip_gram),n_gram:res.data.configuration.n_gram||angular.copy($scope.defaultGroupConfigs.configuration.n_gram)}),$scope.modalSlider.open("#createEditTraitsSlider"),setTimeout(function(){$scope.bindSearchEvents()},300)},function(err){"NO"!==accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE")&&NotificationService.notify(i18n.i18nString("failed_traits"),"error")})},$scope.getTraitsById=function(traitId,traitGroup){BTStreamsService.getTraitsById($applicationService.userInfo().userId,streamId,traitGroup._id,traitId).then(function(res){$scope.traits.selectedtrait=res.data.key||res.data.traitName,$scope.selectedTraitKey=res.data.key||res.data.traitName,$scope.traits.addEditTraits=angular.copy(traitGroup),$scope.traits.addEditTraits.traits={},$scope.traits.addEditTraits.traits[$scope.traits.selectedtrait]=angular.copy(res.data),$scope.traits.selectedtraitDisplayName=angular.copy(res.data.traitName),$scope.traits.selectedTraitObj=angular.copy(res.data),$scope.modalSlider.open("#createEditTraitsSlider")},function(err){NotificationService.notify(i18n.i18nString("failed_to_fetch_mappings_noty_errr"),"error")})},$scope.updateTraitsById=function(traitId,groupId,payload){BTStreamsService.updateTraitsById($applicationService.userInfo().userId,streamId,groupId,traitId,payload).then(function(res){NotificationService.notify(i18n.i18nString("trait_updated_sucess_noty"),"success"),$scope.getTraitsGroupsApi(),$scope.modalSlider.close("#createEditTraitsSlider"),checkMLSyncStatus(),$scope.sliderMode=""},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_to_save_trait_err_noty"),"error");
})},$scope.getTraitsGroupsApi(!0),$scope.updateTraitsApi=function(traitId,payload,form,ruleFlag){$scope.traitsLoading=!0,BTStreamsService.updateTraitGroup($applicationService.userInfo().userId,streamId,traitId,payload).then(function(res){$scope.getTraitsGroupsApi(),$scope.traitDeleted=!1,NotificationService.notify(i18n.i18nString("trait_grp_updated_sucess_noty"),"success"),checkMLSyncStatus(),$timeout(function(){$scope.traitsLoading=!1},500),$scope.closeCreate(form),ruleFlag&&$scope.openManageIntentTraitRules()},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("trait_update_failed_err_noty"),"error"),$timeout(function(){$scope.traitsLoading=!1})})},$scope.createTraitsApi=function(payload,form,addRuleFlag){$scope.traitsLoading=!0,BTStreamsService.createTraitGroup($applicationService.userInfo().userId,streamId,payload).then(function(res){mixpanelEvent("createTraits"),$scope.getTraitsGroupsApi(),$scope.closeCreate(form),$scope.traits.addEditTraits={},$scope.traits.addEditTraits.matchStrategy="probability",NotificationService.notify(i18n.i18nString("trait_grp_created_sucess_label",{dyn:payload.groupName}),"success"),checkMLSyncStatus(),$timeout(function(){$scope.traitsLoading=!1},500),addRuleFlag&&$scope.openManageIntentTraitRules()},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("trait_creation_failed_err"),"error"),$timeout(function(){$scope.traitsLoading=!1})})},$scope.deleteTraitsGroup=function(traitsGroup){function confirmDelete(){if(traitsGroup._id){var traitslist=angular.copy($scope.traits.traitGroups);traitslist.splice(index,1);var payload=traitslist;BTStreamsService.deleteTraitsGroup($applicationService.userInfo().userId,streamId,traitsGroup._id,payload).then(function(res){mixpanelEvent("deleteTraits"),NotificationService.notify(i18n.i18nString("trait_grp_deleted_sucessfully_label",{dyn:deleteTrait.groupName}),"success"),$scope.getTraitsGroupsApi(),checkMLSyncStatus()},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("trait_deletion_failed"),"error")})}else $scope.traits.traitGroups.splice(index,1)}function cancelDelete(){return!1}var index=_.findIndex($scope.traits.traitGroups,function(traitObj){return traitObj._id===traitsGroup._id}),deleteTrait=angular.copy($scope.traits.traitGroups[index]),msg=i18n.i18nString("delete_trait_type_msg",{dyn:traitsGroup.groupName});NotificationService.userConfirm(msg,[confirmDelete,cancelDelete],{okText:i18n.i18nString("confirm"),btnClass:"redBtn"},"",void 0,i18n.i18nString("are_you_sure"))},$scope.isTrainInprogress=function(){return $scope.trainStatus.saving?!0:!1},$scope.closeThisAccordian=function(event,groupIndex){$timeout(function(){event&&event.stopPropagation();var id="#"+groupIndex+"traitsAccordian";$(id)&&$(id).click&&$(id).click()})},$scope.showUtteranceInternalHeader=function(type){$scope.activeTabType=type,$(".utterances-content-view").bind("scroll",bindScroll)},$scope.closeTrainSaveDiv=function(){$scope.showTrainSavingDiv=!1,$scope.trainStatus={success:!0,failed:!1,saving:!1},$scope.speechTrainStatus={success:!0,failed:!1,saving:!1},$scope.trainTitle=""},$rootScope.$on("MLUtterencesTrainFinished",function($event){$scope.trainStatus={success:!0,failed:!1,saving:!1},$scope.trainTitle="",$scope.showTrainBtn=!1}),$rootScope.$on("MLUtterencesTrainFailed",function($event){$scope.trainStatus={success:!1,failed:!0,saving:!1},$scope.trainTitle=i18n.i18nString("problm_in_training_utter_noty")}),$scope.isDuplicate=function(trait){if(trait){var traitLKey=angular.copy(trait);return $scope.traitCounts&&$scope.traitCounts[traitLKey]&&$scope.traitCounts[traitLKey].count>1?!0:$scope.traits.selectedTraitObj&&$scope.traits.selectedTraitObj.traitName!==$scope.traits.selectedtraitDisplayName&&$scope.traitCounts&&$scope.traitCounts[traitLKey]&&$scope.traitCounts[traitLKey].count?!0:!1}},$scope.isTraitKeyDuplicate=function(trait,type){if(trait){var traitLKey=angular.copy(trait.toUpperCase());return $scope.traitCounts&&$scope.traitCounts[traitLKey]&&$scope.traitCounts[traitLKey].count>1&&!type?!0:$scope.traitCounts&&$scope.traitCounts[traitLKey]&&$scope.traitCounts[traitLKey].count&&"newKey"==type?!0:!1}},$scope.traitSortableOptions={handle:".traitSortHandle","ui-floating":!0,update:traitSortableCallback},$scope.bindSearchEvents=function(index){return $scope.search.utteranceSearch="",index?void $(".utteranceSearchBar").off("click").on("click",function(){$(this).hasClass("btx-close")?($(".utteranceSearch").removeClass("searchExpand"),$(this).removeClass("btx-close"),$(this).addClass("fa-search"),$scope.search.utteranceSearch=""):($(".utteranceSearch").addClass("searchExpand"),$(this).addClass("btx-close"),$(this).removeClass("fa-search"),$timeout(function(){$(".utteranceSearchInput").focus()},350))}):void("editTrait"!==$scope.sliderMode?$(".traitSearchBar").off("click").on("click",function(){$(this).hasClass("btx-close")?($(".traitSearch").removeClass("searchExpand"),$(this).removeClass("btx-close"),$(this).addClass("fa-search"),$scope.search.traitSearch=""):($(".traitSearch").addClass("searchExpand"),$(this).addClass("btx-close"),$(this).removeClass("fa-search"),$timeout(function(){$(".traitSearchInput").focus()},350))}):$(".utteranceSearchBar").off("click").on("click",function(){$(this).hasClass("btx-close")?($(".utteranceSearch").removeClass("searchExpand"),$(this).removeClass("btx-close"),$(this).addClass("fa-search"),$scope.search.utteranceSearch=""):($(".utteranceSearch").addClass("searchExpand"),$(this).addClass("btx-close"),$(this).removeClass("fa-search"),$timeout(function(){$(".utteranceSearchInput").focus()},350))}))},$scope.openManage=function(){deRegisterSlider("#mlTraitGroupThreshold"),deRegisterSlider("#mlTraitSequenceLength"),deRegisterSlider("#mlTraitSkipDistance"),deRegisterSlider("#mlTraitnGramSequenceLength"),prepareSliders()},$scope.createNewTraits=function(){$scope.traits.addEditTraits={},$scope.traits.addEditTraits=angular.copy($scope.defaultGroupConfigs),$scope.groupConfigs=angular.copy($scope.defaultGroupConfigs),$scope.sliderMode="createGroup",$scope.traits.search="",$scope.editedContent=!1,$scope.traitDeleted=!1,$scope.modalSlider.open("#createEditTraitsSlider"),$scope.gSearch?$scope.gSearch.search="":($scope.gSearch={},$scope.gSearch.search=""),setTimeout(function(){$scope.bindSearchEvents()},300)},$scope.editTraitFroup=function(traitGroup,index){$scope.editedContent=!1,$scope.currentGroupEditIndex=index,$scope.groupConfigs.matchStrategy=traitGroup.matchStrategy,$scope.traitDeleted=!1,$scope.sliderMode="editGroup",traitGroup._id&&$scope.getTraitGroupById(traitGroup._id,null,traitGroup)},$scope.closeCreate=function(form){form&&form_util.makeItClean(form),$scope.traitDeleted=!1,$scope.add={traitName:""},$scope.modalSlider.close("#createEditTraitsSlider"),angular.element(".traitSection .entity-body").animate({scrollTop:10}),$scope.sliderMode=""},$scope.openEditTraits=function(trait,traitGroup,traitId){$scope.editedContent=!1;var index=_.findIndex($scope.traits.traitGroups,function(traitObj){return traitObj._id===traitGroup._id});$scope.currentGroupEditIndex=index,$scope.sliderMode="editTrait",$scope.traitDeleted=!1,$scope.traits.selectedTraitGroupId=traitGroup._id,$scope.getTraitsById(traitId,traitGroup)},$scope.addTraits=function(traitName,event){var traits=[];if(event&&13==event.keyCode){if(!traitName||""===traitName)return!1;if(_constants_.checkForSecialChar(traitName,!1,"traits"))return!1;void 0===$scope.traits.addEditTraits.traits&&($scope.traits.addEditTraits.traits={}),void 0===$scope.traits.addEditTraits.traitsArray&&($scope.traits.addEditTraits.traitsArray=[]),$scope.add={traitName:""};var tempTraitKey=angular.copy(traitName);if($scope.traits.addEditTraits.traits[tempTraitKey])NotificationService.notify(i18n.i18nString("trait_dup_noty_err"),"error");else{var dummyTraitsObj={};dummyTraitsObj[tempTraitKey]={data:[],displayName:traitName,key:tempTraitKey,newKey:!0},angular.extend(dummyTraitsObj,$scope.traits.addEditTraits.traits||{}),$scope.traits.addEditTraits.newTrait=traitName,$scope.traits.addEditTraits.traits=angular.copy(dummyTraitsObj),traits.push(dummyTraitsObj[tempTraitKey]),$scope.traits.addEditTraits.traitsArray=traits.concat($scope.traits.addEditTraits.traitsArray),$timeout(function(){$("#0traitsAccordian").hasClass("closedAccordian")&&$("#0traitsAccordian").click()},100)}}},$scope.addUtterance=function(utter,key,event,traitsGroup,index){var utteranceData=[],duplicateExists=!1;if(event&&13==event.keyCode&&traitsGroup&&""!==utter){for(var i=0;i<$scope.traits.addEditTraits.traits[key].data.length;i++)if($scope.traits.addEditTraits.traits[key].data[i].toLowerCase()===utter.toLowerCase()){"pattern"===traitsGroup.matchStrategy?NotificationService.notify(i18n.i18nString("pattern_samename"),"error"):NotificationService.notify(i18n.i18nString("utterance_samename"),"error"),duplicateExists=!0;break}duplicateExists||(utteranceData.push(utter),$scope.traits.addEditTraits.traits[key].data=utteranceData.concat($scope.traits.addEditTraits.traits[key].data),index>-1&&($scope.traits.addEditTraits.traitsArray[index]=$scope.traits.addEditTraits.traits[key]),$scope.traits.addEditTraits.traits[key].utterance="")}},$scope.editUtterence=function(e,utteranceIndex,trait){e&&(e.stopPropagation(),e.stopImmediatePropagation());var utterance=trait.data[utteranceIndex];return-1!==trait.data.indexOf($scope.editTrait.editUtterence)&&utteranceIndex!==trait.data.indexOf($scope.editTrait.editUtterence)?($scope.editTrait.editUtterence=trait.data[utteranceIndex],NotificationService.notify(i18n.i18nString("utterance_samename"),"error"),$(".editingUtterance"+utteranceIndex).addClass("hide"),void $(".addUtteranceInput"+utteranceIndex).removeClass("hide")):$scope.editTrait.editUtterence&&$scope.editTrait.editUtterence.length?($(".editingUtterance"+utteranceIndex).addClass("hide"),$(".addUtteranceInput"+utteranceIndex).removeClass("hide"),trait.data[utteranceIndex]=$scope.editTrait.editUtterence,void 0):(trait.data[utteranceIndex]=utterance,void NotificationService.notify(i18n.i18nString("utterance_cannot_be_empty"),"error"))},$scope.editUtterenceAccordion=function(e,utteranceIndex,trait,parentIndex){e&&(e.stopPropagation(),e.stopImmediatePropagation());var utterance=trait.data[utteranceIndex];return-1!==trait.data.indexOf($scope.editTrait.editUtterence)&&utteranceIndex!==trait.data.indexOf($scope.editTrait.editUtterence)?($scope.editTrait.editUtterence=trait.data[utteranceIndex],NotificationService.notify(i18n.i18nString("utterance_samename"),"error"),$(".editingUtterance"+parentIndex+utteranceIndex).addClass("hide"),void $(".addUtteranceInput"+parentIndex+utteranceIndex).removeClass("hide")):$scope.editTrait.editUtterence&&$scope.editTrait.editUtterence.length?($(".editingUtterance"+parentIndex+utteranceIndex).addClass("hide"),$(".addUtteranceInput"+parentIndex+utteranceIndex).removeClass("hide"),trait.data[utteranceIndex]=angular.copy($scope.editTrait.editUtterence),void 0):(trait.data[utteranceIndex]=utterance,void NotificationService.notify(i18n.i18nString("utterance_cannot_be_empty"),"error"))},$scope.editUtterenceIntrait=function(index,utterance){$(".editingUtterance"+index).removeClass("hide"),$(".addUtteranceInput"+index).addClass("hide"),setTimeout(function(){$(".editingUtterance"+index).find("input").focus()},200),$scope.editTrait.editUtterence=utterance},$scope.editUtterenceAccordionInTrait=function(index,utterance,parentIndex){$scope.editTrait.editUtterence="",$(".editingUtterance"+parentIndex+index).removeClass("hide"),$(".addUtteranceInput"+parentIndex+index).addClass("hide"),setTimeout(function(){$(".editingUtterance"+parentIndex+index).find("input").focus()},200),$scope.editTrait.editUtterence=utterance},$scope.saveTraits=function(traitsGroup,form,byTraitId,addRuleFlag){function confirm(){return form.$invalid?void form_util.touch(form):$scope.traits.addEditTraits.traits?$scope.traits.addEditTraits.traits&&!Object.keys($scope.traits.addEditTraits.traits).length?void NotificationService.notify(i18n.i18nString("please_add_atleast_one_trait_err_noty"),"error"):void(traitsGroup&&traitsGroup._id&&!byTraitId?$scope.updateTraitsApi(traitsGroup._id,payload,form,addRuleFlag):byTraitId?byTraitId&&$scope.updateTraitsById($scope.traits.addEditTraits.traits[$scope.traits.selectedtrait].traitId,traitsGroup._id,payload):$scope.createTraitsApi(payload,form,addRuleFlag)):void NotificationService.notify(i18n.i18nString("please_add_atleast_one_trait_err_noty"),"error")}function cancel(){$scope.traits.selectedtraitDisplayName=angular.copy($scope.traits.selectedtrait)}function cancelEdit(){$scope.modalSlider.close("#createEditTraitsSlider")}var traits={},payload={},traitsData=angular.copy($scope.traits.addEditTraits.traitsArray);if($.each(traitsData,function(i,trait){var displayName=angular.copy(trait.key)||angular.copy(trait.displayName),traitKey=angular.copy(trait.key||trait.displayName);trait.displayName=trait.displayName||displayName,void 0!==trait.utterance&&delete trait.utterance,void 0!==trait.key&&delete trait.key,void 0!==trait.newKey&&delete trait.newKey,traits[traitKey]=trait}),byTraitId||(payload={groupName:$scope.traits.addEditTraits.groupName,matchStrategy:$scope.traits.addEditTraits.matchStrategy,scoreThreshold:$scope.traits.addEditTraits.scoreThreshold,traits:traits,algo:$scope.traits.addEditTraits.algo||"n_gram"},"skip_gram"===payload.algo&&(payload.configuration={skip_gram:{seqLength:$scope.traits.addEditTraits.configuration.skip_gram.seqLength||2,maxSkipDistance:$scope.traits.addEditTraits.configuration.skip_gram.maxSkipDistance||1}}),"n_gram"===payload.algo&&(payload.configuration={n_gram:{minVal:$scope.traits.addEditTraits.configuration.n_gram.minVal||1,maxVal:$scope.traits.addEditTraits.configuration.n_gram.maxVal||1}}),(void 0===payload.scoreThreshold||"pattern"==payload.matchStrategy)&&(payload.scoreThreshold=.5),traitsGroup&&traitsGroup._id&&$scope.traitDeleted?NotificationService.userConfirm(i18n.i18nString("one_or_more_traits_del_warning"),[confirm,cancelEdit],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("confirm_proceed")):confirm()),byTraitId){var tempTraitKey=angular.copy($scope.traits.selectedtraitDisplayName);$scope.traits.selectedtrait!=tempTraitKey?(payload={traitName:$scope.traits.selectedtraitDisplayName,traitKey:angular.copy($scope.traits.selectedtraitDisplayName),traitId:$scope.traits.addEditTraits.traits[$scope.traits.selectedtrait].traitId,sourceId:$scope.traits.addEditTraits._id,destId:$scope.traits.selectedTraitGroupId,data:$scope.traits.addEditTraits.traits[$scope.traits.selectedtrait].data},NotificationService.userConfirm(i18n.i18nString("trait_hintmsg1"),[confirm,cancel],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("are_you_sure"))):(payload={traitName:$scope.traits.selectedtraitDisplayName,traitKey:angular.copy($scope.traits.selectedtraitDisplayName),traitId:$scope.traits.addEditTraits.traits[$scope.traits.selectedtrait].traitId,sourceId:$scope.traits.addEditTraits._id,destId:$scope.traits.selectedTraitGroupId,data:$scope.traits.addEditTraits.traits[$scope.traits.selectedtrait].data},confirm())}},$scope.deleteTraitInGroup=function(key,traitsGroup,event,traitIndex){event&&(event.preventDefault(),event.stopImmediatePropagation()),$scope.traitDeleted=!0,delete traitsGroup.traits[key],traitsGroup.traitsArray.splice(traitIndex,1)},$scope.deleteUtteranceIntrait=function(deletedutternace,key,traitsGroup,traitIndex){var utternaceIndex=null;_.find(traitsGroup.traits[key].data,function(utterance,i){return deletedutternace==utterance?(utternaceIndex=i,!1):void 0});null!==utternaceIndex&&traitsGroup.traits[key].data.splice(utternaceIndex,1),traitIndex>-1&&($scope.traits.addEditTraits.traitsArray[traitIndex].data=traitsGroup.traits[key].data)},$scope.saveGroupConfigs=function(){$scope.traits.addEditTraits.matchStrategy=angular.copy($scope.groupConfigs.matchStrategy),$scope.traits.addEditTraits.scoreThreshold=angular.copy($scope.groupConfigs.scoreThreshold),$scope.traits.addEditTraits.algo=angular.copy($scope.groupConfigs.algo),$scope.traits.addEditTraits.configuration=angular.copy($scope.groupConfigs.configuration),$(".modalSliderContainer").click()},$scope.cancleGroupConfigs=function(){$scope.groupConfigs.matchStrategy=$scope.traits.addEditTraits.matchStrategy||"probability",s1.bootstrapSlider("setValue",$scope.traits.addEditTraits.scoreThreshold||.5),$scope.traits.addEditTraits.configuration||($scope.traits.addEditTraits.configuration=angular.copy($scope.defaultGroupConfigs.configuration)),$scope.groupConfigs.configuration=angular.copy($scope.traits.addEditTraits.configuration)||angular.copy($scope.defaultGroupConfigs.configuration),"skip_gram"===$scope.traits.addEditTraits.algo&&($scope.groupConfigs.algo="skip_gram",s2.bootstrapSlider("setValue",$scope.traits.addEditTraits.configuration.skip_gram.seqLength||2),s3.bootstrapSlider("setValue",$scope.traits.addEditTraits.configuration.skip_gram.maxSkipDistance||1)),"n_gram"===$scope.traits.addEditTraits.algo&&($scope.groupConfigs.algo="n_gram",s4.bootstrapSlider("setValue",$scope.traits.addEditTraits.configuration.n_gram.maxVal||1)),$(".modalSliderContainer").click()},$scope.toggleAcc=function(){$scope.traits.addEditTraits.newTrait=""},$scope.enableTraitNameEdit=function(status,traitIndex,trait,key){status.contentEditable=!0,setTimeout(function(){var id="#traitEditableSpan"+traitIndex;$(id).val(trait||key),$(id).focus()},200)},$scope.checkForSecialChar=function(string,allowNegation){var characters=/[\=\`\~\!@#\$\%\^&\*\(\)\-\+\{\}\:"\[\];\',\.\/<>\?\|\\]+/;if(allowNegation&&/[!]/.test(string)){if(string&&"!"!==string[0])return NotificationService.notify(i18n.i18nString("negations_traits"),"error"),!0;if(characters=/[\=\`\~\@#\$\%\^&\*\(\)\-\+\{\}\:"\[\];\',\.\/<>\?\|\\]+/,string&&"!"==string[0]){var testStringNeagtion=angular.copy(string);if(testStringNeagtion=testStringNeagtion.slice(1,string.length),/[!]/.test(testStringNeagtion))return NotificationService.notify(i18n.i18nString("negations_traits"),"error"),!0}if(string&&"!"==string[0]&&1==string.length)return NotificationService.notify(i18n.i18nString("trait_name"),"error"),!0}return characters.test(string)?(NotificationService.notify(i18n.i18nString("trait_name"),"error"),!0):characters.test(string)},$scope.updateTraitName=function(e,key,traitIndex,status){var newTraitkey="";if(e&&13==e.keyCode){if(newTraitkey=angular.copy(e.currentTarget.value),_constants_.checkForSecialChar(newTraitkey,!0,"trait"))return!1;if($scope.traits.addEditTraits.traitsArray[traitIndex].key!==newTraitkey&&$scope.traits.addEditTraits.traits[newTraitkey])return NotificationService.notify(i18n.i18nString("trait_dup_noty_err"),"error"),!1;var displayName=e.currentTarget.value;$scope.traits.addEditTraits.traitsArray[traitIndex].key=newTraitkey,$scope.traits.addEditTraits.traitsArray[traitIndex].displayName=displayName,$scope.traits.addEditTraits.traits[newTraitkey]=angular.copy($scope.traits.addEditTraits.traits[key]),newTraitkey!=key&&delete $scope.traits.addEditTraits.traits[key],$scope.traits.addEditTraits.traits[newTraitkey].key=newTraitkey,$scope.traits.addEditTraits.traits[newTraitkey].displayName=displayName,status.contentEditable=!1}},$scope.searchTraits=function(searchKey){$scope.traits.search=searchKey,$scope.gSearch?$scope.gSearch.search=searchKey:($scope.gSearch={},$scope.gSearch.search=searchKey)},$scope.callBack&&"KG"==$scope.callBack.type&&($scope.callBack.createNewTraits=$scope.createNewTraits,$scope.callBack.traitSearch=$scope.searchTraits,$scope.callBack.updateGroupViewForGK()),$scope.openManageIntentTraitRules=function(){return dummy_traitAnd=[],$scope.dummyTraitOrCondition=[],$scope.traitMappings={},$scope.traitMappings.selectedIntent="",$scope.traitMappings.traitRules=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.urlValidation=!1,$scope.traitRules={},$scope._botComponents.length?($scope.showMaptraitsSlider=!0,void $scope.modalSlider.open("#mapTraitsToIntents")):(NotificationService.notify(i18n.i18nString("please_create_a_dialog_intents_tomap_traits"),"error"),!1)},$scope.closeManageIntentTraitRules=function(){dummy_traitAnd=[],$scope.dummyTraitOrCondition=[],$scope.traitMappings={},$scope.traitMappings.selectedIntent="",$scope.traitMappings.traitRules=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.urlValidation=!1,$scope.traitRules={},$scope.showMaptraitsSlider=!1,$scope.modalSlider.close("#mapTraitsToIntents")};var dummy_traitAnd=[];$scope.dummyTraitOrCondition=[],$scope.traitMappings={},$scope.traitMappings.selectedIntent="",$scope.traitMappings.traitRules=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.urlValidation=!1,$scope.traitRules={},$scope.closeIconDark=$scope.assetsBase+"icons/closeIconDark.svg",$scope.orIcon=$scope.assetsBase+"icons/orIcon.svg",$scope.minusCircle=$scope.assetsBase+"icons/minus-circle.svg",$scope.loadTags=function(query){return $timeout("!"==query[0]?function(){return $scope.allTraitsNegations.filter(function(traitName){return traitName.startsWith(query)})}:function(){return $filter("filter")($scope.allTraits,query)})},$scope.selectIntent=function(intentid){if($scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.preparingRules=!0,intentid){var intent=_.find($scope._botComponents,{_id:intentid});intent&&($scope.traitMappings.traitRules=angular.copy(intent.traitRules)||[])}$scope.preparingRules=!1},$scope.mapTraitsForComponent=function(){if(!$scope.traitMappings.selectedIntent)return NotificationService.notify(i18n.i18nString("please_selecr_intent_to_map_traits"),"error"),!1;$scope.savingInProgress=!0;var payload={traitRules:[]};$.each($scope.traitMappings.traitRules,function(i,eachRule){(eachRule.length>1||1==eachRule.length&&eachRule[0])&&payload.traitRules.push(eachRule)}),BTFlowtaskService.updateComponentTraits($scope.stream._id,$scope.traitMappings.selectedIntent,payload).then(function(res){mixpanelEvent("createRuleTraits"),NotificationService.notify(i18n.i18nString("rules_updated_sucess_noty"),"success"),$scope.closeManageIntentTraitRules(),$scope.savingInProgress=!1,fetchBotComponentsByType()},function(err){$scope.savingInProgress=!1,NotificationService.notify(i18n.i18nString("fail_traits"),"error")})},$scope.addTraitDummyAndCondition=function(index){$timeout(function(){var condition=$scope.dummyTraitOrCondition[index];if(!condition[0])return!1;var trait=angular.copy(condition[0]),mappings={traitRules:[]},andCondition=[];mappings.traitRules=angular.copy($scope.traitMappings.traitRules)||[],andCondition.push(trait),mappings.traitRules.push(andCondition),$scope.traitMappings.traitRules=mappings.traitRules,$scope.dummyTraitOrCondition.length>1?$scope.dummyTraitOrCondition.splice(index,1):1==$scope.dummyTraitOrCondition.length&&($scope.dummyTraitOrCondition=[],$timeout(function(){$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$("#addTraitRules"+($scope.traitMappings.traitRules.length-1))&&$("#addTraitRules"+($scope.traitMappings.traitRules.length-1)).find(".input")&&$("#addTraitRules"+($scope.traitMappings.traitRules.length-1)).find(".input").length&&$("#addTraitRules"+($scope.traitMappings.traitRules.length-1)).find(".input")[0].focus()},300))},700)},$scope.deleteOrRule=function(orIndex){var mappings={traitRules:[]};mappings.traitRules=angular.copy($scope.traitMappings.traitRules)||[],mappings.traitRules.splice(orIndex,1),$scope.traitMappings.traitRules=mappings.traitRules},$scope.addOrDummy=function(){$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd))},$scope.clearSearch=function(){$timeout(function(){$scope.traits.search="",$scope.gSearch?$scope.gSearch.search="":($scope.gSearch={},$scope.gSearch.search="")},150)},$scope.expandTags=function(e){var _element=e.currentTarget;$(_element).css({display:"none"});var _elements=$(_element).parent().find(".utteranceTag"),filteredElements=_.filter(_elements,function(e,i){return!$(e).is(":visible")});_.map(filteredElements,function(element){$(element).css({display:"block"})})},$scope.clearTraitSearch=function(){$scope.search.traitSearch=""},fetchBotComponentsByType(),$scope.getTemplateUrl=function(){return $scope.templateUrl?$scope.templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-traits/bt-traits.html"},$scope.cb&&($scope.cb.createNewTraits=$scope.createNewTraits)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _component=angular.module("bt-forms");_component.controller("BTChangePasswordCtrl",["$scope","$timeout","$rootScope","NotificationService","AuthService","$window","$workflowService","form_util","$applicationService","$modal","$modalInstance","config","$translator","i18n","localstore",function($scope,$timeout,$rootScope,NotificationService,AuthService,$window,$workflowService,form_util,$applicationService,$modal,$modalInstance,config,$translator,i18n,localstore){function getPasswordPolicy(emailId){var url="mp.user.pwdPolicy",params={emailId:emailId};$translator.translate(url,params,{}).then(function(response){if(response.data){var hintText=i18n.i18nString("yourPasswordContain"),pattern="^",charstoAllow='[A-Za-z\\d=`~!@#$%^&*._:"\\(\\)\\-+{}:"\\[\\]\';\\\\,\\/<>?|]';response.data.hasOwnProperty("pwdMinLength")&&(hintText+=i18n.i18nString("atleast_char",{dyn:response.data.pwdMinLength})),response.data.hasOwnProperty("pwdMinAlphabets")&&response.data.pwdMinAlphabets>0&&(hintText=hintText+", "+i18n.i18nString("contain_alpha",{dyn:response.data.pwdMinAlphabets}),pattern+="(?=.*[A-Za-z])"),response.data.hasOwnProperty("pwdMinNumericValues")&&response.data.pwdMinNumericValues>0&&(hintText=hintText+", "+i18n.i18nString("contain_numeric",{dyn:response.data.pwdMinNumericValues}),pattern+="(?=.*\\d)"),response.data.hasOwnProperty("pwdMinSpecicalChars")&&response.data.pwdMinSpecicalChars>0&&(hintText=hintText+", "+i18n.i18nString("contain_special",{dyn:response.data.pwdMinSpecicalChars}),pattern+="(?=.*[=`~!@#$%^&*._:\"\\(\\)\\-+{}\\[\\]';\\\\,\\/<>?|])"),response.data.hasOwnProperty("pwdMinLowercase")&&response.data.pwdMinLowercase>0&&(hintText=hintText+", "+i18n.i18nString("contain_lower",{dyn:response.data.pwdMinLowercase}),pattern+="(?=.*[a-z])"),response.data.hasOwnProperty("pwdMinUppercase")&&response.data.pwdMinUppercase>0&&(hintText=hintText+", "+i18n.i18nString("contain_upper",{dyn:response.data.pwdMinUppercase}),pattern+="(?=.*[A-Z])"),pattern=pattern+charstoAllow+"{"+response.data.pwdMinLength+","+response.data.pwdMaxLength+"}$",hintText+=".",$scope.passwordPolicy={pattern:pattern,hintText:hintText,minLength:response.data.pwdMinLength||6,maxLength:response.data.pwdMaxLength||256}}})}$scope.passwordPolicy={hintText:i18n.i18nString("password_policy"),pattern:"^",minLength:8,maxLength:256},$scope.cancelPwdReset=function(){$modalInstance.close()},config&&config.userInfo&&($scope.mailID=config.userInfo,$scope.userProfile={emailId:$scope.mailID});var passwordExpired=localstore.getAuthData();$scope.resetPwd=function(){"undefined"==typeof passwordExpired?($scope.payload={emailId:$scope.userProfile.emailId,newPassword:$scope.changePasswordForm.newpwd.$modelValue,oldPassword:$scope.changePasswordForm.oldpwd.$modelValue},AuthService.changePasswordByPolicy($scope.payload).then(function(res){NotificationService.notify(i18n.i18nString("pwd_changed"),"success"),$timeout(function(){$modalInstance.close()},500)},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||err&&err.data||i18n.i18nString("pwd_notupdated");NotificationService.notify(errMsg,"error"),(err&&err.data&&err.data.errors&&44===err.data.errors[0].code||err&&429===err.status)&&$modalInstance.close()})):($scope.saving=!0,$scope.payload={emailId:$scope.userProfile.emailId,newPassword:$scope.changePasswordForm.newpwd.$modelValue,oldPassword:$scope.changePasswordForm.oldpwd.$modelValue},AuthService.changePassword($scope.payload).then(function(res){NotificationService.notify(i18n.i18nString("pwd_changed"),"success"),$timeout(function(){$modalInstance.close()},500),$scope.saving=!1},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("pwd_notupdated");err&&err.data&&err.data.errors&&42===err.data.errors[0].code?NotificationService.notify("New password should be different from your last five passwords","error"):NotificationService.notify(errMsg,"error"),err&&err.data&&err.data.errors&&44===err.data.errors[0].code&&$modalInstance.close(),$scope.saving=!1}))},config&&config.userInfo?($scope.mailID=config.userInfo,$scope.userProfile={emailId:$scope.mailID}):$scope.userProfile=$applicationService.userInfo().koreUserInfo,getPasswordPolicy($scope.userProfile.emailId),$scope.returnFalse=function(){return!1}}])}(angular),function(ng){var _userProfile=ng.module("bt-forms");_userProfile.directive("profile",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-user-profile/profile.html",controller:"profileCtrl"}}),_userProfile.controller("profileCtrl",["$scope","env_conf","$timeout","$rootScope","NotificationService","AuthService","BTFileUploadService","$window","form_util","$applicationService","$modal","$translator","$workflowService","i18n",function($scope,env_conf,$timeout,$rootScope,NotificationService,AuthService,BTFileUploadService,$window,form_util,$applicationService,$modal,$translator,$workflowService,i18n){function checkIdStatus(){var url="mp.user.checkIdStatus",params={};$scope.userProfile.hasOwnProperty("emailId")&&(params.emailId=$scope.userProfile.emailId),$translator.translate(url,{},params).then(function(response){response.data.hasOwnProperty("idp")?$scope.showChangePassword=!1:$scope.showChangePassword=!0},function(response){NotificationService.notify(response,!0)})}$scope.userProfile=angular.copy($applicationService.userInfo().koreUserInfo),$scope.arrowGray=env_conf["context-url"]+"/assets/icons/arrowGray.svg",$scope.starOrangeIcon=env_conf["context-url"]+"/assets/icons/starOrangeIcon.svg",$scope.starGrayIcon=env_conf["context-url"]+"/assets/icons/starGrayIcon.svg",$scope.createPlaceholder=env_conf["context-url"]+"/assets/images/createPlaceholder.svg",$scope.lockGreen=env_conf["context-url"]+"/assets/icons/lockGreen.svg",$scope.showChangePassword=!1,$scope.context_url=env_conf["context-url"],$scope.charRemaining=i18n.i18nString("Generalform_charlimit"),$scope.selectedAccount=$workflowService.selectedAccount(),$scope.iconObj={},$scope.rolesList=[{name:"Architect",value:"Architect"},{name:"Business Analyst",value:"Business Analyst"},{name:"Business Owner",value:"Business Owner"},{name:"Contact Center Agent",value:"Contact Center Agent"},{name:"Contact Center Manager",value:"Contact Center Manager"},{name:"Conversation Designer",value:"Conversation Designer"},{name:"Customer Success Agent",value:"Customer Success Agent"},{name:"CXO",value:"CXO"},{name:"Data Scientist",value:"Data Scientist"},{name:"DevOps Engineer",value:"DevOps Engineer"},{name:"Engineer",value:"Engineer"},{name:"Executive",value:"Executive"},{name:"Head of Department",value:"Head of Department"},{name:"Linguistic Expert",value:"Linguistic Expert"},{name:"Product Manager",value:"Product Manager"},{name:"Product Owner",value:"Product Owner"},{name:"Project Manager",value:"Project Manager"},{name:"Subject Matter Expert",value:"Subject Matter Expert"},{name:"Team Leader",value:"Team Leader"},{name:"Quality Analyst",value:"Quality Analyst"},{name:"Others",value:"Others"}],$scope.departmentList=[{name:"Customer Support",value:"Customer Support"},{name:"Engineering",value:"Engineering"},{name:"Finance",value:"Finance"},{name:"General Administration",value:"General Administration"},{name:"HR & Legal",
value:"HR & Legal"},{name:"IT & Support",value:"IT & Support"},{name:"Marketing",value:"Marketing"},{name:"Operations",value:"Operations"},{name:"Product and Design",value:"Product and Design"},{name:"Sales and Account Management",value:"Sales and Account Management"},{name:"Others",value:"Others"}],$scope.searchRole="",$scope.searchDept="",$scope.validations={invalidFirstName:!1,invalidLastName:!1,invalidAccountName:!1,invalidTitle:!1},$scope.checkValidations=function(type,string){var format1=/[~!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/,format2=/(www|http|https)/;format1.test(string)||format2.test(string)?"firstName"==type?$scope.validations.invalidFirstName=!0:"lastName"==type?$scope.validations.invalidLastName=!0:"dept"==type?$scope.validations.invalidDepartment=!0:"Title"==type?$scope.validations.invalidTitle=!0:$scope.validations.invalidAccountName=!0:"firstName"==type?$scope.validations.invalidFirstName=!1:"lastName"==type?$scope.validations.invalidLastName=!1:"dept"==type?$scope.validations.invalidDepartment=!1:"Title"==type?$scope.validations.invalidTitle=!1:$scope.validations.invalidAccountName=!1},$scope.changePassword=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-user-profile/bt-change-password.html",controller:"BTChangePasswordCtrl",windowClass:"modal-kr changePwdLogin",resolve:{config:function(){return{userInfo:$scope.userProfile.emailId||{}}}}})};var emailID=$scope.userProfile.emailId,domainName=emailID.split("@");$scope.userProfile.companyName=domainName[1],$scope.userProfile.accountName=$scope.selectedAccount.accountName,$scope.sendProfileData=function(isValid,form){return isValid?void($scope.validations.invalidFirstName||$scope.validations.invalidLastName||($scope.payload={personalInfo:{hometown:"",timeZone:"",lastName:$scope.userProfileform.lastName.$modelValue,middleName:"",firstName:$scope.userProfileform.firstName.$modelValue},accountInfo:{dept:$scope.userProfile.dept,profColour:"",profImage:$scope.userProfile.profImage?$scope.userProfile.profImage:"no-avatar",jTitle:$scope.userProfile.jTitle},additionalFields:[{key:"company",value:$scope.userProfileform.companyName.$modelValue}]},$scope.userProfile.accountName&&($scope.payload.accountInfo.accountName=($scope.userProfile.accountName||"").replace(/[^a-zA-Z0-9]/g," ")),AuthService.profileUpdate($scope.payload).then(function(res){$scope.userProfile.lName=$scope.userProfileform.lastName.$modelValue,$scope.userProfile.fName=$scope.userProfileform.firstName.$modelValue,$scope.userProfile.lastName=$scope.userProfileform.lastName.$modelValue,$scope.userProfile.firstName=$scope.userProfileform.firstName.$modelValue;var _usrInfo=$applicationService.userInfo();_usrInfo.koreUserInfo=$scope.userProfile,$applicationService.userInfo(_usrInfo),$rootScope.koreUserInfo=$scope.userProfile,NotificationService.notify(i18n.i18nString("personal_details_saved"),"success"),$scope.closeProfile(),$scope.userProfile.accountName&&($scope.selectedAccount.accountName=$scope.userProfile.accountName,$scope.selectedAccount.displayName=$scope.userProfile.accountName,$rootScope.$emit("selectedAccountUpdate",$scope.selectedAccount))},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("save_Failed");NotificationService.notify(errMsg,"error")}))):void form_util.touch(form)},$scope.closeProfileModal=function(){$rootScope.$emit("onUserprofileClose"),$scope.$broadcast("botIconUpdate",$rootScope.profileImgLinkPrefix)},$scope.changePic=function(userProfile){return $scope.iconObj.profileUploading?void NotificationService.notify("Profile upload is in progress","error"):($timeout(function(){$("#profileFile").val(""),$("#profileFile").click()},0),void userProfile.$setDirty())},$scope.loadingProfilePic=!1,$scope.uploadStreamProfile=function(){if($scope.loadingProfilePic=!0,$scope.newStreamData.profileFile.name){var _ext=$scope.newStreamData.profileFile.name.substring($scope.newStreamData.profileFile.name.lastIndexOf("."));if(".png"!==_ext&&".PNG"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),$scope.fileExtensionError=!0,void($scope.loadingProfilePic=!1)}$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.profileFile),data.append("fileContext","profile"),data.append("fileExtension","png"),$scope.iconObj.profileUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.profileFile.name,fileId:response.data.fileId};$scope.newStreamData.profile=fileUploaded,$rootScope.profileImgLinkPrefix=-1===$rootScope.profileImgLinkPrefix.indexOf("?")?$rootScope.profileImgLinkPrefix+"?v=1.1"+$rootScope.profileImgLinkPrefix+1e3*Math.random():$rootScope.profileImgLinkPrefix+1e3*Math.random(),$scope.userProfile.profImage="profile.png",$rootScope.koreUserInfo.profImage=$scope.userProfile.profImage,NotificationService.notify(i18n.i18nString("filename_Upload",{fileName:fileUploaded.fileName}),"success"),setTimeout(function(){$scope.loadingProfilePic=!1},1500),setTimeout(function(){$scope.iconObj.profileUploading=!1},700),$scope.$emit("botIconUpdate",$rootScope.profileImgLinkPrefix)},function(response){NotificationService.notify("Oops! "+response.data.errors[0].msg,"error"),$scope.loadingProfilePic=!1,$scope.iconObj.profileUploading=!1})},$scope.getProfile=function(){return $rootScope.profileImgLinkPrefix},$scope.deleteStreamProfile=function(userProfile){$scope.newStreamData&&($scope.newStreamData.profileFile=null,$scope.newStreamData.profile=null),$scope.userProfile.profImage="no-avatar",$scope.$emit("botIconUpdate","no-avatar"),$("#profileFile").val(""),userProfile.$dirty=!0},$scope.getDisplayName=function(type){var findVal;return"role"===type?findVal=$scope.rolesList.filter(function(item){return item.value===$scope.userProfile.jTitle})[0]:"dept"===type&&(findVal=$scope.departmentList.filter(function(item){return item.value===$scope.userProfile.dept})[0]),findVal?findVal.name:void 0},$scope.updateScroll=function(scrollEle){$timeout(function(){PerfectScrollbar.update($(scrollEle)[0])},100)},$scope.changeRole=function(role){$scope.userProfile.jTitle=role,$scope.userProfileform.$dirty=!0},$scope.changeDepartment=function(dept){$scope.userProfile.dept=dept,$scope.userProfileform.$dirty=!0},$scope.closeProfile=function(){$scope.closeModalSlider("#profileModal"),$scope.$emit("botIconUpdate",$rootScope.profileImgLinkPrefix)},checkIdStatus()}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.controller("BTWelcomeForm",["$scope","$translator","$modalInstance","config","$filter","$rootScope","$routeParams","$timeout","$location","$applicationService","scriptLoader","env_conf","security","$workflowService","AuthService","interactiveHelp","localstore","i18n","mixPanel","BTStreamsService","BTProcessAppDataService","$q","jsEvents",function($scope,$translator,$modalInstance,config,$filter,$rootScope,$routeParams,$timeout,$location,$applicationService,scriptLoader,env_conf,security,$workflowService,AuthService,interactiveHelp,localstore,i18n,mixPanel,BTStreamsService,BTProcessAppDataService,$q,jsEvents){function scrollToEle(element){var _PanelEle=$(element);if(_PanelEle){var _container=_PanelEle.closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=_PanelEle.offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"slow")}}}function cancle(){}function resumeOnboard(){var stepContent=angular.copy($scope.stepContent[$scope.resumeOboard.guideID]);$scope.selectedGuideId=$scope.resumeOboard.guideID,$.each(stepContent,function(i,step){i<$scope.resumeOboard.stepLoaded+1&&(step.stepActive=!1,step.stepLoaded=!1),i==$scope.resumeOboard.stepLoaded+1&&(step.stepActive=!0,step.stepLoaded=!1)}),$scope.resumeOboard.stepLoaded==stepContent.length-1&&(stepContent[stepContent.length-1].stepActive=!0,stepContent[stepContent.length-1].stepLoaded=!1),$scope.selectedGuide=angular.copy(stepContent),$scope.guideStep=2,$(".guideBody").scrollTop(0)}$scope.config=config,$scope.installationStatus=null,$scope.sharedBots=[],$scope.checkingForInvitations=!0,$scope.showImage=!0,$scope.showBotsCount=3,$scope.currentStepIndex=0,$scope.userInvitedBot=null,$scope.invitedBot=null,$scope.currentSharedBot=null,$scope.userAccounts=[];var onBoardingFlow={};$scope.config&&$scope.config.component&&$scope.config.component.guideId?(localStorage.removeItem("koreOnBoardingProgress"),$scope.guideStep=2):($scope.guideStep=1,$modalInstance.opened.then(function(result){$("body").addClass("bt-welcome-modal-open")}),$modalInstance.result.then(function(result){$("body").removeClass("bt-welcome-modal-open")})),$scope.showVideoModal=function(id){$scope.currentModal="video",$("body").addClass("videoPlayerOpened")},$scope.showVideoModal(),$scope.resumeOboard=JSON.parse(localStorage.getItem("koreOnBoardingProgress")),$scope.BuilderContextUrl=env_conf["context-url"],$scope.koreUserInfo=$applicationService.userInfo().koreUserInfo;var _userInfo=$applicationService.userInfo();$scope.userInfo=_userInfo,$scope.accounts=_userInfo.appControls.associatedAccounts,$scope.assectBase=env_conf["assets-url"],$scope.videoBG=env_conf["assets-url"]+"images/videoBG.png",$scope.backArrow=env_conf["context-url"]+"/assets/landingImages/backArrow.svg",$scope.learn=env_conf["context-url"]+"/assets/onboarding/learn.svg",$scope.started=env_conf["context-url"]+"/assets/onboarding/started.svg",$scope.noboardOne=env_conf["context-url"]+"/assets/onboarding/noboardBTN-1.svg",$scope.noboardTwo=env_conf["context-url"]+"/assets/onboarding/noboardBTN-2.svg",$scope.help=env_conf["context-url"]+"/assets/onboarding/help.svg",$scope.vaImg=env_conf["context-url"]+"/assets/login/va.png",$scope.paImg=env_conf["context-url"]+"/assets/login/pa.png",$scope.vaIcon=env_conf["context-url"]+"/assets/login/vaIcon.png",$scope.paIcon=env_conf["context-url"]+"/assets/login/paIcon.png",$scope.vaMain=env_conf["context-url"]+"/assets/login/helpSlider/va-main.svg",$scope.vaOne=env_conf["context-url"]+"/assets/login/helpSlider/va-1.svg",$scope.vaTwo=env_conf["context-url"]+"/assets/login/helpSlider/va-2.svg",$scope.vathree=env_conf["context-url"]+"/assets/login/helpSlider/va-3.svg",$scope.vaFour=env_conf["context-url"]+"/assets/login/helpSlider/va-4.svg",$scope.paMain=env_conf["context-url"]+"/assets/login/helpSlider/pa-main.svg",$scope.paOne=env_conf["context-url"]+"/assets/login/helpSlider/pa-1.svg",$scope.paTwo=env_conf["context-url"]+"/assets/login/helpSlider/pa-2.svg",$scope.pathree=env_conf["context-url"]+"/assets/login/helpSlider/pa-3.svg",$scope.paFour=env_conf["context-url"]+"/assets/login/helpSlider/pa-4.svg",$scope.btLoader=env_conf["context-url"]+"/assets/loader.svg",$scope.playBtn=env_conf["context-url"]+"/assets/icons/PlayBtn.svg",$scope.botTypeObj={VA:i18n.i18nString("virtual_assistant_label"),PA:i18n.i18nString("process_app")},$scope.botType="",$scope.userProfile=angular.copy($applicationService.userInfo().koreUserInfo),$scope.userProfile.jTitle="",$scope.userProfile.dept="",$scope.userProfile.industry="",$scope.userProfile.others="",$scope.rolesList=[{name:"Architect",value:"Architect"},{name:"Business Analyst",value:"Business Analyst"},{name:"Business Owner",value:"Business Owner"},{name:"Contact Center Agent",value:"Contact Center Agent"},{name:"Contact Center Manager",value:"Contact Center Manager"},{name:"Conversation Designer",value:"Conversation Designer"},{name:"Customer Success Agent",value:"Customer Success Agent"},{name:"CXO",value:"CXO"},{name:"Data Scientist",value:"Data Scientist"},{name:"DevOps Engineer",value:"DevOps Engineer"},{name:"Engineer",value:"Engineer"},{name:"Executive",value:"Executive"},{name:"Head of Department",value:"Head of Department"},{name:"Linguistic Expert",value:"Linguistic Expert"},{name:"Product Manager",value:"Product Manager"},{name:"Product Owner",value:"Product Owner"},{name:"Project Manager",value:"Project Manager"},{name:"Subject Matter Expert",value:"Subject Matter Expert"},{name:"Team Leader",value:"Team Leader"},{name:"Quality Analyst",value:"Quality Analyst"},{name:"Others",value:"Others"}],$scope.departmentList=[{name:"Customer Support",value:"Customer Support"},{name:"Engineering",value:"Engineering"},{name:"Finance",value:"Finance"},{name:"General Administration",value:"General Administration"},{name:"HR & Legal",value:"HR & Legal"},{name:"IT & Support",value:"IT & Support"},{name:"Marketing",value:"Marketing"},{name:"Operations",value:"Operations"},{name:"Product and Design",value:"Product and Design"},{name:"Sales and Account Management",value:"Sales and Account Management"},{name:"Others",value:"Others"}],$scope.industryList=[{name:"Banking, Financial Services and Insurance",value:"Banking, Financial Services and Insurance"},{name:"E-Commerce",value:"E-Commerce"},{name:"Energy",value:"Energy"},{name:"Healthcare",value:"Healthcare"},{name:"Hospitality",value:"Hospitality"},{name:"IT Services",value:"IT Services"},{name:"Manufacturing",value:"Manufacturing"},{name:"Media, Advertising and Entertainment",value:"Media, Advertising and Entertainment"},{name:"Real Estate",value:"Real Estate"},{name:"Supply Chain and Logistics",value:"Supply Chain and Logistics"},{name:"Telecommunications",value:"Telecommunications"},{name:"Travel and Tourism",value:"Travel and Tourism"},{name:"Others",value:"others"}];$rootScope.$on("processAppCreationStatus",function(ev,payload){"success"===payload?$scope.appCreated($scope.views.product):($scope.initializeCreateBot=!1,$scope.showCreationDropdown=!1)});$scope.onCreateNewBot=function(payload){if(payload&&"PA"===$scope.views.product){var appPayload={name:payload.name,description:payload.description||"",icon:payload.icon.fileId};jsEvents.postMessageToChildIframes("createApp","#processFlowsFrame",appPayload)}else{$scope.initializeCreateBot=!1;var stream=$workflowService.selectedStream();$rootScope.$broadcast("loadBots",stream),$scope.appCreated($scope.views.product)}},$scope.showCreationDropdown=!1,$scope.onCancelBotCreation=function(){$scope.initializeCreateBot=!1,$scope.showCreationDropdown=!1},$scope.welcomeForm=!0,$rootScope.$on("onAccountsUpdate",function(ev,paylod){$scope.accounts.push(paylod)}),$scope.checkForAccounts=function(){var _selectetedAccount=$workflowService.selectedAccount()||localstore.getSelectedAccount();if(_userInfo.appControls&&_userInfo.appControls.associatedAccounts&&_userInfo.appControls.associatedAccounts.length){_userInfo.appControls.associatedAccounts=_.filter(_userInfo.appControls.associatedAccounts,function(account){return account.isDeveloper||!1}),$scope.defaultAccountId=_userInfo.appControls.defaultAccountId||"",_selectetedAccount=_userInfo.appControls.associatedAccounts[0];var _selfAccount=_.find(_userInfo.appControls.associatedAccounts,function(account){return account.self});_selfAccount&&(_selectetedAccount=_selfAccount);var _defaultAccountId=_.find(_userInfo.appControls.associatedAccounts,function(account){return $scope.defaultAccountId===account.accountId});_defaultAccountId&&(_selectetedAccount=_defaultAccountId);var _chosenAccount=_.find(_userInfo.appControls.associatedAccounts,function(account){return _userInfo.appControls.chosenAccountId===account.accountId});_chosenAccount&&(_selectetedAccount=_chosenAccount);var _fromSelection=localstore.getSelectedAccount();if(_fromSelection){var accountFound=_.find(_userInfo.appControls.associatedAccounts,{accountId:_fromSelection.accountId});accountFound&&(_selectetedAccount=accountFound)}}$scope.selectedAccount=_selectetedAccount},$scope.checkForUserInvitedBot=function(){$scope.selectedAccount=$scope.selectedAccount||$workflowService.selectedAccount()||localstore.getSelectedAccount(),console.log("checking invitations");var invitedBotId=localStorage.getItem("invitedBot");invitedBotId&&"undefined"!==invitedBotId&&"null"!==invitedBotId?$scope.userInvitedBot=invitedBotId:$scope.userInvitedBot=null},$scope.selectAccount=function(account){if(account.hasOwnProperty("idp")){var dataobject={};dataobject.username=$applicationService.userInfo().appControls.userInfo.emailId,dataobject.idp=account.idp,account.client_email=$applicationService.userInfo().appControls.userInfo.emailId,localStorage.setItem("selectedSSOAccount",JSON.stringify(account)),security.handleSSORedirect(dataobject,"direct")}else localStorage.removeItem("selectedSSOAccount"),localstore.setSelectedAccount(account),window.location.reload()},$scope.closeOptionsModal=function(){$scope.currentModal="",$("body").removeClass("videoPlayerOpened"),$scope.showCreationDropdown=!1},$scope.switchAccount=function(account){$scope.config.component&&$scope.config.component.selectAccount&&$scope.config.component.selectAccount(account)},$scope.getStreamsData=function(){$scope.checkForUserInvitedBot(),$scope.checkForAccounts(),$scope.selectedAccount=$scope.selectedAccount||$workflowService.selectedAccount()||localstore.getSelectedAccount(),$scope.sharedBots=[],$workflowService.selectedAccount()||$workflowService.selectedAccount($scope.selectedAccount);var _apps=[];$scope.loadingStreams=!0,$q.all([BTStreamsService.getStreams(),BTProcessAppDataService.getProcessAppsData()]).then(function(res){var botsData=res[0].data;$.each(botsData,function(i,bot){bot.createdBy.id!==_userInfo.userId&&(bot.type="VA",$scope.userInvitedBot===bot._id?$scope.invitedBot=bot:_apps.push(bot))});var processApps=res[1].data.pfApplications;$.each(processApps,function(i,app){app.createdBy.userId!==_userInfo.userId&&(app.type="PA",$scope.userInvitedBot===app._id?$scope.invitedBot=bot:_apps.push(app))}),$scope.sharedBots=_apps,$scope.checkingForInvitations=!1,$scope.loadingStreams=!1},function(err){$scope.checkingForInvitations=!1,$scope.loadingStreams=!1})},$scope.getStreamsData(),$scope.selectBot=function(bot){if("PA"===bot.type)$("#koreProcessAppsTab").trigger("click"),setTimeout(function(){jsEvents.postMessageToChildIframes("selectProcessApp","#processFlowsFrame",bot._id),$scope.closeModal()},100);else{var eventInfo={Category:"Onboarding","Sub Category":"Invited Account",Level:"ONBOARDING AND ACTIVATION"};mixPanel.postEvent("User Onboarding - Bot Project Joined",eventInfo),$rootScope.$emit("selectOrChangeBot",bot),$scope.closeModal()}},$scope.navigateTo=function(to){var targetURL="";switch(to){case"botAdmin":targetURL=window.appConfig.BOT_ADMIN_URL;break;default:console.log("default")}if(targetURL){var _account=$workflowService.selectedAccount();_account&&_account.accountId&&(targetURL=targetURL+"?accountId="+_account.accountId),$window.open(targetURL,"_blank")}},$scope.exit=function(){$scope.selectedGuide={},$scope.currentElement={},$scope.currentStep={},$scope.currentStepIndex=0,$scope.config&&$scope.config.component&&$scope.config.component.guideId?$scope.closeModal():($scope.guideStep=1,$(".guideBody").scrollTop(0))},$scope.launchBotStore=function(){var targetURL=window.appConfig.MP_URL;$window.open(targetURL,"_blank")},$rootScope.logOut=function(){security.logout()},$scope.sampleTemplets={block:'<p>A bot is a <a href="">virtual assistant</a> that acts as an intelligent intermediary between people, digital systems and Internet-enabled things.</p>',image:'<img ng-src="{{dummyimgOne}}">',blockList:'<h6 class="subTitle">'+i18n.i18nString("weather_bot")+"</h6><ul><li> "+i18n.i18nString("configure_display")+"</li><li> "+i18n.i18nString("alert_display")+'</li></ul><div class="btn"> '+i18n.i18nString("get_started")+"</div>"},$scope.continueStepProcess=function(step,parentIndex){step.stepFunction?step.stepFunction():step.stepLoaded?$scope.nextStep(parentIndex):$timeout(function(){step.loadSteps=$scope.selectedGuide[$scope.currentStepIndex].loadSteps+1},100)},$scope.onButtonClick=function(stepIndex,buttonIndex,steps,parentIndex,button){var buttonEle="#button"+$scope.currentStep.stepId+$scope.currentStepRunning;$(buttonEle+buttonIndex).addClass("active"),buttonIndex?$(buttonEle+0).addClass("hide"):$(buttonEle+1).addClass("hide"),button&&("continue"==button.btnFunction?$scope.continueStepProcess(steps,parentIndex):"nextStep"==button.btnFunction?$scope.nextStep(parentIndex):"skipNext"==button.btnFunction?button.skipTo?(steps.stepLoaded=!0,$scope.selectedGuide[button.skipTo-1].stepNo="Step "+(parentIndex+2),$scope.nextStep(button.skipTo-1)):$scope.nextStep(parentIndex):"exit"==button.btnFunction?$scope.closeModal():"completeOnBoard"==button.btnFunction&&(mixPanel.postEvent("Onboarding Journey Completed"),$scope.closeModal()))},$scope.nextStep=function(index){$scope.currentStepIndex=angular.copy(index+1),$scope.selectedGuide[index].stepLoaded=!0,$scope.setUpdateLocalStorageForOnboarding($scope.selectedGuideId,$scope.currentParentStepIndex),index<$scope.selectedGuide.length-1&&($scope.selectedGuide[index].stepActive=!1,$scope.selectedGuide[index+1].stepActive=!0)},$scope.adjustScroll=function(i){var buttonEle=($(".guideBody"),"#button"+$scope.currentStep.stepId+$scope.currentStepRunning);scrollToEle($scope.currentElement),i==$scope.currentStep.stepContent[$scope.currentStepRunning].length&&($scope.currentStepRunning==$scope.currentStep.stepContent.length-1&&$timeout(function(){$scope.selectedGuide[$scope.currentStepIndex].stepLoaded=!0,$scope.setUpdateLocalStorageForOnboarding($scope.selectedGuideId,$scope.currentParentStepIndex),$scope.selectedGuide[$scope.currentStepIndex].hasBtnTemplets&&$("[data-get-started]").click(function(e){$scope.closeModal();var _getStartTo=$(e.currentTarget).attr("data-get-started");_getStartTo&&("CREATE_BOT_ALERT"===_getStartTo||"CREATE_BOT_DIALOG"===_getStartTo||"CREATE_BOT_KT"===_getStartTo)&&interactiveHelp.openHelp(_getStartTo)})},100),$timeout(function(){$(buttonEle).addClass("displayBlock"),scrollToEle(buttonEle)},1200))},$scope.selectProcessApps=function(){$("#koreProcessAppsTab").trigger("click"),$("html").removeClass("onBoardVideoMobileView"),$scope.startBotsWhatsNew()},$scope.startCreate=function(type){if(!onBoardingFlow.productInitiated){onBoardingFlow.productInitiated=!0;var eventInfo={Category:"Onboarding","Sub Category":"Welcome Message",Level:"ONBOARDING AND ACTIVATION","Product Initiated":"processApps"===type?"Process App":"Virtual Assistant"};mixPanel.postEvent("User Onboarding - Product Initiated",eventInfo)}if("processApps"===type){var eventInfoPA={Category:"Activation","Sub Category":"Activation - PA",Level:"ONBOARDING AND ACTIVATION","Product Initiated":"Process App"};mixPanel.postEvent("PA - Enter Process App tab",eventInfoPA),$scope.openBackDropModal("create","PA")}else if("bots"===type){var eventInfoBots={Category:"Activation","Sub Category":"Activation - VA",Level:"ONBOARDING AND ACTIVATION","Product Initiated":"Virtual Assistant"};mixPanel.postEvent("VA - Enter Virtual Assistants tab",eventInfoBots),$scope.openBackDropModal("create","VA")}},$scope.startFromScratch=function(type,botType){$scope.views={product:type,createApp:$scope.onCreateNewBot},$scope.showCreationDropdown&&botType===$scope.botType?($scope.botType=botType||"newBot",$scope.showCreationDropdown=!1):$scope.showCreationDropdown&&botType!==$scope.botType?$scope.botType=botType||"newBot":($scope.botType=botType||"newBot",$scope.showCreationDropdown=!$scope.showCreationDropdown)},$scope.appCreated=function(type){$("html").removeClass("onBoardVideoMobileView"),"PA"===type?$("#koreProcessAppsTab").trigger("click"):$rootScope.$emit("createNewBot"),$scope.closeModal()},$scope.openBackDropModal=function(id,product){$scope.currentModal=id,$scope.productId=product,$("body").removeClass("videoPlayerOpened"),"PA"===product?$scope.productSelected="Process-App":$scope.productSelected="Conversational-App"},$scope.initPlayer=function(){setTimeout(function(){try{var player=new Vimeo.Player("koreWelcomeVideo");player.on("play",function(){$scope.videoPlayed()})}catch(e){console.log("failed to load video scripts")}},100)},$scope.videoPlayed=function(){if(!onBoardingFlow.productVideoPlayed){onBoardingFlow.productVideoPlayed=!0;var eventInfo={Category:"Onboarding","Sub Category":"Welcome Message",Level:"ONBOARDING AND ACTIVATION"};mixPanel.postEvent("User Onboarding - Welcome Video played",eventInfo)}},$scope.changeRole=function(role){$scope.userProfile.jTitle=role},$scope.changeDepartment=function(dept){$scope.userProfile.dept=dept},$scope.changeIndustry=function(indus){$scope.userProfile.industry=indus},$scope.getDisplayName=function(type){var findVal;return"role"===type?findVal=$scope.rolesList.filter(function(item){return item.value===$scope.userProfile.jTitle})[0]:"dept"===type?findVal=$scope.departmentList.filter(function(item){return item.value===$scope.userProfile.dept})[0]:"industry"===type&&(findVal=$scope.industryList.filter(function(item){return item.value===$scope.userProfile.industry})[0]),findVal?findVal.name:void 0},$scope.updateScroll=function(scrollEle){$timeout(function(){PerfectScrollbar.update($(scrollEle)[0])},100)},$scope.sendProfileData=function(){if($scope.userProfile){var indusObj={key:"industry",value:$scope.userProfile.industry},findcompany=_.find($scope.userProfile.additionalFields,function(item){return"company"===item.key}),companyObj={};findcompany&&findcompany.value&&(companyObj={key:"company",value:findcompany.value}),"others"===$scope.userProfile.industry&&(indusObj.value=$scope.userProfile.others);var reqPayload={};reqPayload.additionalFields=[],companyObj&&companyObj.key&&reqPayload.additionalFields.push(companyObj),reqPayload.additionalFields.push(indusObj),reqPayload.accountInfo={},reqPayload.accountInfo.dept=$scope.userProfile.dept,reqPayload.accountInfo.profImage=$scope.userProfile.accountInfo.profImage,reqPayload.accountInfo.profColour=$scope.userProfile.accountInfo.profColour,reqPayload.accountInfo.jTitle=$scope.userProfile.jTitle,AuthService.profileUpdate(reqPayload).then(function(res){var eventInfo={Category:"Onboarding","Sub Category":"Welcome Message",Level:"ONBOARDING AND ACTIVATION","User Role":$scope.userProfile.jTitle,"User Industry":$scope.userProfile.industry,"User department":$scope.userProfile.dept||""};mixPanel.postEvent("User Onboarding - Details submitted",eventInfo);var _usrInfo=$applicationService.userInfo();_usrInfo.koreUserInfo=$scope.userProfile,$applicationService.userInfo(_usrInfo),$rootScope.koreUserInfo=$scope.userProfile,NotificationService.notify(i18n.i18nString("personal_details_saved"),"success"),$scope.closeOptionsModal()},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("save_Failed");NotificationService.notify(errMsg,"error")})}},$scope.isDetailsForm=function(){if(!$scope.userProfile)return!1;if($scope.userProfile.jTitle&&$scope.userProfile.dept&&$scope.userProfile.industry){if("others"!==$scope.userProfile.industry)return!0;if($scope.userProfile.others)return!0}},$scope.profileUpdateInprogress=!1,$scope.startBotsWhatsNew=function(skipModal){if(!$scope.profileUpdateInprogress){$scope.profileUpdateInprogress=!0;var payload={isBotsOnboarded:!0,enableTips:!1},enableTips=$applicationService.userInfo()&&$applicationService.userInfo().koreUserInfo.enableTips;AuthService.profileUpdate(payload).then(function(res){$scope.profileUpdateInprogress=!1,localStorage.removeItem("koreOnBoardingProgress"),$rootScope.koreUserInfo.isBotsOnboarded=!0,$rootScope.koreUserInfo.isBotsOnboarded=!0,$applicationService.userInfo()&&$applicationService.userInfo().koreUserInfo&&($applicationService.userInfo().koreUserInfo.enableTips=!1,$applicationService.userInfo().koreUserInfo.isBotsOnboarded=!0),skipModal||$timeout(enableTips?function(){interactiveHelp.openHelp("TAKE_TOUR"),$modalInstance.close(),$("body").removeClass("videoPlayerOpened")}:function(){$modalInstance.close(),$("body").removeClass("videoPlayerOpened")}),console.log(i18n.i18nString("update_board"))},function(err){$scope.profileUpdateInprogress=!1,console.error(i18n.i18nString("error_updating"))})}},$scope.instalationStatus=function(data){$scope.installationStatus&&$scope.installationStatus.status||($scope.installationStatus=JSON.parse(JSON.stringify(data)),$scope.$apply()),$rootScope.koreUserInfo.isBotsOnboarded||$scope.startBotsWhatsNew(!0)};$rootScope.$on("TemplateInstallationStatus",function(event,payload){$scope.instalationStatus(payload)}),$rootScope.$on("closeWelcomeModel",function(){$scope.closeModal()}),$rootScope.$on("botImportSuccess",function(){setTimeout(function(){$scope.closeModal()},200)});$scope.initToolTipts=function(){setTimeout(function(){$('[data-toggle="popover"]').popover({trigger:"hover"})},300)},$scope.closeModal=function(skip){$("html").removeClass("onBoardVideoMobileView"),$scope.startBotsWhatsNew()},$scope.cb={cbFunction:$scope.adjustScroll},$scope.attachPopover=function(id){$("#"+id).popover({html:!0,trigger:"hover",content:function(){return $("#"+id+"Content").html()}})},$scope.$on("importAppStatus",function(e,data){$scope.checkProcessImportStatus(data)}),$scope.checkProcessImportStatus=function(status){"success"===status?$scope.closeModal():"failed"===status&&($(".bt-welcome-modal").removeClass("hide"),$rootScope.$broadcast("selectDefaultBotScreen"))},$scope.runStep=function(steps,step,parentIndex,index){$scope.currentElement="#"+steps.stepId+index,$scope.currentStep=steps,$scope.currentParentStepIndex=parentIndex,$scope.currentStepRunning=index;var ele={};ele="#"+steps.stepId+index,$timeout(function(){$(ele).chatBubble({messages:steps.stepContent[index],typingSpeed:200,delay:20,cbFunction:$scope.adjustScroll})})};var imageInStep3="<div><p> "+i18n.i18nString("lifecycle")+'</p><img src="'+$scope.assectBase+'onboarding/botBuildLifeCycle.svg"></div>';"<div><p>"+i18n.i18nString("graphic_steps")+'</p><img src="'+$scope.assectBase+'onboarding/koreai_bots_platform.png"></div>';$scope.stepContent={learnBots:[{stepNo:"Step 1",stepId:"step1",stepDisc:i18n.i18nString("world_bots"),stepActive:!0,stepLoaded:!1,loadSteps:1,stepContent:[["<p> "+i18n.i18nString("virtual_assistant_desc")+" </p>","<p>"+i18n.i18nString("bots_replaceable")+"</p>","<p> "+i18n.i18nString("bots_interact")+" </p>"],["<p>"+i18n.i18nString("bots_intelligence")+" </p>","<p>"+i18n.i18nString("bots_engaging")+"</p>","<p>"+i18n.i18nString("bots_never_forget")+"</p>","<p>"+i18n.i18nString("bots_get_work")+"</p>","<p>"+i18n.i18nString("bots_seamlessly")+"</p>"],['<p><h6 class="subTitle">'+i18n.i18nString("customer_service")+"</h6> <br>"+i18n.i18nString("bot_provides")+"</p>",'<p><h6 class="subTitle">'+i18n.i18nString("banking_bot")+"</h6> <br>"+i18n.i18nString("bot_customers")+" </p>",'<p><h6 class="subTitle">'+i18n.i18nString("airline_bot")+"</h6> <br>"+i18n.i18nString("customers_bot")+"</p>"]],buttons:[[{text:i18n.i18nString("tell_more"),emoji:$scope.assectBase+"onboarding/emojies/blushing.png",btnFunction:"continue"},{text:i18n.i18nString("got_it"),emoji:"",btnFunction:"nextStep"}],[{text:i18n.i18nString("show_examples"),emoji:"",btnFunction:"continue"},{text:i18n.i18nString("got_it"),emoji:"",btnFunction:"nextStep"}],[{text:i18n.i18nString("lets_continue"),emoji:"",btnFunction:"nextStep"}]]},{stepNo:"Step 2",stepId:"step2",stepDisc:i18n.i18nString("brief_overview"),stepActive:!1,stepLoaded:!1,loadSteps:1,stepContent:[['<div><h6 class="subTitle">'+i18n.i18nString("nlp")+"</h6><br>"+i18n.i18nString("identifies_intent")+"</div>",'<div><h6 class="subTitle">'+i18n.i18nString("Utterances")+"</h6><br> "+i18n.i18nString("anything_user_says")+"</div>",'<div><h6 class="subTitle">'+i18n.i18nString("intents_label")+"</h6><br>"+i18n.i18nString("essential_words")+'<br><span class="grayText">'+i18n.i18nString("example")+' - </span><span class="blueText">'+i18n.i18nString("book_apponitment")+'</span> <br> <ul><li><span class="blueText">'+i18n.i18nString("want_book")+"</span> "+i18n.i18nString("with_doctor")+'</li><li><span class="blueText">'+i18n.i18nString("need_consult")+"</span> "+i18n.i18nString("doctor")+"</li> </div>",'<div><h6 class="subTitle">'+i18n.i18nString("Entities_label")+"</h6><br>"+i18n.i18nString("fields_words")+' <br><span class="grayText">'+i18n.i18nString("example")+' - </span> <span class="blueText">'+i18n.i18nString("book_apponitment")+"</span> <br> <ul><li>"+i18n.i18nString("appointment")+' <span class="blueText">'+i18n.i18nString("tomorrow")+"</span>.</li><li>"+i18n.i18nString("want_appointment")+'<span class="blueText">10am</span>  '+i18n.i18nString("on")+' <span class="blueText"> '+i18n.i18nString("Friday")+"</span>.</li><li> "+i18n.i18nString("want_at_your")+' <span class="blueText">10  '+i18n.i18nString("oxford_street")+"</span>  "+i18n.i18nString("location_for")+' <span class="blueText">5 pm</span>.</li></ul></div>'],['<div><h6 class="subTitle">'+i18n.i18nString("artificial")+"</h6></br>"+i18n.i18nString("machine_ability")+"</div>",'<div><h6 class="subTitle">'+i18n.i18nString("machine_learning")+"</h6><br>"+i18n.i18nString("algorithms")+" </div>",'<div><h6 class="subTitle">'+i18n.i18nString("entity_extract")+"</h6><br>"+i18n.i18nString("extraction_relevant")+"</div>"],['<div><h6 class="subTitle">'+i18n.i18nString("channels")+"</h6><br>"+i18n.i18nString("including_voice")+"</div>",'<div><h6 class="subTitle">'+i18n.i18nString("Responses")+"</h6><br>"+i18n.i18nString("bot_says_res")+"</div>",'<div><h6 class="subTitle">'+i18n.i18nString("notifications")+"</h6><br>"+i18n.i18nString("messages_users")+"</div>"],['<div><h6 class="subTitle">'+i18n.i18nString("tasks")+"</h6><br>"+i18n.i18nString("simple_jobs")+"</div>",'<div><h6 class="subTitle">'+i18n.i18nString("learning")+"</h6><br>"+i18n.i18nString("chatbots_intents")+"</div>"]],
buttons:[[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("behind_curtain"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("bots_communicate"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("bots_learn"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("review_lifecycle"),emoji:"",btnFunction:"nextStep"}]]},{stepNo:"Step 3",stepId:"step3",stepDisc:i18n.i18nString("short_review"),stepActive:!1,stepLoaded:!1,stepFunction:!1,loadSteps:1,stepContent:[["<p>"+i18n.i18nString("methodology")+" </p>","<p>"+i18n.i18nString("bots_platform")+"</P>","<p>"+i18n.i18nString("framework_key")+"</P>",imageInStep3],['<div><h6 class="subTitle">'+i18n.i18nString("define_build")+"</h6> <br><p>"+i18n.i18nString("steps_involving")+"</div>","<p>"+i18n.i18nString("capabilities")+"</p>"],['<div><h6 class="subTitle">'+i18n.i18nString("train")+"</h6> <br> <p>"+i18n.i18nString("after_developing")+" </div>","<p>"+i18n.i18nString("internal_testing")+"</p>"],['<div><h6 class="subTitle">'+i18n.i18nString("Enable")+"</h6> <br><p>"+i18n.i18nString("steps_to_refer")+"</p> </div>"],['<div><h6 class="subTitle">'+i18n.i18nString("test")+"</h6> <br><p>"+i18n.i18nString("built")+" </div>","<p>"+i18n.i18nString("testing_model")+"</p> "],['<div><h6 class="subTitle">'+i18n.i18nString("publish")+"</h6> <br><p>"+i18n.i18nString("sufficiently")+"  </div>","<p>"+i18n.i18nString("bot_developers")+"</p> "],['<div><h6 class="subTitle">'+i18n.i18nString("analyze")+"</h6> <br><p>"+i18n.i18nString("deployed")+"   </div>","<p>"+i18n.i18nString("bots_performance")+"  </p>","<p>"+i18n.i18nString("future_more")+" </p>"],["<p>"+i18n.i18nString("building_bots")+"</p>"]],buttons:[[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("break_down"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("review_training"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("enable_me"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("tell_testing"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("lets_review"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("tell_analyze"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("continue"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("tell_me_aboutKore"),emoji:"",btnFunction:"nextStep"}]]},{stepNo:"Step 4",stepId:"step4",stepDisc:i18n.i18nString("look_platform"),stepActive:!1,stepLoaded:!1,loadSteps:1,stepContent:[["<p>"+i18n.i18nString("kore_platform")+"</p>","<p>"+i18n.i18nString("platform_provides")+"</p>"],['<div><h6 class="subTitle">'+i18n.i18nString("Proprietary")+"</h6> <br><p>"+i18n.i18nString("unique_multiengine")+"</p><br><p>"+i18n.i18nString("complex_backforth")+" </p> </div>"],['<div><h6 class="subTitle">'+i18n.i18nString("bot_Intelligence")+"</h6> <br><p>"+i18n.i18nString("advanced_intelligence")+"</p>"],['<div><h6 class="subTitle">'+i18n.i18nString("gui_dialog")+"</h6> <br><p>"+i18n.i18nString("multi_developer")+"</p>"],['<div><h6 class="subTitle">'+i18n.i18nString("Omnichannel")+"</h6><br><p>"+i18n.i18nString("enterprise_channels")+"</p>"],['<div><h6 class="subTitle">'+i18n.i18nString("enterprise_ready")+"</h6><br> <p>"+i18n.i18nString("provides_everything")+"</p><br><p>"+i18n.i18nString("Soc_type")+" </p></div>"],['<div><h6 class="subTitle">'+i18n.i18nString("detailed_analytics")+"</h6><br><p>"+i18n.i18nString("visualization")+"</p>"]],buttons:[[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("lets_begin"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("whats_next"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("tell_more"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("skip_section"),emoji:$scope.assectBase+"onboarding/emojies/sunglasses.png",btnFunction:"nextStep"},{text:i18n.i18nString("lets_continue"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("show_me_more"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("almost_there"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("start_building"),emoji:"",btnFunction:"nextStep"}]]},{stepNo:"Step 6",stepId:"step5",hasBtnTemplets:!0,stepDisc:i18n.i18nString("get_started_building"),stepActive:!1,stepLoaded:!1,loadSteps:1,stepContent:[["<p>"+i18n.i18nString("build_conversational")+"</p>","<p>"+i18n.i18nString("learning_task")+"</p>"],["<p>"+i18n.i18nString("predefined_usecase")+"</p>",'<div><h6 class="subTitle">'+i18n.i18nString("alert_task_weather")+" </h6><ul><li>"+i18n.i18nString("create_alerts")+"</li><li>"+i18n.i18nString("bot_conversations")+' </li></ul><div class="btn getStartedBtn" data-get-started="CREATE_BOT_ALERT" id="getStartedBtn">'+i18n.i18nString("get_started")+"</div></div>",'<div><h6 class="subTitle">'+i18n.i18nString("dialog_task_bot")+"</h6><ul><li>"+i18n.i18nString("create_Dialog")+"</li><li>"+i18n.i18nString("capture_request")+' </li></ul><div class="btn getStartedBtn" data-get-started="CREATE_BOT_DIALOG" id="getStartedBtn">'+i18n.i18nString("get_started")+"</div></div>",'<div><h6 class="subTitle">'+i18n.i18nString("knowledge_task_bot")+"</h6><ul><li>"+i18n.i18nString("create_Botontology")+"</li><li>"+i18n.i18nString("extract_weburl")+'</li></ul><div class="btn getStartedBtn"  data-get-started="CREATE_BOT_KT" id="getStartedBtn">'+i18n.i18nString("get_started")+"</div></div>"]],buttons:[[{text:i18n.i18nString("build_ownbot"),emoji:"",btnFunction:"completeOnBoard"},{text:i18n.i18nString("continue_walkthrough"),emoji:"",btnFunction:"continue"}],[{text:i18n.i18nString("define_usecase"),emoji:"",btnFunction:"completeOnBoard"}]]}],learnBotBuilding:[{stepId:"step1",hasBtnTemplets:!0,stepDisc:i18n.i18nString("get_started_building"),stepActive:!0,stepLoaded:!1,loadSteps:1,stepContent:[["<p>"+i18n.i18nString("predefined_usecase")+"</p>",'<div><h6 class="subTitle">'+i18n.i18nString("alert_task_weather")+" </h6><ul><li>"+i18n.i18nString("create_alerts")+"</li><li>"+i18n.i18nString("bot_conversations")+' </li></ul><div class="btn getStartedBtn" data-get-started="CREATE_BOT_ALERT" id="getStartedBtn">'+i18n.i18nString("get_started")+"</div></div>",'<div><h6 class="subTitle">'+i18n.i18nString("dialog_task_bot")+"</h6><ul><li>"+i18n.i18nString("create_Dialog")+"</li><li>"+i18n.i18nString("capture_request")+' </li></ul><div class="btn getStartedBtn" data-get-started="CREATE_BOT_DIALOG" id="getStartedBtn">'+i18n.i18nString("get_started")+"</div></div>",'<div><h6 class="subTitle">'+i18n.i18nString("knowledge_task_bot")+"</h6><ul><li>"+i18n.i18nString("create_Botontology")+"</li><li>"+i18n.i18nString("extract_weburl")+'</li></ul><div class="btn getStartedBtn"  data-get-started="CREATE_BOT_KT" id="getStartedBtn">'+i18n.i18nString("get_started")+"</div></div>"]],buttons:[[{text:i18n.i18nString("define_usecase"),emoji:"",btnFunction:"completeOnBoard"}]]}]},$scope.isBordingGuideMenu=[{id:"learnBots",title:i18n.i18nString("new_bots"),disc:i18n.i18nString("learn_allabouts"),icon:$scope.learn,label:i18n.i18nString("get_started")},{id:"learnBotBuilding",title:i18n.i18nString("familiar_bots"),disc:i18n.i18nString("take_step"),icon:$scope.started,label:i18n.i18nString("get_started")},{id:"helpGuid",title:i18n.i18nString("bot_expert"),disc:i18n.i18nString("Jump_straight"),icon:$scope.help,label:i18n.i18nString("start_Building")}],$("html").addClass("onBoardVideoMobileView"),$scope.setUpdateLocalStorageForOnboarding=function(guideID,stepLoaded,contentIndex){$rootScope.koreUserInfo.isBotsOnboarded||localStorage.setItem("koreOnBoardingProgress",JSON.stringify({guideID:guideID,stepLoaded:stepLoaded}))},$scope.startGuideTour=function(id){$scope.selectedGuideId=id,"helpGuid"===id?$scope.closeModal():($scope.selectedGuide=angular.copy($scope.stepContent[id]),$scope.setUpdateLocalStorageForOnboarding(id,0,0),$scope.guideStep=2,$(".guideBody").scrollTop(0))},$scope.resumeOboard&&$scope.resumeOboard.guideID&&NotificationService.userConfirm(i18n.i18nString("looks_resume"),[resumeOnboard,cancle],{okText:i18n.i18nString("resume"),cancelText:i18n.i18nString("exit_label")},"",void 0,i18n.i18nString("welcome_back")),$scope.config&&$scope.config.component&&$scope.config.component.guideId&&$scope.startGuideTour($scope.config.component.guideId),$scope.loadVideo=function(){$scope.showImage=!1},$scope.showMeGuidedHints=function(){window.whatfixKoreData.isBotsOnboarded=!0,scriptLoader.loadWhatfixScripts(),$scope.closeModal()},$scope.skipGuidedHints=function(){window.whatfixKoreData.isBotsOnboarded=!1,scriptLoader.loadWhatfixScripts(),$scope.closeModal()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("weChatChannel",[function(){return{scope:{onSave:"=",value:"=",context:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/WeChat-channel/weChat-channel.html",controller:["$scope","$workflowService","$location","$timeout","BTStreamsService","env_conf","form_util","uuid4","BTIdpService","$translator","i18n",function($scope,$workflowService,$location,$timeout,BTStreamsService,env_conf,form_util,uuid4,BTIdpService,$translator,i18n){function getId(){return"ap-"+uuid4.generate()}var clipWebhook_url,clipVerify_token;$scope.channel=$scope.value||{enable:!0},$scope.assetsBase=env_conf["assets-url"],$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.patternPass=/^[^\s].+[^\s]$/,$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.idp.name,$scope.channel.app_name=stream.name,$scope.channel.streamId=newVal.idp.streamId,$scope.channel.clientID=newVal.idp.formfields.filter(function(obj){return"appid"===obj.key})[0]["default"],$scope.channel.clientSecret=newVal.idp.formfields.filter(function(obj){return"secret"===obj.key})[0]["default"],console.log($scope.channel))});var stream=$workflowService.selectedStream();$scope.save=function(form){if(form.$invalid)return form_util.touch(form),NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error"),$scope.clientIDRequired=$scope.channel.clientID&&$scope.channel.clientID.trim()?!1:!0,void($scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0);var payload={name:stream.name+"wechat",enable:$scope.channel.enable,appConfig:{tokenURL:"https://api.weixin.qq.com/cgi-bin/token"},formfields:[{title:"appid",key:"appid","default":$scope.channel.clientID,isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"secret",key:"secret","default":$scope.channel.clientSecret,isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"grant_type",key:"grant_type","default":"client_credentials",isRequired:!0,fieldType:"textbox",visibility:"hidden"}],streamId:$workflowService.selectedStream()._id,channel_auth:"wechat",sso_type:"custom",contentType:"application/x-www-form-urlencoded",method:"POST"};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),NotificationService.notify(i18n.i18nString("wechat_edited_success"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),NotificationService.notify(i18n.i18nString("wechat_added_success"),"success")},function(err){var errMsg="";try{errMsg=err.data.errors[0].msg}catch(e){errMsg=i18n.i18nString("channel_config_failed")}NotificationService.notify(errMsg,"error")})},$scope.goToHome=function(flag){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.currentStep={},BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"wechat"}).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url,$scope.channel.verify_token=res.data.verify_token},function(err){$scope.channelAuth={}}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#weChat_webhook_url"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#weChat_verify_token"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("amazonAlexa",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/amazonalexa-channel/amazonalexa-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","$element","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,$element,i18n){var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope._constants_=_constants_;var streamUserAccountId="";$scope.btTestFormApi={},$scope.btTestStatus={},$scope.channel={name:stream.name+" alexa account",streamId:stream._id,app_name:stream.name,enable:!0},$scope.integrationOpt={selected:"dialog"},$scope.account={link:!1},$scope.idpList=[],$scope.idp={selected:""};var selectedIdp="";$scope.channel.echoShow=!0,$scope.channel.mode="sandbox",BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.idpList=res.data,$scope.idpList=$scope.idpList.filter(function(val){return"oauth2"===val.sso_type}),0!==$scope.idpList.length&&selectedIdp&&""!==selectedIdp&&($scope.idp.selected=$scope.idpList.filter(function(val){return val.refId===selectedIdp})[0].name)},function(res){NotificationService.notify(i18n.i18nString("notify_idp"),"error")}),$scope.exportAlexaJson=function(){function startExport(){BTStreamsService.alexaExport("",stream._id,""+$scope.channel.echoShow).then(function(response){var data=($scope.channel.echoShow,response.data),fileName=stream.name+"_alexa.json",buffer=JSON.stringify(data,null,4),blob=new Blob([buffer],{type:"text/json;charset=utf8;"}),link=document.createElement("a");void 0!==link.download?(link.setAttribute("href",window.URL.createObjectURL(blob)),link.setAttribute("download",fileName),document.body.appendChild(link),link.click(),document.body.removeChild(link)):navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob(blob,fileName)},function(error){return""})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("download")):startExport()},$scope.assetsBase=env_conf["assets-url"],$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.name,$scope.channel.mode=newVal.mode,$scope.channel.app_name=stream.name,$scope.integrationOpt.selected="Redirection"===newVal.integrationType?"redirection":"dialog",$scope.account.link=newVal.isAccLinkingEnabled,selectedIdp=newVal.idpId,streamUserAccountId=newVal.streamUserAccountId||"")}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/alexa/hooks/"+stream._id,$scope.save=function(form){if(form.$invalid)return void NotificationService.notify(i18n.i18nString("pls_select_idp_from_account"),"error");var payload={};payload.type="alexa",payload.enable=$scope.channel.enable,payload.integrationType="dialog"===$scope.integrationOpt.selected?"DialogMigration":"Redirection",payload.isAccLinkingEnabled=$scope.account.link,$scope.account.link&&0!==$scope.idpList.length&&(payload.idpId=$scope.idpList.filter(function(val){return val.name===$element.find(".idpSelected")[0].value})[0].refId),$scope.onSave(payload,"","","","Amazon Alexa")},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_AMAZON_ALEXA,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.bulbSvg=env_conf["context-url"]+"/assets/images/bulbicon.svg",$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,2===step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#amazonalexaoauthuri2"');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".slack-channel-page").scrollTop(0)},$scope.closeChannel=function(){$scope.goToHome()},$timeout(function(){$(".slack-channel-page").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("audioCodes",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/audiocodes-channel/audio-codes.html",scope:{closeSlider:"=",onSave:"=",value:"="},controller:["$scope","$workflowService","$timeout","BTStreamsService","env_conf","$applicationService","NotificationService","i18n",function($scope,$workflowService,$timeout,BTStreamsService,env_conf,$applicationService,NotificationService,i18n){var stream=$workflowService.selectedStream();$scope.assetsBase=env_conf["assets-url"],$scope.modalSlider={},$scope.audio_codes_cb={},$scope.audio_codes_ivr={},$scope.streamState=$workflowService.selectedStreamState(),$scope.audio_codes_ivr.isFrom="audiocodes",$scope.audio_codes_ivr.streamVoiceKey="audioCodesSettings",$scope.serverUrl=env_conf.API_SERVER_URL,$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")},{step:3,active:!1,name:"Voice Call Properties"}],$scope.channel={enable:"true",oAuthRedirectURI:$scope.serverUrl+"/hooks/audiocodes/"+stream._id},$scope.$watch("value",function(newVal,oldVal){$scope.audio_codes_cb.selectedApp=newVal?newVal.app.clientId:null,$scope.audio_codes_cb.value=newVal}),$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#webhookaudiocodes"');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$scope.steps[step-1].active=!0,$(".audio-codes-channel").scrollTop(0)},$scope.saveIVR=function(){$scope.audio_codes_ivr.saveIVR($scope.goToHome)},$scope.save=function(){var payload={};return"choose"==$scope.audio_codes_cb.selectedAppView?void NotificationService.notify(i18n.i18nString("please_selec_app"),"error"):(payload={app:{clientId:$scope.audio_codes_cb.selectedAppView.clientId,appName:$scope.audio_codes_cb.selectedAppView.appName},type:"audiocodes",enable:$scope.channel.enable},"true"===$scope.channel.enable&&(payload.enable=!0),void $scope.onSave(payload,"","","","IVR - AudioCodes"))},$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page.audio-codes-channel").scrollTop(0)}}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("ciscoTropo",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",channelsenable:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/cisco-tropo/cisco-tropo.html",controller:["$scope","$element","$workflowService","BTStreamsService","$timeout","env_conf","NotificationService","uuid4","form_util","_constants_","$rootScope","i18n",function($scope,$element,$workflowService,BTStreamsService,$timeout,env_conf,NotificationService,uuid4,form_util,_constants_,$rootScope,i18n){function setupClipboardCopy(){$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#callBackUrl0"]');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},500)}function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.searchCountryCodes="";var defaultMobileArray=[{countryCode:i18n.i18nString("Bt_chnl_cisco_config_countryCode_label"),number:""}],getDefaultMobileArray=function(){var oldPhoneNumberArray=[];if($scope.value.phoneNumber){var oldPhoneNumberObject={},phoneNumber=$scope.value.phoneNumber;oldPhoneNumberObject.number=phoneNumber.substring(phoneNumber.length-10,phoneNumber.length),oldPhoneNumberObject.countryCode=phoneNumber.substring(0,phoneNumber.length-10),oldPhoneNumberArray.push(oldPhoneNumberObject)}return oldPhoneNumberArray.length&&oldPhoneNumberArray||defaultMobileArray};$scope.sendContactCB={},$scope.channel={_id:$scope.value._id,type:"sms",gateway:"tropo",authToken:$scope.value.authToken,clientApi:$scope.value.authToken,numbers:$scope.value&&($scope.value.numbers||[]).length>0&&$scope.value.numbers||getDefaultMobileArray(),applicationName:$scope.value.applicationName,applicationType:$scope.value.applicationType,enable:!0},$scope.assetsBase=env_conf["assets-url"],$scope._constants_=_constants_,$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.serverUrl=env_conf.API_SERVER_URL+"/client/sms/tropo",setupClipboardCopy(),$scope.stepClick=function(step){$scope.next(step),$(".cisco-channel-page").scrollTop(0)},$scope.save=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.applicationType&&$scope.channel.applicationType.trim()&&$scope.channel.applicationName&&$scope.channel.applicationName.trim()?!1:!0,$scope.clientNumberReq=$scope.channel.phoneNumber&&$scope.channel.phoneNumber.countryCode&&$scope.channel.phoneNumber.number?!1:!0,$scope.clientSecretRequired=$scope.channel.clientApp&&$scope.channel.clientApp.trim()?!1:!0,NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error"),void($scope.clientIDRequired||$scope.clientNumberReq?$timeout(function(){$element.find(".tropo-channel-page").scrollTop($element.find(".tropo-channel-page").height()+100),form.applicationName.$dirty&&""===$element.find('[name="applicationName"]').val().trim()?$element.find('[name="applicationName"]').focus():form.applicationType.$dirty&&""===$element.find('[name="applicationType"]').val().trim()?$element.find('[name="applicationType"]').focus():form.phoneOnly.$dirty&&""===$element.find('[name="phoneOnly"]').val().trim()&&$element.find('[name="phoneOnly"]').focus(),form.phoneOnly.$dirty&&($scope.ciscoForm.phoneOnly.$setDirty(),!$scope.channel.phoneNumber||$scope.channel.phoneNumber.number&&$scope.channel.phoneNumber.number.trim().length>0||$scope.ciscoForm.phoneOnly.$setValidity("mobRequired",!1))},350):$scope.clientSecretRequired&&$timeout(function(){$element.find(".tropo-channel-page").scrollTop($element.find(".tropo-channel-page").height()+500),form.clientApi.$dirty&&""===$element.find('[name="clientApi"]').val().trim()&&$element.find('[name="clientApi"]').focus()},350));if(!$scope.channel.enable){var channelObject=angular.copy($scope.channel);if(channelObject.name="Cisco Tropo",$scope.$parent.isLastEnabledChannel(channelObject))return NotificationService.notify(i18n.i18nString("atleast_one_enabled_chnl_is_req"),"error"),!1}var _enable=!1;if($.each($scope.channelsenable,function(index,channel){return"twilio"===channel.gateway&&"Enabled"===channel.status?(_enable=!0,!1):void 0}),_enable)NotificationService.confirmDialog(i18n.i18nString("bt_chnl_form_twilio_chnl_already_enabled"),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0});else{var payload={type:"sms",gateway:"tropo",authToken:$scope.channel.clientApi,numbers:$scope.channel.numbers,enable:$scope.channel.enable,applicationName:$scope.channel.applicationName,applicationType:$scope.channel.applicationType,_id:$scope.channel._id};payload._id?BTStreamsService.createOrEditChannel(stream._id,$scope.channel.type,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation($scope.channel.type),NotificationService.notify(i18n.i18nString("bt_chnl_cisco_tropo_edited_sucess"),"success"),$scope.sendContactCB.updateMpStream()},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")}):(payload._id=getId(),BTStreamsService.createOrEditChannel(stream._id,$scope.channel.type,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation($scope.channel.type),$scope.sendContactCB.updateMpStream(),NotificationService.notify(i18n.i18nString("bt_chnl_cisco_tropo_added_sucess"),"success")},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")}))}$scope.closeSlider()},$scope.selectItem=function(item){console.log(item);var selectedCountryCodes=_.pluck($scope.channel.phoneNumber,"countryCode"),selectedCountryNames=_.pluck($scope.channel.phoneNumber,"countryName");return-1===$.inArray(item.value,selectedCountryCodes)||-1===$.inArray(item.name,selectedCountryNames)||$scope.channel.phoneNumber.countryName===item.name&&$scope.channel.phoneNumber.countryCode===item.value?($scope.channel.phoneNumber.countryCode=item.value,$scope.channel.phoneNumber.countryName=item.name,$scope.countryCodeChoosen=item,$(".dropdown").removeClass("open"),void $rootScope.$broadcast("onCountryCodeSelected")):void NotificationService.notify(i18n.i18nString("country_code_already_in_use"),"warning")},$scope.searchClicked=function(e){e.stopPropagation()},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_TROPO,$scope.channelHeaderCallback=$scope,$scope.selectItem=function(item,index){console.log(item);var selectedCountryCodes=_.pluck($scope.channel.numbers,"countryCode"),selectedCountryNames=_.pluck($scope.channel.numbers,"countryName");return-1===$.inArray(item.value,selectedCountryCodes)||-1===$.inArray(item.name,selectedCountryNames)||$scope.channel.numbers[index].countryName===item.name&&$scope.channel.numbers[index].countryCode===item.value?($scope.channel.numbers[index].countryCode=item.value,$scope.channel.numbers[index].countryName=item.name,$scope.countryCodeChoosen=item,$(".dropdown").removeClass("open"),void $rootScope.$broadcast("onCountryCodeSelected")):void NotificationService.notify(i18n.i18nString("country_code_already_in_use"),"warning")},$scope.deleteMobileField=function(index){$scope.channel.numbers.splice(index,1)},$scope.addNewMobileField=function(index){if(""===$scope.channel.numbers[index].number.trim())return $scope.ciscoForm["phoneOnly"+index].$setDirty(),void $scope.ciscoForm["phoneOnly"+index].$setValidity("mobRequired",!1);if(!$scope.ciscoForm["phoneOnly"+index].$error.invalidFormat){var defaultMobObject={countryCode:"Select country code",number:""};$scope.channel.numbers.push(defaultMobObject),$timeout(function(){$(".dropdown-toggle").dropdown()})}},$timeout(function(){$(".dropdown-toggle").dropdown(),$(".ciscoChannelContainer").on("click",".dropdown-menu",function(evt){evt.stopPropagation()})}),$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.next=function(step){$(".slack-channel-page").scrollTop(0),$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0},$timeout(function(){$(".slack-channel-page").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("emailChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/email-channel/email-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","$rootScope","env_conf","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,$rootScope,env_conf,i18n){var emaildomain=$workflowService.seedData().domain;$scope.stream=$workflowService.selectedStream(),$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope._constants_=_constants_,$scope.emailPostFix=_constants_.emailchannelInfo.emailPostFix.replace("{emaildomain}",emaildomain),$scope.sendContactCB={},
$scope.goToHome=function(flag){$scope.email.name="",$scope.$parent.goToHome(flag),$scope.closeSlider()},$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.email=_.isObject($scope.value)&&Object.keys($scope.value).length>0?$scope.value:{disabled:!0,name:"",enable:!0},$scope.email.name=($scope.email.name||"").split("@")[0].replace(/\s/g,"").toLowerCase(),$scope.changeEmail=function(){$scope.email.disabled=!1},$scope.saveEmail=function(saveIt){if(""===$scope.email.name)return void NotificationService.notify(i18n.i18nString("provide_a_valid_email_address"),"error");var payload={};payload.type="email",payload.email=$scope.email.name+$scope.emailPostFix,payload.enable=$scope.email.enable,$scope.email.disabled=!0,saveIt&&$scope.onSave(payload,"","",$scope.sendContactCB.updateMpStream,"Email")},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3),$timeout(function(){$(".emailInput").focus()},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("fbChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/fb-channel/fb-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,form_util,i18n){var clipWebhook_url,clipVerify_token;$scope.channel=$scope.value||{enable:!0,typingIndicator:!1},$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channelAuth={},$scope.assetsBase=env_conf["assets-url"],$scope.currentStep={},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_FB,$scope.channelHeaderCallback=$scope,$scope.$watch("value",function(newVal,oldVal){$scope.channel=newVal||{enable:!0,typingIndicator:!1},$scope.channelAuth=$scope.channelAuth||{},$scope.channel.webhook_url=$scope.channelAuth.webhook_url,$scope.channel.verify_token=$scope.channelAuth.verify_token}),BTStreamsService.getWebhookUrl($workflowService.selectedStream()._id).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url,$scope.channel.verify_token=res.data.verify_token},function(err){$scope.channelAuth={}}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0)},$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);var payload={};payload.type="facebook",payload.page_token=$scope.channel.page_token,payload.page_id=$scope.channel.page_id,payload.app_id=$scope.channel.app_id,payload.app_secret=$scope.channel.app_secret,payload.enable=$scope.channel.enable,payload.typingIndicator=$scope.channel.typingIndicator,$scope.onSave(payload,"","","","Facebook Messenger")},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#fb_webhook_url"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#fb_verify_token"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0)},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$timeout(function(){$(".fb-channel-page").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("fbWorkplace",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/fb-workplace/fb-workplace.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","form_util","$window","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,form_util,$window,i18n){function openAuthPage(data){function showPopUpBlockedDialog(url,emitEvent){$scope.redirectURL=url;var dialog=window.bootbox.dialog({message:'<div class="dialog-content"><div class="symbol"><span class="fa fa-exclamation-circle"></span></div><div><div class="desc"> '+i18n.i18nString("bt_chnl_fb_workplace_looks_like_popup_blocker")+' </div><div class="message">'+i18n.i18nString("click_yes_to_proceed_further")+' </div><div class="popup-button-group"><button type="button" class="btn btn-primary popup-block-accept-btn" aria-label="Close">'+i18n.i18nString("yes")+"</button></div></div></div>",className:"alert-modal popup-block-warning"});dialog.init(function(){$(document).on("click",".popup-block-accept-btn",function(event){$window.open($scope.redirectURL,"_blank"),$(".bootbox-close-button").trigger("click"),pollLocalStorage()})})}function pollLocalStorage(){lStoragePollTimer&&(clearInterval(lStoragePollTimer),lStoragePollTimer=null),lStoragePollTimer=setInterval(function(){var authConfig=JSON.parse(localStorage.getItem("channelExternalAuthConfig"));authConfig&&(authConfig.functionCall.onChildLoad&&onChildLoad(),authConfig.functionCall.externalAuthResponse&&(externalAuthResponse(authConfig.data),clearInterval(lStoragePollTimer),lStoragePollTimer=null))},1e3)}function onChildLoad(){childWindow.location.href=data.url,localStorage.setItem("channelExternalAuthConfig",JSON.stringify({functionCall:{onChildLoad:!1,externalAuthResponse:!1}}))}function externalAuthResponse(data){var hashMessage=data.hash;"success"===hashMessage?($scope.cond.isAuthorized=!0,authorizedNow=!0,NotificationService.notify(i18n.i18nString("bt_chnl_fb_workplace_added_to_ur_Accnt",{dyn:streamName}),"success")):($scope.cond.isAuthorized=!1,NotificationService.notify(i18n.i18nString("bt_chnl_fb_workplace_couldnot_authorize",{dyn:streamName}),"error"))}var lStoragePollTimer,strWindowFeatures="_blank,rel=opener,menubar=no,resizable=no,location=no,toolbar=no,height=500,width=700,resizable=yes,scrollbars=yes,status=yes,left=350,top=80",childWindow=$window.open(appUrl+window.appConfig.CONTEXT_PATH+"/views/auth-redirect.html","app_install",strWindowFeatures);childWindow?pollLocalStorage():showPopUpBlockedDialog(data.url,!0),childWindow&&childWindow.focus()}var clipWebhook_url,clipVerify_token;$scope.channel=$scope.value||{enable:!0,isMention:!0,isChat:!0},$scope.channelAuth={},$scope.assetsBase=env_conf["assets-url"],$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState();var streamName=$workflowService.selectedStream().name,appUrl=window.appConfig.API_SERVER_URL;$scope.currentStep={},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_WFACEBOOK,$scope.channelHeaderCallback=$scope;env_conf.API_SERVER_URL;$scope.managePermissionsFb=[{name:i18n.i18nString("bt_chnl_fb_workplace_msg_any_number"),selected:!0,readOnly:!0,key_val:"message"},{name:i18n.i18nString("bt_chnl_fb_workplace_mention_bot"),selected:!1,readOnly:!1,key_val:"bot_mention"},{name:i18n.i18nString("bt_chnl_fb_workplace_manage_grp"),selected:!1,readOnly:!1,key_val:"write_group"},{name:i18n.i18nString("bt_chnl_fb_workplace_create_link"),selected:!1,readOnly:!1,key_val:"link_unfurling"},{name:i18n.i18nString("bt_chnl_fb_workplace_read_user_email"),selected:!1,readOnly:!1,key_val:"read_user_email"},{name:i18n.i18nString("bt_chnl_fb_workplace_read_work_profile"),selected:!1,readOnly:!1,key_val:"read_user_work_profile"},{name:i18n.i18nString("bt_chnl_fb_workplace_read_org_chart"),selected:!1,readOnly:!1,key_val:"read_user_org_chart"}],$scope.$watch("value",function(newVal,oldVal){if($scope.channel=newVal||{enable:!0,isMention:!0,isChat:!0},$scope.channelAuth=$scope.channelAuth||{},$scope.channel.webhook_url=$scope.channelAuth.webhook_url,$scope.channel.verify_token=$scope.channelAuth.verify_token,$scope.channel&&$scope.channel.permissions)for(var i=0;i<$scope.channel.permissions.length;i++)for(var j=0;j<$scope.managePermissionsFb.length;j++)$scope.channel.permissions[i]===$scope.managePermissionsFb[j].key_val&&($scope.managePermissionsFb[j].selected=!0);else $scope.managePermissionsFb.forEach(function(val){("bot_mention"==val.key_val||"write_group"==val.key_val)&&(val.selected=!0)})}),$scope.cond={isAuthorized:!1};var authorizedNow=!1;BTStreamsService.getWebhookUrl($workflowService.selectedStream()._id,!0).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url,$scope.channel.verify_token=res.data.verify_token},function(err){$scope.channelAuth={}}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]);var channelsList=$workflowService.selectedStream().channels;if(0!==channelsList.length){var fbWorkplace=channelsList.filter(function(val){return"wfacebook"===val.type});fbWorkplace&&fbWorkplace[0]&&fbWorkplace[0].fbstate&&($scope.cond.isAuthorized="installed"===fbWorkplace[0].fbstate)}$scope.installApp=function(){for(var permsKeys=$scope.managePermissionsFb.filter(function(val){return val.selected}),permsKeysVal=[],i=0;i<permsKeys.length;i++)permsKeysVal[i]=permsKeys[i].key_val;var payload={pageName:$workflowService.selectedStream().name,isMention:$scope.channel.isMention,isChat:$scope.channel.isChat,permissions:permsKeysVal};BTStreamsService.fbInstallApp($workflowService.selectedStream()._id,payload).then(function(res){res.data&&res.data.wfbUrl&&openAuthPage({url:res.data.wfbUrl})},function(err){NotificationService.notify(i18n.i18nString("unable_to_authorize_chnl"),"error"),console.log(err)})},$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0)},$scope.save=function(form){if(!$scope.cond.isAuthorized)return void NotificationService.notify(i18n.i18nString("pls_authorize_bot_before_saving"),"error");if(form&&form.$invalid)return void form_util.touch(form);var payload={};payload.type="wfacebook",payload.isMention=$scope.channel.isMention,payload.isChat=$scope.channel.isChat,payload.enable=$scope.channel.enable,payload.thirdPartyInstallation=!0,$scope.onSave(payload,"","","","Workplace by Facebook")},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#fb_webhook_url"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#fb_verify_token"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0)},$scope.goToHome=function(){return $scope.cond.isAuthorized&&authorizedNow?void NotificationService.confirmDialog(i18n.i18nString("chnl_has_to_be_saved"),function(){},{okText:i18n.i18nString("ok_label"),noCancelBtn:!0}):($scope.$parent.goToHome(),void $scope.closeSlider())},$scope.exit=$scope.goToHome,$timeout(function(){$(".fb-channel-page").scrollTop(0)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("googleHome",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/google-home/google-home.html",controller:["$scope","$workflowService","$location","$timeout","BTStreamsService","env_conf","i18n",function($scope,$workflowService,$location,$timeout,BTStreamsService,env_conf,i18n){var clipWebhook_url,clipVerify_token;$scope.channel=$scope.value||{enable:!0},$scope.assetsBase=env_conf["assets-url"],$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.save=function(form){var payload={};return form&&form.$invalid?void form_util.touch(form):(payload.type="googleactions",payload.enable=$scope.channel.enable,void $scope.onSave(payload,"","","","Google Assistant"))},$scope.goToHome=function(flag){$scope.closeSlider()},$scope.currentStep={},BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"googleactions"}).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url,$scope.channel.verify_token=res.data.verify_token},function(err){$scope.channelAuth={}}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#googleHome_webhook_url"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#googleHome_verify_token"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("googleHangout",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/hangout-channel/hangout-channel.html",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},controller:["$scope","$workflowService","$location","$applicationService","BTStreamsService","$timeout","$routeParams","env_conf","NotificationService","form_util","i18n",function($scope,$workflowService,$location,$applicationService,BTStreamsService,$timeout,$routeParams,env_conf,NotificationService,form_util,i18n){$scope.currentStep={},$scope.channel=$scope.value||{enable:!0},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}];var channelState={};$scope.configHangout={clientEmail:"",privateKey:""},$scope.streamState=$workflowService.selectedStreamState(),$scope.assetsBase=env_conf["assets-url"],$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){var channelDetails=res.data.channels.filter(function(val){return"hangoutchat"===val.type})[0];res.data.channelStatus&&res.data.channelStatus.hangoutchat&&(channelState=res.data.channelStatus.hangoutchat),channelDetails&&($scope.configHangout={clientEmail:channelDetails.clientEmail,privateKey:channelDetails.privateKey},$scope.channel.enable=channelDetails.enable)},function(err){console.log(err)}),$scope.save=function(form){var payload={};return form&&form.$invalid?void form_util.touch(form):(payload={privateKey:$scope.configHangout.privateKey,clientEmail:$scope.configHangout.clientEmail},payload.type="googleHangout",payload.enable=$scope.channel.enable,void(channelState.state&&"delete"!==channelState.state?("update"===channelState.state||"new"===channelState.state)&&BTStreamsService.hangoutChannel($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),NotificationService.notify(i18n.i18nString("channel_info_saved"),"success")},function(err){console.log(err)}):BTStreamsService.hangoutChannel($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload).then(function(res){$workflowService.selectedStream().channels=res.data.channels,$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation($scope.channel.type),NotificationService.notify(i18n.i18nString("hangOut_chnl_added_sucess"),"success")},function(err){console.log(err)})))},$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},250)},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#googlehangoutauthuri"');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},250)},BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"hangoutchat"}).then(function(res){$scope.channel.webhook_url=res.data.webhook_url},function(err){$scope.channelAuth={}})}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("ivrChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"=",ivrChannelList:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/ivr-channel/ivr-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","NotificationService","uuid4","$translator","form_util","$modal","$q","AppsDataService","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,NotificationService,uuid4,$translator,form_util,$modal,$q,AppsDataService,i18n){function getApps(){$scope.isAppLoading=!0,$scope.loadingAddChannel=!0,$q.all([AppsDataService.getAppsList($scope.stream._id),AppsDataService.getBotsList()]).then(function(res){if($scope.loadingAddChannel=!1,res[1]&&res[1].data?$scope.avalSreams=res[1].data:$scope.avalSreams=[],res[0]&&res[0].data&&res[0].data.apps){$scope.apps=res[0].data.apps;var a_appClientIds=_.pluck($scope.apps,"clientId");if($workflowService.selectedStream().sdkSubscription&&-1===$.inArray($workflowService.selectedStream().sdkSubscription.sdkClientId,a_appClientIds)){var appObject=$workflowService.selectedStream().sdkSubscription;appObject.clientId=appObject.sdkClientId,appObject.isNonEditable=!0,$scope.apps.push(appObject)}if($scope.value&&$scope.value.app){var _selApps=$scope.apps.filter(function(app){return app.clientId===$scope.value.app.clientId});_selApps&&_selApps.length&&($scope.setApp(_selApps[0]),$scope.isNonEditable=_selApps[0].isNonEditable)}$scope.apps=_.filter($scope.apps,function(o){return o.clientId}),$scope.JWEPublicKey=res[0].data.publicKeys.keys[0]}else $scope.apps=[];$scope.isAppLoading=!1},function(err){$scope.loadingAddChannel=!1,NotificationService.alertNotify(i18n.i18nString("get_apps")),$scope.isAppLoading=!1})}var clipWebhook_url,clipVerify_token,clipWebhook_url_v2,clipVerify_token_v2,stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.stream=$workflowService.selectedStream(),$scope.showWebhookV1=!1,$scope.channel={name:i18n.i18nString("ivr_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0,isAsync:!1},$scope.channelAuth={},$scope.btTestFormApi={},$scope.btTestStatus={},$scope.char_remaining=i18n.i18nString("Generalform_name_pattern_charlimit"),$scope.assetsBase=env_conf["assets-url"],$scope.currentStep={},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_IVR,$scope.channelHeaderCallback=$scope,$scope.selectConfig={placeholder:i18n.i18nString("select_a_key"),allowClear:!1,minimumResultsForSearch:-1},$scope.showURL=!1,$scope.changeWebhook=function(value){value===!0?$scope.showWebhookV1=!0:$scope.showWebhookV1=!1},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/chatbot/hooks/"+stream._id,$scope.channel.url_v2=env_conf.API_SERVER_URL+"/chatbot/v2/webhook/"+stream._id,$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel=newVal||{enable:!0,streamId:stream._id,name:stream.name,app_name:stream.name},$scope.channel.oAuthRedirectURI=newVal.url||env_conf.API_SERVER_URL+"/chatbot/hooks/"+stream._id,$scope.channel.url_v2=newVal.url_v2||env_conf.API_SERVER_URL+"/chatbot/v2/webhook/"+stream._id,$scope.ivrChannelList.length?$scope.showURL=$scope.channel.oAuthRedirectURI?!0:!1:$scope.showURL=!0,$scope.channel.post_url=newVal.post_url,$scope.channel.isAsync=newVal.isAsync,$scope.channel.verify_token=newVal.verify_token)}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".ivr-channel-page").scrollTop(0)},$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);if(!$scope.selectedAppView.clientId)return void NotificationService.alertNotify("",i18n.i18nString("please_select_app"),"error");if(""===$scope.channel.displayName||void 0===$scope.channel.displayName)return void NotificationService.alertNotify("",i18n.i18nString("please_enter_chnl_name"),"error");var payload={};payload.app={clientId:$scope.selectedAppView.clientId,appName:$scope.selectedAppView.appName},$scope.channel.isAsync===!1?(payload.displayName=$scope.channel.displayName,void 0===$scope.channel.type?payload.type="ivr":payload.type=$scope.channel.type,payload.isAsync=$scope.channel.isAsync,payload.enable=$scope.channel.enable,$scope.onSave(payload,"","","","Webhook",$scope.value)):(payload.displayName=$scope.channel.displayName,payload.app_token=$scope.channel.app_token,payload.post_url=$scope.channel.post_url,void 0===$scope.channel.type?payload.type="ivr":payload.type=$scope.channel.type,payload.isAsync=$scope.channel.isAsync,payload.enable=$scope.channel.enable,$scope.onSave(payload,"","","","Webhook"))},$scope.next=function(step){$(".slack-channel-page").scrollTop(0),$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#ivroauthuri2"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#ivroauthuri2"]'),clipWebhook_url_v2=new Clipboard('[data-clipboard-target="#ivroauthuriv22"]'),clipVerify_token_v2=new Clipboard('[data-clipboard-target="#ivroauthuriv22"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url_v2.on("success",function(e){}),clipWebhook_url_v2.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token_v2.on("success",function(e){}),clipVerify_token_v2.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".slack-channel-page").scrollTop(0)},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.onSelectedApp=function(newVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},$scope.$watch("selectedApp",function(newVal,oldVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},!0),$scope.exit=$scope.goToHome,$scope.setApp=function(app){$scope.selectedAppView=app,$scope.selectedApp=app.clientId,setTimeout(function(){$("#select2").select2("val",app.clientId)},100)},$scope.listener=function(msg,args){if("app.created"===msg)$scope.apps.push(args);else if("app.edited"===msg){var _index=_.findIndex($scope.apps,function(o){return o.clientId===args.clientId});_index>-1&&($scope.apps[_index]=args)}$scope.setApp(args)},$scope.createNewApp=function(){$scope.selectedApp="create"},$scope.editApp=function(){var app=$scope.selectedAppView;$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Edit",context:"addChannel",cb:$scope.listener,app:app,bot:stream}}}})},$scope.createApp=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Create",context:"addChannel",cb:$scope.listener,bot:stream}}}})},$scope.showHideSecret=function(){$scope.secretKeyShown=!0},$scope.copyJWTToken=function(containerid){var textarea=document.createElement("textarea");textarea.id="temp_element",textarea.style.height=0,document.body.appendChild(textarea),textarea.value=document.getElementById(containerid).innerText;var selector=document.querySelector("#temp_element");selector.select(),document.execCommand("copy"),document.body.removeChild(textarea),NotificationService.notify(i18n.i18nString("jwe_key_copy"),"success")},getApps();new Clipboard("[data-clipboard-target]");$timeout(function(){$(".ivr-channel-page").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("ivrVoice",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"=",callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/ivr-voice/ivr-voice.html",controller:["$scope","$rootScope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","NotificationService","uuid4","$translator","form_util","$modal","$q","AppsDataService","i18n",function($scope,$rootScope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,NotificationService,uuid4,$translator,form_util,$modal,$q,AppsDataService,i18n){function getStepState(step){var searchQ=$workflowService.storeSearchQry();return searchQ&&searchQ.userNavigateFlag&&searchQ.userNavigateFlag&&"ivrVoice"==searchQ.navigateTo&&searchQ.step?step==searchQ.step?!0:!1:1===step?!0:!1}function getApps(){$scope.loadingAddChannel=!0,$scope.loadingAppDetails=!0,$q.all([AppsDataService.getAppsList($scope.stream._id),AppsDataService.getBotsList()]).then(function(res){if($scope.loadingAddChannel=!1,res[1]&&res[1].data?$scope.avalSreams=res[1].data:$scope.avalSreams=[],res[0]&&res[0].data&&res[0].data.apps){$scope.apps=res[0].data.apps;var a_appClientIds=_.pluck($scope.apps,"clientId");if($workflowService.selectedStream().sdkSubscription&&-1===$.inArray($workflowService.selectedStream().sdkSubscription.sdkClientId,a_appClientIds)){var appObject=$workflowService.selectedStream().sdkSubscription;appObject.clientId=appObject.sdkClientId,appObject.isNonEditable=!0,$scope.apps.push(appObject)}if($scope.value&&$scope.value.app){var _selApps=$scope.apps.filter(function(app){return app.clientId===$scope.value.app.clientId});_selApps&&_selApps.length&&($scope.setApp(_selApps[0]),$scope.isNonEditable=_selApps[0].isNonEditable)}$scope.apps=_.filter($scope.apps,function(o){return o.clientId}),$scope.loadingAppDetails=!1}else $scope.apps=[],$scope.loadingAppDetails=!1},function(err){$scope.loadingAppDetails=!1,$scope.loadingAddChannel=!1,NotificationService.alertNotify(i18n.i18nString("get_apps"))})}var clipWebhook_url,clipVerify_token,stream=$workflowService.selectedStream();$scope.stream=$workflowService.selectedStream(),$scope.callback=$scope.callback||{},$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("ivr_voice_Account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0,isSandboxEnabled:!1,sandboxDetails:{}},$scope.channelAuth={},$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.btTestFormApi={},$scope.btTestStatus={},$scope.assetsBase=env_conf["assets-url"],$scope.helpIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/helpIcon.svg",$scope.currentStep={},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_IVR,$scope.channelHeaderCallback=$scope,$scope.selectConfig={placeholder:i18n.i18nString("select_a_key"),allowClear:!1,minimumResultsForSearch:-1},$scope.redirectToLinkforSandbox=function(link,e){e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()),$rootScope.redirectToLink(link,e)},$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel=angular.copy(newVal)||{enable:!0,streamId:stream._id,name:stream.name,app_name:stream.name},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/ivr/hooks/"+stream._id,void 0===newVal.isSandboxEnabled?$scope.channel.isSandboxEnabled=!1:$scope.channel.isSandboxEnabled=newVal.isSandboxEnabled,
$scope.channel.sandboxDetails=newVal.sandboxDetails||{})}),$scope.steps=[{step:1,active:getStepState(1),name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:getStepState(2),name:i18n.i18nString("bt_chnl_configuration")},{step:3,active:getStepState(3),name:i18n.i18nString("ivr_properties_normal")}],$workflowService.storeSearchQry({userNavigateFlag:!1,navigateTo:""}),$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),3!=step||$scope.callback.enabled||$scope.callback.showIvrsettings(),$(".ivr-channel-page").scrollTop(0)},$scope.checkStreamState=function(){!$scope.stream||$scope.stream.ivrSettings||$scope.channel&&$scope.channel.isSandboxEnabled?$scope.save($scope.ivrDetailForm):NotificationService.alert(i18n.i18nString("bt_chnl_ivrV_settings_not_enabled"),$scope.save,{okText:i18n.i18nString("proceed")},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/ivr/hooks/"+stream._id,$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);if(!$scope.selectedAppView.clientId)return void NotificationService.alertNotify("",i18n.i18nString("please_select_app"),"error");var payload={};payload.app={clientId:$scope.selectedAppView.clientId,appName:$scope.selectedAppView.appName},payload.type="ivrVoice",payload.enable=$scope.channel.enable,payload.isSandboxEnabled=$scope.channel.isSandboxEnabled||!1,payload.sandboxDetails=$scope.channel.sandboxDetails,$scope.onSave(payload,"","","","IVR")},$scope.next=function(step){$(".slack-channel-page").scrollTop(0),$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#ivroauthuri2"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#ivroauthuri2"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),3===step&&$("#saveBtn").addClass("zIndex"),$(".slack-channel-page").scrollTop(0)},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.onSelectedApp=function(newVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},$scope.$watch("selectedApp",function(newVal,oldVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},!0),$scope.exit=$scope.goToHome,$scope.resetClientId=function(){BTStreamsService.ivrVoiceReset($scope.stream._id).then(function(res){$scope.stream=res.data,$workflowService.selectedStream(res.data);var streamChannels=[];streamChannels=res.data.channels,NotificationService.notify(i18n.i18nString("reset_successful"),"success"),$.each(streamChannels,function(i,specficChannel){"ivrVoice"==specficChannel.type&&specficChannel.isSandboxEnabled&&specficChannel.sandboxDetails&&specficChannel.sandboxDetails.phoneNo&&($scope.value.sandboxDetails=specficChannel.sandboxDetails,$scope.channel.sandboxDetails=specficChannel.sandboxDetails)})},function(error){NotificationService.notify(i18n.i18nString("chnl_reset_failed"),"error")})},$scope.setApp=function(app){$scope.selectedAppView=app,$scope.selectedApp=app.clientId,setTimeout(function(){$("#select2").select2("val",app.clientId)},100)},$scope.listener=function(msg,args){if("app.created"===msg)$scope.apps.push(args);else if("app.edited"===msg){var _index=_.findIndex($scope.apps,function(o){return o.clientId===args.clientId});_index>-1&&($scope.apps[_index]=args)}$scope.setApp(args)},$scope.createNewApp=function(){$scope.selectedApp="create"},$scope.editApp=function(){var app=$scope.selectedAppView;$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Edit",context:"addChannel",cb:$scope.listener,app:app,bot:stream}}}})},$scope.createApp=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Create",context:"addChannel",cb:$scope.listener,bot:stream}}}})},$scope.showHideSecret=function(){$scope.secretKeyShown=!0},getApps();new Clipboard("[data-clipboard-target]");$timeout(function(){$(".ivr-channel-page").scrollTop(2)},1e3),$scope.saveIvrStream=function(){$scope.callback.createIVRStream()}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("jabberChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/jabber-channel/jabber-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("jabber_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.serverUrl=env_conf.API_SERVER_URL,$scope.assetsBase=env_conf["assets-url"],$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel.enable=newVal.enable,$scope.channel.app_name=stream.name,$scope.channel.app_token=newVal.app_token,$scope.channel.post_url=newVal.post_url,console.log($scope.channel))}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$scope.channel.webhook_url=$scope.serverUrl+"/hooks/jabber/"+stream._id,$scope.save=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.hannel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,void NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error");var payload={app_token:$scope.channel.app_token,post_url:$scope.channel.post_url,type:"jabber",enable:$scope.channel.enable};$scope.onSave(payload,"","","","Jabber")},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_SKYPE,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,$(".slack-channel-page").scrollTop(0),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#jabber_webhook_url2"]');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},1e3)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("koreChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/kore-channel/kore-channel.html",controller:["$scope","$workflowService","$timeout","form_util","env_conf","i18n",function($scope,$workflowService,$timeout,form_util,env_conf,i18n){function notifyStatus(streamName,msg){NotificationService.notify(streamName+msg+" successfully","success")}function slashCommand(id){id=$workflowService.selectedStream()._id||id;var msg=id?i18n.i18nString("updated_label"):i18n.i18nString("saved_label_lowercase");if($scope.commandCtx.createSlashCommand){var command=$scope.botdata.command||{};return $scope.commandCtx.streamId=id,0===Object.keys(command).length?void notifyStatus($workflowService.selectedStream().name,msg):($scope.commandSaveInProgress=!0,$scope.commandCtx.createSlashCommand().then(function(res){$scope.commandSaveInProgress=!1,notifyStatus($scope.newStreamData.name,msg)},function(err){var errorMsg=err.data.errors[0].msg;$scope.commandSaveInProgress=!1,NotificationService.notify(errorMsg,"error")}))}notifyStatus($workflowService.selectedStream(),msg)}$scope.stream=$workflowService.selectedStream(),$scope.streamState=$workflowService.selectedStreamState(),$scope.commandCtx={},$scope.botdata={},$scope.commandSaveInProgress=!1,$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.saveKoreChannel=function(){var payload={type:"kore",enable:$scope.$parent.kore.enable};$scope.onSave(payload,"","","","Kore.ai")},$scope.saveSlashCommand=function(){return $scope.koreChannelForm&&$scope.koreChannelForm.$invalid?(form_util.touch($scope.koreChannelForm),!1):void slashCommand()},$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.commandCtx.streamId=$workflowService.selectedStream()._id,$timeout(function(){$scope.commandCtx.getSlashCommands()}),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("lineChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/line-channel/line-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,form_util,i18n){var clipWebhook_url,clipVerify_token,clipVerify_ID,stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("line_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.channelAuth={},$scope.btTestFormApi={},$scope.btTestStatus={},$scope.assetsBase=env_conf["assets-url"],$scope.currentStep={},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_LINE,$scope.channelHeaderCallback=$scope,$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel=newVal||{enable:!0,streamId:stream._id,name:stream.name,app_name:stream.name},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/hooks/line/"+stream._id,$scope.channel.webhook_url=newVal.webhook_url,$scope.channel.verify_token=newVal.verify_token,$scope.channel.channel_ID=newVal.channel_ID)}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".line-channel-page").scrollTop(0)},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/hooks/line/"+stream._id,$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);var payload={};payload.app_token=$scope.channel.app_token,payload.app_secret=$scope.channel.app_secret,payload.channel_ID=$scope.channel.channel_ID,payload.app_name=$scope.channel.name,payload.type="line",payload.enable=$scope.channel.enable,$scope.onSave(payload,"","","","Line")},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#lineoauthuri2"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#lineoauthuri2"]'),clipVerify_ID=new Clipboard('[data-clipboard-target="#lineoauthuri2"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,$scope.isSafariid=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_ID.on("success",function(e){}),clipVerify_ID.on("error",function(e){$scope.isSafariid=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".line-channel-page").scrollTop(0)},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$timeout(function(){$(".inner-scroll").scrollTop(0)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("livePerson",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/live-person/live-person.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,form_util,i18n){var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("LivePerson_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.channel.isSDKEnabled=!1,$scope.channel.isChatAPIEnabled=!1,$scope.channelAuth={},$scope.btTestFormApi={},$scope.btTestStatus={},$scope.assetsBase=env_conf["assets-url"],$scope.currentStep={},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_LINE,$scope.channelHeaderCallback=$scope,$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel.enable=newVal.enable,$scope.channel.accountId=newVal.accountId,$scope.channel.appKey=newVal.appKey,$scope.channel.secret=newVal.secret,$scope.channel.accessToken=newVal.accessToken,$scope.channel.accessTokenSecret=newVal.accessTokenSecret,$scope.channel.username=newVal.username,$scope.channel.isChatAPIEnabled=newVal.isChatAPIEnabled,$scope.channel.isSDKEnabled=newVal.isSDKEnabled)}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".line-channel-page").scrollTop(0)},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/hooks/line/"+stream._id,$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);if($scope.boxChecked=$("input[type=checkbox]:checked").length,!$scope.boxChecked)return void($scope.checkBoxInValidate=!0);var payload={};payload.loginMethod="apikey",payload.accountId=$scope.channel.accountId,payload.username=$scope.channel.username,payload.appKey=$scope.channel.appKey,payload.secret=$scope.channel.secret,payload.accessToken=$scope.channel.accessToken,payload.accessTokenSecret=$scope.channel.accessTokenSecret,payload.type="liveperson",payload.enable=$scope.channel.enable,payload.isSDKEnabled=$scope.channel.isSDKEnabled,payload.isChatAPIEnabled=$scope.channel.isChatAPIEnabled,$scope.onSave(payload,"","","","Live Person")},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){}),$(".line-channel-page").scrollTop(0)},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$timeout(function(){$(".line-channel-page").scrollTop(2)},2e3),$scope.exit=$scope.goToHome,$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("liveBank",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/livebank-channel/livebank-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","NotificationService","uuid4","$translator","form_util","$modal","$q","AppsDataService","$applicationService","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,NotificationService,uuid4,$translator,form_util,$modal,$q,AppsDataService,$applicationService,i18n){function getApps(){$scope.loadingAddChannel=!0,$q.all([AppsDataService.getAppsList($scope.stream._id),AppsDataService.getBotsList()]).then(function(res){if($scope.loadingAddChannel=!1,res[1]&&res[1].data?$scope.avalSreams=res[1].data:$scope.avalSreams=[],res[0]&&res[0].data&&res[0].data.apps){$scope.apps=res[0].data.apps;var a_appClientIds=_.pluck($scope.apps,"clientId");if($workflowService.selectedStream().sdkSubscription&&-1===$.inArray($workflowService.selectedStream().sdkSubscription.sdkClientId,a_appClientIds)){var appObject=$workflowService.selectedStream().sdkSubscription;appObject.clientId=appObject.sdkClientId,appObject.isNonEditable=!0,$scope.apps.push(appObject)}var liveBankDet=$workflowService.selectedStream().channels.filter(function(val){return"livebank"===val.type})[0];if(liveBankDet&&"enabled"===liveBankDet.status.toLowerCase()&&($scope.channel.callbackUrl=liveBankDet.lbHookUrl,$scope.selectedApp=liveBankDet.app.clientId),$scope.value&&$scope.value.app){var _selApps=$scope.apps.filter(function(app){return app.clientId===$scope.value.app.clientId});_selApps&&_selApps.length&&($scope.setApp(_selApps[0]),$scope.isNonEditable=_selApps[0].isNonEditable)}$scope.apps=_.filter($scope.apps,function(o){return o.clientId})}else $scope.apps=[]},function(err){$scope.loadingAddChannel=!1,NotificationService.alertNotify(i18n.i18nString("get_apps"))})}var clipWebhook_url,clipVerify_token,stream=$workflowService.selectedStream();$scope.stream=$workflowService.selectedStream(),$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("ivr_voice_Account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.channelAuth={},$scope.btTestFormApi={},$scope.btTestStatus={},$scope.assetsBase=env_conf["assets-url"],$scope.currentStep={},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_IVR,$scope.channelHeaderCallback=$scope,$scope.selectConfig={placeholder:i18n.i18nString("select_a_key"),allowClear:!1,minimumResultsForSearch:-1},$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel=newVal||{enable:!0,streamId:stream._id,name:stream.name,app_name:stream.name},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/chatbot/livebank/hooks/"+stream._id)}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".ivr-channel-page").scrollTop(0)},$scope.channel.oAuthRedirectURI=env_conf.API_SERVER_URL+"/chatbot/livebank/hooks/"+stream._id,$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);if(!$scope.selectedAppView.clientId)return void NotificationService.alertNotify("",i18n.i18nString("please_select_app"),"error");var payload={};payload.app={clientId:$scope.selectedAppView.clientId,appName:$scope.selectedAppView.appName},payload.type="livebank",payload.enable=$scope.channel.enable,payload.lbHookUrl=$scope.channel.callbackUrl,BTStreamsService.livebankChannel($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation($scope.channel.type),NotificationService.notify(i18n.i18nString("bt_chnl_live_bank_chnl_added_success"),"success")},function(err){console.log(err)})},$scope.next=function(step){$(".slack-channel-page").scrollTop(0),$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#ivroauthuri2"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#ivroauthuri2"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".slack-channel-page").scrollTop(0)},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.onSelectedApp=function(newVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},$scope.$watch("selectedApp",function(newVal,oldVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},!0),$scope.exit=$scope.goToHome,$scope.setApp=function(app){$scope.selectedAppView=app,$scope.selectedApp=app.clientId,setTimeout(function(){$("#select2").select2("val",app.clientId)},100)},$scope.listener=function(msg,args){if("app.created"===msg)$scope.apps.push(args);else if("app.edited"===msg){var _index=_.findIndex($scope.apps,function(o){return o.clientId===args.clientId});_index>-1&&($scope.apps[_index]=args)}$scope.setApp(args)},$scope.createNewApp=function(){$scope.selectedApp="create"},$scope.editApp=function(){var app=$scope.selectedAppView;$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Edit",context:"addChannel",cb:$scope.listener,app:app,bot:stream}}}})},$scope.createApp=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Create",context:"addChannel",cb:$scope.listener,bot:stream}}}})},$scope.showHideSecret=function(){$scope.secretKeyShown=!0},getApps();new Clipboard("[data-clipboard-target]");$timeout(function(){$(".ivr-channel-page").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("matterMostChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/matterMost-channel/matterMost-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("matterMost_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.integration={},$scope.integration.type="webhook",$scope.serverUrl=env_conf.API_SERVER_URL,$scope.assetsBase=env_conf["assets-url"],$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel.enable=newVal.enable,$scope.channel.app_name=stream.name,$scope.channel.verification_token=newVal.verification_token,$scope.channel.post_url=newVal.post_url,$scope.channel.mattermost_hosturl=newVal.host,$scope.channel.access_token=newVal.accessToken,$scope.channel.botUserName=newVal.botUserName||"")}),$scope.selectRadio=function(name){"webhook"===name?($scope.integration.type="webhook",$timeout(function(){$("#webhookIntegration")[0].checked=!0})):"webSocket"===name&&($scope.integration.type="webSocket",$timeout(function(){$("#webSocketIntegration")[0].checked=!0}))},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$scope.channel.webhook_url=$scope.serverUrl+"/hooks/mattermost/"+stream._id,$scope.save=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.hannel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,void NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error");var payload={};"webhook"===$scope.integration.type?payload={verification_token:$scope.channel.verification_token,post_url:$scope.channel.post_url,type:"mattermost",enable:$scope.channel.enable,integrationType:"webhook"}:"webSocket"===$scope.integration.type&&(payload={accessToken:$scope.channel.access_token,host:$scope.channel.mattermost_hosturl,type:"mattermost",integrationType:"websocket",enable:$scope.channel.enable,botUserName:$scope.channel.botUserName.trim()||""}),$scope.onSave(payload,"","","","Mattermost")},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_SKYPE,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,$(".slack-channel-page").scrollTop(0),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#mattermost_webhook_url2"]');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},1e3)},$timeout(function(){$(".inner-scroll").scrollTop(2),$("#webhookIntegration")[0].checked=!0;var mattermostData=stream.channels.filter(function(val){return"mattermost"===val.type});mattermostData&&mattermostData[0]&&("webhook"===mattermostData[0].integrationType?($scope.integration.type="webhook",$timeout(function(){$("#webhookIntegration")[0].checked=!0})):"websocket"===mattermostData[0].integrationType&&($scope.integration.type="webSocket",$timeout(function(){$("#webSocketIntegration")[0].checked=!0})))},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("msChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/ms-channel/ms-channel.html",controller:["$scope","$element","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$element,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream(),processApps=$workflowService.processAppsData()||[];$scope.sumocb={processcb:{changeText:!0}},$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("ms_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name},$scope.channel.enable=!0,$scope.assetsBase=env_conf["assets-url"],$scope.processApps=[],$scope.channel.selectedProcessApp=[],processApps.forEach(function(value){$scope.processApps.push({value:value.name,type:value._id})}),$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.idp.name,$scope.channel.app_name=stream.name,$scope.channel.streamId=newVal.idp.streamId,$scope.channel.clientID=newVal.idp.formfields.filter(function(obj){return"client_id"===obj.key})[0]["default"],$scope.channel.clientSecret=newVal.idp.formfields.filter(function(obj){return"client_secret"===obj.key})[0]["default"],$scope.channel.enableNotification=newVal.enableNotification,newVal.enableNotification&&newVal.notification&&($scope.channel.processClientID=newVal.notification.client_id,$scope.channel.processClientSecret=newVal.notification.client_secret,$scope.channel.processTenantId=newVal.notification.tenantId,$scope.channel.processeAppId=newVal.notification.teamsAppId,$scope.channel.processNotification=newVal.notification.processappScopes.length?!0:!1,newVal.notification.processappScopes.forEach(function(val){$scope.channel.selectedProcessApp.push(val.wfId)})),console.log($scope.channel))}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id
},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"msteams"}).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url},function(err){$scope.channelAuth={}}),$scope.save=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.channel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error"),void $timeout(function(){$element.find(".slack-channel-page").scrollTop($element.find(".slack-channel-page").height()+100),form.clientID.$dirty&&""===$element.find('[name="clientID"]').val().trim()?$element.find('[name="clientID"]').focus():form.clientSecret.$dirty&&""===$element.find('[name="clientSecret"]').val().trim()&&$element.find('[name="clientSecret"]').focus()},350);var payload={_id:$scope.channel._id,name:$scope.channel.name,enable:$scope.channel.enable,appConfig:{tokenURL:"https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token"},formfields:[{title:"client_id",key:"client_id","default":$scope.channel.clientID,isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"client_secret",key:"client_secret","default":$scope.channel.clientSecret,isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"grant_type",key:"grant_type","default":"client_credentials",isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"scope",key:"scope","default":"https://api.botframework.com/.default",isRequired:!0,fieldType:"textbox",visibility:"hidden"}],streamId:$scope.channel.streamId,channel_auth:"msteams",sso_type:"custom",contentType:"application/x-www-form-urlencoded",method:"POST",enableNotification:$scope.channel.enableNotification};if($scope.channel.enableNotification&&(payload.notification={client_id:$scope.channel.processClientID,client_secret:$scope.channel.processClientSecret,tenantId:$scope.channel.processTenantId,teamsAppId:$scope.channel.processeAppId,enableProcessNotification:!0},$scope.channel.selectedProcessApp.length)){var selected=[];$scope.channel.selectedProcessApp.forEach(function(val){_.find($scope.processApps,{type:val})&&selected.push({name:_.find($scope.processApps,{type:val}).value,wfId:val})}),payload.notification.processappScopes=selected}if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("msteams"),NotificationService.notify(i18n.i18nString("bt_chnl_ms_chnl_edited_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("msteams"),NotificationService.notify(i18n.i18nString("bt_chnl_ms_chnl_added_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_MS,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome()},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#ms_webhook_url2"]');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},1e3),$scope.steps[step-1].active=!0,$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("rcsBusiness",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/rcs-business/rcs-business.html",scope:{closeSlider:"=",stateUpdate:"="},controller:["$scope","$workflowService","$timeout","BTStreamsService","env_conf","$applicationService","NotificationService","uuid4","BTIdpService","i18n",function($scope,$workflowService,$timeout,BTStreamsService,env_conf,$applicationService,NotificationService,uuid4,BTIdpService,i18n){function rcsStateCheck(){var rcsInfo=channelsList.filter(function(val){return"rcs"===val.type})[0];rcsInfo&&rcsInfo.status&&($scope.content.showEnable=!1,"requested"===rcsInfo.status?($scope.content.status="requested",$scope.content.message=i18n.i18nString("bt_chnl_form_requested_popOver")):"readyToTest"===rcsInfo.status?($scope.content.status="readyToTest",$scope.channel.fallback=rcsInfo.fallbackURL,$scope.content.message=i18n.i18nString("bt_chnl_form_readytoTest_popOver")):"readyToLaunch"===rcsInfo.status?($scope.content.status="readyToLaunch",$scope.channel.fallback=rcsInfo.fallbackURL,$scope.content.message=i18n.i18nString("bt_chnl_form_readytoLaunch_popOver")):"launchInProgress"===rcsInfo.status?($scope.content.status="launchInProgress",$scope.channel.fallback=rcsInfo.fallbackURL,$scope.content.message=i18n.i18nString("bt_chnl_form_launchInProgress_popOver")):"launched"===rcsInfo.status&&($scope.content.status="launched",$scope.content.message=i18n.i18nString("bt_chnl_form_launched_popOver")))}function getId(){return"ap-"+uuid4.generate()}function getStream(){BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){channelsList=angular.copy(res.data.channels),rcsStateCheck()},function(error){console.error("getStreams Failed",error)})}var channelsList=[];$scope.streamState=$workflowService.selectedStreamState();var botName=$workflowService.selectedStream().name;$scope.currentStep={},$scope.content={message:"",status:"",showEnable:!0},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.channel={enable:!0,launch:!1,msgEvents:env_conf.API_SERVER_URL+"/api/public/stream/"+$workflowService.selectedStream()._id+"/rcs/msgevents",fallback:""},$scope.assetsBase=env_conf["assets-url"],$scope.rcsBusinessImage=env_conf["context-url"]+"/img/rcsBusiness.png",getStream(),$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},250)},$scope.isSaveVisible=function(){return"published"===$scope.streamState&&"readyToTest"!=$scope.content.status&&"requested"!=$scope.content.status||"readyToTest"!=$scope.content.status&&"requested"!=$scope.content.status},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),$(".fb-channel-page").scrollTop(0),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipA=new Clipboard('[data-clipboard-target="#rcsBusinessFallback"');clipA.on("success",function(e){}),clipA.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)});var clipB=new Clipboard('[data-clipboard-target="#rcsBusinessMsgEvents"');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$timeout(function(){$(".inner-scroll").scrollTop(2)},250)},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()};$scope.save=function(){if(!$scope.channel.enable&&!$scope.channel.launch||$scope.channel.enable&&!$scope.channel.launch&&"readyToLaunch"===$scope.content.status)return void $scope.goToHome();var rcs=channelsList.filter(function(val){return"rcs"===val.type}),idpId="";rcs&&rcs[0]&&rcs[0].idp&&(idpId=rcs[0].idp._id);var payload={_id:idpId,enable:$scope.channel.enable,status:"requested",appConfig:{},streamId:$workflowService.selectedStream()._id,sso_type:"oauth2",channel_auth:"rcs",name:botName+" rcs account"};if("requested"!==$scope.content.status&&""!==$scope.content.status&&(payload.status=$scope.content.status),""!==payload._id){var id=payload._id;delete payload._id,delete payload.appConfig,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),NotificationService.notify(i18n.i18nString("bt_chnl_rcs_chnl_edited_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),NotificationService.notify(i18n.i18nString("bt_chnl_rcs_chnl_added_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")});"readyToLaunch"===$scope.content.status&&$scope.channel.launch&&BTStreamsService.rcsLaunch($applicationService.userInfo().userId,$workflowService.selectedStream()._id,{}).then(function(res){NotificationService.notify(i18n.i18nString("bt_chnl_rcs_chnl_launch_inprog"),"success"),$scope.goToHome(),$scope.stateUpdate.rcsStateCheck(),rcsStateCheck()},function(err){NotificationService.notify(i18n.i18nString("bt_chnl_unable_to_launch"),"error")})}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("ringCentralEngageChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/ring-central-engage-channel/ring-central-engage.html",controller:["$scope","$element","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$element,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream(),processApps=$workflowService.processAppsData()||[];$scope.sumocb={processcb:{changeText:!0}},$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("ringCentralEngage_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name},$scope.channel.enable=!0,$scope.assetsBase=env_conf["assets-url"],$scope.processApps=[],$scope.channel.selectedProcessApp=[],processApps.forEach(function(value){$scope.processApps.push({value:value.name,type:value._id})}),$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.idp.name,$scope.channel.app_name=stream.name,$scope.channel.streamId=newVal.idp.streamId,$scope.channel.senderId=newVal.senderId,$scope.channel.host_url=newVal.host_url,$scope.channel.verificationToken=newVal.idp.appConfig.verificationToken,$scope.channel.access_token=newVal.idp.appConfig.access_token,console.log($scope.channel))}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"rcengage"}).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url},function(err){$scope.channelAuth={}}),$scope.save=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.channel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error"),void $timeout(function(){$element.find(".slack-channel-page").scrollTop($element.find(".slack-channel-page").height()+100),form.clientID.$dirty&&""===$element.find('[name="clientID"]').val().trim()?$element.find('[name="clientID"]').focus():form.clientSecret.$dirty&&""===$element.find('[name="clientSecret"]').val().trim()?$element.find('[name="clientSecret"]').focus():form.authToken.$dirty&&""===$element.find('[name="authToken"]').val().trim()&&$element.find('[name="authToken"]').focus()},350);var payload={_id:$scope.channel._id,name:$scope.channel.name,type:"rcengage",enable:$scope.channel.enable,appConfig:{access_token:$scope.channel.access_token,verificationToken:$scope.channel.verificationToken},streamId:$scope.channel.streamId,channel_auth:"rcengage",displayName:"RingCentral Engage",webhook_url:$scope.channel.webhook_url,sso_type:"custom",host_url:$scope.channel.host_url,notification:{acl:[]}};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("rcengage"),NotificationService.notify(i18n.i18nString("bt_chnl_rcEngage_chnl_edited_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("rcengage"),NotificationService.notify(i18n.i18nString("bt_chnl_rcEngage_chnl_added_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_MS,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome()},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#ms_webhook_url2"]');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},1e3),$scope.steps[step-1].active=!0,$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("ringcentralChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/ringcentral-channel/ringcentral-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){function getIdpByName(){BTIdpService.getIdpByName(_idpName,$workflowService.selectedStream()._id).then(function(res){$scope.idpConfig=res.data,$scope.idpConfig&&$scope.idpConfig.appConfig&&($scope.channel.clientSecret=$scope.idpConfig.appConfig.clientSecret,$scope.channel.clientID=$scope.idpConfig.appConfig.clientID,idpID=$scope.idpConfig._id)},function(err){NotificationService.notify(i18n.i18nString("failed_fetch_idp"),"error"),$scope.idpConfig={}})}function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState();var streamUserAccountId="",idpID="";$scope.btTestFormApi={},$scope.btTestStatus={},$scope.channel={name:i18n.i18nString("ringcentral_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.channel.mode="sandbox";var authorizationURLs={production:"https://platform.ringcentral.com/restapi/oauth/authorize",sandbox:"https://platform.devtest.ringcentral.com/restapi/oauth/authorize"},tokenURLs={production:"https://platform.ringcentral.com/restapi/oauth/token",sandbox:"https://platform.devtest.ringcentral.com/restapi/oauth/token"};$scope.assetsBase=env_conf["assets-url"],$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.name,$scope.channel.mode=newVal.mode,$scope.channel.app_name=stream.name,$scope.channel.streamId=newVal.idp.streamId,streamUserAccountId=newVal.streamUserAccountId||"",console.log($scope.channel))}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.oAuthRedirectURI=res.data.callbackURL.split("/:idp")[0]});var _idpName=stream.name+" ringcentral account";$scope.idpConfig="",getIdpByName(),$scope.createIDPAndCheckAuthorization=function(ringCentralForm){$scope.saveIDP(ringCentralForm)},$scope.saveIDP=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.hannel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,void NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error");var payload={_id:$scope.idpConfig._id,name:_idpName,enable:$scope.channel.enable,appConfig:{authorizationURL:authorizationURLs[$scope.channel.mode],tokenURL:tokenURLs[$scope.channel.mode],clientID:$scope.channel.clientID,clientSecret:$scope.channel.clientSecret,scope:""},streamId:$scope.channel.streamId,channel_auth:"ringcentral",sso_type:"oauth2"};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){getIdpByName(),$scope.testIdp(res.data._id)},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){getIdpByName(),$scope.testIdp(res.data._id)},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);if(!streamUserAccountId)return void NotificationService.notify(i18n.i18nString("bt_chnl_pls_setup_authorization"),"error");var payload={};payload.streamUserAccountId=streamUserAccountId,payload.idp=idpID||$scope.channel.app_token,payload.mode=$scope.channel.mode,payload.type="ringcentral",payload.enable=$scope.channel.enable,$scope.onSave(payload,"","","","Ringcentral Glip")},$scope.testIdp=function(idpId){idpID=idpId,$scope.btTestFormApi.afterInit=function(){$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success,responseData){success?(streamUserAccountId=responseData.streamAccountId,NotificationService.notify(i18n.i18nString("auth_test_success"),"success")):(streamUserAccountId="",NotificationService.notify(i18n.i18nString("auth_test_failed"),"error")),$scope.btTestFormApi.close()},$scope.btTestFormApi.init({_id:idpId?idpId:$scope.newAuth&&$scope.newAuth.selected._id,type:"idp",testFor:"idp",isFromRingCentral:!0})},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_RINGCENTRAL,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome()},$scope.bulbSvg=env_conf["context-url"]+"/assets/images/bulbicon.svg",$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,2===step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#ringcentraloauthuri2"');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.filter("otherbots",function(){return function(bots,stream){var filtered=_.filter(bots,function(o){return o._id&&o._id!==stream._id});return _.pluck(filtered,"name").join(", ")}}),_module.filter("mask",function(){return function(str){return str?Array(str.length).join("*"):""}}),_module.directive("rtmChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/rtm-channel/rtm-channel.html",controller:["$scope","$workflowService","$location","env_conf","_constants_","BTStreamsService","$timeout","$routeParams","$rootScope","$modal","AppsDataService","NotificationService","$q","i18n","$translator","$sce",function($scope,$workflowService,$location,env_conf,_constants_,BTStreamsService,$timeout,$routeParams,$rootScope,$modal,AppsDataService,NotificationService,$q,i18n,$translator,$sce){function setTabs(){$scope.steps=[{step:1,active:!0,name:i18n.i18nString("configure")},{step:2,active:!1,name:i18n.i18nString("customize_theme")}]}function prepareIframeUrlForScene(scene){window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.sdkTeamUrl=$sce.trustAsResourceUrl("http://localhost:4200/builderx/sdk-personalization/"+$scope.stream._id+"/VA?showSave=false"):$scope.sdkTeamUrl=window.appConfig.API_SERVER_URL+"/builderx/sdk-personalization/"+$scope.stream._id+"/VA?showSave=false"}function getApps(){$scope.loadingAddChannel=!0,$q.all([AppsDataService.getAppsList($scope.stream._id)]).then(function(res){if($scope.loadingAddChannel=!1,res[0]&&res[0].data&&res[0].data.apps){$scope.apps=res[0].data.apps,$scope.JWEPublicKey=res[0].data.publicKeys.keys[0];var a_appClientIds=_.pluck($scope.apps,"clientId");if($workflowService.selectedStream().sdkSubscription&&-1===$.inArray($workflowService.selectedStream().sdkSubscription.sdkClientId,a_appClientIds)){var appObject=$workflowService.selectedStream().sdkSubscription;appObject.clientId=appObject.sdkClientId,appObject.isNonEditable=!0,$scope.apps.push(appObject)}if($scope.$parent.rtm&&$scope.$parent.rtm.app){var _selApps=$scope.apps.filter(function(app){return app.clientId===$scope.$parent.rtm.app.clientId});$scope.setApp(_selApps[0]),$scope.isNonEditable=_selApps[0].isNonEditable}else if($workflowService.selectedStream().appPreferences&&$workflowService.selectedStream().appPreferences.rtmAppId){var _selApps1=$scope.apps.filter(function(app){return app.clientId===$workflowService.selectedStream().appPreferences.rtmAppId});$scope.setApp(_selApps1[0]),$scope.isNonEditable=_selApps1[0].isNonEditable}else $scope.apps&&$scope.apps.length&&$scope.setApp($scope.apps[0]);$scope.apps=_.filter($scope.apps,function(o){return o.clientId}),$scope.$parent.rtm.enable&&getInstallationInfo()}else $scope.apps=[]},function(err){$scope.loadingAddChannel=!1,NotificationService.alertNotify(i18n.i18nString("get_apps"))})}function getInstallationInfo(){BTStreamsService.getEmbedwebsdkDetails($scope.stream._id).then(function(res){if(res&&res.data&&($scope.installation=res.data,$scope.installation.domains.length||($scope.installation.domains=[""]),$scope.installation)){var code=$scope.installation.cssTag+"\n"+$scope.installation.scriptTag+"\n"+$scope.scriptTag,embedCodeEle=document.getElementById("embedCode");embedCodeEle.innerText=code,$scope.embedCode=code}},function(errRes){errRes&&errRes.data&&errRes.data.errors?NotificationService.notify(errRes.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})}setTabs(),$scope.stepClick=function(step){$scope.next(step),$(".cisco-channel-page").scrollTop(0)},$scope.next=function(step){$(".slack-channel-page").scrollTop(0),$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0},$scope._=_,$scope.stream=$scope.$parent.stream,$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.secretKeyShown=!1,$scope.speech={},$scope.speech.sttEnabled=!1,$scope.speech.sttEngine="kore",$scope.assetsBase=env_conf["assets-url"],$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.closeArrow=window.appConfig.CONTEXT_PATH+"/assets/landingImages/closeCross.png",$scope.selectConfig={placeholder:i18n.i18nString("select_a_key"),allowClear:!1,minimumResultsForSearch:-1},$scope.installation={},prepareIframeUrlForScene(),$scope.scriptTag="<script>KoreSDK.show(KoreSDK.chatConfig);</script>",$scope.embedCode={},$scope.isChannelEnabled=angular.copy($scope.$parent.rtm.enable);var websdkChannel=_.find($scope.$parent.channels,function(item){return"widgetsdk"===item.id}),rtmChannel=_.find($scope.$parent.channels,function(item){return"rtm"===item.id});$scope.iswidgetsdkChannelEnabled=angular.copy("Not Setup"===websdkChannel.status?!1:!0),$scope.allBots=$workflowService.streamsAll(),$scope.websdk={enable:rtmChannel&&rtmChannel.widgetSDKConfig&&rtmChannel.widgetSDKConfig.enable?!0:!1},$scope.widgetsCount=$scope.stream._taskCounts.widgets[$scope.streamState.state],$scope.panelsCount=$scope.stream._taskCounts.panels[$scope.streamState.state],$scope.goToHome=function(){setTabs(),$scope.$parent.goToHome(),$scope.$parent.rtm.enable=!1},setTimeout(function(){$(".webMobileClientChannel").scrollTop(1)},700);for(var i=0;i<$scope.stream.channels.length;i++)if("rtm"===$scope.stream.channels[i].type){$scope.speech.sttEnabled=$scope.stream.channels[i].sttEnabled||!1;break}$(".JSONDiv a").click(function(){$("#JWTToken").show()}),$scope.setApp=function(app){$scope.selectedAppView=app,setTimeout(function(){app&&$("#select2").select2("val",app.clientId)},100)},$scope.listener=function(msg,args){if("app.created"===msg)$scope.apps.push(args);else if("app.edited"===msg){var _index=_.findIndex($scope.apps,function(o){return o.clientId===args.clientId});_index>-1&&($scope.apps[_index]=args)}$scope.setApp(args)},$scope.createEditTheme={name:""},$scope.openCreateEditModal=function(){jsEvents.postMessageToChildIframes("themeStatus","#sdkCustomization",$scope.createEditTheme)};var rtmUpdate=$rootScope.$on("rtmThemeUpdates",function($event,rtmThemeUpdates){rtmThemeUpdates&&"closeCancelSDKTheme"===rtmThemeUpdates.action&&$scope.goToHome(!0)});$scope.$on("$destroy",function(){rtmUpdate()}),$scope.onThemeSave=function(){jsEvents.postMessageToChildIframes("onSdkThemeSave","#sdkCustomization",$scope.createEditTheme)},$scope.onSelectedApp=function(newVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},$scope.editApp=function(){var app=$scope.selectedAppView;$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.allBots},config:function(){return{type:"Edit",context:"addChannel",cb:$scope.listener,app:app,bot:$scope.stream}}}})},$scope.createApp=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.allBots},config:function(){return{type:"Create",context:"addChannel",cb:$scope.listener,bot:$scope.stream}}}})},$scope.onCancel=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.saveRTM=function(isPublish){var domains=angular.copy($scope.installation.domains);if(domains){var findInd=domains.findIndex(function(domain){return!domain});-1!==findInd&&domains.splice(findInd,1)}BTStreamsService.postEmbedwebsdkDetails($scope.stream._id,{domains:domains}).then(function(res){var payload={};payload.type="rtm",payload.name="Web / Mobile Client",payload.app={clientId:$scope.selectedAppView.clientId,appName:$scope.selectedAppView.appName,key:$scope.selectedAppView.key},payload.isAlertsEnabled=$scope.$parent.rtm.isAlertsEnabled,payload.enable=$scope.$parent.rtm.enable,payload.sttEnabled=$scope.speech.sttEnabled,payload.sttEngine=$scope.speech.sttEngine,$scope.websdk.enable&&(payload.widgetSDKConfig={},payload.widgetSDKConfig.type="widgetsdk",payload.widgetSDKConfig.name="Widget SDK",payload.widgetSDKConfig.app={clientId:$scope.selectedAppView.clientId,appName:$scope.selectedAppView.appName},payload.widgetSDKConfig.enable=$scope.websdk.enable,payload.widgetSDKConfig.sttEnabled=$scope.speech.sttEnabled,payload.widgetSDKConfig.sttEngine=$scope.speech.sttEngine),console.log(payload),$scope.onSave(payload,"","","","Web / Mobile Client"),isPublish&&setTimeout(function(){$scope.selectComponent("publish")},2e3)},function(errRes){errRes&&errRes.data&&errRes.data.errors?NotificationService.notify(errRes.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})},$scope.showHideSecret=function(){$scope.secretKeyShown=!0},$scope.selectComponent=function(innerRightViewElement){$scope.$parent&&$scope.$parent.setSubMenuToOpen&&$scope.$parent.setSubMenuToOpen(innerRightViewElement)},$scope.saveAndPublish=function(){$scope.saveRTM(!0)},getApps();new Clipboard("[data-clipboard-target]");$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3),$scope.copyJWTToken=function(containerid){var textarea=document.createElement("textarea");textarea.id="temp_element",textarea.style.height=0,document.body.appendChild(textarea),textarea.value=document.getElementById(containerid).innerText;var selector=document.querySelector("#temp_element");selector.select(),document.execCommand("copy"),document.body.removeChild(textarea),NotificationService.notify(i18n.i18nString("jwe_key_copy"),"success")},$scope.changeChannel=function(){$scope.$parent.rtm.enable&&(getInstallationInfo(),$scope.apps.length||$scope.createApplication())},$scope.changeWebsdkChannel=function(){console.log($scope.websdk);
},$scope.createApplication=function(){var payload={algorithm:"HS256",appName:$scope.stream.name,bots:[$scope.stream._id],isJtiEnforced:!1,isJweEnforced:!1,pushNotifications:{enable:!1,webhookUrl:""},scope:["anonymouschat","registration"]},_urlParams={streamId:$scope.stream._id};$translator.translate("bt.apps.create",_urlParams,payload).then(function(res){res&&res.data&&200===res.status?(getApps(),$scope.setApp(res.data[0])):NotificationService.notify(i18n.i18nString("App_Already_Exists"),"error")},function(errRes){errRes&&errRes.data&&errRes.data.errors?errRes.data.errors.length&&"AppAlreadyExists"===errRes.data.errors[0].code?NotificationService.notify(i18n.i18nString("App_Already_Exists"),"error"):NotificationService.notify(errRes.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})},$scope.downloadSDK=function(){window.open("https://github.com/Koredotcom/web-kore-sdk")},$scope.redirectToVA=function(url){window.open(url)},$scope.copyToClipboard=function(text){var textarea=document.createElement("textarea");document.body.appendChild(textarea),textarea.value=text,textarea.select(),textarea.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(textarea),NotificationService.notify("Copied successfully","success")},$scope.addDomains=function(){if($scope.installation.domains){var findEmpty=$scope.installation.domains.filter(function(domain){return!domain});if(findEmpty&&findEmpty.length)return;$scope.installation.domains.push(""),setTimeout(function(){$("#installationDomainsInp"+($scope.installation.domains.length-1)).focus()},100)}},$scope.deleteDomains=function(index){$scope.installation.domains&&$scope.installation.domains.length>1&&$scope.installation.domains.splice(index,1)}}],link:function($scope,$ele,$attrs,ctrls){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("skypeBusiness",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/skype-business/skype-business.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("skype_for_business_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.assetsBase=env_conf["assets-url"],$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.idp.name,$scope.channel.app_name=stream.name,$scope.channel.streamId=newVal.idp.streamId,$scope.channel.clientID=newVal.idp.formfields.filter(function(obj){return"client_id"===obj.key})[0]["default"],$scope.channel.clientSecret=newVal.idp.formfields.filter(function(obj){return"client_secret"===obj.key})[0]["default"],console.log($scope.channel))}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"skypeforbusiness"}).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url},function(err){$scope.channelAuth={}}),$scope.save=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.hannel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,void NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error");var payload={_id:$scope.channel._id,name:$scope.channel.name,enable:$scope.channel.enable,appConfig:{tokenURL:"https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token"},formfields:[{title:"client_id",key:"client_id","default":$scope.channel.clientID,isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"client_secret",key:"client_secret","default":$scope.channel.clientSecret,isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"grant_type",key:"grant_type","default":"client_credentials",isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"scope",key:"scope","default":"https://api.botframework.com/.default",isRequired:!0,fieldType:"textbox",visibility:"hidden"}],streamId:$scope.channel.streamId,channel_auth:"skypeforbusiness",sso_type:"custom",contentType:"application/x-www-form-urlencoded",method:"POST"};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("skypeforbusiness"),NotificationService.notify(i18n.i18nString("bt_chnl_skypeB_edited_success"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("skypeforbusiness"),NotificationService.notify(i18n.i18nString("bt_chnl_skypeB_added_success"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_SKYPE,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,$(".slack-channel-page").scrollTop(0),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#skype_business_webhook_url2"]');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},1e3)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("skypeChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/skype-channel/skype-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("skype_account_label",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.assetsBase=env_conf["assets-url"],$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.idp.name,$scope.channel.app_name=stream.name,$scope.channel.streamId=newVal.idp.streamId,$scope.channel.clientID=newVal.idp.formfields.filter(function(obj){return"client_id"===obj.key})[0]["default"],$scope.channel.clientSecret=newVal.idp.formfields.filter(function(obj){return"client_secret"===obj.key})[0]["default"],console.log($scope.channel))}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"skype"}).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url},function(err){$scope.channelAuth={}}),$scope.save=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.hannel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,void NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error");var payload={_id:$scope.channel._id,name:$scope.channel.name,enable:$scope.channel.enable,appConfig:{tokenURL:"https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token"},formfields:[{title:"client_id",key:"client_id","default":$scope.channel.clientID,isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"client_secret",key:"client_secret","default":$scope.channel.clientSecret,isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"grant_type",key:"grant_type","default":"client_credentials",isRequired:!0,fieldType:"textbox",visibility:"hidden"},{title:"scope",key:"scope","default":"https://api.botframework.com/.default",isRequired:!0,fieldType:"textbox",visibility:"hidden"}],streamId:$scope.channel.streamId,channel_auth:"skype",sso_type:"custom",contentType:"application/x-www-form-urlencoded",method:"POST"};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("skype"),NotificationService.notify(i18n.i18nString("bt_chnl_skype_edited_success"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("skype"),NotificationService.notify(i18n.i18nString("bt_chnl_skype_added_success"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_SKYPE,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#skype_webhook_url2"]');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},1e3),$scope.steps[step-1].active=!0,$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("skypePremise",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/skype-premise/skype-premise.html",controller:["$scope","$workflowService","$location","$timeout","BTStreamsService","env_conf","form_util","NotificationService","i18n",function($scope,$workflowService,$location,$timeout,BTStreamsService,env_conf,form_util,NotificationService,i18n){var clipWebhook_url,clipVerify_token,stream=$workflowService.selectedStream();$scope.channel=$scope.value||{enable:!0},$scope.assetsBase=env_conf["assets-url"],$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.save=function(form){var payload={};return form&&form.$invalid?void form_util.touch(form):0!==$scope.channel.RootUrl.indexOf("http")?void NotificationService.notify(i18n.i18nString("discovery_url_format"),"error"):(payload.type="skypeOnPrem",payload.username=$scope.channel.username,payload.password=$scope.channel.password,payload.autodiscover_url=$scope.channel.RootUrl,payload.enable=$scope.channel.enable,void $scope.onSave(payload,"","","",i18n.i18nString("bt_chnl_form_skype_on_premise_label")))},$scope.goToHome=function(flag){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.skypePremImage=env_conf["context-url"]+"/img/skypeIcon.svg",$scope.channel={name:i18n.i18nString("skype_premise_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel.enable=newVal.enable,$scope.channel.username=newVal.username,$scope.channel.password=newVal.password,$scope.channel.RootUrl=newVal.autodiscover_url)}),$scope.currentStep={},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#googleHome_webhook_url"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#googleHome_verify_token"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("slackChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/slack-channel/slack-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){function getIdpByName(){BTIdpService.getIdpByName(_idpName,$workflowService.selectedStream()._id).then(function(res){idpConfig=res.data,idpConfig&&idpConfig.appConfig&&($scope.channel.clientID=idpConfig.appConfig.clientID,$scope.channel.clientSecret=idpConfig.appConfig.clientSecret,$scope.channel.verificationToken=idpConfig.appConfig.verificationToken,$scope.idpID=idpConfig._id,isAuthorized=!0)},function(err){NotificationService.notify(i18n.i18nString("failed_fetch_idp"),"error"),idpConfig={}})}function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream(),processApps=$workflowService.processAppsData()||[],botName=$workflowService.selectedStream().name;$scope.sumocb={processcb:{changeText:!0}},$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState();var streamUserAccountId="",idpConfig={},_idpName=i18n.i18nString("slack_account",{dyn:stream.name}),isAuthorized=!1;$scope.btTestFormApi={},$scope.channel={name:i18n.i18nString("slack_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.idpID="",$scope.assetsBase=env_conf["assets-url"],$scope.processApps=[],$scope.channel.selectedProcessApp=[],processApps.forEach(function(value){$scope.processApps.push({value:value.name,type:value._id})}),$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.idp.name,$scope.channel.app_name=stream.name,streamUserAccountId=newVal.streamUserAccountId,$scope.channel.enableNotification=newVal.enableNotification,newVal.enableNotification&&newVal.notification&&($scope.channel.botUserToken=newVal.notification.botToken,$scope.channel.processNotification=newVal.notification.processappScopes.length?!0:!1,newVal.notification.processappScopes.forEach(function(val){$scope.channel.selectedProcessApp.push(val.wfId)})),$scope.channel.streamId=newVal.idp.streamId,$scope.channel.clientID=newVal.idp.appConfig?newVal.idp.appConfig.clientID:void 0,$scope.channel.clientSecret=newVal.idp.appConfig?newVal.idp.appConfig.clientSecret:void 0,$scope.channel.verificationToken=newVal.idp.appConfig?newVal.idp.appConfig.verificationToken:void 0,console.log($scope.channel))}),$timeout(function(){var clipB=new Clipboard("[data-clipboard-target]");$scope.isSafariappname=!1,$scope.isSafaryUri=!1,clipB.on("success",function(e){console.log("success")}),clipB.on("error",function(e){var targetEle=$(e.trigger).data("clipboardTarget"),isSafary=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification);"#slack_appName"===targetEle?$scope.isSafariappname=isSafary:$scope.isSafaryUri=isSafary})}),$scope.steps=[{step:1,active:!0,name:"Instructions"},{step:2,active:!1,name:"Configurations"}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"slack"}).then(function(res){$scope.channel.webhook_url=res.data.webhook_url}),$scope.testIdp=function(idpId){$scope.idpID=idpId,$scope.btTestFormApi.afterInit=function(){$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success,responseData){success?(streamUserAccountId=responseData.streamAccountId,NotificationService.notify(i18n.i18nString("auth_test_success"),"success")):(streamUserAccountId="",NotificationService.notify(i18n.i18nString("auth_test_failed"),"error")),$scope.btTestFormApi.close()},$scope.btTestFormApi.init({_id:idpId?idpId:$scope.newAuth&&$scope.newAuth.selected._id,type:"idp",testFor:"idp",isFromTwitter:!0})},getIdpByName(),$scope.authorize=function(form){var payload={};if(form&&form.$invalid)return void form_util.touch(form);if(payload={appConfig:{authorizationURL:"https://slack.com/oauth/v2/authorize",tokenURL:"https://slack.com/api/oauth.v2.access",clientID:$scope.channel.clientID,clientSecret:$scope.channel.clientSecret,verificationToken:$scope.channel.verificationToken,scope:"im:read,channels:history,im:history,mpim:history,users.profile:read,users:read"},sso_type:"oauth2",streamId:stream._id,channel_auth:"default",name:botName+" slack account",enable:$scope.channel.enable},idpConfig._id){var id=idpConfig._id;delete idpConfig._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){getIdpByName(),$scope.testIdp(res.data._id),isAuthorized=!0},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){getIdpByName(),$scope.testIdp(res.data._id),isAuthorized=!0},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.resetChannel=function(){BTStreamsService.deleteChannel($workflowService.selectedStream()._id,"slack","",{idp:$scope.idpID}).then(function(res){NotificationService.notify(i18n.i18nString("chnl_reset_success"),"success"),$scope.channel.clientID="",$scope.channel.clientSecret="",$scope.channel.verificationToken="",$scope.idpID="",idpConfig=""},function(err){var errMsg=err&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("chnl_reset_failed");NotificationService.notify(errMsg,"error")})},$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);if(!isAuthorized)return void NotificationService.notify(i18n.i18nString("please_authorize_chnl_before_saving"),"error");if(""===streamUserAccountId)return void NotificationService.notify(i18n.i18nString("aunthorization_failed"),"error");var payload={streamUserAccountId:streamUserAccountId,idp:$scope.idpID,type:"slack",enable:$scope.channel.enable,verificationToken:$scope.channel.verificationToken,enableNotification:$scope.channel.enableNotification};if($scope.channel.enableNotification&&(payload.notification={botToken:$scope.channel.botUserToken,enableProcessNotification:!0},$scope.channel.selectedProcessApp.length)){var selected=[];$scope.channel.selectedProcessApp.forEach(function(val){_.find($scope.processApps,{type:val})&&selected.push({name:_.find($scope.processApps,{type:val}).value,wfId:val})}),payload.notification.processappScopes=selected}$scope.onSave(payload,"","","","slack")},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_SLACK,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()};var slack_appName,slack_rURI,slack_webhook_url;$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,2===step&&$timeout(function(){slack_appName=new Clipboard('[data-clipboard-target="#slack_appName2"]'),slack_rURI=new Clipboard('[data-clipboard-target="#slack_rURI2"]'),slack_webhook_url=new Clipboard('[data-clipboard-target="#slack_webhook_url2"]'),$scope.isSafariappname=!1,$scope.isSafaryUri=!1,$scope.isSafariwebhook=!1,slack_appName.on("success",function(e){}),slack_appName.on("error",function(e){$scope.isSafariappname=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),slack_rURI.on("success",function(e){}),slack_rURI.on("error",function(e){$scope.isSafaryUri=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),slack_webhook_url.on("success",function(e){}),slack_webhook_url.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("smsChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",schema:"=",context:"=",wfType:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/sms-channel/sms-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,i18n){$scope.stream=$workflowService.selectedStream(),$scope.channels=$workflowService.seedData().botChannelsTypes,$scope._constants_=_constants_,$scope.fields=[],$scope.form={},$scope.noop=angular.noop,$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.goToHome=function(){$scope.$parent.goToHome()},$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.saveSms=function(){var payload=$scope.form.save();payload.type="sms",payload.id="twilio",payload.enable=$scope.$parent.sms.enable,$scope.onSave(payload)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("sparkChannel",[function(){return{restrict:"EA",scope:{value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/spark-channel/spark-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","form_util","NotificationService","env_conf","$translator","BTIdpService","uuid4","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,form_util,NotificationService,env_conf,$translator,BTIdpService,uuid4,i18n){function getId(){return"ap-"+uuid4.generate()}function changeStep(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step].active=!0}$scope.stream=$workflowService.selectedStream(),$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channels=$workflowService.seedData().botChannelsTypes,$scope._constants_=_constants_,$scope.currentTab=0,$scope.channel={type:"spark",streamId:$scope.stream._id,app_name:$scope.stream.name,name:i18n.i18nString("spark_Account",{dyn:$scope.stream.name}),enable:!0},$scope.assetsBase=env_conf["assets-url"],$scope.stream.channels=$scope.stream.channels||[];$scope.stream.channels||[];$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=i18n.i18nString("spark_Account",{dyn:$scope.stream.name}),$scope.channel.app_name=$scope.stream.name,$scope.channel.streamId=newVal.idp.streamId,$scope.channel.authToken=newVal.authToken,$scope.channel.botEmail=newVal.botEmail,$scope.channel.clientID=newVal.idp.appConfig.clientID,$scope.channel.clientSecret=newVal.idp.appConfig.clientSecret,$scope.channel.webhookId=newVal.webhookId)}),$scope.helpLink=$scope.$root.helpLinks.CISCO_SPARK_HELP,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$location.path(window.appConfig.CONTEXT_PATH),$scope.$parent.goToHome(),$scope.closeSlider()},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),$(".slack-channel-page").scrollTop(0)},$scope.save=function(form){if(form.$invalid)return void form_util.touch(form);var payload={_id:$scope.channel._id,name:$scope.channel.name,enable:$scope.channel.enable,authToken:$scope.channel.authToken,botEmail:$scope.channel.botEmail,appConfig:{authorizationURL:"https://api.ciscospark.com/v1/authorize",tokenURL:"https://api.ciscospark.com/v1/access_token",clientID:$scope.channel.clientID,clientSecret:$scope.channel.clientSecret,scope:"spark:all"},streamId:$scope.stream._id,sso_type:"oauth2",channel_auth:"spark",webhookId:$scope.channel.webhookId};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation($scope.channel.type),NotificationService.notify(i18n.i18nString("bt_chnl_cisco_edited_success"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation($scope.channel.type),NotificationService.notify(i18n.i18nString("bt_chnl_cisco_added_success"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.isSafariwhid=!1,$timeout(function(){var clipB=(new Clipboard('[data-clipboard-target="#webhookId"]'),new Clipboard("[data-clipboard-target]"));clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwhid=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}];var spark_rURI;$scope.next=function(step){$scope.currentTab=step-1,changeStep(step-1),2===step&&$timeout(function(){spark_rURI=new Clipboard('[data-clipboard-target="#spark_rURI2"]'),$scope.isSafariwhid=!1,spark_rURI.on("success",function(e){}),spark_rURI.on("error",function(e){$scope.isSafariwhid=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("syniverseChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/syniverse-channel/syniverse-channel.html",controller:["$scope","$element","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$element,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){
function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream(),processApps=$workflowService.processAppsData()||[];$scope.sumocb={processcb:{changeText:!0}},$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channel={name:i18n.i18nString("syniverse_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name},$scope.channel.enable=!0,$scope.assetsBase=env_conf["assets-url"],$scope.processApps=[],$scope.channel.selectedProcessApp=[],processApps.forEach(function(value){$scope.processApps.push({value:value.name,type:value._id})}),$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.idp.name,$scope.channel.app_name=stream.name,$scope.channel.streamId=newVal.idp.streamId,$scope.channel.senderId=newVal.senderId,$scope.channel.clientID=newVal.idp.appConfig.clientID,$scope.channel.clientSecret=newVal.idp.appConfig.clientSecret,$scope.channel.authToken=newVal.idp.appConfig.authToken,console.log($scope.channel))}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"syniverse"}).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url},function(err){$scope.channelAuth={}}),$scope.save=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.channel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error"),void $timeout(function(){$element.find(".slack-channel-page").scrollTop($element.find(".slack-channel-page").height()+100),form.clientID.$dirty&&""===$element.find('[name="clientID"]').val().trim()?$element.find('[name="clientID"]').focus():form.clientSecret.$dirty&&""===$element.find('[name="clientSecret"]').val().trim()?$element.find('[name="clientSecret"]').focus():form.authToken.$dirty&&""===$element.find('[name="authToken"]').val().trim()&&$element.find('[name="authToken"]').focus()},350);var payload={_id:$scope.channel._id,name:$scope.channel.name,enable:$scope.channel.enable,senderId:$scope.channel.senderId,appConfig:{authToken:$scope.channel.authToken,clientID:$scope.channel.clientID,clientSecret:$scope.channel.clientSecret},streamId:$scope.channel.streamId,channel_auth:"syniverse",sso_type:"custom"};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("syniverse"),NotificationService.notify(i18n.i18nString("bt_chnl_syniverse_chnl_edited_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),$scope.channel.enable&&$scope.$parent.showBotAdminConfirmation("syniverse"),NotificationService.notify(i18n.i18nString("bt_chnl_syniverse_chnl_added_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_MS,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome()},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#ms_webhook_url2"]');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},1e3),$scope.steps[step-1].active=!0,$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("telegramChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",wfType:"=",context:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/telegram-channel/telegram-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,form_util,i18n){var clipWebhook_url,clipVerify_token;$scope.channel=$scope.value||{enable:!0,isMention:!0,isChat:!0},$scope.channelAuth={},$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.assetsBase=env_conf["assets-url"],$scope.currentStep={},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_WFACEBOOK,$scope.channelHeaderCallback=$scope,$scope.$watch("value",function(newVal,oldVal){$scope.channel=newVal||{enable:!0,isMention:!0,isChat:!0},$scope.channelAuth=$scope.channelAuth||{},$scope.channel.webhook_url=$scope.channelAuth.webhook_url,$scope.channel.verify_token=$scope.channelAuth.verify_token}),BTStreamsService.getWebhookUrl($workflowService.selectedStream()._id,!0).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url,$scope.channel.verify_token=res.data.verify_token},function(err){$scope.channelAuth={}}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0)},$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);var payload={};payload.type="telegram",payload.botSecret=$scope.channel.botSecret,payload.screen_name=$scope.channel.screen_name,payload.enable=$scope.channel.enable,$scope.onSave(payload,"","","","Telegram")},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#fb_webhook_url"]'),clipVerify_token=new Clipboard('[data-clipboard-target="#fb_verify_token"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),clipVerify_token.on("success",function(e){}),clipVerify_token.on("error",function(e){$scope.isSafarivt=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0)},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.exit=$scope.goToHome,$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("twilioChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",channelsenable:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/twilio-channel/twilio-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","$rootScope","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,$rootScope,i18n){$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState();$scope.stream=$workflowService.selectedStream(),$scope.channels=$workflowService.seedData().botChannelsTypes,$scope._constants_=_constants_,$scope.countryCodeChoosen=_constants_.countryCodes[0],$scope.searchCountryCodes="",$scope.fields=[],$scope.form={},$scope.noop=angular.noop;var defaultMobileArray=[{countryCode:i18n.i18nString("Bt_chnl_cisco_config_countryCode_label"),number:""}],getDefaultMobileArray=function(){var oldPhoneNumberArray=[];if($scope.value.phoneNumber){var oldPhoneNumberObject={},phoneNumber=$scope.value.phoneNumber;oldPhoneNumberObject.number=phoneNumber.substring(phoneNumber.length-10,phoneNumber.length),oldPhoneNumberObject.countryCode=phoneNumber.substring(0,phoneNumber.length-10),oldPhoneNumberArray.push(oldPhoneNumberObject)}return oldPhoneNumberArray.length&&oldPhoneNumberArray||defaultMobileArray};$scope.sendContactCB={},$scope.channel={accountSid:$scope.value.accountSid,authToken:$scope.value.authToken,messagingServiceSid:$scope.value.messagingServiceSid,type:"sms",gateway:"twilio",enable:$scope.value.enable,numbers:$scope.value&&($scope.value.numbers||[]).length>0&&$scope.value.numbers||getDefaultMobileArray()},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.saveSms=function(){var payload=angular.copy($scope.channel);payload.enable=$scope.value.enable,payload.numbers=_.filter(payload.numbers,function(num){return num.number&&num.number.trim()}),payload.numbers=_.map(payload.numbers,function(num){return num.number=num.number&&num.number.replace(/-/g,"").trim(),num.number?num:void 0}),$scope.onSave(payload,"","",angular.noop,"Twilio SMS")},$scope.assetsBase=env_conf["assets-url"],$scope.serverUrl=env_conf.API_SERVER_URL,$scope.callBackUrls=[{id:"requestUrl",label:i18n.i18nString("Bt_chnl_twilioS_config_resturl_label"),url:$scope.serverUrl+"/client/sms/twilio"},{id:"fallBackUrl",label:i18n.i18nString("Bt_chnl_twilioS_config_fallb_label"),url:$scope.serverUrl+"/client/sms/twilio"},{id:"statusCallbackUrl",label:i18n.i18nString("Bt_chnl_twilioS_config_statusb_label"),url:$scope.serverUrl+"/client/sms/twilio/statuscallback"}],$timeout(function(){$(".dropdown-toggle").dropdown(),$(".twilioChannelContainer").on("click",".dropdown-menu",function(evt){evt.stopPropagation()})}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.step=1,$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$scope.save=function(form){if(form&&form.$invalid)return $scope.accountSidRequired=$scope.channel.accountSid&&$scope.channel.accountSid.trim()?!1:!0,$scope.authTokenRequired=$scope.channel.authToken&&$scope.channel.authToken.trim()?!1:!0,$scope.messagingServiceSidRequired=$scope.channel.messagingServiceSid&&$scope.channel.messagingServiceSid.trim()?!1:!0,void(1===Object.keys(form.$error).length&&"invalidFormat"===Object.keys(form.$error)[0]?NotificationService.notify(i18n.i18nString("please_enter_valid_mobile_numbers"),"error"):NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error"));var _enable=!1;$.each($scope.channelsenable,function(index,channel){"tropo"===channel.gateway&&"Enabled"===channel.status&&(_enable=!0)}),_enable?NotificationService.confirmDialog(i18n.i18nString("bt_chnl_form_eanable_single_sms_provider_ciscoChnl_enabled"),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0}):$scope.saveSms()},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_SMS,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome()},$scope.flowSearchFilter=function(filter){return function(countryCodes){return filter.name?countryCodes.name&&-1!==countryCodes.name.toLowerCase().indexOf(filter.name&&filter.name.toLowerCase()):!0}},$scope.selectItem=function(item,index){console.log(item);var selectedCountryCodes=_.pluck($scope.channel.numbers,"countryCode"),selectedCountryNames=_.pluck($scope.channel.numbers,"countryName");return-1===$.inArray(item.value,selectedCountryCodes)||-1===$.inArray(item.name,selectedCountryNames)||$scope.channel.numbers[index].countryName===item.name&&$scope.channel.numbers[index].countryCode===item.value?($scope.channel.numbers[index].countryCode=item.value,$scope.channel.numbers[index].countryName=item.name,$scope.countryCodeChoosen=item,$(".dropdown").removeClass("open"),void $rootScope.$broadcast("onCountryCodeSelected")):void NotificationService.notify(i18n.i18nString("country_code_already_in_use"),"warning")},$scope.addNewMobileField=function(index){if(""===$scope.channel.numbers[index].number.trim())return $scope.btchannel.twilioForm["phoneOnly"+index].$setDirty(),void $scope.btchannel.twilioForm["phoneOnly"+index].$setValidity("mobRequired",!1);if(!$scope.btchannel.twilioForm["phoneOnly"+index].$error.invalidFormat){var defaultMobObject={countryCode:"Select country code",number:""};$scope.channel.numbers.push(defaultMobObject),$timeout(function(){$(".dropdown-toggle").dropdown()})}},$scope.deleteMobileField=function(index){$scope.channel.numbers.splice(index,1)};var requestUrlcp,fallBackUrlcp,statusCallbackUrlcp;$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,2===step&&$timeout(function(){requestUrlcp=new Clipboard('[data-clipboard-target="#requestUrl2"]'),fallBackUrlcp=new Clipboard('[data-clipboard-target="#fallBackUrl2"]'),statusCallbackUrlcp=new Clipboard('[data-clipboard-target="#statusCallbackUrl2"]'),$scope.isrequestUrlcp=!1,$scope.isfallBackUrlcp=!1,$scope.statusCallbackUrlcp=!1,requestUrlcp.on("success",function(e){}),requestUrlcp.on("error",function(e){$scope.isrequestUrlcp=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),fallBackUrlcp.on("success",function(e){}),fallBackUrlcp.on("error",function(e){$scope.isfallBackUrlcp=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)}),statusCallbackUrlcp.on("success",function(e){}),statusCallbackUrlcp.on("error",function(e){$scope.isfallBackUrlcp=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("twilioVoice",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",channelsenable:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/twilio-voice/twilio-voice.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","$rootScope","$q","BTFlowtaskService","channelsConfig","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,$rootScope,$q,BTFlowtaskService,channelsConfig,i18n){function getStreams(){BTStreamsService.getBTStream(stream._id).then(function(res){if(res&&res.data&&res.data.twilioVoiceSettings&&($scope.twilioVoiceSettings={enable:res.data.twilioVoiceSettings.enable,timeout:res.data.twilioVoiceSettings.timeout,retry_limit:res.data.twilioVoiceSettings.retry_limit,callTerminationHandler:res.data.twilioVoiceSettings.callTerminationHandler,bargein:res.data.twilioVoiceSettings.bargein,timeoutPrompts:angular.copy(res.data.twilioVoiceSettings.timeoutPrompts)}),res.data&&res.data.botEvents&&(botEventsSave=res.data.botEvents),res.data&&res.data.botEvents&&res.data.botEvents.CONVERSATION_END){var convEnd=res.data.botEvents.CONVERSATION_END;if(convEnd&&convEnd.enabled)if($scope.conver.value="trigger","triggerDialog"===convEnd.action){var dialogName="";$scope.events.config="initiate";for(var i=0;i<$scope.dialogsName.length;i++)if($scope.dialogsName[i].id===convEnd.task){dialogName=$scope.dialogsName[i].name;break}$scope.selected.dialog=dialogName}else"runScript"===convEnd.action?($scope.events.config="runScript",$scope.inp.scriptText=decodeJS(convEnd.script)):"showMsg"===convEnd.action&&($scope.events.config="showMessage",$scope.responseObj=angular.copy(res.data.botEvents.CONVERSATION_END.msg));else res.data.ivrSettings&&res.data.ivrSettings.enable&&($scope.conver.value="terminate")}else $scope.conver.value="terminate";$scope.isLoading=!1},function(err){$scope.isLoading=!1})}function createConversationEndPayload(){var payload={CONVERSATION_END:{}};if("initiate"===$scope.events.config){payload.CONVERSATION_END.action="triggerDialog",payload.CONVERSATION_END.script=".",payload.CONVERSATION_END.msg=[];var dialogId="";if(!$scope.selected.dialog)return!1;for(var i=0;i<$scope.dialogsName.length;i++)if($scope.dialogsName[i].name===$scope.selected.dialog){dialogId=$scope.dialogsName[i].id;break}payload.CONVERSATION_END.task=dialogId}else"runScript"===$scope.events.config?(payload.CONVERSATION_END.action="runScript",payload.CONVERSATION_END.script=$scope.inp.scriptText,payload.CONVERSATION_END.task="",payload.CONVERSATION_END.welcomeMsg=[]):"showMessage"===$scope.events.config&&(payload.CONVERSATION_END.action="showMsg",payload.CONVERSATION_END.script=".",payload.CONVERSATION_END.msg=$scope.responseObj);return payload.CONVERSATION_END.enabled=!0,payload.CONVERSATION_END.manageFirstMessage={},payload.CONVERSATION_END.welcomeIvrOptions=[],payload}function getDialogs(){var deferred=$q.defer();return $scope.dialogsName=[],BTFlowtaskService.getFlowtaks($workflowService.selectedStream()._id).then(function(res){var ind=0,refIds=[];res.data.forEach(function(val){-1==refIds.indexOf(val.refId)&&refIds.push(val.refId)}),res.data.forEach(function(val){!val.isFollowUp&&refIds.indexOf(val.refId)>-1&&($scope.dialogsName[ind]={},$scope.dialogsName[ind].name=val.name,$scope.dialogsName[ind].id=val.refId,refIds.splice(refIds.indexOf(val.refId),1),ind++)}),deferred.resolve($scope.dialogsName)},function(err){console.log(err),deferred.reject(err)}),deferred.promise}var stream=$workflowService.selectedStream();$scope.form={},$scope.form.twilioVoiceForm={},$scope.rightClass="right700",$scope.stream=$workflowService.selectedStream(),$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channels=$workflowService.seedData().botChannelsTypes,$scope._constants_=_constants_,$scope.countryCodeChoosen=_constants_.countryCodes[0],$scope.searchCountryCodes="",$scope.languagelist=$scope._constants_.twilioLanSelect,$scope.searchCountryLang="",$scope.fields=[],$scope.form={},$scope.noop=angular.noop,$scope.isDialogsAvailable=!1,$scope.showEnable=!1,$scope.submitForm=!1,$scope.conver={value:"terminate"},$scope.inp={scriptText:""},$scope.events={config:"initiate"},$scope.selected={dialog:""},$scope.dialogsName=[];var botEventsSave={};$scope.channelsConfig=channelsConfig;var defaultMobileArray=[{countryCode:i18n.i18nString("Bt_chnl_cisco_config_countryCode_label"),number:""}];$scope.modalSlider={},$scope.timeIntervels=[],$scope.retriesCount=[],$scope.voiceList=["Alice","Woman","Man"];for(var maxTimeinSecs=60,k=0;maxTimeinSecs>=k;k++)$scope.timeIntervels.push(1e3*k);for(var j=1;10>=j;j++)$scope.retriesCount.push(j);$scope.twilioVoiceSettings={enable:!0,timeout:3e3,retry_limit:6,callTerminationHandler:"",bargein:!1,timeoutPrompts:[[{type:"text",value:""}]]},$scope.welcomeMessagecbs={},$scope.welcomeMessagecbs.isAddResponseEnabled=!1,$scope.welcomeMessagecbs.isFrom="channelIvr",$scope.welcomeMessagecbs.isAPICall=!1,$scope.responseObj=[],$scope.isLoading=!0,$scope.convertToInt=function(id){return parseInt(id,10)},$scope.welcomeMessagecbs.closeAddResponseModal=function(){$scope.welcomeMessagecbs.isAddResponseEnabled=!1,$scope.showEnable=!1,$scope.modalSlider.close("#btWelcomeMess")},$scope.welcomeMessagecbs.getObjResponse=function(obj,isEdit){if($scope.isSaveDisabled=!1,$scope.isAddRespEdited=!0,isEdit){for(var i=0;i<$scope.responseObj.length;i++)if($scope.responseObj[i]._id===obj._id){$scope.responseObj.splice(i,1,obj);break}}else $scope.responseObj.push(obj)},$scope.welcomeMessagecbs.getObjResponseEdit=function(obj){$scope.isAddRespEdited=!0,$scope.isSaveDisabled=!1,$scope.responseObj=[],$scope.responseObj=angular.copy(obj)},$scope.bargeinToggle=function(enable){enable?$scope.twilioVoiceSettings.bargein=!1:$scope.twilioVoiceSettings.bargein=!0},$scope.saveIVR=function(form){if($scope.submitForm=!0,!form.$invalid){if("trigger"===$scope.conver.value&&"showMessage"===$scope.events.config){var numOfAllChannels=$scope.responseObj.filter(function(v){return"default"===v.channel}).length;if(0===numOfAllChannels)return void NotificationService.notify(i18n.i18nString("atleast_one_all_chann"),"error")}var temp={twilioVoiceSettings:$scope.twilioVoiceSettings},convPayload={};convPayload=createConversationEndPayload(),convPayload!==!1&&(temp.botEvent={},temp.botEvent.CONVERSATION_END={},temp.botEvent.CONVERSATION_END=convPayload.CONVERSATION_END),"terminate"==$scope.conver.value&&temp.botEvent&&temp.botEvent.CONVERSATION_END&&(temp.botEvent.CONVERSATION_END.enabled=!1),BTStreamsService.editStream(stream._id,temp).then(function(res){NotificationService.notify(i18n.i18nString("voice_call_save"),"success")},function(err){try{NotificationService.notify(err.data.errors[0].msg,"error")}catch(e){NotificationService.notify(i18n.i18nString("voice_call_error"),"error")}})}};var getDefaultMobileArray=function(){var oldPhoneNumberArray=[];if($scope.value.phoneNumber){var oldPhoneNumberObject={},phoneNumber=$scope.value.phoneNumber;oldPhoneNumberObject.number=phoneNumber.substring(phoneNumber.length-10,phoneNumber.length),oldPhoneNumberObject.countryCode=phoneNumber.substring(0,phoneNumber.length-10),oldPhoneNumberArray.push(oldPhoneNumberObject)}return oldPhoneNumberArray.length&&oldPhoneNumberArray||defaultMobileArray};$scope.sendContactCB={},$scope.channel={name:i18n.i18nString("twilio_voice_accnt",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0,koreVoice:!1,voice:"Alice",numbers:$scope.value&&($scope.value.numbers||[]).length>0&&$scope.value.numbers||getDefaultMobileArray(),languages:$scope.languagelist},$scope.serverUrl=env_conf.API_SERVER_URL,$scope.assetsBase=env_conf["assets-url"],$timeout(function(){$(".dropdown-toggle").dropdown(),$(".twilioChannelContainer").on("click",".dropdown-menu",function(evt){evt.stopPropagation()})}),$scope.deleteMessage=function(response,index){function delMessage(){$scope.isAddRespEdited=!0;for(var i=0;i<$scope.responseObj.length;i++)if(""!==$scope.responseObj[i]._id&&$scope.responseObj[i]._id===response._id&&$scope.responseObj[i].channel===response.channel||$scope.responseObj[i].text===response.text&&$scope.responseObj[i].channel===response.channel){$scope.responseObj.splice(i,1);break}}var numOfAllChannels=$scope.responseObj.filter(function(v){return"default"===v.channel}).length;"default"===response.channel&&1===numOfAllChannels?NotificationService.confirm({msg:i18n.i18nString("channel_mandatory"),successCb:function(){delMessage()},isModal:!0,btnTexts:{success:i18n.i18nString("yes"),fail:i18n.i18nString("no")}}):delMessage()},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")},{step:3,active:!1,name:"Voice Call Properties"}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel.enable=newVal.enable,$scope.channel.koreVoice=newVal.useKoreVoice||$scope.channel.koreVoice,$scope.channel.voice=newVal.voice||$scope.channel.voice,$scope.channel.voice=$scope.channel.voice.charAt(0).toUpperCase()+$scope.channel.voice.slice(1),$scope.channel.app_name=stream.name,$scope.channel.twilio_number=newVal.twilio_number,$scope.channel.languages=$scope.languagelist,$scope.channel.speechlanguage=newVal.speechlanguage||"en-US",console.log($scope.channel))}),$scope.channel.oAuthRedirectURI=$scope.serverUrl+"/twiliovoice/hooks/"+stream._id,$scope.save=function(form){if(form.$invalid&&Object.keys(form.$error).length>0&&Object.keys(form.$error).indexOf("invalidFormat")>-1)return void NotificationService.notify(i18n.i18nString("please_enter_valid_mobile_numbers"),"error");for(var i=0;i<$scope.channel.numbers.length;i++)if(""===$scope.channel.numbers[i].number||"Select country code"==$scope.channel.numbers[i].countryCode)return void NotificationService.notify(i18n.i18nString("please_enter_valid_mobile_numbers"),"error");var payload={type:"twiliovoice",enable:$scope.channel.enable};payload.speechlanguage=$scope.channel.speechlanguage,payload.useKoreVoice=$scope.channel.koreVoice,payload.voice=$scope.channel.voice,payload.numbers=_.filter($scope.channel.numbers,function(num){return num.number&&num.number.trim()}),payload.numbers=_.map($scope.channel.numbers,function(num){return num.number=num.number&&num.number.replace(/-/g,"").trim(),num.number?num:void 0}),$scope.value.numbers=payload.numbers||[],$scope.onSave(payload,"","","","Twilio Voice")},$scope.decodeJS=function(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}};var decodeJS=$scope.decodeJS;$scope.bulbSvg=env_conf["context-url"]+"/assets/images/bulbicon.svg",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_TWILIO_VOICE,$scope.channelHeaderCallback=$scope,$scope.flowSearchFilter=function(filter){return function(countryCodes){return filter.name?countryCodes.name&&-1!==countryCodes.name.toLowerCase().indexOf(filter.name&&filter.name.toLowerCase()):!0}},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.selectLang=function(item,index){console.log(item);_.pluck($scope.channel.languages,"twilioLanSelect");$scope.countryLangChoosen=item,$(".dropdown").removeClass("open"),$rootScope.$broadcast("onCountryCodeSelected")},$scope.selectItem=function(item,index){console.log(item);var selectedCountryCodes=_.pluck($scope.channel.numbers,"countryCode"),selectedCountryNames=_.pluck($scope.channel.numbers,"countryName");return-1===$.inArray(item.value,selectedCountryCodes)||-1===$.inArray(item.name,selectedCountryNames)||$scope.channel.numbers[index].countryName===item.name&&$scope.channel.numbers[index].countryCode===item.value?($scope.channel.numbers[index].countryCode=item.value,$scope.channel.numbers[index].countryName=item.name,$scope.countryCodeChoosen=item,$(".dropdown").removeClass("open"),void $rootScope.$broadcast("onCountryCodeSelected")):void NotificationService.notify("CountryCode already in use","warning")},$scope.addNewMobileField=function(index){if(""===$scope.channel.numbers[index].number.trim())return $scope.form.twilioVoiceForm["phoneOnly"+index].$setDirty(),void $scope.form.twilioVoiceForm["phoneOnly"+index].$setValidity("mobRequired",!1);if(!$scope.form.twilioVoiceForm["phoneOnly"+index].$error.invalidFormat){var defaultMobObject={countryCode:i18n.i18nString("Bt_chnl_cisco_config_countryCode_label"),number:""};$scope.channel.numbers.push(defaultMobObject),$timeout(function(){$(".dropdown-toggle").dropdown()})}},$scope.deleteMobileField=function(index){$scope.channel.numbers.splice(index,1)},$scope.editResponse=function(index){var isChannelSpec=!1,channelId="all";$scope.welcomeMessagecbs.isAddResponseEnabled=!0,$scope.showEnable=!0,$timeout(function(){$scope.modalSlider.open("#btWelcomeMess"),$scope.welcomeMessagecbs.loadMessage($scope.responseObj,index,isChannelSpec,channelId),$scope.welcomeMessagecbs.openResponseSliderIvr(),$(".welcomeMessageModal").modal("show")},500)},getDialogs().then(function(data){$scope.isDialogsAvailable=!0,getStreams()},function(err){$scope.isDialogsAvailable=!0,$scope.dialogsName=[],NotificationService.notify(i18n.i18nString("unable_fetch_dialogs"),"error")}),$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,$(".slack-channel-page").scrollTop(0),2==step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#twiliovoiceoauthuri"');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})},1e3)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("twitterChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/twitter-channel/twitter-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","form_util","NotificationService","$translator","BTIdpService","uuid4","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,form_util,NotificationService,$translator,BTIdpService,uuid4,i18n){function getIdpByName(){BTIdpService.getIdpByName(_idpName,$workflowService.selectedStream()._id).then(function(res){idpConfig=res.data,idpConfig&&idpConfig.appConfig&&($scope.twitterData.consumer_key=idpConfig.appConfig.consumerKey,$scope.twitterData.consumer_secret=idpConfig.appConfig.consumerSecret,$scope.twitterData.access_token_key=idpConfig.appConfig.token,$scope.twitterData.access_token_secret=idpConfig.appConfig.tokenSecret,$scope.twitterData.screen_name=idpConfig.appConfig.screen_name,$scope.content.env_name=idpConfig.appConfig.env,$scope.idpID=idpConfig._id,isAuthorized=!0)},function(err){NotificationService.notify(i18n.i18nString("failed_fetch_idp"),"error"),idpConfig={}})}function getId(){return"ap-"+uuid4.generate()}$scope.stream=$workflowService.selectedStream(),$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.fields=[],$scope.form={},$scope.noop=angular.noop,$scope.currentStep=0,$scope.btTestFormApi={},$scope.twitterData={type:"twitter",enable:!0,name:"Twitter"},$scope.content={env_name:""};var isAuthorized=!1,webhook_url=env_conf.API_SERVER_URL+"/hooks/twitter/"+$scope.stream._id,_idpName=$scope.stream.name+" twitter account",idpConfig={};$scope.idpID="";var streamUserAccountId="";$scope.channelHeaderCallback=$scope,$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_SLACK,$scope.channelHeaderCallback=$scope,$scope.request=i18n.i18nString("request"),$scope.post=i18n.i18nString("post_label"),$scope.goToHome=function(){
$scope.$parent.goToHome(),$scope.closeSlider()},$scope.assetsBase=env_conf["assets-url"],$scope.stream.channels=$scope.stream.channels||[],$scope.$watch("value",function(newVal,oldVal){$scope.twitterData=newVal||{enable:!0},$scope.twitterData.type="twitter",$scope.twitterData.name="Twitter",newVal&&newVal.idp&&newVal.idp.appConfig&&newVal.idp.appConfig.env&&($scope.content.env_name=newVal.idp.appConfig.env)}),$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.twitterData.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.twitterData.redirect_ui=$scope.twitterData.redirect_ui.slice(0,$scope.twitterData.redirect_ui.length-1)}),$scope.resetChannel=function(){BTStreamsService.deleteChannel($scope.stream._id,"twitter","",{idp:$scope.idpID}).then(function(res){NotificationService.notify(i18n.i18nString("chnl_reset_success"),"success"),$scope.twitterData.consumer_key="",$scope.twitterData.consumer_secret="",$scope.twitterData.access_token_key="",$scope.twitterData.access_token_secret="",$scope.twitterData.screen_name="",$scope.content.env_name="",$scope.idpID="",idpConfig&&idpConfig._id&&delete idpConfig._id},function(err){var errMsg=err&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("chnl_reset_failed");NotificationService.notify(errMsg,"error")})},$scope.testIdp=function(idpId){$scope.idpID=idpId,$scope.btTestFormApi.afterInit=function(){$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success,responseData){success?(streamUserAccountId=responseData.streamAccountId,NotificationService.notify(i18n.i18nString("auth_test_success"),"success")):(streamUserAccountId="",NotificationService.notify(i18n.i18nString("auth_test_failed"),"error")),$scope.btTestFormApi.close()},$scope.btTestFormApi.init({_id:idpId?idpId:$scope.newAuth&&$scope.newAuth.selected._id,type:"idp",testFor:"idp",isFromTwitter:!0})},getIdpByName(),$scope.authorize=function(form){var payload={};if(form&&form.$invalid)return form_util.touch(form),!1;if(payload={appConfig:{accessTokenURL:"https://api.twitter.com/oauth/access_token",baseURL:"",consumerKey:$scope.twitterData.consumer_key,consumerSecret:$scope.twitterData.consumer_secret,token:$scope.twitterData.access_token_key,tokenSecret:$scope.twitterData.access_token_secret,env:$scope.content.env_name,requestTokenURL:"https://api.twitter.com/oauth/request_token",userAuthorizationURL:"https://api.twitter.com/oauth/authorize",webhookUrl:webhook_url,screen_name:$scope.twitterData.screen_name},connectorEnabled:!1,fields:[],hasTenancy:!1,name:_idpName,sso_type:"oauth",streamId:$scope.stream._id},idpConfig._id){var id=idpConfig._id;delete idpConfig._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){getIdpByName(),$scope.testIdp(res.data._id)},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){getIdpByName(),$scope.testIdp(res.data._id)},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);if(!isAuthorized)return void NotificationService.notify(i18n.i18nString("please_authorize_chnl_before_saving"),"error");if(""===streamUserAccountId)return void NotificationService.notify(i18n.i18nString("aunthorization_failed"),"error");var payload={streamUserAccountId:streamUserAccountId,idp:$scope.idpID,mode:"sandbox",type:"twitter",enable:$scope.twitterData.enable};$scope.onSave(payload,"","","","Twitter")},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)};var twitter_rURI;$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,2===step&&$timeout(function(){twitter_rURI=new Clipboard('[data-clipboard-target="#twitter_rURI2"]'),$scope.isSafaryUri=!1,twitter_rURI.on("success",function(e){}),twitter_rURI.on("error",function(e){$scope.isSafaryUri=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})})}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("unbluChannel",[function(){return{restrict:"EA",scope:{value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/unblu-channel/unblu-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","form_util","NotificationService","env_conf","$translator","BTIdpService","uuid4","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,form_util,NotificationService,env_conf,$translator,BTIdpService,uuid4,i18n){function getId(){var getIdValue="ap-"+uuid4.generate();return getIdValue}$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.stream=$workflowService.selectedStream(),$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.channels=$workflowService.seedData().botChannelsTypes,$scope._constants_=_constants_,$scope.currentTab=0,$scope.channel={type:"Unblu",streamId:$scope.stream._id,app_name:$scope.stream.name,name:"Unblu",enable:!0};var clipWebhook_url;$scope.assetsBase=env_conf["assets-url"],$scope.stream.channels=$scope.stream.channels||[];$scope.stream.channels||[];$scope.channel.isReboardingEnabled=!1,$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp._id,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.idp.name,$scope.channel.unbluUrl=newVal.idp.appConfig.unbluHostUrl,$scope.channel.description=newVal.idp.appConfig.dialogBot.description,$scope.channel.app_name=$scope.stream.name,$scope.channel.streamId=newVal.idp.streamId,$scope.channel.userName=newVal.idp.appConfig.username,$scope.channel.password=newVal.idp.appConfig.password,$scope.channel.firstName=newVal.idp.appConfig.botPerson.firstName,$scope.channel.dialogBotName=newVal.idp.appConfig.dialogBot.name,$scope.channel.dialogBotSecret=newVal.idp.appConfig.dialogBot.secret,$scope.channel.namedAreaName=newVal.idp.appConfig.dialogBot.namedAreaNames)}),$scope.channelHeaderCallback=$scope;var showError=function(err){try{NotificationService.notify(err.data.errors[0].msg,"error")}catch(e){NotificationService.notify(i18n.i18nString("channel_config_failed"),"error")}};$scope.save=function(form){if(form.$invalid)return form_util.touch(form),void NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error");var payload={_id:$scope.channel._id,name:"unblu "+$scope.stream.name,enable:$scope.channel.enable,appConfig:{unbluHostUrl:$scope.channel.unbluUrl,username:$scope.channel.userName,password:$scope.channel.password,botPerson:{firstName:$scope.channel.firstName},dialogBot:{name:$scope.channel.dialogBotName,secret:$scope.channel.dialogBotSecret,description:$scope.channel.description,namedAreaNames:$scope.channel.namedAreaName}},streamId:$scope.channel.streamId,channel_auth:"unblu",sso_type:"custom"};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),NotificationService.notify(i18n.i18nString("unblu_edited_success"),"success")},function(err){showError(err)})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){$scope.goToHome(),NotificationService.notify(i18n.i18nString("unblu_added_success"),"success")},function(err){showError(err)})},$scope.goToHome=function(){$location.path(window.appConfig.CONTEXT_PATH),$scope.$parent.goToHome(),$scope.closeSlider()},BTStreamsService.getWebhookUrlForChannel({streamId:$workflowService.selectedStream()._id,channel:"unblu"}).then(function(res){$scope.channelAuth=res.data,$scope.channel.webhook_url=res.data.webhook_url,$scope.channel.verify_token=res.data.verify_token},function(err){$scope.channelAuth={}}),$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.redirect_ui=res.data.callbackURL.split(":idp")[0]||"",$scope.channel.redirect_ui=$scope.channel.redirect_ui.slice(0,$scope.channel.redirect_ui.length-1)}),$scope.currentStep={},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#unblu_webhook_url2"]'),$scope.isSafariwh=!1,$scope.isSafarivt=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("whatsappBusiness",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/whatsapp-business/whatsapp-business.html",controller:["$scope","$workflowService","$location","$timeout","BTStreamsService","env_conf","form_util","i18n",function($scope,$workflowService,$location,$timeout,BTStreamsService,env_conf,form_util,i18n){var clipWebhook_url;$scope.channel=$scope.value||{enable:!0};var stream=$workflowService.selectedStream();$scope.assetsBase=env_conf["assets-url"],$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.phoneNumbInfo=!1,$scope.whatsAppImage=env_conf["context-url"]+"/img/whatsapp-business.svg",$scope.partnerClicked={},$scope.save=function(form){var payload={};return form&&form.$invalid?void form_util.touch(form):(payload.type="whatsapp",payload.enable=$scope.channel.enable,payload.vendor=$scope.configurationsSelectedPartner.key,"karix"!==$scope.configurationsSelectedPartner.key&&(payload.username=$scope.channel.username),"karix"!==$scope.configurationsSelectedPartner.key&&(payload.password=$scope.channel.password),payload.from=$scope.channel.from,"infobip"===$scope.configurationsSelectedPartner.key&&(payload.host=$scope.channel.host),"karix"===$scope.configurationsSelectedPartner.key&&(payload.accountKey=$scope.channel.accountKey),"infobip"===$scope.configurationsSelectedPartner.key&&(payload.keyword=$scope.channel.keyword),void $scope.onSave(payload,"","","","Whatsapp"))},$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.currentStep={},$scope.channel={name:i18n.i18nString("whatsapp_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0,webhook_url:env_conf.API_SERVER_URL+"/hooks/whatsapp/"+stream._id,webhook_url_gp:env_conf.API_SERVER_URL+"/hooks/gp/whatsapp/"+stream._id,webhook_url_karix:env_conf.API_SERVER_URL+"/hooks/karix/whatsapp/"+stream._id},$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel.enable=newVal.enable,$scope.channel.username=newVal.username,$scope.channel.password=newVal.password,$scope.channel.from=newVal.from,$scope.channel.host=newVal.host,$scope.channel.keyword=newVal.keyword,$scope.channel.accountKey=newVal.accountKey)}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.currentStep=angular.copy($scope.steps[0]),$scope.stepClick=function(step){$scope.next(step),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),2===step&&$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#whatsAppForm_webhook_url"]'),$scope.isSafariwh=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".fb-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)},$scope.messagingPartnerArray=[{key:"infobip",title:i18n.i18nString("Bt_chnl_whatsappB_instruct_drpdown_option")},{key:"gupshup",title:i18n.i18nString("Bt_chnl_whatsappB_instruct_drpdown_option-1")},{key:"karix",title:i18n.i18nString("Bt_chnl_whatsappB_instruct_drpdown_option-2")}],$scope.value&&$scope.value.vendor?_.forEach($scope.messagingPartnerArray,function(val){val.key===$scope.value.vendor&&($scope.instructionsSelectedPartner=val,$scope.configurationsSelectedPartner=val)}):($scope.instructionsSelectedPartner=$scope.messagingPartnerArray[0],$scope.configurationsSelectedPartner=$scope.messagingPartnerArray[0]),$scope.instructionsPartnerSelection=function(partner){$scope.instructionsSelectedPartner||($scope.instructionsSelectedPartner={}),$scope.configurationsSelectedPartner||($scope.configurationsSelectedPartner={}),$scope.instructionsSelectedPartner=partner,$scope.configurationsSelectedPartner=partner},$scope.configurationsPartnerSelection=function(partner){$scope.configurationsSelectedPartner||($scope.configurationsSelectedPartner={}),$scope.instructionsSelectedPartner=partner,$scope.configurationsSelectedPartner=partner,($scope.channel.from||$scope.channel.host||$scope.channel.username||$scope.channel.password||$scope.channel.keyword)&&($("#DismissConfigurations").modal("show"),$scope.partnerClicked=partner)},$scope.closeEnableUserMsgPopup=function(){"infobip"===$scope.configurationsSelectedPartner.key&&($scope.configurationsSelectedPartner={key:"gupshup",title:i18n.i18nString("Bt_chnl_whatsappB_instruct_drpdown_option-1")}),"karix"===$scope.configurationsSelectedPartner.key?$scope.configurationsSelectedPartner={key:"gupshup",title:i18n.i18nString("Bt_chnl_whatsappB_instruct_drpdown_option-2")}:$scope.configurationsSelectedPartner={key:"infobip",title:i18n.i18nString("Bt_chnl_whatsappB_instruct_drpdown_option")},$("#DismissConfigurations").modal("hide")},$scope.closeOpenedConfigurePopup=function(){$("#DismissConfigurations").modal("hide")},$scope.updateWhatsappConfigurations=function(){$scope.configurationsSelectedPartner=$scope.partnerClicked,$("#DismissConfigurations").modal("hide"),$scope.channel.from=null,$scope.channel.host=null,$scope.channel.username=null,$scope.channel.password=null,$scope.channel.keyword=null}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.filter("otherbots",function(){return function(bots,stream){var filtered=_.filter(bots,function(o){return o._id&&o._id!==stream._id});return _.pluck(filtered,"name").join(", ")}}),_module.filter("mask",function(){return function(str){return str?Array(str.length).join("*"):""}}),_module.directive("widgetsdkChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/widgetsdk-channel/widgetsdk-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","$rootScope","$modal","AppsDataService","NotificationService","$q","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,$rootScope,$modal,AppsDataService,NotificationService,$q,i18n){function getApps(){$scope.loadingAddChannel=!0,$q.all([AppsDataService.getAppsList($scope.stream._id),AppsDataService.getBotsList()]).then(function(res){if($scope.loadingAddChannel=!1,res[1]&&res[1].data?$scope.avalSreams=res[1].data:$scope.avalSreams=[],res[0]&&res[0].data&&res[0].data.apps){$scope.apps=res[0].data.apps,$scope.JWEPublicKey=res[0].data.publicKeys.keys[0];var a_appClientIds=_.pluck($scope.apps,"clientId");if($workflowService.selectedStream().sdkSubscription&&-1===$.inArray($workflowService.selectedStream().sdkSubscription.sdkClientId,a_appClientIds)){var appObject=$workflowService.selectedStream().sdkSubscription;appObject.clientId=appObject.sdkClientId,appObject.isNonEditable=!0,$scope.apps.push(appObject)}if($scope.$parent.widgetsdk&&$scope.$parent.widgetsdk.app){var _selApps=$scope.apps.filter(function(app){return app.clientId===$scope.$parent.widgetsdk.app.clientId});$scope.setApp(_selApps[0]),$scope.isNonEditable=_selApps[0].isNonEditable}else if($workflowService.selectedStream().appPreferences&&$workflowService.selectedStream().appPreferences.rtmAppId){var _selApps1=$scope.apps.filter(function(app){return app.clientId===$workflowService.selectedStream().appPreferences.rtmAppId});$scope.setApp(_selApps1[0]),$scope.isNonEditable=_selApps1[0].isNonEditable}$scope.apps=_.filter($scope.apps,function(o){return o.clientId})}else $scope.apps=[]},function(err){$scope.loadingAddChannel=!1,NotificationService.alertNotify(i18n.i18nString("get_apps"))})}$scope._=_,$scope.stream=$scope.$parent.stream,$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState(),$scope.secretKeyShown=!1,$scope.speech={},$scope.speech.sttEnabled=!1,$scope.speech.sttEngine="kore",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.closeArrow=window.appConfig.CONTEXT_PATH+"/assets/landingImages/closeCross.png",$scope.selectConfig={placeholder:i18n.i18nString("select_a_key"),allowClear:!1,minimumResultsForSearch:-1},$scope.currentStep={},$scope.channel=$scope.value||{enable:!0},$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.selectedApp={selApp:""},$scope.channel&&$scope.channel.app&&$scope.channel.app.clientId&&($scope.selectedApp.selApp=$scope.channel.app.clientId),$scope.goToHome=function(){$scope.$parent.goToHome()},setTimeout(function(){$(".webMobileClientChannel").scrollTop(1)},700);for(var i=0;i<$scope.stream.channels.length;i++)if("widgetsdk"===$scope.stream.channels[i].type){$scope.speech.sttEnabled=$scope.stream.channels[i].sttEnabled||!1;break}$(".JSONDiv a").click(function(){$("#JWTToken").show()}),$scope.setApp=function(app){$scope.selectedAppView=app,setTimeout(function(){app&&$("#select2").select2("val",app.clientId)},100)},$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,step>$scope.currentStep.step&&($scope.currentStep=angular.copy($scope.steps[step-1])),$(".widgetsdk-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},250)},$scope.listener=function(msg,args){if("app.created"===msg)$scope.apps.push(args);else if("app.edited"===msg){var _index=_.findIndex($scope.apps,function(o){return o.clientId===args.clientId});_index>-1&&($scope.apps[_index]=args)}$scope.setApp(args)},$scope.stepClick=function(step){$scope.next(step),$(".widgetsdk-channel-page").scrollTop(0),$timeout(function(){$(".inner-scroll").scrollTop(2)},250)},$scope.createNewApp=function(){$scope.selectedApp.selApp="create"},$scope.onSelectedApp=function(newVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},$scope.$watch("selectedApp.selApp",function(newVal,oldVal){if($scope.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp.selApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.selectedAppView=$scope.apps[_index])}catch(e){}},!0),$scope.editApp=function(){var app=$scope.selectedAppView;$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Edit",context:"addChannel",cb:$scope.listener,app:app,bot:$scope.stream}}}})},$scope.createApp=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Create",context:"addChannel",cb:$scope.listener,bot:$scope.stream}}}})},$scope.onCancel=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.savewidgetsdk=function(){var payload={};payload.type="widgetsdk",payload.name="Widget SDK",payload.app={clientId:$scope.selectedAppView.clientId,appName:$scope.selectedAppView.appName,key:$scope.selectedAppView.key},payload.isAlertsEnabled=$scope.$parent.widgetsdk.isAlertsEnabled,payload.enable=$scope.$parent.widgetsdk.enable,payload.sttEnabled=$scope.speech.sttEnabled,payload.sttEngine=$scope.speech.sttEngine,$scope.onSave(payload,"","","","Widget SDK")},$scope.showHideSecret=function(){$scope.secretKeyShown=!0},getApps();new Clipboard("[data-clipboard-target]");$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3),$scope.copyJWTToken=function(containerid){var textarea=document.createElement("textarea");textarea.id="temp_element",textarea.style.height=0,document.body.appendChild(textarea),textarea.value=document.getElementById(containerid).innerText;var selector=document.querySelector("#temp_element");selector.select(),document.execCommand("copy"),document.body.removeChild(textarea),NotificationService.notify(i18n.i18nString("jwe_key_copy"),"success")}}],link:function($scope,$ele,$attrs,ctrls){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("yammerChannel",[function(){return{restrict:"EA",scope:{onSave:"=",value:"=",context:"=",wfType:"=",closeSlider:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-form/yammer-channel/yammer-channel.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","BTIdpService","NotificationService","uuid4","$translator","form_util","i18n",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,BTIdpService,NotificationService,uuid4,$translator,form_util,i18n){function getIdpByName(){BTIdpService.getIdpByName(_idpName,$workflowService.selectedStream()._id).then(function(res){$scope.idpConfig=res.data,$scope.idpConfig&&$scope.idpConfig.appConfig&&($scope.channel.clientSecret=$scope.idpConfig.appConfig.clientSecret,$scope.channel.clientID=$scope.idpConfig.appConfig.clientID,idpID=$scope.idpConfig._id)},function(err){NotificationService.notify(i18n.i18nString("failed_fetch_idp"),"error"),$scope.idpConfig={}})}function getId(){return"ap-"+uuid4.generate()}var stream=$workflowService.selectedStream();$scope.streamState={},$scope.streamState.state=$workflowService.selectedStreamState();var streamUserAccountId="",idpID="";$scope.btTestFormApi={},$scope.btTestStatus={},$scope.channel={name:i18n.i18nString("yammer_account",{dyn:stream.name}),streamId:stream._id,app_name:stream.name,enable:!0},$scope.channel.mode="sandbox";$scope.assetsBase=env_conf["assets-url"],$scope.$watch("value",function(newVal,oldVal){newVal&&_.isObject(newVal)&&Object.keys(newVal).length>0&&($scope.channel._id=newVal.idp,$scope.channel.enable=newVal.enable,$scope.channel.name=newVal.name,$scope.channel.mode=newVal.mode,$scope.channel.app_name=stream.name,$scope.channel.streamId=newVal.idp.streamId,streamUserAccountId=newVal.streamUserAccountId||"",console.log($scope.channel))}),$scope.steps=[{step:1,active:!0,name:i18n.i18nString("bt_chnl_instruction")},{step:2,active:!1,name:i18n.i18nString("bt_chnl_configuration")}],$scope.stepClick=function(step){$scope.next(step),$(".slack-channel-page").scrollTop(0)},$translator.translate("bt.callbackurl.get",{streamId:$workflowService.selectedStream()._id},{}).then(function(res){$scope.channel.oAuthRedirectURI=res.data.callbackURL.split("/:idp")[0]});var _idpName=i18n.i18nString("yammer_account",{dyn:stream.name});$scope.idpConfig="",getIdpByName(),$scope.createIDPAndCheckAuthorization=function(yammerForm){$scope.saveIDP(yammerForm)},$scope.saveIDP=function(form){if(form.$invalid)return form_util.touch(form),$scope.clientIDRequired=$scope.channel.clientID&&$scope.hannel.clientID.trim()?!1:!0,$scope.clientSecretRequired=$scope.channel.clientSecret&&$scope.channel.clientSecret.trim()?!1:!0,void NotificationService.notify(i18n.i18nString("please_provide_mandatory_fields"),"error");var payload={_id:$scope.idpConfig._id,name:_idpName,enable:$scope.channel.enable,appConfig:{authorizationURL:"https://www.yammer.com/oauth2/authorize",tokenURL:" https://www.yammer.com/oauth2/access_token.json",clientID:$scope.channel.clientID,clientSecret:$scope.channel.clientSecret,scope:""},streamId:$scope.channel.streamId,channel_auth:"yammer",sso_type:"oauth2"};if(payload._id){var id=payload._id;delete payload._id,BTIdpService.editIdp(id,$workflowService.selectedStream()._id,payload).then(function(res){getIdpByName(),$scope.testIdp(res.data._id)},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})}else payload._id=getId(),BTIdpService.createIdp($workflowService.selectedStream()._id,payload).then(function(res){getIdpByName(),$scope.testIdp(res.data._id)},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("channel_config_failed");NotificationService.notify(errMsg,"error")})},$scope.save=function(form){if(form&&form.$invalid)return void form_util.touch(form);if(!streamUserAccountId)return void NotificationService.notify(i18n.i18nString("bt_chnl_pls_setup_authorization"),"error");var payload={};payload.streamUserAccountId=streamUserAccountId,payload.idp=idpID||$scope.channel.app_token,payload.type="yammer",payload.enable=$scope.channel.enable,$scope.onSave(payload,"","","","Yammer")},$scope.testIdp=function(idpId){idpID=idpId,$scope.btTestFormApi.afterInit=function(){$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success,responseData){success?(streamUserAccountId=responseData.streamAccountId,NotificationService.notify(i18n.i18nString("auth_test_success"),"success")):(streamUserAccountId="",NotificationService.notify(i18n.i18nString("auth_test_failed"),"error")),$scope.btTestFormApi.close()},$scope.btTestFormApi.init({_id:idpId?idpId:$scope.newAuth&&$scope.newAuth.selected._id,type:"idp",testFor:"idp",isFromRingCentral:!0})},$scope.helpLink=$scope.$root.helpLinks.ADD_CHANNEL_YAMMER,$scope.channelHeaderCallback=$scope,$scope.goToHome=function(){$scope.$parent.goToHome(),$scope.closeSlider()},$scope.bulbSvg=env_conf["context-url"]+"/assets/images/bulbicon.svg",$scope.next=function(step){$scope.steps.map(function(step){step.active=!1}),$scope.steps[step-1].active=!0,2===step&&$timeout(function(){$scope.isSafariwebhook=!1;var clipB=new Clipboard('[data-clipboard-target="#yammeroauthuri2"');clipB.on("success",function(e){}),clipB.on("error",function(e){$scope.isSafariwebhook=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$(".slack-channel-page").scrollTop(0)},$timeout(function(){$(".inner-scroll").scrollTop(2)},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("channelIvrSettingsSupp",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-support/channel-ivr-settings-supp/channel-ivr-settings-supp.html",scope:{cb:"="},controller:"ivrSettingsCtrl",controllerAs:"ivrSettSupp",bindToController:!1}}]),_module.controller("ivrSettingsCtrl",["$scope","$workflowService","$timeout","AppsDataService","BTStreamsService","env_conf","$applicationService","NotificationService","uuid4","BTIdpService","i18n","$q","$modal","BTFlowtaskService","channelsConfig",function($scope,$workflowService,$timeout,AppsDataService,BTStreamsService,env_conf,$applicationService,NotificationService,uuid4,BTIdpService,i18n,$q,$modal,BTFlowtaskService,channelsConfig){function getDialogs(){var deferred=$q.defer();return $scope.dialogsName=[],BTFlowtaskService.getFlowtaks($workflowService.selectedStream()._id).then(function(res){var ind=0,refIds=[];res.data.forEach(function(val){-1==refIds.indexOf(val.refId)&&refIds.push(val.refId)}),res.data.forEach(function(val){!val.isFollowUp&&refIds.indexOf(val.refId)>-1&&($scope.dialogsName[ind]={},$scope.dialogsName[ind].name=val.name,$scope.dialogsName[ind].id=val.refId,refIds.splice(refIds.indexOf(val.refId),1),ind++)}),deferred.resolve($scope.dialogsName)},function(err){console.log(err),deferred.reject(err)}),deferred.promise}function createConversationEndPayload(){var payload={CONVERSATION_END:{}};if("initiate"===$scope.events.config){payload.CONVERSATION_END.action="triggerDialog",payload.CONVERSATION_END.script=".",payload.CONVERSATION_END.msg=[];var dialogId="";if(!$scope.selected.dialog)return!1;for(var i=0;i<$scope.dialogsName.length;i++)if($scope.dialogsName[i].name===$scope.selected.dialog){dialogId=$scope.dialogsName[i].id;break}payload.CONVERSATION_END.task=dialogId}else"runScript"===$scope.events.config?(payload.CONVERSATION_END.action="runScript",payload.CONVERSATION_END.script=$scope.inp.scriptText,payload.CONVERSATION_END.task="",payload.CONVERSATION_END.welcomeMsg=[]):"showMessage"===$scope.events.config&&(payload.CONVERSATION_END.action="showMsg",payload.CONVERSATION_END.script=".",payload.CONVERSATION_END.msg=$scope.responseObj);return payload.CONVERSATION_END.enabled=!0,payload.CONVERSATION_END.manageFirstMessage={},payload.CONVERSATION_END.welcomeIvrOptions=[],payload}function getStreams(){BTStreamsService.getBTStream(stream._id).then(function(res){$scope.isLoading=!1;var reqKey=$scope.cb.streamVoiceKey;if(res.data&&res.data[reqKey]&&($scope.ivrSettingsSupp=angular.copy(res.data[reqKey]),!res.data[reqKey].properties||"audiocodes"!=$scope.cb.isFrom&&"propPanelAudiocodes"!=$scope.cb.isFrom||($scope.tempProperty=res.data[reqKey].properties)),res.data&&res.data.botEvents&&res.data.botEvents.CONVERSATION_END){var convEnd=res.data.botEvents.CONVERSATION_END;if(convEnd&&convEnd.enabled)if($scope.conver.value="trigger","triggerDialog"===convEnd.action){var dialogName="";$scope.events.config="initiate";for(var i=0;i<$scope.dialogsName.length;i++)if($scope.dialogsName[i].id===convEnd.task){dialogName=$scope.dialogsName[i].name;break}$scope.selected.dialog=dialogName}else"runScript"===convEnd.action?($scope.events.config="runScript",$scope.inp.scriptText=decodeJS(convEnd.script)):"showMsg"===convEnd.action&&($scope.events.config="showMessage",
$scope.responseObj=angular.copy(res.data.botEvents.CONVERSATION_END.msg));else res.data.ivrSettings&&res.data.ivrSettings.enable&&($scope.conver.value="terminate")}else $scope.conver.value="terminate";setTimeout(function(){$(".nodeLevelChannelSlider .modalBody").scrollTop(1)},200)},function(err){$scope.isLoading=!1})}$scope.modalSlider={},$scope.rightClass="right700",$scope.isLoading=!0,$scope.timeIntervels=[],$scope.retriesCount=[];for(var maxTimeinSecs=60,k=0;maxTimeinSecs>=k;k++)$scope.timeIntervels.push(1e3*k);for(var j=1;10>=j;j++)$scope.retriesCount.push(j);$scope.streamState=$workflowService.selectedStreamState(),$scope.isDialogsAvailable=!1,$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.conver={value:"terminate"},$scope.inp={scriptText:""},$scope.events={config:"initiate"},$scope.selected={dialog:""},$scope.show={enable:!1},$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.backArrow=env_conf["context-url"]+"/assets/icons/rightArrow.svg",$scope.channelsConfig=channelsConfig,$scope.ivr=[],$scope.ivrSettingsSupp={enable:!0,timeout:3e3,retry_limit:6,callTerminationHandler:"",bargein:!1,properties:[],timeoutPrompts:[[{type:"text",value:""}]]},$scope.cb.voicePropSettings=$scope.ivrSettingsSupp,$scope.cb.conver=$scope.conver,$scope.assetsBase=env_conf["assets-url"],$scope.stream=$workflowService.selectedStream();var stream=$workflowService.selectedStream();$scope.channel_supp_ivr_cb={},$scope.channel_supp_ivr_cb.isAddResponseEnabled=!1,$scope.channel_supp_ivr_cb.isFrom=$scope.cb.isFrom,$scope.channel_supp_ivr_cb.isAPICall=!1,$scope.responseObj=[],$scope.channel_supp_ivr_cb.closeAddResponseModal=function(){$scope.channel_supp_ivr_cb.isAddResponseEnabled=!1,$scope.show.enable=!1,$scope.modalSlider.close("#addResponseChannelSupp")},$scope.convertToInt=function(id){return parseInt(id,10)},$scope.editResponse=function(index){var isChannelSpec=!1,channelId="all";$scope.channel_supp_ivr_cb.isAddResponseEnabled=!0,$scope.show.enable=!0,$timeout(function(){$scope.show.enable=!0,setTimeout(function(){$scope.modalSlider.open("#addResponseChannelSupp")},200),$scope.channel_supp_ivr_cb.loadMessage($scope.responseObj,index,isChannelSpec,channelId),$scope.channel_supp_ivr_cb.openResponseSliderIvr(),$(".welcomeMessageModal").modal("show")},500)},$scope.deleteMessage=function(response,index){function delMessage(){$scope.isAddRespEdited=!0;for(var i=0;i<$scope.responseObj.length;i++)if(""!==$scope.responseObj[i]._id&&$scope.responseObj[i]._id===response._id&&$scope.responseObj[i].channel===response.channel||$scope.responseObj[i].text===response.text&&$scope.responseObj[i].channel===response.channel){$scope.responseObj.splice(i,1);break}}var numOfAllChannels=$scope.responseObj.filter(function(v){return"default"===v.channel}).length;"default"===response.channel&&1===numOfAllChannels?NotificationService.confirm({msg:i18n.i18nString("channel_mandatory"),successCb:function(){delMessage()},isModal:!0,btnTexts:{success:i18n.i18nString("yes"),fail:i18n.i18nString("no")}}):delMessage()},$scope.decodeJS=function(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}};var decodeJS=$scope.decodeJS;$scope.channel_supp_ivr_cb.getObjResponse=function(obj,isEdit){if($scope.isSaveDisabled=!1,$scope.isAddRespEdited=!0,isEdit){for(var i=0;i<$scope.responseObj.length;i++)if($scope.responseObj[i]._id===obj._id){$scope.responseObj.splice(i,1,obj);break}}else $scope.responseObj.push(obj)},$scope.channel_supp_ivr_cb.getObjResponseEdit=function(obj){$scope.isAddRespEdited=!0,$scope.isSaveDisabled=!1,$scope.responseObj=[],$scope.responseObj=angular.copy(obj)},$scope.cb.saveIVR=function(callb){if($scope.submitForm=!0,!$scope.ivrSettSupp.ivrForm.$invalid){if("trigger"===$scope.conver.value&&"showMessage"===$scope.events.config){var numOfAllChannels=$scope.responseObj.filter(function(v){return"default"===v.channel}).length;if(0===numOfAllChannels)return void NotificationService.notify(i18n.i18nString("atleast_one_all_chann"),"error")}var temp={};temp[$scope.cb.streamVoiceKey]=$scope.ivrSettingsSupp;var convPayload={};convPayload=createConversationEndPayload(),convPayload!==!1&&(temp.botEvent={},temp.botEvent.CONVERSATION_END={},temp.botEvent.CONVERSATION_END=convPayload.CONVERSATION_END),"terminate"==$scope.conver.value&&temp.botEvent&&temp.botEvent.CONVERSATION_END&&(temp.botEvent.CONVERSATION_END.enabled=!1),BTStreamsService.editStream(stream._id,temp).then(function(res){NotificationService.notify("Voice Call Properties saved successfully","success"),callb()},function(err){try{NotificationService.notify(err.data.errors[0].msg,"error")}catch(e){NotificationService.notify("Failed to save Voice Call Properties","error")}})}},$scope.activateValueSearch=function(show){$scope.showNameSearch=!1,show?$scope.showValueSearch=!0:$scope.showValueSearch=!1,$scope.ivr.nameSearchQuery="",$scope.tempProperty=$scope.ivrSettingsSupp.properties,setTimeout(function(){$(".focusValueSearch").focus()},100)},$scope.activateNameSearch=function(show){$scope.showValueSearch=!1,show?$scope.showNameSearch=!0:$scope.showNameSearch=!1,$scope.ivr.nameSearchQuery="",$scope.tempProperty=$scope.ivrSettingsSupp.properties,setTimeout(function(){$(".focusNameSearch").focus()},100)},$scope.addProperty=function(key){angular.element("#saveBtn").removeClass("zIndex"),"add"==key&&($scope.saveEdit=!1,$scope.showEnable=!0,$timeout(function(){$scope.modalSlider.open("#vxmlProp")},100),$scope.vxmlproperty={},$scope.vxmlproperty.name="",$scope.vxmlproperty.value="")},$scope.editProperty=function(index){$scope.saveEdit=!0,$scope.showEnable=!0,$.each($scope.ivrSettingsSupp.properties,function(i,property){index===i&&($scope.editIndex=i,$scope.vxmlproperty=angular.copy(property))}),$timeout(function(){$scope.modalSlider.open("#vxmlProp")},100)},$scope.deleteProperty=function(index){$scope.ivrSettingsSupp.properties.splice(index,1),$scope.tempProperty=$scope.ivrSettingsSupp.properties,$scope.xmlProperties=$scope.ivrSettingsSupp.properties},$scope.createProperty=function(type){return""===$scope.vxmlproperty.name?void NotificationService.notify(i18n.i18nString("valid_property_name"),"error"):""===$scope.vxmlproperty.value?void NotificationService.notify(i18n.i18nString("valid_property_value"),"error"):("new"===type?($scope.ivrSettingsSupp.properties||($scope.ivrSettingsSupp.properties=[]),$scope.ivrSettingsSupp.properties.push($scope.vxmlproperty),$scope.tempProperty=$scope.ivrSettingsSupp.properties,$scope.xmlProperties=$scope.ivrSettingsSupp.properties,$scope.modalSlider.close("#vxmlProp")):"edit"===type&&($scope.ivrSettingsSupp.properties[$scope.editIndex]=$scope.vxmlproperty,$scope.tempProperty=$scope.ivrSettingsSupp.properties,$scope.xmlProperties=$scope.ivrSettingsSupp.properties,$scope.modalSlider.close("#vxmlProp")),void($scope.showEnable=!1))},$scope.cancleCreate=function(){$scope.saveEdit||($scope.vxmlproperty.name="",$scope.vxmlproperty.value=""),angular.element("#saveBtn").addClass("zIndex"),$scope.modalSlider.close("#vxmlProp"),$scope.showEnable=!1},$scope.trackSearch=function(event){27===event.keyCode&&($scope.showValueSearch=!1,$scope.showNameSearch=!1,$scope.ivr.nameSearchQuery="",$scope.tempProperty=$scope.newStreamData.ivrSettings.properties)},$scope.searchRecords=function(key){""!==$scope.ivr.nameSearchQuery&&($scope.showNameSearch||$scope.showValueSearch)?$scope.tempProperty=$scope.tempProperty.filter(function(variable){return"name"===key?0===variable.name.indexOf($scope.ivr.nameSearchQuery):0===variable.value.indexOf($scope.ivr.nameSearchQuery)}):$scope.tempProperty=angular.copy($scope.ivrSettingsSupp.properties)},getDialogs().then(function(data){$scope.isDialogsAvailable=!0,getStreams()},function(err){$scope.isDialogsAvailable=!0,$scope.dialogsName=[],NotificationService.notify(i18n.i18nString("unable_fetch_dialogs"),"error")})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("createNewAppSupp",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-support/create-new-app-supp/create-new-app-supp.html",scope:{cb:"="},controller:["$scope","$workflowService","$timeout","AppsDataService","BTStreamsService","env_conf","$applicationService","NotificationService","uuid4","BTIdpService","i18n","$q","$modal",function($scope,$workflowService,$timeout,AppsDataService,BTStreamsService,env_conf,$applicationService,NotificationService,uuid4,BTIdpService,i18n,$q,$modal){function getApps(){$scope.loadingAddChannel=!0,$scope.cb.loadingAppDetails=!0;var deferred=$q.defer();return $q.all([AppsDataService.getAppsList($scope.stream._id),AppsDataService.getBotsList()]).then(function(res){if($scope.loadingAddChannel=!1,res[1]&&res[1].data?$scope.avalSreams=res[1].data:$scope.avalSreams=[],res[0]&&res[0].data&&res[0].data.apps){$scope.apps=res[0].data.apps;var a_appClientIds=_.pluck($scope.apps,"clientId");if($workflowService.selectedStream().sdkSubscription&&-1===$.inArray($workflowService.selectedStream().sdkSubscription.sdkClientId,a_appClientIds)){var appObject=$workflowService.selectedStream().sdkSubscription;appObject.clientId=appObject.sdkClientId,appObject.isNonEditable=!0,$scope.apps.push(appObject)}if($scope.cb.value&&$scope.cb.value.app){var _selApps=$scope.apps.filter(function(app){return app.clientId===$scope.cb.value.app.clientId});_selApps&&_selApps.length&&($scope.setApp(_selApps[0]),$scope.isNonEditable=_selApps[0].isNonEditable)}$scope.apps=_.filter($scope.apps,function(o){return o.clientId}),$scope.cb.loadingAppDetails=!1}else $scope.apps=[],$scope.cb.loadingAppDetails=!1;deferred.resolve(res)},function(err){$scope.cb.loadingAppDetails=!1,$scope.loadingAddChannel=!1,NotificationService.alertNotify(i18n.i18nString("get_apps")),deferred.reject(err)}),deferred.promise}$scope.assetsBase=env_conf["assets-url"];var stream=$workflowService.selectedStream();$scope.stream=$workflowService.selectedStream(),$scope.streamState=$workflowService.selectedStreamState(),$scope.selectConfig={placeholder:i18n.i18nString("select_a_key"),allowClear:!1,minimumResultsForSearch:-1},$scope.sel={selectedApp:""};new Clipboard("[data-clipboard-target]");$scope.setApp=function(app){$scope.cb.selectedAppView=app,$scope.selectedApp=app.clientId,setTimeout(function(){$("#select2").select2("val",app.clientId)},100)},$scope.createNewApp=function(){$scope.sel.selectedApp="create"},$scope.listener=function(msg,args){if("app.created"===msg)$scope.apps.push(args);else if("app.edited"===msg){var _index=_.findIndex($scope.apps,function(o){return o.clientId===args.clientId});_index>-1&&($scope.apps[_index]=args)}$scope.setApp(args)},$scope.onSelectedApp=function(newVal){if($scope.cb.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.selectedApp="";else if(newVal)try{var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.cb.selectedAppView=$scope.apps[_index])}catch(e){}},$scope.$watch("sel.selectedApp",function(newVal,oldVal){if($scope.cb.selectedAppView="choose","create"===newVal)$scope.createApp(),$scope.sel.selectedApp="";else if(newVal)try{getApps().then(function(res){var _index=_.findIndex($scope.apps,function(o){return o.clientId===newVal});_index>-1&&($scope.cb.selectedAppView=$scope.apps[_index])},function(err){})}catch(e){}},!0),$scope.showHideSecret=function(){$scope.secretKeyShown=!0},$scope.createApp=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Create",context:"addChannel",cb:$scope.listener,bot:stream}}}})},$scope.editApp=function(){var app=$scope.cb.selectedAppView;$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Edit",context:"addChannel",cb:$scope.listener,app:app,bot:stream}}}})},getApps()}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("nodeLevelVoiceChannelsAllSliders",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-support/node-level-voice-channels-all-sliders/node-level-voice-channels-all-sliders.html",scope:{cb:"=",nodeInfo:"="},controller:["$scope","$workflowService","$timeout","AppsDataService","BTStreamsService","env_conf","$applicationService","NotificationService","uuid4","BTIdpService","i18n","$q","$modal",function($scope,$workflowService,$timeout,AppsDataService,BTStreamsService,env_conf,$applicationService,NotificationService,uuid4,BTIdpService,i18n,$q,$modal){$scope.audio_codes_cb={},$scope.twilio_voice_cb={},$scope.modalSlider={},$scope.isAudioCodesSlider=!1,$scope.rightClass="right700",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.assetsBase=env_conf["assets-url"],$scope.selectedStreamState=$workflowService.selectedStreamState(),$scope.closeAudioCodes=function(){$scope.modalSlider.close("#audioCodesChannel"),$scope.cb.closeVoiceSlider()},$scope.saveAudioIVR=function(){$scope.audio_codes_cb.saveIVR($scope.closeAudioCodes)},$scope.cb.openAudioCodesVoiceProp=function(){$scope.isAudioCodesSlider=!0,$scope.audio_codes_cb.isFrom="propPanelAudiocodes",$scope.audio_codes_cb.streamVoiceKey="audioCodesSettings",$scope.modalSlider.open("#audioCodesChannel")},$scope.closeTwilioVoice=function(){$scope.modalSlider.close("#twilioVoiceSettings"),$scope.cb.closeVoiceSlider()},$scope.saveTwilioIVR=function(){$scope.twilio_voice_cb.saveIVR($scope.closeTwilioVoice)},$scope.editResponse=function(index){var isChannelSpec=!1,channelId="all";$scope.welcomeMessagecbs.isAddResponseEnabled=!0,$scope.showEnable=!0,$timeout(function(){$scope.modalSlider.open("#btWelcomeMess"),$scope.welcomeMessagecbs.loadMessage($scope.responseObj,index,isChannelSpec,channelId),$scope.welcomeMessagecbs.openResponseSliderIvr(),$(".welcomeMessageModal").modal("show")},100)},$scope.cb.openChannelLevelTwilioVoice=function(){$scope.isTwilioVoiceSlider=!0,$scope.twilio_voice_cb.isFrom="twilioVoicePP",$scope.twilio_voice_cb.streamVoiceKey="twilioVoiceSettings",$scope.modalSlider.open("#twilioVoiceSettings")}}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("nodeLevelVoiceChannelsSupp",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/channels-support/node-level-voice-channels-supp/node-level-voice-channels-supp.html",scope:{cb:"="},controller:["$scope","$workflowService","$timeout","AppsDataService","BTStreamsService","env_conf","$applicationService","NotificationService","uuid4","BTIdpService","i18n","$q","$modal",function($scope,$workflowService,$timeout,AppsDataService,BTStreamsService,env_conf,$applicationService,NotificationService,uuid4,BTIdpService,i18n,$q,$modal){$scope.flag={showRest:!1}}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("conversationDialogBuilder",function(){return{restrict:"EAQ",scope:{onComplete:"&",wfType:"@",displayMode:"@",configure:"&",callBack:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/conversation-builder/conversation-dialog-builder.html",controller:["$window","$scope","patternFactory","$element","env_conf","$timeout","$rootScope","$location","$filter","$routeParams","NotificationService","$workflowService","BTFlowtaskService","BTStreamsService","$modal","$sanitize","accessControlService","$applicationService","i18n","$q","channelsConfig","defaultValue","$sce",function($window,$scope,patternFactory,$element,env_conf,$timeout,$rootScope,$location,$filter,$routeParams,NotificationService,$workflowService,BTFlowtaskService,BTStreamsService,$modal,$sanitize,accessControlService,$applicationService,i18n,$q,channelsConfig,defaultValue,$sce){function exit1(){""!==$scope.firstNodeUId?BTFlowtaskService.unlockFlowTask($scope.dialogTask._id).then(function(){$workflowService.dialogNodesNames([]),$scope.callBack&&$scope.callBack.closeFlowTaskEvent&&$scope.callBack.closeFlowTaskEvent(),closeFullPageModal1()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("release_lock"),"error");$scope.callBack&&$scope.callBack.closeFlowTaskEvent&&$scope.callBack.closeFlowTaskEvent(),closeFullPageModal1()}):closeFullPageModal1()}$scope.lodingDialog=!0;var _loggerInstance={};$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.formSelection=env_conf["context-url"]+"/assets/images/check-green-small.svg",$scope.formDropDown=env_conf["context-url"]+"/assets/icons/caretDown.svg",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.backArrowGray=env_conf["context-url"]+"/assets/icons/back-arrow-gray.svg",$scope.ellipsisGray=env_conf["context-url"]+"/assets/icons/ellipsisGray.svg",$scope.ellipsisWhite=env_conf["context-url"]+"/assets/icons/ellipsisWhite.svg",$scope.caretRightGray=env_conf["context-url"]+"/assets/icons-new/caret/caret-right-gray.svg",$scope.caretRightGreen=env_conf["context-url"]+"/assets/icons-new/caret/caret-right-green.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.emptyIllustration=env_conf["context-url"]+"/img/empty-illustration.svg",$scope.trashRed=env_conf["context-url"]+"/assets/icons-new/delete-trash/trash-red.svg",$scope.dialogTask=$workflowService.taskEditInfo(),$scope.streamData=$workflowService.selectedStream(),$scope.flowtaskObj=$workflowService.flowtaskInfo()||{},$scope.selectedDialogId=$scope.flowtaskObj._id,$scope.dialogTaskList=$workflowService.dialogTasks()||{},$scope.dialogTasksByState=$workflowService.dialogTasksByState()||{},$scope.stream=$workflowService.selectedStream(),$scope.flowtaskApi={},$scope.savingtask=i18n.i18nString("saving"),$scope.clone=i18n.i18nString("clone"),$scope.offline=i18n.i18nString("offline_mode"),$scope.online=i18n.i18nString("online_mode"),$scope.talk=i18n.i18nString("talk_to"),$scope._constants_=angular.copy($rootScope._constants_),$scope.runBot={show:!0,hideSubBar:!1,fromDialogTask:!0},$scope.flowtaskApi.type=i18n.i18nString("flowtask"),$scope.amendEntityOptions={continueFromAmendedNode:i18n.i18nString("re-execute_dialog"),continueFromCurrentNode:i18n.i18nString("re_execute_currdialog")},window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.dialogUrl=$sce.trustAsResourceUrl("http://localhost:4200/builderx/conversation/dialog/"+$scope.streamData._id+"/"+$scope.dialogTask._id):$scope.dialogUrl=window.appConfig.API_SERVER_URL+"/builderx/conversation/dialog/"+$scope.streamData._id+"/"+$scope.dialogTask._id;var iframe=$("#dialogIFrame");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")})}),$rootScope.$on("uiformIframeEvent",function(e,formEvent){setTimeout(function(){$scope.lodingForm=!1},500)}),$scope.arrowAngle=env_conf["context-url"]+"/assets/icons/arrowAngle.svg",$scope.botIcon=env_conf["context-url"]+"/assets/botIcons/1.svg",$scope.ellipsisDark=env_conf["context-url"]+"/assets/icons/ellipsisDark.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.goBack=function(){closeFullPageModal()},$scope.$emit("nestedComponentLoaded",{id:"conversationDialog",flag:!1}),$scope.changeDialogTask=function(taskId){window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.dialogUrl=$sce.trustAsResourceUrl("http://localhost:4200/builderx/conversation/dialog/"+$scope.streamData._id+"/"+taskId):$scope.dialogUrl=window.appConfig.API_SERVER_URL+"/builderx/conversation/dialog/"+$scope.streamData._id+"/"+taskId},$scope.clearSetUpLocalStorageFortask=function(setTask){var localPath=window.localStorage.getItem("previousState");localPath&&(localPath=JSON.parse(localPath),localPath.selectedTaskType&&!setTask&&delete localPath.selectedTaskType,localPath.selectedTaskId&&!setTask&&delete localPath.selectedTaskId,setTask&&setTask._id&&(localPath.selectedTaskId=setTask._id,"published"==setTask.state?localPath.selectedTaskType="flowtaskView":localPath.selectedTaskType="flowtaskEdit"),window.localStorage.setItem("previousState",JSON.stringify(localPath)))};var closeFullPageModal=function(){$("body").hasClass("bt-modal-open")&&($("body").removeClass("bt-modal-open"),$(".modal-backdrop").remove()),$scope.$emit("updateStep",-1),$("#btFullpageModal").modal("hide"),$rootScope.$emit("insertOrUpdateTask","flowTask",$scope.taskEditInfo,!1),$rootScope.$emit("showContent"),$rootScope.$broadcast("updateEditTask",!1),$(".flowTaskDebugConsolePanel").css("width","")};$scope.switchExit=function(){$scope.closeRunBot(),exit1()},$scope.closeRunBot=function(){$("body").removeClass("displayTalkTo"),$scope.debugInfo=[],$scope.debugRaw={},$scope.debugContext="",$scope.nlTraceData="",_loggerInstance&&_loggerInstance.isRecording?$("#recordInProgressFlow").modal("show"):($element.find(".flowTaskForm").removeClass("isRunBotOpen"),$scope.runBot.show=!0,$scope.isConnecting=!0,$rootScope.$emit("botTestEnd"),$scope.closeDebugConsolePanel(),$scope.showRunBotHeader=!0,$timeout(function(){$element.find(".runBotContainer .botConfigBody").removeClass("slideLeft"),$element.find(".runBotContainer .runBotBody").removeClass("slideLeft")},100))};var closeFullPageModal1=function(){$rootScope.$emit("insertOrUpdateTask","flowTask",$scope.taskEditInfo,!1),$rootScope.$broadcast("updateEditTask",!1)};$scope.closeDebugConsolePanel=function(){$scope.debugContext="",$scope.isDebugConsolePanelOpened=!1,$element.find(".flowTaskDebugConsolePanel").css("width",""),$element.find(".flowTaskDebugConsolePanel.ui-draggable").css("cssText","width : 0px !important;")},$scope.maximizeRunBot=function(){$element.find(".flowTaskForm").addClass("isRunBotOpen"),$scope.runBot.show=!1,$scope.isChatWindowMinimized=!1;$timeout(function(){$(".flowTaskBlock .flowTaskDebugConsolePanel").hasClass("minimized")&&$(".flowTaskDebugConsolePanel .minMax").trigger("click")},100),$timeout(function(){var _ele=$element.find(".flowTaskPropertyPanel"),_panelLeft=_ele.offset().left;if($scope.isPropertyPanelOpened&&0>_panelLeft){var _parentEle=$element.find(".flowTaskConnectionBlock"),_right=parseInt(_parentEle.width())-10-parseInt(_ele.width());_ele.css("right",_right+"px"),_ele.css("left","auto")}},500)},$scope.minimizeRunBot=function(){$("body").removeClass("displayTalkTo"),$element.find(".flowTaskForm").removeClass("isRunBotOpen"),$timeout(function(){$(".flowTaskBlock .flowTaskDebugConsolePanel").hasClass("maximized")&&$(".flowTaskDebugConsolePanel .minMax").trigger("click")},100),$scope.showRunBotHeader=!0,$scope.isChatWindowMinimized=!0,$timeout(function(){$element.find(".runBotContainer .botConfigBody").removeClass("slideLeft"),$element.find(".runBotContainer .runBotBody").removeClass("slideLeft"),$scope.runBot.show=!0},100)},$scope.changeDialogTask=function(task){if(_loggerInstance&&_loggerInstance.isRecording)return $("#recordInProgressFlow").modal("show"),void($scope.taskDialog=task);var entity=_.find($scope.dialogTasksByState,{_id:task});$scope.switchExit(),$timeout(function(){$scope.$emit("switchDialogTaskEdit",entity,{success:function(){$workflowService.flowtaskInfo(entity),$scope.clearSetUpLocalStorageFortask(entity),$scope.$emit("switchDialogTask",entity.state)},failure:function(){console.log("Task locked")}})},1500)},$scope.exit=function(){$rootScope.$emit("updateSummaryData"),$scope.clearSetUpLocalStorageFortask(),defaultValue.setDefaultOptionalValue(),defaultValue.setDefaultHiddenValue(),$workflowService.dialogNodesNames([]),$scope.callBack&&$scope.callBack.closeFlowTaskEvent&&$scope.callBack.closeFlowTaskEvent(),closeFullPageModal()}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("conversationUpgrade",function(){return{restrict:"EA",scope:{migrationJourney:"=",callBack:"=",flowtaskObj:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/conversation-upgrade/conversation-upgrade.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","form_util","i18n","mixPanel","$util",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,form_util,i18n,mixPanel,$util){$scope.migrationJourney=$scope.migrationJourney||{showUpgrade:!1},$scope.upgradeFlowBig=env_conf["context-url"]+"/img/upgrade-dialog-big.png";var flowtask=$scope.flowtaskObj||$scope.selectedDialogForUpgrade,_selectedStream=$workflowService.selectedStream();$scope.dialogTaskList=$workflowService.dialogTasks()||{},$scope.dialogTasksByState=$workflowService.dialogTasksByState()||{},$scope.processUpgrade=function(type){if("backup"===type){var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:flowtask.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"User has requested to take Bot Export during dialog upgrade from V1 to V2 is initiated"};mixPanel.postEvent("Upgrade to Dialog Builder V2 - Backup Initiated",dialogData),$scope.migrationJourney.step="createBotversion"}if("close"===type&&$scope.closeupgadeToNewDialog(),"createVersion"===type){if(!$scope.migrationJourney.versionName)return void NotificationService.notify("Please provide bot version name","error");$scope.migrationJourney.step="versionInProgress",$scope.createVersion()}"upgrade"===type&&($scope.startUpgrading(),$scope.migrationJourney.step="upgradeInProgress")},$scope.startUpgrading=function(){BTFlowtaskService.migrateFlowtask(_selectedStream._id,flowtask._id).then(function(res){$scope.migrationJourney.step="upgradeSuccess";var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:flowtask.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"Dialog is successfully upgraded from V1 to V2 is initiated"};mixPanel.postEvent("Upgrade to Dialog Builder V2 - Completed",dialogData),$scope.migrationJourney.newDialog=res.data,$scope.migrationJourney.modalOpen||$scope.closeupgadeToNewDialog()},function(error){error&&error.data&&error.data.errors&&error.data.errors.length&&NotificationService.notify(error.data.errors[0].msg,"error"),$scope.migrationJourney.step=null;var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:flowtask.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"Error in upgrading Dialog from V1 to V2"};mixPanel.postEvent("Upgrade to Dialog Builder V2 - Failed",dialogData),_botComponents="error"})},$scope.createVersion=function(version){$scope.versionStatus="inprogress";var _payload={name:$scope.migrationJourney.versionName,description:""};BTStreamsService.createVersion(_selectedStream._id,_payload).then(function(response){$scope.verionStatus(response.data,!0)},function(err){$scope.migrationJourney.step="versionFailure",err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Creation of new Bot Version "+$scope.migrationJourney.versionName+" has failed.","error")})},$scope.verionStatus=function(data,initialCall){data&&("success"===data.status.toLowerCase()?"versionSuccess"!==$scope.migrationJourney.step&&($scope.migrationJourney.step="versionSuccess"):initialCall&&"in_progress"===data.status.toLowerCase()?(NotificationService.notify("Creation of new Bot Version "+$scope.migrationJourney.versionName+" is in progress.","success"),$rootScope.$broadcast("getProgressDockStatus"),$scope.migrationJourney.step="versionInProgress"):"failure"===data.status.toLowerCase()&&($scope.migrationJourney.step="versionFailure",NotificationService.notify("Creation of new Bot Version "+$scope.migrationJourney.versionName+" has failed.","error")))},$scope.callBack.verionStatus=$scope.verionStatus,$scope.closeUpgradePop=function(){},$scope.getStarted=function(){$workflowService.newDialogUpgrade($scope.migrationJourney.newDialog._id),$scope.closeupgadeToNewDialog()},$scope.changeDialogTask=function(task,update){var entity=update||_.find($scope.dialogTasksByState,{_id:task});return entity.sceneRefId&&$util.isIE11OrEarlier()?($util.showUnSupportedBrowserWarningForDialog(),!1):void $timeout(function(){$scope.$emit("switchDialogTaskEdit",entity,{success:function(){$workflowService.flowtaskInfo(entity),$scope.clearSetUpLocalStorageFortask(entity),$scope.$emit("switchDialogTask",entity.state)},failure:function(){console.log("Task locked")}})},1500)},$scope.clearSetUpLocalStorageFortask=function(setTask){var localPath=window.localStorage.getItem("previousState");localPath&&(localPath=JSON.parse(localPath),localPath.selectedTaskType&&!setTask&&delete localPath.selectedTaskType,localPath.selectedTaskId&&!setTask&&delete localPath.selectedTaskId,setTask&&setTask._id&&(localPath.selectedTaskId=setTask._id,"published"==setTask.state?localPath.selectedTaskType="flowtaskView":localPath.selectedTaskType="flowtaskEdit"),window.localStorage.setItem("previousState",JSON.stringify(localPath)))},$scope.upgadeToNewDialog=function(){$scope.closeUpgradePop(),$scope.migrationJourney.modalOpen=!0,$("#upgradeDialogToConversation").modal("show");var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:flowtask.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"Dialog upgrade from V1 to V2 is initiated"};mixPanel.postEvent("Upgrade to Dialog Builder V2 - Initiated",dialogData)},$scope.callBack.upgadeToNewDialog=$scope.upgadeToNewDialog,$scope.closeupgadeToNewDialog=function(){$scope.closeUpgradePop(),$scope.migrationJourney.step=null,$scope.migrationJourney.modalOpen=!1;({streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:flowtask.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"Dialog upgrade from V1 to V2 is canceled"});$("#upgradeDialogToConversation").modal("hide"),setTimeout(function(){$scope.callBack.conversationUpgrade&&$scope.callBack.conversationUpgrade(null,$scope.migrationJourney.newDialog)},200)}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btCustomLibrary",[function(){return{scope:{callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/custom-library/bt-custom-library.html",controller:["$scope","$timeout","BTStreamsService","$workflowService","NotificationService","env_conf","$applicationService","i18n",function($scope,$timeout,BTStreamsService,$workflowService,NotificationService,env_conf,$applicationService,i18n){function importModalSliderOpen(){$timeout(function(){$scope.modalSlider.open("#customTemplateSlider")},500)}function importModalSliderclose(){$timeout(function(){$scope.modalSlider.close("#customTemplateSlider")},500)}function customLibraryTemplates(){$scope.customTemplates=[],BTStreamsService.getAllCustomTemplate($workflowService.selectedStream()._id).then(function(res){for(var i=0;i<res.data.length;i++)res.data[i].name=res.data[i].name.replace(/&lt;/g,"<").replace(/&gt;/g,">"),res.data[i].description=res.data[i].description.replace(/&lt;/g,"<").replace(/&gt;/g,">");$scope.getCustomTemplates=$scope.customTemplates.concat(res.data)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){
var msg=error.errors[0].msg;NotificationService.notify.notify(msg,"error")}else NotificationService.notify.notify(i18n.i18nString("error_handle"),"error")})}function getBotFunctions(){BTStreamsService.getBotFunctions($workflowService.selectedStream()._id).then(function(res){$scope.botFunctions.botFuctionFile=res.data[0]},function(errRes){console.log("Failed getting bot functions")})}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function encodeJS(_obj){try{return encodeURIComponent(_obj)}catch(e){return _obj}}$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.rightClass="right700",$scope.modalSlider={},$scope.currentTab="customTemplate",$scope.customTemplate={},$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.updating=i18n.i18nString("updating_label_1"),$scope.update=i18n.i18nString("update"),$scope["new"]=i18n.i18nString("new"),$scope.edit=i18n.i18nString("edit"),$scope.createMode=!0,$scope.contextCondition=[{key:"",value:""}],$scope.botFunctions={},$scope.deleteBotFunctions=function(e){var _parms={fileName:$scope.botFunctions.botFuctionFile.fileName,fileId:$scope.botFunctions.botFuctionFile.fileId};BTStreamsService.deleteBotFunctions($workflowService.selectedStream()._id,_parms).then(function(res){$scope.botFunctions.botFuctionFile="",NotificationService.notify(i18n.i18nString("bot_function_removed_sucess"),"success")},function(errRes){console.log("Failed deleting bot functions")})},$scope.botFunctionSave=function(){if($scope.botFunctions.botFuctionFile){var _parms={fileName:$scope.botFunctions.botFuctionFile.fileName,fileId:$scope.botFunctions.botFuctionFile.fileId};BTStreamsService.addBotFunctions($workflowService.selectedStream()._id,_parms).then(function(res){NotificationService.notify(i18n.i18nString("saved_successfully"),"success")},function(errRes){NotificationService.notify(i18n.i18nString("failed_saving_err_noty"),"error")})}else NotificationService.notify(i18n.i18nString("please_choose_a_file_err"),"warning")},$scope.uploadFile=function(e){if($scope.botFunctions.botFuctionFile){var _ext="";if($scope.botFunctions.botFuctionFile.name){_ext=$scope.botFunctions.botFuctionFile.name.substring($scope.botFunctions.botFuctionFile.name.lastIndexOf("."));var supportingFileFormats=[".js"];if(-1===$.inArray(_ext,supportingFileFormats))return void NotificationService.notify(i18n.i18nString("upload_only_js_files"),"error")}var _fileLimit=5e5;if(e.target.files[0].size>_fileLimit)return void NotificationService.notify(i18n.i18nString("file_size_shouldnot_exced_err_noty"),"warning");var data=new FormData;data.append("file",$scope.botFunctions.botFuctionFile),data.append("fileContext","bulkImport"),data.append("fileExtension","txt"),$scope.fileuploading=!0,BTStreamsService.uploadBotFunctionsFile($applicationService.userInfo().userId,data).then(function(response){var fileUploaded={fileName:"botFuction",fileId:response.data.fileId};$scope.botFunctions.botFuctionFile=fileUploaded,$scope.fileuploading=!1},function(err){NotificationService.notify(i18n.i18nString("oops_label")+err.data.errors[0].msg,"error"),$scope.fileuploading=!1})}},$timeout(function(){$(".customLibraryTemplateMainLi a").trigger("click")},200),$scope.updateCurrentTab=function(type){$scope.currentTab=type,customLibraryTemplates()},$scope.noCustomTemplate=function(){return $(".getCustomTemplate")&&$(".getCustomTemplate").children().length},$scope.updateCurrentTemplateTab=function(type){$scope.activeCustomTemplateType=type},$scope.newCustomTemplate=function(){if($scope.createMode=!0,$scope.customTemplate.templateName="",$scope.customTemplate.descriptionName="",$scope.customTemplate.customTemplateEditor="",$scope.contextCondition&&$scope.contextCondition.length)for(var i=0;i<$scope.contextCondition.length;i++)$scope.contextCondition[i].key="",$scope.contextCondition[i].value="";$timeout(function(){$(".customLibraryTemplateLi a").trigger("click")},500),importModalSliderOpen()},$scope.closeCustomTemplate=function(){if($scope.contextCondition&&$scope.contextCondition.length)for(var i=0;i<$scope.contextCondition.length;i++)$scope.contextCondition[i].key="",$scope.contextCondition[i].value="";importModalSliderclose()},$scope.addContextCond=function(index){$scope.contextCondition.length>0&&index===$scope.contextCondition.length-1&&$scope.contextCondition.push({key:"",value:""})},$scope.onRemoveCond=function(index){$scope.contextCondition.length>1&&$scope.contextCondition[index]&&$scope.contextCondition.splice(index,1)},$scope.getPreviewData=function(customTemplate){var _context={},_isValidContext=!0;if($scope.contextCondition.length>0&&$.each($scope.contextCondition,function(k,context){var _contextKey=context.key?context.key.trim():"";if(""!==_contextKey){if(0!==_contextKey.toLowerCase().indexOf("context."))return _isValidContext=!1,!1;var _tempObj={};_contextKey=_contextKey.substr(8),_contextKey.split(".").reverse().forEach(function(_parsedKey){var _t={};_t[_parsedKey]=Object.keys(_tempObj).length?_tempObj:context.value.trim(),_tempObj=_t}),angular.merge(_context,_tempObj)}}),!_isValidContext)return void NotificationService.notify.notify(i18n.i18nString("bot_welcomeMessage_keys_should_be_prefixed_notify"),"warning");$scope.previewIsOn=!0;var payload={template:$scope.customTemplate.customTemplateEditor,type:"uxmap",context:JSON.stringify(_context)};$scope.isError=!1,$scope.preview="",$scope.customTemplate._id=customTemplate,BTStreamsService.customTemplatePreview($workflowService.selectedStream()._id,customTemplate,payload).then(function(res){var _ele=document.createElement("div");_ele.innerHTML=res.data&&(res.data.resolvedPayload||res.data.resolvedData);var lnkEle=$(_ele).find("a");lnkEle.length>0&&$.each(lnkEle,function(k,ele){$(ele).attr("target","_blank")}),$scope.preview=_ele.innerHTML,$scope.previewIsOn=!1},function(err){var error=err.data&&err.data.errors&&err.data.errors[0].msg||err.data;try{error=JSON.parse(error),error.errors&&error.errors[0].msg&&($scope.preview=error.errors[0].msg)}catch(e){$scope.preview=error}$scope.previewIsOn=!1,$scope.isError=!0})},$scope.customTemplateSave=function(){$scope.saveInprogress=!0,$scope.createCustomTemplate={name:$scope.customTemplate.templateName,type:"uxmap",description:$scope.customTemplate.descriptionName,template:encodeJS($scope.customTemplate.customTemplateEditor)},BTStreamsService.createCustomTemplate($workflowService.selectedStream()._id,$scope.createCustomTemplate).then(function(res){res&&res.data&&NotificationService.notify.notify(i18n.i18nString("custom_template_created"),"success"),res&&res.data.name&&res.data.name.length&&(res.data.name=res.data.name.replace(/&lt;/g,"<").replace(/&gt;/g,">"),res.data.description=res.data.description.replace(/&lt;/g,"<").replace(/&gt;/g,">")),$scope.getCustomTemplates.push(res.data),$workflowService.customLibraries($scope.getCustomTemplates),$scope.customTemplateID=res.data._id,$scope.saveInprogress=!1,importModalSliderclose()},function(error){if($scope.saveInprogress=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify.notify(msg,"error")}else NotificationService.notify.notify(i18n.i18nString("error_handle"),"error")}),$timeout(function(){$(".customLibraryTemplateLi a").trigger("click")},500)},$scope.deleteCustomTemplate=function(index,template){NotificationService.notify.alert(i18n.i18nString("delete_custom_temp"),function(){BTStreamsService.deleteCustomTemplate($workflowService.selectedStream()._id,template._id).then(function(res){res&&res.data?($scope.getCustomTemplates.splice(index,1),NotificationService.notify.notify(i18n.i18nString("custom_template_deleted"),"success",1500),$workflowService.customLibraries($scope.getCustomTemplates)):alert(i18n.i18nString("error_alert"))},function(errRes){alert(i18n.i18nString("error_alert"))})},{okText:i18n.i18nString("ok_label")})},$scope.editCustomTemplate=function(template){$timeout(function(){$(".customLibraryTemplateLi a").trigger("click")},500),$scope.createMode=!1,importModalSliderOpen(),$scope.customTemplate._id=template._id,BTStreamsService.getCustomTemplateData($workflowService.selectedStream()._id,template._id).then(function(res){$scope.customTemplate.templateName=res.data.name.replace(/&lt;/g,"<").replace(/&gt;/g,">"),$scope.customTemplate.descriptionName=res.data.description.replace(/&lt;/g,"<").replace(/&gt;/g,">"),$scope.customTemplate.customTemplateEditor=decodeJS(res.data.template)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify.notify(msg,"error")}else NotificationService.notify.notify(i18n.i18nString("error_handle"),"error")})},$scope.updateCustomTemplate=function(templateId){$scope.updateInprogress=!0,importModalSliderOpen(),$scope.createCustomTemplate={name:$scope.customTemplate.templateName,type:"uxmap",description:$scope.customTemplate.descriptionName,template:encodeJS($scope.customTemplate.customTemplateEditor)},BTStreamsService.updateCustomTemplate($workflowService.selectedStream()._id,templateId,$scope.createCustomTemplate).then(function(res){res&&res.data&&NotificationService.notify.notify(i18n.i18nString("custom_template_updated"),"success"),templateId&&$.each($scope.getCustomTemplates,function(i,temp){temp._id==templateId&&($scope.getCustomTemplates[i]=res.data)}),$scope.updateInprogress=!1,importModalSliderclose()},function(error){if($scope.updateInprogress=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify.notify(msg,"error")}else NotificationService.notify.notify(i18n.i18nString("error_handle"),"error")})},getBotFunctions(),$scope.$emit("nestedComponentLoaded",{id:"customLibrary",flag:!1})}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("debugConsolePanel",function(){return{restrict:"EAQ",scope:{debugInfo:"=",debugRaw:"=",debugContext:"=",isResized:"=",fromDialog:"@?",closeDebugger:"&",nlTrace:"=?",nlTraceData:"=?",callBack:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/debug-console/debug-console-panel.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","i18n",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,i18n){function updateFilterUI(){$element.find('.debug-log-level-filter [name="debugLogFilter"]').each(function(){$scope.debugLevelFilterArr.indexOf($(this).val().toLowerCase())>-1?$(this).prop("checked",!0):$(this).prop("checked",!1)})}function intialize(){$scope.debugLevelFilterArr=["warning","info","error"],$timeout(function(){updateFilterUI();var _ele=$element.closest(".flowTaskDebugConsolePanel");if(_ele.hasClass("minimized")){_ele.toggleClass("minimized maximized");var _iconEle=_ele.find(".toggleMinMax");_iconEle.hasClass("fa-window-maximize")&&_iconEle.toggleClass("fa-window-minimize fa-window-maximize")}$scope.isMinimized=!1,$scope.consoleMaximized=!0},300)}$scope.stream=$workflowService.selectedStream(),$scope._constants_=$rootScope._constants_,$scope.assetsBase=env_conf["assets-url"],"DarkTheme"==$workflowService.debugConsoleThemeInfo()?$scope.isBirightModeActive=!1:$scope.isBirightModeActive=!0;$workflowService.selectedStream();$scope.isOpen=!1,$scope.isAccordionOpen=!1,$scope.hasDebugObj=!1,$scope.hasNLAnalysisObj=!1,$scope.options={mode:"code",ace:window.ace,theme:"ace/theme/clouds_midnight",aceViewMode:!0},intialize(),$scope.toggleDebugLevelFilter=function(e){$scope.debugLevelFilterArr=$element.find('.debug-log-level-filter [name="debugLogFilter"]:checked').map(function(_,el){return $(el).val().toLowerCase()}).get()},$scope.bightMode=function(){$scope.isBirightModeActive=$scope.isBirightModeActive?!1:!0,$workflowService.debugConsoleThemeInfo($scope.isBirightModeActive?"LightTheme":"DarkTheme")},$scope.openSessionAccordion=function(){$scope.isAccordionOpen=!$scope.isAccordionOpen},$scope.somethingClicked=function(e){e.preventDefault(),e.stopPropagation()},$scope.debugLevelFilter=function(debug){return debug.debugLevel=debug.debugLevel||"Info",$scope.debugLevelFilterArr.indexOf(debug.debugLevel.toLowerCase())>=0?!0:!1},$scope.toggleSize=function(e){e.preventDefault(),e.stopPropagation();var _ele=$(e.target).closest(".flowTaskDebugConsolePanel"),_calculatedWidth=800;$(e.target).hasClass("expand")?(window.innerWidth-550<800?(_calculatedWidth=window.innerWidth-550,$(_ele).css("width",_calculatedWidth+"px")):$(_ele).css("width","800px"),$scope.isMinimized=!1):(window.innerWidth-550<574?(_calculatedWidth=window.innerWidth-550,$(_ele).css("width",_calculatedWidth+"px")):$(_ele).css("width","574px"),$scope.isMinimized=!0),$(e.target).toggleClass("fa-expand fa-compress")},$scope.toggleMinMax=function(e){e.preventDefault(),e.stopPropagation();var _ele=$(e.target).closest(".flowTaskDebugConsolePanel");_ele.toggleClass("minimized maximized"),$(e.target).toggleClass("fa-window-minimize fa-window-maximize"),_ele.hasClass("minimized")?($(".conversationBuilder").removeClass("maximized"),$scope.consoleMaximized=!1,$scope.callBack&&$scope.callBack.adjustpannelsInIframe&&$scope.callBack.adjustpannelsInIframe("debugLog","minimize")):($(".conversationBuilder").addClass("maximized"),$scope.callBack&&$scope.callBack.adjustpannelsInIframe&&$scope.callBack.adjustpannelsInIframe("debugLog","maximize"),$scope.consoleMaximized=!0)},$element.on("focus",".jsoneditor textarea",function(e){$(e.target).attr("readonly",!0),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();var ctrlDown=!1,ctrlKey=17,cmdKey=91,vKey=86,bSpace=8;$(e.target).keydown(function(e){(e.keyCode==ctrlKey||e.keyCode==cmdKey)&&(ctrlDown=!0)}).keyup(function(e){(e.keyCode==ctrlKey||e.keyCode==cmdKey)&&(ctrlDown=!1)}),$(e.target).keydown(function(e){return e.keyCode===bSpace||ctrlDown&&e.keyCode==vKey?(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1):void 0})}),$element.on("click",".debugData",function(e){if("a"!==e.target.nodeName.toLowerCase()){e.preventDefault(),e.stopPropagation();var _ele=$(e.target).find(".accordion-toggle");$(_ele).trigger("click")}}),$scope.prepareCopyClipboard=function(e,type,jsonData){e.preventDefault(),e.stopPropagation(),$scope.success=!0;var selection,range=document.createRange(),input=JSON.stringify($scope.debugRaw);"NLanalysis"===type&&(input=JSON.stringify($scope.nlTraceData)),"sessionContextObj"===type&&(input=JSON.stringify(jsonData)),window.clipboardData?$scope.success=window.clipboardData.setData("Text",input):($scope.tmpElem=$("<div>"),$scope.tmpElem.css({position:"absolute",left:"-1000px",top:"-1000px"}),$scope.tmpElem.text(input),$("body").append($scope.tmpElem),range.selectNodeContents($scope.tmpElem.get(0)),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range))},$scope.copyDebugToClipboard=function(e,type,jsonData,msg){function copyToClipboardFF(text){window.prompt(i18n.i18nString("copy_clipboard"),text)}if(msg=msg||i18n.i18nString("json_copied_success"),e.preventDefault(),e.stopPropagation(),!window.clipboardData)try{$scope.success=document.execCommand("copy",!1,null)}catch(e){var input=JSON.stringify($scope.debugRaw);"NLanalysis"===type&&(input=JSON.stringify($scope.nlTraceData)),"sessionContextObj"===type&&(input=JSON.stringify(jsonData)),copyToClipboardFF(input)}finally{$scope.tmpElem.remove()}$scope.success&&NotificationService.notify(msg,"success")},$scope.$watch("debugRaw",function(newVal,oldVal){_.isEmpty(newVal)?$scope.hasDebugObj=!1:$scope.hasDebugObj=!0}),$scope.$watch("nlTraceData",function(newVal,oldVal){_.isEmpty(newVal)?$scope.hasNLAnalysisObj=!1:$scope.hasNLAnalysisObj=!0}),$scope.$watch("isAccordionOpen",function(newVal,oldVal){var _consoleHeight;oldVal===!0&&newVal===!1?(_consoleHeight=parseInt($element.parent().height())-60,$element.find(".debug-console-body .log-console-body").css("height",_consoleHeight+"px")):oldVal===!1&&newVal===!0&&(_consoleHeight=parseInt($element.parent().height())-60-250,$element.find(".debug-console-body .panel .panel-body").css("height",_consoleHeight+"px"))}),$scope.$watch("isResized",function(newVal,oldVal){var _conHeight;newVal!==oldVal&&(_conHeight=parseInt($element.parent().height())-60,$scope.isAccordionOpen?(_conHeight-=250,$element.find(".debug-console-body .panel .panel-body").css("height",_conHeight+"px")):$element.find(".debug-console-body .log-console-body").css("height",_conHeight+"px"))}),$scope.options.copyDebugToClipboard=$scope.copyDebugToClipboard,$scope.options.prepareCopyClipboard=$scope.prepareCopyClipboard}]}})}(angular),function(ng){var _module=angular.module("bt-forms");_module.directive("defaultDialogSettings",function(){return{restrict:"EA",scope:{helpLinkUrl:"@",isFooterLink:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/default-dialog/default-dialog.html",controller:"DefaultDialogCntr"}}),_module.filter("agentDialogsFilter",function(){return function(dialogs){var _filteredDialogs=_.filter(dialogs,function(dialog){return!0});return _filteredDialogs}}),_module.controller("DefaultDialogCntr",["$scope","$timeout","$rootScope","BTFlowtaskService","$workflowService","BTStreamsService","NotificationService","form_util","accessControlService","i18n",function($scope,$timeout,$rootScope,BTFlowtaskService,$workflowService,BTStreamsService,NotificationService,form_util,accessControlService,i18n){function loadDialogs(){BTFlowtaskService.getFlowtaks($workflowService.selectedStream()._id).then(function(res){$scope.dialogs=_.uniq(res.data,"refId"),$scope.dialogs.map(function(dialog){return"published"===dialog.state?dialog.devState="":dialog.devState=" @development",dialog});var _dialogFound=_.find($scope.dialogs,{refId:$scope.stream.defaultDialogId});_dialogFound?$scope.selectedDialog.refId=_dialogFound.refId:$scope.selectedDialog.refId=""},function(err){$scope.dialogs=[]})}function saveSettings(_payload){$scope.saveInProgress=!0,BTStreamsService.editDefaultDialog($workflowService.selectedStream()._id,_payload).then(function(res){$scope.saveInProgress=!1,res.data&&($scope.stream=res.data,$workflowService.selectedStream(res.data),NotificationService.notify(i18n.i18nString("settings_updated"),"success",2e3))},function(error){if($scope.saveInProgress=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}$scope.init=function(){$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.saveInProgress=!1,loadDialogs(),$scope.stream=$workflowService.selectedStream(),$scope.settings={},$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.settings.defaultDialog=$scope.stream.defaultDialogId?!0:!1},$scope.selectedDialog={},$scope.saveDefaultDialog=function(defaultDialog){if((!defaultDialog||!defaultDialog.refId)&&$scope.settings.defaultDialog)return void NotificationService.notify(i18n.i18nString("please_select"),"error");var _payload={};$scope.settings.defaultDialog?_payload.defaultDialogId=defaultDialog.refId:_payload.defaultDialogId=null,saveSettings(_payload)},$scope.init(),$scope.$emit("nestedComponentLoaded",{id:"defaultDialog",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btDialogSettings",function(){return{restrict:"EAQ",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/dialog-settings/dialog-settings.html",controller:["$scope","$element","$timeout","$rootScope","$routeParams","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","env_conf","form_util","i18n",function($scope,$element,$timeout,$rootScope,$routeParams,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,env_conf,form_util,i18n){function importModalSliderOpen(){$timeout(function(){$scope.modalSlider.open("#addRespTaskFailExecution")})}function saveDialogSettings(settings){if($scope.isTaskExecutionFail){var isSaveDisabled=!1;if("initiate_task"===$scope.eventConfig.proceed?isSaveDisabled=void 0===$scope.selected.dialog||""===$scope.selected.dialog:"run_script"===$scope.eventConfig.proceed?isSaveDisabled=""===$scope.inp.scriptText:"show_mess"===$scope.eventConfig.proceed&&(isSaveDisabled=$scope.responseObj.length<1),"show_mess"===$scope.eventConfig.proceed&&$scope.responseObj&&0===$scope.responseObj.filter(function(v){return"default"===v.channel}).length)return void NotificationService.notify(i18n.i18nString("channel_mandatory"),"error");if(isSaveDisabled)return void NotificationService.notify(i18n.i18nString("define_bot_behaviour"),"error")}var _params={};_params.streamId=$workflowService.selectedStream()._id;var intentName=$scope.settings.name;$scope.settings.name&&(intentName=$scope.settings.name.trim().replace(/\s\s+/g," ")),$scope.settings.name=intentName,_params.name=intentName,_params.shortDesc=settings.shortDesc,_params.visibility=$scope.configData.dialogObj.visibility,_params.contextLifeTime={options:{"enum":""}},_params.followupTaskOptions=$scope.followupTaskOptions||{isFollowUp:!1,message:$scope._constants_.pauseResumeMessages.folloowUpTaskProvided.key},"retainWithTimeLimit"!==$scope.settings.contextLifeTime.options?_params.contextLifeTime.options=$scope.settings.contextLifeTime.options:(_params.contextLifeTime.options=$scope.settings.contextLifeTime.options,_params.contextLifeTime.minutes=parseInt($scope.settings.contextLifeTime.minutes)),$scope.intentNodeType.isFollowUp?(_params.isFollowUp=!0,_params.isHidden=!1):$scope.intentNodeType.isHidden?(_params.isHidden=!0,_params.isFollowUp=!1):(_params.isHidden=!1,_params.isFollowUp=!1),$scope.interruptOptions.holdUxOptions=$scope.interruptOptions.holdUxOptions||{option:"holdCurrTask",message:""},$scope.interruptOptions.type=$scope.interruptOptions.type||{option:"developer",message:""},$scope.interruptOptions.resumeUxOptions=$scope.interruptOptions.resumeUxOptions||{option:"notifyUser",message:"",neverNotify:!1};var interruptOptions={};"task"===$scope.interruptOptions.priority?(interruptOptions.interruptsEnabled=$scope.interruptOptions.interruptsEnabled,interruptOptions.priority="task",interruptOptions.holdUxOptions=$scope.interruptOptions.holdUxOptions,interruptOptions.type=$scope.interruptOptions.type,interruptOptions.resumeUxOptions=$scope.interruptOptions.resumeUxOptions,interruptOptions.holdUxOptions&&"discardCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.discardCurrentTask.key:"continueCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.continueCurrentTask.key:interruptOptions.holdUxOptions.message=""):(interruptOptions={priority:"bot"},_params.followupTaskOptions={isFollowUp:$scope.followupTaskOptions.isFollowUp,message:$scope.followupTaskOptions.isFollowUp?$scope._constants_.pauseResumeMessages.folloowUpTaskProvided.key:""}),interruptOptions.holdUxOptions&&"holdCurrTask"===interruptOptions.holdUxOptions.option&&("confFromUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.getConfirmatonWithUser.key:"notifyUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.notifyUserWithMessage.key:interruptOptions.resumeUxOptions.message="");var payloadBotEvents={onTaskFailure:{}};if($scope.isTaskExecutionFail)if(payloadBotEvents.onTaskFailure.enabled=!0,"initiate_task"===$scope.eventConfig.proceed){payloadBotEvents.onTaskFailure.action="triggerDialog",payloadBotEvents.onTaskFailure.script=".",payloadBotEvents.onTaskFailure.msg=[],payloadBotEvents.onTaskFailure.ivrOptions=[],$scope.welcomeIVRTemp={};for(var dialogId="",i=0;i<$scope.dialogsName.length;i++)if($scope.dialogsName[i].name===$scope.selected.dialog){dialogId=$scope.dialogsName[i].id;break}payloadBotEvents.onTaskFailure.task=dialogId}else"run_script"===$scope.eventConfig.proceed?(payloadBotEvents.onTaskFailure.action="runScript",payloadBotEvents.onTaskFailure.script=$scope.inp.scriptText,payloadBotEvents.onTaskFailure.welcomeMsg=[],payloadBotEvents.onTaskFailure.ivrOptions=[],$scope.welcomeIVRTemp={},payloadBotEvents.onTaskFailure.task=""):"show_mess"===$scope.eventConfig.proceed&&(payloadBotEvents.onTaskFailure.action="showMsg",payloadBotEvents.onTaskFailure.script=".",payloadBotEvents.onTaskFailure.msg=$scope.responseObj,$scope.stream.ivrSettings&&$scope.stream.ivrSettings.enable&&$scope.ivrBridge.getIVROptions&&$scope.ivrBridge.getIVROptions()&&$scope.isIVREntered?payloadBotEvents.onTaskFailure.ivrOptions=$scope.ivrBridge.getIVROptions():$scope.welcomeIVRTemp&&$scope.welcomeIVRTemp.ivrOptions?payloadBotEvents.onTaskFailure.ivrOptions=$scope.welcomeIVRTemp.ivrOptions:payloadBotEvents.onTaskFailure.ivrOptions=[]);else payloadBotEvents.onTaskFailure.enabled=!1;_params.onTaskFailure=payloadBotEvents.onTaskFailure,_params.interruptOptions=interruptOptions,BTFlowtaskService.updateFlowtask($workflowService.selectedStream()._id,$scope.configData.dialogObj._id,_params).then(function(res){$scope.configData.dialogObj=res&&res.data,res&&res.data&&(NotificationService.notify(i18n.i18nString("settings_updated"),"success",2e3),$scope.configData.cb.updateFlowData($scope.configData.dialogObj),$scope.closeModalDialogSettings(),$scope.configData.load())},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}$scope.configData=$scope.cb,$scope.stream=$workflowService.selectedStream(),$scope._constants_=$rootScope._constants_,$scope.manageResponseCB={},$scope.showStandardResponses=!1,$scope.timeIntervels=["5","10","15","20","25","30"],$scope.contextLifeTimeOption={options:"close",minutes:"5"},$scope.edit=i18n.i18nString("edit"),$scope.add=i18n.i18nString("add"),$scope.js_msg=i18n.i18nString("js_msg"),$scope.isTaskExecutionFail=!1,$scope.intentNodeType={},$scope.intentNodeType.isHidden=!1,$scope.intentNodeType.isFollowUp=!1,$scope.taskFailExecutionCB={},$scope.taskFailExecutionCB.isAddResponseEnabled=!1,$scope.taskFailExecutionCB.isFrom="dialogs",$scope.taskFailExecutionCB.isAPICall=!1,$scope.assetsBase=env_conf["assets-url"];var _selectedLanguage=$workflowService.currentLanguage();$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.eventConfig={proceed:"initiate_task"},$scope.isAddRespEdited=!1,$scope.responseObj=[],$scope.dialogsName=[],$scope.vprop={name:"",value:""},$scope.inp={scriptText:""},$scope.isIvrEnabled=!1,$scope.selected={dialog:""},$scope.welcomeIVRTemp={},$scope.ivrBridge={},$scope.editIVR=!1,$scope.openedKey="";var vxmlflag=!1,propertiesList=[],isVxml=!1,ind=0;$workflowService.dialogTasks().forEach(function(val){val.isFollowUp||($scope.dialogsName[ind]={},$scope.dialogsName[ind].name=val.name,$scope.dialogsName[ind].id=val.refId,ind++)}),$scope.rightClass="right500",$scope.modalSlider={},"universalbot"===$scope.stream.type&&($scope.eventConfig.proceed="run_script"),$scope.scrollBottomDialog=function(){$timeout(function(){$(".dialogSettingsInnerBody").scrollTop($(".dialogSettingsInnerBody").height())},200)},$scope.taskFailExecutionCB.scrollDownDialog=function(){$scope.scrollBottomDialog()},$scope.isTaskFailEnabled=function(){return $workflowService.selectedStream().botEvents&&$workflowService.selectedStream().botEvents.TASK_FAILURE_EVENT&&$workflowService.selectedStream().botEvents.TASK_FAILURE_EVENT.enabled||!1},$scope.saveIVRSettings=function(vprop,label){if($scope.stream=$workflowService.selectedStream(),"vxmlAdded"!==label&&"deleted"!==label&&"saved"!==label){var payload={ivrOptions:$scope.ivrBridge.getIVROptions()};$scope.welcomeIVRTemp=angular.copy(payload),$scope.closeIVRSettings("notVxml")}if($timeout(function(){$scope.eventConfig.proceed="show_mess"},100),0!==$scope.responseObj.length&&($scope.isSaveDisabled=!1),$scope.isIVREntered=!0,vprop&&vprop.name)if($scope.ivrBridge.getIVROptions().advance.properties.length){var vpropName=$scope.ivrBridge.getIVROptions().advance.properties.map(function(v){return v.name});vpropName.push(vprop.name),$scope.cb.updateVxmlGlobalKeysShare(vpropName)}else $scope.cb.updateVxmlGlobalKeysShare(vprop.name);NotificationService.notify(i18n.i18nString("ivr_settings_save"),"success")};var isEmpty=function(obj){for(var prop in obj)if(obj.hasOwnProperty(prop))return!1;return!0};$scope.onInputKeyup=function(e){var _this=$(e.currentTarget);_this=$(e.currentTarget),_selectedLanguage&&"en"===_selectedLanguage&&_this.val(_this.val().replace(/[^a-zA-Z- 0-9]+/g,"")),$scope.onCheckLength(e)},$scope.onCheckLength=function(e){var _this=$(e.currentTarget);_this&&_this.val().length>256&&_this.val(_this.val().substr(0,256))},$scope.icons={spark:env_conf["context-url"]+"/img/spark.svg",msteams:env_conf["context-url"]+"/img/microsoft-teams-icon.png",syniverse:env_conf["context-url"]+"/img/syniverse.png",rcengage:env_conf["context-url"]+"/img/ringCentralEngage.png",slack:env_conf["context-url"]+"/img/slack.svg",sms:env_conf["context-url"]+"/img/sms.svg",twilio:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",email:env_conf["context-url"]+"/img/email.svg",skype:"",facebook:env_conf["context-url"]+"/img/facebook.svg",websdk:env_conf["context-url"]+"/img/slack.svg",kore:env_conf["context-url"]+"/img/kore.svg",rtm:env_conf["context-url"]+"/img/web-mobile.svg",widgetsdk:env_conf["context-url"]+"/img/widgetsdk.svg",skypeOnPrem:env_conf["context-url"]+"/img/skypebusiness.svg",twitter:env_conf["context-url"]+"/img/twitter.svg",cisco:env_conf["context-url"]+"/img/cisco-tropo-icon.png",wfacebook:env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Groups":env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Chat":env_conf["context-url"]+"/img/fb-workplace-icon.png",ringcentral:env_conf["context-url"]+"/img/ringCentralIcon.png",skypeforbusiness:env_conf["context-url"]+"/img/skypebusiness.svg",jabber:env_conf["context-url"]+"/img/jabbericon.jpg",yammer:env_conf["context-url"]+"/img/yammericon.png",telegram:env_conf["context-url"]+"/img/telegram-logo.png",alexa:env_conf["context-url"]+"/img/amazonalexa.png",twiliovoice:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",line:env_conf["context-url"]+"/img/line-logo.png",ivr:env_conf["context-url"]+"/img/webhook.png",liveperson:env_conf["context-url"]+"/img/live-person.png",ivrVoice:env_conf["context-url"]+"/assets/ivrIcons/ivrIcon.svg",wechat:env_conf["context-url"]+"/img/weChat.svg"},$scope.taskFailExecutionCB.call=function(label){$scope.saveIVRSettings(vxmlflag,label)},$scope.taskFailExecutionCB.changeToShowMessage=function(){$(".dialogSettingsForm ").modal("show"),$scope.eventConfig.proceed="show_mess"},$scope.taskFailExecutionCB.openEventSliderCb=function(){$scope.openModalSlider("#addRespTaskFailExecution")},$scope.decodeJS=function(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}},$scope.deleteMessage=function(response,index){$scope.isAddRespEdited=!0,$scope.isSaveDisabled=!1;
for(var i=0;i<$scope.responseObj.length;i++)if(""!==$scope.responseObj[i]._id&&$scope.responseObj[i]._id===response._id&&$scope.responseObj[i].channel===response.channel||$scope.responseObj[i].text===response.text&&$scope.responseObj[i].channel===response.channel){$scope.responseObj.splice(i,1);break}0===$scope.responseObj.length&&($scope.isSaveDisabled=!0)},$scope.taskFailExecutionCB.updateWelcomeMessages=function(res){$scope.welcomeMessages=res},$scope.taskFailExecutionCB.getObjResponse=function(obj,isEdit){if($scope.isSaveDisabled=!1,$scope.isAddRespEdited=!0,isEdit){for(var i=0;i<$scope.responseObj.length;i++)if($scope.responseObj[i]._id===obj._id){$scope.responseObj.splice(i,1,obj);break}}else $scope.responseObj.push(obj)},$scope.taskFailExecutionCB.getObjResponseEdit=function(obj){$scope.isAddRespEdited=!0,$scope.isSaveDisabled=!1,$scope.responseObj=[],$scope.responseObj=angular.copy(obj)},$scope.editResponse=function(index){var isChannelSpec,channelId;$scope.taskFailExecutionCB.isAddResponseEnabled=!0;for(var key in $scope.eventsData)if($scope.eventsData[key].name===$scope.globOpenedSlider){isChannelSpec=$scope.eventsData[key].channelSpecific,channelId=$scope.eventsData[key].channel;break}$timeout(function(){$scope.taskFailExecutionCB.loadMessage($scope.responseObj,index,isChannelSpec,channelId)},300),importModalSliderOpen()},$scope.dilogTypeselect=function(type){"followUp"===type?($scope.intentNodeType.isFollowUp=$scope.intentNodeType.isFollowUp?!1:!0,$scope.intentNodeType.isHidden=!1):"hidden"!==type||$scope.intentNodeType.isFollowUp||($scope.intentNodeType.isHidden=$scope.intentNodeType.isHidden?!1:!0)},$scope.setPriority=function(priority){"task"===$scope.interruptOptions.priority&&($scope.interruptOptions.holdUxOptions=$scope.interruptOptions.holdUxOptions||{option:"holdCurrTask",message:""},$scope.interruptOptions.type=$scope.interruptOptions.type||{option:"developer",message:""},$scope.interruptOptions.resumeUxOptions=$scope.interruptOptions.resumeUxOptions||{option:"notifyUser",message:"",neverNotify:!1})},$scope.init=function(){$scope.callFrom=$scope.cb.callFrom,$scope.interruptOptions={priority:"bot"},$scope.followupTaskOptions={isFollowUp:!1},$scope.settings=angular.copy($scope.configData.dialogObj||{}),$scope.intentNodeType.isFollowUp=$scope.settings.isFollowUp||!1,$scope.intentNodeType.isHidden=$scope.settings.isHidden||!1,$scope.settings.contextLifeTime=$scope.settings.contextLifeTime||$scope.contextLifeTimeOption;var timeIntervel;timeIntervel=$scope.settings.contextLifeTime.minutes?angular.copy($scope.settings.contextLifeTime.minutes.toString()):"5",$scope.settings.contextLifeTime.minutes=angular.copy(timeIntervel),$scope.interruptOptions=$scope.settings.interruptOptions||$scope.interruptOptions,$scope.followupTaskOptions=$scope.settings.followupTaskOptions||$scope.followupTaskOptions,$scope.settings.onTaskFailure&&$scope.settings.onTaskFailure.enabled&&($("#taskExecuteToggle").click(),"triggerDialog"===$scope.settings.onTaskFailure.action?($scope.eventConfig.proceed="initiate_task",$scope.selected.dialog=$scope.dialogsName.filter(function(v,i){return v.id==$scope.settings.onTaskFailure.task})[0].name,$scope.globSelDialog=$scope.selected.dialog,$scope.responseObj=[]):"runScript"===$scope.settings.onTaskFailure.action?($scope.eventConfig.proceed="run_script",$scope.responseObj=[],$scope.selected.dialog="",$scope.inp.scriptText=$scope.settings.onTaskFailure.script,$scope.globScriptText=$scope.settings.onTaskFailure.script):"showMsg"===$scope.settings.onTaskFailure.action&&($scope.eventConfig.proceed="show_mess",$scope.responseObj=[],$scope.responseObj=angular.copy($scope.settings.onTaskFailure.msg),isEmpty($scope.settings.onTaskFailure.ivrOptions)||($scope.welcomeIVRTemp.ivrOptions=angular.copy($scope.settings.onTaskFailure.ivrOptions)))),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",setTimeout(function(){$(".dialogSettingsInnerBody").scrollTop(2)},200)},$scope.cb.init=function(){$scope.stream=$workflowService.selectedStream(),$scope.init()},$scope.setTimeIntervel=function(){$scope.settings.contextLifeTime.minutes=$scope.settings.contextLifeTime.minutes||"5"},$scope.editIVRSettings=function(){$scope.stream=$workflowService.selectedStream(),$scope.ivrOptions=angular.copy($scope.welcomeIVRTemp.ivrOptions),$scope.editIVR=!0,$scope.isIvrEnabled=!0,importModalSliderOpen()},$scope.closeIVRSettings=function(label){if(isVxml&&"notVxml"!==label){for(var tempProps=angular.copy($scope.ivrBridge.ivrOptions.advance.properties),i=0;i<tempProps.length;i++)for(var j=0;j<propertiesList.length;j++)propertiesList[j].name===tempProps[i].name&&propertiesList[j].value===tempProps[i].value&&(tempProps[i]={});tempProps=tempProps.filter(function(v){return v==={}}),$scope.ivrBridge.ivrOptions.advance.properties=tempProps;var tempNames=tempProps.map(function(v,i){return v.name});$scope.cb.updateVxmlCancel(tempNames)}$scope.editIVR=!1,$timeout(function(){$scope.eventConfig.proceed="show_mess",$scope.modalSlider.close("#addRespTaskFailExecution")},100),$scope.isIvrEnabled=!1,$(".dialogSettingsForm ").modal("show")},$scope.addProperty=function(vprop){propertiesList.push(vprop),$scope.ivrBridge.ivrOptions=$scope.ivrBridge.getIVROptions(),$scope.ivrBridge.ivrOptions.advance.properties.push(vprop),isVxml=!0,$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""},$scope.saveIVRSettings(vprop,"vxmlAdded")},$scope.closeNodeVxmlProp=function(){$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""}},$scope.closeModalDialogSettings=function(){$(".builderMaincontainer").removeClass("bt-modal-open"),$(".modal-backdrop").remove(),$(".builderMaincontainer").removeClass("modal-open"),$scope.cb.show=!1},$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation(),$scope.manageResponseCB.title=i18n.i18nString("confirm_dialog_task"),$scope.manageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key];var access="FULL";$scope.cb.viewMode&&(access="VIEW"),setTimeout(function(){$scope.manageResponseCB.openManageResponse(),$scope.manageResponseCB.initMessages(access)},300)},$scope.manageResponseCB.closeResponseScreen=function(){$scope.manageResponseCB.conditionKey={},$scope.showStandardResponses=!1},$scope.disableBtn=function(){return $scope.settings&&$scope.settings.name&&""!==$scope.settings.name.trim()?!1:!0},$scope.saveSettings=function(form){saveDialogSettings($scope.settings)},$scope.toggleTaskExecutionFail=function(){$scope.isTaskExecutionFail=!$scope.isTaskExecutionFail,$scope.isTaskExecutionFail?($(".toggle-dialog-slider").siblings(".inputLabelNewDesc").addClass("displayInline"),$(".toggle-dialog-slider").addClass("pull-right").addClass("pull-cust-up"),$(".dialogSettingsInnerBody").scrollTop($(".dialogSettingsInnerBody").height())):($(".toggle-dialog-slider").siblings(".inputLabelNewDesc").removeClass("displayInline"),$(".toggle-dialog-slider").removeClass("pull-right").removeClass("pull-cust-up")),$scope.scrollBottomDialog()}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("editLinkBot",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/edit-link-bot/edit-link-bot.html",scope:{linkTrainingData:"=",callback:"=",linkBotDetails:"=",editTrain:"="},controller:["$scope","$translator","$rootScope","$workflowService","BTStreamsService","NotificationService","$timeout","accessControlService","$element","env_conf","i18n",function($scope,$translator,$rootScope,$workflowService,BTStreamsService,NotificationService,$timeout,accessControlService,$element,env_conf,i18n){function stopSaving(className){$element.find(className).removeClass("fa fa-refresh fa-spin"),$element.find(className).addClass("fa fa-check"),setTimeout(function(){$element.find(className).removeClass("fa fa-check")},3e3)}$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.helpIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/helpIcon.svg",$scope.selectedStream=$workflowService.selectedStream(),$scope.currentLanguage=$workflowService.currentLanguage(),$scope.assetsBase=env_conf["assets-url"],$scope.eyeimage=$scope.assetsBase+"landingImages/icons/eye.svg",$scope.linktrainingData={},$scope.limit=10,$scope.currentPage=1,$scope.maxSize=3,$scope.itemsPerPage=10,$scope.editLinkBotForm={},$scope.streamState=$workflowService.selectedStreamState(),$scope.redirectToLink=function(linkType){$rootScope.redirectToLink(linkType)},$scope.closeEditLinkBot=function(){$scope.callback.closeEditLinkModal("#editLinkBot")},$scope.$watch("linkTrainingData",function(newVal,oldVal){newVal&&($scope.linktrainingData.invocationNames=newVal.invocationNames,$scope.linktrainingData.trainingUtterances=newVal.trainingUtterances,$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_TASKS"))}),$scope.$watch("linkBotDetails",function(newVal,oldVal){newVal&&($scope.linkBot=newVal)}),$scope.enableDisablePreferredBot=function(linkedBot){if($element.find(".fallbackBot").addClass("fa fa-refresh fa-spin"),linkedBot.inclusiveBot&&linkedBot.preferredBotStatus)return NotificationService.notify(i18n.i18nString("linked_marked"),"error"),$element.find(".fallbackBot").removeClass("fa fa-refresh fa-spin"),$element.find(".fallbackBot").addClass("fa fa-times"),$timeout(function(){linkedBot.preferredBotStatus=!linkedBot.preferredBotStatus}),void setTimeout(function(){$element.find(".fallbackBot").removeClass("fa fa-times")},3e3);var _payload={preferredBot:linkedBot.preferredBotStatus,botId:linkedBot._id};BTStreamsService.addTrainingData($scope.selectedStream._id,_payload).then(function(response){linkedBot.preferredBotStatus?NotificationService.notify(i18n.i18nString("added_fallback_Bots",{dyn:linkedBot.botName}),"success"):linkedBot.preferredBotStatus||NotificationService.notify(i18n.i18nString("removed_fallback_Bots",{dyn:linkedBot.botName}),"success"),$workflowService.selectedStream(response.data),stopSaving(".fallbackBot")},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):linkedBot.preferredBotStatus?NotificationService.notify(i18n.i18nString("error_fallback",{dyn:linkedBot.botName}),"error"):linkedBot.preferredBotStatus||NotificationService.notify(i18n.i18nString("error_removing_fallback",{dyn:linkedBot.botName}),"error"),linkedBot.preferredBotStatus=!linkedBot.preferredBotStatus,$element.find(".fallbackBot").removeClass("fa fa-refresh fa-spin"),$element.find(".fallbackBot").addClass("fa fa-times"),setTimeout(function(){$element.find(".fallbackBot").removeClass("fa fa-times")},3e3)})},$scope.enabledDisableInclusiveBot=function(linkedBot){if($element.find(".inclusiveBot").addClass("fa fa-refresh fa-spin"),linkedBot.inclusiveBot&&linkedBot.preferredBotStatus)return NotificationService.notify(i18n.i18nString("linked_marked"),"error"),$element.find(".inclusiveBot").removeClass("fa fa-refresh fa-spin"),$element.find(".inclusiveBot").addClass("fa fa-times"),$timeout(function(){linkedBot.inclusiveBot=!linkedBot.inclusiveBot}),void setTimeout(function(){$element.find(".inclusiveBot").removeClass("fa fa-times")},3e3);var _payload={inclusiveBot:linkedBot.inclusiveBot,botId:linkedBot._id};BTStreamsService.addTrainingData($scope.selectedStream._id,_payload).then(function(response){linkedBot.inclusiveBot?NotificationService.notify(i18n.i18nString("added_inclusive",{dyn:linkedBot.botName}),"success"):linkedBot.inclusiveBot||NotificationService.notify(i18n.i18nString("remove_inclusive",{dyn:linkedBot.botName}),"success"),$workflowService.selectedStream(response.data),stopSaving(".inclusiveBot")},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):linkedBot.inclusiveBot?NotificationService.notify(i18n.i18nString("error_adding_inclusive",{dyn:linkedBot.botName}),"error"):linkedBot.inclusiveBot||NotificationService.notify(i18n.i18nString("error_removing_inclusive",{dyn:linkedBot.botName}),"error"),linkedBot.inclusiveBot=!linkedBot.inclusiveBot,$element.find(".inclusiveBot").removeClass("fa fa-refresh fa-spin"),$element.find(".inclusiveBot").addClass("fa fa-times"),setTimeout(function(){$element.find(".inclusiveBot").removeClass("fa fa-times")},3e3)})},$scope.saveEditTrainingData=function(trainingData,bot){var _trainingData=angular.copy(trainingData);_trainingData.invocationNames=_.pluck(_trainingData.invocationNames,"text");var _payload={trainingUtterances:_trainingData.trainingUtterances,invocationNames:_trainingData.invocationNames,botId:bot._id,linkedBotDetails:{_id:bot._id,displayName:bot.botName}};bot.preferredBotStatus&&(_payload.preferredBot=bot.preferredBotStatus),bot.inclusiveBot&&(_payload.inclusiveBot=bot.inclusiveBot),BTStreamsService.addTrainingData($scope.selectedStream._id,_payload).then(function(response){if(response){var updatedStream;if(response.data.hasOwnProperty("invocationNames")&&response.data.hasOwnProperty("linkedBotUtterances")){$scope.selectedStream.invocationNames[response.data.trainingBotDetails.linkedBotId]=response.data.trainingBotDetails.invocationNames;var linkedBotTrainingDetails=_.find($scope.selectedStream.linkedBotUtterances,{id:response.data.trainingBotDetails.linkedBotId});linkedBotTrainingDetails&&linkedBotTrainingDetails.trainingUtterances&&(linkedBotTrainingDetails.trainingUtterances=response.data.trainingBotDetails.trainingUtterances),updatedStream=_.extend({},$scope.selectedStream,response.data),$workflowService.selectedStream(updatedStream)}else response.data.hasOwnProperty("invocationNames")&&!response.data.hasOwnProperty("linkedBotUtterances")&&($scope.selectedStream.invocationNames[response.data.trainingBotDetails.linkedBotId]=response.data.trainingBotDetails.invocationNames,updatedStream=_.extend({},$scope.selectedStream,response.data),$workflowService.selectedStream(updatedStream));$scope.linktrainingData=response.data.trainingBotDetails,$scope.editTrain.trainStatus(),NotificationService.notify(i18n.i18nString("saved_successfully"),"success")}},function(err){err&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")})},$scope.addUtterance=function(utterance,trainingData){if(!utterance||!utterance.newUtterance.length)return void NotificationService.notify(i18n.i18nString("utterances_value"),"error");if($scope.linktrainingData.trainingUtterances.indexOf(utterance.newUtterance)>=0){var _duplicateValue=angular.copy(utterance.newUtterance);NotificationService.notify(i18n.i18nString("duplicate_utterance_added",{duplicateValue:_duplicateValue}),"error")}else $scope.linktrainingData.trainingUtterances.push(utterance.newUtterance);utterance.newUtterance=""},$scope.deleteUtterance=function(index,utterance,currentPage){currentPage>1&&(index=10*(currentPage-1)+index),$scope.linktrainingData.trainingUtterances.splice(index,1)},$scope.pageChanged=function(currentPage){$scope.currentPage=currentPage},$scope.editUtterence=function(e,index,currentPage){e.preventDefault();var editValue=$("#utteranceTag"+index).text();if($scope.linktrainingData.trainingUtterances.indexOf(editValue)>=0&&index!==$scope.linktrainingData.trainingUtterances.indexOf(editValue))return NotificationService.notify(i18n.i18nString("utterances_dyn",{dyn:editValue}),"error"),void $("#utteranceTag"+index).text($scope.linkTrainingData.trainingUtterances[index]);var indexCal=10*(currentPage-1)+index;editValue&&editValue.length?$scope.linktrainingData.trainingUtterances[indexCal]=editValue:(NotificationService.notify(i18n.i18nString("utterances_value"),"error"),$("#utteranceTag"+index).text($scope.linktrainingData.trainingUtterances[indexCal]))},$scope.preventEvent=function(e){e.preventDefault()}}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("entityInstancePrompts",["$timeout","$workflowService","$filter",function($timeout,$workflowService,$filter){return{restrict:"EA",scope:{errorFor:"@",error:"=",displayMode:"@",onSave:"&",onCancel:"&",insideStream:"=",wfType:"@",view:"=",cb:"=",nodeInfo:"="},controller:["$scope","$rootScope","form_util","$element","BTFlowtaskService","BTStreamsService","BTAlertsService","BTActionsService","$workflowService","$location","NotificationService","env_conf","channelsConfig","i18n",function($scope,$rootScope,form_util,$element,BTFlowtaskService,BTStreamsService,BTAlertsService,BTActionsService,$workflowService,$location,NotificationService,env_conf,channelsConfig,i18n){function loadMultiCategoryComponents(){$.isEmptyObject($scope.nodeInfo.nodeInfo)||$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&"dateperiod"===$scope.nodeInfo.nodeInfo.entityType&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts&&($scope.instanceMultiCategoryPromptsCopy=angular.copy($scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts),$scope.instanceMultiCategoryPromptsCopy&&$scope.instanceMultiCategoryPromptsCopy.forEach(function(category){category.message.forEach(function(msg){msg.text=decodeJS(msg.text)}),category.message.length&&($scope.overrideMultiCategoryPrompts[category.category].message=!0),category.errorMessage.forEach(function(msg){msg.text=decodeJS(msg.text)}),category.errorMessage.length&&($scope.overrideMultiCategoryPrompts[category.category].errorMessage=!0),category.newPrompt={channel:"default",text:"",type:"basic",_id:""},category.newErrorPrompt={channel:"default",text:"",type:"basic",_id:""}}),$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.hasOwnProperty("errorPromptSequencing")&&($scope.errorPromptObj.errorPromptSequencing=angular.copy($scope.nodeInfo.dialogNodeInstance.nodeOptions.errorPromptSequencing)))}function decodeMessages(){$scope.userPromptsCopy.length>0&&($scope.userPromptOptions.override=!0,$scope.userPromptsCopy.forEach(function(message){message.text=decodeJS(message.text)})),$scope.userErrorPromptsCopy.length>0&&($scope.errorPromptOptions.override=!0,$scope.userErrorPromptsCopy.forEach(function(error){error.text=decodeJS(error.text)}))}function loadErrorPromptSequencing(){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.hasOwnProperty("errorPromptSequencing")&&($scope.errorPromptObj.errorPromptSequencing=angular.copy($scope.nodeInfo.dialogNodeInstance.nodeOptions.errorPromptSequencing))}function startSaving(className){$element.find(className).addClass("fa fa-refresh fa-spin")}function finishSaving(className,isError){$element.find(className).removeClass("fa fa-refresh fa-spin"),"error"===isError?$element.find(className).addClass("fa fa-times"):$element.find(className).addClass("fa fa-check"),setTimeout(function(){$element.find(className).removeClass("fa fa-check fa-times")},3e3)}function encodeJS(_obj){return encodeURIComponent(_obj)}function decodeJS(_obj){try{return decodeURIComponent(_obj.replace(/&lt;/g,"<").replace(/&gt;/g,">"))}catch(e){return _obj}}function createPrompt(index){""!==$scope.newPrompt.text&&(startSaving(".defaultPromptSaveIcon"),saveUserPromptMessages($scope.userPromptsCopy,index,!1))}function createErrorPrompt(index){""!==$scope.newErrorPrompt.text&&(startSaving(".defaultErrorPromptSaveIcon"),saveErrorPromptMessages($scope.userErrorPromptsCopy,index,!1))}function togglePromptsIcons(type,index){setTimeout(function(){$element.find(".deletePromptIcon"+index).removeClass("hideIcon")},3200)}function toggleErrorPromptsIcons(type,index){setTimeout(function(){$element.find(".deleteErrorPromptIcon"+index).removeClass("hideIcon")},3200)}function prepareInstancePayload(){var payload={},nodeOptions={};return $scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&(nodeOptions=$scope.nodeInfo.dialogNodeInstance.nodeOptions),"dialogAct"===$scope.nodeInfo.nodeInfo.type?payload={nodeOptions:{transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{},precedence:$scope.nodeInfo.dialogNodeInstance.nodeOptions.precedence}}:"entity"===$scope.nodeInfo.nodeInfo.type?payload={nodeOptions:{message:$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.message||[],errorMessage:$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage||[],isOptional:$scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional,transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",promptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions,reuseOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.reuseOptions,inputHandlingOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.inputHandlingOptions||"useAsEntityValue",interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{},precedence:$scope.nodeInfo.dialogNodeInstance.nodeOptions.precedence,noAutoCorrection:$scope.nodeInfo.dialogNodeInstance.nodeOptions.noAutoCorrection,notForReuse:$scope.nodeInfo.dialogNodeInstance.nodeOptions.notForReuse,customTags:$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags||{},errorPromptSequencing:$scope.errorPromptObj.errorPromptSequencing}}:"message"===$scope.nodeInfo.nodeInfo.type?payload={nodeOptions:{transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{}}}:"intent"===$scope.nodeInfo.nodeInfo.type?payload={nodeOptions:{transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",transitionMode:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionMode,interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{}}}:$scope.nodeInfo.nodeInfo.type&&(payload={nodeOptions:{transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto"}}),payload.nodeOptions=Object.assign(nodeOptions,payload.nodeOptions),payload}function saveUserPromptMessages(messages,index,_isFromDelete,payloadOfListOfValues){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS($scope.newPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var payload=prepareInstancePayload();payload.nodeOptions.message=_tempMessage,$scope.nodeInfo&&"list_of_values"===$scope.nodeInfo.nodeInfo.entityType&&(payload.nodeOptions.applyDefaultTemplate=$scope.overrideListOfValuesOptions.display),BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data&&res.data.nodes){var _nodeIndex=-1,filterObj=res.data.nodes.filter(function(e){return _nodeIndex++,e.nodeId==$scope.nodeInfo.nodeInfo.nodeId});filterObj=filterObj[0]||null,-1===index?(finishSaving(".defaultPromptSaveIcon"),$scope.newPrompt.text="",setTimeout(function(){NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("bot_res_updated"),"success")},500)):(finishSaving(".promptSaveSpin"+index),togglePromptsIcons("hide",index),_isFromDelete?NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_deleted"):i18n.i18nString("prompt_deleted"),"success"):NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("bot_res_updated"),"success")),$scope.nodeInfo.dialogNodeInstance.nodeOptions.message=filterObj.nodeOptions.message,$scope.nodeInfo.dialogNodeInstance.nodeOptions.message.length||($scope.userPromptOptions.override=!1),$scope.userPromptsCopy=angular.copy($scope.nodeInfo.dialogNodeInstance.nodeOptions.message||[]),$scope.userPromptsCopy.length>0&&($scope.userPromptOptions.override=!0,$scope.userPromptsCopy.forEach(function(message){message.text=decodeJS(message.text)})),$scope.cb.updateDialog(res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(isFromDelete?i18n.i18nString("bot_res_deletion"):i18n.i18nString("bot_res_update"),"error"):NotificationService.notify(_isFromDelete?i18n.i18nString("prompt_deletion"):i18n.i18nString("prompt_failed"),"error"):"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(i18n.i18nString("bot_res_creation_failed"),"error"):NotificationService.notify(i18n.i18nString("prompt_creation_failed"),"error");-1===index?finishSaving(".defaultPromptSaveIcon","error"):(finishSaving(".promptSaveSpin"+index,"error"),togglePromptsIcons("hide",index))})}function saveErrorPromptMessages(messages,index,_isFromDelete){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS($scope.newErrorPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var payload=prepareInstancePayload();payload.nodeOptions.errorMessage=_tempMessage,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data&&res.data.nodes){var _nodeIndex=-1,filterObj=res.data.nodes.filter(function(e){return _nodeIndex++,e.nodeId==$scope.nodeInfo.nodeInfo.nodeId});filterObj=filterObj[0]||null,-1===index?(finishSaving(".defaultErrorPromptSaveIcon"),$scope.newErrorPrompt.text="",setTimeout(function(){NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("bot_res_updated"),"success")},500)):(finishSaving(".errorPromptSaveSpin"+index),toggleErrorPromptsIcons("hide",index),_isFromDelete?NotificationService.notify(i18n.i18nString("error_prompt_success"),"success"):NotificationService.notify(i18n.i18nString("error_prompt_update"),"success")),$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage=filterObj.nodeOptions.errorMessage,$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage.length||($scope.errorPromptOptions.override=!1),$scope.userErrorPromptsCopy=angular.copy($scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage||[]),$scope.userErrorPromptsCopy.length>0&&($scope.errorPromptOptions.override=!0,$scope.userErrorPromptsCopy.forEach(function(error){error.text=decodeJS(error.text)})),$scope.cb.updateDialog(res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?NotificationService.notify(_isFromDelete?i18n.i18nString("promptdeletion_failed"):i18n.i18nString("update_failed"),"error"):NotificationService.notify(i18n.i18nString("error_prompt_failed"),"error");-1===index?finishSaving(".defaultErrorPromptSaveIcon","error"):(finishSaving(".errorPromptSaveSpin"+index,"error"),toggleErrorPromptsIcons("hide",index))})}function createCategoryPrompt(index,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.newPrompt.text&&(startSaving(".defaultPromptSaveIcon"+category),saveUserCategoryPromptMessages(filterObj.message,index,!1,category,filterObj))}function createCategoryErrorPrompt(index,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.newErrorPrompt.text&&(startSaving(".defaultErrorPromptSaveIcon"+category),saveCategoryErrorPromptMessages(filterObj.errorMessage,index,!1,category,filterObj))}function saveCategoryErrorPromptMessages(messages,index,_isFromDelete,category,filterObj){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS(filterObj.newErrorPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var _currCategoryPrompts=angular.copy($scope.instanceMultiCategoryPromptsCopy),tempCopyObj=_currCategoryPrompts.filter(function(e){return e.category==category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.errorMessage=_tempMessage,_currCategoryPrompts.forEach(function(categ){delete categ.newPrompt,delete categ.newErrorPrompt});var payload=prepareInstancePayload();payload.nodeOptions.multiCategoryPrompts=_currCategoryPrompts,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data){var _nodeIndex=-1,filterObj=res.data.nodes.filter(function(e){return _nodeIndex++,e.componentId==$scope.nodeInfo.dialogNodeInstance.componentId});filterObj=filterObj[0]||null,$scope.userErrorPromptsCopy=angular.copy($scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts||[]),-1===index?(finishSaving(".defaultErrorPromptSaveIcon"+category),setTimeout(function(){NotificationService.notify(i18n.i18nString("bot_res_updated"),"success")},500)):(finishSaving(".errorPromptSaveSpin"+category+index),toggleErrorPromptsIcons("hide",index),_isFromDelete?($scope.nodeInfo.nodeInfo.errorMessage.splice(index,1),NotificationService.notify(i18n.i18nString("error_prompt_success"),"success")):NotificationService.notify(i18n.i18nString("error_prompt_update"),"success")),$scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts=angular.copy(_currCategoryPrompts),loadMultiCategoryComponents(),$scope.cb.updateDialog(res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?NotificationService.notify(_isFromDelete?i18n.i18nString("promptdeletion_failed"):i18n.i18nString("update_failed"),"error"):NotificationService.notify(i18n.i18nString("error_prompt_failed"),"error");-1===index?finishSaving(".defaultErrorPromptSaveIcon","error"):(finishSaving(".errorPromptSaveSpin"+index,"error"),toggleErrorPromptsIcons("hide",index))})}function saveUserCategoryPromptMessages(messages,index,_isFromDelete,category,filterObj){var _tempMessage=[];
if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS(filterObj.newPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var _currCategoryPrompts=angular.copy($scope.instanceMultiCategoryPromptsCopy),tempCopyObj=_currCategoryPrompts.filter(function(e){return e.category==category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.message=_tempMessage,_currCategoryPrompts.forEach(function(categ){delete categ.newPrompt,delete categ.newErrorPrompt});var payload=prepareInstancePayload();payload.nodeOptions.multiCategoryPrompts=_currCategoryPrompts,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data){var _nodeIndex=-1,filterObj=res.data.nodes.filter(function(e){return _nodeIndex++,e.componentId==$scope.nodeInfo.dialogNodeInstance.componentId});filterObj=filterObj[0]||null,$scope.userErrorPromptsCopy=angular.copy($scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts||[]),-1===index?(finishSaving(".defaultPromptSaveIcon"+category),setTimeout(function(){NotificationService.notify(i18n.i18nString("bot_res_updated"),"success")},500)):(finishSaving(".promptSaveSpin"+category+index),togglePromptsIcons("hide",index),_isFromDelete?NotificationService.notify(i18n.i18nString("prompt_deleted"),"success"):NotificationService.notify(i18n.i18nString("bot_res_updated"),"success")),$scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts=angular.copy(_currCategoryPrompts),loadMultiCategoryComponents(),$scope.cb.updateDialog(res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(isFromDelete?i18n.i18nString("bot_res_deletion"):i18n.i18nString("bot_res_update"),"error"):NotificationService.notify(_isFromDelete?i18n.i18nString("prompt_deletion"):i18n.i18nString("prompt_failed"),"error"):"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(i18n.i18nString("bot_res_creation_failed"),"error"):NotificationService.notify(i18n.i18nString("prompt_creation_failed"),"error");-1===index?finishSaving(".defaultPromptSaveIcon","error"):(finishSaving(".promptSaveSpin"+index,"error"),togglePromptsIcons("hide",index))})}function sortableCallbackErrorPromt(e,uiElement){if($scope.userErrorPromptsCopy.length>1){var dropindex=uiElement.item.sortable.dropindex;setTimeout(function(){saveErrorPromptMessages($scope.userErrorPromptsCopy,dropindex,!1)},50)}else NotificationService.notify("If more than one prompt message is defined","error")}$scope.assetsBase=env_conf["assets-url"],$scope._constants_=$rootScope._constants_,$scope.custom={},$scope.custom.user=[],$scope.custom.message=[],$scope.custom.session=[],$scope.customForm={},$scope.initialCustomUserProfile={},$scope.initialMessageCustomTag={},$scope.initialCustomSession={},$scope.trashIcon=$scope.assetsBase+"icons/trashIcon.svg",$scope._channelConfig=channelsConfig;var _selectedStream=($workflowService.currentLanguage(),$workflowService.selectedStream());if($scope.stream=$workflowService.selectedStream(),$scope.errorPromptObj={errorPromptSequencing:!1},$scope.sortableOptionsErrorPromt={handle:".sortBar","ui-floating":!0,update:sortableCallbackErrorPromt},_selectedStream&&($scope.stream=_selectedStream),$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type)$scope.showAdvancedOptions=!0,$scope.nodeInfo.dialogNodeInstance.nodeOptions&&!$scope.nodeInfo.dialogNodeInstance.nodeOptions.precedence&&($scope.nodeInfo.dialogNodeInstance.nodeOptions.precedence="entityOverIntent");else if($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"dialogAct"===$scope.nodeInfo.dialogNodeInstance.type)$scope.showAdvancedOptions=!1,$scope.noAdvancedOptions=!0,$scope.showAdvancedControlsforConfirmMessage=!0,$scope.nodeInfo.dialogNodeInstance.nodeOptions&&!$scope.nodeInfo.dialogNodeInstance.nodeOptions.precedence&&($scope.nodeInfo.dialogNodeInstance.nodeOptions.precedence="entityOverIntent");else if($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"message"===$scope.nodeInfo.dialogNodeInstance.type)$scope.showAdvancedOptions=!1,$scope.showAdvancedControlsforConfirmMessage=!0,$scope.noAdvancedOptions=!0;else if("intent"===$scope.nodeInfo.nodeInfo.type&&$scope.nodeInfo.dialogNodeInstance.uId!==$scope.nodeInfo.dialogInfo.firstNodeId&&$scope.nodeInfo.nodeInfo.dialogId&&0===$scope.nodeInfo.nodeInfo.dialogId.indexOf("dg-")){$scope.showAdvancedOptions=!1,$scope.noAdvancedOptions=!0;var _dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId||$scope.nodeInfo.nodeInfo.dialogId;$scope.nodeInfo.dialogNodeInstance.flowTaskId&&$scope.nodeInfo.dialogNodeInstance.flowTaskId===_dialogRefId&&($scope.showAdvancedOptions=!0,$scope.noAdvancedOptions=!1)}else $scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"script"===$scope.nodeInfo.dialogNodeInstance.type?$scope.noAdvancedOptions=!0:$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"service"===$scope.nodeInfo.dialogNodeInstance.type?$scope.noAdvancedOptions=!0:($scope.showAdvancedOptions=!1,$scope.noAdvancedOptions=!0);$scope.manageResponseCB={},$scope.showAdvancedControls=!1,$scope.userPromptOptions={override:!1},$scope.errorPromptOptions={override:!1},$scope.userPromptsCopy=angular.copy($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.message)||[],$scope.userErrorPromptsCopy=angular.copy($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage)||[],$scope.newPrompt={channel:"default",text:"",type:"basic",_id:""},$scope.newErrorPrompt={channel:"default",text:"",type:"basic",_id:""},$scope.instanceMultiCategoryPromptsCopy=[],$scope.instanceMultiCategoryPromptsCopy=[{category:"from",errorMessage:[],message:[]},{category:"to",errorMessage:[],message:[]}],$scope.overrideMultiCategoryPrompts={from:{message:!1,errorMessage:!1},to:{message:!1,errorMessage:!1}},loadMultiCategoryComponents(),$scope.interruptOptions={type:{option:"developer",message:""},priority:"task",holdUxOptions:{option:"holdCurrTask",message:""},resumeUxOptions:{option:"notifyUser",message:"",neverNotify:!1}},$scope.stream.interruptOptions&&$scope.stream.interruptOptions.interruptsEnabled?$scope.interruptOptions.interruptsEnabled=$scope.stream.interruptOptions.interruptsEnabled:$scope.interruptOptions.interruptsEnabled=!1,$scope.interruptOptions=$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||$scope.interruptOptions,$scope.interruptOptions.interruptsEnabled||($scope.interruptOptions.type={option:"doNotAllowHoldResume"}),$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions&&($scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions.interruptsEnabled=$scope.interruptOptions.interruptsEnabled),$scope.nodeInfo.dialogNodeInstance.nodeOptions.inputHandlingOptions=$scope.nodeInfo.dialogNodeInstance.nodeOptions.inputHandlingOptions||"useAsEntityValue",$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags=$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags,$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags&&($scope.customCopy=angular.copy($scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags),$scope.custom.message=$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags.message,$scope.custom.session=$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags.session,$scope.custom.user=$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags.user),$scope.overrideListOfValuesOptions={},$scope.overrideListOfValuesOptions.display=!1,decodeMessages(),loadErrorPromptSequencing(),$scope.cb.updateMessages=function(){$scope.userPromptsCopy=angular.copy($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.message)||[]},$scope.cb.updateMulticategoryMessages=function(){loadMultiCategoryComponents()},$scope.cb.updateErrorMessages=function(){$scope.userErrorPromptsCopy=angular.copy($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage)||[]},$scope.cb.isUserPromptsOveridden=function(){return $scope.userPromptOptions.override},$scope.cb.isErrorPromptsOveridden=function(){return $scope.errorPromptOptions.override},$scope.cb.isMultiCategoryUserPromptsOveridden=function(category){return $scope.overrideMultiCategoryPrompts[category].message},$scope.cb.isMultiCategoryErrorPromptsOveridden=function(category){return $scope.overrideMultiCategoryPrompts[category].errorMessage},$scope.auto_grow_prompts=function(e,index){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createPrompt(index):$scope.saveEditPrompts(index),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_error_prompts=function(e,index){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createErrorPrompt(index):$scope.saveEditErrorPrompts(index),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.showPromptSaveTip=function(index,category){category=category||"",$element.find(".promptSaveTip"+category+index)&&"block"!==$element.find(".promptSaveTip"+category+index)[0].style.display?$element.find(".promptSaveTip"+category+index).css("display","block"):$element.find(".promptSaveTip"+category+index).css("display","none")},$scope.showErrorPromptSaveTip=function(index,category){category=category||"",$element.find(".errorPromptSaveTip"+category+index).length&&"block"!==$element.find(".errorPromptSaveTip"+category+index)[0].style.display?$element.find(".errorPromptSaveTip"+category+index).css("display","block"):$element.find(".errorPromptSaveTip"+category+index).length&&$element.find(".errorPromptSaveTip"+category+index).css("display","none")},$scope.saveEditErrorPrompts=function(index){""!==$scope.userErrorPromptsCopy[index].text?(toggleErrorPromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorPromptMessages($scope.userErrorPromptsCopy,index,!1)):NotificationService.notify(i18n.i18nString("errpr_prompt"),"error")},$scope.deleteEditErrorPrompts=function(index){toggleErrorPromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorPromptMessages($scope.userErrorPromptsCopy,index,!0)},$scope.saveEditPrompts=function(index){""!==$scope.userPromptsCopy[index].text?(togglePromptsIcons("show",index),startSaving(".promptSaveSpin"+index),saveUserPromptMessages($scope.userPromptsCopy,index,!1)):NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_prompt"):i18n.i18nString("prompt_empty"),"error")},$scope.deleteEditPrompts=function(index){togglePromptsIcons("show",index),startSaving(".promptSaveSpin"+index),saveUserPromptMessages($scope.userPromptsCopy,index,!0)},$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation();var access="FULL";"view"===$scope.cb.displayMode&&(access="VIEW"),setTimeout(function(){$scope.manageResponseCB.title=i18n.i18nString("confirm_dialog"),$scope.manageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key],$scope.manageResponseCB.initMessages(access),$scope.manageResponseCB.openManageResponse()},100)},$scope.manageResponseCB.closeResponseScreen=function(){$scope.manageResponseCB.conditionKey={},$scope.showStandardResponses=!1},$scope.addMessage=function(e,className){if(13===e.keyCode&&$scope.customForm.message.$valid){var _result=_.filter($scope.custom.message,{name:$scope.initialMessageCustomTag.name,value:$scope.initialMessageCustomTag.value});if(_result.length)NotificationService.notify(i18n.i18nString("key_value_pair"),"error");else{$("#messagekey").focus(),startSaving(className),$scope.custom.message.push({name:$scope.initialMessageCustomTag.name,value:$scope.initialMessageCustomTag.value}),$scope.customCopy=angular.copy($scope.custom),$scope.initialMessageCustomTag={};var payload=prepareInstancePayload();angular.forEach($scope.custom.message,function(obj,index){(""===obj.name||""===obj.value)&&$scope.custom.message.splice(index,1)}),payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}}else if($scope.customForm.message.$invalid&&13===e.keyCode){var _msg=i18n.i18nString("key_value_mandatory");NotificationService.notify(_msg,"error")}},$scope.editMessage=function(e,className,customObj){if(13===e.keyCode&&""!==customObj.name&&""!==customObj.value){var _result=_.filter($scope.customCopy.message,{name:customObj.name,value:customObj.value});if(_result.length)NotificationService.notify(i18n.i18nString("key_value_pair"),"error");else{startSaving(className);var payload=prepareInstancePayload();payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}}else if(13===e.keyCode&&(""===customObj.name||""===customObj.value)){var _msg=i18n.i18nString("key_value_mandatory");NotificationService.notify(_msg,"error")}},$scope.deleteMessage=function(index,className){function confirmDeleteCustomMessage(){startSaving(className),$scope.custom.message.splice(index,1);var payload=prepareInstancePayload();payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}var msg=i18n.i18nString("delete_custom_tag");NotificationService.alert(msg,confirmDeleteCustomMessage,{okText:i18n.i18nString("ok_label")})},$scope.addUser=function(e,className){if(13===e.keyCode&&$scope.customForm.user.$valid){var _result=_.filter($scope.custom.user,{name:$scope.initialCustomUserProfile.name,value:$scope.initialCustomUserProfile.value});if(_result.length)NotificationService.notify(i18n.i18nString("key_value_pair"),"error");else{$("#userkey").focus(),startSaving(className),$scope.custom.user.push({name:$scope.initialCustomUserProfile.name,value:$scope.initialCustomUserProfile.value}),$scope.customCopy=angular.copy($scope.custom),$scope.initialCustomUserProfile={};var payload=prepareInstancePayload();angular.forEach($scope.custom.user,function(obj,index){(""===obj.name||""===obj.value)&&$scope.custom.user.splice(index,1)}),payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}}else if(13===e.keyCode&&$scope.customForm.user.$invalid){var _msg=i18n.i18nString("key_value_mandatory");NotificationService.notify(_msg,"error")}},$scope.editUser=function(e,className,customObj){if(13===e.keyCode&&""!==customObj.name&&""!==customObj.value){var _result=_.filter($scope.customCopy.user,{name:customObj.name,value:customObj.value});if(_result.length)NotificationService.notify(i18n.i18nString("key_value_pair"),"error");else{startSaving(className);var payload=prepareInstancePayload();payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}}else if(13===e.keyCode&&(""===customObj.name||""===customObj.value)){var _msg=i18n.i18nString("key_value_mandatory");NotificationService.notify(_msg,"error")}},$scope.deleteUser=function(index,className){function confirmDeleteUser(){startSaving(className),$scope.custom.user.splice(index,1);var payload=prepareInstancePayload();payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}var msg=i18n.i18nString("delete_custom_tag");NotificationService.alert(msg,confirmDeleteUser,{okText:i18n.i18nString("ok_label")})},$scope.addSession=function(e,className){if(13===e.keyCode&&$scope.customForm.session.$valid){var _result=_.filter($scope.custom.session,{name:$scope.initialCustomSession.name,value:$scope.initialCustomSession.value});if(_result.length)NotificationService.notify(i18n.i18nString("key_value_pair"),"error");else{$("#sessionkey").focus(),startSaving(className),$scope.custom.session.push({name:$scope.initialCustomSession.name,value:$scope.initialCustomSession.value}),$scope.customCopy=angular.copy($scope.custom),$scope.initialCustomSession={};var payload=prepareInstancePayload();angular.forEach($scope.custom.session,function(obj,index){(""===obj.name||""===obj.value)&&$scope.custom.session.splice(index,1)}),payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}}else if(13===e.keyCode&&$scope.customForm.session.$invalid){var _msg=i18n.i18nString("key_value_mandatory");NotificationService.notify(_msg,"error")}},$scope.editSession=function(e,className,customObj){if(13===e.keyCode&&""!==customObj.name&&""!==customObj.value){var _result=_.filter($scope.customCopy.session,{name:customObj.name,value:customObj.value});if(_result.length)NotificationService.notify(i18n.i18nString("key_value_pair"),"error");else{startSaving(className);var payload=prepareInstancePayload();payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}}else if(13===e.keyCode&&(""===customObj.name||""===customObj.value)){var _msg=i18n.i18nString("key_value_mandatory");NotificationService.notify(_msg,"error")}},$scope.deleteSession=function(index,className){function confirmDeleteSession(){startSaving(className),$scope.custom.session.splice(index,1);var payload=prepareInstancePayload();payload.nodeOptions.customTags=$scope.custom,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&($scope.cb.updateDialog(res.data),finishSaving(className))},function(err){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})}var msg=i18n.i18nString("delete_custom_tag");NotificationService.alert(msg,confirmDeleteSession,{okText:i18n.i18nString("ok")})},$scope.showHideAdvancedControls=function(){$scope.showAdvancedControls=$scope.showAdvancedControls?!1:!0},setTimeout(function(){$(".entityAdvancedControl").click(function(event){$(".tab-content").animate({scrollTop:event.currentTarget.offsetTop-100},1e3)})},2e3),$scope.auto_grow_category_prompts=function(e,index,category){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createCategoryPrompt(index,category):$scope.saveCategoryEditPrompts(index,category),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_error_category_prompts=function(e,index,category){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createCategoryErrorPrompt(index,category):$scope.saveCategoryEditErrorPrompts(index,category),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.saveCategoryEditPrompts=function(index,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.message[index].text?(togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryPromptMessages(filterObj.message,index,!1,category,filterObj)):NotificationService.notify(i18n.i18nString("prompt_empty"),"error")},$scope.saveCategoryEditErrorPrompts=function(index,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.errorMessage[index].text?(toggleErrorPromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorPromptMessages(filterObj.errorMessage,index,!1,category,filterObj)):NotificationService.notify(i18n.i18nString("prompt_empty"),"error")},$scope.deleteEditCategoryPrompts=function(index,type,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&filterObj.errorMessage[index]){var _standardPromptMessageCount=filterObj.errorMessage.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryPromptMessages(filterObj.errorMessage,index,!0,category,filterObj);else{if("default"===filterObj.errorMessage[index].channel)return NotificationService.notify(i18n.i18nString("allchannel_msg"),"error"),!1;togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryPromptMessages(filterObj.errorMessage,index,!0,category,filterObj)}}},{okText:i18n.i18nString("ok_label")})},$scope.deleteEditCategoryErrorPrompts=function(index,type,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&filterObj.errorMessage[index]){var _standardPromptMessageCount=filterObj.errorMessage.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)toggleErrorPromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorPromptMessages(filterObj.errorMessage,index,!0,category,filterObj);else{if("default"===$scope.userErrorPromptsCopy[index].channel)return NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("allchannel_res"):i18n.i18nString("allchannel_msg"),"error"),!1;toggleErrorPromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorPromptMessages(filterObj.errorMessage,index,!0,category,filterObj)}}},{okText:i18n.i18nString("ok")})},$scope.reOrderChange=function(event){var payload=prepareInstancePayload();BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&$scope.cb.updateDialog(res.data)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_prompt_failed"),"error")})},$scope.saveHoldResume=function(className){startSaving(className);var payload=prepareInstancePayload(),interruptOptions={priority:$scope.interruptOptions.priority,type:$scope.interruptOptions.type||{option:"developer",message:""}};"node"===interruptOptions.priority?"doNotAllowHoldResume"===interruptOptions.type.option?interruptOptions={type:{option:"developer"},interruptsEnabled:!1,priority:"node"}:(interruptOptions.priority="node",interruptOptions.interruptsEnabled=!0,$scope.interruptOptions.type=$scope.interruptOptions.type||{option:"developer",message:""},"developer"===$scope.interruptOptions.type.option&&(interruptOptions.holdUxOptions=$scope.interruptOptions.holdUxOptions||{option:"holdCurrTask",message:""},"discardCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.discardCurrentTask.key:"continueCurrTask"===interruptOptions.holdUxOptions.option?interruptOptions.holdUxOptions.message=$scope._constants_.pauseResumeMessages.continueCurrentTask.key:interruptOptions.holdUxOptions.message="",$scope.interruptOptions.holdUxOptions=interruptOptions.holdUxOptions),(interruptOptions.holdUxOptions&&"holdCurrTask"===interruptOptions.holdUxOptions.option||"endUser"===$scope.interruptOptions.type.option)&&(interruptOptions.resumeUxOptions=$scope.interruptOptions.resumeUxOptions||{option:"notifyUser",message:"",neverNotify:!1},$scope.interruptOptions&&$scope.interruptOptions.resumeUxOptions&&$scope.interruptOptions.resumeUxOptions.neverNotify?interruptOptions.resumeUxOptions.neverNotify=$scope.interruptOptions.resumeUxOptions.neverNotify:interruptOptions.resumeUxOptions.neverNotify=!1,"confFromUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.getConfirmatonWithUser.key:"notifyUser"===interruptOptions.resumeUxOptions.option?interruptOptions.resumeUxOptions.message=$scope._constants_.pauseResumeMessages.notifyUserWithMessage.key:interruptOptions.resumeUxOptions.message="",$scope.interruptOptions.resumeUxOptions=interruptOptions.resumeUxOptions)):interruptOptions={priority:$scope.interruptOptions.priority},payload.nodeOptions.interruptOptions=interruptOptions,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){res&&res.data&&res.data.nodes&&$scope.cb.updateDialog(res.data),finishSaving(className)},function(error){if(finishSaving(className,"error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_prompt_failed"),"error")})},$scope.showDisplayListOfvaluesOptions=function(){return"entity"===$scope.nodeInfo.nodeInfo.type&&"list_of_values"===$scope.nodeInfo.nodeInfo.entityType?!0:"dialogAct"===$scope.nodeInfo.nodeInfo.type?!0:!1},$scope.saveListOfValuesOptionsChoice=function(){var payload={applyDefaultTemplate:$scope.overrideListOfValuesOptions.display};saveUserPromptMessages($scope.userPromptsCopy,"",!1,payload)},($scope.nodeInfo&&"entity"===$scope.nodeInfo.nodeInfo.type&&"list_of_values"===$scope.nodeInfo.nodeInfo.entityType||"dialogAct"===$scope.nodeInfo.nodeInfo.type)&&$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.hasOwnProperty("applyDefaultTemplate")&&($scope.overrideListOfValuesOptions.display=$scope.nodeInfo.dialogNodeInstance.nodeOptions.applyDefaultTemplate)}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/entity-instance-prompts/entity-instance-prompts.html",link:function(scope,element,attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("errorForm",["$timeout","$workflowService","$filter",function($timeout,$workflowService,$filter){return{restrict:"EA",scope:{errorFor:"@",error:"=",onSave:"&",onCancel:"&",wfType:"@",view:"="},controller:["$scope","$rootScope","form_util","$filter","BTSeedDataService","BTStreamsService","BTAlertsService","BTActionsService","$workflowService","$location","NotificationService","domEvents","accessControlService","i18n",function($scope,$rootScope,form_util,$filter,BTSeedDataService,BTStreamsService,BTAlertsService,BTActionsService,$workflowService,$location,NotificationService,domEvents,accessControlService,i18n){function initialize(){$scope.loading=!0,$scope.error=[],$scope.errorCodes=[],$scope.totalErrors=[],$scope.totalStatuses=[],$scope.saving=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.seeedData={},$scope.currentPage=1,$scope.saveInProgress=!1,$scope._constants_=$rootScope._constants_,$scope.pollError={statusCode:"",action:null,messageType:"",threshold:null,errorsPath:null},$scope.editInOperation=!1,$scope.editIndex=null,$scope.maxSize=5,$scope.pollErrorDefault=angular.copy($scope.pollError),BTSeedDataService.getSeedData().then(function(res){$scope.seedData=res.data,$scope.messageTypes=angular.copy(res.data.errorMessageTypes),$scope.messageTypes=$scope.messageTypes.filter(function(obj){return"default"!==obj.value?obj:void 0}),$scope.defaultActions=angular.copy(res.data.errorActions),$scope.actions=angular.copy(res.data.errorActions).filter(function(action){return"none"!==action.value})}).then(function(){
if($scope.loading=!1,"stream"===$scope.errorFor)if($workflowService.selectedStream()._id)BTStreamsService.getErrorCodes($workflowService.selectedStream()._id).then(function(res){$scope.errorCodes=res.data,$scope.totalErrors=res.data,getErrors()});else{var errorCodes=$scope.seedData.errorCodes.pollErrors;for(var key in errorCodes)if(errorCodes.hasOwnProperty(key)&&"0"!==key&&"def"!==key){var obj=errorCodes[key];obj.statusCode=key,$scope.totalStatuses.push(obj)}$scope.totalErrors=angular.copy($scope.totalStatuses)}}),getErrors()}function getErrors(){var statuses=$scope.errorCodes;if(statuses&&statuses.length)for(var i=0;i<statuses.length;i++)$scope.totalStatuses.push(statuses[i])}function getIndex(errors,error){for(var i=0;i<errors.length;i++)if(+errors[i].statusCode===+error.statusCode)return i;return-1}function collectAllErrors(errors){var alert,alertErrors,action,actionErrors;return"alert"===$scope.errorFor?(alert=$workflowService.alertInfo(),alertErrors=alert&&alert.errorCodes&&alert.errorCodes.pollError||[],errors=_.union(errors,alertErrors),errors=_.uniq(errors,function(error){return error.statuscode})):"action"===$scope.errorFor&&(action=$workflowService.actionInfo(),actionErrors=action&&action.errorCodes&&action.errorCodes.pollError||[],errors=_.union(errors,actionErrors),errors=_.uniq(errors,function(error){return error.statuscode})),errors}function setSaveInProgress(){$scope.saveInProgress=!1}function registerListeners(){$workflowService.registerModalHiddenEvent(),$(".errorModal").on("hidden.bs.modal hide.bs.modal",function(e){$timeout(function(){$scope.errorFrm=!1})})}$scope.advancedDisplayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.insideStream=!0,initialize(),$scope.$watch("errorCodes",function(newVal,oldVal){getErrors()}),getErrors(),$scope.savePollError=function(event,isValid,form,error){if(event&&event.preventDefault&&event.preventDefault(),error=angular.copy($scope.pollError),"default"===error.messageType&&($scope.pollError.messageType=""),!isValid||"default"===error.messageType)return void form_util.touch(form);error.action||(error.action=["none"]),error.action=_.uniq(error.action);var index=getIndex($scope.totalErrors,error);if(error.errorsPath&&error.errorsPath.split&&(error.errorsPath=error.errorsPath.split(",")),"custom"===error.messageType?delete error.errorsPath:delete error.customMessage,error.statusCode=error.statusCode+"",error.insert=!0,$scope.editInOperation){if(index!==$scope.editIndex&&-1!==index)return void NotificationService.notify(i18n.i18nString("error_code"),"warning");$scope.totalErrors.splice($scope.editIndex,1,angular.copy(error))}else{if(-1!==index)return void NotificationService.notify(i18n.i18nString("error_code"),"warning");$scope.totalErrors.push(angular.copy(error)),$scope.currentPage=($scope.totalErrors.length-$scope.totalErrors.length%5)/5+1}$scope.error=$scope.totalErrors.filter(function(obj){return obj.insert?obj:void 0}),$scope.errorFrm=!1,$(".errorModal").modal("hide")},$scope.closeErrorModal=function(){$(".errorModal").modal("hide")},$scope.editError=function(error,index){index=getIndex($scope.totalErrors,error),$scope.editIndex=index,$scope.editInOperation=!0,$scope.pollError=angular.copy(error),delete $scope.pollError.actionsview,$scope.pollError.statusCode=+$scope.pollError.statusCode,$scope.pollError.messageType=error.messageType,$scope.errorFrm=!0,$(".errorModal").modal({show:!0,backdrop:"static"}),registerListeners()},$scope.saveErrors=function(){$scope.saveInProgress=!0;var errors=$scope.totalErrors.filter(function(obj){return obj.insert?obj:void 0}).map(function(obj){var result=angular.copy(obj);return delete result.insert,result});errors=collectAllErrors(errors),$scope.onSave({error:errors,cb:setSaveInProgress})},$scope.showErrorForm=function(notInvokeClear){notInvokeClear||$scope.clear(),$scope.editInOperation=!1,$scope.editIndex=null,$scope.errorFrm=!0,$(".errorModal").modal({show:!0,backdrop:"static"}),registerListeners()},$scope.isScheduled=function(){var result=!1;if($scope.pollError&&$scope.pollError.action)for(var i=0;i<$scope.pollError.action.length;i++)"reschedule"===$scope.pollError.action[i]&&(result=!0);return result},$scope.deleteError=function(index){$scope.totalErrors.splice(index,1)},$scope.cancel=function(){initialize(),$scope.onCancel(),$(".errorModal").modal("hide"),$scope.errorFrm=!1,$location.path(window.appConfig.CONTEXT_PATH)},$scope.clear=function(){$scope.pollError=angular.copy($scope.pollErrorDefault)},$scope.errorClear=function(){$scope.clear()},$scope.$watch("totalErrors",function(newVal,oldVal){newVal&&Array.isArray(newVal)&&(newVal||[]).map(function(error){return error.actionsview=(error.action||[]).map(function(action){var totalActions=[];return $scope.defaultActions.map(function(defAction){defAction.value===action&&totalActions.push(defAction.name)}),totalActions}),error.actionsview=error.actionsview||[],error.actionsview=_.compact(error.actionsview),error})},!0),$scope.$on("evt:nextActErr",function(){$scope.saveErrors()}),$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.$emit("nestedComponentLoaded",{id:"errorMessage",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/error-form/error-form.html",link:function(scope,element,attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("errorPromptForm",[function(){return{restrict:"EA",scope:{onDone:"=",mode:"=",onCancelPrompt:"=",errorsObject:"=",displayMode:"=",selectedNode:"=",dialogData:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/error-prompt-form/error-prompt-form.html",controller:["$scope","$element","$workflowService","BTStreamsService","NotificationService","BTFlowtaskService","$timeout","_constants_","env_conf","channelsConfig","i18n","mixPanel",function($scope,$element,$workflowService,BTStreamsService,NotificationService,BTFlowtaskService,$timeout,_constants_,env_conf,channelsConfig,i18n,mixPanel){function sortableCallbackErrorPromt(e,uiElement){if($scope.standardErrors.length>1){var dropindex=uiElement.item.sortable.dropindex;setTimeout(function(){$scope.saveUserPromptMessages(dropindex,!1,!1)},50)}else NotificationService.notify("If more than one prompt message is defined","error")}function isStandardPromptExist(index){var _standardPromptMessageCount=$scope.standardErrors.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);return _standardPromptMessageCount>1?!0:(1!==_standardPromptMessageCount||$scope.standardErrors[index]._id)&&"default"===$scope.standardErrors[index].channel&&"default"!==$scope.selectedChannel.channel?(NotificationService.notify(i18n.i18nString("atleast_error_msg"),"error"),!1):!0}function encodeJS(_obj){return encodeURIComponent(_obj)}function startSaving(className){$element.find(className).addClass("fa fa-refresh fa-spin")}function finishSaving(className,isError){$element.find(className).removeClass("fa fa-refresh fa-spin"),"error"===isError?$element.find(className).addClass("fa fa-times"):$element.find(className).addClass("fa fa-check"),setTimeout(function(){$element.find(className).removeClass("fa fa-check fa-times")},3e3)}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function isMarkUp(markup){return markup.jsCode&&""!==markup.jsCode.trim()?!1:!0}$scope.dialogTask=$workflowService.taskEditInfo(),$scope.standardErrors=[],channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channels=Object.values(channelsConfig.channelsObject),$scope.selectedChannel={},$scope.selectedChannel.channel="default",$scope.displayMode=$scope.displayMode||"edit",$scope.assetsBase=env_conf["assets-url"],"edit"===$scope.displayMode&&$scope.errorsObject&&$scope.errorsObject.nodeInfo&&$scope.errorsObject.nodeInfo.nodeInfo.editLocked&&($scope.displayMode="view"),$scope._constants_=_constants_,$scope.stream=$workflowService.selectedStream(),$scope.$watch("errorsObject",function(newVal,oldVal){newVal&&($scope.standardPrompts=[],$scope.channelPrompts=[],$scope.standardErrors=[],$scope.currentScreen=0,newVal.errors&&newVal.errors.length>0&&newVal.errors.map(function(message){message.text=message.text,"default"===message.channel?$scope.standardPrompts.push(message):("wfacebook"===message.channel&&(message.channel=message.isMention?"wfacebookG":"wfacebookC"),$scope.channelPrompts.push(message))}),$scope.type="error",$scope.standardErrors=$scope.standardErrors.concat($scope.standardPrompts),$scope.standardErrors=$scope.standardErrors.concat($scope.channelPrompts),$scope.standardErrors.forEach(function(obj){obj.isOpen="false"}),$scope.errorsObject.openIndex&&!isPromptOpened&&setTimeout(function(){isPromptOpened||($("#promptHeader-"+$scope.errorsObject.openIndex).trigger("click"),isPromptOpened=!0)},1e3))}),$scope.CurrentTabIndex=-1,$scope.currentTabIndexOfPage1=0,$scope.currentTabIndexOfPage2=0,$scope.currentScreen=0,$scope.editPromptMode=!0,$scope.isUser=!0,$scope.editErrorIndex=0,$scope.editingError={},$scope.type="error",$scope.loadEditor=!1;var isWFacebook=!1,wfacebookIndex=0,isPromptOpened=!1;$scope._channelConfig=channelsConfig,$scope.contextCondition=[{key:"",value:""}],$scope.channels=$scope.channels.map(function(channel,i){return channel.used=!1,"wfacebook"===channel.id&&(isWFacebook=!0,wfacebookIndex=i),channel}),$scope.channels=_.filter($scope.channels,{enable:!0}),$scope.channels=_.filter($scope.channels,{enable:!0}),$scope.editors={},$scope.jsEditorCbs={},$scope.markdownCbs={},$scope.type="error",$scope.displayMode=$scope.displayMode||"edit",$scope.jsEditorCbs.displayMode=$scope.displayMode,$scope.markdownCbs.displayMode=$scope.displayMode,$scope.contexts=[],$scope.contextsData=[],$scope.markdownCbs.switchEditor=function(type){"javaScriptEditor"===type?$scope.alterTabsOfPage2(1):"promptsPreview"===type&&$scope.alterTabsOfPage2(2)},$scope.markdownCbs.onFocus=function(){$scope.showProtip=!0},$scope.markdownCbs.onBlur=function(){$scope.showProtip=!1},$scope.markdownCbs.isFromUserPrompt=!0,$scope.jsEditorCbs.onFocus=function(){$scope.showProtip=!0},$scope.jsEditorCbs.onBlur=function(){$scope.showProtip=!1},$scope.icons={spark:env_conf["context-url"]+"/img/spark.svg",msteams:env_conf["context-url"]+"/img/microsoft-teams-icon.png",syniverse:env_conf["context-url"]+"/img/syniverse.png",rcengage:env_conf["context-url"]+"/img/ringCentralEngage.png",slack:env_conf["context-url"]+"/img/slack.svg",sms:env_conf["context-url"]+"/img/sms.svg",twilio:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",email:env_conf["context-url"]+"/img/email.svg",skype:"",facebook:env_conf["context-url"]+"/img/facebook.svg",websdk:env_conf["context-url"]+"/img/slack.svg",kore:env_conf["context-url"]+"/img/kore.svg",rtm:env_conf["context-url"]+"/img/web-mobile.svg",widgetsdk:env_conf["context-url"]+"/img/widgetsdk.svg",skypeOnPrem:env_conf["context-url"]+"/img/skypebusiness.svg",twitter:env_conf["context-url"]+"/img/twitter.svg",cisco:env_conf["context-url"]+"/img/cisco-tropo-icon.png",wfacebook:env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Groups":env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Chat":env_conf["context-url"]+"/img/fb-workplace-icon.png",ringcentral:env_conf["context-url"]+"/img/ringCentralIcon.png",skypeforbusiness:env_conf["context-url"]+"/img/skypebusiness.svg",jabber:env_conf["context-url"]+"/img/jabbericon.jpg",yammer:env_conf["context-url"]+"/img/yammericon.png",telegram:env_conf["context-url"]+"/img/telegram-logo.png",alexa:env_conf["context-url"]+"/img/amazonalexa.png",twiliovoice:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",line:env_conf["context-url"]+"/img/line-logo.png",ivr:env_conf["context-url"]+"/img/webhook.png",liveperson:env_conf["context-url"]+"/img/live-person.png",ivrVoice:env_conf["context-url"]+"/assets/ivrIcons/ivrIcon.svg",googleactions:env_conf["context-url"]+"/img/google-home.svg",wechat:env_conf["context-url"]+"/img/weChat.svg",hangoutchat:env_conf["context-url"]+"/img/hangoutchat.png",livebank:env_conf["context-url"]+"/img/livebank.png"},$scope.showProtip=!0,$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.quotsIcon=window.appConfig.CONTEXT_PATH+"/assets/images/quotsIcon.svg",$scope.$watch("selectedChannel.channel",function(){$scope.selectedChannelType=$scope.selectedChannel.channel}),$scope.alterTabsOfPage1=function(tabIndex){$scope.currentTabIndexOfPage1=tabIndex},$scope.addContextCond=function(index){$scope.contextCondition.length>0&&index===$scope.contextCondition.length-1&&$scope.contextCondition.push({key:"",value:""})},$scope.onRemoveCond=function(index){$scope.contextCondition.length>1&&$scope.contextCondition[index]&&$scope.contextCondition.splice(index,1)},$scope.sortableOptionsErrorPromt={handle:".sortBar","ui-floating":!0,update:sortableCallbackErrorPromt},$scope.alterTabsOfPage2=function(tabIndex){$scope.CurrentTabIndex=tabIndex,$scope.editingError.jsCode&&$scope.editingError.jsCode.trim()&&0===tabIndex?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_js_notify")):$scope.editingError.markUp&&$scope.editingError.markUp.trim()&&1===tabIndex?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_markup_notify")):$scope.currentTabIndexOfPage2=tabIndex,2===tabIndex&&($scope.editingError.jsCode&&$scope.editingError.jsCode.trim().length>0||$scope.editingError.markUp&&$scope.editingError.markUp.trim().length>0?$scope.disablePreviewBtn=!1:$scope.disablePreviewBtn=!0,$scope.openPreviewWithSample())},$scope.disableSaveBtn=function(){return"edit"!==$scope.displayMode?!0:$scope.editingError.markUp&&$scope.editingError.markUp.trim()||$scope.editingError.jsCode&&$scope.editingError.jsCode.trim()?!1:!0},$scope.addNewErrorMessage=function(){if("edit"===$scope.displayMode){$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0,$scope.selectedChannel.channel="default";var messageObject={};messageObject.channel=$scope.selectedChannel.channel,messageObject.text="",messageObject.type="basic",$scope.standardErrors.push(messageObject),$scope.currEditPromptIndex>=0&&($scope.standardErrors[$scope.currEditPromptIndex].isOpen=!1,$scope.loadEditor=!1),$timeout(function(){$scope.standardErrors[$scope.standardErrors.length-1].isOpen=!0,$scope.editPrompt($scope.standardErrors.length-1,!1)},150)}},$scope.savePromptMessage=function(index){if(isStandardPromptExist(index)){var _isFrmCreate=!1;$scope.standardErrors=$scope.standardErrors||[];var messageObject={};messageObject.channel=$scope.selectedChannel.channel,"wfacebookG"===messageObject.channel?(messageObject.channel="wfacebook",messageObject.isMention=!0):"wfacebookC"===messageObject.channel&&(messageObject.channel="wfacebook",messageObject.isMention=!1),0===$scope.CurrentTabIndex?(messageObject.text=$scope.editingError.markUp?$scope.editingError.markUp:$scope.editingError.jsCode,messageObject.type="basic"):1===$scope.CurrentTabIndex&&(messageObject.text=angular.copy($scope.editingError.jsCode?$scope.editingError.jsCode:$scope.editingError.markUp),messageObject.type="uxmap"),-1===$scope.editMessageIndex&&($scope.editingError.jsCode||$scope.editingError.markUp)?$scope.standardErrors.push(messageObject):(messageObject._id=$scope.standardErrors[$scope.editMessageIndex]._id,$scope.standardErrors[$scope.editMessageIndex]=messageObject),$scope.standardErrors[$scope.editMessageIndex]._id||(_isFrmCreate=!0),$scope.saveUserPromptMessages(index,!1,_isFrmCreate),$scope.currentTabIndexOfPage2=0,$scope.navigateBack($scope.currEditPromptIndex)}},$scope.saveUserPromptMessages=function(index,_isFromDelete,_isFrmCreate){if($scope.errorsObject.isInstancePrompts)return void $scope.saveInstanceEntityUserErrorMessages(index,_isFromDelete,_isFrmCreate);startSaving(".promptSaveSpin"+index);var _tempMessage=[];$scope.standardErrors&&$scope.standardErrors.length>0&&$.each($scope.standardErrors,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebookG"===_tempMessageObject.channel||"wfacebookC"===_tempMessageObject.channel||"wfacebook"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),_tempMessage=_tempMessage.filter(function(i){return""!==i.text});var payload={name:$scope.errorsObject.name,errorMessage:_tempMessage};if($scope.errorsObject.category&&""!==$scope.errorsObject.category){var tempCopyObj=$scope.errorsObject.nodeInfo.nodeInfo.multiCategoryPrompts.filter(function(e){return e.category==$scope.errorsObject.category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.errorMessage=_tempMessage,payload={name:$scope.errorsObject.name,multiCategoryPrompts:$scope.errorsObject.nodeInfo.nodeInfo.multiCategoryPrompts}}BTFlowtaskService.updateComponent($workflowService.selectedStream()._id,$scope.errorsObject.nodeId,payload).then(function(res){if(res&&res.data){var componentData=$scope.errorsObject.nodeInfo.nodeInfo||{},dialog=$scope.dialogData||{},_eventPayload={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,"Dialog Name":dialog.name,"Component Name":componentData.intent||componentData.name,"Dialog Version":"V2",Category:"Engagement L2","Sub Category":"Conversation - Dialog Task",Level:"Engagement L2","Primary Intent creation mode":"Storyboard"},event="";if("intent"===componentData.type?event="Conversation - Dialog Intent updated":"message"===componentData.type?event="Conversation - Dialog Message Node updated":"entity"===componentData.type?event="Conversation - Dialog Entity Node updated":"dialogAct"===componentData.type?event="Conversation - Dialog Confirmation Node updated":"service"===componentData.type?event="Conversation - Bot action Service updated":"script"===componentData.type?event="Conversation - Bot action Script updated":"logic"===componentData.type?event="Conversation - Bot action Logic updated":"SDKWebHook"===componentData.type?event="Conversation - Bot action Webhook updated":"process"===componentData.type?event="Conversation - Bot action Process updated":"agentTransfer"===componentData.type?event="Conversation - Agent Transfer node updated":"form"===componentData.type?event="Conversation - Form node updated":"botAction"===componentData.type&&(event="componentData - Bot action Node updated"),event&&mixPanel.postEvent(event,_eventPayload),finishSaving(".promptSaveSpin"+index),_isFromDelete)setTimeout(function(){$scope.standardErrors.splice(index,1),$scope.dialogData&&$scope.dialogData("updateComponent",$scope.standardErrors)},1e3),$timeout(function(){$(".scrollDiv").scrollTop(2)},1e3),NotificationService.notify(i18n.i18nString("error_message_deleted"),"success");else{if($scope.errorsObject.category&&""!==$scope.errorsObject.category)$.each($scope.errorsObject.nodeInfo.nodeInfo.multiCategoryPrompts,function(k,cat){var filterObj=res.data.multiCategoryPrompts.filter(function(e){return e.category==cat.category});filterObj=filterObj[0]||[],cat.message.forEach(function(msg,index){msg._id=filterObj.message[index]}),cat.errorMessage.forEach(function(msg,index){msg._id=filterObj.errorMessage[index]})});else{$.each($scope.standardErrors,function(k,message){message._id=res.data.errorMessage[k]});var _componentData=res.data;_componentData.errorMessage=angular.copy($scope.standardErrors),_componentData.errorMessage.forEach(function(msg){msg.text=encodeURIComponent(msg.text)}),$scope.dialogData&&$scope.dialogData("updateComponent",_componentData)}NotificationService.notify(_isFrmCreate?i18n.i18nString("error_msg_created"):i18n.i18nString("error_msg_updated"),"success")}}},function(error){if(finishSaving(".promptSaveSpin"+index,"error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else _isFrmCreate?NotificationService.notify(i18n.i18nString("error_message_creation"),"error"):NotificationService.notify(_isFromDelete?i18n.i18nString("error_message_delete"):i18n.i18nString("error_message_update"),"error")})},$scope.saveInstanceEntityUserErrorMessages=function(index,_isFromDelete,_isFrmCreate){startSaving(".promptSaveSpin"+index);var _tempMessage=[];$scope.standardErrors&&$scope.standardErrors.length>0&&$.each($scope.standardErrors,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel||"wfacebook"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),_tempMessage=_tempMessage.filter(function(i){return""!==i.text});var payload={nodeOptions:{isOptional:$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.isOptional,transitionType:$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",promptOptions:$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions,interruptOptions:$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{},reuseOptions:$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.reuseOptions,notForReuse:$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.notForReuse||!1,precedence:$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.precedence,customTags:$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.customTags||{}}};if($scope.errorsObject.category&&""!==$scope.errorsObject.category){var tempCopyObj=$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts.filter(function(e){return e.category==$scope.errorsObject.category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.errorMessage=_tempMessage,payload.nodeOptions.multiCategoryPrompts=$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts}else payload.nodeOptions.errorMessage=angular.copy(_tempMessage),payload.nodeOptions.message=angular.copy($scope.errorsObject.nodeInfo&&$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.message)||[];BTFlowtaskService.updateFlowtaskNodeInfo($workflowService.selectedStream()._id,$scope.errorsObject.nodeInfo.dialogInfo.dialogId,$scope.errorsObject.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data)if(finishSaving(".promptSaveSpin"+index),_isFromDelete)setTimeout(function(){$scope.standardErrors.splice(index,1)},1e3),$timeout(function(){$(".scrollDiv").scrollTop(2)},1e3),NotificationService.notify(i18n.i18nString("error_message_deleted"),"success");else{var filterObj=angular.copy(res.data.nodes.filter(function(e){return e.nodeId==$scope.errorsObject.nodeInfo.nodeInfo.nodeId}));filterObj=filterObj[0]||null,$scope.errorsObject.category&&""!==$scope.errorsObject.category&&filterObj.nodeOptions.multiCategoryPrompts?$.each($scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts,function(k,cat){var multiCategoryFilterObj=filterObj.nodeOptions.multiCategoryPrompts.filter(function(e){return e.category==cat.category});multiCategoryFilterObj=multiCategoryFilterObj[0]||[],cat.message.forEach(function(msg,index){msg._id=multiCategoryFilterObj.message[index]}),cat.errorMessage.forEach(function(msg,index){msg._id=multiCategoryFilterObj.errorMessage[index]})}):filterObj&&filterObj.nodeOptions.errorMessage&&($scope.standardErrors=angular.copy(filterObj.nodeOptions.errorMessage),$scope.standardErrors.forEach(function(message){message.text=decodeJS(message.text)})),NotificationService.notify(_isFrmCreate?i18n.i18nString("error_msg_created"):i18n.i18nString("error_msg_updated"),"success")}},function(error){if(finishSaving(".promptSaveSpin"+index,"error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else _isFrmCreate?NotificationService.notify(i18n.i18nString("error_message_creation"),"error"):NotificationService.notify(_isFromDelete?i18n.i18nString("error_message_delete"):i18n.i18nString("error_message_update"),"error")})},$scope.savePromptsInfo=function(){var promptsArray=[];promptsArray=promptsArray.concat($scope.standardErrors),$scope.errorsObject.category&&""!==$scope.errorsObject.category?$scope.onDone(promptsArray,$scope.errorsObject.nodeInfo.nodeInfo.multiCategoryPrompts):$scope.onDone(promptsArray)},$scope.editPromptMessage=function(index){-1===index&&($scope.editPromptMode=!1),$scope.loadEditor=!0,$scope.editErrorIndex=index,$scope.currentScreen=1,$scope.editingError={},$scope.selectedChannel="default",$scope.contextCondition=[{key:"",value:""}],0>index||index>=0&&"basic"===$scope.standardErrors[index].type?($scope.editingError.markUp=index>=0?$scope.standardErrors[index].text:"",$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0):($scope.editingError.jsCode=$scope.standardErrors[index].text,$scope.currentTabIndexOfPage2=1,$scope.CurrentTabIndex=1)},$scope.navigateBack=function(index){$scope.loadEditor=!1,$scope.currentScreen=0,$scope.editPromptMode=!0,$scope.isUser=!0,$scope.standardErrors[index].isOpen=!1,$(".scrollDiv").animate({scrollTop:$("#prompt-0").offset().top},1e3)},$scope.addPromptMessage=function(){$scope.standardErrors=$scope.standardErrors||[];var messageObject={};return messageObject.channel=0===$scope.currentTabIndexOfPage1?"default":$scope.selectedChannel,messageObject.text=$scope.editingError.jsCode?$scope.editingError.jsCode:$scope.editingError.markUp,messageObject.type=$scope.editingError.jsCode?"uxmap":"basic",void 0===messageObject.text||""===messageObject.text.trim()?void NotificationService.notify(_constants_.flowtasks.errorPrompt.errorMsg,"warning"):(-1===$scope.editErrorIndex&&($scope.editingError.jsCode||$scope.editingError.markUp)?$scope.standardErrors.push(messageObject):(messageObject._id=$scope.standardErrors[$scope.editErrorIndex]._id,$scope.standardErrors[$scope.editErrorIndex]=messageObject),$scope.currentTabIndexOfPage2=0,void $scope.navigateBack())},$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.getJsSamples(),$scope.editPrompt=function(index,isOpen){$scope.loadEditor=!1,isOpen||($scope.currEditPromptIndex=index,-1===index&&($scope.editPromptMode=!1,$scope.isUser=!1),$scope.editMessageIndex=index,$scope.editingError={},$scope.selectedChannel.channel=index>=0?$scope.standardErrors[index].channel:"",0>index||index>=0&&"basic"===$scope.standardErrors[index].type?($scope.editingError.markUp=index>=0?$scope.standardErrors[index].text:"",$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0):($scope.editingError.jsCode=$scope.standardErrors[index].text,$scope.currentTabIndexOfPage2=1,$scope.CurrentTabIndex=1),"wfacebook"===$scope.selectedChannel.channel&&($scope.selectedChannel.channel=$scope.standardErrors[index].isMention?"Workplace For Groups":"Workplace For Chat")),$timeout(function(){isOpen||($scope.loadEditor=!0)},150),$timeout(function(){isOpen?$(".scrollDiv").animate({scrollTop:$("#prompt-0").offset().top},1e3):$(".scrollDiv").animate({scrollTop:$("#prompt-"+index).offset().top},750)},350)},$scope.deletePrompt=function(index){$scope.standardErrors.splice(index,1)},$scope.deleteErrorMessage=function($event,index){$event.preventDefault(),$event.stopPropagation();var _msgTxt="error message";NotificationService.alert(i18n.i18nString("delete_dyn",{dyn:_msgTxt}),function(){if(""===$scope.standardErrors[index].text)return $scope.standardErrors.splice(index,1),NotificationService.notify(i18n.i18nString("error_msg_deleted"),"success"),void $timeout(function(){$(".scrollDiv").scrollTop(2)},1e3);var _standardPromptMessageCount=$scope.standardErrors.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)$scope.saveUserPromptMessages(index,!0,!1);else{if("default"===$scope.standardErrors[index].channel)return NotificationService.notify(i18n.i18nString("atleast_error_msg"),"error"),!1;$scope.saveUserPromptMessages(index,!0,!1)}},{okText:i18n.i18nString("ok_label")})},$scope.cancel=function(){$("#flowtask_configure").modal("hide")},$scope.updateFooterHeader=function(){return $scope.footerInfoTitle=i18n.i18nString("learn_about_error"),$scope.footerHeaderId="bt-userPrompt",$scope.footerPanelId="bt-userPrompt-panel",$scope.nameDescription=i18n.i18nString("resource.bb553"),!0},$scope.closePromptDialog=function(){$scope.savePromptsInfo()},$scope.savePromptsInfo=function(){var promptsArray=[];promptsArray=$scope.standardErrors.filter(function(i){return""!==i.text}),promptsArray.forEach(function(v){delete v.isOpen}),$scope.errorsObject.category&&""!==$scope.errorsObject.category?$scope.errorsObject.isInstancePrompts?$scope.onDone(promptsArray,$scope.errorsObject.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts,!0):$scope.onDone(promptsArray,$scope.errorsObject.nodeInfo.nodeInfo.multiCategoryPrompts):$scope.errorsObject.isInstancePrompts?$scope.onDone(promptsArray,!1,!0):$scope.onDone(promptsArray)},$scope.handleEditorPlaceholder=function(event){},$scope.getPreviewData=function(){var _context={},_isValidContext=!0;if($scope.contextCondition.length>0&&$.each($scope.contextCondition,function(k,context){var _contextKey=context.key?context.key.trim():"";if(""!==_contextKey){if(0!==_contextKey.toLowerCase().indexOf("context."))return _isValidContext=!1,!1;var _tempObj={};_contextKey=_contextKey.substr(8),_contextKey.split(".").reverse().forEach(function(_parsedKey){var _t={};_t[_parsedKey]=Object.keys(_tempObj).length?_tempObj:context.value.trim(),_tempObj=_t}),angular.merge(_context,_tempObj)}}),!_isValidContext)return void NotificationService.notify(i18n.i18nString("bot_welcomeMessage_keys_should_be_prefixed_notify"),"warning");$scope.previewIsOn=!0;var markup=isMarkUp($scope.editingError),payload={message:$scope.editingError.markUp&&$scope.editingError.markUp.trim()?$scope.editingError.markUp:$scope.editingError.jsCode,type:markup?"basic":"uxmap",context:JSON.stringify(_context)};$scope.isError=!1,$scope.preview="",BTFlowtaskService.messagePreviewFlowtask($workflowService.selectedStream()._id,$scope.errorsObject.taskId,$scope.errorsObject.nodeId,payload).then(function(res){var _ele=document.createElement("div");_ele.innerHTML=res.data&&(res.data.resolvedPayload||res.data.resolvedData);var lnkEle=$(_ele).find("a");lnkEle.length>0&&$.each(lnkEle,function(k,ele){$(ele).attr("target","_blank")}),$scope.preview=_ele.innerHTML,$scope.previewIsOn=!1},function(err){var error=err.data&&err.data.errors&&err.data.errors[0].msg||err.data;try{error=JSON.parse(error),error.errors&&error.errors[0].msg&&($scope.preview=error.errors[0].msg)}catch(e){$scope.preview=error}$scope.previewIsOn=!1,$scope.isError=!0})},$scope.openPreviewWithSample=function(){$scope.isError=!1,$scope.previewIsOn=!1,$scope.preview=$scope.editingError.markUp?$scope.editingError.markUp:$scope.editingError.jsCode}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("finishForm",function(){return{restrict:"EA",scope:{configure:"&",wfType:"@",displayMode:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/finish-form/finish-form.html",controller:["$scope","$rootScope","urlutil","$q","$workflowService","$routeParams","$location","$applicationService","BTAlertsService","BTActionsService","BTStreamsService","BTFiltersService","cron",function($scope,$rootScope,urlutil,$q,$workflowService,$routeParams,$location,$applicationService,BTAlertsService,BTActionsService,BTStreamsService,BTFiltersService,cron){
function fetchResourceDetails(){var _promise,rqInfoForTable={};resourceType===apConstants.RESOURCE_TYPE_ALERT?_promise=$q.all([$workflowService.alertInfo(),$workflowService.mpAlertInfo()]):resourceType===apConstants.RESOURCE_TYPE_ACTION&&(_promise=$q.all([$workflowService.actionInfo(),$workflowService.mpActionInfo()])),_promise.then(function(res){var btresource=res[0],mpresource=res[1];if($scope.resourceDetails=angular.extend({},btresource),$scope.resourceDetails=angular.extend(btresource,mpresource),$scope.resourceDetails.scheduleOptions&&$scope.resourceDetails.scheduleOptions["default"]&&$scope.resourceDetails.scheduleOptions["default"][0]&&($scope.resourceDetails.repeatInterval=cron.extract($scope.resourceDetails.scheduleOptions["default"][0])),$scope.resourceDetails.createdBy=$scope.resourceDetails.createdBy.firstName+" "+$scope.resourceDetails.createdBy.lastName,resourceType===apConstants.RESOURCE_TYPE_ALERT){if($scope.resourceDetails.alertFieldsRequired){var alertFieldForTable={};alertFieldForTable.headers=[{name:"FieldType",sortable:!1},{name:"Name",sortable:!1}],alertFieldForTable.rows=[],$scope.resourceDetails.alertFieldsDefinition.forEach(function(defn){alertFieldForTable.rows.push({FieldType:defn.fieldType,Name:defn.title})}),$scope.alertFieldsInfo=alertFieldForTable}rqInfoForTable.headers=[{name:"Url",sortable:!0},{name:"Method",sortable:!0}],rqInfoForTable.rows=[],arrangeReqChains($scope.resourceDetails.requestChain,rqInfoForTable),getAlertFilters($scope.resourceDetails._id||$workflowService.alertInfo()._id,$scope.resourceDetails.version||$workflowService.alertInfo().version),$scope.rqInfo=rqInfoForTable}if(resourceType===apConstants.RESOURCE_TYPE_ACTION){var payloadInfoForTable={};payloadInfoForTable.headers=[{name:"Fieldtype",sortable:!1},{name:"Key",sortable:!1},{name:"Title",sortable:!1},{name:"Type",sortable:!1}],payloadInfoForTable.rows=[],$scope.resourceDetails.payloadField.forEach(function(defn){payloadInfoForTable.rows.push({Title:defn.title,Key:defn.key,Fieldtype:defn.fieldType,Type:defn.type})}),$scope.payloadInfo=payloadInfoForTable;var rqActionInfoForTable={};rqActionInfoForTable.headers=[{name:"Url",sortable:!0},{name:"Method",sortable:!0}],rqActionInfoForTable.rows=[],arrangeReqChains($scope.resourceDetails.requestChain,rqActionInfoForTable),$scope.rqInfo=rqActionInfoForTable;var queryFieldInfoForTable={};queryFieldInfoForTable.headers=[{name:"Fieldtype",sortable:!1},{name:"Key",sortable:!1},{name:"Title",sortable:!1},{name:"Type",sortable:!1}],queryFieldInfoForTable.rows=[],$scope.resourceDetails.queryField.forEach(function(defn){queryFieldInfoForTable.rows.push({Title:defn.title,Key:defn.key,Fieldtype:defn.fieldType,Type:defn.type})}),$scope.queryFieldInfo=queryFieldInfoForTable}})}function prepareReqChainTableData(reqLink){var endPoint,url,record={};return reqLink.linkDefinition=reqLink.linkDefinition||{},"apiObject"===reqLink.linkType&&(endPoint=reqLink.linkDefinition&&reqLink.linkDefinition.endPoint,endPoint=endPoint||{},url=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port,protocol:endPoint.protocol}),record.method=endPoint.method||"---",record.url=url),record}function getAlertFilters(id,version){BTFiltersService.getFiltersByAlertId(id,version).then(function(res){formAlertFilterTable(res.data)})}function arrangeReqChains(requestChain,table){angular.forEach(requestChain||[],function(obj,index){if(obj&&"apiObject"===obj.linkType){var row=prepareReqChainTableData(obj);table.rows.push({Url:row.url,Method:row.method||"---"})}})}function formAlertFilterTable(data){if(data.length>0){var alertFilters={};alertFilters.headers=[{name:"FieldType"},{name:"Name"},{name:"Type"}],alertFilters.rows=[];for(var i=0;i<data.length;i++)alertFilters.rows.push({FieldType:data[i].rhsInputType.inputType,Name:data[i].name,Type:data[i].type});$scope.resourceDetails.filterInfo=alertFilters}}var resourceType=$routeParams.resourceType,resourceId=$routeParams.resourceId,flowtype=$routeParams.flowtype,apConstants=$applicationService.getAppConstants();window.URI;$scope._constants_=$rootScope._constants_,$scope.linkTypes=$workflowService.seedData().requestChainTypes||[],resourceType||(resourceType=$scope.wfType,"alert"===resourceType?resourceId=$workflowService.alertInfo()._id:"action"===resourceType&&(resourceId=$workflowService.actionInfo()._id)),$scope.resourceType=resourceType,$scope.resourceId=resourceId,$scope.flowtype=flowtype,$scope.resourceDetails={},fetchResourceDetails(),$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onFinishSetup=function(type){$scope.configure({type:$routeParams.resourceType})}}]}})}(angular),function(ng){var _createDialogForm=ng.module("bt-forms");_createDialogForm.directive("btCreateDialog",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/flowtask-form/bt-create-dialog.html",controller:"createDialogCtrl"}}),_createDialogForm.controller("createDialogCtrl",["$scope","$timeout","$filter","$element","patternFactory","BTFlowtaskService","$workflowService","$location","$rootScope","env_conf","i18n","mixPanel","BTStreamsService","$util",function($scope,$timeout,$filter,$element,patternFactory,BTFlowtaskService,$workflowService,$location,$rootScope,env_conf,i18n,mixPanel,BTStreamsService,$util){function scrollToEle(){var _PanelEle=$(".moreOptions");if(_PanelEle){var _container=$(".dialogScrollBody");if(_container&&_container.offset()){var _scrollHeight=100;_container.animate({scrollTop:_scrollHeight},"slow")}}}function createUtterances(componentRes){var payload={taskId:componentRes._id,streamId:_selectedStream._id,taskName:componentRes.name,type:"DialogIntent",sentences:$scope.newDialogUtterences};BTStreamsService.createBulkUtterances(payload).then(function(res){})}function initializeNodeModal(nodeType){$scope.nodeObjLabels={},$scope.nodeObjLabels.name=$scope._constants_.flowtasks.label,"intent"===nodeType?($scope.nodeObj=$.extend(!0,{},_intentObj),$scope.nodeObjLabels.name=i18n.i18nString("new_intent")):"entity"===nodeType?($scope.nodeObj=$.extend(!0,{},_entityObj),$scope.nodeObjLabels.name=i18n.i18nString("new_entity")):"service"===nodeType?($scope.nodeObj=$.extend(!0,{},_serviceObj),$scope.nodeTypeObjOptns=$.extend(!0,[],_serviceNodeType),$scope.nodeObjLabels.name=i18n.i18nString("new_service")):"script"===nodeType?($scope.nodeObj=$.extend(!0,{},_scriptObj),$scope.nodeObjLabels.name=i18n.i18nString("new_script")):"message"===nodeType?($scope.nodeObj=$.extend(!0,{},_messageObj),$scope.nodeObjLabels.name=i18n.i18nString("new_message")):"dialogAct"===nodeType?($scope.nodeObj=$.extend(!0,{},_confirmationObj),$scope.nodeObjLabels.name=i18n.i18nString("new_confirmation")):"SDKWebHook"===nodeType&&($scope.nodeObj=$.extend(!0,{},_sdkwebhookObj),$scope.nodeObjLabels.name=i18n.i18nString("new_webhook")),$scope.nodeObj.type=nodeType,$scope.nodeObjLabels.isFirstNode=!1,$scope.nodeObjLabels.nameLabel=$scope._constants_.flowtasks.label,"intent"===nodeType?($scope.nodeObjLabels.nameSubLabel="",$scope.nodeObjLabels.namePlaceholder=i18n.i18nString("create_lead")):"message"===nodeType?($scope.nodeObjLabels.nameSubLabel="",$scope.nodeObjLabels.namePlaceholder=i18n.i18nString("msg_place")):($scope.nodeObjLabels.nameSubLabel="",$scope.nodeObjLabels.namePlaceholder=i18n.i18nString("special_char"))}function openPreviewModal(nodeType,isFirstNode){initializeNodeModal(nodeType),$scope.nodeObjLabels.isFirstNode=!0,$timeout(function(){$scope.nodeObj.isInvalid=!0},350)}$scope.footerInfoTitle=i18n.i18nString("footer_info_title"),$scope.footerHeaderId="dialogForm",$scope.footerPanelId="dialogFormPanel",$scope.creating=i18n.i18nString("creating"),$scope.savingLabel=i18n.i18nString("saving"),$scope.proceed=i18n.i18nString("proceed"),$scope.intent=i18n.i18nString("configurable_intent_name"),$scope.create=i18n.i18nString("account_create"),$scope.caretIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/caretDown.svg",$scope.arrowAngle=window.appConfig.CONTEXT_PATH+"/assets/icons/arrowAngle.svg",$scope.closeIconDark=$scope.assetsBase+"icons/closeIconDark.svg",$scope.upgradeFlowBig=env_conf["context-url"]+"/img/upgrade-dialog-big.png",$scope.orIcon=$scope.assetsBase+"icons/orIcon.svg",$scope.minusCircle=$scope.assetsBase+"icons/minus-circle.svg",$scope.betaNew=$scope.assetsBase+"icons-new/beta/beta-new.svg",$scope.dialogCreation=env_conf["context-url"]+"/assets/dialog-creation/bialog-creation.gif",$scope.brokenImageSmall=env_conf["context-url"]+"/assets/images/brokenImageSmall.png",$scope.communication=env_conf["context-url"]+"/assets/dialog-creation/communication.svg",$scope.compare=env_conf["context-url"]+"/assets/dialog-creation/compare.svg",$scope.peopleWorkingTogether=env_conf["context-url"]+"/assets/dialog-creation/people_working_together.svg",$scope.nameDescription=i18n.i18nString("name_desc"),$scope.assetsPath=env_conf["context-url"],$scope.license={},$scope.notificationEnabled=!1,$scope.saveInProgress=!1,$scope.savingdialog=!1,$scope.conversationalBuilder=$scope.helpGuideOptions&&$scope.helpGuideOptions.showTaskCreation||$scope.rightPanel&&$scope.rightPanel.innerRightPanel&&"storyboard"===$scope.rightPanel.innerRightPanel.view?!0:!0,$scope.duplicateUtterance=!1;var _selectedStream=$workflowService.selectedStream();_selectedStream&&"solution"===_selectedStream.type&&($scope.conversationalBuilder=!1),$scope.streamData=_selectedStream;var _selectedLanguage=$workflowService.currentLanguage(),_connectionColors=["#299d8e","#5ea8d3","#e9c369","#f3a261","#533a71","#6183d8","#50c5b7","#7ac74f","#1c77c3","#9f86c0"];$scope.minDialog=!1,$scope.toggleDialogBanner=function(){$scope.minDialog=!$scope.minDialog},$scope.newDialogUtterance="",$scope.newDialogUtterences=[],$scope.manageContext={preConditions:[],contextTags:[]},$scope.intentNodeType={},$scope.intentNodeType.isHidden=!1,$scope.intentNodeType.isFollowUp=!1;var dummyConnectionCount=0;$scope.deleteUtterance=function(index){$scope.newDialogUtterences.splice(index,1),NotificationService.notify(i18n.i18nString("utterance_deleted"),"success")},$scope.addUtterance=function(event,newDialogUtterance){if(event&&13==event.keyCode){if(newDialogUtterance&&newDialogUtterance.trim()){if($scope.newDialogUtterences.indexOf(newDialogUtterance)>-1)return void($scope.duplicateUtterance=!0);$scope.newDialogUtterences.push(newDialogUtterance),$scope.newDialogUtterance=""}}else $scope.duplicateUtterance=!1},$scope.proceedCreateDialog=function(type){return $scope.conversationalBuilder&&$util.isIE11OrEarlier()?($util.showUnSupportedBrowserWarningForDialog(),$scope.closeDialogCreation(),!1):("new"===type?($scope.conversationalBuilder=!0,$scope.closeupgadeToNewDialog(),$scope.onNodeSave()):"old"===type||"solution"===$scope.streamData.type?($scope.conversationalBuilder=!1,$scope.closeupgadeToNewDialog(),$scope.onNodeSave()):$scope.conversationalBuilder?$scope.onNodeSave():$scope.onNodeSave(),void $scope.$emit("updateChecklist","dialogTasks"))},$scope.upgadeToNewDialog=function(){$("#createNewDialog").modal("show")},$scope.closeupgadeToNewDialog=function(){$("#createNewDialog").modal("hide")},$scope.dilogTypeselect=function(type){"followUp"===type?($scope.intentNodeType.isFollowUp=$scope.intentNodeType.isFollowUp?!1:!0,$scope.intentNodeType.isHidden=!1):"hidden"!==type||$scope.intentNodeType.isFollowUp||($scope.intentNodeType.isHidden=$scope.intentNodeType.isHidden?!1:!0)},$scope.toggleLearnMore=function(){$("body").off("click").on("click",function(){$scope.showLeadrnMore=!1}),$scope.showLeadrnMore=!$scope.showLeadrnMore},$scope.onInputKeyup=function(e,type,field){var _this=$(e.currentTarget);"intent"!==type&&"prompt"!==field&&-1!==_this.val().indexOf(" ")&&_this.val(_this.val().replace(/\s/g,"")),"intent"===type&&(_this=$(e.currentTarget),_selectedLanguage&&"en"===_selectedLanguage&&(_this.val(_this.val().replace(/[^a-zA-Z- 0-9]+/g,"")),$scope.nodeObj.name=_this.val())),$scope.onCheckLength(e),$scope.checkCreateNodeFormDirty()},$scope.onCheckLength=function(e){var _this=$(e.currentTarget);_this&&_this.val().length>256&&_this.val(_this.val().substr(0,256))},$scope.checkCreateNodeFormDirty=function(){if($scope.nodeObj.requiredFields&&$scope.nodeObj.requiredFields.length>0){var isValid=!0;return $.each($scope.nodeObj.requiredFields,function(k,field){return"custom"!==$scope.nodeObj.serviceNodeType&&"serviceType"===field||$scope.nodeObj[field]&&0!==$scope.nodeObj[field].length?void 0:($scope.nodeObj.isInvalid=!0,isValid=!1,!1)}),isValid?void($scope.nodeObj.isInvalid=!1):void 0}};var count=0;$scope.cloneDialog=function(callback,dialog){if($scope.nodeObj.requiredFields&&$scope.nodeObj.requiredFields.length>0){var isValid=!0;if($.each($scope.nodeObj.requiredFields,function(k,field){return"service"===$scope.nodeObj.type&&"custom"!==$scope.nodeObj.serviceNodeType&&"serviceType"===field||0!==$scope.nodeObj[field].length?void 0:($scope.nodeObj.isInvalid=!0,isValid=!1,!1)}),!isValid)return}if(!$scope.saveInProgress){$scope.saveInProgress=!0,$element.find("#flowtask_node_Begin .btnSave").addClass("disabled").text("Creating...");var payload={name:($scope.nodeObj.name||"").trim().replace(/\s\s+/g," "),preConditions:$scope.manageContext.preConditions,desc:$scope.nodeObj.desc,isFollowUp:$scope.intentNodeType.isFollowUp,isHidden:$scope.intentNodeType.isHidden,contextTags:$scope.manageContext.contextTags};BTFlowtaskService.cloneDialogTask($workflowService.selectedStream()._id,dialog._id,payload).then(function(res){$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id).then(function(res){$scope.saveInProgress=!1,callback&&(callback(),NotificationService.notify(i18n.i18nString("dialog_clone_success"),"success"))})},function(err){$scope.saveInProgress=!1,err&&err.data&&err.data.errors&&err.data.errors.length&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("dialog_clone_failed"),"error")})}},$scope.callbacks&&($scope.callbacks.cloneDialog=$scope.cloneDialog),$scope.expandMoreOps=function(){setTimeout(function(){scrollToEle()},400)},$scope.onNodeSave=function(){function createDialog(uId,componentRes){var _params={name:($scope.nodeObj.name||"").trim().replace(/\s\s+/g," "),shortDesc:$scope.nodeObj.desc},_transitions=[];_transitions.push({"default":"",metadata:{color:_connectionColors[0],connId:"dummy"+dummyConnectionCount}});var newMeta={left:750,top:100},sceneMetadata={description:_params.shortDesc,name:_params.name,status:"In Progress",startDialogConversation:!0},dialogNodePayload={nodeId:uId,type:componentRes.type,componentId:componentRes._id,transitions:_transitions,metadata:{left:30,top:120},nodeOptions:{contextTags:$scope.manageContext.contextTags}};$scope.conversationalBuilder&&(dialogNodePayload.positionMeta=newMeta,_params.sceneMetadata=sceneMetadata),dummyConnectionCount++,componentRes&&componentRes._id&&(_params.nodes=[],_params.nodes.push(dialogNodePayload)),_params.visibility={namespace:"private",namespaceIds:[""]},"intent"==componentRes.type&&($scope.intentNodeType.isFollowUp?(_params.isFollowUp=!0,_params.isHidden=!1):$scope.intentNodeType.isHidden?(_params.isHidden=!0,_params.isFollowUp=!1):(_params.isFollowUp=!1,_params.isHidden=!1),_params.interruptOptions={priority:"bot"}),BTFlowtaskService.createFlowtask(_selectedStream._id,_params).then(function(res){_dialogObj=res&&res.data,$scope.flowtaskObj=res&&res.data;var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:_params.name,DialogVersion:$scope.conversationalBuilder?"V2":"V1",Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"New dialog task is created using the old Dialog Builder"},eventMessage="New Dialog Created using V1";$scope.conversationalBuilder&&(eventMessage="New Dialog Created using V2",dialogData["Event Description"]="New dialog task is created using the Conversation driven Dialog Builder"),mixPanel.postEvent(eventMessage,dialogData);var dialogInitiateEvent={streamId:_selectedStream._id,BotName:_selectedStream.name,"Dialog Name":_params.name,"Dialog Version":$scope.conversationalBuilder?"V2":"V1",Category:"Engagement L1","Sub Category":"Conversation - Dialog Task","Event Description":"New dialog task is created using the old Dialog Builder",Level:"Engagement L1","Dialog source":"Create"};mixPanel.postEvent("Conversation - Initiate Dialog Task",dialogInitiateEvent);var _intentEventPayload={streamId:_selectedStream._id,BotName:_selectedStream.name,"Dialog Name":_params.name,"Dialog Version":$scope.conversationalBuilder?"V2":"V1",Category:"Engagement L2","Sub Category":"Conversation - Dialog Task","Event Description":"New dialog task is created using the old Dialog Builder",Level:"Engagement L2","Primary Intent creation mode":"Dialog Task"};mixPanel.postEvent("Conversation - Dialog Primary Intent Created",_intentEventPayload),$scope.newDialogUtterences&&$scope.newDialogUtterences.length?($scope.conversationalBuilder?(eventMessage="New Dialog Created using V2 with Training Data",dialogData["Event Description"]="New dialog task was created in V2 by providing one or more utterances"):(eventMessage="New Dialog Created using V1 with Training Data",dialogData["Event Description"]="New dialog task was created in V1 by providing one or more utterances"),mixPanel.postEvent(eventMessage,dialogData)):($scope.conversationalBuilder?(eventMessage="New Dialog Created using V2 without Training Data",dialogData["Event Description"]="New dialog task was created in V2 where user has not provided any training utterances in this page"):(eventMessage="New Dialog Created using V1 without Training Data",dialogData["Event Description"]="New dialog task was created in V1 where user has not provided any training utterances in this page"),mixPanel.postEvent(eventMessage,dialogData)),$workflowService.flowtaskInfo(res.data);var _dialogTasks=$workflowService.dialogTasks()||[];if(_dialogTasks.push(res.data),$workflowService.dialogTasks(_dialogTasks),"intent"===componentRes.type){var _payload={name:(componentRes.name||"").trim().replace(/\s\s+/g," "),dialogId:_dialogObj._id};$scope.streamId=_selectedStream._id,BTFlowtaskService.updateComponent($scope.streamId,componentRes._id,_payload).then(function(res){$scope.newDialogUtterences&&$scope.newDialogUtterences.length&&createUtterances(componentRes),$scope.closeDialogCreation&&$scope.closeDialogCreation(),console.log("res"),$scope.flowtaskObj.taskType="flowTask",$scope.flowtaskObj.newDialog="true",$workflowService.taskEditInfo($scope.flowtaskObj),$workflowService.taskMode("edit"),$scope.closeHelpModal&&$scope.closeHelpModal(),$scope.fullModalCallback.openFullPageModal(3),$scope.$emit("updateStep",3,"",!0),$rootScope.$emit("updateGlobalWorkProgress",!1),$timeout(function(){$rootScope.$emit("updateEditTask",!0)})},function(err){NotificationService.notify(i18n.i18nString("component_failed"),"error")})}},function(error){if(_dialogObj={},$scope.saveInProgress=!1,$scope.savingdialog=!1,$rootScope.$emit("updateGlobalWorkProgress",!1),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$element.find("#flowtask_node_Begin .btnSave").removeClass("disabled").text("Create")})}function createComponent(){var _params=$.extend(!0,{},$scope.nodeObj);$scope._tempMessageParams={},delete _params.requiredFields,delete _params.isInvalid,"intent"===_params.type?(_params.intent=(_params.name||"").trim().replace(/\s\s+/g," "),_params.preConditions=$scope.manageContext.preConditions,delete _params.name):("entity"===_params.type||"dialogAct"===_params.type||"message"===_params.type)&&(_params.message=[],_params.message.push({channel:"default",text:_params.prompt,type:"basic"}),$scope._tempMessageParams.message=_params.message,delete _params.prompt),"entity"===_params.type&&(_params.entityType=_params.nodeType,_params.errorMessage=[{text:angular.copy(errorMessages[_params.entityType]||" "),type:"basic",channel:"default"}],$scope._tempMessageParams.errorMessage=_params.errorMessage,delete _params.nodeType),delete _params.uId,BTFlowtaskService.createComponent(_selectedStream._id,_params).then(function(res){var _res=res&&res.data;$scope.nodeObj.uId=_res.type+count,_res.uId=$scope.nodeObj.uId,_res.nodeId=$scope.nodeObj.uId,createDialog($scope.nodeObj.uId,_res)},function(error){if($scope.saveInProgress=!1,$scope.savingdialog=!1,$rootScope.$emit("updateGlobalWorkProgress",!1),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$element.find("#flowtask_node_Begin .btnSave").removeClass("disabled").text("Create")})}if($scope.savingdialog=!0,$scope.nodeObj.requiredFields&&$scope.nodeObj.requiredFields.length>0){var isValid=!0;if($.each($scope.nodeObj.requiredFields,function(k,field){return"service"===$scope.nodeObj.type&&"custom"!==$scope.nodeObj.serviceNodeType&&"serviceType"===field||0!==$scope.nodeObj[field].length?void 0:($scope.nodeObj.isInvalid=!0,isValid=!1,!1)}),!isValid)return}$scope.saveInProgress||($scope.saveInProgress=!0,$rootScope.$emit("updateGlobalWorkProgress",!0),"service"===$scope.nodeObj.type&&"custom"!==$scope.nodeObj.serviceNodeType&&($scope.nodeObj.serviceType="rest"),$element.find("#flowtask_node_Begin .btnSave").addClass("disabled").text("Creating..."),createComponent())};var _intentObj={name:"",desc:"",requiredFields:["name"]};$scope.getSentenceCase=function(value){return _selectedStream.defaultLanguage&&"en"!==_selectedStream.defaultLanguage?value:$filter("sentence_case")(value)},$scope.toggleConversationBuilder=function(params){$scope.conversationalBuilder=$scope.conversationalBuilder?!1:!0},$scope.validateTaskName=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression("dialog");return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,{test:function(value){return _selectedLanguage&&"en"!==_selectedLanguage?regexp2.test(value):regexp.test(value)}}}(),setTimeout(function(){$(".dialogScrollBody").scrollTop(1)},200),openPreviewModal("intent",!0),$scope.getLicenseInfo=function(){$scope.selectedStream&&$scope.selectedStream.license&&($scope.license=$scope.selectedStream.license,$scope.license&&"small"===$scope.license.planId&&($scope.notificationEnabled=!0))},$scope.getLicenseInfo(),$scope.closeNotification=function(){$scope.notificationEnabled=!1}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("flowtaskForm",function(){return{restrict:"EAQ",scope:{onComplete:"&",wfType:"@",displayMode:"@",configure:"&",callBack:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/flowtask-form/flowtask-form.html",controller:["$window","$scope","patternFactory","$element","env_conf","$timeout","$rootScope","$location","$filter","$routeParams","NotificationService","$workflowService","BTFlowtaskService","BTStreamsService","$modal","$sanitize","accessControlService","$applicationService","i18n","$q","channelsConfig","defaultValue","$sce","jsEvents","mixPanel","$util","navigator",function($window,$scope,patternFactory,$element,env_conf,$timeout,$rootScope,$location,$filter,$routeParams,NotificationService,$workflowService,BTFlowtaskService,BTStreamsService,$modal,$sanitize,accessControlService,$applicationService,i18n,$q,channelsConfig,defaultValue,$sce,jsEvents,mixPanel,$util,navigator){function scrollToNode(nodeId,completeFn){var _container=$("flowtask-form .flowTaskForm .flowTaskConnectionBlock.ps-container"),_ele=_container.find('.dragEleConn[data-id="'+nodeId+'"]'),_x_disp=_container.width()/2,_y_disp=_container.height()/2;$timeout(function(){_container.animate({scrollLeft:_ele.offset().left+150-_container.offset().left+_container.scrollLeft()-_x_disp,scrollTop:_ele.offset().top+_ele.height()/2-_container.offset().top+_container.scrollTop()-_y_disp},function(){completeFn&&completeFn();var _selectedNode=_ele.closest(".draggableEle");_selectedNode&&(_selectedNode.addClass("highlight-glow"),$timeout(function(){_selectedNode.removeClass("highlight-glow")},3e3))})},500)}function updateDialogEntities(){$scope.dialogEntities=_.filter(_botComponents,{type:"entity"})}function getComponents(){BTFlowtaskService.getComponents(_selectedStream._id).then(function(res){_botComponents=res&&res.data,updateDialogEntities()},function(error){_botComponents="error"})}function fetchBotComponentsByType(type,callback){var requests=[];requests.push(BTFlowtaskService.getComponentsByType(_selectedStream._id,type,"true")),"form"===type&&requests.push(BTStreamsService.getBotUiForms(_selectedStream._id,!0)),$q.all(requests).then(function(res){_botComponents=[];var compRes=res[0],formCompRes=res[1];compRes&&compRes.data&&compRes.data.length>0?($.each(compRes.data,function(k,comp){"configured"===comp.status&&_botComponents.push(comp)}),updateDialogEntities(),$timeout(function(){callback(),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings()},100)):$scope.nodeObjListLoading=!1,formCompRes&&formCompRes.data&&formCompRes.data.length?$scope.formTasks=formCompRes.data:$scope.formTasks=[]},function(error){if(error=error[0],_botComponents=[],$scope.nodeObjListLoading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("fetch_error"),"error")})}function intialize(){_objList=[],_objConnection=[],count=0,dummyConnectionCount=0,$scope.saveNodeInProgress=!1,_dialogObj={},_currentSourceNode="",_dummyConnectionId="",$scope.runBot.show=!0,$scope.objList={},$scope.firstNodeUId="",$scope.selectedNode="",$scope.selectedGroup="",$scope.isPropertyPanelOpened=!1,$scope.isDebugConsolePanelOpened=!1,$scope.nodeObjList=[],$scope.nodeObj={},$scope.nodeObjLabels={},resetFlag&&($scope.introObj={screenshots:[]},$scope.introObj.needsAuth=!1),$("body").addClass("displayTalkTo"),$scope.streamId=_selectedStream._id,"edit"===$scope.displayMode||"view"===$scope.displayMode||$scope.doneImporting?(setDataForEdit(),$timeout(function(){$element.find(".flowTaskPropertyPanel").draggable({start:function(e,ui){$(".flowTaskPropertyPanel ").hasClass("minimized")&&e.preventDefault()},handle:".property-panel-header",containment:".dialogFieldset",stop:onPanelDragStop}).resizable({containment:".dialogFieldset",minWidth:500,maxWidth:Math.floor(.6*_flowTaskConnectionBlock.width()),handles:"e, w",resize:function(event,ui){var _minimized=ui.size.width<800,_ele=$(event.target).find(".toggleDebugConsolePanelSize");_ele&&(_ele.toggleClass("fa-compress",!_minimized),_ele.toggleClass("fa-expand",_minimized))}}),$element.find(".flowTaskPropertyPanel").css("top","5px").css("right","5px").css("left","auto")}),$timeout(function(){$element.find(".flowTaskDebugConsolePanel").draggable({handle:".nav.nav-tabs",containment:"document",cancel:".minimized"}).resizable({containment:"document",minWidth:430,maxWidth:800,minHeight:400,handles:"e, s, se",stop:onDebugResizeStop})})):($scope.flowtaskObj={name:""},$timeout(function(){openPreviewModal("intent",!0),$element.find(".flowTaskPropertyPanel").draggable({handle:".property-panel-header",containment:".dialogFieldset",stop:onPanelDragStop}).resizable({containment:".dialogFieldset",minWidth:500,maxWidth:700,handles:"e, w"}),$element.find(".flowTaskPropertyPanel").css("top","5px").css("right","5px").css("left","auto")}),$timeout(function(){$element.find(".flowTaskDebugConsolePanel").draggable({handle:".debug-console-panel-header",containment:"document"}).resizable({containment:"document",minWidth:400,maxWidth:800,minHeight:400,handles:"e, s, se",stop:onDebugResizeStop})}))}function updateContextDialogInfo(){$scope.availableNodesNames={nodes:[],entities:[],mappedIntents:[]},$.each(_objList,function(k,obj){"intent"===obj.type&&$scope.firstNodeComponentId!==obj._id?$scope.availableNodesNames.mappedIntents.push(obj.name):"entity"===obj.type?$scope.availableNodesNames.entities.push(obj.name):$scope.availableNodesNames.nodes.push(obj.name)}),$scope.availableNodesNames.mappedIntents=_.uniq($scope.availableNodesNames.mappedIntents),$scope.availableNodesNames.entities=_.uniq($scope.availableNodesNames.entities),$scope.availableNodesNames.nodes=_.uniq($scope.availableNodesNames.nodes),$workflowService.dialogNodesNames($scope.availableNodesNames),$scope.propertyCb.parentTaskContextdata=$scope.availableNodesNames}function fetchServiceNodes(){var filteredServiceNodeArray=[];if($scope.conversationBuilder){var list=Object.values(_objList);filteredServiceNodeArray=list.filter(function(_node){return("service"===_node.type||"entity"===_node.type&&"list_of_items_lookup"===_node.entityType)&&_node.sampleResponse&&_node.sampleResponse.length})}else filteredServiceNodeArray=_objList.filter(function(_node){return("service"===_node.type||"entity"===_node.type&&"list_of_items_lookup"===_node.entityType)&&_node.sampleResponse&&_node.sampleResponse.length});filteredServiceNodeArray=_.uniq(filteredServiceNodeArray,function(item,key,a){return item._id});var _data={nodes:filteredServiceNodeArray,dialogId:_dialogObj._id};$timeout(function(){$scope.runbotConfigCb&&$scope.runbotConfigCb.updateServiceNodes&&$scope.runbotConfigCb.updateServiceNodes(_data)},350)}function mixPanelUpdateEvent(componentData,dialog){componentData=componentData||{},dialog=dialog||{};var _eventPayload={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,"Dialog Name":dialog.name,"Component Name":componentData.intent||componentData.name,"Dialog Version":"V2",Category:"Engagement L2","Sub Category":"Conversation - Dialog Task",Level:"Engagement L2","Primary Intent creation mode":"Storyboard"},event="";"intent"===componentData.type?event="Conversation - Dialog Intent updated":"message"===componentData.type?event="Conversation - Dialog Message Node updated":"entity"===componentData.type?event="Conversation - Dialog Entity Node updated":"dialogAct"===componentData.type?event="Conversation - Dialog Confirmation Node updated":"service"===componentData.type?event="Conversation - Bot action Service updated":"script"===componentData.type?event="Conversation - Bot action Script updated":"logic"===componentData.type?event="Conversation - Bot action Logic updated":"SDKWebHook"===componentData.type?event="Conversation - Bot action Webhook updated":"process"===componentData.type?event="Conversation - Bot action Process updated":"agentTransfer"===componentData.type?event="Conversation - Agent Transfer node updated":"form"===componentData.type?event="Conversation - Form node updated":"botAction"===componentData.type&&(event="componentData - Bot action Node updated"),event&&mixPanel.postEvent(event,_eventPayload)}function getUtterances(dialogObjId,componentId){dialogObjId&&componentId&&BTStreamsService.getUtterances(componentId,$scope.utterences.length,10,"").then(function(res){$timeout(function(){$scope.propertyCb.updateUtterance&&$scope.propertyCb.updateUtterance(res)},100)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("getting_utterance"),"error")})}function getdummyId(nodes){var x=[],t=_.pluck(nodes,"transitions"),dummID="fallbackID"+t.length;if(t.length){
t.forEach(function(tr){x=x.concat(tr)});var _dumArr=_.pluck(x,"metadata.connId")||[];if(_dumArr.sort(),_dumArr.length){var highStr=_dumArr[_dumArr.length-1],_no=+highStr.substring(5,highStr.length);return _no++,"dummy"+_no}return dummID}return dummID}function prepareDisplayOptions(){if(_dialogObj&&_dialogObj.displayOption){try{var _disOpts=JSON.parse(_dialogObj.displayOption);$scope.displayOpts=angular.extend({},$scope.displayOpts,_disOpts)}catch(e){$scope.displayOpts={hideType:!1,hideNode:!1,hideConn:!1}}$scope.displayOpts.hideType&&$element.find(".flowTaskConnectionBlock").addClass("hideType"),$scope.displayOpts.hideNode&&$element.find(".flowTaskConnectionBlock").addClass("hideNode"),$scope.displayOpts.hideConn&&$element.find(".flowTaskConnectionBlock").addClass("hideConn")}}function setDataForEdit(){var loader=NotificationService.loader(i18n.i18nString("fetching_nodes"));_dialogObj=$workflowService.flowtaskInfo(),prepareDisplayOptions(),_dialogObj.nodes&&_dialogObj.nodes.length>0&&($scope.firstNodeUId=_dialogObj.nodes[0].nodeId,$scope.firstNodeComponentId=_dialogObj.nodes[0].componentId,BTFlowtaskService.getFlowtaskComponents(_selectedStream._id,_dialogObj._id).then(function(res){if(res){for(var i=0;i<res.data.length;i++)res.data[i].desc&&(res.data[i].desc=res.data[i].desc.replace(/&gt;/g,">").replace(/&lt;/g,"<"));$workflowService.selectedDialogComponents(res.data)}var _res=res&&res.data||[],_tempComponents={},_tempComponentObj={};$.each(_res,function(k,component){_tempComponents[component._id]=component}),$scope.nodeObjCount={},_dialogObj.nodes=_.uniq(_dialogObj.nodes,"nodeId"),$.each(_dialogObj.nodes,function(k,node){if($scope.prepareComponentCount(node),_tempComponentObj[node.componentId]||(_tempComponentObj[node.componentId]={count:0},_tempComponentObj[node.componentId][node.nodeId]=_tempComponentObj[node.componentId].count),_tempComponentObj[node.componentId].count=_tempComponentObj[node.componentId].count+1,_tempComponentObj[node.componentId][node.nodeId]=_tempComponentObj[node.componentId].count,"dialogAct"===node.type){var _noTransision=_.find(node.transitions,function(tr){return tr["if"]&&"no"===tr["if"].dialogAct});_noTransision||(node.transitions[1].metadata.color=_connectionColors[2],node.transitions.splice(1,0,{"if":{dialogAct:"no"},then:"",metadata:{color:_connectionColors[1],connId:getdummyId(_dialogObj.nodes)}}))}var _tempNodeObj=_tempComponents[node.componentId];if(_tempNodeObj&&_tempNodeObj.name){if($scope.objList[node.nodeId]=$.extend(!0,{},_nodeObj,{type:_tempNodeObj.type,name:_tempNodeObj.name,uId:node.nodeId,desc:_tempNodeObj.desc,metadata:node.metadata,componentId:_tempNodeObj._id,nodeOptions:node.nodeOptions}),"entity"===_tempNodeObj.type){var entityType=_.find($scope._constants_.entityNlp,{value:_tempNodeObj.entityType});"company_name"===entityType.value&&(entityType.title="Company/Org Name"),$scope.objList[node.nodeId].entityType=entityType.title,$scope.objList[node.nodeId].nodeOptions&&$scope.objList[node.nodeId].nodeOptions.eventOptions?$scope.objList[node.nodeId].nodeOptions.eventOptions.defaultMaxRetry=$scope.objList[node.nodeId].nodeOptions.eventOptions.defaultMaxRetry:($scope.objList[node.nodeId].nodeOptions.eventOptions={},$scope.objList[node.nodeId].nodeOptions.eventOptions.defaultMaxRetry=$workflowService.cloneData($scope.defaultMaxRetry))}if("intent"===_tempNodeObj.type){if($scope.objList[node.nodeId].flowTaskId=node.flowTaskId,$scope.objList[node.nodeId].intent=_tempNodeObj.intent,node.contextMap)if(node.contextMap.constructor===String)try{$scope.objList[node.nodeId].contextMap=JSON.parse(node.contextMap)}catch(e){$scope.objList[node.nodeId].contextMap={}}else $scope.objList[node.nodeId].contextMap=node.contextMap;if(node.postContextMap)if(node.postContextMap.constructor===String)try{$scope.objList[node.nodeId].postContextMap=JSON.parse(node.postContextMap)}catch(e){$scope.objList[node.nodeId].postContextMap={}}else $scope.objList[node.nodeId].postContextMap=node.postContextMap}if("process"===_tempNodeObj.type&&($scope.objList[node.nodeId].resourceId=_tempNodeObj.resourceId),$scope.objList[node.nodeId].nodeTypeName=$scope.configurableElements[_tempNodeObj.type]?$scope.configurableElements[_tempNodeObj.type].name:"unknown",node.transitions&&node.transitions.length>0){var connectionNum=1;$.each(node.transitions,function(l,transition){var _tempConnId=transition.metadata&&transition.metadata.connId?transition.metadata.connId:"dummy"+dummyConnectionCount;dummyConnectionCount++;var _tempConnObj={connId:_tempConnId,sourceId:node.nodeId,targetId:void 0!==transition["default"]?transition["default"]:transition.then,isDefault:void 0!==transition["default"]?!0:!1};transition["if"]=transition["if"]||{},transition["if"].hasOwnProperty("context")&&(transition.metadata.hasOwnProperty("intent")?(_tempConnObj.ifConditionPrefix="intent",_tempConnObj.intentType="followup"):(_tempConnObj.ifConditionPrefix="context",_tempConnObj.ifCondition=transition["if"].context||""),_tempConnObj.ifOperator=transition["if"].op||"",_tempConnObj.value=transition["if"].value||""),transition["if"].hasOwnProperty("intent")&&(_tempConnObj.ifConditionPrefix="intent",_tempConnObj.intentType="userinput",_tempConnObj.ifCondition=transition["if"].intent||"",_tempConnObj.ifOperator=transition["if"].op||"",_tempConnObj.value=transition["if"].value||""),transition["if"].hasOwnProperty("conjoin")&&(_tempConnObj.conjoin=transition["if"].conjoin,_tempConnObj.tests=transition["if"].tests),"dialogAct"===node.type&&transition["if"]&&transition["if"].dialogAct?(_tempConnObj.ifConditionPrefix="dialogAct",_tempConnObj.ifOperator="",_tempConnObj.value="",_tempConnObj.isDefault?delete transition["if"]:transition["if"]&&(_tempConnObj.ifCondition=transition["if"].dialogAct,transition["if"].hasOwnProperty("context")&&(_tempConnObj.ifConditionPrefix="context",_tempConnObj.ifCondition=transition["if"].context||"",_tempConnObj.ifOperator=transition["if"].op||"",_tempConnObj.value=transition["if"].value||""))):void 0!==transition["default"]?(_tempConnObj.ifCondition="",_tempConnObj.ifOperator="",_tempConnObj.value="",delete transition["if"]):(void 0!==transition["if"].field?(_tempConnObj.ifConditionPrefix="field",_tempConnObj.ifCondition=transition["if"].field||""):transition["if"].hasOwnProperty("context")&&(transition.metadata.hasOwnProperty("intent")?(_tempConnObj.ifConditionPrefix="intent",_tempConnObj.intentType="followup"):_tempConnObj.ifConditionPrefix="context",_tempConnObj.ifCondition=transition["if"].context||"",_tempConnObj.ifOperator=transition["if"].op||"",_tempConnObj.value=transition["if"].value||""),_tempConnObj.ifOperator=transition["if"].op||"",_tempConnObj.value=transition["if"].value||""),transition.metadata&&transition.metadata.color?_tempConnObj.color=transition.metadata.color:(_tempConnObj.color=_connectionColors[l>0?l:0],transition.metadata?_dialogObj.nodes[k].transitions[l].metadata.color=_tempConnObj.color:_dialogObj.nodes[k].transitions[l].metadata={color:_tempConnObj.color}),$scope.objList[node.nodeId].connections[_tempConnId]=$.extend(!0,{},_connObj,_tempConnObj),_tempConnObj.connObjNumber=connectionNum,_objConnection.push($.extend(!0,{},_connObj,_tempConnObj)),connectionNum++;var _tempConn=_tempConnId.replace("dummy","");isNaN(_tempConn)||parseInt(_tempConn)>dummyConnectionCount&&(dummyConnectionCount=parseInt(_tempConn)+5)})}_objList.push($.extend({},_tempNodeObj,{nodeId:node.nodeId}))}var _nodeNumber=node.nodeId.replace(node.type,"");$scope.objList[node.nodeId]&&($scope.objList[node.nodeId].nodeNumber=parseInt(_nodeNumber)+1),isNaN(_nodeNumber)||parseInt(_nodeNumber)>count&&(count=parseInt(_nodeNumber))}),count++,loader(),rearrangeNodesOnUI(),updateConectionWarnings(),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings()},function(error){if(loader(),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("some_error_occured"),"error");$scope.exit()})),$scope.groups=$workflowService.cloneData(_dialogObj.groups||[])}function rearrangeNodesOnUI(){var _left=30,_top=170,loader=NotificationService.loader(i18n.i18nString("creating_node"));$timeout(function(){var _extremeLeft=0,_extremeTop=0,_extremeTopHeight=0;$.each($scope.objList,function(k,obj){if(obj){$scope.objListSearch.push({key:obj.uId,val:obj.name}),$scope.objList[k].hide=!1;var _parent=$element.find('[data-id="'+obj.uId+'"]').parents(".draggableEle");$scope.objList[k].metadata&&(_top=$scope.objList[k].metadata.top||0,_left=$scope.objList[k].metadata.left||0),_parent.css("top",_top).css("left",_left),_left=_left+parseInt(_parent.css("width"))+80,_parent.draggable({start:ondragStart,drag:ondragging,stop:ondragStop,stack:".draggableEle"}),obj.metadata&&obj.metadata.left&&obj.metadata.left>_extremeLeft&&(_extremeLeft=obj.metadata.left),obj.metadata&&obj.metadata.top&&obj.metadata.top>_extremeTop&&(_extremeTop=obj.metadata.top,$element.find('[data-id="'+obj.uId+'"]').length>0&&(_extremeTopHeight=$element.find('[data-id="'+obj.uId+'"]').height()))}}),correctPageScroll(_extremeTop,_extremeTopHeight,_extremeLeft,!1),createAllConnections(),rearrangeGroups(),makeNodesSelectable(),PerfectScrollbar.update($element.find(".flowTaskConnectionBlock")[0]),loader(),$scope.setZoombyDisplayOptions()},350)}function checkForAllowedNode(newNodes){var groupedNodes=[],allowed=!0;return $scope.groups.forEach(function(group){groupedNodes=groupedNodes.concat(group.nodes)}),newNodes.forEach(function(nodeId){groupedNodes.indexOf(nodeId)>-1&&(allowed=!1)}),allowed||NotificationService.notify("Cannot group the nodes which are already part of other group"),allowed}function makeNodesSelectable(){$element.find(".flowTaskConnectionBlock").selectable({filter:".kr-node",selected:function(event,ui){console.log("Selected")},selecting:function(event,ui){console.log("Selecting")},create:function(event,ui){console.log("create")},stop:function(event,ui){if(console.log("stop"),$scope.savingGroup)return!1;var newNodes=[];if($element.find(".ui-selected .dragEleConn").each(function(i,ele){newNodes.push($(ele).attr("data-id"))}),newNodes&&newNodes.length&&newNodes.length>=1&&checkForAllowedNode(newNodes)){var newGroup={name:"Group Name",nodes:newNodes,_id:getRandomGroupId(),isLocalObject:!0};$scope.groups.push(newGroup),saveGroupsToServer(),$timeout(function(){rearrangeGroups()},900)}$element.find(".flowTaskConnectionBlock").selectable("destroy"),makeNodesSelectable(),$(event.originalEvent.target).hasClass("flowTaskConnectionBlock")&&$element.find(".flowTaskConnectionBlock").trigger("click")}})}function saveGroupsToServer(deleteIntentScope){var groupsToSave=[],deleteIndex=-1,updatedGroupNode=null,newNode={};$scope.groups.forEach(function(group,indx){var _grp={nodes:group.nodes,name:group.name,subIntents:[]};group.subIntents&&group.subIntents.length&&group.subIntents.forEach(function(intent,i){intent&&intent.nodeId&&$scope.objList[intent.nodeId]&&_grp.subIntents.push(intent)}),group.subIntents=_grp.subIntents,$scope.selectedGroup&&$scope.selectedGroup._id===group._id&&(updatedGroupNode=group._id,$scope.selectedNode&&$scope.selectedNode.nodeInfo&&(newNode.intent=$scope.selectedNode.nodeInfo.intent,newNode.nodeId=$scope.selectedNode.nodeInfo.uId||$scope.selectedNode.nodeInfo.nodeId,$scope.selectedNode.nodeInfo.dialogRefId&&(newNode.refId=$scope.selectedNode.nodeInfo.dialogRefId,newNode.dialogId=$scope.selectedNode.nodeInfo.dialogId),!newNode||$scope.editGroupNodeInstance||deleteIntentScope||_grp.subIntents.push(newNode))),_grp&&_grp.subIntents&&deleteIntentScope&&deleteIntentScope.nodeId&&($.each(_grp.subIntents,function(i,int){deleteIntentScope.nodeId===int.nodeId&&(deleteIndex=i)}),deleteIndex>-1&&_grp.subIntents.splice(deleteIndex,1)),group.isLocalObject||(_grp._id=group._id),groupsToSave.push(_grp)});var _updateParams={groups:groupsToSave,name:_dialogObj.name,visibility:_dialogObj.visibility};BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_updateParams).then(function(res){if(console.log("Position Saved"),_dialogObj=res&&res.data,updatedGroupNode&&(res&&res.data&&res.data.groups&&res.data.groups.length&&res.data.groups.forEach(function(grp){grp._id===updatedGroupNode&&($scope.selectedGroup=grp)}),$scope.groups.forEach(function(grp,index){grp._id===updatedGroupNode&&(grp=$scope.selectedGroup)})),deleteIndex>-1&&(NotificationService.notify("Intent removed successfully","success"),$scope.removeTempIntnetNode(deleteIntentScope.nodeId)),$scope.groupNodeIntentsToDelete&&$scope.groupNodeIntentsToDelete.length){var deletedIntentId={};$.each($scope.groupNodeIntentsToDelete,function(i,node){deletedIntentId[node.nodeId]="deleted"}),$scope.removeTempIntnetNode(null,deletedIntentId)}$scope.closeGroupIntentModalSlider(!0)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function getRandomGroupId(){return(Math.floor(1e8*Math.random())+1).toString()}function rearrangeGroups(){var groupPading={top:45,right:60,bottom:30,left:25},_groups=$scope.groups;if(_groups&&_groups.length){var groups=_groups;groups.forEach(function(group){if(group.nodes&&group.nodes.length){var groupRect={offset:{left:-1,top:-1},width:-1,height:-1};group.nodes.forEach(function(node){var nodeEle=$element.find('.dragEleConn[data-id="'+node+'"]').closest(".draggableEle"),$nodeEle=$(nodeEle);if(!nodeEle.length)return!1;var nodeRect={offset:$nodeEle.offset(),width:$nodeEle.width(),height:$nodeEle.height()};console.log("nodeRect:"+JSON.stringify(nodeRect)),(-1===groupRect.height||nodeRect.offset.top+nodeRect.height>groupRect.height)&&(groupRect.height=nodeRect.offset.top+nodeRect.height),(-1===groupRect.width||nodeRect.offset.left+nodeRect.width>groupRect.width)&&(groupRect.width=nodeRect.offset.left+nodeRect.width),(-1===groupRect.offset.left||nodeRect.offset.left<groupRect.offset.left)&&(groupRect.offset.left=nodeRect.offset.left),(-1===groupRect.offset.top||nodeRect.offset.top<groupRect.offset.top)&&(groupRect.offset.top=nodeRect.offset.top)}),groupRect.height=groupRect.height-groupRect.offset.top,groupRect.width=groupRect.width-groupRect.offset.left;var groupEle=$element.find('.groups-wrp .group[data-group-id="'+group._id+'"]'),topBar=$(".flowTaskConnectionBlock").offset();groupRect.offset.top=groupRect.offset.top-topBar.top,groupRect.offset.left=groupRect.offset.left+$element.find(".flowTaskConnectionBlock").scrollLeft(),groupRect.offset.top=groupRect.offset.top+$element.find(".flowTaskConnectionBlock").scrollTop(),groupRect.offset.left=groupRect.offset.left-groupPading.left,groupRect.offset.top=groupRect.offset.top-groupPading.top,groupRect.height=groupRect.height+groupPading.top+groupPading.bottom,groupRect.width=groupRect.width+groupPading.left+groupPading.right,$(groupEle).css({left:groupRect.offset.left,top:groupRect.offset.top,height:groupRect.height,width:groupRect.width,opacity:1})}})}}function chechForConnectionCounts(){var connections=$("connection.line");if(connections&&connections.length)if($scope.displayOpts.hideConn){var nodes=Object.keys($scope.objList);nodes&&nodes.length&&$.each(nodes,function(i,node){var foundConnections=_.filter(connections,function(item){return $(item)&&$(item).hasClass(node)});foundConnections&&1===foundConnections.length?$(foundConnections).addClass("singleConnection"):$(foundConnections).removeClass("singleConnection")})}else $(connections).removeClass("singleConnection")}function createAllConnections(){if(_objConnection.length>0)for(var k=0;k<_objConnection.length;k++){var tempConnection=_objConnection[k],_source=$element.find('.draggableEle [data-id="'+tempConnection.sourceId+'"]'),_target=$element.find('.draggableEle [data-id="'+tempConnection.targetId+'"]');if(_source.length>0&&_target.length>0){var singleSource="";$(".line.source-"+tempConnection.sourceId).length||(singleSource=" singleConnection"),_source.connections({to:'.draggableEle [data-id="'+tempConnection.targetId+'"]',"class":"line source-"+tempConnection.sourceId+" "+tempConnection.sourceId+" target-"+tempConnection.targetId+singleSource,within:$element.find(".flowTaskConnectionBlock")[0],lineColor:tempConnection.color,connectionNum:tempConnection.connObjNumber})}else _objConnection.splice(k,1),k--,$scope.objList[tempConnection.sourceId].tempConnections[tempConnection.connId]=tempConnection;rearrangeConnectionsForObj(tempConnection.sourceId)}checkIfSingleComponent(),setTimeout(function(){chechForConnectionCounts()})}function checkIfSingleComponent(){1===Object.keys($scope.objList).length&&$scope.selectCurrentNode($scope.firstNodeUId)}function correctPageScroll(extremeTop,extremeTopHeight,extremeLeft,runExtremeCheck){extremeTop=extremeTop||0,extremeTopHeight=extremeTopHeight||0,extremeLeft=extremeLeft||0,runExtremeCheck&&$.each($scope.objList,function(k,obj){obj.metadata&&obj.metadata.left&&obj.metadata.left>extremeLeft&&(extremeLeft=obj.metadata.left),obj.metadata&&obj.metadata.top&&obj.metadata.top>extremeTop&&(extremeTop=obj.metadata.top,$element.find('[data-id="'+obj.uId+'"]').length>0&&(extremeTopHeight=$element.find('[data-id="'+obj.uId+'"]').height()))});var _virtualHeight=parseInt(extremeTop+extremeTopHeight+$(window).height()/2),_virtualWidth=parseInt(extremeLeft+300+400+$(window).width()/2);$element.find(".dummyBlockForScroll").css("left",_virtualWidth+"px").css("top",_virtualHeight+"px")}function createConnectionForType(_uId,_type,transitions){if(transitions&&transitions.length>0&&$scope.configurableElements[_type]){var _nodeObj={nodeTypeName:$scope.configurableElements[_type].name,connections:{},tempConnections:{}},_top=20,_hasTarget=!1;return $.each(transitions,function(k,connection){var _dummyVal=connection.metadata&&connection.metadata.connId?connection.metadata.connId:"dummy"+dummyConnectionCount;dummyConnectionCount++;var ifCondPre="context",ifCond="",ifOp="",_isDefault=!1;void 0===connection["default"]?"dialogAct"===_type?(ifCondPre="dialogAct",ifCond=connection["if"].dialogAct,ifOp="",connection["if"]&&connection["if"].hasOwnProperty("context")&&(ifCondPre="context",ifCond="")):"intent"===_type?(ifCondPre="intent",ifCond="",ifOp=""):"entity"===_type&&(ifCondPre="field",ifCond=$scope.objList[_uId].name.trim(),ifOp=""):("dialogAct"===_type&&(ifCondPre="dialogAct"),_isDefault=!0),_nodeObj.connections[_dummyVal]=$.extend(!0,{},_connObj,{connId:_dummyVal,sourceId:_uId,targetId:_isDefault?connection["default"]||"":connection.then||"",ifConditionPrefix:ifCondPre,ifCondition:ifCond,ifOperator:ifOp,value:"",isDefault:_isDefault,top:_top,color:connection.metadata&&connection.metadata.color?connection.metadata.color:"#0090dab",intentType:connection.intentType||"followup"}),_hasTarget=(_isDefault?connection["default"]||"":connection.then||"").length>0,_top+=30}),_hasTarget||(_nodeObj.tempConnections=$.extend(!0,{},_nodeObj.connections)),_nodeObj}return{connections:{},tempConnections:{}}}function createNodeEle(obj,transitions,isGroupNodeIntent){function makeEleDraggable(){$scope.objList[_objVal]&&$scope.objList[_objVal].hide&&($scope.objList[_objVal].hide=!1);var _conObj=$element.find('[data-id="'+_objVal+'"]').parents(".draggableEle");if(0===_conObj.length&&1>_eleCount)return _eleCount++,void $timeout(makeEleDraggable,100);var _vals,_top=170,_left=30;if($element.find('[data-id="'+_objVal+'"]').data("objheight",_conObj.css("height")),_currentSourceNode&&(_vals=$element.find('[data-id="'+_currentSourceNode+'"]')),_vals&&_vals.length>0&&(_vals=_vals.parents(".draggableEle"),_top=parseInt(_vals.css("top")),_left=parseInt(_vals.css("left"))+_vals.width()+80),$scope.selectedConnection){var _addInBetweenEle=$element.find(".connectionInfoPopover");_top=parseInt(_addInBetweenEle.css("top"))-_conObj.height()/2,_left=parseInt(_addInBetweenEle.css("left"))-_conObj.width()/2}_conObj.css("top",_top+"px").css("left",_left+"px");var _collisionDetected=!1,_iterationCount=100,_bottomChecked=!1,_rightChecked=!1,_startLeftCheck=!1,_initVals={top:_top,left:_left};if(!$scope.selectedConnection)for(;_iterationCount&&($.each($scope.objList,function(k,obj){return k!==_objVal&&checkCollisionDetection(_conObj,$element.find('[data-id="'+k+'"]').parents(".draggableEle"))?(_collisionDetected=!0,!1):void 0}),_iterationCount--,_collisionDetected);)_collisionDetected=!1,_bottomChecked&&_rightChecked&&!_startLeftCheck&&(_top=_initVals.top,_left=_initVals.left,_startLeftCheck=!0),_startLeftCheck?_left+=100:_bottomChecked?_rightChecked||(_rightChecked=!0,_top=_initVals.top,_left=parseInt(_vals.css("left"))-80-_vals.width(),0>_left&&(_left=0)):(_bottomChecked=!0,_top=_initVals.top+80+_vals.height(),_left=parseInt(_vals.css("left"))),_conObj.css("top",_top+"px").css("left",_left+"px");$scope.objList[_objVal].metadata={left:_left,top:_top},1!==$scope.zoomScale&&(_conObj.css("transform","scale("+$scope.zoomScale+")"),_conObj.css("transform-origin","0 0 0")),_conObj.draggable({start:ondragStart,drag:ondragging,stop:ondragStop,stack:".draggableEle"}),_currentSourceNode&&_currentSourceNode.length>0&&(_dummyConnectionId&&"object"==typeof _dummyConnectionId?addNewInBetweenConnections(_currentSourceNode,_objVal,_dummyConnectionId):addNewConnection(_currentSourceNode,_objVal,_dummyConnectionId),_currentSourceNode="",_dummyConnectionId="")}var _objVal=obj.uId?obj.uId:obj.type+count;$scope.objList[_objVal]=$.extend(!0,{},_nodeObj,{type:obj.type,name:obj.name,uId:_objVal,connections:{},hide:!0,desc:obj.desc,componentId:obj.componentId,nodeOptions:obj.nodeOptions});var _nodeNumber=_objVal.replace(obj.type,"");if($scope.objListSearch.push({key:_objVal,val:obj.name}),$scope.objList[_objVal].nodeNumber=1+parseInt(_nodeNumber),$scope.objList[_objVal]=$.extend(!0,$scope.objList[_objVal],createConnectionForType(_objVal,obj.type,transitions)),"intent"===obj.type&&($scope.objList[_objVal].intent=obj.intent||obj.name,obj.isSubDialog&&($scope.objList[_objVal].flowTaskId=obj.isSubDialog)),"entity"===obj.type){var _dialogComponent;obj.entityType||(_dialogComponent=_.find($scope.dialogEntities,{_id:obj.componentId}),obj.entityType=_dialogComponent.entityType);var entityType=_.find($scope._constants_.entityNlp,{value:obj.entityType});entityType&&entityType.value&&"company_name"===entityType.value&&(entityType.title="Company/Org Name"),entityType&&entityType.title&&($scope.objList[_objVal].entityType=entityType.title)}var _eleCount=0;isGroupNodeIntent||$timeout(makeEleDraggable,100)}function checkCollisionDetection(comp1,comp2){if(comp1.length&&comp2.length){var comp1Data={left:comp1.offset().left,top:comp1.offset().top,width:comp1.width(),height:comp1.height()},comp2Data={left:comp2.offset().left,top:comp2.offset().top,width:comp2.width(),height:comp2.height()};return comp1Data.left<comp2Data.left+comp2Data.width&&comp1Data.left+comp1Data.width>comp2Data.left&&comp1Data.top<comp2Data.top+comp2Data.height&&comp1Data.top+comp1Data.height>comp2Data.top?!0:!1}}function arrayToAndString(arr){var outStr="";return 1===arr.length?outStr=arr[0]:2===arr.length?outStr=arr.join(" and "):arr.length>2&&(outStr=arr.slice(0,-1).join(", ")+", and "+arr.slice(-1)),outStr}function ondragStart(e,u){_parentHeight=$element.find(".flowTaskConnectionBlock")[0].scrollHeight-300,_parentWidth=$element.find(".flowTaskConnectionBlock")[0].scrollWidth-400,_initPos.left=u.position.left,_initPos.top=u.position.top,$scope.nodeDragging=!0}function ondragging(e,u){u.position.left<0&&(u.position.left=0),u.position.top<0&&(u.position.top=0),u.position.top-_parentHeight>0&&$element.find(".flowTaskConnectionBlock").scrollTop($element.find(".flowTaskConnectionBlock").scrollTop()+50),u.position.left-_parentWidth>0&&$element.find(".flowTaskConnectionBlock").scrollLeft($element.find(".flowTaskConnectionBlock").scrollLeft()+50),$("connection").connections("update")}function ondragStop(e,u){if($timeout(function(){$scope.nodeDragging=!1},500),"view"!==$scope.displayMode){if($timeout(function(){$("connection").connections("update"),rearrangeGroups()}),e.target){var _ele=$(e.target),_uId=_ele.find(".dragEleConn").data("id"),_updateParams={metadata:{left:u.position.left<0?0:parseInt(u.position.left/$scope.zoomScale),top:u.position.top<0?0:parseInt(u.position.top/$scope.zoomScale)}};$scope.objList[_uId].metadata=_updateParams.metadata,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,_dialogObj._id,_uId,_updateParams).then(function(res){console.log("Position Saved"),_dialogObj=res&&res.data},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")}),correctPageScroll(0,0,0,!0)}console.log("left: "+u.position.left+", top: "+u.position.top)}}function onPanelDragStop(e,u){if(e.target){var _parentEle=$element.find(".flowTaskConnectionBlock"),_ele=$(e.target),_right=parseInt(_parentEle.width())-u.position.left-parseInt(_ele.width());_ele.css("right",_right+"px"),_ele.css("left","auto")}}function onDebugResizeStop(e,u){$scope.isDebugResized++}function openPreviewModal(nodeType,isFirstNode,nodeobj){$timeout(function(){$("#flowtask_node_Begin").modal({backdrop:"static",show:!0})},350),initializeNodeModal(nodeType),$scope.nodeObjLabels.isFirstNode=!0;var _modalBodyHeight=$(window).height()-300;$("#flowtask_node_Begin .modal-body").css("max-height",_modalBodyHeight),$timeout(function(){$scope.nodeObj.isInvalid=!0,"intent"!==nodeType&&($scope.onNodeSave(nodeobj),$("#flowtask_node_Begin").addClass("hide"))},350)}function getNewNodeConnectionColor(typeId,dummyId){var _connNum=0;if(void 0===dummyId&&(dummyId=""),$scope.objList[typeId]&&$scope.objList[typeId].connections){if(_connNum=Object.keys($scope.objList[typeId].connections).length,_connNum>0&&$scope.objList[typeId].connections[dummyId]&&$scope.objList[typeId].connections[dummyId].connId&&$scope.objList[typeId].connections[dummyId].color)return $scope.objList[typeId].connections[dummyId].color;_connNum>9&&(_connNum%=10)}else console.log("Random Number assigned"),_connNum=Math.floor(10*Math.random());return _connectionColors[_connNum]}function addNewConnection(sourceUID,targetUID,dummyId){var i,_lineColor="",_isDefault=!1,_isInObjListConn=!1,_isInObjListTempConn=!1;for($scope.objList[sourceUID]&&$scope.objList[sourceUID].connections&&$scope.objList[sourceUID].connections[dummyId]&&(_isDefault=$scope.objList[sourceUID].connections[dummyId].isDefault),i=0;i<_objConnection.length;i++)if(_objConnection[i].sourceId===sourceUID&&_objConnection[i].tagretId===targetUID){_objConnection.splice(i,1);var _ele=$element.find(".flowTaskConnectionBlock .source-"+sourceUID+" .target-"+targetUID);_ele.length>0&&$.each(_ele,function(k,ele){$(ele).connections("remove")}),i--}dummyId&&""!==dummyId.trim()&&(_lineColor=getNewNodeConnectionColor(sourceUID,dummyId));var _connObjNumber=0;if($scope.objList[sourceUID]&&$scope.objList[sourceUID].connections?($scope.objList[sourceUID].connections[dummyId]&&(_isInObjListConn=!0),$scope.objList[sourceUID].tempConnections[dummyId]&&(_isInObjListTempConn=!0),$.each($scope.objList[sourceUID].connections,function(k,conn){return _connObjNumber++,conn.targetId===targetUID?!1:void 0})):_connObjNumber=1,$element.find('.draggableEle [data-id="'+targetUID+'"]').length>0){$element.find('.draggableEle [data-id="'+sourceUID+'"]').connections({to:'.draggableEle [data-id="'+targetUID+'"]',"class":"line source-"+sourceUID+" "+sourceUID+" target-"+targetUID+" singleConnection",within:$element.find(".flowTaskConnectionBlock")[0],lineColor:_lineColor,connectionNum:_connObjNumber,sourceId:sourceUID,targetId:targetUID});var _tempConnObj=$.extend(!0,{},_connObj,{sourceId:sourceUID,targetId:targetUID,color:_lineColor,isDefault:_isDefault});_isInObjListConn?(_tempConnObj.connId=dummyId,_tempConnObj.ifConditionPrefix=$scope.objList[sourceUID].connections[dummyId].ifConditionPrefix,_tempConnObj="intent"===$scope.objList[targetUID].type&&"service"!==$scope.objList[sourceUID].type&&"script"!==$scope.objList[sourceUID].type&&"dialogAct"!==$scope.objList[sourceUID].type?$.extend(!0,{},$scope.objList[sourceUID].tempConnections[dummyId],{sourceId:sourceUID,targetId:targetUID,color:_lineColor,isDefault:_isDefault}):$.extend(!0,{},$scope.objList[sourceUID].tempConnections[dummyId],{sourceId:sourceUID,targetId:targetUID,color:_lineColor,isDefault:_isDefault}),"dialogAct"===$scope.objList[sourceUID].type&&(_tempConnObj.ifCondition=$scope.objList[sourceUID].tempConnections[dummyId].ifCondition||""),_isInObjListTempConn&&delete $scope.objList[sourceUID].tempConnections[dummyId]):(_tempConnObj.connId="dummy"+dummyConnectionCount,dummyConnectionCount++),addConnectionOnNode(_tempConnObj,dummyId,!0)}rearrangeConnectionsForObj(sourceUID)}function addNewInBetweenConnections(sourceUID,targetUID,connectionObj){var _sourceTransition,_targetTransision;_targetTransision=_.filter($scope.objList[targetUID].connections,{isDefault:!0}),_targetTransision&&1===_targetTransision.length&&(_targetTransision=_targetTransision[0],_targetTransision.targetId=connectionObj.target.uId,addConnectionOnNode(_targetTransision,_targetTransision.connId,!0,function(){if($scope.objList[sourceUID]&&$scope.objList[sourceUID].connections){var _connsAvailable=_.filter($scope.objList[connectionObj.source.uId].connections,{sourceId:connectionObj.source.uId,targetId:connectionObj.target.uId});_connsAvailable&&_connsAvailable.length>1?(_sourceTransition=_.filter($scope.objList[connectionObj.source.uId].connections,{isDefault:!0}),_sourceTransition=_sourceTransition[0]):_connsAvailable&&1===_connsAvailable.length&&(_sourceTransition=_connsAvailable[0])}_sourceTransition.targetId=targetUID,addConnectionOnNode(_sourceTransition,_sourceTransition.connId,!0),deHighlightConnection();var _ele=$element.find(".flowTaskConnectionBlock .source-"+sourceUID+" .target-"+targetUID);_ele.length>0&&$.each(_ele,function(k,ele){$(ele).connections("remove")})}))}function rearrangeConnectionsForObj(uId){var _top=20;$.each($scope.objList[uId].tempConnections,function(k,tConn){tConn.top=_top,_top+=30}),$element.find('.dragEleConn[data-id="'+uId+'"]').css("height",""),$element.find('.dragEleConn[data-id="'+uId+'"]').parents(".draggableEle").css("height",""),$timeout(function(){_top>parseInt($element.find('.dragEleConn[data-id="'+uId+'"]').parents(".draggableEle").css("height"))&&($element.find('.dragEleConn[data-id="'+uId+'"]').parents(".draggableEle").css("height",_top+"px"),$element.find('.dragEleConn[data-id="'+uId+'"]').css("height",_top-10+"px"))}),updateConectionWarnings()}function rearrangeConnectionNumber(uId){var _connObjNumber=0;$element.find("connection.source-"+uId).connections("remove");var _source=$element.find('.draggableEle [data-id="'+uId+'"]');$.each($scope.objList[uId].connections,function(k,tConn){_connObjNumber++,tConn.connObjNumber=_connObjNumber;var _target=$element.find('.draggableEle [data-id="'+tConn.targetId+'"]');_source.length>0&&_target.length>0&&_source.connections({to:'.draggableEle [data-id="'+tConn.targetId+'"]',"class":"line source-"+uId+" "+uId+" target-"+tConn.targetId+" singleConnection",within:$element.find(".flowTaskConnectionBlock")[0],lineColor:tConn.color,connectionNum:tConn.connObjNumber})})}function registerMouseEvents(){$element.find(".flowTaskConnectionBlock").on("dblclick",function(e){e.target===e.currentTarget&&$scope.propertyCb.closePropertyPanel();
}),$element.find(".flowTaskBlock").on("mousemove",function(e){if($element.find(".addConnectionDropdown.open").length>0||$scope.inBtwOptShown||_tracePath)return!1;var res=[],_connElmts=[];$element.find("connection").each(function(index){isPointInsideDiv(this,e.pageX,e.pageY,3)&&(isPointInsideDiv($(this).find(".connection-inner"),e.pageX,e.pageY,0)||res.push(this))}),res.length&&(_connElmts=res);var _mouseOnNode=$element.find(".draggableEle .configure .fa.fa-gear:visible").length?!0:!1;!_mouseOnNode&&_connElmts.length?highlightConnection(_connElmts[0]):deHighlightConnection()})}function isPointInsideDiv(_div,pageX,pageY,_bR){var offset=$(_div).offset(),left=offset.left,top=offset.top,width=$(_div).width(),height=$(_div).height();return height*=parseFloat($scope.zoomScale),width*=parseFloat($scope.zoomScale),pageX>left-_bR&&left+width+_bR>pageX&&pageY>top-_bR&&top+height+_bR>pageY?!0:!1}function getSourceTarget(connectionEle){var classList=$(connectionEle).attr("class").split(/\s+/),_rObj={};return $.each(classList,function(index,item){"source"===item.substring(0,6)?_rObj.source=item.substring(7,item.length):"target"===item.substring(0,6)&&(_rObj.target=item.substring(7,item.length))}),_rObj}function highlightConnection(e){deHighlightConnection();var _targetId=getSourceTarget(e).target,_sourceId=getSourceTarget(e).source;$scope.highlightConnection(_sourceId,_targetId),$scope.selectedConnection={source:$scope.objList[_sourceId],target:$scope.objList[_targetId]};var left=($(this).offset(),e.pageX),top=e.pageY,theHeight=$(".connectionInfoPopover").height();"configured"!=$scope.flowtaskObj.state&&"awaitingApproval"!=$scope.flowtaskObj.state||"FULL"!=$scope.accessRights||"edit"!=$scope.displayMode||$(".connectionInfoPopover").show(),$(".connectionInfoPopover").css("left",left+10+"px"),$(".connectionInfoPopover").css("top",top-theHeight/2-10+"px"),document.body.style.cursor="pointer"}function deHighlightConnection(){$scope.clearTracepath(!0),$(".connectionInfoPopover").hide(),document.body.style.cursor="default",_highlightedConnEle=null}function exit(){$(".botDetailsForm").removeClass("dialogModalOpen"),NotificationService.clearAll(),$rootScope.$emit("updateSummaryData"),$scope.clearSetUpLocalStorageFortask(),defaultValue.setDefaultOptionalValue(),defaultValue.setDefaultHiddenValue(),$scope.loadUtteranceModule=!1,$workflowService.flowTaskDisplayMode(""),""!==$scope.firstNodeUId?BTFlowtaskService.unlockFlowTask(_dialogObj._id).then(function(){$workflowService.dialogNodesNames([]),closeFullPageModal(),$scope.callBack&&$scope.callBack.closeFlowTaskEvent&&$scope.callBack.closeFlowTaskEvent()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("release_lock"),"error");$scope.callBack&&$scope.callBack.closeFlowTaskEvent&&$scope.callBack.closeFlowTaskEvent(),closeFullPageModal()}):($scope.callBack&&$scope.callBack.closeFlowTaskEvent&&$scope.callBack.closeFlowTaskEvent(),closeFullPageModal());var params={action:"updateDialogStory",payload:{}};$scope.sendEventToIframe(params)}function exit1(){""!==$scope.firstNodeUId?BTFlowtaskService.unlockFlowTask(_dialogObj._id).then(function(){$workflowService.dialogNodesNames([]),$scope.callBack&&$scope.callBack.closeFlowTaskEvent&&$scope.callBack.closeFlowTaskEvent(),closeFullPageModal1()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("release_lock"),"error");$scope.callBack&&$scope.callBack.closeFlowTaskEvent&&$scope.callBack.closeFlowTaskEvent(),closeFullPageModal1()}):closeFullPageModal1()}function updateScriptDefWarnings(){$scope.notiRefs.scriptDefWarns&&$scope.notiRefs.scriptDefWarns.length&&$scope.notiRefs.scriptDefWarns.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.scriptDefWarns=[],$.each(_objList,function(k,obj){if("script"===obj.type&&!obj.script){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("script_def",{name:obj.name}),type:"error",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.scriptDefWarns.push(_nRef)}})}function updateServiceReqDefWarnings(){function hasRequestDefination(obj){if("custom"===obj.serviceNodeType)return obj.endPoint&&(obj.endPoint.host||obj.endPoint.path);if("urltoimage"===obj.serviceNodeType)return obj.endPoint&&(obj.endPoint.host||obj.endPoint.path);if("htmltoimage"===obj.serviceNodeType){var _reqData=obj.htmlData&&obj.htmlData[0]&&obj.htmlData[0].text||"";return _reqData=_reqData.replace(/&lt;/gi,"<").replace(/&gt;/gi,">"),""===_reqData?!1:!0}return"smartalert"===obj.serviceNodeType?_.isEmpty(obj.payload)?!1:!0:"datatable"===obj.serviceNodeType?obj.payload&&obj.payload.name:void 0}$scope.notiRefs.reqDefWarns&&$scope.notiRefs.reqDefWarns.length&&$scope.notiRefs.reqDefWarns.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.reqDefWarns=[],$.each(_objList,function(k,obj){if("service"===obj.type&&!hasRequestDefination(obj)){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("service_def",{name:obj.name}),type:"error",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.reqDefWarns.push(_nRef)}})}function updateServiceSampleResWarnings(){$scope.notiRefs.sampleResWarns&&$scope.notiRefs.sampleResWarns.length&&$scope.notiRefs.sampleResWarns.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.sampleResWarns=[],$.each(_objList,function(k,obj){if("service"===obj.type&&"custom"===obj.serviceNodeType&&(!obj.sampleResponse||"{}"===obj.sampleResponse)){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("res_service_node",{name:obj.name}),type:"warning",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.sampleResWarns.push(_nRef)}})}function updateEntityRegExWarnings(){$scope.notiRefs.entityRegExWarns&&$scope.notiRefs.entityRegExWarns.length&&$scope.notiRefs.entityRegExWarns.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.entityRegExWarns=[],$.each(_objList,function(k,obj){if("entity"===obj.type&&"regex"===obj.entityType&&!obj.regexPattern){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("customtags_reg",{name:obj.name}),type:"error",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.entityRegExWarns.push(_nRef)}})}function updateEntityQuantityErrors(){$scope.notiRefs.entityQuantityErrors&&$scope.notiRefs.entityQuantityErrors.length&&$scope.notiRefs.entityQuantityErrors.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.entityQuantityErrors=[],$.each(_objList,function(k,obj){if("entity"===obj.type&&"quantityv2"===obj.entityType&&!obj.unitType){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("quantity_entity",{name:obj.name}),type:"error",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.entityQuantityErrors.push(_nRef)}})}function updateEntityLOIEnumeratorErrors(){$scope.notiRefs.entityLOIEnumeratorErrors&&$scope.notiRefs.entityLOIEnumeratorErrors.length&&$scope.notiRefs.entityLOIEnumeratorErrors.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.entityLOIEnumeratorErrors=[],$.each(_objList,function(k,obj){if("entity"===obj.type&&"list_of_values"===obj.entityType&&!obj.allowedValues||"entity"===obj.type&&"list_of_values"===obj.entityType&&obj.allowedValues&&obj.allowedValues.hasOwnProperty("values")&&!(obj.allowedValues.values.length>=2)||"entity"===obj.type&&"list_of_values"===obj.entityType&&obj.allowedValues&&obj.allowedValues.hasOwnProperty("variable")&&!obj.allowedValues.variable){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("list_values",{name:obj.name}),type:"error",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.entityLOIEnumeratorErrors.push(_nRef)}})}function updateEntityLOILookupErrors(){$scope.notiRefs.entityLOILookupErrors&&$scope.notiRefs.entityLOILookupErrors.length&&$scope.notiRefs.entityLOILookupErrors.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.entityLOILookupErrors=[],$.each(_objList,function(k,obj){if("entity"===obj.type&&"list_of_items_lookup"===obj.entityType&&!obj.lookupId&&("static"===obj.subType||void 0===obj.subType)){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("list_lookup",{name:obj.name}),type:"error",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.entityLOILookupErrors.push(_nRef)}})}function updateEntityPatternsErrors(){$scope.notiRefs.entityPatternsErrors&&$scope.notiRefs.entityPatternsErrors.length&&$scope.notiRefs.entityPatternsErrors.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.entityPatternsErrors=[],$.each(_objList,function(k,obj){if(!("entity"!==obj.type||"composite"!==obj.entityType||obj.patterns&&obj.patterns.length)){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("composite_entity",{name:obj.name}),type:"warning",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.entityPatternsErrors.push(_nRef)}})}function updateEntityCompositePatternsErrors(){$scope.notiRefs.entityPatternsErrors&&$scope.notiRefs.entityPatternsErrors.length&&$scope.notiRefs.entityPatternsErrors.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.entityPatternsErrors=[],$.each(_objList,function(k,obj){if(!("entity"!==obj.type||"composite"!==obj.entityType||obj.compositePatterns&&obj.compositePatterns.length)){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("composite_entity",{name:obj.name}),type:"warning",nodeType:obj.type,navigateInfo:{nodeId:obj.nodeId,nodeSection:"nodeProperties"},breadCrumb:[obj.name,$scope._constants_.propertyPanel.componentProperties]});$scope.notiRefs.entityPatternsErrors.push(_nRef)}})}function updateConectionWarnings(){var _hasTempConn=checkForTempConnections(),_NodesMsg="";$scope.notiRefs.tempConnections&&$scope.notiRefs.tempConnections.length&&$scope.notiRefs.tempConnections.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.tempConnections=[];var tempConnNodes=_.uniq(_hasTempConn.nodes,function(x){return x.uId});$.each(tempConnNodes,function(k,node){if(!(node&&node.uId&&$scope.groupNodeIntentsObj[node.uId])&&(_NodesMsg+=node.name+", ",$scope.notifierBridge&&$scope.notifierBridge.notify)){var _nRef=$scope.notifierBridge.notify({msg:i18n.i18nString("node_temporary",{node:node.name}),type:"warning",nodeType:node.type,navigateInfo:{nodeId:node.uId,nodeSection:"connection"},breadCrumb:[node.name,"Connections"]});$scope.notiRefs.tempConnections.push(_nRef)}})}function getConnections(data){var transitions=_.flatten(_.pluck(data,"transitions"));return _.filter(transitions,function(each){return"end"!==each["default"]&&!_.isEmpty(each["default"])||_.isUndefined(each["default"])})}function prepareData(){$scope.amendEntity.flowtask.amendConfig.enabled&&($scope.amendEntity.flowtask.amendConfig.allowHidden=$scope.amendEntity.flowtask.amendConfig.allowHidden?$scope.amendEntity.flowtask.amendConfig.allowHidden:!1),$scope.amendEntity.flowtask.amendConfig.enabled===!1?(delete $scope.amendEntity.flowtask.amendConfig.postAmend,delete $scope.amendEntity.flowtask.amendConfig.skipShownMessages,delete $scope.amendEntity.flowtask.amendConfig.clearDownstreamEntities,delete $scope.amendEntity.flowtask.amendConfig.allowHidden):("continueFromCurrentNode"===$scope.amendEntity.flowtask.amendConfig.postAmend||"jumpToSpecificNode"===$scope.amendEntity.flowtask.amendConfig.postAmend)&&(delete $scope.amendEntity.flowtask.amendConfig.skipShownMessages,delete $scope.amendEntity.flowtask.amendConfig.clearDownstreamEntities)}function initializeNodeModal(nodeType){$scope.nodeObjLabels={},$scope.nodeObjLabels.name=$scope._constants_.flowtasks.label,"intent"===nodeType?($scope.nodeObj=$.extend(!0,{},_intentObj),$scope.nodeObjLabels.name=i18n.i18nString("new_intent"),$scope.nameDescription=i18n.i18nString("name_desc")):"entity"===nodeType?($scope.nodeObj=$.extend(!0,{},_entityObj),$scope.nodeObjLabels.name=i18n.i18nString("new_entity"),$scope.nameDescription=i18n.i18nString("entity_name")):"service"===nodeType?($scope.nodeObj=$.extend(!0,{},_serviceObj),$scope.nodeTypeObjOptns=$.extend(!0,[],_serviceNodeType),$scope.nodeObjLabels.name=i18n.i18nString("new_service"),$scope.nameDescription=i18n.i18nString("service_name")):"script"===nodeType?($scope.nodeObj=$.extend(!0,{},_scriptObj),$scope.nodeObjLabels.name=i18n.i18nString("new_script"),$scope.nameDescription=i18n.i18nString("script_name")):"message"===nodeType?($scope.nodeObj=$.extend(!0,{},_messageObj),$scope.nodeObjLabels.name=i18n.i18nString("new_message"),$scope.nameDescription=i18n.i18nString("message_name")):"dialogAct"===nodeType?($scope.nodeObj=$.extend(!0,{},_confirmationObj),$scope.nodeObjLabels.name=i18n.i18nString("new_confirmation"),$scope.nameDescription=i18n.i18nString("confirmation_name")):"SDKWebHook"===nodeType?($scope.nodeObj=$.extend(!0,{},_sdkwebhookObj),$scope.nodeObjLabels.name=i18n.i18nString("new_webhook"),$scope.nameDescription=i18n.i18nString("webhook_name")):"agentTransfer"===nodeType&&($scope.nodeObj=$.extend(!0,{},_agentTransferObj),$scope.nodeObjLabels.name=i18n.i18nString("new_agenttransfer"),$scope.nameDescription=i18n.i18nString("agent_transfer_name")),$scope.nodeObj.type=nodeType,$scope.nodeObjLabels.isFirstNode=!1,$scope.nodeObjLabels.nameLabel=$scope._constants_.flowtasks.label,"intent"===nodeType?$scope.nodeObjLabels.namePlaceholder=i18n.i18nString("create_lead"):"message"===nodeType?($scope.nodeObjLabels.nameSubLabel="",$scope.nodeObjLabels.namePlaceholder=i18n.i18nString("msg_place")):($scope.nodeObjLabels.nameSubLabel="",$scope.nodeObjLabels.namePlaceholder=i18n.i18nString("intent_name_place"))}function addConnectionOnNode(connectionObj,dummyId,deleteDummyConn,onAddConnectionCb){if(_dialogObj.nodes&&_dialogObj.nodes.length>0){var _transitionObj={},_isSourceMsg=!1,_isSourceIntent=!1,_isTargetIntent=!1,_isSourceDialogAct=!1;$.each($scope.objList,function(k,obj){"dialogAct"===obj.type&&obj.uId===connectionObj.sourceId&&(_isSourceDialogAct=!0),"message"===obj.type&&obj.uId===connectionObj.sourceId&&(_isSourceMsg=!0),"intent"===obj.type&&obj.uId===connectionObj.sourceId&&(_isSourceIntent=!0),"intent"===obj.type&&obj.uId===connectionObj.targetId&&(_isTargetIntent=!0)});var _hasIntentTransition=!1,_followUpIntent=!1;if(_isSourceDialogAct)connectionObj.isDefault?_transitionObj={"default":connectionObj.targetId}:(_transitionObj={"if":{dialogAct:connectionObj.ifCondition||"no"},then:connectionObj.targetId},"dialogAct"!==connectionObj.ifConditionPrefix&&(_transitionObj={"if":{context:connectionObj.ifCondition,op:connectionObj.ifOperator,value:connectionObj.value},then:connectionObj.targetId}));else if(_isSourceMsg&&_isTargetIntent){if(connectionObj.isDefault){onAddConnectionCb&&(dummyId=dummyId||""),dummyId=dummyId||"";var connectionObjCopy=$workflowService.cloneData(connectionObj);connectionObjCopy.targetId="",$scope.objList[connectionObj.sourceId].connections[dummyId]=connectionObjCopy,connectionObj.connId="dummy"+dummyConnectionCount,dummyId=connectionObj.connId,dummyConnectionCount++}_transitionObj={"if":{},then:connectionObj.targetId},"followup"===connectionObj.intentType?(_transitionObj["if"].op=connectionObj.ifOperator,_transitionObj["if"].value=connectionObj.value,_transitionObj["if"].context="context.FollowupIntents",_followUpIntent=!0):(_transitionObj["if"].op=connectionObj.ifOperator,_transitionObj["if"].value=connectionObj.value,_transitionObj["if"].intent=connectionObj.ifCondition),"intent"===connectionObj.ifConditionPrefix&&("followup"===connectionObj.intentType&&(_followUpIntent=!0),_hasIntentTransition=!0)}else connectionObj.isDefault?_transitionObj={"default":connectionObj.targetId}:"intent"===connectionObj.ifConditionPrefix?(_transitionObj={"if":{},then:connectionObj.targetId},"followup"===connectionObj.intentType?(_transitionObj["if"].op=connectionObj.ifOperator,_transitionObj["if"].value=connectionObj.value,_transitionObj["if"].context="context.FollowupIntents",_followUpIntent=!0):(_transitionObj["if"].op=connectionObj.ifOperator,_transitionObj["if"].value=connectionObj.value,_transitionObj["if"].intent=connectionObj.ifCondition),_hasIntentTransition=!0):"field"===connectionObj.ifConditionPrefix?(_transitionObj={"if":{field:connectionObj.ifCondition,op:connectionObj.ifOperator,value:connectionObj.value},then:connectionObj.targetId},""===_transitionObj["if"].op&&(delete _transitionObj["if"].op,delete _transitionObj["if"].value)):_transitionObj="dialogAct"===connectionObj.ifConditionPrefix?{"if":{dialogAct:connectionObj.ifCondition},then:connectionObj.targetId}:{"if":{context:connectionObj.ifCondition,op:connectionObj.ifOperator,value:connectionObj.value},then:connectionObj.targetId};connectionObj.conjoin&&(_transitionObj["if"]={conjoin:connectionObj.conjoin,tests:connectionObj.tests}),_transitionObj.metadata={color:connectionObj.color,connId:connectionObj.connId},"intent"===connectionObj.ifConditionPrefix&&"followup"===connectionObj.intentType&&(_transitionObj.metadata.intent=""),$.each(_dialogObj.nodes,function(k,node){if(node.nodeId===connectionObj.sourceId){if(node.transitions&&node.transitions.length>0){var foundKey=-1;if(""!==dummyId)for(var key=0;key<node.transitions.length;key++)if(deleteDummyConn&&node.transitions[key].metadata&&node.transitions[key].metadata.connId&&node.transitions[key].metadata.connId===dummyId){foundKey=key;break}foundKey>=0&&foundKey<node.transitions.length?node.transitions[foundKey]=_transitionObj:(connectionObj.isDefault=!1,node.transitions.splice(node.transitions.length-1,0,_transitionObj))}else node.transitions=[],node.transitions.push(_transitionObj);var _transitionType="auto";return _hasIntentTransition&&!_followUpIntent&&(_transitionType="onInput"),node.nodeOptions||(node.nodeOptions={transitionType:_transitionType},node.nodeOptions.transitionType=_transitionType),node.nodeOptions.promptOptions?"required"===node.nodeOptions.promptOptions?node.nodeOptions.isOptional=!1:node.nodeOptions.isOptional=!0:node.nodeOptions.isOptional?(node.nodeOptions.promptOptions="optional",node.nodeOptions.isOptional=!0):(node.nodeOptions.isOptional=!1,node.nodeOptions.promptOptions="required"),!1}})}var _updateParams={streamId:_dialogObj.streamId,name:_dialogObj.name,nodes:[],displayOption:_dialogObj.displayOption,visibility:_dialogObj.visibility};_dialogObj.nodes&&_dialogObj.nodes.length>0?$.each(_dialogObj.nodes,function(k,node){delete node._id,delete node.message,node.nodeOptions=node.nodeOptions||{},_updateParams.nodes.push(node)}):_dialogObj.nodes=[],BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_updateParams).then(function(res){if(console.log("Connection Added"),$workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0),_dialogObj=res&&res.data,connectionObj&&connectionObj.targetId){var _targetEle=$element.find('.dragEleConn[data-id="'+connectionObj.targetId+'"]');if(_targetEle.length>0){var _updateParams={metadata:{left:parseInt(_targetEle.parents(".draggableEle").css("left")),top:parseInt(_targetEle.parents(".draggableEle").css("top"))}};BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,_dialogObj._id,connectionObj.targetId,_updateParams).then(function(res){console.log("Position Saved"),$workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0),_dialogObj=res&&res.data},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}if(_objConnection.push(connectionObj),connectionObj.isDefault)$scope.objList[connectionObj.sourceId].connections[connectionObj.connId]=connectionObj,$scope.objList[connectionObj.sourceId].connections[connectionObj.connId].connObjNumber=Object.keys($scope.objList[connectionObj.sourceId].connections).length;else if($scope.objList[connectionObj.sourceId].connections[connectionObj.connId])angular.extend($scope.objList[connectionObj.sourceId].connections[connectionObj.connId],connectionObj);else{var _tempConnection=$.extend(!0,{},$scope.objList[connectionObj.sourceId].connections);delete $scope.objList[connectionObj.sourceId].connections,$scope.objList[connectionObj.sourceId].connections={};var _connObjNumber=0;$.each(_tempConnection,function(k,conn){_connObjNumber++,conn.connId!==connectionObj.connId?(conn.isDefault&&($scope.objList[connectionObj.sourceId].connections[connectionObj.connId]=connectionObj,$scope.objList[connectionObj.sourceId].connections[connectionObj.connId].connObjNumber=Object.keys($scope.objList[connectionObj.sourceId].connections).length),$scope.objList[connectionObj.sourceId].connections[conn.connId]=conn,$scope.objList[connectionObj.sourceId].connections[conn.connId].connObjNumber=_connObjNumber):conn.connObjNumber=_connObjNumber})}$scope.objList[connectionObj.sourceId].tempConnections={},$.each($scope.objList[connectionObj.sourceId].connections,function(k,conn){""===conn.targetId&&($scope.objList[connectionObj.sourceId].tempConnections[conn.connId]=conn)}),rearrangeConnectionsForObj(connectionObj.sourceId),rearrangeConnectionNumber(connectionObj.sourceId),onAddConnectionCb?onAddConnectionCb():connectionObj&&connectionObj.targetId?$scope.onConfigure(connectionObj.targetId,"nodeProperties",[{CssSelector:".node-name",action:"input-focus",delay:500}]):connectionObj&&connectionObj.sourceId&&$scope.isPropertyPanelOpened&&$scope.onConfigure(connectionObj.sourceId,"nodeProperties",[{CssSelector:".node-name",action:"input-focus",delay:500}]),$timeout(function(){$("connection").connections("update"),chechForConnectionCounts()},350)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function addNodeOnDialog(res){var _updateParams={streamId:_dialogObj.streamId,name:_dialogObj.name,nodes:[],displayOption:_dialogObj.displayOption,visibility:_dialogObj.visibility};_dialogObj.nodes&&_dialogObj.nodes.length>0?$.each(_dialogObj.nodes,function(k,node){delete node._id,delete node.message,_updateParams.nodes.push(node)}):_dialogObj.nodes=[];var _transitions=[];if("dialogAct"===res.type)_transitions.push({"if":{context:"",op:"",value:""},then:"",metadata:{color:_connectionColors[2],connId:"dummy"+dummyConnectionCount}}),dummyConnectionCount++,_transitions.push({"if":{dialogAct:"yes"},then:"",metadata:{color:_connectionColors[0],connId:"dummy"+dummyConnectionCount}}),dummyConnectionCount++,_transitions.push({"if":{dialogAct:"no"},then:"",metadata:{color:_connectionColors[1],connId:"dummy"+dummyConnectionCount}}),dummyConnectionCount++,_transitions.push({"default":"",metadata:{color:_connectionColors[3],connId:"dummy"+dummyConnectionCount}});else if("intent"===res.type&&$scope.nodeObj.isSubDialog){var _subdialogTransObj={"default":"end",metadata:{color:_connectionColors[0],connId:"dummy"+dummyConnectionCount}};$scope.groupNodeIntent&&(_subdialogTransObj.metadata.groupNodeIntent=!0),_transitions.push(_subdialogTransObj)}else if("agentTransfer"===res.type)_transitions.push({"default":"end",metadata:{color:_connectionColors[0],connId:"dummy"+dummyConnectionCount}});else{var transObj={"default":"",metadata:{color:_connectionColors[0],connId:"dummy"+dummyConnectionCount}};$scope.groupNodeIntent&&(transObj.metadata.groupNodeIntent=!0),_transitions.push(transObj)}dummyConnectionCount++;var _nodeOptions={transitionType:"auto"};"entity"===res.type&&(_nodeOptions.isOptional=!1,_nodeOptions.promptOptions="required",_nodeOptions.interruptOptions={interruptsEnabled:!0,priority:"task"},_nodeOptions.eventOptions={defaultMaxRetry:{retry_limit:5,action:"endOfDialog"}});var _nodeObj={nodeId:$scope.nodeObj.uId,type:res.type,componentId:res._id,transitions:_transitions,nodeOptions:_nodeOptions};"intent"===$scope.nodeObj.type&&$scope.nodeObj.isSubDialog&&(_nodeObj.flowTaskId=$scope.nodeObj.isSubDialog),$scope.groupNodeIntent&&"intent"===$scope.nodeObj.type&&(_nodeObj.groupNodeIntent=!0),_updateParams.nodes.push(_nodeObj),BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_updateParams).then(function(res){if($workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0),_dialogObj=res&&res.data,$scope.processingCreateEle=!1,$scope.groupNodeIntent){var oldSelection=null;$scope.selectedNode&&$scope.selectedNode.dialogNodeInstance&&$scope.selectedNode.dialogNodeInstance.uId&&(oldSelection=$scope.selectedNode.dialogNodeInstance.uId),createNodeEle($scope.nodeObj,_transitions,!0),$scope.dialogData("updateDialog",res.data,$scope.nodeObj.uId),$scope.selectGroupNodeIntent($scope.nodeObj),oldSelection&&$scope.removeTempIntnetNode(oldSelection),$scope.intentCancel(),$scope.nodeObj={}}else createNodeEle($scope.nodeObj,_transitions),updateScriptDefWarnings(),updateServiceReqDefWarnings(),updateServiceSampleResWarnings(),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateConectionWarnings(),$scope.nodeObj={};$scope.groupNodeIntent=!1,$scope.eleCreationInProgress=!1},function(error){if($scope.groupNodeIntentDeleteInProgess=!1,$scope.processingCreateEle=!1,$scope.eleCreationInProgress=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function pushHistory(debug){if(debug&&debug.history){$scope.debugInfo=$scope.debugInfo||[];var node=debug.history;node.debugTitle&&$scope.debugInfo.push(node),node.timestampFormated=moment(node.timestamp).local().format("MM-DD-YYYY  HH:mm:ss.SSS"),$timeout(function(){var _debugLogDiv=$(".debug-console-panel-cntnr .tab-content");_debugLogDiv&&_debugLogDiv.scrollTop(_debugLogDiv[0].scrollHeight)},300)}}function showBotScreen(){function checkConnection(){$element.find(".kore-chat-window .kore-chat-header .header-title").text()===_selectedStream.name?$scope.isConnecting=!1:40>count&&$timeout(function(){checkConnection()},500),count++}$scope.isConnecting=!0,$scope.debugInfo=$scope.debugInfo||[],$scope.debugRaw=$scope.debugRaw||{},$scope.debugContext=$scope.debugContext||"",$scope.nlTraceData=$scope.nlTraceData||"",$scope.$on("loggerInstance",function(events,instance){_loggerInstance=instance});var _userInfo=$applicationService.userInfo();$rootScope.$emit("botTestStart",_selectedStream,".flowTaskForm .runBotContainer .runBotBody",$scope.pushDebugInfo,null,null,$scope.pushHistoryInfo,null,null,_userInfo),$scope.minMaxChatWinowz("maximize"),$scope.runBot.show=!1,$timeout(function(){$scope.minMaxDebugLog("minimize")},100);var count=0,$popover=$(".whiteBorder").popover({html:!0,content:'<p class="content">"'+i18n.i18nString("popover_content")+'"<span> <a class="knowmore" target="_blank" href="https://github.com/Koredotcom/chatbot-test-runner">"'+i18n.i18nString("know_more")+'"</a></span></p>',trigger:"click"});$popover.on("mouseenter",function(e){var _this=this;$(this).popover("show"),$(this.children[0]).addClass("displayBlock"),$(".popover").on("mouseleave",function(){$(_this).popover("hide")})}).on("mouseleave",function(e){var _this=this;setTimeout(function(){$(".popover:hover").length||($(_this.children[0]).removeClass("displayBlock"),$(_this).popover("hide"))},200)}),checkConnection(),$timeout(function(){var _ele=$element.find(".flowTaskPropertyPanel");if(_ele&&_ele.length){var _panelLeft=_ele.offset().left;if($scope.isPropertyPanelOpened&&0>_panelLeft){var _parentEle=$element.find(".flowTaskConnectionBlock"),_right=parseInt(_parentEle.width())-10-parseInt(_ele.width());_ele.css("right",_right+"px"),_ele.css("left","auto")}}},500)}function refreshBotData(){function checkConnection(){$element.find(".kore-chat-window .kore-chat-header .header-title").text()===_selectedStream.name?$scope.isConnecting=!1:40>count&&$timeout(function(){checkConnection()},500),count++}$scope.isConnecting=!0,$scope.debugInfo=[],$scope.debugRaw={},$scope.debugContext="",$scope.nlTraceData="";var count=0;$element.find(".kore-chat-window .kore-chat-header .reload-btn").length>0&&$element.find(".kore-chat-window .kore-chat-header .reload-btn").trigger("click"),$timeout(function(){checkConnection()},500)}function checkForTempConnections(){var hasTempConn=!1,_nodesWithTempConn=[];return $.each($scope.objList,function(k,obj){return obj.tempConnections&&Object.keys(obj.tempConnections).length>0&&($.each(obj.tempConnections,function(k,tempObj){"end"!==tempObj.targetId&&(hasTempConn=!0,_nodesWithTempConn.push({uId:obj.uId,name:obj.name}))}),hasTempConn)?{hasTempConn:!1}:void 0}),{hasTempConn:hasTempConn,nodes:_nodesWithTempConn}}function writeAndDownloadDialog(filename,data){if(navigator.msSaveBlob){var blob=new Blob([data],{type:"data:text/plain;charset=utf-8"});return window.navigator.msSaveOrOpenBlob(blob,filename)}var element=document.createElement("a");element.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(data)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function setPropertyPanelWidth(){_flowTaskPropertyPanel.css("width",Math.floor(.6*_flowTaskConnectionBlock.width())),_flowTaskPropertyPanel.resizable&&(_flowTaskPropertyPanel.resizable({disabled:!1}),_flowTaskPropertyPanel.resizable("option","maxWidth",Math.floor(.6*_flowTaskConnectionBlock.width()))),$(".flowTaskPropertyPanel").width()<500?($(".propertyPanelExpand").addClass("hide"),$(".propertyPanelCompress").addClass("hide")):($(".propertyPanelExpand").removeClass("hide"),$(".propertyPanelCompress").removeClass("hide"))}function getFlowTasks(){BTFlowtaskService.getFlowtaks($workflowService.selectedStream()._id,_dialogObj._id).then(function(res){if(res&&res.data){$scope.availableFlowTasks=res.data,$scope.formsArray={};var dialogs=res.data,selectedDialog=dialogs.filter(function(obj){return obj._id===_dialogObj._id})[0],formsArray=selectedDialog.nodes.filter(function(obj){return obj.canRegenerate===!0});formsArray.forEach(function(form){$scope.formsArray[form.componentId]=form.regenerateOptions})}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){
var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function fetchDialogBotConfigurations(){BTFlowtaskService.getDialogTaskBotConfiguration(_selectedStream._id,_dialogObj._id).then(function(res){res&&res.data&&($scope.botConfiguration=res.data)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function addFormNodeViaBatch(){var args=($scope.formExperience.args[0],$scope.formExperience.args[1]),nodeId=args[2],connectionId=args[3],formObj=args[4],transisionIndex=0,selectedChannelIds=[],payload={nodeId:nodeId,transitionIndex:transisionIndex,conversationalExperienceChannels:[],dummyConnectionCount:dummyConnectionCount},selectedChannelEles=$element.find(".formExperience .channels-cntr .channel input:checked");if(!selectedChannelEles||!selectedChannelEles.length)return NotificationService.notify(i18n.i18nString("formandconversation_channel_validation"),"warning"),!1;selectedChannelEles.each(function(i,ele){selectedChannelIds.push($(ele).attr("id"))});var transitions=_.find(_dialogObj.nodes,{nodeId:nodeId}).transitions;transitions&&transitions.length&&(transisionIndex=_.findIndex(transitions,function(transition){return transition.metadata&&transition.metadata.connId?transition.metadata.connId===connectionId:!1}),0>transisionIndex&&(transisionIndex=0)),payload.transitionIndex=transisionIndex,payload.conversationalExperienceChannels=selectedChannelIds,"form"===formObj.type&&formObj._id.startsWith("dc")?payload.componentId=formObj._id:payload.formRefId=formObj.refId,BTFlowtaskService.addFormNodeBatch(_selectedStream._id,_dialogObj._id,payload).then(function(res){res.data&&($workflowService.flowtaskInfo(res.data),setDataForEdit(),$scope.closeFormExpModal())},function(err){})}function openBotLevelIVR(){$scope.enableIvrsettings(),$scope.modalSlider.open("#ivrBotLevel")}function openChannelLevelTwilioVoice(){$scope.isAllVoiceEnabled=!0,setTimeout(function(){$scope.prop_panel_voice_channels_all_cb.openChannelLevelTwilioVoice()},500)}function openAudioCodesVoiceProp(){$scope.isAllVoiceEnabled=!0,setTimeout(function(){$scope.prop_panel_voice_channels_all_cb.openAudioCodesVoiceProp()},500)}function updateIvrStreamData(streamObj){BTStreamsService.editStream($workflowService.selectedStream()._id,streamObj).then(function(response){if(response.data.ivrSettings){$scope.enabled=response.data.ivrSettings.enable,$workflowService.selectedStream(response.data);$scope.enabled?i18n.i18nString("settings_enabled"):i18n.i18nString("settings_disabled");prepareIVRData()}})}function prepareIVRData(ivrOptions){$scope.isEnabled=!1,_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable&&($scope.isEnabled=_selectedStream.ivrSettings.enable,ivrOptions?ivrOptions&&!ivrOptions.errorPrompts&&(ivrOptions.errorPrompts=[]):(ivrOptions={},$workflowService.cloneData(_defaultIVRProps,ivrOptions)),ivrOptions&&ivrOptions.grammars&&($scope.originalIvrGrammerCopy=$workflowService.cloneData(ivrOptions.grammars)),ivrOptions.advance&&ivrOptions.advance.properties&&($scope.originalIvrVxmlCopy=$workflowService.cloneData(ivrOptions.advance.properties)))}function updateSmartalert(data){if(data){var params={action:"updateSmartalert",payload:data};$scope.sendEventToIframe(params)}}function updateAlertRef(data){if(data){var params={action:"updateAlertRef",payload:data};$scope.sendEventToIframe(params)}}function updateNotification(data){if(data){var params={action:"updateNotification",payload:data};$scope.sendEventToIframe(params)}}function saveSmartAlertSubscriptionComponent(data){var params={action:"smartAlertSave",payload:data};$scope.sendEventToIframe(params)}var _flowTaskConnectionBlock=$element.find(".flowTaskConnectionBlock");$(".botDetailsForm").addClass("dialogModalOpen"),$scope.conversationBuilder=!1,$scope.loadDialog=!0,$scope.initialLoading=!0;var _flowTaskPropertyPanel=$element.find(".flowTaskPropertyPanel");$scope.accessRights=accessControlService.getAccessRight("BOTBUILDER_TASKS");var previousState=window.localStorage.getItem("previousState");previousState&&(previousState=JSON.parse(previousState),previousState&&previousState.isFromKora&&($scope.isFromKora=!0)),$scope.nlpPermission=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.callback={},$scope.dialogTemplateLoadFlag=function(){$scope.loadingDialogsTemplate=!1},$scope.migrationJourney={showUpgrade:!1},$scope.flowtaskApi={},$scope.savingtask=i18n.i18nString("saving"),$scope.clone=i18n.i18nString("clone"),$scope.offline=i18n.i18nString("offline_mode"),$scope.online=i18n.i18nString("online_mode"),$scope.talk=i18n.i18nString("talk_to"),$scope._constants_=$workflowService.cloneData($rootScope._constants_),$scope.flowtaskApi.type=i18n.i18nString("flowtask");var _objList=[],_objConnection=[];$scope.modalSlider={};var count=0,dummyConnectionCount=0;$scope.saveNodeInProgress=!1;var _dialogObj={};$scope.dialogSettingsCB={},$scope.openLInkedTaskSliderCB={open:!1},$scope.openManageInterruptions={},$scope.allNodeInstancesListObj={},$scope.dialogSettingsCB.show=!1;var _currentSourceNode="",_dummyConnectionId="",_previousPropertyPanelUid="";$scope.editComponentLockInView=$workflowService.flowtaskInfo().editComponentLockInView,$scope.flowtaskObj=$workflowService.flowtaskInfo()||{},$scope.stream=$workflowService.selectedStream(),$scope.loadAuthForm=!1,$scope.dialogReportCB={},$scope.btUtteranceCb={},$scope.createTestCaseConfig={},$scope.flowtaskObj.sceneRefId?($scope.conversationBuilder=!0,setTimeout(function(){var iframe=$("#dialogIFrame");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")})})},100)):!$scope.flowtaskObj||"configured"!=$scope.flowtaskObj.state&&"awaitingApproval"!=$scope.flowtaskObj.state&&"rejected"!=$scope.flowtaskObj.state||"FULL"!=$scope.accessRights||"edit"!=$scope.displayMode||"solution"===$scope.stream.type||($scope.migrationJourney.showUpgrade=!0);var newDialog=!1;$workflowService.newDialogUpgrade()&&$scope.conversationBuilder&&(newDialog=!0,$workflowService.newDialogUpgrade(null,!0));var dialogUrlRoute="/builderx/conversation/dialog/"+$scope.stream._id+"/"+$scope.flowtaskObj._id+"?new="+newDialog;navigator&&navigator.currentNavigationObj&&"storyboard"===navigator.currentNavigationObj.selectedMenuItem?($scope.selectedDialogMode="conversation",dialogUrlRoute="/builderx/conversation/stories/"+$scope.stream._id+"/"+$scope.flowtaskObj.sceneRefId+"/storyEdit?new="+newDialog+"&dialogId="+$scope.flowtaskObj._id):$scope.selectedDialogMode="dialog",window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.dialogUrl=$sce.trustAsResourceUrl("http://localhost:4200"+dialogUrlRoute):$scope.dialogUrl=window.appConfig.API_SERVER_URL+dialogUrlRoute,$scope.switchConversationType=function(type){$scope.selectedDialogMode=type,"training"===type?$scope.openManageTraining():"dialog"===type?($scope.closeManageTraining(),jsEvents.postMessageToChildIframes("switchToDialogBuildView","#dialogIFrame",{streamId:$scope.stream._id,dialogId:$scope.flowtaskObj._id})):"conversation"===type&&($scope.closeManageTraining(),jsEvents.postMessageToChildIframes("switchToConversationView","#dialogIFrame",{streamId:$scope.stream._id,sceneId:$scope.flowtaskObj.sceneRefId,dialogId:$scope.flowtaskObj._id}))},$scope.showBanner=function(){$scope.showUpgradeBanner=!0,setTimeout(function(){$scope.showUpgradeBanner=!1},3500)},$scope.closeBanerHead=function(){$scope.showUpgradeBanner=!1},$scope.selectedDialogId=$scope.flowtaskObj._id,$scope.dialogTaskList=$workflowService.dialogTasks()||{},$scope.dialogTasksByState=$workflowService.dialogTasksByState()||{},$scope.amendEntityOptions={continueFromAmendedNode:i18n.i18nString("re-execute_dialog"),continueFromCurrentNode:i18n.i18nString("re_execute_currdialog")},$scope.fromSmart=$workflowService.kgDataFromKora().fromSmart,$scope.fromWorkbench=$workflowService.kgDataFromKora().fromWorkbench;var _selectedStream=$workflowService.selectedStream(),errorMessages=$workflowService.seedData().entityErrorMessages[$workflowService.currentLanguage()]||{};errorMessages.string&&(errorMessages.label=errorMessages.string),$scope.manage_var_flowtask_form__cb={},$scope.manage_var_flowtask_form__cb.flagName="dialog",$scope.manageVarFlowTaskFormEnable=!1,$scope.runBot={show:!0,hideSubBar:!1,fromDialogTask:!0},$scope.objList={},$scope.firstNodeUId="",$scope.rightClass="right500",$scope.firstNodeComponentId="",$scope.selectedNode="",$scope.selectedGroup="",$scope.groupNodeIntentsObj={};var _menuFocusedNode="";$scope.isPropertyPanelOpened=!1,$scope.isDebugConsolePanelOpened=!1,$scope.nodeObjList=[],$scope.isConnecting=!1;var isTaskFailEnabled=$workflowService.selectedStream().botEvents&&$workflowService.selectedStream().botEvents.TASK_FAILURE_EVENT&&$workflowService.selectedStream().botEvents.TASK_FAILURE_EVENT.enabled||!1;$scope.showRunBotHeader=!0,$scope.nodeObj={},$scope.nodeObjLabels={},$scope.nodeObjCount={},$scope.isDebugResized=0,$scope.serviceTypeList=[{name:"REST",value:"rest"},{name:"SOAP",value:"soap"}],$scope.messagesObject=null,$scope.isPrompt=!0,$scope.utterences=[],$scope.authCB={},$scope.btTestFormApi={},$scope.btTestStatus={},$scope.notifierBridge={},$scope.conversationBuilder&&($scope.notifierBridge.dialogType="conversationBuilder"),$scope.notiRefs={},$scope.notiRefs.tempConnections=[],$scope.objListSearch=[],$scope.availableNodesNames={nodes:[],entities:[],mappedIntents:[]},$scope.botConfiguration={enableTryoutMode:!1},$scope.assetsBase=env_conf["assets-url"],$scope.eleCreationInProgress=!1,$scope.search={},$scope.bot={},$scope.bot.importType="fullImport";var _loggerInstance={};$scope.amendEntity={},$scope.allowNamespace=$workflowService.selectedStream().enableNameSpace,$scope.processApps=[],$scope.formSelection=env_conf["context-url"]+"/assets/images/check-green-small.svg",$scope.formDropDown=env_conf["context-url"]+"/assets/icons/caretDown.svg",$scope.upgradeIcon=env_conf["context-url"]+"/assets/icons-new/upgradeIcon.svg",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.backArrowGray=env_conf["context-url"]+"/assets/icons/back-arrow-gray.svg",$scope.ellipsisGray=env_conf["context-url"]+"/assets/icons/ellipsisGray.svg",$scope.ellipsisWhite=env_conf["context-url"]+"/assets/icons/ellipsisWhite.svg",$scope.caretRightGray=env_conf["context-url"]+"/assets/icons-new/caret/caret-right-gray.svg",$scope.caretRightGreen=env_conf["context-url"]+"/assets/icons-new/caret/caret-right-green.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.emptyIllustration=env_conf["context-url"]+"/img/empty-illustration.svg",$scope.upgradeFlow=env_conf["context-url"]+"/img/upgrade-dialog.png",$scope.upgradeFlowBig=env_conf["context-url"]+"/img/upgrade-dialog-big.png",$scope.trashRed=env_conf["context-url"]+"/assets/icons-new/delete-trash/trash-red.svg",$scope.successIcon=env_conf["context-url"]+"/assets/upgrade/success-icon.svg",$scope.failIcon=env_conf["context-url"]+"/assets/upgrade/success-icon.svg",$scope.trainingIcon=env_conf["context-url"]+"/assets/icons-new/training/training.svg",$scope.debugLogCB={},$scope.arrowLeftWhiteIcon=env_conf["context-url"]+"/assets/icons-new//arrow/arrow-left-white.svg",$scope.communication=env_conf["context-url"]+"/assets/dialog-creation/communication.svg",$scope.compare=env_conf["context-url"]+"/assets/dialog-creation/compare.svg",$scope.peopleWorkingTogether=env_conf["context-url"]+"/assets/dialog-creation/people_working_together.svg",$scope.betaNew=$scope.assetsBase+"icons-new/beta/beta-new.svg",$scope.defaultMaxRetry={retry_limit:5,action:"endOfDialog"},$scope.currentIntent={},$scope.loadUtteranceModule=!1,$scope.notifierBridge.onNotificationClick=function(navigateInfo){$scope.conversationBuilder?jsEvents.postMessageToChildIframes("nodeWarnClick","#dialogIFrame",navigateInfo):$scope.notificationNavigate(navigateInfo)},$scope.notificationNavigate=function(navigateInfo){scrollToNode(navigateInfo.nodeId,function(){$scope.selectCurrentNode(navigateInfo.nodeId,navigateInfo.nodeSection)})},$timeout(function(){$("li.dropdownSearchInput input").on("click",function(event){event.stopPropagation(),$(".dropdown.taskContainer").toggleClass("open"),$(".dropdown.taskContainer").addClass("open")}),$("li.dropdownSearchInput input").on("focus",function(event){event.stopPropagation(),$(".dropdown.taskContainer").addClass("open")})},2e3),$scope.ivrSettingsDefault={ivrSettings:{asrConfidenceThreshold:{key:"confidenceLevel",value:0},extraction_key:"userinput",enable:!1,timeout:"30",enable_log:!0,retry_limit:"6",properties:[],enable_transcript:!1,transcript_tag:"",callTerminationHandler:"",bargein:!1,timeoutPrompts:[[{type:"text",value:""}]],nomatchPrompts:[[{type:"text",value:""}]],grammars:[]}},$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.pencilIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/pencilIcon.svg",$scope.trashIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/trashIcon.svg",$scope.checkTickIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/checkTickIcon.svg",$scope.chatIcon=$scope.assetsBase+"images/left-menu-img/chatIcon.svg",$scope.availableFlowTasks=[],$scope.footerInfoTitle=i18n.i18nString("footer_info_title"),$scope.nameDescription=i18n.i18nString("name_desc"),$scope.dialogEntities=[],$scope.conManageResponseCB={},$scope.openManageResponseConv=function(key){$scope.showStandardResponses=!0,$scope.conManageResponseCB.title=i18n.i18nString("confirm_dialog_task"),$scope.conManageResponseCB.conditionKey=$scope._constants_.pauseResumeMessages[key],setTimeout(function(){var _btnValue="close";$scope.conManageResponseCB.openManageResponse(_btnValue),$scope.conManageResponseCB.initMessages("FULL")},500)},$scope.conManageResponseCB.closeResponseScreen=function(){$scope.conManageResponseCB.conditionKey={},$scope.showStandardResponses=!1},$scope.searchText="",$scope.searchUId="",$scope.runBot.hideSubBar=!1,$scope.highlight=function(uId,item,search){var count="";$scope.nodeObjCount&&$scope.nodeObjCount[item.componentId]&&$scope.nodeObjCount[item.componentId][uId]&&$scope.nodeObjCount[item.componentId].count>1&&(count="<span class='objCount'> ["+$scope.nodeObjCount[item.componentId][uId]+"]</span>");var text=item.name;"intent"==item.type&&(text=item.intent);try{text=$sanitize(text)}catch(ex){console.warn(ex),text="Malcious script"}if(!search)return text+count;var _replaceStr='<span class="highlightedText">$&</span>';return $scope.searchUId===uId&&(_replaceStr='<span class="highlightedText selected">$&</span>'),text.replace(new RegExp(search,"gi"),_replaceStr)+count},$scope.processUpgrade=function(type){if("backup"===type){var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:$scope.flowtaskObj.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"User has requested to take Bot Export during dialog upgrade from V1 to V2 is initiated"};mixPanel.postEvent("Upgrade to Dialog Builder V2 - Backup Initiated",dialogData),$scope.migrationJourney.step="createBotversion"}if("close"===type&&$scope.closeupgadeToNewDialog(),"createVersion"===type){if(!$scope.migrationJourney.versionName)return void NotificationService.notify("Please provide bot version name","error");$scope.migrationJourney.step="versionInProgress",$scope.createVersion()}"upgrade"===type&&($scope.startUpgrading(),$scope.migrationJourney.step="upgradeInProgress")},$scope.getStarted=function(){$workflowService.newDialogUpgrade($scope.migrationJourney.newDialog._id),$scope.changeDialogTask($scope.migrationJourney.newDialog,$scope.migrationJourney.newDialog)},$scope.startUpgrading=function(){BTFlowtaskService.migrateFlowtask(_selectedStream._id,$scope.flowtaskObj._id).then(function(res){$scope.migrationJourney.step="upgradeSuccess";var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:$scope.flowtaskObj.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"Dialog is successfully upgraded from V1 to V2 is initiated"};mixPanel.postEvent("Upgrade to Dialog Builder V2 - Completed",dialogData),$scope.migrationJourney.newDialog=res.data,$scope.migrationJourney.modalOpen||$scope.closeupgadeToNewDialog()},function(error){var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:$scope.flowtaskObj.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"Error in upgrading Dialog from V1 to V2"};mixPanel.postEvent("Upgrade to Dialog Builder V2 - Failed",dialogData),_botComponents="error"})},$scope.createVersion=function(version){$scope.versionStatus="inprogress";var _payload={name:$scope.migrationJourney.versionName,description:""};BTStreamsService.createVersion(_selectedStream._id,_payload).then(function(response){$scope.verionStatus(response.data,!0)},function(err){$scope.migrationJourney.step="versionFailure",err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Creation of new Bot Version "+$scope.migrationJourney.versionName+" has failed.","error")})},$scope.verionStatus=function(data,initialCall){data&&("success"===data.status.toLowerCase()?"versionSuccess"!==$scope.migrationJourney.step&&($scope.migrationJourney.step="versionSuccess"):initialCall&&"in_progress"===data.status.toLowerCase()?(NotificationService.notify("Creation of new Bot Version "+$scope.migrationJourney.versionName+" is in progress.","success"),$rootScope.$broadcast("getProgressDockStatus"),$scope.migrationJourney.step="versionInProgress"):"failure"===data.status.toLowerCase()&&($scope.migrationJourney.step="versionFailure",NotificationService.notify("Creation of new Bot Version "+$scope.migrationJourney.versionName+" has failed.","error")))},$scope.callBack.verionStatus=$scope.verionStatus,$scope.closeUpgradePop=function(){},$scope.upgadeToNewDialog=function(){$scope.closeUpgradePop(),$scope.migrationJourney.modalOpen=!0,$("#upgradeDialog").modal("show");var dialogData={streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:$scope.flowtaskObj.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"Dialog upgrade from V1 to V2 is initiated"};mixPanel.postEvent("Upgrade to Dialog Builder V2 - Initiated",dialogData)},$scope.closeupgadeToNewDialog=function(){$scope.closeUpgradePop(),$scope.migrationJourney.step=null,$scope.migrationJourney.modalOpen=!1;({streamId:_selectedStream._id,BotName:_selectedStream.name,DialogName:$scope.flowtaskObj.name,Category:"Dialog Builder",SubCategory:"Dialog Creation","Event Description":"Dialog upgrade from V1 to V2 is canceled"});$("#upgradeDialog").modal("hide")},$scope.openCommentsSlider=function(){jsEvents.postMessageToChildIframes("openCommentsSlider","#dialogIFrame")},$scope.openConversationCommentsSlider=function(){jsEvents.postMessageToChildIframes("conversationComments","#dialogIFrame")},$scope.openShareSlider=function(){jsEvents.postMessageToChildIframes("openShareSlider","#dialogIFrame")},$scope.openPreviewSlider=function(){jsEvents.postMessageToChildIframes("openPreviewSlider","#dialogIFrame")},$scope.refreshConversation=function(){jsEvents.postMessageToChildIframes("refreshConversation","#dialogIFrame")},$scope.menuAction=function(method){jsEvents.postMessageToChildIframes(method,"#dialogIFrame")},$scope.objSearchedInfo=function(srchStr,key,name){$scope.searchText=srchStr,$scope.searchUId=key,$scope.conversationBuilder&&name?jsEvents.postMessageToChildIframes("dialogSearch","#dialogIFrame",name):key&&key.length>0&&scrollToNode(key)},window.notifierBridge=$scope.notifierBridge,$scope.dialogMode=null,$scope._constants_=$rootScope._constants_,$scope.isWorkProgress=!1,$scope.loaderMessage=i18n.i18nString("working"),$scope.importDialogHeader=i18n.i18nString("import_dialog_desc"),$scope.importModalTitle=i18n.i18nString("a_dialog"),$scope.doneImporting=!1,$scope.dialogRequiredError=!1;var _connectionColors=["#299d8e","#5ea8d3","#e9c369","#f3a261","#533a71","#6183d8","#50c5b7","#7ac74f","#1c77c3","#9f86c0"];$scope.botColor=_selectedStream.color,$scope.selectedStreamName=_selectedStream.name,$scope.configurableElements={message:{type:"message",name:i18n.i18nString("constants.flowtasks_message"),description:i18n.i18nString("configurable_msg_desc"),shortDesc:i18n.i18nString("configurable_msg_name"),showCreate:!0},dialogAct:{type:"dialogAct",name:i18n.i18nString("confirmation_caps"),description:i18n.i18nString("configurable_dialogact_desc"),shortDesc:i18n.i18nString("configurable_dialogact_name"),showCreate:!0},entity:{type:"entity",name:i18n.i18nString("entity_caps"),description:i18n.i18nString("configurable_entity_identification"),shortDesc:i18n.i18nString("configurable_entity_name"),showCreate:!0},form:{type:"form",name:i18n.i18nString("form_node_name"),description:i18n.i18nString("configurable_form_desc"),shortDesc:i18n.i18nString("configurable_form_name"),showCreate:!0},logic:{type:"logic",name:i18n.i18nString("logic_node_name"),description:i18n.i18nString("configurable_logic_desc"),shortDesc:i18n.i18nString("configurable_logic_name"),showCreate:!0},service:{type:"service",name:i18n.i18nString("service_caps"),description:i18n.i18nString("configurable_service_desc"),shortDesc:i18n.i18nString("configurable_service_name"),showCreate:!0},script:{type:"script",name:i18n.i18nString("script_caps"),description:i18n.i18nString("configurable_script_desc"),shortDesc:i18n.i18nString("configurable_script_name"),showCreate:!0},subDialog:{type:"subDialog",name:i18n.i18nString("dialog_caps"),description:i18n.i18nString("configurable_subdialog_desc"),shortDesc:i18n.i18nString("configurable_subdialog_name"),showCreate:!1},SDKWebHook:{type:"SDKWebHook",name:i18n.i18nString("webhook_caps"),description:i18n.i18nString("configurable_webhook_desc"),shortDesc:i18n.i18nString("configurable_webhook_name"),showCreate:!0},intent:{type:"intent",name:i18n.i18nString("user_intent"),description:i18n.i18nString("configurable_intent_desc"),shortDesc:i18n.i18nString("configurable_intent_name"),showCreate:!0},process:{type:"process",name:"PROCESS",description:"",shortDesc:i18n.i18nString("configurable_process_name"),showCreate:!0}},$rootScope.appConfig.DISABLE_AGENT_TRANSFER||($scope.configurableElements.agentTransfer={type:"agentTransfer",name:i18n.i18nString("agent_transfer_caps"),description:i18n.i18nString("configurable_agenttransfer_desc"),shortDesc:i18n.i18nString("configurable_agenttransfer_name"),showCreate:!0}),"universalbot"===$scope.stream.type&&($scope.configurableElements.subDialog.disbleAdd=!0,$scope.configurableElements.intent.disbleAdd=!0),"universalbot"===$scope.stream.type&&(delete $scope.configurableElements.logic,delete $scope.configurableElements.form);var resetFlag,_nodeObj={type:"",name:"",uId:"",connections:{},tempConnections:{},hide:!0,desc:"",componentId:"",nodeNumber:0},_connObj={connId:"",sourceId:"",targetId:"",isDefault:!1,ifConditionPrefix:"context",ifCondition:"",ifOperator:"",value:"",color:"#009dab",top:0,showBottom:!1,connObjNumber:1},_ifOperatorList={"=":{name:"equals to",val:"="},">=":{name:"greater than equals to",val:">="},"<=":{name:"less than equals to",val:"<="},"!=":{name:"not equals to",val:"!="},">":{name:"greater than",val:">"},"<":{name:"less than",val:"<"},"":{name:"exists",val:""},eq:{name:"equals to",val:"="},gte:{name:"greater than equals to",val:">="},lte:{name:"less than equals to",val:"<="},neq:{name:"not equals to",val:"!="},gt:{name:"greater than",val:">"},lt:{name:"less than",val:"<"}},_botComponents=[];$scope.fromSearch=!1;var _forms=[],_nodeColors={subDialog:"#eaa724",intent:"#57187f",entity:"#3ab962",script:"#9b9b9b",SDKWebHook:"#8B572A",agentTransfer:"#8B572A",service:"#4a4a4a",message:"#007eff",dialogAct:"#1d758e",form:"#bd10e0",logic:"#ff001f",process:"#135423"};$element.connections({action:"updateColors",nodeColors:_nodeColors}),$scope.displayOpts={hideType:!1,hideNode:!1,hideConn:!1},$scope.serviceNodeOptions=[{value:"custom",name:$scope._constants_.flowtasks.serviceTypes.custom},{value:"htmltoimage",name:$scope._constants_.flowtasks.serviceTypes.htmlToImage},{value:"urltoimage",name:$scope._constants_.flowtasks.serviceTypes.urlToImage}],$scope.ifOperatorsFollowupIntents=[{name:"Contains",val:"cnt"},{name:"Exists",val:""}];var _defaultIVRProps=$workflowService.defaultComponentIVRProps();_defaultIVRProps.grammars=[],$scope.flowtaskApi.getIfOperatorsFollowupIntents=function(){return $scope.ifOperatorsFollowupIntents},$scope.flowtaskApi.getIVRDefaults=function(){return _defaultIVRProps},$scope.prepareComponentCount=function(node,dialogNodeslist){if(!dialogNodeslist&&node)$scope.allNodeInstancesListObj[node.nodeId]=node,node&&node.transitions&&node.transitions.length&&node.transitions[0].metadata&&node.transitions[0].metadata.groupNodeIntent?$scope.groupNodeIntentsObj[node.nodeId]=node:($scope.nodeObjCount[node.componentId]||($scope.nodeObjCount[node.componentId]={count:0},$scope.nodeObjCount[node.componentId][node.nodeId]=$scope.nodeObjCount[node.componentId].count),$scope.nodeObjCount[node.componentId].count=$scope.nodeObjCount[node.componentId].count+1,$scope.nodeObjCount[node.componentId][node.nodeId]=$scope.nodeObjCount[node.componentId].count);else{var dialogData=$workflowService.flowtaskInfo();$scope.nodeObjCount={},$scope.allNodeInstancesListObj={},$.each(dialogData.nodes,function(k,nodeele){$scope.allNodeInstancesListObj[nodeele.nodeId]=nodeele,nodeele&&nodeele.transitions&&nodeele.transitions.length&&nodeele.transitions[0].metadata&&nodeele.transitions[0].metadata.groupNodeIntent?$scope.groupNodeIntentsObj[nodeele.nodeId]=nodeele:($scope.nodeObjCount[nodeele.componentId]||($scope.nodeObjCount[nodeele.componentId]={count:0},$scope.nodeObjCount[nodeele.componentId][nodeele.nodeId]=$scope.nodeObjCount[nodeele.componentId].count),$scope.nodeObjCount[nodeele.componentId].count=$scope.nodeObjCount[nodeele.componentId].count+1,$scope.nodeObjCount[nodeele.componentId][nodeele.nodeId]=$scope.nodeObjCount[nodeele.componentId].count)})}},$scope.flowtaskApi.updateComponentLock=function(){$scope.propertyCb.closePropertyPanel(),BTFlowtaskService.getComponents(_selectedStream._id).then(function(res){_botComponents=res&&res.data,updateDialogEntities(),intialize(),fetchDialogBotConfigurations(),getFlowTasks(),$scope.selectedNode="",$scope.selectedGroup=""},function(error){_botComponents="error"})},$scope.flowtaskApi.updateClonedComponent=function(newNodeValue,oldNodevalue){$scope.propertyCb.closePropertyPanel(),$scope.currentNodeId=oldNodevalue.nodeId,$.each($scope.objList,function(k,obj){obj.uId===oldNodevalue.nodeId&&(obj.name=newNodeValue.name,obj._id=newNodeValue._id,obj.editLocked=newNodeValue.editLocked)});var _updateParams={streamId:_dialogObj.streamId,name:_dialogObj.name,nodes:[],displayOption:_dialogObj.displayOption,visibility:_dialogObj.visibility};_dialogObj.nodes&&_dialogObj.nodes.length>0?$.each(_dialogObj.nodes,function(k,node){node.nodeId==oldNodevalue.nodeId&&(node.componentId=newNodeValue._id),node.nodeOptions=node.nodeOptions||{},_updateParams.nodes.push(node)}):_dialogObj.nodes=[],BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_updateParams).then(function(res){$workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0),console.log("Connection Added"),_dialogObj=res&&res.data,BTFlowtaskService.getComponents(_selectedStream._id).then(function(res){_botComponents=res&&res.data,updateDialogEntities(),intialize(),fetchDialogBotConfigurations(),getFlowTasks()},function(error){_botComponents="error"})})},$scope.updateWarnings=function(data){_objList=data.objList,_objList&&_objList.hasOwnProperty("intent0")&&_objList.intent0.intent&&($scope.flowtaskObj.name=_objList.intent0.intent),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings(),data.tempConnections&&($scope.notiRefs.tempConnections&&$scope.notiRefs.tempConnections.length&&$scope.notiRefs.tempConnections.forEach(function(con){$scope.notifierBridge.remove(con)}),$scope.notiRefs.tempConnections=[],$.each(data.tempConnections,function(k,tempConnWarn){if($scope.notifierBridge&&$scope.notifierBridge.notify){var _nRef=$scope.notifierBridge.notify(tempConnWarn);$scope.notiRefs.tempConnections.push(_nRef)}}))};var prepareComponents=function(streamId,componentId){BTFlowtaskService.getComponents(streamId,componentId).then(function(response){_dialogObj&&_dialogObj.nodes[0]&&_dialogObj.nodes[0].componentId===componentId&&($scope.primaryIntentOb=response.data)})};$scope.conversationBuilder?(_dialogObj=$workflowService.flowtaskInfo(),_dialogObj.nodes&&_dialogObj.nodes.length>0&&($scope.firstNodeUId=_dialogObj.nodes[0].nodeId),prepareDisplayOptions(),prepareComponents(_selectedStream._id,_dialogObj.nodes[0].componentId)):(getComponents(),intialize(),prepareComponents(_selectedStream._id,_dialogObj.nodes[0].componentId)),$scope.editPrompt=function(messages,isPrompt,openIndex,category,isInstancePrompts,promptType){category=category||"",$scope.messagesObject={},$scope.isPrompt=isPrompt,$scope.messagesObject.messages={},$scope.messagesObject.taskId=_dialogObj._id,$scope.messagesObject.nodeId=$scope.selectedNode.nodeInfo._id,$scope.messagesObject.name=$scope.selectedNode.nodeInfo.name,$scope.messagesObject.nodeInfo=$scope.selectedNode,$scope.messagesObject.category=category,$scope.messagesObject.isInstancePrompts=isInstancePrompts||!1,openIndex&&-1!==openIndex&&($scope.messagesObject.openIndex=openIndex),promptType?$scope.promptType=promptType:$scope.promptType=null,$scope.dialogMode="prompt",$timeout(function(){$scope.messagesObject={},$scope.isPrompt=isPrompt,messages.forEach(function(message){message.text=decodeURIComponent(message.text)}),$scope.messagesObject.messages=$workflowService.cloneData(messages),$scope.messagesObject.taskId=_dialogObj._id,$scope.messagesObject.nodeId=$scope.selectedNode.nodeInfo._id,$scope.messagesObject.name=$scope.selectedNode.nodeInfo.name,$scope.messagesObject.nodeInfo=$scope.selectedNode,$scope.messagesObject.category=category,$scope.messagesObject.isInstancePrompts=isInstancePrompts||!1,openIndex&&-1!==openIndex&&($scope.messagesObject.openIndex=openIndex),$timeout(function(){$("#userprompt_configure").modal({backdrop:"static",show:!0})},250)},100)},$scope.onPromptClose=function(){$("#userprompt_configure").modal("hide"),$scope.dialogMode=null},$scope.onDone=function(messages,multiCategory,isInstancePrompts,promptType){if($("#userprompt_configure").modal("hide"),$scope.dialogMode=null,promptType&&"submit"===promptType){$scope.selectedNode.nodeInfo.submitMessage=$workflowService.cloneData(messages),messages.forEach(function(message){message.text=encodeURIComponent(message.text)});$scope.propertyCb.updateSubmitMessages&&$scope.propertyCb.updateSubmitMessages(messages);$scope.selectedNode.nodeInfo.submitMessage=$workflowService.cloneData(messages)}else if(multiCategory)if(isInstancePrompts){$scope.selectedNode.dialogNodeInstance.nodeOptions.multiCategoryPrompts=multiCategory;$scope.propertyCb.updateEntityInstanceMulticategoryMessages&&$scope.propertyCb.updateEntityInstanceMulticategoryMessages(messages)}else{$scope.selectedNode.nodeInfo.multiCategoryPrompts=multiCategory;$scope.propertyCb.updateMulticategoryMessages&&$scope.propertyCb.updateMulticategoryMessages(messages);
}else if(isInstancePrompts){$scope.selectedNode.dialogNodeInstance.nodeOptions.message=$workflowService.cloneData(messages),messages.forEach(function(message){message.text=encodeURIComponent(message.text)});$scope.propertyCb.updateEntityInstanceMessages&&$scope.propertyCb.updateEntityInstanceMessages(messages);$scope.selectedNode.dialogNodeInstance.nodeOptions.message=$workflowService.cloneData(messages)}else{$scope.selectedNode.nodeInfo.message=$workflowService.cloneData(messages),messages.forEach(function(message){message.text=encodeURIComponent(message.text)});$scope.propertyCb.updateMessages&&$scope.propertyCb.updateMessages(messages);$scope.selectedNode.nodeInfo.message=$workflowService.cloneData(messages)}$scope.propertyCb&&$scope.propertyCb.prepareInstancePrompts&&$scope.propertyCb.prepareInstancePrompts(!0)},$scope.editError=function(errors,openIndex,category,isInstancePrompts){$scope.errorObject={},$scope.errorObject.errors={},$scope.errorObject.taskId=_dialogObj._id,$scope.errorObject.nodeId=$scope.selectedNode.nodeInfo._id,$scope.errorObject.name=$scope.selectedNode.nodeInfo.name,$scope.dialogMode="error",$scope.errorObject.nodeInfo=$scope.selectedNode,$scope.errorObject.category=category,$scope.errorObject.isInstancePrompts=isInstancePrompts||!1,openIndex&&-1!==openIndex&&($scope.errorObject.openIndex=openIndex),$timeout(function(){$scope.errorObject={},errors.forEach(function(message){message.text=decodeURIComponent(message.text)}),$scope.errorObject.errors=$workflowService.cloneData(errors),$scope.errorObject.taskId=_dialogObj._id,$scope.errorObject.nodeId=$scope.selectedNode.nodeInfo._id,$scope.errorObject.name=$scope.selectedNode.nodeInfo.name,$scope.errorObject.nodeInfo=$scope.selectedNode,$scope.errorObject.isInstancePrompts=isInstancePrompts||!1,$scope.errorObject.category=category,openIndex&&-1!==openIndex&&($scope.errorObject.openIndex=openIndex),$timeout(function(){$("#errorprompt_configure").modal({backdrop:"static",show:!0})},250)},100)},$scope.onErrorPromptClose=function(){$("#errorprompt_configure").modal("hide"),$scope.dialogMode=null},$scope.onErrorPromptDone=function(messages,multiCategory,isInstancePrompts){if($("#errorprompt_configure").modal("hide"),$scope.dialogMode=null,multiCategory)if(isInstancePrompts){$scope.selectedNode.dialogNodeInstance.nodeOptions.multiCategoryPrompts=multiCategory;$scope.propertyCb.updateEntityInstanceMulticategoryMessages&&$scope.propertyCb.updateEntityInstanceMulticategoryMessages(messages)}else{$scope.selectedNode.nodeInfo.multiCategoryPrompts=multiCategory;$scope.propertyCb.updateMulticategoryMessages&&$scope.propertyCb.updateMulticategoryMessages(messages)}else if(isInstancePrompts){$scope.selectedNode.dialogNodeInstance.nodeOptions.errorMessage=$workflowService.cloneData(messages),messages.forEach(function(message){message.text=encodeURIComponent(message.text)});$scope.propertyCb.updateEntityInstanceErrorMessages&&$scope.propertyCb.updateEntityInstanceErrorMessages(messages);$scope.selectedNode.dialogNodeInstance.nodeOptions.errorMessage=$workflowService.cloneData(messages)}else{$scope.selectedNode.nodeInfo.errorMessage=$workflowService.cloneData(messages),messages.forEach(function(message){message.text=encodeURIComponent(message.text)});$scope.propertyCb.updateErrorMessages&&$scope.propertyCb.updateErrorMessages(messages);$scope.selectedNode.nodeInfo.errorMessage=$workflowService.cloneData(messages)}$scope.propertyCb&&$scope.propertyCb.prepareInstancePrompts&&$scope.propertyCb.prepareInstancePrompts(!0)};var decodePattern=function(patternText){if(patternText)try{return patternText.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return patternText}};$scope.getNodeMessages=function(component,checkType){var _msg="";if(component&&component.componentId)if("entity"===component.type&&component.nodeOptions&&component.nodeOptions.message&&component.nodeOptions.message.length>0)if(checkType&&"uxmap"===component.nodeOptions.message[0].type)_msg=i18n.i18nString("custom_js");else try{_msg=decodeURIComponent(decodePattern(component.nodeOptions.message[0].text))}catch(e){_msg=component.nodeOptions.message[0]&&component.nodeOptions.message[0].text||""}else $.each(_objList,function(k,obj){if(obj._id===component.componentId){if(obj.multiCategoryPrompts&&obj.multiCategoryPrompts.length&&"dateperiod"===obj.entityType){if(checkType&&obj.multiCategoryPrompts[0]&&obj.multiCategoryPrompts[0].message&&obj.multiCategoryPrompts[0].message[0]&&"uxmap"===obj.multiCategoryPrompts[0].message[0].type)_msg=i18n.i18nString("custom_js");else if(obj.multiCategoryPrompts[0]&&obj.multiCategoryPrompts[0].message)try{_msg=decodeURIComponent(obj.multiCategoryPrompts[0].message[0]&&obj.multiCategoryPrompts[0].message[0].text)}catch(e){_msg=obj.multiCategoryPrompts[0].message[0]&&obj.multiCategoryPrompts[0].message[0].text||""}}else if(checkType&&obj.message&&obj.message[0]&&"uxmap"===obj.message[0].type)_msg=i18n.i18nString("custom_js");else if(obj.message&&obj.message.length)try{_msg=decodeURIComponent(obj.message[0]&&obj.message[0].text)}catch(e){_msg=obj.message[0]&&obj.message[0].text||""}return!1}});return _msg},$scope.getAppName=function(item){var _selectApp=_.find($scope.processApps,{refId:item.resourceId});return _selectApp?_selectApp.name:""},$scope.getRetryMessage=function(item){var _str="On Exceeding retries go to ";if(item.nodeOptions&&item.nodeOptions.eventOptions&&item.nodeOptions.eventOptions.defaultMaxRetry&&"executeNode"===item.nodeOptions.eventOptions.defaultMaxRetry.action&&""!==item.nodeOptions.eventOptions.defaultMaxRetry.ref){var nodeObj=_.find($scope.objList,{uId:item.nodeOptions.eventOptions.defaultMaxRetry.ref});if(nodeObj)return _str=_str+nodeObj.name+($scope.nodeObjCount[nodeObj.componentId].count>1?"["+$scope.nodeObjCount[nodeObj.componentId].count+"]":"")}},$scope.editGroupNodeName=function(group){$scope.editGroupNodeInstance=!0,setTimeout(function(){$("#groupedit"+group._id).focus()},100)},$scope.getNodeCount=function(node){var count="";if(node){var compId=node.compId||node.componentId,uId=node.uId||node.nodeId;$scope.nodeObjCount&&$scope.nodeObjCount[compId]&&$scope.nodeObjCount[compId][uId]&&$scope.nodeObjCount[compId].count>1&&(count=" ["+$scope.nodeObjCount[compId][uId]+"]")}return count},$scope.getGroupIntentTransitionFlow=function(intent){var transFlow="Resume the dialog";if(intent&&intent.nodeId&&$scope.groupNodeIntentsObj&&$scope.groupNodeIntentsObj[intent.nodeId]&&$scope.groupNodeIntentsObj[intent.nodeId].targetNode&&"jumpToSpecificNode"===$scope.groupNodeIntentsObj[intent.nodeId].targetNode.type&&$scope.groupNodeIntentsObj[intent.nodeId].targetNode.node){var _node=$scope.objList[$scope.groupNodeIntentsObj[intent.nodeId].targetNode.node],nodeName=(_node.intent||_node.name)+$scope.getNodeCount(_node);transFlow="Jump to a node ("+(nodeName||"")+")"}return transFlow},$scope.deleteGroupNodeIntent=function(item,event){event&&event.stopPropagation(),$scope.groupNodeIntentDeleteInProgess=item,NotificationService.userConfirm("Deleting an intent from a Group will remove it from the Group and will clear all its properties. To permanently delete the intent, visit the Manage Components module.",[function(){saveGroupsToServer(item)},function(){$scope.groupNodeIntentDeleteInProgess=null}],{okText:i18n.i18nString("delete"),btnClass:"btnDelete"},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.editGroupNodeIntent=function(){saveGroupsToServer(),$scope.propertyCb&&$scope.propertyCb.prepareGroupIntnetNodeMessages&&$scope.propertyCb.prepareGroupIntnetNodeMessages();var _payload={nodeOptions:$scope.selectedNode.dialogNodeInstance.nodeOptions,targetNode:$scope.selectedNode.dialogNodeInstance.targetNode,contextMap:"",preConditions:$scope.selectedNode.dialogNodeInstance.preConditions||[]};if($scope.selectedNode&&$scope.selectedNode.dialogNodeInstance&&$scope.selectedNode.dialogNodeInstance.contextMap&&$scope.selectedNode.dialogNodeInstance.contextMap.length){var contextMap={};$.each($scope.selectedNode.dialogNodeInstance.contextMap,function(contextvarkey,context){context.key&&(contextMap[context.key]=context.value)}),_payload.contextMap=JSON.stringify(contextMap)}BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.selectedNode.dialogInfo.dialogId,$scope.selectedNode.dialogNodeInstance.uId,_payload).then(function(res){NotificationService.notify("Intent saved successfully","success"),$scope.dialogData("updateDialog",res&&res.data),$workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.saveGroup=function(group){return group&&!group.name?void NotificationService.notify(i18n.i18nString("empty_group_node_name"),"error"):(group.edit=!1,void saveGroupsToServer())},$scope.selectGroupNodeIntent=function(groupIntent){$scope.selectedNode="",$timeout(function(){if(groupIntent&&(groupIntent.nodeId||groupIntent.uId)){var uid=groupIntent.nodeId||groupIntent.uId;$scope.selectCurrentNode(uid,null,null,!0),$scope.loadingGroupNodeInstanceProperties=!1}},500)},$scope.openGroupIntentModalSlider=function(event,groupIntent){$scope.search={name:""},$scope.loadingGroupIntents=!0,groupIntent&&groupIntent.nodeId?($scope.loadingGroupNodeInstanceProperties=!0,$scope.editGroupNodeInstance=groupIntent):($scope.loadingGroupNodeInstanceProperties=!1,$scope.editGroupNodeInstance=!1),fetchBotComponentsByType("intent",function(){$scope.prepareNodeObjList("intent"),$scope.loadingGroupIntents=!1}),$scope.modalSlider.open("#showGroupNodeIntentSlider"),$scope.selectGroupNodeIntent(groupIntent)},$scope.closeGroupIntentModalSlider=function(saveClose){$scope.search={name:""},!saveClose&&!$scope.editGroupNodeInstance&&$scope.selectGroupNode&&$scope.selectedNode&&$scope.selectedNode.dialogNodeInstance&&$scope.selectedNode.dialogNodeInstance.uId&&$scope.removeTempIntnetNode($scope.selectedNode.dialogNodeInstance.uId),$timeout(function(){$scope.modalSlider.close("#showGroupNodeIntentSlider")},500)},$scope.selectGroupNode=function(group){$scope.selectedNode="",$scope.selectedGroup=group,$scope.isPropertyPanelOpened=!0,_flowTaskPropertyPanel.removeClass("minimized"),$timeout(function(){angular.element($window).trigger("resize")},350)},$scope.removeTempIntnetNode=function(typeID,listOfIdsObj){var _params={name:_dialogObj.name,nodes:[],displayOption:_dialogObj.displayOption,visibility:_dialogObj.visibility},_isIntent=!0;_dialogObj.nodes&&_dialogObj.nodes.length>0&&$.each(_dialogObj.nodes,function(k,node){if(typeID){if(node.nodeId!==typeID){var _nodeObj=node;delete _nodeObj._id,node.transitions&&node.transitions.length>0&&$.each(node.transitions,function(k,transition){transition.then===typeID?(node.transitions[k].then="",_isIntent&&(node.transitions[k]["if"]={intent:""})):transition["default"]===typeID&&(node.transitions[k]["default"]=""),void 0!==transition["default"]&&transition["if"]&&delete node.transitions[k]["if"]}),_params.nodes.push(_nodeObj)}}else if(listOfIdsObj&&Object.keys(listOfIdsObj).length&&!listOfIdsObj[node.nodeId]){var _nodeObjCopy=node;delete _nodeObjCopy._id,node.transitions&&node.transitions.length>0&&$.each(node.transitions,function(k,transition){listOfIdsObj[transition.then]?(node.transitions[k].then="",_isIntent&&(node.transitions[k]["if"]={intent:""})):listOfIdsObj[transition["default"]]&&(node.transitions[k]["default"]=""),void 0!==transition["default"]&&transition["if"]&&delete node.transitions[k]["if"]}),_params.nodes.push(_nodeObjCopy)}delete node.message}),BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_params).then(function(res){$workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0),_dialogObj=res&&res.data;for(var i=0;i<_objList.length;i++)if(_objList[i]._id===$scope.objList[typeID].componentId&&_objList[i].nodeId===typeID){_objList.splice(i,1),i--;break}for(var j=0;j<_objConnection.length;j++)!_objConnection[j]||_objConnection[j].targetId!==typeID&&_objConnection[j].sourceId!==typeID||(_objConnection.splice(j,1),j--);delete $scope.objList[typeID],$scope.objListSearch=[],$scope.groupNodeIntents=[],$.each($scope.objList,function(k,obj){$scope.objListSearch.push({key:obj.uId,val:obj.name}),obj.connections&&Object.keys(obj.connections).length>0&&$.each(obj.connections,function(k,conn){conn&&conn.targetId===typeID?(conn.targetId="",_isIntent&&(conn.ifCondition=""),obj.tempConnections={},$.each(obj.connections,function(k,conn){""===conn.targetId&&(obj.tempConnections[k]=conn)})):conn&&conn["default"]===typeID&&(conn["default"]="",obj.tempConnections[k]=conn)})})},function(error){})},$scope.closeGroupNode=function(){!$scope.editGroupNodeInstance&&$scope.selectedGroup&&$scope.selectedNode&&$scope.selectedNode.dialogNodeInstance&&$scope.selectedNode.dialogNodeInstance.uId&&$scope.removeTempIntnetNode($scope.selectedNode.dialogNodeInstance.uId),$scope.selectedGroup="",$scope.isPropertyPanelOpened=!1},$scope.changeGroupIntentNode=function(event,newSelection){$scope.createEleForConnDefault(event,"intent",newSelection.uId,null,newSelection)},$scope.selectGroupIntent=function(event,intent){if($scope.editGroupNodeInstance=!1,$scope.groupNodeIntent=!0,$scope.loadingGroupNodeInstanceProperties=!0,$scope.selectGroupIntent&&$scope.selectedNode.nodeInfo&&$scope.selectedNode.nodeInfo.intent)NotificationService.userConfirm("Do you want to switch the intent, any changes made for the current intent wil be lost",[function(){$scope.changeGroupIntentNode(event,intent,$scope.selectedNode.dialogNodeInstance)},function(){return $scope.loadingGroupNodeInstanceProperties=!1,!1}],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("confirm_proceed"));else{var nodeType="intent";intent&&intent.dialogRefId&&(nodeType="subDialog"),$scope.createEleForConnDefault(null,nodeType,intent.uId,null,intent)}},$scope.createGroupNodeIntent=function(event){$scope.groupNodeIntent=!0,$scope.groupNodeIntentCreationInprogress=!0,$scope.createEleForConn(event,"intent")},$scope.deleteGroup=function(group){$scope.groupNodeIntentsToDelete=[];var proceeedGroupNodeDelete=function(){$scope.groupNodeIntentsToDelete=group.subIntents||[],$scope.groups=_.without($scope.groups,_.findWhere($scope.groups,{_id:group._id})),NotificationService.notify("The "+group.name+" Group is removed.","success"),rearrangeGroups(),saveGroupsToServer()};group&&group.subIntents&&group.subIntents.length?NotificationService.userConfirm(i18n.i18nString("delete_group_node_popup"),[function(){proceeedGroupNodeDelete()},function(){$scope.groupNodeIntentsToDelete=[]}],{okText:i18n.i18nString("delete"),btnClass:"btnDelete"},"",void 0,i18n.i18nString("confirm_proceed")):proceeedGroupNodeDelete()},$scope.getNodeName=function(nodeId){return $scope.objList[nodeId]?$scope.objList[nodeId].name:nodeId},$scope.getConnTargetId=function(obj){if(""===obj.targetId||"end"===obj.targetId)return"";var _targetObj=$scope.objList[obj.targetId],_targetNum=_targetObj&&_targetObj.type?obj.targetId.replace(_targetObj.type,""):"";return isNaN(_targetNum)?"":1+parseInt(_targetNum)},$scope.getConnectionInfo=function(index,obj,connection){var _msg=0===index?"If ":"Else If ";if(0===index&&connection.isDefault)_msg="Default";else if(connection.isDefault)_msg="Else ";else{var _ifOp=_ifOperatorList[connection.ifOperator]?_ifOperatorList[connection.ifOperator].name:"";if("intent"===obj.type&&void 0===_ifOp?_ifOp="":void 0===_ifOp&&(_ifOp=""),"field"===connection.ifConditionPrefix){var _ifCondName="Entities";$.each(_objList,function(k,obj){obj.nodeId===connection.ifCondition&&(_ifCondName+="."+obj.name)}),""===_ifCondName&&(_ifCondName="Entities"),_msg+=_ifCondName+" "+_ifOp}else if("intent"===connection.ifConditionPrefix)if("followup"===connection.intentType)if(_msg=i18n.i18nString("if_intents"),connection.ifOperator){var _opFound=_.find($scope.ifOperatorsFollowupIntents,{val:connection.ifOperator});if(_opFound&&(_msg+=" "+_opFound.name.toLowerCase(),"cnt"===_opFound.val||"ncnt"===_opFound.val)){var _dialogFound=_.find($scope.dialogTaskList,{refId:connection.value});_dialogFound?_msg+=" "+_dialogFound.name:$scope.objList[connection.value]&&(_msg+=" "+$scope.objList[connection.value].name)}}else _msg+=" exists";else _msg=i18n.i18nString("on_intent_matches"),connection.ifCondition&&connection.ifCondition.length>0&&$.each($scope.objList,function(k,conn){return k===connection.ifCondition?(_msg+=conn.name,!1):void 0});else if("context"===connection.ifConditionPrefix&&"context.followupintents"===(connection.ifCondition||"").toLowerCase())if(_msg="context.FollowupIntents",connection.ifOperator){var _opFound1=_.find($scope.ifOperatorsFollowupIntents,{val:connection.ifOperator});if(_opFound1&&(_msg+=" "+_opFound1.name.toLowerCase(),"cnt"===_opFound1.val||"ncnt"===_opFound1.val)){var _dialogFound1=_.find($scope.dialogTaskList,{refId:connection.value});_dialogFound1?_msg+=" "+_dialogFound1.name:$scope.objList[connection.value]&&(_msg+=" "+$scope.objList[connection.value].name)}}else _msg+=" exists";else if(connection.tests&&connection.tests.length){connection.tests.forEach(function(test){_msg+=test.context+" "+test.op+" "+(test.value?test.value+" ":"")+connection.conjoin+" "});var msg=_msg.trim().split(" ");msg.pop(),_msg=msg.join(" ")}else _msg+="context",connection.ifCondition&&connection.ifCondition.length>0&&(_msg+="."+connection.ifCondition),_msg+=" "+_ifOp;if(""!==_ifOp&&"exists"!==_ifOp&&(_msg+=connection.value?" "+connection.value:""),"dialogAct"===obj.type&&"dialogAct"===connection.ifConditionPrefix){var preFixText=0===index?"If ":"Else If ";_msg=preFixText+connection.ifCondition}}return connection.targetId&&(_msg+=" goto "+$scope.getNodeName(connection.targetId)),_msg+" "},$scope.openDebugConsole=function(){$scope.$broadcast("updateJsonData",$scope.debugContext),$scope.isDebugConsolePanelOpened=!0,$(".dialogFieldset").addClass("maximized"),$scope.adjustpannelsInIframe("debugLog","open"),$timeout(function(){var _ele=$element.find(".flowTaskDebugConsolePanel");if($element.find(".flowTaskDebugConsolePanel.ui-draggable").hasClass("minimized")&&($(".dialogFieldset").removeClass("maximized"),$element.find(".toggleMinMax").trigger("click")),window.innerWidth-550<800){var _calculatedWidth=window.innerWidth-550;$(_ele).css("left","-1px").css("top","2px").css("width",_calculatedWidth+"px")}else $(_ele).css("left","-1px").css("top","2px").css("width","800px")})},$scope.nodeClick=function(e,uid,item){if($scope.nodeDragging||$(e.target).closest(".dummyConnections").length||$(e.target).closest(".nodeMap").length||$(e.target).closest(".addDummyConnection").length||$(e.target).closest(".remove").length)return!1;if(_flowTaskPropertyPanel.css("width",Math.floor(.6*_flowTaskConnectionBlock.width())),$(".flowTaskPropertyPanel").width()<500?($(".propertyPanelExpand").addClass("hide"),$(".propertyPanelCompress").addClass("hide")):($(".propertyPanelExpand").removeClass("hide"),$(".propertyPanelCompress").removeClass("hide")),item&&item.nodeOptions&&"required"===item.nodeOptions.promptOptions&&item.nodeOptions.eventOptions&&item.nodeOptions.eventOptions.defaultMaxRetry&&"executeNode"===item.nodeOptions.eventOptions.defaultMaxRetry.action){var refId=item.nodeOptions.eventOptions.defaultMaxRetry.ref,nodeIds=Object.keys($scope.objList);-1===nodeIds.indexOf(refId)&&$element.find("#deleteNodeImport").addClass("show").removeClass("fade")}$scope.selectCurrentNode(uid)},$scope.selectCurrentNode=function(uId,type,actionArray,isGroupNode){if(_selectedStream.sdkSubscription&&($workflowService.selectedStream().sdkSubscription=_selectedStream.sdkSubscription),uId||($scope.propertyCb.loadingPropeertypanel=!1),$scope.propertyCb.loadingPropeertypanel&&uId)return void console.log("Yet to open previous clicked property panel");uId&&($scope.propertyCb.loadingPropeertypanel=!0),$timeout(function(){$scope.propertyCb&&($scope.propertyCb.startPropertyPanelAnimate&&$scope.propertyCb.startPropertyPanelAnimate(type,actionArray),$scope.propertyCb.updateBotConfigurationData&&$scope.propertyCb.updateBotConfigurationData($scope.botConfiguration))},500),_flowTaskPropertyPanel.removeClass("minimized"),$scope.isExpanded=!0,$scope.isMinimized=!1,$scope.selectedNode="",isGroupNode||($scope.selectedGroup=""),$timeout(function(){$scope.$apply()},50);var _refId="",_sendObj={openSection:type,nodeInfo:{},dialogNodeInstance:{},dialogInfo:{dialogId:"",dummyConnCount:"",currentEntities:[],currentIntents:[],dialogNodes:[],firstNodeId:$scope.firstNodeUId,firstNodeComponentId:$scope.firstNodeComponentId,nodeCounts:$scope.nodeObjCount},displayMode:$scope.displayMode,editLocked:!1};$.each($scope.objList,function(k,obj){if(obj.uId===uId){if(obj.isSelected=!0,obj&&$scope.groupNodeIntentsObj&&$scope.groupNodeIntentsObj[obj.uId]){var contextMapObj={};obj.contextMap=[];try{contextMapObj=JSON.parse($scope.groupNodeIntentsObj[obj.uId].contextMap)}catch(e){contextMapObj="object"==typeof obj.contextMap?obj.contextMap:{}}contextMapObj&&Object.keys(contextMapObj)&&Object.keys(contextMapObj).length&&$.each(contextMapObj,function(key,value){var _tempObj={key:key,value:value};obj.contextMap||(obj.contextMap=[]),obj.contextMap.push(_tempObj)});var tempTargetObj=$scope.groupNodeIntentsObj[obj.uId].targetNode||{},groupIntentPreCond=$scope.groupNodeIntentsObj[obj.uId].preConditions||[];obj.preConditions=JSON.parse(JSON.stringify(groupIntentPreCond)),obj.targetNode=JSON.parse(JSON.stringify(tempTargetObj));var transitionFlow="continueFromIdentifiedNode";$scope.groupNodeIntentsObj[obj.uId]&&$scope.groupNodeIntentsObj[obj.uId].targetNode&&$scope.groupNodeIntentsObj[obj.uId].targetNode.type||(obj.targetNode={type:transitionFlow})}_sendObj.dialogNodeInstance=obj,_refId=obj.componentId,$scope.isPropertyPanelOpened=!0,_previousPropertyPanelUid=uId}else obj.isSelected=!1}),$.each(_objList,function(k,obj){if(_sendObj.dialogInfo.dialogNodes.push(obj.name),obj._id===_refId&&obj.nodeId===uId&&(_sendObj.nodeInfo=obj),"entity"===obj.type&&_sendObj.dialogInfo.currentEntities.push({name:obj.name,compId:obj._id,uId:obj.nodeId,unitType:obj.unitType,defaultUnit:obj.defaultUnit,entityType:obj.entityType}),"intent"===obj.type){var _intentObj={name:obj.intent,compId:obj._id,uId:obj.nodeId,refId:obj.refId};$scope.objList[obj.nodeId]&&$scope.objList[obj.nodeId].flowTaskId&&(_intentObj.type="subDialog"),_sendObj.dialogInfo.currentIntents.push(_intentObj)}}),_sendObj.nodeInfo.hasOwnProperty("applyDefaultTemplate")||$.each(_botComponents,function(k,component){component&&component._id===_sendObj.nodeInfo._id&&component.hasOwnProperty("applyDefaultTemplate")&&(_sendObj.nodeInfo.applyDefaultTemplate=component.applyDefaultTemplate)}),updateContextDialogInfo(),_sendObj.dialogInfo.dialogId=_dialogObj._id,_sendObj.editLocked=_dialogObj.editable?!1:!0,_sendObj.dialogInfo.dummyConnCount=dummyConnectionCount,$timeout(function(){$scope.selectedNode=_sendObj,$scope.selectedNode.nodeInfo.nodeId=uId,$scope.selectedNode&&$scope.selectedNode.nodeInfo&&"intent"===$scope.selectedNode.nodeInfo.type&&$timeout(function(){$scope.utterences=[],getUtterances($scope.firstNodeComponentId,_sendObj.nodeInfo._id),$scope.updateComponent($scope.selectedNode.nodeInfo._id)},500),_sendObj.vNameSpace?$scope.selectedNode.nodeInfo.vNameSpace=_sendObj.vNameSpace:$scope.selectedNode.nodeInfo.vNameSpace=[];var tempFlowInfo=$workflowService.selectedDialogComponents(),tempFilter=_.findWhere(tempFlowInfo,{_id:$scope.selectedNode.nodeInfo._id});tempFilter&&tempFilter.vNameSpace&&($scope.selectedNode.nodeInfo.vNameSpace=tempFilter.vNameSpace),tempFilter&&tempFilter.hasOwnProperty("useTaskLevelNs")?$scope.selectedNode.nodeInfo.useTaskLevelNs=tempFilter.useTaskLevelNs:$scope.selectedNode.nodeInfo.vNameSpace=[],$timeout(function(){angular.element($window).trigger("resize")},350)},200)},$scope.updateComponent=function(componentId){BTFlowtaskService.getComponents($workflowService.selectedStream()._id,componentId).then(function(response){response&&(response.data.hasOwnProperty("patterns")||(response.data.patterns=[]),response.data.hasOwnProperty("traitRules")||(response.data.traitRules=[]),$scope.propertyCb.updatePropertyPanel(response.data))})},$scope.resetToDefaultDialog=function(){$element.find("#deleteNodeImport").addClass("fade").removeClass("show"),$scope.propertyCb.updateDefaultMaxRetry()},$scope.propertyCb={},$scope.showCount=function(item){var showCount=!1;if(item&&item.connections){var connection=Object.keys(item.connections);connection&&connection.length>1&&(showCount=!0)}return showCount},$scope.getTraitsGroupsApi=function(){BTStreamsService.getTraitGroups($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$scope.traitGroups=$workflowService.cloneData(res.data),$scope.propertyCb.allTraits={};var alltraitsArr=[],allTraitsNegations=[];$.each($scope.traitGroups,function(i,traits){$.each(traits.traits,function(j,trait){({groupId:traits._id,traitId:trait.traitId||j,traitName:trait.traitName});alltraitsArr.push(trait.traitName),allTraitsNegations.push("!"+trait.traitName)})}),$scope.propertyCb.allTraits.traits=_.uniq(alltraitsArr),$scope.propertyCb.allTraits.negativeTraits=_.uniq(allTraitsNegations)},function(err){$scope.loadingTraits=!1,"NO"!==$scope.nlpPermission&&NotificationService.notify(i18n.i18nString("failed_traits"),"error")})},$scope.getTraitsGroupsApi(),$scope.propertyCb.closePropertyPanel=function(){$scope.isPropertyPanelOpened=!1,$element.find(".flowTaskPropertyPanel").css("width",""),$scope.selectCurrentNode()},$scope.runbotConfigCb={},$scope.dialogBotConfigDataUpdate=function(type,data){"updateBotConfig"===type&&($scope.botConfiguration=data)},$scope.dialogData=function(type,data,_uId){if($scope.selectedNode.dialogNodeInstance&&$scope.selectedNode.dialogNodeInstance.uId&&!_uId&&(_uId=$scope.selectedNode.dialogNodeInstance.uId),"updateDialog"===type){if(data&&data._id===_dialogObj._id){_dialogObj=data;var _tempConnObj={},_tempDefaultConnection={};$scope.nodeObjCount={},$scope.prepareComponentCount(null,!0),$.each(data.nodes,function(k,node){if(_uId===node.nodeId){if($.each(node.transitions,function(k,transition){var _connection=$.extend(!0,{},_connObj);transition&&transition.metadata&&transition.metadata.connId?_connection.connId=transition.metadata.connId:(dummyConnectionCount++,_connection.connId="dummy"+dummyConnectionCount),_connection.sourceId=node.nodeId,void 0===transition["if"]&&(transition["if"]={}),_connection.ifConditionPrefix=void 0!==transition["if"].dialogAct?"dialogAct":void 0!==transition["if"].intent?"intent":void 0!==transition["if"].field?"field":"context",void 0===transition["default"]?(_connection.isDefault=!1,_connection.targetId=transition.then,"dialogAct"===_connection.ifConditionPrefix?(_connection.ifCondition=transition["if"].dialogAct||"yes",_connection.ifOperator="",_connection.value=""):transition["if"].hasOwnProperty("context")?(transition.metadata.hasOwnProperty("intent")?(_connection.ifCondition=transition["if"].intent,_connection.ifConditionPrefix="intent",_connection.intentType="followup"):(_connection.ifConditionPrefix="context",_connection.ifCondition=transition["if"].context||""),_connection.ifOperator=transition["if"].op||"",_connection.value=transition["if"].value||""):transition["if"].hasOwnProperty("conjoin")&&(_connection.conjoin=transition["if"].conjoin,_connection.tests=transition["if"].tests),transition["if"].hasOwnProperty("intent")?(_connection.intentType="userinput",_connection.ifCondition=transition["if"].intent||"",_connection.ifOperator=transition["if"].op||"",_connection.value=transition["if"].value||""):"field"===_connection.ifConditionPrefix&&(_connection.ifCondition=transition["if"].field,_connection.ifOperator=transition["if"].op||"",_connection.value=transition["if"].value||"")):(_connection.targetId=transition["default"],_connection.isDefault=!0,delete transition["if"]),transition.metadata&&(_connection.color=transition.metadata.color||_connection.color),_connection.isDefault?(_tempDefaultConnection[_connection.connId]=_connection,_tempDefaultConnection[_connection.connId].connObjNumber=k+1):(_tempConnObj[_connection.connId]=_connection,_tempConnObj[_connection.connId].connObjNumber=k+1)}),$scope.objList[_uId]&&($scope.objList[_uId].nodeOptions=node.nodeOptions,$scope.objList[_uId].nodeOptions&&$scope.objList[_uId].nodeOptions.hasOwnProperty("userInputCorrection")?$scope.objList[_uId].nodeOptions.autoCorrect=$scope.objList[_uId].nodeOptions.userInputCorrection?"true":"false":$scope.objList[_uId].nodeOptions.autoCorrect="true","entity"===$scope.objList[_uId].type&&($scope.objList[_uId].nodeOptions&&$scope.objList[_uId].nodeOptions.hasOwnProperty("eventOptions")?$scope.objList[_uId].nodeOptions.eventOptions=$scope.objList[_uId].nodeOptions.eventOptions:($scope.objList[_uId].nodeOptions.eventOptions={},$scope.objList[_uId].nodeOptions.eventOptions.defaultMaxRetry=$workflowService.cloneData($scope.defaultMaxRetry))),"intent"===$scope.objList[_uId].type)){if(node.contextMap&&node.contextMap.constructor===String)try{$scope.objList[_uId].contextMap=JSON.parse(node.contextMap)}catch(e){$scope.objList[_uId].contextMap={}}else $scope.objList[_uId].contextMap=node.contextMap||{};if(node.postContextMap&&node.postContextMap.constructor===String)try{$scope.objList[_uId].postContextMap=JSON.parse(node.postContextMap)}catch(e){$scope.objList[_uId].postContextMap={}}else $scope.objList[_uId].postContextMap=node.postContextMap||{}}return!1}}),Object.keys(_tempDefaultConnection).length>0&&(_tempConnObj=$.extend(!0,{},_tempConnObj,_tempDefaultConnection));for(var ke=0;ke<_objConnection.length;ke++)_objConnection[ke].sourceId!==_uId||_tempConnObj[_objConnection[ke].connId]||(_objConnection.splice(ke,1),ke--);$element.find("connection.source-"+_uId).length>0&&$element.find("connection.source-"+_uId).connections("remove"),$scope.objList[_uId].connections={},$scope.objList[_uId].tempConnections={},$.each(_tempConnObj,function(k,tempConn){var _isFound=!1;if($.each(_objConnection,function(l,connection){if(k===connection.connId){_isFound=!0;var _source=$element.find('.dragEleConn[data-id="'+tempConn.sourceId+'"]'),_target=$element.find('.dragEleConn[data-id="'+tempConn.targetId+'"]');return _source.length>0&&_target.length>0?(_source.connections({to:'.draggableEle [data-id="'+tempConn.targetId+'"]',"class":"line source-"+tempConn.sourceId+" "+tempConn.sourceId+" target-"+tempConn.targetId+" singleConnection",within:$element.find(".flowTaskConnectionBlock")[0],lineColor:tempConn.color,connectionNum:tempConn.connObjNumber}),$scope.objList[_uId].connections[connection.connId]=tempConn,_objConnection[l]=tempConn,$scope.objList[_uId].tempConnections&&$scope.objList[_uId].tempConnections[connection.connId]&&delete $scope.objList[_uId].tempConnections[connection.connId]):($scope.objList[_uId].connections[connection.connId]=tempConn,$scope.objList[_uId].tempConnections[connection.connId]=tempConn),!1}}),!_isFound){var _source=$element.find('.dragEleConn[data-id="'+tempConn.sourceId+'"]'),_target=$element.find('.dragEleConn[data-id="'+tempConn.targetId+'"]');_source.length>0&&_target.length>0?(_source.connections({to:'.draggableEle [data-id="'+tempConn.targetId+'"]',"class":"line source-"+tempConn.sourceId+" "+tempConn.sourceId+" target-"+tempConn.targetId+" singleConnection",within:$element.find(".flowTaskConnectionBlock")[0],lineColor:tempConn.color,connectionNum:tempConn.connObjNumber}),$scope.objList[_uId].connections[tempConn.connId]=tempConn,_objConnection.push(_tempConnObj),$scope.objList[_uId].tempConnections&&$scope.objList[_uId].tempConnections[tempConn.connId]&&delete $scope.objList[_uId].tempConnections[tempConn.connId]):($scope.objList[_uId].connections[tempConn.connId]=tempConn,$scope.objList[_uId].tempConnections[tempConn.connId]=tempConn);
}})}$scope.groupNodeIntent||rearrangeConnectionsForObj(_uId),$timeout(function(){$("connection").connections("update"),chechForConnectionCounts()},350)}else"updateComponent"===type?($scope.objListSearch=[],$.each(_objList,function(k,obj){if($scope.objListSearch.push({key:obj.uId,val:obj.name}),obj._id===data._id){var _nodeid=_objList[k].nodeId;data.message&&data.message.length&&!data.message[0].text&&(data.message=_objList[k].message),data.errorMessage&&data.errorMessage.length&&data.errorMessage[0]&&!data.errorMessage[0].text&&(data.errorMessage=_objList[k].errorMessage),data.submitMessage&&data.submitMessage.length&&data.submitMessage[0]&&!data.submitMessage[0].text&&(data.submitMessage=_objList[k].submitMessage),_objList[k]&&_objList[k].formDetails&&(data.formDetails=_objList[k].formDetails),data.multiCategoryPrompts&&data.multiCategoryPrompts.length&&data.multiCategoryPrompts[0].message&&data.multiCategoryPrompts[0].message[0].text?_objList[k].multiCategoryPrompts=data.multiCategoryPrompts:data.multiCategoryPrompts=_objList[k].multiCategoryPrompts||[],data.multiCategoryPrompts&&data.multiCategoryPrompts.length&&data.multiCategoryPrompts[0].errorMessage&&data.multiCategoryPrompts[0].errorMessage[0].text?_objList[k].multiCategoryPrompts=data.multiCategoryPrompts:data.multiCategoryPrompts=_objList[k].multiCategoryPrompts||[],data.nodeId=_nodeid,data.uId=_nodeid,_objList[k]=$workflowService.cloneData(data)}}),$.each(_botComponents,function(k,obj){return obj._id===data._id?(_botComponents[k]=data,!1):void 0}),$.each($scope.objList,function(k,obj){if(obj.componentId===data._id){if(obj.name=data.name,"intent"===data.type&&(obj.intent=data.intent,obj.uId===$scope.firstNodeUId&&($scope.flowtaskObj.name=data.intent)),"entity"===data.type){var entityType=_.find($scope._constants_.entityNlp,{value:data.entityType});"company_name"===entityType.value&&(entityType.title="Company/Org Name"),obj.entityType=entityType.title,obj.nodeOptions&&obj.nodeOptions.hasOwnProperty("eventOptions")?obj.nodeOptions.eventOptions=obj.nodeOptions.eventOptions:(obj.nodeOptions.eventOptions={},obj.nodeOptions.eventOptions.defaultMaxRetry=$workflowService.cloneData($scope.defaultMaxRetry))}"process"===data.type&&(obj.resourceId=data.resourceId)}}),updateDialogEntities(),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings(),fetchServiceNodes(),updateContextDialogInfo(),$timeout(function(){$element.find("connection").connections("update"),chechForConnectionCounts()})):"updateBotConfig"===type&&($scope.botConfiguration=data,$timeout(function(){fetchServiceNodes()},350));$scope.propertyCb&&$scope.propertyCb.prepareInstancePrompts&&$scope.propertyCb.prepareInstancePrompts(!0)},$scope.closeDebugConsolePanel=function(){$scope.debugContext="",$scope.isDebugConsolePanelOpened=!1,$(".dialogFieldset").removeClass("maximized"),$scope.adjustpannelsInIframe("debugLog","close"),$element.find(".flowTaskDebugConsolePanel").css("width",""),$element.find(".flowTaskDebugConsolePanel.ui-draggable").css("cssText","width : 0px !important;")},$scope.checkNodeColor=function(nodeId,nodeType,flowTaskId){var _val="";return $scope.firstNodeUId===nodeId,"intent"===nodeType&&flowTaskId&&(nodeType="subDialog"),_val={"border-color":_nodeColors[nodeType]?_nodeColors[nodeType]:"#F00"},_val},$scope.checkNodeTypeColor=function(nodeType,flowTaskId){return"intent"===nodeType&&flowTaskId&&(nodeType="subDialog"),{"border-color":_nodeColors[nodeType]?_nodeColors[nodeType]:"","background-color":_nodeColors[nodeType]?_nodeColors[nodeType]:""}},$scope.getNodeTypeName=function(nodeType,flowTaskId){return"intent"===nodeType&&flowTaskId&&(nodeType="subDialog"),$scope.configurableElements[nodeType]?$scope.configurableElements[nodeType].name:""},$scope.prepareNodeObjList=function(_type,_isDialog){$scope.botIntents=[],$.each(_botComponents,function(k,component){component&&component.type===_type&&("intent"===_type&&$scope.botIntents.push(component),"intent"===_type&&_isDialog?component.dialogId&&$scope.nodeObjList.push(component):$scope.nodeObjList.push(component))}),$scope.duplicateNodeObjList=$workflowService.cloneData($scope.nodeObjList),$scope.nodeObjListLoading=!1},$scope.onNodeClicked=function($event,_type,node){$scope.search.name="",node.menuFocused=!0,$scope.selectedConfigurableElement=_type,_menuFocusedNode=node;var _isDialog=!1;if("subDialog"===_type&&(_type="intent",_isDialog=!0),$($event.currentTarget).hasClass("eleType")){if($event.stopPropagation(),$scope.nodeObjList=[],$scope.nodeObjListLoading=!0,$scope.fromSearch=!1,$scope.noResults=!1,$scope.showUIFormsList||$scope.showFormNodesList||$scope.allForms(!0),$($event.currentTarget).siblings().find(".open").removeClass("open"),"intent"===_type){var _prevNodeType=($($event.currentTarget).parents(".dummyConnections").siblings(".dragEleConn").data("type")||"").trim().toLowerCase();if($scope.selectedConnection&&$scope.selectedConnection.source&&(_prevNodeType=$scope.selectedConnection.source.type.toLocaleLowerCase()),"sdkwebhook"===_prevNodeType||"agenttransfer"===_prevNodeType)return void NotificationService.notify(i18n.i18nString("sdk_webhook"),"warning")}if("SDKWebHook"===_type&&$scope.selectedConnection&&$scope.selectedConnection.target&&"intent"===$scope.selectedConnection.target.type)return void NotificationService.notify(i18n.i18nString("sdkwebhook_warning"),"warning");$($event.currentTarget).find(".dropdown").addClass("open"),"error"===_botComponents?BTFlowtaskService.getComponents(_selectedStream._id).then(function(res){_botComponents=res&&res.data,updateDialogEntities(),$scope.onNodeClicked($event)},function(error){_botComponents="error"}):fetchBotComponentsByType(_type,function(){$scope.prepareNodeObjList(_type,_isDialog);var _heightDiff=$($event.currentTarget).offset().top+230-parseInt($(".flowTaskConnectionBlock").height()),_widthDiff=$($event.currentTarget).offset().left+400-parseInt($(".flowTaskConnectionBlock").width());$scope.selectedNode&&(_widthDiff+=parseInt($element.find("property-panel .property-panel-cntnr").width())),_widthDiff>0&&$timeout(function(){$(".flowTaskConnectionBlock").scrollLeft(_widthDiff+parseInt($(".flowTaskConnectionBlock").scrollLeft()))},500),_heightDiff>0&&$timeout(function(){$(".flowTaskConnectionBlock").scrollTop(_heightDiff+parseInt($(".flowTaskConnectionBlock").scrollTop()))},500),$timeout(function(){PerfectScrollbar.update($.find(".exisiting-node-menu-item:visible")[0])},50)})}},$scope.formToggle=function(){$scope.formToggleOpen=!$scope.formToggleOpen,$scope.formToggleOpen?$(".formsDDMenu").show():$(".formsDDMenu").hide()},$scope.uIFormsList=function(){$scope.showUIFormsList=!0,$scope.showFormNodesList=!1,$scope.showAllForms=!1,$scope.showUIForms=!0,$scope.showFormnode=!1,$scope.formToggle()},$scope.formNodesList=function(){$scope.showFormNodesList=!0,$scope.showUIFormsList=!1,$scope.showAllForms=!1,$scope.showUIForms=!1,$scope.showFormnode=!0,$scope.formToggle()},$scope.allForms=function(flag){$scope.showUIFormsList=!0,$scope.showFormNodesList=!0,$scope.showAllForms=!0,$scope.showUIForms=!1,$scope.showFormnode=!1,flag||$scope.formToggle()},$scope.createEleForConn=function($event,_type,sourceNode,dummyId,nodeobj){if("form"===_type&&!$event.formExperienceDone)return $event.methodToInvoke="createEleForConn",$scope.initFormExperience(arguments),$scope.propertyCb.uiFormName=nodeobj.displayName,!1;if(!$scope.eleCreationInProgress){$scope.eleCreationInProgress=!0;var cmpTypeName=_type;if("dialogAct"===_type?cmpTypeName=i18n.i18nString("configurable_dialogact_name"):"SDKWebHook"===_type?cmpTypeName=i18n.i18nString("configurable_webhook_name"):"service"===_type?cmpTypeName=i18n.i18nString("configurable_service_name"):"message"===_type?cmpTypeName=i18n.i18nString("constants.nlp_Message"):"entity"===_type?cmpTypeName=i18n.i18nString("configurable_entity_name"):"script"===_type?cmpTypeName=i18n.i18nString("configurable_script_name"):"intent"===_type&&(cmpTypeName=i18n.i18nString("optional_intent")),$scope.footerInfoTitle=i18n.i18nString("importance_node",{cmpTypeName:cmpTypeName}),$scope.footerHeaderId="bt-dialog-node",$scope.footerPanelId="bt-dialog-node-panel",$event.stopPropagation(),$event.currentTarget&&$($event.currentTarget).hasClass("disabled"))return void($scope.eleCreationInProgress=!1);_currentSourceNode=sourceNode,_dummyConnectionId=dummyId,"intent"===_type?($scope.nodeObj=$.extend(!0,{},_intentObj,{name:"",intent:"",desc:"",type:"intent"}),$scope.nodeObjLabels={},$scope.nodeObjLabels.name=i18n.i18nString("new_intent"),$scope.nodeObjLabels.nameLabel=i18n.i18nString("name_label"),$scope.nodeObjLabels.namePlaceholder=i18n.i18nString("create_lead"),$scope.nodeObjLabels.isFirstNode="false",$scope.nameDescription=i18n.i18nString("name_desc"),$scope.intentModalSlider()):openPreviewModal(_type,!1,nodeobj)}},$scope.processingCreateEle=!1,$scope.createEleForConnDefault=function($event,_type,sourceNode,dummyId,nodeObj){if($event&&"form"===_type&&!$event.formExperienceDone)return $event.methodToInvoke="createEleForConnDefault",$scope.initFormExperience(arguments),!1;var _isSubDialog="";return"subDialog"===_type&&(_type="intent",_isSubDialog=nodeObj.dialogRefId),$scope.processingCreateEle===!0?!1:($scope.processingCreateEle=!0,$event&&$event.stopPropagation(),_currentSourceNode=sourceNode,_dummyConnectionId=dummyId,"intent"===_type?$scope.nodeObj=$.extend(!0,{},_intentObj,{name:nodeObj.name,intent:nodeObj.intent,desc:nodeObj.desc||""}):"entity"===_type?$scope.nodeObj=$.extend(!0,{},_entityObj,{name:nodeObj.name,nodeType:nodeObj.entityType||"",prompt:nodeObj.message||[]}):"form"===_type?$scope.nodeObj=$.extend(!0,{},_formObj,{name:nodeObj.name,prompt:nodeObj.message||[]}):"logic"===_type?$scope.nodeObj=$.extend(!0,{},_logicObj,{name:nodeObj.name}):"service"===_type?$scope.nodeObj=$.extend(!0,{},_serviceObj,{name:nodeObj.name,nodeType:nodeObj.serviceType,nodeSubType:nodeObj.serviceSubType}):"script"===_type?$scope.nodeObj=$.extend(!0,{},_scriptObj,{name:nodeObj.name,nodeType:nodeObj.serviceType,nodeSubType:nodeObj.serviceSubType}):"message"===_type?$scope.nodeObj=$.extend(!0,{},_messageObj,{name:nodeObj.name}):"dialogAct"===_type?$scope.nodeObj=$.extend(!0,{},_confirmationObj,{name:nodeObj.name,prompt:nodeObj.message||[]}):"SDKWebHook"===_type?$scope.nodeObj=$.extend(!0,{},_sdkwebhookObj,{name:nodeObj.name,callbackURL:nodeObj.callbackURL,events:nodeObj.events}):"agentTransfer"===_type&&($scope.nodeObj=$.extend(!0,{},_agentTransferObj,{name:nodeObj.name,callbackURL:nodeObj.callbackURL,events:nodeObj.events})),$scope.nodeObj.type=_type,$scope.nodeObj.uId=_type+count,$scope.nodeObj.componentId=nodeObj._id,_isSubDialog&&($scope.nodeObj.isSubDialog=_isSubDialog),nodeObj.nodeId=$scope.nodeObj.uId,$scope.nodeObj.nodeId=$scope.nodeObj.uId,_objList.push(nodeObj),count++,void addNodeOnDialog(nodeObj))},$scope.onRemove=function(typeID,node){if(typeID===$scope.firstNodeUId)return void NotificationService.notify(i18n.i18nString("first_node"),"error");var _eventOptDependents=[],_transitionDependents=[],groupNodeDependncies=[];if($scope.groupNodeIntentsObj&&Object.keys($scope.groupNodeIntentsObj)&&Object.keys($scope.groupNodeIntentsObj).length&&$.each($scope.groupNodeIntentsObj,function(key,val){val&&val.targetNode&&val.targetNode.node===typeID&&groupNodeDependncies.push(typeID)}),groupNodeDependncies&&groupNodeDependncies.length){var name=node?node.name:"";return NotificationService.confirm({heading:i18n.i18nString("cannot_delete_title"),headerClass:"confirmationHeader",msg:i18n.i18nString("cannot_delete_group_node_intent",{nodeName:name}),successCb:function(){},failCb:function(){},isModal:!0,btnTexts:{success:i18n.i18nString("ok"),fail:i18n.i18nString("cancel")}}),!1}if(typeID&&$scope.groupNodeIntentsObj&&$scope.groupNodeIntentsObj[typeID]&&$scope.groupNodeIntentsObj[typeID].targetNode&&"jumpToSpecificNode"===$scope.groupNodeIntentsObj[intent.nodeId].targetNode.type&&$scope.groupNodeIntentsObj[intent.nodeId].targetNode.node){var _node=$scope.objList[$scope.groupNodeIntentsObj[intent.nodeId].targetNode.node],nodeName=(_node.intent||_node.name)+$scope.getNodeCount(_node);transFlow="Jump to a node ("+(nodeName||"")+")"}if(_dialogObj.nodes&&_dialogObj.nodes.length&&_dialogObj.nodes.forEach(function(node){if(node&&node.nodeOptions&&node.nodeOptions.eventOptions&&node.nodeOptions.eventOptions.maxRetry&&"executeNode"===node.nodeOptions.eventOptions.maxRetry.action){var _maxRetryDelCheck=node.nodeOptions.eventOptions.maxRetry;_maxRetryDelCheck.ref&&_maxRetryDelCheck.ref===typeID&&_eventOptDependents.push(node)}if(node&&node.nodeOptions&&node.nodeOptions.eventOptions&&node.nodeOptions.eventOptions.defaultMaxRetry&&"required"===node.nodeOptions.promptOptions&&"executeNode"===node.nodeOptions.eventOptions.defaultMaxRetry.action){var _transitionNodeCheck=node.nodeOptions.eventOptions.defaultMaxRetry;_transitionNodeCheck.ref&&_transitionNodeCheck.ref===typeID&&_transitionDependents.push(node)}}),_transitionDependents&&_transitionDependents.length)return $scope._entityNames=[],_transitionDependents.forEach(function(node){$scope._entityNames.push($scope.objList[node.nodeId].name)}),$scope.currentTypeId=typeID,void $element.find("#deleteNode").addClass("show").removeClass("fade");if(_eventOptDependents.length){var _names=[];return _eventOptDependents.forEach(function(node){_names.push($scope.objList[node.nodeId].name)}),window.bootbox.dialog({message:i18n.i18nString("cannot_delete_node")+(_names.length>1?"s":"")+" "+arrayToAndString(_names),title:i18n.i18nString("cannot_delete_title"),className:"text-center",buttons:{main:{label:i18n.i18nString("ok"),className:"",callback:function(){}}}}),!1}NotificationService.confirm({heading:i18n.i18nString("cannot_delete_title"),headerClass:"confirmationHeader",msg:i18n.i18nString("delete_selected_node"),successCb:function(){$scope.propertyCb.closePropertyPanel();var _params={name:_dialogObj.name,nodes:[],displayOption:_dialogObj.displayOption,visibility:_dialogObj.visibility},_isIntent=$scope.objList[typeID]&&"intent"===$scope.objList[typeID].type?!0:!1;_dialogObj.nodes&&_dialogObj.nodes.length>0&&$.each(_dialogObj.nodes,function(k,node){if(node.nodeId!==typeID){var _nodeObj=node;delete _nodeObj._id,node.transitions&&node.transitions.length>0&&$.each(node.transitions,function(k,transition){transition.then===typeID?(node.transitions[k].then="",_isIntent&&(node.transitions[k]["if"]={intent:""})):transition["default"]===typeID&&(node.transitions[k]["default"]=""),void 0!==transition["default"]&&transition["if"]&&delete node.transitions[k]["if"]}),_params.nodes.push(_nodeObj)}delete node.message}),BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_params).then(function(res){$workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0),_dialogObj=res&&res.data;for(var i=0;i<_objList.length;i++)if(_objList[i]._id===$scope.objList[typeID].componentId&&_objList[i].nodeId===typeID){_objList.splice(i,1),i--;break}for(var j=0;j<_objConnection.length;j++)!_objConnection[j]||_objConnection[j].targetId!==typeID&&_objConnection[j].sourceId!==typeID||(_objConnection.splice(j,1),j--);delete $scope.objList[typeID],$scope.objListSearch=[],$.each($scope.objList,function(k,obj){$scope.objListSearch.push({key:obj.uId,val:obj.name}),obj.connections&&Object.keys(obj.connections).length>0&&($.each(obj.connections,function(k,conn){conn&&conn.targetId===typeID?(conn.targetId="",_isIntent&&(conn.ifCondition=""),obj.tempConnections={},$.each(obj.connections,function(k,conn){""===conn.targetId&&(obj.tempConnections[k]=conn)})):conn&&conn["default"]===typeID&&(conn["default"]="",obj.tempConnections[k]=conn)}),rearrangeConnectionsForObj(obj.uId))}),$timeout(function(){$scope.$apply(),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings(),rearrangeGroups()})},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},failCb:function(){},isModal:!0,btnTexts:{success:i18n.i18nString("ok"),fail:i18n.i18nString("cancel")}})},$scope.closeDeleteNodeModal=function(){$element.find("#deleteNode").removeClass("show").addClass("fade")},$scope.proceedDeleteNode=function(typeID){$element.find("#deleteNode").removeClass("show").addClass("fade");var _params={name:_dialogObj.name,nodes:[],displayOption:_dialogObj.displayOption,visibility:_dialogObj.visibility},_isIntent=$scope.objList[typeID]&&"intent"===$scope.objList[typeID].type?!0:!1;_dialogObj.nodes&&_dialogObj.nodes.length>0&&$.each(_dialogObj.nodes,function(k,node){if(node.nodeId!==typeID){var _nodeObj=node;delete _nodeObj._id,node.transitions&&node.transitions.length>0&&$.each(node.transitions,function(k,transition){transition.then===typeID?(node.transitions[k].then="",_isIntent&&(node.transitions[k]["if"]={intent:""})):transition["default"]===typeID&&(node.transitions[k]["default"]=""),void 0!==transition["default"]&&transition["if"]&&delete node.transitions[k]["if"]}),_params.nodes.push(_nodeObj)}delete node.message}),BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_params).then(function(res){$workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0),_dialogObj=res&&res.data;for(var i=0;i<_objList.length;i++)if(_objList[i]._id===$scope.objList[typeID].componentId&&_objList[i].nodeId===typeID){_objList.splice(i,1),i--;break}for(var j=0;j<_objConnection.length;j++)!_objConnection[j]||_objConnection[j].targetId!==typeID&&_objConnection[j].sourceId!==typeID||(_objConnection.splice(j,1),j--);delete $scope.objList[typeID],$scope.objListSearch=[],$.each($scope.objList,function(k,obj){if($scope.objListSearch.push({key:obj.uId,val:obj.name}),obj.connections&&Object.keys(obj.connections).length>0&&($.each(obj.connections,function(k,conn){conn&&conn.targetId===typeID?(conn.targetId="",_isIntent&&(conn.ifCondition=""),obj.tempConnections={},$.each(obj.connections,function(k,conn){""===conn.targetId&&(obj.tempConnections[k]=conn)})):conn&&conn["default"]===typeID&&(conn["default"]="",obj.tempConnections[k]=conn)}),rearrangeConnectionsForObj(obj.uId)),"entity"===$scope.objList[obj.uId].type){var updatedDialog=_.find(_dialogObj.nodes,{nodeId:obj.uId});updatedDialog&&updatedDialog.nodeOptions&&updatedDialog.nodeOptions.eventOptions?$scope.objList[obj.uId].nodeOptions.eventOptions=updatedDialog.nodeOptions.eventOptions:($scope.objList[obj.uId].nodeOptions.eventOptions={},$scope.objList[obj.uId].nodeOptions.eventOptions.defaultMaxRetry=$workflowService.cloneData($scope.defaultMaxRetry))}}),$timeout(function(){$scope.$apply(),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings(),rearrangeGroups()})},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})};var _parentHeight=0,_parentWidth=0;$scope.zoomScale=1,$scope.zoomScalePer="100%",$element.connections({updateZoom:!0,zoomScale:$scope.zoomScale});var _initPos={left:"",top:""};$scope.onConfigure=function(typeID,type,actionArray){$scope.selectCurrentNode(typeID,type,actionArray)},$scope.onAddNewDummyConnection=function(typeId){var _connColor=getNewNodeConnectionColor(typeId),dummyConn=$.extend(!0,{},_connObj);dummyConn.connId="dummy"+dummyConnectionCount,dummyConnectionCount++,dummyConn.sourceId=typeId,dummyConn.color=_connColor,addConnectionOnNode(dummyConn,"",!1)},$scope.closeModal=function(){$("#myModal").modal("hide")},$scope.manageVarFlowTaskOpen=function(){$scope.manageVarFlowTaskFormEnable=!0,$scope.manage_var_flowtask_form__cb._id=$scope.flowtaskObj._id,$scope.manage_var_flowtask_form__cb.state="indevelopment"==$scope.flowtaskObj.state?"configured":$scope.flowtaskObj.state,$scope.manage_var_flowtask_form__cb.addedNamespaces=$scope.flowtaskObj.vNameSpace||[],$scope.manage_var_flowtask_form__cb.subHeading="",$scope.manage_var_flowtask_form__cb.updateDialogNamespace=function(list){$scope.flowtaskObj.vNameSpace=list},$scope.manage_var_flowtask_form__cb.payloadExtend=_.pick($scope.flowtaskObj,"name","visibility"),setTimeout(function(){$scope.modalSlider.open("#manageVarNamespaceFlowTaskForm")},200)},$scope.manage_var_flowtask_form__cb.close=function(){$scope.modalSlider.close("#manageVarNamespaceFlowTaskForm"),$scope.manageVarFlowTaskFormEnable=!1},$scope.closeRegenerateModal=function(){$("#regenerateModal").modal("hide")},$scope.regenerateDialog=function(item,formDetails){$scope.regenerateDialogDetails=formDetails},$scope.getBotsynonyms=function(intent){if($scope.props={},intent){try{$scope.props.botSynonyms=JSON.parse(JSON.stringify($scope.stream.synonyms))}catch(e){$scope.props.botSynonyms=$workflowService.cloneData($scope.stream.synonyms)||{}}var _intentSentence=intent;_intentSentence&&_intentSentence.split(" ").forEach(function(key){$scope.props.botSynonyms[key]||($scope.props.botSynonyms[key]=[])})}};var cbBridge={};cbBridge.onBotUpdate=function(botData){botData&&($scope.stream=botData),botData&&botData.synonyms&&($scope.props.botSynonyms=botData.synonyms||{});var parms={action:"synonymsUpdated",payload:{}};$scope.sendEventToIframe(parms)},$scope.addBotSynonyms=function(intent){return $scope.readonly?!1:($scope.getBotsynonyms(intent),void $modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-synonyms/bt-add-synonyms.html",controller:"BTAddSynonymsCtrl",backdrop:"static",resolve:{config:function(){return{cbBridge:cbBridge,parentSynonyms:$scope.props.botSynonyms,isFromPP:!0}}}}))},$scope.confirmRegenerateDialog=function(){$("#regenerateModal").modal("hide");var payload={dialogId:$scope.regenerateDialogDetails.dialogId};BTStreamsService.regenerateSubDialog(_dialogObj.streamId,$scope.regenerateDialogDetails.formId,payload).then(function(response){response&&($("#"+$scope.regenerateDialogDetails.formId).hide(),NotificationService.notify(i18n.i18nString("regenerate_success_msg"),"success"))},function(error){NotificationService.notify(i18n.i18nString("summary_apifailed"),"error")})},$scope.onCancel=function(event){event&&event.preventDefault&&event.preventDefault(),resetFlag=!0,intialize(),resetFlag=!1,resetFlag&&($scope.saveInProgress=!1,$scope.onComplete()),$workflowService.dialogNodesNames([]),closeFullPageModal()},$scope.addInBetweenNode=function($event){var dropEle=$($event.currentTarget).closest(".dropdown");dropEle.toggleClass("open"),$scope.inBtwOptShown=!0,$scope.moveEleToTop($event)},$scope.moveEleToTop=function($event){$scope.showFormNodesList=!1,$scope.showUIFormsList=!1,$scope.formToggleOpen=!1;var _parentEle=$($event.currentTarget).parents(".draggableEle"),_zIndex=parseInt(_parentEle.css("zIndex"))+5;if(_parentEle.css("zIndex",_zIndex),$($event.currentTarget).hasClass("addConnectionBtn")){var _heightDiff=$($event.currentTarget.parentElement).offset().top+250-parseInt($(".flowTaskConnectionBlock").height()),_widthDiff=$($event.currentTarget.parentElement).offset().left+200-parseInt($(".flowTaskConnectionBlock").width());$scope.selectedNode&&(_widthDiff+=parseInt($element.find("property-panel .property-panel-cntnr").width())),_widthDiff>0&&$timeout(function(){$(".flowTaskConnectionBlock").scrollLeft(_widthDiff+parseInt($(".flowTaskConnectionBlock").scrollLeft()))},500),_heightDiff>0&&$timeout(function(){$(".flowTaskConnectionBlock").scrollTop(_heightDiff+parseInt($(".flowTaskConnectionBlock").scrollTop()))},500)}};var _highLightTagrets=[],_tracePath=!1;registerMouseEvents(),$(".flowTaskBlock").on("mousemove",function(e){if($scope.inBtwOptShown)return!1;var left=e.pageX,top=e.pageY,theHeight=$(".connectionInfoPopover").height(),theWidth=$(".connectionInfoPopover").width(),topBar=$(".flowTaskConnectionBlock").offset();$(".connectionInfoPopover").css("left",left-theWidth/2+$(".flowTaskConnectionBlock").scrollLeft()+"px"),$(".connectionInfoPopover").css("top",top-topBar.top-theHeight/2+$(".flowTaskConnectionBlock").scrollTop()+"px")});var _highlightedConnEle;$scope.highlightConnection=function(sourceId,targetId){return _highLightTagrets&&_highLightTagrets.length?void $scope.clearTracepath(!0):(_highLightTagrets=[],_highLightTagrets.push(targetId),_highLightTagrets.push(sourceId),$scope.clearTracepath(!1),$element.find(".flowTaskConnectionBlock").addClass("highlightNodes"),void $.each(_highLightTagrets,function(k,highlightNode){$element.find('[data-id="'+highlightNode+'"]').parents(".draggableEle").addClass("highlightedNode"),$element.find("connection.source-"+sourceId+".target-"+targetId).addClass("highlightedNode");var _connInfo=$.data($("connection.source-"+sourceId+".target-"+targetId)[0],"connection");$(_connInfo.node_from).closest(".arc-right").addClass("highlightedNode"),$(_connInfo.node_to).closest(".arc-left").addClass("highlightedNode")}))},$scope.tracePathClick=function(targetId){_tracePath=!_tracePath,$scope.highlightNodeMap(targetId)},$scope.highlightNodeMap=function(targetId,singleConnection){if(singleConnection=singleConnection||!1,_highLightTagrets&&_highLightTagrets.length)return void $scope.clearTracepath(!0);_highLightTagrets=[],_highLightTagrets.push(targetId);for(var i=0;;){var _valFound=!1;if(_highLightTagrets[i]===$scope.firstNodeUId)break;if(singleConnection&&2===_highLightTagrets.length)break;if($.each(_objConnection,function(k,connection){connection.targetId===_highLightTagrets[i]&&(_highLightTagrets.push(connection.sourceId),_valFound=!0)}),!(_valFound||i<_highLightTagrets.length-1))break;i++}$scope.clearTracepath(!1),$element.find(".flowTaskConnectionBlock").addClass("highlightNodes"),$.each(_highLightTagrets,function(k,highlightNode){$element.find('[data-id="'+highlightNode+'"]').parents(".draggableEle").addClass("highlightedNode"),singleConnection?highlightNode===targetId&&$element.find("connection.target-"+highlightNode).addClass("highlightedNode"):$element.find("connection.target-"+highlightNode).addClass("highlightedNode")})},$scope.clearTracepath=function(emptyHtargetArray){$element.find(".leftHook .arc-left").removeClass("highlightedNode"),$element.find(".rightHook .arc-right").removeClass("highlightedNode"),$element.find(".draggableEle").removeClass("highlightedNode"),$element.find("connection").removeClass("highlightedNode"),$element.find(".flowTaskConnectionBlock").removeClass("highlightNodes"),emptyHtargetArray&&(_highLightTagrets=[],_tracePath=!1)},$scope.expandFlowView=function(){$element.find(".flowTaskForm").addClass("expandedView")},$scope.collapseFlowView=function(){$element.find(".flowTaskForm").removeClass("expandedView")};var closeFullPageModal=function(){$("body").hasClass("bt-modal-open")&&($("body").removeClass("bt-modal-open"),$(".modal-backdrop").remove()),$scope.$emit("updateStep",-1),$("#btFullpageModal").modal("hide"),$rootScope.$emit("insertOrUpdateTask","flowTask",$scope.taskEditInfo,!1),$rootScope.$emit("showContent"),$rootScope.$broadcast("updateEditTask",!1),$(".flowTaskDebugConsolePanel").css("width",""),$scope.loadDialog=!1},closeFullPageModal1=function(){$rootScope.$emit("insertOrUpdateTask","flowTask",$scope.taskEditInfo,!1),$rootScope.$broadcast("updateEditTask",!1)};$scope.clearSetUpLocalStorageFortask=function(setTask){var localPath=window.localStorage.getItem("previousState");localPath&&(localPath=JSON.parse(localPath),localPath.selectedTaskType&&!setTask&&delete localPath.selectedTaskType,localPath.selectedTaskId&&!setTask&&delete localPath.selectedTaskId,setTask&&setTask._id&&(localPath.selectedTaskId=setTask._id,"published"==setTask.state?localPath.selectedTaskType="flowtaskView":localPath.selectedTaskType="flowtaskEdit"),window.localStorage.setItem("previousState",JSON.stringify(localPath)))},$scope.exit=function(){$scope.exitlabel="exitTaskFlow",$scope.closeRunBot(),_loggerInstance.isRecording||exit()},$scope.switchExit=function(){$scope.closeRunBot(),exit1()},$scope.exportDialog=function(){function startExport(){$scope.flowtaskObj.followUpIntents&&$scope.flowtaskObj.followUpIntents.length>0?$(".flowtask-dialog-modal").modal("show"):BTFlowtaskService.exportDialog(_selectedStream._id,$scope.flowtaskObj._id).then(function(res){writeAndDownloadDialog(res.data.name+".json",JSON.stringify(res.data))})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$element.find("#depricationExportFlowModal")&&$element.find("#depricationExportFlowModal").removeClass("show").addClass("fade"),$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_dialog")):startExport()},$scope.canelExportDialog=function(){$(".flowtask-dialog-modal").modal("hide")},$scope.startExportDialog=function(){$(".flowtask-dialog-modal").modal("hide"),BTFlowtaskService.exportDialog(_selectedStream._id,$scope.flowtaskObj._id).then(function(res){writeAndDownloadDialog(res.data.name+".json",JSON.stringify(res.data))})},$scope.showExportDeprication=function(){$element.find("#depricationExportFlowModal").removeClass("fade").addClass("show")},$scope.cancelExportDeprication=function(){$element.find("#depricationExportFlowModal").removeClass("show").addClass("fade")},$scope.importModalSlider=function(){$timeout(function(){$scope.modalSlider.open("#showDialogImport")},500)},$scope.intentModalSlider=function(){$timeout(function(){$scope.groupNodeIntentCreationInprogress?$("#createGroupNodeIntentModal").modal("show"):$scope.modalSlider.open("#showIntentSlider")},500)},$scope.importObj={},$scope.importObj.importDialog=null,$scope.readDialog=function(event){if($scope.importObj.importDialog){if($scope.importedDialogName=$scope.importObj.importDialog.name,$scope.importedDialogName){var _ext=$scope.importedDialogName.substring($scope.importedDialogName.lastIndexOf("."));if(".json"!==_ext)return NotificationService.notify(i18n.i18nString("upload_json"),"error"),void($scope.fileExtensionError=!0);$scope.fileExtensionError=!1,$scope.dialogRequiredError=!1}var reader=new FileReader;reader.readAsText($scope.importObj.importDialog),reader.onload=function(e){var data=reader.result;!data||data&&!data.length?(NotificationService.notify(i18n.i18nString("upload_valid"),"error"),$scope.fileEmptyError=!0):$scope.fileEmptyError=!1,$scope.importedDialogData=data}}},$scope.changeEvent=function(event){event.target.value=""},$scope.confirmImport=function(){return $scope.importedDialogData?($scope.isWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("importing"),void BTFlowtaskService.importDialog(_selectedStream._id,$scope.flowtaskObj._id,$scope.importedDialogData,$scope.bot).then(function(res){getFlowTasks(),$scope.doneImporting=!0,$workflowService.flowtaskInfo(res.data),$scope.flowtaskObj=res.data,$scope.importModalTitle=i18n.i18nString("successsful"),$scope.connections=getConnections(res.data.nodes),$scope.importDialogHeader=i18n.i18nString("dialog_backup_success"),intialize(),fetchBotComponentsByType("entity",function(res){}),$scope.importResults=i18n.i18nString("analyzing_file",{
length:$scope.flowtaskObj.nodes.length})+i18n.i18nString("analyzing_file_desc",{connections_length:$scope.connections.length}),$scope.isWorkProgress=!1,$scope.loaderMessage=i18n.i18nString("working"),$scope.displayMode="edit"},function(error){$scope.doneImporting=!0;var _msg=error.data.errors[0].msg;$scope.importDialogHeader=i18n.i18nString("dialog_backup_failure"),$scope.importResults=_msg,$scope.isWorkProgress=!1,$scope.loaderMessage=i18n.i18nString("working"),$scope.importModalTitle="Failed",NotificationService.notify(_msg,"error")})):($scope.dialogRequiredError=!0,void NotificationService.notify(i18n.i18nString("dialog_file_req"),"error"))},$scope.finishImporting=function(){$scope.doneImporting=!1,$scope.importedDialogName=void 0,$scope.importedDialogData=void 0,$scope.importDialog=void 0,$scope.importDialogHeader=i18n.i18nString("import_dialog_desc"),$scope.importModalTitle=i18n.i18nString("a_dialog"),$scope.fileExtensionError=!1,$scope.modalSlider.close("#showDialogImport")},$scope.intentCancel=function(){$scope.groupNodeIntentCreationInprogress?$("#createGroupNodeIntentModal").modal("hide"):$scope.modalSlider.close("#showIntentSlider"),$scope.groupNodeIntentCreationInprogress=!1,$scope.eleCreationInProgress=!1},$scope.onFinishSetup=function(type){BTFlowtaskService.finishFlowtask(_selectedStream._id,_dialogObj._id).then(function(res){NotificationService.notify(i18n.i18nString("dialog_configured"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.configure=function(val){};var _dialogSettingsCB={};_dialogSettingsCB.updateFlowData=function(flowData){if($scope.flowtaskObj=flowData,$scope.objList&&$scope.objList.intent0){var dialogIntent=$scope.objList.intent0.componentId;dialogIntent&&flowData&&flowData.name&&$.each($scope.objList,function(k,obj){obj.componentId===dialogIntent&&(obj.intent=flowData.name)})}console.log($scope.nodeInfo)};var _updateflowtask=function(flowtask){var index;$.each($scope.dialogTaskList,function(i,task){if(task.child&&task.child.length){if(flowtask._id===task.child[0]._id)return index=i,$scope.dialogTaskList[index].child[0]=flowtask,$scope.flowtaskObj=$scope.dialogTaskList[index].child[0],$scope.openManageInterruptions.currFlowTask=$scope.flowtaskObj,$scope.openManageInterruptions.dialogObj=$scope.flowtaskObj,!1}else if(flowtask._id===task._id)return index=i,$scope.dialogTaskList[index]=flowtask,$scope.flowtaskObj=$scope.dialogTaskList[index],$scope.openManageInterruptions.currFlowTask=$scope.flowtaskObj,void($scope.openManageInterruptions.dialogObj=$scope.flowtaskObj)})},_updateFollowUpIntents=function(flowtask,followUpIntents){var index;$.each($scope.dialogTaskList,function(i,task){if(task.child&&task.child.length){if(flowtask._id===task.child[0]._id)return index=i,$scope.dialogTaskList[index].child[0].followUpIntents=followUpIntents,$scope.flowtaskObj=$scope.dialogTaskList[index].child[0],$scope.openManageInterruptions.currFlowTask=$scope.flowtaskObj,$scope.openManageInterruptions.dialogObj=$scope.flowtaskObj,!1}else if(flowtask._id===task._id)return index=i,$scope.dialogTaskList[index].followUpIntents=followUpIntents,$scope.flowtaskObj=$scope.dialogTaskList[index],$scope.openManageInterruptions.currFlowTask=$scope.flowtaskObj,$scope.openManageInterruptions.dialogObj=$scope.flowtaskObj,!1})};$scope.openDialogLinkedTask=function(flowtask){return $scope.showStandardResponses=!1,$scope.flowtaskObj=$scope.flowtaskObj||$workflowService.flowtaskInfo(),$scope.conversationBuilder&&$scope.callBack&&$scope.callBack.openManageInterruptions?void $scope.callBack.openManageInterruptions($scope.flowtaskObj,!0):($scope.sliderStep=1,$scope.showflowsinterrupts=!0,$scope.openManageInterruptions.dialogObj=$scope.flowtaskObj,$scope.openManageInterruptions.updateDialog=_updateflowtask,$scope.openManageInterruptions.updateFollowUpIntents=_updateFollowUpIntents,$scope.openManageInterruptions.dialogTasks=$scope.dialogTaskList,$scope.openManageInterruptions.currFlowTask=$scope.flowtaskObj,void setTimeout(function(){$scope.openManageInterruptions.viewMode="published"===$scope.flowtaskObj.state?!0:!1,("setup"===$scope.stream.state&&$scope.stream.sbStreamId||!$scope.flowtaskObj.editable)&&($scope.openManageInterruptions.viewMode=!0),$scope.modalSlider.open("#flowTaskmanageInteruptions")},600))},$scope.getComponents=function(flowtask){$scope.nodeObjCount={},$scope.component={},BTFlowtaskService.getFlowtaskComponents($workflowService.selectedStream()._id,flowtask._id).then(function(res){res&&res.data&&($.each(res.data,function(k,component){$scope.component[component._id]=component}),$.each(flowtask.nodes,function(k,nodeele){$scope.nodeObjCount[nodeele.componentId]||($scope.nodeObjCount[nodeele.componentId]={count:0},$scope.nodeObjCount[nodeele.componentId][nodeele.nodeId]=$scope.nodeObjCount[nodeele.componentId].count),$scope.nodeObjCount[nodeele.componentId].count=$scope.nodeObjCount[nodeele.componentId].count+1,$scope.nodeObjCount[nodeele.componentId][nodeele.nodeId]=$scope.nodeObjCount[nodeele.componentId].count,nodeele.count=$scope.nodeObjCount[nodeele.componentId].count}))})},$scope.openAmendEntity=function(){return $scope.conversationBuilder&&$scope.callBack&&$scope.callBack.amendEntityDialog?void $scope.callBack.amendEntityDialog($scope.flowtaskObj):($scope.amendEntity.flowtask=$workflowService.cloneData($workflowService.flowtaskInfo()),$scope.flowtaskObj=$workflowService.cloneData($workflowService.flowtaskInfo()),$scope.amendEntity.flowtask.amendConfig=$scope.flowtaskObj.amendConfig||{},$scope.amendEntity.flowtask.amendConfig&&void 0===$scope.amendEntity.flowtask.amendConfig.priority&&($scope.amendEntity.flowtask.amendConfig={priority:"bot"}),$scope.amendEntity.flowtask.amendConfig&&$scope.amendEntity.flowtask.amendConfig.enabled&&($scope.amendEntity.flowtask.amendConfig.allowHidden=$scope.amendEntity.flowtask.amendConfig.hasOwnProperty("allowHidden")?$scope.amendEntity.flowtask.amendConfig.allowHidden:!1),"jumpToSpecificNode"===$scope.amendEntity.flowtask.amendConfig.postAmend&&$scope.getComponents($scope.flowtaskObj),$scope.amendEntity.streamData=$workflowService.selectedStream(),$scope.viewMode="published"===$scope.flowtaskObj.state?!0:!1,void $scope.modalSlider.open("#showAmendEntityDialog"))},$scope.setDefault=function(){$workflowService.flowtaskInfo()&&$workflowService.flowtaskInfo().amendConfig&&"task"===$workflowService.flowtaskInfo().amendConfig.priority?void 0===$scope.amendEntity.flowtask.amendConfig.enabled?$scope.amendEntity.flowtask.amendConfig.enabled=!1:$scope.amendEntity.flowtask=$workflowService.cloneData($workflowService.flowtaskInfo()):void 0===$scope.amendEntity.flowtask.amendConfig.enabled&&($scope.amendEntity.flowtask.amendConfig.enabled=!1)},$scope.setDefaultPriority=function(){void 0===$scope.amendEntity.flowtask.amendConfig.postAmend&&($scope.amendEntity.flowtask.amendConfig.postAmend="continueFromAmendedNode")},$scope.saveAmendEntity=function(){prepareData();var _params={};_params.streamId=$workflowService.selectedStream()._id,_params.name=$scope.amendEntity.flowtask.name,_params.shortDesc=$scope.amendEntity.flowtask.shortDesc,_params.visibility=$scope.amendEntity.flowtask.visibility,_params.amendConfig=$scope.amendEntity.flowtask.amendConfig,BTFlowtaskService.updateFlowtask($workflowService.selectedStream()._id,$scope.amendEntity.flowtask._id,_params).then(function(res){res&&res.data&&(NotificationService.notify(i18n.i18nString("notify_amend"),"success"),$workflowService.flowtaskInfo(res.data),$scope.amendEntity.flowtask=res.data,$scope.closeAmendSlider())})},$scope.closeAmendSlider=function(){$scope.modalSlider.close("#showAmendEntityDialog")},$scope.onInterruptsCancel=function(){$scope.showflowsinterrupts=!1,$scope.sliderStep=null,$scope.modalSlider.close("#flowTaskmanageInteruptions")},$scope.updateInterruptsStep=function(event,stepNo){stepNo&&$timeout(function(){$scope.sliderStep=stepNo})},$scope.stepUpdate=function(step){$scope.$emit("updateInterruptsStep",step)},$scope.$on("updateInterruptsStep",$scope.updateInterruptsStep),$scope.openDialogSettings=function(z){$scope.dialogSettingsCB.show=!0,$timeout(function(){if(isTaskFailEnabled)for(var i=0;i<$scope.availableFlowTasks.length;i++)if($scope.availableFlowTasks[i]._id===$scope.flowtaskObj._id&&$scope.flowtaskObj.onTaskFailure&&$scope.availableFlowTasks[i].onTaskFailure){$scope.flowtaskObj.onTaskFailure.msg=$workflowService.cloneData($scope.availableFlowTasks[i].onTaskFailure.msg);break}$scope.dialogSettingsCB.dialogObj=$scope.flowtaskObj,$scope.dialogSettingsCB.cb=_dialogSettingsCB,$scope.dialogSettingsCB.callFrom="dialog",$scope.dialogSettingsCB.viewMode="published"===$scope.flowtaskObj.state?!0:!1,("setup"===$scope.stream.state&&$scope.stream.sbStreamId||!$scope.flowtaskObj.editable)&&($scope.dialogSettingsCB.viewMode=!0),$(".dialogTask .dialogSettingsForm").modal("show"),$scope.dialogSettingsCB.init(),$scope.dialogSettingsCB.init||$timeout(function(){$scope.dialogSettingsCB.init()},200)},500)},$scope.getSentenceCase=function(value){return _selectedStream.defaultLanguage&&"en"!==_selectedStream.defaultLanguage?value:$filter("sentence_case")(value)},$scope.validateTaskName=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression("dialog");return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,{test:function(value){return value&&1===value.length?regexp2.test(value):regexp.test(value)}}}();var _intentObj={name:"",desc:"",requiredFields:["name"]},_entityObj={name:"",nodeType:"label",prompt:"",requiredFields:[]},_formObj={name:"",requiredFields:[]},_logicObj={name:"",requiredFields:[]},_sdkwebhookObj={name:"",requiredFields:[]},_agentTransferObj={name:"",requiredFields:[]},_serviceObj={name:"",serviceType:"rest",serviceNodeType:"custom",requiredFields:[]},_scriptObj={name:"",requiredFields:[]},_messageObj={name:"",prompt:"",requiredFields:[]},_confirmationObj={name:"",prompt:"",requiredFields:[]};_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable&&(_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable_transcript&&_defaultIVRProps&&_defaultIVRProps.grammars&&_defaultIVRProps.grammars.length&&(_defaultIVRProps.grammars[0].type="disable"),_entityObj.ivrOptions=$workflowService.cloneData(_defaultIVRProps),_confirmationObj.ivrOptions=$workflowService.cloneData(_defaultIVRProps));var _serviceNodeType=[];$scope.nodeTypeObjOptns=[],$scope.onInputKeyup=function(e,type,field){var _selectedLanguage=$workflowService.currentLanguage(),_this=$(e.currentTarget);"intent"!==type&&"prompt"!==field?-1!==_this.val().indexOf(" ")&&_this.val(_this.val().replace(/\s/g,"")):"intent"==type&&(_this=$(e.currentTarget),_selectedLanguage&&"en"===_selectedLanguage&&_this.val(_this.val().replace(/[^a-zA-Z- 0-9]+/g,""))),$scope.onCheckLength(e),$scope.checkCreateNodeFormDirty()},$scope.onCheckLength=function(e){var _this=$(e.currentTarget);_this&&_this.val().length>256&&_this.val(_this.val().substr(0,256))},$scope.updateServiceNodeType=function(value){"custom"!==value?$element.find(".serviceNodeSubType").attr("disabled","disabled"):$element.find(".serviceNodeSubType").removeAttr("disabled"),$scope.nodeObj.serviceType="",$scope.checkCreateNodeFormDirty()},$scope.checkCreateNodeFormDirty=function(){if($scope.nodeObj.requiredFields&&$scope.nodeObj.requiredFields.length>0){var isValid=!0;return $.each($scope.nodeObj.requiredFields,function(k,field){return"custom"!==$scope.nodeObj.serviceNodeType&&"serviceType"===field||0!==$scope.nodeObj[field].length?void 0:($scope.nodeObj.isInvalid=!0,isValid=!1,!1)}),isValid?void($scope.nodeObj.isInvalid=!1):void 0}},$scope.changeDialogTask=function(task,update){if(_loggerInstance&&_loggerInstance.isRecording)return $("#recordInProgressFlow").modal("show"),void($scope.taskDialog=task);var entity=update||_.find($scope.dialogTasksByState,{_id:task});return entity.sceneRefId&&$util.isIE11OrEarlier()?($util.showUnSupportedBrowserWarningForDialog(),!1):($scope.switchExit(),void $timeout(function(){$scope.$emit("switchDialogTaskEdit",entity,{success:function(){$(".botDetailsForm").removeClass("dialogModalOpen"),$workflowService.flowtaskInfo(entity),$scope.clearSetUpLocalStorageFortask(entity),$scope.$emit("switchDialogTask",entity.state)},failure:function(){console.log("Task locked")}})},1500))},$scope.onNodeSave=function(nodeObj){function createDialog(uId,componentRes){var _params={name:$scope.nodeObj.name,shortDesc:$scope.nodeObj.desc},_transitions=[];_transitions.push({"default":"",metadata:{color:_connectionColors[0],connId:"dummy"+dummyConnectionCount}}),dummyConnectionCount++,componentRes&&componentRes._id&&(_params.nodes=[],_params.nodes.push({nodeId:uId,type:componentRes.type,componentId:componentRes._id,transitions:_transitions,metadata:{left:30,top:170}})),_params.visibility={namespace:"private",namespaceIds:[""]},BTFlowtaskService.createFlowtask(_selectedStream._id,_params).then(function(res){if(_dialogObj=res&&res.data,$scope.flowtaskObj=res&&res.data,createNodeEle($scope.nodeObj,_transitions),"intent"===componentRes.type){var _payload={name:componentRes.name,dialogId:_dialogObj._id};BTFlowtaskService.updateComponent($scope.streamId,componentRes._id,_payload).then(function(res){mixPanelUpdateEvent(componentRes,$scope.flowtaskObj),_botComponents.push(res&&res.data),updateDialogEntities(),updateConectionWarnings()},function(err){NotificationService.notify(i18n.i18nString("component_failed"),"error")})}$scope.nodeObj={},$scope.saveNodeInProgress=!1,$element.find("#flowtask_node_Begin").modal("toggle"),$element.find("#flowtask_node_Begin .btnSave").removeClass("disabled").text("Create")},function(error){if(_dialogObj={},$scope.saveNodeInProgress=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$element.find("#flowtask_node_Begin .btnSave").removeClass("disabled").text("Create")})}function createComponent(nodeObj){var _params=$.extend(!0,{},$scope.nodeObj);$scope._tempMessageParams={},delete _params.requiredFields,delete _params.isInvalid,"intent"===_params.type?(_params.intent=_params.name,delete _params.name):("entity"===_params.type||"dialogAct"===_params.type||"message"===_params.type)&&delete _params.prompt,"entity"===_params.type&&(_params.entityType=_params.nodeType,_params.errorMessage=[{text:$workflowService.cloneData(errorMessages[_params.entityType]||" "),type:"basic",channel:"default"}],$scope._tempMessageParams.errorMessage=_params.errorMessage,delete _params.nodeType),delete _params.uId,nodeObj&&(_params.resourceId=nodeObj.refId),BTFlowtaskService.createComponent(_selectedStream._id,_params).then(function(res){var _eventPayload={streamId:_selectedStream._id,BotName:_selectedStream.name,"Dialog Name":$scope.flowtaskObj.name,"Dialog Version":"V1",Category:"Engagement L2","Sub Category":"Conversation - Dialog Task",Level:"Engagement L2","Primary Intent creation mode":"Storyboard"},event="";"intent"===_params.type?event="Conversation - Dialog Intent Created":"message"===_params.type?event="Conversation - Dialog Message Node created":"entity"===_params.type?event="Conversation - Dialog Entity Node created":"dialogAct"===_params.type?event="Conversation - Dialog Confirmation Node created":"service"===_params.type?event="Conversation - Bot action Service created":"script"===_params.type?event="Conversation - Bot action Script created":"logic"===_params.type?event="Conversation - Bot action Logic created":"SDKWebHook"===_params.type?event="Conversation - Bot action Webhook created":"process"===_params.type?event="Conversation - Bot action Process created":"agentTransfer"===_params.type?event="Conversation - Agent Transfer node updated":"form"===_params.type&&(event="Conversation - Form node updated"),event&&mixPanel.postEvent(event,_eventPayload),BTFlowtaskService.getComponents(_selectedStream._id,res.data._id).then(function(res){var _res=res&&res.data;_.merge($scope.nodeObj,_res),$scope.nodeObj.uId=_res.type+count,$scope.nodeObj.componentId=_res._id,_res.uId=$scope.nodeObj.uId,_res.nodeId=$scope.nodeObj.uId,_objList.push(_res),_res&&"intent"===_res.type?$scope.nodeObj.intent=_res.intent:$element.find("#flowtask_node_Begin").removeClass("hide"),0===$scope.firstNodeUId.length?($scope.firstNodeUId=$scope.nodeObj.uId,$scope.firstNodeComponentId=$scope.nodeObj.componentId,createDialog($scope.nodeObj.uId,_res)):($scope.saveNodeInProgress=!1,_botComponents.push(_res),updateDialogEntities(),addNodeOnDialog(_res),_res&&"intent"===_res.type?$scope.modalSlider.close("#showIntentSlider"):($element.find("#flowtask_node_Begin").modal("toggle"),$element.find("#flowtask_node_Begin .btnSave").removeClass("disabled").text("Create"))),count++,updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},function(error){if($scope.saveNodeInProgress=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$element.find("#flowtask_node_Begin .btnSave").removeClass("disabled").text("Create")})}if($scope.nodeObj.requiredFields&&$scope.nodeObj.requiredFields.length>0){var isValid=!0;if($.each($scope.nodeObj.requiredFields,function(k,field){return"service"===$scope.nodeObj.type&&"custom"!==$scope.nodeObj.serviceNodeType&&"serviceType"===field||0!==$scope.nodeObj[field].length?void 0:($scope.nodeObj.isInvalid=!0,isValid=!1,!1)}),!isValid)return}$scope.saveNodeInProgress||($scope.saveNodeInProgress=!0,"service"===$scope.nodeObj.type&&"custom"!==$scope.nodeObj.serviceNodeType&&($scope.nodeObj.serviceType="rest"),$element.find("#flowtask_node_Begin .btnSave").addClass("disabled").text("Creating..."),createComponent(nodeObj))},$scope.onNodeClose=function(){0===$scope.firstNodeUId.length?($element.find("#flowtask_node_Begin").modal("toggle"),$timeout($scope.exit,350)):$element.find("#flowtask_node_Begin").modal("toggle"),$scope.nodeObj={},$("#flowtask_node_Begin").modal("hide"),$scope.modalSlider&&$scope.modalSlider.close&&($scope.modalSlider.close("#showIntentSlider"),$scope.eleCreationInProgress=!1)},$scope.pushHistoryInfo=function(debug){pushHistory(debug)},$scope.pushDebugInfo=function(debug){debug.NLAnalysis&&!_.isEmpty(debug.NLAnalysis)&&($scope.nlTraceData=debug.NLAnalysis||"");var tempDebug=$workflowService.cloneData(debug);"contextUpdate"===tempDebug.type&&(debug=debug.context||{},$scope.debugRaw=debug,$scope.debugContext=debug),"contextUpdate"===tempDebug.type&&tempDebug.context.scriptErrorMeta&&$rootScope.$emit("validate script",tempDebug),$timeout(function(){$scope.$digest()},350)},$scope.showBotScreen=function(){checkForTempConnections();$scope.isChatWindowMinimized?$scope.maximizeRunBot():showBotScreen()},$scope.toggleRecording=function(e){if($(e.target).hasClass("knowmore"))return!1;var _ele=angular.element(".whiteBorder");_ele&&_ele.length>0?(angular.element(".whiteBorder").removeClass("whiteBorder").addClass("whiteBorderStop"),_loggerInstance.isRecording=!0):(angular.element(".whiteBorderStop").removeClass("whiteBorderStop").addClass("whiteBorder"),_loggerInstance.isRecording=!1,$("#recordStopFlow").modal("show"))},$scope.closeDownloadModal=function(){$("#recordStopFlow").modal("hide"),_loggerInstance.isRecording=!0,angular.element(".whiteBorder").removeClass("whiteBorder").addClass("whiteBorderStop")},$scope.closeInProgressModal=function(){$("#recordInProgressFlow").modal("hide"),$scope.exitlabel="",$scope.taskDialog=void 0},$scope.downloadChatJson=function(){$rootScope.$emit("downloadChatJson"),$("#recordStopFlow").modal("hide")},$scope.discardDownloadModal=function(){$scope.closeRunBot(),$("#recordStopFlow").modal("hide"),$scope.createTestCaseConfig.createTestCaseFlag=!1},$scope.createTestCase=function(){if(_loggerInstance&&_loggerInstance.getData){var chatData=JSON.stringify(_loggerInstance.getData());$rootScope.recordedChatData=chatData}setTimeout(function(){$("#recordStopFlow").modal("hide"),$rootScope.manageTestCaseModal&&$rootScope.manageTestCaseModal("create")},200),$timeout(function(){$scope.closeRunBot()},0)},$scope.refreshBotData=function(){var _hasTempConn=checkForTempConnections(),_NodesMsg="";if(_hasTempConn.hasTempConn){var tempConnNodes=_.uniq(_hasTempConn.nodes,function(x){return x.uId});$.each(tempConnNodes,function(k,node){_NodesMsg+=node.name+", "}),_NodesMsg=i18n.i18nString("nodes_msg")+"<br>"+_NodesMsg.substr(0,_NodesMsg.length-2),window.bootbox.dialog({message:i18n.i18nString("temp_connections")+"<br/><br/>"+_NodesMsg,title:i18n.i18nString("temp_connections_title"),className:"alert-modal",buttons:{success:{label:i18n.i18nString("no"),className:"btn-primary",callback:function(){}},main:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){refreshBotData()}}}})}else $timeout(function(){refreshBotData()},100)},$scope.closeRunBot=function(){$("body").removeClass("displayTalkTo"),$scope.debugInfo=[],$scope.debugRaw={},$scope.debugContext="",$scope.nlTraceData="",_loggerInstance&&_loggerInstance.isRecording?$("#recordInProgressFlow").modal("show"):($scope.minMaxChatWinowz("minimize"),$scope.runBot.show=!0,$scope.isConnecting=!0,$rootScope.$emit("botTestEnd"),$scope.closeDebugConsolePanel(),$scope.showRunBotHeader=!0,$timeout(function(){$element.find(".runBotContainer .botConfigBody").removeClass("slideLeft"),$element.find(".runBotContainer .runBotBody").removeClass("slideLeft")},100))},$scope.minMaxDebugLog=function(action){"minimize"===action?$(".dialogFieldset .flowTaskDebugConsolePanel").length&&$(".dialogFieldset .flowTaskDebugConsolePanel").hasClass("minimized")&&($(".dialogFieldset").addClass("maximized"),$(".flowTaskDebugConsolePanel .minMax").trigger("click")):$(".dialogFieldset .flowTaskDebugConsolePanel").length&&$(".dialogFieldset .flowTaskDebugConsolePanel").hasClass("maximized")&&($(".dialogFieldset").removeClass("maximized"),$(".flowTaskDebugConsolePanel .minMax").trigger("click"))},$scope.minMaxChatWinowz=function(action){"minimize"===action?$element.find(".flowTaskForm").removeClass("isRunBotOpen"):$element.find(".flowTaskForm").addClass("isRunBotOpen"),$scope.adjustpannelsInIframe("chatWindow",action)},$scope.maximizeRunBot=function(){$scope.minMaxChatWinowz("maximize"),$element.find(".flowTaskForm").addClass("isRunBotOpen"),$scope.runBot.show=!1,$scope.isChatWindowMinimized=!1;$timeout(function(){$scope.minMaxDebugLog("minimize")},100),$timeout(function(){var _ele=$element.find(".flowTaskPropertyPanel");if(_ele&&_ele.length){var _panelLeft=_ele.offset().left;if($scope.isPropertyPanelOpened&&0>_panelLeft){var _parentEle=$element.find(".flowTaskConnectionBlock"),_right=parseInt(_parentEle.width())-10-parseInt(_ele.width());_ele.css("right",_right+"px"),_ele.css("left","auto")}}},500)},$scope.minimizeRunBot=function(){$("body").removeClass("displayTalkTo"),$scope.minMaxChatWinowz("minimize"),$element.find(".flowTaskForm").removeClass("isRunBotOpen"),$timeout(function(){$scope.minMaxDebugLog()},100),$scope.showRunBotHeader=!0,$scope.isChatWindowMinimized=!0,$timeout(function(){$element.find(".runBotContainer .botConfigBody").removeClass("slideLeft"),$element.find(".runBotContainer .runBotBody").removeClass("slideLeft"),$scope.runBot.show=!0},100)},$scope.confirmCloseProgressModal=function(){_loggerInstance.isRecording=!1;var _ele=angular.element(".whiteBorderStop");_ele&&_ele.length>0&&angular.element(".whiteBorderStop").removeClass("whiteBorderStop").addClass("whiteBorder"),setTimeout(function(){$("#recordInProgressFlow").modal("hide")},300),void 0!==$scope.taskDialog?$scope.changeDialogTask($scope.taskDialog):"exitTaskFlow"===$scope.exitlabel?$scope.exit():$scope.closeRunBot()},$scope.runBotConfiguration=function(_openBotConfig){_openBotConfig?($scope.showRunBotHeader=!1,$timeout(function(){$element.find(".runBotContainer .botConfigBody").addClass("slideLeft"),$element.find(".runBotContainer .runBotBody").addClass("slideLeft"),fetchServiceNodes()},100)):($scope.showRunBotHeader=!0,$timeout(function(){$element.find(".runBotContainer .botConfigBody").removeClass("slideLeft"),$element.find(".runBotContainer .runBotBody").removeClass("slideLeft")},100))},$scope.onmMenuOptionClicked=function($event){if($event.stopPropagation(),$event.currentTarget){var _currEle=$($event.currentTarget);_currEle.siblings().removeClass("active"),_currEle.addClass("active"),_currEle.find(".dropdown").addClass("open")}},$scope.setZoombyDisplayOptions=function(){$element.find(".flowTaskConnectionBlock").hasClass("hideConn")?$scope.setZoom(.7):$scope.restoreZoom()},$scope.setZoom=function(zoomScale){var _prevZoom=$scope.zoomScale;$scope.zoomScale=zoomScale,$scope.zoomScalePer=parseInt(100*$scope.zoomScale)+"%",$element.find(".draggableEle").css("transform","scale("+$scope.zoomScale+")").css("transform-origin","0 0"),$element.find("connection").css("transform","scale("+$scope.zoomScale+")").css("transform-origin","0 0"),$timeout(function(){rearrangeGroups()},700);var _ele=$element.find(".draggableEle");_ele.length>0&&$.each(_ele,function(k,ele){var _left=parseInt($(ele).css("left")),_top=parseInt($(ele).css("top"));$(ele).css("left",parseInt(_left*$scope.zoomScale/_prevZoom)),$(ele).css("top",parseInt(_top*$scope.zoomScale/_prevZoom))}),$element.connections({updateZoom:!0,zoomScale:$scope.zoomScale}),$timeout(function(){$element.find("connection").connections("update"),chechForConnectionCounts()},100)},$scope.reduceZoom=function(){var _prevZoom=$scope.zoomScale;parseInt(10*$scope.zoomScale)-5>0&&($scope.zoomScale=parseFloat(parseFloat($scope.zoomScale)-.1).toFixed(1)),$scope.zoomScalePer=parseInt(100*$scope.zoomScale)+"%",$element.find(".draggableEle").css("transform","scale("+$scope.zoomScale+")").css("transform-origin","0 0"),$element.find("connection").css("transform","scale("+$scope.zoomScale+")").css("transform-origin","0 0"),$timeout(function(){rearrangeGroups()},700);var _ele=$element.find(".draggableEle");_ele.length>0&&$.each(_ele,function(k,ele){var _left=parseInt($(ele).css("left")),_top=parseInt($(ele).css("top"));$(ele).css("left",parseInt(_left*$scope.zoomScale/_prevZoom)),$(ele).css("top",parseInt(_top*$scope.zoomScale/_prevZoom))}),$element.connections({updateZoom:!0,zoomScale:$scope.zoomScale}),$timeout(function(){$element.find("connection").connections("update"),chechForConnectionCounts()},100)},$scope.increaseZoom=function(){var _prevZoom=$scope.zoomScale;parseInt(10*$scope.zoomScale)-15<0&&($scope.zoomScale=parseFloat(parseFloat($scope.zoomScale)+.1).toFixed(1)),$scope.zoomScalePer=parseInt(100*$scope.zoomScale)+"%",$element.find(".draggableEle").css("transform","scale("+$scope.zoomScale+")").css("transform-origin","0 0"),$element.find("connection").css("transform","scale("+$scope.zoomScale+")").css("transform-origin","0 0"),$timeout(function(){rearrangeGroups()},700);var _ele=$element.find(".draggableEle");_ele.length>0&&$.each(_ele,function(k,ele){var _left=parseInt($(ele).css("left")),_top=parseInt($(ele).css("top"));$(ele).css("left",parseInt(_left*$scope.zoomScale/_prevZoom)),$(ele).css("top",parseInt(_top*$scope.zoomScale/_prevZoom))}),$element.connections({updateZoom:!0,zoomScale:$scope.zoomScale}),$timeout(function(){$element.find("connection").connections("update"),chechForConnectionCounts()},100)},$scope.restoreZoom=function(){var _prevZoom=$scope.zoomScale;$scope.zoomScale=1,$scope.zoomScalePer=parseInt(100*$scope.zoomScale)+"%",$element.find(".draggableEle").css("transform","scale("+$scope.zoomScale+")").css("transform-origin","0 0"),$element.find("connection").css("transform","scale("+$scope.zoomScale+")").css("transform-origin","0 0"),$timeout(function(){rearrangeGroups()},700);var _ele=$element.find(".draggableEle");_ele.length>0&&$.each(_ele,function(k,ele){var _left=parseInt($(ele).css("left")),_top=parseInt($(ele).css("top"));$(ele).css("left",parseInt(_left*$scope.zoomScale/_prevZoom)),$(ele).css("top",parseInt(_top*$scope.zoomScale/_prevZoom))}),$element.connections({updateZoom:!0,zoomScale:$scope.zoomScale}),$timeout(function(){$element.find("connection").connections("update"),chechForConnectionCounts()},100)},$scope.displayOptionClicked=function(displayOpt,e){var _currentTarget=$(e.currentTarget);if(e.currentTarget&&_currentTarget.parent().hasClass("showRefresh"))return void NotificationService.notify(i18n.i18nString("display_option"),"warning");if(_currentTarget.siblings().removeClass("showSpin"),_currentTarget.parent().addClass("showRefresh"),_currentTarget.addClass("showSpin"),"hideType"===displayOpt?$scope.displayOpts.hideType?($element.find(".flowTaskConnectionBlock").removeClass("hideType"),$scope.displayOpts.hideType=!1):($element.find(".flowTaskConnectionBlock").addClass("hideType"),$scope.displayOpts.hideType=!0):"hideNode"===displayOpt?$scope.displayOpts.hideNode?($element.find(".flowTaskConnectionBlock").removeClass("hideNode"),$scope.displayOpts.hideNode=!1):($element.find(".flowTaskConnectionBlock").addClass("hideNode"),$scope.displayOpts.hideNode=!0):"hideConn"===displayOpt?$scope.displayOpts.hideConn?($element.find(".flowTaskConnectionBlock").removeClass("hideConn"),$scope.displayOpts.hideConn=!1):($element.find(".flowTaskConnectionBlock").addClass("hideConn"),$scope.displayOpts.hideConn=!0):"showAll"===displayOpt&&($scope.displayOpts.hideType&&$scope.displayOpts.hideNode&&$scope.displayOpts.hideConn?($element.find(".flowTaskConnectionBlock").removeClass("hideType hideNode hideConn"),$scope.displayOpts.hideType=!1,$scope.displayOpts.hideNode=!1,$scope.displayOpts.hideConn=!1):($element.find(".flowTaskConnectionBlock").addClass("hideType hideNode hideConn"),$scope.displayOpts.hideType=!0,$scope.displayOpts.hideNode=!0,$scope.displayOpts.hideConn=!0)),$scope.conversationBuilder||$.each(_objList,function(k,obj){rearrangeConnectionsForObj(obj.nodeId)}),"view"===$scope.displayMode)return _currentTarget.parent().removeClass("showRefresh"),_currentTarget.removeClass("showSpin"),_currentTarget.siblings().removeClass("showSpin"),!1;var _updateParams={name:_dialogObj.name,nodes:_dialogObj.nodes,streamId:_dialogObj.streamId,visibility:_dialogObj.visibility,displayOption:_dialogObj.displayOption};_updateParams.displayOption=JSON.stringify($scope.displayOpts),$scope.conversationBuilder||$scope.setZoombyDisplayOptions(),BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_updateParams).then(function(res){if($scope.conversationBuilder){var parms={action:"displayOptions",payload:{displayOption:displayOpt,allOptions:JSON.stringify($scope.displayOpts)}};return $scope.sendEventToIframe(parms),$workflowService.flowtaskInfo(res.data),_currentTarget.parent().removeClass("showRefresh"),_currentTarget.removeClass("showSpin"),_currentTarget.siblings().removeClass("showSpin"),void(_dialogObj=res&&res.data)}$workflowService.flowtaskInfo(res.data),$scope.prepareComponentCount(null,!0),_dialogObj=res&&res.data,$scope.nodeObj={},_currentTarget.parent().removeClass("showRefresh"),
_currentTarget.removeClass("showSpin"),_currentTarget.siblings().removeClass("showSpin"),$scope.processingCreateEle=!1,updateScriptDefWarnings(),updateServiceReqDefWarnings(),updateServiceSampleResWarnings(),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateConectionWarnings()},function(error){if(_currentTarget.parent().removeClass("showRefresh"),_currentTarget.removeClass("showSpin"),_currentTarget.siblings().removeClass("showSpin"),$scope.processingCreateEle=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")}),$timeout(function(){$element.find("connection").connections("update"),chechForConnectionCounts()},100)},$scope.onImportClicked=function(){NotificationService.notify(i18n.i18nString("onimport_click"),"warning")},$scope.onExportClicked=function(){NotificationService.notify(i18n.i18nString("onimport_click"),"warning")},$scope.autoArrangeDialog=function(){var parms={action:"autoarrange",payload:{}};$scope.sendEventToIframe(parms)},$scope.zoomOptionClicked=function(option){if($scope.conversationBuilder){var parms={action:"zoomOption",payload:{zoomMethod:option}};return void $scope.sendEventToIframe(parms)}if("fitToPage"===option){$element.find(".flowTaskConnectionBlock").scrollLeft(0).scrollTop(0);var _extremeLeft=0,_extremeTop=0,_extremeTopHeight=0;$.each($scope.objList,function(k,obj){obj.metadata&&obj.metadata.left&&obj.metadata.left>_extremeLeft&&(_extremeLeft=obj.metadata.left),obj.metadata&&obj.metadata.top&&obj.metadata.top>_extremeTop&&(_extremeTop=obj.metadata.top,$element.find('[data-id="'+obj.uId+'"]').length>0&&(_extremeTopHeight=$element.find('[data-id="'+obj.uId+'"]').height()))}),_extremeLeft*=$scope.zoomScale,_extremeTop*=$scope.zoomScale,_extremeTopHeight*=$scope.zoomScale,parseInt(10*$scope.zoomScale)>5&&(_extremeTop+_extremeTopHeight+20>$element.find(".flowTaskBlock").height()||_extremeLeft+300>$element.find(".flowTaskBlock").width())&&($scope.reduceZoom(),$timeout(function(){$scope.zoomOptionClicked("fitToPage")},350))}else if("resetZoom"===option){var _prevZoom=$scope.zoomScale;$scope.zoomScale=1,$element.find(".draggableEle").css("transform","").css("transform-origin","0 0"),$element.find("connection").css("transform","").css("transform-origin","0 0");var _ele=$element.find(".draggableEle");_ele.length>0&&$.each(_ele,function(k,ele){var _left=parseInt($(ele).css("left")),_top=parseInt($(ele).css("top"));$(ele).css("left",parseInt(_left*$scope.zoomScale/_prevZoom)),$(ele).css("top",parseInt(_top*$scope.zoomScale/_prevZoom))}),$element.connections({updateZoom:!0,zoomScale:$scope.zoomScale}),$timeout(function(){$element.find("connection").connections("update"),chechForConnectionCounts()},100),$scope.zoomScale=1,$scope.zoomScalePer="100%"}$element.find(".subBar .dropdown").removeClass("open")},$scope.toggleSize=function(e){$scope.isExpanded?(_flowTaskPropertyPanel.css("width",Math.floor(500)),$(".flowTaskPropertyPanel").width()<500?($(".propertyPanelExpand").addClass("hide"),$(".propertyPanelCompress").addClass("hide")):($(".propertyPanelExpand").removeClass("hide"),$(".propertyPanelCompress").removeClass("hide"))):(_flowTaskPropertyPanel.css("width",Math.floor(.6*_flowTaskConnectionBlock.width())),$(".flowTaskPropertyPanel").width()<500?($(".propertyPanelExpand").addClass("hide"),$(".propertyPanelCompress").addClass("hide")):($(".propertyPanelExpand").removeClass("hide"),$(".propertyPanelCompress").removeClass("hide"))),$scope.isExpanded=!$scope.isExpanded},$scope.toggleMinMax=function(e){$scope.isMinimized?_flowTaskPropertyPanel.removeClass("minimized"):_flowTaskPropertyPanel.addClass("minimized"),$scope.isMinimized=!$scope.isMinimized},angular.element($window).on("resize",function(e){$.isWindow(e.target)&&$scope&&$scope.isPropertyPanelOpened&&setPropertyPanelWidth()}),$scope.showNodeOnUI=function(nodeObj){if("intent"!==nodeObj.type||!nodeObj.dialogId)return!0;var _flowtask=$scope.availableFlowTasks.filter(function(flowtask){return flowtask._id===nodeObj.dialogId});if(_flowtask.length>0){if("suspended"===_flowtask[0].state.toLowerCase()||"rejected"===_flowtask[0].state.toLowerCase())return!1;var _node=_flowtask[0].nodes.filter(function(obj){return obj.componentId===nodeObj._id});return _node[0]?!0:!1}return nodeObj.dialogRefId&&(_flowtask=$scope.availableFlowTasks.filter(function(flowtask){return flowtask.refId===nodeObj.dialogRefId}),_flowtask.length>0)?"suspended"===_flowtask[0].state.toLowerCase()||"rejected"===_flowtask[0].state.toLowerCase()?!1:!0:void 0},$scope.dialogSettingsCB.load=function(){getFlowTasks()},$scope.publishDialog=function(){$scope.publishInProgress=!0;var dialogId=$scope.selectedDialogId,payload={resources:[{namespace:"enterprise",resourceId:dialogId,namespaceIds:[],resourceType:"dialog"}],publishAllComponents:!0,versionComment:"Dialog Publish"};BTStreamsService.standardPublish($workflowService.selectedStream()._id,payload).then(function(res){res=res.data,$timeout(function(){BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,res[0].sbResourceId).then(function(res){if(res=res.data){NotificationService.notify("Dialog published successfully!","success");var _updatedDialogId=res._id;_updatedDialogId&&(previousState.selectedTaskId=_updatedDialogId,window.localStorage.setItem("previousState",JSON.stringify(previousState)),window.location.reload(),$scope.publishInProgress=!1)}},function(err){$scope.publishInProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},1e4)},function(err){$scope.publishInProgress=!1,NotificationService.notify("Unable to publish Dialog!","error")})};var getProcessApps=function(){BTFlowtaskService.getProcessApps($workflowService.selectedStream()._id).then(function(res){res&&res.data&&($scope.processApps=res.data)})};$scope.conversationBuilder||(fetchDialogBotConfigurations(),getFlowTasks(),getProcessApps()),$rootScope.$on("update node info",function(e,data){var currentNode=_.find($scope.flowtaskObj.nodes,function(node){return node.componentId===data._id});$scope.selectCurrentNode(currentNode.nodeId),$timeout(function(){$scope.dialogData("updateComponent",data),$scope.selectCurrentNode(currentNode.nodeId)},750)}),$scope.disableEnter=function(e){13===e.keyCode&&e.preventDefault(),setTimeout(function(){$(".exisiting-node-menu-item").scrollTop(0)},50)},$scope.searchDialogs=function(type){var searchQuery="";if($scope.noResults=!1,$scope.search&&(searchQuery=$scope.search.name),"form"===type){var searchRequest=[];searchRequest.push(BTFlowtaskService.getSearchComponentsByType(_selectedStream._id,type,"true",searchQuery)),searchRequest.push(BTFlowtaskService.getSearchComponentFormType(_selectedStream._id,type,searchQuery)),$q.all(searchRequest).then(function(res){_botComponents=[],_forms=[],res&&res.length>0?(res[0]&&res[0].data.length>0&&($.each(res[0].data,function(k,comp){"configured"===comp.status&&_botComponents.push(comp)}),$scope.nodeObjList=_botComponents),res[1]&&res[1].data.length>0&&($.each(res[1].data,function(k,comp){"configured"===comp.state&&_forms.push(comp)}),$scope.formTasks=_forms),(0===res[0].data.length||0===res[1].data.length)&&($scope.fromSearch=!0,$scope.nodeObjListLoading=!1,$scope.formTasks=0===res[1].data.length?[]:_forms,$scope.nodeObjList=0===res[0].data.length?[]:$scope.nodeObjList,0===res[0].data.length&&0===res[1].data.length&&($scope.noResults=!0)),updateDialogEntities(),$timeout(function(){updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings()},100)):$scope.nodeObjListLoading=!1},function(error){if(_botComponents=[],$scope.nodeObjListLoading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_fetching_components"),"error")})}else BTFlowtaskService.getSearchComponentsByType(_selectedStream._id,type,"true",searchQuery).then(function(res){_botComponents=[],res&&res.data&&res.data.length>0?($.each(res.data,function(k,comp){"configured"===comp.status&&_botComponents.push(comp)}),$scope.nodeObjList=_botComponents,"intent"===type&&($scope.botIntents=_botComponents),updateDialogEntities(),$timeout(function(){updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateEntityPatternsErrors(),updateEntityCompositePatternsErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings()},100)):($scope.nodeObjListLoading=!1,$scope.nodeObjList=0===res.data.length?[]:$scope.nodeObjList,0===res.data.length&&($scope.noResults=!0))},function(error){if(_botComponents=[],$scope.nodeObjListLoading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_fetching_components"),"error")})},$($element).on("hide.bs.dropdown",function(){_menuFocusedNode&&_menuFocusedNode.menuFocused&&(_menuFocusedNode.menuFocused=!1),deHighlightConnection(),$scope.selectedConnection=null,$scope.inBtwOptShown=!1}),$scope.$emit("nestedComponentLoaded",{id:"flowtaskForm",flag:!1}),$scope.initFormExperience=function(args){$scope.formExperienceChannels=channelsConfig.getSupportedChannels(),$scope.formExperience={},$scope.formExperience.type="onlyform",$scope.formExperience.step="typeSelection",$scope.formExperience.args=[this,args],$($element).find("#formExperience").modal()},$scope.doneformExpSelection=function(){var _self=$scope.formExperience.args[0],args=$scope.formExperience.args[1],event=args[0];"channelSelection"===$scope.formExperience.step?addFormNodeViaBatch():(event.formExperienceDone=!0,$scope.closeFormExpModal(),$scope[event.methodToInvoke].apply(_self,args))},$scope.closeFormExpModal=function(){$($element).find("#formExperience").modal("hide")},$scope.redirectToLink=function(linkType,e){e&&e.stopPropagation(),$rootScope.redirectToLink(linkType)},$scope.adjustpannelsInIframe=function(panel,action){if($scope.conversationBuilder){var dialogFrame=$("#dialogIFrame"),iframeContents=dialogFrame.contents();"chatWindow"===panel&&("maximize"===action?iframeContents&&iframeContents.find(".conversationContainer")&&!iframeContents.find(".conversationContainer").hasClass("chatWindowOpen")&&iframeContents.find(".conversationContainer").addClass("chatWindowOpen"):iframeContents&&iframeContents.find(".conversationContainer")&&iframeContents.find(".conversationContainer").hasClass("chatWindowOpen")&&iframeContents.find(".conversationContainer").removeClass("chatWindowOpen")),"debugLog"===panel&&("open"===action&&(iframeContents&&iframeContents.find(".conversationContainer")&&!iframeContents.find(".conversationContainer").hasClass("debugLogMax")&&iframeContents.find(".conversationContainer").addClass("debugLogMax"),iframeContents&&iframeContents.find(".conversationContainer")&&!iframeContents.find(".conversationContainer").hasClass("debugLogOpen")&&iframeContents.find(".conversationContainer").addClass("debugLogOpen")),"close"===action&&(iframeContents&&iframeContents.find(".conversationContainer")&&iframeContents.find(".conversationContainer").hasClass("debugLogMax")&&iframeContents.find(".conversationContainer").removeClass("debugLogMax"),iframeContents&&iframeContents.find(".conversationContainer")&&iframeContents.find(".conversationContainer").hasClass("debugLogOpen")&&iframeContents.find(".conversationContainer").removeClass("debugLogOpen")),"maximize"===action?iframeContents&&iframeContents.find(".conversationContainer")&&!iframeContents.find(".conversationContainer").hasClass("debugLogMax")&&iframeContents.find(".conversationContainer").addClass("debugLogMax"):iframeContents&&iframeContents.find(".conversationContainer")&&iframeContents.find(".conversationContainer").hasClass("debugLogMax")&&iframeContents.find(".conversationContainer").removeClass("debugLogMax"))}},$scope.debugLogCB.adjustpannelsInIframe=$scope.adjustpannelsInIframe,$scope.prepareSearchObjFromIframe=function(searchAray){$scope.objListSearch=searchAray},$scope.getErrorPromptsComponent=function(){var parms={action:"errorMessagePrompts",payload:errorMessages};$scope.sendEventToIframe(parms)},$scope.prop_panel_voice_channels_all_cb={},$workflowService.selectedStream().ivrSettings?(_selectedStream.ivrSettings=$workflowService.selectedStream().ivrSettings||$scope.ivrSettingsDefault.ivrSettings,$scope.isEnabled=$workflowService.selectedStream().ivrSettings.enable||$scope.ivrSettingsDefault.ivrSettings.enable):$workflowService.selectedStream().ivrSettings=$scope.ivrSettingsDefault,$scope.saveIvrStream=function(){$scope.callback.createIVRStream()},$scope.enableIvrsettings=function(){$scope.isEnabled||($scope.isEnabled=!0,$workflowService.selectedStream().ivrSettings.enable=!0,btPostData={ivrSettings:{asrConfidenceThreshold:$workflowService.selectedStream().ivrSettings.asrConfidenceThreshold||$scope.ivrSettingsDefault.ivrSettings.asrConfidenceThreshold,extraction_key:$workflowService.selectedStream().ivrSettings.extraction_key||$scope.ivrSettingsDefault.ivrSettings.extraction_key,enable:$scope.isEnabled||$scope.ivrSettingsDefault.ivrSettings.enable,timeout:parseInt(1e3*$workflowService.selectedStream().ivrSettings.timeout)||$scope.ivrSettingsDefault.ivrSettings.timeout,retry_limit:parseInt($workflowService.selectedStream().ivrSettings.retry_limit)||$scope.ivrSettingsDefault.ivrSettings.retry_limit,properties:$workflowService.selectedStream().ivrSettings.properties||$scope.ivrSettingsDefault.ivrSettings.properties,enable_log:$workflowService.selectedStream().ivrSettings.enable_log||$scope.ivrSettingsDefault.ivrSettings.enable_log,enable_transcript:$workflowService.selectedStream().ivrSettings.enable_transcript||$scope.ivrSettingsDefault.ivrSettings.enable_transcript,transcript_tag:$workflowService.selectedStream().ivrSettings.transcript_tag||$scope.ivrSettingsDefault.ivrSettings.transcript_tag,callTerminationHandler:$workflowService.selectedStream().ivrSettings.callTerminationHandler||$scope.ivrSettingsDefault.ivrSettings.callTerminationHandler,bargein:$workflowService.selectedStream().ivrSettings.bargein||$scope.ivrSettingsDefault.ivrSettings.bargein,grammars:$workflowService.selectedStream().ivrSettings.grammars||$scope.ivrSettingsDefault.ivrSettings.grammars}},$workflowService.selectedStream().ivrSettings&&$workflowService.selectedStream().ivrSettings.timeoutPrompts?btPostData.ivrSettings.timeoutPrompts=[[angular.extend({type:"text"},$workflowService.selectedStream().ivrSettings.timeoutPrompts[0][0])]]:btPostData.ivrSettings.timeoutPrompts=$scope.ivrSettingsDefault.ivrSettings.timeoutPrompts,$workflowService.selectedStream().ivrSettings&&$workflowService.selectedStream().ivrSettings.nomatchPrompts?btPostData.ivrSettings.nomatchPrompts=[[angular.extend({type:"text"},$workflowService.selectedStream().ivrSettings.nomatchPrompts[0][0])]]:btPostData.ivrSettings.nomatchPrompts=$scope.ivrSettingsDefault.ivrSettings.nomatchPrompts,updateIvrStreamData(btPostData),$scope.callback&&$scope.callback.enableIvr&&$scope.callback.enableIvr(),$("#ivrNode").modal("hide"))},$scope.closeBotLevelIvr=function(){$scope.modalSlider.close("#ivrBotLevel")},$scope.closeTwilioVoice=function(){$scope.modalSlider.close("#twilioVoiceSettings")},$scope.closeAudioCodes=function(){$scope.modalSlider.close("#audioCodesPropPanel")},$scope.bargeinToggle=function(enable){enable?$scope.twilioVoiceSettings.bargein=!1:$scope.twilioVoiceSettings.bargein=!0},$scope.prop_panel_voice_channels_all_cb.closeVoiceSlider=function(){$scope.isAllVoiceEnabled=!1},$scope.openVoiceSliders=function(payload){$scope.iframeNodeObj=payload.iframeNodeObj,$scope.ivrOptions=payload.ivrOptions,prepareIVRData($scope.ivrOptions),"botIvr"===payload.type?openBotLevelIVR():"twilioVoice"===payload.type?openChannelLevelTwilioVoice():"AudioCodes"===payload.type&&openAudioCodesVoiceProp()},$scope.voice_channels_node_cb={openBotLevelIVR:openBotLevelIVR,openChannelLevelTwilioVoice:openChannelLevelTwilioVoice,openAudioCodesVoiceProp:openAudioCodesVoiceProp},$scope.iframeEvent=function(e,data){if(data&&data.action)switch(data.action){case"dialogSearchList":data.payload&&$scope.prepareSearchObjFromIframe(data.payload);break;case"generateReport":data.payload&&$scope.propertyCb.editReport(data.payload);break;case"smartAlert":data.payload&&$scope.requestDefinition(data.payload);break;case"lookupSettingModal":data.payload&&$scope.lookupSettingModal(data.payload);break;case"createNewAuth":data.payload&&$scope.createNewAuthModal(data.payload);break;case"openSynonymsModal":data.payload&&$scope.addBotSynonyms(data.payload);break;case"manageStandardResponse":data.payload&&$scope.openManageResponseConv(data.payload.type);break;case"updateWarnings":data.payload&&$scope.updateWarnings(data.payload);break;case"getErrorMessages":$scope.getErrorPromptsComponent();break;case"openVoiceSliders":$scope.openVoiceSliders(data.payload);break;case"showBanner":$scope.showBanner()}},$scope.$on("dialogIframeEvent",$scope.iframeEvent),$scope.propertyCb.editReport=function(payload){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-dialog-reports/bt-dialog-reports.html",controller:"BTDialogReportsCtrl",backdrop:"static",windowClass:"bt-dialog-reports-modal modal-kr",resolve:{config:function(){return{component:payload.nodeInfo,dialogReportCB:$scope.dialogReportCB,editReport:payload&&payload.report?payload.report:null,displayMode:$scope.displayMode,dialogComponent:{nodeInfo:payload.component}}}}})},$scope.dialogReportCB.onDialogReportSave=function(component){var params={action:"generateReportSave",payload:component};$scope.sendEventToIframe(params)},$scope.requestDefinition=function(payload){return"smartalert"===payload.nodeInfo.nodeInfo.serviceNodeType?(payload.alerts&&payload.alerts.length&&$workflowService.alertTasks(payload.alerts),0===payload.alerts.length&&NotificationService.notify(i18n.i18nString("no_alerts"),"warning"),void(0!==payload.alerts.length&&""!==payload.requestServiceData?$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/smart-alerts/smart-alerts.html",controller:"smartAlertsCtrl",backdrop:"static",resolve:{config:function(){return{component:payload.nodeInfo,smartAlertService:payload.nodeInfo.nodeInfo.requestServiceData||payload.requestServiceData,smartalertCB:updateSmartalert,alertRefCB:updateAlertRef,notificationCB:updateNotification,saveSmartAlertSubscriptionComponentCB:saveSmartAlertSubscriptionComponent}}}}):0!==payload.alerts.length&&BTStreamsService.smartAlertSubscription(payload._id,payload.nodeInfo._id,payload.alerts).then(function(res){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/smart-alerts/smart-alerts.html",controller:"smartAlertsCtrl",backdrop:"static",resolve:{config:function(){return{component:payload.nodeInfo,smartAlertService:res.data,smartalertCB:updateSmartalert,alertRefCB:updateAlertRef,notificationCB:updateNotification,saveSmartAlertSubscriptionComponentCB:saveSmartAlertSubscriptionComponent}}}})},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")}))):void 0},$scope.lookupSettingModal=function(onLoad){},$scope.createNewAuthModal=function(payload){$scope.loadAuthForm=!0,$scope.authCB.showAuthFormModal&&$scope.authCB.showAuthFormModal()},$scope.sendEventToIframe=function(params){jsEvents.postMessageToChildIframes(params.action,"#dialogIFrame",params.payload)},$scope.redirectWorkbench=function(){window.open($rootScope.resolveWorkbenchHostUrl(),"_self")},$scope.closeManageTraining=function(){$scope.loadUtteranceModule=!1},$scope.openManageTraining=function(){$scope.loadUtteranceModule=!0;var _primaryIntent=$scope.primaryIntentOb;$workflowService.flowTaskDisplayMode($scope.displayMode),$timeout(function(){$scope.btUtteranceCb.loadingEntities(_selectedStream._id),$scope.btUtteranceCb.fetchIntents(_primaryIntent,$scope.displayMode)},700)},$rootScope.$on("invokeTraining",function(){$scope.loadUtteranceModule=!0,$timeout(function(){var _currentTrainStatus=$workflowService.currTrainStatus();void 0!==_currentTrainStatus&&_currentTrainStatus.saving||$scope.btUtteranceCb.trainBot("conversationBuilder")},2e3)});var updateTrainStatus=function(trainStatus){jsEvents.postMessageToChildIframes("trainStatus","#dialogIFrame",trainStatus)},updateTrainDataDetails=function(intentData){jsEvents.postMessageToChildIframes("trainingDataDetails","#dialogFrame",{streamId:_selectedStream._id,componentId:_dialogObj.nodes[0].componentId,utteranceCount:intentData.utteranceCount})},updateIntentData=function(trainData){$scope.propertyCb&&$scope.propertyCb.updateIntentData&&$scope.propertyCb.updateIntentData(trainData),$scope.currentIntent=trainData.intentData,$scope.currentIntent.updateTrainData=!0};$scope.btUtteranceCb.updateTrainStatus=updateTrainStatus,$scope.btUtteranceCb.updateTrainDataDetails=updateTrainDataDetails,$scope.btUtteranceCb.updateIntentData=updateIntentData,$scope.propertyCb.updateComponent=prepareComponents,$timeout(function(){$scope.initialLoading=!1})}]}})}(angular),function(ng){"use strict";function GeoLocator($geolocator,$rootScope){function link($scope,$element,$attrs){var userSearch=!1;$scope.locationSelected=!1,$scope.locations=[],$scope.locating=!0,$geolocator.getCurrentCoordinates().then(function(res){$geolocator.getLocation(res.location).then(function(res){$scope.locations=res.locations,$scope.locating=!1},function(err){$scope.locating=!1,$scope.locations=[],$scope.locationSelected=!1})}),$scope.toggleSuggestions=function(){$scope.field.location||userSearch?$scope.showSuggestions=!1:($scope.showSuggestions=!0,$scope.enableUserSearch=!0)},$scope.searchLocation=function(){$scope.field.location&&($scope.searching=!0,$geolocator.getLocation($scope.field.location).then(function(res){userSearch=!0,$scope.locations=res.locations,$scope.searching=!1,$scope.showSuggestions=!0,$scope.locationSelected=!1},function(err){$scope.searching=!1,$scope.locations=[]}))},$scope.pickLocation=function(index){$scope.field.location=$scope.locations[index].address,$scope.field.userInput={title:$scope.locations[index].address,value:$scope.locations[index].coords},$scope.locations=[],$scope.enableUserSearch=!1,$scope.locationSelected=!0,$('[name="'+$scope.field.key+'"]').val($scope.field.location),$('[name="'+$scope.field.key+'"]').change()},$scope.field&&$scope.field.userInput&&($scope.field.location=$scope.field.userInput)}return{restrict:"AE",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/geo-locator/geo-locator.html",link:link}}ng.module("bt-forms").directive("geoLocator",GeoLocator),GeoLocator.$inject=["$geolocator","$rootScope"]}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("intentEntity",[function(){return{restrict:"EA",scope:{streamId:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/intent-entity/intent-entity.html",controller:["$scope","form_util","BTStreamsService","$workflowService","BTActionsService","BTAlertsService","_constants_","NotificationService","$rootScope","accessControlService","i18n","env_conf",function($scope,form_util,BTStreamsService,$workflowService,BTActionsService,BTAlertsService,_constants_,NotificationService,$rootScope,accessControlService,i18n,env_conf){function getAlerts(id,state){$scope.loadingAlerts=!0,$scope.alertTasks=$workflowService.alertTasks(),$scope.alertTasksByState=[],$scope.alertTasks.map(function(task){var fields=[];task.state===state?(task.alertFieldsDefinition&&(task.alertFieldsDefinition.map(function(field){fields.push(field)}),task.fields=fields),$scope.alertTasksByState.push(task)):task.child&&task.child.length&&task.child[0].state==state&&(task.child[0].alertFieldsDefinition&&(task.child[0].alertFieldsDefinition.map(function(field){fields.push(field)}),task.child[0].fields=fields),$scope.alertTasksByState.push(task.child[0]))}),$scope.loadingAlerts=!1}function getActions(id,state){$scope.loadingActions=!0,$scope.actionTasks=$workflowService.actionTasks(),$scope.actionTasksByState=[],$scope.actionTasks.map(function(task){var fields=[];task.state===state?task.payloadField&&task.queryField&&(task.payloadField.map(function(field){fields.push(field)}),task.queryField.map(function(field){fields.push(field)}),task.fields=fields,$scope.actionTasksByState.push(task)):task.child&&task.child.length&&task.child[0].state==state&&(task.child[0].payloadField&&task.child[0].queryField&&(task.child[0].payloadField.map(function(field){fields.push(field)}),task.child[0].queryField.map(function(field){fields.push(field)}),task.fields=task.child[0]),$scope.actionTasksByState.push(task.child[0]))}),$scope.loadingActions=!1}function load(){var state=angular.copy($scope.selectedStreamState);"indevelopment"===state&&(state="configured"),getActions(streamId,state),getAlerts(streamId,state)}function hideIntentForm(){$scope.closeModalSlider("#intent-entity-form")}function hideFieldForm(){$scope.closeModalSlider("#intent-field-form")}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE");var streamId=$scope.streamId||$workflowService.selectedStream()._id;$scope.selectedStreamState=$workflowService.selectedStreamState(),$scope.alertTasks=[],$scope.actionTasks=[],$scope.alertTaskToShow=0,$scope.actionTaskToShow=0,$scope.currentPage=1,$scope._constants_=_constants_,$scope.stream=$workflowService.selectedStream(),$scope.field={},$scope.task={},$scope._constants_=$rootScope._constants_,$scope.alertSearch="",$scope.actionSearch="",$scope.ignoreWords=i18n.i18nString("ignore_word"),$scope.confirmOn=i18n.i18nString("confirmation_on"),$scope.confirmOff=i18n.i18nString("confirmation_off"),$scope.fields=i18n.i18nString("fields"),$scope.placeholder=i18n.i18nString("add_ignore_words"),$scope.forms={},$scope.rightClass="right700",$scope.editIcon=env_conf["context-url"]+"/assets/icons/pencilIcon.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.clearAlertSearch=function(){$scope.alertSearch=""},$scope.clearActionSearch=function(){$scope.actionSearch=""},load(),$scope.manageIntent=function(type,task,index){task.fields&&task.fields.length>0&&"alert"==type?$scope.alertTaskToShow=$scope.alertTaskToShow==index?-1:index:$scope.actionTaskToShow=$scope.actionTaskToShow==index?-1:index},$scope.showIntentForm=function(task,event){$scope.task=task,$scope.openModalSlider("#intent-entity-form"),event.preventDefault(),event.stopPropagation()},$scope.cancelEditIntent=function(){$scope.task={},hideIntentForm()};var currentFieldIndex=-1;$scope.showFieldForm=function(task,field,index,event){$scope.task=task,$scope.field={storevalue:field.timeToSave?!0:!1,title:field.title,metadata:field.metadata,timeToSave:field.timeToSave},currentFieldIndex=index,event.preventDefault(),event.stopPropagation(),$scope.openModalSlider("#intent-field-form")},$scope.cancelFieldForm=function(){currentFieldIndex=-1,$scope.field={},$scope.task={},hideFieldForm()},$scope.$watch("field.metadata",function(newVal,oldVal){newVal||(form_util.makeItClean($scope.forms.intent_entityFieldsForm),$scope.forms.intent_entityFieldsForm.__$invalid=!1)}),$scope.saveFieldInfo=function(){function callback(err){err?NotificationService.notify(i18n.i18nString("field_saving"),"error"):(NotificationService.notify(i18n.i18nString("fields_saved"),"success"),$scope.cancelFieldForm())}var id=$scope.task._id;"l"===id[0]?$scope.task.alertFieldsDefinition.map(function(field){field.title==$scope.field.title&&(field.metadata=$scope.field.metadata,field.timeToSave=$scope.field.storevalue?$scope.field.timeToSave:"")}):"a"===id[0]&&($scope.task.payloadField.map(function(field){field.title==$scope.field.title&&(field.metadata=$scope.field.metadata,field.timeToSave=$scope.field.storevalue?$scope.field.timeToSave:"")}),$scope.task.queryField.map(function(field){field.title==$scope.field.title&&(field.metadata=$scope.field.metadata,field.timeToSave=$scope.field.storevalue?$scope.field.timeToSave:"")})),$scope.saveEditIntent(callback)},$scope.saveEditIntent=function(callback){var payload,task=angular.copy($scope.task),id=task._id;"l"===id[0]?(payload={allowEdit:!0,alertFieldsDefinition:task.alertFieldsDefinition,offKoraConfirmation:task.offKoraConfirmation,ignoreWords:task.ignoreWords},BTAlertsService.createBTAlertUp(id,payload).then(function(res){callback?callback():(NotificationService.notify(i18n.i18nString("intent_saved"),"success"),hideIntentForm())},function(err){callback?callback(err):NotificationService.notify(i18n.i18nString("intent_saving"),"error")})):"a"===id[0]&&(payload={allowEdit:!0,payloadField:task.payloadField,queryField:task.queryField,offKoraConfirmation:task.offKoraConfirmation,ignoreWords:task.ignoreWords},BTActionsService.updateBTAction(id,payload).then(function(res){callback?callback():(NotificationService.notify(i18n.i18nString("intent_saved"),"success"),hideIntentForm())},function(err){callback?callback(err):NotificationService.notify(i18n.i18nString("intent_saving"),"error")}))},$scope.$emit("nestedComponentLoaded",{id:"ignoreWords",flag:!1})}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("introForm",function(){return{restrict:"EA",scope:{onComplete:"&",wfType:"@",displayMode:"@",configure:"&",hooks:"=?callbacks",resource:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/intro-form/intro-form.html",controller:["$scope","form_util","patternFactory","$timeout","$rootScope","$location","$filter","$routeParams","NotificationService","BTFileUploadService","BTAlertsService","BTActionsService","BTStreamsService","BTFlowtaskService","$workflowService","i18n","env_conf",function($scope,form_util,patternFactory,$timeout,$rootScope,$location,$filter,$routeParams,NotificationService,BTFileUploadService,BTAlertsService,BTActionsService,BTStreamsService,BTFlowtaskService,$workflowService,i18n,env_conf){function processUserInputs(obj){return obj.name&&(obj.name=obj.name.replace(/&lt;/g,"<").replace(/&gt;/g,">")),obj.shortDesc&&(obj.shortDesc=obj.shortDesc.replace(/&lt;/g,"<").replace(/&gt;/g,">")),obj.label&&(obj.label=obj.label.replace(/&lt;/g,"<").replace(/&gt;/g,">")),obj.description&&(obj.description=obj.description.replace(/&lt;/g,"<").replace(/&gt;/g,">")),obj}function intialize(){if($scope.saveInProgress=!1,finalObj={},resetFlag&&($scope.introObj={screenshots:[]},$scope.introObj.needsAuth="action"===$scope.wfType?!0:!1),"alert"===$scope.wfType){var alrtInfo=processUserInputs($workflowService.alertInfo());$scope.manageContext={preConditions:alrtInfo.preConditions||[],contextTags:alrtInfo.contextTags||[]};var mpAlertInfo=processUserInputs($workflowService.mpAlertInfo());angular.extend(finalObj,alrtInfo),angular.extend(finalObj,mpAlertInfo),$scope.alertid=finalObj._id,$scope.typeOftask="alert"}else if("action"===$scope.wfType){var actionInfo=processUserInputs($workflowService.actionInfo());$scope.manageContext={preConditions:actionInfo.preConditions||[],contextTags:actionInfo.contextTags||[]};var mpActionInfo=processUserInputs($workflowService.mpActionInfo());
angular.extend(finalObj,actionInfo),angular.extend(finalObj,mpActionInfo),$scope.actionid=finalObj._id,$scope.isReportTask=finalObj.isReport,$scope.typeOftask=finalObj.isReport?"reporttask":"action"}else if("flowTask"===$scope.wftype){var flowTaskInfo=processUserInputs($workflowService.flowtaskInfo());angular.extend(finalObj,flowTaskInfo),$scope.flowtaskId=finalObj._id}publishedEntity="published"===finalObj.state;var alertKeyMapping={name:"name",ignoreWords:"ignoreWords",shortDesc:"shortdescription",userAlertMsg:"userAlertMsg",teamAlertMsg:"teamAlertMsg",longDesc:"longdescription",needsTopic:"needsTopic",contents:"contents",keywords:"keywords",subtype:"subtype",screenShots:"screenshots",hasActions:"hasActions",helpLink:"helpLink",demoYoutubeLink:"demoYoutubeLink",offKoraConfirmation:"offKoraConfirmation",isAuthRequiredForWsdl:"isAuthRequiredForWsdl"},actionKeyMapping={name:"name",ignoreWords:"ignoreWords",shortDesc:"shortdescription",longDesc:"longdescription",contents:"contents",keywords:"keywords",subtype:"subtype",screenShots:"screenshots",helpLink:"helpLink",demoYoutubeLink:"demoYoutubeLink",mappedOnly:"mappedOnly",offKoraConfirmation:"offKoraConfirmation",isAuthRequiredForWsdl:"isAuthRequiredForWsdl",askOneOptionalField:"askOneOptionalField"},flowtaskKeyMapping={name:"name",shortDesc:"shortdescription",subtype:"subtype",helpLink:"helpLink",demoYoutubeLink:"demoYoutubeLink",offKoraConfirmation:"offKoraConfirmation",isAuthRequiredForWsdl:"isAuthRequiredForWsdl"};$scope.streamId=$workflowService.selectedStream()._id;var mappingObj={};if(Object.keys(finalObj).length>0){"alert"===$scope.wfType?mappingObj=alertKeyMapping:"action"===$scope.wfType?mappingObj=actionKeyMapping:"flowtask"===$scope.wfType&&(mappingObj=flowtaskKeyMapping);for(var key in mappingObj)mappingObj.hasOwnProperty(key)&&($scope.introObj[mappingObj[key]]=finalObj[key]);$scope.introObj.needsTopic=!1,$scope.introObj.screenshots=_.compact($scope.introObj.screenshots);for(var screenIndex=0;screenIndex<$scope.introObj.screenshots.length;screenIndex++){var link=$scope.introObj.screenshots[screenIndex];$scope.introObj.screenshots[screenIndex]={fileName:"screenshot "+screenIndex,fileId:link.fileId,link:link.signedUrl}}$scope.introObj.type=$filter("filter")($scope.alerttypes,{value:finalObj.type})[0],$scope.introObj.subtype=$scope.introObj.subtype?$scope.introObj.subtype:"rest",$timeout(function(){$scope.introForm&&$scope.introForm.$setPristine(!0)})}}function createMPAlert(mpalert,create){var mpAlertObj;mpAlertObj=$workflowService.alertInfo(),mpalert._id=$scope.alertid,mpalert.namespace="private",mpalert.namespaceIds=[],mpalert.userAlertMsg=$scope.introObj.userAlertMsg,mpalert.teamAlertMsg=$scope.introObj.teamAlertMsg,mpalert.screenShots=$scope.introObj.screenshots.map(function(ss){return ss.fileId||ss.link}),"string"==typeof $scope.introObj.keywords?mpalert.keywords=$scope.introObj.keywords.split(","):"object"==typeof $scope.introObj.keywords&&$scope.introObj.keywords.length>0?mpalert.keywords=$scope.introObj.keywords:mpalert.keywords=[],mpalert.contents=$scope.introObj.contents,$workflowService.alertData(mpalert),"edit"!==$scope.displayMode&&!$scope.alertid||create?BTAlertsService.createMPAlert(mpalert).then(function(res){$scope.saveInProgress=!1,$workflowService.mpAlertInfo(res.data),notifyActionStatus(),intialize(),$scope.afterSave(),$rootScope.$emit("insertOrUpdateTask","alert",$workflowService.alertInfo(),!0)},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_create_alert"),"error"),BTAlertsService.deleteBTAlert($scope.alertid),$scope.alertid=null}):BTAlertsService.updateMPAlert($scope.alertid||finalObj._id,mpalert).then(function(res){$scope.saveInProgress=!1,$workflowService.mpAlertInfo(res.data),notifyActionStatus(),intialize(),$scope.afterSave(),$rootScope.$emit("insertOrUpdateTask","alert",$workflowService.alertInfo(),!1)},function(res){$scope.saveInProgress=!1,$rootScope.saveAndExit=!1,NotificationService.notify(i18n.i18nString("failed_alert"),"error")})}function createBTAlert(){if(!$scope.saveInProgress){_alert={name:$scope.introObj.name,label:$scope.introObj.name,shortDesc:$scope.introObj.shortdescription,ignoreWords:$scope.introObj.ignoreWords,longDesc:$scope.introObj.longdescription,welcomeMsg:$scope.introObj.welcomemsg,type:$scope.introObj.type.value,streamId:_selectedStream._id,sourceStream:_selectedStream.name,needsTopic:!1,subtype:$scope.introObj.subtype||"rest",hasActions:$scope.introObj.hasActions,helpLink:$scope.introObj.helpLink,demoYoutubeLink:$scope.introObj.demoYoutubeLink,offKoraConfirmation:$scope.introObj.offKoraConfirmation,isAuthRequiredForWsdl:$scope.introObj.isAuthRequiredForWsdl,contextTags:$scope.manageContext.contextTags,preConditions:$scope.manageContext.preConditions};var errors=angular.copy($scope.introObj.errorCodes);errors&&errors instanceof Array&&(errors=errors.map(function(obj){return delete obj.insert,obj})),errors=_.union(errors,$scope.introObj.pollError),errors=_.uniq(errors,function(error){return+error.statusCode}),_alert.errorCodes={pollError:errors},_alert=_.addProps(publishedEntity,_alert,{allowEdit:!0}),$scope.saveInProgress=!0,"edit"===$scope.displayMode||$scope.alertid?BTAlertsService.createBTAlertUp($scope.alertid||finalObj._id,_alert).then(function(res){$scope.alertid=res.data._id,$workflowService.alertInfo(res.data),$scope.$emit("resourceUpdate"),createMPAlert(_alert,!1)},function(res){$scope.saveInProgress=!1,$rootScope.saveAndExit=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_alert"),"error")}):BTAlertsService.createBTAlert(_alert).then(function(res){$scope.alertid=res.data._id,$workflowService.alertInfo(res.data),createMPAlert(_alert,!0)},function(res){$scope.saveInProgress=!1,$rootScope.saveAndExit=!1,$scope.alertid=null,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_create_alert"),"error")})}}function createMPAction(_action,create){_action.targetStream=_selectedStream.name,_action.contents=$scope.introObj.contents,_action.mappedOnly=$scope.introObj.mappedOnly,"string"==typeof $scope.introObj.keywords?_action.keywords=$scope.introObj.keywords.split(","):"object"==typeof $scope.introObj.keywords&&$scope.introObj.keywords.length>0?_action.keywords=$scope.introObj.keywords:_action.keywords=[],_action.screenShots=$scope.introObj.screenshots.map(function(ss){return ss.fileId||ss.link}),_action.namespace="private",_action.namespaceIds=[],_action._id=$scope.actionid,"edit"!==$scope.displayMode&&!$scope.actionid||create?BTActionsService.createMPAction(_action).then(function(res){$scope.saveInProgress=!1,$workflowService.mpActionInfo(res.data),notifyActionStatus(),intialize(),$scope.afterSave(),$rootScope.$emit("insertOrUpdateTask","action",$workflowService.actionInfo(),!0)},function(res){$scope.saveInProgress=!1,$rootScope.saveAndExit=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(finalObj.isReport?i18n.i18nString("failed_create_info"):i18n.i18nString("failed_create_action"),"error"),BTActionsService.deleteBTAction($scope.actionid),$scope.actionid=null}):BTActionsService.updateMPAction($scope.actionid||finalObj._id,_action).then(function(res){$scope.saveInProgress=!1,$workflowService.mpActionInfo(res.data),notifyActionStatus(),intialize(),$scope.afterSave(),$rootScope.$emit("insertOrUpdateTask","action",$workflowService.actionInfo(),!1)},function(res){$scope.saveInProgress=!1,$rootScope.saveAndExit=!1,NotificationService.notify(finalObj.isReport?i18n.i18nString("failed_info"):i18n.i18nString("failed_action"),"error")})}function createBTAction(){var _actionIntro={name:$scope.introObj.name,ignoreWords:$scope.introObj.ignoreWords,shortDesc:$scope.introObj.shortdescription,longDesc:$scope.introObj.longdescription,welcomeMsg:$scope.introObj.welcomemsg,type:$scope.introObj.type.value,subtype:$scope.introObj.subtype||"rest",streamId:_selectedStream._id,targetStream:_selectedStream.name,helpLink:$scope.introObj.helpLink,demoYoutubeLink:$scope.introObj.demoYoutubeLink,offKoraConfirmation:$scope.introObj.offKoraConfirmation,isAuthRequiredForWsdl:$scope.introObj.isAuthRequiredForWsdl,askOneOptionalField:$scope.introObj.askOneOptionalField,contextTags:$scope.manageContext.contextTags,preConditions:$scope.manageContext.preConditions},errors=angular.copy($scope.introObj.errorCodes);errors&&errors instanceof Array&&(errors=errors.map(function(obj){return delete obj.insert,obj})),errors=_.union(errors,$scope.introObj.pollError),errors=_.uniq(errors,function(error){return+error.statusCode}),_actionIntro.errorCodes={pollError:errors},_actionIntro=_.addProps(publishedEntity,_actionIntro,{allowEdit:!0}),$scope.saveInProgress||($scope.saveInProgress=!0,"edit"===$scope.displayMode||$scope.actionid?BTActionsService.updateBTAction($scope.actionid||finalObj._id,_actionIntro).then(function(res){$workflowService.actionInfo(res.data),$scope.$emit("resourceUpdate"),$scope.actionid=res.data._id,createMPAction(_actionIntro,!1)},function(res){$scope.saveInProgress=!1,$rootScope.saveAndExit=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(finalObj.isReport?i18n.i18nString("failed_info"):i18n.i18nString("failed_action"),"error")}):BTActionsService.createBTAction(_actionIntro).then(function(res){$workflowService.actionInfo(res.data),$scope.actionid=res.data._id,createMPAction(_actionIntro,!0)},function(res){$scope.saveInProgress=!1,$rootScope.saveAndExit=!1,$scope.actionid=null,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(finalObj.isReport?i18n.i18nString("failed_create_info"):i18n.i18nString("failed_create_action"),"error")}))}function createFlowTask(){if(!$scope.saveInProgress){_flowTask={label:$scope.introObj.name,shortDesc:$scope.introObj.shortdescription};var errors=angular.copy($scope.introObj.errorCodes);return errors&&errors instanceof Array&&(errors=errors.map(function(obj){return delete obj.insert,obj})),_flowTask=_.addProps(publishedEntity,_flowTask,{allowEdit:!0}),$scope.saveInProgress=!0,"edit"===$scope.displayMode,void 0}}function notifyActionStatus(){$scope.onComplete({wftype:$scope.wfType,authRequired:$scope.introObj.needsAuth}),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo)}function notifyChange(){$scope.selectedStream=$workflowService.selectedStream(),$scope.selectedStream.synonyms=_.cloneDeep($scope.selectedStream.synonyms),($scope.keywordHighlighterApi&&$scope.keywordHighlighterApi.highlight||angular.noop)($workflowService.selectedStream().synonyms)}var _alert,_flowTask,_selectedStream="";_selectedStream=$workflowService.selectedStream(),$scope.chevronRightDark=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-right-dark.svg",$scope._constants_=$rootScope._constants_,$scope.scrollToDiv=$rootScope.scrollToDiv,$scope.selectedStream=_selectedStream,$scope.tmpltPrePath=$scope.$root.tmpltPrePath;$workflowService.currentLanguage();if($scope.previousCondition=$workflowService.alertData().type,$scope.charremaining=i18n.i18nString("Generalform_charlimit"),$scope.infoRequired=i18n.i18nString("info_required"),$scope.actionRequired=i18n.i18nString("action_required"),$scope.alertRequired=i18n.i18nString("alert_required"),$scope.infoAllows=i18n.i18nString("info_allows"),$scope.actionAllows=i18n.i18nString("action_allows"),$scope.alertAllows=i18n.i18nString("alert_allows"),$scope.infoNObot=i18n.i18nString("info_Nobot"),$scope.actionNObot=i18n.i18nString("action_Nobot"),$scope.alertNObot=i18n.i18nString("alert_Nobot"),$scope.displayinfoName=i18n.i18nString("info_DisplayName"),$scope.displayactionName=i18n.i18nString("action_DisplayName"),$scope.displayalertName=i18n.i18nString("alert_DisplayName"),$scope.connInfoName=i18n.i18nString("info_connName"),$scope.connActionName=i18n.i18nString("action_connName"),$scope.connAlertName=i18n.i18nString("alert_connName"),$scope.subtypeInfoName=i18n.i18nString("info_subtype"),$scope.subtypeActionName=i18n.i18nString("action_subtype"),$scope.subtypeAlertName=i18n.i18nString("alert_subtype"),$scope.infoContext=i18n.i18nString("info_context"),$scope.actionContext=i18n.i18nString("action_context"),$scope.alertContext=i18n.i18nString("alert_context"),$scope.infoDesc=i18n.i18nString("info_Desc"),$scope.actionDesc=i18n.i18nString("action_Desc"),$scope.alertDesc=i18n.i18nString("alert_Desc"),$scope.dialogLong=i18n.i18nString("dialog_long"),$scope.actionLong=i18n.i18nString("action_Long"),$scope.alertLong=i18n.i18nString("alert_Long"),$scope.actioncheck=i18n.i18nString("check_action"),$scope.infoCheck=i18n.i18nString("check_info"),$scope.mappedInfo=i18n.i18nString("mapped_info"),$scope.mappedAction=i18n.i18nString("mapped_action"),$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.infoHelp=i18n.i18nString("help_info"),$scope.actionHelp=i18n.i18nString("help_action"),$scope.alertHelp=i18n.i18nString("help_alert"),$scope.infoAdd=i18n.i18nString("add_info"),$scope.actionAdd=i18n.i18nString("add_action"),$scope.alertAdd=i18n.i18nString("add_alert"),$scope.infoName=i18n.i18nString("info_Name"),$scope.actionName=i18n.i18nString("action_Name"),$scope.alertName=i18n.i18nString("alert_Name"),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.demolinkDescription=$rootScope.getSanitizedText($rootScope.lableData.bb506),$scope.searchKeyWordsDescription=$rootScope.getSanitizedText($rootScope.lableData.bb508),$scope.introObj={screenshot:{},screenshots:[]},$scope.manageContext={preConditions:[],contextTags:[]},$scope.keywordHighlighterApi={},$scope.hooks=$scope.hooks||{},$scope.afterSave=angular.noop,$scope.isReportTask=!1,$scope.typeOftask=$scope.wfType,"alert"===$scope.wfType){$scope.alerttypes=$workflowService.seedData().alertTypes||[];for(var i=0;i<$scope.alerttypes.length;i++)if("email"===$scope.alerttypes[i].value){$scope.alerttypes.splice(i,1);break}}else"action"===$scope.wfType?($scope.alerttypes=[{name:i18n.i18nString("web_Service"),value:"webservice"}],$scope.introObj.type=$scope.alerttypes[0]):"flowTask"===$scope.wfType&&($scope.alerttypes=[{name:i18n.i18nString("flow_task"),value:"flowtask"}],$scope.introObj.type="flowTask");$scope.subtypes=$workflowService.seedData().webserviceTypes,$scope.introObj.needsAuth="action"===$scope.wfType?!0:!1,$scope.introObj.offKoraConfirmation=$workflowService.selectedStream().offKoraConfirmation,$scope.introObj.askOneOptionalField=$workflowService.selectedStream().askOneOptionalField;var finalObj,resetFlag,publishedEntity;intialize(),$scope.showadvancedoptions=!1,"flowtask"!==$scope.wfType&&($scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$scope.showAdvancedOptions=function(){$scope.showadvancedoptions?($scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$("#advancedoptdivMain .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showadvancedoptions=!0,$scope.advancedoptiontext=i18n.i18nString("hide_advanced_options_label"),$("#advancedoptdivMain .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"))}),$scope.$watch("introObj.name",function(newVal,oldValue){_selectedStream.defaultLanguage&&"en"!==_selectedStream.defaultLanguage}),$scope.isSuspendedTask=function(){return finalObj&&"suspended"===finalObj.state},$scope.onCancel=function(event){event&&event.preventDefault&&event.preventDefault(),resetFlag=!0,intialize(),resetFlag=!1,resetFlag&&($scope.saveInProgress=!1,$scope.onComplete()),$scope.$parent.onCancel()},$scope.formReset=function(){$scope.introObj={screenshot:{},screenshots:[]},$scope.introObj.type={},$scope.introForm.$setPristine(),$scope.saveInProgress=!1},$scope.uploadScreenshot=function(){if($scope.introObj.screenshotFile.name){var _ext=$scope.introObj.screenshotFile.name.substring($scope.introObj.screenshotFile.name.lastIndexOf("."));if(".png"!==_ext)return void $timeout(function(){$scope.screenshotFileExtensionError=!0})}$scope.screenshotFileExtensionError=!1;var data=new FormData;data.append("file",$scope.introObj.screenshotFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.screenshotUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.introObj.screenshotFile.name,fileId:response.data.fileId};$scope.introObj.screenshots.push(fileUploaded),NotificationService.notify(i18n.i18nString("file_Uploaded",{dyn:fileUploaded.fileName}),"success"),$scope.screenshotUploading=!1,$scope.introObj.screenshotFile=null},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.screenshotUploading=!1,$scope.introObj.screenshotFile=null})},$scope.deleteScreenshot=function($index){var ss=$scope.introObj.screenshots[$index],ssIndx=$scope.introObj.screenshots.indexOf(ss);$scope.introObj.screenshots.splice(ssIndx,1)},$scope.saveIntro=function(isValid,form){return isValid?(_selectedStream=$workflowService.selectedStream(),$scope.introObj.needsAuth="webservice"===$scope.introObj.type.value?!0:$scope.introObj.needsAuth,void("alert"===$scope.wfType?createBTAlert():"action"===$scope.wfType?createBTAction():"flowTask"===$scope.wfType&&createFlowTask())):void form_util.touch(form)},$scope.setAlertspathValue=function(){"action"!==$scope.wfType&&"rss"!==$scope.introObj.type.value&&($scope.introObj.hasActions=!0)},$scope.getEntityStatus=function(){return publishedEntity},$scope.callbacks={onSave:notifyChange,onCancel:notifyChange,onOpenModal:notifyChange,onCloseModal:notifyChange},$scope.underline=function(){notifyChange()},$timeout(function(){notifyChange()}),$scope.$on("evt:nextActintro",function(evt,data){$scope.moveTo=data,!$scope.displayMode||$scope.displayMode&&"edit"===$scope.displayMode?$scope.introForm.$valid?$scope.saveIntro($scope.introForm.$valid,$scope.introForm):(NotificationService.notify(i18n.i18nString("enter_valid_Data"),"error"),$rootScope.saveAndExit=!1):$location.path(window.appConfig.CONTEXT_PATH+"/workflows")});var rss_webservice_stages={basic:{prev:"start",curr:"basic",next:"auth",no:1},auth:{prev:"basic",curr:"auth",next:"requestObj",no:2},requestObj:{prev:"auth",curr:"requestObj",next:"responseObj",no:3},responseObj:{prev:"requestObj",curr:"responseObj",next:"errorMsgs",no:4},errorMsgs:{prev:"responseObj",curr:"errorMsgs",next:"settings",no:5},settings:{prev:"errorMsgs",curr:"settings",next:"finishForm",no:6},finishForm:{prev:"settings",curr:"finishForm",next:"end",no:7}},action_stages={basic:{prev:"start",curr:"basic",next:"auth",no:1},auth:{prev:"basic",curr:"auth",next:"requestObj",no:2},requestObj:{prev:"auth",curr:"requestObj",next:"responseObj",no:3},responseObj:{prev:"requestObj",curr:"responseObj",next:"errorMsgs",no:4},errorMsgs:{prev:"responseObj",curr:"errorMsgs",next:"finishForm",no:5},finishForm:{prev:"errorMsgs",curr:"finishForm",next:"end",no:6}},webhook_stages={basic:{prev:"start",curr:"basic",next:"requestObj",no:1},requestObj:{prev:"basic",curr:"requestObj",next:"responseObj",no:2},responseObj:{prev:"requestObj",curr:"responseObj",next:"errorMsgs",no:3},finishForm:{prev:"errorMsgs",curr:"finishForm",next:"end",no:5}};"alert"===$scope.wfType?$scope.stages={webhook:webhook_stages,rss:rss_webservice_stages,webservice:rss_webservice_stages}:"action"===$scope.wfType&&($scope.stages={webservice:action_stages}),$scope.isThisSectionRequired=function(section){if("basic"===section)return!0;var type="alert"===$scope.wfType?$scope.introObj.type&&$scope.introObj.type.value:"webservice";return $scope.stages&&$scope.stages[type]&&$scope.stages[type][section]},$scope.hooks.isChanged=function(){return $scope.introForm&&$scope.introForm.$dirty},$scope.hooks.triggerSave=function(callback){$scope.afterSave=callback,$scope.saveIntro($scope.introForm.$valid,$scope.introForm)},window.onbeforeunload=function(event){return $scope.introForm&&$scope.introForm.$dirty?i18n.i18nString("auth_form_alert"):void 0},$scope.$on("$locationChangeStart",function(event,next,current){function successCb(){$scope.saveIntro($scope.introForm.$valid,$scope.introForm)}function failCb(){$scope.introForm.$dirty=!1,$location.path(next)}$scope.introForm.$dirty&&"view"!==$scope.displayMode&&(event.preventDefault(),$scope.afterSave=failCb,NotificationService.confirm({msg:i18n.i18nString("before_proceeding"),successCb:successCb,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("save"),fail:i18n.i18nString("discard_label")}}))}),$scope.invalidWordCount=!1,$scope.checkTaskWordCount=function(){return $scope.introObj.name?void($scope.introObj.name.split(" ").length<2||$scope.introObj.name.split(" ").length>5?($scope.invalidWordCount=!0,$scope.introForm.name.$valid=!1):($scope.invalidWordCount=!1,$scope.introForm.name.$valid=$scope.introForm.name.$valid||!0)):void($scope.invalidWordCount=!1)},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onFinishSetup=function(type){$scope.configure({type:type})},$scope.botNameMatched=!1,$scope.validateTaskName=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression();return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,$scope.getEntityStatus()&&(regexp=/^[a-zA-Z0-9][a-zA-Z0-9_<>*. ]+$/),{test:function(value){var regexBotname=new RegExp($workflowService.selectedStream().name,"i");return(value.match(regexBotname)||[]).length?($scope.botNameMatched=!0,!1):($scope.botNameMatched=!1,value&&1===value.length?regexp2.test(value):regexp.test(value))}}}(),$scope.validateYoutubeURL=function(){return{test:function(uri){var p=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return uri.match(p)?!0:!1}}}()}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.controller("joinAccountsCtrl",["$scope","$applicationService","AuthService","security","$rootScope","env_conf","mixPanel","_constants_","i18n",function($scope,$applicationService,AuthService,security,$rootScope,env_conf,mixPanel,_constants_,i18n){$scope.constants=_constants_;var appControls=$applicationService.userInfo().appControls;$scope.requestedAccounts={},$scope.requestingAccountJoining={},appControls&&appControls.requestedAccounts&&appControls.requestedAccounts.length&&$.each(appControls.requestedAccounts,function(i,val){$scope.requestedAccounts[val.acctId]={}}),appControls||(window.location=window.appConfig.CONTEXT_PATH),$scope.accountlimit=6,$scope.showAccountsCount=$scope.accountlimit,$rootScope.showLoginLoader=!1,$scope.userInfo=appControls.userInfo,$scope.loading=!0,AuthService.getAllowedAccountsToJoin().then(function(res){var userInfo={$email:$applicationService.userInfo().emailPhone,FirstName:$applicationService.userInfo().firstName,LastName:$applicationService.userInfo().lastName,Category:"Onboarding","Sub Category":"Join Account"};if(mixPanel.postEvent("User Onboarding - Join Accounts",userInfo),res&&res.data){var data=res.data;data&&data.length&&$.each(data,function(i,acc){!$scope.domain&&acc.allowedDomains&&acc.allowedDomains.length&&($scope.domain=acc.allowedDomains[0]),acc.color=$scope.constants.randomColors[i]||"";var acountName=[acc.accountName];acc.displayName?acountName=acc.displayName.split(" "):console.log("Account name missing"),acountName&&acountName.length&&$.each(acountName,function(j,name){2>j&&(acc.initials=(acc.initials||"")+name.charAt(0))})}),data.length?($scope.availableAccounts=data,$scope.selectAccountType=!0,$scope.loading=!1):($scope.selectAccount=!0,$scope.createOwnAccount())}},function(err){$scope.loading=!1,console.error("Kore: Error getting AllowedAccountsToJoin"+err)}),$scope.goToSelectAccount=function(){$scope.selectAccountType=!1,$scope.selectAccount=!0},$scope.arrowAngle=env_conf["context-url"]+"/assets/icons/arrowAngle.svg",$scope.pendingAccount=env_conf["context-url"]+"/assets/login/pendingAccount.jpg",$scope.community=env_conf["context-url"]+"/assets/login/community.svg",$scope.documents=env_conf["context-url"]+"/assets/login/documents.svg",$scope.organization=env_conf["context-url"]+"/assets/login/organization.svg",$scope.userAvatar=env_conf["context-url"]+"/img/user-gray.svg",$scope.goToSelectAccountType=function(){$scope.selectAccountType=!0,$scope.selectAccount=!1},$scope.initToolTipts=function(){setTimeout(function(){$('[data-toggle="popover"]').popover({trigger:"hover"})},300)},$scope.showMore=function(){$scope.showAccountsCount=$scope.availableAccounts.length},$scope.searchAccounts="",$scope.createOwnAccount=function(){AuthService.requestToJoinAccounts("selfAccount",[{acctId:appControls.accountId}]).then(function(data){var userInfo={$email:$applicationService.userInfo().emailPhone,FirstName:$applicationService.userInfo().firstName,LastName:$applicationService.userInfo().lastName,Category:"Onboarding","Sub Category":"Join Account"};mixPanel.postEvent("User Onboarding - Requested and Get Started",userInfo),window.location=window.appConfig.CONTEXT_PATH,$scope.loading=!1},function(err){err&&err.data&&err.data.errors&&err.data.errors.length&&NotificationService.notify(err.data.errors[0].msg,"error"),$scope.loading=!1})},$scope.selectAvailableAccount=function(account){account.selected=!account.selected},$scope.closeFlow=function(account){security.logout()},$scope.openLinks=function(type,$event){"community"===type?$rootScope.redirectToLink("https://community.kore.ai/",$event,!0):"koreAcademy"===type?$rootScope.redirectToLink("https://info.kore.ai/online-training-schedule",$event,!0):"documents"===type&&$rootScope.redirectToLink("https://developer.kore.ai/docs/bots/chatbot-overview/koreai-platform/",$event,!0)},$scope.updateAppControlList=function(){AuthService.getAppControlList($applicationService.userInfo().userId).then(function(res){var data=res.data;data&&data.associatedAccounts.length?window.location=window.appConfig.CONTEXT_PATH:(NotificationService.notify("","error"),$scope.selectAccount=!1)},function(err){console.error("Kore: Error fetching AppControlList"+err)})},$scope.requestJoinAccount=function(account){var _selectedAcconts=[{acctId:account._id}];$scope.requestingAccountJoining[account._id]={},AuthService.requestToJoinAccounts("joinAccount",_selectedAcconts).then(function(data){var userInfo={$email:$applicationService.userInfo().emailPhone,FirstName:$applicationService.userInfo().firstName,LastName:$applicationService.userInfo().lastName,Category:"Onboarding","Sub Category":"Join Account"};mixPanel.postEvent("User Onboarding - Request to Join",userInfo),$scope.requestedAccounts[account._id]={},setTimeout(function(){delete $scope.requestingAccountJoining[account._id]},100),account.autoApprovingUserReqs?NotificationService.notify(i18n.i18nString("account_joined_successfully",{displayName:account.displayName||account.accountName}),"success"):NotificationService.notify(i18n.i18nString("submited_request_toast"),"success")},function(err){delete $scope.requestingAccountJoining[account._id],err&&err.data&&err.data.errors&&err.data.errors.length&&NotificationService.notify(err.data.errors[0].msg,"error")})}}])}(angular),function(ng){angular.module("bt-forms").directive("keyValueForm",["$workflowService",function($workflowService){return{restrict:"EA",scope:{form:"=",options:"=",payloadType:"@?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/key-value-form/key-value-form.html",controller:["$scope","form_util",function($scope,form_util){function saveToOptions(values){$scope.options={},(values||[]).map(function(value){$scope.options[value.title]=value.value})}var editIndex="no-value";$scope.item={},"isobject"==$scope.payloadType?($scope.options=$scope.options||{},$scope.values=[],Object.keys($scope.options).map(function(key){$scope.values.push({title:key,value:$scope.options[key]})}),$scope.save=function(isValid,form){return isValid?("no-value"===editIndex?$scope.values.push($scope.item):$scope.values.splice(editIndex,1,$scope.item),saveToOptions($scope.values),form_util.makeItClean(form),void $scope.cancel()):void form_util.touch(form)},$scope.editItem=function(index){editIndex=index,$scope.item=angular.copy($scope.values[index]),$scope.showForm=!0},$scope.deleteItem=function(index){$scope.values.splice(index,1),saveToOptions($scope.values)},$scope.cancel=function(){$scope.item={},editIndex="no-value",$scope.showForm=!1},$scope.enableCreate=function(){editIndex="no-value",$scope.showForm=!0},$scope.form.save=function(){$scope.showForm&&$scope.save($scope.keyvalueform&&$scope.keyvalueform.$valid,$scope.keyvalueform)}):$scope.payloadType?($scope.options=$scope.options||[],$scope.save=function(isValid,form){return isValid?("no-value"===editIndex?$scope.options.push($scope.item):$scope.options.splice(editIndex,1,$scope.item),form_util.makeItClean(form),void $scope.cancel()):void form_util.touch(form)},$scope.editItem=function(index){editIndex=index,$scope.item=angular.copy($scope.options[index]),$scope.showForm=!0},$scope.deleteItem=function(index){$scope.options.splice(index,1)},$scope.cancel=function(){$scope.item={},editIndex="no-value",$scope.showForm=!1},$scope.enableCreate=function(){editIndex="no-value",$scope.showForm=!0},$scope.form.save=function(){$scope.showForm&&$scope.save($scope.keyvalueform&&$scope.keyvalueform.$valid,$scope.keyvalueform)}):($scope.metavalues={},$scope.options=$scope.options||{},$scope.temp=$workflowService.seedData().fileUploadMeta,$scope.temp.map(function(item){$scope.metavalues[item.value]=item.key}),delete $scope.temp,$scope.save=function(isValid,form){return isValid?($scope.options[$scope.item.title]=$scope.item.value,form_util.makeItClean(form),void $scope.cancel()):void form_util.touch(form)},$scope.editItem=function(key){$scope.item.title=key,$scope.item.value=$scope.options[key],$scope.showForm=!0,$scope.isEditItem=!0},$scope.deleteItem=function(key){delete $scope.options[key]},$scope.cancel=function(){$scope.item={},$scope.showForm=!1},$scope.enableCreate=function(){$scope.showForm=!0,$scope.isEditItem=!1},$scope.form.save=function(){$scope.showForm&&$scope.save($scope.keyvalueform&&$scope.keyvalueform.$valid,$scope.keyvalueform)},$scope.showTable=function(){return Object.keys($scope.options).length>0&&!$scope.payloadType}),$scope.$on("onCancelFeildForm",function(){$scope.showForm=!1})}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){var _kgOntoNewForm=angular.module("bt-forms");_kgOntoNewForm.directive("kgExtractionOntoNew",function(){return{restrict:"EA",scope:{callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/kg-extraction-onto-new/kg-extraction-onto-new.html",controller:"kgExtractOntoCtrl"}}),_kgOntoNewForm.controller("kgExtractOntoCtrl",["$scope","$rootScope","$q","TimerNotification","patternFactory","env_conf","$interval","form_util","NotificationService","$timeout","BTStreamsService","$workflowService","botOntologyService","$applicationService","$filter","uuid","$element","_constants_","i18n",function($scope,$rootScope,$q,TimerNotification,patternFactory,env_conf,$interval,form_util,NotificationService,$timeout,BTStreamsService,$workflowService,botOntologyService,$applicationService,$filter,uuid,$element,_constants_,i18n){function initDragDropFile(){!function(window){function triggerCallback(e,callback){if(callback&&"function"==typeof callback){var files;e.dataTransfer?files=e.dataTransfer.files:e.target&&(files=e.target.files),callback.call(null,files);
}}function makeDroppable(ele,callback){if(!(ele.find('[type="file"]').length>0)){var input=document.createElement("input");input.setAttribute("type","file"),input.setAttribute("multiple",!0),input.style.display="none",input.id="fileInputID",input.addEventListener("change",function(e){triggerCallback(e,callback)}),ele=ele[0],ele.appendChild(input),ele.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.add("dragover")}),ele.addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover")}),ele.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover"),triggerCallback(e,callback)}),$("#kgExtractOntoNewBrowse").on("click",function(){input.value=null,input.click()})}}window.makeDroppable=makeDroppable}(window),function(window){window.makeDroppable($(".fileDropContainerKGOnto"),function(files){console.log(files),$scope.uploadCSVFile(files[0])})}(window)}function bulkDeleteFaqQnA(){var payload={qsIds:[]};payload.qsIds=getSelectedQna(),BTStreamsService.kgQnABulkDel($scope.stream._id,$scope.knowledgeExtractId._id,payload).then(function(res){$scope.countFaqScroll=0,$(".kgFaqScroll").scrollTop(0),kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,0,faqsLimit,$scope.search.faq,$scope.filterType,i18n.i18nString("faqs_deleted")),$timeout(function(){$element.find("#selectAllKg")[0].checked=!1},250)},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error")})}function loadNextFaqs(){var deferred=$q.defer();return BTStreamsService.kgQuesAns($scope.stream._id,$scope.knowledgeExtractId._id,countStart*faqsLimit,faqsLimit,$scope.search.faq,$scope.filterType).then(function(res){deferred.resolve(res)},function(err){deferred.reject(err)}),deferred.promise}function getCountFaq(type){return $scope.extraction.qas.filter(function(val){return"addedQues"===type?!val.status:val.status}).length}function startKgHistInterval(flag,selected){var kgHistInter=$interval(function(){BTStreamsService.kgQuesAns($scope.stream._id,$scope.knowledgeExtractId._id,countStart*faqsLimit,faqsLimit,$scope.search.faq,$scope.filterType).then(function(res){$scope.extraction.qas=$scope.extraction.qas.concat(res.data.extractions),$scope.extraction.allQAS=$scope.extraction.allQAS.concat(res.data.extractions),"till10"===flag&&getCountFaq(selected)>9?($interval.cancel(kgHistInter),$scope.countFaqRow=!0,$scope.isFaqEmpty=!1):"tillEnd"===flag&&getCountFaq(selected)===countAllSelect&&($interval.cancel(kgHistInter),$scope.countFaqRow=countAllSelect>9,$scope.isFaqEmpty=!1),countStart++},function(err){$interval.cancel(kgHistInter)})},500)}function kgHistoryUpdate(selected){countAllSelect="addedQues"===selected?$scope.qna.added:$scope.qna.notAdded;var countFq=getCountFaq(selected);if(!countAllSelect)return $scope.countFaqRow=!1,void($scope.isFaqEmpty=!0);if(countAllSelect>0&&11>countAllSelect&&countAllSelect===countFq)return $scope.countFaqRow=countFq>9,void($scope.isFaqEmpty=!1);if(countAllSelect>0&&11>countAllSelect)startKgHistInterval("tillEnd",selected);else{if(countAllSelect>faqsLimit&&countFq===faqsLimit)return $scope.countFaqRow=countFq>9,void($scope.isFaqEmpty=!1);if(countAllSelect>faqsLimit&&countFq===countAllSelect)return $scope.countFaqRow=countFq>9,void($scope.isFaqEmpty=!1);if(countAllSelect>faqsLimit&&countFq>faqsLimit)return $scope.countFaqRow=countFq>9,void($scope.isFaqEmpty=!1);countAllSelect>faqsLimit&&startKgHistInterval("till10",selected)}}function getNodesLockStatus(callbackMethod,showToast){botOntologyService.getNodesLockStatus($scope.userInfo.userId,$scope.knowledgeTask._id).then(function(res){var values=_.values(res.data),isResourceLocked=-1!==_.indexOf(values,!0)?!0:!1;isResourceLocked?showToast?NotificationService.notify(i18n.i18nString("nodes_lock_status"),"error"):NotificationService.confirmDialog(i18n.i18nString("nodes_lock_status"),$scope.getKTData,{okText:i18n.i18nString("ok"),noCancelBtn:!0}):callbackMethod()},function(err){})}function initContainerDrag(){var resize=$(".termContainer");$(resize).resizable({handles:"e",maxWidth:900,minWidth:350,resize:function(event,ui){var currentWidth=ui.size.width,padding=1;$(this).width(currentWidth),$(".mainContainer").width(containerWidth-currentWidth-padding)}})}function clearBuffer(){$scope.buffers.callback=null}function scrollToNode(){var _container=$(".kgContainer.ps-container"),_ele=_container.find(".highlightnode"),_x_disp=_container.width()/2,_y_disp=_container.height()/2;$timeout(function(){_container.animate({scrollLeft:_ele.offset().left+150-_container.offset().left+_container.scrollLeft()-_x_disp,scrollTop:_ele.offset().top+_ele.height()/2-_container.offset().top+_container.scrollTop()-_y_disp},function(){var _selectedNode=_ele;_selectedNode&&(_selectedNode.addClass("highlight-glow"),$timeout(function(){_selectedNode.removeClass("highlight-glow")},3e3))})},500)}function getPayload(){var _payload=[],constructPayload=function(treeData){$.each(treeData,function(i,nodeData){var nodePayloadObj=angular.copy(nodeData);nodePayloadObj=_.omit(nodePayloadObj,["nodes","class","saveFail","isNewNode","defaultCollapse","labelpath","idsPath","faqCount"]),nodePayloadObj.label&&nodePayloadObj.label.trim()&&_payload.push(nodePayloadObj),nodeData.nodes.length&&constructPayload(nodeData.nodes)})};return constructPayload($scope.data),_payload||{}}function getTextEncoded(name){return name?name.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function retainScrollPosition(editIndex){var _faqEle=$("[faqid='"+$scope.ontology.allQAS[editIndex]._id+"']");if(_faqEle){var _container=_faqEle.closest(".ps-container");if(_container){var _scrollHeight=_faqEle.offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"slow")}}}function toggleFreezeClass(action){$("body")[action]("screenFreeze")}function showLockErrorMessage(error,full){try{error=error.errors;var msg=_.isArray(error)?error[0].msg:i18n.i18nString("some_error");$scope.lockErrorMsg=msg,NotificationService.notify(msg,"error")}catch(ex){console.log(ex)}}function ondragStart(e,u){_parentHeight=$(".kgContainer")[0].scrollHeight-300,_parentWidth=$(".kgContainer")[0].scrollWidth-50}function ondragging(event,ui){var $nodeHoveredEle=$(".nodehovered");if($nodeHoveredEle.is(":visible")){var hoveredNodeScope=$(".nodehovered").closest(".ontologytreenodeKgExt").scope();hoveredNodeScope.expand(),registerDragDropEvents()}$(".kgContainer").each(function(){var $this=$(this),cOffset=$this.offset(),bottomPos=cOffset.top+$this.height();if(clearInterval($this.data("timerScroll")),$this.data("timerScroll",!1),event.pageX>=cOffset.left&&event.pageX<=cOffset.left+$this.width()){if(event.pageY>=bottomPos-triggerZone&&event.pageY<=bottomPos){var moveUp=function(){$this.scrollTop($this.scrollTop()+scrollSpeed)};$this.data("timerScroll",setInterval(moveUp,10)),moveUp()}if(event.pageY>=cOffset.top&&event.pageY<=cOffset.top+triggerZone){var moveDown=function(){$this.scrollTop($this.scrollTop()-scrollSpeed)};$this.data("timerScroll",setInterval(moveDown,10)),moveDown()}}})}function encodeJS(_obj){return encodeURIComponent(_obj)}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}function addToExtract(){$("#add-to-extraction-modal").modal("show")}function getSecondLevelNodeOfNodeId(nodeId){var map=_.indexBy($scope.ontologytreetaxonomy,"nodeId"),parents=[],rootNodeId=$scope.data[0].nodeId;if(rootNodeId){for(var node=map[nodeId];node&&node.nodeId!==rootNodeId&&node.parent[0]!==rootNodeId;)node=map[node.parent[0]];node&&node.nodeId!==rootNodeId&&parents.push(node)}return parents[0]}function updateParentToChildAllData(termData){$scope.ontology.selectedTerm.label=termData.label,$scope.ontology.selectedTerm.nodes=termData.nodes,$scope.ontology.selectedTerm.synonyms=termData.synonyms,$scope.ontology.selectedTerm.classId=termData.classId,$scope.ontology.selectedTerm.termUsage=termData.termUsage||"default";var findAndUpdateNode=function(treeData){$.each(treeData,function(i,nodeData){if(nodeData.nodeId==termData.nodeId){if(nodeData.label=termData.label,nodeData.nodes=termData.nodes,nodeData.synonyms=termData.synonyms,nodeData.classId=termData.classId,nodeData.termUsage=termData.termUsage||"default",$scope.breadCrumbData[$scope.breadCrumbData.length-1].nodeLabel=nodeData.label,nodeData&&nodeData.labelpath){var _labelPathArray=nodeData.labelpath.split(" > ");_labelPathArray[_labelPathArray.length-1]=nodeData.label,nodeData.labelpath=_labelPathArray.join(" > "),nodeData.idsPath=nodeData.idsPath;var termsMapObject1={nodeIds:nodeData.idsPath,path:nodeData.labelpath};termsMap[nodeData.nodeId]=termsMapObject1}return void updateTermAndIDsPath(nodeData,!0)}nodeData.nodes.length&&findAndUpdateNode(nodeData.nodes)})};findAndUpdateNode($scope.data)}function fillChildrenOfParentId(taxonomy,nodes,parentTermObject){if(!parentTermObject.parent.length){parentTermObject.labelpath=parentTermObject.label,parentTermObject.idsPath=parentTermObject.nodeId;var termsMapObjectroot={nodeIds:parentTermObject.idsPath,path:parentTermObject.labelpath};termsMap[parentTermObject.nodeId]=termsMapObjectroot}var childs=_.filter(taxonomy,function(node){return _.indexOf(node.parent,parentTermObject.nodeId)>-1});if(childs&&childs.length>0)for(var i=0;i<childs.length;i++){childs[i].defaultCollapse=!0,childs[i].labelpath=(parentTermObject.labelpath||parentTermObject.label)+" > "+childs[i].label,childs[i].idsPath=(parentTermObject.idsPath||parentTermObject.nodeId)+" > "+childs[i].nodeId;var termsMapObject={nodeIds:childs[i].idsPath,path:childs[i].labelpath};termsMap[childs[i].nodeId]=termsMapObject,nodes.push(JSON.parse(JSON.stringify(childs[i]))),nodes[nodes.length-1].nodes=[],fillChildrenOfParentId(taxonomy,nodes[nodes.length-1].nodes,childs[i])}}function expandAndGotoSpecificNode(nodeIdsString){var nodeIdsArray=nodeIdsString.split(" > ");if(!$("[nodeid="+nodeIdsArray[nodeIdsArray.length-1]+"] .ontologytreenodeKgExt").is(":visible")){var makeExpandNodes=function(treeData){$.each(treeData,function(i,nodeData){return-1!==$.inArray(nodeData.nodeId,nodeIdsArray)&&nodeIdsArray.length>1&&nodeData.nodes.length&&(nodeIdsArray.splice(0,1),nodeData.defaultCollapse=!1,makeExpandNodes(nodeData.nodes)),1==nodeIdsArray.length?!1:void 0})};makeExpandNodes($scope.data)}var isNOdeVisible=!1,termDetectionInterval=$interval(function(){if(isNOdeVisible=$("[nodeid="+nodeIdsArray[nodeIdsArray.length-1]+"] .ontologytreenodeKgExt").is(":visible")){$(".ontologytreenodeKgExt").removeClass("matchednode"),$(".ontologytreenodeKgExt").removeClass("highlightnode"),$($("[nodeid="+nodeIdsArray[nodeIdsArray.length-1]+"] .ontologytreenodeKgExt")[0]).addClass("highlightnode"),$(".ontologyuitreenode .ontologytreenodeKgExt").removeClass("greyBg"),scrollToNode();var selectedNodeScope=$("[nodeid="+nodeIdsArray[nodeIdsArray.length-1]+"] .ontologytreenodeKgExt").scope();$scope.getQASForThisTerm(selectedNodeScope),$interval.cancel(termDetectionInterval)}},100)}$scope.userInfo=$applicationService.userInfo(),$scope.modalSlider={},$scope.forms={},$scope._constants_=_constants_,$scope.importModal={},$scope.isFilterClick=!1,$scope.ontologyClassModal={},$scope.faqstats={},$scope.faqstats.limit=10,$scope.faqstats.path="",$scope.forms.termSettingsForm={},$scope.synonymkey={},$scope.synonymkey.searchQuery="",$scope.totalFaqCount=0,$scope.buffers={},$scope.ktSynonymObject=[],$scope.qna={added:"",notAdded:"",total:""},$scope.manageKtSynonym={},$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.placeholderMsg=i18n.i18nString("type_enter_To");var _selectedLanguage=$workflowService.currentLanguage();$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.backArrow=env_conf["context-url"]+"/assets/icons/backArrow.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.ellipsisDark=env_conf["context-url"]+"/assets/icons/ellipsisDark.svg",$scope.assetsBase=env_conf["assets-url"],$scope.rightArrow=$scope.assetsBase+"ivrIcons/rightArrow.svg",$scope.search={faq:""},$scope.knowledgeExtractId={_id:""},$scope.isFaqEmpty=!1,$scope.countFaqRow=!1,$scope.knowledgeTask={},$scope.showKgGraph=!1,$scope.showSelOptSlider=!1,$scope.filterType="",$scope.isFromSearch=!1,$scope.kgParentInfo={nodeId:"",label:""},$scope.hrefURL="",$scope.extensionImpKgExtract="",$scope.importStep=0,$scope.error={mess:""},$scope.current={tag:"allQues"},$scope.shift={key:!1};var faqsLimit=30,countAllSelect=0;$scope.statusEnabled=!0;var loadNextFaqsFlag=!0;$scope.dragDropIcon=window.appConfig.CONTEXT_PATH+"/assets/images/import.png",$scope.wentWrongIcon=window.appConfig.CONTEXT_PATH+"/assets/images/wentwrong.png",$scope.importingIcon=env_conf["context-url"]+"/assets/images/importing.png",$scope.importDoneIcon=env_conf["context-url"]+"/img/import-success.png";var countStart=1;$scope.moveForward=function(stepNo){$scope.importStep=stepNo,1==stepNo&&$scope.removeFile()},$scope.pdfAnnoData={},$scope.addedToKGFlag=!0,$scope.loaderFlag=!1,$scope.payloadFaq={},$scope.hoverNodeScope={},Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(selector){for(var el=this;el;){if(el.matches(selector))return el;el=el.parentElement}}),$scope.startImport=function(){$scope.importStep=3,BTStreamsService.uploadFAQFile($applicationService.userInfo().userId,$scope.dataImport).then(function(response){var payload={importType:"update",delimiter:",",fileType:$scope.extensionImpKgExtract.substr(1),fileName:response.data.fileId};BTStreamsService.kgImportFaq($scope.stream._id,$scope.knowledgeExtractId._id,payload).then(function(res){var importKgId=res.data._id,pollImportStatus=$interval(function(){BTStreamsService.kgStatusPoll($scope.stream._id,importKgId).then(function(res){"success"===res.data.status&&(countStart=1,kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,0,faqsLimit,"",""),$(".import-utterance-modal").modal("show"),$scope.importStep=4,$interval.cancel(pollImportStatus))},function(err){$interval.cancel(pollImportStatus),err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&($scope.error.mess=err.data.errors[0].msg),$(".import-utterance-modal").modal("show"),$scope.importStep=2})},5e3)},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&($scope.error.mess=err.data.errors[0].msg),$(".import-utterance-modal").modal("show"),$scope.importStep=2})},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&($scope.error.mess=err.data.errors[0].msg),$(".import-utterance-modal").modal("show"),$scope.importStep=2})},$scope.onCancel=function(msg){$(".import-utterance-modal").modal("hide"),$scope.fileName="",msg&&"fromImport"===msg&&NotificationService.notify(i18n.i18nString("progress_importing"))},$scope.removeFile=function(){$scope.fileName=""},$scope.onDone=function(){$(".import-utterance-modal").modal("hide"),$scope.fileName=""},$scope.importFaq=function(){$scope.importStep=0,$scope.ellipsisVert=!1,$(".import-utterance-modal").modal("show")},$scope.goToStep=function(stepNo){$scope.error.mess="",1==stepNo&&("undefined"!=typeof pollImportStatus&&$interval.cancel(pollImportStatus),$scope.moveForward(stepNo))},$scope.proceedFirst=function(){$scope.importStep=1,$timeout(function(){initDragDropFile()},500)},$scope.uploadCSVFile=function(fileObject){var _ext="";if(fileObject.name){_ext=fileObject.name.substring(fileObject.name.lastIndexOf(".")),$scope.extensionImpKgExtract=_ext;var supportingFileFormats=[".csv"];if(-1===$.inArray(_ext,supportingFileFormats))return NotificationService.notify(i18n.i18nString("csv_file"),"error"),void($scope.fileExtensionError=!0)}var reader=new FileReader;reader.readAsText(fileObject),reader.onload=function(e){var respnoseData=reader.result,_fileLimit=5e6;if(fileObject.size>_fileLimit)return NotificationService.notify(i18n.i18nString("file_size"),"warning"),void removeFile();if(!respnoseData||respnoseData&&!respnoseData.length)NotificationService.notify(i18n.i18nString("upload_valid_file",{dyn:_ext.slice(1).toUpperCase()}),"error"),$scope.fileEmptyError=!0;else{$scope.fileName=fileObject.name,$scope.fileExtensionError=!1;var data=new FormData;data.append("file",fileObject),data.append("fileContext","bulkImport"),data.append("fileExtension",_ext.substring(_ext.lastIndexOf(".")+1)),data.append("Content-Type",fileObject.type),$scope.qafileuploading=!0,$scope.dataImport=data,$scope.fileObject=fileObject}}},$scope.closeQuickTip=function(){$scope.showquicktip=!1},$scope.closeSelOptSlider=function(){$scope.showSelOptSlider=!1,$(".changeWidthOntoSelector").removeClass("width1140").addClass("width700")},$scope.showQuickTip=function(){$scope.showquicktip=!0},$scope.checkFaqSearchInp=function(e){16===e.which?$scope.shift.key=!0:$scope.shift.key&&13===e.which?$scope.shift.key=!1:13===e.which&&($scope.shift.key=!1,e.preventDefault(),$scope.isFromSearch=!0,$scope.searchKgFaq())},$scope.$watch("search.faq",function(newVal,oldVal){""===newVal&&""!==$scope.knowledgeExtractId._id&&($scope.searchKgFaq(),$scope.isFromSearch=!1)}),$scope.$watch("faqstats.limit",function(newVal,oldVal){$scope.faqstats.limit=newVal}),$scope.selectKgCheck={all:!1},$scope.treeFilter=$filter("uiTreeFilter"),$scope.availableFields=["label"],$scope.supportedFields=["label"],$scope.extraction={qas:[],allQAS:[]},$scope.editQnA={ques:"",ans:""},$(".changeWidthOntoSelector").removeClass("width1140").addClass("width700"),$scope.isMoreAvailable=!1,$scope.editKgQnA=function(qaDetails){$element.find(".editQnAForm").hide(),$element.find(".editQnAForm[edit-id="+qaDetails._id+"]").show(),$element.find(".qaFinder[qa-id="+qaDetails._id+"]").hide(),$scope.editQnA.ques=qaDetails.question,$scope.editQnA.ans=qaDetails.answer,$scope.statusEnabled=!1},$scope.closeKgSearch=function(){$scope.search.faq=""};var kgQuesAnsCall=function(streamId,knowledgeExtId,offset,limit,searchTerm,filterType,mess,flagFrom){BTStreamsService.kgQuesAns(streamId,knowledgeExtId,offset,limit,searchTerm,filterType).then(function(res){$scope.extraction.qas=angular.copy(res.data.extractions),$scope.extraction.allQAS=angular.copy(res.data.extractions),$scope.isMoreAvailable=res.data.moreAvailable,$scope.qna.added=res.data.qnaAddedCount,$scope.qna.notAdded=res.data.qnaExtractedCount,$scope.qna.total=res.data.qnaCount,$scope.current.tag="allQues",$scope.selectKgCheck.all=!1,$(".allQuestions").parent().children().removeClass("active"),$(".allQuestions").addClass("active");for(var tempQa={},tempQaCount=0,i=0;i<$scope.extraction.qas.length;i++)tempQa=$scope.extraction.qas[i],tempQaCount++;$scope.isFaqEmpty=0===tempQaCount,$scope.countFaqRow=tempQaCount>9,$timeout(function(){0!==$(".kgFaqScroll").length&&$(".kgFaqScroll").scrollTop(0),0!==$(".kgContainer.clt").length&&$(".kgContainer.clt").scrollTop(0)},250),mess&&NotificationService.notify(mess,"success"),$scope.checkAddToFAQ()},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")})};$scope.exportFaq=function(isFromBackup){function startExport(){BTStreamsService.kgExportFaq($scope.stream._id,$scope.knowledgeExtractId._id).then(function(res){var _idKgExport=res.data._id;isFromBackup?isFromBackup&&NotificationService.notify(i18n.i18nString("downloading"),"success"):NotificationService.notify(i18n.i18nString("export_inprogress"),"success");var dockStatusPoll=$interval(function(){BTStreamsService.getAllProgressDockNotifications($scope.stream._id).then(function(res){var dockData=res.data.filter(function(val){return val._id===_idKgExport})[0],fileIdKgExport=dockData.fileId;"SUCCESS"===dockData.status&&($interval.cancel(dockStatusPoll),BTStreamsService.downloadProgressDockExportFile(fileIdKgExport).then(function(res){if(res&&res.data){$scope.hrefURL=res.data.fileUrl+dockData.store.urlParams;var element=document.createElement("a");element.setAttribute("href",$scope.hrefURL),element.setAttribute("target","_self"),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")}))},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error"),$interval.cancel(dockStatusPoll)})},100)},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_faqs")):startExport()},$scope.searchKgFaq=function(){$scope.countFaqScroll=0,kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,0,faqsLimit,$scope.search.faq,$scope.filterType)},$scope.isAddEligible=function(){return 0===$element.find(".faqCheckBox:checked").length},$scope.addToNode=function(){$(".changeWidthOntoSelector").removeClass("width700").addClass("width1140"),$scope.showSelOptSlider=!0};var getSelectedQna=function(){for(var selectedFAQ=$element.find(".faqCheckBox:checked"),idList=[],i=0;i<selectedFAQ.length;i++)idList[i]=selectedFAQ[i].id;return idList=idList.filter(function(val){return void 0!==val})};$scope.delMultipleFAQ=function(){var $faqCheckBox=$element.find(".faqCheckBox:checked");0===$faqCheckBox.length?NotificationService.notify(i18n.i18nString("faq_delete"),"error"):NotificationService.confirm({heading:i18n.i18nString("delete_faq"),headerClass:"confirmationHeader",msg:i18n.i18nString("delete_faqs"),successCb:bulkDeleteFaqQnA,isModal:!0,btnTexts:{success:i18n.i18nString("ok_label"),fail:i18n.i18nString("cancel")}})},$scope.removeClippedLines=function(e){e.currentTarget.classList.contains("clipThreeLines")?e.currentTarget.classList.remove("clipThreeLines"):e.currentTarget.classList.add("clipThreeLines")},$timeout(function(){document.getElementById("FaqKgList").addEventListener("scroll",function(e){$(this).scrollTop()+$(this).innerHeight()>=.95*$(this)[0].scrollHeight&&$scope.isMoreAvailable&&loadNextFaqsFlag&&(loadNextFaqsFlag=!1,loadNextFaqs().then(function(res){$scope.extraction.qas=$scope.extraction.qas.concat(res.data.extractions),$scope.extraction.allQAS=$scope.extraction.allQAS.concat(res.data.extractions),$scope.isMoreAvailable=res.data.moreAvailable,$scope.countFaqRow=$(".faqrow.checkboxWrap").length>9,("addedQues"===$scope.current.tag&&getCountFaq("addedQues")===$scope.qna.added||"notAdded"===$scope.current.tag&&getCountFaq("notAdded")===$scope.qna.notAdded)&&($scope.countFaqRow=!1),countStart++,loadNextFaqsFlag=!0},function(err){NotificationService.notify(i18n.i18nString("unable_load"),"error"),loadNextFaqsFlag=!0}))})},1e3),$scope.filterShowHide=function(){$scope.isFilterClick=!$scope.isFilterClick},$scope.filterSelected=function(sel){"allQnA"===sel?($scope.countFaqScroll=0,$scope.filterType="all",kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,$scope.countFaqScroll*faqsLimit,faqsLimit,$scope.search.faq,"all","","fromFilter")):"canAdd"===sel?($scope.countFaqScroll=0,$scope.filterType="open",kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,$scope.countFaqScroll*faqsLimit,faqsLimit,$scope.search.faq,"open","","fromFilter")):"addedPrev"===sel&&($scope.countFaqScroll=0,$scope.filterType="added",kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,$scope.countFaqScroll*faqsLimit,faqsLimit,$scope.search.faq,"added","","fromFilter")),$timeout(function(){$element.find("#selectAllKg")[0].checked=!1},250)},$scope.saveEditQnA=function(details){var payload={question:$scope.editQnA.ques,answer:$scope.editQnA.ans};countStart=1,BTStreamsService.kgQnAUpdate($scope.stream._id,details.kEId,details._id,payload).then(function(res){$element.find(".editQnAForm[edit-id="+details._id+"]").hide(),$element.find(".qaFinder[qa-id="+details._id+"]").show(),$scope.editQnA.ques="",$scope.editQnA.ans="",kgQuesAnsCall($scope.stream._id,details.kEId,0,faqsLimit,"",$scope.filterType,i18n.i18nString("faq_updated"))},function(err){NotificationService.notify(i18n.i18nString("unable_save"),"error")}),$scope.statusEnabled=!0},$scope.closePrefixModal=function(){$element.find("#kg-extract-modal").removeClass("show").addClass("fade")},$scope.registerDD=function(){registerDragDropEvents()},$scope.updateCurrentTab=function(selected){if("addedQues"!==selected&&"notAdded"!==selected||""!==$scope.search.faq?""===$scope.search.faq&&$scope.extraction.qas.length&&($scope.isFaqEmpty=!1):(countStart=1,kgHistoryUpdate(selected)),$scope.selectKgCheck.all){$scope.selectKgCheck.all=!1;for(var i=0;i<$scope.extraction.qas.length;i++)$scope.extraction.qas[i].selected=!1}$scope.current.tag=selected,$timeout(function(){$(".kgFaqScroll").scrollTop(0)})},$scope.cancelEditQnA=function(details){$element.find(".editQnAForm[edit-id="+details._id+"]").hide(),$element.find(".qaFinder[qa-id="+details._id+"]").show(),$scope.editQnA.ques="",$scope.editQnA.ans="",$scope.statusEnabled=!0},$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.icIcon=$scope.iconContextPath+"/includechilds.svg",$scope.ecIcon=$scope.iconContextPath+"/excludechilds.svg",$scope.stream=$workflowService.selectedStream();var faqEvents,termEvents;$scope.activeNodeId=1,$scope.faqsLoaded=!1,$scope.selectedQuestions=[],$scope.ontology={},$scope.ontology.allQAS=[],$scope.selectAllQna=function(){for(var currTag=$scope.current.tag,i=0;i<$scope.extraction.qas.length;i++){var qaStatus=$scope.extraction.qas[i].status;("allQues"===currTag||"addedQues"===currTag&&!qaStatus||"notAdded"===currTag&&qaStatus)&&($scope.extraction.qas[i].selected=!$scope.selectKgCheck.all)}},$scope.callback.knowledgeQnA=function(kgListData){$scope.knowledgeExtractId._id=angular.copy(kgListData._id),$scope.getKTData(),$scope.countFaqScroll=0,kgQuesAnsCall($scope.stream._id,kgListData._id,0,faqsLimit,"",$scope.filterType)},$scope.deleteKgFAQ=function(delData){NotificationService.confirm({heading:i18n.i18nString("delete_faq"),headerClass:"confirmationHeader",msg:i18n.i18nString("are_delete"),successCb:function(){BTStreamsService.kgQnADel($scope.stream._id,delData.kEId,delData._id).then(function(res){kgQuesAnsCall($scope.stream._id,delData.kEId,0,faqsLimit,"",$scope.filterType,i18n.i18nString("faq_deleted"))},function(err){console.log("Error ",err)})},failCb:function(){},isModal:!0,btnTexts:{success:i18n.i18nString("ok_label"),fail:i18n.i18nString("cancel")}})},$scope.isEditable=function(){return"view"!==$workflowService.taskMode()},$scope.expandAllNodes=!1,$scope.toggleNode=function(scope){function proceed(){return scope.$modelValue["class"]?($scope.expandAllNodes=!$scope.expandAllNodes,$scope.expandAllNodes?$scope.expandAll():($scope.collapseAll(),scope.toggle()),clearBuffer(),void $timeout(function(){registerDragDropEvents()},500)):(scope.toggle(),clearBuffer(),void $timeout(function(){registerDragDropEvents()},500))}return $scope.isNewNodeSaveTriggered?void($scope.buffers.callback=proceed):void $scope.lockorCheckNode(scope.$modelValue,proceed)},$scope.expandDirectChildOfRoot=function(scope){$scope.collapseAll(),scope.toggle()},$scope.moveLastToTheBeginning=function(){var a=$scope.data.pop();$scope.data.splice(0,0,a)},$scope.treeOptions={accept:function(sourceNodeScope,destNodesScope,destIndex){return"undefined"!=typeof destNodesScope.node&&"uiTreeNode"===destNodesScope.$parent.$type?!0:!1},beforeDrop:function(e){},dropped:function(e){function proceedUpdateOnDragAndDrop(){sourceModelValue.parent[0]=destinationModalValue.nodeId,sourceModelValue.labelpath=(destinationModalValue.labelpath||destinationModalValue.label)+" > "+sourceModelValue.label,sourceModelValue.idsPath=(destinationModalValue.idsPath||destinationModalValue.nodeId)+" > "+sourceModelValue.nodeId;var termsMapObject1={nodeIds:sourceModelValue.idsPath,path:sourceModelValue.labelpath};termsMap[sourceModelValue.nodeId]=termsMapObject1,updateTermAndIDsPath(sourceModelValue),$scope.updateOntology("","",!0)}$(".kgContainer").css({cursor:"default"});var sourceModelValue=e.source.nodeScope.$modelValue,destinationModalValue=e.dest.nodesScope.$nodeScope.$modelValue;return sourceModelValue.parent[0]!==destinationModalValue.nodeId?void getNodesLockStatus(proceedUpdateOnDragAndDrop):void(e.source.index==e.dest.index?console.log("same index"):getNodesLockStatus(proceedUpdateOnDragAndDrop))}},$scope.onmMenuOptionClicked=function($event){if($event.stopPropagation(),$event.currentTarget){var _currEle=$($event.currentTarget);_currEle.siblings().removeClass("active"),_currEle.addClass("active"),_currEle.find(".dropdown").addClass("open")}},$scope.disableDrag=function(node){var _disableDrag=!1;return(!node.parent.length||node.isNewNode)&&(_disableDrag=!0),_disableDrag};var highlightIndex=-1,_prevSearchTxt="",previousSearchTerm="",machedTerms=[],isFromSelect=!1;$scope.clearSearch=function(){$scope.pattern="",$scope.searchTextInfo="",_prevSearchTxt="",$(".ontologytreenodeKgExt").removeClass("matchednode"),$(".ontologytreenodeKgExt").removeClass("highlightnode"),setTimeout(function(){$(".angular-ui-tree-node .ontologytreenodeKgExt").removeClass("highlightnode"),$(".angular-ui-tree-node .ontologytreenodeKgExt").removeClass("bgGreen")},100),$($(".ontologyuitreenode .ontologytreenodeKgExt")[0]).addClass("greyBg"),highlightIndex=-1,previousSearchTerm="",machedTerms=[],$scope.matchedTerms=[]},$scope.highlightTermText=function(evt){""===evt.target.value&&($scope.matchedTerms=[],$(".angular-ui-tree-node .ontologytreenodeKgExt").removeClass("highlightnode"),$(".angular-ui-tree-node .ontologytreenodeKgExt").removeClass("bgGreen"));{if(!$scope.pattern)return void $scope.clearSearch();if(13==evt.keyCode){if(isFromSelect)return void(isFromSelect=!1);if($(evt.target).autocomplete("close"),previousSearchTerm!==$scope.pattern&&(machedTerms=[],machedTerms=_.filter($scope.ontologytreetaxonomy,function(nodeData){return-1!==nodeData.label.toLowerCase().indexOf($scope.pattern.toLowerCase())}),$scope.matchedTerms=machedTerms||[],previousSearchTerm=$scope.pattern,highlightIndex=-1),highlightIndex==machedTerms.length-1&&(highlightIndex=-1),machedTerms.length){highlightIndex+=1;var nodeIdsString=termsMap[machedTerms[highlightIndex].nodeId].nodeIds;$scope.searchTextInfo=highlightIndex+1+i18n.i18nString("of")+machedTerms.length,expandAndGotoSpecificNode(nodeIdsString)}else $scope.searchTextInfo=highlightIndex+1+i18n.i18nString("of")+machedTerms.length}}},$scope.prevSearch=function(){$scope.navigateToSearch("backward")},$scope.nextSearch=function(){$scope.navigateToSearch("forward")},$scope.navigateToSearch=function(navigationType,index){if(navigationType=navigationType?navigationType:"forward",!machedTerms.length)return void($scope.searchTextInfo="");0===highlightIndex&&"backward"==navigationType?highlightIndex=machedTerms.length-1:highlightIndex>0&&"backward"==navigationType&&(highlightIndex-=1),highlightIndex==machedTerms.length-1&&"forward"==navigationType?highlightIndex=0:highlightIndex<machedTerms.length-1&&"forward"==navigationType&&(highlightIndex+=1),highlightIndex=-1==index?index+1:-1==highlightIndex?highlightIndex+1:highlightIndex,$(".angular-ui-tree-node .ontologytreenodeKgExt").removeClass("highlightnode");var nodeIdsString=termsMap[machedTerms[highlightIndex].nodeId].nodeIds;$scope.searchTextInfo=highlightIndex+1+" of "+machedTerms.length,expandAndGotoSpecificNode(nodeIdsString);
},$scope.updateScroll=function(scrollEle){$timeout(function(){PerfectScrollbar.update($(scrollEle)[0])},300)},$scope.bindScrollPagination=function(){var formContainerEle=$(".faqcollection ");formContainerEle.unbind("scroll").bind("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.getFaqsByKnowledge("","",!0)})},$scope.getFaqsByKnowledge=function(offset,isFromNode,isFromPagination){var searchParam=encodeJS($scope.faqSearchQuery)||"";if(offset=offset||0,void 0===isFromNode&&(isFromNode=!0),isFromNode&&($scope.faqsLoaded=!1,searchParam="",$scope.faqSearchQuery="",$scope.ontology.qas=[]),isFromPagination){if(!$scope.moreAvailable||$scope.loadingPaginatedFAQs)return;$scope.loadingPaginatedFAQs=!0,offset=$scope.ontology.qas.length}$scope.faqsFromNode=isFromNode,searchParam?$scope.isFromSearch=!0:$scope.isFromSearch=!1,BTStreamsService.getOrSearchFAQS($applicationService.userInfo.userId,$scope.knowledgeTask._id,searchParam,offset,$scope.faqstats.limit,$scope.activeNodeId,""+$scope.withallchild).then(function(response){response.data.count&&($scope.totalFaqCount=response.data.count),$scope.moreAvailable=response.data.moreAvailable,$.each(response.data.faqs,function(i,qa){$.map(qa.answerPayload,function(answerObject){return answerObject.text=decodeJS(answerObject.text),answerObject}),qa.questionPayload.question=qa.questionPayload.question||"",$.each(qa.subAnswers,function(i,answerObject){$.map(answerObject,function(subanswerObject){return subanswerObject.text=decodeJS(subanswerObject.text),subanswerObject})})}),isFromPagination?$scope.ontology.allQAS=[].concat($scope.ontology.allQAS,response.data.faqs):($scope.ontology.allQAS=response.data.faqs,$scope.faqsLoaded=!0),$scope.totalItems=response.data.count,$scope.ontology.qas=$scope.ontology.allQAS||[],$scope.ontology.allQAS.length?($("body").addClass("ontologymodalopen"),$scope.showBulkImport=!1):$scope.withallchild&&$scope.activeNodeId==$scope.data[0].nodeId&&($scope.showBulkImport=!0,$("body").removeClass("ontologymodalopen")),$scope.loadingPaginatedFAQs=!1,registerDragDropEvents(),isFromPagination||$(".kgFaqScroll").scrollTop(0),$timeout(function(){$scope.bindScrollPagination(),faqEvents.disableDragKgExt(),$rootScope.$emit("pefectScrollUpdate")},350),$scope.loaderFlag=!1},function(error){$scope.faqsLoaded=!0,$scope.loaderFlag=!1})},$scope.withallchild=!0;$scope.resetFlags=function(){$scope.showBTS=!1,$scope.showQAForm=!1,$scope.showFAQs=!1},$scope.collapseAll=function(){$scope.$broadcast("angular-ui-tree:collapse-all")},$scope.expandAll=function(){$scope.$broadcast("angular-ui-tree:expand-all")},$scope.data=[{nodeId:uuid.v4(),label:getTextEncoded($scope.stream.name),"class":"bgblack",level:"l0",parent:[],synonyms:[],nodes:[]}];getPayload();$scope.ontologyfaqsStats={},$scope.ontologyfaqsStats.editIndex=-1,$scope.getKTData=function(fromImport,fromTerm){fromTerm||($scope.loadingKnowledgeGraph=!0),fromImport&&($scope.data=[],$scope.ontology.qas=[]);var requestData={streamId:$workflowService.selectedStream()._id};BTStreamsService.getAllKtsList($applicationService.userInfo().userId,requestData).then(function(res){if(res.data.length){var configuredRes=res.data.filter(function(val){return"configured"===val.status||"awaitingApproval"})[0];$scope.knowledgeTask=configuredRes,$scope.ontologytreetaxonomy=configuredRes.taxonomy,$scope.kgParentInfo.nodeId=configuredRes.taxonomy[0].nodeId,$scope.kgParentInfo.label=configuredRes.taxonomy[0].label,$scope.ontologytreetaxonomy=configuredRes.taxonomy.filter(function(val){return val.deleted!==!0}),$scope.loadingKnowledgeGraph=!1;var totalTreeData=_.filter($scope.ontologytreetaxonomy,function(treeData){return!treeData.parent||!treeData.parent.length});totalTreeData[0].nodes=[],totalTreeData[0]["class"]="bgblack";new Date;fillChildrenOfParentId($scope.ontologytreetaxonomy,totalTreeData[0].nodes,totalTreeData[0]);new Date;$scope.data=totalTreeData.length&&totalTreeData||$scope.data,$timeout(function(){if(fromTerm){var fromTermScope=$("[nodeid='"+fromTerm.nodeId+"'] .ontologytreenodeKgExt").scope();$scope.openSettingsPanel(fromTermScope)}else{var rootNodeScope=$("[nodeid='"+$scope.data[0].nodeId+"'] .ontologytreenodeKgExt").scope();$scope.getQASForThisTerm(rootNodeScope),$scope.expandDirectChildOfRoot(rootNodeScope)}initContainerDrag()},500)}else $scope.loadingKnowledgeGraph=!1,$scope.createOntology()},function(err){})},$scope.getPathOfTerm=function(scope){var _termPath=[],allParents=$(scope.$element).parentsUntil(".termContainer").filter("[nodeid]");return allParents.each(function(k,l,m,n){var nodeObject={nodeLabel:$(this).attr("nodeLabel"),nodeId:$(this).attr("nodeID"),scope:$(this).scope()};_termPath.push(nodeObject)}),$scope._termPath=_termPath.reverse(),_.pluck($scope._termPath,"nodeLabel").join(" > ")};$scope.getAndUpdateOntology=function(fromTerm){$scope.getKTData(!1,fromTerm)},$scope.getTermLabelByID=function(id){var term=_.find($scope.ontologytreetaxonomy,{nodeId:id})||{};return term.label||""};$scope.releaseLock=function(resourceID,hideMsg){return BTStreamsService.releaseLock(resourceID).then(function(res){hideMsg||NotificationService.notify(i18n.i18nString("edit_locked",{name:resource.name}),"success")},function(err){return hideMsg||NotificationService.notify(i18n.i18nString("edit_lock_failed",{name:resource.name}),"error"),$q.reject({data:{error:i18n.i18nString("lock_release_failed")}})})},$scope.lockResource=function(resourceID){return BTStreamsService.createLock(resourceID).then(function(res){},function(err){return showLockErrorMessage(err.data,err),$q.reject(err)})};var prevResourceId="";$scope.isTermLocked=!1,$scope.lockorCheckNode=function(resource,cbMethod,stopOnError){if($scope.resourceCopy=angular.copy(resource),!resource.parent||!resource.parent.length||resource.parent[0]!==$scope.data[0].nodeId||!$scope.isEditable())return void cbMethod();var resourceID=resource.nodeId;resourceID=$scope.knowledgeTask._id+"@"+resourceID,prevResourceId&&prevResourceId!==resourceID&&$scope.releaseLock(prevResourceId,!0),$scope.lockResource(resourceID).then(function(res){prevResourceId=resourceID,$scope.isTermLocked=!1,cbMethod()},function(err){$scope.isTermLocked=!0,stopOnError||cbMethod()})},$scope.updateTagPath=function(parentID){var term={},pathArray=[];do{term=_.find($scope.ontologytreetaxonomy,{nodeId:parentID})||{};var nodeObject={};nodeObject.tag=term.label,nodeObject.hideRemove=!0,pathArray.push(nodeObject),parentID=term.parent&&term.parent[0]}while(term.parent&&term.parent.length);$scope.faqEditTagsPath=pathArray.reverse()};var _parentHeight=0,_parentWidth=0,triggerZone=100,scrollSpeed=2,Events=function(element){this.element=element};Events.prototype.registerDragKgExt=function(){$(this.element).draggable({appendTo:".kg-extraction-form-two",cursor:"move",cursorAt:{top:-12,left:-20},zIndex:999999,containment:".kg-extraction-form-two",scroll:!1,helper:function(event){if($scope.selectedQuestions&&$scope.selectedQuestions.length>0){var html='<div class="ui-widget-header tileParent" style="z-index:999999"><div class="child1"><div class="child2"><div class="child3"><span class="pull-right countercircle">'+$scope.selectedQuestions.length+'</span><span class="helperText">'+$scope.selectedQuestions[0].question+"</span></div></div></div></div>";return $scope.html=html,$(html)}},start:function(event,ui){$scope.dragInProgress=!0,ondragStart(event,ui)},stop:function(event,ui){$scope.dragInProgress=!1,$(".kgContainer").each(function(){clearInterval($(this).data("timerScroll")),$(this).data("timerScroll",!1)})},refreshPositions:!0,drag:function(event,ui){ondragging(event,ui)}})},Events.prototype.enableDragKgExt=function(){$(this.element).hasClass("ui-draggable")&&$(this.element).draggable("enable")},Events.prototype.disableDragKgExt=function(){$(this.element).hasClass("ui-draggable")&&$(this.element).draggable("disable")},Events.prototype.registerDropKgExt=function(){$(this.element).droppable({hoverClass:"nodehovered",classes:{"ui-droppable-hover":"ui-state-hover"},tolerance:"pointer",drop:function(event,ui){var parent=$(event.target).closest("li").attr("nodeID"),leafterm=$(event.target).closest("li").attr("label"),hoverNodeScope=$("[nodeid='"+parent+"'] .ontologytreenodeKgExt").scope(),faqCollectionPayload=($scope.getPathOfTerm(hoverNodeScope),_.map($scope.selectedQuestions,function(question){question.parent=parent,question.leafterm=leafterm;var answerPayload=[];$.each(question.answerPayload,function(i,answers){var ans={};ans._id=answers._id,ans.text=encodeJS(answers.text),ans.type=answers.type,ans.channel=answers.channel||"default",answerPayload.push(ans)});var subAnswers=[];$.each(question.subAnswers,function(i,answerObject){var answerPayloadObject=[];$.each(answerObject,function(i,subAnswerObject){var answerObject={_id:subAnswerObject._id,text:encodeJS(subAnswerObject.text),type:subAnswerObject.type,channel:subAnswerObject.channel||"default"};answerPayloadObject.push(answerObject)}),subAnswers.push(answerPayloadObject)});var faqPayload={questionPayload:{question:question.question,tagsPayload:[]},answerPayload:[{text:question.answer,type:"basic",channel:"default"}],knowledgeTaskId:$scope.knowledgeTask._id,subQuestions:[],responseType:"message",subAnswers:[],streamId:question.streamId,parent:parent,leafterm:leafterm,qsId:question._id};return faqPayload}));$scope.ontology.qas=_.filter($scope.ontology.allQAS,function(qas){return!0})||[];var payloadFaq={faqs:faqCollectionPayload};countStart=1,$scope.pdfAnnoData&&0===$scope.qna.added&&"pdf"===$scope.pdfAnnoData.fileExtension?(addToExtract(),$scope.payloadFaq=payloadFaq,$scope.hoverNodeScope=hoverNodeScope):$scope.faqBulkUpdate(payloadFaq,hoverNodeScope)}})},$scope.proceedAddToExtractDialog=function(){$scope.faqBulkUpdate($scope.payloadFaq,$scope.hoverNodeScope)},$scope.cancelAddToExtractDialog=function(){$("#add-to-extraction-modal").modal("hide")},$scope.$watch("extraction.qas",function(newVal,oldVal){$scope.selectedQuestions=_.filter($scope.extraction.qas,{selected:!0})||[],$scope.selectedQuestions&&!$scope.selectedQuestions.length&&faqEvents?$timeout(function(){faqEvents.disableDragKgExt()},200):faqEvents&&$timeout(function(){faqEvents.enableDragKgExt()},200)},!0),$scope.getThisQaTermLockstate=function(qa){var term=getSecondLevelNodeOfNodeId(qa.parent);return term?term.editLocked:void 0},$scope.hideOntologyQAForm=function(){$scope.showQAForm=!1;var editIndex=angular.copy($scope.ontologyfaqsStats.editIndex);$scope.ontologyfaqsStats.editIndex=-1,$timeout(function(){-1!==editIndex?(retainScrollPosition(editIndex),editIndex=-1):$(".faqcollection").scrollTop(0),registerDragDropEvents(),$scope.bindScrollPagination()},300)},$scope.selectTheClickedNode=function(scope){if($scope.resetFlags($scope.showFAQs),$scope.showFAQs=!0,$scope.activeNodeId=scope.$modelValue.nodeId,$scope.activeNodeLabel=scope.$modelValue.label,$(".ontologytreenodeKgExt").removeClass("bgGreen"),scope.$modelValue.isNewNode){$("[nodeid='"+scope.$modelValue.parent[0]+"']").find("> .ontologytreenodeKgExt").addClass("bgGreen");var parentScope=$("[nodeid='"+scope.$modelValue.parent[0]+"']").scope();$scope.activeNodeId=parentScope.$modelValue.nodeId,$scope.activeNodeLabel=parentScope.$modelValue.label,$scope.getFaqsByKnowledge()}else $(scope.$element).hasClass("ontologytreenodeKgExt")?$($(scope.$element).closest(".ontologytreenodeKgExt")[0]).addClass("bgGreen"):$($(scope.$element).find("> .ontologytreenodeKgExt")[0]).addClass("bgGreen")},$scope.getQASForThisTerm=function(scope,isFromNode){function proceed(){$scope.hideOntologyQAForm(),$scope.selectTheClickedNode(scope),$scope.ontology.selectedTerm=scope.$modelValue,$scope.showQuickTip(),$timeout(function(){$scope.closeQuickTip()},1e4),$scope.getFaqsByKnowledge("",isFromNode),clearBuffer()}if($scope.isNewNodeSaveTriggered)return void($scope.buffers.callback=proceed);var secondLevelNode=getSecondLevelNodeOfNodeId(scope.$modelValue.nodeId);secondLevelNode?($scope.clickedTermParent=secondLevelNode,$scope.lockorCheckNode(secondLevelNode,proceed)):(proceed(),$scope.clickedTermParent=$scope.ontology.selectedTerm)},$scope.checkLevel=function(node){var rootNodeId=$scope.data[0].nodeId;return node.parent[0]==rootNodeId&&node.editLocked?!0:!1},$scope.createConnections=function(){var _source=$(".angular-ui-tree-node"),_target=".angular-ui-tree-node .angular-ui-tree-node";_source.connections({to:_target,within:$(".angular-ui-tree-nodes")})},$scope.getFormattedData=function(){function format(json_string,key_to_skip){return JSON.parse(json_string,function(key,value){return key!==key_to_skip?value:void 0})}return format(JSON.stringify($scope.data),"isNewNode")},$scope.createOntology=function(){var payload={};payload.name=$workflowService.selectedStream().name,payload.description=i18n.i18nString("make_kg"),payload.taxonomy=getPayload(),payload.isGraph=!0,payload.visibility={namespace:"private",namespaceIds:[$scope.userInfo.userId]},payload.streamId=$scope.stream._id,payload.metadata={taxonomy:$scope.getFormattedData()},botOntologyService.createTerm($scope.userInfo.userId,payload).then(function(res){$scope.knowledgeTask=res.data,$scope.kgParentInfo.nodeId=res.data.taxonomy[0].nodeId,$scope.kgParentInfo.label=res.data.taxonomy[0].label,$scope.callback.getKnowledgeTasksKgOnto(),$scope.ontologytreetaxonomy=res.data.taxonomy,$scope.data=res.data.metadata&&res.data.metadata.taxonomy.length&&res.data.metadata.taxonomy||$scope.data,$timeout(function(){$timeout(function(){initContainerDrag()},600),$scope.getQASForThisTerm($(".bgblack").scope())},500)},function(err){console.log(err)})},$scope.cudOntologyNode=function(operation,nodeData,cb,msg){var isFromSettings=_.isArray(nodeData);nodeData=_.isArray(nodeData)?nodeData:[nodeData],nodeData=_.map(nodeData,function(node){return node=_.omit(node,["nodes","class","saveFail","isNewNode","defaultCollapse","labelpath","idsPath","faqCount"]),node.operation=operation,node});var loader="";loader=cb&&"delete"==cb.event?NotificationService.loader(i18n.i18nString("deleting_term")):NotificationService.loader(i18n.i18nString("updating_kg")),toggleFreezeClass("addClass"),botOntologyService.cudOntologyNode($scope.userInfo.userId,$scope.stream._id,$scope.knowledgeTask._id,nodeData).then(function(response){isFromSettings&&updateParentToChildAllData(cb.data),$scope.ontologytreetaxonomy=response.data.taxonomy,cb&&"enter"==cb.event?($scope.parentTermScope=$("[nodeid='"+cb.data.$modelValue.parent[0]+"']").scope(),$scope.stopUpdate=!0,delete $scope.ontology.selectedTerm.isNewNode,$scope.newSubItem($scope.parentTermScope),loader()):(cb&&"delete"==cb.event,loader()),toggleFreezeClass("removeClass"),$scope.buffers.callback&&(delete $scope.ontology.selectedTerm.isNewNode,$scope.buffers.callback()),delete $scope.ontology.selectedTerm.isNewNode,$scope.isNewNodeSaveTriggered=!1,$scope.ontology.selectedTerm.showCheck=!0;var _selectedTerm=$scope.ontology.selectedTerm;$timeout(function(){delete _selectedTerm.showCheck},1e3),msg=msg?msg:i18n.i18nString("terms_saved"),NotificationService.notify(msg,"success"),$scope.forms.saveInProgress=!1;$("[nodeid="+$scope.ontology.selectedTerm.nodeId+"] .ontologytreenodeKgExt").removeClass("matchednode"),$("[nodeid="+$scope.ontology.selectedTerm.nodeId+"] .ontologytreenodeKgExt").removeClass("highlightnode"),$scope.navigateToSearch("",-1),toggleFreezeClass("removeClass")},function(error){loader(),toggleFreezeClass("removeClass")})},$timeout(function(){var hoverTimer=$(document).on("mouseover",".ontologytreenodeKgExt",function(evt){function scrollToViewPort(){evt.stopPropagation(),evt.stopImmediatePropagation(),evt.preventDefault();var offsetObj=$(evt.target).closest(".ontologytreenodeKgExt").offset(),_scrollLeftPos=$(".kgContainer").scrollLeft(),_scrollUpto=0,totalWidthComparision=$(".kgContainer").width()<$(evt.target).closest(".ontologytreenodeKgExt").width()+offsetObj.left;offsetObj.left<0?(_scrollUpto=_scrollLeftPos+offsetObj.left,$(".kgContainer").scrollLeft(_scrollUpto)):offsetObj.left>0&&totalWidthComparision&&(_scrollUpto=_scrollLeftPos+offsetObj.left,$(".kgContainer").scrollLeft(_scrollUpto))}hoverTimer=$timeout(function(){scrollToViewPort()},500)}).on("mouseout",".ontologytreenodeKgExt",function(evt){$timeout.cancel(hoverTimer)})},1e3),$scope.faqBulkUpdate=function(faqCollectionPayload,scope,mess){$scope.loaderFlag=!0,$scope.cancelAddToExtractDialog(),BTStreamsService.kgDragDropFaq($applicationService.userInfo().userId,faqCollectionPayload).then(function(res){$timeout(function(){$element.find("#selectAllKg")[0].checked=!1},250),res.data.message?NotificationService.notify(res.data.message,"warning"):mess?NotificationService.notify(mess,"success"):NotificationService.notify(i18n.i18nString("selected_added_kg"),"success");try{var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Knowledge Graph","Knowledge Category":faqCollectionPayload.faqs[0].leafterm};mixPanel.postEvent("Conversation - Question added",eventInfo)}catch(e){console.log("Kg addition failed")}$scope.callback.knowledgeQnA($scope.knowledgeExtractId),$(".kgFaqScroll").scrollTop(0),$scope.loaderFlag=!1},function(err){if(err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg){try{NotificationService.notify(JSON.parse(err.data.errors[0].msg).errors["answerPayload.0.answer"].message,"error")}catch(e){NotificationService.notify(err.data.errors[0].msg,"error")}409===err.data.errors[0].code&&kgQuesAnsCall($scope.stream._id,$scope.knowledgeExtractId._id,0,faqsLimit,"","")}else console.error("Error Detected ",err);$timeout(function(){$element.find("#selectAllKg")[0].checked=!1,$(".kgFaqScroll").scrollTop(0)},250),$scope.loaderFlag=!1})},$scope.showNodeSuggestions=!0,$scope.closeNodeSuggestions=function(){$scope.showNodeSuggestions=!1;var parentTermScope=$(".bgblack").scope();$scope.newSubItem(parentTermScope)};var registerDragDropEvents=function(){$timeout(function(){faqEvents=new Events(".kgQnaBody"),termEvents=new Events(".tree-node-content-kg"),faqEvents.registerDragKgExt(),termEvents.registerDropKgExt()},200)};$scope.isResponseEllipsis=function(evt,qa){var _ellipsisEles=$(evt.target).closest(".row").find(".ellipsisview"),isElipsis=!1;return $.each(_ellipsisEles,function(i,elepsisEle){"true"==$(elepsisEle).attr("data-overflowed")&&(isElipsis=!0)}),(qa.answer&&qa.answer.length>110||qa.question&&qa.question.length>110)&&(isElipsis=!0),isElipsis},$scope.showFullResponse=function(qa){qa.fullView=!qa.fullView},$scope.checkFromSearch=function(){return $scope.isFromSearch},$scope.moreAvailable=!0,$scope.unlockTerm=function(node){function confirmUnlock(){var payload={nodeId:node.nodeId};BTStreamsService.ktNodeUnlock($scope.stream._id,$scope.knowledgeTask._id,payload).then(function(response){$scope.getKTData(),NotificationService.notify(i18n.i18nString("node_unlocked"),"success")},function(error){NotificationService.notify(i18n.i18nString("failed_node_lock"),"error")})}function cancleUnlock(){}NotificationService.userConfirm(i18n.i18nString("unlock_term"),[confirmUnlock,cancleUnlock],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("confirm_unlock_name"))};var termsMap={};$scope.validateTermName=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression();return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,{test:function(value){return _selectedLanguage&&"en"!==_selectedLanguage?regexp2.test(value):regexp.test(value)}}}();var searchTermEle=$("#termsearchid");searchTermEle.bind("keydown",function(event){event.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&event.preventDefault()}).autocomplete({minLength:1,source:function(request,response){return $scope.triggeredFromSelect?void($scope.triggeredFromSelect=!1):void response($.map($.ui.autocomplete.filter($scope.ontologytreetaxonomy,$scope.pattern),function(item){var labelPathArray=termsMap[item.nodeId]&&termsMap[item.nodeId].path.split(" > ");labelPathArray[labelPathArray.length-1]="<span class='pathleafterm'>"+labelPathArray[labelPathArray.length-1]+"</span>";var lablePathString=labelPathArray.join(" > ");return{label:lablePathString,value:termsMap[item.nodeId]&&termsMap[item.nodeId].nodeIds}}))},focus:function(event,ui){event.preventDefault()},select:function(e,ui){return isFromSelect=!0,expandAndGotoSpecificNode(ui.item.value),!1},position:{collision:"flip"},open:function(event,ui){if($(".ui-autocomplete:visible").css({left:"+="+5*$scope.caretPos}),window.outerWidth-210<$(".ui-autocomplete:visible").offset().left){var _leftToReposition=$(".ui-autocomplete:visible").offset().left-(window.outerWidth-210)+10;$(".ui-autocomplete:visible").css({left:"-="+_leftToReposition})}}}).autocomplete("instance")._renderItem=function(ul,item){return $("<li>").append(item.label).appendTo(ul)},searchTermEle.autocomplete("widget").addClass("ontologysearchautocomplete"),$scope.callback.init=function(listData){if($scope.pdfAnnoData={},$scope.pdfAnnoData=listData,$scope.loaderFlag=!0,$scope.clearSearch(),countStart=1,$(".searchIconGray").removeClass("hide"),$(".synSearch").removeClass("searchExpand"),$scope.search.faq="","success"===listData.status){if($scope.qna.added=listData.qnaAddedCount,$scope.qna.notAdded=listData.qnaExtractedCount,$scope.qna.total=listData.qnaCount,$scope.callback.openedName=listData.name,$scope.knowledgeTasks&&0!==$scope.knowledgeTasks.length){var kgStatusConfigured=$scope.knowledgeTasks.filter(function(v){return"configured"===v.state})[0];$workflowService.taskEditInfo(kgStatusConfigured)}$scope.isKgExtOnto=!0,$timeout(function(){$scope.openType="btExtract",listData.hasOwnProperty("isVisited")&&!listData.isVisited&&BTStreamsService.kgExtractIsVisited($workflowService.selectedStream()._id,listData._id,{isVisited:"true"}).then(function(res){},function(err){});var updateExtractId=$interval(function(){$scope.callback.knowledgeQnA&&($scope.callback.knowledgeQnA(listData),$interval.cancel(updateExtractId))},100)})}else"inProgress"===listData.status?NotificationService.notify(i18n.i18nString("kg_extract_progress"),"error"):NotificationService.notify(i18n.i18nString("kg_request_failure"),"error");$scope.checkAddToFAQ()},$scope.annotateDocument=function(){$("#add-to-extraction-modal").modal("show")},$scope.closeAnnotateDocument=function(){$("#add-to-extraction-modal").modal("hide")},$scope.reAnnotateDocument=function(){$scope.pdfAnnoData&&"pdf"===$scope.pdfAnnoData.fileExtension?$scope.addedToKGFlag?($scope.pdfAnnoData.addedToKGFlag=!0,$scope.callback.goBackToAnnotool($scope.pdfAnnoData)):($("#add-to-extraction-modal").modal("hide"),$("#re-annotate-modal").modal("show")):NotificationService.notify("Only PDF documents","error")},$scope.closeReAnnotateDocument=function(){$("#re-annotate-modal").modal("hide")},$scope.createCopyModal=function(){$("#re-annotate-modal").modal("hide"),$("#create-copy-modal").modal("show"),$("#extract-name").focus()},$scope.createCopy=function(){$scope.callback.checkFileName($scope.pdfAnnoData.copyFileName)&&$scope.pdfAnnoData.copyFileName?($scope.pdfAnnoData.name=$scope.pdfAnnoData.copyFileName,$scope.pdfAnnoData.createCopy=!0,$scope.callback.goBackToAnnotool($scope.pdfAnnoData),$("#create-copy-modal").modal("hide")):$scope.pdfAnnoData.copyFileName||NotificationService.notify("Please enter extract name","error")},$scope.createCopyClose=function(){$("#create-copy-modal").modal("hide")},$scope.checkAddToFAQ=function(){0!==$scope.qna.added?$scope.addedToKGFlag=!1:0===$scope.qna.added&&($scope.addedToKGFlag=!0)},$scope.goBackFromOntoNew=function(){$scope.callback.goBackFromOntoNew(),$scope.extraction={},clearBuffer()},$scope.cb={showOntologyQAForm:$scope.showOntologyQAForm,hideOntologyQAForm:$scope.hideOntologyQAForm,showBotOntologyTermSettings:$scope.showBotOntologyTermSettings,hideBotOntologyTermSettings:$scope.hideBotOntologyTermSettings,updateOntology:$scope.updateOntology,ontologyClassModal:$scope.ontologyClassModal,updateFaqCollection:$scope.updateFaqCollection,getFaqsByKnowledge:$scope.getFaqsByKnowledge,getKTData:$scope.getKTData,exportOntology:$scope.exportOntology,getAndUpdateOntology:$scope.getAndUpdateOntology,cudOntologyNode:$scope.cudOntologyNode,isEditable:$scope.isEditable,prevResourceId:prevResourceId,isTermLocked:$scope.isTermLocked}}]),_kgOntoNewForm.filter("formatNameFilter",function(){return function(input){return input?input.replace(/&lt;/g,"<").replace(/&gt;/g,">"):void 0}}),_kgOntoNewForm.filter("shortenEllipsisString",function(){return function(input){return input?(input=input.trim().replace(/\n/g,"<br>"),input.length>110?input.slice(0,110)+"...":input):void 0}}),_kgOntoNewForm.filter("nextLineFilter",function(){return function(input){return input?input.trim().replace(/\n/g,"<br>"):void 0}})}(angular),function(ng){"use strict";var _module=ng.module("bt-streams");_module.directive("botLanguageManage",["$workflowService","_constants_","BTFileUploadService","BTStreamsService","$rootScope","_constants_","i18n","env_conf","accessControlService",function($workflowService,constants,BTFileUploadService,BTStreamsService,$rootScope,_constants_,i18n,env_conf,accessControlService){return{restrict:"EA",scope:{selectedLanguage:"=",selectedStream:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/language-settings/language-manage.html",controller:["$scope",function($scope){function writeAndDownloadDialog(filename,data){if(navigator.msSaveBlob){var blob=new Blob([data],{type:"data:text/plain;charset=utf-8"});return window.navigator.msSaveOrOpenBlob(blob,filename)}var element=document.createElement("a");element.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(data)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function loadTitles(){if($scope.openModalSlider("#languageManagement"),$scope.selectedStream={},$workflowService.selectedStream().translationEngine&&($scope.selectedStream.translationEngine=$workflowService.selectedStream().translationEngine),$workflowService.selectedStream().translationAPIKey&&($scope.selectedStream.translationAPIKey=$workflowService.selectedStream().translationAPIKey),$scope.nluLanguage="",$scope.previousNluLanguage="",$scope.selectedLanguage=$workflowService.selectedLanguage(),$scope.i18n.baseLanguage="",$workflowService.selectedStream().multiLingualConfigurations&&$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value]&&$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value].nluLanguage&&$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value].nluLanguage!==$scope.selectedLanguage.value?_.forEach($workflowService.seedData().supportedLanguages,function(eachLang){eachLang.value===$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value].nluLanguage?$scope.nluLanguage=eachLang:"ge"===$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value].nluLanguage&&($scope.nluLanguage={name:"Multilingual",value:"ge",dvalue:"ge"})}):$scope.nluLanguage=$scope.selectedLanguage,$scope.selectedLanguage.hasOwnProperty("enabled"))$scope.i18n.baseLanguage=_.find($scope.supportedLanguages,{value:$scope.selectedLanguage.hasOwnProperty("enabled")?$scope.selectedLanguage.value:selectedStream.defaultLanguage}),$scope.i18n.baseCopyLanguage=_.find($scope.supportedLanguages,{value:$scope.selectedLanguage.hasOwnProperty("enabled")?$scope.selectedLanguage.value:selectedStream.defaultLanguage}),$scope.i18n.baseAdvancedLanguage=_.find($scope.supportedLanguages,{value:$scope.selectedLanguage.hasOwnProperty("enabled")?$scope.selectedLanguage.value:selectedStream.defaultLanguage});else{$scope.i18n.enableLanguageType="defaultContent",$scope.i18n.baseLanguage="",$scope.i18n.baseCopyLanguage="",$scope.i18n.baseAdvancedLanguage="";var checkForNluLanguage=!1;_.forEach($scope.nluSupportedLanguages,function(lang){lang.value===$scope.selectedLanguage.value&&($scope.nluLanguage=lang,checkForNluLanguage=!0)}),checkForNluLanguage||($scope.nluLanguage={name:"Multilingual",value:"ge",dvalue:"ge"}),$scope.nluLanguage||($scope.nluLanguage={name:"MultiLingual",value:"ge",dvalue:"ge"})}$scope.i18n.enableUpdate=!1,$scope.selectedLanguage.hasOwnProperty("enabled")?($scope.manageLanguageTitle=i18n.i18nString("manageLanguageTitle_Enabled",{dyn:$scope.selectedLanguage.name}),$scope.manageLangugageNote=i18n.i18nString("manageLanguagenote_Enabled"),$scope.step1Title=i18n.i18nString("manageLanguagenote_Enabled_step1Title_label"),$scope.step1Description=i18n.i18nString("manageLanguagenote_Enabled_step1Title_desc"),$scope.step2Title=i18n.i18nString("manageLanguagenote_step2Title_label",{dyn:$scope.selectedLanguage.name}),$scope.step2Description=i18n.i18nString("step_2_Description",{dyn:$scope.selectedLanguage.name}),$scope.step3Title=i18n.i18nString("manageLanguagenote_Enabled_step3Title_label"),$scope.addEnableLangDefinition="Update Bot Language",$scope.addEnableNewLangDesc="Below language model will be used to train the bot",$scope.i18n.enableLanguageType="modifiedContent",$scope.i18n.updatedLanguageFileName=""):($scope.i18n.enableLanguageType="defaultContent",$scope.manageLanguageTitle=i18n.i18nString("manageLanguage_enable_desc",{dyn:$scope.selectedLanguage.name}),$scope.manageLangugageNote=i18n.i18nString("manageLanguagenote_notEnabled"),$scope.step1Title=i18n.i18nString("manageLanguagenote_notEnabled_step1Title_label"),$scope.step1Description=i18n.i18nString("manageLanguagenote_notEnabled_step1Title_desc"),$scope.step2Title=i18n.i18nString("manageLanguagenote_step2Title_label",{dyn:$scope.selectedLanguage.name}),$scope.step2Description=i18n.i18nString("step_2_Description",{dyn:$scope.selectedLanguage.name}),$scope.step3Title=i18n.i18nString("manageLanguagenote_Enabled_step3Title_label"),$scope.addEnableLangDefinition=i18n.i18nString("select_lang_definition"),$scope.addEnableNewLangDesc=i18n.i18nString("new_lang_enabled")),$scope.languageSettings={enableLanguageTitle:i18n.i18nString("manageLanguageTitle_Enabled",{dyn:$scope.selectedLanguage.name}),enableLanguageProtip:i18n.i18nString("enableLanguageProtip_desc",{dyn:$scope.selectedLanguage.name}),enableLanguageNote:i18n.i18nString("manageLanguagenote_notEnabled")},$scope.selectedTransitionEngine={},$scope.copyValues=[{title:"DIALOG AND ALERT TASKS",items:[{value:"definition",name:"Definition",selected:!0,read_only_one:1},{value:"training",name:"Training",selected:!1}]},{title:"KNOWLEDGE GRAPH",items:[{name:"FAQs & Answers",value:"faqs",selected:!1},{value:"ontology",name:"Ontology Structure",selected:!1}]},{title:"OTHERS",items:[{value:"smalltalk",name:"Small Talk",selected:!1},{value:"traits",name:"Traits",selected:!1}]}],$scope.multiLingual={},$workflowService.selectedStream()&&$workflowService.selectedStream().multiLingualConfigurations&&$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value]&&$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value].inputTranslation?$scope.multiLingual.inputTranslation=!0:$scope.multiLingual.inputTranslation=!1,$workflowService.selectedStream()&&$workflowService.selectedStream().multiLingualConfigurations&&$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value]&&$workflowService.selectedStream().multiLingualConfigurations[$scope.selectedLanguage.value].responseTranslation?$scope.multiLingual.responseTranslation=!0:$scope.multiLingual.responseTranslation=!1,$workflowService.selectedStream()&&$workflowService.selectedStream().preferredData&&_.forEach($scope.copyValues,function(copyValue){_.forEach(copyValue.items,function(item){_.forEach($workflowService.selectedStream().preferredData,function(data){data===item&&(item.selected=!0);
})})}),$scope.translationEngines=$workflowService.seedData().translationEngines||[{type:"google",displayName:"Google Translate"},{type:"microsoft",displayName:"Microsoft Translate"}],$scope.selectedTransitionEngine={},$scope.selectedTransitionEngine.translationEngine="google",$scope.getTransilationEngineName=function(key){var name="";return $.each($scope.translationEngines,function(i,engine){engine.type===key&&(name=engine.displayName)}),name},$scope.showInputTranslation=!1}function printResultWithTimeout(timeout,text){setTimeout(function(){$scope.importResults=text},timeout)}var selectedStream=$workflowService.selectedStream();$scope.stream=$workflowService.selectedStream(),$scope.rightClass="right700",$scope._constants_=_constants_,$scope.supportedLanguages=$workflowService.supportedLanguages(),$scope.nluSupportedLanguages=$workflowService.seedData().nluSupportedLanguages,$scope.searchLanguage={},$scope.searchLanguage.languageSearch="",$scope.lanuageSettingConstants=constants.languageSettings,$scope.selectedLanguage=$workflowService.selectedLanguage(),$scope.nluLanguage=$scope.selectedLanguage,$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.closeCross=window.appConfig.CONTEXT_PATH+"/assets/landingImages/closeCross.png",$scope.manualJSON=env_conf["context-url"]+"/assets/languages/manualJSON.png",$scope.i18n={},$scope.isWorkProgress=!1,$scope.isGlobalWorkProgress=!1,$scope.Enable=i18n.i18nString("Enable"),$scope.manage=i18n.i18nString("manage"),$scope.update=i18n.i18nString("update"),$scope.importing=i18n.i18nString("importing"),$scope.ok=i18n.i18nString("ok_uppercase"),$scope.chooseOptioni18n=i18n.i18nString("choose_an_option"),$scope.selecti18n=i18n.i18nString("select"),$scope.selectBaseLangi18n=i18n.i18nString("select_base_lang_pack"),$scope.i18n.enableLanguageType="modifiedContent",$scope.closeLanguageManageModal=function(){$(".language-manage").modal("hide")},$scope.scrollUpdate=function(){setTimeout(function(){$rootScope.$emit("pefectScrollUpdate")},1e3)},$scope.importing=!1,$scope.readLangaugeFile=function(){if($scope.importedDialogName=$scope.i18n.updatedLanguageFile.name,$scope.importedDialogName){var _ext=$scope.importedDialogName.substring($scope.importedDialogName.lastIndexOf("."));if(".json"!==_ext)return NotificationService.notify(i18n.i18nString("upload_json"),"error"),void($scope.fileExtensionError=!0);$scope.fileExtensionError=!1,$scope.dialogRequiredError=!1}var reader=new FileReader;reader.readAsText($scope.i18n.updatedLanguageFile),reader.onload=function(e){var data=reader.result;$scope.updatedLanguageJson=data,$scope.i18n.updatedLanguageFileName=$scope.i18n.updatedLanguageFile.name},$scope.i18n.enableUpdate=!0},$scope.downloadDefaultLanguage=function(){function startExport(){"defaultContent"===$scope.i18n.enableLanguageType&&($scope.i18n.baseLanguage=$scope.i18n.baseCopyLanguage),"advancedContent"===$scope.i18n.enableLanguageType&&($scope.i18n.baseLanguage=$scope.i18n.baseAdvancedLanguage),BTStreamsService.downloadDefaultLanguage(selectedStream._id,$scope.i18n.baseLanguage.value).then(function(res){writeAndDownloadDialog($scope.i18n.baseLanguage.name+".json",JSON.stringify(res.data))})["catch"](function(res){NotificationService.notify(i18n.i18nString("oops_label")+res.data.errors[0].msg,"error")})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("download")):startExport()},$scope.trainBot=function(){$scope.nlpPermission=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$broadcast("getProgressDockStatus"),NotificationService.notify(i18n.i18nString("bot_train"),"info")},function(err){"NO"!==$scope.nlpPermission&&(err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error"))})},$scope.updateLanguagePack=function(){function successCallback(res){res&&res.data&&res.data.multiLingualConfigurations&&($scope.multiLingual.inputTranslation=res.data.multiLingualConfigurations[$scope.selectedLanguage.value].inputTranslation,$scope.multiLingual.responseTranslation=res.data.multiLingualConfigurations[$scope.selectedLanguage.value].responseTranslation,$scope.nluLanguage.value=res.data.multiLingualConfigurations[$scope.selectedLanguage.value].nluLanguage),$workflowService.currentLanguage($scope.selectedLanguage.value),$scope.isWorkProgress=!1,$scope.importModalTitle="Inprogess",$scope.importModalDescription=i18n.i18nString("language_manage_import_json_des",{dyn:$scope.selectedLanguage.name}),angular.element("#language_import").modal("show"),$scope.importing=!0,printResultWithTimeout(100,"Analyzing file . . . \n\n"),printResultWithTimeout(1e3,"Analyzing file . . . \n\n"+res.data.dialogs+" dialogs, "+res.data.alerts+" alerts, "+res.data.actions+" actions, "+res.data.panels+" panels, "+res.data.widgets+" widgets and "+(res.data.forms||0)+" forms found"),printResultWithTimeout(1350,"Analyzing file . . . \n\n"+res.data.dialogs+" dialogs, "+res.data.alerts+" alerts, "+res.data.actions+" actions, "+res.data.panels+" panels, "+res.data.widgets+" widgets and "+(res.data.forms||0)+" forms found \n\nChecking data integrity . . ."),printResultWithTimeout(3e3,"Analyzing file . . . \n\n"+res.data.dialogs+" dialogs, "+res.data.alerts+" alerts, "+res.data.actions+" actions, "+res.data.panels+" panels, "+res.data.widgets+" widgets and "+(res.data.forms||0)+" forms found \n\nChecking data integrity . . .\n\nNo issues found.\n\n"+$scope.selectedLanguage.name+" pack is imported successfully"),$scope.importModalTitle="successful",setTimeout(function(){$scope.importing=!1,$scope.importModalTitle="successful"},3200)}function errorCallback(res){$scope.isWorkProgress=!1,$scope.importModalTitle=i18n.i18nString("failed"),$scope.importModalDescription=i18n.i18nString("language_manage_err_modal_desc",{dyn:$scope.selectedLanguage.name}),$scope.importResults="Analyzing file . . . \n\nError encountered: "+res.data.errors[0].msg+".\n\nImport cancelled.",angular.element("#language_import").modal("show")}if($scope.isWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("importing"),$scope.showNotification(),"defaultContent"===$scope.i18n.enableLanguageType||"advancedContent"===$scope.i18n.enableLanguageType){var array=[];_.forEach($scope.copyValues,function(copyValue){_.forEach(copyValue.items,function(item){item.selected&&array.push(item.value)})});var payload={};"defaultContent"===$scope.i18n.enableLanguageType?payload={baseLanguage:$scope.i18n.baseCopyLanguage.value}:"advancedContent"===$scope.i18n.enableLanguageType&&(payload={preferredData:array,baseLanguage:$scope.i18n.baseAdvancedLanguage.value}),payload.multiLingualConfigurations={},payload.multiLingualConfigurations[$scope.selectedLanguage.value]={nluLanguage:$scope.nluLanguage.value,inputTranslation:$scope.multiLingual.inputTranslation,responseTranslation:$scope.multiLingual.responseTranslation},BTStreamsService.addSupportedLanguage(selectedStream._id,$scope.selectedLanguage.value,payload).then(function(res){res&&res.data&&res.data.multiLingualConfigurations&&($scope.multiLingual.inputTranslation=res.data.multiLingualConfigurations[$scope.selectedLanguage.value].inputTranslation,$scope.multiLingual.responseTranslation=res.data.multiLingualConfigurations[$scope.selectedLanguage.value].responseTranslation,$scope.nluLanguage.value=res.data.multiLingualConfigurations[$scope.selectedLanguage.value].nluLanguage),"defaultContent"===$scope.i18n.enableLanguageType&&res.data.baseLanguage?$scope.i18n.baseCopyLanguage.value=res.data.baseLanguage:"advancedContent"===$scope.i18n.enableLanguageType&&res.data.baseLanguage&&($scope.i18n.baseAdvancedLanguage.value=res.data.baseLanguage,_.forEach($scope.copyValues,function(copyValue){_.forEach(copyValue.items,function(item){res.data.preferredData&&res.data.preferredData.length&&_.forEach(res.data.preferredData,function(data){data===item&&(item.selected=!0)})})}));var _msg=i18n.i18nString("language_manage_lang_enabled_sucess_noty",{dyn1:$scope.selectedLanguage.name,dyn2:selectedStream.name});$scope.selectedLanguage.configure=!1,NotificationService.notify(_msg,"success"),setTimeout(function(){$scope.finishImporting()},1e3)})["catch"](function(res){var _msg=i18n.i18nString("language_manage_enable_lang_err",{dyn:$scope.selectedLanguage.name});NotificationService.notify(_msg,"error"),$scope.showStatusLoader=!1})}else{var languageJson={};languageJson.multiLingualConfigurations={},languageJson.multiLingualConfigurations[$scope.selectedLanguage.value]={nluLanguage:$scope.nluLanguage.value,inputTranslation:$scope.multiLingual.inputTranslation,responseTranslation:$scope.multiLingual.responseTranslation},$scope.updatedLanguageJson?(languageJson=JSON.parse($scope.updatedLanguageJson),languageJson.multiLingualConfigurations={},languageJson.multiLingualConfigurations[$scope.selectedLanguage.value]={nluLanguage:$scope.nluLanguage.value,inputTranslation:$scope.multiLingual.inputTranslation,responseTranslation:$scope.multiLingual.responseTranslation},BTStreamsService.updateLanguageJson(selectedStream._id,$scope.selectedLanguage.value,languageJson).then(successCallback)["catch"](errorCallback)):BTStreamsService.editStream($workflowService.selectedStream()._id,languageJson).then(function(res){$workflowService.selectedStream(res.data),NotificationService.notify(i18n.i18nString("manage_translations_update"),"success"),$scope.closeModalSlider("#languageManagement")},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})}$scope.nluLanguage.value!==$scope.previousNluLanguage.value&&$scope.trainBot()},$scope.finishImporting=function(){angular.element("#uploadLanguageFile").val(""),$("#language_import").modal("hide"),$scope.i18n.updatedLanguageFile=void 0,$scope.i18n.updatedLanguageFileName="",$("#languageMangaeModal").modal("hide"),$("body").removeClass("bt-modal-open"),$scope.$emit("loadBots",selectedStream)},$scope.cancelLanguageManage=function(){angular.element("#uploadLanguageFile").val(""),$scope.i18n.updatedLanguageFile=void 0,$scope.i18n.updatedLanguageFileName="",$("#languageMangaeModal").modal("hide")},$scope.showNotification=function(translator){if("microsoft"===$scope.selectedStream.translationEngine){var microsoftTranslator=["eu","be","ceb","co","eo","fy","gl","ha","haw","ig","jv","rw","la","lb","ny","gd","st","sn","si","so","su","tg","wo","xh","yi","yo","zu"],microsoftTrans=!1;_.forEach(microsoftTranslator,function(value){$scope.selectedLanguage.value===value&&(microsoftTrans=!0)}),microsoftTrans&&(translator?$scope.multiLingual.inputTranslation=!1:NotificationService.notify("The "+$scope.selectedLanguage.name+","+$scope.selectedLanguage.value+" is not supported by the "+$scope.getTransilationEngineName($scope.selectedStream.translationEngine),"warning"))}else if("google"===$scope.selectedStream.translationEngine){var googleTranslator=["as","la","bo","wo"],googleTrans=!1;_.forEach(googleTranslator,function(value){$scope.selectedLanguage.value===value&&(googleTrans=!0)}),googleTrans&&(translator?$scope.multiLingual.inputTranslation=!1:NotificationService.notify("The "+$scope.selectedLanguage.name+","+$scope.selectedLanguage.value+" is not supported by the "+$scope.getTransilationEngineName($scope.selectedStream.translationEngine),"warning"))}},$scope.openInputTranslation=function(){$scope.showInputTranslation=!0},$scope.closeLanguageTranslationEngine=function(){$scope.selectedStream&&$scope.selectedStream.translationEngine?$scope.selectedTransitionEngine={translationEngine:$scope.selectedStream.translationEngine,translationAPIKey:$scope.selectedStream.translationAPIKey}:$scope.selectedTransitionEngine.translationEngine="google",$scope.showInputTranslation=!1},$scope.enableUpdateButton=function(){$scope.i18n.enableUpdate=!0},$scope.configureTransitionEngine=function(){var payload={translationEngine:$scope.selectedTransitionEngine.translationEngine,translationAPIKey:$scope.selectedTransitionEngine.translationAPIKey};return $scope.selectedTransitionEngine.translationEngine&&$scope.selectedTransitionEngine.translationAPIKey?void BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){$scope.selectedStream=res.data,$scope.test=res.data,NotificationService.notify("Translation Configurations updated successfully","success"),$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),res.data)),$scope.closeLanguageTranslationEngine()},function(res){NotificationService.notify(res.data.errors[0].msg,"error")}):void NotificationService.notify("Fields are required","error")},$scope.selectConfigBaseLanguage=function(language){$scope.i18n.baseLanguage=_.find($scope.supportedLanguages,{value:language.hasOwnProperty("enabled")?language.value:selectedStream.defaultLanguage})},$scope.selectCopyConfigBaseLanguage=function(language){$scope.i18n.baseCopyLanguage=_.find($scope.supportedLanguages,{value:language.hasOwnProperty("enabled")?language.value:selectedStream.defaultLanguage})},$scope.selectAdvancedConfigBaseLanguage=function(language){$scope.i18n.baseAdvancedLanguage=_.find($scope.supportedLanguages,{value:language.hasOwnProperty("enabled")?language.value:selectedStream.defaultLanguage})},$scope.addNluLanguage=function(nluLanguage){$scope.previousNluLanguage=$scope.nluLanguage,$scope.nluLanguage=nluLanguage,$scope.nluLanguage.value===$scope.previousNluLanguage.value||$scope.selectedLanguage.configure||($scope.i18n.enableUpdate=!1,"ge"!==$scope.nluLanguage.value&&"ge"!==$scope.previousNluLanguage.value?($scope.multiLingual.inputTranslation=!0,$scope.changeNluLanguageDescription="You have changed the NLU model from "+$scope.previousNluLanguage.name+" to "+$scope.nluLanguage.name+". If you have previously trained the assistant with "+$scope.previousNluLanguage.name+" training data, then make sure to replace it with corresponding training data in "+$scope.nluLanguage.name+"."):"ge"===$scope.nluLanguage.value?($scope.multiLingual.inputTranslation=!1,$scope.changeNluLanguageDescription="You have changed the NLU model from "+$scope.previousNluLanguage.name+" to Multilingual. You can continue to train the assistant in the "+$scope.previousNluLanguage.name+" language or any other language supported by the multilingual NLU model."):"ge"===$scope.previousNluLanguage.value&&($scope.changeNluLanguageDescription="You have changed the NLU model from Multilingual to "+$scope.nluLanguage.name+". If you have previously trained the assistant with "+$scope.nluLanguage.name+" training data, you can continue to use it without any changes. If you have trained using any other language,  then make sure to replace it with corresponding training data in "+$scope.nluLanguage.name+"."),$("#changeNluLanguage").modal("show")),$scope.nluLanguage.value!==$scope.previousNluLanguage.value&&$scope.selectedLanguage.configure&&("ge"!==$scope.nluLanguage.value&&$scope.selectedLanguage.value!==$scope.nluLanguage.value?$scope.multiLingual.inputTranslation=!0:"ge"===$scope.nluLanguage.value&&($scope.multiLingual.inputTranslation=!1)),$scope.i18n.enableUpdate=!0,$scope.searchLanguage.languageSearch="",$scope.showNotification("fromTranslator")},$scope.hideLanguageDropdown=function(e){setTimeout(function(){$scope.searchLanguage.languageSearch=""})},$scope.changeNluLanguageModal=function(){$scope.nluLanguage=$scope.previousNluLanguage,$("#changeNluLanguage").modal("hide"),$scope.i18n.enableUpdate=!1},$scope.$on("loadTitles",loadTitles)}]}}])}(angular),function(ng){"use strict";ng.module("bt-forms").directive("languageSettings",function(){return{restrict:"EA",scope:{callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/language-settings/language-settings-form.html",controller:["$scope","$workflowService","$rootScope","BTStreamsService","accessControlService","$timeout","i18n","env_conf","$element","$sce","jsEvents",function($scope,$workflowService,$rootScope,BTStreamsService,accessControlService,$timeout,i18n,env_conf,$element,$sce,jsEvents){function checkLockedTasks(){var i,locked=!1;if($scope.flowtasks)for(i=0;i<$scope.flowtasks.length;i++)if(!$scope.flowtasks[i].editable){locked=!0;break}if($scope.alerts)for(i=0;i<$scope.alerts.length;i++)if(!$scope.alerts[i].editable){locked=!0;break}if($scope.actions)for(i=0;i<$scope.actions.length;i++)if(!$scope.actions[i].editable){locked=!0;break}if($scope.knowledgeTasks)for(i=0;i<$scope.knowledgeTasks.length;i++)if(!$scope.knowledgeTasks[i].editable){locked=!0;break}if($scope.reports)for(i=0;i<$scope.reports.length;i++)if(!$scope.reports[i].editable){locked=!0;break}if($scope.mappings)for(i=0;i<$scope.mappings.length;i++)if(!$scope.mappings[i].editable){locked=!0;break}return locked=selectedStream.sbStreamId?selectedStream.allowInheritance:!1}function confirmEnableLanguage(){$workflowService.selectedLanguage($scope.currTryingaLanguage),$scope.selectedLanguage=$scope.currTryingaLanguage,$scope.$broadcast("loadTitles")}function confirmToggleLanguage(){$scope.selectedLan.enabled?$element.find("#enableConfirmation").removeClass("fade").addClass("show"):BTStreamsService.reEnableLanguage(selectedStream._id,$scope.selectedLan.value).then(function(response){response&&($scope.selectedLan.enabled=!$scope.selectedLan.enabled,$workflowService.selectedStream(response.data),NotificationService.notify(i18n.i18nString("selected_language_enabled_success"),"success"))},function(err){err&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong","error")})}function onSliderChangedProxy(mode,val){$(mode);switch(mode){case"#execution-slider":if($scope.execCount=val,void 0===val)try{$scope.execCount=Math.round($($("#languageCount-slider .slider-handle")[0]).attr("aria-valuenow"))}catch(e){$scope.execCount=1}$scope.updateLanguageSettings()}}function registerSlider(ele,obj){var slider=$(ele).bootstrapSlider(obj);return $(ele).slider().on("slideStop ",function(ev){onSliderChanged(ele,ev.value)}),$(ele).slider().on("slide",function(ev){formatTooltip(ele,ev.value)}),slider}function deRegisterSlider(ele){$(ele).slider().off("slideStop"),$(ele).slider().off("slide")}function formatTooltip(mode,val){switch(mode){case"#execution-slider":$("#languageCount-slider").find(".tooltip-inner").text(val)}}function confirmMarkDefault(){BTStreamsService.defaultLanguage(selectedStream._id,$scope.selectedLan.value).then(function(response){if(response){var _defaultLanName=_.filter($scope.languages,{value:$scope.defaultLanguage})[0].name;NotificationService.notify("Default Language is changed from "+_defaultLanName+" to "+language.name,"success"),$workflowService.selectedStream(response.data),$scope.defaultLanguage=language.value}})}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.languageSetting={};var selectedStream=$workflowService.selectedStream();$scope.selectedStreamState=$workflowService.selectedStreamState(),$scope.selectedStream=selectedStream,$scope.default_language_label=i18n.i18nString("default_lang"),$scope.manage=i18n.i18nString("manage"),$scope.Enable=i18n.i18nString("Enable");var searchQuery=$workflowService.storeSearchQry();$scope.enabled=i18n.i18nString("enabled"),$scope.disabled=i18n.i18nString("disabled"),$scope.assetsBase=env_conf["assets-url"],$scope.authorizationCallback={onlyCreate:!0},$scope.languageSetting.selectionLogic="perSession",$scope.loadingLanguage=!1,$scope.showLanguageSearch=!1,$scope.languageSearchQuery="",$scope.rightClass="right550",$scope.languageLogicLabels={lifeTime:"Lifetime",perSession:"Per Session",perVolley:"Every User Message"},$scope.execCount=1;var s8;$scope.betaIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/betaIcon.svg",$scope.translationIcons={google:window.appConfig.CONTEXT_PATH+"/assets/languages/googleIcon.svg",microsoft:window.appConfig.CONTEXT_PATH+"/assets/languages/microsoftIcon.svg"},$scope.selectedTransitionEngine={},$scope.selectedTransitionEngine.translationEngine="google",$workflowService.selectedStream().translationEngine&&($scope.selectedStream.translationEngine=$workflowService.selectedStream().translationEngine,$scope.selectedTransitionEngine.translationEngine=$scope.selectedStream.translationEngine),$workflowService.selectedStream().translationAPIKey&&($scope.selectedStream.translationAPIKey=$workflowService.selectedStream().translationAPIKey,$scope.selectedTransitionEngine.translationAPIKey=$scope.selectedStream.translationAPIKey),$scope.genericLanguage={value:$scope.selectedStream.defaultLanguageForGe,enabled:!1},$scope.languageForInputTranslation=$scope.selectedStream.languageForInputTranslation,$scope.enableInputTranslation=$scope.selectedStream.enableInputTranslation,$(".innerRight").scrollTop(1),$scope.callback.loadLanguageConfigurations=function(){$scope.loadingLanguage=!0,BTStreamsService.getBTStream(selectedStream._id).then(function(response){response.data.languagePreferences&&($scope.languageSetting.selectionLogic=selectedStream.languagePreferences.type),$workflowService.selectedStream(response.data),$scope.selectedStream=$workflowService.selectedStream();var availableLanguages=angular.copy($workflowService.seedData().supportedLanguages),configuredLanguages={};"indevelopment"===$workflowService.selectedStreamState()?(configuredLanguages=response.data.languageConfigurations?response.data.languageConfigurations:response.data.supportedLanguages,$scope.languages=_.map(availableLanguages,function(lan){return lan&&"ge"===lan.value&&configuredLanguages[lan.value]&&configuredLanguages[lan.value].enabled&&($scope.genericLanguage.enabled=!0),configuredLanguages&&configuredLanguages[lan.value]&&configuredLanguages[lan.value].hasOwnProperty("enabled")?(lan.enabled=configuredLanguages[lan.value].enabled,lan.configure=!1):lan.configure=!0,lan})):"published"===$workflowService.selectedStreamState()&&($scope.taskApprovedLanguages=response.data.taskApprovedLanguages,$scope.taskDisabledLanguages=response.data.publishedDisabledLangs,$scope.languages=_.map(availableLanguages,function(lan){return $scope.taskApprovedLanguages&&-1!==$scope.taskApprovedLanguages.indexOf(lan.value)?(lan.enabled=!0,lan.configure=!1):$scope.taskDisabledLanguages&&-1!==$scope.taskDisabledLanguages.indexOf(lan.value)?(lan.enabled=!1,lan.configure=!1):lan.configure=!0,lan&&"ge"===lan.value&&lan.enabled&&($scope.genericLanguage.enabled=lan.enabled),lan})),$scope.defaultLanguage=response.data.defaultLanguage,$timeout(function(){$scope.loadingLanguage=!1},300)},function(err){$scope.loadingLanguage=!1})},$scope.toggleTarget=function(target){$scope.getallTranslationEngine(),$(target).click()},$scope.updateHeight=function(){setTimeout(function(){$("#rightPanelScrollContents").trigger("resize")},300)},$scope.enabledLanguages=function(){var enabledLanguages=_.filter($scope.languages,function(lan){return lan.configure||"ge"===lan.value?void 0:!0});return enabledLanguages&&enabledLanguages.length?enabledLanguages.length:void 0},$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.standardLanguages=window.appConfig.CONTEXT_PATH+"/assets/languages/standard-languages.svg",$scope.advancedLanguageSettings=window.appConfig.CONTEXT_PATH+"/assets/languages/advanced-language-settings.svg",$scope.translationConfigurations=window.appConfig.CONTEXT_PATH+"/assets/languages/translation-configurations.svg",$scope.languageSelectionLogic=window.appConfig.CONTEXT_PATH+"/assets/languages/language-selection-logic.svg",$scope.languageSetting.jsEditorValue="if (!context.UserContext.preffLanguage) {\n\n/*\n\nWe recommend that you do not edit the IF statement above. If you do, the save will fail.\n\nAt the end of this script, you must be able to set the value for context.UserContext.preffLanguage to one of the supported language codes like EN, ES, DE or FR\n\n*/\n\n\n// Your code on how to detect and set the language context goes here.\n\n}",$scope.translationEngines=$workflowService.cloneData($workflowService.seedData().translationEngines)||[{type:"google",displayName:"Google Translate"},{type:"microsoft",displayName:"Microsoft Translate"}],$scope.translationEngine={type:"notranslation",selectedEngine:{},defaultEngines:{},customTranslators:[]},$scope.addEditCustomTranslatorModal=function(method,engine){if("show"===method){var url="/builderx/connect-api/translationengine/"+$scope.selectedStream._id;engine&&engine._id&&(url=url+"/"+engine._id),window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.translationengineUrl=$sce.trustAsResourceUrl("http://localhost:4200"+url):$scope.translationengineUrl=window.appConfig.API_SERVER_URL+url,$("#customTranslatorEngineConfigModal").modal("show")}else $("#customTranslatorEngineConfigModal").modal("hide"),$scope.translationengineUrl=null},$scope.onengineChange=function(engine){!engine||engine&&"ustom"===engine.type?$scope.translationEngine.selectedEngine={}:engine&&($scope.translationEngine.selectedEngine=engine)},$scope.addEditCustomTranslator=function(){var type=$scope.translationEngine.selectedEngine.subType||$scope.translationEngine.selectedEngine.type,payload={type:"standard"};$scope.translationEngine.defaultEngines[type]&&($scope.translationEngine.defaultEngines[type].seedData?(payload.name=$scope.translationEngine.defaultEngines[type].displayName,payload.subType=type,payload.apiKey=$scope.translationEngine.defaultEngines[type].apiKey,$scope.createTranslationEngine(type,payload)):(payload.name=$scope.translationEngine.defaultEngines[type].displayName,payload.subType=type,payload.apiKey=$scope.translationEngine.defaultEngines[type].apiKey,$scope.editTranslationEngine($scope.translationEngine.defaultEngines[type]._id,payload,type)))},$scope.createTranslationEngine=function(engineid,payload){BTStreamsService.createtranslationEngine($workflowService.selectedStream()._id,payload).then(function(res){$scope.saveSelectedEngine(res.data._id)},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.editTranslationEngine=function(engineid,payload,type){BTStreamsService.editTranslationEngine($workflowService.selectedStream()._id,engineid,payload).then(function(res){$scope.saveSelectedEngine(engineid)},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.saveSelectedEngine=function(engineid){var payload={translationEngineId:engineid||""};BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){$scope.selectedStream=res.data,NotificationService.notify("Translation Configurations updated successfully","success"),$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),res.data))},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.saveTranslationToStream=function(engineid){var payload={translationEngineId:""};if("notranslation"===$scope.translationEngine.type)return void $scope.saveSelectedEngine();var type=$scope.translationEngine.selectedEngine.subType||$scope.translationEngine.selectedEngine.type;if($scope.translationEngine.defaultEngines[type]){if(engineid=type,!$scope.translationEngine.defaultEngines[type].apiKey)return NotificationService.notify("Please provide Access Key","error"),!1}else if("custom"===type&&(engineid=$scope.translationEngine.selectedEngine._id,!$scope.translationEngine.selectedEngine._id))return NotificationService.notify("Please select/crreate custom translation ","error"),!1;payload.translationEngineId=engineid,$scope.translationEngine.defaultEngines[type]?$scope.addEditCustomTranslator():$scope.saveSelectedEngine(engineid)},$scope.getallTranslationEngine=function(engine){$scope.translationEngine={type:$scope.translationEngine.type||"notranslation",selectedEngine:engine||{},defaultEngines:{},customTranslators:[]},$scope.translationEngines=$workflowService.cloneData($workflowService.seedData().translationEngines),$.each($scope.translationEngines,function(i,engine){engine.seedData=!0,$scope.translationEngine.defaultEngines[engine.type]=engine}),BTStreamsService.allTranslationengines($scope.selectedStream._id).then(function(res){$.each(res.data,function(i,val){val&&"custom"===val.type?($scope.translationEngine.customTranslators.push(val),val._id===$workflowService.selectedStream().translationEngineId&&($scope.translationEngine.selectedEngine=val,$scope.translationEngine.type=val.type)):"standard"===val.type&&(val.subType||(val.name.includes("Google")&&(val.subType="google"),val.name.includes("Microsoft")&&(val.subType="microsoft")),$scope.translationEngine.defaultEngines[val.subType]=val,(val.subType&&val.subType===$workflowService.selectedStream().translationEngineId||val._id&&val._id===$workflowService.selectedStream().translationEngineId)&&($scope.translationEngine.selectedEngine=val,$scope.translationEngine.type=val.subType))})},function(err){NotificationService.notify(i18n.i18nString("failed_enable_noty"),"error")})},$scope.getallTranslationEngine(),$scope.getStream=function(engine,ignoreGetCall){BTStreamsService.getBTStream(selectedStream._id).then(function(response){$workflowService.selectedStream(response.data),$scope.selectedStream=$workflowService.selectedStream(),ignoreGetCall||$scope.getallTranslationEngine(engine),$scope.addEditCustomTranslatorModal("hide")},function(error){$scope.getallTranslationEngine()})};var eventtranslationEngine=$rootScope.$on("translationEngineEvent",function(e,data){switch(data.action){case"createNewAuth":$scope.showAuth();break;case"closeEngine":data.payload&&data.payload._id?$scope.getStream(data.payload):($scope.getStream(null,!0),$scope.getallTranslationEngine(),$scope.addEditCustomTranslatorModal("hide"))}});$scope.getTransilationEngineName=function(key){var name="";return $.each($scope.translationEngines,function(i,engine){engine.type===key&&(name=engine.displayName)}),name},$scope.authorizationCallback.onModalClose=function(){jsEvents.postMessageToChildIframes("closeAuthForm","#translationEngineEvent",{})},$scope.getLanguageConfiguration=function(){return $scope.selectedStream.enableInputTranslation||$scope.genericLanguage.enabled?$scope.genericLanguage.enabled?"Generic Language":$scope.selectedStream.enableInputTranslation?"Auto-Translation":"Not Configured":"Not Configured"},$scope.getlanguageName=function(language){var name="";return $.each($scope.languages,function(i,lan){lan.value===language&&(name=lan.name)}),name},$scope.addLangForUniversalBot=function(){var language=$scope.currTryingaLanguage;BTStreamsService.addSupportedLanguage(selectedStream._id,language.value).then(function(res){NotificationService.notify(i18n.i18nString("universalBot_enabling_lang_success",{languageName:language.name}),"success"),$scope.$emit("loadBots",selectedStream)},function(err){NotificationService.notify(i18n.i18nString("failed_enable_noty"),"error")})},$scope.closeLangMsgUniversalbot=function(){$("#langEnableModalUniversalBot").modal("hide"),$scope.$emit("loadBots",selectedStream)},$scope.showAuth=function(){$scope.authorizationCallback.showAuth()},$scope.manageLanguage=function(e,language){e&&e.stopPropagation(),$scope.currTryingaLanguage=language,checkLockedTasks()?NotificationService.confirmDialog((language.enabled?i18n.i18nString("updating_label"):i18n.i18nString("enabling_additional"))+i18n.i18nString("language_unlock"),confirmEnableLanguage,{okText:i18n.i18nString("continue"),cancelText:i18n.i18nString("cancel"),language:language}):($workflowService.selectedLanguage(language),$scope.selectedLanguage=language,$scope.$broadcast("loadTitles"));
},searchQuery&&"openInputTranslation"===searchQuery.searchQry&&($scope.supportedLanguages=$workflowService.seedData().supportedLanguages,$scope.defaultLanguage=$workflowService.currentLanguage(),_.forEach($scope.supportedLanguages,function(eachLang){eachLang.value===$scope.defaultLanguage&&($scope.selectedDefaultLanguage=eachLang,$scope.selectedDefaultLanguage.enabled=!0)}),setTimeout(function(){$scope.manageLanguage(null,$scope.selectedDefaultLanguage)},500),$workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:""})),$scope.updateLanguageSettings=function(e){"perSession"===$scope.languageSetting.selectionLogic?($scope.showSlider=!0,$scope.showLifetimeSlider=!1):"lifeTime"===$scope.languageSetting.selectionLogic&&($scope.showSlider=!1,$scope.showLifetimeSlider=!0),setTimeout(function(){$rootScope.$broadcast("savelanguageSettings",{type:$scope.languageSetting.selectionLogic,setLangOnCnt:$scope.execCount||1}),$scope.$emit("savingInprogress",!0)},200)},$scope.$on("updateLanguageSettings",function(evt){$scope.updateLanguageSettings()}),$scope.$emit("nestedComponentLoaded",{id:"languageManagement",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.toggleLanguage=function(e,language){e.preventDefault(),e.stopPropagation(),language.value===$scope.defaultLanguage?NotificationService.notify(i18n.i18nString("default_language_cannot_dsabled"),"error"):checkLockedTasks()?($scope.selectedLan=language,NotificationService.confirmDialog((language.enabled?i18n.i18nString("updating_label"):i18n.i18nString("enabling_additional"))+i18n.i18nString("language_unlock"),confirmToggleLanguage,{okText:i18n.i18nString("continue"),cancelText:i18n.i18nString("cancel"),language:language})):language.enabled?($element.find("#enableConfirmation").removeClass("fade").addClass("show"),$scope.selectedLan=language):BTStreamsService.reEnableLanguage(selectedStream._id,language.value).then(function(response){response&&(language.enabled=!language.enabled,NotificationService.notify(i18n.i18nString("selected_language_enabled_success"),"success"),$workflowService.selectedStream(response.data),$scope.callback.updateSupportedLanguage())},function(err){err&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong","error")})},$scope.configureTransitionEngine=function(){var payload={translationEngine:$scope.selectedTransitionEngine.translationEngine,translationAPIKey:$scope.selectedTransitionEngine.translationAPIKey};return $scope.selectedTransitionEngine.translationEngine&&$scope.selectedTransitionEngine.translationAPIKey?void BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){$scope.selectedStream=res.data,NotificationService.notify("Translation Configurations updated successfully","success"),$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),res.data)),$scope.closeLanguageTranslationEngine()},function(res){NotificationService.notify(res.data.errors[0].msg,"error")}):void NotificationService.notify("Fields are required","error")},$scope.configureGenericLanguage=function(){$("#languageSettingsLogic").modal("show");var payload={defaultLanguageForGe:$scope.genericLanguage.value};BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){$scope.selectedStream=res.data,NotificationService.notify("Configurations updated successfully","success"),$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),res.data)),$scope.enableGenericLanguage()},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.updateSelectionToPerSession=function(){$("#languageSettingsLogic").modal("hide"),$scope.languageSetting.selectionLogic="perSession",$scope.updateLanguageSettings()},$scope.updateInputLanguageLanguage=function(){$scope.enableInputTranslation?("perVolley"===$scope.languageSetting.selectionLogic&&$scope.openEnableUserMsgPopup(),$scope.enableInputTranslationLanguage()):$scope.disableInputTranslationLanguage()},$scope.updateInputAutoTranslateLanguage=function(lan){var payload={languageForInputTranslation:lan};BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){$scope.selectedStream=res.data,NotificationService.notify("Auto translation updated successfully","success"),$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),res.data)),$scope.genericLanguage.enabled&&$scope.disableGenericLanguage()},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.updateGenericLanguage=function(){$scope.genericLanguage.enabled?("perVolley"===$scope.languageSetting.selectionLogic&&$scope.openEnableUserMsgPopup(),$scope.enableGenericLanguage()):$scope.disableGenericLanguage()},$scope.disableInputTranslationLanguage=function(ignoreNotification){var payload={enableInputTranslation:!1};BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){$scope.selectedStream=res.data,ignoreNotification||NotificationService.notify("Auto translation disabled successfully","success"),$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),res.data))},function(res){ignoreNotification||NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.redirectToLink=function(link,event){event.stopPropagation(),event.stopImmediatePropagation(),event.preventDefault(),$rootScope.redirectToLink(link,event)},$scope.enableInputTranslationLanguage=function(){var payload={enableInputTranslation:!0,languageForInputTranslation:$workflowService.selectedStream().languageForInputTranslation||$scope.defaultLanguage};BTStreamsService.editStream($workflowService.selectedStream()._id,payload).then(function(res){$scope.selectedStream=res.data,NotificationService.notify("Auto translation enabled successfully","success"),$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),res.data)),$scope.genericLanguage.enabled&&$scope.disableGenericLanguage()},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.updateLanguageAcrossBot=function(){$scope.callback&&$scope.callback.updateSupportedLanguage&&$scope.callback.updateSupportedLanguage()},$scope.disableGenericLanguage=function(){BTStreamsService.disableLanguage(selectedStream._id,"ge").then(function(response){response&&($scope.selectedStream=response.data,$scope.genericLanguage.enabled=!1,$workflowService.selectedStream(response.data),NotificationService.notify("Generic language disabled","success"),$scope.callback.updateSupportedLanguage())},function(err){})},$scope.enableGenericLanguage=function(){var geConfigured=!1;$.each($scope.languages,function(i,lan){lan.configure||"ge"!==lan.value||(geConfigured=!0)}),geConfigured?BTStreamsService.reEnableLanguage($workflowService.selectedStream()._id,"ge").then(function(res){var geIndex=-1;$.each($scope.languages,function(i,lan){"ge"===lan.value&&(geIndex=i)}),geIndex>-1&&($scope.languages[geIndex].configure=!1),NotificationService.notify("Generic language enabled","success"),$scope.closeConfigureGenericLanguageTranslation(),$scope.genericLanguage.enabled=!0;var streamData=$workflowService.selectedStream();streamData.languageConfigurations&&(streamData.languageConfigurations.ge={enabled:!0}),$workflowService.selectedStream(streamData),$scope.updateLanguageAcrossBot(),$scope.enableInputTranslation&&$scope.disableInputTranslationLanguage(!0)})["catch"](function(res){NotificationService.notify(res.data.errors[0].msg,"error")}):BTStreamsService.addSupportedLanguage($workflowService.selectedStream()._id,"ge").then(function(res){var geIndex=-1;$.each($scope.languages,function(i,lan){"ge"===lan.value&&(geIndex=i)}),geIndex>-1&&($scope.languages[geIndex].configure=!1),NotificationService.notify("Generic language enabled","success"),$scope.closeConfigureGenericLanguageTranslation(),$scope.genericLanguage.enabled=!0;var streamData=$workflowService.selectedStream();streamData.languageConfigurations&&(streamData.languageConfigurations.ge={enabled:!0}),$workflowService.selectedStream(streamData),$scope.updateLanguageAcrossBot(),$scope.enableInputTranslation&&$scope.disableInputTranslationLanguage(!0)})["catch"](function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.closeConfigureGenericLanguageTranslation=function(){$scope.genericLanguage.value=$scope.selectedStream.defaultLanguageForGe,$scope.closeModalSlider("#configureGenericLanguageTranslation")},$scope.openConfigureGenericLanguageTranslation=function(){$scope.genericLanguage.value=$scope.selectedStream.defaultLanguageForGe,$scope.openModalSlider("#configureGenericLanguageTranslation")},$scope.closeLanguageTranslationEngine=function(){$scope.selectedTransitionEngine={translationEngine:$scope.selectedStream.translationEngine,translationAPIKey:$scope.selectedStream.translationAPIKey},$scope.closeModalSlider("#editLanguageTranslationEngine")},$scope.openLanguageTranslationEngine=function(){$scope.selectedStream&&$scope.selectedStream.translationEngine?$scope.selectedTransitionEngine={translationEngine:$scope.selectedStream.translationEngine,translationAPIKey:$scope.selectedStream.translationAPIKey}:($scope.selectedTransitionEngine||($scope.selectedTransitionEngine={}),$scope.selectedTransitionEngine.translationEngine="google"),$scope.openModalSlider("#editLanguageTranslationEngine")},$scope.addLanguageSlider=function(){$scope.openModalSlider("#listLanguageManagement")},searchQuery&&"openLanguageTranslation"===searchQuery.searchQry&&(setTimeout(function(){$scope.addLanguageSlider()},500),$workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:""})),$scope.closeLanguageSlider=function(){$scope.closeModalSlider("#listLanguageManagement")},$scope.intializeSlider=function(){try{deRegisterSlider("#execution-slider")}catch(error){console.log("slider registered")}var streamData=$workflowService.selectedStream();streamData&&streamData.languagePreferences&&streamData.languagePreferences.setLangOnCnt&&($scope.execCount=streamData.languagePreferences.setLangOnCnt),setTimeout(function(){s8=registerSlider("#execution-slider",{tooltip:"show",tooltip_position:"top",ticks_tooltip:!0}),s8.bootstrapSlider("setValue",$scope.execCount),formatTooltip("#execution-slider",$scope.execCount)},100)};var onSliderChanged=_.debounce(onSliderChangedProxy,500);$scope.callback.loadLanguageConfigurations(),$scope.closeModal=function(){$element.find("#enableConfirmation").removeClass("show").addClass("fade")},$scope.confirmDisable=function(){$element.find("#enableConfirmation").removeClass("show").addClass("fade"),BTStreamsService.disableLanguage(selectedStream._id,$scope.selectedLan.value).then(function(response){response&&($scope.selectedLan.enabled=!$scope.selectedLan.enabled,$workflowService.selectedStream(response.data),NotificationService.notify(i18n.i18nString("selected_language_disabled_success"),"success"),$scope.callback.updateSupportedLanguage())},function(err){})},$scope.markDefault=function(e,language){e.stopPropagation(),checkLockedTasks()?($scope.selectedLan=language,NotificationService.confirmDialog((language.enabled?i18n.i18nString("updating_label"):i18n.i18nString("enabling_additional"))+i18n.i18nString("language_unlock"),confirmMarkDefault,{okText:i18n.i18nString("continue"),cancelText:i18n.i18nString("cancel"),language:language})):BTStreamsService.defaultLanguage(selectedStream._id,language.value).then(function(response){if(response){var _defaultLanName=_.filter($scope.languages,{value:$scope.defaultLanguage})[0].name;NotificationService.notify("Default Language is changed from "+_defaultLanName+" to "+language.name,"success"),$scope.defaultLanguage=language.value,$workflowService.selectedStream(response.data)}})},$scope.openSearch=function(){$scope.showLanguageSearch=!0,$timeout(function(){$(".focusNameSearch").focus()})},$scope.closeLanguageValue=function(){$scope.showLanguageSearch=!1,$scope.languageSearchQuery=""},$scope.openEnableUserMsgPopup=function(){$("#languageSettingsLogic").modal("show")},$scope.closeEnableUserMsgPopup=function(){$("#languageSettingsLogic").modal("hide")},$scope.$on("$destroy",function(){eventtranslationEngine&&eventtranslationEngine()})}]}}).directive("clickOnce",function($timeout){var delay=400;return{restrict:"EA",link:function(scope,elem,attrs){function onClick(evt){disabled?(evt.preventDefault(),evt.stopImmediatePropagation()):(disabled=!0,$timeout(function(){disabled=!1,scope.toggleLanguage(evt,scope.language)},delay,!1))}var disabled=!1;scope.$on("$destroy",function(){elem.off("click",onClick)}),elem.on("click",onClick)}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("linkedBotTraining",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/linked-bot-training/linked-bot-training.html",scope:{linkBots:"="},controller:["$scope","$translator","$rootScope","$workflowService","BTStreamsService","NotificationService","$timeout","accessControlService","$element","env_conf","BTFlowtaskService","$q","i18n",function($scope,$translator,$rootScope,$workflowService,BTStreamsService,NotificationService,$timeout,accessControlService,$element,env_conf,BTFlowtaskService,$q,i18n){function fetchLinkedBots(){var configBot,inclusiveBot,publishedBot,inclPublishedBot;$scope.publishedBots=$scope.selectedStream.publishedBots.filter(function(bot){return _.filter($scope.selectedStream.unpublishedBots.concat($scope.selectedStream.awaitingApprovalBots),{_id:bot._id}).length?void 0:bot}),"indevelopment"===$scope.filterToggle?($scope.totalLinkedBots=$scope.selectedStream.configuredBots.concat($scope.publishedBots,$scope.selectedStream.awaitingApprovalBots),$scope.totalLinkedBots=_.map($scope.totalLinkedBots,function(bot){return $scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs.length>0&&(obj.confidenceConfig[0].minThreshold[bot._id]=void 0!==$scope.selectedStream.confidenceConfigs[0].minThreshold[bot._id]?$scope.selectedStream.confidenceConfigs[0].minThreshold[bot._id]:.3),configBot=_.find($scope.selectedStream.fallbackConfiguredBots,{_id:bot._id}),configBot?bot.preferredBotStatus=!0:bot.preferredBotStatus=!1,inclusiveBot=_.find($scope.selectedStream.inclusiveConfiguredBots,{_id:bot._id}),inclusiveBot?bot.inclusiveBot=!0:bot.inclusiveBot=!1,bot})):"published"===$scope.filterToggle&&($scope.totalLinkedBots=$scope.selectedStream.publishedBots,$scope.totalLinkedBots=_.map($scope.totalLinkedBots,function(bot){return $scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs.length>0&&(obj.confidenceConfig[0].minThreshold[bot._id]=void 0!==$scope.selectedStream.confidenceConfigs[0].minThreshold[bot._id]?$scope.selectedStream.confidenceConfigs[0].minThreshold[bot._id]:.3),publishedBot=_.find($scope.selectedStream.fallbackPublishedBots,{_id:bot._id}),publishedBot?bot.preferredBotStatus=!0:bot.preferredBotStatus=!1,inclPublishedBot=_.find($scope.selectedStream.inclusivePublishedBots,{_id:bot._id}),inclPublishedBot?bot.inclusiveBot=!0:bot.inclusiveBot=!1,bot}))}function addTrainingData(_trainingData,_msg,currentTaskCopy){var _payload={trainingUtterances:_trainingData.trainingUtterances,invocationNames:_trainingData.invocationNames,botId:_trainingData.linkedBotId,linkedBotDetails:{_id:_trainingData.linkedBotId}};BTStreamsService.addTrainingData($scope.selectedStream._id,_payload).then(function(response){if(response){$scope.linkTrainingServerCopy=angular.copy(response.data.trainingBotDetails),$scope.search.utteranceText?BTStreamsService.searchText($scope.selectedStream._id,$scope.search.utteranceText,"trainingUtterances",$scope.currentLinkBot._id).then(function(response){$scope.linkTrainingData=response.data.result}):$scope.linkTrainingData=response.data.trainingBotDetails,NotificationService.notify(_msg,"success"),$scope.nonSearchUtteranceResults={},$scope.trainShow=!0,currentTaskCopy&&($scope.currentTaskCopy.isSubmitted=!0);var updatedStream;if(response.data.hasOwnProperty("invocationNames")&&response.data.hasOwnProperty("linkedBotUtterances")){$scope.selectedStream.invocationNames[response.data.trainingBotDetails.linkedBotId]=response.data.trainingBotDetails.invocationNames;var linkedBotTrainingDetails=_.find($scope.selectedStream.linkedBotUtterances,{id:response.data.trainingBotDetails.linkedBotId});linkedBotTrainingDetails&&linkedBotTrainingDetails.trainingUtterances&&(linkedBotTrainingDetails.trainingUtterances=response.data.trainingBotDetails.trainingUtterances),updatedStream=_.extend({},$scope.selectedStream,response.data),$workflowService.selectedStream(updatedStream)}else response.data.hasOwnProperty("invocationNames")&&!response.data.hasOwnProperty("linkedBotUtterances")&&($scope.selectedStream.invocationNames[response.data.trainingBotDetails.linkedBotId]=response.data.trainingBotDetails.invocationNames,updatedStream=_.extend({},$scope.selectedStream,response.data),$workflowService.selectedStream(updatedStream))}},function(err){err&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error"),$scope.linkTrainingData&&($scope.linkTrainingServerCopy=angular.copy($scope.linkTrainingData))})}function isBotPublished(){return"private"!==$scope.selectedStream.visibility.namespace}function filterFn(task){return task&&task.isDeleted?!1:"published"===$scope.filterToggle?"published"===task.status?!0:!1:"published"===task.status?task.isParent?!1:!0:"published"!==task.status?!0:!1}function getTaskUtterances(currentPage,task,searchQuery){var offset={start:10*(currentPage-1),limit:10};BTStreamsService.getUtterances(task._id,offset.start,offset.limit,searchQuery).then(function(res){res&&($scope.utterences=res.data.Sentences,$scope.utterences=_.unique($scope.utterences,"_id"),$scope.utteranceCopy=angular.copy($scope.utterences),savedUtterCount=0,_.map($scope.utteranceCopy,function(utterance){-1!==$scope.linkTrainingData.trainingUtterances.indexOf(utterance.sentence)?(utterance.selected=!0,savedUtterCount+=1):utterance.selected=!1}),$scope.savedSelectedUtterances=angular.copy($scope.utteranceCopy),$scope.utteranceCount=res.data.count,$scope.previousPage=$scope.ob.currentUtterPage)})}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.backArrow=env_conf["context-url"]+"/assets/icons/back-arrow-gray.svg",$scope.rightClass="right500",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.exclamationGray=env_conf["context-url"]+"/assets/icons/exclamationGray.svg",$scope.grouping=env_conf["assets-url"]+"images/grouping.png",$scope.searchIcon=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/smalltalk/close.svg",$scope.bulbIcon=env_conf["context-url"]+"/assets/images/24x29-bulbicon.png",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.currentLanguage=$workflowService.currentLanguage(),$scope.selectedStream=$workflowService.selectedStream(),$scope.dialogTasks=$workflowService.dialogTasksByState(),$scope.limit=10,$scope.currentPage=1,$scope.ob={},$scope.currentUtterPage=1,$scope.maxSize=3,$scope.itemsPerPage=10;$scope.tasks=[],$scope.upgradedTasks=[],$scope.search={},$scope.selectBots=i18n.i18nString("select_bot"),$scope.copyInfo=i18n.i18nString("copy_info"),$scope.nobots=i18n.i18nString("no_bots_caps"),$scope.trainShow=!1,$scope.trainStatus={success:!1,failed:!1,saving:!0},$scope.disableBtn=!0,$scope.filterToggle=$workflowService.selectedStreamState();var configurations,savedUtterCount=0;$scope.showAccordionContent=!1,$scope.activeTask={},$scope.isFromCloseModal=!1,$scope.$emit("nestedComponentLoaded",{id:"linkedBotTraining",flag:!1});var obj={confidenceConfig:[{mode:"ml",isActive:!0,minThreshold:{},maxThreshold:0},{mode:"faq",isActive:!0},{mode:"cs",isActive:!0}]};$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs.length>0&&(obj.confidenceConfig[2].taskMatchTolerance=void 0===$scope.selectedStream.confidenceConfigs[2]?2:void 0!==$scope.selectedStream.confidenceConfigs[2].taskMatchTolerance?$scope.selectedStream.confidenceConfigs[2].taskMatchTolerance:2,obj.confidenceConfig[2].intentRescoring=void 0===$scope.selectedStream.confidenceConfigs[2]?!0:void 0!==$scope.selectedStream.confidenceConfigs[2].intentRescoring?$scope.selectedStream.confidenceConfigs[2].intentRescoring:!0),$scope.getLinkBots=function(){fetchLinkedBots()};var doServiceCalls=function(obj){BTStreamsService.updateThresholds($workflowService.selectedStream()._id,obj).then(function(res){$scope.selectedStream.confidenceConfigs=res.data.confidenceConfigs,$workflowService.selectedStream($scope.selectedStream,res.data),NotificationService.notify(i18n.i18nString("settings_saved"),"success")},function(err){err.data&&err.data&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})},registerSlider=function(ele,ob){var slider=$(ele).bootstrapSlider(ob);return $(ele).slider().on("slideStop ",function(ev){obj.confidenceConfig[0].minThreshold[$scope.currentLinkBot._id]=ev.value,$("#configuration-slider").find(".tooltip-inner").text(ev.value),doServiceCalls(obj)}),$(ele).slider().on("slide",function(ev){$("#configuration-slider").find(".tooltip-inner").text(ev.value)}),slider},initializeSlider=function(){configurations=registerSlider("#configuration",{tooltip:"always",tooltip_position:"bottom"}),configurations.bootstrapSlider("setValue",obj.confidenceConfig[0].minThreshold[$scope.currentLinkBot._id])};$scope.resetDefaultVal=function(current){var defValue=.3;obj.confidenceConfig[0].minThreshold[$scope.currentLinkBot._id]=defValue,configurations.bootstrapSlider("setValue",defValue),$("#configuration-slider").find(".tooltip-inner").text(defValue),doServiceCalls(obj)};var clearSliders=function(){$("#configuration").slider().off("slideStop"),$("#configuration").slider().off("slide")},closeConfigAccordion=function(){$(".configurationBlock").hasClass("collapsed")||($(".configurationBlock").toggleClass("collapsed"),$("#configurations").toggleClass("in"),clearSliders())};$scope.selectedBot=function(bot){$(".dropdown.dropdown-select").find(".dropdown-toggle .selectfield").html('<span><img style="width:20px;height:20px;float:left;" src='+bot.botIconUrl+'><span class="botName" style="padding-left:10px;">'+bot.botName+"</span></span>"),$(".dropdown-menu.botlist").prev().dropdown("toggle"),$scope.currentLinkBot=bot,$scope.isInclusive=bot.inclusiveBot?!0:!1,$scope.isFallback=bot.preferredBotStatus?!0:!1,closeConfigAccordion(),BTStreamsService.getBTStream(bot._id).then(function(response){response&&($scope.linkBotPermission=response.data.permissions.BOTBUILDER_NATURAL_LANGUAGE[0])}),BTStreamsService.getLinkBot($scope.selectedStream._id,bot._id).then(function(response){response&&($scope.linkTrainingData=response.data.result,$scope.linkTrainingServerCopy=angular.copy(response.data.result))},function(err){NotificationService.notify(i18n.i18nString("some_error"),"error")})},$(".closeCross.Utterances").on("click",function(e){e.stopPropagation(),e.stopImmediatePropagation(),$(this).find(".crossIcon.hide").length?($(this).find(".searchIcon").addClass("hide"),$(this).find(".crossIcon").removeClass("hide"),$(".searchContainer").find(".searchUtterInput").removeClass("hide"),$(".searchContainer").find(".searchUtterInput").focus()):($(".searchContainer").find(".searchUtterInput").val(""),$(".searchContainer").find(".searchUtterInput").addClass("hide"),$(this).find(".searchIcon").removeClass("hide"),$(this).find(".crossIcon").addClass("hide"),$scope.$apply(function(){$scope.search.utteranceText="",$scope.searchUtterances(null,$scope.search,"trainingUtterances",$scope.currentLinkBot)}))}),$scope.searchUtterances=function(e,search,type,linkedBot){e&&13===e.keyCode?(e.stopPropagation(),e.stopImmediatePropagation(),BTStreamsService.searchText($scope.selectedStream._id,search.utteranceText,type,linkedBot._id).then(function(response){$scope.linkTrainingData=response.data.result})):""===search.utteranceText&&BTStreamsService.searchText($scope.selectedStream._id,search.utteranceText,type,linkedBot._id).then(function(response){$scope.linkTrainingData=response.data.result,$scope.linkTrainingServerCopy=angular.copy(response.data.result)})},$scope.saveUtterance=function(utterance,bot){if(!utterance||!utterance.newUtterance.length)return void NotificationService.notify(i18n.i18nString("utterances_value"),"error");if($scope.linkTrainingData.trainingUtterances.indexOf(utterance.newUtterance)>=0)return NotificationService.notify(i18n.i18nString("utterances_added",{dyn:utterance.newUtterance}),"error"),void(utterance.newUtterance="");var addNewUtterance=!1;_.forEach($scope.linkTrainingData.trainingUtterances,function(value){value.toUpperCase()===utterance.newUtterance.toUpperCase()&&(addNewUtterance=!0)}),addNewUtterance||$scope.linkTrainingData.trainingUtterances.push(utterance.newUtterance),$scope.linkTrainingServerCopy.trainingUtterances.push(utterance.newUtterance),utterance.newUtterance="";var _trainingData=angular.copy($scope.linkTrainingServerCopy);addTrainingData(_trainingData,i18n.i18nString("save_utterance"))},$scope.deleteUtterance=function(index,currentPage){currentPage>1&&(index=10*(currentPage-1)+index);var currentUtterance=$scope.linkTrainingData.trainingUtterances[index],deleteIndex=_.findIndex($scope.linkTrainingServerCopy.trainingUtterances,function(utterance){return utterance===currentUtterance});$scope.linkTrainingData.trainingUtterances.splice(index,1),$scope.linkTrainingServerCopy.trainingUtterances.splice(deleteIndex,1);var _trainingData=angular.copy($scope.linkTrainingServerCopy);addTrainingData(_trainingData,i18n.i18nString("utterance_deleted"))},$scope.pageChanged=function(currentPage){$scope.currentPage=currentPage,$timeout(function(){$(".innerRightBody").scrollTop(0)})},$scope.getPageData=function(offset,type,linkedBot){BTStreamsService.paginateTrainingData($scope.selectedStream._id,offset,$scope.limit,null,type,linkedBot.linkedBotId).then(function(response){response&&($scope.linkTrainingData.trainingUtterances=response.data.result.trainingUtterances)})};var _accordionParent=$("#accordion");_accordionParent.on("show.bs.collapse",".collapse",function(){_accordionParent.find(".collapse.in").collapse("hide")}),_accordionParent.on("hidden.bs.collapse",function(){$(this).find(".toggleOpen").toggleClass("toggleOpen").toggleClass("toggleClose")}),$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},$scope.fetchTasks=function(linkedBot){$scope.openModalSlider("#selectUtterances"),$q.all([BTFlowtaskService.getEntitiesOrIntents(linkedBot._id,"intents"),BTFlowtaskService.getFlowtaks(linkedBot._id)]).then(function(res){var filteredDialogTasks=[],_filteredNodes=[],componentIDs=[];filteredDialogTasks=_.filter(res[1].data,function(task,i){return"inprogress"!==task.state&&"suspended"!==task.state&&"rejected"!==task.state}),$.each(filteredDialogTasks,function(i,dialog){_filteredNodes=_filteredNodes.concat(_.filter(dialog.nodes,{nodeId:"intent0"}))}),componentIDs=_.pluck(_filteredNodes,"componentId"),res[0].data=res[0].data.map(function(task){return task.taskType="DialogIntent",task.status&&(task.status=task.status.toLowerCase()),-1===$.inArray(task._id,componentIDs)&&(task.hide=!0),"published"!==task.status&&!task.hide&&isBotPublished()&&(task.taskstate="@development"),task}),$scope.intentdata=res[0].data,res[0].data=_.filter(res[0].data,function(d){return!d.hide}),$scope.tasks=[],$scope.tasks=$scope.tasks.concat(res[0].data),$scope.findParenttasks($scope.tasks),$scope.tasks=$scope.tasks.filter(function(task){return filterFn(task)})})},$scope.selectAllUtterance=function(selected){selected?_.map($scope.utterances,function(utterance,index){utterance.selected=!0}):_.map($scope.utterances,function(utterance,index){utterance.selected=!1})};var closeSlider=function(){$scope.closeModalSlider("#selectUtterances"),$scope.currentTask={},$scope.utteranceCopy={},$scope.nonSearchUtteranceResults={},$scope.currentTaskCopy={},$scope.activeTask={},$scope.tasks=[],$scope.search.searchUtterance="",$scope.ob.currentUtterPage=1,$scope.utteranceCount=0};$scope.closeLinkedBotModal=function(){closeSlider(),$element.find("#alertNotify").removeClass("show").addClass("fade")},$scope.closeSelectUtterance=function(){var selectedUtterances=_.filter($scope.nonSearchUtteranceResults,{selected:!0}),hasUnsavedUtterances=checkForUnsavedUtterances(selectedUtterances);hasUnsavedUtterances?($scope.isFromCloseModal=!0,$element.find("#alertNotify").removeClass("fade").addClass("show")):closeSlider()},$scope.onTagAdded=function(){var _trainingData=angular.copy($scope.linkTrainingData);_trainingData.invocationNames=_.pluck(_trainingData.invocationNames,"text"),addTrainingData(_trainingData,i18n.i18nString("innovaction"))},$scope.proceedChange=function(){var offset={start:0,limit:10};$element.find("#alertNotify").removeClass("show").addClass("fade"),$scope.currentTaskCopy=angular.copy($scope.currentTask),$scope.currentTaskCopy.isSubmitted=!1,BTStreamsService.getUtterances($scope.currentTask._id,offset.start,offset.limit,"").then(function(res){$scope.utterences=res.data.Sentences,$scope.utterences=_.unique($scope.utterences,"_id"),$scope.utteranceCopy=angular.copy($scope.utterences),savedUtterCount=0,_.map($scope.utteranceCopy,function(utterance){-1!==$scope.linkTrainingData.trainingUtterances.indexOf(utterance.sentence)?(utterance.selected=!0,savedUtterCount+=1):utterance.selected=!1}),$scope.savedSelectedUtterances=angular.copy($scope.utteranceCopy),$scope.nonSearchUtteranceResults={},$scope.utteranceCount=res.data.count,$scope.disableBtn=!0})};var checkForUnsavedUtterances=function(totalSelectedUtterances){for(var checkForUnsavedUtterances=_.filter($scope.savedSelectedUtterances,{selected:!0}),serverSavedUtterIds=_.pluck(checkForUnsavedUtterances,"_id"),foundUnsavedUtterance=!1,i=0;i<totalSelectedUtterances.length;i++)if(-1===serverSavedUtterIds.indexOf(totalSelectedUtterances[i]._id)){foundUnsavedUtterance=!0;break}return foundUnsavedUtterance};$scope.getUtterances=function(taskId,fromSearch){var searchQuery,task,offset={start:0,limit:10};taskId&&(task=_.find($scope.tasks,{_id:taskId})),$scope.search.searchUtterance&&(searchQuery=$scope.search.searchUtterance);var selectedUtterances=_.filter($scope.nonSearchUtteranceResults,{selected:!0}),hasUnsavedUtterances=checkForUnsavedUtterances(selectedUtterances);$scope.currentTaskCopy&&task&&$scope.currentTask.hasOwnProperty("_id")&&task._id!==$scope.currentTaskCopy._id&&!$scope.currentTaskCopy.isSubmitted&&hasUnsavedUtterances?($element.find("#alertNotify").removeClass("fade").addClass("show"),$scope.isFromCloseModal=!1,$scope.currentTask=task):task&&($scope.currentTask=task,$scope.currentTaskCopy=angular.copy($scope.currentTask),$scope.currentTaskCopy.isSubmitted=!1,BTStreamsService.getUtterances(task._id,offset.start,offset.limit,searchQuery).then(function(res){$scope.utterences=res.data.Sentences,$scope.utterences=_.unique($scope.utterences,"_id"),$scope.utteranceCopy=angular.copy($scope.utterences),fromSearch||($scope.nonSearchUtteranceResults=angular.copy($scope.utteranceCopy)),savedUtterCount=0,_.map($scope.utteranceCopy,function(utterance){if(-1!==$scope.linkTrainingData.trainingUtterances.indexOf(utterance.sentence))utterance.selected=!0,savedUtterCount+=1;else if(selectedUtterances&&selectedUtterances.length){var _selectedUtterance=_.find(selectedUtterances,{_id:utterance._id});_selectedUtterance&&_selectedUtterance._id===utterance._id&&(utterance.selected=!0);
}else utterance.selected=!1}),fromSearch||($scope.savedSelectedUtterances=angular.copy($scope.utteranceCopy)),$scope.utteranceCount=res.data.count,$scope.previousPage=$scope.ob.currentUtterPage}))},$scope.closeAlert=function(){$element.find("#alertNotify").removeClass("show").addClass("fade"),$scope.currentTask=JSON.parse(JSON.stringify($scope.currentTaskCopy)),$scope.activeTask._id=$scope.currentTask._id},$scope.addTrainingUtterances=function(utterances){var _selectedUtterances=_.filter(utterances,function(utterance){return utterance.selected}),_filteredUtterances=_.pluck(_selectedUtterances,"sentence"),count=0;if(angular.forEach(_filteredUtterances,function(utterance){$scope.linkTrainingData.trainingUtterances.indexOf(utterance)>=0&&count++}),_filteredUtterances.length&&count===_filteredUtterances.length)1==count?NotificationService.notify(i18n.i18nString("utterance_already"),"error"):NotificationService.notify(i18n.i18nString("utterance_already"),"error");else if(count!==_filteredUtterances.length){var _trainingData=angular.copy($scope.linkTrainingData);_trainingData.invocationNames=_.pluck(_trainingData.invocationNames,"text"),_trainingData.trainingUtterances=_.unique(_trainingData.trainingUtterances.concat(_filteredUtterances)),addTrainingData(_trainingData,i18n.i18nString("utterance_added"),$scope.currentTaskCopy)}},$scope.trainBot=function(){BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$scope.trainShow=!1,$scope.showTrainSavingSyn=!0,$scope.trainStatus={success:!1,failed:!1,saving:!0},$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),NotificationService.notify(i18n.i18nString("bot_train"),"info")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})},$rootScope.$on("linkedBotTrainingFinished",function(){$scope.trainStatus={success:!0,failed:!1,saving:!1}}),$scope.closeTrainSaveDiv=function(){$scope.showTrainSavingSyn=!1};(function(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithUBTraining")&&!res.data.isMlInSyncWithUBTraining?$scope.trainShow=!0:$scope.trainShow=!1,"Finished"===res.data.trainingStatus?($scope.showTrainSavingSyn=!1,$scope.trainStatus.saving=!1):"Failed"===res.data.trainingStatus&&($scope.showTrainSavingSyn=!1,$scope.trainStatus.saving=!1)},function(err){if($scope.showTrainSavingSyn=!1,$scope.trainStatus.saving=!1,"NO"!==accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE")){var _msg=i18n.i18nString("err_on_fetching_msg");NotificationService.notify(_msg,"error")}})})();$scope.onTagRemoved=function(tag){var _trainingData=angular.copy($scope.linkTrainingData);_.filter(_trainingData.invocationNames,{text:tag.text}),_trainingData.invocationNames=_.pluck(_trainingData.invocationNames,"text"),addTrainingData(_trainingData,i18n.i18nString("innovaction_deleted"))},$scope.offset=0,$scope.searchTaskUtterance=function(event,taskId){13!=event.keyCode&&$scope.search.searchUtterance||$scope.getUtterances(taskId,!0)},$scope.closeAlertUtter=function(){$element.find("#alertSelection").removeClass("show").addClass("fade")},$scope.proceed=function(searchQuery){$element.find("#alertSelection").removeClass("show").addClass("fade"),$scope.ob.currentUtterPage=$scope.nextPage,getTaskUtterances($scope.ob.currentUtterPage,$scope.currentTask._id,searchQuery)},$scope.pageChangedUtterance=function(pageNo,searchQuery){$scope.nextPage=pageNo;var selectedUtterance;return $scope.utteranceCopy&&(selectedUtterance=_.filter($scope.utteranceCopy,{selected:!0}).length),selectedUtterance>0&&selectedUtterance!==savedUtterCount?($element.find("#alertSelection").removeClass("fade").addClass("show"),void($scope.ob.currentUtterPage=$scope.previousPage)):void getTaskUtterances(pageNo,$scope.currentTask._id,searchQuery)},$scope.enableBtn=function(utteranceCopy,selectedUtterance){var _selectedList=_.filter(utteranceCopy,{selected:!0});_selectedList.length?$scope.disableBtn=!1:$scope.disableBtn=!0,$scope.nonSearchUtteranceResults&&($scope.selectedUtterance=_.find($scope.nonSearchUtteranceResults,{_id:selectedUtterance._id})),$scope.selectedUtterance&&($scope.selectedUtterance.selected=selectedUtterance.selected),$scope.search.searchUtterance||($scope.nonSearchUtteranceResults=angular.copy(utteranceCopy))},$scope.editUtterence=function(e,index,currentPage){e.preventDefault();var editValue=$("#utteranceTag"+index).text(),indexCal=10*(currentPage-1)+index;if(editValue&&editValue.length){var editIndex=_.findIndex($scope.linkTrainingServerCopy.trainingUtterances,function(utterance){return utterance===$scope.linkTrainingData.trainingUtterances[index]});$scope.linkTrainingServerCopy.trainingUtterances[editIndex]=editValue,$scope.linkTrainingData.trainingUtterances[indexCal]=editValue;var _trainingData=angular.copy($scope.linkTrainingServerCopy);addTrainingData(_trainingData,i18n.i18nString("utterences_update_sucess_noty"))}else NotificationService.notify(i18n.i18nString("utterances_value"),"error"),$("#utteranceTag"+index).text($scope.linkTrainingData.trainingUtterances[indexCal])},$scope.toggleAccordion=function(){$scope.showAccordionContent=!$scope.showAccordionContent},$(".configurationBlock").on("click",function(){$(this).hasClass("collapsed")?initializeSlider():clearSliders()}),$scope.toogleInvocationAccordion=function(){$scope.showAccordionContent=!1},$scope.toogleConfigurationAccordion=function(){$scope.showAccordionContent=!1},$('[data-toggle="popover"]').popover()}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("manageCollections",function(){return{restrict:"E",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/manage-collections/manage-collections.html",controller:["$scope","$workflowService","NotificationService","BTStreamsService","env_conf","i18n","$applicationService",function($scope,$workflowService,NotificationService,BTStreamsService,env_conf,i18n,$applicationService){function formRedirection(){$scope.cb.collectionList.length?$scope.cb.collectionType="LIST":"EXPORT"===$scope.cb.collectionType?$scope.cb.collectionType="EXPORT":$scope.cb.collectionType="EMPTY"}function getAllCollections(){"LIST"===$scope.cb.collectionType&&$scope.cb.collectionList.length&&($scope.cb.collectionList=_.map($scope.cb.collectionList,function(val){return val.isNameEdit=!1,val.isDescEdit=!1,_.pick(val,"_id","streamId","name","description","isActive","createdOn","isNameEdit","isDescEdit","refId")}))}$scope.rightClass="right900",$scope.envVariableForm={},$scope.assetsBase=env_conf["assets-url"],$scope.emptyState=env_conf["context-url"]+"/assets/icons/empty-illustration.svg",$scope.closeArrow=env_conf["context-url"]+"/assets/icons/close.svg",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.pencil=env_conf["context-url"]+"/assets/icons-new/edit-pencil/edit.png",$scope.help=env_conf["context-url"]+"/assets/icons-new/help/help-dark.svg",$scope.checkGreen=env_conf["context-url"]+"/assets/icons-new/check-mark/check-green.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.table={columns:["COLLECTION NAME","DESCRIPTION","CREATED",""]},$scope.selectedCell={},$scope.selectedStreamState=$workflowService.selectedStreamState(),$scope.collectionForm={name:"",description:"",cloneFrom:""},$scope.inp={namespace:"",name:"",description:""},$scope.isLoading=!1,$scope.setVal=function(cell){$scope.inp.name=cell.name,$scope.inp.description=cell.description},$scope.addNewCollection=function(){$scope.cb.collectionType="CREATE",$scope.collectionForm={name:"",description:"",cloneFrom:""},setTimeout(function(){$("#ColNameInput").focus()},5)},$scope.checkKey=function(e,cell,index,type){if(27==e.which&&(cell.isNameEdit=!1,cell.isDescEdit=!1),13==e.which){var payload={name:cell.name,description:cell.description},collectionId=cell._id||"";if("name"===type){if(""===$scope.inp.name)return void NotificationService.notify("Please enter name","warning");$scope.isLoading=!0,payload.name=$scope.inp.name,$("#load-name"+index).show(),$("#pencil"+index).hide(),cell.isNameEdit=!1,BTStreamsService.btUpdateCollection($applicationService.userInfo().userId,$workflowService.selectedStream()._id,collectionId,payload).then(function(res){res&&res.data&&($scope.cb.collectionList=res.data,NotificationService.notify("Name updated successfully","success")),cell.name=angular.copy($scope.inp.name),$scope.isLoading=!1},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Failed to update name","error"),$scope.isLoading=!1})}else if("description"===type){if(""===$scope.inp.description)return void NotificationService.notify("Please enter description","warning");$scope.isLoading=!0,payload.description=$scope.inp.description,$("#load-description"+index).show(),$("#pencil"+index).hide(),cell.isDescEdit=!1,BTStreamsService.btUpdateCollection($applicationService.userInfo().userId,$workflowService.selectedStream()._id,collectionId,payload).then(function(res){res&&res.data&&($scope.cb.collectionList=res.data,NotificationService.notify("Description updated successfully","success")),cell.description=angular.copy($scope.inp.description),$scope.isLoading=!1},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Failed to update description","error"),$scope.isLoading=!1})}}},$scope.editCell=function(cell,type){if("name"===type){if(_.findWhere($scope.cb.collectionList,{isNameEdit:!0}))return;cell.isNameEdit=!0,setTimeout(function(){document.getElementById("nameInp").focus()},1)}else if("description"===type){if(_.findWhere($scope.cb.collectionList,{isDescEdit:!0}))return;cell.isDescEdit=!0,setTimeout(function(){document.getElementById("descInp").focus()},1)}},$scope.focusOut=function(cell){cell.isNameEdit=!1,cell.isDescEdit=!1},$scope.isFormValid=function(){return $scope.collectionForm.name&&($scope.collectionForm.description||$scope.collectionForm.cloneFrom)?!0:!1},$scope.saveExportCollection=function(){$scope.cb.close()},$scope.changeCollection=function(cell){$scope.cb.selectedCollection=cell},$scope.saveForm=function(){formRedirection()},$scope.cancelForm=function(){formRedirection()},$scope.createCollection=function(){var payload={name:$scope.collectionForm.name||"",description:$scope.collectionForm.description||"",cloneFrom:$scope.collectionForm.cloneFrom.refId||""};return!$scope.collectionForm.cloneFrom&&$scope.cb.collectionList.length?void NotificationService.notify("Please select collection","warning"):($scope.isLoading=!0,void BTStreamsService.btCreateCollection($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload).then(function(res){res&&res.data&&($scope.cb.collectionList=res.data,formRedirection(),NotificationService.notify(i18n.i18nString("collection_created"),"success")),$scope.isLoading=!1},function(err){console.log(err),err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Failed to create collection","error"),$scope.isLoading=!1}))},$scope.updateCollection=function(cell){var payload={name:cell.name,description:cell.description,isActive:!0};$scope.isLoading=!0;var collectionId=cell._id||"";BTStreamsService.btUpdateCollection($applicationService.userInfo().userId,$workflowService.selectedStream()._id,collectionId,payload).then(function(res){res&&res.data&&($scope.cb.collectionList=res.data,NotificationService.notify(i18n.i18nString("collection_updated"),"success")),$scope.isLoading=!1},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Failed to mark collection as active","error"),$scope.isLoading=!1})},$scope.deleteCollection=function(cell){function cancleExport(){}function startExport(){var collectionId=cell._id||"";$scope.isLoading=!0,BTStreamsService.btDeleteCollection($applicationService.userInfo().userId,$workflowService.selectedStream()._id,collectionId).then(function(res){res&&res.data&&($scope.cb.collectionList=res.data,NotificationService.notify(i18n.i18nString("collection_deleted"),"success")),$scope.isLoading=!1},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Failed to delete collection","error"),$scope.isLoading=!1})}NotificationService.alert(i18n.i18nString("collection_delete_text"),[startExport,cancleExport],{okText:i18n.i18nString("ok_uppercase")})};var init=function(){getAllCollections()};init()}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("manageVariableNamespace",function(){return{restrict:"E",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/manage-variable-namespace/manage-variable-namespace.html",controller:["$scope","$workflowService","NotificationService","BTFlowtaskService","BTStreamsService","BTAlertsService","BTActionsService","$applicationService","env_conf","i18n",function($scope,$workflowService,NotificationService,BTFlowtaskService,BTStreamsService,BTAlertsService,BTActionsService,$applicationService,env_conf,i18n){$scope.rightClass="right700",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.selectedState=$workflowService.selectedStreamState(),$scope.save=function(){function saveIt(){var _params={vNameSpace:$scope.cb.addedNamespaces};$("#namespaceLastDelete").modal("hide"),"dialog"==$scope.cb.flagName?(_params=_.extend(_params,$scope.cb.payloadExtend),BTFlowtaskService.updateFlowtask($workflowService.selectedStream()._id,$scope.cb._id,_params).then(function(res){$scope.cb.updateDialogNamespace(_params.vNameSpace),$scope.cb.close(),NotificationService.notify(i18n.i18nString("ns_updated_succ"),"success")},function(err){NotificationService.notify(i18n.i18nString("failed_save_ns"),"error")})):"alert"==$scope.cb.flagName?BTAlertsService.createBTAlertUp($scope.cb._id,_params).then(function(res){$scope.cb.updatedAlertNamespace(res.data.vNameSpace),$scope.cb.close(),NotificationService.notify(i18n.i18nString("ns_updated_succ"),"success")},function(err){NotificationService.notify(i18n.i18nString("failed_save_ns"),"error")}):"information"==$scope.cb.flagName?BTActionsService.updateBTAction($scope.cb._id,_params).then(function(res){$scope.cb.updateInformationNamespace(res.data.vNameSpace),$scope.cb.close(),NotificationService.notify(i18n.i18nString("ns_updated_succ"),"success")},function(err){NotificationService.notify(i18n.i18nString("failed_save_ns"),"error")}):"action"==$scope.cb.flagName?BTActionsService.updateBTAction($scope.cb._id,_params).then(function(res){$scope.cb.updateActionNamespace(res.data.vNameSpace),$scope.cb.close(),NotificationService.notify(i18n.i18nString("ns_updated_succ"),"success")},function(err){NotificationService.notify(i18n.i18nString("failed_save_ns"),"error")}):"smallTalk"==$scope.cb.flagName?BTStreamsService.updateGroup(_params,$workflowService.selectedStream()._id,$scope.cb._id).then(function(res){$scope.cb.updateSmallNamespace(res.data.vNameSpace),$scope.cb.close(),NotificationService.notify(i18n.i18nString("ns_updated_succ"),"success")},function(err){NotificationService.notify(i18n.i18nString("failed_save_ns"),"error")}):"standardResponse"==$scope.cb.flagName?BTStreamsService.editStream($workflowService.selectedStream()._id,{krVNameSpace:_params.vNameSpace}).then(function(res){$scope.cb.updateStandardRespNamespace(res.data.krVNameSpace),$scope.cb.close(),NotificationService.notify(i18n.i18nString("ns_updated_succ"),"success")},function(err){NotificationService.notify(i18n.i18nString("failed_save_ns"),"error")}):"events"==$scope.cb.flagName?(_params.evVNameSpace=_params.vNameSpace,delete _params.vNameSpace,BTStreamsService.editStream($workflowService.selectedStream()._id,_params).then(function(res){$scope.cb.updateEventsNamespace(res.data.evVNameSpace),$scope.cb.close(),NotificationService.notify(i18n.i18nString("ns_updated_succ"),"success")},function(err){})):"kg"==$scope.cb.flagName&&BTStreamsService.addNamespaceKg($applicationService.userInfo().userId,$scope.cb._id,_params).then(function(res){$scope.cb.updateKgNamespaces(res.data.vNameSpace),$scope.cb.close(),NotificationService.notify(i18n.i18nString("ns_updated_succ"),"success")},function(err){NotificationService.notify(i18n.i18nString("failed_save_ns"),"error")})}$scope.cb.newlyAddedNS.length>0&&($scope.cb.addedNamespaces=$scope.cb.addedNamespaces.concat($scope.cb.newlyAddedNS)),0===$scope.cb.addedNamespaces.length?($("#namespaceLastDelete").modal("show"),setTimeout(function(){$("#proceed_removeNs").off("click"),$("#proceed_removeNs").on("click",saveIt)},500)):saveIt()}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("manageVariablesNamespaceTable",function(){return{restrict:"E",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/manage-variables-namespace-table/manage-variables-namespace-table.html",controller:["$scope","$workflowService","NotificationService","BTStreamsService","env_conf","i18n","$applicationService",function($scope,$workflowService,NotificationService,BTStreamsService,env_conf,i18n,$applicationService){$scope.rightClass="right900",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.pencil=env_conf["context-url"]+"/assets/icons-new/edit-pencil/edit.png",$scope.help=env_conf["context-url"]+"/assets/icons-new/help/help-dark.svg",$scope.checkGreen=env_conf["context-url"]+"/assets/icons-new/check-mark/check-green.svg",$scope.table={columns:[i18n.i18nString("namespace_label_uppercase"),i18n.i18nString("global_variables"),i18n.i18nString("content_variable"),""]},$scope.selectedCell={},$scope.selectedState=$workflowService.selectedStreamState();var streamState="indevelopment"==$workflowService.selectedStreamState()?"configured":$workflowService.selectedStreamState();$scope.namespaceList=[],$scope.inp={namespace:""},$scope.isLoading=!0;var delNS={};$scope.setVal=function(cell){$scope.inp.namespace=cell.name},$scope.checkKey=function(e,cell,index){if(27==e.which&&(cell.isEdit=!1),13==e.which){if(""===$scope.inp.namespace)return void NotificationService.notify(i18n.i18nString("please_enter_ns"),"warning");var payload={name:$scope.inp.namespace};$("#load-name"+index).show(),$("#pencil"+index).hide(),cell.isEdit=!1,BTStreamsService.updateNamespace($applicationService.userInfo().userId,$workflowService.selectedStream()._id,cell._id,payload).then(function(res){cell.name=angular.copy($scope.inp.namespace),$("#load-name"+index).hide(),$("#load-done"+index).show(),setTimeout(function(){$("#load-done"+index).hide(),$("#pencil"+index).show()},1e3),$scope.cb.getAllNamespaces().then(function(res){$scope.cb.getBotVariables()}),NotificationService.notify(i18n.i18nString("ns_updated_success"),"success")},function(err){NotificationService.notify(i18n.i18nString("failed_update_ns"),"error")})}},$scope.updateDel=function(cell){delNS=cell,$scope.selectedCell=cell,cell&&(cell.gVariables+cell.cVariables>0?$("#namespaceDelete").modal("show"):$scope.deleteNS())},$scope.closeNsCannotDel=function(){$("#namespaceCannotDelete").modal("hide")},$scope.deleteNS=function(){$("#namespaceDelete").modal("hide"),BTStreamsService.deleteNamespace($applicationService.userInfo().userId,$workflowService.selectedStream()._id,delNS._id).then(function(res){NotificationService.notify(i18n.i18nString("namespace")+" "+delNS.name+i18n.i18nString("failed_delete_ns"),"success"),$scope.updateDel(null),$scope.cb.getBotVariables(),init()},function(err){try{err.data.errors[0].msg.indexOf("being used")>-1&&($("#namespaceCannotDelete").modal("show"),$scope.downloadHref="data:text/plain;base64,"+btoa(err.data.errors[0].msg),$scope.downloadFile=delNS.name+"_logs.txt")}catch(e){NotificationService.notify(i18n.i18nString("namespace")+delNS.name+i18n.i18nString("failed_delete_ns2"),"error")}})},$scope.editCell=function(cell){_.findWhere($scope.namespaceList,{isEdit:!0})||(cell.isEdit=!0,setTimeout(function(){document.getElementById("namespaceInp").focus()}))};var init=function(){BTStreamsService.getAllNamespaces($applicationService.userInfo().userId,$workflowService.selectedStream()._id,{_headers:{state:streamState}}).then(function(res){$scope.namespaceList=_.map(res.data,function(val){return val.isEdit=!1,_.pick(val,"name","_id","type","isEdit","gVariables","cVariables")}),$scope.cb.updateNsList(_.pluck($scope.namespaceList,"name")),$scope.isLoading=!1,setTimeout(function(){$('[data-toggle="popover"]').popover({trigger:"hover",placement:"top"})},100)},function(err){$scope.isLoading=!1})};init()}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("mlUttetnaceScore",[function(){return{restrict:"EA",scope:{mlObj:"=",wfType:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/ml-score-form/ml-score-form.html",controller:["$window","$scope","$rootScope","$workflowService","$location","_constants_","BTStreamsService","BTFlowtaskService","$timeout","$routeParams","env_conf","form_util","$filter","NotificationService","i18n","mixPanel",function($window,$scope,$rootScope,$workflowService,$location,_constants_,BTStreamsService,BTFlowtaskService,$timeout,$routeParams,env_conf,form_util,$filter,NotificationService,i18n,mixPanel){function checkMLSyncStatus(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithSentences")&&res.data.isMlInSyncWithSentences?$scope.mlInSync=!0:$scope.mlInSync=!1,res.data&&"Finished"===res.data.trainingStatus?$scope.showTrainSavingDiv=!1:$scope.showTrainSavingDiv=!0},function(err){var _msg=i18n.i18nString("err_on_fetching_msg");NotificationService.notify(_msg,"error")})}function mapColorEntityToWord(utterance){return $scope.constants.config.hideMLEE?!1:void 0}function checkForDoneButton(){$scope.mlScoreFormObj.selectedtasks=[],$.each($scope.filterObj.taskFilter.mlViewSelectedTask,function(key,value){$scope.allTaskObj&&$scope.allTaskObj[key]&&$scope.mlScoreFormObj.selectedtasks.push($scope.allTaskObj[key])}),$scope.slectedTaskesCount=$scope.mlScoreFormObj.selectedtasks.length}function saveEditedUtterance(payload,utterId){BTStreamsService.editUtterances(payload,utterId).then(function(res){NotificationService.notify(i18n.i18nString("utterences_update_sucess_noty"),"info"),$scope.mlEditAllUtterances=res.data,checkMLSyncStatus()},function(err){409===err.status?NotificationService.notify(i18n.i18nString("utterences_dupli_err_noty"),"error"):NotificationService.notify(i18n.i18nString("utterences_save_fail_err_noty"),"error")})}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createUtterance"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Utterance Added"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}$scope.loader={},$scope.stream=$workflowService.selectedStream(),$scope.stream.streamstate=$workflowService.selectedStreamState(),$scope.stream&&$scope.stream.confidenceConfigs&&$scope.stream.confidenceConfigs.length?$scope.thresholdVal=$scope.stream.confidenceConfigs[0].minThreshold:$scope.thresholdVal=0,$scope.alerts=$workflowService.alertTasks(),$scope.actions_info=$workflowService.actionTasks(),$scope.mlScoreFormObj={},$scope.backArrow=env_conf["context-url"]+"/assets/landingImages/backArrow.png",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.intents=$scope.mlObj.intents||{},$scope.taskOrderByUtts=$scope.mlObj.MlScoreRes.order,$scope.utterencesByTask=$scope.mlObj.MlScoreRes.data,$scope.sortType="weektostrong",$scope.search={},$scope.assetsBase=env_conf["assets-url"],$scope.allutterances=[],$scope.actions=[],$scope.informations=[],$scope.mlScoreFormObj.selectedtasks=[],$scope.mlScoreFormObj.orderedTaskList=[],$scope.mlScoreFormObj.loadedCount=4,$scope.tasksCount=[],$scope.uttCount=[],$scope.mlScoreFormObj.selectedUtterances=[],$scope.doneDisabled=!1,$scope.alltasks="true",$scope.allUtts="true",$scope.mlSelect={},$scope.publishedTasks=[],$scope.tasksInDeveploment=[],$scope.activeMlTaskLength=!0,$scope.activeNLPTasklength=!0,$scope.rightClass="right400",$scope.entityCallbacks={},$scope.allTaskObj={},$scope.loadMLUI=!1,$scope.training=i18n.i18nString("nl_training"),$scope.train=i18n.i18nString("train"),$scope.applying=i18n.i18nString("applying"),$scope.apply=i18n.i18nString("apply"),$scope.development=i18n.i18nString("trained_development"),$scope.published=i18n.i18nString("trained_published"),$scope.taskUtterance={},$scope.filterObj={allTaskIds:{},toggleTask:{toggleSelected:{},toggleActive:!1},utteranceFilter:{mlViewSelectedUtt:{}},taskFilter:{mlViewSelectedTask:{}}},$scope.context={},$scope.entityCallbacks&&$scope.entityCallbacks.updateDropDownPostion&&$scope.entityCallbacks.updateDropDownPostion(!1),$scope.checkScrollButtons=function(resetCall){if($(".mlScrollDiv")&&$(".mlScrollDiv").length){var innerscrollwidth=$(".mlScrollDiv")[0].scrollWidth,scrollPosition=$(".mlScrollDiv").scrollLeft(),innerWidth=$(".mlScrollDiv").innerWidth();$scope.showRight=innerscrollwidth>scrollPosition+innerWidth?!0:!1,$scope.showLeft=scrollPosition?!0:!1,resetCall&&setTimeout(function(){$(".mlScrollDiv .ps-scrollbar-x").off("mouseleave").on("mouseleave",function(){$scope.checkScrollButtons()})},2e3)}$scope.mlScoreFormObj.loadedCount<$scope.mlScoreFormObj.orderedTaskList.length&&($scope.showRight=!0)},$scope.loadNextItems=function(){if($scope.mlScoreFormObj.loadedCount<$scope.mlScoreFormObj.orderedTaskList.length)$scope.mlScoreFormObj.loadedCount=$scope.mlScoreFormObj.loadedCount+2,setTimeout(function(){var innerscrollwidth=$(".mlScrollDiv")[0].scrollWidth;$(".mlScrollDiv").scrollLeft();$(".mlScrollDiv").scrollLeft(innerscrollwidth),$scope.checkScrollButtons()},500);else{var scrollPosition=($(".mlScrollDiv")[0].scrollWidth,$(".mlScrollDiv").scrollLeft());$(".mlScrollDiv").scrollLeft(scrollPosition+835),$scope.checkScrollButtons()}},$scope.loadPreviousItems=function(){var scrollPosition=($(".mlScrollDiv")[0].scrollWidth,$(".mlScrollDiv").scrollLeft());$(".mlScrollDiv").scrollLeft(scrollPosition-835),$scope.checkScrollButtons()},$scope.nlpPositiveQuad=50*(10-10*$scope.thresholdVal),$scope.nlpNegativeQuad=10*$scope.thresholdVal*50,checkMLSyncStatus(),$scope.constants=_constants_,$scope.constants.config.hideMLEE?console.log("hide"):$scope.entityCallbacks.mapColorEntityToWord=mapColorEntityToWord;$.each($scope.actions_info,function(i,task){task.isReport?$scope.informations.push(task):$scope.actions.push(task)}),$scope.mlSelect.tasksByType=[],$scope.alerts.length&&($scope.mlSelect.tasksByType=$scope.mlSelect.tasksByType.concat($scope.alerts)),$scope.actions.length&&($scope.mlSelect.tasksByType=$scope.mlSelect.tasksByType.concat($scope.actions)),$scope.intents.length&&($scope.mlSelect.tasksByType=$scope.mlSelect.tasksByType.concat($scope.intents)),$scope.informations.length&&($scope.mlSelect.tasksByType=$scope.mlSelect.tasksByType.concat($scope.informations)),$scope.randomColors=[];var _connectionColors=["#36ba5a","#2279c4","#fc8500","#ff5d5d","#533a71","#B0171F","#C67171","#8E8E38","#EE0000","#8B1A1A","#CDCD00","#F08080","#8B6969","#CD9B9B","#CD4F39","#8B5A00","#8B864E","#FFFF00","#7FFF00","#00CED1","#BF3EFF","#E3CF57","#BDB76B","#00FF00","#FF7256","#FFF68F","#556B2F","#00868B","#191970","#000000","#E2725B","#30D5C8","#FAD6A5","#FDFD96","#BFFF00","#E1A95F","#8B008B","#FF7F50","#5D8AA8","#A4C639","#A1CAF1","#92A1CF","#893F45","#5D3954","#013220","#515151","#6183d8","#50c5b7","#7ac74f","#1c77c3","#9f86c0","#52B9A1","#447E71","#157D59","#19676B","#3C4E82","#189C19","#1089D7","#29D867","#259F71","#581ACD","#312A1D","#419FB6","#305AE7","#39BB40","#5962FB","#2EDDDB","#19578A","#183F98","#4DD95C","#1E69A4","#0ACC51","#337512","#317ECB","#14A617","#33AC75","#149B7E","#24C281","#2995CB","#13A954","#37688B","#29A8BD","#3F879C","#48EE48","#438266","#189C39","#17842D","#4C3595","#2AA3E7","#429E88","#3635FD","#066197","#25CA68","#06C10D","#347C37","#48C485","#373C6C","#1B919C","#16A9F4","#5C8AAE","#209354","#50C6EA","#49A5BC","#1D456C","#4C1ECB","#28849C","#1E7428","#4EE349","#027EEF","#1E6C4C","#314AE8","#3A7012","#4734D1","#4EE441","#535C9E","#01A9CA","#48E69F","#311CB4","#5BD276","#13655C","#0B75EF","#08E715","#4C5DD8","#43CFCB","#58D75C","#18D018","#3E3632","#5F855D","#5CB772","#2EC6C8","#25DDBC","#3E9201","#372C3B","#1ABEED","#1CE6FE","#2E9C90","#421F49","#217334","#3E56CC","#2171D1","#17B6DF","#5B9FF1","#25A689","#18E877","#38B5B1","#1514C1","#285BBD","#1C9C8B","#33F352","#049288","#58EAF2","#04BC95","#133DBE","#1B9939","#19EC43","#2AC359","#468B51","#1591A1","#4E33BD","#411932","#55C441","#14C39E","#5132C4","#24B93A","#28E7E9","#40F1EA","#3D2AE6","#2B5CCC","#40166A","#107AD4","#433834","#3C0096","#58834F","#543AE3","#262F97","#372209","#42A7D7","#5A8060","#35DC10","#3CE010","#438BFC","#272D7D","#2ED847","#1B5583","#06B638","#369ED3","#337894","#1171E5","#5B5E81","#4F8955","#1DEED7","#28126E","#4F1B31","#2BF4E1","#41458B","#3CB491","#058DAD","#4BAC26","#3A6B7C","#1C4643","#0517FB","#2701AA","#0D4859","#56A449","#4A7AAF","#16AD69","#356792","#23B7F5","#3B7C86","#5B5105","#568168","#4DA365","#3B4B76","#5529AE","#355CA1","#312AE7","#149A9B","#1A404E","#25829D","#4731A2","#5C0BEE","#43CB9A","#384449","#3A7713","#1FF9F7","#2931C3","#2F7124","#2391E1","#27A995","#3FB319","#02696C","#3CA0E5","#4DAC2C","#3F7E8F","#1CCE92","#389BC4","#0AB3F0","#51E837","#1CE856","#1E39CE","#373EB8","#2A0D33","#3276F5","#3D9FEC","#0A59CB","#01936D","#2ABC50","#0D2CD9","#03B61D","#163415","#18CA51","#1713E9","#5C558F","#08D86B","#354366","#473984","#0D65B4","#274188","#402A6D","#4CB05B","#493DA6","#436415","#106C75","#085C9C","#286EC1","#2B826B","#2416C3","#575CB6","#268380","#527D26","#119A13","#144273","#48E0B7","#312372","#568481","#2E3A8E","#4CF89B","#3C5213","#0A4B68","#5275C7","#4953E6","#1EADC8","#1AA8A6","#13E7FD","#34A76C","#38B66D","#5CB959","#09663B","#3EC4C2","#0B0FA4","#4AE3D3","#3B5A11","#42D143","#2528C4","#4393EC","#4D54A9","#14A399","#490D63","#05AE4D","#3BA377","#1D82EE","#4FE1BA","#19F30A","#19B1B5","#1159D7","#357EC5","#361BBD","#1E2B59","#1BF16B","#0A4B93","#4AC5B3","#1C860D","#23E9CE","#52106B","#22F7E4","#58BBB8","#35695B","#28727A","#403302","#29CBFB","#19E8DC","#5B5C6B","#299D5F","#35B7D1","#204FD8","#4F6267","#2AEB41","#044585","#2DE707","#46A802","#4C23A3","#17C665","#13CB08","#2A7849","#0683F5","#287D63","#4B5677","#2B2B54","#42BE3F","#5BA83D","#4FAE78","#12C584","#1FC98C","#206876","#4A5EB6","#19697C","#36D6C7","#07ACAD","#2214FB","#0BE306","#5ED1E9","#446E7E","#0F42F5","#4DB884","#3AD185","#39945B","#0055C9","#584132","#4A8A1F","#4A1F78","#4BB3E6","#4796CE","#14A87B","#162000","#25D8EA","#3C2C6E","#4257B1","#1BA369","#3C6B8E","#06F96D","#13FBB8","#4E3CCB","#0DF6E9","#5474A4","#34742E","#2FB971","#33F99A","#12DB60","#2E72D6","#2947C9","#35CCE3","#461BD0","#0B5B5F","#466DA5","#325A03","#4FD6BF","#4F51B9","#4C44E0","#5C6AB7","#2EAD33","#2E439E","#46A6E3","#191825","#13D682","#4E5899","#2D6EBD","#581389","#5DD44D","#06219D","#0898A6","#140629","#2D8D43","#1317E1","#274B68","#4A115D","#3B2263","#248015","#247D41","#0CCB9F","#326E96","#56CDD8","#16399C","#3EEEC8","#5B8C57","#3521C3","#1B7376","#33CA31","#56E2E9","#44F5C1","#1AD324","#518A90","#03ECD6","#1517DE","#4CEC8B","#490377","#4757FC","#1D325A","#2C3639","#20AEC1","#52041A","#355ECD","#312C95","#39765B","#0688F3","#0C3832","#46B8D0","#3C519C","#227538","#2F699C","#3CD068","#487E13","#304726","#2B6DDA","#019D29","#092E55","#033D76","#325BF2","#27AE66","#46D4AD","#41A9BA","#4523DB","#24B1F2","#3BB3D5","#35DE4C","#196344","#07123C","#0C8D20","#08473A","#31276B","#4E9455","#42EFC1","#446629","#4BA875","#362E2B","#101474","#413937","#1418F3","#47CA2E","#128967","#18D257","#25191E","#1DB45D","#31C62C","#11EED4","#081EE7","#4731CB","#58DC2C","#514E69","#4CA9C2","#2ED8A2","#2B9693","#54DFC8","#4E9988","#22E025","#3A615E","#2DC613","#343C72","#34AD26","#4DC2C3","#56C2BA","#113092","#3197A2","#0262D2","#1E447B","#11D374","#2880D3","#26B337","#5DDD7A","#5D13F8","#2F2383","#26514D","#1A4A8C","#4DE9BB","#0C7F1E","#05DB3E","#49DC2B","#2EC5D3","#24ABA2","#54AD57","#37BC32","#04A344","#079277","#0E7C2B","#1B4AEE","#0153E2","#13444E","#217A30","#413F39","#4161B5","#21679E","#5396DD","#4F0B4A","#10E8B5","#212DD8","#55A983","#1DE260","#43FBBB","#368D64","#1794DD","#4BC165","#337DB1","#12D7B5","#107E22","#3E3391","#30BD5C","#5537E2","#11ED9F","#548948","#48E35B","#3241B1","#04CE34","#521535","#324D1D","#13AF18","#392299","#36535C","#134157","#321837","#363D64","#5BD47A","#24A9A3","#0C7A85","#5A2AC8","#47D922","#5C13CE","#2AF17C","#228138","#2DA647","#13E818","#26E714","#324367","#2762E2","#2AC5E8","#2BB82C","#128DEE","#2D1323","#1791AC","#225DB1","#49B6D8","#0596A5","#53A1AD","#2FCD77","#5D53FD","#3AD2F4","#536CA4","#2A9CC6","#235969","#1BFCD8","#276147","#4496D5","#161B44","#297EA5","#57014C","#545461","#53EC1A","#5FBED4","#24896E","#07CE75","#2AE949","#3C7855","#119A21","#03B311","#1B6E5E","#46DBE5","#45B04D","#55BD3C","#3DF367","#4A7CD0","#257EB5","#2549C4","#18A044","#2AA867","#2D22AA","#26BAD5","#2DBEF6","#39BD5C","#1BDBD3","#04ACF8","#24EDDD","#569C74","#461B60","#3896EF","#197131","#435D23","#1BEB99","#240426","#2C69AC","#282984","#02106C","#0B2A23","#305117","#4CDE85","#092F34","#41DDE8","#17B663","#3D24EA","#411561","#42C07F","#2C734E","#3C2372","#2AB5C7","#16C1A6","#4D9432","#412622","#5D368E","#0B50D6","#46AE77","#0BC519","#3C7539","#14E5BD","#5FFD1D","#3B8347","#3133DE","#26DF3E","#278742","#31C124","#4CA2CC","#2BD73A","#27C97C","#29B398","#24AE35","#5471B6","#3E95E7","#2E6D1D","#534B58","#2AFDC8","#308433","#1D94A1","#32C48E","#212CD1","#312463","#379941","#014676","#3554B6","#5BECA8","#4F1FE1","#249606","#32E5CE","#232324","#11BA11","#4987A5","#3E2D3C","#069A2D","#26D63A","#318EB3","#357AA8","#1D442C","#181364","#17C22A","#48DB26","#45A63A","#4E7D93","#3715C8","#092C9E","#372489","#4E3469","#154472","#38D9EE","#0B1DB3","#4DBB17","#138DDD","#398A33","#4B88B9","#3CC59B","#143D28","#5CAD44","#2E225C","#4B42D8","#2B35CC","#17474B","#07032E","#4E606E","#2A72E3","#5B7726","#183C13","#224C0E","#051AFC","#147198","#0963D4","#2B586D","#40427D","#27764E","#0E69DC","#3BA788","#1C9C42","#1C2A62","#49DF53","#478D3B","#18B69D","#02DD6A","#226CEB","#4E7A67","#344125","#23742B","#5BEDE5","#416880","#416B88","#36EE2A","#2B3674","#2AB79E","#436B56","#4A3464","#12A9C4","#4EAF3C","#4C2C2B","#2EBD17","#147634","#0392B7","#1CCE2F","#3061B4","#5B6FB0","#13EE3E","#435838","#535061","#3019D4","#561AFA","#1D1582","#02D617","#35E6C1","#4E9504","#2DE199","#5AB470","#1BC45D","#035221","#26FD00","#2623ED","#3995BB","#1CBBE5","#105147","#249A49","#428C28","#1DFE1B","#43C67D","#4856E6","#09AD60","#5313BC","#3C7345","#2F58C4","#042B64","#01C16A","#0FA4F4","#092145","#4EDE75","#2DA632","#57E783","#19A9EF","#3E495C","#1114CF","#48899B","#2C1DBC","#279BBE","#036C67","#4EDD18","#2420C7","#579ADD","#06ACDD","#371753","#3F6850","#131CC2","#1B0A0D","#312386","#4C923B","#5D7DB9","#506BC5","#4B94C7","#4B8A59","#488351","#1B58B9","#1E6B6D","#11A843","#416D4E","#43E83A","#097CDC","#159B1C","#53974B","#005CA9","#323E3C","#5589C8","#332B7C","#2C1E50","#1CB6CB","#1231E7","#4819BC","#11D0BA","#4A6C36","#2FA0C3","#38E0EE","#352D5F","#114C33","#1BAF3E","#52879E","#32A8E1","#485DE8","#4D80B2","#384053","#179478","#2A6F52","#07401C","#47D96C","#1AB235","#1E4877","#2C3E13","#14A6C8","#318729","#33B92A","#067225","#3CD942","#49A541","#11C98C","#2B4521","#346D1C","#155698","#49EE66","#3033EB","#3C3F89","#376D86","#3CD6BB","#3E196D","#51BB85","#223969","#15D794","#17BBC5","#2B1725","#3EC282","#267538","#099C2D","#223A07","#27DCCA","#565A79","#44CC3D","#3891B8","#30DFDC","#59D379","#229512","#1148F6","#2FAAD8","#162D9E","#166699","#289AF6","#3C2533","#34B431","#462CA1","#5D2F73","#1B63DF","#040DE7","#274535","#56DE7B","#2FC833","#2023D8","#3D992A","#5DAC42","#5DD057","#345A76","#530EFE","#1E8D81","#45F34C","#46EA36","#0C9D39","#159396","#35C019","#0B39C9","#2BEE78","#4652C2","#015F4A","#4BDCB9","#05D49E","#245A9F","#0837C6","#468D18","#4302D6","#5A64EC","#043D9A","#222B32","#44C009","#08176E","#4B167D","#109621","#407952","#3E9A95","#08A6D7","#1AF349","#10ABDB","#1043E7","#32DA01","#49C93C","#3C1499","#26E735","#155442","#17E3CE","#25D5FB","#32B431","#216925","#3B80C9","#03C288","#19EB85","#1B255B","#10970E","#27528A","#2C6244","#540B9E","#4062CE","#36A6ED","#57FB49","#4764BB","#4DA49F","#2AD724","#3D3554","#3A2E5D","#1B4DD2","#166C95","#0C374A","#1D52EC","#13AA3B","#4A159D","#4D9FB5","#37C2A4","#43EAF7","#1D1A4E","#382D85","#587652","#017E13","#0834DC","#138415","#39F694","#3E1FE4","#163D94","#12B126","#4482DF","#5144F4","#5C3DC5","#4B5254","#1D6341","#5C957D","#1F7913","#4CEB7C","#3B86B7","#4AE615","#131E68","#25ED9E","#2F9422","#22B808","#171C5E","#3C3637","#3B2A68","#27E1B2","#03761A","#4D0ADE","#17AC60","#348941","#52328C","#35C4AB","#3DA943","#5368E1","#3DCE28","#1A7A2D","#46641B","#559D5F","#3C9ED7","#3B6F26","#093DEB","#3822C7","#09CC94","#4CDB79","#0D5328","#0D6CB3","#467443","#1FB4AD","#5B8673","#5BBB65","#2510EE","#1D7018","#4122D9","#2C1BE6","#168B44","#1C2171","#4A67F4","#14AC40","#019977","#53CD44","#2931B2","#1E3771","#387258","#2C51F1","#187343","#3FB1A5","#157736","#36A892","#440586","#17E20C","#442D74","#0C1927","#380C15","#573162","#42506B","#2459E2","#238844","#42446A","#43ED14","#4E94CB","#1D3DEE","#3A9B31","#21F049","#3E18CC","#0737DE","#44C2DE","#22C482","#10571E","#26B7A7","#457448","#247763","#5660CA","#36CB64","#353995","#0164D9","#087EED","#3941AD","#19A2BB","#1FC1A6","#464DC4","#2899F5","#35B055","#55E225"];
$scope.randomColors=_connectionColors,$scope.prepareAllUtterances=function(){$scope.allutterances=[],$scope.taskUtterance={},$.each($scope.taskOrderByUtts,function(i,task){$scope.filterObj.allTaskIds[task]={},$scope.filterObj.taskFilter.mlViewSelectedTask[task]={}}),$scope.utterencesByTask&&Object.keys($scope.utterencesByTask).length&&$.each($scope.utterencesByTask,function(k,utterence){var obj=[];obj.sentence=utterence.sentence,obj.expected=utterence.expected,obj.sentenceId=utterence.sentenceId,obj.scores=utterence.scores,obj.view="Show",$scope.allutterances.push(obj);var sentenceObj=[];sentenceObj[0]=utterence.sentence,sentenceObj[1]="Show",sentenceObj[2]=utterence.expected,sentenceObj[3]=utterence.sentenceId,$scope.taskUtterance[obj.expected]||($scope.taskUtterance[obj.expected]=[]),$scope.taskUtterance[obj.expected].push(sentenceObj)})},$scope.prepareUtteranceByTask=function(){$scope.prepareAllUtterances(),$.each($scope.mlSelect.tasksByType,function(i,tasks){var key="state";"DialogIntent"===tasks.type&&(key="status"),"published"===tasks[key]?$scope.publishedTasks.push(tasks):$scope.tasksInDeveploment.push(tasks),$scope.mlSelect.tasksByType[i].isAdded=$scope.filterObj.taskFilter.mlViewSelectedTask[tasks._id]?"YES":"NO",$scope.mlSelect.tasksByType[i].TP=[],$scope.mlSelect.tasksByType[i].TN=[],$scope.mlSelect.tasksByType[i].FP=[],$scope.mlSelect.tasksByType[i].FN=[],$scope.mlSelect.tasksByType[i].totalTP=[],$scope.mlSelect.tasksByType[i].totalTN=[],$scope.mlSelect.tasksByType[i].totalFP=[],$scope.mlSelect.tasksByType[i].totalFN=[],$scope.mlSelect.tasksByType[i].sentences=[],$scope.mlSelect.tasksByType[i].isSelected="disabled",$scope.mlSelect.tasksByType[i].colorSelected=$scope.randomColors[i],$scope.mlSelect.tasksByType[i].pHeight=$scope.nlpPositiveQuad+"px",$scope.mlSelect.tasksByType[i].nHeight=$scope.nlpNegativeQuad+"px",tasks&&"DialogIntent"==tasks.type?$scope.mlSelect.tasksByType[i].taskType="dialog":tasks&&tasks.alertFieldsDefinition?$scope.mlSelect.tasksByType[i].taskType="alert":tasks&&tasks.queryField&&tasks.isReport?$scope.mlSelect.tasksByType[i].taskType="info":tasks&&tasks.queryField&&!tasks.isReport&&($scope.mlSelect.tasksByType[i].taskType="action"),$scope.utterencesByTask&&Object.keys($scope.utterencesByTask).length&&$scope.taskUtterance&&$scope.taskUtterance[tasks._id]?$scope.mlSelect.tasksByType[i].sentences=$scope.taskUtterance[tasks._id]:$scope.mlSelect.tasksByType[i].sentences=[],$scope.allTaskObj[$scope.mlSelect.tasksByType[i]._id]=$scope.mlSelect.tasksByType[i]})},$scope.prepareUtteranceByTask(),0===$scope.publishedTasks.length&&0!==$scope.tasksInDeveploment.length&&($scope.mlObj.filterToggle="indevelopment"),0===$scope.tasksInDeveploment.length&&0!==$scope.publishedTasks.length&&($scope.mlObj.filterToggle="published"),$scope.totalTaskscount=$scope.mlSelect.tasksByType.length||0,$scope.mlScorelength=$scope.allutterances.length,$scope.selectUtterances=function(sentence,task){sentence[1]="Show"===sentence[1]?"Hide":"Show",$scope.allUtts="false",$.each($scope.allutterances,function(i,utterence){sentence[3]==utterence.sentenceId&&(utterence.view=sentence[1])}),$scope.uttCount=[],$scope.allutterances.map(function(utterence){"Show"===utterence.view&&($scope.uttCount.push(utterence),$scope.slectedUttsCount=$scope.uttCount.length)})},$scope.checkforDoneUtt=function(){$scope.mlScoreFormObj.selectedUtterances=[],$scope.allutterances.map(function(utterence){"Show"===utterence.view&&$scope.mlScoreFormObj.selectedUtterances.push(utterence)})},$scope.selectTask=function(task,index){var selectedTasks=Object.keys($scope.filterObj.taskFilter.mlViewSelectedTask);selectedTasks&&selectedTasks.length<10?$scope.filterObj.taskFilter.mlViewSelectedTask[task._id]?(delete $scope.filterObj.taskFilter.mlViewSelectedTask[task._id],task.isAdded="NO"):($scope.filterObj.taskFilter.mlViewSelectedTask[task._id]={},task.isAdded="YES"):!$scope.filterObj.taskFilter.mlViewSelectedTask[task._id]&&selectedTasks&&selectedTasks.length>9?NotificationService.notify(i18n.i18nString("maximum_tasks"),"error"):$scope.filterObj.taskFilter.mlViewSelectedTask[task._id]&&(delete $scope.filterObj.taskFilter.mlViewSelectedTask[task._id],task.isAdded="NO"),$scope.alltasks="false",$scope.tasksCount=selectedTasks},$scope.getActiveState=function(){$timeout(function(){$scope.slectedTaskesCount&&0===$scope.slectedTaskesCount.length?($scope.activeMlTaskLength=!0,$scope.activeNLPTasklength=!0):($scope.activeMlTaskLength=$(".stylMlgraph").find(".stylgraph").is(":visible"),$scope.activeNLPTasklength=$(".NLPgraph").find(".nlpTask").is(":visible"))},100)},$scope.updateFilterValue=function(filterVal){return $scope.activeMlTaskLength=!0,$scope.activeNLPTasklength=!0,0===$scope.publishedTasks.length?($scope.getActiveState(),"indevelopment"):0===$scope.tasksInDeveploment.length?($scope.getActiveState(),"published"):($scope.getActiveState(),"indevelopment"===filterVal?"published":"indevelopment")},$scope.filterFn=function(task,indexval){var key="state";return"DialogIntent"===task.type&&(key="status"),"published"===$scope.mlObj.filterToggle?"published"===task[key]?!0:!1:"published"!==task[key]?!0:!1},$scope.PlotTPDot=function(task,tp){var _dotTPColor={"margin-left":tp[4],"margin-top":tp[3],color:tp[2]};return _dotTPColor},$scope.PlotTNDot=function(task,tn){var _dotTNColor={"margin-left":tn[4],"margin-top":tn[3],color:tn[2]};return _dotTNColor},$scope.PlotFPDot=function(task,fp,index){var _dotFPColor={"margin-left":fp[4],"margin-top":fp[3],color:fp[2]};return _dotFPColor},$scope.PlotFNDot=function(task,fn){var _dotFNColor={"margin-left":fn[4],"margin-top":fn[3],color:fn[2]};return _dotFNColor},$scope.getPositiveHeight=function(task,score){var eachPCount,dotP_height,totalPheight=$(".boxTP").height()||240;return $scope.mlObj.MlScoreRes&&$scope.mlObj.MlScoreRes.useProbability?(eachPCount=50,dotP_height=$scope.nlpPositiveQuad-(score[1]-$scope.thresholdVal)*eachPCount*10,dotP_height+"px"):(eachPCount=totalPheight/5,dotP_height=totalPheight-5-score[1]*eachPCount,dotP_height+"px")},$scope.getNegativeHeight=function(task,score){var dotN_height,eachNCount,num=0-score[1],totalNheight=$(".boxTN").height()||240;return $scope.mlObj.MlScoreRes&&$scope.mlObj.MlScoreRes.useProbability?(eachNCount=50,dotN_height=($scope.thresholdVal-score[1])*eachNCount*10,dotN_height+"px"):(eachNCount=totalNheight/5,dotN_height=num*eachNCount-5,dotN_height+"px")},$scope.getMargin=function(totals,score){var duplicates=totals.filter(function(plots){return plots==score[1]});if(duplicates.length>1){var dups;return dups=duplicates.length>22?duplicates.length%22:duplicates.length,dups%2===0?3*dups+dups+"px":dups%2!==0?"-"+(3*(dups-1)+dups)+"px":"0px"}return"0px"},$scope.getColor=function(task,score){var curTaskColor=$scope.mlSelect.tasksByType.filter(function(color){return color._id==task._id});return curTaskColor.length?curTaskColor[0].colorSelected:"#f8f8f8"},$scope.selectAllTaks=function(){$scope.alltasks="true"===$scope.alltasks?"false":"true","true"===$scope.alltasks?$scope.slectedTaskesCount=$scope.totalTaskscount:$scope.slectedTaskesCount=0,$.each($scope.mlSelect.tasksByType,function(i,task){"true"===$scope.alltasks?$scope.mlSelect.tasksByType[i].isAdded="YES":$scope.mlSelect.tasksByType[i].isAdded="NO"})},$scope.selectAllUtts=function(){$scope.allUtts="true"===$scope.allUtts?"false":"true","true"===$scope.allUtts?$scope.slectedUttsCount=$scope.mlScorelength:$scope.slectedUttsCount=0,$.each($scope.mlSelect.tasksByType,function(i,task){$.each(task.sentences,function(k,sentence){"true"===$scope.allUtts?sentence[1]="Show":sentence[1]="Hide"})}),$.each($scope.allutterances,function(k,sentence){"true"===$scope.allUtts?sentence.view="Show":sentence.view="Hide"})},$scope.showhideTasks=function(){$scope.showTasks="show"===$scope.showTasks?"hide":"show",$scope.showUtts="hide"},$scope.showhideUtterances=function(){$scope.showUtts="show"===$scope.showUtts?"hide":"show",$scope.showTasks="hide"},$scope.tasktoggle=function(task,index){$scope.filterObj.toggleTask.toggleSelected[task._id]?delete $scope.filterObj.toggleTask.toggleSelected[task._id]:$scope.filterObj.toggleTask.toggleSelected[task._id]={},Object.keys($scope.filterObj.toggleTask.toggleSelected).length?$scope.filterObj.toggleTask.toggleActive=!0:$scope.filterObj.toggleTask.toggleActive=!1},$scope.mlObj.prepareMl=function(){$scope.isGlobalWorkProgress=!0,$scope.axisPoint=0,$scope.mlObj.MlScoreRes&&$scope.mlObj.MlScoreRes.useProbability&&($scope.axisPoint=$scope.thresholdVal),$scope.mlScorelength||($scope.isGlobalWorkProgress=!1),$.each($scope.mlScoreFormObj.selectedUtterances,function(j,scoreArray){var task=$scope.allTaskObj[scoreArray.expected];task&&$.each(scoreArray.scores,function(k,score){if(score[0]=score[0].split(" ")[0],score[1]=Math.round(100*score[1])/100,score[1]>5?score[1]=5:score[1]<-5&&(score[1]=-5),task._id==score[0])score[1]>$scope.axisPoint?(task.totalTP.push(score[1]),score[2]=(task.colorSelected||"#ffff")+" !important",score[3]=$scope.getPositiveHeight(task,score),score[4]=$scope.getMargin(task.totalTP,score),score[5]=scoreArray.expected,score[6]=scoreArray.sentenceId,score[7]=scoreArray.sentence,score[8]="show",task.TP.push(score)):(task.totalFN.push(score[1]),score[2]=(task.colorSelected||"#ffff")+" !important",score[3]=$scope.getNegativeHeight(task,score),score[4]=$scope.getMargin(task.totalFN,score),score[5]=scoreArray.expected,score[6]=scoreArray.sentenceId,score[7]=scoreArray.sentence,score[8]="show",task.FN.push(score));else{var falseTask=$scope.allTaskObj[score[0]];falseTask&&(score[1]>$scope.axisPoint?(falseTask.totalFP.push(score[1]),score[2]=(task.colorSelected||"#ffff")+" !important",score[3]=$scope.getPositiveHeight(task,score),score[4]=$scope.getMargin(falseTask.totalFP,score),score[5]=scoreArray.expected,score[6]=scoreArray.sentenceId,score[7]=scoreArray.sentence,score[8]="show",falseTask.FP.push(score)):(falseTask.totalTN.push(score[1]),score[2]=(task.colorSelected||"#ffff")+" !important",score[3]=$scope.getNegativeHeight(task,score),score[4]=$scope.getMargin(falseTask.totalTN,score),score[5]=scoreArray.expected,score[6]=scoreArray.sentenceId,score[7]=scoreArray.sentence,score[8]="show",falseTask.TN.push(score)))}})}),$scope.getTasksByOrder()},$scope.sortMlData=function(type){"toWeak"===type?$scope.sortType="strongtoweak":$scope.sortType="weektostrong"},$scope.getMLScore=function(){var payload={tasks:Object.keys($scope.filterObj.taskFilter.mlViewSelectedTask),weak_to_strong:"strongtoweak"===$scope.sortType?!1:!0};BTStreamsService.mlUtterencesScore($scope.stream._id,payload).then(function(res){var mlResponse=res.data.order;mlResponse||(NotificationService.notify(i18n.i18nString("fetching_error"),"error"),mlResponse=$scope.mlObj.MlScoreRes.order)},function(err){$scope.isGlobalWorkProgress=!1,$scope.isWorkProgress=!1;var _msg=i18n.i18nString("fetching_error");NotificationService.notify(_msg,"error")})},$scope.getTasksByOrder=function(){var mlResponse=$scope.mlObj.MlScoreRes.order;$scope.taskOrderByUtts=mlResponse,$scope.taskOrderByUtts=$scope.taskOrderByUtts;_.find($scope.taskOrderByUtts,function(orderId){$scope.allTaskObj[orderId]&&$scope.allTaskObj[orderId]._id&&$scope.filterObj.taskFilter.mlViewSelectedTask[orderId]&&$scope.mlScoreFormObj.orderedTaskList.push($scope.allTaskObj[orderId])});$scope.isGlobalWorkProgress=!1,$scope.isWorkProgress=!1,$scope.getActiveState(),0!==$scope.slectedTaskesCount&&($scope.mlObj.MlScoreRes&&$scope.mlObj.MlScoreRes.useProbability?$scope.showNLP=!0:$scope.showMl=!0)},$scope.reRunModal=function(){$scope.loader.loadingMLModal=!0,$scope.tasksCount=[],$scope.uttCount=[],$scope.doneDisabled=!1,$scope.alltasks="true",$scope.allUtts="true",$scope.publishedTasks=[],$scope.tasksInDeveploment=[],$scope.activeMlTaskLength=!0,$scope.activeNLPTasklength=!0,$scope.showMl=!1,$scope.showNLP=!1,$scope.isGlobalWorkProgress=!0,$scope.isWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("loading_graph_label"),$scope.clearTaskData(),$scope.filterObj={allTaskIds:{},toggleTask:{toggleSelected:{},toggleActive:!1},utteranceFilter:{mlViewSelectedUtt:{}},taskFilter:{mlViewSelectedTask:{}}};var payload={tasks:Object.keys($scope.filterObj.taskFilter.mlViewSelectedTask),weak_to_strong:"strongtoweak"===$scope.sortType?!1:!0};BTStreamsService.mlUtterencesScore($scope.stream._id,payload).then(function(res){$scope.mlObj.MlScoreRes=res.data,$scope.taskOrderByUtts=res.data.order,$scope.utterencesByTask=res.data.data,$scope.prepareUtteranceByTask(),$scope.initialCall()})},$scope.getTaskNameByID=function(taaskId){var taskName="";return $scope.allTaskObj[taaskId]&&(taskName=$scope.allTaskObj[taaskId].name),taskName},$scope.getEntityNameByID=function(id){var eniityName;return $.each($scope.currentExpectedtask.entitiesArray,function(i,entity){return entity._id===id?(eniityName=entity.name,!1):void 0}),eniityName},$scope.getTaskByID=function(taaskId){var taskData;return $scope.allTaskObj[taaskId]&&(taskData=$scope.allTaskObj[taaskId]),taskData},$scope.filter=function(){$scope.showTasks="show",$scope.showUtts="hide",$scope.rightClass="right400",$scope.openModalSlider("#mlscoreFilter")},$scope.createFilter=function(){if(!$scope.filterInprogress){$scope.filterInprogress=!0,$scope.activeMlTaskLength=!0,$scope.activeNLPTasklength=!0,$scope.showMl=!1,$scope.showNLP=!1,$scope.isGlobalWorkProgress=!0,$scope.isWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("loading_graph_label");var payload={tasks:Object.keys($scope.filterObj.taskFilter.mlViewSelectedTask),weak_to_strong:"strongtoweak"===$scope.sortType?!1:!0};BTStreamsService.mlUtterencesScore($scope.stream._id,payload).then(function(res){$scope.filterInprogress=!1,$scope.mlObj.MlScoreRes=res.data,$scope.taskOrderByUtts=res.data.order,$scope.utterencesByTask=res.data.data,$scope.clearTaskData(),$scope.prepareAllUtterances(),checkForDoneButton(),$scope.checkforDoneUtt(),$scope.mlObj.prepareMl(),$scope.closeModalSlider("#mlscoreFilter"),setTimeout(function(){$scope.loader.loadingMLModal=!1})},function(res){$scope.filterInprogress=!1})}},$scope.selectQuadrent=function(quad){$scope.showUttSearch=!1,$scope.search.searchQuery="",$scope.qType=quad,setTimeout(function(){$(".modalBody").scrollTop(0)},200)},$scope.selectQuadrentTask=function(taskId,index){if($scope.showUttSearch=!1,$scope.search.searchQuery="",index)$scope.quadrentTask=$scope.mlScoreFormObj.orderedTaskList[index],$scope.quad.selectedTaskId=$scope.quadrentTask._id;else{var task=_.find($scope.mlScoreFormObj.selectedtasks,{_id:taskId});task&&($scope.quadrentTask=task,$scope.quad.selectedTaskId=$scope.quadrentTask._id)}},$scope.getUtterancesData=function(taskId){BTStreamsService.getUtterancesbyId(taskId,0,0,"","true").then(function(res){$scope.mlEditAllUtterances=res.data},function(err){})},$scope.getComponentsByDialogID=function(task){BTFlowtaskService.getFlowtaskComponents($workflowService.selectedStream()._id,task.dialogId).then(function(res){task.entitiesArray=_.filter(res.data,{type:"entity"})||[]})},$scope.openQuadrentView=function(quad,task){$scope.quad={selectedTaskId:""},$scope.quadrentStep=1,$scope.qType=quad,$scope.rightClass="right400",$scope.quadrentTask=task,$scope.quad.selectedTaskId=task._id,$scope.openModalSlider("#mlQuadrentView")},$scope.getQuadType={TP:"True +ve",FP:"True +ve",TN:"False-ve",FN:"False -ve"},$scope.openEditUtterances=function(index,task,quadrent,type,callby,event,quadType){event&&(event.preventDefault(),event.stopPropagation()),$scope.quadType=quadType,$scope.callBy=callby,$scope.quadrentStep=2,$scope.rightClass="right400",$scope.quadEditUtterance=quadrent,$scope.currentEditQuad=type,$scope.currentEditTask=task,$scope.currentExpectedtask=$scope.getTaskByID(quadrent[5]),"DialogIntent"==$scope.currentExpectedtask.type&&$scope.getComponentsByDialogID($scope.currentExpectedtask),$scope.getUtterancesData(quadrent[6]),$scope.openModalSlider("#mlQuadrentView"),$scope.quadUtterance=quadrent[7],$scope.matchedTaskId=quadrent[0],$scope.expectedTaskId=quadrent[5]},$scope.changeUtteranceTask=function(taskId,index){$scope.mlEditAllUtterances.entities=[],$scope.currentExpectedtask=$scope.getTaskByID(taskId),"DialogIntent"===$scope.currentExpectedtask.type&&$scope.getComponentsByDialogID($scope.currentExpectedtask)},$scope.addUtterance=function(payload){BTStreamsService.createUtterances(payload).then(function(res){mixpanelEvent("createUtterance"),$scope.$emit("updateChecklist","machineLearningUtterances"),checkMLSyncStatus(),NotificationService.notify(i18n.i18nString("utterences_update_sucess_noty"),"success")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("problem_utterance"),"error")})},$scope.editUtterence=function(selectTaskId,utterence,quad,score){var payload={},focusedUtterance=$("#"+$scope.mlEditAllUtterances._id).text()&&$("#"+$scope.mlEditAllUtterances._id).text().trim();if($scope.quadEditUtterance[5]===selectTaskId){var expectedTask=$scope.getTaskByID($scope.quadEditUtterance[5]);payload={taskId:$scope.quadEditUtterance[5],sentence:focusedUtterance||utterence,entities:$scope.mlEditAllUtterances.entities||[],streamId:$scope.stream._id,type:expectedTask.type,taskName:expectedTask.name},saveEditedUtterance(payload,$scope.quadEditUtterance[6])}else{var newMapedTask=$scope.getTaskByID(selectTaskId);payload={taskId:selectTaskId,sentence:utterence,streamId:$scope.stream._id,taskName:newMapedTask.name,type:newMapedTask.type},$scope.deleteUtterances(-1,$scope.currentEditQuad,$scope.quadEditUtterance,payload)}$scope.savingUtt=!1},$scope.activateUttSearch=function(show){show?($scope.showUttSearch=!0,$scope.search.searchQuery=""):($scope.showUttSearch=!1,$scope.search.searchQuery=""),$scope.search.searchQuery="",setTimeout(function(){$(".focusNameSearch").focus()},100)},$scope.deleteEntityToWordMap=function(utterance,index,entity){utterance.entities.splice(index,1)},$scope.deleteUtterances=function(index,quad,score,addUttPayload){score[9]=!0;var expectedTask=$scope.getTaskByID(score[5]),payload={taskId:score[5],sentence:score[7],streamId:$scope.stream._id,type:expectedTask.type,taskName:expectedTask.name};BTStreamsService.deleteUtterances(payload,score[6]).then(function(res){-1===index&&addUttPayload&&$scope.addUtterance(addUttPayload),$.each(quad,function(i,utterance){return utterance[6]===score[6]?(quad.splice(i,1),!1):void 0}),$scope.deleting=!1,-1!==index&&(checkMLSyncStatus(),NotificationService.notify(i18n.i18nString("utterance_deleted"),"success"))},function(err){score[9]=!1,-1===index?NotificationService.notify(i18n.i18nString("utterance_update"),"error"):NotificationService.notify(i18n.i18nString("delete_utterances"),"error")})},$scope.closeQuadrentView=function(){$scope.quad.selectedTaskId="",$scope.closeModalSlider("#mlQuadrentView")},$scope.closeEditUtteranceView=function(){$scope.closeModalSlider("#mlQuadrentView")},$scope.goToList=function(){$scope.quadrentStep=1},$rootScope.$on("MLScoreUtterencesTrainFinished",function($event){$scope.trainStatus={success:!0,failed:!1,saving:!1},$scope.trainTitle="",$scope.mlInSync=!0}),$rootScope.$on("MLScoreUtterencesTrainFailed",function($event){$scope.trainStatus={success:!1,failed:!0,saving:!1},$scope.trainTitle=i18n.i18nString("utterences_training_intiated_err"),$scope.mlInSync=!1}),$scope.trainBot=function(){$scope.showTrainSavingDiv=!0,$scope.trainStatus={success:!1,failed:!1,saving:!0},BTStreamsService.trainUtterances($scope.stream._id).then(function(res){$rootScope.$emit("triggerAutoTrainStatusPoll"),NotificationService.notify(i18n.i18nString("utterences_training_intiated"),"info"),$scope.trainTitle=""},function(err){$scope.trainStatus={success:!1,failed:!0,saving:!1},err.data.errors.length>0?(NotificationService.notify(err.data.errors[0].msg,"error"),$scope.trainTitle=err.data.errors[0].msg):($scope.trainTitle=i18n.i18nString("problm_in_training_utter_noty"),NotificationService.notify(i18n.i18nString("problm_in_training_utter_noty"),"error"))})},$scope.initialCall=function(){$scope.isGlobalWorkProgress=!0,$scope.isWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("loading_graph_label"),checkForDoneButton(),$scope.checkforDoneUtt(),$scope.mlObj.prepareMl(),$scope.mlObj.MlScoreRes&&$scope.mlObj.MlScoreRes.useProbability?$scope.showNLP=!0:$scope.showMl=!0,$scope.allTasksUtteranceData=$scope.mlScoreFormObj.orderedTaskList,$scope.loadMLUI=!0,$scope.mlObj.directiveLoading=!1,setTimeout(function(){$scope.loader.loadingMLModal=!1,$scope.checkScrollButtons(!0)})},$scope.back=function(){$(".sidenav").removeClass("zindex1"),$scope.showMl=!1,$scope.showNLP=!1,$scope.allutterances=[],$scope.goToHome()},$scope.clearTaskData=function(){$scope.mlScoreFormObj.orderedTaskList=[],$.each($scope.mlSelect.tasksByType,function(i,task){task.TP=[],task.TN=[],task.FP=[],task.FN=[],task.totalFP=[],task.totalTP=[],task.totalFN=[],task.totalTN=[]}),$scope.filterObj.allTaskIds={},$scope.filterObj.toggleTask.toggleSelected={},$scope.filterObj.toggleTask.toggleActive=!1},$scope.context={},$scope.context.mapEntityToWord=function(selectedSentence,entityID,utteranceIndex){var payload=($scope.mlEditAllUtterances.sentence,{});selectedSentence=$scope.entityCmpt.focusedUtterance.substring($scope.entityCmpt.startEndIndex.start,$scope.entityCmpt.startEndIndex.end);var indexAfterTrim=selectedSentence.length-selectedSentence.trim().length;payload.entities=[];var sentenceEntObject={startIndex:$scope.entityCmpt.startEndIndex.start,endIndex:$scope.entityCmpt.startEndIndex.end-indexAfterTrim,entityId:entityID};if(payload.entities.push(sentenceEntObject),$scope.mlEditAllUtterances.entities&&$scope.mlEditAllUtterances.entities.length){$.each($scope.mlEditAllUtterances.entities,function(i,entity){($scope.entityCmpt.startEndIndex.start<=entity.startIndex&&$scope.entityCmpt.startEndIndex.end>=entity.startIndex||$scope.entityCmpt.startEndIndex.start<=entity.endIndex&&$scope.entityCmpt.startEndIndex.end>=entity.endIndex||$scope.entityCmpt.startEndIndex.start>=entity.startIndex&&$scope.entityCmpt.startEndIndex.end<=entity.endIndex||$scope.entityCmpt.startEndIndex.start<=entity.startIndex&&$scope.entityCmpt.startEndIndex.end>=entity.endIndex)&&delete $scope.mlEditAllUtterances.entities[i]});var tempEntitesArray=$scope.mlEditAllUtterances.entities||[];tempEntitesArray=_.without(tempEntitesArray,null),tempEntitesArray=_.without(tempEntitesArray,void 0),payload.entities=[].concat(payload.entities,tempEntitesArray)}$scope.mlEditAllUtterances.entities=payload.entities,$scope.constants.config.hideMLEE?console.log("hide"):$scope.entityCallbacks.updateDropDownPostion(!1,$scope.entityCmpt.offsetObject)},$scope.entityCmpt={},$scope.entityCmpt.entities=[{startIndex:5,endIndex:9,entityId:"entityID",name:"entityname"}],$scope.goToHome=function(){$(".mlScore-modal").modal("hide"),$("body").removeClass("modal-open bt-modal-open"),$scope.mlObj.openMLScore=!1,$scope.mlObj.checkMLSyncStatus&&$scope.mlObj.checkMLSyncStatus(!0),$scope.mlObj.loadingEntities&&$scope.mlObj.loadingEntities($scope.stream._id),$scope.showMl=!1,$scope.showNLP=!1},$scope.slectedTaskesCount=$scope.totalTaskscount,$scope.slectedUttsCount=$scope.mlScorelength,$scope.initialCall(),$timeout(function(){$scope.filter()},1e3)}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("focusIn",function(){return{restrict:"AE",link:function($scope,$element,$attrs){$element.on("click",function(){$element.parents(".uttrence-view").addClass("noBackGround")}),$element.on("focusout",function(){$element.parents(".uttrence-view").removeClass("noBackGround")})}}}),_module.directive("mlUtteranceModule",[function(){return{restrict:"E",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/ml-utterance-module/ml-utterance-module.html",scope:{intentData:"=",cb:"=",upgradeTask:"=",viewMode:"=",trainSyncData:"=?"},controller:["$scope","_constants_","$workflowService","env_conf","BTStreamsService","$sce","$element","i18n","BTFlowtaskService","accessControlService","$rootScope","$timeout","BTAlertsService","mixPanel","jsEvents",function($scope,_constants_,$workflowService,env_conf,BTStreamsService,$sce,$element,i18n,BTFlowtaskService,accessControlService,$rootScope,$timeout,BTAlertsService,mixPanel,jsEvents){function buildWarnData(){$scope.warnObj={warnings:[],errors:[],all:[]};var nluRules=$scope.intentData.nluRules||$scope.intentData["localeData.en.nluRules"];nluRules&&Object.keys(nluRules).length&&($.each(nluRules,function(key,val){val&&val.severity&&(val.severity=val.severity.toLowerCase(),val.type=key,"error"===val.severity.toLowerCase()?$scope.warnObj.errors.push(val):"warning"===val.severity.toLowerCase()&&$scope.warnObj.warnings.push(val),$scope.warnObj.all.push(val))}),$scope.warnObj.errors.length?$scope.warnIcon=env_conf["context-url"]+"/assets/icons/nluError.svg":$scope.warnIcon=env_conf["context-url"]+"/assets/icons/nluWarn.svg"),$scope.buildingRules=!1}function getColorByEntity(entityName){return entityColors[entityName]?entityColors[entityName]:(entityColors[entityName]=$scope.constants.entityColors[Math.floor(12*Math.random())+1],entityColors[entityName])}function removeTagValidation(){$(".tags").find("input").val("")}function bindScroll(event){event.stopImmediatePropagation(),$(this).scrollTop()+$(this).innerHeight()>=.8*$(this)[0].scrollHeight&&(console.log($scope.fetchingUtterances),$scope.fetchingUtterances||($scope.fetchingUtterances=!0,"auto"===$scope.activeTabType?getAutoTrainedUtterances($scope.intentData,!0):getUtterances($scope.intentData,!0),$(".utterances-content-view").off("scroll",bindScroll)))}function getAutoTrainedUtterances(intentData,isFromScroll,isFromSearch){if(intentData)if($scope.moreAutoTrainedAvailable){var searchQuery=$scope.utteranceSearch.utteranceSearchQuery||"";isFromSearch||($scope.offset=$scope.autoTrainedUtterances.length),$scope.loadingRules=!0,BTStreamsService.getUtterances(intentData._id,$scope.offset,30,searchQuery,"true",$workflowService.selectedStream()._id).then(function(res){isFromScroll||"auto"!==$scope.activeTabType||($scope.autoTrainedUtterances=[]),$scope.isFromSearch=isFromSearch,$scope.utteranceSearch.utteranceSearchQuery||($scope.isFromSearch=!1),$scope.autoTrainedUtterances=$scope.autoTrainedUtterances.concat(res.data.Sentences),$scope.autoTrainedUtterances=_.unique($scope.autoTrainedUtterances,"_id"),$scope.moreAutoTrainedAvailable=res.data.moreAvailable,isFromSearch||($scope.autoTrainedUtteranceCount=res.data.count),$scope.count&&!isFromSearch?intentData.utteranceCount=$scope.autoTrainedUtteranceCount+$scope.count:$scope.count||!$scope.autoTrainedUtteranceCount||isFromSearch||(intentData.utteranceCount=$scope.autoTrainedUtteranceCount),$scope.autoTrainFetching=!1,$scope.fetchingUtterances=!1,$(".mlUtterance").is(":visible")&&$timeout(function(){PerfectScrollbar.update($(".utterances-content-view")[0])},100),$(".utterances-content-view").on("scroll",bindScroll),$scope.loadingRules=!1},function(err){$scope.autoTrainFetching=!1,$scope.fetchingUtterances=!1,$scope.loadingRules=!1,$(".utterances-content-view").on("scroll",bindScroll)})}else $scope.autoTrainFetching=!1,$scope.fetchingUtterances=!1,$scope.loadingRules=!1,$(".utterances-content-view").on("scroll",bindScroll)}function startSaving(className,isFromDelete){$scope.saveStatus={initial:!1,pending:!0,completed:!1,failed:!1}}function finishSaving(className,isError,isFromDelete){"error"===isError?($scope.editSaveText="",$timeout(function(){$scope.saveStatus={initial:!1,pending:!1,completed:!1,failed:!0}},1e3),isFromDelete||$element.find(className).addClass("fa fa-times")):($timeout(function(){$scope.saveStatus={initial:!1,pending:!1,completed:!0,failed:!1}},1e3),isFromDelete?$scope.editSaveText="":$element.find(className).addClass("fa fa-check")),$timeout(function(){$scope.editSaveText="",$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1}},5e3)}function hideEntityDetails(){$element.find(".entityInfoDiv").hide()}function saveEditedUtterance(payload,index){BTStreamsService.editUtterances(payload,$scope.utterences[index]._id).then(function(res){finishSaving(".utteranceInput"+$scope.utterences[index]._id),NotificationService.notify(i18n.i18nString("utterences_update_sucess_noty"),"info"),$scope.utterencesCopy[index].sentence=$scope.utterences[index].sentence,$scope.entityCmpt.fromEdit=!0,$scope.utterences[index].sentence=res.data.sentence,$scope.utterences[index].entities=res.data.entities||[],$scope.utterences[index].nluRules=res.data.nluRules||{},mapColorEntityToWord($scope.utterences[index]),$scope.isTrainInprogress()||($scope.showTrainSavingDiv=!1),checkMLSyncStatus(),setTimeout(function(){$scope.editId=-1,$("#"+$scope.utterences[index]._id).blur()},500),$scope.loadingRules=!1,$scope.getComponentById()},function(err){$scope.loadingRules=!1,err.data&&err.data.errors?(finishSaving(".utteranceInput"+$scope.utterences[index]._id,"error"),$scope.utterences[index].sentence=$scope.utterencesCopy[index].sentence,$scope.utterences[index]&&$scope.utterences[index].entities&&!$scope.utterences[index].entities.length&&($("#"+$scope.utterences[index]._id)[0].innerText=$scope.utterencesCopy[index].sentence),$scope.editThis(index),NotificationService.notify(err.data.errors[0].msg,"error")):(finishSaving(".utteranceInput"+$scope.utterences[index]._id,"error"),$scope.utterences[index].sentence=$scope.utterencesCopy[index].sentence,$scope.editThis(index),NotificationService.notify(i18n.i18nString("utterences_save_fail_err_noty"),"error")),setTimeout(function(){$scope.editId=-1,$("#"+$scope.utterences[index]._id).blur(),hideEntityDetails()},500)})}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createUtterance"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Utterance Added"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}function allintentsObj(){$scope.cb.intentsObj={},$scope.cb&&$scope.cb.allIntents&&$scope.cb.allIntents.length&&$.each($scope.cb.allIntents,function(i,intent){$scope.cb.intentsObj[intent._id]=intent})}function checkMLSyncStatus(disableNotify){$scope.loadingRules=!0,BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithSentences")&&!res.data.isMlInSyncWithSentences||res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithTraits")&&!res.data.isMlInSyncWithTraits?($scope.trainSyncData=angular.copy(res.data),prepareTrainLabel(res.data)):$scope.showTrainBtn=!1,"Finished"===res.data.trainingStatus?($scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1):"Failed"===res.data.trainingStatus||res.data.isError?($scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1,res.data.isError&&($scope.failed_to_train_utt_msg=i18n.i18nString("failed_to_train_utt_msg"),res.data.errorDesc&&res.data.errorDesc.message&&($scope.showTrainBtn=!0),disableNotify||NotificationService.notify(failed_to_train_utt_msg,"error"))):res.data&&res.data.trainingStatus&&"waiting"===res.data.trainingStatus.toLowerCase()&&($scope.showTrainSavingDiv=!0,$scope.trainProgressLabel||prepareTrainProgressLabel(),$scope.trainStatus={success:!1,failed:!1,saving:!0}),$scope.loadingRules=!1},function(err){$scope.loadingRules=!1,$scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1,$scope.err_on_fetching_msg=i18n.i18nString("err_on_fetching_msg"),NotificationService.notify($scope.err_on_fetching_msg,"error")})}$scope.filterToggle=$workflowService.selectedStreamState(),$scope.activeTabType="developer",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.searchClose=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",
$scope.roundCheck=env_conf["context-url"]+"/assets/icons/round-check.svg",$scope.saving=env_conf["context-url"]+"/assets/gif/saving.gif",$scope.brokenImageSmall=env_conf["context-url"]+"/assets/images/brokenImageSmall.png",$scope.focusedIndex=-1,$scope.utterences=[],$scope.autoTrainedUtterances=[],$scope.utteranceSearch={},$scope.autoTrainedUtteranceCount=0,$scope.offset=0,$scope.constants=_constants_,$scope.selectedStream=$workflowService.selectedStream();var streamId=$scope.selectedStream._id;$scope.context={},$scope.entityCmpt={},$scope.entityCmpt.showentityDropdown=!1,$scope.entityCmpt.fromEdit=!1,$scope.entityCmpt.offsetObject={},$scope.activeType="DialogIntent",$scope.moreAvailable=!0,$scope.moreAutoTrainedAvailable=!0,$scope.autoTrainFetching=!1,$scope.entityCallbacks={},$scope.btUtteranceObject={},$scope.traitRules={},$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.viewImage=env_conf["context-url"]+"/assets/landingImages/icons/eye.svg",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.infoIcon=env_conf["context-url"]+"/assets/icons-new/info/info-gray.svg",$scope.searchIcon=env_conf["context-url"]+"/assets/icons/search.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/icons-new/close/close-dark.svg",$scope.loadingUtterances=!1,$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1},$scope.views={utterances:!0,patterns:!1,negativepatterns:!1,rules:!1},$scope.showView={utterances:!0,patterns:!0,negativepatterns:!0,rules:!0},$scope.entityCmpt.entities=[{startIndex:5,endIndex:9,entityId:"entityID",name:"entityname"}],$scope.speechTrainStatus={success:!0,failed:!1,saving:!1},$scope.trainStatus={success:!0,failed:!1,saving:!1};var entityColors={},savedUtteranceFlag=!1,tempSel="",previousUtteranceIndex=-1,previousUnsavedUtteranceValue="";$scope.patternsCB={},$scope.negativepatternsCB={},$scope.constants=_constants_,$scope.trainingScreenLoaded=!0,$scope.search={};$scope.constants.config.hideMLEE?console.log("hide"):$scope.entityCallbacks&&$scope.entityCallbacks.updateDropDownPostion&&$scope.entityCallbacks.updateDropDownPostion(!1),$scope.warnObj={warnings:[],errors:[],all:[]},buildWarnData(),$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},$scope.getColorByEntity=getColorByEntity;var mapColorEntityToWord=function(utterance){function getSentenceByEntity(triplets,str){String.prototype.replaceBetween=function(start,end,what){var value=this.substring(0,start+1)+what+this.substring(end);return value},triplets.sort(function(a,b){return b[0]-a[0]});for(var triplet,ii=0;triplet=triplets[ii];ii++){var result=mapIndex(triplet[0],triplet[1],ii,triplets);result&&(str=str.replaceBetween(triplet[0]-1,triplet[1],triplet[2]))}return str}if($scope.constants.config.hideMLEE)return!1;if(utterance.entities&&utterance.entities.length){var _parentArray=[];$.each(utterance.entities,function(i,entity){utterance.entities&&utterance.hasOwnProperty("scores")&&(entity.score=utterance.scores[entity.entityId]);var _childArray=[entity.startIndex,entity.endIndex,'<span contenteditable="true" class="spantags" entityIndex="'+i+'" startIndex="'+entity.startIndex+'" endIndex="'+entity.endIndex+'"  entityId="'+entity.entityId+'" style="cursor:pointer;font-weight:bold;color:'+getColorByEntity(entity.entityName)+'">'+utterance.sentence.substring(entity.startIndex,entity.endIndex)+"</span>"];_parentArray.push(_childArray)}),utterance.sentence=getSentenceByEntity(_parentArray,utterance.sentence)}};$scope.constants.config.hideMLEE?console.log("hide"):$scope.entityCallbacks.mapColorEntityToWord=mapColorEntityToWord,$scope.back=function(){jsEvents.postMessageToChildIframes("updateNlpData","#dialogIFrame",{}),$scope.cb.closeTrainingModalSlider("#trainingFullModal");var traitRules;$scope.cb&&$scope.cb.fetchMLStatus&&$scope.cb.fetchMLStatus(),$scope.cb&&$scope.cb.loadingEntities&&!$scope.cb.showIntentsLabel&&$scope.cb.loadingEntities($scope.selectedStream._id),$scope.moreAvailable=!0,$scope.moreAutoTrainedAvailable=!0;var _obj={showTrainBtn:$scope.showTrainBtn,showTrainSavingDiv:$scope.showTrainSavingDiv,trainStatus:$scope.trainStatus,trainProgressLabel:$scope.trainProgressLabel};$scope.utteranceSearch.utteranceSearchQuery="",$scope.btUtteranceObject={},$scope.closeSearch&&$scope.closeSearch(),$(".builderMaincontainer").removeClass("showBot"),$scope.activeTabType="developer",$scope.cb.updateTrainDetails&&$scope.cb.updateTrainDetails(_obj),$scope.patternsCB&&$scope.patternsCB.returnTraitRules&&(traitRules=$scope.patternsCB.returnTraitRules()),$scope.cb.updatePropertyPanel&&$scope.cb.updatePropertyPanel($scope.intentData,traitRules),$scope.cb.updateTrainDataDetails&&$scope.cb.updateTrainDataDetails($scope.intentData),$scope.cb.updateIntentData&&$scope.cb.updateIntentData({intentData:$scope.intentData,traitRules:traitRules,trainStatus:_obj}),$timeout(function(){$scope.utterences=[],$scope.autoTrainedUtterances=[]},500),removeTagValidation()},$scope.showUtteranceInternalHeader=function(type){$scope.activeTabType=type,$(".utterances-content-view").on("scroll",bindScroll),$(".utterances-content-view").animate({scrollTop:0}),$scope.clearSearch()},$scope.trustAsHtml=function(utterenceSentence){return $sce.trustAsHtml(utterenceSentence)},$scope.isTrainInprogress=function(){return $scope.speechTrainStatus.saving||$scope.trainStatus.saving?!0:!1};var mapIndex=function(start,end,currentIndex,triplets){if(currentIndex>0){var previousIndex=currentIndex-1,currentTriplet=triplets[currentIndex],previousTriplet=triplets[previousIndex];return currentTriplet[0]===previousTriplet[0]&&currentTriplet[1]===previousTriplet[1]?!1:!0}return!0},getUtterances=function(intent,isFromScroll,isFromSearch,cb){if($scope.intentData=intent,$scope.activeType=intent.taskType,$scope.fetching=!0,$scope.dataLoaded=!1,$scope.moreAutoTrainedAvailable&&!isFromScroll&&getAutoTrainedUtterances(intent,isFromScroll,isFromSearch),$scope.moreAvailable){var searchQuery=$scope.utteranceSearch.utteranceSearchQuery||"";isFromScroll||isFromSearch||($scope.trainingScreenLoaded=!1),isFromSearch||($scope.offset=$scope.utterences.length),$scope.loadingRules=!0,BTStreamsService.getUtterances(intent._id,$scope.offset,30,searchQuery,void 0,$workflowService.selectedStream()._id).then(function(res){isFromScroll||($scope.utterences=[]),$.each(res.data.Sentences,function(i,utterance){mapColorEntityToWord(utterance)}),$scope.utterences=$scope.utterences.concat(res.data.Sentences),$scope.utterences=_.unique($scope.utterences,"_id"),$scope.utterencesCopy=angular.copy($scope.utterences),$scope.moreAvailable=res.data.moreAvailable,isFromSearch||($scope.count=res.data.count,intent.utteranceCount=res.data.count),$scope.isFromSearch=isFromSearch,$scope.dataLoaded=!0,$scope.autoTrainedUtteranceCount&&!isFromSearch&&(intent.utteranceCount=$scope.autoTrainedUtteranceCount+$scope.count),setTimeout(function(){$scope.cb.loadingMLUtterances=!1,$scope.loadingUtterances=!1},200),$scope.trainingScreenLoaded=!0,function(){$scope.isFromScroll=isFromScroll,isFromSearch||isFromScroll?$(".utterances-content-view").on("scroll",bindScroll):setTimeout(function(){$(".utterances-content-view").on("scroll",bindScroll)},1e3)}(),$scope.fetching=!1,$scope.fetchingUtterances=!1,$(".mlUtterance").is(":visible")&&$timeout(function(){PerfectScrollbar.update($(".utterances-content-view")[0]),$('[data-toggle="dropdown"').on("click",function(e){$scope.entityCmpt.showentityDropdown=!1,$element.find(".entity-selection-dropdown").removeClass("entity-selection-dropdown")})},100),$scope.loadingRules=!1},function(err){$scope.fetching=!1,$scope.fetchingUtterances=!1,$scope.cb.loadingMLUtterances=!1,$scope.loadingUtterances=!1,$scope.trainingScreenLoaded=!1,$scope.dataLoaded=!0,$scope.loadingRules=!1,$(".utterances-content-view").on("scroll",bindScroll)})}else $scope.fetching=!1,$scope.fetchingUtterances=!1,$scope.loadingUtterances=!1,$scope.dataLoaded=!0,$scope.loadingRules=!1,$(".utterances-content-view").on("scroll",bindScroll)};$scope.editThis=function(index){-1===previousUtteranceIndex||$scope.utterences[previousUtteranceIndex].sentence&&(savedUtteranceFlag||$scope.utterences[previousUtteranceIndex].sentence===previousUnsavedUtteranceValue)||($scope.utterences[previousUtteranceIndex].sentence=$scope.utterencesCopy[previousUtteranceIndex].sentence),savedUtteranceFlag=!1,previousUtteranceIndex=index,previousUnsavedUtteranceValue=$scope.utterences[index].sentence,$scope.editId=index,setTimeout(function(){$('input[name="utterance-text"]').focus()},100)},$scope.cancelEditUtterance=function(){setTimeout(function(){$scope.utterences[previousUtteranceIndex].sentence=$scope.utterencesCopy[previousUtteranceIndex].sentence,$scope.editId=-1,savedUtteranceFlag=!0})},$scope.context.mapEntityToWord=function(selectedSentence,entityID,utteranceIndex,intentData){if($scope.currentSelectedTask=intentData?intentData:$scope.intentData,"indevelopment"===$scope.filterToggle){var key="state";if("DialogIntent"===$scope.currentSelectedTask.taskType&&(key="status"),"published"==$scope.currentSelectedTask[key])$scope.upgradeTask.callbackType="mapEntityToWord",$scope.upgradeTask.selectedSentence=selectedSentence,$scope.upgradeTask.entityID=entityID,$scope.upgradeTask.utteranceIndex=utteranceIndex,NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{utteranceIndex&&($scope.entityCmpt.selectedUtteranceIndex=utteranceIndex);var focusedUtterance=$scope.entityCmpt.focusedUtterance&&$scope.entityCmpt.focusedUtterance.trim();console.log(focusedUtterance),console.log($scope.entityCmpt.selectedUtteranceIndex),console.log($scope.entityCmpt.startEndIndex);var name;name="DialogIntent"===$scope.intentData.type?$scope.intentData.intent:$scope.intentData.name;var payload={taskId:$scope.intentData._id,sentence:focusedUtterance,streamId:streamId,taskName:name,type:$scope.currentSelectedTask.taskType};selectedSentence=$scope.entityCmpt.focusedUtterance.substring($scope.entityCmpt.startEndIndex.start,$scope.entityCmpt.startEndIndex.end);var indexAfterTrim=selectedSentence.length-selectedSentence.trim().length;payload.entities=[];var sentenceEntObject={startIndex:$scope.entityCmpt.startEndIndex.start,endIndex:$scope.entityCmpt.startEndIndex.end-indexAfterTrim,entityId:entityID};if(payload.entities.push(sentenceEntObject),$scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities&&$scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities.length){$.each($scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities,function(i,entity){($scope.entityCmpt.startEndIndex.start<=entity.startIndex&&$scope.entityCmpt.startEndIndex.end>entity.startIndex||$scope.entityCmpt.startEndIndex.start<entity.endIndex&&$scope.entityCmpt.startEndIndex.end>=entity.endIndex||$scope.entityCmpt.startEndIndex.start>=entity.startIndex&&$scope.entityCmpt.startEndIndex.end<=entity.endIndex||$scope.entityCmpt.startEndIndex.start<=entity.startIndex&&$scope.entityCmpt.startEndIndex.end>=entity.endIndex)&&delete $scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities[i]});var tempEntitesArray=$scope.utterences[$scope.entityCmpt.selectedUtteranceIndex].entities||[];tempEntitesArray=_.without(tempEntitesArray,null),tempEntitesArray=_.without(tempEntitesArray,void 0),payload.entities=[].concat(payload.entities,tempEntitesArray)}$scope.constants.config.hideMLEE?console.log("hide"):$scope.entityCallbacks.updateDropDownPostion(!1,$scope.entityCmpt.offsetObject),startSaving(".utteranceInput"+$scope.utterences[$scope.entityCmpt.selectedUtteranceIndex]._id),saveEditedUtterance(payload,parseInt($scope.entityCmpt.selectedUtteranceIndex))}}},$scope.deleteEntityToWordMap=function(utterence,utterenceIndex,entityIndex){if($scope.currentSelectedTask=$scope.intentData,"indevelopment"===$scope.filterToggle){var key="state";if("DialogIntent"===$scope.currentSelectedTask.taskType&&(key="status"),"published"==$scope.currentSelectedTask[key])$scope.currentEdit=$("#"+$scope.utterences[utterenceIndex]._id).text()&&$("#"+$scope.utterences[utterenceIndex]._id).text().trim(),$scope.currentIndex=utterenceIndex,$scope.currentUtterenceId=utterence._id,$scope.upgradeTask.callbackType="deleteEntityWordMap",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{utterence.entities.splice(entityIndex,1);var payload={taskId:utterence.taskId,sentence:$("<div>"+utterence.sentence+"<div>").text(),streamId:utterence.streamId,taskName:utterence.taskName,type:utterence.type,entities:utterence.entities||[]};startSaving(".utteranceInput"+$scope.utterences[utterenceIndex]._id),saveEditedUtterance(payload,utterenceIndex)}}};var addUtteranceCall=function(payload,utterance,fromFlag,intentData){if($("#utterance-text").prop("disabled",!0),$scope.currentSelectedTask=intentData?intentData:$scope.intentData,"indevelopment"===$scope.filterToggle){var key="state";if("DialogIntent"===$scope.currentSelectedTask.taskType&&(key="status"),"published"==$scope.currentSelectedTask[key])$scope.upgradeTask.currentUtt=$scope.btUtteranceObject.utteranceText,$scope.currentSelectedTask=$scope.intentData,$scope.upgradeTask.callbackType="addUtterance",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{if(!$scope.btUtteranceObject.utteranceText&&!payload&&!utterance)return $("#utterance-text").prop("disabled",!1),void $("#utterance-text").focus();var name;name="DialogIntent"===$scope.currentSelectedTask.type?$scope.currentSelectedTask.intent:$scope.currentSelectedTask.name,payload||(payload=utterance?{taskId:intentData._id,sentence:$scope.upgradeTask.currentUtt,streamId:streamId,taskName:name,type:intentData.taskType}:{taskId:$scope.intentData._id,sentence:$scope.btUtteranceObject.utteranceText,streamId:streamId,taskName:name,type:$scope.currentSelectedTask.taskType}),"uttModule"!==fromFlag&&"fromUpgrade"!==fromFlag||!payload||(payload.predictiveNer=!0),"information"===$scope.currentSelectedTask.taskType&&(payload.type="action"),$scope.loadingRules=!0,startSaving(".mainUtteranceInput"),setTimeout(function(){BTStreamsService.createUtterances(payload).then(function(res){$scope.getComponentById(),mixpanelEvent("createUtterance"),$scope.$emit("updateChecklist","machineLearningUtterances"),$scope.loadingRules=!1,res&&res.data&&($("#utterance-text").prop("disabled",!1),hideEntityDetails(),finishSaving(".mainUtteranceInput"),$scope.utterences.unshift(res.data),$scope.utterencesCopy=angular.copy($scope.utterences),$scope.btUtteranceObject.utteranceText="",$scope.count++,$scope.intentData.utteranceCount=$scope.count,$scope.autoTrainedUtteranceCount&&($scope.intentData.utteranceCount=$scope.count+$scope.autoTrainedUtteranceCount),NotificationService.notify(i18n.i18nString("utterence_created_sucess_noty"),"info"),$scope.isTrainInprogress()||($scope.showTrainSavingDiv=!1),mapColorEntityToWord(res.data),setTimeout(function(){$("#utterance-text").focus()},200),0!==res.data.entities.length&&(tempSel="#"+res.data._id,$timeout(function(){$(tempSel).trigger("focus")},100)),checkMLSyncStatus())},function(err){$scope.loadingRules=!1,$("#utterance-text").prop("disabled",!1),finishSaving(".mainUtteranceInput","error"),$scope.upgradeTask.currentUtt=$scope.btUtteranceObject.utteranceText,err.data&&err.data.errors&&err.data.errors.length&&400===err.data.errors[0].code&&err.data.errors[0].msg.includes("Please upgrade the task")?BTFlowtaskService.getDialog($workflowService.selectedStream()._id,$scope.intentData.dialogId).then(function(res){$scope.currentSelectedTask=$scope.intentData,$scope.currentSelectedTask.parentId=res.data.parentId,$scope.upgradeTask.callbackType="addUtterance",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"))},function(err){err.data&&err.data.errors&&err.data.errors.length>0&&NotificationService.notify(err.data.errors[0].msg,"error")}):err.data&&err.data.errors&&err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("problm_in_training_utter_noty"),"error")})},3e3)}}},appendUtterance=function(intent,deleteLimit,offset){$scope.offset=$scope.utterences.length,$scope.loadingRules=!0,BTStreamsService.getUtterances(intent._id,offset,deleteLimit,"",void 0,$workflowService.selectedStream()._id).then(function(res){$scope.utterences=$scope.utterences.concat(res.data.Sentences),$scope.utterences=_.unique($scope.utterences,"_id"),$scope.utterencesCopy=angular.copy($scope.utterences),$scope.moreAvailable=res.data.moreAvailable,$scope.count=res.data.count,intent.utteranceCount=$scope.count,$scope.loadingRules=!1},function(err){$scope.loadingRules=!1})},appendAutoUtterance=function(intent,deleteLimit,offset){$scope.offset=$scope.autoTrainedUtterances.length,$scope.loadingRules=!0,BTStreamsService.getUtterances(intentData._id,offset,deleteLimit,"","true",$workflowService.selectedStream()._id).then(function(res){$scope.loadingRules=!1,$scope.autoTrainedUtterances=$scope.autoTrainedUtterances.concat(res.data.Sentences),$scope.autoTrainedUtterances=_.unique($scope.autoTrainedUtterances,"_id"),$scope.moreAutoTrainedAvailable=res.data.moreAvailable,$scope.autoTrainedUtteranceCount=res.data.count})};$scope["delete"]=function(index,utterenceId,intentData){if($scope.currentSelectedTask=intentData?intentData:$scope.intentData,"indevelopment"===$scope.filterToggle){var key="state";if("DialogIntent"===$scope.currentSelectedTask.taskType&&(key="status"),"published"==$scope.currentSelectedTask[key])$scope.upgradeTask.currentIndex=index,$scope.upgradeTask.currentUtterenceId=utterenceId,$scope.upgradeTask.callbackType="deleteUtterance",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{var name;_.find($scope.utterences,function(utterance,i){return index=i,utterance._id==utterenceId});name=$scope.intentData&&"DialogIntent"===$scope.intentData.type?$scope.currentSelectedTask.intent:$scope.currentSelectedTask.name;var payload={taskId:$scope.currentSelectedTask._id,sentence:$("<div>"+$scope.utterences[index].sentence+"</div>").text(),streamId:streamId,type:$scope.currentSelectedTask.taskType,taskName:name};startSaving(".utteranceInput"+$scope.utterences[index]._id,!0),$scope.loadingRules=!0,BTStreamsService.deleteUtterances(payload,$scope.utterences[index]._id).then(function(res){$scope.loadingRules=!1,$scope.getComponentById(),finishSaving(".utteranceInput"+$scope.utterences[index]._id,null,!0),setTimeout(function(){hideEntityDetails()},500),$scope.utterences.splice(index,1),$scope.count--,$scope.intentData.utteranceCount=$scope.count,$scope.autoTrainedUtteranceCount&&($scope.intentData.utteranceCount=$scope.count+$scope.autoTrainedUtteranceCount),NotificationService.notify(i18n.i18nString("utterance_deleted"),"info"),$scope.showTrainSavingDiv=!1,!("developer"===$scope.activeTabType&&$scope.count>30)||$scope.utteranceSearch.searchQuery&&$scope.utteranceSearch.utteranceSearchQuery.length||appendUtterance($scope.intentData,1,30),!("auto"===$scope.activeTabType&&$scope.count>30)||$scope.utteranceSearch.searchQuery&&$scope.utteranceSearch.utteranceSearchQuery.length||appendAutoUtterance($scope.intentData,1,30),checkMLSyncStatus()},function(err){$scope.loadingRules=!1,finishSaving(".utteranceInput"+$scope.utterences[index]._id,"error",!0)})}}},$scope.searchUtterance=function(event){$scope.moreAvailable=!0,$scope.moreAutoTrainedAvailable=!0,$scope.offset=0,$scope.dataLoaded=!1,13!=event.keyCode&&$scope.utteranceSearch.utteranceSearchQuery||getUtterances($scope.intentData,!1,!0)},$scope.clearSearch=function(){$scope.utteranceSearch.utteranceSearchQuery="",$scope.moreAvailable=!0,$scope.moreAutoTrainedAvailable=!0,$scope.offset=0,getUtterances($scope.intentData,!1,!0)},$scope.clearSearchPattern=function(){$scope.search.searchQuery=""},$scope.clickedUtterance=function(utterence){$scope.currentSelectedUtterance=angular.copy(utterence)},$scope.editUtterence=function(index,utterenceId,utterence,intentData){if($scope.currentSelectedTask=intentData?intentData:$scope.intentData,"indevelopment"===$scope.filterToggle){var key="state";if("DialogIntent"===$scope.currentSelectedTask.taskType&&(key="status"),$scope.currentIndexValue=angular.copy($scope.utterences[index].sentence),""===$("#"+$scope.utterences[index]._id).text())return $scope.utterences[index].sentence=$scope.currentSelectedUtterance.sentence,$("#"+$scope.utterences[index]._id).text($scope.currentSelectedUtterance.sentence),NotificationService.notify(i18n.i18nString("utterences_shouldnot_empty_err_noty"),"error"),!1;if("published"==$scope.currentSelectedTask[key])$scope.currentEdit=$("#"+$scope.utterences[index]._id).text()&&$("#"+$scope.utterences[index]._id).text().trim(),$scope.upgradeTask.currentIndex=index,$scope.upgradeTask.currentUtterenceId=utterenceId,$scope.upgradeTask.currentUtt=utterence,$scope.upgradeTask.callbackType="editUtterence",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{_.find($scope.utterences,function(utterance,i){return index=i,utterance._id==utterenceId});if(!$scope.utterences[index].sentence)return;savedUtteranceFlag=!0;var focusedUtterance;utterence?focusedUtterance=utterence:(focusedUtterance=$("#"+$scope.utterences[index]._id).text()&&$("#"+$scope.utterences[index]._id).text().trim(),$scope.constants.config.hideMLEE&&(focusedUtterance=$("#"+$scope.utterences[index]._id).text()&&$("#"+$scope.utterences[index]._id).text().trim()));var name;name="DialogIntent"===$scope.intentData.type?$scope.currentSelectedTask.intent:$scope.currentSelectedTask.name;var payload={taskId:$scope.currentSelectedTask._id,sentence:focusedUtterance,entities:$scope.utterences[index].entities||[],streamId:streamId,type:$scope.currentSelectedTask.taskType,taskName:name};payload&&payload.sentence&&payload.entities&&payload.entities[index]&&payload.entities.startEndIndex&&payload.sentence.length<payload.entities[index].endIndex&&(payload.entities[index].endIndex=payload.sentence.length),startSaving(".utteranceInput"+$scope.utterences[index]._id),saveEditedUtterance(payload,index)}}},$scope.addUtterance=function(payload,utterance,fromFlag,e){e&&13===e.keyCode&&($scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1},addUtteranceCall(payload,utterance,fromFlag))},$scope.getComponentById=function(componentId){$scope.buildingRules=!0,componentId=componentId||$scope.intentData._id,BTFlowtaskService.getComponents($scope.selectedStream._id,componentId).then(function(result){$scope.intentData.nluRules=result.data.nluRules,buildWarnData()},function(err){$scope.buildingRules=!1})},$scope.getComponentsByDialogID=function(intentData){intentData.hide||!intentData.hasOwnProperty("dialogId")?BTFlowtaskService.getComponentsByType($scope.selectedStream._id,"entity").then(function(result){$scope.entityList=result.data,intentData.entitiesArray=$scope.entityList||[]}):BTFlowtaskService.getFlowtaskComponents($workflowService.selectedStream()._id,intentData.dialogId).then(function(res){intentData.entitiesArray=_.filter(res.data,{type:"entity"})||[],$scope.intentsArray=_.filter(res.data,{type:"intent"})||[]})},$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?task.isReport?"information":"action":task&&"DialogIntent"==task.taskType?"flowtask":""},$scope.upgrade=function(){$scope.isGlobalWorkProgress=!0,$scope.loaderMessage="Upgrading task..";var taskType=$scope.getTaskType($scope.currentSelectedTask);$scope.upgradeWorkflow($scope.currentSelectedTask,taskType)},$scope.cancelUpgrade=function(){$scope.currentSelectedUtterance&&$("#"+$scope.currentSelectedUtterance._id).length&&($("#"+$scope.currentSelectedUtterance._id)[0].innerHTML=$scope.currentSelectedUtterance.sentence),$("#utterance-text").prop("disabled",!1),setTimeout(function(){$("#utterance-text").focus()},100)},$scope.upgradeWorkflow=function(task,type){"alert"===type?BTAlertsService.upgradeBTAlert(task._id).then(function(response){BTAlertsService.upgradeMPAlert(task._id,response.data._id).then(function(upgradeRes){BTAlertsService.configured(upgradeRes.data._id).then(function(configRes){$scope.cb.loadingEntities(streamId,type,configRes.data[0],"fromUpgrade"),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type||"information"===type?BTActionsService.upgradeBTAction(task._id).then(function(response){BTActionsService.upgradeMPAction(task._id,response.data._id).then(function(upgradeRes){BTActionsService.configured(upgradeRes.data._id).then(function(configRes){$scope.cb.loadingEntities(streamId,type,configRes.data[0],"fromUpgrade"),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,task.parentId||task.dialogId).then(function(res){$scope.isGlobalWorkProgress=!1,$scope.cb.loadingEntities(streamId,"DialogIntent",res.data,"fromUpgrade")},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.cb.getUtterances=function(intent,cb){$scope.constants.config.hideMLEE?console.log("hide"):$scope.entityCallbacks&&$scope.entityCallbacks.updateDropDownPostion&&$scope.entityCallbacks.updateDropDownPostion(!1),"DialogIntent"==intent.type?($scope.intentData=intent,$scope.getComponentsByDialogID($scope.intentData)):"intent"==intent.type&&($scope.intentData=intent,$scope.intentData.taskType="DialogIntent",$scope.getComponentsByDialogID($scope.intentData)),$scope.viewMode&&($scope.flowTaskDisplayMode=$scope.viewMode,$scope.flowTaskDisplayMode=$scope.displayMode.toUpperCase()),$scope.showTrainBtn=cb.showTrainBtn,$scope.showTrainSavingDiv=cb.showTrainSavingDiv,$scope.moreAvailable=!0,$scope.utterences=[],getUtterances(intent,null,null,cb),$timeout(function(){$(".utterances-content-view").animate({scrollTop:0})},500)};var prepareTrainProgressLabel=function(){$scope.trainSyncData&&($scope.trainSyncData.hasOwnProperty("isMlInSyncWithSentences")&&!$scope.trainSyncData.isMlInSyncWithSentences&&$scope.trainSyncData.hasOwnProperty("isMlInSyncWithTraits")&&!$scope.trainSyncData.isMlInSyncWithTraits?$scope.trainProgressLabel=" Intent, Entity & Traits training are currently in progress. ":$scope.trainSyncData.hasOwnProperty("isMlInSyncWithSentences")&&!$scope.trainSyncData.isMlInSyncWithSentences?$scope.trainProgressLabel=" Intent & Entity training are currently in progress.  ":$scope.trainSyncData.hasOwnProperty("isMlInSyncWithTraits")&&!$scope.trainSyncData.isMlInSyncWithTraits&&($scope.trainProgressLabel="Traits training is currently in progress. "))};$scope.trainBot=function(){$scope.showTrainBtn=!1,$scope.showTrainSavingDiv=!0,$scope.trainStatus={success:!1,failed:!1,saving:!0},prepareTrainProgressLabel(),$scope.loadingRules=!0,BTStreamsService.trainUtterances(streamId).then(function(res){$scope.loadingRules=!1,$scope.getComponentById(),$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$emit("clearTestTrainText"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open"),NotificationService.notify(i18n.i18nString("utterences_training_intiated"),"info"),$scope.trainTitle=""},function(err){$scope.loadingRules=!1,$scope.trainStatus={success:!1,failed:!0,saving:!1},err.data.errors.length>0?(NotificationService.notify(err.data.errors[0].msg,"error"),$scope.trainTitle=err.data.errors[0].msg):($scope.trainTitle=i18n.i18nString("problm_in_training_utter_noty"),NotificationService.notify(i18n.i18nString("utterences_training_intiated_err"),"error"))})},$scope.closeTrainSaveDiv=function(){$scope.showTrainSavingDiv=!1,$scope.trainStatus={success:!0,failed:!1,saving:!1},$scope.speechTrainStatus={success:!0,failed:!1,saving:!1},$scope.trainTitle=""},$scope.deleteAutoTrainUtterance=function(index,utterenceId){$scope.currentSelectedTask=$scope.intentData;var name,key="state";if("DialogIntent"===$scope.currentSelectedTask.taskType&&(key="status"),name="DialogIntent"===$scope.intentData.type?$scope.currentSelectedTask.intent:$scope.currentSelectedTask.name,"published"==$scope.currentSelectedTask[key])return $scope.upgradeTask.currentIndex=index,$scope.upgradeTask.currentUtterenceId=utterenceId,$scope.upgradeTask.callbackType="deleteUtterance",void NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));var payload={taskId:$scope.currentSelectedTask._id,sentence:$("<div>"+$scope.autoTrainedUtterances[index].sentence+"</div>").text(),streamId:streamId,type:$scope.currentSelectedTask.taskType,taskName:name};startSaving(".utteranceInput"+$scope.autoTrainedUtterances[index]._id,!0),$scope.loadingRules=!0,BTStreamsService.deleteUtterances(payload,$scope.autoTrainedUtterances[index]._id).then(function(res){hideEntityDetails(),finishSaving(".utteranceInput"+$scope.autoTrainedUtterances[index]._id,null,!0),setTimeout(function(){$scope.autoTrainedUtterances.splice(index,1)},500),$scope.autoTrainedUtteranceCount--,$scope.count&&($scope.intentData.utteranceCount=$scope.count+$scope.autoTrainedUtteranceCount),NotificationService.notify(i18n.i18nString("utterance_deleted"),"info"),$scope.trainBot(),$scope.loadingRules=!1,$scope.getComponentById()},function(err){$scope.loadingRules=!1,finishSaving(".utteranceInput"+$scope.autoTrainedUtterances[index]._id,"error",!0)})};var mlUtteranceTrainFailedHandler=$rootScope.$on("MLUtterencesTrainFailed",function($event){$scope.trainStatus={success:!1,failed:!0,saving:!1},$scope.trainTitle=i18n.i18nString("problm_in_training_utter_noty"),$scope.speechTrainStatus.saving||setTimeout(function(){$scope.showTrainBtn=!0},350)}),mlUtteranceHandler=$rootScope.$on("MLUtterencesTrainFinished",function($event){$scope.trainStatus={success:!0,failed:!1,saving:!1},$scope.trainTitle="",setTimeout(function(){$scope.showTrainBtn=!1,$scope.showTrainSavingDiv=!1},3e3)});$rootScope.$on("MLSpeechTrainFinished",function($event){$scope.speechTrainStatus={success:!0,failed:!1,saving:!1},$scope.speechTrainTitle="",$scope.trainStatus.failed&&setTimeout(function(){$scope.showTrainBtn=!0,$scope.showTrainSavingDiv=!1},350)}),$rootScope.$on("MLSpeechTrainFailed",function($event){$scope.speechTrainStatus={success:!1,failed:!0,saving:!1},$scope.speechTrainTitle=i18n.i18nString("speech_training_intiated_err"),$scope.trainStatus.saving||setTimeout(function(){$scope.showTrainBtn=!0},350)}),$(document).on("click",function(e){$(e.target)&&$(e.target).scope()&&!$(e.target).hasClass("utterance-item-title")&&!$(e.target).scope().entitiesList&&($scope.entityCmpt.showentityDropdown=!1,
$element.find(".entity-selection-dropdown").removeClass("entity-selection-dropdown"))}),$scope.$on("$destroy",function(){$(".utterances-content-view").off("scroll",bindScroll)}),$scope.showActiveType=function(tab,type,_trainStatus){allintentsObj(),Object.keys($scope.views).forEach(function(view){$scope.views[view]=!1}),Object.keys($scope.views).forEach(function(view){$scope.showView[view]=!0}),$scope.views[tab]=!0,$scope.flowTaskDisplayMode=$workflowService.flowTaskDisplayMode(),$scope.flowTaskDisplayMode&&$scope.flowTaskDisplayMode.length&&($scope.flowTaskDisplayMode=$scope.flowTaskDisplayMode.toUpperCase()),_trainStatus&&($scope.showTrainBtn=_trainStatus.showTrainBtn,$scope.showTrainSavingDiv=_trainStatus.showTrainSavingDiv,$scope.trainStatus=_trainStatus.trainStatus),"utterances"===tab?($scope.btUtteranceObject.utteranceText="",$scope.utterences=[],$scope.autoTrainedUtterances=[],$scope.offset=0,$scope.utteranceSearch.utteranceSearchQuery="",$scope.loadingUtterances=!0,$scope.moreAvailable=!0,$scope.moreAutoTrainedAvailable=!0,getUtterances($scope.intentData,!1,!1)):"patterns"===tab?($scope.patternsCB.loadingPatterns=!0,type=type?type:$scope.intentData.taskType,$scope.iPatterns={},$scope.patternsCB.onClickTask($scope.intentData,type)):"negativepatterns"===tab?(type=type?type:$scope.intentData.taskType,$scope.negativepatternsCB.loadingNegativePatterns=!0,$scope.negativepatternsCB.onClickTask($scope.intentData,type)):"rules"===tab&&($scope.patternsCB.loadingPatterns=!0,type=type?type:$scope.intentData.taskType,$scope.traitRules.traitMappings=$scope.intentData.traitRules||[],$scope.patternsCB.onClickTraits($scope.intentData,type,$scope.traitRules)),buildWarnData()},$scope.onClickEntity=function(selectedEntity,tab,type){$scope.selectedTask=selectedEntity,Object.keys($scope.views).forEach(function(view){$scope.views[view]=!1}),$scope.views[tab]=!0,Object.keys($scope.showView).forEach(function(view){$scope.showView[view]=!1}),$scope.showView[tab]=!0,$scope.patternsCB.onClickEntity($scope.selectedTask,type)},$scope.selectIntent=function(intent){$scope.intentData=intent,$scope.getComponentById(),$scope.intentData.type="DialogIntent",$scope.intentData.taskType="DialogIntent",$scope.intentData.patternsArray=[],$scope.intentData.patterns=intent.patterns||[],$scope.intentData.patterns.forEach(function(msg){msg.original=decodePattern(msg.original)}),$scope.intentData.patterns.map(function(pattern){$scope.intentData.patternsArray.push(pattern.original)}),$scope.loadingUtterances=!0,$scope.utterences=[],$scope.moreAvailable=!0,getUtterances(intent,null,null),$scope.showActiveType("utterances")},$scope.cb.intentsObj={},$scope.setIntent=function(intentId){$scope.primaryIntentData=_.find($scope.cb.allIntents,{_id:intentId}),$scope.primaryIntentData&&$scope.selectIntent($scope.primaryIntentData)},$scope.redirectToLink=function(linkType){$rootScope.redirectToLink(linkType)};var prepareTrainLabel=function(data){$scope.trainStatus&&!$scope.trainStatus.saving&&($scope.showTrainBtn=!0),data.hasOwnProperty("isMlInSyncWithSentences")&&!data.isMlInSyncWithSentences&&data.hasOwnProperty("isMlInSyncWithTraits")&&!data.isMlInSyncWithTraits?$scope.trainLabel=i18n.i18nString("untrained_utterances_ml_traits"):data.hasOwnProperty("isMlInSyncWithSentences")&&!data.isMlInSyncWithSentences?$scope.trainLabel=i18n.i18nString("untrained_utterance_ml"):data.hasOwnProperty("isMlInSyncWithTraits")&&!data.isMlInSyncWithTraits&&($scope.trainLabel=i18n.i18nString("untrained_utterance_traits"));var _obj={trainLabel:$scope.trainLabel,showTrainBtn:$scope.showTrainBtn,trainStatus:$scope.trainStatus,trainProgressLabel:$scope.trainProgressLabel};$scope.cb&&$scope.cb.updateTrainBtnDetails&&$scope.cb.updateTrainBtnDetails(_obj)};$scope.checkForRules=function(rules){return rules&&Object.keys(rules)&&Object.keys(rules).length?!0:!1},$scope.patternsCB.updateStatus=function(status){$scope.saveStatus=status},$scope.$on("$destroy",function(){mlUtteranceHandler(),mlUtteranceTrainFailedHandler()}),$scope.cb.addUtteranceCall=addUtteranceCall,$scope.cb.editUtterance=$scope.editUtterence,$scope.cb.deleteUtterance=$scope["delete"],$scope.cb.mapEntityToWord=$scope.context.mapEntityToWord,$scope.cb.showActiveType=$scope.showActiveType,$scope.cb.onClickEntity=$scope.onClickEntity,$scope.cb.checkMLSyncStatus=checkMLSyncStatus}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("namespacesSearchAccordions",function(){return{restrict:"E",scope:{cb:"=",manVarCb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/namespaces-search-accordions/namespaces-search-accordions.html",controller:["$scope","$workflowService","NotificationService","BTStreamsService","BTFlowtaskService","$applicationService","env_conf","i18n","accessControlService",function($scope,$workflowService,NotificationService,BTStreamsService,BTFlowtaskService,$applicationService,env_conf,i18n,accessControlService){function showError(err){try{NotificationService.notify(err.data.errors[0].msg,"error")}catch(e){NotificationService.notify("Unable to process your request, please try after some time!","error")}}function attachCollapse(){setTimeout(function(){$(".accordion-namespaces-comp .collapse").off("show.bs.collapse"),$(".accordion-namespaces-comp .collapse").on("show.bs.collapse",function(e){var targetId=e.target.getAttribute("data-namespace-id");$("#"+e.target.id).hide(),$("#"+e.target.id).next(".loading-namespace-variables").show(),BTStreamsService.getNSVariables($applicationService.userInfo().userId,$workflowService.selectedStream()._id,targetId).then(function(res){$("#"+e.target.id).show(),$("#"+e.target.id).next(".loading-namespace-variables").hide();var globalData=_.filter(res.data,function(val){return"env"==val.variableType});globalData=_.map(globalData,function(val){return _.pick(val,"key","value","variableType","group","hint","state")});var localData=_.filter(res.data,function(val){return"locale"==val.variableType});localData=_.map(localData,function(val){return _.pick(val,"key","value","variableType","group","hint","state")});var allData=globalData.concat(localData);_.map(allData,function(val){return val.variableType="env"==val.variableType?"Global":"Content",val}),allData=_.filter(allData,function(val){return"published"==$scope.manVarCb.state?"published"==val.state:"configured"==val.state});var varCounts=_.countBy(res.data,function(val){return"configured"==val.state&&"env"==val.variableType?"globConfVar":"configured"==val.state&&"locale"==val.variableType?"locConfVar":"published"==val.state&&"env"==val.variableType?"globPubVar":"published"==val.state&&"locale"==val.variableType?"locPubVar":void 0}),findLoc=_.findWhere($scope.addedNamespacesObjects,{_id:targetId});findLoc.tableData=allData,findLoc.searchName="",findLoc.searchValue="",findLoc.search={showName:!1,showValue:!1},findLoc.type={global:!1,content:!1,all:!0},findLoc.delay=!1,findLoc.group={group:!0,notes:!1},findLoc.counts=varCounts},function(err){})})},500)}$scope.greyTrash=env_conf["context-url"]+"/assets/icons-new/delete-trash/trash-red-delete.svg",$scope.searchGreen=env_conf["context-url"]+"/assets/icons-new/search/search-green.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/icons/close.svg",$scope.checkGreen=env_conf["context-url"]+"/assets/icons-new/check-mark/check-green.svg",$scope.checkGrey=env_conf["context-url"]+"/assets/icons-new/check-mark/check-gray.svg",$scope.caretDown=env_conf["context-url"]+"/assets/icons-new/caret/caret-down-gray.svg",$scope.emptyScreen=env_conf["context-url"]+"/img/emptyImgNew.svg",$scope.selectedState=$workflowService.selectedStreamState(),$scope.inputNamespace="",$scope.nlpPermission=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE");var allNamespaces=[];$scope.addedNamespacesObjects=[],$scope.selected={text:null},$scope.group={group:!0,notes:!1},$scope.isNamespacesLoading=!0,$scope.searchClick=function(label,data,ind){"name"==label?(data.search.showName=!0,setTimeout(function(){$("#searchName"+ind).focus()},100)):"value"==label&&(data.search.showValue=!0,setTimeout(function(){$("#searchValue"+ind).focus()},100))},$scope.resetSearch=function(nsData){nsData.searchName="",nsData.searchValue="",nsData.search.showName=!1,nsData.search.showValue=!1},$scope.manVarCb.propertyPanelRadio=function(radio){var payload={};"use"==radio?(payload={useTaskLevelNs:!0,vNameSpace:[]},BTFlowtaskService.updateComponent($workflowService.selectedStream()._id,$scope.manVarCb.nodeInfoId,payload).then(function(res){$scope.manVarCb.propertyPanelNamespaceupdate(res.vNameSpace),$scope.manVarCb.propertyPanelNamespaceRadioUpdate(res.data.useTaskLevelNs),_.findWhere($workflowService.selectedDialogComponents(),{_id:$scope.manVarCb.nodeInfoId}).vNameSpace=[],_.findWhere($workflowService.selectedDialogComponents(),{_id:$scope.manVarCb.nodeInfoId}).useTaskLevelNs=res.data.useTaskLevelNs,NotificationService.notify(i18n.i18nString("var_ns_updated_succ"),"success")},function(err){showError(err),$scope.manVarCb.selectCustRadio("customize")})):"customize"==radio&&(payload={useTaskLevelNs:!1},BTFlowtaskService.updateComponent($workflowService.selectedStream()._id,$scope.manVarCb.nodeInfoId,payload).then(function(res){$scope.manVarCb.propertyPanelNamespaceupdate(res.vNameSpace),$scope.manVarCb.propertyPanelNamespaceRadioUpdate(res.data.useTaskLevelNs),_.findWhere($workflowService.selectedDialogComponents(),{_id:$scope.manVarCb.nodeInfoId}).vNameSpace=[],_.findWhere($workflowService.selectedDialogComponents(),{_id:$scope.manVarCb.nodeInfoId}).useTaskLevelNs=res.data.useTaskLevelNs,$scope.addedNamespacesObjects=[],$scope.manVarCb.addedNamespaces=[],$scope.manVarCb.newlyAddedNS=[],NotificationService.notify(i18n.i18nString("var_ns_updated_succ"),"success")},function(err){showError(err),$scope.manVarCb.selectCustRadio("customize")}))},$scope.addNamespace=function(e){if(13==e.which){if(!_.some(allNamespaces,function(el){return el.name===e.target.value}))return void NotificationService.notify(i18n.i18nString("ns_entered_not_avai"),"error");var findId=_.findWhere(allNamespaces,{name:e.target.value})._id;if($scope.manVarCb.addedNamespaces.indexOf(findId)>-1||$scope.manVarCb.newlyAddedNS.indexOf(findId)>-1)return void NotificationService.notify(i18n.i18nString("ns_entered_prese"),"warning");if($scope.manVarCb.newlyAddedNS.push(findId),$scope.addedNamespacesObjects.push(_.findWhere(allNamespaces,{_id:findId})),$scope.inputNamespace="",e.target.value="",$("#namespaceTypeahead"+$scope.manVarCb.flagName).off("click"),$("#namespaceTypeahead"+$scope.manVarCb.flagName).on("click",function(){$("#namespaceTypeahead"+$scope.manVarCb.flagName).eq(0).val("n").trigger("input"),$("#namespaceTypeahead"+$scope.manVarCb.flagName).eq(0).val("").trigger("input")}),"propertyPanel"==$scope.manVarCb.flagName){$scope.manVarCb.addedNamespaces.push(findId);var payload={useTaskLevelNs:!1,vNameSpace:$scope.manVarCb.addedNamespaces};BTFlowtaskService.updateComponent($workflowService.selectedStream()._id,$scope.manVarCb.nodeInfoId,payload).then(function(res){$scope.manVarCb.propertyPanelNamespaceupdate(res.data.vNameSpace),$scope.manVarCb.propertyPanelNamespaceRadioUpdate(res.data.useTaskLevelNs),_.findWhere($workflowService.selectedDialogComponents(),{_id:$scope.manVarCb.nodeInfoId}).vNameSpace=res.data.vNameSpace,_.findWhere($workflowService.selectedDialogComponents(),{_id:$scope.manVarCb.nodeInfoId}).useTaskLevelNs=res.data.useTaskLevelNs},function(err){showError(err),$scope.manVarCb.addedNamespaces.pop(),$scope.addedNamespacesObjects.pop()})}}},$scope.selectVarType=function(typ,data){data.type={global:!1,content:!1,all:!1},data.type[typ]=!0,data.delay=!1,setTimeout(function(){data.delay=!0},100)},$scope.checkKey=function(e){27==e.which&&$scope.resetSearch()},$scope.removeNS=function(event,cell){function remove(){if($scope.manVarCb.addedNamespaces=_.without($scope.manVarCb.addedNamespaces,cell._id),$scope.manVarCb.newlyAddedNS=_.without($scope.manVarCb.newlyAddedNS,cell._id),$scope.addedNamespacesObjects=_.without($scope.addedNamespacesObjects,_.findWhere($scope.addedNamespacesObjects,{_id:cell._id})),$("#namespaceLastDelete")&&$("#namespaceLastDelete").modal("hide"),"propertyPanel"==$scope.manVarCb.flagName){var payload={useTaskLevelNs:!1,vNameSpace:$scope.manVarCb.addedNamespaces};BTFlowtaskService.updateComponent($workflowService.selectedStream()._id,$scope.manVarCb.nodeInfoId,payload).then(function(res){$scope.manVarCb.propertyPanelNamespaceupdate(res.data.vNameSpace),$scope.manVarCb.propertyPanelNamespaceRadioUpdate(res.data.useTaskLevelNs),_.findWhere($workflowService.selectedDialogComponents(),{_id:$scope.manVarCb.nodeInfoId}).vNameSpace=res.data.vNameSpace||[],_.findWhere($workflowService.selectedDialogComponents(),{_id:$scope.manVarCb.nodeInfoId}).useTaskLevelNs=res.data.useTaskLevelNs},function(err){})}}event.preventDefault(),event.stopPropagation(),1==$scope.addedNamespacesObjects.length&&"propertyPanel"!==$scope.manVarCb.flagName||"propertyPanel"===$scope.manVarCb.flagName?($("#namespaceLastDelete").modal("show"),setTimeout(function(){$("#proceed_removeNs").off("click"),$("#proceed_removeNs").on("click",remove)},500)):remove()},$scope.closeNamespaceLastDel=function(){$("#namespaceLastDelete").modal("hide")},$scope.selectGroupNotes=function(typ,data){data.group={group:!1,notes:!1},data.group[typ]=!0},$scope.attachCollapse=attachCollapse;var init=function(){$scope.manVarCb.newlyAddedNS=[],$scope.addedNamespacesObjects=[],BTStreamsService.getAllNamespaces($applicationService.userInfo().userId,$workflowService.selectedStream()._id,{_headers:{state:$scope.manVarCb.state}}).then(function(res){allNamespaces=_.map(res.data,function(val){var temp=_.pick(val,"name","_id","gVariables","cVariables");return temp.nsType=val.type,temp}),$("#namespaceTypeahead"+$scope.manVarCb.flagName).typeahead({minLength:0,items:9999,showHintOnFocus:!0,autoSelect:!1,source:allNamespaces}),_.each($scope.manVarCb.addedNamespaces,function(val){_.findWhere(allNamespaces,{_id:val})?$scope.addedNamespacesObjects.push(_.findWhere(allNamespaces,{_id:val})):null}),setTimeout(function(){$scope.isNamespacesLoading=!1},100)},function(err){"NO"!==$scope.nlpPermission&&NotificationService.notify(i18n.i18nString("failed_load_ns"),"error"),$scope.isNamespacesLoading=!1})};init()}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("focusIn",function(){return{restrict:"AE",link:function($scope,$element,$attrs){$element.on("click",function(){$element.addClass("noBackGround")}),$element.on("focusout",function(){$element.removeClass("noBackGround")})}}}),_module.directive("negativePatterns",[function(){return{restrict:"EA",scope:{stream:"=?",context:"=",hideUi:"@",cb:"=",intent:"=?",showTrain:"=?",saveStatusNpattern:"=?",views:"=?",showIntentsLabel:"=?",search:"=?",selectedTask:"=?",flowTaskMode:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/negative-patterns/negative-patterns.html",controller:["$scope","_constants_","$workflowService","$timeout","BTFlowtaskService","$q","BTAlertsService","BTActionsService","BTStreamsService","$applicationService","env_conf","accessControlService","i18n",function($scope,_constants_,$workflowService,$timeout,BTFlowtaskService,$q,BTAlertsService,BTActionsService,BTStreamsService,$applicationService,env_conf,accessControlService,i18n){function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}function sortableCallback1(e,ui){$timeout(function(){var sortIndex=0;saveIntentPatterns($scope.selectedTask,!0,void 0,sortIndex)},200)}function sortableCallback2(e,ui){$timeout(function(){if($scope.selectedTask){var sortIndex=0;saveIntentPatterns($scope.selectedTask,!0,void 0,sortIndex)}},200)}function createPattern(task,text,isInlineMode){var payload={input:text,intend:task.name,resourceId:task._id};$scope.saving=!0,BTStreamsService.createPattern($scope.stream._id,payload).then(function(res){isInlineMode||$scope.cancelAddPattern(),$scope.tPattern.newTaskPattern="",$scope.selectedTask.negativePatterns=res.data,$scope.editTaskPattern=null,$scope.saving=!1,NotificationService.notify(i18n.i18nString("patrn_module_added_sucess"),"success")},function(err){var msg=getErrorMsg(err,i18n.i18nString("patrn_module_adding_field"));NotificationService.notify(msg,"error"),$scope.saving=!1})}function indexUpdateForEntitiesOrIntentsPatterns(mode){$scope.allIntent=$scope.intents,$scope.intentPatternsObject=angular.copy($scope.initialObject),$scope.intentPatternsObject=$scope.intents,$scope.intentPatternsObject=$scope.intentPatternsObject.concat($scope.allTasks),$scope.intentPatternsObject=_constants_.getAlphabeticallySortedArray($scope.intentPatternsObject,"name"),$scope.indexObject=angular.copy($scope.intentPatternsObject)}function resolveIntents(type,intent,fromUpgrade){BTFlowtaskService.getEntitiesOrIntents(streamId,type).then(function(res){res.data&&(intent&&($scope.intents=[]),$scope.intents=$scope.intents.concat(res.data),getFlowTasks().then(function(response){$scope.dialogs=response.data;var hiddenDialogTasks=_.filter($scope.dialogs,function(dialog){return dialog.isDeleted}),hiddenDialogTasksIds=_.pluck(hiddenDialogTasks,"_id");$scope.intents.map(function(intent){-1!==$.inArray(intent.dialogId,hiddenDialogTasksIds)&&(intent.isDeleted=!0)})}),$scope.findParenttasks($scope.intents),mapPatternsArray($scope.intents),fromUpgrade&&$scope.showUpgradedPattern(type,intent))},function(error){})}function loadingEntities(id,task){$scope.taskFieldPatternsLoading=!0,task?tasks.push(task):(tasks=tasks.concat($workflowService.alertTasks()),tasks=tasks.concat($workflowService.actionTasks())),tasks=_.filter(tasks,function(task){return"inProgress"!==task.state}),$scope.tasks=JSON.parse(JSON.stringify(tasks)),$scope.taskFieldPatternsLoading=!1,$scope.findParenttasks($scope.tasks),prepareTasksPatternsArray(),loadPatterns()}function indexUpdateForTaskPatterns(mode){$scope.taskPatternsObject=angular.copy($scope.initialObject),$scope.allTasks=$scope.tasks,$scope.allIntent=$scope.intents,$scope.taskPatternsObject=$scope.tasks,$scope.indexObject=angular.copy($scope.taskPatternsObject),$scope.intentPatternsObject=$scope.allIntent.concat($scope.allTasks),$scope.intentPatternsObject=_constants_.getAlphabeticallySortedArray($scope.intentPatternsObject,"name")}function prepareTasksPatternsArray(){$scope.tasks.map(function(task){task.negativePatternsArray=[],task.negativePatterns=task.negativePatterns||[],task.negativePatterns.forEach(function(msg){msg.original=decodePattern(msg.original)}),task.negativePatterns.map(function(pattern){task.negativePatternsArray.push(pattern.original)})})}function loadPatterns(){indexUpdateForTaskPatterns()}function getErrorMsg(err,defaultMsg){return err=err&&err.data,err&&err.errors&&err.errors[0]&&err.errors[0].msg||defaultMsg}function updateComponentPatterns(component,msg,index,sortIndex,intent){$scope.saveStatusNpattern={initial:!1,pending:!0,completed:!1,failed:!1},BTFlowtaskService.updateNegativePatterns($scope.stream._id,$scope.userId,{resourceId:component._id,negativePatterns:component.negativePatternsArray}).then(function(res){component.negativePatterns=angular.copy(res.data.negativePatterns),intent&&(intent.negativePatterns=angular.copy(res.data.negativePatterns),intent.negativePatternsArray=angular.copy(component.negativePatternsArray),$scope.selectedTask.negativePatterns=angular.copy(res.data.negativePatterns),$scope.selectedTask.negativePatternsArray=angular.copy(component.negativePatternsArray)),$.each($scope.intentPatternsObject,function(i,intentCopy){component._id==intentCopy._id&&($scope.intentPatternsObject[i].negativePatterns=res.data.negativePatterns||[])}),$scope.saveStatusNpattern={initial:!1,pending:!1,completed:!0,failed:!1},index>=0?NotificationService.notify(i18n.i18nString("negative_patterns_updated"),"success"):sortIndex>=0?NotificationService.notify(i18n.i18nString("negative_pattern_reorder"),"success"):(msg=msg||i18n.i18nString("negative_pattern_added"),NotificationService.notify(msg,"success")),$scope.iPatterns.newIntentPattern="",$scope.iPatterns.editIntentPattern="",$timeout(function(){$scope.saveStatusNpattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)},function(err){NotificationService.notify(err.data.errors[0].msg,"error"),$scope.saveStatusNpattern={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatusNpattern={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)})}function onClickTask(selectedTask,type){$scope.selectedTask=selectedTask,$scope.intent=selectedTask;var _currentTask;$(".negative-pattern-body").animate({scrollTop:0}),$scope.iPatterns={},$scope.iPatterns.newIntentPattern="",type&&($scope.selectedTask.type="alert"===type?"webservice":type),"alert"===type?(_currentTask=_.find($scope.tasks,{_id:selectedTask._id}),_currentTask&&($scope.selectedTask.negativePatternsArray=_currentTask.negativePatternsArray||[])):(_currentTask=_.find($scope.intents,{_id:selectedTask._id}),_currentTask&&($scope.selectedTask.negativePatternsArray=_currentTask.negativePatternsArray||[])),$scope.viewMode&&($scope.displayMode=$scope.viewMode.toUpperCase()),$timeout(function(){$scope.cb.loadingNegativePatterns=!1},500)}$scope.$emit("nestedComponentLoaded",{id:"negativePatterns",flag:!1}),$scope.initialObject=[{a:[],b:[],c:[],d:[],e:[],f:[],g:[],h:[],i:[],j:[],k:[],l:[],m:[],n:[],o:[],p:[],q:[],r:[],s:[],t:[],u:[],v:[],w:[],x:[],y:[],z:[],other:[]}],$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.intentPatternsObject=angular.copy($scope.initialObject),$scope.stream=angular.copy($workflowService.selectedStream()),$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png";var streamId=$scope.stream._id;$scope.userId=$applicationService.userInfo().userId,$scope.constants=_constants_,$scope.assetsBase=env_conf["assets-url"],$scope.intents=[],$scope.tasks=[],$scope.upgradedTasks=[],$scope.iPatterns={},$scope.tPattern={},$scope.editIntentPatternId=null,$scope.filterToggle=$workflowService.selectedStreamState(),$scope.clickedIntentIndexId=null,$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.searchClose=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.searchIcon=env_conf["context-url"]+"/assets/icons/search.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/icons-new/close/close-dark.svg";var tasks=[];$scope.sortableOptions1={handle:".sortBar1","ui-floating":!0,update:sortableCallback1},$scope.sortableOptions2={handle:".sortBar2","ui-floating":!0,update:sortableCallback2},$scope.saveTaskPatternsObject=function(task){if("indevelopment"===$scope.filterToggle){var key="state";"published"==task[key]?($scope.currentTask=task,$scope.upgradeCopy.upgradeFrom="patterns",$scope.currentPattern=$scope.tPattern.newTaskPattern,$scope.upgradeCopy.upgradeType="addPattern",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"))):task.newTaskPattern&&null!==task.newTaskPattern&&""!==task.newTaskPattern?createPattern($scope.editTaskPattern,task.newTaskPattern,!0):null!==$scope.tPattern.newTaskPattern&&""!==$scope.tPattern.newTaskPattern&&createPattern(task,$scope.tPattern.newTaskPattern,!0)}},$scope.cancelUpgrade=function(){},$scope.currentPatternValue=" ",$scope.clickIntentPattern=function(index,pattern,intent,parentIndex){$scope.currentPatternValue=angular.copy(pattern),$(".intentPatternClass").removeClass("hide"),$(".inputIntentClass").addClass("hide"),$scope.iPatterns.editIntentPattern=decodePattern(pattern.original),$scope.tPattern.editTaskPattern=decodePattern(pattern.original),$(".hidingIntentPatterns"+intent.type+index).addClass("hide"),$(".editingIntentPatterns"+intent.type+index).removeClass("hide"),$(".fieldPatternInput"+intent.type).focus()};var saveIntentPatterns=function(intent,isIntentSortFrom,index,sortIndex,parentIndex){var intentCopy=angular.copy(intent);if("indevelopment"===$scope.filterToggle){var key="state";if("DialogIntent"===intent.type&&(key="status"),"published"==intent[key])$scope.currentTask=intent,void 0===index&&($scope.currentPattern=$scope.iPatterns.newIntentPattern,$scope.upgradeType="addPattern"),NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else if(index>=0){var newIndex;intentCopy.negativePatternsArray=_.pluck(intentCopy.negativePatterns||[],"original")||[],intent.negativePatternsArray=_.pluck(intent.negativePatterns||[],"original")||[];var negativePatternsOldValues=_.pluck(intentCopy.negativePatterns||[],"value")||[];_.forEach(negativePatternsOldValues,function(value,index){$scope.currentPatternValue&&$scope.currentPatternValue.original&&value===$scope.currentPatternValue.original&&(newIndex=index)}),"webservice"===intent.type?intentCopy.negativePatternsArray[newIndex]=intentCopy.negativePatternsArray[newIndex].replace(intentCopy.negativePatternsArray[newIndex],$scope.tPattern.editTaskPattern):intentCopy.negativePatternsArray[newIndex]=intentCopy.negativePatternsArray[newIndex].replace(intentCopy.negativePatternsArray[newIndex],$scope.iPatterns.editIntentPattern),updateComponentPatterns(intentCopy,"",newIndex,void 0,intent),$(".hidingIntentPatterns"+intent.type+index).removeClass("hide"),$(".editingIntentPatterns"+intent.type+index).addClass("hide")}else intentCopy.negativePatternsArray=_.pluck(intentCopy.negativePatterns||[],"original")||[],!isIntentSortFrom&&intentCopy.negativePatternsArray&&intentCopy.negativePatternsArray.length?(intentCopy.negativePatternsArray.push($scope.iPatterns.newIntentPattern),updateComponentPatterns(intentCopy,"",void 0,sortIndex,intent)):isIntentSortFrom?updateComponentPatterns(intentCopy,"",void 0,sortIndex,intent):($scope.currentPattern&&"addPattern"===$scope.upgradeType?intentCopy.negativePatternsArray.push($scope.currentPattern):intentCopy.negativePatternsArray.push($scope.iPatterns.newIntentPattern),updateComponentPatterns(intentCopy,"",void 0,sortIndex,intent))}};$scope.saveIntentPatternsObject=function(e,intent,isIntentSortFrom,index,sortIndex,parentIndex){e&&13===e.keyCode&&saveIntentPatterns(intent,isIntentSortFrom,index,sortIndex,parentIndex)},$scope.removeEditMode=function(intent,index,parentIndex){var _ele=$(".hidingIntentPatterns"+intent.type+index);$(".hidingIntentPatterns"+intent.type+index).removeClass("hide"),$(".editingIntentPatterns"+intent.type+index).addClass("hide"),setTimeout(function(){_ele.parent().hasClass("noBackGround")&&_ele.parent().removeClass("noBackGround")},200)},$scope.cancelIntentPattern=function(resetIndex){resetIndex&&($scope.editIntentPatternId=null);var indexIntent=-1;$scope.intents.map(function(intent,index){$scope.editIntentPattern&&intent._id===$scope.editIntentPattern._id&&(indexIntent=index)}),-1!=indexIntent&&indexUpdateForEntitiesOrIntentsPatterns("intentPatterns")},$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},$scope.editIntentPatternObject=function(intent,event,index){var key;$scope.selectedIntent=_.filter($scope.allIntent,{_id:intent._id})[0],"indevelopment"===$scope.filterToggle?("DialogIntent"==intent.type?key="status":"webservice"==intent.type&&(key="state"),"published"==intent[key]?($scope.editIntentPatternId=null,$scope.currentTask=intent,$scope.currentIndex=index,NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"))):($scope.cancelIntentPattern(),$scope.editIntentPattern=angular.copy(intent),$scope.editIntentPatternId=intent._id,setTimeout(function(){$(".intentPatternInput").trigger("focus")},350)),event&&setTimeout(function(){var ele=event.currentTarget,_container=$(".bt-patterns").closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=$(ele.parentElement).offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"fast")}},350)):"published"===$scope.filterToggle&&($scope.editIntentPattern=angular.copy(intent),$scope.editIntentPatternId=intent._id,setTimeout(function(){var ele=event.currentTarget,_container=$(".bt-patterns").closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=$(ele.parentElement).offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"fast")}},350))};var getFlowTasks=function(){var deferred=$q.defer();return BTFlowtaskService.getFlowtaks($workflowService.selectedStream()._id).then(function(response){deferred.resolve(response)},function(err){deferred.reject(err)}),deferred.promise},mapPatternsArray=function(tasks){tasks.forEach(function(task){task.negativePatternsArray=[],task.negativePatterns=task.negativePatterns||[],task.negativePatterns.forEach(function(msg){msg.original=decodePattern(msg.original),task.negativePatternsArray.push(msg.original)})})};$scope.resolveAlerts=function(type,upgradedAlerts){BTAlertsService.getAlerts($scope.stream._id).then(function(res){res.data=res.data.map(function(task){return task.taskType="alert",task.intentTypeName="Alert",task.state=task.state.toLowerCase(),("inprogress"===task.state||"suspended"===task.state||"rejected"===task.state)&&(task.hide=!0),task}),res.data=_.filter(res.data,function(d){return!d.hide}),$scope.alertTasks=res.data,$scope.findParenttasks($scope.alertTasks),mapPatternsArray($scope.alertTasks),$scope.showUpgradedAlerts(type,upgradedAlerts),$timeout(function(){$scope.cb.loadingPatterns=!1},500)},function(err){$scope.patternsCB.loadingPatterns=!1,err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.showUpgradedAlerts=function(type,upgradedData){var _selectedIntent;_selectedIntent=_.find($scope.alertTasks,{_id:upgradedData._id}),$scope.selectedTask=_selectedIntent,$scope.selectedTask.intentSection="patterns",NotificationService.notify(i18n.i18nString("upgraded_success"),"success"),upgradedData&&"addPattern"===$scope.upgradeCopy.upgradeType&&$scope.saveTaskPatternsObject($scope.selectedTask)},$scope.showUpgradedPattern=function(type,upgradedData){var _selectedNode,_selectedIntent;_selectedNode=_.filter(upgradedData.nodes,{nodeId:"intent0"})[0],_selectedIntent=_.find($scope.intents,{_id:_selectedNode.componentId}),$scope.selectedTask=_selectedIntent,NotificationService.notify(i18n.i18nString("upgraded_success"),"success"),upgradedData&&"addPattern"===$scope.upgradeType&&saveIntentPatterns($scope.selectedTask)},$scope.taskFieldPatternsLoading=!0,$scope.deleteComponentPattern=function(component,pattern,$event){if($event.stopPropagation(),"indevelopment"===$scope.filterToggle){var key="state";if("DialogIntent"===component.type&&(key="status"),"published"==component[key])$scope.currentTask=component,NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"));else{var componentCopy=angular.copy(component),msg=i18n.i18nString("do_you_want_to_delete_this_pattern"),confirmDeletePattern=function(){$scope.saveStatusNpattern={initial:!1,pending:!0,completed:!1,failed:!1},componentCopy.negativePatternsArray=_.filter(componentCopy.negativePatterns,function(patternObject,i){return pattern.original!==patternObject.original})||[],componentCopy.negativePatternsArray=_.pluck(componentCopy.negativePatternsArray,"original");var msg=i18n.i18nString("negative_pattern_deleted");updateComponentPatterns(componentCopy,msg,void 0,void 0,component)};NotificationService.alert(msg,confirmDeletePattern,arguments)}}
},$(".antiPatternSearchIcon").click(function(){$(this).hasClass("fa-remove")?($(this).removeClass("fa-remove"),$(this).addClass("fa-search"),$(".searchPattern").removeClass("searchExpand"),$scope.search=""):(setTimeout(function(){$(".patternSearch").trigger("focus")},350),$(this).addClass("fa-remove"),$(this).removeClass("fa-search"),$(".searchPattern").addClass("searchExpand"))}),$scope.upgrade=function(){$scope.isGlobalWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("upgrading_task_label");var taskType=$scope.getTaskType($scope.currentTask);$scope.upgradeWorkflow($scope.currentTask,taskType)},$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?"action":task&&"DialogIntent"==task.type?"flowtask":""},$scope.upgradeWorkflow=function(task,type){"alert"===type?BTAlertsService.upgradeBTAlert(task._id).then(function(response){BTAlertsService.upgradeMPAlert(task._id,response.data._id).then(function(upgradeRes){BTAlertsService.configured(upgradeRes.data._id).then(function(configRes){$scope.isGlobalWorkProgress=!1,$scope.resolveAlerts(null,configRes.data[0]),$timeout(function(){$(".intentPattern-select2 .select2-input").focus()},350)},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,$scope.cb.loadingNegativePatterns=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,$scope.cb.loadingNegativePatterns=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type?BTActionsService.upgradeBTAction(task._id).then(function(response){BTActionsService.upgradeMPAction(task._id,response.data._id).then(function(upgradeRes){BTActionsService.configured(upgradeRes.data._id).then(function(configRes){loadingEntities(null,configRes.data[0]),$scope.editIntentPatternId=configRes.data[0]._id,$scope.isGlobalWorkProgress=!1,$scope.editIntentPatternObject(configRes.data[0],void 0,$scope.currentIndex),$timeout(function(){$(".intentPattern-select2 .select2-input").focus()},350)},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,task.dialogId).then(function(res){resolveIntents("intents",res.data,!0),$scope.isGlobalWorkProgress=!1,$scope.editIntentPatternId=res.data.nodes[0].componentId,$timeout(function(){$(".intentPattern-select2 .select2-input").focus()},350)},function(err){$scope.isGlobalWorkProgress=!1,$scope.cb.loadingNegativePatterns=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.filterToggleTask=function(task){var taskType=$scope.getTaskType(task),key="state";return task&&"DialogIntent"===task.type&&(key="status"),"published"===$scope.filterToggle?"published"===task[key]?!0:!1:"published"!==task[key]||"alert"!==taskType&&"action"!==taskType&&"flowtask"!==taskType?"published"!==task[key]&&"suspended"!==task[key]?!0:!1:task.isParent||task.isDeleted?!1:!0},$scope.editTaskPattern=function(selectedTask,index){if("indevelopment"===$scope.filterToggle){var key="state";"published"==selectedTask[key]?($scope.currentTask=selectedTask,$scope.upgradeCopy.upgradeFrom="patterns",NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg"))):(selectedTask.negativePatterns[index].original=selectedTask.negativePatterns[index].original.replace(selectedTask.negativePatterns[index].original,$scope.tPattern.editTaskPattern),saveIntentPatterns($scope.selectedTask,!0,index,void 0))}},$scope.cb.onClickTask=onClickTask}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("nlAdvancedSettings",[function(){return{restrict:"EA",scope:{streamUpdateCb:"=",rightPannelView:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/nl-advanced-settings/nl-advanced-settings.html",controller:["$scope","$translator","$rootScope","$workflowService","BTStreamsService","NotificationService","$timeout","accessControlService","$element","env_conf","i18n",function($scope,$translator,$rootScope,$workflowService,BTStreamsService,NotificationService,$timeout,accessControlService,$element,env_conf,i18n){function saveMultiIntentSetting(){BTStreamsService.editNlSettings($workflowService.selectedStream()._id,$scope.payload1).then(function(res){$(".save-tip").addClass("fa fa-check").show().text("saved..."),$timeout(function(){$(".save-tip").removeClass("fa fa-check").hide().text("saving...")},5e3),$workflowService.selectedStream(angular.extend($scope.selectedStream,res.data)),$("#noty_center_layout_container").empty(),NotificationService.notify(i18n.i18nString("multi_intent_settings_saved_sucessfully_noty"),"success")},function(err){NotificationService.notify(err.data.errors[0].msg,"error"),$(".save-tip").removeClass("fa fa-check").hide().text("saving...")})}$scope.payload={},$scope.payload1={},$scope.constants=$rootScope._constants_,$scope.streamState=$workflowService.selectedStreamState(),$scope.assetsBase=env_conf["assets-url"],$scope.detect={multiIntent:!1},$scope.selectedStream=$workflowService.selectedStream(),$scope.filterToggle="enabled",$scope.intentToggle="enabled",$scope.negativeToggle="enabled",$scope.rightClass="right400",$scope.refreshIcon=env_conf["context-url"]+"/assets/icons/refreshIcon.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.neg={},$scope.amendEntityDescription=[{desc:i18n.i18nString("multi_amendEntityDescription_one")},{desc:i18n.i18nString("multi_amendEntityDescription_two")},{desc:i18n.i18nString("multi_amendEntityDescription_three")},{desc:i18n.i18nString("multi_amendEntityDescription_four")},{desc:i18n.i18nString("multi_amendEntityDescription_five")}],$scope.selectedStream.detectMultiIntent&&($scope.detect.multiIntent=!0,$scope.intentToggle="disabled"),$scope.selectedStream.enableNegativePatterns&&($scope.neg.negativePattern=!0,$scope.negativeToggle="enabled"),$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.showModal=function(){$element.find("#warningModal").removeClass("fade").addClass("show")},$scope.closeModal=function(){$scope.intentParams.useSynonyms=!$scope.intentParams.useSynonyms,$element.find("#warningModal").removeClass("show").addClass("fade")},$scope.enableDisableIntent=function(){$scope.detect.multiIntent?$scope.intentToggle="enabled":$scope.intentToggle="disabled",$scope.payload1.detectMultiIntent=$scope.detect.multiIntent,saveMultiIntentSetting()},$scope.negativePatternToggle=function(){$scope.neg.negativePattern?($scope.negativeToggle="enabled",$("#enableNegativePattern").modal("show")):($scope.negativeToggle="disabled",$("#disableNegativePattern").modal("show"))},$scope.closeDisableNegative=function(){$("#disableNegativePattern").modal("hide"),$scope.neg.negativePattern=!0,$scope.negativeToggle="enabled"},$scope.confirmCloseDisableNegative=function(){$("#disableNegativePattern").modal("hide"),BTStreamsService.editNlSettings($workflowService.selectedStream()._id,{enableNegativePatterns:$scope.neg.negativePattern}).then(function(res){$scope.neg.negativePattern=res.data.enableNegativePatterns,$workflowService.selectedStream(angular.extend($scope.selectedStream,res.data)),$scope.streamUpdateCb(res.data),NotificationService.notify(i18n.i18nString("negative_patterns_disabled_sucess_noty"),"success")},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.confirmCloseEnableNegative=function(){$("#enableNegativePattern").modal("hide"),BTStreamsService.editNlSettings($workflowService.selectedStream()._id,{enableNegativePatterns:$scope.neg.negativePattern}).then(function(res){$scope.neg.negativePattern=res.data.enableNegativePatterns,$workflowService.selectedStream(angular.extend($scope.selectedStream,res.data)),$scope.streamUpdateCb(res.data),NotificationService.notify(i18n.i18nString("negative_patterns_enabled_sucess_noty"),"success")},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.knowledgeTasks=$workflowService.knowledgeTasks(),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.$emit("nestedComponentLoaded",{id:"nlAdvancedSettings",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")})}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("patternManage",[function(){return{restrict:"EA",scope:{stream:"=?",context:"=?",hideUi:"@",gSearchCb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/patterns-module/patterns-module.html",controller:"PatternsModuleCtrl"}}]).filter("formatTaskPattern",function(){return function(input){return input&&input.split("* ").join("")}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("promptsGenric",[function(){return{restrict:"EA",scope:{onDone:"=",mode:"=",onCancelPrompt:"=",messagesObject:"=",displayMode:"=",scrollContainer:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/prompts-genric-form/prompts-genric-form.html",controller:["$scope","$element","channelsConfig","$workflowService","BTStreamsService","NotificationService","BTFlowtaskService","$timeout","env_conf","$rootScope","i18n",function($scope,$element,channelsConfig,$workflowService,BTStreamsService,NotificationService,BTFlowtaskService,$timeout,env_conf,$rootScope,i18n){function decodeJS(_obj){try{return decodeURIComponent(_obj.replace(/&lt;/g,"<").replace(/&gt;/g,">"))}catch(e){return _obj}}function isStandardPromptExist(index){var _standardPromptMessageCount=$scope._allPrompts.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);return _standardPromptMessageCount>1?!0:(1!==_standardPromptMessageCount||$scope._allPrompts[index]._id)&&"default"===$scope._allPrompts[index].channel&&"default"!==$scope.selectedChannel.channel?(NotificationService.notify("message"===$scope.type?i18n.i18nString("allchannel_res"):i18n.i18nString("atleast_one_prompt"),"error"),!1):!0}function scrollInitiate(){$timeout(function(){$($scope.scrollContainer).scrollTop(2)},750)}function isMarkUp(markup){return markup.jsCode&&""!==markup.jsCode.trim()?!1:!0}function encodeJS(_obj){return encodeURIComponent(_obj)}$scope.standardPrompts=[],$scope._allPrompts=[],$scope.channelPrompts=[],$scope.CurrentTabIndex=-1,$scope.defaultMsg={channel:"default",text:"",type:"basic"},$scope.scrollContainer=$scope.scrollContainer||".modalBody",$scope.initilizing=!0,$scope._allPrompts.push($scope.defaultMsg),$scope.loadEditor=!1,$scope.currEditPromptIndex=-1,$scope.assetsBase=env_conf["assets-url"];var isWFacebook=!1,isPromptOpened=!1;$scope.displayMode=$scope.displayMode||"edit",channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channels=Object.values(channelsConfig.channelsObject),$scope._channelConfig=channelsConfig,$scope.stream=$workflowService.selectedStream(),$scope.channels=$scope.channels.map(function(channel,i){return channel.used=!1,"wfacebook"===channel.id&&(isWFacebook=!0),channel}),$scope.channels=_.filter($scope.channels,{enable:!0}),isWFacebook&&($scope.channels=_.without($scope.channels,_.findWhere($scope.channels,{id:"wfacebook"}))),$scope.selectedChannel={},$scope.selectedChannel.channel="default",$scope.$watch("messagesObject",function(newVal,oldVal){if(newVal){if($scope.standardPrompts=[],$scope.channelPrompts=[],$scope._allPrompts=[],$scope.currentScreen=0,newVal&&newVal.messages.length>0)newVal.messages.map(function(message){message.text=decodeJS(message.text),"default"===message.channel?$scope.standardPrompts.push(message):("wfacebook"===message.channel&&(message.channel=message.isMention?"wfacebookG":"wfacebookC"),$scope.channelPrompts.push(message))});else{var tempMsgObj={channel:"default",text:"",type:"basic"};$scope._allPrompts.push(tempMsgObj)}$scope.type="message",$scope._allPrompts=$scope._allPrompts.concat($scope.standardPrompts),$scope._allPrompts=$scope._allPrompts.concat($scope.channelPrompts),$scope._allPrompts.forEach(function(obj){obj.isOpen="false"}),$scope.messagesObject.openIndex>-1&&!isPromptOpened&&setTimeout(function(){isPromptOpened||($("#promptHeader-"+$scope.messagesObject.openIndex).trigger("click"),isPromptOpened=!0)},1e3)}}),$scope.currentTabIndexOfPage1=0,$scope.currentTabIndexOfPage2=0,$scope.currentScreen=0,$scope.editPromptMode=!0,$scope.isUser=!0,$scope.editMessageIndex=0,$scope.editingMessage={},$scope.type="message",$scope._constants_=$rootScope._constants_,$scope.contextCondition=[{key:"",value:""}],$scope.editors={},$scope.jsEditorCbs={},$scope.markdownCbs={},$scope.jsEditorCbs.displayMode=$scope.displayMode,$scope.markdownCbs.displayMode=$scope.displayMode,$scope.contexts=[],$scope.contextsData=[],$scope.markdownCbs.switchEditor=function(type){"javaScriptEditor"===type?$scope.alterTabsOfPage2(1):"promptsPreview"===type&&$scope.alterTabsOfPage2(2)},$scope.markdownCbs.onFocus=function(){$scope.showProtip=!0},$scope.markdownCbs.onBlur=function(){$scope.showProtip=!1},$scope.markdownCbs.isFromUserPrompt=!0,$scope.jsEditorCbs.onFocus=function(){$scope.showProtip=!0},$scope.jsEditorCbs.onBlur=function(){$scope.showProtip=!1},$scope.icons={spark:env_conf["context-url"]+"/img/spark.svg",msteams:env_conf["context-url"]+"/img/microsoft-teams-icon.png",syniverse:env_conf["context-url"]+"/img/syniverse.png",rcengage:env_conf["context-url"]+"/img/ringCentralEngage.png",slack:env_conf["context-url"]+"/img/slack.svg",sms:env_conf["context-url"]+"/img/sms.svg",twilio:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",email:env_conf["context-url"]+"/img/email.svg",skype:"",facebook:env_conf["context-url"]+"/img/facebook.svg",websdk:env_conf["context-url"]+"/img/slack.svg",kore:env_conf["context-url"]+"/img/kore.svg",rtm:env_conf["context-url"]+"/img/web-mobile.svg",widgetsdk:env_conf["context-url"]+"/img/widgetsdk.svg",skypeOnPrem:env_conf["context-url"]+"/img/skypebusiness.svg",twitter:env_conf["context-url"]+"/img/twitter.svg",cisco:env_conf["context-url"]+"/img/cisco-tropo-icon.png",wfacebook:env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Groups":env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Chat":env_conf["context-url"]+"/img/fb-workplace-icon.png",ringcentral:env_conf["context-url"]+"/img/ringCentralIcon.png",skypeforbusiness:env_conf["context-url"]+"/img/skypebusiness.svg",jabber:env_conf["context-url"]+"/img/jabbericon.jpg",yammer:env_conf["context-url"]+"/img/yammericon.png",telegram:env_conf["context-url"]+"/img/telegram-logo.png",alexa:env_conf["context-url"]+"/img/amazonalexa.png",twiliovoice:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",line:env_conf["context-url"]+"/img/line-logo.png",ivr:env_conf["context-url"]+"/img/webhook.png",liveperson:env_conf["context-url"]+"/img/live-person.png",ivrVoice:env_conf["context-url"]+"/assets/ivrIcons/ivrIcon.svg",googleactions:env_conf["context-url"]+"/img/google-home.svg",wechat:env_conf["context-url"]+"/img/weChat.svg",hangoutchat:env_conf["context-url"]+"/img/hangoutchat.png",livebank:env_conf["context-url"]+"/img/livebank.png"},$scope.showProtip=!0,$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.quotsIcon=window.appConfig.CONTEXT_PATH+"/assets/images/quotsIcon.svg",$scope.alterTabsOfPage1=function(tabIndex){$scope.currentTabIndexOfPage1=tabIndex},$scope.addContextCond=function(index){$scope.contextCondition.length>0&&index===$scope.contextCondition.length-1&&$scope.contextCondition.push({key:"",value:""})},$scope.onRemoveCond=function(index){$scope.contextCondition.length>1&&$scope.contextCondition[index]&&$scope.contextCondition.splice(index,1)},$scope.selected=void 0,$scope.states=["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Dakota","North Carolina","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming"],$scope.$watch("selectedChannel.channel",function(){$scope.selectedChannelType=$scope.selectedChannel.channel}),$scope.alterTabsOfPage2=function(tabIndex){$scope.CurrentTabIndex=tabIndex,$scope.loadEditor=!0,$scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim()&&0===tabIndex?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_js_notify")):$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()&&1===tabIndex?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_markup_notify")):$scope.currentTabIndexOfPage2=tabIndex,2===tabIndex&&($scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim().length>0||$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim().length>0?$scope.disablePreviewBtn=!1:$scope.disablePreviewBtn=!0,$scope.preview="")},$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.getJsSamples(),$scope.closePromptDialog=function(){$scope.savePromptsInfo()},$scope.savePromptsInfo=function(){var promptsArray=[];promptsArray=$scope._allPrompts.filter(function(i){return""!==i.text}),promptsArray.forEach(function(v){delete v.isOpen}),$scope.onDone(promptsArray)},$scope.editPrompt=function(index,isOpen){$scope.loadEditor=!1,isOpen||($scope.currEditPromptIndex=index,-1===index&&($scope.editPromptMode=!1,$scope.isUser=!1),$scope.editMessageIndex=index,$scope.editingMessage={},$scope.selectedChannel.channel=index>=0?$scope._allPrompts[index].channel:"",0>index||index>=0&&"basic"===$scope._allPrompts[index].type?($scope.editingMessage.markUp=index>=0?$scope._allPrompts[index].text:"",$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0):($scope.editingMessage.jsCode=$scope._allPrompts[index].text,$scope.currentTabIndexOfPage2=1,$scope.CurrentTabIndex=1),"wfacebook"===$scope.selectedChannel.channel&&($scope.selectedChannel.channel=$scope._allPrompts[index].isMention?"wfacebookG":"wfacebookC")),$timeout(function(){"basic"!==$scope._allPrompts[index].type&&($scope.editingMessage.jsCode=$scope._allPrompts[index].text),isOpen||($scope.loadEditor=!0)},150),$timeout(function(){isOpen?$($scope.scrollContainer).animate({scrollTop:$("#prompt-0").offset().top},1e3):$($scope.scrollContainer).animate({scrollTop:$("#prompt-"+index).offset().top},750)},350)},$scope.deletePromptMessage=function($event,index){$event.preventDefault(),$event.stopPropagation();var _msgTxt="message"===$scope.type?"bot response":"prompt message";NotificationService.alert("Do you want to delete this "+_msgTxt,function(){if(""===$scope._allPrompts[index].text)return $scope._allPrompts.splice(index,1),void $timeout(function(){$($scope.scrollContainer).scrollTop(2)},1e3);var _standardPromptMessageCount=$scope._allPrompts.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)$scope.preparePromptsPayload(index,!0,!1);else{if("default"===$scope._allPrompts[index].channel)return NotificationService.notify("message"===$scope.type?i18n.i18nString("allchannel_res"):i18n.i18nString("atleast_one_prompt"),"error"),!1;$scope.preparePromptsPayload(index,!0,!1)}},{okText:i18n.i18nString("ok_uppercase")})};var _editingMessage="";$scope.channelSelected=function(selectedChannel){_editingMessage=angular.copy($scope.editingMessage),$timeout(function(){$scope.editingMessage=_editingMessage},200),$scope.selectedChannel.channel=selectedChannel},$scope.savePromptMessage=function(index){if(isStandardPromptExist(index)){var _isFrmCreate=!1;$scope._allPrompts=$scope._allPrompts||[];var messageObject={};messageObject.channel=$scope.selectedChannel.channel,"wfacebookG"===messageObject.channel?(messageObject.channel="wfacebook",messageObject.isMention=!0):"wfacebookC"===messageObject.channel&&(messageObject.channel="wfacebook",messageObject.isMention=!1),0===$scope.CurrentTabIndex?(messageObject.text=$scope.editingMessage.markUp?$scope.editingMessage.markUp:$scope.editingMessage.jsCode,messageObject.type="basic"):1===$scope.CurrentTabIndex&&(messageObject.text=angular.copy($scope.editingMessage.jsCode?$scope.editingMessage.jsCode:$scope.editingMessage.markUp),messageObject.type="uxmap"),-1===$scope.editMessageIndex&&($scope.editingMessage.jsCode||$scope.editingMessage.markUp)?$scope._allPrompts.push(messageObject):(messageObject._id=$scope._allPrompts[$scope.editMessageIndex]._id,$scope._allPrompts[$scope.editMessageIndex]=messageObject),$scope._allPrompts[$scope.editMessageIndex]._id||(_isFrmCreate=!0),$scope.preparePromptsPayload(index,!1,_isFrmCreate),$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0,$scope.navigateBack($scope.currEditPromptIndex)}},$scope.addNewPromptMessage=function(){if("edit"===$scope.displayMode){$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0,$scope.selectedChannel.channel="default";var messageObject={};messageObject.channel=$scope.selectedChannel.channel,messageObject.text="",messageObject.type="basic",$scope._allPrompts.push(messageObject),$scope.currEditPromptIndex>=0&&($scope._allPrompts[$scope.currEditPromptIndex].isOpen=!1,$scope.loadEditor=!1),$timeout(function(){$scope._allPrompts[$scope._allPrompts.length-1].isOpen=!0,$scope.editPrompt($scope._allPrompts.length-1,!1)},150)}},$scope.disableSaveBtn=function(){return"edit"!==$scope.displayMode?!0:$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()||$scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim()?!1:!0},$scope.formDirty=function(){if($scope._allPrompts&&$scope._allPrompts.length)for(var i=0;i<$scope._allPrompts.length;i++)if(""===$scope._allPrompts[i].text)return!0;return!1},$scope.canFinish=function(){for(var i=0;i<$scope._allPrompts.length;i++)if(""!==$scope._allPrompts[i].text)return!0;return!1},scrollInitiate(),$scope.editPromptMessage=function(index){-1===index&&($scope.editPromptMode=!1),$scope.loadEditor=!0,$scope.editMessageIndex=index,$scope.currentScreen=1,$scope.editingMessage={},$scope.selectedChannel="default",$scope.contextCondition=[{key:"",value:""}],0>index||index>=0&&"basic"===$scope.standardPrompts[index].type?($scope.editingMessage.markUp=index>=0?$scope.standardPrompts[index].text:"",$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0):($scope.editingMessage.jsCode=$scope.standardPrompts[index].text,$scope.currentTabIndexOfPage2=1,$scope.CurrentTabIndex=1)},$scope.editChannelPromptMessage=function(index){-1===index&&($scope.editPromptMode=!1,$scope.isUser=!1),$scope.editMessageIndex=index,$scope.loadEditor=!0,$scope.currentScreen=1,$scope.editingMessage={},$scope.selectedChannel=index>=0?$scope.channelPrompts[index].channel:"",0>index||index>=0&&"basic"===$scope.channelPrompts[index].type?($scope.editingMessage.markUp=index>=0?$scope.channelPrompts[index].text:"",$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0):($scope.editingMessage.jsCode=$scope.channelPrompts[index].text,$scope.currentTabIndexOfPage2=1,$scope.CurrentTabIndex=1)},$scope.navigateBack=function(index){$scope.loadEditor=!1,$scope.currentScreen=0,$scope.editPromptMode=!0,$scope.isUser=!0,$scope._allPrompts[index].isOpen=!1,$($scope.scrollContainer).animate({scrollTop:$("#prompt-0").offset().top},1e3)},$scope.addPromptMessage=function(){$scope.standardPrompts=$scope.standardPrompts||[],$scope.channelPrompts=$scope.channelPrompts||[];var messageObject={};messageObject.channel=0===$scope.currentTabIndexOfPage1?"default":$scope.selectedChannel.channel,"Workplace For Groups"===messageObject.channel?(messageObject.channel="wfacebook",messageObject.isMention=!0):"Workplace For Chat"===messageObject.channel&&(messageObject.channel="wfacebook",messageObject.isMention=!1),messageObject.text=$scope.editingMessage.jsCode?$scope.editingMessage.jsCode:$scope.editingMessage.markUp,messageObject.type=$scope.editingMessage.jsCode?"uxmap":"basic","default"===messageObject.channel?-1===$scope.editMessageIndex&&($scope.editingMessage.jsCode||$scope.editingMessage.markUp)?$scope.standardPrompts.push(messageObject):(messageObject._id=$scope.standardPrompts[$scope.editMessageIndex]._id,$scope.standardPrompts[$scope.editMessageIndex]=messageObject):-1===$scope.editMessageIndex&&($scope.editingMessage.jsCode||$scope.editingMessage.markUp)?$scope.channelPrompts.push(messageObject):(messageObject._id=$scope.channelPrompts[$scope.editMessageIndex]._id,$scope.channelPrompts[$scope.editMessageIndex]=messageObject),$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0,$scope.navigateBack()},$scope.deletePrompt=function(index){0===$scope.currentTabIndexOfPage1?$scope.standardPrompts.splice(index,1):$scope.channelPrompts.splice(index,1)},$scope.getPreviewData=function(){var _context={},_isValidContext=!0;if($scope.contextCondition.length>0&&$.each($scope.contextCondition,function(k,context){var _contextKey=context.key?context.key.trim():"";if(""!==_contextKey){if(0!==_contextKey.toLowerCase().indexOf("context."))return _isValidContext=!1,!1;var _tempObj={};_contextKey=_contextKey.substr(8),_contextKey.split(".").reverse().forEach(function(_parsedKey){var _t={};_t[_parsedKey]=Object.keys(_tempObj).length?_tempObj:context.value.trim(),_tempObj=_t}),angular.merge(_context,_tempObj)}}),!_isValidContext)return void NotificationService.notify(i18n.i18nString("bot_welcomeMessage_keys_should_be_prefixed_notify"),"warning");$scope.previewIsOn=!0;var markup=isMarkUp($scope.editingMessage),payload={message:$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()?$scope.editingMessage.markUp:$scope.editingMessage.jsCode,type:markup?"basic":"uxmap",context:JSON.stringify(_context)};$scope.isError=!1,$scope.preview="",BTFlowtaskService.messagePreviewFlowtask($workflowService.selectedStream()._id,"taskId","nodeId",payload).then(function(res){var _ele=document.createElement("div");_ele.innerHTML=res.data&&(res.data.resolvedPayload||res.data.resolvedData);var lnkEle=$(_ele).find("a");lnkEle.length>0&&$.each(lnkEle,function(k,ele){$(ele).attr("target","_blank")}),$scope.preview=_ele.innerHTML,$scope.previewIsOn=!1},function(err){var error=err.data&&err.data.errors&&err.data.errors[0].msg||err.data;try{error=JSON.parse(error),error.errors&&error.errors[0].msg&&($scope.preview=error.errors[0].msg)}catch(e){$scope.preview=error}$scope.previewIsOn=!1,$scope.isError=!0})},$scope.openPreviewWithSample=function(){$scope.previewIsOn=!1,$scope.preview=$scope.editingMessage.markUp?$scope.editingMessage.markUp:$scope.editingMessage.jsCode},$scope.updateFooterHeader=function(){return $scope.footerInfoTitle=i18n.i18nString("user_prompt_learnMore_creating_prompt"),"message"===$scope.type&&($scope.footerInfoTitle=i18n.i18nString("user_prompt_learnMore_creating_bot_response")),$scope.footerHeaderId="bt-userPrompt",$scope.footerPanelId="bt-userPrompt-panel",$scope.nameDescription=i18n.i18nString("user_prompt_creating_right_prompt_Desc"),!0},$scope.preparePromptsPayload=function(index,_isFromDelete,_isFrmCreate){var _tempMessage=[];$scope._allPrompts&&$scope._allPrompts.length>0&&$.each($scope._allPrompts,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type};message._id&&(_tempMessageObject._id=message._id),("wfacebookG"===_tempMessageObject.channel||"wfacebookC"===_tempMessageObject.channel||"wfacebook"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&($scope._allPrompts.splice(index,1),_tempMessage.splice(index,1)),_tempMessage=_tempMessage.filter(function(i){return""!==i.text}),$scope.onDone(_tempMessage)}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("propertyPanel",function(){return{restrict:"EAQ",scope:{onComplete:"&",wfType:"@",nodeInfo:"=",dialogData:"=",nodeObj:"@",editPrompt:"=",editError:"=",cb:"=",authCb:"=",btTestFormApi:"=",btTestStatus:"=",notiRefs:"=",runBot:"=",dialogEntities:"=?",flowtaskApi:"=",callBy:"=",processApps:"=",groupNode:"=",groupNodeIntnets:"=",currentIntent:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/property-panel/property-panel.html",controller:["$scope","$element","patternFactory","$filter","$timeout","$rootScope","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","$modal","urlutil","env_conf","geoLocationIds","BTFileUploadService","$applicationService","form_util","$animate","_constants_","channelsConfig","BTIdpService","$q","i18n","$http","defaultValue","accessControlService","mixPanel",function($scope,$element,patternFactory,$filter,$timeout,$rootScope,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,$modal,urlutil,env_conf,geoLocationIds,BTFileUploadService,$applicationService,form_util,$animate,_constants_,channelsConfig,BTIdpService,$q,i18n,$http,defaultValue,accessControlService,mixPanel){function mapSelectedProcess(nodeInfo){var _selectedProcess=_.find($scope.processApps,{refId:nodeInfo.resourceId});$scope.process.selectedProcess=$workflowService.cloneData(_selectedProcess)}function mapContextValues(nodeInfo){if($scope.process.selectedProcess){$scope.process.selectedProcess.contextKeyValues=[];var _contextKeyValue={};nodeInfo.contextMap&&(_contextKeyValue=JSON.parse(nodeInfo.contextMap),$scope.process.selectedProcess.contextMap=_contextKeyValue),_.forEach($scope.process.selectedProcess.variables,function(variable,index){$scope.process.selectedProcess.contextKeyValues.push({key:variable,value:_contextKeyValue[variable]?_contextKeyValue[variable]:""})})}}function mapParticipateContextValues(nodeInfo){$scope.contextKeyValues=[];var _contextKeyValue={};nodeInfo.contextMap&&(_contextKeyValue=JSON.parse(nodeInfo.contextMap),$scope.processTypeContext.action=_contextKeyValue.action,$scope.processTypeContext.taskId=_contextKeyValue.taskId)}function decodeInstanceMessages(){$scope.userInstancePromptsCopy.length>0?($scope.userInstancePromptOptions.override=!0,$scope.userInstancePromptsCopy.forEach(function(message){message.text=decodeJS(message.text)})):$scope.userInstancePromptOptions.override=!1,$scope.userErrorInstancePromptsCopy.length>0?($scope.errorInstancePromptOptions.override=!0,$scope.userErrorInstancePromptsCopy.forEach(function(error){error.text=decodeJS(error.text)})):$scope.errorInstancePromptOptions.override=!1}function loadMultiCategoryInstancePrompts(){$.isEmptyObject($scope.nodeInfo.nodeInfo)||$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&"dateperiod"===$scope.nodeInfo.nodeInfo.entityType&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts&&($scope.instanceMultiCategoryPromptsCopy=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts),$scope.instanceMultiCategoryPromptsCopy&&$scope.instanceMultiCategoryPromptsCopy.forEach(function(category){category.message.forEach(function(msg){msg.text=decodeJS(msg.text)}),category.message.length&&($scope.overrideMultiCategoryPrompts[category.category].message=!0,$scope.overrideMultiCategoryPrompts.from.message=!0,$scope.overrideMultiCategoryPrompts.to.message=!0),category.errorMessage.forEach(function(msg){msg.text=decodeJS(msg.text)}),category.errorMessage.length&&($scope.overrideMultiCategoryPrompts[category.category].errorMessage=!0,
$scope.overrideMultiCategoryPrompts.from.errorMessage=!0,$scope.overrideMultiCategoryPrompts.to.errorMessage=!0),category.newInstancePrompt={channel:"default",text:"",type:"basic",_id:""},category.newErrorInstancePrompt={channel:"default",text:"",type:"basic",_id:""}}),$scope.nodeInfo.nodeInfo.hasOwnProperty("errorPromptSequencing")&&($scope.errorInstancePromptObj.errorPromptSequencing=$workflowService.cloneData($scope.nodeInfo.nodeInfo.errorPromptSequencing)))}function loadErrorPromptSequencing(value){$scope.nodeInfo.nodeInfo&&$scope.nodeInfo.nodeInfo.hasOwnProperty("errorPromptSequencing")&&($scope.errorInstancePromptObj.errorPromptSequencing=value||$workflowService.cloneData($scope.nodeInfo.nodeInfo.errorPromptSequencing))}function createCategoryInstancePrompt(index,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.newInstancePrompt.text&&(startSaving(".defaultPromptSaveIcon"+category),saveUserCategoryInstancePromptMessages(filterObj.message,index,!1,category,filterObj))}function createCategoryErrorInstancePrompt(index,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.newErrorInstancePrompt.text&&(startSaving(".defaultErrorPromptSaveIcon"+category),saveCategoryErrorInstancePromptMessages(filterObj.errorMessage,index,!1,category,filterObj))}function saveUserInstancePromptMessages(messages,index,_isFromDelete,payloadOfListOfValues,deleteall){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS($scope.newInstancePrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var payload=prepareInstancePayload();payload.nodeOptions.message=_tempMessage,deleteall&&(payload.nodeOptions.message=[]),$scope.nodeInfo&&"list_of_values"===$scope.nodeInfo.nodeInfo.entityType&&(payload.nodeOptions.applyDefaultTemplate=$scope.overrideListOfValuesOptions.display),BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data&&res.data.nodes){var _nodeIndex=-1,filterObj=res.data.nodes.filter(function(e){return _nodeIndex++,e.nodeId==$scope.nodeInfo.dialogNodeInstance.uId});filterObj=filterObj[0]||null,-1===index?(finishSaving(".defaultPromptSaveIcon"),$scope.newInstancePrompt.text="",setTimeout(function(){NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("bot_res_updated"),"success")},500)):(finishSaving(".promptSaveSpin"+index),togglePromptsIcons("hide",index),_isFromDelete?NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_deleted"):i18n.i18nString("prompt_deleted"),"success"):NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("bot_res_updated"),"success")),$scope.nodeInfo.dialogNodeInstance.nodeOptions.message=filterObj.nodeOptions.message,$scope.nodeInfo.dialogNodeInstance.nodeOptions.message.length||($scope.userInstancePromptOptions.override=!1),$scope.userInstancePromptsCopy=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.message||[]),$scope.userInstancePromptsCopy.length>0&&($scope.userInstancePromptOptions.override=!0,$scope.userInstancePromptsCopy.forEach(function(message){message.text=decodeJS(message.text)})),$scope.entityInstancePropertyCB.updateDialog(res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(isFromDelete?i18n.i18nString("bot_res_deletion"):i18n.i18nString("bot_res_update"),"error"):NotificationService.notify(_isFromDelete?i18n.i18nString("prompt_deletion"):i18n.i18nString("prompt_failed"),"error"):"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(i18n.i18nString("bot_res_creation_failed"),"error"):NotificationService.notify(i18n.i18nString("prompt_creation_failed"),"error");-1===index?finishSaving(".defaultPromptSaveIcon","error"):(finishSaving(".promptSaveSpin"+index,"error"),togglePromptsIcons("hide",index))})}function saveErrorInstancePromptMessages(messages,index,_isFromDelete,payloadOfListOfValues,deleteall){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS($scope.newErrorInstancePrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var payload=prepareInstancePayload();payload.nodeOptions.errorMessage=_tempMessage,deleteall&&(payload.nodeOptions.errorMessage=[]),BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data&&res.data.nodes){var _nodeIndex=-1,filterObj=res.data.nodes.filter(function(e){return _nodeIndex++,e.nodeId==$scope.nodeInfo.dialogNodeInstance.uId});filterObj=filterObj[0]||null,-1===index?(finishSaving(".defaultErrorPromptSaveIcon"),$scope.newErrorInstancePrompt.text="",setTimeout(function(){NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("bot_res_updated"),"success")},500)):(finishSaving(".errorPromptSaveSpin"+index),toggleErrorPromptsIcons("hide",index),_isFromDelete?NotificationService.notify(i18n.i18nString("error_prompt_success"),"success"):NotificationService.notify(i18n.i18nString("error_prompt_update"),"success")),$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage=filterObj.nodeOptions.errorMessage||[],$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage.length||($scope.errorInstancePromptOptions.override=!1),$scope.userErrorInstancePromptsCopy=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage||[]),$scope.userErrorInstancePromptsCopy.length>0&&($scope.errorInstancePromptOptions.override=!0,$scope.userErrorInstancePromptsCopy.forEach(function(error){error.text=decodeJS(error.text)})),$scope.entityInstancePropertyCB.updateDialog(res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?NotificationService.notify(_isFromDelete?i18n.i18nString("promptdeletion_failed"):i18n.i18nString("update_failed"),"error"):NotificationService.notify(i18n.i18nString("error_prompt_failed"),"error");-1===index?finishSaving(".defaultErrorPromptSaveIcon","error"):(finishSaving(".errorPromptSaveSpin"+index,"error"),toggleErrorPromptsIcons("hide",index))})}function saveCategoryErrorInstancePromptMessages(messages,index,_isFromDelete,category,filterObj,deleteMsgType){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index&&filterObj){var _tempMessageObject={channel:"default",text:encodeJS(filterObj.newErrorInstancePrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var _currCategoryPrompts=$workflowService.cloneData($scope.instanceMultiCategoryPromptsCopy),tempCopyObj=_currCategoryPrompts.filter(function(e){return e.category==category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.errorMessage=_tempMessage,_currCategoryPrompts.forEach(function(categ){delete categ.newInstancePrompt,delete categ.newErrorInstancePrompt});var payload=prepareInstancePayload();payload.nodeOptions.multiCategoryPrompts=_currCategoryPrompts||[],deleteMsgType&&category&&payload.nodeOptions.multiCategoryPrompts.forEach(function(e){e.errorMessage=[]}),BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data){var _nodeIndex=-1,filterObj=res.data.nodes.filter(function(e){return _nodeIndex++,e.nodeId==$scope.nodeInfo.dialogNodeInstance.uId});filterObj=filterObj[0]||null,$scope.userErrorInstancePromptsCopy=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts||[]),-1===index?(finishSaving(".defaultErrorPromptSaveIcon"+category),setTimeout(function(){NotificationService.notify(i18n.i18nString("bot_res_updated"),"success")},500)):(finishSaving(".errorPromptSaveSpin"+category+index),toggleErrorPromptsIcons("hide",index),_isFromDelete?($scope.nodeInfo.nodeInfo.errorMessage.splice(index,1),NotificationService.notify(i18n.i18nString("error_prompt_success"),"success")):NotificationService.notify(i18n.i18nString("error_prompt_update"),"success")),$scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts=$workflowService.cloneData(_currCategoryPrompts),loadMultiCategoryInstancePrompts(),$scope.entityInstancePropertyCB.updateDialog(res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?NotificationService.notify(_isFromDelete?i18n.i18nString("promptdeletion_failed"):i18n.i18nString("update_failed"),"error"):NotificationService.notify(i18n.i18nString("error_prompt_failed"),"error");-1===index?finishSaving(".defaultErrorPromptSaveIcon","error"):(finishSaving(".errorPromptSaveSpin"+index,"error"),toggleErrorPromptsIcons("hide",index))})}function saveUserCategoryInstancePromptMessages(messages,index,_isFromDelete,category,filterObj,deleteMsgType){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index&&filterObj){var _tempMessageObject={channel:"default",text:encodeJS(filterObj.newInstancePrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var _currCategoryPrompts=$workflowService.cloneData($scope.instanceMultiCategoryPromptsCopy),tempCopyObj=_currCategoryPrompts.filter(function(e){return e.category==category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.message=_tempMessage,_currCategoryPrompts.forEach(function(categ){delete categ.newInstancePrompt,delete categ.newErrorInstancePrompt});var payload=prepareInstancePayload();payload.nodeOptions.multiCategoryPrompts=_currCategoryPrompts||[],deleteMsgType&&category&&payload.nodeOptions.multiCategoryPrompts.forEach(function(e){e.message=[]}),BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data){var _nodeIndex=-1,filterObj=res.data.nodes.filter(function(e){return _nodeIndex++,e.nodeId==$scope.nodeInfo.dialogNodeInstance.uId});filterObj=filterObj[0]||null,$scope.userErrorInstancePromptsCopy=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts||[]),-1===index?(finishSaving(".defaultPromptSaveIcon"+category),setTimeout(function(){NotificationService.notify(i18n.i18nString("bot_res_updated"),"success")},500)):(finishSaving(".promptSaveSpin"+category+index),toggleInstancePromptsIcons("hide",index),_isFromDelete?NotificationService.notify(i18n.i18nString("prompt_deleted"),"success"):NotificationService.notify(i18n.i18nString("bot_res_updated"),"success")),$scope.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts=$workflowService.cloneData(_currCategoryPrompts),loadMultiCategoryInstancePrompts(),$scope.entityInstancePropertyCB.updateDialog(res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(isFromDelete?i18n.i18nString("bot_res_deletion"):i18n.i18nString("bot_res_update"),"error"):NotificationService.notify(_isFromDelete?i18n.i18nString("prompt_deletion"):i18n.i18nString("prompt_failed"),"error"):"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(i18n.i18nString("bot_res_creation_failed"),"error"):NotificationService.notify(i18n.i18nString("prompt_creation_failed"),"error");-1===index?finishSaving(".defaultPromptSaveIcon","error"):(finishSaving(".promptSaveSpin"+index,"error"),togglePromptsIcons("hide",index))})}function createInstancePrompt(index){""!==$scope.newInstancePrompt.text&&(startSaving(".defaultPromptSaveIcon"),saveUserInstancePromptMessages($scope.userInstancePromptsCopy,index,!1))}function createErrorInstancePrompt(index){""!==$scope.newErrorInstancePrompt.text&&(startSaving(".defaultErrorPromptSaveIcon"),saveErrorInstancePromptMessages($scope.userErrorInstancePromptsCopy,index,!1))}function toggleInstancePromptsIcons(type,index){setTimeout(function(){$element.find(".deletePromptIcon"+index).removeClass("hideIcon")},3200)}function toggleErrorInstancePromptsIcons(type,index){setTimeout(function(){$element.find(".deleteErrorPromptIcon"+index).removeClass("hideIcon")},3200)}function prepareInstancePayload(){var payload={};return"dialogAct"===$scope.nodeInfo.nodeInfo.type?payload={nodeOptions:{transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{},precedence:$scope.nodeInfo.dialogNodeInstance.nodeOptions.precedence}}:"entity"===$scope.nodeInfo.nodeInfo.type?payload={nodeOptions:{message:$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.message||[],errorMessage:$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage||[],isOptional:$scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional,transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",promptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions,reuseOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.reuseOptions,inputHandlingOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.inputHandlingOptions||"useAsEntityValue",interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{},precedence:$scope.nodeInfo.dialogNodeInstance.nodeOptions.precedence,noAutoCorrection:$scope.nodeInfo.dialogNodeInstance.nodeOptions.noAutoCorrection,notForReuse:$scope.nodeInfo.dialogNodeInstance.nodeOptions.notForReuse,customTags:$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags||{}}}:"message"===$scope.nodeInfo.nodeInfo.type?payload={nodeOptions:{transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{}}}:"intent"===$scope.nodeInfo.nodeInfo.type?payload={nodeOptions:{transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",transitionMode:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionMode,interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{}}}:$scope.nodeInfo.nodeInfo.type&&(payload={nodeOptions:{transitionType:$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto"}}),payload}function sortableCallbackErrorInstancePromt(e,uiElement){$scope.userErrorInstancePromptsCopy.length>1?setTimeout(function(){console.log($scope.userErrorInstancePromptsCopy),saveErrorInstancePromptMessages($scope.userErrorInstancePromptsCopy,uiElement.item.index(),!1)},50):NotificationService.notify("If more than one prompt message is defined","error")}function onSliderChangedNew(mode,val){$(".save-tip").show().text("Saving...");$(mode);switch(mode){case"#dual-sliders":$scope.obj.confidenceConfig[0].minThreshold=val[0],$scope.obj.confidenceConfig[0].definiteThreshold=val[1]}}function prepareSliders(){setTimeout(function(){function registerSlider(ele,obj){var slider=$(ele).bootstrapSlider(obj);return $(ele).slider().on("slideStop ",function(ev){onSliderChangedProxy(ele,ev.value)}),$(ele).slider().on("slide",function(ev){formatTooltip(ele,ev.value)}),slider}function formatTooltip(mode,val){switch(mode){case"#dual-sliders":$(".dual-sliders").find(".tooltip-min").find(".tooltip-inner").text(val[0]),$(".dual-sliders").find(".tooltip-max").find(".tooltip-inner").text(val[1])}}function onSliderChangedProxy(mode,val){$(".save-tip").show().text("Saving...");$(mode);switch(mode){case"#dual-sliders":$scope.obj.confidenceConfig[0].minThreshold=val[0],$scope.obj.confidenceConfig[0].definiteThreshold=val[1]}}void 0===$scope.nodeInfo.nodeInfo.minThreshold||"undefined"==typeof $scope.nodeInfo.nodeInfo.minThreshold?$scope.obj.confidenceConfig[0].minThreshold="0.6":$scope.obj.confidenceConfig[0].minThreshold=$scope.nodeInfo.nodeInfo.minThreshold.toString(),void 0===$scope.nodeInfo.nodeInfo.definiteThreshold||"undefined"==typeof $scope.nodeInfo.nodeInfo.definiteThreshold?$scope.obj.confidenceConfig[0].definiteThreshold="0.9":$scope.obj.confidenceConfig[0].definiteThreshold=$scope.nodeInfo.nodeInfo.definiteThreshold.toString();var array=[];array.push(parseFloat($scope.obj.confidenceConfig[0].minThreshold)),array.push(parseFloat($scope.obj.confidenceConfig[0].definiteThreshold)),dualS=registerSlider("#dual-sliders",{tooltip:"always",tooltip_split:!0,tooltip_position:"bottom"});var slider=$(".lookEntityContainer").find("#triple-slider")[0];slider&&slider.noUiSlider&&slider.noUiSlider.destroy(),noUiSlider.create(slider,{start:[array[0],array[1]],connect:[!1,!0,!0],tooltips:[wNumb({decimals:2}),wNumb({decimals:2})],values:[.6,.9],step:.05,range:{min:[0],max:[1]}}),slider.noUiSlider.off("change"),slider.noUiSlider.on("change",function(values){$scope.obj.confidenceConfig[0].minThreshold=values[0],$scope.obj.confidenceConfig[0].definiteThreshold=values[1]});for(var connect=slider.querySelectorAll(".noUi-connect"),classes=["c-2-color","c-3-color"],i=0;i<connect.length;i++)connect[i].classList.add(classes[i]);formatTooltip("#dual-sliders",array)},100)}function prepareGroupIntnetNodeMessages(res){$scope.groupIntnetMessagePrompts=[];var _tempmessages=[];$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.message&&(res=res||$scope.nodeInfo.dialogNodeInstance.nodeOptions.message),res&&res.length?$.each(res,function(k,message){var _tempMessageObject={channel:message.channel,text:decodeJS(message.text),type:message.type},_tempMessageObjectPayload={channel:message.channel,text:message.text,type:message.type};message._id&&(_tempMessageObject._id=message._id,_tempMessageObjectPayload._id=message._id),("wfacebookG"===_tempMessageObject.channel||"wfacebookC"===_tempMessageObject.channel||"wfacebook"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessageObject&&_tempMessageObject.text&&($scope.groupIntnetMessagePrompts.push(_tempMessageObject),_tempmessages.push(_tempMessageObjectPayload)),$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&($scope.nodeInfo.dialogNodeInstance.nodeOptions.message=_tempmessages)}):$scope.nodeInfo.dialogNodeInstance.nodeOptions.message=[]}function sortableCallbackErrorPromt(e,uiElement){if($scope.userErrorPromptsCopy.length>1){var dropindex=uiElement.item.sortable.dropindex;setTimeout(function(){saveErrorPromptMessages($scope.userErrorPromptsCopy,dropindex,!1)},50)}else NotificationService.notify("If more than one prompt message is defined","error")}function checkMLSyncStatus(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){"Finished"===res.data.trainingStatus?($scope.saveInprogress=!1,finishSaving(".machineLearningLevelSave")):"Failed"===res.data.trainingStatus?($scope.saveInprogress=!1,finishSaving(".machineLearningLevelSave")):($scope.saveInprogress=!0,startSaving(".machineLearningLevelSave"))},function(err){$scope.saveInprogress=!1,finishSaving(".machineLearningLevelSave");var _msg=i18n.i18nString("err_on_fetching_msg");NotificationService.notify(_msg,"error")})}function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}function cityAdvanceInit(param){$element.on("click",".dropdown-menu input, .dropdown-menu label",function(e){e.stopPropagation()}),$scope.continentSelected=i18n.i18nString("continentSelected"),$scope.countrySelected=i18n.i18nString("countrySelected"),$scope.stateSelected=i18n.i18nString("stateSelected"),$scope.continentList=geoLocationIds.continents,$scope.continentIdlist=[],$scope.continentNameslist=[],$scope.earlierContinentIds=[],$scope.earlierContinentNames=[],$scope.earlierCountryIds=[],$scope.earlierCountryNames=[],$scope.earlierStateIds=[],$scope.earlierStateNames=[],$scope.countryIdlist=[],$scope.countrynamelist=[],$scope.stateIdlist=[],$scope.statenamelist=[],$scope.continentsList=[],$scope.countriesLists=[],$scope.statesLists=[],0===param.length?($scope.continentsAll=[{id:"defaultContinent",name:i18n.i18nString("continentSelected"),checked:!0}],$scope.countriesAll=[{id:"defaultCountry",name:i18n.i18nString("countrySelected"),checked:!0}],$scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!0}],_.forEach($scope.continentList,function(v,k){$scope.continentsList.push({id:k,name:v,checked:!0})}),_.forEach($scope.continentList,function(v,k){$scope.earlierContinentIds.push(k),$scope.earlierContinentNames.push(v)})):($scope.continentsAll=[{id:"defaultContinent",name:i18n.i18nString("continentSelected"),checked:!1}],_.forEach($scope.continentList,function(v,k){$scope.continentsList.push({id:k,name:v,checked:!1})}),_.forEach(param,function(idCity){-1===idCity.indexOf(".")?-1===$scope.continentIdlist.indexOf(idCity)&&($scope.continentIdlist.push(idCity),$scope.continentNameslist.push(_.find($scope.continentsList,{id:idCity}).name),_.find($scope.continentsList,{id:idCity}).checked=!0,_.forEach(geoLocationIds.countries[idCity],function(v,k){$scope.countriesLists.push({id:idCity+"."+k,name:v,checked:!1,parentId:idCity})})):($scope.countriesAll=[{id:"defaultCountry",name:i18n.i18nString("countrySelected"),checked:!1}],-1===$scope.continentIdlist.indexOf(idCity.split(".")[0])&&($scope.continentIdlist.push(idCity.split(".")[0]),$scope.continentNameslist.push(_.find($scope.continentsList,{id:idCity.split(".")[0]}).name),_.find($scope.continentsList,{id:idCity.split(".")[0]}).checked=!0,_.forEach(geoLocationIds.countries[idCity.split(".")[0]],function(v,k){$scope.countriesLists.push({id:idCity.split(".")[0]+"."+k,name:v,checked:!1,parentId:idCity.split(".")[0]})})),void 0===idCity.split(".")[2]?-1===$scope.countryIdlist.indexOf(idCity)&&($scope.countryIdlist.push(idCity),$scope.countrynamelist.push(_.find($scope.countriesLists,{id:idCity}).name),_.find($scope.countriesLists,{id:idCity}).checked=!0,_.forEach(geoLocationIds.states[idCity.split(".")[1]],function(v,k){$scope.statesLists.push({id:idCity+"."+k,name:v,checked:!1})})):($scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!1}],-1===$scope.countryIdlist.indexOf(idCity.slice(0,idCity.lastIndexOf(".")))&&($scope.countryIdlist.push(idCity.slice(0,idCity.lastIndexOf("."))),$scope.countrynamelist.push(_.find($scope.countriesLists,{id:idCity.slice(0,idCity.lastIndexOf("."))}).name),_.find($scope.countriesLists,{id:idCity.slice(0,idCity.lastIndexOf("."))}).checked=!0,_.forEach(geoLocationIds.states[idCity.split(".")[1]],function(v,k){$scope.statesLists.push({id:idCity.slice(0,idCity.lastIndexOf("."))+"."+k,name:v,checked:!1})})),-1===$scope.stateIdlist.indexOf(idCity)&&($scope.stateIdlist.push(idCity),$scope.statenamelist.push(_.find($scope.statesLists,{id:idCity}).name),_.find($scope.statesLists,{id:idCity}).checked=!0)))}),$scope.earlierContinentIds=$workflowService.cloneData($scope.continentIdlist),$scope.earlierContinentNames=$workflowService.cloneData($scope.continentNameslist),$scope.earlierCountryIds=$workflowService.cloneData($scope.countryIdlist),$scope.earlierCountryNames=$workflowService.cloneData($scope.countrynamelist),$scope.earlierStateIds=$workflowService.cloneData($scope.stateIdlist),$scope.earlierStateNames=$workflowService.cloneData($scope.statenamelist),$scope.continentSelected=getCityAdvText($scope.continentNameslist),$scope.countrySelected=getCityAdvText($scope.countrynamelist),$scope.stateSelected=getCityAdvText($scope.statenamelist))}function mixPanelUpdateEvent(componentData,dialog){componentData=$scope.nodeInfo.nodeInfo||{},dialog=$scope.flowtaskObj||{};var _eventPayload={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,"Dialog Name":dialog.name,"Component Name":componentData.intent||componentData.name,"Dialog Version":"V2",Category:"Engagement L2","Sub Category":"Conversation - Dialog Task",Level:"Engagement L2","Primary Intent creation mode":"Storyboard"},event="";"intent"===componentData.type?event="Conversation - Dialog Intent updated":"message"===componentData.type?event="Conversation - Dialog Message Node updated":"entity"===componentData.type?event="Conversation - Dialog Entity Node updated":"dialogAct"===componentData.type?event="Conversation - Dialog Confirmation Node updated":"service"===componentData.type?event="Conversation - Bot action Service updated":"script"===componentData.type?event="Conversation - Bot action Script updated":"logic"===componentData.type?event="Conversation - Bot action Logic updated":"SDKWebHook"===componentData.type?event="Conversation - Bot action Webhook updated":"process"===componentData.type?event="Conversation - Bot action Process updated":"agentTransfer"===componentData.type?event="Conversation - Agent Transfer node updated":"form"===componentData.type?event="Conversation - Form node updated":"botAction"===componentData.type&&(event="componentData - Bot action Node updated"),event&&mixPanel.postEvent(event,_eventPayload)}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createUtterance"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Utterance Added"),"createPattern"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Pattern Added"),"createTraits"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Rule Added"),"createEntitySynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Entity Synonym added"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function loadMultiCategoryComponents(){$.isEmptyObject($scope.nodeInfo.nodeInfo)||$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&"dateperiod"===$scope.nodeInfo.nodeInfo.entityType&&($scope.multiCategoryPromptsCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.multiCategoryPrompts),$scope.multiCategoryPromptsCopy&&$scope.multiCategoryPromptsCopy.forEach(function(category){category.message.forEach(function(msg){msg.text=decodeJS(msg.text)}),category.errorMessage.forEach(function(msg){msg.text=decodeJS(msg.text)}),category.newPrompt={channel:"default",text:"",type:"basic",_id:""},category.newErrorPrompt={channel:"default",text:"",type:"basic",_id:""}}))}function loadMessages(){$.isEmptyObject($scope.nodeInfo.nodeInfo)?$scope.userPromptsCopy=[]:$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&("entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"message"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"dialogact"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"service"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"form"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase())&&($scope.userPromptsCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.message),$scope.userPromptsCopy&&$scope.userPromptsCopy[0]?$scope.userPromptsCopy.forEach(function(message){message.text=decodeJS(message.text)}):($scope.userPromptsCopy=[],$scope.nodeInfo.nodeInfo.message=[])),$.isEmptyObject($scope.nodeInfo.nodeInfo)?$scope.userErrorPromptsCopy=[]:$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&("entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"form"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase())&&($scope.userErrorPromptsCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.errorMessage),$scope.nodeInfo.nodeInfo.hasOwnProperty("errorPromptSequencing")&&($scope.errorPromptObj.errorPromptSequencing=$workflowService.cloneData($scope.nodeInfo.nodeInfo.errorPromptSequencing)),$scope.userErrorPromptsCopy&&$scope.userErrorPromptsCopy[0]?$scope.userErrorPromptsCopy.forEach(function(message){message.text=decodeJS(message.text)}):($scope.nodeInfo.nodeInfo.errorMessage=[],$scope.userErrorPromptsCopy=[])),$.isEmptyObject($scope.nodeInfo.nodeInfo)?$scope.submitMessagesCopy=[]:$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"form"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&($scope.submitMessagesCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.submitMessage),$scope.submitMessagesCopy&&$scope.submitMessagesCopy[0]?$scope.submitMessagesCopy.forEach(function(message){message.text=decodeJS(message.text)}):($scope.nodeInfo.nodeInfo.submitMessage=[],$scope.submitMessagesCopy=[]))}function saveCompositePatterns(e,ui){var existingPatternsValue=$scope.props.patterns||[];startSaving(".entityCompositePatterns"),BTFlowtaskService.updateComponentPatterns($scope.stream._id,$scope.nodeInfo.nodeInfo._id,{
patterns:existingPatternsValue,compositePatterns:$scope.props.compositePattern}).then(function(res){if(mixpanelEvent("createPattern"),res&&res.data){addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId);var utterances=[];$scope.nodeInfo.nodeInfo.utterances&&(utterances=$scope.nodeInfo.nodeInfo.utterances),$scope.nodeInfo.nodeInfo=$scope.component=res.data,$scope.nodeInfo.nodeInfo.utterances=utterances,$scope.dialogData("updateComponent",res.data)}finishSaving(".entityCompositePatterns")},function(error){finishSaving(".entityCompositePatterns")})}function loadSelectedEvents(eventIds){$scope.events.forEach(function(event){event.checked=!1});eventIds&&eventIds.length&&eventIds.forEach(function(event){var _eve=_.find($scope.events,{id:event});_eve&&(_eve.checked=!0)})}function decodeJS(_obj){try{return decodeURIComponent(_obj.replace(/&lt;/g,"<").replace(/&gt;/g,">"))}catch(e){return _obj}}function processUIEndPoint(endPoint){if(!endPoint)return"";var _url=urlutil.concat({host:endPoint.host?endPoint.host:"",path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol?endPoint.protocol:""});return _url}function setupConnections(){$scope.tempDialogNodeInstConnObj=[],$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.connections&&Object.keys($scope.nodeInfo.dialogNodeInstance.connections).length>0?$.each($scope.nodeInfo.dialogNodeInstance.connections,function(k,conn){var modifiedConn=JSON.parse(JSON.stringify(conn));conn.conjoin?"and"===conn.conjoin?(modifiedConn.conditionAnd=!0,modifiedConn.conditionOr=!1,modifiedConn.orSelected=!1):(modifiedConn.conditionAnd=!1,modifiedConn.conditionOr=!0,modifiedConn.orSelected=!0):(modifiedConn.conditionAnd=!0,modifiedConn.conditionOr=!0,modifiedConn.orSelected=!1),$scope.tempDialogNodeInstConnObj.push($.extend(!0,{},modifiedConn))}):$scope.tempDialogNodeInstConnObj=[],0===$scope.tempDialogNodeInstConnObj.length&&$scope.addElseIfBlock();var tempConnects=!1;$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.tempConnections&&(tempConnects=Object.keys($scope.nodeInfo.dialogNodeInstance.tempConnections).filter(function(con){return"end"===$scope.nodeInfo.dialogNodeInstance.tempConnections[con].targetId?!1:!0})),$scope.hasTempConnections=tempConnects&&tempConnects.length}function checkEntityRulesSyncWithML(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithEntityRules")?$scope.showEntityTrain=!0:$scope.showEntityTrain=!1,"Finished"===res.data.trainingStatus&&res.data.isMlInSyncWithEntityRules?($scope.trainStatus.saving=!1,$scope.trainStatus.success=!0):"Failed"===res.data.trainingStatus?($scope.trainStatus.saving=!1,$scope.trainStatus.success=!1):"Finished"!==res.data.trainingStatus||res.data.isMlInSyncWithEntityRules?($scope.trainStatus.saving=!0,$scope.trainStatus.success=!1):($scope.trainStatus.saving=!1,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!1)},function(err){$scope.trainStatus.saving=!1,$scope.trainStatus.success=!1;var _msg=i18n.i18nString("fetching_rules_ML");NotificationService.notify(_msg,"error")})}function preparePromptOptionsData(){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions?"required"===$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions?$scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional=!1:$scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional=!0:$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional?$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions="optional":$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions?($scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional=!1,$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions="required"):$scope.nodeInfo.dialogNodeInstance.nodeOptions={isOptional:!1,promptOptions:"required"}}function prepareEntityRulesData(){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.entityRules?($scope.entityRules.rules=$scope.nodeInfo.dialogNodeInstance.nodeOptions.entityRules,$scope.rulesKeys=Object.keys($scope.entityRules.rules)):($scope.entityRules.rules={},$scope.rulesKeys=Object.keys($scope.entityRules.rules))}function prepareIVRData(){("entity"===$scope.nodeInfo.dialogNodeInstance.type||"dialogAct"===$scope.nodeInfo.dialogNodeInstance.type||"message"===$scope.nodeInfo.dialogNodeInstance.type)&&($scope.headingsList.showIVRProperty.show=!0,$scope.isEnabled=!1,$scope.nodeInfo.nodeInfo&&!($scope.nodeInfo.nodeInfo.ivrOptions||$scope.nodeInfo.nodeInfo.ivrOptions&&!Object.keys($scope.nodeInfo.nodeInfo.ivrOptions).length)&&($scope.nodeInfo.nodeInfo.ivrOptions=_defaultIVRProps),_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable&&($scope.isEnabled=_selectedStream.ivrSettings.enable,$scope.nodeInfo.nodeInfo&&!$scope.nodeInfo.nodeInfo.ivrOptions?($scope.nodeInfo.nodeInfo.ivrOptions={},$workflowService.cloneData(_defaultIVRProps,$scope.nodeInfo.nodeInfo.ivrOptions)):$scope.nodeInfo.nodeInfo.ivrOptions&&!$scope.nodeInfo.nodeInfo.ivrOptions.errorPrompts&&($scope.nodeInfo.nodeInfo.ivrOptions.errorPrompts=[]),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&($scope.originalIvrGrammerCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.ivrOptions.grammars)),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.advance&&$scope.nodeInfo.nodeInfo.ivrOptions.advance.properties&&($scope.originalIvrVxmlCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties))))}function intialize(){if(prepareIVRData(),$scope.hasUnsavedConnection=!1,$scope.nodeInfo.dialogNodeInstance!=={}){setupConnections(),initListOfValues(),addNewKeyVal(),addNewKeyVal(!0),$scope.nodeInfo.nodeInfo.lookupId&&($scope.lookupId=$scope.nodeInfo.nodeInfo.lookupId,getLookupJson()),$scope.nodeName=$scope.nodeInfo.dialogNodeInstance.name||$scope.nodeInfo.nodeInfo.name||"",$scope.nodeLabel=$scope.nodeInfo.nodeInfo.label||"",$scope.nodeAuthURL=$scope.nodeInfo.nodeInfo.customAuthenticationURL||"",$scope.nodeLabel=$scope.nodeLabel.replace(/&lt;/gi,"<").replace(/&gt;/gi,">");var prepareComponents=function(streamId,componentId){BTFlowtaskService.getComponents(streamId,componentId).then(function(response){response&&response.data&&response.data.piiDataEnabled?$scope.status.piiDataEnabled="true":$scope.status.piiDataEnabled="false"})};if(prepareComponents($workflowService.selectedStream()._id,$scope.nodeInfo.nodeInfo._id),"entity"===$scope.nodeInfo.dialogNodeInstance.type)preparePromptOptionsData(),(void 0===$scope.nodeInfo.nodeInfo.previewContext||$scope.nodeInfo.nodeInfo.previewContext==={})&&($scope.nodeInfo.nodeInfo.previewContext=""),("dateperiod"===$scope.nodeInfo.nodeInfo.entityType||"address"===$scope.nodeInfo.nodeInfo.entityType||"label"===$scope.nodeInfo.nodeInfo.entityType||"description"===$scope.nodeInfo.nodeInfo.entityType||"from_number"===$scope.nodeInfo.nodeInfo.entityType||"to_number"===$scope.nodeInfo.nodeInfo.entityType||"attachment"===$scope.nodeInfo.nodeInfo.entityType||"json_object"===$scope.nodeInfo.nodeInfo.entityType)&&($scope.isArrayAllowed=!1),"label"===$scope.nodeInfo.nodeInfo.entityType&&void 0===$scope.nodeInfo.dialogNodeInstance.nodeOptions.userInputCorrection?$scope.nodeInfo.dialogNodeInstance.nodeOptions.autoCorrect="true":$scope.nodeInfo.dialogNodeInstance.nodeOptions.userInputCorrection?$scope.nodeInfo.dialogNodeInstance.nodeOptions.autoCorrect="true":$scope.nodeInfo.dialogNodeInstance.nodeOptions.autoCorrect="false";else if($scope.nodeInfo.dialogNodeInstance.nodeOptions){if("logic"===$scope.nodeInfo.dialogNodeInstance.type){$scope.contextVars=[],$scope.contextVariables=$scope.nodeInfo.nodeInfo.contextMap?JSON.parse($scope.nodeInfo.nodeInfo.contextMap):{};var contextkeys=Object.keys($scope.contextVariables);$scope.contextVariablesArray=[],contextkeys.forEach(function(contextkey){$scope.contextVariablesArray.push({key:contextkey,value:$scope.contextVariables[contextkey]})}),console.log($scope.contextVariablesArray)}}else $scope.nodeInfo.dialogNodeInstance.nodeOptions={transitionType:"auto"};if("SDKWebHook"!==$scope.nodeInfo.nodeInfo.type&&"agentTransfer"!==$scope.nodeInfo.nodeInfo.type||!_selectedStream.sdkSubscription?$scope.sdkConfiguration=null:($scope.sdkConfiguration=$.extend(!0,{},_selectedStream.sdkSubscription),loadSelectedEvents($scope.sdkConfiguration.subscribedFor)),$scope.headingsList.showInstanceProperty.show=!0,"entity"===$scope.nodeInfo.nodeInfo.type||"dialogAct"===$scope.nodeInfo.nodeInfo.type||"service"===$scope.nodeInfo.nodeInfo.type||"script"===$scope.nodeInfo.nodeInfo.type||"message"===$scope.nodeInfo.nodeInfo.type&&"universalbot"!==$scope.stream.type)$scope.headingsList.showInstanceProperty.show=!0;else if("intent"===$scope.nodeInfo.nodeInfo.type&&$scope.nodeInfo.dialogNodeInstance.uId!==$scope.nodeInfo.dialogInfo.firstNodeId&&$scope.nodeInfo.nodeInfo.dialogId&&0===$scope.nodeInfo.nodeInfo.dialogId.indexOf("dg-")){$scope.headingsList.showInstanceProperty.show=!1,$scope.callAnotherDialog=!1;var _dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId||$scope.nodeInfo.nodeInfo.dialogId;$scope.nodeInfo.dialogNodeInstance.flowTaskId&&$scope.nodeInfo.dialogNodeInstance.flowTaskId===_dialogRefId&&($scope.headingsList.showInstanceProperty.show=!0,$scope.callAnotherDialog=!0)}else"agentTransfer"===$scope.nodeInfo.nodeInfo.type&&($scope.headingsList={showInstanceProperty:{show:!1,isOpen:!0,key:"instanceProperties"},showInstanceConnection:{show:!1,isOpen:!1,key:"connection"},showNodeProperty:{show:!0,isOpen:!1,key:"nodeProperties"},showHelp:{show:!1,isOpen:!1,key:"help"}});if($scope.nodeInfo.nodeInfo.script)try{$scope.scriptData=$scope.nodeInfo.nodeInfo.script&&decodeURIComponent($scope.nodeInfo.nodeInfo.script)}catch(e){$scope.scriptData=$scope.nodeInfo.nodeInfo.script}"intent"===$scope.nodeInfo.nodeInfo.type&&$scope.nodeInfo.dialogInfo.firstNodeId===$scope.nodeInfo.dialogNodeInstance.uId?($scope.isFirstNode=!0,$scope.headingsList.showInstanceProperty.show=!1):"process"===$scope.nodeInfo.nodeInfo.type?$scope.headingsList.showInstanceProperty.show=!1:($scope.isFirstNode=!1,$scope.headingsList.showInstanceProperty.show=!0),openSection($scope.nodeInfo.openSection),$scope.contextMap={isLoading:!1,keyCount:0,subIntentEntities:[],remainingKeys:[]},$scope.postContextMap={isLoading:!1,keyCount:0,subIntentEntities:[],remainingKeys:[]},"intent"===$scope.nodeInfo.nodeInfo.type&&$scope.callAnotherDialog&&($scope.contextMap.isLoading=!0,fetchEntitiesForSubIntent(),$scope.headingsList.showInstanceConnection.show=!0,openSection("connection"===$scope.nodeInfo.openSection?"default":$scope.nodeInfo.openSection)),initializeContextCustomValues()}}function initializeContextCustomValues(){$scope.nodeInfo&&$scope.nodeInfo.dialogInfo&&$scope.nodeInfo.dialogInfo.dialogNodes&&($scope.customContextValues=$scope.nodeInfo.dialogInfo.dialogNodes)}function initListOfValues(){$scope.lovObj.isMultiLangDetectionEnabled=$scope.nodeInfo.nodeInfo.isMultiLangDetectionEnabled,$scope.nodeInfo.nodeInfo.allowedValues&&(void 0!==$scope.nodeInfo.nodeInfo.allowedValues.variable?$scope.dropDownInfo={staticDropdownType:"context",contextDropdownVals:{contextVal:""!==$scope.nodeInfo.nodeInfo.allowedValues.variable?$scope.nodeInfo.nodeInfo.allowedValues.variable:"",contextValKey:""!==$scope.nodeInfo.nodeInfo.allowedValues.valueKey?$scope.nodeInfo.nodeInfo.allowedValues.valueKey:"",contextTitleKey:""!==$scope.nodeInfo.nodeInfo.allowedValues.titleKey?$scope.nodeInfo.nodeInfo.allowedValues.titleKey:"",contextSynonymsKey:""!==$scope.nodeInfo.nodeInfo.allowedValues.synonymsKey?$scope.nodeInfo.nodeInfo.allowedValues.synonymsKey:"",contextWordIndex:""!==$scope.nodeInfo.nodeInfo.allowedValues.indexKey?$scope.nodeInfo.nodeInfo.allowedValues.indexKey:""},staticDropdownVals:[]}:($scope.dropDownInfo={staticDropdownType:"staticList",contextDropdownVals:{},staticDropdownVals:[]},$scope.nodeInfo.nodeInfo.allowedValues.values||($scope.nodeInfo.nodeInfo.allowedValues.values=[{title:"",value:""}]),$.each($scope.nodeInfo.nodeInfo.allowedValues.values,function(k,objVal){$scope.dropDownInfo.staticDropdownVals.push({title:$scope._constants_.replaceSpecialChar(objVal.title),value:$scope._constants_.replaceSpecialChar(objVal.value),synonyms:$scope._constants_.replaceSpecialChar(objVal.synonyms?"string"==typeof objVal.synonyms?objVal.synonyms:objVal.synonyms.join():"")})}))),void 0!==$scope.nodeInfo.nodeInfo.spellcorrectThreshold?$scope.autoCorrectThresholdEnum=$scope.nodeInfo.nodeInfo.spellcorrectThreshold:$scope.autoCorrectThresholdEnum=0,void 0!==$scope.nodeInfo.nodeInfo.minThreshold?$scope.obj.confidenceConfig[0].minThreshold=$scope.nodeInfo.nodeInfo.minThreshold:$scope.obj.confidenceConfig[0].minThreshold=.6,void 0!==$scope.nodeInfo.nodeInfo.definiteThreshold?$scope.obj.confidenceConfig[0].definiteThreshold=$scope.nodeInfo.nodeInfo.definiteThreshold:$scope.obj.confidenceConfig[0].definiteThreshold=.9,setTimeout(function(){$(".listOfvals").scrollTop(1)},500),setTimeout(function(){$(".listOfItems").scrollTop(1)},500)}function initializeSlider(){setTimeout(function(){function onSliderChanged(mode,val){switch($(".save-tip").show().text(i18n.i18nString("saving")),mode){case"#hybrid-slider":$scope.autoCorrectThresholdEnum=val;break;case"#hybrid-slider1":$scope.autoCorrectThresholdEnum=val;break;case"#hybrid-slider2":$scope.autoCorrectThresholdEnum=val}formatTooltip(mode,val)}function formatTooltip(mode,val){switch(mode){case"#hybrid-slider":$("#enum-slider").find(".tooltip-inner").text(val+"%");break;case"#hybrid-slider1":$("#lookup-slider").find(".tooltip-inner").text(val+"%");break;case"#hybrid-slider2":$("#remote-slider").find(".tooltip-inner").text(val+"%")}}function registerSlider(ele,obj){var slider=$(ele).bootstrapSlider(obj);return $(ele).slider().on("slideStop ",function(ev){onSliderChanged(ele,ev.value)}),$(ele).slider().on("slide",function(ev){formatTooltip(ele,ev.value)}),slider}var s1=registerSlider("#hybrid-slider1",{tooltip:"always",tooltip_position:"bottom"}),s2=registerSlider("#hybrid-slider",{tooltip:"always",tooltip_position:"bottom"}),s3=registerSlider("#hybrid-slider2",{tooltip:"always",tooltip_position:"bottom"});void 0!==s1&&s1.bootstrapSlider("setValue",$scope.autoCorrectThresholdEnum),void 0!==s2&&s2.bootstrapSlider("setValue",$scope.autoCorrectThresholdEnum),void 0!==s3&&s3.bootstrapSlider("setValue",$scope.autoCorrectThresholdEnum),formatTooltip("#hybrid-slider",$scope.autoCorrectThresholdEnum),formatTooltip("#hybrid-slider1",$scope.autoCorrectThresholdEnum),formatTooltip("#hybrid-slider2",$scope.autoCorrectThresholdEnum)},450)}function openSection(sectionKey){$scope.nodeInfo.openSection=sectionKey,Object.keys($scope.headingsList).map(function(section){return $scope.headingsList[section]}).forEach(function(section){section.isOpen=!1});var _index=_.findIndex(Object.keys($scope.headingsList).map(function(section){return $scope.headingsList[section]}),{key:sectionKey});_index>-1?Object.keys($scope.headingsList).map(function(section){return $scope.headingsList[section]})[_index].isOpen=!0:openSection("nodeProperties")}function fetchEntitiesForSubIntent(){$scope.linkedTaskavailableNodesNames={mappedIntents:[],entities:[],nodes:[]},BTFlowtaskService.getFlowtaskComponents(_selectedStream._id,$scope.nodeInfo.nodeInfo.dialogId).then(function(res){var _res=res&&res.data,_contextMap={},_contextMapResolved={subIntentEntities:[],remainingKeys:[]};if(_res&&_res.length>0&&$.each(_res,function(k,component){"entity"===component.type&&_contextMapResolved.subIntentEntities.push({key:component.name,val:"",entityType:component.entityType||""}),"intent"===component.type&&$scope.firstNodeComponentId!==component._id?$scope.linkedTaskavailableNodesNames.mappedIntents.push(component.name):"entity"===component.type?$scope.linkedTaskavailableNodesNames.entities.push(component.name):$scope.linkedTaskavailableNodesNames.nodes.push(component.name)}),$scope.nodeInfo.dialogNodeInstance.contextMap)try{_contextMap=$scope.nodeInfo.dialogNodeInstance.contextMap.constructor===Object?$scope.nodeInfo.dialogNodeInstance.contextMap:JSON.parse($scope.nodeInfo.dialogNodeInstance.contextMap),$.each(_contextMap,function(k,contextVal){var _isMatched=!1,_key="",_isEntity=!1;0===k.indexOf("context.entities.")?(_key=k.replace("context.entities.",""),_isEntity=!0):_key=k,_isEntity&&$.each(_contextMapResolved.subIntentEntities,function(k,intentVal){return _key===intentVal.key?(_isMatched=!0,_contextMapResolved.subIntentEntities[k].val=contextVal,!1):void 0}),_isMatched||(_isEntity?_contextMapResolved.remainingKeys.push({key:k,val:contextVal}):_contextMapResolved.remainingKeys.push({key:k,val:contextVal}))})}catch(e){_contextMap={}}$scope.contextMap={isLoading:!1,keyCount:_contextMapResolved.subIntentEntities.length+_contextMapResolved.remainingKeys.length,subIntentEntities:_contextMapResolved.subIntentEntities,remainingKeys:_contextMapResolved.remainingKeys};var _postContextMapResolved={subIntentEntities:[],remainingKeys:[]};if($scope.nodeInfo.dialogInfo&&$scope.nodeInfo.dialogInfo.currentEntities&&$scope.nodeInfo.dialogInfo.currentEntities.length>0){var entityNodes=$workflowService.cloneData($scope.nodeInfo.dialogInfo.currentEntities);$.each(_.uniq(entityNodes,"compId"),function(k,component){_postContextMapResolved.subIntentEntities.push({key:component.name,val:"",entityType:component.entityType||""})})}if($scope.nodeInfo.dialogNodeInstance.postContextMap)try{_contextMap=$scope.nodeInfo.dialogNodeInstance.postContextMap.constructor===Object?$scope.nodeInfo.dialogNodeInstance.postContextMap:JSON.parse($scope.nodeInfo.dialogNodeInstance.postContextMap),$.each(_contextMap,function(k,contextVal){var _isMatched=!1,_key="",_isEntity=!1;0===k.indexOf("context.entities.")?(_key=k.replace("context.entities.",""),_isEntity=!0):_key=k,_isEntity&&$.each(_postContextMapResolved.subIntentEntities,function(k,intentVal){return _key===intentVal.key?(_isMatched=!0,_postContextMapResolved.subIntentEntities[k].val=contextVal,!1):void 0}),_isMatched||(_isEntity?_postContextMapResolved.remainingKeys.push({key:k,val:contextVal}):_postContextMapResolved.remainingKeys.push({key:k,val:contextVal}))})}catch(e){_contextMap={}}$scope.postContextMap={isLoading:!1,keyCount:_postContextMapResolved.subIntentEntities.length+_postContextMapResolved.remainingKeys.length,subIntentEntities:_postContextMapResolved.subIntentEntities,remainingKeys:_postContextMapResolved.remainingKeys}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function startSaving(className){$element.find(className).addClass("fa fa-refresh fa-spin")}function finishSaving(className,isError){$element.find(className).removeClass("fa fa-refresh fa-spin"),"error"===isError?$element.find(className).addClass("fa fa-times"):$element.find(className).addClass("fa fa-check"),setTimeout(function(){$element.find(className).removeClass("fa fa-check fa-times")},1e3)}function unique(array){for(var a=array.concat(),i=0;i<a.length;++i)for(var j=i+1;j<a.length;++j)a[i]===a[j]&&a.splice(j--,1);return a}function updateIvrStreamData(streamObj){BTStreamsService.editStream($workflowService.selectedStream()._id,streamObj).then(function(response){if(response.data.ivrSettings){$scope.enabled=response.data.ivrSettings.enable,$workflowService.selectedStream(response.data);$scope.enabled?i18n.i18nString("settings_enabled"):i18n.i18nString("settings_disabled");prepareIVRData()}})}function openBotLevelIVR(){$("#ivrNode").modal("hide"),$scope.enableIvrsettings(),$scope.groupIntentIvrCb.openIvr=!0,$scope.modalSlider.open("#ivrBotLevel")}function openChannelLevelTwilioVoice(){$scope.isAllVoiceEnabled=!0,setTimeout(function(){$scope.prop_panel_voice_channels_all_cb.openChannelLevelTwilioVoice()},500)}function openAudioCodesVoiceProp(){$scope.isAllVoiceEnabled=!0,setTimeout(function(){$scope.prop_panel_voice_channels_all_cb.openAudioCodesVoiceProp()},500)}function addNewKeyVal(lookupJson){return $scope.readonly?!1:void(lookupJson?($scope.newJson=!0,$scope.newJsonValue={title:"",value:"",synonyms:""}):($scope.newStatic=!0,$scope.newStaticValue={title:"",value:"",synonyms:""}))}function saveStaticDropDownValues(){var _drpDown=[],invalid=!1,notValidSyn=!1,notValidSynonymsArray=[];if(!$scope.dropDownInfo.staticDropdownVals.length)return void NotificationService.notify(i18n.i18nString("add_item"),"error");if($.each($scope.dropDownInfo.staticDropdownVals,function(k,drpOpts){var drpOptsCopy=$workflowService.cloneData(drpOpts);if(0===drpOptsCopy.title.length||0===drpOptsCopy.value.length)invalid=!0;else{var _tempObj=$scope._constants_.getFromBetween.get(drpOptsCopy.synonyms,"<",">"),_tempSynonyms=_tempObj.results;drpOptsCopy.synonyms=_tempObj.string.replace(/,,/g,","),","==drpOptsCopy.synonyms[0]&&","==drpOptsCopy.synonyms[drpOptsCopy.synonyms.length-1]&&(drpOptsCopy.synonyms=drpOptsCopy.synonyms.substring(1,drpOptsCopy.synonyms.length-1)),","==drpOptsCopy.synonyms[0]&&(drpOptsCopy.synonyms=drpOptsCopy.synonyms.substring(1,0)),","==drpOptsCopy.synonyms[drpOptsCopy.synonyms.length-1]&&(drpOptsCopy.synonyms=drpOptsCopy.synonyms.substring(0,drpOptsCopy.synonyms.length-1)),drpOptsCopy.synonyms=drpOptsCopy.synonyms.split(","),drpOptsCopy.synonyms=drpOptsCopy.synonyms.filter(function(syn){return""!==syn?syn:void 0}),drpOptsCopy.synonyms=drpOptsCopy.synonyms.map(function(syn){return syn.trim()}),_tempSynonyms=_tempSynonyms.map(function(eachSynonym){return/['||"||*]/.test(eachSynonym)&&notValidSynonymsArray.push(eachSynonym),notValidSyn||(notValidSyn=/['||"||*]/.test(eachSynonym)),"<"+eachSynonym.trim()+">"}),drpOptsCopy.synonyms=drpOptsCopy.synonyms.concat(_tempSynonyms),_drpDown.push(drpOptsCopy)}}),notValidSyn)return void NotificationService.notify(i18n.i18nString("special_char_allows"),"warning");if(invalid)return void NotificationService.notify(i18n.i18nString("req_fields"),"error");var _updateParams={allowedValues:{values:_drpDown},spellcorrectThreshold:$scope.autoCorrectThresholdEnum,entityType:$scope.nodeInfo.nodeInfo.entityType};"ge"==$scope.currentLanguage&&(_updateParams.minThreshold=$scope.obj.confidenceConfig[0].minThreshold,_updateParams.definiteThreshold=$scope.obj.confidenceConfig[0].definiteThreshold,_updateParams.isMultiLangDetectionEnabled=$scope.lovObj.isMultiLangDetectionEnabled||!1);$workflowService.cloneData($scope.dropDownInfo.staticDropdownVals);return updateComponent(_updateParams,".entityDrpdownSettings",{message:i18n.i18nString("saved")})}function saveContextDropDownValues(){if(!$scope.dropDownInfo.contextDropdownVals.contextVal)return void NotificationService.notify(i18n.i18nString("specify_context_var"),"error");var _updateParams={allowedValues:{variable:$scope.dropDownInfo.contextDropdownVals.contextVal,titleKey:$scope.dropDownInfo.contextDropdownVals.contextTitleKey,valueKey:$scope.dropDownInfo.contextDropdownVals.contextValKey,synonymsKey:$scope.dropDownInfo.contextDropdownVals.contextSynonymsKey,indexKey:$scope.dropDownInfo.contextDropdownVals.contextWordIndex},spellcorrectThreshold:$scope.autoCorrectThresholdEnum,entityType:$scope.nodeInfo.nodeInfo.entityType};return"ge"==$scope.currentLanguage&&(_updateParams.minThreshold=$scope.obj.confidenceConfig[0].minThreshold,_updateParams.definiteThreshold=$scope.obj.confidenceConfig[0].definiteThreshold,_updateParams.isMultiLangDetectionEnabled=$scope.lovObj.isMultiLangDetectionEnabled||!1),updateComponent(_updateParams,".entityDrpdownSettings",{message:i18n.i18nString("saved")})}function fetchComponentDetails(){BTFlowtaskService.getComponents($scope.stream._id,$scope.nodeInfo.nodeInfo._id).then(function(res){$scope.nodeInfo.nodeInfo.applyDefaultTemplate=res.data&&res.data.hasOwnProperty("applyDefaultTemplate")?res.data.applyDefaultTemplate:!1,$scope.nodeInfo.nodeInfo.message=res.data.message,$scope.nodeInfo.nodeInfo.errorMessage=res.data.errorMessage,"dateperiod"===res.data.entityType?($scope.nodeInfo.nodeInfo.multiCategoryPrompts=res.data.multiCategoryPrompts||[],loadMultiCategoryComponents()):loadMessages(),$scope.dialogData("updateComponent",res&&res.data)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("fetch_currcomponent"),"error")})}function addLocalProperties(data){$scope.nodeInfo.nodeInfo.nodeId&&(data.nodeId=$scope.nodeInfo.nodeInfo.nodeId),"entity"===data.type&&"dateperiod"===data.entityType&&($scope.nodeInfo.nodeInfo.multiCategoryPrompts=$workflowService.cloneData($scope.multiCategoryPromptsCopy))}function updateComponent(component,className,lookupInfo,label,msg){return BTFlowtaskService.updateComponent($scope.stream._id,$scope.nodeInfo.nodeInfo._id,component).then(function(res){if(mixPanelUpdateEvent(),_isClosed)return!1;component&&component.hasOwnProperty("errorPromptSequencing")&&($scope.nodeInfo.nodeInfo.errorPromptSequencing=component.errorPromptSequencing),".intentGeneralSettings"==className&&($scope.getBotsynonyms(),$scope.nodeInfo.dialogNodeInstance.name=$scope.intentName),"process"===$scope.nodeInfo.nodeInfo.type&&($scope.nodeInfo.dialogNodeInstance.name=$scope.nodeName);var _currentEntities=_.filter($scope.nodeInfo.dialogInfo.currentEntities,{compId:res.data._id});_currentEntities&&_currentEntities.length&&_currentEntities.forEach(function(currentEntity){currentEntity.name=res.data.name});var _currentIntents=_.filter($scope.nodeInfo.dialogInfo.currentIntents,{compId:res.data._id});_currentIntents&&_currentIntents.length&&_currentIntents.forEach(function(currentIntent){currentIntent.name=res.data.name}),"entity"===res.data.type&&(component&&component.errorMessage&&(component.errorMessage[0]._id=res.data.errorMessage[0],0===$scope.nodeInfo.nodeInfo.errorMessage.length&&($scope.nodeInfo.nodeInfo.errorMessage=component.errorMessage),$scope.nodeInfo.nodeInfo.errorMessage[0]=angular.extend($scope.nodeInfo.nodeInfo.errorMessage[0],component.errorMessage[0])),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&($scope.originalIvrGrammerCopy=$scope.nodeInfo.nodeInfo.ivrOptions.grammars),res.data.errorMessage[0]=$scope.nodeInfo.nodeInfo.errorMessage[0],"address"===res.data.entityType||"label"===res.data.entityType||"description"===res.data.entityType||"from_number"===res.data.entityType||"to_number"===res.data.entityType?$scope.isArrayAllowed=!1:$scope.isArrayAllowed=!0,$scope.selectcityAdv=!1,"cityAdv"===res.data.entityType&&(res.data.entityFields&&res.data.entityFields.cityAdvanced?($scope.selectcityAdv=!0,cityAdvanceInit(res.data.entityFields.cityAdvanced)):($scope.selectcityAdv=!0,$scope.continentSelected=i18n.i18nString("continentSelected"),$scope.countrySelected=i18n.i18nString("countrySelected"),$scope.stateSelected=i18n.i18nString("stateSelected"),$scope.countriesList={},$scope.statesList={},$scope.countryIdlist=[],$scope.countrynamelist=[],$scope.stateIdlist=[],$scope.statenamelist=[],$scope.earlierContinentIds=[],$scope.earlierContinentNames=[],$scope.earlierCountryIds=[],$scope.earlierCountryNames=[],$scope.earlierStateIds=[],$scope.earlierStateNames=[],$scope.contOkDisable=!1,$scope.continentList=geoLocationIds.continents,$scope.continentsAll=[{id:"defaultContinent",name:i18n.i18nString("continentSelected"),checked:!0}],$scope.continentsList=[],$scope.continentIdlist=[],$scope.continentNameslist=[],$scope.countriesAll=[{id:"defaultCountry",name:i18n.i18nString("countrySelected"),checked:!0}],$scope.countriesLists=[],$scope.statesLists=[],$scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!0}],_.forEach($scope.continentList,function(v,k){$scope.continentsList.push({id:k,name:v,checked:!0})}),_.forEach($scope.continentList,function(v,k){$scope.continentIdlist.push(k),$scope.continentNameslist.push(v)}),_.forEach($scope.continentList,function(v,k){$scope.earlierContinentIds.push(k),$scope.earlierContinentNames.push(v)}),$element.on("click",".dropdown-menu input, .dropdown-menu label",function(e){e.stopPropagation()}))),component.entityType,fetchComponentDetails()),res.data&&res.data.ivrOptions&&($scope.nodeInfo.nodeInfo.ivrOptions=res.data.ivrOptions,_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.properties&&($scope.vxmlGlobalCopyKeys=_.pluck(_selectedStream.ivrSettings.properties||[],"name")),_selectedStream&&_selectedStream.audioCodesSettings&&($scope.vxmlGlobalCopyKeys=$scope.vxmlGlobalCopyKeys.concat(_.pluck(_selectedStream.audioCodesSettings.properties||[],"name"))),$scope.vxmlNodeKeys=_.pluck($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties||[],"name"),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys))),"service"===res.data.type&&$scope.reqDefCb.onServiceSave(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId),"process"===res.data.type&&(mapSelectedProcess(res.data),mapContextValues(res.data)),$scope.dialogData("updateComponent",res&&res.data),className&&finishSaving(className),res.data.utterances=JSON.parse(JSON.stringify($scope.utterancesCopy)),$scope.nodeInfo.nodeInfo=res.data,prepareIVRData(),$scope.component=$scope.nodeInfo.nodeInfo,$scope.nodeInfo.nodeInfo&&$scope.nodeInfo.nodeInfo.webhookTimeout&&$scope.sdkConfiguration&&($scope.sdkConfiguration.webhookTimeout=$scope.nodeInfo.nodeInfo.webhookTimeout),initListOfValues(),lookupInfo&&(lookupInfo.getLookup&&$scope.nodeInfo.nodeInfo.lookupId&&($scope.lookupId=$scope.nodeInfo.nodeInfo.lookupId,getLookupJson()),NotificationService.notify(lookupInfo.message,"success"),$scope.isWorkProgress=!1),void 0!==label&&NotificationService.notify(label+" "+msg+i18n.i18nString("successfully"),"success")},function(error){if($scope.intentName=$scope.nodeInfo.dialogNodeInstance.name,$scope.dialogData("updateComponent",$scope.component),$scope.nodeInfo.nodeInfo=$scope.component,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("save_currcomponent"),"error");finishSaving(className,"error"),$scope.isWorkProgress=!1})}function getCityAdvText(selectedArr){var MAX=3,len=selectedArr.length,remaining=len-MAX;return len?MAX>=len?1===len?selectedArr[0]:2===len?selectedArr[0]+" & "+selectedArr[1]:len===MAX?selectedArr.slice(0,MAX-1).join(", ")+" & "+selectedArr[MAX-1]:void 0:selectedArr.slice(0,MAX).join(", ")+" & "+remaining+" other"+(1!==remaining?"s":""):"None"}function saveEntityNodeType(){for(i=0;i<$scope._constants_.entityNlp.length;i++)("quantity"===$scope._constants_.entityNlp[i].value||"from_number"===$scope._constants_.entityNlp[i].value||"to_number"===$scope._constants_.entityNlp[i].value||"currency"===$scope._constants_.entityNlp[i].value)&&($scope._constants_.entityNlp[i].isDepricated=!0);$scope.saveEntityNodeType()}function checkForDuplicates(patterns,pattern){return patterns.indexOf(pattern)}function updateSmartalert(data){$scope.requestServiceData=data,$scope.nodeInfo.nodeInfo.requestServiceData=data}function updateAlertRef(data){$scope.nodeInfo.nodeInfo.alertRef=data;
}function updateNotification(data){$scope.nodeInfo.nodeInfo.alertRef.notificationType=data}function saveSmartAlertSubscriptionComponent(data){$scope.dialogData("updateComponent",data)}function findValueByPrefix(object,prefix){for(var property in object)if(object.hasOwnProperty(property)&&property.toString().startsWith(prefix))return object[property]}function savePostContextMap(){startSaving(".contextMapPostassignmentsSettings");var _postContextMapStr={};$scope.postContextMap&&($.each($scope.postContextMap.subIntentEntities,function(k,keyVal){keyVal.key&&(_postContextMapStr["context.entities."+keyVal.key]=keyVal.val)}),$.each($scope.postContextMap.remainingKeys,function(k,keyVal){keyVal.key&&(_postContextMapStr[keyVal.key]=keyVal.val)}));var _payload={postContextMap:JSON.stringify(_postContextMapStr)};BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,_payload).then(function(res){$scope.dialogData("updateDialog",res&&res.data),finishSaving(".contextMapPostassignmentsSettings")},function(error){if(finishSaving(".contextMapPostassignmentsSettings","error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function saveContextMap(){startSaving(".contextMapSettings");var _contextMapStr={};$scope.contextMap&&($.each($scope.contextMap.subIntentEntities,function(k,keyVal){keyVal.key&&(_contextMapStr["context.entities."+keyVal.key]=keyVal.val)}),$.each($scope.contextMap.remainingKeys,function(k,keyVal){keyVal.key&&(_contextMapStr[keyVal.key]=keyVal.val)}));var _payload={contextMap:JSON.stringify(_contextMapStr)};BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,_payload).then(function(res){$scope.dialogData("updateDialog",res&&res.data),finishSaving(".contextMapSettings")},function(error){if(finishSaving(".contextMapSettings","error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function getLookupJson(){BTFlowtaskService.getLookupJson($applicationService.userInfo().userId,$scope.lookupId).then(function(res){$scope.lookup.jsonData=res.data.map(function(data){data.title=data.title.replace(/&lt;/gi,"<").replace(/&gt;/gi,">"),data.value=data.value.replace(/&lt;/gi,"<").replace(/&gt;/gi,">");for(var i=0;i<data.synonyms.length;i++)data.synonyms[i]=data.synonyms[i].replace(/&lt;/gi,"<").replace(/&gt;/gi,">");return data}),savedLookupData=$workflowService.cloneData($scope.lookup.jsonData),$scope.updateJsonData()},function(error){var msg=error.errors?error.errors[0].msg:i18n.i18nString("fetch_lookup");NotificationService.notify(msg,"error")})}function toggleUtteranceIcons(type,index){"show"===type?$element.find(".deleteUtteranceIcon"+index).addClass("hideIcon"):setTimeout(function(){$element.find(".deleteUtteranceIcon"+index).removeClass("hideIcon")},3200)}function focusElement(className){$timeout(function(){$element.find(className).show().focus()},200)}function sortableCallback(e,ui){$scope.paginationOptions.currentPage>1&&(ui.item.sortable.index=($scope.paginationOptions.currentPage-1)*$scope.paginationOptions.itemsPerPage+ui.item.sortable.index,ui.item.sortable.dropindex=($scope.paginationOptions.currentPage-1)*$scope.paginationOptions.itemsPerPage+ui.item.sortable.dropindex)}function togglePromptsIcons(type,index,category){category=category||"","show"===type?$element.find(".deletePromptIcon"+category+index).addClass("hideIcon"):setTimeout(function(){$element.find(".deletePromptIcon"+category+index).removeClass("hideIcon")},3200)}function toggleSubmitsIcons(type,index,category){category=category||"","show"===type?$element.find(".deleteSubmittIcon"+category+index).addClass("hideIcon"):setTimeout(function(){$element.find(".deleteSubmitIcon"+category+index).removeClass("hideIcon")},3200)}function toggleErrorPromptsIcons(type,index,category){category=category||"","show"===type?$element.find(".deleteErrorPromptIcon"+category+index).addClass("hideIcon"):setTimeout(function(){$element.find(".deleteErrorPromptIcon"+category+index).removeClass("hideIcon")},3200)}function createErrorPrompt(index){""!==$scope.newErrorPrompt.text&&(startSaving(".submitPromptSaveIcon"),saveErrorPromptMessages($scope.userErrorPromptsCopy,index,!1))}function createSubmitPrompt(index){""!==$scope.newSubmitPrompt.text&&(startSaving(".submitPromptSaveIcon"),saveSubmitPromptMessages($scope.submitMessagesCopy,index,!1,!0))}function createCategoryPrompt(index,category){var filterObj=$scope.multiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.newPrompt.text&&(startSaving(".defaultPromptSaveIcon"+category),saveUserCategoryPromptMessages(filterObj.message,index,!1,category,filterObj))}function createCategoryErrorPrompt(index,category){var filterObj=$scope.multiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.newErrorPrompt.text&&(startSaving(".defaultErrorPromptSaveIcon"+category),saveCategoryErrorPromptMessages(filterObj.errorMessage,index,!1,category,filterObj))}function saveCategoryErrorPromptMessages(messages,index,_isFromDelete,category,filterObj){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS(filterObj.newErrorPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var _currCategoryPrompts=$workflowService.cloneData($scope.multiCategoryPromptsCopy),tempCopyObj=_currCategoryPrompts.filter(function(e){return e.category==category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.errorMessage=_tempMessage,_currCategoryPrompts.forEach(function(categ){delete categ.newPrompt,delete categ.newErrorPrompt});var payload={name:$scope.nodeInfo.nodeInfo.name,multiCategoryPrompts:_currCategoryPrompts};BTFlowtaskService.updateComponent($scope.component.streamId,$scope.nodeInfo.nodeInfo._id,payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId),$scope.nodeInfo.nodeInfo.multiCategoryPrompts=$workflowService.cloneData(_currCategoryPrompts),-1===index?(finishSaving(".defaultErrorPromptSaveIcon"+category),setTimeout(function(){NotificationService.notify(i18n.i18nString("prompt_update"),"success")},500)):(finishSaving(".errorPromptSaveSpin"+category+index),toggleErrorPromptsIcons("hide",index),_isFromDelete?($scope.nodeInfo.nodeInfo.errorMessage.splice(index,1),NotificationService.notify(i18n.i18nString("error_prompt_success"),"success")):NotificationService.notify(i18n.i18nString("error_prompt_update"),"success")),$.each($scope.nodeInfo.nodeInfo.multiCategoryPrompts,function(k,cat){var filterObj=res.data.multiCategoryPrompts.filter(function(e){return e.category==cat.category});filterObj=filterObj[0]||[],cat.message.forEach(function(msg,index){msg._id=filterObj.message[index]}),cat.errorMessage.forEach(function(msg,index){msg._id=filterObj.errorMessage[index]})}),res.data.multiCategoryPrompts=$scope.nodeInfo.nodeInfo.multiCategoryPrompts,loadMultiCategoryComponents(),$scope.dialogData("updateComponent",res.data))},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?NotificationService.notify(_isFromDelete?i18n.i18nString("promptdeletion_failed"):i18n.i18nString("update_failed"),"error"):NotificationService.notify(i18n.i18nString("error_prompt_failed"),"error");-1===index?finishSaving(".defaultErrorPromptSaveIcon","error"):(finishSaving(".errorPromptSaveSpin"+index,"error"),toggleErrorPromptsIcons("hide",index))})}function saveUserCategoryPromptMessages(messages,index,_isFromDelete,category,filterObj){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS(filterObj.newPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var _currCategoryPrompts=$workflowService.cloneData($scope.multiCategoryPromptsCopy),tempCopyObj=_currCategoryPrompts.filter(function(e){return e.category==category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.message=_tempMessage,_currCategoryPrompts.forEach(function(categ){delete categ.newPrompt,delete categ.newErrorPrompt});var payload={name:$scope.nodeInfo.nodeInfo.name,multiCategoryPrompts:_currCategoryPrompts};BTFlowtaskService.updateComponent($scope.component.streamId,$scope.nodeInfo.nodeInfo._id,payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId),$scope.nodeInfo.nodeInfo.multiCategoryPrompts=$workflowService.cloneData(_currCategoryPrompts),-1===index?(finishSaving(".defaultPromptSaveIcon"+category),setTimeout(function(){NotificationService.notify(i18n.i18nString("prompt_update"),"success")},500)):(finishSaving(".promptSaveSpin"+category+index),togglePromptsIcons("hide",index),_isFromDelete?NotificationService.notify(i18n.i18nString("prompt_deleted"),"success"):NotificationService.notify(i18n.i18nString("prompt_update"),"success")),$.each($scope.nodeInfo.nodeInfo.multiCategoryPrompts,function(k,cat){var filterObj=res.data.multiCategoryPrompts.filter(function(e){return e.category==cat.category});filterObj=filterObj[0]||[],cat.message.forEach(function(msg,index){msg._id=filterObj.message[index]}),cat.errorMessage.forEach(function(msg,index){msg._id=filterObj.errorMessage[index]})}),res.data.multiCategoryPrompts=$workflowService.cloneData($scope.nodeInfo.nodeInfo.multiCategoryPrompts),$scope.dialogData("updateComponent",res.data),loadMultiCategoryComponents())},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(_isFromDelete?i18n.i18nString("bot_res_deletion"):i18n.i18nString("bot_res_update"),"error"):NotificationService.notify(_isFromDelete?i18n.i18nString("prompt_deletion"):i18n.i18nString("prompt_failed"),"error"):"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(i18n.i18nString("bot_res_creation_failed"),"error"):NotificationService.notify(i18n.i18nString("prompt_creation_failed"),"error");-1===index?finishSaving(".defaultPromptSaveIcon","error"):(finishSaving(".promptSaveSpin"+index,"error"),togglePromptsIcons("hide",index))})}function createPrompt(index){""!==$scope.newPrompt.text&&(startSaving(".defaultPromptSaveIcon"),saveUserPromptMessages($scope.userPromptsCopy,index,!1))}function encodeJS(_obj){return encodeURIComponent(_obj)}function saveUserPromptMessages(messages,index,_isFromDelete){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS($scope.newPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var payload={name:$scope.nodeInfo.nodeInfo.name,message:_tempMessage};BTFlowtaskService.updateComponent($scope.component.streamId,$scope.nodeInfo.nodeInfo._id,payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId),-1===index?(finishSaving(".defaultPromptSaveIcon"),setTimeout(function(){$scope.userPromptsCopy.push(JSON.parse(JSON.stringify($scope.newPrompt))),$.each($scope.userPromptsCopy,function(k,message){message._id=res.data.message[k]}),res.data.message=$workflowService.cloneData($scope.userPromptsCopy),res.data.message.forEach(function(msg){msg.text=encodeJS(msg.text)}),$scope.nodeInfo.nodeInfo.message=$workflowService.cloneData(res.data.message),$scope.dialogData("updateComponent",res.data),$scope.newPrompt.text="",NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("prompt_update"),"success")},500)):(finishSaving(".promptSaveSpin"+index),togglePromptsIcons("hide",index),_isFromDelete?($scope.userPromptsCopy.splice(index,1),NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_deleted"):i18n.i18nString("prompt_deleted"),"success")):NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("prompt_update"),"success"),res.data.message=$workflowService.cloneData($scope.userPromptsCopy),res.data.message.forEach(function(msg){msg.text=encodeJS(msg.text)}),$scope.nodeInfo.nodeInfo.message=$workflowService.cloneData(res.data.message),$scope.dialogData("updateComponent",res.data)))},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(_isFromDelete?i18n.i18nString("bot_res_deletion"):i18n.i18nString("bot_res_update"),"error"):NotificationService.notify(_isFromDelete?i18n.i18nString("prompt_deletion"):i18n.i18nString("prompt_failed"),"error"):"message"===$scope.nodeInfo.nodeInfo.type?NotificationService.notify(i18n.i18nString("bot_res_creation_failed"),"error"):NotificationService.notify(i18n.i18nString("prompt_creation_failed"),"error");-1===index?finishSaving(".defaultPromptSaveIcon","error"):(finishSaving(".promptSaveSpin"+index,"error"),togglePromptsIcons("hide",index))})}function saveErrorPromptMessages(messages,index,_isFromDelete){var _tempMessage=[];if(messages&&messages.length>0&&($.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),console.log(_tempMessage)),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS($scope.newErrorPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var payload={name:$scope.nodeInfo.nodeInfo.name,errorMessage:_tempMessage};BTFlowtaskService.updateComponent($scope.component.streamId,$scope.nodeInfo.nodeInfo._id,payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId),-1===index?(finishSaving(".defaultErrorPromptSaveIcon"),setTimeout(function(){$scope.userErrorPromptsCopy.push(JSON.parse(JSON.stringify($scope.newErrorPrompt))),$.each($scope.userErrorPromptsCopy,function(k,message){message._id=res.data.errorMessage[k]}),res.data.errorMessage=$workflowService.cloneData($scope.userErrorPromptsCopy),res.data.errorMessage.forEach(function(msg){msg.text=encodeJS(msg.text)}),$scope.nodeInfo.nodeInfo.errorMessage=$workflowService.cloneData(res.data.errorMessage),$scope.dialogData("updateComponent",res.data),$scope.newErrorPrompt.text="",NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("prompt_update"),"success")},500)):(finishSaving(".errorPromptSaveSpin"+index),toggleErrorPromptsIcons("hide",index),_isFromDelete?($scope.userErrorPromptsCopy.splice(index,1),NotificationService.notify(i18n.i18nString("error_prompt_success"),"success")):NotificationService.notify(i18n.i18nString("error_prompt_update"),"success"),res.data.errorMessage=$workflowService.cloneData($scope.userErrorPromptsCopy),res.data.errorMessage.forEach(function(msg){msg.text=encodeJS(msg.text)}),$scope.nodeInfo.nodeInfo.errorMessage=$workflowService.cloneData(res.data.errorMessage),$scope.dialogData("updateComponent",res.data)))},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?NotificationService.notify(_isFromDelete?i18n.i18nString("promptdeletion_failed"):i18n.i18nString("update_failed"),"error"):NotificationService.notify(i18n.i18nString("error_prompt_failed"),"error");-1===index?finishSaving(".defaultErrorPromptSaveIcon","error"):(finishSaving(".errorPromptSaveSpin"+index,"error"),toggleErrorPromptsIcons("hide",index))})}function saveSubmitPromptMessages(messages,index,_isFromDelete,create){var _tempMessage=[];if(messages&&messages.length>0&&$.each(messages,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebook"===_tempMessageObject.channel||"Workplace For Groups"===_tempMessageObject.channel||"Workplace For Chat"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),-1===index){var _tempMessageObject={channel:"default",text:encodeJS($scope.newSubmitPrompt.text),type:"basic",_id:""};_tempMessage.push(_tempMessageObject)}var payload={name:$scope.nodeInfo.nodeInfo.name,submitMessage:_tempMessage};BTFlowtaskService.updateComponent($scope.component.streamId,$scope.nodeInfo.nodeInfo._id,payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),create&&$timeout(function(){finishSaving(".submitPromptSaveIcon")},500),addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId),-1===index?(finishSaving(".submitPromptSaveSpin"+index),finishSaving(".submitPromptSaveSpin"),setTimeout(function(){$scope.submitMessagesCopy.push(JSON.parse(JSON.stringify($scope.newSubmitPrompt))),$.each($scope.submitMessagesCopy,function(k,message){message._id=res.data.submitMessage[k]}),res.data.submitMessage=$workflowService.cloneData($scope.submitMessagesCopy),res.data.submitMessage.forEach(function(msg){msg.text=encodeJS(msg.text)}),$scope.nodeInfo.nodeInfo.submitMessage=$workflowService.cloneData(res.data.submitMessage),$scope.dialogData("updateComponent",res.data),$scope.newSubmitPrompt.text="",NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_res_updated"):i18n.i18nString("submit_update"),"success")},500)):(finishSaving(".submitPromptSaveIcon"+index),finishSaving(".submitPromptSaveIcon"),toggleSubmitsIcons("hide",index),_isFromDelete?($scope.submitMessagesCopy.splice(index,1),NotificationService.notify(i18n.i18nString("submit_deleted"),"success")):NotificationService.notify(i18n.i18nString("submit_update"),"success"),res.data.submitMessage=$workflowService.cloneData($scope.submitMessagesCopy),res.data.submitMessage.forEach(function(msg){msg.text=encodeJS(msg.text)}),$scope.nodeInfo.nodeInfo.submitMessage=$workflowService.cloneData(res.data.submitMessage),$scope.dialogData("updateComponent",res.data)))},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else-1!==index?NotificationService.notify(_isFromDelete?i18n.i18nString("promptdeletion_failed"):i18n.i18nString("update_failed"),"error"):NotificationService.notify(i18n.i18nString("error_submit_failed"),"error");-1===index?finishSaving(".submitPromptSaveIcon","error"):(finishSaving(".submitPromptSaveSpin"+index,"error"),toggleErrorPromptsIcons("hide",index))}),setTimeout(function(){$(".accordion-toggle").click(function(event){$(".tab-content").animate({scrollTop:event.currentTarget.offsetTop-300},1e3)})},2e3)}function saveIVRMaxNo(subopt){if($scope.nodeInfo.dialogInfo&&$scope.nodeInfo.dialogInfo.dialogId&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.uId){subopt||($scope.maxRetry.ref="");var classname=".behaviour_retires";startSaving(classname);var _params=$scope.maxRetry;_params&&"invokeCallTerminationHandler"===_params.action&&(_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.callTerminationHandler?_params.ref=_selectedStream.ivrSettings.callTerminationHandler:_params.ref=""),_params.ref||(_params.ref="");var _nodeOptions=angular.extend($scope.nodeInfo.dialogNodeInstance.nodeOptions,{eventOptions:{maxRetry:_params}}),_updateParams={nodeOptions:_nodeOptions};BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,_updateParams).then(function(res){$scope.dialogData("updateDialog",res&&res.data),finishSaving(classname)},function(error){if(finishSaving(classname,"error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}function processUIHeaders(headers){var _headers=[],headerObj={};try{headerObj=JSON.parse(headers.value)}catch(e){headerObj={}}Object.keys(headerObj).length&&Object.keys(headerObj).forEach(function(key){_headers.push({key:key,value:headerObj[key]})});return _headers}function saveToServer(_payload,silent,triggerTest){silent||($scope.saveInProgress=!0),BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),$scope.dialogData("updateComponent",res.data),"edit"===$scope.nodeInfo.displayMode&&($scope.component=res.data,$scope.nodeInfo.nodeInfo=$scope.component),triggerTest&&$scope.checkIdpAndExecuteAPI()),$scope.saveInProgress=!1,$scope.testInProgress=!1},function(){$scope.saveInProgress=!1,$scope.testInProgress=!1})}function idpTestListenersRegistration(callTestRequest){$scope.btTestFormApi.afterInit=function(){console.info("idp test afterInit callback is called"),$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(){console.info("idp test afterTest callback is called"),console.info($scope.btTestStatus),$timeout(function(){callTestRequest()},2e3)},$scope.btTestFormApi.afterClose=function(){console.info("idp test afterClose callback is called"),$scope.testInProgress=!1},$scope.btTestFormApi.onError=function(){console.error("idp test onError callback is called"),console.log($scope.btTestStatus),$scope.testInProgress=!1},$scope.btTestFormApi.onCancel=function(){console.warn("idp test onCancel callback is called"),console.log($scope.btTestStatus),$scope.testInProgress=!1},$scope.btTestFormApi.onNewAccounts=function(accounts){$scope.accounts=accounts},$scope.btTestFormApi.onAuthTestModalOpen=function(){$(".listOfValMain").addClass("modalSmall")},$scope.btTestFormApi.onAuthTestModalClose=function(){$(".listOfValMain").removeClass("modalSmall"),$scope.testInProgress=!1}}function deProcessUIHeaders(headers){var headerObj={};headers&&headers.length&&headers.forEach(function(header){header.key&&header.value&&(headerObj[header.key]=header.value)});return headerObj}function deProcessUIEndPoint(url,method){var uriParser=window.URI,components=uriParser.parse(url),endPoint={host:components.host,port:components.port?components.port+"":"",path:components.path,protocol:components.scheme,method:method};return endPoint.path+=components.query?"?"+components.query:"",endPoint.path+=components.fragment?"#"+components.query:"",endPoint}function testRequest(){$scope.testInProgress=!0;var _executePayload=deProcessUIHeaders($scope.props.contextParams),_idpName=$scope.newAuth&&$scope.newAuth.selected&&$scope.newAuth.selected.name;_idpName&&"none"!==_idpName.toLowerCase()&&"oauth2_client_credential"!==$scope.newAuth.selected.sso_type&&$scope.accounts.length&&(_executePayload["context.accountidtouse"]=$scope.accounts[0].streamAccountId),_executePayload=generateObjectByPath(_executePayload),BTFlowtaskService.executeComponent($scope.stream._id,$scope.component._id,_executePayload).then(function(res){$scope.lookupRemote.jsonData=res.data,$scope.statusCode=res.data.statusCode,$scope.testInProgress=!1,$("#triggerResponse").trigger("click")},function(res){var err=res.data;err&&err.errors&&err.errors[0].msg||i18n.i18nString("some_error");$scope.statusCode=err.errors[0].code,$scope.testInProgress=!1;var parsedErrObj={};try{parsedErrObj=JSON.parse(err.errors[0].msg)}catch(e){parsedErrObj=err.errors[0].msg||{errors:[{msg:i18n.i18nString("unknown"),code:"Unknown"}]}}$scope.lookupRemote.jsonData=parsedErrObj})}function generateObjectByPath(_obj){var _returnObj={};return Object.keys(_obj).forEach(function(key){var _arrayPath,_originalKey,_parsedData,_arrayStartIndex=key.indexOf("[");if(_arrayStartIndex>-1){_arrayPath=key.substring(_arrayStartIndex,key.length),_originalKey=$workflowService.cloneData(key);try{_parsedData=JSON.parse(_obj[_originalKey])}catch(e){NotificationService.notify(i18n.i18nString("valid_array"),"error")}key=key.substring(0,_arrayStartIndex)}var _tempObj={};key.split(".").reverse().forEach(function(_parsedKey){var _t={};_t[_parsedKey]=Object.keys(_tempObj).length?_tempObj:_arrayStartIndex>-1?_parsedData:_obj[key],_tempObj=_t}),angular.merge(_returnObj,_tempObj)}),_returnObj}function arrayToKeyValueArray(_arr){var contextArr=[];_arr.forEach(function(key){contextArr.push({key:key,value:""})});return contextArr}function getContextParams(){var _params=[],rawStr=($scope.props&&$scope.props.headers&&$scope.props.headers.length&&$scope.props.headers.forEach(function(header){header&&header.value&&addToArray(getTemplateTokens(header.value),_params)}),$scope.props&&$scope.props.params&&$scope.props.params.length&&$scope.props.params.forEach(function(header){header&&header.value&&addToArray(getTemplateTokens(header.value),_params)}),JSON.stringify($scope.props.rawParams));return addToArray(getTemplateTokens(rawStr),_params),$scope.props&&$scope.props.endPoint&&$scope.props.endPoint.requestUrl&&(addToArray(getTemplateTokens($scope.props.endPoint.requestUrl),_params),_params=_.uniq(_params)),_params}function addToArray(data,array){return data&&data.length&&array.push.apply(array,data),array}function getTemplateTokens(str){if(str&&"string"==typeof str){var matchArr=str.match(/{{\s*[\w\.\[\]]+\s*}}/g);return matchArr&&matchArr.length?matchArr.map(function(x){return x.match(/[\w\.\[\]]+/)[0]}):[]}return[]}function convertArrayToObject(array,cb){var obj={};array.forEach(function(elem){obj[elem.key]=elem.value}),cb(obj)}function prepareGroupIntentIvrProperties(){$scope.groupIntentIvrBridge={},$scope.groupIntenivrOptions=null,$scope.groupIntentIvrCb={},$scope.groupIntentIvrCb.openBotLevelIVR=openBotLevelIVR,$scope.groupIntentIvrCb.openChannelLevelTwilioVoice=openChannelLevelTwilioVoice,$scope.groupIntentIvrCb.openAudioCodesVoiceProp=openAudioCodesVoiceProp,$scope.groupIntentIvrCb.type="groupNodeIntent",$scope.groupIntentIvrCb.openIvr=!1,$scope.groupIntentIvrCb.call=$scope.saveIVR,$scope.enableIvrsettings()}$animate.enabled(!1),$scope.callback={},$scope.status={},$scope.status.piiDataEnabled="false",$scope.entityTypeValue="",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.defaultValue={},$scope.nlpPermission=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.nodeInfo.displayMode&&"VIEW"===$scope.nodeInfo.displayMode.toUpperCase()&&($scope.nlpPermission="VIEW",$workflowService.flowTaskDisplayMode($scope.nlpPermission)),$scope.rightClass="right500",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.deleteIcon=window.appConfig.CONTEXT_PATH+"/assets/icons-new/delete-trash/trash-red-delete.svg",$scope.isAllVoiceEnabled=!1,$scope.channelsConfig=channelsConfig,$scope.initialMessageCustomTag={},$scope._constants_=_.cloneDeep($rootScope._constants_),$scope.dialogTaskList=$workflowService.dialogTasks()||{};var _selectedLanguage=$workflowService.currentLanguage();$scope.currentLanguage=$workflowService.currentLanguage();var _selectedStream=$workflowService.cloneData($workflowService.selectedStream());$scope.selectedStreamState=$workflowService.selectedStreamState();var dualS;$workflowService.cloneData($workflowService.selectedStream());if($scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.allowNamespace=$workflowService.selectedStream().enableNameSpace,$scope.stream=_selectedStream,$scope.rightClass="right700",$scope.sampleResCB={},$scope.processTypeList=[{name:"Trigger",type:"trigger"},{name:"Send Bot response to Process App",type:"participate"}],$scope.typeList={trigger:"Trigger",participate:"Send Bot response to Process App"},$scope.processTypeContext={taskId:"",action:""},$scope.utteranceSearch={},$scope.andOrConditionSelected=!1,$scope.gSearchCb={},$scope.timeouts=[],$scope.instanceRetries=[],$scope.submitForm=!1,$scope.searching=!1,$scope.showAddPattern=!0,$scope.addUtterance=i18n.i18nString("add_utterances"),$scope.editUtterance=i18n.i18nString("edit_utterances"),$scope.elseif=i18n.i18nString("else_if"),$scope["if"]=i18n.i18nString("if"),$scope.affirmative_elseif=i18n.i18nString("affirmative_elseif"),$scope.affirmative_if=i18n.i18nString("affirmative_if"),$scope.negative_elsif=i18n.i18nString("negative_elseif"),$scope.negative_if=i18n.i18nString("negative_if"),$scope.add=i18n.i18nString("add_caps"),$scope.edit=i18n.i18nString("edit_caps"),$scope.viewError=i18n.i18nString("view_errors"),$scope.manageError=i18n.i18nString("manage_errors"),$scope["default"]=i18n.i18nString("default_lan"),
$scope.view=i18n.i18nString("view_caps"),$scope.manage=i18n.i18nString("manage_caps"),$scope.viewRequest=i18n.i18nString("view_request"),$scope.manageRequest=i18n.i18nString("edit_request"),$scope.viewScript=i18n.i18nString("view_script"),$scope.editScript=i18n.i18nString("edit_script"),$scope.savingproperty=i18n.i18nString("saving"),$scope.confirmproperty=i18n.i18nString("confirm"),$scope.testing=i18n.i18nString("testing_caps"),$scope.test=i18n.i18nString("test"),$scope.sampleRes=i18n.i18nString("sample_res"),$scope.enable=i18n.i18nString("Enable"),$scope.disable=i18n.i18nString("Disable"),$scope.manageDecode={submitMsg:!1,errorMsg:!1,usrPrompt:!1},$scope.intentContextVariableMap=[],$scope.manageResponseCB={},$scope.ivrResponses=i18n.i18nString("ivr_res"),$scope.initialPrompts=i18n.i18nString("initial_prompts"),$scope.addPlaintext=i18n.i18nString("add_plain_text"),$scope.provideLink=i18n.i18nString("initial_prompt_place"),$scope.addPlain=i18n.i18nString("add_plain"),$scope.providiinglink=i18n.i18nString("providelink"),$scope.customize=i18n.i18nString("customize"),$scope.add=i18n.i18nString("add"),$scope.trained=i18n.i18nString("trained"),$scope.training=i18n.i18nString("training_label"),$scope.train=i18n.i18nString("train"),$scope.trainStatus={success:!1,saving:!0,failed:!1},$scope.prop_panel_voice_channels_all_cb={},$scope["default"]={},$scope.showTrainBtn=!1,$scope.contentURL=window.appConfig.TMPLT_PRE_PATH+"js/forms/ml-utterance-module/ml-utterance-module-dialog.html",$scope.manageContext={preConditions:[],contextTags:[],autoEmitEntityValues:!1},$scope.manageGroupIntentContext={preConditions:[],contextTags:[],autoEmitEntityValues:!1},$scope.hideValues=["","dne"],$scope.redirectToLink=function(linkType){$rootScope.redirectToLink(linkType)},$scope.ob={},$scope.daasCallbackObj={},$scope.daasOptions={aceMode:"ace/mode/javascript",mode:"view"===$scope.displayMode?"tree":"code",ace:window.ace},$scope.process={},$scope.showGroupNodeManaeResponse=!1,$scope.ob.referencePatterns=[],$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.contextTags&&($scope.manageContext.contextTags=$scope.nodeInfo.dialogNodeInstance.nodeOptions.contextTags),$scope.nodeInfo&&$scope.nodeInfo.nodeInfo&&$scope.nodeInfo.nodeInfo.preConditions&&($scope.manageContext.preConditions=$scope.nodeInfo.nodeInfo.preConditions),$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&($scope.manageContext.autoEmitEntityValues=$scope.nodeInfo.dialogNodeInstance.nodeOptions.autoEmitEntityValues||$scope.manageContext.autoEmitEntityValues),$scope.currentIntent&&$scope.currentIntent.updateTrainData&&($scope.nodeInfo.nodeInfo.patterns=angular.copy($scope.currentIntent.patterns),$scope.nodeInfo.nodeInfo.traitRules=angular.copy($scope.currentIntent.traitRules),$scope.nodeInfo.nodeInfo.negativePatterns=angular.copy($scope.currentIntent.negativePatterns)),"process"===$scope.nodeInfo.nodeInfo.type&&$scope.processApps&&($scope.processAppList=$scope.processApps,$scope.nodeInfo.nodeInfo&&(mapSelectedProcess($scope.nodeInfo.nodeInfo),"trigger"===$scope.nodeInfo.nodeInfo.processType&&mapContextValues($scope.nodeInfo.nodeInfo),"participate"===$scope.nodeInfo.nodeInfo.processType&&mapParticipateContextValues($scope.nodeInfo.nodeInfo))),$scope.lovObj={isMultiLangDetectionEnabled:!1},$scope.defaultMessageObj={channel:"default",text:"",type:"basic"},$scope.groupNode&&prepareGroupIntnetNodeMessages(),$scope.modalSlider={},$scope.lookupRemote={},$scope.component=$scope.nodeInfo.nodeInfo,$scope.reqDefCb={},$scope.prop_panel_audio_codes_cb={},$scope.voice_channels_node_cb={},$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.hasOwnProperty("name")&&($scope.intentName=$scope.nodeInfo.dialogNodeInstance.name,$scope.nodeInfo.dialogNodeInstance.name||($scope.intentName=$scope.nodeInfo.nodeInfo.name)),$scope.saveIVR=function(data){console.log(data)},$scope.ivrSettingsDefault={ivrSettings:{asrConfidenceThreshold:{key:"confidenceLevel",value:0},extraction_key:"userinput",enable:!1,timeout:"30",enable_log:!0,retry_limit:"6",properties:[],enable_transcript:!1,transcript_tag:"",callTerminationHandler:"",bargein:!1,timeoutPrompts:[[{type:"text",value:""}]],nomatchPrompts:[[{type:"text",value:""}]],grammars:[]}},$scope.obj={confidenceConfig:[{mode:"lovEntity",isActive:!0,minThreshold:.6,definiteThreshold:.9}]},$scope.responseObj=[],$scope.accounts=[],$scope.sampleResponseIndex=0,$scope.manageTrainingCB={},$scope.component.sampleResponse)for(var z=0;i<$scope.component.sampleResponse.length;z++)if($scope.component.sampleResponse[z].isDefault){if($scope.sampleResponseIndex=z,$scope.lookupRemote.jsonData=$scope.component.sampleResponse[i].response,"string"==typeof $scope.lookupRemote.jsonData)try{$scope.lookupRemote.jsonData=JSON.parse($scope.lookupRemote.jsonData)}catch(e){$scope.lookupRemote.jsonData={}}break}$scope.convertToInt=function(id){return parseInt(id,10)};var dummy_traitAnd=[];$scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push($workflowService.cloneData(dummy_traitAnd)),$scope.urlValidation=!1,$scope.traitRules={},$scope.traitRules.traitMappings=$workflowService.cloneData($scope.nodeInfo.nodeInfo.traitRules)||[],_selectedStream.ivrSettings=_selectedStream.ivrSettings||$scope.ivrSettingsDefault.ivrSettings,$scope.isEnabled=_selectedStream.ivrSettings.enable||$scope.ivrSettingsDefault.ivrSettings.enable,_selectedStream&&_selectedStream.channels&&($scope.isTwilioEnabled=1==_selectedStream.channels.filter(function(val){return"twiliovoice"==val.type}).length,$scope.isAudioCodesEnabled=1==_selectedStream.channels.filter(function(val){return"audiocodes"==val.type}).length,$scope.isIVRVoiceEnabled=1==_selectedStream.channels.filter(function(val){return"ivrVoice"==val.type}).length);for(var t=1;10>=t;t++)$scope.timeouts[t]=1===t?t+" Minute":t+" Minutes";$scope.newAuth={},$scope.serviceTimeouts=[];for(var s=5;20>=s;s++)$scope.serviceTimeouts[s]=s+" Seconds";$scope.serviceTimeoutsAuth=[];for(var a=10;120>=a;a+=10)$scope.serviceTimeoutsAuth[a]=a+" Seconds";$scope.headingsList={showInstanceProperty:{show:!1,isOpen:!0,key:"instanceProperties"},showInstanceConnection:{show:!0,isOpen:!1,key:"connection"},showNodeProperty:{show:!0,isOpen:!1,key:"nodeProperties"},showIVRProperty:{show:!1,isOpen:!1,key:"ivrProperties"},showNLPProperty:{show:!1,isOpen:!1,key:"nlpProperties"},showHelp:{show:!0,isOpen:!1,key:"help"}},($scope.nodeInfo&&$scope.nodeInfo.nodeInfo&&"intent"===$scope.nodeInfo.nodeInfo.type||"entity"===$scope.nodeInfo.nodeInfo.type)&&($scope.headingsList.showNLPProperty.show=!0),$scope.copySDKClientID=function(){var copyText=document.getElementById("configInput");copyText.select(),document.execCommand("copy")},$scope.loadTags=function(query){return $timeout("!"==query[0]?function(){return $scope.cb.allTraits.negativeTraits.filter(function(traitName){return traitName.startsWith(query)})}:function(){return $filter("filter")($scope.cb.allTraits.traits,query)})},"manageComponents"==$scope.callBy?!$scope.runBot.fromDialogTask&&$scope.nodeInfo.nodeInfo.parentId?$scope.offsetValue=-210:$scope.offsetValue=-175:$scope.offsetValue=-190,$scope.transitionOptions={},$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionMode?$scope.transitionOptions.mode=$scope.nodeInfo.dialogNodeInstance.nodeOptions.transitionMode:$scope.transitionOptions.mode=i18n.i18nString("initiate_task"),$scope.synonymsObj={yes:[],no:[]},$scope.nodeInfo&&"dialogAct"===$scope.nodeInfo.dialogNodeInstance.type&&($scope.synonymsObj=$scope.nodeInfo.nodeInfo.synonyms||{yes:[],no:[]}),$scope.synonymsObj.yes=_constants_.getAlphabeticallySortedArray($scope.synonymsObj.yes),$scope.synonymsObj.no=_constants_.getAlphabeticallySortedArray($scope.synonymsObj.no),$scope.dialogTask=$workflowService.taskEditInfo(),$scope.synonymsSelect2Options={maxTagLength:128},$scope.patternSelect2Options={maxTagLength:2048},$scope.listOfValuesOptions={},$scope.listOfValuesOptions.display=!1,$scope.customContextValues=[],$scope.propertyNamespaceCb={},$scope.propertyNamespaceCb.flagName="propertyPanel",$scope.nodeInfo&&$scope.nodeInfo.nodeInfo&&($scope.propertyNamespaceCb.addedNamespaces=$scope.nodeInfo.nodeInfo.vNameSpace||[],$scope.propertyNamespaceCb.nodeInfoId=$scope.nodeInfo.nodeInfo._id,$scope.propertyNamespaceCb.state="published"!=$scope.nodeInfo.nodeInfo.status?"configured":"published",$scope.propertyNamespaceCb.propertyPanelNamespaceupdate=function(list){$scope.nodeInfo.nodeInfo.vNameSpace=list},$scope.propertyNamespaceCb.propertyPanelNamespaceRadioUpdate=function(flag){$scope.nodeInfo.nodeInfo.useTaskLevelNs=flag}),$scope.rad={manageVar:"use"},$scope.propertyNamespaceCb.selectCustRadio=function(radio){$scope.rad.manageVar=radio},$scope.nodeInfo&&$scope.nodeInfo.nodeInfo.useTaskLevelNs?$scope.rad.manageVar="use":$scope.nodeInfo&&$scope.nodeInfo.nodeInfo.hasOwnProperty("useTaskLevelNs")&&!$scope.nodeInfo.nodeInfo.useTaskLevelNs&&($scope.rad.manageVar="customize"),$scope.entityInstancePropertyCB={},$scope.flowtaskObj=$workflowService.flowtaskInfo()||{};var publishedAlerts=$workflowService.alertTasks();$scope.alerts=publishedAlerts.filter(function(alert){return"published"===alert.state}),$scope.assetsBase=env_conf["assets-url"],$scope.ivrAudio=$scope.assetsBase+"ivrIcons/ivr-audio.svg",$scope.ivrMove=$scope.assetsBase+"ivrIcons/ivr-move.svg",$scope.ivrJS=$scope.assetsBase+"ivrIcons/ivr-js.svg",$scope.ivrTextGreen=$scope.assetsBase+"ivrIcons/ivr-text.svg",$scope.ivrTextBlack=$scope.assetsBase+"ivrIcons/ivr-text-black.svg",$scope.ivrText=$scope.ivrTextGreen,$scope.ivrIcon=$scope.assetsBase+"ivrIcons/ivrIcon.svg",$scope.ivrIconGray=$scope.assetsBase+"ivrIcons/ivrIconGray.svg",$scope.nlpIcon=$scope.assetsBase+"propertyPanel/nl-green.svg",$scope.nlpIconGray=$scope.assetsBase+"propertyPanel/nl-gray.svg",$scope.rightArrow=$scope.assetsBase+"ivrIcons/rightArrow.svg",$scope.closeIcon=$scope.assetsBase+"ivrIcons/closeIcon.svg",$scope.trashIcon=$scope.assetsBase+"icons/trashIcon.svg",$scope.testArrowIcon=env_conf["context-url"]+"/assets/icons/testArrowIcon.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.closeIconDark=$scope.assetsBase+"icons/closeIconDark.svg",$scope.orIcon=$scope.assetsBase+"icons/orIcon.svg",$scope.minusCircle=$scope.assetsBase+"icons/minus-circle.svg",$scope.componentPropertyGray=$scope.assetsBase+"propertyPanel/componentPropertyGray.svg",$scope.componentPropertyGreen=$scope.assetsBase+"propertyPanel/componentPropertyGreen.svg",$scope.backArrowGreen=env_conf["context-url"]+"/assets/icons/caretRightGreen.svg",$scope.caretRightIcon=$scope.assetsBase+"/assets/icons-new/caret/caret-right.svg",$scope.connectionsGray=$scope.assetsBase+"propertyPanel/connectionsGray.svg",$scope.connectionsGreen=$scope.assetsBase+"propertyPanel/connectionsGreen.svg",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.instancePropertyGray=$scope.assetsBase+"/propertyPanel/instancePropertyGray.svg",$scope.instancePropertyGreen=$scope.assetsBase+"propertyPanel/instancePropertyGreen.svg",$scope.ivrGray=$scope.assetsBase+"propertyPanel/ivrGray.svg",$scope.IvrGreen=$scope.assetsBase+"propertyPanel/IvrGreen.svg",$scope.nlpIconGray=$scope.assetsBase+"propertyPanel/trainingGray.svg",$scope.nlpIconGreen=$scope.assetsBase+"propertyPanel/trainingGreen.svg",$scope.backArrow=env_conf["context-url"]+"/assets/icons-new/arrow/arrow-left-gray.svg",$scope.caretRightIcon=$scope.assetsBase+"icons-new/caret/caret-right.svg",$scope.warningIcon=env_conf["context-url"]+"/assets/icons-new/exclamation-triangle/exclamation-triangle-orange.svg",$scope.saveInprogress=!1,$scope.supportedLanguages=$workflowService.supportedLanguages(),$scope.languageList={},$scope.prompt={},$scope.isPiiEnabled=$workflowService.selectedStream().enable_pii,$.each($scope.supportedLanguages,function(i,language){$scope.languageList[language.value]=language.name}),$scope.IVRForm={},$scope.vprop={},$scope.entityRules={},$scope.vxmlCopy=[],$scope.errorPromptObj={errorPromptSequencing:!1},$scope.errorInstancePromptObj={errorPromptSequencing:!1},$scope.overrideListOfValuesOptions={},$scope.overrideListOfValuesOptions.display=!1,$scope.propertyPanelPatternCB={},$scope.prepareInstancePrompts=function(update){update||($scope.userInstancePromptOptions={override:!1},$scope.errorInstancePromptOptions={override:!1}),$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&($scope.userInstancePromptsCopy=$workflowService.cloneData($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.message)||[],$scope.userErrorInstancePromptsCopy=$workflowService.cloneData($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage)||[],$scope.newInstancePrompt={channel:"default",text:"",type:"basic",_id:""},$scope.newErrorInstancePrompt={channel:"default",text:"",type:"basic",_id:""},$scope.instanceMultiCategoryPromptsCopy=$scope.instanceMultiCategoryPromptsCopy||[],$scope.instanceMultiCategoryPromptsCopy&&!$scope.instanceMultiCategoryPromptsCopy.length&&($scope.instanceMultiCategoryPromptsCopy=[{category:"from",errorMessage:[],message:[]},{category:"to",errorMessage:[],message:[]}]),$scope.overrideMultiCategoryPrompts={from:{message:!1,errorMessage:!1},to:{message:!1,errorMessage:!1}},($scope.nodeInfo&&"entity"===$scope.nodeInfo.nodeInfo.type&&"list_of_values"===$scope.nodeInfo.nodeInfo.entityType||"dialogAct"===$scope.nodeInfo.nodeInfo.type)&&$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.hasOwnProperty("applyDefaultTemplate")&&($scope.overrideListOfValuesOptions.display=$scope.nodeInfo.dialogNodeInstance.nodeOptions.applyDefaultTemplate),loadMultiCategoryInstancePrompts(),loadErrorPromptSequencing(),decodeInstanceMessages())},$scope.cb.prepareInstancePrompts=$scope.prepareInstancePrompts,$scope.showDisplayListOfvaluesInstanceOptions=function(){return"entity"===$scope.nodeInfo.nodeInfo.type&&"list_of_values"===$scope.nodeInfo.nodeInfo.entityType?!0:"dialogAct"===$scope.nodeInfo.nodeInfo.type?!0:!1},$scope.saveListOfValuesInstanceOptionsChoice=function(){var payload={applyDefaultTemplate:$scope.overrideListOfValuesOptions.display};saveUserInstancePromptMessages($scope.userInstancePromptsCopy,"",!1,payload)},$scope.prepareInstancePrompts(),$scope.auto_grow_instance_prompts=function(e,index){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createInstancePrompt(index):$scope.saveEditInstancePrompts(index),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_error_instance_prompts=function(e,index){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createErrorInstancePrompt(index):$scope.saveEditErrorInstancePrompts(index),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_category_instance_prompts=function(e,index,category){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createCategoryInstancePrompt(index,category):$scope.saveCategoryEditInstancePrompts(index,category),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_error_category_instance_prompts=function(e,index,category){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createCategoryErrorInstancePrompt(index,category):$scope.saveCategoryEditErrorInstancePrompts(index,category),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.saveCategoryEditInstancePrompts=function(index,category,deleteAll){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.message[index].text?(togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryInstancePromptMessages(filterObj.message,index,!1,category,filterObj,deleteAll)):NotificationService.notify(i18n.i18nString("prompt_empty"),"error")},$scope.saveCategoryEditErrorInstancePrompts=function(index,category,deleteAll){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.errorMessage[index].text?(toggleErrorPromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorInstancePromptMessages(filterObj.errorMessage,index,!1,category,filterObj,deleteAll)):NotificationService.notify(i18n.i18nString("prompt_empty"),"error")},$scope.deleteEditCategoryInstancePrompts=function(index,type,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&filterObj.errorMessage[index]){var _standardPromptMessageCount=filterObj.errorMessage.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryInstancePromptMessages(filterObj.errorMessage,index,!0,category,filterObj);else{if("default"===filterObj.errorMessage[index].channel)return NotificationService.notify(i18n.i18nString("allchannel_msg"),"error"),!1;togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryInstancePromptMessages(filterObj.errorMessage,index,!0,category,filterObj)}}},{okText:i18n.i18nString("ok_label")})},$scope.deleteEditCategoryErrorInstancePrompts=function(index,type,category){var filterObj=$scope.instanceMultiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&filterObj.errorMessage[index]){var _standardPromptMessageCount=filterObj.errorMessage.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)toggleErrorIntancePromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorInstancePromptMessages(filterObj.errorMessage,index,!0,category,filterObj);else{if("default"===$scope.userErrorInstancePromptsCopy[index].channel)return NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("allchannel_res"):i18n.i18nString("allchannel_msg"),"error"),!1;toggleErrorPromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorInstancePromptMessages(filterObj.errorMessage,index,!0,category,filterObj)}}},{okText:i18n.i18nString("ok")})},$scope.auto_grow_error_instance_prompts=function(e,index){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createErrorInstancePrompt(index):$scope.saveEditErrorInstancePrompts(index),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.showInstancePromptSaveTip=function(index,category){category=category||"",$element.find(".promptSaveTip"+category+index)&&"block"!==$element.find(".promptSaveTip"+category+index)[0].style.display?$element.find(".promptSaveTip"+category+index).css("display","block"):$element.find(".promptSaveTip"+category+index).css("display","none")},$scope.showErrorInstancePromptSaveTip=function(index,category){category=category||"",$element.find(".errorPromptSaveTip"+category+index).length&&"block"!==$element.find(".errorPromptSaveTip"+category+index)[0].style.display?$element.find(".errorPromptSaveTip"+category+index).css("display","block"):$element.find(".errorPromptSaveTip"+category+index).length&&$element.find(".errorPromptSaveTip"+category+index).css("display","none")},$scope.saveEditErrorInstancePrompts=function(index){""!==$scope.userErrorInstancePromptsCopy[index].text?(toggleErrorInstancePromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorInstancePromptMessages($scope.userErrorInstancePromptsCopy,index,!1)):NotificationService.notify(i18n.i18nString("errpr_prompt"),"error")},$scope.deleteEditErrorInstancePrompts=function(index){toggleErrorInstancePromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorInstancePromptMessages($scope.userErrorInstancePromptsCopy,index,!0)},$scope.saveEditInstancePrompts=function(index){""!==$scope.userInstancePromptsCopy[index].text?(toggleInstancePromptsIcons("show",index),startSaving(".promptSaveSpin"+index),saveUserInstancePromptMessages($scope.userInstancePromptsCopy,index,!1)):NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_prompt"):i18n.i18nString("prompt_empty"),"error")},$scope.deleteEditInstancePrompts=function(index){toggleInstancePromptsIcons("show",index),startSaving(".promptSaveSpin"+index),saveUserInstancePromptMessages($scope.userInstancePromptsCopy,index,!0)},$scope.reOrderInstanceChange=function(event){var payload={errorPromptSequencing:$scope.errorInstancePromptObj.errorPromptSequencing,instanceProperties:!0};$scope.entityInstancePropertyCB.updateNodeInfo(payload)},$scope.changePromptType=function(type,category){if("userCatgoryInstancePrompt"===type)if($scope.overrideMultiCategoryPrompts.from.message=$scope.overrideMultiCategoryPrompts[category].message,$scope.overrideMultiCategoryPrompts.to.message=$scope.overrideMultiCategoryPrompts[category].message,!$scope.overrideMultiCategoryPrompts[category].message&&$scope.instanceMultiCategoryPromptsCopy){var catgry=_.filter($scope.instanceMultiCategoryPromptsCopy,function(cat){return cat&&cat.message&&cat.message.length});catgry&&catgry.length&&catgry[0].message&&catgry[0].message.length?NotificationService.userConfirm(i18n.i18nString("switch_mesage_override_notify"),[function(){saveUserCategoryInstancePromptMessages([],-1,!0,category,null,"message")},function(){$scope.overrideMultiCategoryPrompts.from.message=!0,$scope.overrideMultiCategoryPrompts.to.message=!0}],{okText:i18n.i18nString("confirm"),btnClass:"btnPrimary"},"",void 0,i18n.i18nString("confirm_proceed")):$scope.instanceMultiCategoryPromptsCopy&&$scope.instanceMultiCategoryPromptsCopy.length||($scope.instanceMultiCategoryPromptsCopy=[{category:"from",errorMessage:[],message:[]},{category:"to",errorMessage:[],message:[]}])}else $scope.instanceMultiCategoryPromptsCopy&&$scope.instanceMultiCategoryPromptsCopy.length||($scope.instanceMultiCategoryPromptsCopy=[{category:"from",errorMessage:[],message:[]},{category:"to",errorMessage:[],message:[]}]);if("errorCatgoryInstancePrompt"===type)if($scope.overrideMultiCategoryPrompts.from.errorMessage=$scope.overrideMultiCategoryPrompts[category].errorMessage,$scope.overrideMultiCategoryPrompts.to.errorMessage=$scope.overrideMultiCategoryPrompts[category].errorMessage,!$scope.overrideMultiCategoryPrompts[category].errorMessage&&$scope.instanceMultiCategoryPromptsCopy&&$scope.instanceMultiCategoryPromptsCopy.length){var errCatgry=_.filter($scope.instanceMultiCategoryPromptsCopy,function(cat){return cat&&cat.errorMessage&&cat.errorMessage.length});errCatgry&&errCatgry.length&&errCatgry[0].errorMessage&&errCatgry[0].errorMessage.length?NotificationService.userConfirm(i18n.i18nString("switch_mesage_override_notify"),[function(){saveCategoryErrorInstancePromptMessages([],-1,!0,category,null,"errorMessage")},function(){$scope.overrideMultiCategoryPrompts.from.errorMessage=!0,$scope.overrideMultiCategoryPrompts.to.errorMessage=!0}],{okText:i18n.i18nString("confirm"),btnClass:"btnPrimary"},"",void 0,i18n.i18nString("confirm_proceed")):$scope.instanceMultiCategoryPromptsCopy&&$scope.instanceMultiCategoryPromptsCopy.length||($scope.instanceMultiCategoryPromptsCopy=[{category:"from",errorMessage:[],message:[]},{category:"to",errorMessage:[],message:[]}])}else $scope.instanceMultiCategoryPromptsCopy&&$scope.instanceMultiCategoryPromptsCopy.length||($scope.instanceMultiCategoryPromptsCopy=[{category:"from",errorMessage:[],message:[]},{category:"to",errorMessage:[],message:[]}]);"userPrompt"===type&&!$scope.userInstancePromptOptions.override&&$scope.userInstancePromptsCopy&&$scope.userInstancePromptsCopy.length&&NotificationService.userConfirm(i18n.i18nString("switch_mesage_override_notify"),[function(){saveUserInstancePromptMessages($scope.userInstancePromptsCopy,"",!1,null,!0)},function(){$scope.userInstancePromptOptions.override=!0}],{okText:i18n.i18nString("confirm"),btnClass:"btnPrimary"},"",void 0,i18n.i18nString("confirm_proceed")),"errorPrompt"===type&&!$scope.errorInstancePromptOptions.override&&$scope.userErrorInstancePromptsCopy&&$scope.userErrorInstancePromptsCopy.length&&NotificationService.userConfirm(i18n.i18nString("switch_mesage_override_notify"),[function(){saveErrorInstancePromptMessages($scope.userErrorInstancePromptsCopy,"",!1,null,!0)},function(){$scope.errorInstancePromptOptions.override=!0}],{okText:i18n.i18nString("confirm"),btnClass:"btnPrimary"},"",void 0,i18n.i18nString("confirm_proceed"))};var _defaultIVRProps=$scope.flowtaskApi.getIVRDefaults();_defaultIVRProps.grammars=[],$scope.ivrTimeouts=[];for(var i=1;60>=i;i++)$scope.ivrTimeouts[1e3*i]=i+(i>1?" secs":" sec");$scope.ivrRetries=[];for(var j=1;10>=j;j++)$scope.ivrRetries[j]=j;if("quantity"===$scope.nodeInfo.nodeInfo.entityType||"to_number"===$scope.nodeInfo.nodeInfo.entityType||"from_number"===$scope.nodeInfo.nodeInfo.entityType||"currency"===$scope.nodeInfo.nodeInfo.entityType)for(i=0;i<$scope._constants_.entityNlp.length;i++)$scope._constants_.entityNlp[i].value===$scope.nodeInfo.nodeInfo.entityType&&($scope._constants_.entityNlp[i].isDepricated=!1);var currentLanguage=$workflowService.currentLanguage()?$workflowService.currentLanguage():_selectedStream.defaultLanguage,errorMessages=$workflowService.seedData().entityErrorMessages[currentLanguage]||{};errorMessages.string&&(errorMessages.label=errorMessages.string),$scope.getNodes=function(currentNode){$scope.nodeList=[],angular.forEach($scope.nodeObjList,function(node,index){currentNode.name!==node.name&&$scope.nodeList.push({uId:node.uId,name:node.name})})},$scope.getTransitionNodes=function(nodeInfo){$scope.transitionNodes=[],angular.forEach($scope.nodeObjList,function(node,index){nodeInfo.nodeInfo.name!==node.name&&nodeInfo.dialogInfo.firstNodeId!==node.uId&&$scope.getIntentAllowed(node)&&$scope.transitionNodes.push({uId:node.uId,name:node.name})})},$scope.showAdvancedOptions=function(){$scope.modalSlider.open("#remoteModelAdvanced")},$scope.closeRequestModal=function(){$scope.modalSlider.close("#remoteModelAdvanced")},$scope.editgroupIntentContextMap=function(event,index){return event&&13==event.keyCode?!1:void 0},$scope.removegroupIntentContextMap=function(key){if($scope.nodeInfo.dialogNodeInstance.contextMap&&$scope.nodeInfo.dialogNodeInstance.contextMap.length){var deleteIndex=_.findIndex($scope.nodeInfo.dialogNodeInstance.contextMap,{key:key});deleteIndex>-1&&$scope.nodeInfo.dialogNodeInstance.contextMap.splice(deleteIndex,1)}},$scope.tripleSliderChanged=function(event){setTimeout(function(){var intentSlid=parseFloat($($("#triple-slider .noUi-handle")[0]).attr("aria-valuetext")),kgTask=parseFloat($($("#triple-slider .noUi-handle")[1]).attr("aria-valuetext"));onSliderChangedNew("#dual-sliders",[intentSlid,kgTask])},100)},$scope.addgroupIntentContextMap=function(event){if(event&&13==event.keyCode&&$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.newContextValue&&$scope.nodeInfo.dialogNodeInstance.newContextKey){$scope.nodeInfo.dialogNodeInstance.contextMap||($scope.nodeInfo.dialogNodeInstance.contextMap=[]);var checkForDup=_.find($scope.nodeInfo.dialogNodeInstance.contextMap,{key:$scope.nodeInfo.dialogNodeInstance.newContextKey});if(checkForDup&&checkForDup.key)return void NotificationService.notify('"'+($scope.nodeInfo.dialogNodeInstance.newContextKey+'" is already added'),"error");var _contextMap={key:$scope.nodeInfo.dialogNodeInstance.newContextKey,value:$scope.nodeInfo.dialogNodeInstance.newContextValue};$scope.nodeInfo.dialogNodeInstance.contextMap.push(_contextMap),$scope.nodeInfo.dialogNodeInstance.newContextKey="",$scope.nodeInfo.dialogNodeInstance.newContextValue="",$scope.focusContent("newContextKeyInput")}},$scope.focusContent=function(id){id&&$("#"+id).focus()},$scope.saveIvrProperties=function(){var ivrProperties=$scope.groupIntentIvrBridge.getIVROptions();$scope.nodeInfo.dialogNodeInstance.nodeOptions.ivrOptions=ivrProperties,ivrProperties&&ivrProperties.grammars&&delete ivrProperties.grammars,$scope.closeManageGroupResponse()},$scope.closeManageGroupResponse=function(){$scope.groupIntentResponseTypeEdit=null,$scope.modalSlider.close("#manageGroupResponse"),$scope.showGroupNodeManaeResponse=!1},$scope.onGrouupPromptSave=function(res){$scope.nodeInfo.dialogNodeInstance.nodeOptions.message=res,prepareGroupIntnetNodeMessages(res)},$scope.deleteGroupIntnetMessagePrompts=function(index){$scope.groupIntnetMessagePrompts&&$scope.groupIntnetMessagePrompts.length&&$scope.groupIntnetMessagePrompts.splice(index,1)},$scope.addNewGroupIntentMessage=function(event){if(event&&13==event.keyCode){var _tempMessageObject={channel:"default",text:$scope.defaultMessageObj.text,type:"basic"};_tempMessageObject.text&&($scope.groupIntnetMessagePrompts.push(_tempMessageObject),prepareGroupIntnetNodeMessages($scope.groupIntnetMessagePrompts),$scope.defaultMessageObj.text="")}},$scope.cb.prepareGroupIntnetNodeMessages=function(){prepareGroupIntnetNodeMessages($scope.groupIntnetMessagePrompts)},$scope.onGrouupPromptClose=function(res){$scope.nodeInfo.dialogNodeInstance.nodeOptions.message=res,prepareGroupIntnetNodeMessages()},$scope.openManageGroupResponse=function(index,type){$scope.groupIntentResponseTypeEdit=type,$scope.groupIntenivrOptions=null;try{$scope.groupIntenivrOptions=JSON.parse(JSON.stringify($scope.nodeInfo.dialogNodeInstance.nodeOptions.ivrOptions))}catch(e){$scope.groupIntenivrOptions=null}$scope.groupNodeMsgObj={messages:$scope.nodeInfo.dialogNodeInstance.nodeOptions.message||[],openIndex:0},index>-1&&($scope.groupNodeMsgObj.openIndex=index),$scope.showGroupNodeManaeResponse=!0,setTimeout(function(){$scope.modalSlider.open("#manageGroupResponse")},100)},$scope.maxRetry={action:"invokeCallTerminationHandler",ref:""};var _defaultMaxRetry={retry_limit:5,action:"endOfDialog"};$scope.defaultMaxRetry=$workflowService.cloneData(_defaultMaxRetry),$scope.prompt={promptOptions:"required"};for(var ii=1;5>=ii;ii++)$scope.instanceRetries[ii]=ii;$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&($scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions?($scope.maxRetry=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions.maxRetry?$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions.maxRetry:$scope.maxRetry),
$scope.defaultMaxRetry=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions.defaultMaxRetry?$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions.defaultMaxRetry:_defaultMaxRetry)):$scope.defaultMaxRetry=$workflowService.cloneData(_defaultMaxRetry),defaultValue.getDefaultOptionalValue()&&($scope.defaultValue.defaultOptionValue=defaultValue.getDefaultOptionalValue()[$scope.nodeInfo.dialogNodeInstance.uId]),defaultValue.getDefaultHiddenValue()&&($scope.defaultValue.defaultHiddenValue=defaultValue.getDefaultHiddenValue()[$scope.nodeInfo.dialogNodeInstance.uId]),$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&"prompt"==$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions?$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue&&($scope.defaultValue.defaultOptionValue=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue.text?$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue.text:$scope.defaultValue.defaultOptionValue)):$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&"optional"==$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue&&($scope.defaultValue.defaultHiddenValue=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue.text?$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue.text:$scope.defaultValue.defaultHiddenValue)),$scope.prompt.promptOptions=$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions?$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions:"required"),$scope.checkTermination=function(){"invokeCallTerminationHandler"==$scope.maxRetry.action&&setTimeout(function(){$("#calltermination").trigger("click")},300)},$scope.cb.updateUtterance=function(res){$scope.nodeInfo.nodeInfo.utterances=[],_.forEach(res.data.Sentences,function(eachUtterance){eachUtterance.sentence=decodePattern(eachUtterance.sentence),$scope.nodeInfo.nodeInfo.utterances.push(eachUtterance)}),$scope.utterancesCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.utterances),$scope.totalUtterancesCount=res.data.count},$scope.cb.updateSubmitMessages=function(res){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"form"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&($scope.submitMessagesCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.submitMessage))},$scope.cb.updateMessages=function(res){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&("entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"message"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"dialogact"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"service"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"form"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase())&&($scope.userPromptsCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.message))},$scope.cb.updateMulticategoryMessages=function(res){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&loadMultiCategoryComponents()},$scope.cb.updateEntityInstanceMessages=function(res){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&$scope.entityInstancePropertyCB.updateMessages(res)},$scope.cb.updateEntityInstanceMulticategoryMessages=function(res){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&$scope.entityInstancePropertyCB.updateMulticategoryMessages(res)},$scope.cb.updateEntityInstanceErrorMessages=function(res){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&$scope.entityInstancePropertyCB.updateErrorMessages(res)},$scope.saveConfirmationSynonyms=function(){startSaving(".instanceSynonyms"),setTimeout(function(){var _payload={synonyms:$scope.synonymsObj};updateComponent(_payload,".instanceSynonyms")},500)},$scope.cb.updateBotConfigurationData=function(res){$scope.botConfiguration=res},$scope.cb.updateErrorMessages=function(res){$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.type&&("entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()||"form"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase())&&($scope.userErrorPromptsCopy=$workflowService.cloneData($scope.nodeInfo.nodeInfo.errorMessage))},$scope.reOrderChange=function(event){updateComponent({errorPromptSequencing:$scope.errorPromptObj.errorPromptSequencing},".entityGeneralSettings")},"intent"===$scope.nodeInfo.dialogNodeInstance.type&&checkMLSyncStatus();var _isClosed=!1;$scope.cb.closePropertyPannel=function(){_selectedStream.sdkSubscription&&($workflowService.selectedStream().sdkSubscription=_selectedStream.sdkSubscription),_isClosed=!0,$scope.cancelUnsavedGrammar(),$scope.cb.closePropertyPanel()},$scope.cb.startPropertyPanelAnimate=function(section,actionArray){var highlight=!0;actionArray&&actionArray.length&&(highlight=!1);var _connectionHeading=$('.property-panel-cntnr [data-prop-section-id="'+section+'"]');highlight&&_connectionHeading.addClass("background-color-animation background-color-change"),$timeout(function(){highlight&&_connectionHeading.removeClass("background-color-change"),$timeout(function(){if(highlight&&!_connectionHeading.hasClass("background-color-change")&&_connectionHeading.removeClass("background-color-animation"),actionArray&&actionArray.length){var _delay=0;actionArray.forEach(function(action){_delay=(action.delay||0)+_delay;var _selector=$(action.CssSelector);if(action)switch(action.action){case"input-focus":$timeout(function(){_selector.focus(),_selector.select(),$scope.cb.loadingPropeertypanel=!1},_delay)}})}else $scope.cb.loadingPropeertypanel=!1},350)},350)},$scope.authCB=$scope.authCb,$scope.authCB.nodeInfo=$scope.nodeInfo,$scope.stream=$workflowService.selectedStream(),$scope.atMentionsData=[],$scope.dialogEntities&&$scope.dialogEntities.length&&$.each($scope.dialogEntities,function(i,entity){if("composite"!==entity.entityType&&"configured"===entity.status){var _object={label:entity.name};$scope.atMentionsData.push(_object)}}),$scope.tempDialogNodeInstConnObj=[],$scope.callAnotherDialog=null,$scope.hasUnsavedConnection=!1,$scope.isFirstNode=!1,$scope.isArrayAllowed=!0,$scope.selectcityAdv=!1,$scope.entitySelectionInProgress=!1,$scope.botConfiguration={enableTryoutMode:!1},$scope.ifOperatorList=[{name:i18n.i18nString("exists"),val:""},{name:i18n.i18nString("does_not_exists"),val:"dne"},{name:i18n.i18nString("if_operator_equal"),val:"eq"},{name:i18n.i18nString("if_operator_greater_equal"),val:"gte"},{name:i18n.i18nString("if_operator_less_equal"),val:"lte"},{name:i18n.i18nString("if_operator_not_equals"),val:"neq"},{name:i18n.i18nString("if_operator_greater"),val:"gt"},{name:i18n.i18nString("if_operator_less"),val:"lt"},{name:i18n.i18nString("contains"),val:"cnt"}],$scope.ifOperatorsFollowupIntents=$scope.flowtaskApi.getIfOperatorsFollowupIntents(),$scope.ifCondPrefixList=[{name:i18n.i18nString("configurable_entity_name"),val:"field"},{name:i18n.i18nString("context"),val:"context"},{name:i18n.i18nString("intent_label"),val:"intent"}],$scope.configurableElements={subDialog:{type:"subDialog",name:i18n.i18nString("dialog_caps")},entity:{type:"entity",name:i18n.i18nString("entity_caps")},form:{type:"entity",name:i18n.i18nString("form_caps")},logic:{type:"entity",name:i18n.i18nString("logic_caps")},script:{type:"script",name:i18n.i18nString("script_caps")},SDKWebHook:{type:"SDKWebHook",name:i18n.i18nString("webhook_caps")},agentTransfer:{type:"agentTransfer",name:i18n.i18nString("agent_transfer_caps")},service:{type:"service",name:i18n.i18nString("service_caps")},message:{type:"message",name:i18n.i18nString("bot_response")},dialogAct:{type:"dialogAct",name:i18n.i18nString("confirmation_caps")},intent:{type:"intent",name:i18n.i18nString("user_intent")},process:{type:"process",name:"PROCESS"},botAction:{type:"botAction",name:i18n.i18nString("configurable_botAction_name")}},$scope.icons={spark:env_conf["context-url"]+"/img/spark.svg",msteams:env_conf["context-url"]+"/img/microsoft-teams-icon.png",syniverse:env_conf["context-url"]+"/img/syniverse.png",rcengage:env_conf["context-url"]+"/img/ringCentralEngage.png",slack:env_conf["context-url"]+"/img/slack.svg",sms:env_conf["context-url"]+"/img/sms.svg",twilio:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",email:env_conf["context-url"]+"/img/email.svg",skype:"",facebook:env_conf["context-url"]+"/img/facebook.svg",websdk:env_conf["context-url"]+"/img/slack.svg",kore:env_conf["context-url"]+"/img/kore.svg",rtm:env_conf["context-url"]+"/img/web-mobile.svg",widgetsdk:env_conf["context-url"]+"/img/widgetsdk.svg",skypeOnPrem:env_conf["context-url"]+"/img/skypebusiness.svg",twitter:env_conf["context-url"]+"/img/twitter.svg",cisco:env_conf["context-url"]+"/img/cisco-tropo-icon.png",wfacebook:env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Groups":env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Chat":env_conf["context-url"]+"/img/fb-workplace-icon.png",ringcentral:env_conf["context-url"]+"/img/ringCentralIcon.png",skypeforbusiness:env_conf["context-url"]+"/img/skypebusiness.svg",jabber:env_conf["context-url"]+"/img/jabbericon.jpg",yammer:env_conf["context-url"]+"/img/yammericon.png",telegram:env_conf["context-url"]+"/img/telegram-logo.png",alexa:env_conf["context-url"]+"/img/amazonalexa.png",twiliovoice:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",line:env_conf["context-url"]+"/img/line-logo.png",ivr:env_conf["context-url"]+"/img/webhook.png",liveperson:env_conf["context-url"]+"/img/live-person.png",ivrVoice:env_conf["context-url"]+"/img/ivr-logo.png",wechat:env_conf["context-url"]+"/img/weChat.svg"},$scope.entityInstancePropertyCB.icons=$scope.icons,$scope.chooseUnitType=function(isManual){if($scope.nodeInfo.nodeInfo.unitType){var unitTypeObject=_.filter($scope._constants_.quantityTypes,{key:$scope.nodeInfo.nodeInfo.unitType});$scope.selectedUnitType=unitTypeObject&&unitTypeObject[0],isManual?($scope.nodeInfo.nodeInfo.defaultUnit=$scope.selectedUnitType.defaultValue,$scope.saveEntityNodeType()):$scope.nodeInfo.nodeInfo.defaultUnit=$scope.nodeInfo.nodeInfo.defaultUnit||$scope.selectedUnitType.defaultValue}},$scope.placeholder='<div class="ace_invisible ace_emptyMessage" style="margin-top: 20px;">[<div style="text-indent: 10px;">{</div><div style="text-indent: 20px;">"title":"United States",</div><div style="text-indent: 20px;">"value":"US",</div><div style="text-indent: 20px;">"synonyms":[</div><div style="text-indent: 30px;">"united states",</div><div style="text-indent: 30px;">"USA",</div><div style="text-indent: 30px;">"U.S.A",</div><div style="text-indent: 30px;">"America"</div><div style="text-indent: 20px;">]</div><div style="text-indent: 10px;">},</div><div style="text-indent: 10px;">{</div><div style="text-indent: 20px;">"title":"John F. Kennedy International Airport",</div><div style="text-indent: 20px;">"value":"JFK",</div><div style="text-indent: 20px;">"synonyms":[</div><div style="text-indent: 30px;"> "John F. Kennedy International Airport",</div><div style="text-indent: 30px;">"New York International Airport",</div><div style="text-indent: 30px;">"JFK",</div><div style="text-indent: 20px;">]</div><div style="text-indent: 10px;">}</div>]</div>',$scope.$watch("nodeInfo.nodeInfo.unitType",function(newVal,oldVal){$scope.chooseUnitType()}),$scope.showQuantityType=!0,$scope.nodeColors={subDialog:"#eaa724",intent:"#57187f",entity:"#3ab962",script:"#9b9b9b",SDKWebHook:"#8B572A",agentTransfer:"#8B572A",service:"#4a4a4a",message:"#007eff",dialogAct:"#1d758e",form:"#bd10e0",logic:"#ff001f",process:"#135423",botAction:"#FF784B"},$scope.editorProps={},$scope.editorProps.editorEnabled=!1,$scope.openDaasTest=function(){$scope.daasCallbackObj.sampleResponse=null,$scope.modalSlider.open("#daas-test")},$scope.closeDaasTest=function(){$scope.modalSlider.close("#daas-test")},$scope.daasCloseModal=function(){$scope.modalSlider.close("#data-service")},$scope.saveSampleResponse=function(){var _payload={};if($scope.resSaveInProgress=!0,!$scope.component.sampleResponse||!$scope.component.sampleResponse.length){$scope.component.sampleResponse=[];var _obj={};_obj.name="sampleResponse",_obj.isDefault=!0,$scope.component.sampleResponse.push(_obj)}$scope.component.sampleResponse[$scope.sampleResponseIndex].response=JSON.stringify($scope.daasCallbackObj.sampleResponse),_payload.sampleResponse=$scope.component.sampleResponse,BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),console.log(res),$scope.dialogData("updateComponent",res.data),NotificationService.notify("Sample Response saved successfully","success"),$scope.reqDefCb.onServiceSave(res.data),$scope.closeDaasTest(),$scope.daasCloseModal()),$scope.resSaveInProgress=!1},function(){$scope.resSaveInProgress=!1})},$scope.daasCallbackObj.openDaasTest=$scope.openDaasTest,$scope.daasCallbackObj.nodeInfo=$scope.nodeInfo.nodeInfo,$scope.daasCallbackObj.requestServiceData=$scope.requestServiceData,$scope.serviceNodeTypes=[{id:"custom",name:i18n.i18nString("serviceNodeTypes_custom")},{id:"htmltoimage",name:i18n.i18nString("constants_serviceTypes_htmlToImage")},{id:"urltoimage",name:i18n.i18nString("constants_serviceTypes_urlToImage")},{id:"customauthentication",name:i18n.i18nString("serviceNodeTypes_customauth")}],"universalbot"!==$scope.stream.type&&$scope.serviceNodeTypes.push({id:"smartalert",name:i18n.i18nString("alert_subscription")}),$scope.serviceNodeTypes.push({id:"datatable",name:i18n.i18nString("data_service")}),$scope.serviceNodeTypesChange=function(nv,ov){return $scope.readonly?!1:void window.bootbox.dialog({message:i18n.i18nString("service_node_change"),title:i18n.i18nString("are_you_sure"),className:"alert-modal",onEscape:function(){$scope.nodeInfo.nodeInfo.serviceNodeType=ov},buttons:{main:{label:i18n.i18nString("yes"),className:"btn",callback:function(){var _payload={name:$scope.nodeName,serviceNodeType:$scope.nodeInfo.nodeInfo.serviceNodeType};"custom"===_payload.serviceNodeType&&(_payload.serviceType="rest",delete _payload.payload),"datatable"===_payload.serviceNodeType&&(_payload={name:$scope.nodeName,serviceNodeType:$scope.nodeInfo.nodeInfo.serviceNodeType,payload:{resource:"dataTable"}}),startSaving(".serviceGeneralSettings"),updateComponent(_payload,".serviceGeneralSettings")}},success:{label:i18n.i18nString("no"),className:"btn closeCancel",callback:function(){$scope.nodeInfo.nodeInfo.serviceNodeType=ov}}}})},$scope.getNodeCount=function(node){var count="",compId=node.compId||node.componentId,uId=node.uId||node.nodeId;return $scope.nodeInfo.dialogInfo.nodeCounts&&$scope.nodeInfo.dialogInfo.nodeCounts[compId]&&$scope.nodeInfo.dialogInfo.nodeCounts[compId][uId]&&$scope.nodeInfo.dialogInfo.nodeCounts[compId].count>1&&(count=" ["+$scope.nodeInfo.dialogInfo.nodeCounts[compId][uId]+"]"),count},$scope.unlockDailogComponent=function(){function confirmClone(){var payload={dialogId:$scope.nodeInfo.dialogInfo.dialogId,nodeId:$scope.nodeInfo.nodeInfo.nodeId};BTStreamsService.cloneDialogComponent($scope.stream._id,$scope.nodeInfo.dialogNodeInstance.componentId,payload).then(function(response){$scope.nodeInfo.nodeInfo=response.data,$scope.nodeInfo.nodeInfo.nodeId=nodeInfoToClone.nodeId,$scope.flowtaskApi.updateClonedComponent(response.data,nodeInfoToClone),NotificationService.notify(i18n.i18nString("dialog_success"),"success")},function(error){NotificationService.notify(i18n.i18nString("error"),"error")})}function cancleClone(){}function confirmUnlock(){var payload={resources:[{resourceType:"dialogComponent",resourceId:$scope.nodeInfo.nodeInfo._id}]};BTStreamsService.unlockDailogComponent($scope.stream._id,payload).then(function(response){"FAILURE"==response.data[0].status?$timeout(function(){NotificationService.userConfirm(i18n.i18nString("confirm_unlock_clone"),[confirmClone,cancleClone],{okText:i18n.i18nString("clone"),btnClass:"btnPrimary"},"",void 0,"Clone")},500):"SUCCESS"==response.data[0].status&&($scope.nodeInfo.nodeInfo=response.data[0].result,$scope.flowtaskApi.updateComponentLock(),NotificationService.notify(i18n.i18nString("dialog_success"),"success"))},function(error){NotificationService.notify(i18n.i18nString("error"),"error")})}function confirmTaskUnlock(){var resources=[];resources.push({resourceId:$scope.nodeInfo.dialogInfo.dialogId,resourceType:"dialog"});var requestData={resources:resources};BTStreamsService.unlockDialog($scope.nodeInfo.dialogInfo.dialogId,_selectedStream._id,requestData).then(function(response){"SUCCESS"==response.data[0].status&&($scope.nodeInfo.editLocked=!1,$workflowService.navigateTabIndex(".tasks-pane"),NotificationService.notify(i18n.i18nString("task_unlock"),"success"),$rootScope.$broadcast("loadBots",$workflowService.selectedStream(),"botTasks"))},function(error){})}function cancleTaskUnlock(){}var nodeInfoToClone=$workflowService.cloneData($scope.nodeInfo.nodeInfo);"FlowTask"==$scope.flowtaskApi.type?$scope.nodeInfo.editLocked?NotificationService.userConfirm(i18n.i18nString("flowtask_unlock"),[confirmTaskUnlock,cancleTaskUnlock],{okText:i18n.i18nString("confirm"),btnClass:"btnPrimary"},"",void 0,i18n.i18nString("task_lock")):NotificationService.userConfirm(i18n.i18nString("unlock_node"),[confirmUnlock,cancleTaskUnlock],{okText:i18n.i18nString("confirm"),btnClass:"btnPrimary"},"",void 0,i18n.i18nString("confirm_unlock_name")):"ManageComponents"==$scope.flowtaskApi.type&&$scope.flowtaskApi.updateManageComponenmts($scope.nodeInfo)},$scope.cb.uiFormName?$scope.uiFormName=$scope.cb.uiFormName:$scope.nodeInfo.nodeInfo.formDetails&&$scope.nodeInfo.nodeInfo.formDetails.name&&($scope.uiFormName=$scope.nodeInfo.nodeInfo.formDetails.name),$scope.dropDownInfo={staticDropdownType:"staticList",contextDropdownVals:{contextVal:"",contextValKey:"",contextTitleKey:"",contextSynonymsKey:"",contextWordIndex:""},staticDropdownVals:[]},$scope.newStaticValue={title:"",value:"",synonyms:""},$scope.newJsonValue={title:"",value:"",synonyms:""};var _connectionColors=["#299d8e","#5ea8d3","#e9c369","#f3a261","#533a71","#6183d8","#50c5b7","#7ac74f","#1c77c3","#9f86c0"];$scope.connDefColors=_connectionColors,$scope.entityTypeOptions=["Currency","Other"],$scope.dataTypeOptions=["Number","Decimal"],$scope.props={},$scope.readonly=$scope.nodeInfo.displayMode&&"view"===$scope.nodeInfo.displayMode?!0:!1,$scope.entityInstancePropertyCB.displayMode=$scope.nodeInfo.displayMode||"edit",$scope.utterancesCopy=[],$scope.showUtteraceDefaultTip=!1,$scope.newUtterance={},$scope.newUtterance.sentence="",$scope.newPrompt={channel:"default",text:"",type:"basic",_id:""},$scope.newPrompt.text="",$scope.newErrorPrompt={channel:"default",text:"",type:"basic",_id:""},$scope.newErrorPrompt.text="",$scope.newSubmitPrompt={channel:"default",text:"",type:"basic",_id:""},$scope.newSubmitPrompt.text="",$scope.multiCategoryPromptsCopy=[],loadMultiCategoryComponents(),loadMessages(),$scope.contextMap={isLoading:!1,keyCount:0,subIntentEntities:[],remainingKeys:[]},$scope.postContextMap={isLoading:!1,keyCount:0,subIntentEntities:[],remainingKeys:[]},$scope.events=[{name:i18n.i18nString("events_onmsg"),id:"onMessage"},{name:i18n.i18nString("events_onhook"),id:"onHook"},{name:i18n.i18nString("events_onevent"),id:"onEvent"},{name:i18n.i18nString("events_onalert"),id:"onAlert"},{name:i18n.i18nString("events_varupdate"),id:"onVariableUpdate"}],$rootScope.appConfig.DISABLE_AGENT_TRANSFER||$scope.events.push({name:i18n.i18nString("events_agenttransfer"),id:"onAgentTransfer"});var ivrPromptSortableCallback=function(e,ui){$timeout(function(){$scope.saveIVROptions("")},300)},conSortableCallback=function(e,ui){$timeout(function(){$(e.target).find("[checked='checked']").each(function(){$(this).click()}),$scope.hasUnsavedConnection=!0},300)};$scope.sortableOptions={handle:".sortBar","ui-floating":!0,update:sortableCallback},$scope.ivrPromptsSortableOptions={handle:".sortBar","ui-floating":!0,update:ivrPromptSortableCallback},$scope.compositePattensSorting={handle:".sortBar","ui-floating":!0,update:saveCompositePatterns},$scope.ivrPromptsSortableInnerOptions={handle:".sortBar","ui-floating":!0,update:ivrPromptSortableCallback},$scope.conSortableOptions={connectWith:".sortableConnectionContainer",cancel:".unsortable",update:conSortableCallback,axis:"y"},$scope.sortableOptionsErrorPromt={handle:".sortBar","ui-floating":!0,update:sortableCallbackErrorPromt},$scope.sortableOptionsErrorInstancePromt={handle:".sortBar","ui-floating":!0,update:sortableCallbackErrorInstancePromt},$scope.assetsBase=env_conf["assets-url"],$scope.options={mode:"code",ace:window.ace},$scope.editorCallback={},$scope.lookup={jsonData:[]};var savedLookupData={};if($scope.currentPage=1,$scope.paginationOptions={currentPage:1,maxSize:5,itemsPerPage:20},$scope.utterancePaginatinoOptions={currentPage:1,maxSize:5,itemsPerPage:10},$scope.totalUtterancesCount=0,"entity"===$scope.component.type){$scope.props.synonyms=$workflowService.cloneData(_constants_.getAlphabeticallySortedArray($scope.component.synonyms||[])),$scope.entityList=$workflowService.cloneData($rootScope._constants_.entityNlp);var iKey=0;if("currency"===$scope.nodeInfo.nodeInfo.entityType)for(iKey=0;iKey<$scope.entityList.length;iKey++)"currency"===$scope.entityList[iKey].value&&($scope.entityList[iKey].isDepricated=!1);if("quantity"===$scope.nodeInfo.nodeInfo.entityType)for(iKey=0;iKey<$scope.entityList.length;iKey++)"quantity"===$scope.entityList[iKey].value&&($scope.entityList[iKey].isDepricated=!1);"cityAdv"===$scope.nodeInfo.nodeInfo.entityType&&($scope.selectcityAdv=!0,$scope.nodeInfo.nodeInfo.entityFields&&$scope.nodeInfo.nodeInfo.entityFields.cityAdvanced?$scope.cityParams=$scope.nodeInfo.nodeInfo.entityFields.cityAdvanced:$scope.cityParams=[],cityAdvanceInit($scope.cityParams))}("entity"===$scope.component.type||"intent"===$scope.component.type)&&($scope.props.patterns=$scope.component.patterns||[],$scope.props.compositePattern=$scope.component.compositePatterns||[],$scope.props.patterns.forEach(function(msg){msg.original=decodePattern(msg.original)}),$scope.props.compositePattern.forEach(function(msg){msg.original=decodePattern(msg.original)}),$scope.props.patterns.length&&($scope.props.patterns=_.pluck($scope.props.patterns,"original"),$scope.ob.referencePatterns=$workflowService.cloneData($scope.props.patterns),_.forEach($scope.ob.referencePatterns,function(eachPattern){eachPattern=decodePattern(eachPattern)})),$scope.props.compositePattern.length&&($scope.props.compositePattern=_.pluck($scope.props.compositePattern,"original"))),$scope.getBotsynonyms=function(){if($scope.component&&"intent"===$scope.component.type){$scope.props.botSynonyms=$workflowService.cloneData($scope.stream.synonyms)||{};var _intentSentence=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.intent);_intentSentence&&_intentSentence.split(" ").forEach(function(key){$scope.props.botSynonyms[key]||($scope.props.botSynonyms[key]=[])})}},$scope.bindAuioComplete=function(index,ele){$timeout(function(){var id="#addTrait_"+index;ele&&(id="#addTrait"+ele+index),setTimeout(function(){$(id).autocomplete({minLength:1,source:$scope.cb.allTraits,focus:function(event,ui){return $(id).val(ui.item.label),!1},position:{collision:"flip"},select:function(event,ui){return $(id).val(ui.item.label),!1}}).autocomplete("widget").addClass("contextTypeaheadDropdown")},200)},500)},$scope.mapTraitsForComponent=function(traitsPayload,updateType){var payload={traitRules:[]};$.each(traitsPayload.traitRules,function(i,eachRule){(eachRule.length>1||1==eachRule.length&&eachRule[0])&&payload.traitRules.push(eachRule)});var deferred=$q.defer();return BTFlowtaskService.updateComponentTraits($scope.stream._id,$scope.nodeInfo.nodeInfo._id,payload).then(function(res){mixpanelEvent("createTraits"),$scope.traitRules.traitMappings=traitsPayload.traitRules,$scope.nodeInfo.nodeInfo.traitRules=res.data.traitRules,deferred.resolve(traitsPayload)},function(err){NotificationService.notify(i18n.i18nString("fail_traits"),"error"),deferred.resolve({data:[]})}),deferred.promise},$scope.addTraitAndCondition=function(event,orIndex,rulesArray){setTimeout(function(){var mappings={traitRules:$scope.traitRules.traitMappings};$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("success_traits"),"success")})},700)},$scope.addTraitOrCondition=function(event,index,condition){if($scope._constants_.checkForSecialChar(condition.traitName,!0,"traits"))return!1;if(!condition.traitName)return!1;var trait=$workflowService.cloneData(condition.traitName.replace(/\s/g,"")),mappings={traitRules:[]},andCondition=[];mappings.traitRules=$workflowService.cloneData($scope.traitRules.traitMappings)||[],event&&13==event.keyCode&&(andCondition.push(trait),mappings.traitRules.push(andCondition),$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("success_traits"),"success"),$scope.dummyTraitOrCondition.length>1?$scope.dummyTraitOrCondition.splice(index,1):1==$scope.dummyTraitOrCondition.length&&($scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push($workflowService.cloneData(dummy_traitAnd)))}))},$scope.addTraitDummyAndCondition=function(index){$timeout(function(){var condition=$scope.dummyTraitOrCondition[index];if(!condition[0])return!1;var trait=$workflowService.cloneData(condition[0]),mappings={traitRules:[]},andCondition=[];mappings.traitRules=$workflowService.cloneData($scope.traitRules.traitMappings)||[],andCondition.push(trait),mappings.traitRules.push(andCondition),$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("success_traits"),"success"),$scope.dummyTraitOrCondition.length>1?$scope.dummyTraitOrCondition.splice(index,1):1==$scope.dummyTraitOrCondition.length&&($scope.dummyTraitOrCondition=[],$timeout(function(){$scope.dummyTraitOrCondition.push($workflowService.cloneData(dummy_traitAnd)),$("#addTraitRulesPropertyPannel"+($scope.traitRules.traitMappings.length-1))&&$("#addTraitRulesPropertyPannel"+($scope.traitRules.traitMappings.length-1)).find(".input")&&$("#addTraitRulesPropertyPannel"+($scope.traitRules.traitMappings.length-1)).find(".input").length&&$("#addTraitRulesPropertyPannel"+($scope.traitRules.traitMappings.length-1)).find(".input")[0].focus()},300))})},500)},$scope.deleteOrRule=function(orIndex){var mappings={traitRules:[]};mappings.traitRules=$workflowService.cloneData($scope.traitRules.traitMappings)||[],mappings.traitRules.splice(orIndex,1),$scope.mapTraitsForComponent(mappings,"orCondition").then(function(res){NotificationService.notify(i18n.i18nString("delete_trait"),"success")})},$scope.addOrDummy=function(){$scope.dummyTraitOrCondition.push($workflowService.cloneData(dummy_traitAnd))},$scope.getBotsynonyms(),$scope.suggestedSynonyms=[{name:"value",active:"false"},{name:i18n.i18nString("dollar"),active:"true"},{name:i18n.i18nString("cash"),active:"true"}],$scope.suggestedPatterns=[{id:1}],$scope.requestServiceData=$scope.nodeInfo&&$scope.nodeInfo.nodeInfo&&$scope.nodeInfo.nodeInfo.requestServiceData||$scope.nodeInfo.nodeInfo.payload||"","service"===$scope.component.type&&$scope.nodeInfo.nodeInfo.sampleResponse&&($scope.nodeInfo.nodeInfo.sampleResponse||($scope.isResponseDataAvailable=!1,$scope.responseData={}),$scope.isResponseDataAvailable=$scope.nodeInfo.nodeInfo.sampleResponse.length>0?!0:!1,$scope.responseData=$scope.nodeInfo.nodeInfo.sampleResponse),($scope.nodeInfo&&"entity"===$scope.nodeInfo.nodeInfo.type&&"list_of_values"===$scope.nodeInfo.nodeInfo.entityType||"dialogAct"===$scope.nodeInfo.nodeInfo.type)&&$scope.nodeInfo.nodeInfo&&$scope.nodeInfo.nodeInfo.hasOwnProperty("applyDefaultTemplate")&&($scope.listOfValuesOptions.display=$scope.nodeInfo.nodeInfo.applyDefaultTemplate),$scope.showDisplayListOfvaluesOptions=function(){return"entity"===$scope.nodeInfo.nodeInfo.type&&"list_of_values"===$scope.nodeInfo.nodeInfo.entityType?!0:"dialogAct"===$scope.nodeInfo.nodeInfo.type?!0:!1},$scope.saveListOfValuesOptionsChoice=function(){var payload={applyDefaultTemplate:$scope.listOfValuesOptions.display};updateComponent(payload,".listOfvaluesUserChoice")},$scope.saveRtmRenderType=function(){var payload={rtmRenderType:$scope.nodeInfo.nodeInfo.rtmRenderType};updateComponent(payload,"rtmRenderType")},$scope.decodeJS=decodeJS,"service"===$scope.component.type&&("htmltoimage"===$scope.component.serviceNodeType?($scope.requestServiceData=$scope.component.htmlData&&$scope.component.htmlData[0]&&$scope.component.htmlData[0].text||"",$scope.requestServiceData=$scope.requestServiceData.replace(/&lt;/gi,"<").replace(/&gt;/gi,">")):"smartalert"===$scope.nodeInfo.nodeInfo.serviceNodeType?($scope.requestServiceData=$scope.component.payload?$scope.component.payload:"",$scope.nodeInfo.nodeInfo.requestServiceData=$scope.component.payload?$scope.component.payload:""):"datatable"===$scope.nodeInfo.nodeInfo.serviceNodeType?$scope.requestServiceData=$scope.nodeInfo.nodeInfo.payload||"":$scope.requestServiceData=processUIEndPoint($scope.nodeInfo.nodeInfo.endPoint)),$scope.scriptData="",$scope.showAlertPopup=function(msg,cb){NotificationService.alert(msg,cb,{okText:i18n.i18nString("ok")})};var _defaultGrammar={inputMode:"speech",type:"custom",value:""};preparePromptOptionsData(),prepareEntityRulesData(),$scope.$watch("newAuth.selected",function(newValue,oldValue){(null===newValue||""===newValue)&&($scope.createNewIDP(),$scope.newAuth.selected=oldValue)}),$scope.authCB.onCreateIDP=function(idpData){$scope.authLists.push({_id:idpData._id,name:idpData.name,sso_type:idpData.sso_type}),$scope.newAuth.selected=$scope.authLists.filter(function(authItem){return authItem.name===idpData.name})[0]},$scope.createNewIDP=function(){$scope.authCB.createNewIDP()},$scope.getAuthList=function(){BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.authLists=res.data,$scope.authLists.push({_id:"none",name:"none",sso_type:"none"}),$scope.newAuth.selected=$scope.authLists.filter(function(authItem){return authItem.name===($scope.component.idp||"none")})[0]},function(res){NotificationService.notify(i18n.i18nString("notify_idp"),"error")})},$scope.authEdit=function(){var authID=authID||$scope.newAuth.selected._id;$scope.authCB.authEdit(authID)},$scope.onHeaderFocus=function(index){$scope.props.headers.length===index+1&&$scope.props.headers.push({key:"",value:""})},$scope.onHeaderFocusParams=function(index){$scope.props.params.length===index+1&&$scope.props.params.push({key:"",value:""})},$scope.appendingParamsToURL=function(){var sourceUrl=$(".leftDiv textarea").val(),_p={},appendingURLValues=decodeURI(sourceUrl).substr(sourceUrl.indexOf("?"),sourceUrl.length).replace("?","").split("&").map(function(param){return param.split("=")});appendingURLValues.forEach(function(obj){_p[obj[0]]=obj[1]}),appendingURLValues=_p;var appendingValues={};$scope.props.headers.forEach(function(obj){obj.key&&(appendingValues[obj.key]=obj.value)});var URLQueryParameters=appendingValues,ele="";$scope.props.endPoint.requestUrl="",Object.keys(URLQueryParameters).forEach(function(key){key&&(ele+=(ele?"&":"")+key+(void 0===URLQueryParameters[key]?"":"=")+(URLQueryParameters[key]||""))});var url=sourceUrl.split("?");
url=url[0]+"?"+ele,$scope.props.endPoint.requestUrl=url},$scope.appendingParamsToInput=function(){var sourceUrl=$(".leftDiv textarea").val()||$scope.props.endPoint.requestUrl;if(sourceUrl.includes("?")){var _p={},appendingURLValues=decodeURI(sourceUrl).substr(sourceUrl.indexOf("?"),sourceUrl.length).replace("?","").split("&").map(function(param){return param.split("=")});appendingURLValues.forEach(function(obj){_p[obj[0]]=obj[1]}),appendingURLValues=_p;var appendingValues={};$scope.props.headers.forEach(function(obj){obj.key&&(appendingValues[obj.key]=obj.value)});var URLQueryParameters=appendingURLValues,ele="";$scope.props.headers=[],Object.keys(URLQueryParameters).forEach(function(key){key&&(ele+=(ele?"&":"")+key+(void 0===URLQueryParameters[key]?"":"=")+(URLQueryParameters[key]||""));var obj={key:key,value:URLQueryParameters[key]||""};if(""!==obj.key){var validCheck=$scope.checkobj(obj);validCheck?$scope.props.headers[validCheck-1]=obj:$scope.props.headers.push(obj)}else $scope.props.headers.push({key:"",value:""})})}},$scope.onParamTypeChange=function(){var index=_.findIndex($scope.props.params,function(header){return"Content-Type"===header.key});-1!==index&&$scope.deleteHeaders(index),$scope.props.params.unshift({key:"Content-Type",value:$scope.paramsBody.value}),"custom"===$scope.paramsBody.value&&$timeout(function(){$(".headersTabBtn").click()})},$scope.checkobj=function(obj){for(var duplicateCheck=0,i=0;i<$scope.props.headers.length;i++)$scope.props.headers[i].key==obj.key&&(duplicateCheck=i+1);return duplicateCheck},$scope.onSearchClose=function(e){e.stopPropagation(),$scope.ob.referencePatterns=$scope.props.patterns,$scope.props&&$scope.props.patterns&&!$scope.props.patterns.length&&($scope.showAddPattern=!0)},$scope.showPatternSaveTip=function(index){$element.find(".patternSaveTip"+index)&&"block"!==$element.find(".patternSaveTip"+index)[0].style.display?$element.find(".patternSaveTip"+index).css("display","block"):$element.find(".patternSaveTip"+index).css("display","none")},$scope.searchPatterns=function(){$scope.searchingPattern=!0,""===$scope.gSearchCb.search&&($scope.ob.referencePatterns=$workflowService.cloneData($scope.props.patterns),$scope.showAddPattern=!0,setTimeout(function(){$(".patternSaveTip").hide()},0)),13==event.keyCode&&($scope.ob.referencePatterns=$scope.props.patterns.filter(function(value,index){return value.includes($scope.gSearchCb.search)}))},$scope.openTabSection=function(section){openSection(section),"ivrProperties"!=section||$scope.isEnabled||$scope.enableIvrsettings(),"ivrProperties"==section&&$scope.checkTermination(),"instanceProperties"==section&&checkEntityRulesSyncWithML(),$element.find(".inputContainer .patternSaveTip").css("display","none")},$scope.dialogTaskList=$workflowService.dialogTasks()||{},$scope.dialogTasksByState=$workflowService.dialogTasksByState()||{},$scope.getNodeTypeColor=function(type){return"intent"===type&&$scope.nodeInfo.dialogNodeInstance.flowTaskId&&(type="subDialog"),{"background-color":$scope.nodeColors[type]}},$scope.getNodeTypeName=function(type){return"intent"===type&&$scope.nodeInfo.dialogNodeInstance.flowTaskId&&(type="subDialog"),$scope.configurableElements[type]?$scope.configurableElements[type].name||"":""},$scope.getIntentAllowed=function(currentNode){return!$scope.nodeInfo||"SDKWebHook"!==$scope.nodeInfo.nodeInfo.type&&"agentTransfer"!==$scope.nodeInfo.nodeInfo.type?!0:"intent"===currentNode.type?!1:!0},$scope.getEntityTypeName=function(entityType){var _foundVal="";return $.each($rootScope._constants_.entityNlp,function(k,nlp){return nlp.value===entityType?(_foundVal=nlp.title,!1):void 0}),_foundVal.length>0?_foundVal:entityType},$scope.checkForEntityType=function(type){return"description"===type||"regex"===type?!0:!1},$scope.addElseIfBlock=function(targetId,isDefault){if($scope.readonly)return!1;$scope.nodeInfo.dialogInfo.dummyConnCount++;var _dummyVal="dummy"+$scope.nodeInfo.dialogInfo.dummyConnCount,_connNum=0;0===$scope.tempDialogNodeInstConnObj.length?_connNum=0:(_connNum=$scope.tempDialogNodeInstConnObj.length-1,_connNum>9&&(_connNum%=10)),isDefault&&_connNum++;var connectionObj={context:"",op:"",value:""},tests=[];tests.push(connectionObj);var _connObj={connId:_dummyVal,sourceId:$scope.nodeInfo.dialogNodeInstance.uId,targetId:targetId||"",isDefault:isDefault?!0:!1,ifConditionPrefix:"context",ifCondition:"",ifOperator:"",value:"",color:_connectionColors[_connNum],top:0,showBottom:!1,intentType:"followup",tests:tests,conditionAnd:!0,conditionOr:!0,orSelected:!1};"entity"===$scope.nodeInfo.dialogNodeInstance.type&&(_connObj.ifConditionPrefix="field",_connObj.ifCondition=$scope.nodeInfo.nodeInfo.nodeId,_connObj.ifOperator="");var _pushIndex=$scope.tempDialogNodeInstConnObj.length-1;"dialogAct"===$scope.nodeInfo.dialogNodeInstance.type&&(_pushIndex=_.findLastIndex($scope.tempDialogNodeInstConnObj,function(con){return"dialogAct"!==con.ifConditionPrefix})+1),0===$scope.tempDialogNodeInstConnObj.length?$scope.tempDialogNodeInstConnObj.push(_connObj):$scope.tempDialogNodeInstConnObj.splice(_pushIndex,0,_connObj),$scope.hasUnsavedConnection=!0},intialize(),$scope.accordianToggle=function(i){console.log("Opened group with index: "+i)},$scope.removeConnection=function(connId){return connId.length>0&&!$scope.readonly?void $.each($scope.tempDialogNodeInstConnObj,function(k,conn){return conn.connId===connId?($scope.tempDialogNodeInstConnObj.splice(k,1),$scope.hasUnsavedConnection=!0,!1):void 0}):!1},$scope.addPattern=function(e,selectedTask,type){$scope.selectedTask=$workflowService.cloneData(selectedTask),$(".pattern-modal").modal("show"),"DialogIntent"===type?$scope.propertyPanelPatternCB.onClickTask($scope.selectedTask,type):"DialogEntity"===type&&$scope.propertyPanelPatternCB.onClickEntity($scope.selectedTask,type)};var updatePropertyPanel=function(res,traitRules){res&&res.patterns&&$scope.nodeInfo.nodeInfo&&res._id===$scope.nodeInfo.nodeInfo._id&&($scope.props.patterns=_.pluck(res.patterns,"original"),$scope.ob.referencePatterns=$workflowService.cloneData($scope.props.patterns),_.forEach($scope.ob.referencePatterns,function(eachPattern,i){$scope.ob.referencePatterns[i]=decodePattern(eachPattern)})),traitRules&&traitRules.traitMappings&&$scope.nodeInfo.nodeInfo&&res._id===$scope.nodeInfo.nodeInfo._id&&($scope.traitRules.traitMappings=traitRules.traitMappings||[],$scope.nodeInfo.nodeInfo.traitRules=traitRules.traitMappings||[]),$scope.cb&&$scope.cb.updateComponent&&$scope.cb.updateComponent(_selectedStream._id,res._id)},updatePropertyPanelData=function(res){if(res&&res.patterns&&$scope.nodeInfo.nodeInfo&&res._id===$scope.nodeInfo.nodeInfo._id){var _propPatterns=_.pluck(res.patterns,"original");$scope.ob.referencePatterns=$workflowService.cloneData(_propPatterns),_.forEach($scope.ob.referencePatterns,function(eachPattern,i){$scope.ob.referencePatterns[i]=decodePattern(eachPattern)})}res&&res.traitRules&&$scope.nodeInfo.nodeInfo&&res._id===$scope.nodeInfo.nodeInfo._id&&($scope.traitRules.traitMappings=res.traitRules||[],$scope.nodeInfo.nodeInfo.traitRules=res.traitRules||[])};$scope.propertyPanelPatternCB.updatePropertyPanel=updatePropertyPanel,$scope.cb.updatePropertyPanel=updatePropertyPanelData,$scope.manageTrainingCB.updatePropertyPanel=updatePropertyPanel,$scope.addRules=function(e,selectedTask,type){$scope.selectedTask=$workflowService.cloneData(selectedTask),$(".pattern-modal").modal("show"),$scope.propertyPanelPatternCB.onClickTraits($scope.selectedTask,type,$scope.traitRules)},$scope.addCompositePattern=function(){return $scope.readonly?!1:($scope.props.compositePattern.push(""),void $timeout(function(){$(".property-panel-cntnr .compositePattern").last().find("input").focus()},100))},$scope.removePattern=function(id,_frmPanel){return $scope.readonly?!1:void(_frmPanel?NotificationService.alert(i18n.i18nString("delete_pattern"),function(){$scope.showAddPattern=!0,$scope.props.patterns.splice($scope.props.patterns.indexOf($scope.ob.referencePatterns[id]),1),$scope.ob.referencePatterns.splice(id,1),0===$scope.props.patterns.length&&($scope.searchingPattern=!1)},{okText:i18n.i18nString("ok")}):($scope.props.patterns.splice(id,1),$scope.ob.referencePatterns.splice(id,1),$scope.searchingPattern=!1))},$scope.removeCompositePattern=function(id,_frmPanel){return $scope.readonly?!1:void(_frmPanel?NotificationService.alert(i18n.i18nString("delete_pattern"),function(){$scope.props.compositePattern.splice(id,1),saveCompositePatterns()},{okText:i18n.i18nString("ok")}):($scope.props.compositePattern.splice(id,1),saveCompositePatterns()))},$scope.onCallDialogToggleClick=function(e,cbState){cbState?$scope.onCallDialogToggleChange(!$scope.callAnotherDialog):window.bootbox.dialog({message:i18n.i18nString("onCallDialogToggleClick"),title:i18n.i18nString("title_dialog"),className:"alert-modal",buttons:{success:{label:i18n.i18nString("no"),className:"btn-primary",callback:function(){$element.find(".callAnotherDialogSwtch").trigger("click")}},main:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){$scope.onCallDialogToggleChange(!0)}}},onEscape:function(){$element.find(".callAnotherDialogSwtch").trigger("click")}})},$scope.onCallDialogToggleChange=function(cbState){startSaving(".propertyCallDialogToggle");var _state=cbState,_updateParams={flowTaskId:_state?$scope.nodeInfo.nodeInfo.dialogId:"",nodeOptions:{transitionType:"auto"}};cbState===!0&&(_updateParams.transitions=[{"default":"end"}]),BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,_updateParams).then(function(res){$scope.nodeInfo.dialogNodeInstance.flowTaskId=_state?$scope.nodeInfo.nodeInfo.dialogId:"",$scope.dialogData("updateDialog",res&&res.data),finishSaving(".propertyCallDialogToggle"),cbState?$scope.headingsList.showInstanceConnection.show=!1:$scope.headingsList.showInstanceConnection.show=!0,cbState&&($scope.contextMap.isLoading=!0,fetchEntitiesForSubIntent())},function(error){if(finishSaving(".propertyCallDialogToggle","error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&!$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&($scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions="required"),$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&!$scope.nodeInfo.dialogNodeInstance.nodeOptions.reuseOptions&&($scope.nodeInfo.dialogNodeInstance.nodeOptions.reuseOptions="1"),$scope.toInt=function(val){return parseInt(val,10)},$scope.vxmlGlobalKeys=[],_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.properties&&($scope.vxmlGlobalCopyKeys=_.pluck(_selectedStream.ivrSettings.properties||[],"name"),_selectedStream&&_selectedStream.audioCodesSettings&&($scope.vxmlGlobalCopyKeys=$scope.vxmlGlobalCopyKeys.concat(_.pluck(_selectedStream.audioCodesSettings.properties||[],"name")))),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.advance&&$scope.nodeInfo.nodeInfo.ivrOptions.advance.properties&&($scope.vxmlNodeKeys=_.pluck($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties||[],"name")),$scope.vxmlGlobalCopyKeys||($scope.vxmlGlobalCopyKeys=[]),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys)),$scope.vxmlselect2Opts={};var _emptyVxmlProp={name:"",value:""};$scope.vxmlProp=$workflowService.cloneData(_emptyVxmlProp),$scope.addVxmlProp=function(e,label,item,array,saveIndicatorSelector,ignoreKey){return $scope.readonly?!1:void((ignoreKey||13===e.keyCode&&!e.shiftKey)&&(ignoreKey||e.preventDefault(),item&&item.value&&(array.push($workflowService.cloneData(item)),$scope.saveIVROptions(saveIndicatorSelector,label,"added"),$scope.vxmlProp=$workflowService.cloneData(_emptyIVRProp))))},$scope.selectVXMLProp=function(prop){var _selectedNodeProp,_selectedGlobalProp;if($scope.readonly)return!1;if(prop&&prop.name){var _globalProps=$scope.stream.ivrSettings.properties.concat($scope.stream.audioCodesSettings.properties),_nodeProps=$scope.originalIvrVxmlCopy;_nodeProps&&_nodeProps.length&&(_selectedNodeProp=_.find(_nodeProps,{name:prop.name}),void 0!==_selectedNodeProp&&(prop.value=_selectedNodeProp.value)),_globalProps&&_globalProps.length&&(_selectedGlobalProp=_.find(_globalProps,{name:prop.name}),void 0===_selectedGlobalProp?prop.value=_selectedNodeProp.value:prop.value=_selectedGlobalProp.value)}},$scope.addNodeVxmlProp=function(){$("#vxml-add").modal("show"),$scope.vprop={name:"",value:""}},$scope.closeNodeVxmlProp=function(){$("#vxml-add").modal("hide"),$scope.vprop={name:"",value:""}},$scope.addProperty=function(vxmlprop,saveIndicatorSelector){$scope.saveIVROptions(saveIndicatorSelector,i18n.i18nString("call_control_param"),"added",vxmlprop),$("#vxml-add").modal("hide")};var btPostData={};$scope.enableIvrsettings=function(){$scope.isEnabled||($scope.isEnabled=!0,_selectedStream.ivrSettings.enable=!0,btPostData={ivrSettings:{asrConfidenceThreshold:_selectedStream.ivrSettings.asrConfidenceThreshold||$scope.ivrSettingsDefault.ivrSettings.asrConfidenceThreshold,extraction_key:_selectedStream.ivrSettings.extraction_key||$scope.ivrSettingsDefault.ivrSettings.extraction_key,enable:$scope.isEnabled||$scope.ivrSettingsDefault.ivrSettings.enable,timeout:parseInt(1e3*_selectedStream.ivrSettings.timeout)||$scope.ivrSettingsDefault.ivrSettings.timeout,retry_limit:parseInt(_selectedStream.ivrSettings.retry_limit)||$scope.ivrSettingsDefault.ivrSettings.retry_limit,properties:_selectedStream.ivrSettings.properties||$scope.ivrSettingsDefault.ivrSettings.properties,enable_log:_selectedStream.ivrSettings.enable_log||$scope.ivrSettingsDefault.ivrSettings.enable_log,enable_transcript:_selectedStream.ivrSettings.enable_transcript||$scope.ivrSettingsDefault.ivrSettings.enable_transcript,transcript_tag:_selectedStream.ivrSettings.transcript_tag||$scope.ivrSettingsDefault.ivrSettings.transcript_tag,callTerminationHandler:_selectedStream.ivrSettings.callTerminationHandler||$scope.ivrSettingsDefault.ivrSettings.callTerminationHandler,bargein:_selectedStream.ivrSettings.bargein||$scope.ivrSettingsDefault.ivrSettings.bargein,grammars:_selectedStream.ivrSettings.grammars||$scope.ivrSettingsDefault.ivrSettings.grammars}},_selectedStream.ivrSettings&&_selectedStream.ivrSettings.timeoutPrompts?btPostData.ivrSettings.timeoutPrompts=[[angular.extend({type:"text"},_selectedStream.ivrSettings.timeoutPrompts[0][0])]]:btPostData.ivrSettings.timeoutPrompts=$scope.ivrSettingsDefault.ivrSettings.timeoutPrompts,_selectedStream.ivrSettings&&_selectedStream.ivrSettings.nomatchPrompts?btPostData.ivrSettings.nomatchPrompts=[[angular.extend({type:"text"},_selectedStream.ivrSettings.nomatchPrompts[0][0])]]:btPostData.ivrSettings.nomatchPrompts=$scope.ivrSettingsDefault.ivrSettings.nomatchPrompts,updateIvrStreamData(btPostData),$scope.callback&&$scope.callback.enableIvr&&$scope.callback.enableIvr(),$("#ivrNode").modal("hide"))},$scope.showIvrModal=function(){$("#ivrNode").modal("show")},$scope.closeIvrModal=function(){$("#ivrNode").modal("hide")},$scope.closeBotLevelIvr=function(){$scope.groupIntentIvrCb.openIvr=!1,$scope.modalSlider.close("#ivrBotLevel")},$scope.closeTwilioVoice=function(){$scope.modalSlider.close("#twilioVoiceSettings")},$scope.closeAudioCodes=function(){$scope.modalSlider.close("#audioCodesPropPanel")},$scope.deleteMessage=function(response,index){function delMessage(){$scope.isAddRespEdited=!0;for(var i=0;i<$scope.responseObj.length;i++)if(""!==$scope.responseObj[i]._id&&$scope.responseObj[i]._id===response._id&&$scope.responseObj[i].channel===response.channel||$scope.responseObj[i].text===response.text&&$scope.responseObj[i].channel===response.channel){$scope.responseObj.splice(i,1);break}}var numOfAllChannels=$scope.responseObj.filter(function(v){return"default"===v.channel}).length;"default"===response.channel&&1===numOfAllChannels?NotificationService.confirm({msg:i18n.i18nString("channel_mandatory"),successCb:function(){delMessage()},isModal:!0,btnTexts:{success:i18n.i18nString("yes"),fail:i18n.i18nString("no")}}):delMessage()},$scope.bargeinToggle=function(enable){enable?$scope.twilioVoiceSettings.bargein=!1:$scope.twilioVoiceSettings.bargein=!0},$scope.prop_panel_voice_channels_all_cb.closeVoiceSlider=function(){$scope.isAllVoiceEnabled=!1},$scope.saveAudioIvr=function(){$scope.prop_panel_audio_codes_cb.saveIVR()},$scope.saveIvrStream=function(){$scope.callback.createIVRStream()},$scope.callback.closeModal=function(){$scope.modalSlider.close("#ivrBotLevel"),_selectedStream=$workflowService.cloneData($workflowService.selectedStream()),_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.properties&&($scope.vxmlGlobalCopyKeys=_.pluck(_selectedStream.ivrSettings.properties||[],"name"),_selectedStream&&_selectedStream.audioCodesSettings&&($scope.vxmlGlobalCopyKeys=$scope.vxmlGlobalCopyKeys.concat(_.pluck(_selectedStream.audioCodesSettings.properties||[],"name")))),$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.advance&&$scope.nodeInfo.nodeInfo.ivrOptions.advance.properties&&($scope.vxmlNodeKeys=_.pluck($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties||[],"name"),$scope.stream=_selectedStream),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys))},$scope.showSaveCancel=function(){$scope.hasUnsavedConnections=!0},$scope.addGrammar=function(){var grammar={};_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable_transcript?(grammar=$workflowService.cloneData(_defaultGrammar),grammar.type="disable"):$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&(grammar=$workflowService.cloneData(_defaultGrammar),grammar.type="custom"),$scope.nodeInfo.nodeInfo.ivrOptions.grammars||($scope.nodeInfo.nodeInfo.ivrOptions.grammars=[]),$scope.nodeInfo.nodeInfo.ivrOptions.grammars.push(grammar),$scope.showSaveCancel()},$scope.showConfirmDialog=function(grammar,oldVal){$scope.resetGrammarValue(grammar),$("#confirmGrammarChannel").modal();var newVal=grammar.channel;grammar.channel=oldVal,setTimeout(function(){$("#confirmGrammarChannel .proceed-btn").click(function(){grammar.channel=newVal,$("#confirmGrammarChannel").modal("hide")}),$("#confirmGrammarChannel .cancel-btn").click(function(){grammar.channel=oldVal,$("#confirmGrammarChannel").modal("hide")})})},$scope.resetGrammarValue=function(grammar){grammar.value=""},$scope.deleteGrammar=function(index){$scope.nodeInfo.nodeInfo.ivrOptions.grammars.splice(index,1),$scope.hasUnsavedConnections=!0};var _emptyPrompt={type:"text",value:""},_emptyIVRProp={value:""};$scope.timeoutPrompt=$workflowService.cloneData(_emptyPrompt),$scope.intialPrompt=$workflowService.cloneData(_emptyPrompt),$scope.nomatchPrompt=$workflowService.cloneData(_emptyPrompt),$scope.errorPrompt=$workflowService.cloneData(_emptyPrompt),$scope.customGrammarCB={},$scope.customGrammarCB.onBlur=function(editor,ele){$scope.saveIVROptions(".grammar .savingIndicator")},$scope.jsPromptCB={},$scope.jsPromptCB.onMinimize=function(editor,ele){$(ele).closest(".textbox-jseditor").find(".save").click()},$scope.editIVRScript=function(ele){console.log("element",ele),console.log($(ele.target.closest(".textbox-jseditor")).find("[acify] .resizeToggle")),$(ele.target.closest(".textbox-jseditor")).find("[acify] .resizeToggle").click()},$scope.selectJSprompt=function(ele){$timeout(function(){$(ele.target.closest(".ivr-propmpt")).find("[acify] .resizeToggle").click()},300)},$scope.addSubPrompt=function(e,array,saveIndicatorSelector,label){console.log(e,array,saveIndicatorSelector),array.push($workflowService.cloneData(_emptyPrompt)),$scope.saveIVROptions(saveIndicatorSelector,label,"added")},$scope.addAltPrompt=function(prompt){"file"===prompt.type&&(prompt.alt=[{type:"text",value:""}])},$scope.addprompt=function(e,label,item,array,saveIndicatorSelector,ignoreKey){if($scope.readonly)return!1;var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;(ignoreKey||13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)&&(ignoreKey||e.preventDefault(),(ignoreKey||item&&item.value)&&(array.push([$workflowService.cloneData(item)]),$scope.saveIVROptions(saveIndicatorSelector,label,"added"),$scope.timeoutPrompt=$workflowService.cloneData(_emptyPrompt),$scope.intialPrompt=$workflowService.cloneData(_emptyPrompt),$scope.nomatchPrompt=$workflowService.cloneData(_emptyPrompt),$scope.errorPrompt=$workflowService.cloneData(_emptyPrompt),$scope.vxmlProp=$workflowService.cloneData(_emptyIVRProp)))},$scope.editVXMLPrompt=function(e,label,item,array,saveIndicatorSelector,ignoreKey){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;(ignoreKey||13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)&&(ignoreKey||e.preventDefault(),(ignoreKey||item&&item.value)&&$scope.saveIVROptions(saveIndicatorSelector,label,"added"))},$scope.deletePrompt=function(e,baseIndex,index,array,saveIndicatorSelector,label){return $scope.readonly?!1:(array[baseIndex].splice(index,1),0===array[baseIndex].length&&array.splice(baseIndex,1),void $scope.saveIVROptions(saveIndicatorSelector,label,"deleted"))},$scope.deleteVxmlPrompt=function(e,index,array,saveIndicatorSelector,label){array.splice(index,1),$scope.saveIVROptions(saveIndicatorSelector,label,"deleted")},$scope.deletealtPrompt=function(index,baseIndex,prompt){var altTab=prompt[baseIndex].alt;altTab.splice(index,1)},$scope.checkForSaveRDelete=function(item,baseIndex,index,array,saveIndicatorSelector,noEmptyDelete){return $scope.readonly?!1:(noEmptyDelete||!item||item.value||(array[baseIndex].splice(index,1),0===array[baseIndex].length&&array.splice(baseIndex,1)),void $scope.saveIVROptions(saveIndicatorSelector))},$scope.saveIVRGrammarOptions=function(saveIndicatorSelector,label,msg,form){return form&&form.$invalid?(form_util.touch(angular.forEach(form,function(key,value){})),void NotificationService.notify(i18n.i18nString("valid_grammer"),"warning",2e3)):void(form&&form.$valid&&($scope.nodeInfo.nodeInfo.ivrOptions.grammars=_.map($scope.nodeInfo.nodeInfo.ivrOptions.grammars,function(o){return"twiliovoice"==o.channel||"audiocodes"==o.channel?{channel:o.channel,value:o.value}:o}),$scope.saveIVROptions(saveIndicatorSelector,label,msg)))},$scope.saveIVROptions=function(saveIndicatorSelector,label,msg,vxmlData){if($scope.readonly)return!1;$scope.IVRForm.Grammar&&$scope.IVRForm.Grammar.$invalid&&$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&angular.forEach($scope.nodeInfo.nodeInfo.ivrOptions.grammars,function(element,index){"disable"===element.type||element.value||$scope.nodeInfo.nodeInfo.ivrOptions.grammars.splice(index,1)}),$scope.hasUnsavedConnections=!1,startSaving(saveIndicatorSelector);var _params={ivrOptions:$scope.nodeInfo.nodeInfo.ivrOptions};vxmlData&&(_params.ivrOptions.advance.properties.push(vxmlData),$scope.vxmlGlobalCopyKeys=_.pluck(_selectedStream.ivrSettings.properties||[],"name"),_selectedStream&&_selectedStream.audioCodesSettings&&($scope.vxmlGlobalCopyKeys=$scope.vxmlGlobalCopyKeys.concat(_.pluck(_selectedStream.audioCodesSettings.properties||[],"name"))),$scope.vxmlNodeKeys=_.pluck($scope.nodeInfo.nodeInfo.ivrOptions.advance.properties||[],"name"),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys))),updateComponent(_params,saveIndicatorSelector,null,label,msg)},$scope.onRequiredToggleChangeOptions=function(className,promptOptions,defaultValueSave){promptOptions&&($scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions=promptOptions),"required"===promptOptions?$scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional=!1:$scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional=!0,className?$scope.onRequiredToggleChange(className,defaultValueSave):$scope.onRequiredToggleChange(".propertyRequireToggle","",defaultValueSave)},$scope.saveAutoCorrectOptions=function(){"true"===$scope.nodeInfo.dialogNodeInstance.nodeOptions.autoCorrect?$scope.nodeInfo.dialogNodeInstance.nodeOptions.userInputCorrection=!0:$scope.nodeInfo.dialogNodeInstance.nodeOptions.userInputCorrection=!1,$scope.onRequiredToggleChange(".userInputToggle")},$scope.savePiiDataOptions=function(){var _payload={name:$scope.nodeName,piiDataEnabled:$scope.status&&$scope.status.piiDataEnabled&&"true"===$scope.status.piiDataEnabled?!0:!1};startSaving(".piiDataToggle"),BTStreamsService.savePiiDataOptions($workflowService.selectedStream()._id,$scope.nodeInfo.nodeInfo._id,_payload).then(function(res){finishSaving(".piiDataToggle"),res&&res.data&&res.data.piiDataEnabled?$scope.status.piiDataEnabled="true":$scope.status.piiDataEnabled="false"},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.onRequiredToggleChange=function(classname,label,defaultValueSave,defaultValueEmpty){startSaving(classname);var _updateParams={nodeOptions:$.extend(!0,{},$scope.nodeInfo.dialogNodeInstance.nodeOptions,{isOptional:$scope.nodeInfo.dialogNodeInstance.nodeOptions.isOptional,promptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions,reuseOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.reuseOptions,notForReuse:$scope.nodeInfo.dialogNodeInstance.nodeOptions.notForReuse||!1,transitionType:"auto",transitionMode:$scope.transitionOptions.mode,interruptOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{},userInputCorrection:$scope.nodeInfo.dialogNodeInstance.nodeOptions.userInputCorrection,entityRules:$scope.nodeInfo.dialogNodeInstance.nodeOptions.entityRules||{}})};defaultValueSave&&_updateParams&&_updateParams.nodeOptions&&!_updateParams.nodeOptions.defaultValue&&delete _updateParams.nodeOptions.defaultValue,defaultValueEmpty&&_updateParams&&_updateParams.nodeOptions&&_updateParams.nodeOptions.defaultValue&&(_updateParams.nodeOptions.defaultValue.text=""),$scope.entityTypeValue=$scope.nodeInfo.nodeInfo.entityType,$scope.checkForEntityType($scope.nodeInfo.nodeInfo.entityType)?_updateParams.nodeOptions.noAutoCorrection=$scope.nodeInfo.dialogNodeInstance.nodeOptions.noAutoCorrection||!1:_updateParams.nodeOptions.noAutoCorrection=!1,"message"===$scope.nodeInfo.dialogNodeInstance.type&&Object.keys($scope.nodeInfo.dialogNodeInstance.connections).length>0&&$.each($scope.nodeInfo.dialogNodeInstance.connections,function(k,connection){return"entity"===connection.type?(_updateParams.nodeOptions.transitionType="onInput",!1):void 0}),BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,_updateParams).then(function(res){if($scope.dialogData("updateDialog",res&&res.data),finishSaving(classname),"entityRules"===label&&(NotificationService.notify("Entity rules saved successfully","success"),res&&res.data&&res.data.nodes)){var filterObj=res.data.nodes.filter(function(e){return e.nodeId==$scope.nodeInfo.dialogNodeInstance.uId});filterObj=filterObj[0],$scope.entityRules.rules=filterObj.nodeOptions.entityRules,$scope.entityRules&&$scope.entityRules.rules&&Object.keys($scope.entityRules.rules).length?$scope.rulesKeys=Object.keys($scope.entityRules.rules):$scope.rulesKeys=[],$scope.showEntityTrain=!0}},function(error){if(finishSaving(classname,"error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.onSessionToggleChange=function(cbState){startSaving(".propertySessionToggle"),setTimeout(function(){finishSaving(".propertySessionToggle")},3e3)},$scope.onSessionValChange=function(){$scope.nodeInfo.dialogNodeInstance.fromSessionData&&$scope.nodeInfo.dialogNodeInstance.fromSessionData.length>0&&(-1===$scope.nodeInfo.dialogNodeInstance.fromSessionData.indexOf(" ")?(startSaving(".propertySessionToggle"),setTimeout(function(){finishSaving(".propertySessionToggle")},3e3)):-1!==$scope.nodeInfo.dialogNodeInstance.fromSessionData.indexOf(" ")&&($scope.nodeInfo.dialogNodeInstance.fromSessionData.replace(/\s/,""),$scope.onSessionValChange()))},$scope.onArrayToggleChange=function(cbState){startSaving(".isArrayToggle");var _updateParams={isArray:cbState};$scope.nodeInfo.dialogNodeInstance.nodeOptions.arraySize=10,updateComponent(_updateParams,".isArrayToggle")},$scope.removeDrpDownVal=function(index){if("view"===$scope.nodeInfo.displayMode)return!1;index>=0&&index<$scope.dropDownInfo.staticDropdownVals.length&&$scope.dropDownInfo.staticDropdownVals.splice(index,1),startSaving(".entityDrpdownSettings");var _drpDown=[];$scope.dropDownInfo.staticDropdownVals.length&&$.each($scope.dropDownInfo.staticDropdownVals,function(k,drpOpts){var drpOptsCopy=$workflowService.cloneData(drpOpts);if(0===drpOptsCopy.title.length||0===drpOptsCopy.value.length)invalid=!0;else{var _tempObj=$scope._constants_.getFromBetween.get(drpOptsCopy.synonyms,"<",">"),_tempSynonyms=_tempObj.results;drpOptsCopy.synonyms=_tempObj.string.replace(/,,/g,","),","==drpOptsCopy.synonyms[0]&&","==drpOptsCopy.synonyms[drpOptsCopy.synonyms.length-1]&&(drpOptsCopy.synonyms=drpOptsCopy.synonyms.substring(1,drpOptsCopy.synonyms.length-1)),","==drpOptsCopy.synonyms[0]&&(drpOptsCopy.synonyms=drpOptsCopy.synonyms.substring(1,0)),","==drpOptsCopy.synonyms[drpOptsCopy.synonyms.length-1]&&(drpOptsCopy.synonyms=drpOptsCopy.synonyms.substring(0,drpOptsCopy.synonyms.length-1)),drpOptsCopy.synonyms=drpOptsCopy.synonyms.split(","),drpOptsCopy.synonyms=drpOptsCopy.synonyms.filter(function(syn){return""!==syn?syn:void 0}),drpOptsCopy.synonyms=drpOptsCopy.synonyms.map(function(syn){return syn.trim()}),_tempSynonyms=_tempSynonyms.map(function(eachSynonym){return/['||"||*]/.test(eachSynonym)&&notValidSynonymsArray.push(eachSynonym),notValidSyn||(notValidSyn=/['||"||*]/.test(eachSynonym)),"<"+eachSynonym.trim()+">"}),drpOptsCopy.synonyms=drpOptsCopy.synonyms.concat(_tempSynonyms),_drpDown.push(drpOptsCopy)}});var _updateParams={allowedValues:{values:_drpDown}};updateComponent(_updateParams,".entityDrpdownSettings")},$scope.onContextDrpDownValChange=function(e){return $scope.readonly?!1:void(13===e.keyCode&&e.preventDefault())},$scope.onContextDrpDownValKeyup=function(e){var _this=$(e.currentTarget);-1!==_this.val().indexOf(" ")&&_this.val(_this.val().replace(/\s/g,""))},$scope.onStaticDrpDownValChange=function(e){return"edit"!==$scope.nodeInfo.displayMode&&e.preventDefault(),$scope.readonly?!1:void((13===e.keyCode||9===e.keyCode)&&e.preventDefault())},$scope.dynamicHeight=function(e){$(".listItemsBlocks textarea").css("height","30px"),$(".lookuplistItemsBlocks textarea").css("height","30px");var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.onNewStaticDropDownValChange=function(e){$scope.newStaticValue.title.length&&(0===$scope.newStaticValue.value.length&&($scope.newStaticValue.value=$scope.newStaticValue.title),0===$scope.newStaticValue.synonyms.length&&($scope.newStaticValue.synonyms=$scope.newStaticValue.title),$scope.dropDownInfo.staticDropdownVals.push($scope.newStaticValue),$timeout(function(){angular.element(".listItemsBlocks:last-child :input:eq(2)").focus()},100),addNewKeyVal())};$scope.onArraySizeChange=function($event){},$scope.cancelNodeInstanceConnections=function(e){$scope.tempDialogNodeInstConnObj=[],setupConnections(),$scope.hasUnsavedConnection=!1;
},$scope.scrollToConnectionSave=function(e){e.preventDefault(),e.stopPropagation();var _scrollEle=$('[data-prop-section-id="connection"]').closest(".container").find(".tab-content");_scrollEle&&_scrollEle.animate({scrollTop:_scrollEle[0].scrollHeight},"1000")},$scope.saveNodeInstanceConnections=function(e){if($scope.readonly)return!1;e.preventDefault(),e.stopPropagation(),$scope.hasUnsavedConnection=!1,startSaving(".connectionRulesIcon"),$scope.andOrConditionSelected=!0;var _updateParams={transitions:[]},_hasIntentTransition=!1,_followUpIntent=!1,_userInput=!1;if($scope.tempDialogNodeInstConnObj&&$scope.tempDialogNodeInstConnObj.length>0){var _key=-1;if($.each($scope.tempDialogNodeInstConnObj,function(k,connection){var _transitionObj={};if(connection.isDefault)_transitionObj={"default":connection.targetId};else if("intent"===connection.ifConditionPrefix)_transitionObj={"if":{},then:connection.targetId},"followup"===connection.intentType?(_transitionObj["if"].op=connection.ifOperator,_transitionObj["if"].value=connection.value,_transitionObj["if"].context="context.FollowupIntents",_followUpIntent=!0):("userinput"===connection.intentType?_transitionObj["if"].op="":_transitionObj["if"].op=connection.ifOperator,_transitionObj["if"].value=connection.value,_transitionObj["if"].intent=connection.ifCondition,_userInput=!0),_hasIntentTransition=!0;else if("field"===connection.ifConditionPrefix)_transitionObj={"if":{field:connection.ifCondition,op:connection.ifOperator,value:connection.value},then:connection.targetId},"dne"===_transitionObj["if"].op&&delete _transitionObj["if"].value,""===_transitionObj["if"].op&&(delete _transitionObj["if"].op,delete _transitionObj["if"].value);else if("dialogAct"===connection.ifConditionPrefix)_transitionObj={"if":{dialogAct:connection.ifCondition},then:connection.targetId};else if(connection.conditionAnd&&connection.conditionOr)_transitionObj={"if":{context:connection.ifCondition||connection.tests&&connection.tests[0].context,op:connection.ifOperator||connection.tests&&connection.tests[0].op,value:connection.value||connection.tests&&connection.tests[0].value},then:connection.targetId};else if($scope.andOrConditionSelected){for(var i=connection.tests.length-1;i>0;i--)connection.tests[i].context||connection.tests.splice(i,1);var conjoin=connection.conditionAnd?"and":"or";_transitionObj={"if":{conjoin:conjoin,tests:connection.tests},then:connection.targetId}}_transitionObj.metadata={color:connection.color,connId:connection.connId},"intent"===connection.ifConditionPrefix&&"followup"===connection.intentType&&(_transitionObj.metadata.intent=""),_updateParams.transitions.push(_transitionObj),connection.isDefault&&(_key=_updateParams.transitions.length-1)}),_key>=0&&_key!==_updateParams.transitions.length-1){var _connTempObj=_updateParams.transitions.splice(_key,1);_.isArray(_connTempObj)&&_connTempObj.length&&(_connTempObj=_connTempObj[0]),_updateParams.transitions.push(_connTempObj)}}var _transitionType="auto";if(_hasIntentTransition&&_userInput&&(_transitionType="onInput"),"entity"===$scope.nodeInfo.nodeInfo.type?_updateParams.nodeOptions=$.extend(!0,{},$scope.nodeInfo.dialogNodeInstance.nodeOptions,{transitionType:_transitionType}):"dialogAct"===$scope.nodeInfo.nodeInfo.type||"message"===$scope.nodeInfo.nodeInfo.type?_updateParams.nodeOptions=$.extend(!0,{},$scope.nodeInfo.dialogNodeInstance.nodeOptions,{transitionType:_transitionType}):_updateParams.nodeOptions={transitionType:_transitionType},$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags){var customTags=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.customTags);_updateParams.nodeOptions.customTags=customTags}BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,_updateParams).then(function(res){$scope.dialogData("updateDialog",res&&res.data),finishSaving(".connectionRulesIcon"),setupConnections()},function(error){if(finishSaving(".connectionRulesIcon","error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.connectionCustomContext=["FollowupIntents"],$scope.hasFollowupIntentsText=function(str){return"context.followupintents"===(str||"").toLowerCase()},$scope.checkFollowupIntentSettings=function(connection){"context"===connection.ifConditionPrefix&&$scope.hasFollowupIntentsText(connection.ifCondition)||"intent"===connection.ifConditionPrefix&&"followup"===connection.intentType?_.find($scope.ifOperatorsFollowupIntents,{val:connection.ifOperator})||(connection.ifOperator=$scope.ifOperatorsFollowupIntents[0].val):_.find($scope.ifOperatorList,{val:connection.ifOperator})||(connection.ifOperator=$scope.ifOperatorList[0].val,connection.value="")},$scope.saveConnectionELSEIF=function(e){$scope.hasUnsavedConnection=!0,13===e.keyCode&&e.preventDefault()},$scope.saveConnectionELSEIFResult=function(e){$scope.hasUnsavedConnection=!0,13===e.keyCode&&e.preventDefault()},$scope.isTargetIntent=function(connection){return connection&&""!==connection.targetId&&$scope.nodeObjList[connection.targetId]&&"intent"===$scope.nodeObjList[connection.targetId].type.toLowerCase()?!0:!1},$scope.getIntentName=function(target){return target&&$scope.nodeObjList&&$scope.nodeObjList[target]?$scope.nodeObjList[target].intent?$scope.nodeObjList[target].intent:$scope.nodeObjList[target].name:""},$scope.checkContextVal=function(e){$scope.hasUnsavedConnection=!0;var _this=$(e.currentTarget);-1!==_this.val().indexOf(" ")&&_this.val(_this.val().replace(/\s/g,""))},$scope.continentCancel=function(){$scope.continentAdded=[],$scope.continentRemoved=[],_.forEach($scope.continentIdlist,function(val){-1===$scope.earlierContinentIds.indexOf(val)&&$scope.continentAdded.push(val)}),_.forEach($scope.earlierContinentIds,function(val){-1===$scope.continentIdlist.indexOf(val)&&$scope.continentRemoved.push(val)}),_.forEach($scope.continentAdded,function(val){_.find($scope.continentsList,{id:val}).checked=!1}),_.forEach($scope.continentRemoved,function(val){_.find($scope.continentsList,{id:val}).checked=!0}),$scope.continentIdlist=$workflowService.cloneData($scope.earlierContinentIds),$scope.continentNameslist=$workflowService.cloneData($scope.earlierContinentNames),$scope.continentIdlist.length<7?$scope.continentsAll[0].checked=!1:($scope.continentsAll[0].checked=!0,$scope.continentIdlist=[],$scope.continentNameslist=[])},$scope.countryCancel=function(){$scope.countryAdded=[],$scope.countryRemoved=[],_.forEach($scope.countryIdlist,function(val){-1===$scope.earlierCountryIds.indexOf(val)&&$scope.countryAdded.push(val)}),_.forEach($scope.earlierCountryIds,function(val){-1===$scope.countryIdlist.indexOf(val)&&$scope.countryRemoved.push(val)}),_.forEach($scope.countryAdded,function(val){_.find($scope.countriesLists,{id:val}).checked=!1}),_.forEach($scope.countryRemoved,function(val){_.find($scope.countriesLists,{id:val}).checked=!0}),$scope.countryIdlist=$workflowService.cloneData($scope.earlierCountryIds),$scope.countrynamelist=$workflowService.cloneData($scope.earlierCountryNames)},$scope.stateCancel=function(){$scope.stateAdded=[],$scope.stateRemoved=[],_.forEach($scope.stateIdlist,function(val){-1===$scope.earlierStateIds.indexOf(val)&&$scope.stateAdded.push(val)}),_.forEach($scope.earlierStateIds,function(val){-1===$scope.stateIdlist.indexOf(val)&&$scope.stateRemoved.push(val)}),_.forEach($scope.stateAdded,function(val){_.find($scope.statesLists,{id:val}).checked=!1}),_.forEach($scope.stateRemoved,function(val){_.find($scope.statesLists,{id:val}).checked=!0}),$scope.stateIdlist=$workflowService.cloneData($scope.earlierStateIds),$scope.statenamelist=$workflowService.cloneData($scope.earlierStateNames)},$scope.contOk=function(){if($scope.continentsAll[0].checked===!0)$scope.continentSelected=i18n.i18nString("continentSelected"),$scope.countrySelected=i18n.i18nString("countrySelected"),$scope.stateSelected=i18n.i18nString("stateSelected"),$scope.countriesLists=[],$scope.statesLists=[],$scope.countriesAll=[{id:"defaultCountry",name:i18n.i18nString("countrySelected"),checked:!0}],$scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!0}],$scope.earlierContinentIds=[],$scope.earlierContinentNames=[],_.forEach($scope.continentList,function(v,k){$scope.earlierContinentIds.push(k),$scope.earlierContinentNames.push(v)});else{for($scope.countryIdlist=[],$scope.countrynamelist=[],$scope.continentAdded=[],$scope.continentRemoved=[],$scope.countryAdded=[],$scope.countryRemoved=[],$scope.stateIdlist=[],$scope.statenamelist=[],$scope.countryNamesshow=[],$scope.stateNamesshow=[],7===$scope.earlierContinentIds.length&&($scope.earlierContinentIds=[]),_.forEach($scope.continentIdlist,function(val){-1===$scope.earlierContinentIds.indexOf(val)&&$scope.continentAdded.push(val)}),_.forEach($scope.earlierContinentIds,function(val){-1===$scope.continentIdlist.indexOf(val)&&$scope.continentRemoved.push(val)}),$scope.earlierContinentIds=$workflowService.cloneData($scope.continentIdlist),$scope.continentSelected=getCityAdvText($scope.continentNameslist),$scope.countriesList={},$scope.statesList={},$scope.countriesAll=[{id:"defaultCountry",name:i18n.i18nString("countrySelected"),checked:!0}],i=0;i<$scope.continentAdded.length;i++)$scope.countriesList[i]=geoLocationIds.countries[$scope.continentAdded[i]],_.forEach($scope.countriesList[i],function(v,k){$scope.countriesLists.push({id:$scope.continentAdded[i]+"."+k,name:v,checked:!0,parentId:$scope.continentAdded[i]})});for(j=0;j<$scope.continentRemoved.length;j++)$scope.countriesList[j]=geoLocationIds.countries[$scope.continentRemoved[j]],_.forEach($scope.countriesList[j],function(v,k){$scope.countriesLists.splice($scope.countriesLists.map(function(item){return item.id}).indexOf($scope.continentRemoved[j]+"."+k),1)});var checkCount=0;for(_.forEach($scope.countriesLists,function(val){val.checked&&(checkCount++,$scope.countryNamesshow.push(val.name),$scope.countryIdlist.push(val.id),$scope.countrynamelist.push(val.name))}),$scope.countriesLists.length===checkCount?($scope.countriesAll=[{id:"defaultCountry",name:i18n.i18nString("countrySelected"),checked:!0}],$scope.countrySelected=i18n.i18nString("countrySelected"),$scope.earlierCountryIds=[],$scope.earlierCountryNames=[]):($scope.countriesAll=[{id:"defaultCountry",name:i18n.i18nString("countrySelected"),checked:!1}],$scope.countrySelected=getCityAdvText($scope.countryNamesshow)),_.forEach($scope.countryIdlist,function(val){-1===$scope.earlierCountryIds.indexOf(val)&&$scope.countryAdded.push(val)}),_.forEach($scope.earlierCountryIds,function(val){-1===$scope.countryIdlist.indexOf(val)&&$scope.countryRemoved.push(val)}),$scope.earlierCountryIds=$workflowService.cloneData($scope.countryIdlist),$scope.earlierCountryNames=$workflowService.cloneData($scope.countrynamelist),i=0;i<$scope.countryAdded.length;i++)$scope.statesList[i]=geoLocationIds.states[$scope.countryAdded[i].split(".")[1]],_.forEach($scope.statesList[i],function(v,k){$scope.statesLists.push({id:$scope.countryAdded[i]+"."+k,name:v,checked:!0})});for(j=0;j<$scope.countryRemoved.length;j++)$scope.statesList[j]=geoLocationIds.states[$scope.countryRemoved[j].split(".")[1]],_.forEach($scope.statesList[j],function(v,k){$scope.statesLists.splice($scope.statesLists.map(function(item){return item.id}).indexOf($scope.countryRemoved[j]+"."+k),1)});var checkstate=0;_.forEach($scope.statesLists,function(val){val.checked&&(checkstate++,$scope.stateNamesshow.push(val.name),$scope.stateIdlist.push(val.id),$scope.statenamelist.push(val.name))}),$scope.earlierStateIds=$workflowService.cloneData($scope.stateIdlist),$scope.earlierStateNames=$workflowService.cloneData($scope.statenamelist),$scope.statesLists.length===checkstate?($scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!0}],$scope.stateSelected=i18n.i18nString("stateSelected"),$scope.earlierStateIds=[],$scope.earlierStateNames=[],$scope.statecheck1=!0):($scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!1}],$scope.stateSelected=getCityAdvText($scope.stateNamesshow),$scope.statecheck1=!1)}},$scope.countryOk=function(){if($scope.countriesAll[0].checked===!0)$scope.countrySelected=i18n.i18nString("countrySelected"),$scope.stateSelected=i18n.i18nString("stateSelected"),$scope.statesLists=[],$scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!0}],$scope.earlierCountryIds=[],$scope.earlierCountryNames=[],$scope.leftCont=$scope.continentIdlist;else{for($scope.countryNamesshow1=[],$scope.stateIdlist=[],$scope.statenamelist=[],$scope.countryAdded=[],$scope.countryRemoved=[],$scope.stateNamesshow=[],$scope.statecheck1&&($scope.statesLists=[],$scope.earlierCountryIds=[]),_.forEach($scope.countryIdlist,function(val){-1===$scope.earlierCountryIds.indexOf(val)&&$scope.countryAdded.push(val)}),_.forEach($scope.earlierCountryIds,function(val){-1===$scope.countryIdlist.indexOf(val)&&$scope.countryRemoved.push(val)}),$scope.earlierCountryIds=$workflowService.cloneData($scope.countryIdlist),$scope.earlierCountryNames=$workflowService.cloneData($scope.countrynamelist),$scope.statesList={},$scope.continentcheck=[],$scope.leftCont=[],$scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!0}],i=0;i<$scope.countryAdded.length;i++)$scope.statesList[i]=geoLocationIds.states[$scope.countryAdded[i].split(".")[1]],_.forEach($scope.statesList[i],function(v,k){$scope.statesLists.push({id:$scope.countryAdded[i]+"."+k,name:v,checked:!0})});for(j=0;j<$scope.countryRemoved.length;j++)$scope.statesList[j]=geoLocationIds.states[$scope.countryRemoved[j].split(".")[1]],_.forEach($scope.statesList[j],function(v,k){$scope.statesLists.splice($scope.statesLists.map(function(item){return item.id}).indexOf($scope.countryRemoved[j]+"."+k),1)});for(i=0;i<$scope.countryIdlist.length;i++)-1===$scope.continentcheck.indexOf($scope.countryIdlist[i].split(".")[0])&&$scope.continentcheck.push($scope.countryIdlist[i].split(".")[0]);var checkstate=0;_.forEach($scope.statesLists,function(val){val.checked&&(checkstate++,$scope.stateNamesshow.push(val.name),$scope.stateIdlist.push(val.id),$scope.statenamelist.push(val.name))}),$scope.earlierStateIds=$workflowService.cloneData($scope.stateIdlist),$scope.earlierStateNames=$workflowService.cloneData($scope.statenamelist),_.forEach($scope.countriesLists,function(val){val.checked&&$scope.countryNamesshow1.push(val.name)}),$scope.countrySelected=getCityAdvText($scope.countryNamesshow1),$scope.statesLists.length===checkstate?($scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!0}],$scope.stateSelected=i18n.i18nString("stateSelected"),$scope.earlierStateIds=[],$scope.earlierStateNames=[]):($scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!1}],$scope.stateSelected=getCityAdvText($scope.stateNamesshow)),$scope.statecheck1=!1,$scope.leftCont=$scope.continentIdlist.filter(function(obj){return-1===$scope.continentcheck.indexOf(obj)})}},$scope.stateOk=function(){var _params={};if($scope.statesAll[0].checked===!0)$scope.stateSelected=i18n.i18nString("stateSelected"),$scope.statesAll=[{id:"defaultState",name:i18n.i18nString("stateSelected"),checked:!0}],$scope.earlierStateIds=[],$scope.earlierStateNames=[],$scope.stateIdlist=[],$scope.leftCountry=[],$scope.apiParams=[].concat($scope.leftCont,$scope.leftCountry,$scope.stateIdlist),startSaving(".entityGeneralSettings"),_params={entityFields:{cityAdvanced:$scope.apiParams}},updateComponent(_params,".entityGeneralSettings");else{for($scope.stateAdded=[],$scope.stateRemoved=[],_.forEach($scope.stateIdlist,function(val){-1===$scope.earlierStateIds.indexOf(val)&&$scope.stateAdded.push(val)}),_.forEach($scope.earlierStateIds,function(val){-1===$scope.stateIdlist.indexOf(val)&&$scope.stateRemoved.push(val)}),$scope.earlierStateIds=$workflowService.cloneData($scope.stateIdlist),$scope.stateSelected=getCityAdvText($scope.statenamelist),$scope.counchec=[],$scope.leftCountry=[],i=0;i<$scope.stateIdlist.length;i++)$scope.counchec.indexOf($scope.stateIdlist[i].split(".")[0]+"."+$scope.stateIdlist[i].split(".")[1])&&$scope.counchec.push($scope.stateIdlist[i].split(".")[0]+"."+$scope.stateIdlist[i].split(".")[1]);$scope.leftCountry=$scope.countryIdlist.filter(function(obj){return-1===$scope.counchec.indexOf(obj)}),$scope.apiParams=[].concat($scope.leftCont,$scope.leftCountry,$scope.stateIdlist),startSaving(".entityGeneralSettings"),_params={entityFields:{cityAdvanced:$scope.apiParams}},updateComponent(_params,".entityGeneralSettings")}console.log($scope.stateIdlist),console.log($scope.leftCountry),console.log($scope.leftCont)},$scope.selectContinent=function(selectedContinent,event){selectedContinent.checked?($scope.continentNameslist.push(selectedContinent.name),$scope.continentIdlist.push(selectedContinent.id),7===$scope.continentIdlist.length&&($scope.continentsAll[0].checked=!0)):($scope.continentNameslist.splice($scope.continentNameslist.indexOf(selectedContinent.name),1),$scope.continentIdlist.splice($scope.continentIdlist.indexOf(selectedContinent.id),1),$scope.continentsAll[0].checked&&($scope.continentsAll[0].checked=!1))},$scope.continentAll=function(selectedContinent,event){$scope.continentIdlist=[],$scope.continentNameslist=[],selectedContinent.checked?(_.forEach($scope.continentList,function(v,k){$scope.continentIdlist.push(k),$scope.continentNameslist.push(v)}),_.forEach($scope.continentsList,function(obj){obj.checked=!0}),_.forEach($scope.continentsAll,function(obj){obj.checked=!0})):(_.forEach($scope.continentsList,function(obj){obj.checked=!1}),_.forEach($scope.continentsAll,function(obj){obj.checked=!1}),$scope.contOkDisable=!0)},$scope.selectCountry=function(selectedCountry,event){selectedCountry.checked?($scope.countryIdlist.push(selectedCountry.id),$scope.countrynamelist.push(selectedCountry.name),$scope.countriesLists.length===$scope.countryIdlist.length&&($scope.countriesAll[0].checked=!0)):($scope.countriesAll[0].checked&&($scope.countriesAll[0].checked=!1),$scope.countryIdlist.splice($scope.countryIdlist.indexOf(selectedCountry.id),1),$scope.countrynamelist.splice($scope.countrynamelist.indexOf(selectedCountry.name),1))},$scope.countryAll=function(selectedCountry,event){$scope.countryIdlist=[],$scope.countrynamelist=[],selectedCountry.checked?(_.forEach($scope.countriesLists,function(val){$scope.countryIdlist.push(val.id),$scope.countrynamelist.push(val.name)}),_.forEach($scope.countriesLists,function(obj){obj.checked=!0}),_.forEach($scope.countriesAll,function(obj){obj.checked=!0})):(_.forEach($scope.countriesLists,function(obj){obj.checked=!1}),_.forEach($scope.countriesAll,function(obj){obj.checked=!1}))},$scope.selectState=function(selectedState,event){selectedState.checked?($scope.stateIdlist.push(selectedState.id),$scope.statenamelist.push(selectedState.name),$scope.statesLists.length===$scope.stateIdlist.length&&($scope.statesAll[0].checked=!0)):($scope.statesAll[0].checked&&($scope.statesAll[0].checked=!1),$scope.stateIdlist.splice($scope.stateIdlist.indexOf(selectedState.id),1),$scope.statenamelist.splice($scope.statenamelist.indexOf(selectedState.name),1))},$scope.stateAll=function(selectedState,event){$scope.stateIdlist=[],$scope.statenamelist=[],selectedState.checked?(_.forEach($scope.statesLists,function(val){$scope.stateIdlist.push(val.id),$scope.statenamelist.push(val.name)}),_.forEach($scope.statesLists,function(obj){obj.checked=!0}),_.forEach($scope.statesAll,function(obj){obj.checked=!0})):(_.forEach($scope.statesLists,function(obj){obj.checked=!1}),_.forEach($scope.statesAll,function(obj){obj.checked=!1}))},$scope.saveEntityName=function(e,key){if(key=key||"name",$scope.readonly)return!1;if(13===e.keyCode||9===e.keyCode||"blur"===e.type){$(":focus").blur(),e.preventDefault(),startSaving(".entityGeneralSettings");var _params={};_params[key]=$(e.currentTarget).val(),updateComponent(_params,".entityGeneralSettings")}},$scope.saveEntityRegEx=function(e){if($scope.readonly)return!1;if(13===e.keyCode||9===e.keyCode||"blur"===e.type){e.preventDefault(),startSaving(".entityGeneralSettings");var _params={regexPattern:$(e.currentTarget).val()};updateComponent(_params,".entityGeneralSettings")}},$scope.conditionPrefixChange=function(connId){$scope.hasUnsavedConnection=!0,$scope.tempDialogNodeInstConnObj.length>0&&$.each($scope.tempDialogNodeInstConnObj,function(k,conn){return conn.connId===connId?(conn.ifCondition="",conn.value="",conn.intentType="followup",!1):void 0})},$scope.saveMessagePropertyName=function(e,key,saveClass){if($scope.readonly)return!1;if(13===e.keyCode||9===e.keyCode||"blur"===e.type||"change"===e.type){e.preventDefault();var _payload={};_payload=key&&"label"===key?{label:$scope.nodeLabel}:{name:$scope.nodeName},saveClass?(startSaving(saveClass),updateComponent(_payload,saveClass)):(startSaving(".msgSettings"),updateComponent(_payload,".msgSettings"))}},$scope.saveTimeoutProperties=function(e,key,saveClass){startSaving(".timeoutProperties");var _payload={};$scope.sdkConfiguration.webhookTimeout=$scope.nodeInfo.nodeInfo.webhookTimeout,_payload={webhookTimeout:$scope.sdkConfiguration.webhookTimeout},updateComponent(_payload,saveClass)},$scope.saveServicePropertyName=function(e,key){if($scope.readonly)return!1;if(13===e.keyCode||9===e.keyCode||"blur"===e.type){e.preventDefault();var _payload={};if(key&&"label"===key)_payload={label:$scope.nodeLabel};else if(key&&"authURL"===key){if(!/\b((http|https|ftp):\/\/)[^\s()<>]+(?:\([\w\d]+\)|([^[:punct:]\s]|\/?))/g.test($scope.nodeAuthURL))return $scope.urlValidation=!0,!1;$scope.urlValidation=!1,_payload={customAuthenticationURL:$scope.nodeAuthURL}}else _payload={name:$scope.nodeName};startSaving(".serviceGeneralSettings"),updateComponent(_payload,".serviceGeneralSettings")}},$scope.saveServiceTimeout=function(){var _payload={};_payload={serviceAPITimeout:$scope.nodeInfo.nodeInfo.serviceAPITimeout},startSaving(".serviceTimeouts"),updateComponent(_payload,".serviceTimeouts")},$scope.saveDialogPropertyName=function(e,key){if($scope.readonly)return!1;if(13===e.keyCode||9===e.keyCode||"blur"===e.type){e.preventDefault();var _payload={};_payload=key&&"label"===key?{label:$scope.nodeLabel}:{name:$scope.nodeName},startSaving(".dialogGeneralSettings"),updateComponent(_payload,".dialogGeneralSettings")}};var _prevEntityType=$workflowService.cloneData($scope.nodeInfo.nodeInfo.entityType);$scope.$watch("nodeInfo.nodeInfo.entityType",function(newValue,oldValue){_prevEntityType=oldValue}),$scope.changeEntityType=function(){$scope.entitySelectionInProgress=!0;var _currentEntityType=$workflowService.cloneData($scope.nodeInfo.nodeInfo.entityType);$timeout(function(){"label"!==_prevEntityType?NotificationService.alert(i18n.i18nString("entity_type_small")+_.find($scope._constants_.entityNlp,{value:_prevEntityType}).title+" "+i18n.i18nString("will_change")+_.find($scope._constants_.entityNlp,{value:_currentEntityType}).title+" ",[saveEntityNodeType,$scope.revertEntityNodeType],{okText:i18n.i18nString("ok")}):saveEntityNodeType()}),$scope.atMentionsData=[],$scope.dialogEntities&&$scope.dialogEntities.length&&$.each($scope.dialogEntities,function(i,entity){if("composite"!==entity.entityType&&"configured"===entity.status){var _object={label:entity.name};$scope.atMentionsData.push(_object)}})},$scope.saveIntentPreConditions=function(){startSaving(".manageContextStatusSav"),setTimeout(function(){var _payload={};_payload.preConditions=$scope.manageContext.preConditions,BTFlowtaskService.updateComponent($scope.stream._id,$scope.nodeInfo.nodeInfo._id,_payload).then(function(res){$scope.dialogData("updateComponent",res.data),mixPanelUpdateEvent(),finishSaving(".manageContextStatusSav")},function(error){if(finishSaving(".manageContextStatusSav","error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},400)},$scope.saveIntentOrEntityContextTags=function(){startSaving(".manageContextStatusSav"),setTimeout(function(){var _payload={nodeOptions:$scope.nodeInfo.dialogNodeInstance.nodeOptions};"entity"===$scope.nodeInfo.dialogNodeInstance.type.toLowerCase()&&(_payload.nodeOptions.autoEmitEntityValues=$scope.manageContext.autoEmitEntityValues||!1),_payload.nodeOptions.contextTags=$scope.manageContext.contextTags,BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,_payload).then(function(res){$scope.dialogData("updateDialog",res&&res.data),finishSaving(".manageContextStatusSav")},function(error){if(finishSaving(".manageContextStatusSav","error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},400)},$scope.revertEntityNodeType=function(){$scope.entitySelectionInProgress=!1,""!==_prevEntityType&&($scope.nodeInfo.nodeInfo.entityType=$workflowService.cloneData(_prevEntityType))},$scope.saveEntityNodeType=function(){$scope.entitySelectionInProgress=!1,_prevEntityType=$workflowService.cloneData($scope.nodeInfo.nodeInfo.entityType);var _payload={entityType:$scope.nodeInfo.nodeInfo.entityType};"quantityv2"!==_payload.entityType||$scope.nodeInfo.nodeInfo.defaultUnit?"quantityv2"===_payload.entityType&&(_payload.unitType=$scope.nodeInfo.nodeInfo.unitType,_payload.defaultUnit=$scope.nodeInfo.nodeInfo.defaultUnit):console.log("if cond"),("label"===_payload.entityType||"description"===_payload.entityType||"from_number"===_payload.entityType||"to_number"===_payload.entityType||"json_object"===_payload.entityType)&&(_payload.isArray=!1),"dateperiod"===_payload.entityType&&($scope.multiCategoryPromptsCopy=[{category:"from",errorMessage:[],message:[]},{category:"to",errorMessage:[],message:[]}],_payload.multiCategoryPrompts=[{category:"from",errorMessage:[],message:[]},{category:"to",errorMessage:[],message:[]}]),("list_of_items_lookup"===_payload.entityType||"list_of_values"===_payload.entityType)&&(_payload.spellcorrectThreshold=0),startSaving(".entityGeneralSettings"),_payload.errorMessage=[{text:$workflowService.cloneData(errorMessages[$scope.nodeInfo.nodeInfo.entityType]||" "),type:"basic",channel:"default"}],updateComponent(_payload,".entityGeneralSettings"),$scope.onRequiredToggleChange(".propertyRequireToggle","",!0,!0),($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&$scope.defaultValue.defaultHiddenValue&&$scope.defaultValue.defaultHiddenValue.length&&0!==$scope.defaultValue.defaultHiddenValue.length||$scope.defaultValue.defaultOptionValue&&$scope.defaultValue.defaultOptionValue.length&&0!==$scope.defaultValue.defaultOptionValue.length)&&($scope.defaultValue.defaultHiddenValue="",$scope.defaultValue.defaultOptionValue="")},$scope.saveServiceType=function(event,ov){if("datatable"!==$scope.nodeInfo.nodeInfo.serviceNodeType){startSaving(".serviceGeneralSettings");var _payload={serviceType:$scope.nodeInfo.nodeInfo.serviceType};updateComponent(_payload,".serviceGeneralSettings")}"datatable"===$scope.nodeInfo.nodeInfo.serviceNodeType&&window.bootbox.dialog({message:i18n.i18nString("service_node_change"),title:i18n.i18nString("are_you_sure"),className:"alert-modal",closeButton:!1,buttons:{main:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){$scope.nodeInfo.nodeInfo.payload.name=null;var _payload={};_payload.sampleResponse=[],BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),$scope.nodeInfo.nodeInfo=$scope.component=res.data,$scope.dialogData("updateComponent",res.data))},function(error){console.log(error)}),_payload={name:$scope.nodeName,serviceNodeType:$scope.nodeInfo.nodeInfo.serviceNodeType,payload:{resource:$scope.nodeInfo.nodeInfo.payload.resource}},updateComponent(_payload,".serviceGeneralSettings")}},success:{label:i18n.i18nString("no"),className:"closeCancel",callback:function(){$scope.nodeInfo.nodeInfo.payload.resource=ov}}}})},$scope.saveSampleUserResponse=function(e){return $scope.readonly?!1:void((13===e.keyCode||9===e.keyCode||"blur"===e.type)&&(e.preventDefault(),startSaving(".entitySampleUserRes"),setTimeout(function(){finishSaving(".entitySampleUserRes")},3e3)))},$scope.savePattern=function(e,index,pattern,form){if($scope.readonly)return!1;if(form.$invalid)return!1;if(13===e.keyCode||9===e.keyCode||"blur"===e.type){if($(e.target).closest(".inputContainer").find(".trashDiv").css("visibility","hidden"),$scope.showAddPattern=!0,startSaving(".entityPatterns"+index),setTimeout(function(){finishSaving(".entityPatterns"+index)},0),setTimeout(function(){$(e.target).closest(".inputContainer").find(".trashDiv").css("visibility","visible")},1e3),form.$dirty&&form.$invalid)return $scope.removePattern(index),!1;e.preventDefault(),$(":focus").blur();var _oldValue,duplicateIndex=checkForDuplicates($scope.ob.referencePatterns,pattern);-1===duplicateIndex?(_oldValue=$scope.ob.referencePatterns[index],$scope.ob.referencePatterns[index]=pattern,_oldValue?$scope.props.patterns[$scope.props.patterns.indexOf(_oldValue)]=pattern:$scope.props.patterns[index]=pattern):($scope.showAddPattern=!0,NotificationService.notify(i18n.i18nString("duplicate_pattern"),"error"))}},$scope.showSave=function(index){$scope.showSaveText=!0},$scope.saveDefaultValue=function(e,options,value){(13===e.keyCode||value||"blur"===e.type)&&($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&"prompt"==$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions?($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue?$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue={channel:"default",text:$scope.defaultValue.defaultOptionValue,type:"basic",_id:$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue._id?$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue._id:"")}:($scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue={},$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue={channel:"default",text:$scope.defaultValue.defaultOptionValue,type:"basic",_id:$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue._id?$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue._id:"")}),defaultValue.setDefaultOptionalValue($scope.defaultValue.defaultOptionValue,$scope.nodeInfo.dialogNodeInstance.uId)):$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&"optional"==$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&($scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue?$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue={channel:"default",text:$scope.defaultValue.defaultHiddenValue,type:"basic",_id:$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue._id?$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue._id:"")
}:($scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue={},$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue={channel:"default",text:$scope.defaultValue.defaultHiddenValue,type:"basic",_id:$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue._id?$scope.nodeInfo.dialogNodeInstance.nodeOptions.defaultValue._id:"")}),defaultValue.setDefaultHiddenValue($scope.defaultValue.defaultHiddenValue,$scope.nodeInfo.dialogNodeInstance.uId)),$scope.onRequiredToggleChangeOptions("",$scope.prompt.promptOptions,!0),$scope.showSaveText=!1)},$scope.saveCompositePattern=function(e,index,compositePattern,form){if($scope.readonly)return!1;if(form.$invalid)return!1;if(13===e.keyCode||9===e.keyCode||"blur"===e.type){if(form.$dirty&&form.$invalid)return $scope.removeCompositePattern(index),!1;e.preventDefault(),$scope.props.compositePattern[index]=compositePattern,saveCompositePatterns()}},$scope.getSentenceCase=function(value){return _selectedStream.defaultLanguage&&"en"!==_selectedStream.defaultLanguage?value:$filter("sentence_case")(value)},$scope.validateTaskName=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression("dialog");return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,{test:function(value){var _currentLanguage=$workflowService.currentLanguage();return _currentLanguage&&"en"===_currentLanguage?regexp.test(value):regexp2.test(value)}}}(),$scope.validateFieldPattern=function(){return{test:function(value){return value&&value.split("*").length-1>=1?!0:!1}}}(),$scope.validateCompositeFieldPattern=function(){return{test:function(value){return value&&value.split("@").length-1>=1?!0:!1}}}(),$scope.onDefaultChangeConnection=function(connection){$scope.hasUnsavedConnection=!0},$scope.onChangeConnection=function(connection,type){if(connection&&type&&"intent"===connection.ifConditionPrefix&&"ifConditionPrefix"===type){"context.FollowupIntents"===connection.ifCondition&&(connection.ifCondition="");var obj=$scope.nodeObjList[connection.ifCondition];obj&&$scope.nodeInfo.dialogNodeInstance.uId!==obj.uId&&$scope.nodeInfo.dialogInfo.firstNodeId!==obj.uId&&(connection.targetId=obj.uId)}$scope.hasUnsavedConnection=!0},$scope.reqDefCb={},$scope.reqDefCb.onServiceSave=function(data){if(addLocalProperties(data),$scope.nodeInfo.nodeInfo=$scope.component=data,$scope.nodeInfo.nodeInfo.sampleResponse){try{$scope.isResponseDataAvailable=Object.keys(JSON.parse($scope.nodeInfo.nodeInfo.sampleResponse)).length>0?!0:!1}catch(e){$scope.isResponseDataAvailable=!1}$scope.isResponseDataAvailable&&($scope.responseData=$scope.nodeInfo.nodeInfo.sampleResponse)}"htmltoimage"===$scope.nodeInfo.nodeInfo.serviceNodeType?$scope.nodeInfo.nodeInfo.htmlData&&$scope.nodeInfo.nodeInfo.htmlData[0]?$scope.requestServiceData=$scope.nodeInfo.nodeInfo.htmlData[0].text:$scope.requestServiceData="":"smartalert"===$scope.nodeInfo.nodeInfo.serviceNodeType?$scope.requestServiceData=$scope.nodeInfo.nodeInfo.payload||"":"customauthentication"===$scope.nodeInfo.nodeInfo.serviceNodeType?fetchComponentDetails():$scope.requestServiceData=processUIEndPoint($scope.nodeInfo.nodeInfo.endPoint),"datatable"==$scope.nodeInfo.nodeInfo.serviceNodeType&&($scope.nodeInfo.nodeInfo.payload.resource=data.payload.resource,$scope.requestServiceData=$scope.nodeInfo.nodeInfo.payload||""),$scope.dialogData("updateComponent",data)},$scope.dialogReportCB={},$scope.dialogReportCB.onDialogReportSave=function(component){$scope.nodeInfo.nodeInfo=component,$scope.component=$scope.nodeInfo.nodeInfo,$scope.dialogData("updateComponent",$scope.component)},$scope.editReport=function(report){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-dialog-reports/bt-dialog-reports.html",controller:"BTDialogReportsCtrl",backdrop:"static",windowClass:"bt-dialog-reports-modal modal-kr",resolve:{config:function(){return{component:$scope.nodeInfo,dialogReportCB:$scope.dialogReportCB,editReport:report,displayMode:$scope.nodeInfo.displayMode}}}})},$scope.deleteReport=function(report,$event){$event.stopPropagation(),window.bootbox.dialog({message:i18n.i18nString("delete_report"),title:i18n.i18nString("delete_report_link"),className:"alert-modal",buttons:{success:{label:i18n.i18nString("no"),className:"btn-primary",callback:function(){}},main:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){var _index=_.findIndex($scope.nodeInfo.nodeInfo.report,function(obj){return obj.config.id===report.config.id});_index>-1&&$scope.nodeInfo.nodeInfo.report.splice(_index,1),updateComponent({report:$scope.nodeInfo.nodeInfo.report},".entityGeneralSettings")}}}})},$scope.daasRequestDefinition=function(type){return $scope.nodeInfo.nodeInfo.payload&&($scope.requestServiceData=$scope.nodeInfo.nodeInfo.payload),"datatable"===$scope.nodeInfo.nodeInfo.serviceNodeType?(type||NotificationService.notify("Please select type","error"),void("dataTable"==type?$scope.modalSlider.open("#data-service"):"view"==type&&$scope.modalSlider.open("#data-service"))):void 0},$scope.requestDefinition=function(type){return"smartalert"===$scope.nodeInfo.nodeInfo.serviceNodeType&&"smartalert"===type?(0===$scope.alerts.length&&NotificationService.notify(i18n.i18nString("no_alerts"),"warning"),void(0!==$scope.alerts.length&&""!==$scope.requestServiceData?$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/smart-alerts/smart-alerts.html",controller:"smartAlertsCtrl",backdrop:"static",resolve:{config:function(){return{component:$scope.nodeInfo,smartAlertService:$scope.nodeInfo.nodeInfo.requestServiceData||$scope.requestServiceData,smartalertCB:updateSmartalert,alertRefCB:updateAlertRef,notificationCB:updateNotification,saveSmartAlertSubscriptionComponentCB:saveSmartAlertSubscriptionComponent}}}}):0!==$scope.alerts.length&&BTStreamsService.smartAlertSubscription($workflowService.selectedStream()._id,$scope.nodeInfo.nodeInfo._id,$scope.alertData).then(function(res){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/smart-alerts/smart-alerts.html",controller:"smartAlertsCtrl",backdrop:"static",resolve:{config:function(){return{component:$scope.nodeInfo,smartAlertService:res.data,smartalertCB:updateSmartalert,alertRefCB:updateAlertRef,notificationCB:updateNotification,saveSmartAlertSubscriptionComponentCB:saveSmartAlertSubscriptionComponent}}}})},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")}))):void("custom"===$scope.nodeInfo.nodeInfo.serviceNodeType?$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-request/bt-request.html",controller:"BTRequestCtrl",backdrop:"static",windowClass:"modal-kr kr-exception bt-request-modal  btFullpageModal height-width-100 taskCreateOrEditModal",resolve:{config:function(){return{cbBridge:$scope.reqDefCb,component:$scope.nodeInfo,authCB:$scope.authCB,btTestFormApi:$scope.btTestFormApi,btTestStatus:$scope.btTestStatus}}}}):$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-toimage/bt-toimage.html",controller:"BTToimageCtrl",backdrop:"static",windowClass:"modal-kr kr-exception bt-request-modal btFullpageModal height-width-100 taskCreateOrEditModal",resolve:{config:function(){return{cbBridge:$scope.reqDefCb,component:$scope.nodeInfo}}}}))};var scriptDefCb={};scriptDefCb.onScriptSave=function(data){addLocalProperties(data),$scope.nodeInfo.nodeInfo=$scope.component=$workflowService.cloneData(data),data.script=decodeJS(data.script),$scope.requestServiceData=processUIEndPoint($scope.nodeInfo.nodeInfo.endPoint),$scope.dialogData("updateComponent",data),$scope.scriptData=data.script||""},$scope.scriptDefinition=function(e){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-script/bt-script.html",controller:"BTScriptCtrl",backdrop:"static",resolve:{config:function(){return{cbBridge:scriptDefCb,component:$scope.nodeInfo}}}})};var addUtterancesCb={};addUtterancesCb.onServiceSave=function(data){$scope.nodeInfo.nodeInfo.utterances=$scope.component.utterances=data,$scope.dialogData("updateComponent",$scope.component)},$scope.addUtterances=function(e){return $scope.readonly?!1:void $modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-utterances/bt-utterances.html",controller:"BTUtterancesCtrl",backdrop:"static",resolve:{config:function(){return{cbBridge:addUtterancesCb,component:$scope.nodeInfo}}}})};var addSampleResponseCb={};addSampleResponseCb.onServiceSave=function(data){$scope.nodeInfo.nodeInfo=$scope.component=data,$scope.isResponseDataAvailable=$scope.nodeInfo.nodeInfo.sampleResponse.length>0?!0:!1,$scope.dialogData("updateComponent",data)},$scope.addSampleResponse=function(index){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-response/bt-response.html",controller:"BTResponseCtrl",windowClass:"bt-response-modal",backdrop:"static",resolve:{config:function(){return{cbBridge:addSampleResponseCb,component:$scope.nodeInfo,index:index}}}})};var addSampleContextCb={};addSampleContextCb.onServiceSave=function(data,contextMap){data&&($scope.nodeInfo.nodeInfo=$scope.component=data,$scope.dialogData("updateComponent",data))},$scope.addSampleContext=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-samplecontext/bt-samplecontext.html",controller:"BTSamplecontextCtrl",backdrop:"static",resolve:{config:function(){return{cbBridge:addSampleContextCb,component:{dialogComponent:$scope.nodeInfo.nodeInfo||{}}}}}})},$scope.deleteSampleResponse=function(index,event){event.stopPropagation(),event.preventDefault(),NotificationService.alert(i18n.i18nString("delete_sample_res"),function(){if($scope._sampleResponsePayload=[],$scope._sampleResponsePayload=$workflowService.cloneData($scope.nodeInfo.nodeInfo.sampleResponse),$scope._sampleResponsePayload[index]){$scope._sampleResponsePayload[index].isDefault?($scope._sampleResponsePayload.splice(index,1),$scope._sampleResponsePayload[0]&&($scope._sampleResponsePayload[0].isDefault=!0)):$scope._sampleResponsePayload.splice(index,1);var _payload={};_payload.sampleResponse=$scope._sampleResponsePayload,BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){if(res&&res.data){mixPanelUpdateEvent(),addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId);var _botConfigurationUpdated=!1;$scope.botConfiguration[$scope.nodeInfo.nodeInfo._id]&&$scope.botConfiguration[$scope.nodeInfo.nodeInfo._id]===$scope.nodeInfo.nodeInfo.sampleResponse[index].name&&(_botConfigurationUpdated=!0,$scope._sampleResponsePayload.length?$scope.botConfiguration[$scope.nodeInfo.nodeInfo._id]=$scope._sampleResponsePayload[0].name:(delete $scope.botConfiguration[$scope.nodeInfo.nodeInfo._id],findValueByPrefix($scope.botConfiguration,"dc")||($scope.botConfiguration.enableTryoutMode=!1))),$scope.nodeInfo.nodeInfo=$scope.component=res.data,$scope.dialogData("updateComponent",res.data),_botConfigurationUpdated&&$scope.dialogData("updateBotConfig",$scope.botConfiguration),$scope.isResponseDataAvailable=$scope.nodeInfo.nodeInfo.sampleResponse.length>0?!0:!1,NotificationService.notify(i18n.i18nString("sample_res_deleted"),"success")}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}},{okText:i18n.i18nString("ok_uppercase")})},$scope.getFocusedAssignmentType=function(type){"preAssign"===type?$workflowService.dialogNodesNames($scope.cb.parentTaskContextdata):"postAssign"===type&&$workflowService.dialogNodesNames($scope.linkedTaskavailableNodesNames)},$scope.addPostContextMap=function(){return $scope.readonly?!1:($scope.postContextMap.remainingKeys.push({key:"",val:""}),void($scope.postContextMap.keyCount=$scope.postContextMap.subIntentEntities.length+$scope.postContextMap.remainingKeys.length))},$scope.removeRemainingPostContextMapKeys=function($index){return $scope.readonly?!1:void($scope.postContextMap.remainingKeys&&$scope.postContextMap.remainingKeys[$index]&&($scope.postContextMap.remainingKeys.splice($index,1),savePostContextMap()))},$scope.postContextMapChange=function(e){return $scope.readonly?!1:void((13===e.keyCode||9===e.keyCode||"blur"===e.type)&&(e.preventDefault(),savePostContextMap()))},$scope.addContextMap=function(){return $scope.readonly?!1:($scope.contextMap.remainingKeys.push({key:"",val:""}),void($scope.contextMap.keyCount=$scope.contextMap.subIntentEntities.length+$scope.contextMap.remainingKeys.length))},$scope.removeRemainingKeys=function($index){return $scope.readonly?!1:void($scope.contextMap.remainingKeys&&$scope.contextMap.remainingKeys[$index]&&($scope.contextMap.remainingKeys.splice($index,1),saveContextMap()))},$scope.contextMapChange=function(e){return $scope.readonly?!1:void((13===e.keyCode||9===e.keyCode||"blur"===e.type)&&(e.preventDefault(),saveContextMap()))},$scope.changeConnColor=function(currConn,color){var _updateParams={transitions:[]};startSaving(".connectionRulesIcon"),$.each($scope.nodeInfo.dialogNodeInstance.connections,function(k,connection){var _transitionObj={};connection.isDefault?_transitionObj={"default":connection.targetId}:"intent"===connection.ifConditionPrefix?_transitionObj={"if":{intent:connection.ifCondition},then:connection.targetId,intentType:connection.intentType}:"field"===connection.ifConditionPrefix?(_transitionObj={"if":{field:connection.ifCondition,op:connection.ifOperator,value:connection.value},then:connection.targetId},""===_transitionObj["if"].op&&(delete _transitionObj["if"].op,delete _transitionObj["if"].value)):_transitionObj="dialogAct"===connection.ifConditionPrefix?{"if":{dialogAct:connection.ifCondition},then:connection.targetId}:{"if":{context:connection.ifCondition,op:connection.ifOperator,value:connection.value},then:connection.targetId},connection.connId===currConn.connId?_transitionObj.metadata={color:color,connId:connection.connId}:_transitionObj.metadata={color:connection.color,connId:connection.connId},_updateParams.transitions.push(_transitionObj)}),BTFlowtaskService.updateFlowtaskNodeInfo(_selectedStream._id,$scope.nodeInfo.dialogInfo.dialogId,$scope.nodeInfo.dialogNodeInstance.uId,_updateParams).then(function(res){$scope.dialogData("updateDialog",res&&res.data),currConn.color=color,finishSaving(".connectionRulesIcon")},function(error){if(finishSaving(".connectionRulesIcon","error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.saveIntent=function(e,intentForm,property){if($scope.readonly||intentForm.$invalid)return!1;var _payload={};if(e&&(13==e.keyCode||9==e.keyCode||"blur"==e.type)){if(e.preventDefault(),startSaving(".intentGeneralSettings"),property&&"name"===property){var _intentName=$(e.currentTarget).val();_payload={name:_intentName}}else{var _displayName=$scope.nodeInfo.dialogNodeInstance.intent;$scope.nodeInfo.dialogNodeInstance.intent&&(_displayName=$scope.nodeInfo.dialogNodeInstance.intent.trim().replace(/\s\s+/g," ")),_payload={intent:_displayName}}updateComponent(_payload,".intentGeneralSettings")}},$scope.saveIntentDesc=function(e){if($scope.readonly)return!1;if(13===e.keyCode||9===e.keyCode||"blur"===e.type){e.preventDefault(),startSaving(".intentGeneralSettings");var _payload={desc:$scope.nodeInfo.dialogNodeInstance.desc};updateComponent(_payload,".intentGeneralSettings")}},$scope.onInputKeyup=function(e,key){var _modalObj;_modalObj="label"===key?"nodeLabel":"authURL"===key?"nodeAuthURL":"nodeName";var _this=$(e.currentTarget);"label"!==key&&-1!==_this.val().indexOf(" ")?(_this.val(_this.val().replace(/\s/g,"")),$scope[_modalObj]=_this.val()):"authURL"===key?$scope[_modalObj]=_this.val():_selectedLanguage&&"en"===_selectedLanguage&&"label"!==key?(_this.val(_this.val().replace(/[^a-zA-Z- 0-9_]+/g,"")),$scope[_modalObj]=_this.val()):"label"===key?$scope[_modalObj]=_this.val():(_this.val(_this.val().replace(/\s/g,"")),$scope[_modalObj]=_this.val())},$scope.onInputKeyupIntent=function(e){var _this=$(e.currentTarget);-1!==_this.val().indexOf(" ")&&($scope.nodeInfo.dialogNodeInstance.intent=_this.val())},$scope.onRegExInputKeyup=function(e){var _this=$(e.currentTarget);-1!==_this.val().indexOf(" ")&&(_this.val(_this.val().replace(/\s/g,"")),$scope.nodeInfo.nodeInfo.regexPattern=_this.val())},$scope.saveEntitySynonyms=function(nv){setTimeout(function(){var _payload={synonyms:{}};_payload.synonyms=$scope.props.synonyms,startSaving(".entitySynonym"),BTFlowtaskService.updateComponentSynonyms($scope.stream._id,$scope.nodeInfo.nodeInfo._id,_payload).then(function(res){mixpanelEvent("createEntitySynonyms"),addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId),res&&res.data&&($scope.nodeInfo.nodeInfo=$scope.component=res.data,$scope.dialogData("updateComponent",res.data)),finishSaving(".entitySynonym")},function(error){if(finishSaving(".entitySynonym"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},200)};var cbBridge={};cbBridge.onBotUpdate=function(botData){botData&&($scope.stream=botData),botData&&botData.synonyms&&($scope.props.botSynonyms=botData.synonyms||{})},$scope.canShowBotSynonymsForKey=function(key){return _.contains($scope.nodeInfo.dialogNodeInstance.intent,key)},$scope.addBotSynonyms=function(){return $scope.readonly?!1:void $modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-add-synonyms/bt-add-synonyms.html",controller:"BTAddSynonymsCtrl",backdrop:"static",resolve:{config:function(){return{cbBridge:cbBridge,parentSynonyms:$scope.props.botSynonyms,isFromPP:!0}}}})},$scope.isEmpty=function(obj){return obj&&Object.keys(obj).length?!0:!1},$scope.saveBotSynonms=function(key){startSaving(".entityBotSynonyms"),setTimeout(function(){BTStreamsService.postSynonyms($scope.stream._id,{synonyms:$scope.props.botSynonyms}).then(function(res){$workflowService.selectedStream(res.data),$scope.stream=res.data,finishSaving(".entityBotSynonyms")},function(error){if(finishSaving(".entityBotSynonyms"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},200)},$scope.isEmptyUttrences=function(key){if($scope.nodeInfo.nodeInfo.utterances&&$scope.nodeInfo.nodeInfo.utterances.length){var _hasUttrences=!0;return $scope.nodeInfo.nodeInfo.utterances.forEach(function(utterance){utterance&&""!==utterance.sentence&&(_hasUttrences=!1)}),_hasUttrences}return!0},$scope.deleteSynonym=function(key){function deleteSynonym(){var _synonyms=$workflowService.cloneData($scope.stream.synonyms);delete _synonyms[key],BTStreamsService.postSynonyms($scope.stream._id,{synonyms:_synonyms}).then(function(res){$workflowService.selectedStream(res.data),delete $scope.props.botSynonyms[key]},function(err){var msg=getErrorMsg(err,i18n.i18nString("synonyms_deleted"));NotificationService.notify(msg,"error")})}NotificationService.alert(i18n.i18nString("delete_synonyms"),deleteSynonym,[$scope.stream._id,null,null,!0])},$scope.deleteBotSynonym=function(key){return $scope.readonly?!1:void $scope.deleteSynonym(key)},$scope.uploadLookUpFile=function(e,scope){var _ext;if($scope.fileToUpload=scope.fileToUpload,$scope.fileToUpload.name&&(_ext=$scope.fileToUpload.name.substring($scope.fileToUpload.name.lastIndexOf(".")),_ext=_ext.substring(_ext.lastIndexOf(".")+1),"json"!==_ext&&"csv"!==_ext))return void NotificationService.notify(i18n.i18nString("upload_only_csv_json_error_noty"),"error");var reader=new FileReader;reader.readAsText($scope.fileToUpload),reader.onload=function(e){var jsonData=reader.result;if(!jsonData||jsonData&&!jsonData.length)NotificationService.notify(i18n.i18nString("upload_valid"),"error"),$scope.fileEmptyError=!0;else{$scope.isWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("uploading");var data=new FormData;data.append("file",$scope.fileToUpload),data.append("fileExtension",_ext),data.append("fileContext","bulkImport"),data.append("Content-Type","json"===_ext?"application.json":"txt/csv"),BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:response.data.fileId,fileType:_ext};$scope.loaderMessage=i18n.i18nString("importing"),$scope.uploadedFile=fileUploaded,NotificationService.notify(i18n.i18nString("fileuploaded",{fileToUpload:$scope.fileToUpload.name}),"success"),$scope.closeListOfValuesModal(!0),angular.element("#file-upload").val("")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("oops")+error.statusText,"error");$scope.isWorkProgress=!1,angular.element("#file-upload").val("")})}}},$scope.$watch("props.patterns",function(nv,ov){var diffAB=_.difference(nv,ov),diffBA=_.difference(ov,nv);(diffAB.length||diffBA.length)&&""!==diffAB[0]&&$scope.nodeInfo.nodeInfo._id&&BTFlowtaskService.updateComponentPatterns($scope.stream._id,$scope.nodeInfo.nodeInfo._id,{patterns:nv}).then(function(res){if(mixpanelEvent("createPattern"),res&&res.data){addLocalProperties(res.data),"intent"===res.data.type&&$scope.nodeInfo.nodeInfo.dialogRefId&&!res.data.dialogRefId&&(res.data.dialogRefId=$scope.nodeInfo.nodeInfo.dialogRefId);var utterances=[];$scope.nodeInfo.nodeInfo.utterances&&(utterances=$scope.nodeInfo.nodeInfo.utterances),$scope.nodeInfo.nodeInfo=$scope.component=res.data,$scope.nodeInfo.nodeInfo.utterances=utterances,NotificationService.notify(i18n.i18nString("patrn_module_pattern_updated_success"),"success"),$scope.dialogData("updateComponent",res.data)}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},!0),$scope.$watch("nodeObj",function(nodeObj){""===nodeObj?$scope.nodeObjList={}:"object"==typeof nodeObj?$scope.nodeObjList=nodeObj:($scope.nodeObjList=JSON.parse(nodeObj),$scope.getNodes($scope.nodeInfo.nodeInfo),$scope.getTransitionNodes($scope.nodeInfo))}),$scope.closeListOfValuesModal=function(fromUpload){var payload={};if("list_of_items_lookup"===$scope.nodeInfo.nodeInfo.entityType){if("remote"===$scope.listOfValues.listOfValuesModel){if(""===$scope.props.endPoint.requestUrl)return NotificationService.notify(i18n.i18nString("provide_request_url"),"error"),$scope.saveInProgress=!1,void($scope.testInProgress=!1);var _payload={};return _payload.headers={type:"raw",value:JSON.stringify(deProcessUIHeaders($scope.props.params))},_payload.payload={type:"raw",value:$scope.props.rawParams?encodeURIComponent($scope.props.rawParams):""},_payload.endPoint=deProcessUIEndPoint($scope.props.endPoint.requestUrl,$scope.endPoint.method),_payload.endPoint.connectorEnabled=$scope.props.endPoint.connectorEnabled,_payload.endPoint.piiDataEnabled=$scope.piiDataEnabled.status,_payload.idp=$scope.newAuth.selected&&$scope.newAuth.selected.name||"none",_payload.subType=$scope.listOfValues.listOfValuesModel,_payload.authRequired="none"===_payload.idp?!1:!0,$scope.dropDownInfo.contextDropdownVals.contextVal?(_payload.allowedValues={variable:$scope.dropDownInfo.contextDropdownVals.contextVal,titleKey:$scope.dropDownInfo.contextDropdownVals.contextTitleKey,valueKey:$scope.dropDownInfo.contextDropdownVals.contextValKey,synonymsKey:$scope.dropDownInfo.contextDropdownVals.contextSynonymsKey,indexKey:$scope.dropDownInfo.contextDropdownVals.contextWordIndex},_payload.spellcorrectThreshold=$scope.autoCorrectThresholdEnum,_payload.entityType=$scope.nodeInfo.nodeInfo.entityType,"ge"==$scope.currentLanguage&&(_payload.definiteThreshold=$scope.obj.confidenceConfig[0].definiteThreshold,_payload.minThreshold=$scope.obj.confidenceConfig[0].minThreshold,_payload.isMultiLangDetectionEnabled=$scope.lovObj.isMultiLangDetectionEnabled||!1),void BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){$scope.component=res.data,mixPanelUpdateEvent(),$scope.nodeInfo.nodeInfo=$scope.component,$scope.dialogData("updateComponent",res.data),NotificationService.notify(i18n.i18nString("saved"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})):(NotificationService.notify(i18n.i18nString("provide_map_response"),"error"),$scope.saveInProgress=!1,void($scope.testInProgress=!1))}payload={importType:"update",delimiter:",",streamId:$scope.stream._id};var successMessage=fromUpload?i18n.i18nString("imported"):i18n.i18nString("saved"),invalid=!1,notValidSyn=!1,notValidJson=!1;angular.extend(payload,$scope.uploadedFile);var jsonData=$workflowService.cloneData($scope.lookup.jsonData);if(!_.isEmpty(jsonData)&&!fromUpload){if(jsonData=_.map(jsonData,function(data){try{(0===data.title.length||0===data.value.length)&&(invalid=!0,notValidJson=!0)}catch(e){invalid=!0,notValidJson=!0}if("string"==typeof data.synonyms)if("<"==data.synonyms[0]&&">"==data.synonyms[data.synonyms.length-1]){var tempSyn=[];notValidSyn||(notValidSyn=/['||"||*]/.test(data.synonyms)),tempSyn.push(data.synonyms),data.synonyms=tempSyn}else data.synonyms=data.synonyms.split(","),data.synonyms=data.synonyms.map(function(eachSynonym){return"<"==eachSynonym[0]&&">"==eachSynonym[eachSynonym.length-1]&&(notValidSyn||(notValidSyn=/['||"||*]/.test(eachSynonym))),eachSynonym.trim()});return data}),payload.userJSONArray=$workflowService.cloneData(jsonData),notValidJson)return void NotificationService.notify(i18n.i18nString("not_valid_json_structure_for_lov_lookup"),"warning");if(notValidSyn)return void NotificationService.notify(i18n.i18nString("special_char_allows"),"warning");if(invalid)return void NotificationService.notify(i18n.i18nString("req_fields"),"error")}if(_.isUndefined(payload.userJSONArray)&&_.isUndefined($scope.uploadedFile))NotificationService.notify(i18n.i18nString("one_entity"),"error");else{var _payloadCop={importInfo:payload,subType:$scope.listOfValues.listOfValuesModel,spellcorrectThreshold:$scope.autoCorrectThresholdEnum,entityType:$scope.nodeInfo.nodeInfo.entityType};"ge"===$scope.currentLanguage&&(_payloadCop.definiteThreshold=$scope.obj.confidenceConfig[0].definiteThreshold,_payloadCop.minThreshold=$scope.obj.confidenceConfig[0].minThreshold,_payloadCop.isMultiLangDetectionEnabled=$scope.lovObj.isMultiLangDetectionEnabled),updateComponent(_payloadCop,void 0,{message:successMessage,getLookup:!0})}}else"staticList"===$scope.dropDownInfo.staticDropdownType?saveStaticDropDownValues():saveContextDropDownValues()},$scope.closeModal=function(){$element.find("#List_of_values").modal("toggle"),angular.element(".flowTaskForm").hasClass("isRunBotOpen")||($scope.runBot.show=!0),$scope.runBot.hideSubBar=!1},$scope.autoGrowTextArea=function(e){var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.getDailogDataByRefID=function(id){$scope.dialogTaskList=$workflowService.dialogTasks();var dialog=_.find($scope.dialogTaskList,{refId:id});return dialog&&dialog.child&&dialog.child.length?dialog.child[0]:dialog},$scope.nodeInfo.nodeInfo&&$scope.nodeInfo.nodeInfo.dialogRefId&&($scope.thisDailog=$scope.getDailogDataByRefID($scope.nodeInfo.nodeInfo.dialogRefId)),$scope.upgrade=function(){BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,$scope.thisDailog._id).then(function(res){NotificationService.notify(i18n.i18nString("task_upgrade"),"success"),$.each($scope.dialogTaskList,function(i,task){task.refId===$scope.nodeInfo.nodeInfo.dialogRefId&&($scope.dialogTaskList[i].child=res.data)}),$workflowService.dialogTasks($scope.dialogTaskList),$scope.thisDailog=res.data,$scope.auto_grow($scope.currentEvent,$scope.currentUtt,$scope.currentEditIndex),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.auto_grow=function(e,utterance,index){if(13===e.keyCode&&!e.shiftKey){if(e.preventDefault(),!$scope.thisDailog||"published"!==$scope.thisDailog.state)return-1===index?$scope.createUtterance(utterance):$scope.saveUtterance(utterance,index),!1;$scope.currentUtt=utterance,$scope.currentEditIndex=index,$scope.currentEvent=e,NotificationService.alert(i18n.i18nString("publish_upgrade"),$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,"Upgrade")}var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.createUtterance=function(utterance){""!==utterance.sentence&&(startSaving(".defaultUtteranceSaveIcon"),$scope.createNewUtterance(utterance))},$scope.saveUtterance=function(utterance,index){""!==utterance.sentence&&(toggleUtteranceIcons("show",index),startSaving(".utteranceSaveSpin"+index),$scope.saveEditedUtterence(utterance,index))},$scope.deleteUtterance=function(utterance,index){return $scope.readonly?!1:void($scope.thisDailog&&"published"===$scope.thisDailog.state?($scope.currentUtt=utterance,$scope.currentEditIndex=index,NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("publish_upgrade"))):NotificationService.alert(i18n.i18nString("delete_utterance"),function(){toggleUtteranceIcons("show",index),startSaving(".utteranceSaveSpin"+index),$scope.deleteEditedUtterance(utterance,index)},{okText:i18n.i18nString("ok")}))},$scope.createNewUtterance=function(utterance){var payload={taskId:$scope.component._id,sentence:utterance.sentence,streamId:$scope.component.streamId,type:"DialogIntent"};BTStreamsService.createUtterances(payload).then(function(res){mixpanelEvent("createUtterance"),$scope.$emit("updateChecklist","machineLearningUtterances"),focusElement(".utteranceDataBoxDefault"),finishSaving(".defaultUtteranceSaveIcon"),setTimeout(function(){$scope.nodeInfo.nodeInfo.utterances[$scope.nodeInfo.nodeInfo.utterances.length]=res.data,$scope.utterancesCopy[$scope.utterancesCopy.length]=res.data,$element.find(".defaultUtteranceSaveIcon").removeClass("fa fa-check fa-times"),$scope.newUtterance.sentence=""},500),$scope.totalUtterancesCount=$scope.totalUtterancesCount+1},function(err){finishSaving(".defaultUtteranceSaveIcon","error"),err.data.errors.length>0&&409===err.data.errors[0].code&&err.data.errors[0].msg===i18n.i18nString("utterance_samename")?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_utterance"),"error")})},$scope.saveEditedUtterence=function(utterance,index){
var payload={taskId:$scope.component._id,sentence:utterance.sentence,streamId:$scope.component.streamId,type:"DialogIntent"};BTStreamsService.editUtterances(payload,utterance._id).then(function(res){finishSaving(".utteranceSaveSpin"+index),toggleUtteranceIcons("hide",index),$scope.utterancesCopy[index].sentence=utterance.sentence,focusElement(".utteranceDataBoxDefault"),NotificationService.notify(i18n.i18nString("save_utterance"),"success"),$scope.showTrainBtn=!0},function(err){409===err.status&&(utterance.sentence=$scope.utterancesCopy[index].sentence,NotificationService.notify(i18n.i18nString("duplicate_utterance"),"error")),finishSaving(".utteranceSaveSpin"+index,"error"),toggleUtteranceIcons("hide",index)})},$scope.deleteEditedUtterance=function(utterance,index){var payload={taskId:$scope.component._id,streamId:$scope.component.streamId,type:"DialogIntent"};BTStreamsService.deleteUtterances(payload,utterance._id).then(function(res){finishSaving(".utteranceSaveSpin"+index),toggleUtteranceIcons("hide",index),focusElement(".utteranceDataBoxDefault"),NotificationService.notify(i18n.i18nString("utterance_deleted"),"success"),$scope.utterancesCopy.splice(index,1),$scope.nodeInfo.nodeInfo.utterances.splice(index,1),setTimeout(function(){$scope.totalUtterancesCount=$scope.totalUtterancesCount-1,$scope.utterancePageChanged($scope.utterancePaginatinoOptions.currentPage,!0)},1e3),$scope.showTrainBtn=!0},function(err){finishSaving(".utteranceSaveSpin"+index,"error"),toggleUtteranceIcons("hide",index),NotificationService.notify(i18n.i18nString("utterance_delete_fail"),"error")})},$rootScope.$on("IntentUtterencesTrainFinished",function($event){finishSaving(".machineLearningLevelSave")}),$rootScope.$on("IntentUtterencesTrainFailed",function($event){finishSaving(".machineLearningLevelSave","error")}),$rootScope.$on("MLUtterencesTrainFinished",function($event){$scope.saveInprogress=!1}),$rootScope.$on("MLUtterencesTrainFailed",function($event){$scope.showTrainBtn=!0,$scope.saveInprogress=!1}),$scope.trainBot=function(){return $scope.saveInprogress?!1:($scope.saveInprogress=!0,$scope.showTrainBtn=!1,$scope.readonly?!1:(startSaving(".machineLearningLevelSave"),void BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$scope.saveInprogress=!0,$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open"),NotificationService.notify(i18n.i18nString("utterance_train"),"info")},function(err){$scope.saveInprogress=!1,finishSaving(".machineLearningLevelSave"),"RequestExists"===err.data.errors[0].code?NotificationService.notify(err.data.errors[0].code,"error"):NotificationService.notify(i18n.i18nString("utterences_training_intiated_err"),"error")})))},$scope.showUtteranceSaveTip=function(index){$element.find(".utteranceSaveTip"+index)&&"block"!==$element.find(".utteranceSaveTip"+index)[0].style.display?$element.find(".utteranceSaveTip"+index).css("display","block"):$element.find(".utteranceSaveTip"+index).css("display","none")},$scope.showPromptSaveTip=function(index,category){category=category||"",$element.find(".promptSaveTip"+category+index)&&"block"!==$element.find(".promptSaveTip"+category+index)[0].style.display?$element.find(".promptSaveTip"+category+index).css("display","block"):$element.find(".promptSaveTip"+category+index).css("display","none")},$scope.showSubmitPromptSaveTip=function(index,category){category=category||"",$element.find(".submitpPromptSaveTip"+index)&&"block"!==$element.find(".submitpPromptSaveTip"+index)[0].style.display?$element.find(".submitpPromptSaveTip"+index).css("display","block"):$element.find(".submitpPromptSaveTip"+index).css("display","none")},$scope.showErrorPromptSaveTip=function(index,category){category=category||"",$element.find(".errorPromptSaveTip"+category+index).length&&"block"!==$element.find(".errorPromptSaveTip"+category+index)[0].style.display?$element.find(".errorPromptSaveTip"+category+index).css("display","block"):$element.find(".errorPromptSaveTip"+category+index).length&&$element.find(".errorPromptSaveTip"+category+index).css("display","none")},$scope.initiateSliderRemote=function(){initializeSlider()},$scope.staticDropDownTypeChange=function(onLoad){var delay=onLoad?500:50;if("staticList"===$scope.dropDownInfo.staticDropdownType?$timeout(function(){angular.element(".listItemsMain .newListItem :input:eq(0)").focus()},delay):$timeout(function(){angular.element(".lookupBlock:eq(0) :input").focus()},delay),$scope.runBot.show=!1,$scope.dropDownInfo={staticDropdownType:"staticList",contextDropdownVals:{contextVal:"",contextValKey:"",contextTitleKey:"",contextSynonymsKey:"",contextWordIndex:""},staticDropdownVals:[]},$scope.getAuthList(),initListOfValues(),prepareSliders(),initializeSlider(),$scope.lookup.jsonData=$workflowService.cloneData(savedLookupData),$scope.runBot.hideSubBar=!0,"edit"!==$scope.nodeInfo.displayMode&&setTimeout(function(){$("#lookupEditor .ace_scroller").addClass("isReadOnly"),$("#lookupEditor .ace_content").addClass("isReadOnly"),$("#lookupEditor .ace_scrollbar-v").on("scroll",function(){$("#lookupEditor .ace_scroller").addClass("isReadOnly"),$("#lookupEditor .ace_content").addClass("isReadOnly")})},500),$scope.listOfValues={listOfValuesModel:$scope.component.subType||"static"},$scope.paramsBody={},$scope.component&&$scope.component.headers&&$scope.component.headers.value)try{var _headerObj=$scope.component.headers.value;_headerObj=JSON.parse(_headerObj),_headerObj&&_headerObj["Content-Type"]&&"application/json"===_headerObj["Content-Type"]?$scope.paramsBody.value="application/json":_headerObj&&_headerObj["Content-Type"]&&"urlencoded"===_headerObj["Content-Type"]?$scope.paramsBody.value="urlencoded":_headerObj&&_headerObj["Content-Type"]&&"applicationXML"===_headerObj["Content-Type"]&&($scope.paramsBody.value="applicationXML")}catch(error){$scope.paramsBody.value="custom"}else $scope.paramsBody.value="custom";if($scope.endPoint={method:"get"},$scope.props.params=[],$scope.props.headers=[],$scope.props.rawParams=[],$scope.props.endPoint={},$scope.props.params.push({key:"",value:""}),$scope.props.headers.push({key:"",value:""}),$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.props.endPoint.connectorEnabled=!1,$scope.piiDataEnabled={},$scope.props.endPoint.requestUrl=processUIEndPoint($scope.component.endPoint),$scope.props.endPoint.requestUrl&&($scope.appendingParamsToInput(),$scope.props.headers.push({key:"",value:""})),$scope.props.rawParams=deProcessUIHeaders($scope.props.params),$scope.piiDataEnabled.status=$scope.component.endPoint&&$scope.component.endPoint.piiDataEnabled||!1,$scope.props.endPoint.connectorEnabled=$scope.component.endPoint&&$scope.component.endPoint.connectorEnabled||!1,$scope.endPoint.method=$scope.component.endPoint&&$scope.component.endPoint.method.toLowerCase()||"get",$scope.component.headers&&($scope.props.params=processUIHeaders($scope.component.headers),$scope.props.params.push({key:"",value:""})),$scope.component.sampleResponse)for(var i=0;i<$scope.component.sampleResponse.length;i++)if($scope.component.sampleResponse[i].isDefault){if($scope.sampleResponseIndex=i,$scope.lookupRemote.jsonData=$scope.component.sampleResponse[i].response,"string"==typeof $scope.lookupRemote.jsonData)try{$scope.lookupRemote.jsonData=JSON.parse($scope.lookupRemote.jsonData)}catch(e){$scope.lookupRemote.jsonData={}}break}BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,$scope.stream._id).then(function(res){$scope.getAllVariables=res.data.variables},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_fetch_var"),"error")}),$timeout(function(){$scope.props.rawParams=$scope.component.payload&&$scope.component.payload.value?decodeURIComponent($scope.component.payload.value):""},200)},$scope.deleteHeaders=function(index){$scope.props.params.splice(index,1)},$scope.deleteParams=function(index){$scope.props.headers.splice(index,1)},$scope.onNewJsonValChange=function(e){var delay;$scope.newJsonValue.title.length&&(0===$scope.newJsonValue.value.length&&($scope.newJsonValue.value=$scope.newJsonValue.title),0===$scope.newJsonValue.synonyms.length&&($scope.newJsonValue.synonyms=$scope.newJsonValue.title),(_.isUndefined($scope.lookup.jsonData)||!_.isArray($scope.lookup.jsonData))&&($scope.lookup.jsonData=[]),$scope.lookup.jsonData.push($scope.newJsonValue),$scope.lookup.jsonData.length>$scope.paginationOptions.itemsPerPage&&(delay=0,$scope.lookup.jsonData.length%$scope.paginationOptions.numberOfPages===0&&(delay=100),$timeout(function(){$scope.paginationOptions.currentPage=$scope.paginationOptions.numberOfPages},delay)),$timeout(function(){angular.element(".lookuplistItemsBlocks:last-child :input:eq(2)").focus()},100),addNewKeyVal(!0))},$scope.editorCallback.onBlur=function(editor){""===editor.getText()&&($scope.lookup.jsonData=[])},$scope.updateJsonData=function(){$scope.$broadcast("updateJsonData",$scope.lookup.jsonData)},$scope.removeJsonValue=function(index){index>=0&&index<$scope.lookup.jsonData.length&&$scope.lookup.jsonData.splice(index,1),$scope.updateJsonData()},$scope.pageChanged=function(){$scope.paginationOptions.currentPage===$scope.paginationOptions.numberOfPages&&$timeout(function(){$scope.updatePerfectScrollbar($("#lookupEditor"))})},$scope.utterancePageChanged=function(index,_frmDelete){var _searchQuery="";$scope.totalUtterancesCount===10*index&&_frmDelete&&(index-=1),$scope.utteranceSearch&&$scope.utteranceSearch.utteranceSearchQuery&&(_searchQuery=$scope.utteranceSearch.utteranceSearchQuery),BTStreamsService.getUtterances($scope.component._id,10*(index-1),10,_searchQuery).then(function(res){$scope.cb.updateUtterance(res)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("getting_utterance"),"error")})},$scope.classToTabContent=!1,$(document).off("click",".listOfValMain .markupTabs .nav-tabs li").on("click",".listOfValMain .markupTabs .nav-tabs li",function(){$timeout(function(){$(".lookupListItemsmain").is(":visible")?$(".tab-content").addClass("btmBottom"):$(".tab-content").removeClass("btmBottom")},100)}),$scope.auto_grow_prompts=function(e,index){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createPrompt(index):$scope.saveEditPrompts(index),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_error_prompts=function(e,index){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createErrorPrompt(index):$scope.saveEditErrorPrompts(index),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_submit_prompts=function(e,index){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createSubmitPrompt(index):$scope.saveEditSubmitPrompts(index),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_category_prompts=function(e,index,category){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createCategoryPrompt(index,category):$scope.saveCategoryEditPrompts(index,category),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.auto_grow_error_category_prompts=function(e,index,category){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;if(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)return e.preventDefault(),-1===index?createCategoryErrorPrompt(index,category):$scope.saveCategoryEditErrorPrompts(index,category),!1;var element=e.target;element.style.overflow="hidden",element.style.height="0",element.style.height=element.scrollHeight+3+"px"},$scope.saveEditErrorPrompts=function(index){""!==$scope.userErrorPromptsCopy[index].text?(toggleErrorPromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorPromptMessages($scope.userErrorPromptsCopy,index,!1)):NotificationService.notify(i18n.i18nString("errpr_prompt"),"error")},$scope.deleteEditErrorPrompts=function(index,type){NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&$scope.userErrorPromptsCopy[index]){var _standardPromptMessageCount=$scope.userErrorPromptsCopy.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)toggleErrorPromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorPromptMessages($scope.userErrorPromptsCopy,index,!0);else{if("default"===$scope.userErrorPromptsCopy[index].channel)return NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("allchannel_res"):i18n.i18nString("allchannel_msg"),"error"),!1;toggleErrorPromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorPromptMessages($scope.userErrorPromptsCopy,index,!0)}}},{okText:i18n.i18nString("ok")})},$scope.deleteEditSubmitPrompts=function(index,type){NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&$scope.submitMessagesCopy[index]){var _standardPromptMessageCount=$scope.submitMessagesCopy.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)toggleErrorPromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorPromptMessages($scope.submitMessagesCopy,index,!0);else{if("default"===$scope.submitMessagesCopy[index].channel)return NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("allchannel_res"):i18n.i18nString("allchannel_msg"),"error"),!1;toggleErrorPromptsIcons("show",index),startSaving(".errorPromptSaveSpin"+index),saveErrorPromptMessages($scope.submitMessagesCopy,index,!0)}}},{okText:i18n.i18nString("ok")})},$scope.saveEditPrompts=function(index){""!==$scope.userPromptsCopy[index].text?(togglePromptsIcons("show",index),startSaving(".promptSaveSpin"+index),saveUserPromptMessages($scope.userPromptsCopy,index,!1)):NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_prompt"):i18n.i18nString("prompt_empty"),"error")},$scope.saveEditSubmitPrompts=function(index){""!==$scope.submitMessagesCopy[index].text?(togglePromptsIcons("show",index),startSaving(".submitPromptSaveSpin"+index),saveSubmitPromptMessages($scope.submitMessagesCopy,index,!1)):NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("bot_prompt"):i18n.i18nString("prompt_empty"),"error")},$scope.saveCategoryEditPrompts=function(index,category){var filterObj=$scope.multiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.message[index].text?(togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryPromptMessages(filterObj.message,index,!1,category,filterObj)):NotificationService.notify(i18n.i18nString("prompt_empty"),"error")},$scope.saveCategoryEditErrorPrompts=function(index,category){var filterObj=$scope.multiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],""!==filterObj.errorMessage[index].text?(toggleErrorPromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorPromptMessages(filterObj.errorMessage,index,!1,category,filterObj)):NotificationService.notify(i18n.i18nString("prompt_empty"),"error")},$scope.deleteEditCategoryPrompts=function(index,type,category){var filterObj=$scope.multiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&filterObj.errorMessage[index]){var _standardPromptMessageCount=filterObj.errorMessage.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryPromptMessages(filterObj.errorMessage,index,!0,category,filterObj);else{if("default"===filterObj.errorMessage[index].channel)return NotificationService.notify(i18n.i18nString("atleast_one_prompt"),"error"),!1;togglePromptsIcons("show",index,category),startSaving(".promptSaveSpin"+category+index),saveUserCategoryPromptMessages(filterObj.errorMessage,index,!0,category,filterObj)}}},{okText:i18n.i18nString("ok")})},$scope.deleteEditCategoryErrorPrompts=function(index,type,category){var filterObj=$scope.multiCategoryPromptsCopy.filter(function(e){return e.category==category});filterObj=filterObj[0]||[],NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&filterObj.errorMessage[index]){var _standardPromptMessageCount=filterObj.errorMessage.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)toggleErrorPromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorPromptMessages(filterObj.errorMessage,index,!0,category,filterObj);else{if("default"===$scope.userErrorPromptsCopy[index].channel)return NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("allchannel_res"):i18n.i18nString("allchannel_msg"),"error"),!1;toggleErrorPromptsIcons("show",index,category),startSaving(".errorPromptSaveSpin"+category+index),saveCategoryErrorPromptMessages(filterObj.errorMessage,index,!0,category,filterObj)}}},{okText:i18n.i18nString("ok_uppercase")})},$scope.deleteSubmitPrompts=function(index,type){NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&$scope.submitMessagesCopy[index]){var _standardPromptMessageCount=$scope.submitMessagesCopy.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)togglePromptsIcons("show",index),saveSubmitPromptMessages($scope.submitMessagesCopy,index,!0);else{if("default"===$scope.submitMessagesCopy[index].channel)return NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("allchannel_res"):i18n.i18nString("allchannel_msg"),"error"),!1;togglePromptsIcons("show",index),saveSubmitPromptMessages($scope.submitMessagesCopy,index,!0)}}},{okText:i18n.i18nString("ok")})},$scope.deleteEditPrompts=function(index,type){NotificationService.alert(i18n.i18nString("delete_type",{type:type}),function(){if(!$scope.readonly&&$scope.userPromptsCopy[index]){var _standardPromptMessageCount=$scope.userPromptsCopy.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)togglePromptsIcons("show",index),"submit message"===type?(startSaving(".submitPromptSaveSpin"+index),saveSubmitPromptMessages($scope.userPromptsCopy,index,!0)):(startSaving(".promptSaveSpin"+index),saveUserPromptMessages($scope.userPromptsCopy,index,!0));else{if("default"===$scope.userPromptsCopy[index].channel)return NotificationService.notify("message"===$scope.nodeInfo.nodeInfo.type?i18n.i18nString("allchannel_res"):i18n.i18nString("allchannel_msg"),"error"),!1;togglePromptsIcons("show",index),"submit message"===type?(startSaving(".submitPromptSaveSpin"+index),saveSubmitPromptMessages($scope.userPromptsCopy,index,!0)):(startSaving(".promptSaveSpin"+index),saveUserPromptMessages($scope.userPromptsCopy,index,!0))}}},{okText:i18n.i18nString("ok")})},$scope.cancelUnsavedGrammar=function(){$scope.hasUnsavedConnections=!1,$scope.nodeInfo.nodeInfo.ivrOptions&&$scope.nodeInfo.nodeInfo.ivrOptions.grammars&&($scope.nodeInfo.nodeInfo.ivrOptions.grammars=$workflowService.cloneData($scope.originalIvrGrammerCopy))},$scope.capitalizeFirstLetter=function(string){return string.charAt(0).toUpperCase()+string.slice(1)},setTimeout(function(){$(".accordion-toggle").click(function(event){$(".tab-content").animate({scrollTop:event.currentTarget.offsetTop-300},1e3)})},2e3),$scope.entityInstancePropertyCB.updateDialog=function(data){$scope.dialogData("updateDialog",data)},$scope.entityInstancePropertyCB.editPrompt=function(msg,index,category){$scope.editPrompt(msg,!0,index,category,!0)},$scope.entityInstancePropertyCB.editError=function(msg,index,category){$scope.editError(msg,index,category,!0)},$scope.entityInstancePropertyCB.updateNodeInfo=function(data){data&&data.hasOwnProperty("errorPromptSequencing")&&updateComponent(data,".entityGeneralSettings")},$scope.nodeList=[],$scope.saveIVRMaxNoSubOptsChange=function(){$timeout(function(){saveIVRMaxNo(!0)},500)},$scope.saveIVRMaxNo=function(){$scope.flowtaskObj&&"published"!==$scope.flowtaskObj.state&&saveIVRMaxNo()},$scope.saveLocalIVRMaxNo=function(){$scope.maxRetry.ref=""},$scope.executeServiceForRemote=function(){$scope.testInProgress=!0,$scope.statusCode="",$scope.saveRequest(!0,!0)},$scope.saveRequest=function(silent,triggerTest){$timeout(function(){var _payload={};_payload.headers={type:"raw",value:JSON.stringify(deProcessUIHeaders($scope.props.params))},_payload.payload={type:"raw",value:$scope.props.rawParams?encodeURIComponent($scope.props.rawParams):""},_payload.endPoint=deProcessUIEndPoint($scope.props.endPoint.requestUrl,$scope.endPoint.method),_payload.endPoint.connectorEnabled=$scope.props.endPoint.connectorEnabled,_payload.endPoint.piiDataEnabled=$scope.piiDataEnabled.status,_payload.idp=$scope.newAuth.selected&&$scope.newAuth.selected.name||"none",_payload.authRequired="none"===_payload.idp?!1:!0,_payload.allowedValues={variable:$scope.dropDownInfo.contextDropdownVals.contextVal,titleKey:$scope.dropDownInfo.contextDropdownVals.contextTitleKey,valueKey:$scope.dropDownInfo.contextDropdownVals.contextValKey,synonymsKey:$scope.dropDownInfo.contextDropdownVals.contextSynonymsKey,indexKey:$scope.dropDownInfo.contextDropdownVals.contextWordIndex},_payload.spellcorrectThreshold=$scope.autoCorrectThresholdEnum,_payload.entityType=$scope.nodeInfo.nodeInfo.entityType,"ge"===$scope.currentLanguage&&(_payload.definiteThreshold=$scope.obj.confidenceConfig[0].definiteThreshold,_payload.minThreshold=$scope.obj.confidenceConfig[0].minThreshold,_payload.isMultiLangDetectionEnabled=$scope.lovObj.isMultiLangDetectionEnabled),saveToServer(_payload,silent,triggerTest)},100)},$scope.checkIdpAndExecuteAPI=function(account){function callTestRequest(){testRequest()}var _idpName=$scope.newAuth&&$scope.newAuth.selected&&$scope.newAuth.selected.name;_idpName&&"none"!==_idpName.toLowerCase()?BTIdpService.getIdpByName(_idpName,$workflowService.selectedStream()._id).then(function(res){var idpConfig=res.data;if(idpConfig=idpConfig||{},idpConfig.type="idp",idpConfig.testFor="idp",idpTestListenersRegistration(callTestRequest),account)callTestRequest();else{var data={isFromtestReq:!0};$scope.btTestFormApi.serviceNodeTestInfo(data),$scope.btTestFormApi.init(idpConfig)}},function(err){NotificationService.notify(i18n.i18nString("failed_fetch_idp"),"error"),$scope.idpConfig={}}):callTestRequest()},$scope.sampleResponseBtn=function(){var _payload={};if($scope.resSaveInProgress=!0,!$scope.component.sampleResponse||!$scope.component.sampleResponse.length){$scope.component.sampleResponse=[];var _obj={};_obj.name="sampleResponse",_obj.isDefault=!0,$scope.component.sampleResponse.push(_obj)}$scope.component.sampleResponse[$scope.sampleResponseIndex].response=JSON.stringify($scope.lookupRemote.jsonData),_payload.sampleResponse=$scope.component.sampleResponse,BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&(mixPanelUpdateEvent(),$scope.dialogData("updateComponent",res.data),NotificationService.notify(i18n.i18nString("saved_successfully"),"success")),$scope.resSaveInProgress=!1},function(){$scope.resSaveInProgress=!1})},$scope.toggleAcc=function(){$(".ContextValuesArrow").toggleClass("ContextValuesDownArrow")},$scope.updateContextParams=function(index){$scope.props.contextParams=arrayToKeyValueArray(getContextParams());for(var splittedContextKey=[],i=0;i<$scope.props.contextParams.length;i++)splittedContextKey[i]=$scope.props.contextParams[i].key.split("."),splittedContextKey[i][0]="content"===splittedContextKey[i][0]?"locale":splittedContextKey[i][0];$timeout(function(){for(var i=0;i<splittedContextKey.length;i++){var contextParamVal=$scope.getAllVariables.filter(function(v){return v.variableType===splittedContextKey[i][0]&&v.key===splittedContextKey[i][1]});!contextParamVal[0]||!contextParamVal[0].value||"hidden"===contextParamVal[0].scope&&$scope.isChildBot||($scope.props.contextParams[i].value=contextParamVal[0].value)}},250)},$scope.$watch("props.endPoint.requestUrl",function(newVal,oldVal){$scope.updateContextParams()}),$scope.searchUtterance=function(event){if($scope.searching=!0,13==event.keyCode||!$scope.utteranceSearch.utteranceSearchQuery){var offset=0,limit=10;BTStreamsService.getUtterances($scope.nodeInfo.nodeInfo._id,offset,limit,$scope.utteranceSearch.utteranceSearchQuery).then(function(response){$scope.nodeInfo.nodeInfo.utterances=response.data.Sentences,$scope.totalUtterancesCount=response.data.count,$scope.utteranceSearch.utteranceSearchQuery||($scope.utteranceSearch.utteranceSearchQuery="",$scope.searching=!1)})}},$scope.clearSearch=function(){$scope.utteranceSearch.utteranceSearchQuery="",getUtterances(),$scope.searching=!1},$scope.focusOnMessage=function(className,item,fromadd,edit){$scope.createAndEditContextVAriables(className,item,fromadd,edit)},$scope.createAndEditContextVAriables=function(className,item,fromadd,edit){if(item&&""!==item.key&&""!==item.value){var _result=$scope.contextVariablesArray.filter(function(elem){return elem.key===item.key});if(_result.length>1)NotificationService.notify(i18n.i18nString("key_exist"),"error");else{if(startSaving(className),fromadd){var newItem=JSON.parse(JSON.stringify(item));$scope.contextVariablesArray.push(newItem)}convertArrayToObject($scope.contextVariablesArray,function(convertedToObject){var contextMap=$workflowService.cloneData(convertedToObject),payload={name:$scope.nodeInfo.nodeInfo.name,contextMap:JSON.stringify(contextMap)};console.log(payload),BTFlowtaskService.updateComponent($scope.stream._id,$scope.nodeInfo.nodeInfo._id,payload).then(function(res){console.log(res),mixPanelUpdateEvent(),$scope.dialogData("updateComponent",res.data),finishSaving(className),fromadd&&($scope.initialMessageCustomTag.key="",$scope.initialMessageCustomTag.value=""),"edit"===edit?NotificationService.notify(i18n.i18nString("context_update"),"success"):NotificationService.notify(i18n.i18nString("context_success"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})})}}else if(item&&(""===item.key||""===item.value)){var _msg=i18n.i18nString("key_value_mandatory");NotificationService.notify(_msg,"error")}},$scope.editMessage=function(e,className,item,fromadd,edit){13===e.keyCode&&$scope.createAndEditContextVAriables(className,item,fromadd,edit)},$scope.deleteMessage=function(index,className){function confirmDeleteCustomMessage(){startSaving(className),$scope.contextVariablesArray.splice(index,1),convertArrayToObject($scope.contextVariablesArray,function(convertedObj){var contextMap=$workflowService.cloneData(convertedObj),payload={name:$scope.nodeInfo.nodeInfo.name,contextMap:JSON.stringify(contextMap)};BTFlowtaskService.updateComponent($scope.stream._id,$scope.nodeInfo.nodeInfo._id,payload).then(function(res){console.log(res),mixPanelUpdateEvent(),$scope.dialogData("updateComponent",res.data),finishSaving(className),NotificationService.notify(i18n.i18nString("context_delete"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}})})}var msg=i18n.i18nString("delete_context_variable");NotificationService.alert(msg,confirmDeleteCustomMessage,{okText:i18n.i18nString("ok_label")})},$scope.deleteBlock=function(connection,i){connection.tests?connection.tests.length>1?(connection.tests.splice(i,1),1==connection.tests.length&&(connection.conditionAnd=!0,connection.conditionOr=!0)):(connection.tests[i]={context:"",op:"",value:""},connection.conditionAnd=!0,connection.conditionOr=!0):(connection.ifCondition="",connection.value=""),$scope.hasUnsavedConnection=!0},$scope.addCondition=function(connection,val){if($scope.hasUnsavedConnection=!0,$scope.andOrConditionSelected=!0,!connection.tests){var connectionObj={context:connection.ifCondition,op:connection.ifOperator,value:connection.value};connection.tests=[],connection.tests.push(connectionObj)}"and"===val?(connection.conditionAnd=!0,connection.conditionOr=!1):(connection.conditionAnd=!1,connection.conditionOr=!0,connection.orSelected=!0);var newConnectionObj={context:"",op:"",value:""};connection.tests.push(newConnectionObj)},$scope.options={mode:"view"===$scope.displayMode?"view":"code",ace:window.ace};var getDefaultSampleRules=function(){var contextUrl=window.appConfig.CONTEXT_PATH;$http.get(contextUrl+"/resources/entity_sample_rules.json").then(function(response){response&&response.data&&($scope.placeholderText=JSON.stringify(response.data[$scope.nodeInfo.nodeInfo.entityType]),$scope.showRuleEditor=!0)})};$scope.entityRuleEditor=function(){$scope.showEntityModal=!0,getDefaultSampleRules(),$timeout(function(){if($scope.modalSlider.open("#entityRuleConfigurations"),$scope.nodeInfo.dialogNodeInstance.nodeOptions.entityRules)$scope.$broadcast("updateJsonData",$scope.nodeInfo.dialogNodeInstance.nodeOptions.entityRules);else{var _defaultValue={};$scope.$broadcast("updateJsonData",_defaultValue)}})},$scope.closeEntityRule=function(){$scope.showEntityModal=!1,$scope.showRuleEditor=!1,$scope.modalSlider.close("#entityRuleConfigurations"),$scope.entityRules.rules=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.entityRules)};var validateJson=function(value){try{JSON.parse(value)}catch(e){return!1}return!0};$scope.updateEntityRules=function(entityRules){$scope.nodeInfo.dialogNodeInstance.nodeOptions.entityRules=entityRules.rules||{};var editorValue=$scope.editorCallback.getEditorValue(),validity=validateJson(editorValue);validity?$scope.onRequiredToggleChange(null,"entityRules"):NotificationService.notify("Invalid JSON syntax","error")},$scope.editorCallback.attachPlaceHolder=function(args){if(args.ele&&args.ele.parent().hasClass("entityRuleEditor")&&validateJson(args.editorValue)){var ele,editorValue=Object.keys(JSON.parse(args.editorValue)),placeHolderRefEle=$("#entityRuleConfigurations .ace_content").find(".ace_layer:last").next();editorValue.length?(ele=$("#entityRuleConfigurations .ace_content").find(".placeholderText"),ele.remove()):placeHolderRefEle.hasClass("placeholderText")||(ele=document.createElement("div"),
ele.innerHTML=$scope.placeholderText,$(ele).addClass("placeholderText"),$("#entityRuleConfigurations .ace_content").find(".ace_layer:last").after(ele))}},$scope.trainEntityRules=function(){$scope.trainStatus={success:!1,saving:!0,failed:!1},BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$scope.saveInprogress=!0,$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$broadcast("startTimer"),$rootScope.$broadcast("getProgressDockStatus"),NotificationService.notify(i18n.i18nString("bot_train"),"info")},function(err){$scope.trainStatus={success:!1,saving:!1,failed:!0},err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})},$scope.supportedEntityRules=function(nodeInfo){var entity=_.find(_constants_.entityNlp,{value:nodeInfo.nodeInfo.entityType});return entity&&entity.supportEntity?!0:!1},$rootScope.$on("isMlInSyncWithEntityRules",function(event){$scope.trainStatus={success:!0,failed:!1,saving:!1}}),$scope.setEventOptions=function(className){$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions?$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions.defaultMaxRetry=$workflowService.cloneData($scope.defaultMaxRetry):($scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions={},$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions.defaultMaxRetry=$workflowService.cloneData(_defaultMaxRetry)),$scope.onRequiredToggleChangeOptions(className,$scope.prompt.promptOptions)},$scope.setDefaultMaxRetry=function(retry){var _retryLimit=+retry;$scope.defaultMaxRetry.retry_limit=_retryLimit,$scope.setEventOptions()},$scope.saveDropdown=function(e,value,className){"endOfDialog"===value?($scope["default"].defaultRetryValue="End of Dialog",$scope.defaultMaxRetry.action=value):value.hasOwnProperty("name")&&($scope["default"].defaultRetryValue=value.name+$scope.getNodeCount(value),$scope.defaultMaxRetry.action="executeNode",$scope.defaultMaxRetry.ref=value.uId),$scope.setEventOptions(className)},$scope.confirmIndicator=function(selectedOption,label){$scope.tempPromptOptions=$workflowService.cloneData($scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions),$scope.selectedPromptOptions=selectedOption,$scope.selectedLabel=label,$scope.entityTypeValue=$scope.nodeInfo.dialogNodeInstance.entityType,$scope.$watch("entityTypeValue",function(newValue,oldValue){newValue&&newValue.toLowerCase()!==oldValue.toLowerCase()&&$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&"prompt"===$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&$scope.defaultValue.defaultHiddenValue&&$scope.defaultValue.defaultHiddenValue.length&&0!==$scope.defaultValue.defaultHiddenValue.length&&($scope.defaultValue.defaultHiddenValue=""),newValue&&newValue.toLowerCase()!==oldValue.toLowerCase()&&$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&"optional"===$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&$scope.defaultValue.defaultOptionValue&&$scope.defaultValue.defaultOptionValue.length&&0!==$scope.defaultValue.defaultOptionValue.length&&($scope.defaultValue.defaultOptionValue="")}),"required"!==$scope.tempPromptOptions||"executeNode"!==$scope.defaultMaxRetry.action||_.isEmpty($scope.defaultMaxRetry.ref)?$scope.onRequiredToggleChangeOptions(null,$scope.selectedPromptOptions):$element.find("#entityBehaviour").addClass("show").removeClass("fade"),$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&"prompt"===$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&$scope.defaultValue.defaultOptionValue&&$scope.defaultValue.defaultOptionValue.length&&0!==$scope.defaultValue.defaultOptionValue.length&&$scope.saveDefaultValue("","","savePrompt"),$scope.nodeInfo&&$scope.nodeInfo.dialogNodeInstance&&$scope.nodeInfo.dialogNodeInstance.nodeOptions&&$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&"optional"===$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions&&$scope.defaultValue.defaultHiddenValue&&$scope.defaultValue.defaultHiddenValue.length&&0!==$scope.defaultValue.defaultHiddenValue.length&&$scope.saveDefaultValue("","","saveHidden")},$scope.cancelBehaviourChanges=function(){$element.find("#entityBehaviour").removeClass("show").addClass("fade"),$scope.prompt.promptOptions=$scope.tempPromptOptions},$scope.proceedToggleChange=function(){$element.find("#entityBehaviour").removeClass("show").addClass("fade"),$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions=$scope.selectedPromptOptions,$scope.onRequiredToggleChangeOptions(null,$scope.selectedPromptOptions)},$scope.cb.updateDefaultMaxRetry=function(){$scope.defaultMaxRetry=$workflowService.cloneData(_defaultMaxRetry),$scope["default"].defaultRetryValue="End Of Dialog",$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions={},$scope.nodeInfo.dialogNodeInstance.nodeOptions.eventOptions.defaultMaxRetry=$workflowService.cloneData(_defaultMaxRetry),$scope.onRequiredToggleChangeOptions("",$scope.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions)},$scope.setProcessApp=function(processApp){$scope.process.selectedProcess=$workflowService.cloneData(processApp);var _pocessPayload={resourceId:$scope.process.selectedProcess.refId};startSaving(".entityGeneralSettings"),updateComponent(_pocessPayload,".entityGeneralSettings")},$scope.setProcessType=function(type){var _pocessPayload={processType:type};startSaving(".entityGeneralSettings"),updateComponent(_pocessPayload,".entityGeneralSettings")},$scope.addContextValue=function(e,index,context){if(e&&13===e.keyCode&&context.value&&context.value.length){var _payload={};$scope.process.selectedProcess.contextMap||($scope.process.selectedProcess.contextMap={}),$scope.process.selectedProcess.contextMap[context.key]=context.value,_payload={contextMap:JSON.stringify($scope.process.selectedProcess.contextMap)},startSaving(".contextSaveSpin"+index),updateComponent(_payload,".contextSaveSpin"+index)}},$scope.addParticipateContextValue=function(e,index){if(e&&13===e.keyCode&&($scope.processTypeContext.taskId||$scope.processTypeContext.action)){var _payload={};_payload={contextMap:JSON.stringify($scope.processTypeContext)},startSaving(".contextParticipateSaveSpin"+index),updateComponent(_payload,".contextParticipateSaveSpin"+index)}},$scope.openManageTraining=function(e,intent,type,activetab){switch($scope.modalSlider.open("#trainingFullModalDialog"),$scope.selectedIntent=intent,$scope.activetab=activetab,$scope.manageTrainingCB.showTrainBtn=$scope.showTrainBtn,$scope.selectedIntent.patternsArray=[],$scope.selectedIntent.patterns=intent.patterns||[],$scope.selectedIntent.patterns.map(function(pattern){$scope.selectedIntent.patternsArray.push(pattern.original)}),$scope.manageTrainingCB.getUtterances(intent,$scope.manageTrainingCB),$scope.manageTrainingCB.loadingMLUtterances=!0,$scope.manageTrainingCB.checkMLSyncStatus(),activetab){case"utterances":$scope.loaderLabel="Utterances",$scope.manageTrainingCB.showActiveType($scope.activetab,type);break;case"patterns":$scope.loaderLabel="Patterns","DialogIntent"===type?$scope.manageTrainingCB.showActiveType($scope.activetab,type):"DialogEntity"===type&&$scope.manageTrainingCB.onClickEntity(intent,$scope.activetab,type);break;case"rules":$scope.loaderLabel="Rules","DialogIntent"===type&&$scope.manageTrainingCB.showActiveType($scope.activetab,type)}};var getUtterances=function(){var offset=0,limit=10;$scope.loadingUtterances=!0,BTStreamsService.getUtterances($scope.nodeInfo.nodeInfo._id,offset,limit,$scope.utteranceSearch.utteranceSearchQuery).then(function(response){$scope.nodeInfo.nodeInfo.utterances=[],_.forEach(response.data.Sentences,function(eachUtterance){eachUtterance.sentence=decodePattern(eachUtterance.sentence),$scope.nodeInfo.nodeInfo.utterances.push(eachUtterance)}),$scope.totalUtterancesCount=response.data.count,$timeout(function(){$(".scroll-content").animate({scrollTop:$(".machineLearningLevel").offset().top}),$scope.loadingUtterances=!1},300)})},updateTrainDetails=function(obj){$scope.saveInprogress=obj.showTrainSavingDiv,$scope.showTrainBtn=obj.showTrainBtn,getUtterances()};$scope.manageTrainingCB.updateTrainDetails=updateTrainDetails,$scope.checkMLSyncStatus=function(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithSentences")&&!res.data.isMlInSyncWithSentences?$scope.showTrainBtn=!0:$scope.showTrainBtn=!1,"Finished"===res.data.trainingStatus?($scope.saveInprogress=!1,$scope.trainStatus.saving=!1):"Failed"===res.data.trainingStatus||res.data.isError?($scope.saveInprogress=!1,res.data.isError&&($scope.failed_to_train_utt_msg=i18n.i18nString("failed_to_train_utt_msg"),res.data.errorDesc&&res.data.errorDesc.message&&($scope.showTrainBtn=!0),disableNotify||NotificationService.notify(failed_to_train_utt_msg,"error"))):($scope.saveInprogress=!0,$scope.trainStatus.saving=!0)},function(err){$scope.saveInprogress=!1,$scope.err_on_fetching_msg=i18n.i18nString("err_on_fetching_msg"),NotificationService.notify(err_on_fetching_msg,"error")})},$scope.closeTrainingModalSlider=function(){$scope.modalSlider.close("#trainingFullModalDialog")},$scope.updateIntentData=function(trainData){updateTrainDetails(trainData.trainStatus),updatePropertyPanel(trainData.intentData,trainData.traitRules)},$scope.manageTrainingCB.closeTrainingModalSlider=$scope.closeTrainingModalSlider,$scope.cb.updateIntentData=$scope.updateIntentData,$scope.voice_channels_node_cb={openBotLevelIVR:openBotLevelIVR,openChannelLevelTwilioVoice:openChannelLevelTwilioVoice,openAudioCodesVoiceProp:openAudioCodesVoiceProp},prepareGroupIntentIvrProperties()}]}}),_module.directive("retryAction",function(){return{restrict:"EA",link:function(scope,ele,attrs,ngModel){var retryAction={};if(attrs.retryAction)if(retryAction=JSON.parse(attrs.retryAction),"endOfDialog"===retryAction.action)scope["default"].defaultRetryValue="End Of Dialog";else if("executeNode"===retryAction.action&&!_.isEmpty(retryAction.ref)){var node=_.find(scope.nodeObjList,{uId:retryAction.ref});node&&(scope["default"].defaultRetryValue=node.name+scope.getNodeCount(node))}}}}),_module.directive("multiDropdown",function(){return{restrict:"EA",link:function(scope,el,attrs){$(el).on("click",function(e){$(this).next("ul").toggle(),e.stopPropagation(),e.preventDefault()})}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("reportForm",[function(){return{restrict:"AE",scope:{wfType:"@?",sampleResponseKeys:"=",sampleResponseKeysForReports:"=",displayMode:"@?",reportCb:"=?",dialogComponent:"=?",editReport:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/report-form/report-form.html",controller:["$scope","form_util","$workflowService","BTActionsService","BTAlertsService","NotificationService","BTParamMapService","$timeout","$rootScope","$templateRequest","BTFlowtaskService","$element","$compile","uuid4","i18n",function($scope,form_util,$workflowService,BTActionsService,BTAlertsService,NotificationService,BTParamMapService,$timeout,$rootScope,$templateRequest,BTFlowtaskService,$element,$compile,uuid4,i18n){function closeTemplateModal(){$("#report-template-modal").modal("hide"),$scope.showEditReportTemplate=!1,$scope.reportCb.editTemplateClosed&&$scope.reportCb.editTemplateClosed()}function updateEntity(entityType,config,callback){$scope.saveInprogress=!0;var entity="alert"===entityType?$workflowService.alertInfo():$workflowService.actionInfo();if("alert"===entityType)BTAlertsService.createBTAlertUp(entity._id,config).then(function(res){$workflowService.alertInfo(res.data),(callback||angular.noop)(),$scope.saveResponseObj(),$rootScope.$broadcast("confSaveTriggerStatus",!1)},function(err){confSaveFailed(),console.log(err),$rootScope.$broadcast("confSaveTriggerStatus",!1),NotificationService.notify(i18n.i18nString("saved"),"success"),err&&err.data&&err.data.errors&&err.data.errors.length&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")}).then(function(){$scope.saveInprogress=!1,$rootScope.$broadcast("confSaveTriggerStatus",!1)});else if("action"===entityType)BTActionsService.updateBTAction(entity._id,config).then(function(res){$workflowService.actionInfo(res.data),(callback||angular.noop)(),$scope.saveResponseObj(),$rootScope.$broadcast("confSaveTriggerStatus",!1),NotificationService.notify(i18n.i18nString("saved"),"success")},function(err){confSaveFailed(),console.log(err),$rootScope.$broadcast("confSaveTriggerStatus",!1),err&&err.data&&err.data.errors&&err.data.errors.length&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")}).then(function(){$scope.saveInprogress=!1});else if("dialog"===entityType){var _params={isReport:!0,report:[]};if($scope.dialogComponent.nodeInfo&&$scope.dialogComponent.nodeInfo.report){_params.report=$scope.dialogComponent.nodeInfo.report||[];var _index=_.findIndex(_params.report,function(obj){return obj.config.id===config.report.config.id});0>_index?(config.report.config.id="rp-"+uuid4.generate(),_params.report.push(config.report)):_params.report[_index]=config.report}else config.report.config.id="rp-"+uuid4.generate(),_params.report.push(config.report);BTFlowtaskService.updateComponent($workflowService.selectedStream()._id,$scope.dialogComponent.nodeInfo._id,_params).then(function(res){(callback||angular.noop)(),$rootScope.$broadcast("confSaveTriggerStatus",!1),$scope.reportCb.onDialogReportSaved(res.data),NotificationService.notify(i18n.i18nString("saved"),"success")},function(err){$rootScope.$broadcast("confSaveTriggerStatus",!1),confSaveFailed(),console.log(err),err&&err.data&&err.data.errors&&err.data.errors.length&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")}).then(function(){$scope.saveInprogress=!1})}}function confSaveFailed(){$scope.$emit("confSaveFailed",{})}$scope.report=$scope.report||{},$scope.tags=_.pluck($scope.report.templates,"template"),$scope.cb={},$scope.reportCb.getReportForm=function(){return $scope.reportForm};var entity,reportdata,reportconfig;$scope.takenAction="",$scope.templates=$workflowService.templates(),"dialog"===$scope.wfType&&($scope.templates=_.filter($scope.templates,function(template){return!("cardlayoutwithactions"===template.value||"shoppinglayoutwithactions"===template.value)})),$scope.selectedTmplt=function(){return _.find($scope.templates,{value:$scope.template})},$scope.report.templates=$scope.report.templates||[],$scope.actions=$workflowService.actionTasks(),$timeout(function(){entity="alert"===$scope.wfType?$workflowService.alertInfo():$workflowService.actionInfo(),("dialog"===$scope.wfType?$scope.editReport:entity.isReport&&entity.report)&&(reportdata="dialog"===$scope.wfType?$scope.editReport:entity.report||{},$scope.reportdata=reportdata,reportconfig=reportdata&&reportdata.config,$scope.report.title=reportconfig.title,$scope.report.header=reportconfig.header,$scope.report.details=reportconfig.description,$scope.report.actions=reportdata.actions,reportconfig.id&&($scope.report.id=reportconfig.id),"dialog"===$scope.wfType&&($scope.report.dataPath=reportdata.dataPath),$scope.template=reportconfig.name,$scope.editReport&&($("#edit-report-template-div").addClass("hideByOpacity"),$timeout(function(){$("#edit-report-template-div").removeClass("hideByOpacity")},1e3)),$scope.addTemplate())}),$templateRequest(window.appConfig.TMPLT_PRE_PATH+"js/forms/report-form/edit-report.html").then(function(html){if($scope.editReportLoaded=!0,"dialog"===$scope.wfType){html=$(html).find('[ng-show="showEditReportTemplate"]');var dtemplate=angular.element(html);$compile(dtemplate)($scope),$scope.editReportModal=$($element).closest(".modal-content").append($(dtemplate))}else{var _template=angular.element(html);$scope.editReportModal=$(_template).appendTo("body"),$scope.editReportModal.find('[ng-show="showEditReportTemplate"]').addClass("modal-content")}}),$scope.$on("$destroy",function(){$scope.editReportModal.remove()}),$scope.editTemplate=function(){return $scope.reportForm.$valid?void $timeout(function(){$("#report-template-modal").modal({backdrop:"static",keyboard:!1,show:!0}),$scope.showEditReportTemplate=!0,$scope.reportCb.editTemplateOpened&&$scope.reportCb.editTemplateOpened()},200):(form_util.touch($scope.reportForm),void NotificationService.notify(i18n.i18nString("please_fill_req"),"error"))},$scope.saveResponseObj=function(){},$scope.cb.saveResponseObj=function(){$scope.saveResponseObj()},$scope.cb.closeTemplateModal=function(){closeTemplateModal()},$scope.closeTemplateModal=function(){closeTemplateModal()},$scope.addTemplate=function(){$scope.template&&($scope.report.templates=[{template:$scope.template}]),$scope.tags=_.pluck($scope.report.templates,"template")},$scope.deleteTemplate=function(index){$scope.report.templates.splice(index,1),$scope.tags=_.pluck($scope.report.templates,"template")},$scope.saveReport=function(config,callback){if(!$scope.reportForm.$valid)return form_util.touch($scope.reportForm),confSaveFailed(),void $scope.$apply();if("dialog"===$scope.wfType&&$scope.dialogComponent.nodeInfo&&$scope.dialogComponent.nodeInfo.report&&$scope.dialogComponent.nodeInfo.report.length){var _reportsToCheck=[];_reportsToCheck=$scope.editReport?_.filter($scope.dialogComponent.nodeInfo.report,function(report){return report.config.id!==$scope.editReport.config.id}):angular.copy($scope.dialogComponent.nodeInfo.report);var _reportFound=_.findIndex(_reportsToCheck,function(report){return report.config.title&&$scope.report.title?report.config.title.toLowerCase()===$scope.report.title.toLowerCase():!1});if(_reportFound>-1)return void NotificationService.notify(i18n.i18nString("duplicates"),"error")}var templateconfig={isReport:!0,report:{}};templateconfig.report.config={name:$scope.template,title:$scope.report.title,header:$scope.report.header,description:$scope.report.details,templateInfo:config.templateInfo},$scope.report.id&&(templateconfig.report.config.id=$scope.report.id),"dialog"===$scope.wfType&&(templateconfig.report.dataPath=$scope.report.dataPath),templateconfig.report.mappings=config.mappings,templateconfig.report.actions=$scope.report.actions,updateEntity($scope.wfType,templateconfig,callback)},$scope.cancelReport=function(){$scope.$apply()},$scope.addActionToList=function(actionId){var action=$scope.actions.filter(function(aciton){return aciton._id===actionId})[0];if(action){$scope.report.actions=$scope.report.actions||[];var existedObject=_.find($scope.report.actions,function(actionSelected){return actionSelected.actionId===actionId});existedObject||$scope.report.actions.push({name:action.name,botId:action.streamId,actionId:action._id})}},$scope.deleteAction=function(index){$scope.report.actions.splice(index,1)},$scope.$on("confSaveTrigger",function(evt,data){!$scope.reportForm.$valid&&$scope.reportForm.$dirty?(form_util.touch($scope.reportForm),confSaveFailed(),$rootScope.$broadcast("confSaveTriggerStatus",!1)):$rootScope.$broadcast("templateConfSave",{callback:data.callback})})}],link:function($scope,ele,attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("rqForm",function(){return{restrict:"AE",scope:{mode:"@",onCancel:"&",onSave:"&",onTest:"&",wfType:"@",setReqChain:"=",isFirst:"=",view:"=",showReqForm:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/request-chain-form/request-chain-form.html",controller:["$scope","$workflowService","form_util","urlutil","BTIdpService","$applicationService","$rootScope","$timeout","NotificationService","i18n",function($scope,$workflowService,form_util,urlutil,BTIdpService,$applicationService,$rootScope,$timeout,NotificationService,i18n){function getFormatedRequestFields(){var payload=[],payloadAuth=[];return $scope.taskFields&&$scope.taskFields.length&&(payload=$scope.taskFields.filter(function(task){return task.isChecked}).map(function(task){var _obj={name:task.title,key:task.key,type:task.actionFieldType,subType:"task"};return _obj})),$scope.authParamFields&&$scope.authParamFields.length&&(payloadAuth=$scope.authParamFields.filter(function(task){return task.isChecked}).map(function(task){var _obj={name:task.value,key:task.key,type:task.type,subType:"auth"};return _obj})),payload=payload.concat(payloadAuth)}function getFormatedHeaderFields(){var payloadAuth=[];return $scope.authHeaderFields&&$scope.authHeaderFields.length&&(payloadAuth=$scope.authHeaderFields.filter(function(task){return task.isChecked}).map(function(task){var _obj={name:task.value,key:task.key,type:task.type,subType:"auth"};return _obj})),payloadAuth}function prepareApiObjectPayload(payload){payload.name=$scope.rqData.api.name,payload.linkType=$scope.rqData.api.linkType,payload.linkDefinition={endPoint:splitUrl($scope.rqData.api.requestUrl,$scope.rqData.api.contentType,$scope.rqData.api.rcMethod),streamId:$workflowService.selectedStream()._id,streamName:$workflowService.selectedStream().name,reqFields:getFormatedRequestFields(),headerFields:getFormatedHeaderFields()},payload.linkDefinition.endPoint.connectorEnabled=$scope.rqData.api.connectorEnabled}function prepareProcessPayload(payload){var link;$scope.processors.map(function(processor){link={},link.linkType=processor.linkType,link.linkDefinition={type:processor.processType},"_resolve"===processor.processType?(link.linkDefinition.key=processor.processKey,link.linkDefinition.endPoint=splitUrl(processor.requestUrl,processor.contentType,processor.rcMethod),link.linkDefinition.streamId=$workflowService.selectedStream()._id,link.linkDefinition.streamName=$workflowService.selectedStream().name):processor.processKey&&processor.processType&&(link.linkDefinition.key=processor.processKey),payload.push(link)})}function splitUrl(url,contentType,method){var uriParser=window.URI,components=uriParser.parse(url),endPoint={host:components.host,port:components.port?components.port+"":"",path:components.path,protocol:components.scheme,"content-type":contentType,method:method};return endPoint.path+=components.query?"?"+components.query:"",endPoint.path+=components.fragment?"#"+components.query:"",endPoint}function makeItClean(){var form=$scope.rqForm;for(var key in form)form.hasOwnProperty(key)&&"object"==typeof form[key]&&0!==key.indexOf("$")&&0!==key.indexOf("$$")&&(form[key].$dirty=!1)}$scope.options={mode:"code",ace:window.ace},$scope.views={headers:!0,params:!1,response:!1},$scope.request=i18n.i18nString("request"),$scope.post=i18n.i18nString("post_label"),$scope.savingLabel=i18n.i18nString("saving"),$scope.saveLabel=i18n.i18nString("save"),$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.closeCross=window.appConfig.CONTEXT_PATH+"/assets/landingImages/closeCross.png",$scope.navigate=function(view){Object.keys($scope.views).map(function(view){$scope.views[view]=!1}),$scope.views[view]=!0},$scope.rqData={api:{linkType:"apiObject"},process:{linkType:"processor"}},$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.reqObj={},$scope.processors=[],$scope.connectors=[],$scope.datatypes=$workflowService.seedData().contentTypes,$scope.linkTypes=$workflowService.seedData().requestChainTypes.filter(function(process){return"modifier"!==process.value}),$scope.processTypes=$workflowService.seedData().requestLinkProcessorTypes,$scope.apiCreationInProgress=!1,$scope.isFirst=!0,$scope.$watch("setReqChain",function(newVal,oldVal){var endPoint,url;if($scope.rqData={api:{linkType:"apiObject"},process:{linkType:"processor"}},newVal){newVal.processors=newVal&&newVal.processors||[],$scope.processors=newVal.processors.map(function(processor){var endPoint,obj={},url={};return"_resolve"===processor.linkDefinition.type?(obj={linkType:processor.linkType,processKey:processor.linkDefinition.key,processType:processor.linkDefinition.type},obj.contentType=processor.linkDefinition.endPoint["content-type"],obj.rcMethod=processor.linkDefinition.endPoint.method,endPoint=processor.linkDefinition.endPoint,url=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol}),obj.requestUrl=url,obj):{linkType:processor.linkType,processKey:processor.linkDefinition.key,processType:processor.linkDefinition.type}});var api=newVal&&newVal.api||{};api.linkDefinition=api.linkDefinition||{},api.linkDefinition.endPoint&&(endPoint=api.linkDefinition.endPoint,url=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol}),$scope.rqData.api.requestUrl=url,$scope.rqData.api.rcMethod=endPoint.method,$scope.rqData.api.contentType=endPoint["content-type"],$scope.rqData.api.connectorEnabled=endPoint.connectorEnabled),api.name&&($scope.rqData.api.name=api.name);var taskFields=angular.copy($scope.$parent.alertFieldsDefinition);if(taskFields&&taskFields.length?$scope.taskFields=taskFields.map(function(taskField){return taskField.isChecked=!1,"alert"===$scope.wfType&&(taskField.actionFieldType="queryfield"),"create"===$scope.mode?taskField.isChecked=!0:"edit"===$scope.mode&&api.linkDefinition.reqFields&&api.linkDefinition.reqFields.length&&api.linkDefinition.reqFields.forEach(function(reqField){return reqField.key===taskField.key?(taskField.isChecked=!0,void(taskField.actionFieldType=reqField.type)):void 0}),taskField}):$scope.taskFields=[],$scope.authHeaderFields=[],$scope.authParamFields=[],$scope.$parent.idpConfig.fields&&$scope.$parent.idpConfig.fields.length){var authFields=angular.copy($scope.$parent.idpConfig.fields);authFields&&authFields.length&&authFields.forEach(function(authField){authField.isChecked=!1,"create"===$scope.mode?authField.isChecked=!0:"edit"===$scope.mode&&(api.linkDefinition.headerFields&&api.linkDefinition.headerFields.length&&api.linkDefinition.headerFields.forEach(function(headerField){return headerField.key===authField.key?(authField.isChecked=!0,void(authField.type=headerField.type)):void 0}),api.linkDefinition.reqFields&&api.linkDefinition.reqFields.length&&api.linkDefinition.reqFields.forEach(function(reqField){return"auth"===reqField.subType&&reqField.key===authField.key?(authField.isChecked=!0,void(authField.type=reqField.type)):void 0})),"header"===authField.type?$scope.authHeaderFields.push(authField):$scope.authParamFields.push(authField)})}}}),$rootScope.$on("finishedAlertUpdate",function(event,resource){$scope.apiCreationInProgress=!1}),$scope.saveReqchainObj=function(isValid,showIt,form){var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");if(overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),!$scope.apiCreationInProgress){if($scope.navigate("headers"),!isValid)return void form_util.touch(form);$scope.apiCreationInProgress=!0;var reqChain={api:{},processors:[]};prepareApiObjectPayload(reqChain.api),prepareProcessPayload(reqChain.processors),$scope.onSave({requestObj:reqChain,showIt:showIt,rqObjSave:!0}),makeItClean()}};var processEdit="no-index";$scope.showProcessor=!1,$scope.processInEdit=!1,$scope.newProcessor=function(){$scope.showProcessor=!0,$scope.processor=null,processEdit="no-index",$scope.processInEdit=!1},$scope.editProcess=function(index){$scope.showProcessor=!1,$timeout(function(){processEdit=index,$scope.processor=angular.copy($scope.processors[index]),$scope.showProcessor=!0,$scope.processInEdit=!0})},$scope.removeProcess=function(index){$scope.processors.splice(index,1)},$scope.processorSave=function(processor){"_resolve"!=processor.processType&&Object.keys(processor).map(function(key){"processType"!=key&&"processKey"!=key&&"linkType"!=key&&delete processor[key]}),"no-index"!==processEdit?$scope.processors.splice(processEdit,1,processor):$scope.processors.push(processor),$scope.showProcessor=!1},$scope.processorCancel=function(){$scope.showProcessor=!1},function(){BTIdpService.connectors().then(function(res){$scope.connectors=res.data},function(err){$scope.connectors=[]}),$scope.connectors=$workflowService.botConnectors()}(),$scope.cancelChainForm=function(){PerfectScrollbar.initialize($("#btFullpageModal .main-content")[0]),PerfectScrollbar.destroy($("#commonId .requestApi")[0]);var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),$scope.onCancel({chainForm:!1})}}]}})}(angular),function(ng){angular.module("bt-forms").directive("processorForm",["$workflowService",function($workflowService){return{restrict:"EA",scope:{onSave:"&",processor:"=",onCancel:"&",wfType:"=",edit:"=",view:"=",showProcForm:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/request-chain-form/request-chain-processor.html",controller:["$scope","$workflowService","form_util","i18n",function($scope,$workflowService,form_util,i18n){$scope.$watch("processor",function(newVal,oldVal){newVal?$scope.context=angular.copy(newVal):$scope.context={linkType:"processor"}}),$scope.request=i18n.i18nString("request"),$scope.post=i18n.i18nString("post_label"),$scope.savingLabel=i18n.i18nString("saving"),$scope.saveLabel=i18n.i18nString("save"),$scope.NOOP={},$scope.datatypes=$workflowService.seedData().contentTypes,$scope.linkTypes=$workflowService.seedData().requestChainTypes.filter(function(process){return"modifier"!==process.value}),$scope.processTypes=$workflowService.seedData().requestLinkProcessorTypes,$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.closeCross=window.appConfig.CONTEXT_PATH+"/assets/landingImages/closeCross.png",$scope.add=function(isValid,form){var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");return overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),isValid?($scope.onSave({processor:angular.copy($scope.context),rqObjSave:!0}),$scope.context={linkType:"processor"},form_util.makeItClean($scope.req_processor),void($scope.req_processor.$dirty=!1)):void form_util.touch(form)},$scope.cancel=function(){PerfectScrollbar.initialize($("#btFullpageModal .main-content")[0]),PerfectScrollbar.destroy($("#commonId .requestProcessor")[0]);var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");overflowResult&&$(".modal-body.modal-body-nopadding .creation .main-content").removeClass("overflowUnset"),$scope.context={linkType:"processor"},$scope.onCancel(),form_util.makeItClean($scope.req_processor),$scope.req_processor.$dirty=!1}}],link:function($scope,ele,attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("requestObjectForm",function(){return{restrict:"AE",scope:{wfType:"@",onComplete:"&",onCancel:"&",displayMode:"@",configure:"&",hooks:"=?callbacks",resource:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/request-object-form/request-object-form.html",controller:["$scope","urlutil","$rootScope","$interval","$timeout","$endpoints","$location","$applicationService","$translator","$filter","$workflowService","BTAlertsService","NotificationService","BTActionsService","$util","BTIdpService","form_util","$routeParams","$q","koreUxMap","BTStreamsService","i18n","env_conf",function($scope,urlutil,$rootScope,$interval,$timeout,$endpoints,$location,$applicationService,$translator,$filter,$workflowService,BTAlertsService,NotificationService,BTActionsService,$util,BTIdpService,form_util,$routeParams,$q,koreUxMap,BTStreamsService,i18n,env_conf){
function reqchainDelete(index){reqDataForTAble.rows.splice(index,1),reqObjsToSend.splice(index,1),reqDataArray.splice(index,1),$scope.requestChain=reqDataArray,$scope.reqObj.requestChainObjects=reqDataForTAble,$scope.isFirst=reqDataForTAble.rows.length>0?!1:!0,$scope.setRequestObject("",$scope.isFormValid(),!1,!0)}function prepareReqChainTableData(reqLink){var endPoint,url,record={};return reqLink.linkDefinition=reqLink.linkDefinition||{},"apiObject"===reqLink.linkType?(endPoint=reqLink.linkDefinition&&reqLink.linkDefinition.endPoint,endPoint=endPoint||{},url=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol}),record.name=reqLink.name||"",record.type="API",record.method=endPoint.method):"processor"===reqLink.linkType&&(record.name=reqLink.name||"",record.type="Processor",record.method=reqLink.linkDefinition.type||""),record}function deleteAlertField(index){alertFieldForTable.rows.splice(index,1),$scope.alrtField.alrtFldObjects=alertFieldForTable,alertFieldsDataArray.splice(index,1),$scope.alertFieldsDefinition=alertFieldsDataArray,$scope.setRequestObject("",$scope.isFormValid(),!1,!0)}function setUpTables(){alertFieldsDataArray=[],alertFieldForTable={},reqObjsToSend=[],reqDataForTAble={},reqDataArray=[],alertFieldForTable.rows=[],reqDataForTAble.rows=[],reqDataForTAble.headers=[{name:"Name",sortable:!0},{name:"Type",sortable:!0},{name:"Method",sortable:!1}],alertFieldForTable.headers=[{name:"Name",sortable:!0},{name:"Key",sortable:!1},{name:"Field Control Type",sortable:!1},{name:"Type",sortable:!1}]}function bindValuesInEditMode(){if(setUpTables(),Object.keys(finalObj).length>0){if($scope.reqObj.datatype=$filter("filter")($scope.datatypes,{value:finalObj.dataType})[0],$scope.reqObj.hasUserEndpoint=finalObj.hasUserEndpoint,$scope.reqObj.alertsPath=finalObj.alertsPath,$scope.reqObj.linksPath=finalObj.linksPath,finalObj.initializer&&finalObj.initializer.length&&($scope.reqObj.taskInitializer=koreUxMap.splitCodeIntoNormalAndCode(finalObj.initializer[0].linkDefinition.customCode.body)),finalObj.linksPath&&($scope.reqObj.previewLink=!0),finalObj.linkPreviewKeys&&finalObj.linkPreviewKeys.length)for(var i=0;i<finalObj.linkPreviewKeys.length;i++)$scope.reqObj.linkPreview[finalObj.linkPreviewKeys[i]]=!0;var reqChain={api:{},processors:[]};if(angular.forEach(finalObj.requestChain,function(obj,index){"apiObject"===obj.linkType||"processor"===obj.linkType?(0!==Object.keys(reqChain.api).length&&($scope.onReqObjFormSave(angular.copy(reqChain)),reqChain={api:{},processors:[]}),reqChain.api=obj):"processor"===obj.linkType&&reqChain.processors.push(obj),finalObj.requestChain.length===index+1&&$scope.onReqObjFormSave(angular.copy(reqChain))}),"action"===$scope.wfType){var fieldsData=[];angular.forEach(finalObj.payloadField,function(obj,index){obj.actionFieldType="payloadfield",fieldsData.push(angular.copy(obj))}),angular.forEach(finalObj.queryField,function(obj,index){obj.actionFieldType="queryfield",fieldsData.push(angular.copy(obj))}),fieldsData=$filter("orderBy")(fieldsData,"fieldIndex"),fieldsData.map(function(val){$scope.onAlertFieldSave(angular.copy(val))})}else"alert"===$scope.wfType&&angular.forEach(finalObj.alertFieldsDefinition,function(obj,index){obj.inputType=obj.fieldType,$scope.onAlertFieldSave(angular.copy(obj))});$timeout(function(){$scope.reqObj.sampledata=$util.jsonParse(finalObj.sample)}),$scope.reqObj.hasUserEndpoint&&($scope.hasUserEndpoint=!0,$scope.userEndpoint())}}function getTaskInitializerPayload(code){return{name:"initializer",linkType:"processor",linkDefinition:{customCode:{body:koreUxMap.wrapItInside(null,code)},type:"_custom"}}}function splitUrl(url,contentType,method){var uriParser=window.URI,components=uriParser.parse(url),endPoint={host:components.host,port:components.port?components.port+"":"",path:components.path,protocol:components.scheme,"content-type":contentType,method:method};return endPoint.path+=components.query?"?"+components.query:"",endPoint.path+=components.fragment?"#"+components.query:"",endPoint}function updateAlertsAndActions(cb){if("alert"===$scope.wfType){$rootScope.$emit("finishedAlertUpdate","success","alert");var _alertInfo=$workflowService.alertInfo();_alertInfo.taskType="alert",$scope.$emit("mpResourceUpdate",_alertInfo),$q.all([BTAlertsService.getMPAlert(resourceId),BTAlertsService.getBTAlert(resourceId)]).then(function(res){finalObj={},$workflowService.alertInfo(res[1].data),$workflowService.mpAlertInfo(res[0].data),angular.extend(finalObj,angular.copy(res[1].data)),angular.extend(finalObj,angular.copy(res[0].data)),$workflowService.requestData(finalObj),cb&&cb()},function(err){NotificationService.notify(i18n.i18nString("error_msg"),"error"),$workflowService.mpAlertInfo({}),$workflowService.alertInfo({})})}else if("action"===$scope.wfType){$rootScope.$emit("finishedAlertUpdate","success","alert");var _actionInfo=$workflowService.actionInfo();_actionInfo.taskType="action",$scope.$emit("mpResourceUpdate",_actionInfo),$q.all([BTActionsService.getBTAction(resourceId),BTActionsService.getMPAction(resourceId)]).then(function(res){finalObj={},$workflowService.actionInfo(res[0].data),$workflowService.mpActionInfo(res[1].data),angular.extend(finalObj,angular.copy(res[1].data)),angular.extend(finalObj,angular.copy(res[0].data)),$workflowService.requestData(finalObj),cb&&cb()},function(err){NotificationService.notiy(i18n.i18nString("error_msg"),"error"),$workflowService.mpActionInfo({}),$workflowService.actionInfo({})})}}function getFieldType(fieldtype){var field=_fieldTypes.filter(function(field){return field.value===fieldtype?field:void 0})[0]||{};return field.name}function getLinkPreviewKeys(item){var result=[];for(var key in item)item.hasOwnProperty(key)&&item[key]&&result.push(key);return result}function prepareRequestChainButtons(){$scope.loadingAccounts=!0,BTStreamsService.getAccounts($workflowService.selectedStream()._id,"true","false").then(function(res){res.data?$scope.accounts=res.data:$scope.accounts=[],$scope.loadingAccounts=!1},function(err){$scope.accounts=[],$scope.loadingAccounts=!1})}function idpTestListenersRegistration(verifyInitializer){$scope.btTestFormApi.afterInit=function(){console.info("idp test afterInit callback is called"),$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(){console.info("idp test afterTest callback is called"),console.info($scope.btTestStatus),verifyInitializer()},$scope.btTestFormApi.onResponse=function(status,data){console.info("on response callback"),console.info(status),status&&$scope.setRequestObject("responseSample",$scope.isFormValid(),!1,!0)},$scope.btTestFormApi.afterClose=function(){console.info("idp test afterClose callback is called"),$scope.spinner.testingInProgress=!1},$scope.btTestFormApi.onError=function(errorObject){errorObject&&(NotificationService.notify(errorObject.errMessage,"error"),40===errorObject.errCode&&($(".panel-heading").addClass("collapsed"),$(".panel-collapse.in").collapse("hide"),$("#authPannel").collapse("show"),$(".red_info").show(),$timeout(function(){$(".red_info").hide()},4e3))),console.error("idp test onError callback is called"),console.log($scope.btTestStatus),$scope.spinner.testingInProgress=!1},$scope.btTestFormApi.onCancel=function(){console.warn("idp test onCancel callback is called"),console.log($scope.btTestStatus),$scope.spinner.testingInProgress=!1,hideModalSlider()},$scope.btTestFormApi.onAuthTestModalClose=function(){$scope.spinner.testingInProgress=!1},$scope.btTestFormApi.onNewAccounts=function(accounts){$scope.accounts=accounts}}function taskTestListenersRegistration(){$scope.btTestFormApi.afterInit=function(){console.info("task test afterInit callback is called"),$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success){console.info("task test afterTest callback is called"),console.info($scope.btTestStatus),$scope.reqObj.sampledata=_.clone($scope.btTestStatus.uxjson||$scope.btTestStatus.testFinalResponse),success?NotificationService.notify(i18n.i18nString("request_chain_test_success"),"success"):NotificationService.notify(i18n.i18nString("request_chain_test_fail"),"error"),$scope.spinner.testingInProgress=!1,$scope.reqObjForm.$setDirty()},$scope.btTestFormApi.onResponse=function(status,data){status&&"view"!==$scope.displayMode&&$scope.setRequestObject("responseSample",$scope.isFormValid(),!1,!0)},$scope.btTestFormApi.afterClose=function(){console.log($scope.btTestStatus),console.info("task test afterClose callback is called"),$scope.spinner.testingInProgress=!1},$scope.btTestFormApi.onError=function(){console.error("task test onError callback is called"),console.log($scope.btTestStatus),$scope.spinner.testingInProgress=!1},$scope.btTestFormApi.onCancel=function(){console.warn("task test onCancel callback is called"),console.log($scope.btTestStatus),$scope.spinner.testingInProgress=!1,hideModalSlider()},$scope.btTestFormApi.onAuthTestModalClose=function(){$scope.spinner.testingInProgress=!1}}function arrangeReqChains(reqObjsToSend){var reqChains=[];return reqObjsToSend.map(function(chain){reqChains.push(chain.api||chain)}),reqChains}function notifyFormStatus(){var actionName;if($scope.reqObjForm._touched){"action"===$scope.wfType&&(actionName=$workflowService.actionInfo().name,actionName=actionName&&actionName.toLowerCase()),$scope.reqObjForm.datatype=setUpField($scope.reqObjForm.datatype),$scope.reqObjForm.reqchain=setUpField($scope.reqObjForm.reqchain),$scope.reqObj.datatype?$scope.reqObjForm.datatype.$error.required=!1:($scope.reqObjForm.datatype.$dirty=!0,$scope.reqObjForm.datatype.$error.required=!0);var requestChain=$scope.reqObj.requestChainObjects&&$scope.reqObj.requestChainObjects.rows||[];requestChain&&0===requestChain.length&&"outgoing webhook"!==actionName?($scope.reqObjForm.reqchain.$dirty=!1,$scope.reqObjForm.reqchain.$error.required=!1):$scope.reqObjForm.reqchain.$error.required=!1}}function setUpField(field){return field||(field={$error:{}}),field}function prepareProcessPayload(processor){var link;return link={},link.name=processor.processName,link.linkType=processor.linkType,link.linkDefinition={type:processor.processType},"_resolve"===processor.processType?(link.linkDefinition.key=processor.processKey,link.linkDefinition.endPoint=splitUrl(processor.requestUrl,processor.contentType,processor.rcMethod),link.linkDefinition.streamId=$workflowService.selectedStream()._id,link.linkDefinition.streamName=$workflowService.selectedStream().name):processor.processKey&&processor.processType&&(link.linkDefinition.key=processor.processKey),"_custom"===processor.processType&&(link.linkDefinition.customCode={body:koreUxMap.wrapItInside(null,processor.processCustomCode)}),"_assign"===processor.processType&&(link.linkDefinition.key=processor.processOutVar),link}function unprepareProcessPayload(processor){var endPoint,obj={},url={};return"_resolve"===processor.linkDefinition.type?(obj={linkType:processor.linkType,processKey:processor.linkDefinition.key,processType:processor.linkDefinition.type,processName:processor.name},obj.contentType=processor.linkDefinition.endPoint["content-type"],obj.rcMethod=processor.linkDefinition.endPoint.method,endPoint=processor.linkDefinition.endPoint,url=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol}),obj.requestUrl=url):obj={linkType:processor.linkType,processKey:processor.linkDefinition.key,processType:processor.linkDefinition.type,processName:processor.name},"_custom"===processor.linkDefinition.type&&(obj.processCustomCode=koreUxMap.splitCodeIntoNormalAndCode(processor.linkDefinition.customCode.body)),"_assign"===processor.linkDefinition.type&&(obj.processOutVar=processor.linkDefinition.key),obj}function loadIdpData(){var _idp;"alert"===$scope.wfType?(_idp=$workflowService.alertInfo().idp,$scope.idpValue=_idp):"action"===$scope.wfType&&(_idp=$workflowService.actionInfo().idp,$scope.idpValue=_idp),_idp?BTIdpService.getIdpByName(_idp,$workflowService.selectedStream()._id).then(function(res){$scope.idpConfig=res.data},function(err){$scope.idpConfig={}}):$scope.idpConfig={}}function init(){loadIdpData(),prepareRequestChainButtons(),$timeout(function(){$scope.reqObjForm&&$scope.reqObjForm.$setPristine(!0)},200)}$scope.reqObj={requestChainObjects:[],linkPreview:{}},$scope.alrtField={alrtFldObjects:[]},$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.saveInProgress=!1,$scope.spinner={},$scope.NOOP={},$scope.showReqForm=!1,$scope.showProcForm=!1,$scope.linkTypes=($workflowService.seedData().requestChainTypes||[]).filter(function(process){return"modifier"!==process.value}),$scope.processTypes=$workflowService.seedData().requestLinkProcessorTypes,$scope.datatypes=$workflowService.seedData().contentTypes,$scope.taskInitCB={},$scope.sampleResCB={},$scope.isReport=!1,$scope.authCB={},$scope.authHooks={},$scope.modalSlider={},$scope.rightClass="right500",$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.actionTask=i18n.i18nString("constants.action"),$scope.alertTask=i18n.i18nString("constants.alert"),$scope.chevronRightDark=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-right-dark.svg",$scope.options={mode:"view"===$scope.displayMode?"view":"code",ace:window.ace},$scope._constants_=$rootScope._constants_,$scope.linkPreviewConfig={allowClear:!0,placeholder:i18n.i18nString("select_any_link_preview_key")},$scope.btTestFormApi={},$scope.btTestStatus={},$scope.idpConfig={},$scope.hooks=$scope.hooks||{},$scope.afterSave=angular.noop;var resource,finalObj={};if("alert"===$scope.wfType){var alertInfo=$workflowService.alertInfo(),mpAlertInfo=$workflowService.mpAlertInfo();angular.extend(finalObj,angular.copy(alertInfo)),angular.extend(finalObj,angular.copy(mpAlertInfo)),resource=$workflowService.alertInfo(),$scope.resource=resource}else if("action"===$scope.wfType){var actionInfo=$workflowService.actionInfo(),mpActionInfo=$workflowService.mpActionInfo();angular.extend(finalObj,angular.copy(actionInfo)),angular.extend(finalObj,angular.copy(mpActionInfo)),resource=$workflowService.actionInfo(),$scope.resource=resource,$scope.isReport=finalObj.isReport}$scope.taskId=finalObj._id||$workflowService.alertInfo()._id;var editOperation=!1,editIndex=null;$scope.isWebhook=function(){return"webhook"===$scope.resource.type},$scope.handleAuthForm=angular.noop(),$scope.authCB.onCreateIDP=function(idpData){$scope.authCB.setIDP&&$timeout(function(){$scope.authCB.setIDP()},1e3)},$scope.authCB.onEditIDP=function(idpData){$scope.authCB.setIDP&&$timeout(function(){$scope.authCB.setIDP()},1e3)},$scope.authCB.onSetIDP=function(idpData){finalObj=angular.merge(finalObj,idpData),loadIdpData()},$scope.reqChainObjRowEdit=function(index){editOperation=!0,editIndex=index,$scope.saveInProgress=!1,"processor"===reqObjsToSend[index].api.linkType?$scope.editProcess(index):($scope.editingReqChain=angular.copy(reqObjsToSend[index]),$scope.rqMode="edit",showModalSlider("showReqForm"))},$scope.reqChainObjRowView=function(index){editOperation=!0,editIndex=index,$scope.editingReqChain=angular.copy(reqObjsToSend[index]),$(".rqModal").modal({show:!0,backdrop:"static"})},$scope.reqChainObjRowDel=function(index){NotificationService.alert(i18n.i18nString("you_really_want_to_delete_request"),reqchainDelete,arguments)},$scope.onReqObjFormSave=function(requestChain,showIt,rqObjSave){var obj,row=prepareReqChainTableData("processor"===requestChain.linkType?requestChain:requestChain.api);obj="alert"===$scope.wfType?{Name:row.name,Type:row.type,Method:row.method}:{Name:row.name,Type:row.type,Method:row.method},editOperation?(reqObjsToSend.splice(editIndex,1,requestChain),reqDataForTAble.rows.splice(editIndex,1,obj),$scope.reqObj.requestChainObjects=reqDataForTAble,reqDataArray.splice(editIndex,1,requestChain),$scope.requestChain=reqDataArray,editOperation=!1):(reqObjsToSend.push(requestChain),reqDataForTAble.rows.push(obj),$scope.reqObj.requestChainObjects=reqDataForTAble,reqDataArray.push(requestChain),$scope.requestChain=reqDataArray),showIt?$scope.editingReqChain={}:hideModalSlider(),$scope.isFirst=reqDataForTAble.rows.length>0?!1:!0,rqObjSave&&$scope.setRequestObject("",$scope.isFormValid(),!1,!0)};var alrtEditOperation=!1,alrtIndex=null;$scope.alrtFldObjRowEdit=function(index){var obj=($workflowService.seedData().fieldsData,angular.copy(alertFieldsDataArray[index]));alrtEditOperation=!0,alrtIndex=index,obj.name=obj.title,$scope.editingAlertField=angular.copy(obj),showModalSlider("showAlertFieldSlider")},$scope.alrtFldObjRowView=function(index){var obj=($workflowService.seedData().fieldsData,angular.copy(alertFieldsDataArray[index]));alrtEditOperation=!0,alrtIndex=index,obj.name=obj.title,$scope.editingAlertField=angular.copy(obj),showModalSlider("showAlertFieldSlider")},$scope.alrtFldObjRowDel=function(index){NotificationService.alert(i18n.i18nString("you_really_want_to_delete_parameter"),deleteAlertField,arguments)},$scope.onAlertFieldSave=function(alertfield,showIt,rqObjSave){var row={Name:alertfield.title,Key:alertfield.key,"Field Control Type":getFieldType(alertfield.fieldType)};"action"===$scope.wfType&&(row.Type=alertfield.actionFieldType),alrtEditOperation?(alertFieldForTable.rows.splice(alrtIndex,1,row),$scope.alrtField.alrtFldObjects=alertFieldForTable,alertFieldsDataArray.splice(alrtIndex,1,alertfield),$scope.alertFieldsDefinition=alertFieldsDataArray,alrtEditOperation=!1):(alertFieldForTable.rows.push(row),$scope.alrtField.alrtFldObjects=alertFieldForTable,alertFieldsDataArray.push(alertfield),$scope.alertFieldsDefinition=alertFieldsDataArray),showIt?$scope.editingAlertField={}:hideModalSlider(),rqObjSave&&$scope.setRequestObject("",$scope.isFormValid(),!1,!0)};var alertFieldsDataArray,alertFieldForTable,reqObjsToSend,reqDataForTAble,reqDataArray,hideModalSlider=function(sliderForm){"showAlertFieldSlider"===sliderForm||"showProcForm"===sliderForm||"showReqForm"===sliderForm?($scope[sliderForm]=!0,setTimeout(function(){$scope.modalSlider.close("#commonId")},500)):sliderForm?setTimeout(function(){$scope.modalSlider.close(sliderForm)},500):setTimeout(function(){$scope.modalSlider.close("#commonId")},500),setTimeout(function(){$scope.showAlertFieldSlider=!1,$scope.showReqForm=!1,$scope.showProcForm=!1},250)},showModalSlider=function(sliderForm){var overflowResult=$(".modal-body.modal-body-nopadding .creation .main-content").hasClass("overflowUnset");overflowResult||$(".modal-body.modal-body-nopadding .creation .main-content").addClass("overflowUnset");"showAlertFieldSlider"===sliderForm||"showProcForm"===sliderForm||"showReqForm"===sliderForm?($scope[sliderForm]=!0,setTimeout(function(){$scope.modalSlider.open("#commonId"),"showProcForm"===sliderForm?($("#processName").focus(),PerfectScrollbar.destroy($("#btFullpageModal .main-content")[0]),PerfectScrollbar.initialize($("#commonId .requestProcessor")[0])):"showReqForm"===sliderForm?($("#requestNameApi").focus(),PerfectScrollbar.destroy($("#btFullpageModal .main-content")[0]),PerfectScrollbar.initialize($("#commonId .requestApi")[0])):"showAlertFieldSlider"===sliderForm&&($("#alertFieldName").focus(),PerfectScrollbar.destroy($("#btFullpageModal .main-content")[0]),PerfectScrollbar.initialize($("#commonId .alertFieldFormScroll")[0]))},500)):setTimeout(function(){$scope.modalSlider.open(sliderForm)},500)},_fieldTypes=$workflowService.seedData().fieldsData.fieldType;$scope.$watch("reqObj.datatype",function(newVal,oldVal){newVal||($scope.reqObjForm.datatype.$dirty=!0)}),$timeout(function(){$("#requestAccordion .panel").off("hidden.bs.collapse").on("hidden.bs.collapse",function(e){$scope.updateContentType()})}),$scope.updateContentType=function(){Object.keys(finalObj).length>0&&($scope.reqObj.datatype=$filter("filter")($scope.datatypes,{value:finalObj.dataType})[0])},$scope.showDivs={dataType:!1,sampleResponse:!1,hasUserEndpoint:!1,alertFields:!1,requestChain:!1,alertsPath:!1,linksPath:!0};var _alertType,getAlertType=function(wfType){return"alert"===wfType&&(_alertType||(_alertType=$workflowService.alertInfo().type)),_alertType};getAlertType($scope.wfType);var setHelpLink=function(wfType){$scope.helpLink="";var _info="alert"===wfType?$workflowService.alertInfo():$workflowService.actionInfo(),_connectionType=_info.type;"webservice"===_connectionType&&(_connectionType=_info.subtype),"alert"===wfType?"rss"===_connectionType?$scope.helpLink=$rootScope.helpLinks.ALERT_REQ_RSS:"webhook"===_connectionType?$scope.helpLink=$rootScope.helpLinks.ALERT_REQ_WEBHOOK:"rest"===_connectionType?$scope.helpLink=$rootScope.helpLinks.ALERT_REQ_REST:"soap"===_connectionType&&($scope.helpLink=$rootScope.helpLinks.ALERT_REQ_SOAP):"action"!==wfType||$scope.isReport?"action"===wfType&&$scope.isReport&&("rest"===_connectionType?$scope.helpLink=$rootScope.helpLinks.INFORMATION_REQ_REST:"soap"===_connectionType&&($scope.helpLink=$rootScope.helpLinks.INFORMATION_REQ_SOAP)):"rest"===_connectionType?$scope.helpLink=$rootScope.helpLinks.ACTIONS_REQ_REST:"soap"===_connectionType&&($scope.helpLink=$rootScope.helpLinks.ACTIONS_REQ_SOAP)};setHelpLink($scope.wfType),$scope.userEndpoint=function(){$scope.reqObj.hasUserEndpoint===!0&&($scope.showDivs={dataType:!1,sampleResponse:!0,hasUserEndpoint:!0,alertFields:!0,requestChain:!1,alertsPath:!1,linksPath:!0})};var setShowDivs=function(wfType){if("alert"===wfType)switch(_alertType){case"webhook":$scope.showDivs.dataType=!0,$scope.showDivs.sampleResponse=!0,$scope.showDivs.alertsPath=!0,$scope.showDivs.linksPath=!1;break;case"webservice":$scope.showDivs.dataType=!0,$scope.showDivs.sampleResponse=!0,$scope.showDivs.alertFields=!0,$scope.showDivs.requestChain=!0;break;case"rss":$scope.showDivs.hasUserEndpoint=!0,$scope.showDivs.sampleResponse=!0,$scope.showDivs.dataType=!0,$scope.showDivs.alertFields=!0,$scope.showDivs.requestChain=!0}else"action"===wfType&&($scope.showDivs={dataType:!1,sampleResponse:!0,hasUserEndpoint:!1,alertFields:!0,requestChain:!0,linksPath:!1})};setShowDivs($scope.wfType),$scope.showRequestChainDiv=function(wfType){return"alert"===wfType&&$workflowService.alertInfo()&&"webhook"===$workflowService.alertInfo().type?!1:!0},$scope.showRQForm=function(){editOperation=!1,editIndex=null,"alert"===$scope.wfType?$scope.editingReqChain={rcMethod:"GET"}:$scope.editingReqChain={},$scope.rqMode="create",showModalSlider("showReqForm")},$scope.validateRequestChainSel=function(fromTestRC){var isJsonValid,datatype=$scope.reqObj.datatype;if(notifyFormStatus(),"alert"===$scope.wfType){try{isJsonValid=Object.keys($scope.reqObj.sampledata).length>0}catch(ex){isJsonValid=!1}return fromTestRC&&(isJsonValid=!0),"alert"===$scope.wfType&&"webhook"===getAlertType()?isJsonValid?!0:!1:"alert"===$scope.wfType&&"rss"===getAlertType()&&$scope.reqObj.hasUserEndpoint?isJsonValid?!0:!1:datatype&&$scope.reqObj.requestChainObjects&&$scope.reqObj.requestChainObjects.rows&&$scope.reqObj.requestChainObjects.rows.length>0&&isJsonValid}var actionName=$workflowService.actionInfo().name;return actionName=actionName&&actionName.toLowerCase(),"outgoing webhook"===actionName?!0:$scope.reqObj.requestChainObjects&&$scope.reqObj.requestChainObjects.rows&&$scope.reqObj.requestChainObjects.rows.length>0},$scope.closealertFieldsModal=function(){hideModalSlider()},$scope.showAlertFieldForm=function(){showModalSlider("showAlertFieldSlider"),$scope.editingAlertField={},alrtEditOperation=!1},$scope.orderRQChain=function(type,index){var from=index;"up"===type?$util.swap([reqObjsToSend,reqDataForTAble.rows,reqDataArray],from,from-1):$util.swap([reqObjsToSend,reqDataForTAble.rows,reqDataArray],from,from+1),$scope.requestChain=reqDataArray,$scope.reqObj.requestChainObjects=reqDataForTAble,$scope.reqObjForm.$setDirty()},$scope.orderFields=function(type,index){var from=index;"up"===type?$util.swap([alertFieldForTable.rows,alertFieldsDataArray],from,from-1):$util.swap([alertFieldForTable.rows,alertFieldsDataArray],from,from+1),$scope.alrtField.alrtFldObjects=alertFieldForTable,$scope.alertFieldsDefinition=alertFieldsDataArray,$scope.reqObjForm.$setDirty()};var resourceId,sampleResponse={};$scope.setRequestObject=function(saveFrom,isValid,dontSave,stopNavigation,cb){if($scope.stopNavigation=stopNavigation,$scope.invalidSampleRes)return void NotificationService.notify(i18n.i18nString("provide_valid_Response"),"error");if($scope.reqObj.datatype){if(isValid){if($scope.reqObj.linksPath&&(!$scope.reqObj.linkPreview||0===getLinkPreviewKeys($scope.reqObj.linkPreview).length))return void NotificationService.notify(i18n.i18nString("please_enable_atleast_one_preview_link"),"error")}else if($scope.reqObjForm._touched=!0,notifyFormStatus(),$scope.reqObjForm.linksPath&&$scope.reqObjForm.linksPath.$invalid)return;$workflowService.saveFrom(saveFrom),$scope.saveInProgress=!dontSave;try{sampleResponse=JSON.stringify($scope.reqObj.sampledata),sampleResponse=JSON.parse(sampleResponse)}catch(ex){if(!$scope.reqObj.hasUserEndpoint)return void NotificationService.notify(i18n.i18nString("enter_Valid_sample_Response"),"error")}var _reqObjsToSend=arrangeReqChains(reqObjsToSend),_rquestObject={};if($scope.reqObj.taskInitializer?_rquestObject.initializer=[getTaskInitializerPayload($scope.reqObj.taskInitializer)]:_rquestObject.initializer=[],"alert"===$scope.wfType){switch(_rquestObject.type=getAlertType(),resourceId=$workflowService.alertInfo()._id,_rquestObject.linksPath=$scope.reqObj.linksPath||"",_rquestObject.linkPreviewKeys=_rquestObject.linksPath?getLinkPreviewKeys($scope.reqObj.linkPreview):[],getAlertType()){case"webhook":_rquestObject.dataType=$scope.reqObj.datatype&&$scope.reqObj.datatype.value,_rquestObject.alertsPath=$scope.reqObj.alertsPath,_rquestObject.sample=JSON.stringify(sampleResponse?sampleResponse:{}),delete _rquestObject.linksPath,delete _rquestObject.linkPreviewKeys;break;case"webservice":_rquestObject.dataType=$scope.reqObj.datatype&&$scope.reqObj.datatype.value,_rquestObject.sample=JSON.stringify(sampleResponse?sampleResponse:{}),_rquestObject.requestChain=_reqObjsToSend,_rquestObject.alertFieldsRequired=alertFieldsDataArray.length>0,_rquestObject.alertFieldsDefinition=alertFieldsDataArray;break;case"rss":_rquestObject.alertFieldsRequired=alertFieldsDataArray.length>0,_rquestObject.alertFieldsDefinition=alertFieldsDataArray,$scope.reqObj.hasUserEndpoint===!0?(_rquestObject.hasUserEndpoint=!0,_rquestObject.sample=JSON.stringify(sampleResponse?sampleResponse:{})):(_rquestObject.dataType=$scope.reqObj.datatype.value,_rquestObject.sample=JSON.stringify(sampleResponse?sampleResponse:{}),_rquestObject.requestChain=_reqObjsToSend)}if($workflowService.requestData(_rquestObject),$workflowService.requestChainObjects(_rquestObject.requestChain),$workflowService.alrtFldObjects(_rquestObject.alertFieldsDefinition),dontSave)return;BTAlertsService.createBTAlertUp(resourceId,_rquestObject).then(function(res){$workflowService.alertInfo(res.data),$rootScope.$broadcast("event:sampelResponeChange",res.data.sample),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo),cb||NotificationService.notify(i18n.i18nString("request_data"),"success"),stopNavigation||$scope.onComplete(),updateAlertsAndActions(cb),$scope.saveInProgress=!1,$scope.afterSave(),$scope.reqObjForm&&($scope.reqObjForm.$dirty=!1,$scope.reqObjForm.$setPristine(!0))},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("failed_save_request"),"error")})}else if("action"===$scope.wfType){alertFieldsDataArray.map(function(field,index){field.fieldIndex=index}),_rquestObject.payloadField=angular.copy($filter("filter")(alertFieldsDataArray,{actionFieldType:"payloadfield"})),_rquestObject.queryField=angular.copy($filter("filter")(alertFieldsDataArray,{actionFieldType:"queryfield"})),_rquestObject.payloadField.length&&_rquestObject.payloadField.forEach(function(field){delete field.actionFieldType}),_rquestObject.queryField.length&&(_rquestObject.hasQueryField=!0,_rquestObject.queryField.forEach(function(field){delete field.actionFieldType}));var actionName=$workflowService.actionInfo().name;if(actionName&&"outgoing webhook"!==actionName.toLowerCase()?_rquestObject.requestChain=_reqObjsToSend:(_rquestObject.type="webhook",_rquestObject.hasUserEndpoint=!0),_rquestObject.sample=JSON.stringify(sampleResponse?sampleResponse:{}),resourceId=$workflowService.actionInfo()._id,$workflowService.requestData(_rquestObject),$workflowService.requestChainObjects(_rquestObject.requestChain),$workflowService.alrtFldObjects(_rquestObject.alertFieldsDefinition),dontSave)return;BTActionsService.updateBTAction(resourceId,_rquestObject).then(function(res){$workflowService.actionInfo(res.data),$rootScope.$broadcast("event:sampelResponeChange",res.data.sample),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo),cb||NotificationService.notify(i18n.i18nString("request_data"),"success"),stopNavigation||$scope.onComplete(),updateAlertsAndActions(cb),$scope.saveInProgress=!1,$scope.afterSave(),$scope.reqObjForm&&($scope.reqObjForm.$dirty=!1,$scope.reqObjForm.$setPristine(!0))},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("failed_save_request"),"error")})}}},$workflowService.registerModalHiddenEvent(),$scope.goToResStep=function(){$scope.onComplete()},$scope.onFilterFormCancel=function(){$scope.filterFrm=!1},$scope.onFieldFormCancel=function(data){hideModalSlider()},$scope.fieldFormCancel=function(){$scope.api.close(),$scope.api.afterClose(),$scope.api.onCancel(),$scope.testOnProgress=!1,$scope.requestChainTest=!1},$scope.authFormCancel=function(){$scope.spinner.testingInProgress=!1},$scope.setUpLinksPath=function(clear){clear||($scope.reqObj.linksPath="",$scope.reqObj.linkPreview={})},$scope.onRqFormCancel=function(data){hideModalSlider()},$scope.startRQChainTest=function(account){function verifyInitializer(account){$scope.setRequestObject("initializer",$scope.isFormValid(),!1,!0,executeInitializer)}function executeInitializer(){if($workflowService.requestData({}),task=angular.merge(finalObj,$workflowService.requestData()),task.initializer.length){var payload={idp:task.idp,tenant:$scope.idpConfig.tenant,entity:{type:$scope.wfType,id:task._id},sso_type:$scope.idpConfig.sso_type,userId:$applicationService.userInfo().userId,streamAccountId:account?account.streamAccountId:null,initializer:task.initializer,actionId:task._id};BTStreamsService.ExecuteInitializer(payload).then(function(res){var response=res.data.response,message="";return response&&response[0]&&400===response[0].status?(message="ResolveError"===response[0].name?JSON.parse(response[0].message).errors[0].msg:response[0].message,setTimeout(function(){NotificationService.notify(i18n.i18nString("initializer_Execution_failed")+message,"error")},500),$scope.spinner.testingInProgress=!1,void loader()):void $scope.setRequestObject("",$scope.isFormValid(),!1,!0,triggerTaskTest)},function(err){loader(),$scope.spinner.testingInProgress=!1,NotificationService.notify(i18n.i18nString("something_went_wrong"),"error")})}else triggerTaskTest(account)}function triggerTaskTest(account){loader();var taskConfig={type:"l"===task._id[0]?"alert":"action",testFor:"task",definition:task};$workflowService.requestData({}),task=angular.merge(finalObj,$workflowService.requestData()),taskConfig.definition=task,taskTestListenersRegistration(),$scope.btTestStatus.streamAccountId=account?account.streamAccountId:$scope.btTestStatus.streamAccountId||"none",taskConfig.accountId=$scope.btTestStatus.streamAccountId,$scope.btTestFormApi.init(taskConfig)}if(!$scope.isFormValid(!0))return void NotificationService.notify(i18n.i18nString("please_fill_up_all_required_details"),"warning");var loader=NotificationService.loader(i18n.i18nString("initializing_request_chain")),task=null,idpConfig=null;$scope.spinner.testingInProgress=!0,$workflowService.requestData({}),task=angular.merge(finalObj,$workflowService.requestData()),idpConfig=angular.copy($scope.idpConfig),"none"!=task.idp||"none"!=task.sso_type?(idpConfig=idpConfig||{},
idpConfig.type="idp",idpConfig.testFor="idp",idpTestListenersRegistration(verifyInitializer),account?verifyInitializer(account):(loader(),$scope.btTestFormApi.init(idpConfig))):verifyInitializer()},$scope.clear=function(){for(var i=0;i<reqDataForTAble.length;i++)try{$scope.reqChainObjRowDel(i)}catch(ex){console.log(ex)}for(i=0;i<alertFieldsDataArray.length;i++)try{$scope.alrtFldObjRowDel(i)}catch(ex){console.log(ex)}$scope.reqObj={requestChainObjects:[]}},$scope.cancel=function(){bindValuesInEditMode(),$scope.onCancel(),$location.path(window.appConfig.CONTEXT_PATH)},bindValuesInEditMode(),$scope.isFormValid=function(fromTestRC){return $scope.reqObjForm&&$scope.reqObjForm.$invalid?(form_util.touch($scope.reqObjForm),!1):$scope.validateRequestChainSel(fromTestRC)||$scope.saveInProgress},$scope.$on("evt:nextActReq",function(evt,data){$scope.moveTo=data,$scope.reqObjForm.$valid?$scope.setRequestObject("",$scope.isFormValid()):(NotificationService.notify(i18n.i18nString("please_enter_valid_data"),"error"),$rootScope.saveAndExit=!1)}),$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.$watch(function(){$scope.reqObjForm._touched&&$scope.isFormValid()}),$scope.$watch("displayMode",function(newVal,oldVal){"view"===newVal?$scope.options={mode:"tree",ace:window.ace}:$scope.options={mode:"code",ace:window.ace}});var processEdit="no-index";$scope.showProcForm=!1,$scope.processInEdit=!1,$scope.processors=[],$scope.newProcessor=function(){editOperation=!1,$scope.processor=null,processEdit="no-index",$scope.processInEdit=!1,showModalSlider("showProcForm")},$scope.editProcess=function(index){editOperation=!0,processEdit=index,$scope.processor=unprepareProcessPayload(angular.copy(reqObjsToSend[index].api)),showModalSlider("showProcForm"),$scope.processInEdit=!0},$scope.removeProcess=function(index){$scope.reqObj.requestChainObjects(index,1)},$scope.processorSave=function(processor,rqObjSave){"_resolve"!=processor.processType&&Object.keys(processor).map(function(key){"processType"!=key&&"processKey"!=key&&"linkType"!=key&&"processName"!=key&&"processCustomCode"!=key&&"processOutVar"!=key&&delete processor[key]}),"no-index"!==processEdit?$scope.onReqObjFormSave({api:prepareProcessPayload(processor)},!0,rqObjSave):$scope.onReqObjFormSave({api:prepareProcessPayload(processor)},!0,rqObjSave),hideModalSlider()},$scope.processorCancel=function(){hideModalSlider()},function(){init()}(),$scope.hooks.isChanged=function(){return $scope.isWebhook()?$scope.reqObjForm&&$scope.reqObjForm.$dirty:$scope.reqObjForm&&$scope.reqObjForm.$dirty||$scope.authHooks.isChanged()},$scope.hooks.triggerSave=function(callback){$scope.afterSave=callback,!$scope.isWebhook()&&$scope.authHooks.isChanged()&&$scope.authHooks.triggerSave($scope.reqObjForm.$dirty?null:callback),$scope.reqObjForm.$dirty&&$scope.setRequestObject("",$scope.isFormValid($scope.reqObjForm),!1,!0)},window.onbeforeunload=function(event){return $scope.reqObjForm&&$scope.reqObjForm.$dirty?i18n.i18nString("auth_form_alert"):void 0},$scope.$on("$locationChangeStart",function(event,next,current){function successCb(){$scope.setRequestObject("",$scope.isFormValid($scope.reqObjForm),!1,!0)}function failCb(){$scope.reqObjForm.$dirty=!1,$location.path(next)}$scope.reqObjForm.$dirty&&"view"!==$scope.displayMode&&(event.preventDefault(),$scope.afterSave=failCb,NotificationService.confirm({msg:i18n.i18nString("bt_wf_proceeding_noty"),successCb:successCb,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("save"),fail:i18n.i18nString("discard_label")}}))}),$scope.onFinishSetup=function(type){$scope.configure({type:type})},$scope.taskInitCB.onBlur=function(){var taskInfo="alert"===$scope.wfType?$workflowService.alertInfo():$workflowService.actionInfo();_.isEqual([getTaskInitializerPayload($scope.reqObj.taskInitializer)],taskInfo.initializer)||_.isEqual($scope.reqObj.taskInitializer||[],taskInfo.initializer)?$scope.reqObjForm.$dirty=!1:$scope.reqObjForm.$dirty=!0},$scope.sampleResCB.onBlur=function(editor){$scope.reqObjForm.$dirty=!0,$scope.invalidSampleRes=!1;var _value=editor.getText();if(""===_value)$scope.reqObj.sampledata={};else try{JSON.parse(_value)}catch(e){$scope.invalidSampleRes=!0}},$scope.showTaskInitializerOption=function(){$scope.showTaskInitializer?($scope.showTaskInitializer=!1,$("#reqObjTaskInitWrapDiv .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showTaskInitializer=!0,$("#reqObjTaskInitWrapDiv .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"))},$scope.showResponseDataOption=function(){$scope.showResponseData?($scope.showResponseData=!1,$("#reqObjResDataWrapDiv .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showResponseData=!0,$("#reqObjResDataWrapDiv .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"))}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("responseObjectForm",function(){return{restrict:"AE",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/response-object-form/response-object-form.html",scope:{wfType:"@",onComplete:"&",onCancel:"&",displayMode:"@",configure:"&",hooks:"=?callbacks",resource:"="},controller:["$scope","form_util","$q","$util","koreUxMap","$location","$timeout","tokenizerFilter","BTIdpService","NotificationService","BTAlertsService","$workflowService","BTActionsService","BTFiltersService","BTParamMapService","$filter","textparser","$rootScope","BTStreamsService","$routeParams","env_conf","BTFlowtaskService","$applicationService","i18n",function($scope,form_util,$q,$util,koreUxMap,$location,$timeout,tokenizerFilter,BTIdpService,NotificationService,BTAlertsService,$workflowService,BTActionsService,BTFiltersService,BTParamMapService,$filter,textparser,$rootScope,BTStreamsService,$routeParams,env_conf,BTFlowtaskService,$applicationService,i18n){function responseObjSaveHelper(cb){var responseObj={};if(responseObj.channelUxMap=$scope.resObj.channelUxMap,responseObj.channelUxMap=_.filter(responseObj.channelUxMap,function(channelUxMapitem){return"wfacebookG"===channelUxMapitem.channel?(channelUxMapitem.channel="wfacebook",channelUxMapitem.isMention=!0):"wfacebookC"===channelUxMapitem.channel&&(channelUxMapitem.channel="wfacebook",channelUxMapitem.isMention=!1),channelUxMapitem.body.trim().length>0}),responseObj.koreUxMap={title:wrapItInside($scope.resObj.postTitle2,$scope.resObj.postTitle),body:wrapItInside($scope.resObj.postDescription2,$scope.resObj.postDescription),titleKeyword:$scope.resObj.titleKeyword},"alert"===$scope.wfType){var _alertObj=$workflowService.alertInfo();resourceId=_alertObj._id,responseObj.type=_alertObj.type,$workflowService.responseData(responseObj),$workflowService.workflowFilters(responseObj.alertFilterDefinition),BTAlertsService.createBTAlertUp(resourceId,responseObj).then(function(res){$scope.saveInProgress=!1,$workflowService.alertInfo(res.data),$scope.stopNavigation||$scope.onComplete(),$scope.isFromFinish&&$scope.configure({type:$routeParams.resourceType}),$scope.hideNotifier||NotificationService.notify(i18n.i18nString("save_response_object_success"),"success"),$scope.afterSave(),$scope.resObj.channelUxMap=res.channelUxMap,updateAlertsAndActions(cb),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo)},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("failed_to_save_response_object"),"error")})}else"action"===$scope.wfType&&(resourceId=$workflowService.actionInfo()._id,$workflowService.workflowFilters(responseObj.alertFilterDefinition),BTActionsService.updateBTAction(resourceId,responseObj).then(function(res){$workflowService.actionInfo(res.data),$scope.stopNavigation||$scope.onComplete(),$scope.isFromFinish&&$scope.configure({type:$routeParams.resourceType}),$scope.hideNotifier||NotificationService.notify(i18n.i18nString("save_response_object_success"),"success"),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo),$scope.saveInProgress=!1,$scope.afterSave(),$scope.resObj.channelUxMap=res.channelUxMap,updateAlertsAndActions(cb)},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("failed_to_save_response_object"),"error")}))}function resetReportInfo(){var entity="alert"===$scope.wfType?$workflowService.alertInfo():$workflowService.actionInfo(),config={isReport:!1,report:{}};return"alert"===$scope.wfType?BTAlertsService.createBTAlertUp(entity._id,config):"action"===$scope.wfType?BTActionsService.updateBTAction(entity._id,config):void 0}function updateAlertsAndActions(cb){if("alert"===$scope.wfType){var _alertInfo=$workflowService.alertInfo();_alertInfo.taskType="alert",$scope.$emit("mpResourceUpdate",_alertInfo),$q.all([BTAlertsService.getMPAlert(resourceId),BTAlertsService.getBTAlert(resourceId)]).then(function(res){finalObj={},$workflowService.alertInfo(res[1].data),$workflowService.mpAlertInfo(res[0].data),angular.extend(finalObj,angular.copy(res[1].data)),angular.extend(finalObj,angular.copy(res[0].data)),$workflowService.responseData(finalObj),initialize(cb)},function(err){NotificationService.notify(i18n.i18nString("error_msg"),"error"),$workflowService.mpAlertInfo({}),$workflowService.alertInfo({})})}else if("action"===$scope.wfType){var _actionInfo=$workflowService.actionInfo();_actionInfo.taskType="action",$scope.$emit("mpResourceUpdate",_actionInfo),$q.all([BTActionsService.getBTAction(resourceId),BTActionsService.getMPAction(resourceId)]).then(function(res){finalObj={},$workflowService.actionInfo(res[0].data),$workflowService.mpActionInfo(res[1].data),angular.extend(finalObj,angular.copy(res[1].data)),angular.extend(finalObj,angular.copy(res[0].data)),$workflowService.responseData(finalObj),initialize(cb)},function(err){NotificationService.notiy(i18n.i18nString("error_msg"),"error"),$workflowService.mpActionInfo({}),$workflowService.actionInfo({})})}}function initialize(cb){$scope.resObjCopy={},$scope.alertFilter={alrtFilterObjects:[]},$scope.alertFilter.alrtFilterObjects=[],finalObj={},filterInfo=[],editingFilter={},alertInfo={},mpAlertInfo={},actionInfo={},mpActionInfo={},_sKey=null,_sReqChain=null,filterObjArry=[],_filterTableObj={},$scope.editOperation=null,editIndex=null,_filterTableObj.headers=$filter("orderBy")([{name:"Filter Name",sortable:!0},{name:"DataType",sortable:!1},{name:"FieldType",sortable:!1}],"name"),_filterTableObj.rows=[],"alert"===$scope.wfType?(alertInfo=$workflowService.alertInfo(),mpAlertInfo=$workflowService.mpAlertInfo(),finalObj=angular.copy(alertInfo),angular.extend(finalObj,angular.copy(mpAlertInfo))):"action"===$scope.wfType&&(actionInfo=$workflowService.actionInfo(),mpActionInfo=$workflowService.mpActionInfo(),finalObj=angular.copy(actionInfo),angular.extend(finalObj,angular.copy(mpActionInfo))),Object.keys(finalObj).length>0&&("alert"===$scope.wfType&&BTFiltersService.getFiltersByAlertId(alertInfo._id,alertInfo.version).then(function(res){filterInfo=res.data,angular.forEach(filterInfo,function(obj,index){$scope.onAlertFilterSave(angular.copy(obj))})}),finalObj.sample=convertToObj(finalObj.sample),finalObj.channelUxMap=_.isArray(finalObj.channelUxMap)?finalObj.channelUxMap:[],$scope.resObj.responseMsg=((finalObj.channelUxMap.filter(function(channel){return"default"===channel.channel})[0]||{}).body||"").trim(),$scope.resObj.channelUxMap=$scope.modifyChannelContent(finalObj.channelUxMap),$scope.resObj.postTitle=finalObj.koreUxMap?finalObj.koreUxMap.title:"",$scope.resObj.postTitle=$scope.resObj.postTitle&&$scope.resObj.postTitle.trim(),$scope.resObj.postDescription=finalObj.koreUxMap?finalObj.koreUxMap.body:"",$scope.resObj.postDescription=$scope.resObj.postDescription&&$scope.resObj.postDescription.trim(),$scope.resObj.postTitle=divideValues($scope.resObj.postTitle,"title"),$scope.resObj.postDescription=divideValues($scope.resObj.postDescription,"desc"),$scope.resObj.postTitle=concatString($scope.resObj.postTitle),$scope.resObj.postDescription=concatString($scope.resObj.postDescription),$scope.resObj.titleKeyword=finalObj.koreUxMap?finalObj.koreUxMap.titleKeyword:"",$scope.resObj.ddStrategy=finalObj.ddStrategy||"None",$scope.resObj.identifier=finalObj.identifier&&finalObj.identifier.length>0?finalObj.identifier.join(","):null,$scope.resObj.postTitle=($scope.resObj.postTitle||"").trim(),$scope.resObj.postDescription=($scope.resObj.postDescription||"").trim(),$scope.tabs.title.tab_2=!!$scope.resObj.postTitle&&!0,$scope.tabs.description.tab_2=!!$scope.resObj.postDescription&&!0,_sampleResponse=finalObj.sample,_sReqChain=finalObj.requestChain,$scope.resObj.report=finalObj.isReport,getKeysInSampleResponse(finalObj.sample),$timeout(function(){$scope.resObjForm&&($scope.resObjForm.$dirty=!1)}),Object.keys($scope.resObj).map(function(key){$scope.resObjCopy[key]=$scope.resObj[key]}),$scope.resObjCopy.channelUxMap=angular.copy($scope.resObj.channelUxMap),$scope.hideNotifier=!1),$scope.$broadcast("onTemplateConfSaveSuccess",{}),cb&&($scope.config.task=finalObj,cb())}function openModal(){$(".addfilter").modal({show:!0,backdrop:"static"});var obj=angular.copy(filterObjArry[editIndex]);$scope.editingFilter={_id:obj._id,name:obj.name,hlep:obj.help,fieldName:obj.lhsKey,dataType:obj.type,fieldType:obj.rhsInputType.inputType,supportedOperations:angular.copy(obj.supportedOperations),rhsInputType:obj.rhsInputType}}function getKeysInSampleResponse(paramMap){paramMap=extract(paramMap),$scope.taskresponse=paramMap,BTParamMapService.getDotKeys(paramMap).then(function(res){$scope.sampleResponseKeys=res.data,$timeout(function(){segmentKoreUxMap()})},function(res){console.warn(res&&res.data&&res.data.error)})}function extract(sample){var obj;return sample=convertToObj(sample),_sampleResponse=sample,obj="alert"===$scope.wfType?$workflowService.alertInfo():$workflowService.actionInfo(),_sReqChain=obj.requestChain||[],"webhook"===obj.type?_sKey=obj.alertsPath:_sReqChain.map(function(chain){"processor"===chain.linkType&&"_extract"===chain.linkDefinition.type&&(_sKey=chain.linkDefinition.key)}),_sKey&&sample?_sampleResponse&&_sKey?resolveObjectPath(_sampleResponse,_sKey):_sampleResponse:sample}function filterDelete(index,row){var obj=angular.copy(filterObjArry[index]);BTFiltersService.deleteFilter(obj._id).then(function(res){$scope.alertFilter.alrtFilterObjects.rows.splice(index,1),_filterTableObj.rows.splice(index,1),filterObjArry.splice(index,1),NotificationService.notify(i18n.i18nString("delete_filter_success"),"success")},function(err){NotificationService.notify(i18n.i18nString("delete_filter_failed"),"error")})}function wrapItInside(print,code){if(print){print=print.replace(/<p>|<\/p>/g,""),print=textparser.reWrap(print),print=print.replace(/<%=|%>|<%/g,"+");var chunks=print.replace(/(<.*?>)/g,"+$1+").split("+").filter(function(chunk){return chunk?chunk:void 0}).map(function(chunk){return chunk&&-1!==chunk.search(/<.*?>/)?chunk="'"+chunk+"'":insideTitleVars(chunk)||insideKeys(chunk)||insideDescVars(chunk)?chunk:chunk="'"+chunk+"'"}).join("+");print=chunks.replace(/'\+'/g,"").replace(/\s?class="medium-[i|b|u]"/g,"")}else print="";return code=code?code:"",print=print?"var printf=print; printf("+print+")":"","<% "+code+print+" %>"}function divideValues(value,type){if(!value)return value;value=(value.replace(/var printf=print;/g,"")||"").trim();var result=/printf\s?[(](.+)[)]/g.exec(value);return"title"===type?($scope.resObj.postTitle2=(result&&2===result.length?result[1]:"").trim(),$scope.resObj.postTitle2&&value&&(value=value.replace(/printf/g,"print"),$scope.resObj.postTitle2="")):"desc"===type?($scope.resObj.postDescription2=(result&&2===result.length?result[1]:"").trim(),$scope.resObj.postDescription2&&value&&(value=value.replace(/printf/g,"print"),$scope.resObj.postDescription2="")):"response"===type&&($scope.resObj.responseMsg2=(result&&2===result.length?result[1]:"").trim(),$scope.resObj.responseMsg2=reTransformIt($scope.resObj.responseMsg2)),value=value.replace(/printf\s?[(](.+)[)];?/g,"").trim()}function concatString(print){if(print)for(;print.match(/<%=\s?(<.?>)?(.+?)(<\/.?>)?\s?%>/);)print=print.replace(/<%=\s?(<.?>)?(.+?)(<\/.?>)?\s?%>/,"print($2)");else print="";return print=print.replace(/<%=|%>|<%/g,"")}function insideKeys(key){if(!$scope.sampleResponseKeys)return!1;for(var i=0;i<$scope.sampleResponseKeys.length;i++)if(key===$scope.sampleResponseKeys[i])return!0;return!1}function insideTitleVars(key){if(!$scope.titleVars)return!1;for(var i=0;i<$scope.titleVars.length;i++)if(key===$scope.titleVars[i])return!0;return!1}function insideDescVars(key){if(!$scope.descVars)return!1;for(var i=0;i<$scope.descVars.length;i++)if(key===$scope.descVars[i])return!0;return!1}function reTransformIt(values,type){if(!values)return values;values=values.replace(/'+/g,""),values=values.split("+");for(var i=0;i<values.length;i++)"desc"===type&&insideDescVars(values[i])?values[i]="<%"+values[i]+"%>":"title"===type&&insideTitleVars(values[i])?values[i]="<%"+values[i]+"%>":insideKeys(values[i])&&(values[i]="<%="+values[i]+"%>");return values.join("")}function segmentKoreUxMap(){$scope.titleVars=tokenizerFilter($scope.resObj.postTitle),$scope.descVars=tokenizerFilter($scope.resObj.postDescription),$scope.resObj.postTitle2=($scope.resObj.postTitle2?reTransformIt($scope.resObj.postTitle2,"title"):"").trim(),$scope.resObj.postDescription2=($scope.resObj.postDescription2?reTransformIt($scope.resObj.postDescription2,"desc"):"").trim(),$scope.resObj.responseMsg=divideValues($scope.resObj.responseMsg,"response"),$scope.resObj.responseMsg2=reTransformIt($scope.resObj.responseMsg2||"").trim(),$scope.resObj.responseMsg=concatString($scope.resObj.responseMsg).trim(),$scope.tabs.response.tab_1=!!$scope.resObj.responseMsg2,$scope.tabs.response.tab_2=!!$scope.resObj.responseMsg,$scope.tabs.title.tab_1=!!$scope.resObj.postTitle2&&!0,$scope.tabs.description.tab_1=!!$scope.resObj.postDescription2&&!0}function resolveObjectPath(source,path,result){return-1===path.indexOf("$.")&&(path="$.."+path),result=JSONPath({json:source,path:path})[0],result instanceof Array&&(result=result[0]),result||source}function convertToObj(json){try{return"object"==typeof json?json:"string"==typeof json?JSON.parse(json):{}}catch(ex){return{}}}$scope.filterFrm=!0,$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.resObj={},$scope.alertFilter={alrtFilterObjects:[]},$scope.titlePreviewIsOn=!1,$scope.descPreviewIsOn=!1,$scope.saveInProgress=!1,$scope.callbackObject={},$scope.reportCb={},$scope.resObj.report=!1,$scope._constants_=$rootScope._constants_,$scope.resObj.ddStrategy="None",$scope.resObj.channelUxMap=[],$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.optional=i18n.i18nString("optional_label"),$scope.chevronRightDark=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-right-dark.svg",$scope.tabs={title:{tab_1:!1,tab_2:!1},description:{tab_1:!1,tab_2:!1},response:{tab_1:!1,tab_2:!1}},$scope.options={mode:"code",ace:window.ace};var resourceId,_sampleResponse;$scope.hooks=$scope.hooks||{},$scope.afterSave=angular.noop,"edit"!==$scope.displayMode?$scope.saveKoreUxMap=!0:$scope.saveKoreUxMap=!1,"view"===$scope.displayMode&&($scope.options.mode="tree"),$scope.authList=[],BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.config=$scope.config||{},$scope.config.authList=res.data},function(err){$scope.config=$scope.config||{},$scope.config.authList=[]}),function(){$scope.standardKeys=$scope._constants_.koreuxconsts[$scope.wfType+"s"],$scope.reportKeys=$scope._constants_.reportKeys,$scope.sessionKeys={},BTStreamsService.getSessionKeys($workflowService.selectedStream()._id).then(function(res){Object.keys(res.data).map(function(key){res.data[key].map(function(item){$scope.sessionKeys[key+'.get("'+item+'")']=key+'.get("'+item+'")'})}),$scope.config=$scope.config||{},$scope.config.standardKeys=$scope.standardKeys,$scope.config.sessionKeys=$scope.sessionKeys,$scope.config.reportKeys=$scope.reportKeys},function(err){$scope.sessionKeys={},$scope.config=$scope.config||{},$scope.config.standardKeys=$scope.standardKeys,$scope.config.sessionKeys=$scope.sessionKeys,$scope.config.reportKeys=$scope.reportKeys})}(),function(){BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$scope.botVariablesKeys=$workflowService.botEnvVariables(res.data.variables),$scope.botVariables=res.data.variables,$scope.botVariables.forEach(function(obj){obj.originalKey=obj.key}),$scope.tempBotVariables=angular.copy($scope.botVariables)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("unexpected_error_while_fetching_bot_variables"),"error")})}(),$scope.showDedup=function(wfType){return"alert"===wfType&&"webhook"===$workflowService.alertInfo().type?!1:!0},$scope.setResponseObject=function(isInValid,form,event,stopNavigation,isFromFinish,cb){return $scope.stopNavigation=stopNavigation,$scope.isFromFinish=isFromFinish,isInValid?(form_util.touch(form),void(event&&event.preventDefault&&event.preventDefault())):form.reportForm&&form.reportForm.$invalid?(form_util.touch(form.reportForm),void(event&&event.preventDefault&&event.preventDefault())):($scope.saveInProgress=!0,void $q.all([$scope.titlePreviewRep(),$scope.descPreviewRep()]).then(_.bounce,_.bounce).then(function(res){$timeout(function(){$("#jsPrvw_1 a").trigger("click"),$("#jsPrvw_2 a").trigger("click")}),$scope.resObj.report?$rootScope.$broadcast("confSaveTrigger",{callback:responseObjSaveHelper(cb)}):resetReportInfo().then(function(){responseObjSaveHelper(cb)},function(err){NotificationService.notify(i18n.i18nString("failed_to_save_response_object"),"error")})}))},$scope.$on("confSaveFailed",function(){$scope.saveInProgress=!1});var finalObj,filterInfo,editingFilter,alertInfo,mpAlertInfo,actionInfo,mpActionInfo,_sKey,_sReqChain,filterObjArry,_filterTableObj,editIndex=null;$scope.editOperation=null,$workflowService.registerModalHiddenEvent(),$scope.modifyChannelContent=function(channelData){var updateChannelData=[];return updateChannelData=channelData.filter(function(channel){return"wfacebook"===channel.channel&&channel.isMention?channel.channel="wfacebookG":"wfacebook"!==channel.channel||channel.isMention||(channel.channel="wfacebookC"),channel})},initialize(),$scope.notifyUser=function(type,notify){notify&&"normal"===type?NotificationService.notify(i18n.i18nString("chnl_ux_normal_editor_noty")):notify&&"code"===type&&NotificationService.notify(i18n.i18nString("chnl_ux_normal__r_js_editor_noty"))},$scope.saveReport=function(config){console.log(config)},$scope.cancelReport=function(){console.log("called cancel")},$scope.showAlertFilterForm=function(){$scope.filterFrm=!0,$scope.editingFilter={},$scope.editOperation=null},$scope.onAlertFilterSave=function(filter,showIt){"edit"!==$scope.editOperation?(_filterTableObj.rows.push({"Filter Name":filter.name,FieldType:filter.rhsInputType.inputType,DataType:filter.type}),$scope.alertFilter.alrtFilterObjects=angular.copy(_filterTableObj),filterObjArry.push(angular.copy(filter))):(_filterTableObj.rows.splice(editIndex,1,{"Filter Name":filter.name,FieldType:filter.rhsInputType.inputType,DataType:filter.type}),$scope.alertFilter.alrtFilterObjects=angular.copy(_filterTableObj),filterObjArry.splice(editIndex,1,angular.copy(filter)),$scope.editOperation=""),showIt?$scope.editingFilter={}:$(".addfilter").modal("hide")},$scope.cancelResponseSubmition=function(){initialize(),$scope.onCancel(),$location.path(window.appConfig.CONTEXT_PATH)},$scope.clear=function(){$scope.resObj={};for(var i=0;i<filterObjArry.length;i++)try{$scope.filterDataRowDel(i)}catch(ex){}},$scope.onFilterFormCancel=function(data){$(".addfilter").modal("hide"),$scope.editingFilter={}},$scope.filterDataRowEdit=function(index,row){$scope.editOperation="edit",editIndex=index,$(".addfilter").modal({show:!0,backdrop:"static"});var obj=angular.copy(filterObjArry[index]);$scope.editingFilter={_id:obj._id,name:obj.name,hlep:obj.help,fieldName:obj.lhsKey,dataType:obj.type,fieldType:obj.rhsInputType.inputType,supportedOperations:angular.copy(obj.supportedOperations),rhsInputType:obj.rhsInputType}},$scope.filterDataRowView=function(index,row){$scope.editOperation="edit",editIndex=index,openModal()},$scope.$watch("resObj.postTitle",function(newVal){$scope.titleVars=tokenizerFilter(newVal)}),$scope.$watch("resObj.postDescription",function(newVal){$scope.descVars=tokenizerFilter(newVal)}),$scope.filterDataRowDel=function(index,row){NotificationService.alert(i18n.i18nString("delete_filter"),filterDelete,arguments)},$scope.assetsBase=env_conf["assets-url"],$scope.reportIsThere=function(){return finalObj&&"webservice"===finalObj.type&&("action"!==$scope.wfType||$scope.resObj.report)},$scope.orderFilters=function(type,index){var from=index;"up"===type?$util.swap([$scope.alertFilter.alrtFilterObjects.rows,_filterTableObj.rows,filterObjArry],from,from-1):$util.swap([$scope.alertFilter.alrtFilterObjects.rows,_filterTableObj.rows,filterObjArry],from,from+1)},$scope.channelSave=function(channels){$scope.resObj.channelUxMap=channels},$scope.channelCancel=angular.noop,$scope.titleCallback={},$scope.descCallback={},$scope.responseCallback={},$scope.titlePreviewRep=function(){$scope.titlePreviewIsOn=!0;var title=wrapItInside($scope.resObj.postTitle2,$scope.resObj.postTitle),sampleRes=_sampleResponse&&_sKey?resolveObjectPath(_sampleResponse,_sKey):_sampleResponse,payload={payload:sampleRes,koreUxMap:{title:title}};return payload.payload=sampleRes,$scope.titlePreview="",koreUxMap.execute(payload).then(function(res){return res.type="title",$scope.titlePreview=res.result,$scope.titlePreviewIsOn=!1,res},function(err){return err.type="title",err.error=err.error?'<div class="alert alert-sm alert-danger">'+err.error+"</div>":err.error,$scope.titlePreview=err.error,$scope.titlePreviewIsOn=!1,$q.reject(err)})},$scope.descPreviewRep=function(){$scope.descPreviewIsOn=!0;var body=wrapItInside($scope.resObj.postDescription2,$scope.resObj.postDescription),sampleRes=_sampleResponse&&_sKey?resolveObjectPath(_sampleResponse,_sKey):_sampleResponse,payload={payload:sampleRes,koreUxMap:{body:body}};return payload.payload=sampleRes,$scope.descriptionPreview="",koreUxMap.execute(payload).then(function(res){return res.type="desc",$scope.descriptionPreview=res.result,$scope.descPreviewIsOn=!1,res},function(err){return err.type="desc",err.error=err.error?'<div class="alert alert-sm alert-danger">'+err.error+"</div>":err.error,$scope.descriptionPreview=err.error,$scope.descPreviewIsOn=!1,$q.reject(err)})},$scope.responsePreviewRep=function(){$scope.responsePreviewIsOn=!0;var body=wrapItInside($scope.resObj.responseMsg2,$scope.resObj.responseMsg),sampleRes=_sampleResponse&&_sKey?resolveObjectPath(_sampleResponse,_sKey):_sampleResponse,payload={payload:sampleRes,koreUxMap:{body:body}};return payload.payload=sampleRes,$scope.responsePreview="",koreUxMap.execute(payload).then(function(res){return res.type="desc",$scope.responsePreview=res.result,$scope.responsePreviewIsOn=!1,res},function(err){return err.type="desc",err.error=err.error?'<div class="alert alert-sm alert-danger">'+err.error+"</div>":err.error,$scope.responsePreview=err.error,$scope.responsePreviewIsOn=!1,$q.reject(err)})},$scope.$on("event:sampelResponeChange",function(evt,data){getKeysInSampleResponse(data)}),$scope.textparser=textparser,$scope.$on("evt:nextActRes",function(evt,data){$scope.moveTo=data,$scope.setResponseObject($scope.isFormValid(),$scope.resObjForm,evt)}),$scope.isReportFormValid=function(){return $scope.reportCb.getReportForm?$scope.reportCb.getReportForm().$valid?!0:(NotificationService.notify(i18n.i18nString("please_fill_in_Required_fields"),"error"),!1):!0},$scope.isFormValid=function(){var cond_1,defaultChannel=$scope.resObj.channelUxMap.filter(function(uxmap){return"default"==uxmap.channel})[0];return cond_1=defaultChannel&&defaultChannel.body&&defaultChannel.body.trim(),cond_1=cond_1&&defaultChannel.body.replace(/<%\s+?%>/g,"").trim(),$scope.resObj.showUxError=!cond_1,$scope.resObjForm.resposneMsg={$invalid:!cond_1},"alert"===$scope.wfType?!cond_1:"action"===$scope.wfType?!cond_1:!1},$scope.channelApi={wrap:wrapItInside,transform:reTransformIt},$scope.showFinalOut=function(type){return"title"===type?$scope.resObj.postTitle2||$scope.resObj.postTitle?wrapItInside($scope.resObj.postTitle2,$scope.resObj.postTitle):void 0:"desc"===type&&($scope.resObj.postDescription2||$scope.resObj.postDescription)?wrapItInside($scope.resObj.postDescription2,$scope.resObj.postDescription):void 0},$scope.wrapItInside=function(type){return"desc"===type?($scope.resObj.postDescription=concatString($scope.resObj.postDescription),$scope.resObj.postDescription):"title"===type?($scope.resObj.postTitle=concatString($scope.resObj.postTitle),$scope.resObj.postTitle):void 0},$scope.$watch("sampleResponseKeys",function(newVal,oldVal){_.isArray(newVal)?($scope.config=$scope.config||{},$scope.config.task=finalObj,$scope.config.keys=newVal):($scope.config=$scope.config||{},$scope.config.task=finalObj,$scope.config.keys=[])}),$scope.hooks.isChanged=function(){var changed=!1,validUx=!1,omittedKeys=["title2","title","postDescription2","postDescription","responseMsg","channelUxMap"];return Object.keys($scope.resObjCopy).map(function(key){$scope.resObjCopy[key]!=$scope.resObj[key]&&-1==omittedKeys.indexOf(key)&&(changed=!0)}),changed||(changed=$scope.resObjCopy.channelUxMap.length!=$scope.resObj.channelUxMap.length,0===$scope.resObjCopy.channelUxMap.length&&changed&&($scope.resObj.channelUxMap.map(function(channel,i){var string=channel.body||"";string=string.replace(/<%|%>/g,"").trim(),string&&(validUx=!0)}),changed=changed&&validUx)),changed||$scope.resObjCopy.channelUxMap.map(function(channel,i){var string1=channel.body||"",string2=($scope.resObj.channelUxMap[i]||{}).body||"";string1=string1.replace(/<%|%>/g,"").replace(/var printf=print;/g,"").replace(/printf/g,"print").trim(),string2=string2.replace(/<%|%>/g,"").replace(/var printf=print;/g,"").replace(/printf/g,"print").trim(),string2!=string1&&(changed=!0)}),changed},$scope.hooks.triggerSave=function(callback){$scope.afterSave=callback,$scope.setResponseObject($scope.isFormValid(),$scope.resObjForm,null,!1)},window.onbeforeunload=function(event){return $scope.hooks.isChanged()?i18n.i18nString("auth_form_alert"):void 0};var warningAlreadyShown=!1;$scope.$on("$locationChangeStart",function(event,next,current){function successCb(){$scope.setResponseObject($scope.isFormValid(),$scope.resObjForm,null,!0)}function failCb(){$scope.resObjForm.$dirty=!1,warningAlreadyShown=!0,$location.path(next)}$scope.hooks.isChanged()&&!warningAlreadyShown&&"view"!==$scope.displayMode&&(event.preventDefault(),$scope.afterSave=failCb,warningAlreadyShown=!1,NotificationService.confirm({msg:i18n.i18nString("bt_wf_proceeding_noty"),successCb:successCb,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("save"),fail:i18n.i18nString("discard_label")}}))}),$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.callbackObject.afterInitializerExecution=function(triggerTaskTest){$scope.setResponseObject($scope.isFormValid(),$scope.resObjForm,$scope.$event,!0,!1,triggerTaskTest)},$scope.callbackObject.reportIsThere=$scope.reportIsThere,$scope.hideNotifier=!1,$scope.onFinishSetup=function(type){"edit"===$scope.displayMode?($scope.hideNotifier=!1,$scope.configure({type:type})):($scope.hideNotifier=!0,$scope.setResponseObject($scope.isFormValid(),$scope.resObjForm,$scope.$event,!0,!0))}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("sdkSubscriptions",function(){return{restrict:"EA",scope:{newStreamData:"=",
streamId:"=",callback:"=",sdkConf:"=",sdkConfOnModal:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/sdk-subscriptions-form/sdk-subscriptions-form.html",controller:["$scope","form_util","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","$timeout","BTAlertsService","$translator","AppsDataService","$q","i18n",function($scope,form_util,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,$timeout,BTAlertsService,$translator,AppsDataService,$q,i18n){function getSelectedEventIds(){return _.pluck($scope.selectedEvents,"id")}function loadSelectedEvents(eventIds){$scope.events.forEach(function(event){event.checked=!1});eventIds&&eventIds.length&&eventIds.forEach(function(event){var _eve=_.find($scope.events,{id:event});_eve&&(_eve.checked=!0)})}var appnameToRetain="";$scope.sdk={},$scope.initializeData=function(){$scope.sdkConf={appName:"",noSDKConf:!0,clientID:"",clientSecret:"",cbUrl:"",eventSelector:[]},$scope.events=[{name:i18n.i18nString("on_message"),id:"onMessage"},{name:i18n.i18nString("on_hooknode"),id:"onHook"}],$rootScope.appConfig.DISABLE_AGENT_TRANSFER||$scope.events.push({name:i18n.i18nString("sdk_subscriptions_agentTransferNode"),id:"onAgentTransfer"}),$scope.noneSelected=!1,$scope.sdkConfOnModal={appName:"",createAppSuccess:!1,eventSelector:[],clientID:"",cbUrl:""}},$scope.resetSDKConfOnModal=function(){$scope.sdkConfOnModal={appName:"",createAppSuccess:!1,eventSelector:[],clientID:"",cbUrl:""}},$scope._constants_=$rootScope._constants_,$scope.isSafari=!1,$timeout(function(){var clipboard=new Clipboard("[data-clipboard-target]");clipboard.on("success",function(e){}),clipboard.on("error",function(e){$scope.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})}),$scope.showOrHideCSKey=function($event){var $csID=$("#CLIENT_SECRET"),$ele=("text"===$csID.attr("type")?$csID.attr("type","password"):$csID.attr("type","text"),$($event.currentTarget));"VIEW"===$ele.text()?$ele.text("HIDE"):$ele.text("VIEW")},$scope.callback.closeAppModal=function(argument){$scope.sdkConf.appName=appnameToRetain,$scope.sdk.appCSForm.$setPristine()},$scope.callback.openAppModal=function(){$(".selectAppModal").modal("show"),$(".selectAppModal").on("hidden.bs.modal",function(){$("body").removeClass("modal-open"),$scope.resetSDKConfOnModal()})},$scope.selectEvents=function(){$scope.selectedEvents=$filter("filter")($scope.events,{checked:!0})},$scope.isOptionsRequired=function(){return!$scope.events.some(function(options){return options.checked})},$scope.$watch(function(ov,nv){$scope.selectEvents()}),$scope.saveSDKConf=function(){},$scope.callback.createApp=function(form){var _params={},_urlParams={streamId:$workflowService.selectedStream()._id};if(!$scope.isFormValid(form))return void form_util.touch(form);_params={appName:$scope.sdkConfOnModal.appName,algorithm:"HS256",scope:[],pushNotifications:{enable:!1,webhookUrl:""}},_params.bots=[$workflowService.selectedStream()._id],$scope.saveInProgress=!0;var svcname="bt.apps.create";$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.create"),$translator.translate(svcname,_urlParams,_params).then(function(res){res&&res.data&&200===res.status?($scope.saveInProgress=!1,$scope.sdkConfOnModal.createAppSuccess=!0,loadSelectedEvents([]),$scope.sdkConfOnModal.clientID=res.data.clientId,$scope.sdkConf.clientID=res.data.clientId,$scope.sdkConf.clientSecret=res.data.clientSecret,NotificationService.notify(i18n.i18nString("app_created"),"success")):($scope.saveInProgress=!1,alert(i18n.i18nString("error_alert")))},function(errRes){$scope.saveInProgress=!1,alert(i18n.i18nString("error_alert"))})},$scope.sdk={},$scope.callback.saveSuccess=!1,$scope.$watch("callback.saveSuccess",function(newVal,oldVal){$timeout(function(){$scope.callback.saveSuccess=!1},1e3)}),$scope.callback.formInvalid=!1,$scope.callback.createAppCredentials=function(isFromSdConf,form){var _payload={};form=form||$scope.sdk.sdkConfForm;var noneSelected="none"===$scope.sdkConf.appName;return!form||$scope.isFormValid(form)||noneSelected?($scope.callback.formInvalid=!1,$scope.sdkConf.clientID||noneSelected?(_payload={subscribedFor:getSelectedEventIds(),sdkClientId:$scope.sdkConf.clientID,sdkHostUri:$scope.sdkConfOnModal.cbUrl},isFromSdConf&&(_payload.subscribedFor=getSelectedEventIds(),_payload.sdkHostUri=$scope.sdkConf.cbUrl),$scope.callback.saveInprogress=!0,"none"===$scope.sdkConf.appName?(_payload={},void BTStreamsService.deleteSDKSubscription($workflowService.selectedStream()._id,_payload).then(function(res){$scope.callback.saveInprogress=!1,$scope.callback.saveSuccess=!0,$workflowService.selectedStream(res.data),$scope.$emit("streamUpdate"),isFromSdConf||($scope.sdkConf.appName="",$(".selectAppModal").modal("hide"),$("body").removeClass("modal-open")),$scope.callback.loadSDKConf(),NotificationService.notify(i18n.i18nString("subscription_deleted"),"success")},function(error){$scope.callback.saveInprogress=!1,error.data.errors.length>0?NotificationService.notify(error.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})):void BTStreamsService.makeSDKSubscription($workflowService.selectedStream()._id,_payload).then(function(res){$scope.callback.saveInprogress=!1,$scope.callback.saveSuccess=!0,$scope.sdkConf.noSDKConf=!1,$scope.sdkConf.clientID=res.data.sdkSubscription.sdkClientId,$scope.sdkConf.cbUrl=res.data.sdkSubscription.sdkHostUri,loadSelectedEvents(res.data.sdkSubscription.subscribedFor),$scope.sdkConf.eventSelector=getSelectedEventIds(),$workflowService.selectedStream(res.data),$scope.$emit("streamUpdate"),isFromSdConf||($scope.sdkConf.appName="",$(".selectAppModal").modal("hide"),$("body").removeClass("modal-open"),getApps(!0)),appnameToRetain=$scope.sdkConf.appName,NotificationService.notify(i18n.i18nString("subscribed_success"),"success")},function(error){$scope.callback.saveInprogress=!1,error.data.errors.length>0?NotificationService.notify(error.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})):void 0):($scope.callback.formInvalid=!0,void form_util.touch(form))},$scope.mapSelectedAppData=function(clientIdToMap){if($scope.noneSelected="none"===clientIdToMap,$scope.callback.appSelected=!1,!clientIdToMap)return void($scope.noneSelected=!0);if($scope.noneSelected)return void($scope.callback.appSelected=!0);if("createApp"===clientIdToMap)$scope.callback.openAppModal(),$scope.noneSelected=!0;else{var selectedApp=_.filter($scope.apps,function(app){return app.clientId==clientIdToMap});selectedApp.length>0?($scope.sdkConf.clientID=selectedApp[0].clientId,$scope.sdkConf.clientSecret=selectedApp[0].clientSecret,$scope.callback.appSelected=!0):($scope.sdkConf.clientID="",$scope.sdkConf.clientSecret="",$scope.sdkConf.appName="none",$scope.callback.appSelected=!1)}};var getApps=function(isFromCreateSubscription){$scope.loadingApps=!0,$q.all([AppsDataService.getAppsList($workflowService.selectedStream()._id)]).then(function(res){if($scope.loadingApps=!1,res[1]&&res[1].data?$scope.avalSreams=res[1].data:$scope.avalSreams=[],res[0]&&res[0].data&&res[0].data.apps){$scope.apps=res[0].data.apps,$scope.callback.apps=res[0].data.apps;var a_appClientIds=_.pluck($scope.callback.apps,"clientId");if($workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId&&-1===$.inArray($workflowService.selectedStream().sdkSubscription.sdkClientId,a_appClientIds)){var appObject=$workflowService.selectedStream().sdkSubscription;appObject.clientId=appObject.sdkClientId,$scope.callback.apps.push(appObject)}$scope.sdkConf.appName=$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId||$scope.sdkConf.clientID,appnameToRetain=$scope.sdkConf.appName,$scope.sdkConf.cbUrl=$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkHostUri||$scope.sdkConf.cbUrl,$scope.sdkConf.eventSelector=$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.subscribedFor||$scope.sdkConf.eventSelector,loadSelectedEvents($scope.sdkConf.eventSelector),$scope.mapSelectedAppData($workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId||$scope.sdkConf.clientID||"")}else $scope.apps=[],$scope.callback.apps=[];$scope.contentLoading=!1},function(err){$scope.loadingApps=!1,$scope.contentLoading=!1,NotificationService.alertNotify(i18n.i18nString("get_apps"))})};$scope.callback.loadSDKConf=function(){$scope.initializeData(),$scope.contentLoading=!0,$workflowService.selectedStream().sdkSubscription&&$workflowService.selectedStream().sdkSubscription.sdkClientId?($scope.sdkConf.noSDKConf=!1,getApps()):($scope.sdkConf.noSDKConf=!0,getApps())},$scope.callback.loadSDKConf(),$scope.$watch("sdkConf.appName",function(newVal,oldVal){$scope.mapSelectedAppData(newVal)}),$scope.$on("rerenderSDKConf",function(){$scope.callback.loadSDKConf()}),$scope.isFormValid=function(form){return!form.$invalid},$scope.$emit("nestedComponentLoaded",{id:"sdkConfiguration",flag:!1})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("sentimentManagement",function(){return{restrict:"EA",scope:{callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/sentiment-management/sentiment-management.html",controller:["$scope","form_util","env_conf","$rootScope","$filter","$applicationService","$workflowService","NotificationService","$timeout","$translator","BTFlowtaskService","$window","accessControlService","BTStreamsService","i18n",function($scope,form_util,env_conf,$rootScope,$filter,$applicationService,$workflowService,NotificationService,$timeout,$translator,BTFlowtaskService,$window,accessControlService,BTStreamsService,i18n){function getTaskName(refId){var _selectedTask=$scope.dialogTasks.filter(function(task){return task.refId===refId});return _selectedTask[0]?_selectedTask[0].name:""}function getLinkedBotName(linkedBotId){var selectedBot=_.find($scope.totalLinkedBots,{_id:linkedBotId});return selectedBot.botName}function prepareSentimentData(){angular.forEach($scope.eventDetails,function(eventDetails){var _taskName,_botName,_messageTone=eventDetails.emotionConfig.messageTone,_dialogTone=eventDetails.emotionConfig.dialogTone;eventDetails.task&&!eventDetails.linkedBotStreamId&&(_taskName=getTaskName(eventDetails.task),"universalbot"===$scope.stream.type&&(_botName=$scope.stream.name)),eventDetails.task&&eventDetails.linkedBotStreamId&&(_taskName=eventDetails.taskName,_botName=getLinkedBotName(eventDetails.linkedBotStreamId));var _msg="If ",_messageToneArray=[],_dialogToneArray=[];_messageTone&&(_messageToneArray=Object.values(_messageTone)),_dialogTone&&(_dialogToneArray=Object.values(_dialogTone),$.each(_dialogToneArray,function(i,ele){var selectedContent=_.filter($scope.emotionList,{type:ele.label});selectedContent&&selectedContent.length&&(ele.label=selectedContent[0].displayName)}));var _combinedEventArray=_messageToneArray.concat(_dialogToneArray);angular.forEach(_combinedEventArray,function(messageTone,index){if(index===_combinedEventArray.length-1){var _action="triggerDialog"===eventDetails.action?"initiate task ":"run script ";_taskName?(_msg=_msg+'"<span>'+messageTone.label+'</span>"'+i18n.i18nString("sentiment_management_range_between")+'"<span>'+messageTone.min+"</span><span>"+i18n.i18nString("to_label_spaced")+"</span><span>"+messageTone.max+'</span>"'+i18n.i18nString("then")+_action+'"<span>'+_taskName+'</span>"',_botName&&(_msg=_msg+' from <span>"'+_botName+'</span>" '+i18n.i18nString("bot_lower"))):_msg=_msg+'"<span>'+messageTone.label+'</span>"'+i18n.i18nString("sentiment_management_range_between")+'"<span>'+messageTone.min+"</span><span>"+i18n.i18nString("to_label_spaced")+"</span><span>"+messageTone.max+'</span>"'+i18n.i18nString("then")+_action}else _msg=_msg+'"<span>'+messageTone.label+'</span>"'+i18n.i18nString("sentiment_management_range_between")+'"<span>'+messageTone.min+"</span><span>"+i18n.i18nString("to_label_spaced")+"</span><span>"+messageTone.max+'</span>"'+i18n.i18nString("and_caps")}),eventDetails._msg=_msg})}function sortableCallback(e,uiElement){var _payload={};_.map($scope.eventDetails,function(obj){delete obj._msg}),_payload.botSentimentEvents=$scope.eventDetails,NotificationService.notify(i18n.i18nString("sentiment_management_reordered_success"),"success"),prepareSentimentData(),BTStreamsService.reorderSentiment($scope.userId,$scope.streamId,_payload).then(function(response){response.data&&response.data.botSentimentEvents&&($scope.eventDetails=response.data.botSentimentEvents,$workflowService.selectedStream(response.data))})}function decodeJS(_obj){var decodeText="";try{decodeText=decodeURIComponent(_obj)}catch(ex){decodeText=_obj}finally{return decodeText}}function formatTooltip(mode,val){$(mode).find(".tooltip-min").find(".tooltip-inner").text(val[0]),$(mode).find(".tooltip-max").find(".tooltip-inner").text(val[1])}function onSliderChanged(ele,val){$scope.newobj=angular.copy(_defaultEmotion),$scope.newobj.range=val[0],$scope.newobj.range=val[1]}function registerSlider(ele,obj){var slider=$(ele).bootstrapSlider(obj);return $(ele).slider().on("slideStop",function(ev){onSliderChanged(ele,ev.value)}),$(ele).slider().on("slide",function(ev){formatTooltip(ele,ev.value)}),slider}function updateDetails(data){$scope.closeModalSlider("#sentimentEvent"),$scope.selectedLinkedBot&&($scope.selectedLinkedBot={}),$workflowService.selectedStream(data),$scope.eventDetails=data.botSentimentEvents,prepareSentimentData()}function encodeJS(_obj){return encodeURIComponent(_obj)}function filterFn(task){return task&&task.isDeleted?!1:"published"===$scope.streamState?"published"===task.status?!0:!1:"published"===task.status?task.isParent?!1:!0:"published"!==task.status?!0:!1}function isBotPublished(){return"private"!==$scope.stream.visibility.namespace}$scope.stream=$workflowService.selectedStream(),$scope.userId=$applicationService.userInfo().userId,$scope.dialogTasks=$workflowService.dialogTasksByState(),$scope.streamId=$workflowService.selectedStream()._id,$scope.eventDetails=$scope.stream.botSentimentEvents||[],$scope.rightClass="right700",$scope.$emit("nestedComponentLoaded",{id:"sentimentManagement",flag:!1}),$scope.accessRights=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.checkTickIcon=env_conf["context-url"]+"/assets/icons/checkTickIcon.svg",$scope.emptyStateIcon_sentiment=env_conf["context-url"]+"/assets/empty-state-images/empty-sentiment-managment.png",$scope.assetsBase=env_conf["assets-url"],$scope.streamstate={},$scope.streamstate.toggleState=$workflowService.selectedStreamState(),$scope.filterEvents=$workflowService.selectedStreamState(),$scope.events={},$scope.eventsHeading=i18n.i18nString("add_sentiment"),$scope.emotions=[],$scope.events.emotionrange=[],$scope.events.setting="onTaskCompletion",$scope.events.action="triggerDialog",$scope.eventConfigUB={linkedBotId:"",linkedTask:""},$scope.upgradedTasks=[],$scope.currentTask={},$scope.currentDialogTask={};var _maxLength=256;$scope.emotionList=[{displayName:"Anger-Message Level",type:"Anger-Message Level",emotionType:"angry",toneType:"messageTone",added:!1,label:i18n.i18nString("anger")},{displayName:"Disgust-Message Level",type:"Disgust-Message Level",emotionType:"disgust",toneType:"messageTone",added:!1,label:i18n.i18nString("disgust")},{displayName:"Fear-Message Level",type:"Fear-Message Level",emotionType:"fear",toneType:"messageTone",added:!1,label:i18n.i18nString("fear")},{displayName:"Sad-Message Level",type:"Sad-Message Level",emotionType:"sad",toneType:"messageTone",added:!1,label:i18n.i18nString("sad")},{displayName:"Positive-Message Level",type:"Positive-Message Level",emotionType:"positive",toneType:"messageTone",added:!1,label:i18n.i18nString("positive")},{displayName:"Joy-Message Level",type:"Joy-Message Level",emotionType:"joy",toneType:"messageTone",added:!1,label:i18n.i18nString("joy")},{displayName:"Anger-Session Level",type:"Anger-Dialog Level",emotionType:"angry",toneType:"dialogTone",added:!1,label:i18n.i18nString("anger")},{displayName:"Disgust-Session Level",type:"Disgust-Dialog Level",emotionType:"disgust",toneType:"dialogTone",added:!1,label:i18n.i18nString("disgust")},{displayName:"Fear-Session Level",type:"Fear-Dialog Level",emotionType:"fear",toneType:"dialogTone",added:!1,label:i18n.i18nString("fear")},{displayName:"Sad-Session Level",type:"Sad-Dialog Level",emotionType:"sad",toneType:"dialogTone",added:!1,label:i18n.i18nString("sad")},{displayName:"Positive-Session Level",type:"Positive-Dialog Level",emotionType:"positive",toneType:"dialogTone",added:!1,label:i18n.i18nString("positive")},{displayName:"Joy-Session Level",type:"Joy-Dialog Level",emotionType:"joy",toneType:"dialogTone",added:!1,label:i18n.i18nString("joy")}];var _defaultEmotion={emotionConfig:{},range:{min:-1,max:1}},getLinkedBots=function(){$scope.publishedBots=$scope.stream.publishedBots.filter(function(bot){return _.filter($scope.stream.unpublishedBots.concat($scope.stream.awaitingApprovalBots),{_id:bot._id}).length?void 0:bot}),"indevelopment"===$scope.filterEvents?$scope.totalLinkedBots=$scope.stream.configuredBots.concat($scope.publishedBots,$scope.stream.awaitingApprovalBots):"published"===$scope.filterEvents&&($scope.totalLinkedBots=$scope.stream.publishedBots)};getLinkedBots(),$scope.eventDetails&&$scope.eventDetails.length>0&&prepareSentimentData(),$scope.deleteSentimentEvent=function(index,event){function confirmDeleteSentiment(){_eventIds.push({id:event.id,name:event.name}),_payload.events=_eventIds,$scope.emotionConfig=event.emotionConfig,BTStreamsService.deleteSentiment($scope.userId,$scope.streamId,_payload).then(function(response){response.data&&response.data.botSentimentEvents&&($scope.eventDetails=response.data.botSentimentEvents,$workflowService.selectedStream(response.data),NotificationService.notify(i18n.i18nString("sentiment_management_delete_sentiment_sucess"),"success"),$scope.emotionConfig&&$scope.emotionConfig.messageTone&&angular.forEach($scope.emotionConfig.messageTone,function(obj,emotionType){_.filter($scope.emotionList,function(emotionObj){emotionObj.type===obj.label&&(emotionObj.added=!1)})}),$scope.emotionConfig&&$scope.emotionConfig.dialogTone&&angular.forEach($scope.emotionConfig.dialogTone,function(obj,emotionType){_.filter($scope.emotionList,function(emotionObj){emotionObj.type===obj.label&&(emotionObj.added=!1)})}),prepareSentimentData())},function(err){err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})}var _eventIds=[],_payload={},msg=i18n.i18nString("sentiment_management_delete_sentiment");NotificationService.alert(msg,confirmDeleteSentiment,{okText:i18n.i18nString("ok_uppercase")})},$scope.sortableOptionsSentiment={handle:".sortBar1","ui-floating":!0,update:sortableCallback},$scope.sentimentEventSlider=function(){$scope.events={},$scope.emotions=[],$scope.events.emotionrange=[],$scope.events.setting="onTaskCompletion",$scope.events.action="triggerDialog",$scope.eventsHeading=i18n.i18nString("add_sentiment"),_.map($scope.emotionList,function(emotion){emotion.added&&(emotion.added=!1)}),$scope.openModalSlider("#sentimentEvent"),setTimeout(function(){$("#sentimentEvent .modalBody").animate({scrollTop:5},"slow"),$("input[name='eventname']").focus()},400)},$scope.initialzeScroll=function(event,index){$(".dropdown-menu .senti").hasClass("ps-container")&&(PerfectScrollbar.update($(".senti.ps-container")[0]),$(".senti").animate({scrollTop:20}));var _ele=event.currentTarget;3>=index?$(".sentiScroll").animate({scrollTop:$(_ele).parents(".slider"+index).find(".emotiontag").offset().top}):index>3&&$(".sentiScroll").animate({scrollTop:$(".sentiScroll")[0].scrollHeight})},$scope.cancelSentimentBased=function(){$scope.closeModalSlider("#sentimentEvent"),_.map($scope.emotionList,function(emotion){emotion.added&&(emotion.added=!1)}),$scope.selectedLinkedBot&&($scope.selectedLinkedBot={}),$scope.currentDialogTask={}},$scope.editSentiment=function(eventData){$scope.events.id=eventData.id,$scope.events.name=eventData.name,$scope.events.setting=eventData.setting,$scope.events.action=eventData.action,$scope.emotionConfigData=eventData.emotionConfig,eventData.task?($scope.events.task=eventData.task,$scope.currentDialogTask.name=getTaskName(eventData.task)):eventData.script&&($scope.events.script=decodeJS(eventData.script)),"universalbot"===$scope.stream.type&&(eventData.linkedBotStreamId?($scope.selectedLinkedBot=_.find($scope.totalLinkedBots,{_id:eventData.linkedBotStreamId}),$scope.eventConfigUB.linkedTask=eventData.task,$scope.eventConfigUB.linkedBotId=eventData.linkedBotStreamId,$scope.getLinkedBotTasks($scope.selectedLinkedBot,eventData.task)):eventData.task&&!eventData.linkedBotStreamId&&($scope.eventConfigUB.linkedTask=eventData.task,$scope.currentTask.name=getTaskName(eventData.task),$scope.selectedLinkedBot=angular.copy($scope.stream))),$scope.emotions=[];var _emotionList=[];angular.forEach($scope.emotionConfigData.messageTone,function(obj,emotionType){_emotionList.push(obj),$scope.emotions.push({type:obj.label,range:{min:obj.min,max:obj.max,label:obj.label},emotionConfig:{type:obj.label,emotionType:emotionType,toneType:"messageTone"}}),_.filter($scope.emotionList,function(emotionObj){emotionObj.type===obj.label&&(emotionObj.added=!0)})}),angular.forEach($scope.emotionConfigData.dialogTone,function(obj,emotionType){_emotionList.push(obj);$scope.emotions.push({type:obj.label,range:{min:obj.min,max:obj.max,label:obj.label},emotionConfig:{type:obj.label,emotionType:emotionType,toneType:"dialogTone"}}),_.filter($scope.emotionList,function(emotionObj){emotionObj.type===obj.label&&(emotionObj.added=!0)})}),angular.forEach(_emotionList,function(obj,index){setTimeout(function(){var dualS=registerSlider("#dual-slider"+index,{tooltip:"always",tooltip_split:!0,tooltip_position:"bottom"}),arrayVal=[];arrayVal.push(obj.min),arrayVal.push(obj.max),dualS.bootstrapSlider("setValue",arrayVal),formatTooltip("#dual-slider"+index,arrayVal)},100)}),$scope.addEmotionTag=_.filter($scope.emotionList,{added:!1}),angular.forEach($scope.emotions,function(obj,index){setTimeout(function(){$(".dropdown.dropdown-select").find(".dropdown-toggle"+index).html(obj.type+'<i class="btx-carrot-down top10"></i>')},100)})},$scope.openSentimentSlider=function(eventData){$scope.eventsHeading=eventData.name,$scope.openModalSlider("#sentimentEvent"),setTimeout(function(){$("#sentimentEvent .modalBody").animate({scrollTop:5},"slow"),$("input[name='eventname']").focus(),PerfectScrollbar.update($(".sentiScroll")[0])},400),$scope.editSentiment(eventData)},$scope.redirectToLink=function(linkType){var targetURL=$rootScope.helpLinks[linkType];$window.open(targetURL,"_blank")},$scope.checkValidation=function(){var _ele=$(".dropdown.dropdown-select").find(".selectfield");if(_ele&&_ele.length)for(var i=0;i<=_ele.length;i++)if(_ele[i]&&_ele[i].innerText&&"Select Emotion"===_ele[i].innerText)return!0},$scope.saveEnaDis=function(radioSel){if("triggerDialog"===$scope.events.action){var isSaveDisabled;if("universalbot"===$scope.stream.type)return isSaveDisabled=void 0===$scope.currentTask.name;if("universalbot"!==$scope.stream.type)return isSaveDisabled=void 0===$scope.currentDialogTask.name}},$scope.addEmotion=function(index,event){$scope.emotions.push(angular.copy(_defaultEmotion)),setTimeout(function(){var dualS=registerSlider("#dual-slider"+index,{tooltip:"always",tooltip_split:!0,tooltip_position:"bottom"}),obj=$scope.emotions[index],arrayVal=[];arrayVal.push(obj.range.min),arrayVal.push(obj.range.max),dualS.bootstrapSlider("setValue",arrayVal),formatTooltip("#dual-slider"+index,arrayVal),PerfectScrollbar.update($(".senti.ps-container")[0])},100)},$scope.selectRange=function(index){var emotionObj=$scope.emotions[index],rangeArray=$("#dual-slider"+index).attr("value").split(",");emotionObj.range.min=parseInt(rangeArray[0]),emotionObj.range.max=parseInt(rangeArray[1])},$scope.selectEmotionConfig=function(emotionType,index,event,emmotion){var _this=event.currentTarget,targetDisplayName=emmotion.displayName;$(_this).parents(".dropdown-menu").find("li").removeClass("active"),$(_this).parent("li").addClass("active"),$(_this).parents(".dropdown").find(".dropdown-toggle"+index).html(targetDisplayName+' <span class="caret"></span>'),$(_this).parents(".dropdown").find(".dropdown-toggle"+index).dropdown("toggle");var prevEmotion=$scope.emotions[index].emotionConfig.type;$scope.emotions[index].type=emotionType;var _emotionList={};_.map($scope.emotionList,function(item){item.type==emotionType&&(item.added=!0,_emotionList=item),item.type==prevEmotion&&(item.added=!1)}),$scope.addEmotionTag=_.filter($scope.emotionList,{added:!1}),$scope.emotions[index].emotionConfig=_emotionList,$scope.emotions[index].range.label=emotionType},$scope.deleteEmotion=function(index,emotionType){$scope.emotions.splice(index,1);var _emotionList=_.filter($scope.emotionList,{type:emotionType});_emotionList.length&&void 0!==_emotionList[0]&&(_emotionList[0].added=!1),$scope.addEmotionTag=_.filter($scope.emotionList,{added:!1})},$scope.getTasksUb=function(ubBot){$scope.selectedLinkedBot=ubBot,$scope.currentTask={},"universalbot"===ubBot.type&&delete $scope.eventConfigUB.linkedBotId},$scope.selectTask=function(task,linkedBot){$scope.currentTask=task,$scope.eventConfigUB.linkedTask=task.refId},$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},$scope.getLinkedBotTasks=function(linkedBot,selectedTaskId){$scope.selectedLinkedBot=linkedBot,$scope.eventConfigUB.linkedBotId=linkedBot._id,$scope.currentTask={},BTFlowtaskService.getFlowtaks(linkedBot._id,null,$workflowService.selectedStream()._id).then(function(res){if(res.data=res.data.map(function(task){return task.state&&(task.status=task.state.toLowerCase()),"published"!==task.status&&!task.hide&&isBotPublished()&&(task.taskstate="@development"),task}),$scope.tasks=[],$scope.tasks=$scope.tasks.concat(res.data),$scope.findParenttasks($scope.tasks),$scope.tasks=$scope.tasks.filter(function(task){return filterFn(task)}),selectedTaskId){var selectedLinkedTask=_.find($scope.tasks,{refId:selectedTaskId});selectedLinkedTask&&($scope.eventConfigUB.linkedTask=selectedLinkedTask.refId,$scope.currentTask=selectedLinkedTask)}})},$scope.setTaskData=function(task){$scope.currentDialogTask=task,$scope.events.task=$scope.currentDialogTask.refId},$scope.sentimentEventSubmit=function(events){var i,checkFlag=!0;if(events.name.length>_maxLength)NotificationService.notify(i18n.i18nString("sentiment_management_event_name_cannot_Exceed",{dyn:_maxLength}),"error");else{var _payload={};_payload.name=events.name,_payload.setting=events.setting,_payload.action=events.action,events.task&&"triggerDialog"===events.action&&"universalbot"!==$scope.stream.type?_payload.task=events.task:$scope.eventConfigUB.linkedTask.length&&"triggerDialog"===events.action&&"universalbot"==$scope.stream.type?_payload.task=$scope.eventConfigUB.linkedTask:events.script&&"runScript"===events.action&&(_payload.script=encodeJS(events.script)),$scope.eventConfigUB.linkedBotId&&$scope.eventConfigUB.linkedBotId.length&&"triggerDialog"===events.action&&"universalbot"==$scope.stream.type&&(_payload.linkedBotStreamId=$scope.eventConfigUB.linkedBotId,_payload.taskName=$scope.currentTask.name),_payload.emotionConfig={};var _emotions={};if($.each($scope.emotions,function(i,item){var emotionObj={};emotionObj[item.emotionConfig.emotionType]=item.range,_emotions[item.emotionConfig.toneType]=angular.extend(_emotions[item.emotionConfig.toneType]||{},emotionObj)}),_payload.emotionConfig=_emotions,events.id){var _eventDetails=_.filter($scope.eventDetails,function(eventData){return eventData.id!==events.id});if(_eventDetails&&_eventDetails.length>0)for(i=0;i<_eventDetails.length;i++)if(_eventDetails[i].name.toLowerCase()===events.name.toLowerCase()){NotificationService.notify(i18n.i18nString("sentiment_management_event_same_name_err"),"error"),checkFlag=!1;break}checkFlag&&BTStreamsService.editSentiment($scope.userId,$scope.streamId,events.id,_payload).then(function(response){response.data&&response.data.botSentimentEvents&&($scope.stream.botSentimentEvents=response.data.botSentimentEvents,updateDetails($scope.stream),NotificationService.notify(i18n.i18nString("sentiment_management_event_updated_success"),"success"))},function(err){err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})}else{if($scope.eventDetails&&$scope.eventDetails.length>0)for(i=0;i<$scope.eventDetails.length;i++)if($scope.eventDetails[i].name.toLowerCase()===events.name.toLowerCase()){NotificationService.notify(i18n.i18nString("sentiment_management_event_same_name_err"),"error"),checkFlag=!1;break}checkFlag&&BTStreamsService.saveSentiment($scope.userId,$scope.streamId,_payload).then(function(response){response.data&&response.data.botSentimentEvents&&($scope.stream.botSentimentEvents=response.data.botSentimentEvents,updateDetails($scope.stream),NotificationService.notify(i18n.i18nString("sentiment_management_event_added_success"),"success"))},function(err){err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error")})}}},$scope.runScript=function(ele){$(ele.target.closest(".textbox-jseditor")).find("[acify] .resizeToggle").click()}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("settingsForm",function(){return{restrict:"AE",scope:{wfType:"@",onComplete:"&",onCancel:"&",displayMode:"@",configure:"&",hooks:"=?callbacks",resource:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/settings-form/settings-form.html",controller:["$scope","cron","$timeout","$rootScope","$location","BTIdpService","NotificationService","$workflowService","BTAlertsService","$translator","form_util","$routeParams","BTFiltersService","$filter","$util","i18n","env_conf",function($scope,cron,$timeout,$rootScope,$location,BTIdpService,NotificationService,$workflowService,BTAlertsService,$translator,form_util,$routeParams,BTFiltersService,$filter,$util,i18n,env_conf){function initialize(){$scope.settings={pollingInterval:"",time:[],frequency:[],timeslots:[]},$scope.alertFilter={alrtFilterObjects:[]},$scope.alertFilter.alrtFilterObjects=[];var alertInfo=$workflowService.alertInfo(),mpAlertInfo=$workflowService.mpAlertInfo();if(finalObj=angular.copy(alertInfo),angular.extend(finalObj,angular.copy(mpAlertInfo)),filterObjArry=[],_filterTableObj={},$scope.editOperation=null,editIndex=null,_filterTableObj.headers=$filter("orderBy")([{name:"Filter Name",sortable:!0},{name:"DataType",sortable:!1},{name:"FieldType",sortable:!1}],"name"),_filterTableObj.rows=[],$scope.editOperation=null,Object.keys(finalObj).length>0){"alert"===$scope.wfType&&BTFiltersService.getFiltersByAlertId(alertInfo._id,alertInfo.version).then(function(res){filterInfo=res.data,angular.forEach(filterInfo,function(obj,index){$scope.onAlertFilterSave(angular.copy(obj))})}),$scope.settingsObj.ddStrategy=finalObj.ddStrategy||"None",
$scope.settingsObj.identifier=finalObj.identifier&&finalObj.identifier.length>0?finalObj.identifier.join(","):null;try{$scope.intervalConfig.reminders=JSON.parse(JSON.stringify(finalObj.reminders).replace(/<%|%>/g,""))}catch(ex){$scope.intervalConfig.reminders=finalObj.reminders||{}}if($scope.intervalConfig.initPoll=finalObj.initPoll,$scope.intervalConfig.initPostCount=finalObj.initPostCount,$scope.intervalConfig.reminders.options=($scope.intervalConfig.reminders.options||[]).map(function(option){return option&&option.value}),"webhook"!==finalObj.type){var interval=finalObj.scheduleOptions&&finalObj.scheduleOptions["default"]&&finalObj.scheduleOptions["default"][0]||"";interval&&finalObj.scheduleOptions&&finalObj.scheduleOptions.intervals&&(finalObj.scheduleOptions.frequency=angular.copy(_.map(finalObj.scheduleOptions.frequency,function(freq){return freq})),finalObj.scheduleOptions.intervals.Every=angular.copy(_.map(finalObj.scheduleOptions.intervals.Every,function(every){return every})),finalObj.scheduleOptions.time=angular.copy(_.map(finalObj.scheduleOptions.time,function(time){return time})),bindScheduleIntervals("time",finalObj.scheduleOptions.time),bindScheduleIntervals("frequency",finalObj.scheduleOptions.frequency),bindScheduleIntervals("timeslots",finalObj.scheduleOptions.intervals.At.concat(finalObj.scheduleOptions.intervals.Every)),$timeout(function(){var value=cron.extract(finalObj.scheduleOptions["default"][0]).split(",");$scope.pollOptions.day=value[0]||finalObj.scheduleOptions["default"][0],$scope.pollOptions.frequency=value[1]||finalObj.scheduleOptions["default"][1],$timeout(function(){$scope.pollOptions.interval=value[2]||finalObj.scheduleOptions["default"][2]})}))}}$scope.intervalConfigCopy=angular.copy($scope.intervalConfig)}function filterDelete(index,row){var obj=angular.copy(filterObjArry[index]);BTFiltersService.deleteFilter(obj._id).then(function(res){$scope.alertFilter.alrtFilterObjects.rows.splice(index,1),_filterTableObj.rows.splice(index,1),filterObjArry.splice(index,1),NotificationService.notify(i18n.i18nString("delete_filter_success"),"success")},function(err){NotificationService.notify(i18n.i18nString("delete_filter_failed"),"error")})}function openModal(){$scope.$broadcast("openFilterForm");var obj=angular.copy(filterObjArry[editIndex]);$scope.editingFilter={_id:obj._id,name:obj.name,hlep:obj.help,fieldName:obj.lhsKey,dataType:obj.type,fieldType:obj.rhsInputType.inputType,supportedOperations:angular.copy(obj.supportedOperations),rhsInputType:obj.rhsInputType}}function pluckValue(item){return item.value}function getSelected(collection,selected){var output=[];return selected.map(function(value){_.find(collection,{value:value})&&output.push(_.find(collection,{value:value}))}),output}function bindScheduleIntervals(key,collection){$scope.settings[key]=collection.map(function(obj){return obj})}function getKeysInKoreUxMap(code){var keys;code=code&&code.replace(/<%|%>/g,"");for(var result={},identifiers=esprima.tokenize(code,{}).filter(function(obj){return"Identifier"===obj.type}),i=0;i<identifiers.length;i++)for(var j=0;j<$scope.keys.length;j++)identifiers[i].value===$scope.keys[j]&&(result[identifiers[i].value]=identifiers[i].value);return keys=Object.keys(result)}function getSampleResKeys(alert,data){var _sKey,_sampleResponse=parse(data),_sReqChain=alert.requestChain;return"webhook"===alert.type?_sKey=alert.alertsPath:_sReqChain.map(function(chain){"processor"===chain.linkType&&"_extract"===chain.linkDefinition.type&&(_sKey=chain.linkDefinition.key)}),_sKey&&data?_sampleResponse&&_sKey?resolveObjectPath(_sampleResponse,_sKey):_sampleResponse:parse(data)}function resolveObjectPath(source,path,result){return"string"==typeof source&&(source=parse(source)),-1===path.indexOf("$.")&&(path="$.."+path),result=JSONPath({json:source,path:path})[0],result instanceof Array?result[0]:"object"==typeof result?result:source}function parse(json){if("string"==typeof json)try{return JSON.parse(json)}catch(ex){return{}}else if("object"==typeof json)return json}var __frequency__="__frequency__",finalObj={};$scope.settingsObj={},$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.settingsObj.ddStrategy="None",$scope.alertFilter={alrtFilterObjects:[]},$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png";var filterInfo,filterObjArry,_filterTableObj,selectedStream=$workflowService.selectedStream(),alertScheduleOptions=JSON.parse(JSON.stringify($workflowService.seedData().alertScheduleOptions)),editIndex=null,timeValues=["00:00 am","00:30 am","01:00 am","01:30 am","02:00 am","02:30 am","03:00 am","03:30 am","04:00 am","04:30 am","05:00 am","05:30 am","06:00 am","06:30 am","07:00 am","07:30 am","08:00 am","08:30 am","09:00 am","09:30 am","10:00 am","10:30 am","11:00 am","11:30 am","12:00 pm","12:30 pm","01:00 pm","01:30 pm","02:00 pm","02:30 pm","03:00 pm","03:30 pm","04:00 pm","04:30 pm","05:00 pm","05:30 pm","06:00 pm","06:30 pm","07:00 pm","07:30 pm","08:00 pm","08:30 pm","09:00 pm","09:30 pm","10:00 pm","10:30 pm","11:00 pm","11:30 pm"],hourValues=["5 minutes","10 minutes","15 minutes","30 minutes","1 hour","2 hours","4 hours","6 hours","8 hours","12 hours"];$scope.pollOptions={},$scope.chevronRightDark=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-right-dark.svg",$scope.alertTask=i18n.i18nString("constants.alert"),$scope.actionTask=i18n.i18nString("constants.action"),$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.titlePart={},$scope.recurrencePattern={},$scope.startTime={},$scope.endAfter={},$scope.options=[{title:"5 mins",value:5},{title:"10 mins",value:10},{title:"15 mins",value:15},{title:"30 mins",value:30},{title:"1 hour",value:60},{title:"2 hours",value:120},{title:"4 hours",value:240},{title:"1 day",value:1440},{title:"2 days",value:2880},{title:"3 days",value:4320},{title:"7 days",value:10080}],$scope.hooks=$scope.hooks||{},$scope.intervalConfigCopy={},$scope.afterSave=angular.noop;var textKeys={hash:"hash",recurrenceFormat:"recurrenceFormat",options:"options",enabled:"enabled"};$scope.settings={pollingInterval:"",time:[],frequency:[],timeslots:[]},$scope.optionsConfig={allowclear:!0,multiple:!0,placeholder:i18n.i18nString("smart_alerts_select_frequency")},$scope._constants_=$rootScope._constants_;var languageSpecficOptions=alertScheduleOptions[$workflowService.currentLanguage()||selectedStream.defaultLanguage];hourValues=hourValues.map(function(each){var defaultValue=each.split(" ")[1];return each=each.replace(defaultValue,languageSpecficOptions.time[defaultValue])}),$scope.minutes=languageSpecficOptions.time.minutes,$scope.hours=languageSpecficOptions.time.hours,$scope.every=languageSpecficOptions.frequency[0].value,$scope.at=languageSpecficOptions.frequency[1].value,$scope.intervalConfig={reminders:{},time:languageSpecficOptions.scheme,frequency:languageSpecficOptions.frequency,timeOptions:{"default":[]}},$scope.intervalConfig.timeOptions[$scope.every]=[],$scope.intervalConfig.timeOptions[$scope.at]=[],$scope.intervalConfig.timeOptions[$scope.at+$scope.every]=[],$scope.intervalConfig.timeOptions[$scope.every+$scope.at]=[],timeValues.map(function(value){$scope.intervalConfig.timeOptions[$scope.at].push({value:value})}),hourValues.map(function(value){$scope.intervalConfig.timeOptions[$scope.every].push({value:value})}),$scope.intervalConfig.timeOptions[$scope.every+$scope.at]=$scope.intervalConfig.timeOptions[$scope.every].concat($scope.intervalConfig.timeOptions[$scope.at]),$scope.intervalConfig.timeOptions[$scope.at+$scope.every]=$scope.intervalConfig.timeOptions[$scope.at].concat($scope.intervalConfig.timeOptions[$scope.every]),$scope.saveInProgress=!1,$scope.entity=$workflowService.alertInfo(),$scope.alertType=$scope.entity.type,$scope.filterFrm=!0,$scope.orderFilters=function(type,index){var from=index;"up"===type?$util.swap([$scope.alertFilter.alrtFilterObjects.rows,_filterTableObj.rows,filterObjArry],from,from-1):$util.swap([$scope.alertFilter.alrtFilterObjects.rows,_filterTableObj.rows,filterObjArry],from,from+1)},$scope.filterDataRowDel=function(index,row){NotificationService.alert(i18n.i18nString("delete_filter"),filterDelete,arguments)},$scope.showAlertFilterForm=function(){$scope.filterFrm=!0,$scope.$broadcast("openFilterForm"),$scope.editingFilter={},$scope.editOperation=null},$scope.onAlertFilterSave=function(filter,showIt){"edit"!==$scope.editOperation?(_filterTableObj.rows.push({"Filter Name":filter.name,FieldType:filter.rhsInputType.inputType,DataType:filter.type}),$scope.alertFilter.alrtFilterObjects=angular.copy(_filterTableObj),filterObjArry.push(angular.copy(filter))):(_filterTableObj.rows.splice(editIndex,1,{"Filter Name":filter.name,FieldType:filter.rhsInputType.inputType,DataType:filter.type}),$scope.alertFilter.alrtFilterObjects=angular.copy(_filterTableObj),filterObjArry.splice(editIndex,1,angular.copy(filter)),$scope.editOperation=""),showIt?$scope.editingFilter={}:$scope.$broadcast("closeFilterForm")},$scope.onFilterFormCancel=function(data){$scope.$broadcast("closeFilterForm"),$scope.editingFilter={}},$scope.clear=function(){$scope.settingsObj={};for(var i=0;i<filterObjArry.length;i++)try{$scope.filterDataRowDel(i)}catch(ex){}},$scope.filterDataRowEdit=function(index,row){$scope.editOperation="edit",editIndex=index,$scope.$broadcast("openFilterForm");var obj=angular.copy(filterObjArry[index]);$scope.editingFilter={_id:obj._id,name:obj.name,hlep:obj.help,fieldName:obj.lhsKey,dataType:obj.type,fieldType:obj.rhsInputType.inputType,supportedOperations:angular.copy(obj.supportedOperations),rhsInputType:obj.rhsInputType}},$scope.filterDataRowView=function(index,row){$scope.editOperation="edit",editIndex=index,openModal()},initialize(),$workflowService.registerModalHiddenEvent(),$scope.showDedup=function(wfType){return"alert"===wfType&&"webhook"===$workflowService.alertInfo().type?!1:!0},$scope.setSettings=function(isValid,form,stopNavigation,isFromFinish){if($scope.stopNavigation=stopNavigation,!isValid)return"false"===$scope.settingsForm._status&&NotificationService.notify(i18n.i18nString("req_fields"),"error"),void form_util.touch(form);var times,frequency,hours,intervals,result,_settingsObject={},_alertObj=$workflowService.alertInfo();if($scope.saveInProgress=!0,_settingsObject.type=_alertObj.type,"webhook"!==$scope.entity.type){_settingsObject.ddStrategy=$scope.settingsObj.ddStrategy,"None"===$scope.settingsObj.ddStrategy&&(_settingsObject.identifier=[]),"SinceId"===$scope.settingsObj.ddStrategy?_settingsObject.identifier=[$scope.settingsObj.identifier]:"ExcludeByCachedIds"===$scope.settingsObj.ddStrategy&&(_settingsObject.identifier=$scope.settingsObj.identifier.split(",")),times=getSelected($scope.intervalConfig.time,$scope.settings.time).map(pluckValue),frequency=getSelected($scope.intervalConfig.frequency,$scope.settings.frequency).map(pluckValue),hours=getSelected($scope.intervalConfig.timeOptions[$scope.at],$scope.settings.timeslots).map(pluckValue),intervals=getSelected($scope.intervalConfig.timeOptions[$scope.every],$scope.settings.timeslots).map(pluckValue),result=-1!==$scope.pollOptions.interval.indexOf($scope.minutes)?cron.build($scope.pollOptions.day,$scope.pollOptions.frequency,$scope.pollOptions.interval,$scope.minutes):cron.build($scope.pollOptions.day,$scope.pollOptions.frequency,$scope.pollOptions.interval,$scope.hours);var options={time:times,frequency:frequency,intervals:{At:hours,Every:intervals},"default":[result]};_settingsObject.initPoll=$scope.intervalConfig.initPoll,_settingsObject.initPostCount=$scope.intervalConfig.initPostCount,_settingsObject.scheduleOptions=options,_settingsObject.repeatInterval=result}_settingsObject.reminders={enabled:$scope.intervalConfig.reminders.enabled},$scope.intervalConfig.reminders.enabled&&(Object.keys($scope.intervalConfig.reminders).map(function(key){-1!==key.indexOf("$")||textKeys[key]?_settingsObject.reminders[key]=$scope.intervalConfig.reminders[key]:_settingsObject.reminders[key]="<% "+$scope.intervalConfig.reminders[key]+" %>"}),_settingsObject.reminders.options=_settingsObject.reminders.options.map(function(option){return $scope.options.filter(function(item){return+item.value===+option})[0]})),$workflowService.settingsData(_settingsObject),BTAlertsService.createBTAlertUp(_alertObj._id,_settingsObject).then(function(res){$workflowService.alertInfo(res.data),finalObj.repeatInterval=_settingsObject.repeatInterval,NotificationService.notify(i18n.i18nString("settings_saved_sucessfully"),"success");var _alertInfo=$workflowService.alertInfo();_alertInfo.taskType="alert",$scope.$emit("mpResourceUpdate",_alertInfo),stopNavigation||$scope.onComplete(),isFromFinish&&$scope.configure({type:$routeParams.resourceType}),$scope.saveInProgress=!1,$rootScope.$broadcast("evt:nextSucc",$scope.moveTo),$scope.settingsForm.$dirty=!1,$scope.afterSave(),initialize()},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("settings_form_failed_save")+$scope._constants_.alert.toLowerCase()+" ","error")})},$scope.continueToValidate=function(){$scope.onComplete()},$scope.clear=function(){$scope.settings={pollingInterval:"",time:[],frequency:[],timeslots:[]}},$scope.getSchemes=function(){var results=getSelected($scope.intervalConfig.time,$scope.settings.time);return $scope.pollOptions.day=_.isArray(results)&&results.length>0?$scope.pollOptions.day:"",results},$scope.getFrequencies=function(){var results=getSelected($scope.intervalConfig.frequency,$scope.settings.frequency);return $scope.pollOptions.frequency=_.isArray(results)&&results.length>0?$scope.pollOptions.frequency:"",results},$scope.getTimeslots=function(){var results=getSelected($scope.intervalConfig.timeOptions[$scope.at],$scope.settings.timeslots);return $scope.pollOptions.interval=_.isArray(results)&&results.length>0?$scope.pollOptions.interval:"",results},$scope.getIntervals=function(){var results=getSelected($scope.intervalConfig.timeOptions[$scope.every],$scope.settings.timeslots);return $scope.pollOptions.interval=_.isArray(results)&&results.length>0?$scope.pollOptions.interval:"",results},$scope.validIntervalOptions=!0,$scope.validAlertReminder=!0,$scope.isValid=function(form){var keys,placeholderIsThere;if($scope.intervalConfig.reminders.enabled?(keys=getKeysInKoreUxMap($scope.intervalConfig.reminders.titlePart)||[],placeholderIsThere=0===keys.filter(function(key){return key===__frequency__}).length):placeholderIsThere=!1,"webhook"===$scope.entity.type)return $scope.settingsForm._placeholderNotThere=placeholderIsThere,form.$valid&&!placeholderIsThere;var cond=$scope.pollOptions.day&&$scope.pollOptions.frequency&&$scope.pollOptions.interval&&form.$valid&&!placeholderIsThere,cond_1=$scope.settingsObj.ddStrategy&&"None"!==$scope.settingsObj.ddStrategy?$scope.settingsObj.identifier:!0;return $scope.validIntervalOptions=$scope.pollOptions.day&&$scope.pollOptions.frequency&&$scope.pollOptions.interval?!0:!1,$scope.intervalConfig.reminders.enabled?$scope.validAlertReminder=!(form.options.$error.required||form.titlePart.$error.required||form.hash.$error.required||form.startTime.$error.required||form.recurrenceFormat.$error.required||form.recurrencePattern.$error.required||(form.endAfter?form.endAfter.$error.required:0)||placeholderIsThere):$scope.validAlertReminder=!0,$scope.settingsForm._status=cond?"true":"false",$scope.settingsForm._placeholderNotThere=placeholderIsThere,"alert"===$scope.wfType?cond_1&&cond:cond},$scope.$watch("pollOptions.day",function(newVal,oldVal){newVal&&newVal.trim()||($scope.pollOptions.frequency="",$scope.pollOptions.interval="")}),$scope.$watch("pollOptions.frequency",function(newVal,oldVal){newVal&&newVal.trim()||($scope.pollOptions.interval="")}),$scope.cancel=function(){initialize(),$scope.onCancel(),$location.path(window.appConfig.CONTEXT_PATH)};var data=getSampleResKeys(finalObj,finalObj.sample);data&&data.metainfo&&delete data.metainfo,$translator.translate("bt.dotKeys.post",{},data).then(function(res){$scope.keys=res.data||[],$scope.keys.push(__frequency__)},function(err){$scope.keys=[],$scope.keys.push(__frequency__)}),$scope.hooks.isChanged=function(){return $scope.settingsForm.$dirty},$scope.hooks.triggerSave=function(callback){$scope.afterSave=callback,$scope.setSettings($scope.isValid($scope.settingsForm),$scope.settingsForm)},window.onbeforeunload=function(event){return $scope.settingsForm&&$scope.settingsForm.$dirty?i18n.i18nString("auth_form_alert"):void 0},$scope.$on("$locationChangeStart",function(event,next,current){function successCb(){$scope.setSettings($scope.isValid($scope.settingsForm),$scope.settingsForm)}function failCb(){$scope.settingsForm.$dirty=!1,$location.path(next)}$scope.settingsForm.$dirty&&"view"!==$scope.displayMode&&(event.preventDefault(),$scope.afterSave=failCb,NotificationService.confirm({msg:i18n.i18nString("bt_wf_proceeding_noty"),successCb:successCb,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("save"),fail:i18n.i18nString("discard_label")}}))}),$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onFinishSetup=function(type){"edit"===$scope.displayMode?$scope.configure({type:type}):$scope.setSettings($scope.isValid($scope.settingsForm),$scope.settingsForm,!0,!0)},$scope.$on("evt:exitActSetng",function(evt,data){$scope.moveTo=data,$scope.setSettings(!0)})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("settings",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/settings/settings.html",controller:["$scope","$translator","$rootScope","$workflowService","BTStreamsService","NotificationService","$timeout","accessControlService","$element","env_conf","$applicationService","navigator","i18n","channelsConfig",function($scope,$translator,$rootScope,$workflowService,BTStreamsService,NotificationService,$timeout,accessControlService,$element,env_conf,$applicationService,navigator,i18n,channelsConfig){function doServiceCalls(obj){BTStreamsService.updateThresholds($workflowService.selectedStream()._id,obj).then(function(res){$scope.selectedStream.confidenceConfigs=res.data.confidenceConfigs,$workflowService.selectedStream($scope.selectedStream,res.data),NotificationService.notify(i18n.i18nString("settings_saved"),"success")},function(err){err.data&&err.data&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}function updateRecentBots(nlpSettings){var _payload={assignAllChildBots:"true"===nlpSettings.assignAllChildBots?!0:!1,recentBotLimit:nlpSettings.recentBotLimit};BTStreamsService.editNlSettings($workflowService.selectedStream()._id,_payload).then(function(response){$workflowService.selectedStream(response.data),$scope.nlpSettings=angular.copy(response.data),$scope.nlpSettings.assignAllChildBots=$scope.nlpSettings.assignAllChildBots===!0?"true":"false",NotificationService.notify(i18n.i18nString("settings_saved"),"success")},function(err){err.data&&err.data&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}function onSliderChanged(mode,value){if("#slider-recentbots"===mode)$("#recentbot-slider").find(".tooltip-inner").text(value>1?value+" Bots":value+" Bot"),$scope.nlpSettings.recentBotLimit=value,updateRecentBots($scope.nlpSettings);else{switch(mode){case"#slider-ml":obj.confidenceConfig[0].minThreshold=value;break;case"#slider-proximity":obj.confidenceConfig[2].taskMatchTolerance=value,$("#proxMatch-slider").find(".tooltip-inner").text(value+"%")}doServiceCalls(obj)}}function formatTooltip(mode,value){switch(mode){case"#slider-ml":$("#threshold-slider").find(".tooltip-inner").text(value);break;case"#slider-proximity":$("#proxMatch-slider").find(".tooltip-inner").text(value+"%");break;case"#slider-recentbots":$("#recentbot-slider").find(".tooltip-inner").text(value>1?value+" Bots":value+" Bot")}}function registerSlider(ele,obj){var slider=$(ele).bootstrapSlider(obj);return $(ele).slider().on("slideStop ",function(ev){onSliderChanged(ele,ev.value)}),$(ele).slider().on("slide",function(ev){formatTooltip(ele,ev.value)}),slider}function saveTriggerSettings(){var _payload={botTriggerPhrasesSetting:{enabled:$scope.triggerPhrase.enabled,action:$scope.triggerPhrase.action}};BTStreamsService.saveTriggerPhaseSettings($workflowService.selectedStream()._id,_payload).then(function(response){$workflowService.selectedStream(response.data),NotificationService.notify(i18n.i18nString("settings_saved"),"success")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}function saveResponses(payload){BTStreamsService.newEvent($applicationService.userInfo().userId,$workflowService.selectedStream()._id,payload).then(function(response){response&&(NotificationService.notify(i18n.i18nString("settings_saved"),"success"),$scope.prompt={},$scope.triggerPhrase=response.data.botTriggerPhrasesSetting,$scope.triggerPhrase.msgs=_.map(response.data.botTriggerPhrasesSetting.msg,function(msg){msg.text=decodeJS(msg.text)}))},function(err){$scope.prompt={},err.data&&err.data&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}$scope.assetsBase=env_conf["assets-url"],$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.$emit("nestedComponentLoaded",{id:"settings",flag:!1}),$scope.switchOlder={},$scope.switchOlder.switchToggle=!1;var obj={confidenceConfig:[{mode:"ml",isActive:!0,minThreshold:0,maxThreshold:0},{mode:"faq",isActive:!0},{mode:"cs",isActive:!0}]};$scope.selectedStream=$workflowService.selectedStream(),$scope.intentParams={},$scope.intentParams.useSynonyms=!1;var s1,s2,s3;$scope.trainStatus={success:!1,failed:!1,saving:!1},$scope.nlpSettings={},$scope.triggerPhrase={},$scope.triggerPhrase.enabled=!1,$scope.triggerPhrase.action="childBotWelcomeEvent",$scope.addResponseCB={},$scope.qualified={},$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs.length>0&&(obj.confidenceConfig[0].minThreshold=void 0!==$scope.selectedStream.confidenceConfigs[0].minThreshold?$scope.selectedStream.confidenceConfigs[0].minThreshold:.3,obj.confidenceConfig[2].taskMatchTolerance=void 0===$scope.selectedStream.confidenceConfigs[2]?2:void 0!==$scope.selectedStream.confidenceConfigs[2].taskMatchTolerance?$scope.selectedStream.confidenceConfigs[2].taskMatchTolerance:2,obj.confidenceConfig[2].intentRescoring=void 0===$scope.selectedStream.confidenceConfigs[2]?!0:void 0!==$scope.selectedStream.confidenceConfigs[2].intentRescoring?$scope.selectedStream.confidenceConfigs[2].intentRescoring:!0,$scope.selectedStream.confidenceConfigs&&"boolean"==typeof $scope.selectedStream.confidenceConfigs[2].intentRescoring?$scope.qualified.intentRescoring=$scope.selectedStream.confidenceConfigs[2].intentRescoring?"true":"false":void 0===$scope.selectedStream.confidenceConfigs[2].intentRescoring&&($scope.qualified.intentRescoring="true")),$scope.selectedStream&&($scope.nlpSettings.assignAllChildBots=$scope.selectedStream.hasOwnProperty("assignAllChildBots")?$scope.selectedStream.assignAllChildBots:"true","boolean"==typeof $scope.nlpSettings.assignAllChildBots&&($scope.nlpSettings.assignAllChildBots=$scope.nlpSettings.assignAllChildBots===!0?"true":"false"),$scope.nlpSettings.recentBotLimit=void 0!==$scope.selectedStream.recentBotLimit?$scope.selectedStream.recentBotLimit:5,$scope.selectedStream.botTriggerPhrasesSetting&&($scope.triggerPhrase=$scope.selectedStream.botTriggerPhrasesSetting));(function(){$scope.loadingSettings=!0,BTStreamsService.getMLSynonym($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data[0]&&($workflowService.mlPharams(res.data[0]),$scope.payload=res.data[0],$scope.intentParams=res.data[0].intentParams,setTimeout(function(){$scope.loadingSettings=!1},0))},function(err){$scope.intentParams.useSynonyms=!1,$scope.loadingSettings=!1})})();$scope.showReset=function(a,b){$(a).removeClass("hide"),$scope.currentSlider=b},$scope.hideReset=function(a){$(a).addClass("hide")},$scope.resetDefaultVal=function(current){current=current||$scope.currentSlider;var defValue;switch(current){case"#slider-ml":defValue=.3,obj.confidenceConfig[0].minThreshold=defValue,s1.bootstrapSlider("setValue",defValue);break;case"#slider-proximity":defValue=2,obj.confidenceConfig[2].taskMatchTolerance=defValue,s2.bootstrapSlider("setValue",defValue);break;case"#slider-recentbots":defValue=5,s3.bootstrapSlider("setValue",defValue)}formatTooltip(current,defValue),doServiceCalls(obj)},$scope.showModal=function(){$element.find("#trainSuggestion").removeClass("fade").addClass("show")},$scope.closeModal=function(){$scope.intentParams.useSynonyms=!$scope.intentParams.useSynonyms,$element.find("#trainSuggestion").removeClass("show").addClass("fade")},$scope.prepareSliders=function(){s2=registerSlider("#slider-proximity",{tooltip:"always",tooltip_position:"bottom"}),s2.bootstrapSlider("setValue",obj.confidenceConfig[2].taskMatchTolerance),formatTooltip("#slider-proximity",obj.confidenceConfig[2].taskMatchTolerance),s3=registerSlider("#slider-recentbots",{tooltip:"always",tooltip_position:"bottom"}),s3.bootstrapSlider("setValue",$scope.nlpSettings.recentBotLimit),formatTooltip("#slider-recentbots",$scope.nlpSettings.recentBotLimit)},$scope.updateBotAssignment=function(){updateRecentBots($scope.nlpSettings)},$scope.updateIntentScoring=function(){var intentRescoreValue;intentRescoreValue="true"==$scope.qualified.intentRescoring?!0:!1,obj.confidenceConfig[2].intentRescoring=intentRescoreValue,doServiceCalls(obj)},$scope.trainBot=function(){$scope.trainStatus.saving=!0,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!1,BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$scope.trainStatus.saving=!0,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!1,$scope.showTrainSavingDiv=!0,$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$broadcast("getProgressDockStatus"),NotificationService.notify(i18n.i18nString("bot_train"),"info"),$scope.trainShow=!1,$(".settings-threshold-saving").addClass("marginBottom20")},function(err){$scope.trainStatus.saving=!1,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!0,err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})},$scope.$on("getProgressDockStatus",function(){$scope.trainStatus.saving=!1,$scope.trainStatus.success=!0,$scope.trainStatus.failed=!1}),$scope.toggleSynonym=function(){$element.find("#trainSuggestion").removeClass("show").addClass("fade"),$scope.payload.intentParams=$scope.intentParams,BTStreamsService.updateMLSynonym($workflowService.selectedStream()._id,null,null,$scope.payload).then(function(response){response&&($scope.intentParams=response.data.intentParams,NotificationService.notify(i18n.i18nString("settings_saved"),"success"),$scope.trainBot())})},$scope.closeTrainSaveDiv=function(){$scope.showTrainSavingDiv=!1},$scope.showSwitchModal=function(){$scope.switchOlder.switchToggle=!0,$element.find("#switchModal").removeClass("fade").addClass("show")},$scope.toggleSwitchHandler=function(){saveTriggerSettings()},$scope.updateTriggerPhraseSettings=function(){saveTriggerSettings()},$scope.closeSwitchAlert=function(){$element.find("#switchModal").removeClass("show").addClass("fade"),$scope.switchOlder.switchToggle=!1},$scope.upgrade=function(){$element.find("#switchModal").removeClass("show").addClass("fade");var _payload={universalBotVersion:1};NotificationService.notify(i18n.i18nString("bot_switch_progress"),"success"),BTStreamsService.upgradeUniversalBot($applicationService.userInfo().userId,$scope.selectedStream._id,_payload).then(function(response){response&&($workflowService.selectedStream(response.data),$scope.stream=$workflowService.selectedStream(),$scope.stream.universalBotVersion=1,$workflowService.selectedStream($scope.stream),NotificationService.notify(i18n.i18nString("bot_switch_success"),"success"),$scope.callbacks.navigateTo(null,"linkedBots",!0))})},$scope.openManageResponse=function(){$scope.addResponses=!0,setTimeout(function(){var btnValue="close";$scope.addResponseCB.openManageResponse(btnValue),$scope.addResponseCB.conditionKey={condition:"Message to be displayed when a user invokes a linked bot using Trigger Phrase",key:["Message to be displayed when a user invokes a linked bot using Trigger Phrase"],category:"Statements"},$scope.addResponseCB.initMessages($scope.displayMode)},100)},$scope.editResponse=function(index){$scope.openModalSlider("#responseSlider"),$scope.editMode=!0,$scope.editMessageIndex=index,$scope.prompt=$scope.triggerPhrase.msgs[index]},$scope.activeTabType=function(type,prompt){var currentActiveTab="basic"===prompt.type?"basic":"uxmap";if(type!==currentActiveTab)if("uxmap"===type){if(prompt.text&&prompt.text.trim())return void NotificationService.notify(i18n.i18nString("advance_mode"));prompt.type=type}else if("basic"===type){if(prompt.text&&prompt.text.trim())return void NotificationService.notify(i18n.i18nString("standard_mode"));prompt.type=type}};({botTriggerPhrasesSetting:{enabled:$scope.triggerPhrase.enabled,action:$scope.triggerPhrase.action,msg:$scope.triggerPhrase.msgs}});$scope.deleteMessageResponse=function(index){$scope.triggerPhrase.msgs.splice(index,1);var _payload={botTriggerPhrasesSetting:{enabled:$scope.triggerPhrase.enabled,action:$scope.triggerPhrase.action,msg:$scope.triggerPhrase.msgs}};saveResponses(_payload)}}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("slashCommandsForm",function(){return{restrict:"EA",scope:{of:"@",command:"=",parentForm:"=",ctx:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/slash-commands/slash-commands.html",controller:["$scope","BTSlashCommandsService",function($scope,BTSlashCommandsService){function getSlashCommands(){"stream"===$scope.of?BTSlashCommandsService.getCommand($scope.ctx.streamId).then(function(res){$scope.command=res.data[0]||{},Object.keys($scope.command).length>0?(commandIsThere=!0,$scope.parentForm._createSlash=!0):$scope.parentForm._createSlash=!1}):"action"===$scope.of&&($scope.actionCommandLoading=!0,BTSlashCommandsService.getCommand($scope.ctx.streamId).then(function(res){res.data[0]||{};$scope.hideBotCommand=!0}),BTSlashCommandsService.getSubCommand($scope.ctx.actionId).then(function(res){$scope.command=res.data[0]||{},$scope.parentForm._createSlash=!0,$scope.actionCommandLoading=!1}))}function createSlashCommand(){return $scope.parentForm&&!$scope.parentForm._createSlash?deleteCommand():"stream"===$scope.of?createStreamCommand():"action"===$scope.of?createActionCommand():void 0}function createActionCommand(){var payload=getPayload();return payload.streamId=$scope.ctx.streamId,$scope.command._id?BTSlashCommandsService.editSubCommand($scope.ctx.actionId,$scope.command._id,payload):BTSlashCommandsService.createSubCommand($scope.ctx.actionId,payload)}function createStreamCommand(){var payload=getPayload();return commandIsThere?BTSlashCommandsService.editCommand($scope.ctx.streamId,payload):BTSlashCommandsService.createCommand($scope.ctx.streamId,payload)}function deleteCommand(){return"stream"===$scope.of?deleteStreamCommand():"action"===$scope.of?deleteSubCommand():void 0}function deleteStreamCommand(){return BTSlashCommandsService.deleteCommand($scope.ctx.streamId).then(function(res){$scope.command={}},function(error){})}function deleteSubCommand(){return BTSlashCommandsService.deleteSubCommand($scope.ctx.streamId,$scope.command._id);
}function getPayload(){return{name:$scope.command.name,help:$scope.command.help,sample:$scope.command.sample,description:$scope.command.description}}var commandIsThere=!1;$scope.hideBotCommand=$scope.ctx&&$scope.ctx.hidecheckbox||!1,$scope.command||($scope.command={}),$scope.ctx.getSlashCommands=getSlashCommands,$scope.ctx.createSlashCommand=createSlashCommand,$scope.ctx.deleteCommand=deleteCommand}],link:function($scope,ele,attrs){}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.controller("smartAlertsCtrl",["$scope","config","$workflowService","BTFiltersService","BTStreamsService","NotificationService","$modalInstance","cron","i18n",function($scope,config,$workflowService,BTFiltersService,BTStreamsService,NotificationService,$modalInstance,cron,i18n){function getAlertFiltersPayload(){$scope.filterData=[],$scope.alertFilters&&$scope.alertFilters.length<0&&($scope.alertFilters=[]),$scope.alertFilters&&$.each($scope.alertFilters,function(i,filter){var obj={};obj.name=filter.name,obj.id=filter._id||filter.id,obj.operation=filter.supportedOperations||filter.operation,filter.value&&(obj.value=filter.value||""),$scope.filterData.push(obj)})}function pluckValue(item){return item.value}function getSelected(collection,selected){var output=[];return selected.map(function(value){_.find(collection,{value:value})&&output.push(_.find(collection,{value:value}))}),output}var finalObj={};$scope.filterData=[],$scope.alertDefination={alertfields:{}},$scope.nodeInfo=config.component||{},$scope.alertNotificationType={},$scope.alertNotificationType.value="broadcast",$scope.alertUpgradeType={},$scope.alertUpgradeType.value="none",$scope.formatvalue={value:"2",title:"two"};var timeValues=["00:00 am","00:30 am","01:00 am","01:30 am","02:00 am","02:30 am","03:00 am","03:30 am","04:00 am","04:30 am","05:00 am","05:30 am","06:00 am","06:30 am","07:00 am","07:30 am","08:00 am","08:30 am","09:00 am","09:30 am","10:00 am","10:30 am","11:00 am","11:30 am","12:00 pm","12:30 pm","01:00 pm","01:30 pm","02:00 pm","02:30 pm","03:00 pm","03:30 pm","04:00 pm","04:30 pm","05:00 pm","05:30 pm","06:00 pm","06:30 pm","07:00 pm","07:30 pm","08:00 pm","08:30 pm","09:00 pm","09:30 pm","10:00 pm","10:30 pm","11:00 pm","11:30 pm"],hourValues=["15 minutes","30 minutes","1 hour","2 hours","4 hours","6 hours","8 hours","12 hours"];$scope.options=[{title:"5 mins",value:5},{title:"10 mins",value:10},{title:"15 mins",value:15},{title:"30 mins",value:30},{title:"1 hour",value:60},{title:"2 hours",value:120},{title:"4 hours",value:240},{title:"1 day",value:1440},{title:"2 days",value:2880},{title:"3 days",value:4320},{title:"7 days",value:10080}],$scope.pollOptions={};var publishedAlerts=$workflowService.alertTasks();$scope.alerts=publishedAlerts.filter(function(alert){return"published"===alert.state}),$scope.getAlertFiltersDetails=function(task){$scope.alertDefination={alertfields:{}},$scope.pollOptions.day="",$scope.pollOptions.frequency="",$scope.pollOptions.interval="",$scope.alertNotificationType.value="broadcast",$scope.alertUpgradeType.value="none",$scope.alertExpiry="",$scope.expiryCount="",BTFiltersService.getFiltersByAlertId(task._id,task.version).then(function(res){$scope.alertFilters=[],$scope.alertFilters=res.data,$.each($scope.alertFilters,function(i,filter){var obj={};obj.name=filter.name,obj.id=filter._id||filter.id,obj.operation=filter.supportedOperations||filter.operation,filter.value&&(obj.value=filter.value||""),$scope.filterData.push(obj)})}),$.each($scope.selectedAlert.alertFieldsDefinition,function(i,defination){var obj={};$scope.alertDefination.alertfields[defination.key]=obj.value=defination.value||""})},$scope.selectedNode="",$scope.expiryType=[{key:"Duration",value:"daycount"},{key:"Number of Notification",value:"postcount"}];var alertScheduleOptions=$workflowService.seedData().alertScheduleOptions,languageSpecficOptions=alertScheduleOptions[$workflowService.currentLanguage()||selectedStream.defaultLanguage];hourValues=hourValues.map(function(each){var defaultValue=each.split(" ")[1];return each=each.replace(defaultValue,languageSpecficOptions.time[defaultValue])}),$scope.minutes=languageSpecficOptions.time.minutes,$scope.hours=languageSpecficOptions.time.hours,$scope.every=languageSpecficOptions.frequency[0].value,$scope.at=languageSpecficOptions.frequency[1].value,$scope.intervalConfig={reminders:{},time:languageSpecficOptions.scheme,frequency:languageSpecficOptions.frequency,timeOptions:{"default":[]}},$scope.intervalConfig.timeOptions[$scope.every]=[],$scope.intervalConfig.timeOptions[$scope.at]=[],$scope.intervalConfig.timeOptions[$scope.at+$scope.every]=[],$scope.intervalConfig.timeOptions[$scope.every+$scope.at]=[],timeValues.map(function(value){$scope.intervalConfig.timeOptions[$scope.at].push({value:value})}),hourValues.map(function(value){$scope.intervalConfig.timeOptions[$scope.every].push({value:value})}),$scope.intervalConfig.timeOptions[$scope.every+$scope.at]=$scope.intervalConfig.timeOptions[$scope.every].concat($scope.intervalConfig.timeOptions[$scope.at]),$scope.intervalConfig.timeOptions[$scope.at+$scope.every]=$scope.intervalConfig.timeOptions[$scope.at].concat($scope.intervalConfig.timeOptions[$scope.every]),$scope.settings={pollingInterval:"",time:["daily","weekday","weekend"],frequency:["every","at"],timeslots:[]};try{$scope.intervalConfig.reminders=JSON.parse(JSON.stringify(finalObj.reminders).replace(/<%|%>/g,""))}catch(ex){$scope.intervalConfig.reminders=finalObj.reminders||{}}$scope.intervalConfig.initPoll=finalObj.initPoll,$scope.intervalConfig.initPostCount=finalObj.initPostCount,$scope.intervalConfig.reminders.options=($scope.intervalConfig.reminders.options||[]).map(function(option){return option&&option.value}),$scope.intervalConfigCopy=angular.copy($scope.intervalConfig);var times,frequency,hours,intervals,result;times=getSelected($scope.intervalConfig.time,$scope.settings.time).map(pluckValue),frequency=getSelected($scope.intervalConfig.frequency,$scope.settings.frequency).map(pluckValue),hours=getSelected($scope.intervalConfig.timeOptions[$scope.at],$scope.settings.timeslots).map(pluckValue),intervals=getSelected($scope.intervalConfig.timeOptions[$scope.every],$scope.settings.timeslots).map(pluckValue);setTimeout(function(){if(config.smartAlertService&&config.smartAlertService.value){if($scope.selectedAlert=_.find($scope.alerts,{refId:config.component.nodeInfo.alertRef.refId}),$scope.alertDefination.alertfields=config.smartAlertService.value.alertFields||{},config.smartAlertService.value&&config.smartAlertService.value.filters&&($scope.alertFilters=config.smartAlertService.value.filters[0]),config.smartAlertService.value.repeatInterval){var value=cron.extract(config.smartAlertService.value.repeatInterval);value=value.split(","),$scope.pollOptions.day=value[0],$scope.pollOptions.frequency=value[1],$scope.pollOptions.interval=value[2]}$scope.expiryCount=config.component.nodeInfo.alertRef.alertExpiry.count,$scope.alertExpiry=config.component.nodeInfo.alertRef.alertExpiry.expiryType,$scope.alertUpgradeType.value=config.component.nodeInfo.alertRef.actionOnSmartAlertUpgrade,$scope.alertNotificationType&&$scope.selectedAlert&&"webhook"===$scope.selectedAlert.type&&($scope.alertNotificationType.value=config.component.nodeInfo.alertRef.notificationType)}},300),$scope.isFormValid=function(){return!$scope.smartAlertDetails.$invalid},$scope.saveReport=function(){"webhook"!==$scope.selectedAlert.type&&-1!==$scope.pollOptions.interval.indexOf($scope.minutes)?result=cron.build($scope.pollOptions.day,$scope.pollOptions.frequency,$scope.pollOptions.interval,$scope.minutes):"webhook"!==$scope.selectedAlert.type&&(result=cron.build($scope.pollOptions.day,$scope.pollOptions.frequency,$scope.pollOptions.interval,$scope.hours)),$scope.alertRef={refId:$scope.selectedAlert.refId,alertExpiry:{expiryType:$scope.alertExpiry,count:$scope.expiryCount},actionOnSmartAlertUpgrade:$scope.alertUpgradeType.value},$scope.alertNotificationType&&"webhook"===$scope.selectedAlert.type&&($scope.alertRef.notificationType=$scope.alertNotificationType.value),getAlertFiltersPayload(),$scope.alertData={serviceNodeType:"smartalert",headers:{type:"raw",value:"{}"},alertRef:$scope.alertRef,payload:{type:"raw",value:{alertFields:$scope.alertDefination.alertfields,repeatInterval:result}}},$scope.filterData&&$scope.filterData.length&&($scope.alertData.payload.value.filters=[$scope.filterData]);$scope.alertData;BTStreamsService.smartAlertSubscription($workflowService.selectedStream()._id,$scope.nodeInfo.nodeInfo._id,$scope.alertData).then(function(response){config.smartalertCB&&config.smartalertCB(response.data.payload),config.alertRefCB&&config.alertRefCB(response.data.alertRef),config.notificationCB&&config.notificationCB(response.data.alertRef.notificationType),config.saveSmartAlertSubscriptionComponentCB(response.data),$scope.closeModal()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})};var parameterObj={location:{parameterType:"location",format:{value:{latitude:17.385044,longitude:78.486671},title:"Hyderabad, Telangana, India"}},staticDropDown:{parameterType:"staticDropDown",format:{value:"2",title:"two"}},dynamicDropDown:{parameterType:"dynamicDropDown",format:{value:"2",title:"two"}},Date:{parameterType:"date",format:{title:"2018-01-09T09:08:34.382Z",value:"09-01-2018"}},TypeAhead:{parameterType:"typeahead",format:{title:"testing",value:"311106362006799"}},"Date & Time":{parameterType:"datetime",format:{title:"2018-01-09T09:12:39.336Z",value:"09-01-2018T14:42:39+05:30"}}};$scope.getParameterData=function(parameterType,key){return parameterObj[parameterType][key]},$scope.onInputKeyup=function(e){var _this=$(e.currentTarget);_this.val(_this.val().replace(/[^0-9_]+/g,"")),$scope.expiryCount=_this.val()},$scope.closeModal=function(){$(".smartAlertsModal ").modal("hide"),$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("soapAlertField",function(){return{restrict:"AE",scope:{mode:"@",onCancel:"&",onSave:"&",wfType:"@",operations:"=",parentWsdl:"=",setFieldData:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/soap-alert-field-form/soap-alert-field-form.html",controller:["$scope","soap","$util","form_util","$rootScope","urlutil","$filter","BTIdpService","NotificationService","$workflowService","$timeout","$translator","BTStreamsService","$q","env_conf","i18n",function($scope,soap,$util,form_util,$rootScope,urlutil,$filter,BTIdpService,NotificationService,$workflowService,$timeout,$translator,BTStreamsService,$q,env_conf,i18n){function init(){$scope.isApplicable=!1,$scope.displayCtrls={wsdl:!1},$scope.nestedFormField={},$scope.fieldData={},$scope.supportedDataTypes=_fieldData.dataType,$scope.supportedFieldTypes=_fieldData.fieldType,$scope.dynamicDropDownContentTypes=_fieldData.contentTypes=$workflowService.seedData().contentTypes,$scope.showTypeahead=!1,$scope.currentIdp={},$scope.testFormApi={},$scope.testingInProgress=!1}function preSelectOperation(operation_name,port_name){$scope.soap.operations.map(function(operation){operation.name===operation_name&&operation.port_name===port_name&&(operation.isUsed=!0)})}function assignOperations(description){$scope.soap.operations=$util.collectSoapOperations(description)}function getUsedOperation(){return $scope.soap.operations.filter(function(operation){return operation.isUsed})[0]}function resetOperations(){$scope.soap.operations.map(function(operation){return delete operation.isUsed,operation})}function collectFields(){var fields=[],usedOperations=$scope.soap.operations.filter(function(operation){return operation.isUsed});return usedOperations.map(function(operation){operation.input.map(function(input){fields.push(angular.copy(input))})}),fields=$scope.soapfields=_.unique(angular.copy(fields),"key")}function getAlertObject(){var operation=getUsedOperation(),alrtobj={};switch(alrtobj.title=$scope.fieldData.name,alrtobj.key=$scope.fieldData.key,alrtobj.help=$scope.fieldData.help,$scope.fieldData.dependsOn?alrtobj.dependsOn=$scope.fieldData.dependsOn.split(","):alrtobj.dependsOn=[],$scope.fieldData.visibility&&(alrtobj.visibility=$scope.fieldData.visibility),$scope.fieldData.mapping&&(alrtobj.mapping=$scope.fieldData.mapping),alrtobj.isRequired=$scope.fieldData.isRequired,alrtobj.isSearchable=$scope.fieldData.isSearchable,alrtobj.isMultiSelect=$scope.fieldData.isMultiSelect,alrtobj.transpose=!$scope.fieldData.transpose,alrtobj.metadata=$scope.fieldData.metadata,$scope.fieldData.datatype&&(alrtobj.type=$scope.fieldData.datatype.value),alrtobj.arrayElementType=$scope.fieldData.arrayElementType&&$scope.fieldData.arrayElementType.value,$scope.fieldData.fieldtype.value){case"textbox":case"url":case"textarea":case"email":case"timezone":alrtobj.placeholder=$scope.fieldData.textplaceholder,alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"file":alrtobj.placeholder=$scope.fieldData.textplaceholder,alrtobj.fieldType=$scope.fieldData.fieldtype.value,alrtobj.fileMeta=$scope.fieldData.fileMeta;break;case"staticDropDown":case"staticDropdownCB":alrtobj.staticDropDownFields=jsonHelper($scope.fieldData.staticDropDownFields,alrtobj.type),alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"checkbox":alrtobj.checkbox=jsonHelper($scope.fieldData.staticDropDownFields,alrtobj.type),alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"password":alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"label":case"location":alrtobj.fieldType=$scope.fieldData.fieldtype.value;break;case"date":case"datetime":alrtobj.fieldType=$scope.fieldData.fieldtype.value,alrtobj.placeholder=$scope.fieldData.textplaceholder,alrtobj.format=$scope.fieldData.format;break;case"nestedform":alrtobj.fieldType=$scope.fieldData.fieldtype.value,alrtobj.fields=$scope.fieldData.fields;break;case"typeahead":case"search":case"dynamicDropDown":case"dynamicDropDownCB":var uriParser=window.URI,components=uriParser.parse($scope.fieldData.dynamicDropDownURL||$scope.parentWsdl),rcEndpoint={host:components.host,port:components.port?components.port+"":"",portname:operation.port_name,servicename:operation.service_name,operation:operation.name,path:components.path,protocol:components.scheme,"content-type":"application/json",method:$scope.fieldData.dynamicDropDownMethod};components.query&&(rcEndpoint.path+="?"+components.query),components.fragment&&(rcEndpoint.path+="#"+components.fragment),"boolean"===alrtobj.type&&($scope.fieldData.dynamicDropDownValueKey=$scope.fieldData.dynamicDropDownValueKey.split(",").map(function(value){return isTrueType(value)}).join(",")),alrtobj.dynamicDropDownInfo={endPoint:rcEndpoint,keyForLabel:$scope.fieldData.dynamicDropDownLabelKey,keyForValue:$scope.fieldData.dynamicDropDownValueKey,responsePath:$scope.fieldData.dynamicDropDownPath},alrtobj.fieldType=$scope.fieldData.fieldtype.value}return alrtobj}function makeItClean(){var form=$scope.alertFieldsForm;for(var key in form)form.hasOwnProperty(key)&&"object"==typeof form[key]&&0!==key.indexOf("$")&&0!==key.indexOf("$$")&&(form[key].$dirty=!1);$scope.alertFieldsForm.__$invalid=!1}function jsonHelper(options,type){return options.map(function(option){switch(type){case"number":option.value=parseFloat(option.value);break;case"string":option.value=option.value+"";break;case"boolean":option.value=isTrueType(option.value)}return option})}function isTrueType(value){for(var values=["false",!1,0,"0","no","No","NO","False","FALSE"],i=0;i<values.length;i++)if(value===values[i])return!1;return!0}function clone(object){return JSON.parse(JSON.stringify(object))}var _fieldData=$workflowService.seedData().fieldsData;$scope._constants_=$rootScope._constants_,$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.streamId=$workflowService.selectedStream()._id,$scope.formats={"dd-MM-yyyy":"dd-MM-YYYY","MM-dd-yyyy":"MM-dd-YYYY","dd-MM-yy":"dd-MM-YY","yyyy-MM-dd":"YYYY-MM-dd"},$scope.keyvalueform={key:i18n.i18nString("keyvalueform_key"),value:i18n.i18nString("keyvalueform_value"),keyErrorMsg:i18n.i18nString("keyvalueform_keyErrorMsg"),valueErrorMsg:i18n.i18nString("keyvalueform_valueErrorMsg"),btnLabel:i18n.i18nString("keyvalueform_btnLabel"),btnText:i18n.i18nString("keyvalueform_btnText")},init(),$scope.$watch("setFieldData",function(newVal,oldVal){if(init(),$scope.fieldData={},$scope.alertFieldsForm.__$invalid=!1,newVal&&newVal.fieldType)switch($scope.fieldData.fieldtype=$filter("filter")(_fieldData.fieldType,{value:newVal.fieldType})[0],$scope.soap={operations:clone($scope.operations)},resetOperations(),$scope.fieldData.name=newVal.title,$scope.fieldData.key=newVal.key,$scope.fieldData.help=newVal.help,newVal.dependsOn&&($scope.fieldData.dependsOn=newVal.dependsOn.join(",")),newVal.visibility&&($scope.fieldData.visibility=newVal.visibility),newVal.mapping&&($scope.fieldData.mapping=newVal.mapping),$scope.fieldData.isRequired=newVal.isRequired,$scope.fieldData.isSearchable=newVal.isSearchable,$scope.fieldData.isMultiSelect=newVal.isMultiSelect,$scope.fieldData.untranspose=!newVal.transpose,$scope.fieldData.metadata=newVal.metadata,newVal.type&&($scope.fieldData.datatype=$filter("filter")(_fieldData.dataType,{value:newVal.type})[0]),newVal.arrayElementType&&($scope.fieldData.arrayElementType=$filter("filter")(_fieldData.dataType,{value:newVal.arrayElementType})[0]),newVal.fieldType){case"textbox":case"textarea":case"url":case"email":case"timezone":$scope.fieldData.textplaceholder=newVal.placeholder;break;case"file":$scope.fieldData.textplaceholder=newVal.placeholder,$scope.fieldData.fileMeta=newVal.fileMeta;break;case"datetime":case"date":$scope.fieldData.format=newVal.format,$scope.fieldData.textplaceholder=newVal.placeholder,$scope.showDateField=_.indexOf(Object.keys($scope.formats),newVal.format)<0;break;case"staticDropDown":case"staticDropdownCB":case"checkbox":$scope.fieldData.staticDropDownFields=newVal.staticDropDownFields;break;case"nestedform":$scope.fieldData.fields=newVal.fields;break;case"typeahead":case"search":case"dynamicDropDown":case"dynamicDropDownCB":$scope.isApplicable=!0;var endPoint=newVal.dynamicDropDownInfo.endPoint,endPointUrl=(window.URI,urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol}));endPointUrl!==$scope.parentWsdl?($scope.displayCtrls.wsdl=!0,$timeout(function(){$scope.getWSDLDesc().then(function(){preSelectOperation(endPoint.operation,endPoint.portname)})})):preSelectOperation(endPoint.operation,endPoint.portname),$scope.fieldData.dynamicDropDownURL=endPointUrl,$scope.fieldData.dynamicDropDownContentType=$filter("filter")(_fieldData.contentTypes,{value:newVal.dynamicDropDownInfo.endPoint["content-type"]})[0],$scope.fieldData.dynamicDropDownMethod=newVal.dynamicDropDownInfo.endPoint.method,$scope.fieldData.dynamicDropDownLabelKey=newVal.dynamicDropDownInfo.keyForLabel,$scope.fieldData.dynamicDropDownValueKey=newVal.dynamicDropDownInfo.keyForValue,$scope.fieldData.dynamicDropDownPath=newVal.dynamicDropDownInfo.responsePath;break;default:$scope.isApplicable=!1}}),$scope.showDateTextField=function(format){return"_new_"===format?($scope.showDateField=!0,$scope.fieldData.format="",$scope.fieldData.dateFormat="",void($scope.dateFormat="")):void($scope.fieldData.format=format)},$scope.hideDateTextField=function(){$scope.showDateField=!1,$scope.fieldData.format="",$scope.fieldData.dateFormat="",$scope.dateFormat=""},$scope.typeaheadDataProvider=$workflowService.sampleResponseKeys(),$scope.swithWsdlCtrls=function(){$scope.displayCtrls.wsdl?$scope.soap.operations=[]:$scope.soap={operations:clone($scope.operations)},resetOperations()},$scope.soap={},$scope.getWSDLDesc=function(){return soap.getDescription({url:$scope.fieldData.dynamicDropDownURL,streamId:$scope.streamId}).then(function(res){return assignOperations(res.data)})},$scope.useOperation=function(operation){resetOperations(),operation.isUsed=!0;var fields=collectFields(),dependsOn=[];fields.map(function(field){dependsOn.push(field.key)})},$scope.leaveOperation=function(operation){$timeout(function(){delete operation.isUsed})},$scope.getFieldKey=function(data){$scope.fieldData.key=data.typeaheadOutput.name||data.typeaheadOutput,$scope.showTypeahead=!1};$scope.saveAlertFieldObj=function(isValid,showIt,event,form){function triggerTaskFieldSave(){$scope.onSave({alertFieldDef:getAlertObject(),showIt:showIt}),$scope.fieldData={},makeItClean()}return($scope.keyvalueform.save||angular.noop)(),event&&event.preventDefault&&event.preventDefault(),form.__$invalid=!isValid,isValid?void triggerTaskFieldSave():(form_util.touch(form),void NotificationService.notify(i18n.i18nString("enter_mandatory_field"),"error"))},$scope.cancelFieldForm=function(){$scope.onCancel({fieldForm:!1})},$scope.isMultiRequired=function(type){var allowedTypes={dynamicDropDownCB:!0,dynamicDropDown:!0,staticDropDown:!0,staticDropdownCB:!0};return allowedTypes[type]},$scope.hasDependsOn=function(type){var fieldsWithDependsOn={dynamicDropDown:!0,typeahead:!0,dynamicDropDownCB:!0};return fieldsWithDependsOn[type]},$scope.$watch("fieldData.fieldtype",function(newVal,oldValue){newVal&&"nestedform"===newVal.value?($scope.fieldData.datatype=$filter("filter")($scope.supportedDataTypes,{value:"array"})[0],$scope.fieldData.arrayElementType=$filter("filter")($scope.supportedDataTypes,{value:"object"})[0]):newVal&&"file"===newVal.value&&($scope.fieldData.datatype=$filter("filter")($scope.supportedDataTypes,{value:"array"})[0],$scope.fieldData.arrayElementType=$filter("filter")($scope.supportedDataTypes,{value:"string"})[0])}),$scope.showNestedFieldForm=function(){$scope.nestedFormField={},$scope.showFieldForm=!$scope.showFieldForm};var editIndex="no-value";$scope.edit=function(index){editIndex=index,$timeout(function(){$scope.nestedFormField=angular.copy($scope.fieldData.fields[index])}),$scope.showNestedFieldForm()},$scope["delete"]=function(index){$scope.fieldData.fields.splice(index,1)},$scope.moveUp=function(from){$util.swap([$scope.fieldData.fields],from,from-1)},$scope.moveDown=function(from){$util.swap([$scope.fieldData.fields],from,from+1)},$scope.nestedFormSave=function(field,showIt){$scope.fieldData.fields||($scope.fieldData.fields=[]),"no-value"!==editIndex?$scope.fieldData.fields[editIndex]=field:$scope.fieldData.fields.push(field),editIndex="no-value",showIt||($scope.showFieldForm=!1)},$scope.nestedFormCancel=function(){$scope.showFieldForm=!1}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("soapRequestObject",function(){return{restrict:"EA",scope:{wfType:"@",onComplete:"&",onCancel:"&",displayMode:"@",configure:"&",isFinishSetupLoading:"=",resource:"=",hooks:"=?callbacks"},controller:["$scope","soap","$timeout","$util","$workflowService","form_util","$rootScope","NotificationService","BTActionsService","BTAlertsService","urlutil","$location","BTIdpService","$routeParams","i18n","env_conf",function($scope,soap,$timeout,$util,$workflowService,form_util,$rootScope,NotificationService,BTActionsService,BTAlertsService,urlutil,$location,BTIdpService,$routeParams,i18n,env_conf){function init(){$scope.soap={},$scope.datatypes=$workflowService.seedData().contentTypes,$scope.soapfields=[],$scope.soapReqChains=[],$scope.editedField={},$scope.saveInProgress=!1,$scope.authHooks={},editIndex="no-insert",$scope.sampleResCB={},$scope.afterSave=angular.noop,$scope.isReport=!1,$scope.tmpltPrePath=$scope.$root.tmpltPrePath}function assign(){var resource;if("alert"===$scope.wfType){var alertInfo=$workflowService.alertInfo(),mpAlertInfo=$workflowService.mpAlertInfo();angular.extend(finalObj,angular.copy(alertInfo)),angular.extend(finalObj,angular.copy(mpAlertInfo)),resource=$workflowService.alertInfo(),$scope.resource=resource}else if("action"===$scope.wfType){var actionInfo=$workflowService.actionInfo(),mpActionInfo=$workflowService.mpActionInfo();angular.extend(finalObj,angular.copy(actionInfo)),angular.extend(finalObj,angular.copy(mpActionInfo)),resource=$workflowService.actionInfo(),$scope.isReport=finalObj.isReport,$scope.resource=resource}$scope.isWebhook=function(){return"webhook"===$scope.resource.type},$scope.soap.datatype=finalObj.dataType,$scope.soap.sample=$util.jsonParse(finalObj.sample);var reqChain=finalObj.requestChain[0]&&finalObj.requestChain[0].linkDefinition||{},endPoint=angular.copy(reqChain.endPoint)||{};window.URI;if($scope.soap.wsdlUrl=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol}),"?undefined"===$scope.soap.wsdlUrl&&($scope.soap.wsdlUrl=""),$scope.soap.connectorEnabled=endPoint.connectorEnabled,$scope.soap.wsdlUrl&&finalObj.wsdlOperations){$scope.soap.wsdlOperations=finalObj.wsdlOperations,assignOperations(finalObj.wsdlOperations),preSelectOperation(endPoint.operation,endPoint.portname),collectFields();var fields="alert"==$scope.wfType?finalObj.alertFieldsDefinition:finalObj.payloadField.concat(finalObj.queryField);mergeAlertFields($scope.soapfields,fields)}}function orderFields(fields){for(var tree={},i=0;i<fields.length;i++)fields[i]&&(fields[i].dependsOn=fields[i].dependsOn||[],0===fields[i].dependsOn.length?tree[fields[i].key]="":(tree[fields[i].key]={},fields[i].dependsOn.map(function(key){tree[fields[i].key][key]=""})));var order=[];return Object.keys(tree).map(function(key){"object"==typeof tree[key]&&Object.keys(tree[key]).map(function(key2){order.push(key2)}),order.push(key)}),order=order.reverse(),fields=_.unique(order).map(function(key){return _.find(fields,{key:key})})}function mergeAlertFields(source,dest){return source.map(function(field){var index=_.findIndex(source,{key:field.key}),destField=_.find(dest,{key:field.key});destField&&$scope.soapfields.splice(index,1,destField)})}function concatAlertFields(fields){fields.map(function(field){$scope.soapfields.push(_.clone(field))}),$scope.soapfields=orderFields(_.unique(_.clone($scope.soapfields),"key"))}function delExistingFields(fields){fields.map(function(field){var index=_.findIndex($scope.soapfields,{key:field.key});field=_.find($scope.soapfields,{key:field.key}),field&&!field.isReqField&&$scope.soapfields.splice(index,1)})}function preSelectOperation(operation_name,port_name){$scope.soap.operations.map(function(operation){operation.name===operation_name&&operation.port_name===port_name&&(operation.isUsed=!0)})}function resetOperations(){$scope.soap.operations.map(function(operation){return delete operation.isUsed,operation})}function getSelectedReqChain(){return $scope.soap.operations?$scope.soap.operations.filter(function(operation){return operation.isUsed})[0]||{}:{}}function prepareField(field){return field.fieldType=field.fieldType?field.fieldType:"textbox",field.help=field.help?field.help:i18n.i18nString("please_provide_value"),field.isRequired=field.isRequired&&!0,field}function openFieldForm(){$timeout(function(){$(".soapfields").modal({show:!0,backdrop:"static"})})}function closeFieldForm(){$timeout(function(){$(".soapfields").modal("hide")})}function assignOperations(description){$scope.soap.operations=$util.collectSoapOperations(description),$scope.soapfields=[]}function collectFields(){var fields=[],usedOperations=$scope.soap.operations.filter(function(operation){return operation.isUsed});usedOperations.map(function(operation){operation.input.map(function(input){input=prepareField(input),input.isReqField=!0,fields.push(input)})}),$scope.soapfields=fields||_.unique(_.clone(fields),"key")}var editIndex;$scope.options={mode:"view"===$scope.displayMode?"tree":"code",ace:window.ace},$scope.connectors=[],$scope._constants_=$rootScope._constants_,$scope.authLists=[],$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.selected=i18n.i18nString("selected_label"),$scope.select=i18n.i18nString("select"),$scope.actionTask=i18n.i18nString("constants.action"),$scope.alertTask=i18n.i18nString("constants.alert"),$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.chevronRightDark=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-right-dark.svg",init(),function(){$scope.connectors=$workflowService.botConnectors(),BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.authLists=res.data,$scope.authLists.push({_id:"none",name:"none",sso_type:"none"}),$scope.currentIdp=$scope.authLists.filter(function(auth){return auth.name==finalObj.idp})[0]},function(res){$scope.authLists=[]})}(),$scope.soap.wsdlUrl="",$scope.getWsdlDesc=function(streamAccountId){var payload={url:$scope.soap.wsdlUrl,connectorEnabled:$scope.soap.connectorEnabled,streamAccountId:streamAccountId,sso_type:$scope.currentIdp.sso_type,idp:finalObj.idp,isAuthRequiredForWsdl:finalObj.isAuthRequiredForWsdl};return $scope.soap.connectorEnabled||delete payload.connectorEnabled,finalObj.isAuthRequiredForWsdl&&!streamAccountId?void $scope.openBasicAuthForm():soap.getDescription(payload).then(function(res){return $scope.soap.wsdlOperations=res.data,NotificationService.notify(i18n.i18nString("soap_request_wsdl_Desc_success"),"success"),assignOperations(res.data)},function(err){NotificationService.notify(i18n.i18nString("soap_request_wsdl_Desc_fail"),"error")})},$scope.testFormApi={},$scope.openBasicAuthForm=function(){$timeout(function(){$scope.testFormApi.testIdp()})};var finalObj={};assign(),$scope.performOperation=function(operation){operation.isUsed?$scope.leaveOperation(operation):$scope.useOperation(operation)},$scope.useOperation=function(operation){resetOperations(),operation.isUsed=!0,collectFields()},$scope.leaveOperation=function(operation){delete operation.isUsed,collectFields()},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.editField=function(index){editIndex=index,$scope.editedField=angular.copy($scope.soapfields[index]),$scope.editedField=_.clone(prepareField($scope.editedField)),openFieldForm()},$scope.deleteField=function(index,deleteField){return deleteField?void $scope.soapfields.splice(index,1):void NotificationService.alert(i18n.i18nString("are_you_really_want_to_del_Field"),$scope.deleteField,[index,!0])},$scope.onSoapFieldSave=function(field,showIt){field.isReqField=!0,"no-insert"!==editIndex?$scope.soapfields.splice(editIndex,1,field):$scope.soapfields.push(field),showIt?$scope.editedField={}:closeFieldForm()},$scope.onSoapFieldCancel=function(){closeFieldForm()},$workflowService.registerModalHiddenEvent(),$scope.sampleResCB.onBlur=function(editor){$scope.soapreqform.$dirty=!0,$scope.invalidSampleRes=!1;var _value=editor.getText();if(""===_value)$scope.soap.sample={};else try{JSON.parse(_value)}catch(e){$scope.invalidSampleRes=!0}},$scope.saveRequestChain=function(event,form,stopNavigation){if($scope.stopNavigation=stopNavigation,!form.$valid)return event.preventDefault(),void form_util.touch(form);if($scope.invalidSampleRes)return void NotificationService.notify(i18n.i18nString("provide_valid_Response"),"error");$scope.saveInProgress=!0;var resourceId,operation=getSelectedReqChain(),sampleResponse=$scope.soap.sample?$scope.soap.sample:{},reqChain={},reqObj={},uriParser=window.URI,components=uriParser.parse($scope.soap.wsdlUrl);reqChain.name=operation.service_name,reqChain.streamId=$workflowService.selectedStream()._id,reqChain.streamName=$workflowService.selectedStream().name,reqChain.endPoint={host:components.host,port:components.port?components.port+"":"",portname:operation.port_name,servicename:operation.service_name,operation:operation.name,path:components.path+"?"+components.query,protocol:components.scheme,"content-type":"application/json",method:"",jobSubType:"soap",connectorEnabled:$scope.soap.connectorEnabled},reqObj.type="webservice",reqObj.dataType="application/json",
reqObj.requestChain=[{linkType:"apiObject",linkDefinition:reqChain}],reqObj.sample=JSON.stringify(sampleResponse),reqObj.wsdlOperations=$scope.soap.wsdlOperations,"alert"===$scope.wfType?(reqObj.alertFieldsDefinition=angular.copy($scope.soapfields),reqObj.alertFieldsDefinition=reqObj.alertFieldsDefinition.map(function(field){return delete field.isReqField,field}),reqObj.alertFieldsRequired=reqObj.alertFieldsDefinition.length>0,resourceId=$workflowService.alertInfo()._id,BTAlertsService.createBTAlertUp(resourceId,reqObj).then(function(res){$workflowService.alertInfo(res.data),$rootScope.$broadcast("event:sampelResponeChange",res.data.sample),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo);var _alertInfo=$workflowService.alertInfo();_alertInfo.taskType="alert",$scope.$emit("mpResourceUpdate",_alertInfo),NotificationService.notify(i18n.i18nString("request_data"),"success"),stopNavigation||$scope.onComplete(),$scope.saveInProgress=!1,$scope.afterSave(),$scope.soapreqform.$dirty=!1},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("failed_save_request"),"error")})):"action"===$scope.wfType&&(reqObj.payloadField=angular.copy($scope.soapfields),reqObj.payloadField=reqObj.payloadField.map(function(field){return delete field.isReqField,field}),resourceId=$workflowService.actionInfo()._id,BTActionsService.updateBTAction(resourceId,reqObj).then(function(res){$workflowService.actionInfo(res.data),$rootScope.$broadcast("evt:nextSucc",$scope.moveTo);var _actionInfo=$workflowService.actionInfo();_actionInfo.taskType="action",$scope.$emit("mpResourceUpdate",_actionInfo),NotificationService.notify(i18n.i18nString("request_data"),"success"),stopNavigation||$scope.onComplete(),$scope.saveInProgress=!1,$scope.afterSave(),$scope.soapreqform.$dirty=!1},function(res){$rootScope.saveAndExit=!1,$scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("failed_save_request"),"error")}))},$scope.hooks.isChanged=function(){return $scope.soapreqform&&$scope.soapreqform.$dirty||$scope.authHooks.isChanged()},$scope.hooks.showSave=function(){return $scope.showSave()},$scope.hooks.triggerSave=function(callback){$scope.afterSave=callback,$scope.authHooks.isChanged()&&$scope.authHooks.triggerSave($scope.soapreqform.$dirty?null:callback),$scope.soapreqform.$dirty&&$scope.saveRequestChain($scope.$event,$scope.soapreqform,!1)},$scope.showSave=function(){return Object.keys(getSelectedReqChain()).length>0},$scope.clear=function(){init()},$scope.cancel=function(){assign()},$rootScope.$on("evtAddFields",function(event,fields){fields=fields.map(function(field){field=prepareField(field)}),concatAlertFields(fields)}),$rootScope.$on("evtDelFields",function(event,fields){delExistingFields(fields)}),$scope.onFinishSetup=function(type){$scope.configure({type:$routeParams.resourceType})},$scope.$on("evt:nextActReq",function(evt,data){!$scope.displayMode||$scope.displayMode&&"edit"===$scope.displayMode?($scope.moveTo=data,$scope.saveRequestChain(evt,$scope.soapreqform),$rootScope.saveAndExit=!1):$location.path(window.appConfig.CONTEXT_PATH+"/workflows")})}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/soap-request-object/soap-request-object.html",link:function($scope,ele,attrs){}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("streamForm",function(){return{restrict:"EA",scope:{onCancel:"&",onBack:"&",onSave:"&",displayMode:"@",streamId:"@",editMode:"@",botType:"=?",loadStore:"&",dropdownView:"=",views:"=?"},transclude:!0,templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/stream-form/stream-form.html",controller:["$scope","form_util","$routeParams","$rootScope","patternFactory","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","env_conf","localstore","i18n","jsEvents","mixPanel",function($scope,form_util,$routeParams,$rootScope,patternFactory,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,env_conf,localstore,i18n,jsEvents,mixPanel){function getDomain(email){if(email){var atRateIndex=email.indexOf("@");return email.substr(atRateIndex+1)}}function getBase64(file){var _reader=new FileReader;_reader.onloadend=function(loadEvent){$scope.ImgString=_reader.result},_reader.readAsDataURL(file)}function initializeNewStreamData(){$scope.$emit("resetFilterValue"),$scope.isWorkProgress=!1,$scope.streamObject={profileRequired:"true",purpose:"customer",sbannerchoice:"color",bbannerchoice:"color",color:"#009dab"}}function getStreams(streamForm){$scope.streamForm=streamForm,("view"===$scope.displayMode||"edit"===$scope.displayMode)&&($scope.streamId?BTStreamsService.getBTStream($scope.streamId).then(function(res){$scope.streamObject={name:res.data.name,type:res.data.type||"default",description:res.data.description,websiteUrl:res.data.websiteUrl,demoYoutubeLink:res.data.demoYoutubeLink,botDocLink:res.data.botDocLink,color:res.data.color,hasUserEndpoint:res.data.hasUserEndpoint,keywords:null,hasTenant:res.data.hasTenant,defaultUrl:res.data.baseUrl,helpHint:res.data.tenancy?res.data.tenancy.helpHint:null,sharing:{},offKoraConfirmation:res.data.offKoraConfirmation,synonyms:res.data.synonyms,purpose:res.data.purpose,skipMakeEditLinks:res.data.skipMakeEditLinks||!1};try{$scope.streamObject.sharing[res.data.visibility.namespace[0]]=!0,$scope.streamObject.sharing[res.data.visibility.namespace[1]]=!0}catch(ex){}res.data.errorCodes&&res.data.errorCodes.pollError&&($scope.streamObject.pollError=res.data.errorCodes.pollError,$scope.streamObject.errorCodes=res.data.errorCodes.pollError),res.data.visibility&&res.data.visibility.namespaceIds&&res.data.visibility.namespaceIds.forEach(function(item){for(var i=0;i<$scope.myTeams.length;i++)if($scope.myTeams[i].id===item){$scope.myTeams[i].selected=!0;break}})}).then(function(){BTStreamsService.getMPStream($scope.streamId).then(function(res){res.data&&($scope.streamObject.categoryIds=res.data.categoryIds,$scope.streamObject.websiteUrl=res.data.websiteURL,$scope.streamObject.demoYoutubeLink=res.data.demoYoutubeLink,$scope.streamObject.botDocLink=res.data.botDocLink,$scope.streamObject["class"]=res.data["class"],$scope.streamObject.tagline=res.data.tagline,$scope.streamObject.userTaskListMsg=res.data.userTaskListMsg,$scope.streamObject.teamTaskListMsg=res.data.teamTaskListMsg,$scope.streamObject.profileRequired=res.data.profileRequired+"",$scope.streamObject.sendVcf=res.data.sendVcf+"",$scope.streamObject.purposeisRequired=!0,$scope.streamObject.icon={fileName:"StreamIcon.png"},res.data.bBanner&&($scope.streamObject.bBanner={fileName:"Big Banner.png"}),res.data.sBanner&&($scope.streamObject.sBanner={fileName:"Small Banner.png"}),$scope.streamObject.bBannerColor=res.data.bBannerColor,$scope.streamObject.sBannerColor=res.data.sBannerColor,$scope.streamObject.keywords=res.data.keywords.length>0?res.data.keywords.join(","):null,$scope.streamObject.isInMarket=$workflowService.selectedStream().isInMarket,$scope.streamObject.bbannerchoice="color",$scope.streamObject.sbannerchoice="color",$scope.streamObject.isNLEnabled=res.data.isNLEnabled?"yes":"no",$scope.commandCtx.streamId=$scope.streamId,$scope.commandCtx.getSlashCommands(),$scope.streamForm.$setPristine(),loader())})}):console.log("stream check"))}function createMPStream(streamData){"universalbot"===$scope.botType&&(streamData.type=$scope.botType),$scope.streamId&&"edit"===$scope.displayMode?BTStreamsService.updateMPStream($scope.streamId,streamData).then(function(response){$scope.saveInProgress=!1,slashCommand($scope.streamId),$workflowService.streamType(""),$scope.streamObject={},form_util.makeItClean($scope.streamForm),initializeNewStreamData()},function(res){$scope.saveInProgress=!1,NotificationService.notify(res.data.errors[0].msg,"error")}):BTStreamsService.createMPStream($applicationService.userInfo().userId,streamData).then(function(response){$scope.saveInProgress=!1,$rootScope.$emit("triggerSolutionBotSetup"),$(".kore-chat-header .close-btn").click(),slashCommand(streamData._id),$workflowService.streamType(""),$scope.streamObject={},form_util.makeItClean($scope.streamForm),initializeNewStreamData()},function(res){$scope.saveInProgress=!1,NotificationService.notify(res.data.errors[0].msg,"error")})}function createBTStream(streamData){$scope.duplicateStreamName=!1,$scope.saveInProgress||(streamData.type=$scope.botType,$scope.streamId&&"edit"===$scope.displayMode?($scope.saveInProgress=!0,BTStreamsService.editStream($scope.streamId,streamData).then(function(response){var mpPostData={};$scope.newStreamData=response.data,mpPostData._id=response.data._id,mpPostData.name=$scope.streamObject.name,mpPostData["class"]=$scope.streamObject["class"],mpPostData.description=$scope.streamObject.name,mpPostData.tagline=$scope.streamObject.tagline,"universalbot"!==$scope.botType&&(mpPostData.categoryIds=[$scope.streamObject.categoryIds]),mpPostData.icon=$scope.streamObject.icon.fileId,mpPostData.websiteURL=$scope.streamObject.websiteUrl,mpPostData.demoYoutubeLink=$scope.streamObject.demoYoutubeLink,mpPostData.botDocLink=$scope.streamObject.botDocLink,mpPostData.keywords=$scope.streamObject.keywords?$scope.streamObject.keywords.split(","):[],mpPostData.languages=[],mpPostData.price=1,mpPostData.screenShots=[],mpPostData.namespace="private",mpPostData.namespaceIds=[],mpPostData.userTaskListMsg=$scope.streamObject.userTaskListMsg,mpPostData.teamTaskListMsg=$scope.streamObject.teamTaskListMsg,mpPostData.bBanner=$scope.streamObject.bBanner?$scope.streamObject.bBanner.fileId:"",mpPostData.sBanner=$scope.streamObject.sBanner?$scope.streamObject.sBanner.fileId:"","color"===$scope.streamObject.bbannerchoice?mpPostData.bBannerColor=$scope.streamObject.color:$scope.streamObject.bBanner&&$scope.streamObject.bBanner.fileId&&(mpPostData.bBanner=$scope.streamObject.bBanner.fileId),"color"===$scope.streamObject.sbannerchoice?mpPostData.sBannerColor=$scope.streamObject.color:$scope.streamObject.sBanner&&$scope.streamObject.sBanner.fileId&&(mpPostData.sBanner=$scope.streamObject.sBanner.fileId),mpPostData.color=$scope.streamObject.color,_.addProps($scope.streamObject.purposeisRequired,mpPostData,{purpose:$scope.streamObject.purpose}),mpPostData.profileRequired="true"===$scope.streamObject.profileRequired,mpPostData.sendVcf="true"===$scope.streamObject.sendVcf&&mpPostData.profileRequired,mpPostData.isNLEnabled="yes"==$scope.streamObject.isNLEnabled,$workflowService.selectedStream(response.data),$workflowService.currentLanguage(response.data.defaultLanguage),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data)}),createMPStream(mpPostData)},function(res){return $scope.saveInProgress=!1,$scope.isWorkProgress=!1,409===res.data.errors[0].code&&"Stream with same name already exists"===res.data.errors[0].msg?void($scope.duplicateStreamName=!0):void(412.405===res.data.errors[0].code||403===res.data.errors[0].code?window.bootbox.dialog({message:res.data.errors[0].msg,className:"alert-modal",closeButton:!1,buttons:{main:{label:i18n.i18nString("contact_us"),className:"contact-us",callback:function(){return window.open("https://kore.ai/contact-us/"),!1}},success:{label:i18n.i18nString("close"),className:"closeCancel",callback:function(){return!0}}}}):NotificationService.notify(res.data.errors[0].msg,"error"))})):($scope.saveInProgress=!0,$scope.language&&$scope.language.value&&(streamData.defaultLanguage=$scope.language.value),$scope.streamObject.icon.fileId&&(streamData.icon=$scope.streamObject.icon.fileId),streamData.isFromBT=!0,BTStreamsService.createBTStream($applicationService.userInfo().userId,streamData).then(function(response){var mpPostData={};$scope.newStreamData=response.data,mpPostData._id=response.data._id,mpPostData.name=$scope.streamObject.name.trim().replace(/\s\s+/g," "),mpPostData.description=$scope.streamObject.name,mpPostData["class"]=$scope.streamObject["class"],"universalbot"!==$scope.botType&&(mpPostData.categoryIds=[$scope.streamObject.categoryIds]),mpPostData.icon=$scope.streamObject.icon.fileId,mpPostData.keywords=$scope.streamObject.keywords?$scope.streamObject.keywords.split(","):[],mpPostData.languages=[],mpPostData.price=1,mpPostData.screenShots=[],mpPostData.namespace="private",mpPostData.namespaceIds=[],mpPostData.userTaskListMsg=$scope.streamObject.userTaskListMsg,mpPostData.teamTaskListMsg=$scope.streamObject.teamTaskListMsg,mpPostData.color=$scope.streamObject.color,mpPostData.tagline=$scope.streamObject.tagline,mpPostData.bBanner=$scope.streamObject.bBanner?$scope.streamObject.bBanner.fileId:"",mpPostData.sBanner=$scope.streamObject.sBanner?$scope.streamObject.sBanner.fileId:"",mpPostData.bBannerColor=$scope.streamObject.bBannerColor=$scope.streamObject.color,mpPostData.sBannerColor=$scope.streamObject.sBannerColor=$scope.streamObject.color,"color"===$scope.streamObject.bbannerchoice?mpPostData.bBannerColor=$scope.streamObject.color:$scope.streamObject.bBanner&&$scope.streamObject.bBanner.fileId&&(mpPostData.bBanner=$scope.streamObject.bBanner.fileId),"color"===$scope.streamObject.sbannerchoice?mpPostData.sBannerColor=$scope.streamObject.color:$scope.streamObject.sBanner&&$scope.streamObject.sBanner.fileId&&(mpPostData.sBanner=$scope.streamObject.sBanner.fileId),mpPostData.websiteURL=$scope.streamObject.websiteUrl,mpPostData.demoYoutubeLink=$scope.streamObject.demoYoutubeLink,mpPostData.botDocLink=$scope.streamObject.botDocLink,mpPostData.profileRequired="true"===$scope.streamObject.profileRequired,mpPostData.sendVcf="true"===$scope.streamObject.sendVcf&&mpPostData.profileRequired,$workflowService.selectedStream(response.data),$workflowService.newBotSetupProgress(response.data),$workflowService.currentLanguage(response.data.defaultLanguage),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data)}),createMPStream(mpPostData);var eventInfoBotsCreate={Category:"Activation","Sub Category":"Activation - VA",Level:"ONBOARDING AND ACTIVATION","VA - Inititiation Mode":"Scratch"};mixPanel.postEvent("VA - New Bot Initiated",eventInfoBotsCreate)},function(res){return $scope.saveInProgress=!1,$scope.isWorkProgress=!1,409===res.data.errors[0].code&&"Stream with same name already exists"===res.data.errors[0].msg?void($scope.duplicateStreamName=!0):void(412.405===res.data.errors[0].code||403===res.data.errors[0].code?window.bootbox.dialog({message:res.data.errors[0].msg,className:"alert-modal",closeButton:!1,buttons:{main:{label:i18n.i18nString("contact_us"),className:"contact-us",callback:function(){return window.open("https://kore.ai/contact-us/"),!1}},success:{label:i18n.i18nString("close"),className:"closeCancel",callback:function(){return!0}}}}):NotificationService.notify(res.data.errors[0].msg,"error"))})))}function getStreamIconData(newIconOverride,hideNotify){var url;url=env_conf["components-source"],getFileObject(url+$scope.selectedIcon.uploadPath,function(fileObject){console.log(fileObject),$scope.streamObject.iconFile=fileObject;var showNotification=!hideNotify&&newIconOverride;$scope.uploadStreamIcon(showNotification,newIconOverride)})}function slashCommand(id){var msg=$routeParams.streamId?i18n.i18nString("updated_label"):i18n.i18nString("saved_label_lowercase");if($scope.commandCtx.createSlashCommand){var command=$scope.streamObject.command||{};return $scope.commandCtx.streamId=$scope.streamId||id,0===Object.keys(command).length?void notifyStreamStatus($scope.streamObject.name,msg):$scope.commandCtx.createSlashCommand().then(function(res){$scope.streamObject.command._id=res.data._id,notifyStreamStatus($scope.streamObject.name,msg)},function(err){var errorMsg=err.data.errors[0].msg;NotificationService.notify(errorMsg,"error")})}notifyStreamStatus($scope.streamObject.name,msg)}function notifyStreamStatus(streamName,msg){NotificationService.notify(streamName+msg+i18n.i18nString("successfully_lowercase"),"success"),$workflowService.selectedStream($scope.newStreamData),$scope.onSave()}$rootScope.licenseType;$scope.allBots=$workflowService.streamsAll(),$scope.snapshotsArray=[],$scope.selectTab="icons",$scope.commandCtx={},$scope.isWorkProgress=!1,$scope.loadingStreamForm=!0,$scope.isUploading=!1,$scope.errorInsideStream=!0;var selectedAccount=$workflowService.selectedAccount();$scope.categories=$workflowService.seedData().category,$scope.duplicateStreamName=!1,$scope.showBotNameHint=!1,$scope._constants_=$rootScope._constants_,$scope.ImgString=null,$scope.customStreamData={},$scope.nluSupportedLanguages=$workflowService.seedData().nluSupportedLanguages||[{name:"English",value:"en"},{name:"German",value:"ge"},{name:"Spanish",value:"sp"}],$scope.multiLingualConfigurations={nluLanguage:"en",inputTranslation:!1,responseTranslation:!1},$scope.defaultBotIconsSmall=[{id:"icon1",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-1.png",uploadPath:"/assets/botIcons/updatedIcons/icon-1.png"},{id:"icon2",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-2.png",uploadPath:"/assets/botIcons/updatedIcons/icon-2.png"},{id:"icon3",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-3.png",uploadPath:"/assets/botIcons/updatedIcons/icon-3.png"},{id:"icon4",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-4.png",uploadPath:"/assets/botIcons/updatedIcons/icon-4.png"},{id:"icon5",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-5.png",uploadPath:"/assets/botIcons/updatedIcons/icon-5.png"},{id:"icon6",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-6.png",uploadPath:"/assets/botIcons/updatedIcons/icon-6.png"},{id:"icon7",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-7.png",uploadPath:"/assets/botIcons/updatedIcons/icon-7.png"},{id:"icon8",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-8.png",uploadPath:"/assets/botIcons/updatedIcons/icon-8.png"}],$scope.defaultBotIcons=[{id:"icon1",path:env_conf["context-url"]+"/assets/botIcons/updatedIcons/icon-1.png",uploadPath:"/assets/botIcons/updatedIcons/icon-1.png"},{id:"icon2",path:env_conf["context-url"]+"/assets/botIcons/updatedIcons/icon-2.png",uploadPath:"/assets/botIcons/updatedIcons/icon-2.png"},{id:"icon3",path:env_conf["context-url"]+"/assets/botIcons/updatedIcons/icon-3.png",uploadPath:"/assets/botIcons/updatedIcons/icon-3.png"},{id:"icon4",path:env_conf["context-url"]+"/assets/botIcons/updatedIcons/icon-4.png",uploadPath:"/assets/botIcons/updatedIcons/icon-4.png"},{id:"icon5",path:env_conf["context-url"]+"/assets/botIcons/updatedIcons/icon-5.png",uploadPath:"/assets/botIcons/updatedIcons/icon-5.png"},{id:"icon6",path:env_conf["context-url"]+"/assets/botIcons/updatedIcons/icon-6.png",uploadPath:"/assets/botIcons/updatedIcons/icon-6.png"},{id:"icon7",path:env_conf["context-url"]+"/assets/botIcons/updatedIcons/icon-7.png",uploadPath:"/assets/botIcons/updatedIcons/icon-7.png"},{id:"icon8",path:env_conf["context-url"]+"/assets/botIcons/updatedIcons/icon-8.png",uploadPath:"/assets/botIcons/updatedIcons/icon-8.png"}],$scope.selectedIcon=JSON.parse(JSON.stringify($scope.defaultBotIcons[0])),$scope.uploadImage=env_conf["context-url"]+"/assets/botIcons/updatedIcons/image.png",$scope.defaultImg=env_conf["context-url"]+"/assets/botIcons/new/bot-1.png",$scope.bulbSvg=env_conf["context-url"]+"/assets/images/24x29-bulbicon.png",$scope.backArrow=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.importDummy=env_conf["context-url"]+"/assets/botIcons/import-dummy.png",$scope.helpIcon=env_conf["context-url"]+"/assets/landingImages/helpIcon.svg",$scope.storeInspiration=env_conf["context-url"]+"/assets/icons-new/newbot/store-inspiration.svg",$scope.footerInfoTitle="What target audience should I choose?",$scope.footerHeaderId="streamForm",$scope.footerPanelId="streamFormPanel",$scope.sdkCallback={},$scope.loaderMessage=i18n.i18nString("working_on_it_lowercase"),BTSeedDataService.getSeedCategories().then(function(res){$scope.categories=res.data.categories,$scope.streamObject.categoryIds=$scope.categories[$scope.categories.length-1]._id,$scope.streamObject.type="default"}),$scope.importBot=i18n.i18nString("import_bot"),$scope.createNewBot=i18n.i18nString("create_new"),$scope.charRemaining=i18n.i18nString("char_remaining"),$scope.savingBot=i18n.i18nString("savingBot"),$scope.saveBot=i18n.i18nString("saveBot"),$scope.redirectToLinkStreamForm=function(type,e){e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()),$rootScope.redirectToLink(type,e)};var currentUser=localstore.getAuthData().currentAccount;$scope.isDomainKore="kore"===getDomain(currentUser.userInfo.emailId).split(".")[0],$scope.botTypeObject=[{id:"default",name:i18n.i18nString("standard_bot_label"),type:"default"},{id:"universalbot",name:i18n.i18nString("universal_bot"),type:"universalbot"}],selectedAccount.accountType||$scope.botTypeObject.push({id:"solution",name:i18n.i18nString("smart_bot"),type:"solution"}),$scope.isDomainKore&&$scope.botTypeObject.push({id:"sample",name:i18n.i18nString("sample_bot"),type:"sample"});var botColor=["#4E74F0","#E44929","#FF7A00","#BDA100","#E36CA2","#591880","#3AB961","#654BAF","#1B3880","#9D1850","#DB9400","#008930"];$scope.getRandomColor=function(){return botColor[Math.floor(12*Math.random())+1]},$scope.categoryConfig={allowclear:!0,multiple:!0,placeholder:i18n.i18nString("select_category")},$scope.classConfig={allowclear:!0,multiple:!0,placeholder:i18n.i18nString("select_class")},$scope.universalBotPurposeError=!1,$scope.userImportCallback={};var allStreams=$workflowService.streamsAll();if(allStreams.length)var employeeBots=_.filter(allStreams,{purpose:"employee"}),customerBots=_.filter(allStreams,{purpose:"customer"});$scope.validateColor=function(){return!1},initializeNewStreamData(),$scope.streamObject.purposeisRequired=!0,$scope.myTeams=[],$scope.showNlpEnable=function(){return $rootScope.wfAdmin};var loader;$scope.streamId&&(loader=NotificationService.loader(i18n.i18nString("please_wait_noty"))),$scope.getStreams=getStreams,$scope.saveInProgress=!1,$scope.validateTeamShare=function(){if($scope.myTeams){var selectedTeamCount=0;return $scope.myTeams.forEach(function(team){team.selected&&selectedTeamCount++}),selectedTeamCount>0?!0:!1}return!1},$scope.closeDropdown=function(){$("body").trigger("click")},$scope.postStreamPayloadToParent=function(){$scope.views&&$scope.views.createApp?($scope.isWorkProgress=!0,$scope.views.createApp($scope.streamObject)):$scope.onSave($scope.streamObject)},$scope.createStream=function(isValid,form,event){var errors;({BotName:$scope.streamObject.name});if($scope.botType=$scope.streamObject.type,event&&event.preventDefault&&event.preventDefault(),!isValid)return void form_util.touch(form);if(!$scope.streamObject.icon)return void($scope.iconRequiredError=!0);if($scope.views&&"PA"===$scope.views.product)return void $scope.postStreamPayloadToParent();$scope.isWorkProgress=!0;var btPostData={},botName=$scope.streamObject.name;$scope.streamObject.name&&(botName=$scope.streamObject.name.trim().replace(/\s\s+/g," ")),btPostData.name=botName,btPostData.type=$workflowService.streamType()||$scope.streamObject.type,btPostData.type=$scope.streamObject.type,btPostData.description=$scope.streamObject.name,btPostData.color=$scope.streamObject.color,"universalbot"!==$scope.botType&&(btPostData.categoryIds=[$scope.streamObject.categoryIds]),btPostData.websiteUrl=$scope.streamObject.websiteUrl,btPostData.demoYoutubeLink=$scope.streamObject.demoYoutubeLink,btPostData.botDocLink=$scope.streamObject.botDocLink,btPostData.hasTenant=$scope.streamObject.hasTenant,btPostData.offKoraConfirmation=$scope.streamObject.offKoraConfirmation,btPostData.synonyms=$scope.streamObject.synonyms,btPostData.skipMakeEditLinks=$scope.streamObject.skipMakeEditLinks||!1,_.addProps($scope.streamObject.purposeisRequired,btPostData,{purpose:$scope.streamObject.purpose}),btPostData.hasTenant&&(btPostData.tenancy={},btPostData.tenancy.helpHint=$scope.streamObject.helpHint,btPostData.baseUrl=$scope.streamObject.defaultUrl),errors=angular.copy($scope.streamObject.errorCodes),errors&&errors instanceof Array&&(errors=errors.map(function(obj){return delete obj.insert,obj})),errors=_.union(errors,$scope.streamObject.pollError),errors=_.uniq(errors,function(error){return+error.statusCode}),btPostData.errorCodes={pollError:errors},btPostData.visibility={namespace:[],namespaceIds:[]},$scope.streamObject.sharing&&$scope.streamObject.sharing.enterprise&&btPostData.visibility.namespace.push("enterprise"),$scope.streamObject.sharing&&$scope.streamObject.sharing.team&&(btPostData.visibility.namespace.push("team"),btPostData.visibility.namespaceIds=[],$scope.myTeams&&$scope.myTeams.forEach(function(team){team.selected&&btPostData.visibility.namespaceIds.push(team.id)})),btPostData.multiLingualConfigurations={},btPostData.multiLingualConfigurations[$scope.language.value]={nluLanguage:$scope.multiLingualConfigurations.nluLanguage,inputTranslation:$scope.multiLingualConfigurations.inputTranslation,responseTranslation:$scope.multiLingualConfigurations.responseTranslation},console.log(btPostData,$scope.multiLingualConfigurations),createBTStream(btPostData)};var getFileBlob=function(url,cb){var xhr=new XMLHttpRequest;xhr.open("GET",url),xhr.responseType="blob",xhr.addEventListener("load",function(){cb(xhr.response)}),xhr.send()},blobToFile=function(blob,name){return blob.lastModifiedDate=new Date,blob.name=name,blob},getFileObject=function(filePathOrUrl,cb){getFileBlob(filePathOrUrl,function(blob){cb(blobToFile(blob,"newBot.png"))})};$scope.resetIconUpload=function(){$scope.selectedIcon=JSON.parse(JSON.stringify($scope.defaultBotIcons[0])),$scope.resetingIcon=!0,$scope.selectNewDefaultBotIcon($scope.selectedIcon,!0),NotificationService.notify("Icon reset successful","success"),$scope.customStreamData={},$("#customStreamData")&&$("#customStreamData").length&&($("#customStreamData")[0].value=null)},$scope.importNewProcessApp=function(){var importPayload={importProcessName:$scope.streamObject.name,iconFileId:$scope.streamObject.icon.fileId,processImportDef:$scope.userImportCallback.definitionFormData,processImportConfig:$scope.userImportCallback.configFormData};$rootScope.$broadcast("importNewProcessApp"),jsEvents.postMessageToChildIframes("importProcessApp","#processFlowsFrame",importPayload),$(".bt-welcome-modal").addClass("hide")},$scope.loadStreamIcon=function(){if($scope.customStreamData&&$scope.customStreamData.iconFile&&$scope.customStreamData.iconFile.name){var _ext=$scope.customStreamData.iconFile.name.substring($scope.customStreamData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),$scope.imageExtensionError=!0,void $scope.resetIconUpload();$scope.imageExtensionError=!1;var reader=new FileReader;reader.onload=function(loadEvent){$scope.$apply(function(){$scope.customStreamData.iconUploading=!0,$scope.customStreamData.uploadedIcon=loadEvent.target.result,$scope.confirmUploadOfNewIcon(!1)})},reader.readAsDataURL($scope.customStreamData.iconFile)}},$scope.confirmUploadOfNewIcon=function(hideNotify){$scope.selectedIcon.id="custom",$scope.streamObject.iconFile=$scope.customStreamData.iconFile,$scope.uploadStreamIcon(!hideNotify,!0,!0)},$scope.selectNewDefaultBotIcon=function(iconObj,hideNotify){$scope.selectedIcon=JSON.parse(JSON.stringify(iconObj)),getStreamIconData(!0,hideNotify)},getStreamIconData(),$scope.uploadStreamIcon=function(showNotification,newIconOverride,customIcon){if($scope.streamObject.iconFile.name){var _ext=$scope.streamObject.iconFile.name.substring($scope.streamObject.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),$scope.fileExtensionError=!0,void $scope.resetIconUpload()}$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.streamObject.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.streamObject.iconFile.name,fileId:response.data.fileId};customIcon?$scope.defaultImg=$scope.customStreamData.uploadedIcon:$scope.defaultImg=$scope.selectedIcon.path,$scope.streamObject.icon=fileUploaded,showNotification&&NotificationService.notify(i18n.i18nString("bot_icon_uploaded_successfully"),"success"),getBase64($scope.streamObject.iconFile),$scope.iconUploading=!1,$scope.customStreamData.iconUploading=!1},function(response){showNotification&&NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.iconUploading=!1})},$scope.updateStep=function(stepNo){$scope.$emit("updateStep",stepNo)},$scope.deleteStreamIcon=function(){$scope.streamObject.iconFile=null,$scope.streamObject.icon=null,$("#iconFile").val(""),$scope.streamForm.iconFile.$dirty=!0},$scope.uploadLargeStreamBanner=function(){if($scope.streamObject.bigBannerFile.name){var _ext=$scope.streamObject.bigBannerFile.name.substring($scope.streamObject.bigBannerFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bBfileExtensionError=!0)}$scope.bBfileExtensionError=!1;var data=new FormData;data.append("file",$scope.streamObject.bigBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.bigBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.streamObject.bigBannerFile.name,fileId:response.data.fileId};$scope.streamObject.bBanner=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.bigBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.bigBannerUploading=!1})},$scope.deleteStreamBBanner=function(){$scope.streamObject.bigBannerFile=null,$scope.streamObject.bBanner=null,$("#bigBannerFile").val("")},$scope.uploadSmallStreamBanner=function(){if($scope.streamObject.smBannerFile.name){var _ext=$scope.streamObject.smBannerFile.name.substring($scope.streamObject.smBannerFile.name.lastIndexOf("."));if(".png"!==_ext&&".PNG"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.bSfileExtensionError=!0)}$scope.bSfileExtensionError=!1;var data=new FormData;data.append("file",$scope.streamObject.smBannerFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.smBannerUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.streamObject.smBannerFile.name,fileId:response.data.fileId};$scope.streamObject.sBanner=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.smBannerUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.smBannerUploading=!1})},$scope.deleteStreamSBanner=function(){$scope.streamObject.smBannerFile=null,$scope.streamObject.sBanner=null,$("#smBannerFile").val("")},$scope.onStreamFormCancel=function(){form_util.makeItClean($scope.streamForm),$scope.streamObject={},initializeNewStreamData(),$scope.onCancel()},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.reloadBack=function(){$scope.$parent.setCurrentTab(".tasks-pane")},$scope.clearTenancy=function(){$scope.streamObject.defaultUrl="",$scope.streamObject.helpHint=""},$scope.goBack=function(){$scope.onBack()},$scope.clearTeams=function(){$scope.myTeams.map(function(team){team.selected=!1})};var formsToExcludeValidation=["appCSForm"];$scope.isImportValid=function(){return $scope.userImportCallback&&$scope.userImportCallback.isFormValid&&$scope.userImportCallback.isFormValid();
},$scope.isFormValid=function(){var isFormInvalid=!1;return $scope.streamForm.$error.required&&$scope.streamForm.$error.required.length>0&&$.each($scope.streamForm.$error.required,function(i,requiredForm){-1===$.inArray(requiredForm.$name,formsToExcludeValidation)&&(isFormInvalid=!0)}),$scope.streamForm.name.$error.pattern&&(isFormInvalid=!0),!(isFormInvalid||$scope.streamObject.sharing&&$scope.streamObject.sharing.team&&!$scope.validateTeamShare()||$scope.universalBotPurposeError)},$scope.purposeChanged=function(){"universalbot"===$scope.botType&&("employee"===$scope.streamObject.purpose&&employeeBots&&employeeBots.length<2?($scope.universalBotPurposeError=!0,$scope.universalBotPurposeErrorMessage=i18n.i18nString("universal_employee")):"customer"===$scope.streamObject.purpose&&customerBots&&customerBots.length<2?($scope.universalBotPurposeError=!0,$scope.universalBotPurposeErrorMessage=i18n.i18nString("universal_customer")):$scope.universalBotPurposeError=!1)},$scope.$on("evt:exitAct",function(evt,data){$scope.streamForm.$valid?$scope.createStream(!0):NotificationService.notify(i18n.i18nString("enter_valid_data"),"error")}),$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$scope.showAdvancedOptions=function(){$scope.showadvancedoptions?($scope.showadvancedoptions=!1,$scope.advancedoptiontext=i18n.i18nString("show_advanced_options_label"),$("#advancedoptdivStream .iconArrow").addClass("fa-chevron-right").removeClass("fa-chevron-down")):($scope.showadvancedoptions=!0,$scope.advancedoptiontext="Hide Advanced Options",$("#advancedoptdivStream .iconArrow").removeClass("fa-chevron-right").addClass("fa-chevron-down"))},$scope.takeToStore=function(){mixPanel.postEvent("Launch Botstore"),$scope.onCancel(),$scope.loadBotStore?$scope.loadStore():$scope.$parent.loadStoreNoBotsForm&&$scope.views&&$scope.views.noBotsForm?$scope.$parent.loadStoreNoBotsForm():$scope.$parent.invokeBotsFormForStore()},setTimeout(function(){$scope.loadingStreamForm=!1},200),$scope.redirectToStore=function(){$scope.streamForm&&$scope.streamForm.name.$modelValue&&$scope.streamForm.name.$modelValue.length?$("#botDetailsConfirm").modal("show"):$scope.takeToStore()},$scope.setLanguageCode=function(val){$scope.multiLingualConfigurations.nluLanguage=val,$scope.multiLingualConfigurations.inputTranslation=!1,$scope.multiLingualConfigurations.responseTranslation=!1,$scope.language.value!==$scope.multiLingualConfigurations.nluLanguage&&"ge"!==$scope.multiLingualConfigurations.nluLanguage?$scope.multiLingualConfigurations.inputTranslation=!0:$scope.multiLingualConfigurations.inputTranslation=!1},$scope.getLanguageName=function(val){var index=$scope.nluSupportedLanguages.findIndex(function(lang){return lang.value===val});return index?$scope.nluSupportedLanguages[index].name:$scope.nluSupportedLanguages[0].name},$scope.getSelectedLanguage=function(){var language=$scope.language&&$scope.language.value||"";return language},$scope.updateLanguage=function(lan){if($scope.language=lan,$scope.nluSupportedLanguages.length){var findLang=$scope.nluSupportedLanguages.findIndex(function(lang){return lang.value===$scope.language.value});-1!==findLang?$scope.setLanguageCode($scope.language.value):$scope.setLanguageCode("ge")}},$scope.$on("onLanguageChange",function(evt){$scope.streamForm;$scope.validateBotName.test($scope.streamForm.name.$viewValue)?$scope.streamForm.name.$error.pattern=!1:$scope.streamForm.name.$error.pattern=!0}),$scope.selectConfig={minimumResultsForSearch:-1},$scope.validateBotName=function(){return{test:function(value){var regexpObject=patternFactory.getRegularExpression("stream",$scope.getSelectedLanguage()),regexp=regexpObject.regexp,regexp2=regexpObject.regexp2;return $scope.botType&&"importbot"===$scope.botType?regexp.test(value):value&&1===value.length?regexp2.test(value):regexp.test(value)}}}(),$scope.validateYoutubeURL=function(){return{test:function(uri){var p=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return uri.match(p)?!0:!1}}}(),$scope.hideNote=function(){setTimeout(function(){$scope.showBotNameHint=!1},20)}}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),_module.directive("formatInput",["$filter",function($filter){return{require:"ngModel",restrict:"A",link:function(scope,elem,attrs,ctrl){ctrl&&ctrl.$formatters.push(function(a){return $filter(attrs.formatInput)(ctrl.$modelValue)})}}}]),_module.filter("replaceHtmlString",function(){return function(input){input=input||"";var out="";return out=input.replace(/&lt;/g,"<"),out=out.replace(/&gt;/g,">")}}),_module.directive("streamKnowledgeForm",function(){return{restrict:"EA",scope:{onCancel:"&",onBack:"&",onSave:"&",displayMode:"@",streamId:"@",editMode:"@",taskEditInfo:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/stream-knowledge-form/stream-knowledge-form.html",controller:["$scope","form_util","patternFactory","$routeParams","$rootScope","$filter","$applicationService","$workflowService","BTSeedDataService","BTStreamsService","BTFileUploadService","BTTeamsService","NotificationService","$location","$timeout","env_conf","i18n",function($scope,form_util,patternFactory,$routeParams,$rootScope,$filter,$applicationService,$workflowService,BTSeedDataService,BTStreamsService,BTFileUploadService,BTTeamsService,NotificationService,$location,$timeout,env_conf,i18n){function createKnowledgeTask(ktData){$scope.saveInProgress||($scope.saveInProgress=!0,loader=NotificationService.loader(i18n.i18nString("saving_knowledge_task")),ktData.streamId=$workflowService.selectedStream()._id,BTStreamsService.createKnowledgeTask($applicationService.userInfo().userId,ktData).then(function(response){$scope.knowledgeTaskDetails.ktID=response.data._id,$scope.saveInProgress=!1,loader(),$scope.closeKTMetaModal(!0),NotificationService.notify(i18n.i18nString("kg_saved"),"success"),$scope.isFromModalOpen&&($scope.isFromModalOpen=!1,$(".importkcmodal").modal("show"),$scope.knowledgeData.importchoice="update"),$scope.updateNameAndDescription(response.data),$scope.isFromAddQuestions&&($scope.isFromAddQuestions=!1,$scope.saveQuestionAnswers()),$(".scroll-div").scrollTop($(".knowladgeSubContainer").position().top)},function(res){$scope.saveInProgress=!1,loader(),409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("kg_duplicate")&&($scope.duplicateKTName=!0),NotificationService.notify(res.data.errors[0].msg,"error")}))}function updateKnowledgeTask(ktData){$scope.saveInProgress||($scope.saveInProgress=!0,loader=NotificationService.loader(i18n.i18nString("updating_knowledge_task")),ktData.streamId=$workflowService.selectedStream()._id,BTStreamsService.updateKnowledgeTask($applicationService.userInfo().userId,ktData).then(function(response){NotificationService.notify(i18n.i18nString("knowledge_task_updated"),"success"),$scope.saveInProgress=!1,$scope.isFromModalOpen&&($scope.isFromModalOpen=!1,$(".importkcmodal").modal("show"),$scope.knowledgeData.importchoice="update"),$scope.knowledgeTaskDetails.ktID=response.data._id,$scope.updateNameAndDescription(response.data),$scope.closeKTMetaModal(!0),$(".scroll-div").scrollTop($(".knowladgeSubContainer").position().top),loader()},function(res){$scope.saveInProgress=!1,loader(),409===res.data.errors[0].code&&res.data.errors[0].msg===i18n.i18nString("kg_duplicate")&&($scope.duplicateKTName=!0),NotificationService.notify(res.data.errors[0].msg,"error")}))}var enterpriseLicenseType=$rootScope.licenseType,moreAvailable=!1;$scope.limit=10,$scope.isUploading=!1,$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.errorInsideStream=!0,$scope.isNewKnowledgeTask=!0,$scope.duplicateKTName=!1,$scope.wfType=$scope.taskEditInfo.taskType,$scope.userSaysDescription=$rootScope.getSanitizedText($rootScope.lableData&&$rootScope.lableData.bb528),$scope.char_remaining=i18n.i18nString("char_remaining"),$scope.savingLabel=i18n.i18nString("saving"),$scope.done=i18n.i18nString("done"),$scope._constants_=$rootScope._constants_,$scope.knowledgeData={importchoice:"update",qasearchparam:"",isSearchResultFound:!0,qafound:!0},$scope.assetsBase=env_conf["assets-url"],$scope.trainBot=function(){BTStreamsService.trainFaq($workflowService.selectedStream()._id).then(function(res){$rootScope.$emit("triggerAutoTrainStatusPoll"),NotificationService.notify(i18n.i18nString("knowledge_task_utterance_trained_initiated_noty"),"info")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("problem_in_training_knowledge_task_noty"),"error")})},$scope.knowledgeData.purposeisRequired=enterpriseLicenseType,$scope.showNlpEnable=function(){return $rootScope.wfAdmin},$scope.showqaform=!1,$scope.showQAForm=function(){$scope.showqaform=!0,$scope.selectedDiv=-1,$scope.revokeChangesToQA(),$scope.knowledgeData.qafound=!0,$scope.knowledgeData.isSearchResultFound=!0},$scope.hideQAForm=function(){$scope.showqaform=!1,$scope.isNewKnowledgeTask=!1,$scope.knowledgeData.subQuestions=[],$scope.knowledgeData.subAnswers=[],$scope.resetQAFormData(),$scope.setPristineForAddQAForm(),$scope.knowledgeData.questions.length>0?$scope.knowledgeData.qafound=!0:$scope.knowledgeData.qafound=!1},$scope.setPristineForAddQAForm=function(){$scope.question_answers_form&&$scope.question_answers_form.$setPristine()},$scope.setPristineForAddQAFormEdit=function(){$scope.question_answers_form_edit&&$scope.question_answers_form_edit.$setPristine()},$scope.hideEditQAForm=function(){$scope.selectedDiv=-1,$scope.revokeChangesToQA(),$scope.knowledgeData.questions.length>0?$scope.knowledgeData.qafound=!0:$scope.knowledgeData.qafound=!1},$scope.revokeChangesToQA=function(){angular.copy($scope.knowledgeData.storedQuestions,$scope.knowledgeData.questions)},$scope.updateStoredQA=function(){},$scope.openImportModal=function(){$scope.deleteQAFile(),$(".importkcmodal").modal("show"),$scope.knowledgeData.importchoice="update",$scope.qafileuploading=!1},$scope.openKTMetaModal=function(){$(".ktmetamodal").modal("show")},$scope.closeKTMetaModal=function(isFromSave){$(".ktmetamodal").modal("hide"),isFromSave||$scope.revokeNameAndDescription(),$scope.knowledgeTaskDetails.ktID||$location.path(window.appConfig.CONTEXT_PATH),$scope.duplicateKTName=!1},$workflowService.registerModalHiddenEvent();var loader;$scope.showEditQAForm=function(index){$scope.selectedDiv=index,$scope.hideQAForm()},$scope.saveInProgress=!1,$scope.validateTeamShare=function(){if($scope.myTeams){var selectedTeamCount=0;return $scope.myTeams.forEach(function(team){team.selected&&selectedTeamCount++}),selectedTeamCount>0?!0:!1}return!1},$scope.knowledgeData.subQuestions=[],$scope.addUtteranceFiled=function(){$scope.knowledgeData.subQuestions=$scope.knowledgeData.subQuestions||[],$scope.knowledgeData.subQuestions.push("")},$scope.addUtteranceFiledEdit=function(index){$scope.knowledgeData.questions[index].subQuestions.push("")},$scope.deleterUttranceField=function(fieldIndex){$scope.knowledgeData.subQuestions.splice(fieldIndex,1)},$scope.deleteUttranceFieldEdit=function(parentIndex,fieldIndex){$scope.knowledgeData.questions[parentIndex].subQuestions.splice(fieldIndex,1)},$scope.knowledgeData.subAnswers=[],$scope.addResponseFiled=function(){$scope.knowledgeData.subAnswers=$scope.knowledgeData.subAnswers||[],$scope.knowledgeData.subAnswers.push("")},$scope.addResponseFiledEdit=function(index){$scope.knowledgeData.questions[index].subAnswers.push("")},$scope.deleterResponseField=function(fieldIndex){$scope.knowledgeData.subAnswers.splice(fieldIndex,1)},$scope.deleteResponseFieldEdit=function(parentIndex,fieldIndex){$scope.knowledgeData.questions[parentIndex].subAnswers.splice(fieldIndex,1)},$scope.saveKnowledgeTask=function(isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return form_util.touch(form),void($scope.isFromModalOpen=!1);var btPostData={};btPostData.name=$scope.knowledgeData.name,btPostData.description=$scope.knowledgeData.description,$scope.knowledgeTaskDetails.ktID?(btPostData._id=$scope.knowledgeTaskDetails.ktID,updateKnowledgeTask(btPostData)):createKnowledgeTask(btPostData)},$scope.validateAddQAForm=function(isValid,form,event){return event&&event.preventDefault&&event.preventDefault(),isValid?!0:void form_util.touch(form)},$scope.isEligibleForClear=function(faqFormObject){return faqFormObject.question||faqFormObject.answer||faqFormObject.subQuestions.join().replace(/,/g,"").length>0||faqFormObject.subAnswers.join().replace(/,/g,"").length>0?!0:!1},$scope.selectedQAIndex=-1,$scope.openClearConfirmModal=function(index){index>=0&&$scope.isEligibleForClear($scope.knowledgeData.questions[index])?($scope.selectedQAIndex=index,$(".clearConfirmModal").modal("show")):$scope.isEligibleForClear($scope.knowledgeData)&&($scope.selectedQAIndex=-1,$(".clearConfirmModal").modal("show"))},$scope.resetQuestionAnswersForm=function(){$scope.selectedQAIndex>=0?$scope.resetEditQAFormData($scope.selectedQAIndex):$scope.resetQAFormData(),$(".scroll-div").scrollTop($(".knowladgeSubContainer").position().top),$(".clearConfirmModal").modal("hide")},$scope.resetQAFormData=function(){$scope.knowledgeData.question="",$scope.knowledgeData.answer="",$.each($scope.knowledgeData.subQuestions,function(i,sqData){$scope.knowledgeData.subQuestions[i]=""}),$.each($scope.knowledgeData.subAnswers,function(i,saData){$scope.knowledgeData.subAnswers[i]=""}),$scope.setPristineForAddQAForm()},$scope.resetEditQAFormData=function(index){$scope.knowledgeData.questions[index].question="",$scope.knowledgeData.questions[index].answer="",$.each($scope.knowledgeData.questions[index].subQuestions,function(i,sqData){$scope.knowledgeData.questions[index].subQuestions[i]=""}),$.each($scope.knowledgeData.questions[index].subAnswers,function(i,saData){$scope.knowledgeData.questions[index].subAnswers[i]=""}),$scope.setPristineForAddQAFormEdit()},$scope.searchFaqsBySearchParam=function(){var searchParam=$scope.knowledgeData.qasearchparam;searchParam||$scope.getFaqsByKnowledge()},$scope.knowledgeData.questions=[],$scope.addQuestionAnswers=function(isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return void form_util.touch(form);var questionObject={};questionObject.question=$scope.knowledgeData.question,questionObject.subQuestions=[],questionObject.subQuestions.push(questionObject.question),$scope.knowledgeData.subQuestions=$scope.knowledgeData.subQuestions||[],$.each($scope.knowledgeData.subQuestions,function(i,subquestions){questionObject.subQuestions.push(subquestions)}),questionObject.subAnswers=[],questionObject.subAnswers.push(questionObject.answer),$scope.knowledgeData.subAnswers=$scope.knowledgeData.subAnswers||[],$.each($scope.knowledgeData.subAnswers,function(i,subanswers){questionObject.subAnswers.push(subanswers)}),$scope.knowledgeTaskDetails.ktID?$scope.saveQuestionAnswers():($scope.isFromAddQuestions=!0,$scope.saveKnowledgeTask($scope.isFormValid(),$scope.streamktform,{}))},$scope.removeEmptyStrings=function(inputArray){var arrayWithoutEmptyStrings=[];return arrayWithoutEmptyStrings=_.filter(inputArray,function(value){return""!==value.trim()})},$scope.saveQuestionAnswers=function(){loader=NotificationService.loader(i18n.i18nString("adding_q_a_to_knowledge_task"));var qaObject={question:$scope.knowledgeData.question,answer:$scope.knowledgeData.answer,knowledgeTaskId:$scope.knowledgeTaskDetails.ktID,subQuestions:$scope.removeEmptyStrings($scope.knowledgeData.subQuestions),subAnswers:$scope.removeEmptyStrings($scope.knowledgeData.subAnswers),streamId:$workflowService.selectedStream()._id};BTStreamsService.saveAndUpdateFAQ($applicationService.userInfo().userId,qaObject).then(function(response){response.data.subQuestionsToView=[],response.data.subQuestionsToView.push(response.data.question),$.each(response.data.subQuestions,function(i,subQuestionItem){response.data.subQuestionsToView.push(subQuestionItem)}),response.data.subAnswersToView=[],response.data.subAnswersToView.push(response.data.answer),$.each(response.data.subAnswers,function(i,subAnswerItem){response.data.subAnswersToView.push(subAnswerItem)}),loader(),$scope.setPristineForAddQAForm(),$scope.knowledgeData.questions.push(response.data),$scope.knowledgeData.storedQuestions=$scope.knowledgeData.storedQuestions||[],angular.copy($scope.knowledgeData.questions,$scope.knowledgeData.storedQuestions),$scope.knowledgeData.isSearchResultFound=!0,$scope.knowledgeData.qafound=!0,NotificationService.notify(i18n.i18nString("questions_answers_added_success"),"success"),$scope.showqaform=!1,$scope.isNewKnowledgeTask=!1,$scope.resetQAFormData(),$(".scroll-div").scrollTop($(".knowladgeSubContainer").position().top),$scope.getFaqsByKnowledge()},function(res){loader(),NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.updateQuestionAnswers=function(index,isValid,form,event){if(event&&event.preventDefault&&event.preventDefault(),!isValid)return void form_util.touch(form);console.log($scope.knowledgeData);var qaObject={question:$scope.knowledgeData.questions[index].question,answer:$scope.knowledgeData.questions[index].answer,_id:$scope.knowledgeData.questions[index]._id,knowledgeTaskId:$scope.knowledgeTaskDetails.ktID,subQuestions:$scope.removeEmptyStrings($scope.knowledgeData.questions[index].subQuestions),subAnswers:$scope.removeEmptyStrings($scope.knowledgeData.questions[index].subAnswers),streamId:$workflowService.selectedStream()._id};console.log($scope.knowledgeData);var loader=NotificationService.loader(i18n.i18nString("updating_q_a_to_knowledge_task"));BTStreamsService.updateFAQ($applicationService.userInfo().userId,qaObject,qaObject._id).then(function(response){response.data.subQuestionsToView=response.data.subQuestionsToView||[],angular.copy(response.data.subQuestions,response.data.subQuestionsToView),response.data.subQuestionsToView.unshift(response.data.question),response.data.subAnswersToView=response.data.subAnswersToView||[],angular.copy(response.data.subAnswers,response.data.subAnswersToView),response.data.subAnswersToView.unshift(response.data.answer),loader(),$scope.knowledgeData.questions[index]=response.data,angular.copy($scope.knowledgeData.questions,$scope.knowledgeData.storedQuestions),$scope.showqaform=!1,$scope.isNewKnowledgeTask=!1,$scope.selectedDiv=-1,NotificationService.notify(i18n.i18nString("questions_answers_updated_success"),"success")},function(res){loader(),$scope.isNewKnowledgeTask=!1,NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.closeImportModal=function(){$(".importkcmodal").modal("hide")},$scope.closeImportModalConfirm=function(){$(".importkcmodalconfirm").modal("hide")},$scope.closeclearConfirmModal=function(){$(".clearConfirmModal").modal("hide")},$scope.importFileByFileIDPreprocess=function(){return $scope.knowledgeData.fileId?void("update"===$scope.knowledgeData.importchoice?$scope.importFileByFileID():($scope.closeImportModal(),$(".importkcmodalconfirm").modal("show"))):void NotificationService.notify(i18n.i18nString("upload_file_to_import_q_a"),"error")},$scope.importFileByFileID=function(){var requestData={fileName:$scope.knowledgeData.fileId,fileType:$scope.knowledgeData.qaFile.name.substring($scope.knowledgeData.qaFile.name.lastIndexOf(".")+1),importType:$scope.knowledgeData.importchoice,delimiter:",",streamId:$workflowService.selectedStream()._id,knowledgeTaskId:$scope.knowledgeTaskDetails.ktID},loader=NotificationService.loader(i18n.i18nString("importing_question_answers"));BTStreamsService.importFAQFileBYFileID($applicationService.userInfo.userId,requestData).then(function(response){$(".importkcmodal").modal("hide"),$(".importkcmodalconfirm").modal("hide"),$scope.knowledgeData.fileId="",$scope.getFaqsByKnowledge(),loader()},function(response){$(".importkcmodal").modal("hide"),$(".importkcmodalconfirm").modal("hide"),$scope.knowledgeData.fileId="",$scope.getFaqsByKnowledge(),response.data.errors&&response.data.errors.length?NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("importing_question_answers_err"),"error"),$scope.bigBannerUploading=!1,loader()})};var count=0;$scope.removeFAQByID=function(index,faqID){function failCb(){console.log("on cancel callback")}function removeFAQ(){var loader="";0===count&&(loader=NotificationService.loader(i18n.i18nString("please_wait_noty")),count+=1),$scope.removeQaIndex=index,BTStreamsService.removeFAQ($applicationService.userInfo.userId,faqID).then(function(response){$scope.knowledgeData.questions.splice(index,1),$scope.knowledgeData.storedQuestions=$scope.knowledgeData.storedQuestions||[],$scope.knowledgeData.storedQuestions.splice(index,1),$scope.knowledgeData.questions.length?($scope.knowledgeData.qafound=!0,$scope.knowledgeData.isSearchResultFound=!0):$scope.knowledgeData.qafound=!1,loader(),$("#noty_center_layout_container").empty(),console.log(count),count-=1,$scope.removeQaIndex=-1,NotificationService.notify(i18n.i18nString("questions_answers_deleted_success"),"success"),0===$scope.knowledgeData.questions.length&&$scope.trainBot(),$scope.getFaqsByKnowledge()},function(error){loader(),$("#noty_center_layout_container").empty(),$scope.removeQaIndex=-1,NotificationService.notify(i18n.i18nString("questions_answers_deleted_failed"),"error")})}1===$scope.knowledgeData.questions.length?(event.preventDefault(),NotificationService.confirm({msg:i18n.i18nString("delete_last_faq"),successCb:removeFAQ,failCb:failCb,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("delete"),fail:i18n.i18nString("cancel")}})):removeFAQ()},$scope.knowledgeObjectRes={},$scope.updateNameAndDescription=function(ktObject){$scope.knowledgeObjectRes.name=ktObject.name,$scope.knowledgeObjectRes.description=ktObject.description},$scope.revokeNameAndDescription=function(){$scope.knowledgeData.name=$scope.knowledgeObjectRes.name,$scope.knowledgeData.description=$scope.knowledgeObjectRes.description},$scope.$watch("limit",function(newVal,oldVal){$scope.limit=newVal}),$scope.getFaqsByKnowledge=function(offset){var searchParam=$scope.knowledgeData.qasearchparam||"";$scope.hideEditQAForm(),$scope.hideQAForm(),offset=offset||0;var loader=NotificationService.loader(i18n.i18nString("please_wait_noty"));BTStreamsService.getOrSearchFAQS($applicationService.userInfo.userId,$scope.knowledgeTaskDetails.ktID,searchParam,offset,$scope.limit).then(function(response){0===offset&&$scope.$broadcast("changeCurrentPage",1),$timeout(function(){loader(),$scope.hideQAForm(),$scope.knowledgeData=$scope.knowledgeData||{},$scope.knowledgeData.name=$scope.taskEditInfo.name,$scope.knowledgeData.description=$scope.taskEditInfo.description,$scope.updateNameAndDescription($scope.knowledgeData),$scope.knowledgeData.storedQuestions=[],$.each(response.data.faqs,function(i,questionsObject){response.data.faqs[i].subQuestionsToView=[],response.data.faqs[i].subQuestionsToView.push(response.data.faqs[i].question),questionsObject.subQuestions=questionsObject.subQuestions||[],$.each(questionsObject.subQuestions,function(j,subQuestionItem){response.data.faqs[i].subQuestionsToView.push(subQuestionItem)}),response.data.faqs[i].subAnswersToView=[],response.data.faqs[i].subAnswersToView.push(response.data.faqs[i].answer),questionsObject.subAnswers=questionsObject.subAnswers||[],$.each(questionsObject.subAnswers,function(j,subAnswerItem){response.data.faqs[i].subAnswersToView.push(subAnswerItem)})}),angular.copy(response.data.faqs,$scope.knowledgeData.storedQuestions),!response.data.faqs.length&&$scope.knowledgeData.qasearchparam?($scope.knowledgeData.isSearchResultFound=!1,$scope.knowledgeData.qafound=!0):response.data.faqs.length?($scope.knowledgeData.qafound=!0,$scope.knowledgeData.isSearchResultFound=!0):($scope.knowledgeData.qafound=!1,$scope.knowledgeData.isSearchResultFound=!0),$scope.displayMode=$workflowService.taskMode(),moreAvailable=response.data.moreAvailable,$scope.knowledgeData.questions=response.data.faqs,$scope.totalItems=response.data.count},1e3)})},$scope.uploadCSVorJSONFile=function(){var _ext="";if($scope.knowledgeData.qaFile.name){_ext=$scope.knowledgeData.qaFile.name.substring($scope.knowledgeData.qaFile.name.lastIndexOf("."));var supportingFileFormats=[".csv"];if(-1===$.inArray(_ext,supportingFileFormats))return NotificationService.notify(i18n.i18nString("upload_csv_files"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.knowledgeData.qaFile),data.append("fileContext","bulkImport"),data.append("fileExtension",_ext.substring(_ext.lastIndexOf(".")+1)),data.append("Content-Type","txt/csv"),$scope.qafileuploading=!0,BTStreamsService.uploadFAQFile($applicationService.userInfo().userId,data).then(function(response){var fileUploaded={fileName:$scope.knowledgeData.qaFile.name,fileId:response.data.fileId};$scope.knowledgeData.fileId=response.data.fileId,$scope.knowledgeData.qafile=fileUploaded,NotificationService.notify(fileUploaded.fileName+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.qafileuploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.qafileuploading=!1})},$scope.loadMoreFAQS=function(offset){if(moreAvailable&&!$scope.loadingMore){$scope.loadingMore=!0;var searchParam=$scope.knowledgeData.qasearchparam||"";offset=offset||0;var loader=NotificationService.loader(i18n.i18nString("please_wait_noty"));BTStreamsService.getOrSearchFAQS($applicationService.userInfo.userId,$scope.knowledgeTaskDetails.ktID,searchParam,offset,limit).then(function(response){loader(),$scope.totalItems=response.data.count,$scope.knowledgeData.storedQuestions=$scope.knowledgeData.storedQuestions||[],$.each(response.data.faqs,function(i,questionsObject){response.data.faqs[i].subQuestionsToView=[],response.data.faqs[i].subQuestionsToView.push(response.data.faqs[i].question),questionsObject.subQuestions=questionsObject.subQuestions||[],$.each(questionsObject.subQuestions,function(j,subQuestionItem){response.data.faqs[i].subQuestionsToView.push(subQuestionItem)}),response.data.faqs[i].subAnswersToView=[],response.data.faqs[i].subAnswersToView.push(response.data.faqs[i].answer),questionsObject.subAnswers=questionsObject.subAnswers||[],$.each(questionsObject.subAnswers,function(j,subAnswerItem){response.data.faqs[i].subAnswersToView.push(subAnswerItem)})}),response.data.faqs.length&&($scope.knowledgeData.storedQuestions=$scope.knowledgeData.storedQuestions.concat(response.data.faqs),$scope.knowledgeData.questions=$scope.knowledgeData.questions.concat(response.data.faqs)),moreAvailable=response.data?response.data.moreAvailable:!1,$scope.loadingMore=!1},function(errRes){$scope.knowledgeData.questions="error",$scope.loadingMore=!1})}};var formContainerEle=$("#formContainer ");formContainerEle.on("scroll",function(event){console.log(event),$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&console.log(event)}),$scope.deleteQAFile=function(){$scope.knowledgeData.qafile=null,$("#qaFile").val(""),$("#qafileimport").val(""),$scope.knowledgeData.fileId=""},$scope.onKnowledgeFormCancel=function(){"edit"===$scope.displayMode?$location.path(window.appConfig.CONTEXT_PATH):($scope.knowledgeData={},$scope.onCancel())},$scope.exit=function(){$scope.removeModalOpen(),$location.path(window.appConfig.CONTEXT_PATH)},$scope.removeModalOpen=function(){$("body").removeClass("modal-open"),$("body").removeClass("bt-modal-open")},$scope.clearTenancy=function(){$scope.knowledgeData.defaultUrl="",$scope.knowledgeData.helpHint=""},$scope.goBack=function(){$scope.onBack()},$scope.clearTeams=function(){$scope.myTeams.map(function(team){team.selected=!1})},$scope.isFormValid=function(isSaveKnoledgeTask){return isSaveKnoledgeTask?$scope.streamktform&&$scope.streamktform.name.$valid&&$scope.streamktform.description.$valid:!($scope.streamktform.name.$error.required||$scope.question_answers_form.$invalid)},$scope.$on("evt:exitAct",function(evt,data){$scope.streamktform.$valid?$scope.createStream(!0):NotificationService.notify(i18n.i18nString("enter_valid_data"),"error")}),$scope.getSentenceCase=function(value){var _selectedStream=$workflowService.selectedStream();return _selectedStream.defaultLanguage&&"en"!==_selectedStream.defaultLanguage?value:$filter("sentence_case")(value)},$scope.validatePattern=function(){var regexp="",regexp2="",regexpObject=patternFactory.getRegularExpression();return regexp=regexpObject.regexp,regexp2=regexpObject.regexp2,{test:function(value){return value&&1===value.length?regexp2.test(value):regexp.test(value)}}}(),$scope.validatePatternQA=function(){return{test:function(value){return value.indexOf("</script")>=0||value.indexOf("<script")>=0||value.indexOf("</img")>=0||value.indexOf("<img")>=0||value.indexOf("<iframe")>=0||value.indexOf("</iframe")>=0?!1:!0}}}(),$scope.validatePatternAnswers=function(){return{test:function(value){return value.indexOf("</script")>=0||value.indexOf("<script")>=0||value.indexOf("</img")>=0||value.indexOf("<img")>=0||value.indexOf("<iframe")>=0||value.indexOf("</iframe")>=0?!1:!0}}}(),$scope.knowledgeTaskDetails={ktID:$scope.taskEditInfo._id},$scope.knowledgeTaskDetails.ktID?$scope.isNewKnowledgeTask=!1:$scope.openKTMetaModal(),$workflowService.reigisterModalShownEvent()}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("synonymsForm",function(){return{restrict:"EA",scope:{taskName:"=",values:"=",streamId:"=",callbacks:"=",synonymFor:"@",hideHeading:"@"},controller:["$scope","BTStreamsService","NotificationService","$workflowService","$timeout","i18n",function($scope,BTStreamsService,NotificationService,$workflowService,$timeout,i18n){function getSynonyms(closeit){$scope.taskName&&$scope.streamId&&BTStreamsService.getSynonyms($scope.streamId,$scope.taskName).then(function(res){$scope.synonyms=transformSynonymsToArray(res.data)},function(err){$scope.synonyms=[]}).then(function(){closeit||$(".synonyms_manage").modal({backdrop:"static",show:!0})})}function saveSynonyms(){if($scope.streamId){var synonyms=transformSynonymsToObject($scope.synonyms);"stream"==$scope.synonymFor?$scope.values=synonyms:BTStreamsService.postSynonyms($scope.streamId,{synonyms:synonyms}).then(function(res){closeModal(),$workflowService.selectedStream(res.data),$timeout(function(){$scope.callbacks.onSave()})},function(err){var errMsg=err.data.errors&&err.data.errors[0]&&err.data.errors[0]&&err.data.errors[0].msg||"Failed to save synonyms";NotificationService.notify(errMsg,"error")})}}function transformSynonymsToArray(synonyms){var result=[];return Object.keys(synonyms).map(function(key){result.push({key:key,value:synonyms[key]})}),result}function transformSynonymsToObject(synonyms){var result={};return synonyms.map(function(synonym){result[synonym.key]=synonym.value}),result}function openModal(){getSynonyms(),$scope.callbacks.onOpenModal()}function closeModal(){$(".synonyms_manage").modal("hide"),$scope.saveInProgress=!1,$scope.callbacks.onCloseModal()}$scope.synonyms=[];var count=0;$scope.synonymsCurrentPage=1,$scope.callbacks=_.isObject($scope.callbacks)?$scope.callbacks:{},["onSave","onCancel","onOpenModal","onCloseModal"].map(function(key){$scope.callbacks[key]=_.isFunction($scope.callbacks[key])?$scope.callbacks[key]:angular.noop}),$scope.$watch("values",function(newVal,oldVal){_.isObject(newVal)&&0===$scope.synonyms.length&&($scope.synonyms=_.isObject($scope.values)?transformSynonymsToArray($scope.values):[])},!0),$scope.saveInProgress=!1,$scope.savingLabel=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.save=function(){$scope.saveInProgress=!0,saveSynonyms()},$scope.cancel=function(){
closeModal(),$scope.callbacks.onCancel()},$scope.$watch("synonyms",function(newVal,oldVal){_.isArray(newVal)&&newVal.map(function(synonym,i){_.isArray(synonym.value)?synonym.value.map(function(value,i){synonym.value[i]=synonym.value[i].toLowerCase()}):$scope.synonyms.splice(i,1)}),_.isArray(newVal)&&newVal.length>0&&"stream"===$scope.synonymFor&&(count>0&&saveSynonyms(),++count)},!0),$scope.synonymsAreThere=function(){return _.isArray($scope.synonyms)&&$scope.synonyms.length>0},$scope.deleteSynonym=function(index){$scope.synonyms.splice(index,1)},$scope.openModal=openModal,getSynonyms(!0)}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/synonyms-form/synonyms-form.html",link:function($scope,$ele,$attrs){}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("synonymsManage",[function(){return{restrict:"EA",scope:{hideUi:"@?",context:"=?",gSearchCb:"=",templateUrl:"=?",cb:"=?",currentEditTask:"=?",saveStatusSynonym:"=?",viewMode:"=?",upgradeViewMode:"=?"},template:'<ng-include src="getTemplateUrl()"/>',controller:"SynonymsModuleCtrl"}}])}(angular),function(ng){var _module=ng.module("bt-forms");_module.directive("tryModeForm",function(){return{restrict:"EA",scope:{trymodeid:"@",callback:"=",account:"=",enableTryMode:"=",tryUpdateInProgress:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/try-mode-form/try-mode-form.html",controller:["$scope","$rootScope","$q","$routeParams","$location","$applicationService","$translator","BTAlertsService","BTActionsService","BTFlowtaskService","BTStreamsService","BTTeamsService","NotificationService","BTParamMapService","form_util","$workflowService","flowsUtil","$timeout","BTIdpService","i18n",function($scope,$rootScope,$q,$routeParams,$location,$applicationService,$translator,BTAlertsService,BTActionsService,BTFlowtaskService,BTStreamsService,BTTeamsService,NotificationService,BTParamMapService,form_util,$workflowService,flowsUtil,$timeout,BTIdpService,i18n){$scope.stream=$workflowService.selectedStream(),$scope.needAuth=!1,$scope.isTryModeUpdated=!1,$scope.account=[],$scope.btTestFormApi={},$scope.btTestStatus={},$scope.idpConfigs=[],$scope.tryUpdateInProgress=!1,$scope.rightClass="right500",$scope.loadAuthInfo=function(){$scope.stream=$workflowService.selectedStream(),$scope.enableTryMode=_.isUndefined($scope.stream.canTryOut)?!1:$scope.stream.canTryOut,BTStreamsService.getAuthinfo($workflowService.selectedStream()._id).then(function(res){if($scope.authLists=res.data,$scope.idpConfigs=$scope.idpConfigs||[],$scope.authLists){var idpCallStack=[];$.each($scope.authLists,function(i,authData){idpCallStack.push(BTIdpService.getIdpByName(authData.idpName,$workflowService.selectedStream()._id))}),$q.all(idpCallStack).then(function(res){$scope.idpConfigs=_.pluck(res,"data"),$scope.callback.idpConfigs=$scope.idpConfigs,$scope.getAccountForStream()},function(err){$scope.idpConfigs=$scope.idpConfigs||[],$scope.callback.idpConfigs=$scope.idpConfigs})}$scope.dataloaded=!0,$scope.needAuth=!0},function(res){$scope.authLists=null,$scope.dataloaded=!0,$scope.needAuth=!1})},$scope.loadAuthInfo(),$scope.testIdp=function(index){$scope.btTestFormApi.afterInit=function(){$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success){success?NotificationService.notify(i18n.i18nString("try_mode_authorization_success"),"success"):NotificationService.notify(i18n.i18nString("auth_test_failed"),"error"),$scope.btTestFormApi.close()},$scope.btTestFormApi.onNewAccounts=function(accounts){$scope.getAccountForStream()},$scope.btTestFormApi.init({_id:$scope.idpConfigs[index]._id,type:"idp",testFor:"idp",isTryOutUserConnection:"true"})},$scope.getAccountForStream=function(accountDetails){BTStreamsService.getAccounts($workflowService.selectedStream()._id,"true","true").then(function(res){$scope.account=res.data,$scope.updateIDPData(accountDetails)})},$scope.updateIDPData=function(accountDetails){var idpDetails=angular.copy($scope.idpConfigs);accountDetails?$.each(idpDetails,function(j,idpData){idpData.name===accountDetails.idp&&(idpDetails[j].account=[])}):$.each($scope.account,function(i,accountData){$.each(idpDetails,function(j,idpData){idpData.name===accountData.idp&&(idpDetails[j].account=[accountData])})}),$scope.idpConfigs=angular.copy(idpDetails),$scope.callback.idpConfigs=$scope.idpConfigs},$scope.deleteAccount=function(account){function proccedToDelete(){BTIdpService.deleteStreamUserAccount(account.streamAccountId).then(function(res){$scope.getAccountForStream(account),$scope.isTryModeUpdated=!1,res.data&&"deleted"===res.data.status&&($scope.enableTryMode=!1,$scope.updateTryMode()),NotificationService.notify(i18n.i18nString("account_deleted_success"),"success")})}var confirmationMessage=i18n.i18nString("try_mode_account_delete_notify");window.bootbox.dialog({message:confirmationMessage,title:i18n.i18nString("deleteAccount"),className:"alert-modal",buttons:{success:{label:i18n.i18nString("no"),className:"btn-primary",callback:function(){}},main:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){proccedToDelete()}}},onEscape:function(){}})},$scope.updateTryMode=function(step,callbackMethod){if($scope.authLists&&$scope.account.length!==$scope.idpConfigs.length&&$scope.enableTryMode)NotificationService.notify(i18n.i18nString("try_mode_form_pls_provide_idp_Auth"),"warning");else{var payLoad={canTryOut:$scope.enableTryMode};$scope.tryUpdateInProgress=!0,BTStreamsService.updateTryMode($scope.stream._id,payLoad).then(function(res){$scope.isTryModeUpdated=!0,step?$scope.callback.showStep(step):callbackMethod&&callbackMethod(),$scope.tryUpdateInProgress=!1,$scope.stream.canTryOut=res.data.canTryOut,$workflowService.selectedStream($scope.stream),$scope.$emit("streamUpdate")},function(err){console.log(err),NotificationService.notify(i18n.i18nString("try_mode_err_in_updating_trymode"),"error"),$scope.tryUpdateInProgress=!1})}},$scope.callback=$scope.callback||{},$scope.callback.updateTryMode=$scope.updateTryMode,$scope.callback.loadAuthInfo=$scope.loadAuthInfo,$scope.callback.idpConfigs=$scope.idpConfigs,$scope.$emit("nestedComponentLoaded",{id:"tryMode",flag:!1})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btUiForms",[function(){return{restrict:"EA",scope:{formMode:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/ui-forms/bt-ui-forms.html",controller:["$scope","cron","$timeout","$rootScope","$location","BTIdpService","NotificationService","$workflowService","BTAlertsService","$translator","form_util","$routeParams","BTFiltersService","$filter","$util","env_conf","$sce",function($scope,cron,$timeout,$rootScope,$location,BTIdpService,NotificationService,$workflowService,BTAlertsService,$translator,form_util,$routeParams,BTFiltersService,$filter,$util,env_conf,$sce){$scope.lodingForm=!0,$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png","uiFormsTest"===$scope.formMode?$scope.uiformloadType="/preview":"uiFormsBranding"===$scope.formMode?$scope.uiformloadType="/branding":$scope.uiformloadType="",window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.uiFormsUrl=$sce.trustAsResourceUrl("http://localhost:4200/forms/formBuilder/"+$workflowService.selectedStream()._id+"/"+$workflowService.taskEditInfo()._id+"/builder"+$scope.uiformloadType):$scope.uiFormsUrl=window.appConfig.API_SERVER_URL+"/forms/formBuilder/"+$workflowService.selectedStream()._id+"/"+$workflowService.taskEditInfo()._id+"/builder"+$scope.uiformloadType;var iframe=$("#uiFormsFrame");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")})}),$rootScope.$on("uiformIframeEvent",function(e,formEvent){setTimeout(function(){$scope.lodingForm=!1},500)});var closeFullPageModal=function(){$("body").hasClass("bt-modal-open")&&($("body").removeClass("bt-modal-open"),$(".modal-backdrop").remove()),$scope.$emit("updateStep",-1),$("#btFullpageModal").modal("hide")};$scope.arrowAngle=env_conf["context-url"]+"/assets/icons/arrowAngle.svg",$scope.botIcon=env_conf["context-url"]+"/assets/botIcons/1.svg",$scope.ellipsisDark=env_conf["context-url"]+"/assets/icons/ellipsisDark.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.goBack=function(){closeFullPageModal()}}]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("userPromptForm",[function(){return{restrict:"EA",scope:{onDone:"=",mode:"=",onCancelPrompt:"=",messagesObject:"=",isPrompt:"=",displayMode:"=?",promptType:"=",selectedNode:"=",dialogData:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/user-prompt-form/user-prompt-form.html",controller:["$scope","$element","channelsConfig","$workflowService","BTStreamsService","NotificationService","BTFlowtaskService","$timeout","env_conf","$rootScope","i18n","mixPanel",function($scope,$element,channelsConfig,$workflowService,BTStreamsService,NotificationService,BTFlowtaskService,$timeout,env_conf,$rootScope,i18n,mixPanel){function isStandardPromptExist(index){var _standardPromptMessageCount=$scope._allPrompts.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);return _standardPromptMessageCount>1?!0:(1!==_standardPromptMessageCount||$scope._allPrompts[index]._id)&&"default"===$scope._allPrompts[index].channel&&"default"!==$scope.selectedChannel.channel?(NotificationService.notify("message"===$scope.type?i18n.i18nString("allchannel_res"):i18n.i18nString("atleast_one_prompt"),"error"),!1):!0}function scrollInitiate(){$timeout(function(){$(".scrollDiv").scrollTop(2)},750)}function isMarkUp(markup){return markup.jsCode&&""!==markup.jsCode.trim()?!1:!0}function startSaving(className){$element.find(className).addClass("fa fa-refresh fa-spin")}function finishSaving(className,isError){$element.find(className).removeClass("fa fa-refresh fa-spin"),"error"===isError?$element.find(className).addClass("fa fa-times"):$element.find(className).addClass("fa fa-check"),setTimeout(function(){$element.find(className).removeClass("fa fa-check fa-times")},3e3)}function encodeJS(_obj){return encodeURIComponent(_obj)}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}$scope.dialogTask=$workflowService.taskEditInfo(),$scope.standardPrompts=[],$scope.channelPrompts=[],$scope.CurrentTabIndex=-1,$scope.loadEditor=!1,$scope.currEditPromptIndex=-1,$scope.assetsBase=env_conf["assets-url"];var isWFacebook=!1,isPromptOpened=!1;$scope.displayMode=$scope.displayMode||"edit","edit"===$scope.displayMode&&$scope.messagesObject&&$scope.messagesObject.nodeInfo&&($scope.messagesObject.nodeInfo.nodeInfo&&$scope.messagesObject.nodeInfo.nodeInfo.editLocked||$scope.messagesObject.nodeInfo.editLocked)&&($scope.displayMode="view"),channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channels=Object.values(channelsConfig.channelsObject),$scope._channelConfig=channelsConfig,$scope.stream=$workflowService.selectedStream(),$scope.channels=$scope.channels.map(function(channel,i){return channel.used=!1,"wfacebook"===channel.id&&(isWFacebook=!0),channel}),$scope.channels=_.filter($scope.channels,{enable:!0}),isWFacebook&&($scope.channels=_.without($scope.channels,_.findWhere($scope.channels,{id:"wfacebook"}))),$scope.selectedChannel={},$scope.selectedChannel.channel="default",$scope.$watch("messagesObject",function(newVal,oldVal){newVal&&($scope.standardPrompts=[],$scope.channelPrompts=[],$scope._allPrompts=[],$scope.currentScreen=0,newVal.messages&&newVal.messages.length>0&&newVal.messages.map(function(message){message.text=message.text,"default"===message.channel?$scope.standardPrompts.push(message):("wfacebook"===message.channel&&(message.channel=message.isMention?"wfacebookG":"wfacebookC"),$scope.channelPrompts.push(message))}),$scope.type=$scope.isPrompt?"Prompt":"message",$scope._allPrompts=$scope._allPrompts.concat($scope.standardPrompts),$scope._allPrompts=$scope._allPrompts.concat($scope.channelPrompts),$scope._allPrompts.forEach(function(obj){obj.isOpen="false"}),$scope.messagesObject.openIndex&&!isPromptOpened&&setTimeout(function(){isPromptOpened||($("#promptHeader-"+$scope.messagesObject.openIndex).trigger("click"),isPromptOpened=!0)},1e3))}),$scope.currentTabIndexOfPage1=0,$scope.currentTabIndexOfPage2=0,$scope.currentScreen=0,$scope.editPromptMode=!0,$scope.isUser=!0,$scope.editMessageIndex=0,$scope.editingMessage={},$scope.type=$scope.isPrompt?"Prompt":"message",$scope._constants_=$rootScope._constants_,$scope.contextCondition=[{key:"",value:""}],$scope.editors={},$scope.jsEditorCbs={},$scope.markdownCbs={},$scope.jsEditorCbs.displayMode=$scope.displayMode,$scope.markdownCbs.displayMode=$scope.displayMode,$scope.contexts=[],$scope.contextsData=[],$scope.markdownCbs.switchEditor=function(type){"javaScriptEditor"===type?$scope.alterTabsOfPage2(1):"promptsPreview"===type&&$scope.alterTabsOfPage2(2)},$scope.markdownCbs.onFocus=function(){$scope.showProtip=!0},$scope.markdownCbs.onBlur=function(){$scope.showProtip=!1},$scope.markdownCbs.isFromUserPrompt=!0,$scope.jsEditorCbs.onFocus=function(){$scope.showProtip=!0},$scope.jsEditorCbs.onBlur=function(){$scope.showProtip=!1},$scope.icons={spark:env_conf["context-url"]+"/img/spark.svg",msteams:env_conf["context-url"]+"/img/microsoft-teams-icon.png",syniverse:env_conf["context-url"]+"/img/syniverse.png",rcengage:env_conf["context-url"]+"/img/ringCentralEngage.png",slack:env_conf["context-url"]+"/img/slack.svg",sms:env_conf["context-url"]+"/img/sms.svg",twilio:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",email:env_conf["context-url"]+"/img/email.svg",skype:"",facebook:env_conf["context-url"]+"/img/facebook.svg",websdk:env_conf["context-url"]+"/img/slack.svg",kore:env_conf["context-url"]+"/img/kore.svg",rtm:env_conf["context-url"]+"/img/web-mobile.svg",widgetsdk:env_conf["context-url"]+"/img/widgetsdk.svg",skypeOnPrem:env_conf["context-url"]+"/img/skypebusiness.svg",twitter:env_conf["context-url"]+"/img/twitter.svg",cisco:env_conf["context-url"]+"/img/cisco-tropo-icon.png",wfacebook:env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Groups":env_conf["context-url"]+"/img/fb-workplace-icon.png","Workplace For Chat":env_conf["context-url"]+"/img/fb-workplace-icon.png",ringcentral:env_conf["context-url"]+"/img/ringCentralIcon.png",skypeforbusiness:env_conf["context-url"]+"/img/skypebusiness.svg",jabber:env_conf["context-url"]+"/img/jabbericon.jpg",yammer:env_conf["context-url"]+"/img/yammericon.png",telegram:env_conf["context-url"]+"/img/telegram-logo.png",alexa:env_conf["context-url"]+"/img/amazonalexa.png",twiliovoice:env_conf["context-url"]+"/img/twillio-red-logo.svg?v=1.1",line:env_conf["context-url"]+"/img/line-logo.png",ivr:env_conf["context-url"]+"/img/webhook.png",liveperson:env_conf["context-url"]+"/img/live-person.png",ivrVoice:env_conf["context-url"]+"/assets/ivrIcons/ivrIcon.svg",googleactions:env_conf["context-url"]+"/img/google-home.svg",wechat:env_conf["context-url"]+"/img/weChat.svg",hangoutchat:env_conf["context-url"]+"/img/hangoutchat.png",livebank:env_conf["context-url"]+"/img/livebank.png"},$scope.showProtip=!0,$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.quotsIcon=window.appConfig.CONTEXT_PATH+"/assets/images/quotsIcon.svg",$scope.alterTabsOfPage1=function(tabIndex){$scope.currentTabIndexOfPage1=tabIndex},$scope.addContextCond=function(index){$scope.contextCondition.length>0&&index===$scope.contextCondition.length-1&&$scope.contextCondition.push({key:"",value:""})},$scope.onRemoveCond=function(index){$scope.contextCondition.length>1&&$scope.contextCondition[index]&&$scope.contextCondition.splice(index,1)},$scope.selected=void 0,$scope.states=["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Dakota","North Carolina","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming"],$scope.$watch("selectedChannel.channel",function(){$scope.selectedChannelType=$scope.selectedChannel.channel}),$scope.alterTabsOfPage2=function(tabIndex){$scope.CurrentTabIndex=tabIndex,$scope.loadEditor=!0,$scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim()&&0===tabIndex?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_js_notify")):$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()&&1===tabIndex?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_markup_notify")):$scope.currentTabIndexOfPage2=tabIndex,2===tabIndex&&($scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim().length>0||$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim().length>0?$scope.disablePreviewBtn=!1:$scope.disablePreviewBtn=!0,$scope.preview="")},$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.getJsSamples(),$scope.closePromptDialog=function(){$scope.savePromptsInfo()},$scope.savePromptsInfo=function(){var promptsArray=[];promptsArray=$scope._allPrompts.filter(function(i){return""!==i.text}),promptsArray.forEach(function(v){delete v.isOpen}),$scope.promptType&&"submit"===$scope.promptType?$scope.onDone(promptsArray,!1,!1,"submit"):$scope.messagesObject.category&&""!==$scope.messagesObject.category?$scope.messagesObject.isInstancePrompts?$scope.onDone(promptsArray,$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts,!0):$scope.onDone(promptsArray,$scope.messagesObject.nodeInfo.nodeInfo.multiCategoryPrompts):$scope.messagesObject.isInstancePrompts?$scope.onDone(promptsArray,!1,!0):$scope.onDone(promptsArray)},$scope.editPrompt=function(index,isOpen){$scope.loadEditor=!1,isOpen||($scope.currEditPromptIndex=index,-1===index&&($scope.editPromptMode=!1,$scope.isUser=!1),$scope.editMessageIndex=index,$scope.editingMessage={},$scope.selectedChannel.channel=index>=0?$scope._allPrompts[index].channel:"",0>index||index>=0&&"basic"===$scope._allPrompts[index].type?($scope.editingMessage.markUp=index>=0?$scope._allPrompts[index].text:"",$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0):($scope.editingMessage.jsCode=$scope._allPrompts[index].text,$scope.currentTabIndexOfPage2=1,$scope.CurrentTabIndex=1),"wfacebook"===$scope.selectedChannel.channel&&($scope.selectedChannel.channel=$scope._allPrompts[index].isMention?"wfacebookG":"wfacebookC")),$timeout(function(){"basic"!==$scope._allPrompts[index].type&&($scope.editingMessage.jsCode=$scope._allPrompts[index].text),isOpen||($scope.loadEditor=!0)},150),$timeout(function(){isOpen?$(".scrollDiv").animate({scrollTop:$("#prompt-0").offset().top},1e3):$(".scrollDiv").animate({scrollTop:$("#prompt-"+index).offset().top},750)},350)},$scope.deletePromptMessage=function($event,index){$event.preventDefault(),$event.stopPropagation();var _msgTxt="message"===$scope.type?"bot response":"prompt message";$scope.promptType&&"submit"===$scope.promptType&&(_msgTxt="submit message"),NotificationService.alert("Do you want to delete this "+_msgTxt,function(){if(""===$scope._allPrompts[index].text)return $scope._allPrompts.splice(index,1),"message"===$scope.type?NotificationService.notify(i18n.i18nString("user_prompt_bot_response_deleted"),"success"):NotificationService.notify(i18n.i18nString("user_prompt_prompt_message_deletd_success"),"success"),void $timeout(function(){$(".scrollDiv").scrollTop(2)},1e3);var _standardPromptMessageCount=$scope._allPrompts.reduce(function(n,prompt){return n+(""!==prompt.text&&"default"===prompt.channel)},0);if(_standardPromptMessageCount>1)$scope.saveUserPromptMessages(index,!0,!1);else{if("default"===$scope._allPrompts[index].channel)return NotificationService.notify("message"===$scope.type?i18n.i18nString("allchannel_res"):i18n.i18nString("atleast_one_prompt"),"error"),!1;$scope.saveUserPromptMessages(index,!0,!1)}},{okText:i18n.i18nString("ok_uppercase")})};var _editingMessage="";$scope.channelSelected=function(selectedChannel){_editingMessage=angular.copy($scope.editingMessage),$timeout(function(){$scope.editingMessage=_editingMessage},200),$scope.selectedChannel.channel=selectedChannel},$scope.savePromptMessage=function(index){if(isStandardPromptExist(index)){var _isFrmCreate=!1;$scope._allPrompts=$scope._allPrompts||[];var messageObject={};messageObject.channel=$scope.selectedChannel.channel,"wfacebookG"===messageObject.channel?(messageObject.channel="wfacebook",messageObject.isMention=!0):"wfacebookC"===messageObject.channel&&(messageObject.channel="wfacebook",messageObject.isMention=!1),0===$scope.CurrentTabIndex?(messageObject.text=$scope.editingMessage.markUp?$scope.editingMessage.markUp:$scope.editingMessage.jsCode,messageObject.type="basic"):1===$scope.CurrentTabIndex&&(messageObject.text=angular.copy($scope.editingMessage.jsCode?$scope.editingMessage.jsCode:$scope.editingMessage.markUp),messageObject.type="uxmap"),-1===$scope.editMessageIndex&&($scope.editingMessage.jsCode||$scope.editingMessage.markUp)?$scope._allPrompts.push(messageObject):(messageObject._id=$scope._allPrompts[$scope.editMessageIndex]._id,$scope._allPrompts[$scope.editMessageIndex]=messageObject),$scope._allPrompts[$scope.editMessageIndex]._id||(_isFrmCreate=!0),$scope.saveUserPromptMessages(index,!1,_isFrmCreate),$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0,$scope.navigateBack($scope.currEditPromptIndex)}},$scope.addNewPromptMessage=function(){if("edit"===$scope.displayMode){$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0,$scope.selectedChannel.channel="default";var messageObject={};messageObject.channel=$scope.selectedChannel.channel,messageObject.text="",messageObject.type="basic",$scope._allPrompts.push(messageObject),$scope.currEditPromptIndex>=0&&($scope._allPrompts[$scope.currEditPromptIndex].isOpen=!1,$scope.loadEditor=!1),$timeout(function(){$scope._allPrompts[$scope._allPrompts.length-1].isOpen=!0,$scope.editPrompt($scope._allPrompts.length-1,!1)},150)}},$scope.disableSaveBtn=function(){return"edit"!==$scope.displayMode?!0:$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()||$scope.editingMessage.jsCode&&$scope.editingMessage.jsCode.trim()?!1:!0},$scope.formDirty=function(){for(var i=0;i<$scope._allPrompts.length;i++)if(""===$scope._allPrompts[i].text)return!0;return!1},$scope.canFinish=function(){for(var i=0;i<$scope._allPrompts.length;i++)if(""!==$scope._allPrompts[i].text)return!0;return!1},scrollInitiate(),$scope.editPromptMessage=function(index){-1===index&&($scope.editPromptMode=!1),$scope.loadEditor=!0,$scope.editMessageIndex=index,$scope.currentScreen=1,$scope.editingMessage={},$scope.selectedChannel="default",$scope.contextCondition=[{key:"",value:""}],0>index||index>=0&&"basic"===$scope.standardPrompts[index].type?($scope.editingMessage.markUp=index>=0?$scope.standardPrompts[index].text:"",$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0):($scope.editingMessage.jsCode=$scope.standardPrompts[index].text,$scope.currentTabIndexOfPage2=1,$scope.CurrentTabIndex=1)},$scope.editChannelPromptMessage=function(index){-1===index&&($scope.editPromptMode=!1,$scope.isUser=!1),$scope.editMessageIndex=index,$scope.loadEditor=!0,$scope.currentScreen=1,$scope.editingMessage={},$scope.selectedChannel=index>=0?$scope.channelPrompts[index].channel:"",0>index||index>=0&&"basic"===$scope.channelPrompts[index].type?($scope.editingMessage.markUp=index>=0?$scope.channelPrompts[index].text:"",$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0):($scope.editingMessage.jsCode=$scope.channelPrompts[index].text,$scope.currentTabIndexOfPage2=1,$scope.CurrentTabIndex=1)},$scope.navigateBack=function(index){$scope.loadEditor=!1,$scope.currentScreen=0,$scope.editPromptMode=!0,$scope.isUser=!0,$scope._allPrompts[index].isOpen=!1,$(".scrollDiv").animate({scrollTop:$("#prompt-0").offset().top},1e3)},$scope.addPromptMessage=function(){$scope.standardPrompts=$scope.standardPrompts||[],$scope.channelPrompts=$scope.channelPrompts||[];var messageObject={};messageObject.channel=0===$scope.currentTabIndexOfPage1?"default":$scope.selectedChannel.channel,"Workplace For Groups"===messageObject.channel?(messageObject.channel="wfacebook",messageObject.isMention=!0):"Workplace For Chat"===messageObject.channel&&(messageObject.channel="wfacebook",messageObject.isMention=!1),messageObject.text=$scope.editingMessage.jsCode?$scope.editingMessage.jsCode:$scope.editingMessage.markUp,messageObject.type=$scope.editingMessage.jsCode?"uxmap":"basic","default"===messageObject.channel?-1===$scope.editMessageIndex&&($scope.editingMessage.jsCode||$scope.editingMessage.markUp)?$scope.standardPrompts.push(messageObject):(messageObject._id=$scope.standardPrompts[$scope.editMessageIndex]._id,$scope.standardPrompts[$scope.editMessageIndex]=messageObject):-1===$scope.editMessageIndex&&($scope.editingMessage.jsCode||$scope.editingMessage.markUp)?$scope.channelPrompts.push(messageObject):(messageObject._id=$scope.channelPrompts[$scope.editMessageIndex]._id,$scope.channelPrompts[$scope.editMessageIndex]=messageObject),$scope.currentTabIndexOfPage2=0,$scope.CurrentTabIndex=0,$scope.navigateBack()},$scope.deletePrompt=function(index){0===$scope.currentTabIndexOfPage1?$scope.standardPrompts.splice(index,1):$scope.channelPrompts.splice(index,1)},$scope.cancel=function(){$("#flowtask_configure").modal("hide")},$scope.handleEditorPlaceholder=function(event){},$scope.getPreviewData=function(){var _context={},_isValidContext=!0;if($scope.contextCondition.length>0&&$.each($scope.contextCondition,function(k,context){var _contextKey=context.key?context.key.trim():"";if(""!==_contextKey){if(0!==_contextKey.toLowerCase().indexOf("context."))return _isValidContext=!1,!1;var _tempObj={};_contextKey=_contextKey.substr(8),_contextKey.split(".").reverse().forEach(function(_parsedKey){var _t={};_t[_parsedKey]=Object.keys(_tempObj).length?_tempObj:context.value.trim(),_tempObj=_t}),angular.merge(_context,_tempObj)}}),!_isValidContext)return void NotificationService.notify(i18n.i18nString("bot_welcomeMessage_keys_should_be_prefixed_notify"),"warning");$scope.previewIsOn=!0;var markup=isMarkUp($scope.editingMessage),payload={message:$scope.editingMessage.markUp&&$scope.editingMessage.markUp.trim()?$scope.editingMessage.markUp:$scope.editingMessage.jsCode,type:markup?"basic":"uxmap",context:JSON.stringify(_context)};$scope.isError=!1,$scope.preview="",BTFlowtaskService.messagePreviewFlowtask($workflowService.selectedStream()._id,"taskId","nodeId",payload).then(function(res){var _ele=document.createElement("div");_ele.innerHTML=res.data&&(res.data.resolvedPayload||res.data.resolvedData);var lnkEle=$(_ele).find("a");lnkEle.length>0&&$.each(lnkEle,function(k,ele){$(ele).attr("target","_blank")}),$scope.preview=_ele.innerHTML,$scope.previewIsOn=!1},function(err){var error=err.data&&err.data.errors&&err.data.errors[0].msg||err.data;try{error=JSON.parse(error),error.errors&&error.errors[0].msg&&($scope.preview=error.errors[0].msg)}catch(e){$scope.preview=error}$scope.previewIsOn=!1,$scope.isError=!0})},$scope.openPreviewWithSample=function(){$scope.previewIsOn=!1,$scope.preview=$scope.editingMessage.markUp?$scope.editingMessage.markUp:$scope.editingMessage.jsCode},$scope.updateFooterHeader=function(){return $scope.footerInfoTitle=i18n.i18nString("user_prompt_learnMore_creating_prompt"),"message"===$scope.type&&($scope.footerInfoTitle=i18n.i18nString("user_prompt_learnMore_creating_bot_response")),$scope.footerHeaderId="bt-userPrompt",$scope.footerPanelId="bt-userPrompt-panel",$scope.nameDescription=i18n.i18nString("user_prompt_creating_right_prompt_Desc"),!0},$scope.saveUserPromptMessages=function(index,_isFromDelete,_isFrmCreate){if($scope.messagesObject.isInstancePrompts)return void $scope.saveInstanceEntityUserPromptMessages(index,_isFromDelete,_isFrmCreate);startSaving(".promptSaveSpin"+index);var _tempMessage=[];$scope._allPrompts&&$scope._allPrompts.length>0&&$.each($scope._allPrompts,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebookG"===_tempMessageObject.channel||"wfacebookC"===_tempMessageObject.channel||"wfacebook"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),_tempMessage=_tempMessage.filter(function(i){return""!==i.text});var payload={name:$scope.messagesObject.name,message:_tempMessage};if($scope.promptType&&"submit"===$scope.promptType&&(payload={name:$scope.messagesObject.name,submitMessage:_tempMessage}),$scope.messagesObject.category&&""!==$scope.messagesObject.category){var tempCopyObj=$scope.messagesObject.nodeInfo.nodeInfo.multiCategoryPrompts.filter(function(e){return e.category==$scope.messagesObject.category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.message=_tempMessage,payload={name:$scope.messagesObject.name,multiCategoryPrompts:$scope.messagesObject.nodeInfo.nodeInfo.multiCategoryPrompts}}BTFlowtaskService.updateComponent($workflowService.selectedStream()._id,$scope.messagesObject.nodeId,payload).then(function(res){if(res&&res.data){var componentData=$scope.messagesObject.nodeInfo.nodeInfo||{},dialog=$scope.dialogData||{},_eventPayload={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,"Dialog Name":dialog.name,"Component Name":componentData.intent||componentData.name,"Dialog Version":"V2",Category:"Engagement L2","Sub Category":"Conversation - Dialog Task",Level:"Engagement L2","Primary Intent creation mode":"Storyboard"},event="";if("intent"===componentData.type?event="Conversation - Dialog Intent updated":"message"===componentData.type?event="Conversation - Dialog Message Node updated":"entity"===componentData.type?event="Conversation - Dialog Entity Node updated":"dialogAct"===componentData.type?event="Conversation - Dialog Confirmation Node updated":"service"===componentData.type?event="Conversation - Bot action Service updated":"script"===componentData.type?event="Conversation - Bot action Script updated":"logic"===componentData.type?event="Conversation - Bot action Logic updated":"SDKWebHook"===componentData.type?event="Conversation - Bot action Webhook updated":"process"===componentData.type?event="Conversation - Bot action Process updated":"agentTransfer"===componentData.type?event="Conversation - Agent Transfer node updated":"form"===componentData.type?event="Conversation - Form node updated":"botAction"===componentData.type&&(event="componentData - Bot action Node updated"),event&&mixPanel.postEvent(event,_eventPayload),finishSaving(".promptSaveSpin"+index),_isFromDelete)setTimeout(function(){$scope._allPrompts.splice(index,1),$scope.dialogData&&$scope.dialogData("updateComponent",$scope._allPrompts)},1e3),$timeout(function(){$(".scrollDiv").scrollTop(2)},1e3),"message"===$scope.type?NotificationService.notify(i18n.i18nString("user_prompt_bot_response_deleted"),"success"):$scope.promptType&&"submit"===$scope.promptType?NotificationService.notify(i18n.i18nString("user_submit_submit_message_deletd_success"),"success"):NotificationService.notify(i18n.i18nString("user_prompt_prompt_message_deletd_success"),"success");else{if($scope.messagesObject.category&&""!==$scope.messagesObject.category)$.each($scope.messagesObject.nodeInfo.nodeInfo.multiCategoryPrompts,function(k,cat){var filterObj=res.data.multiCategoryPrompts.filter(function(e){return e.category==cat.category});filterObj=filterObj[0]||[],cat.message.forEach(function(msg,index){
msg._id=filterObj.message[index]}),cat.errorMessage.forEach(function(msg,index){msg._id=filterObj.errorMessage[index]})});else{$.each($scope._allPrompts,function(k,message){message._id=res.data.message[k]});var _componentData=res.data;$scope.promptType&&"submit"===$scope.promptType?(_componentData.submitMessage=angular.copy($scope._allPrompts),_componentData.submitMessage.forEach(function(msg){msg.text=encodeURIComponent(msg.text)})):(_componentData.message=angular.copy($scope._allPrompts),_componentData.message.forEach(function(msg){msg.text=encodeURIComponent(msg.text)})),$scope.dialogData&&$scope.dialogData("updateComponent",_componentData)}"message"===$scope.type?NotificationService.notify("Bot response "+(_isFrmCreate?"created":"updated")+" successfully","success"):$scope.promptType&&"submit"===$scope.promptType?NotificationService.notify("Submit message "+(_isFrmCreate?"created":"updated")+" successfully","success"):NotificationService.notify("Prompt message "+(_isFrmCreate?"created":"updated")+" successfully","success")}}},function(error){if(finishSaving(".promptSaveSpin"+index,"error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else _isFrmCreate?"message"===$scope.type?NotificationService.notify(i18n.i18nString("user_prompt_botResponse_creation_failed"),"error"):NotificationService.notify(i18n.i18nString("prompt_creation_failed"),"error"):"message"===$scope.type?NotificationService.notify("Bot Response "+(_isFromDelete?"deletion":"update")+" failed.","error"):NotificationService.notify("Prompt "+(_isFromDelete?"deletion":"update")+" failed.","error")})},$scope.saveInstanceEntityUserPromptMessages=function(index,_isFromDelete,_isFrmCreate){startSaving(".promptSaveSpin"+index);var _tempMessage=[];$scope._allPrompts&&$scope._allPrompts.length>0&&$.each($scope._allPrompts,function(k,message){var _tempMessageObject={channel:message.channel,text:encodeJS(message.text),type:message.type,_id:message._id};("wfacebookG"===_tempMessageObject.channel||"wfacebookC"===_tempMessageObject.channel||"wfacebook"===_tempMessageObject.channel)&&(_tempMessageObject.isMention=message.isMention,_tempMessageObject.channel="wfacebook"),_tempMessage.push(_tempMessageObject)}),_isFromDelete&&_tempMessage.splice(index,1),_tempMessage=_tempMessage.filter(function(i){return""!==i.text});var payload={nodeOptions:{isOptional:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.isOptional,transitionType:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.transitionType||"auto",promptOptions:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.promptOptions,reuseMarkedupPhrases:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.reuseMarkedupPhrases||!1,interruptOptions:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.interruptOptions||{},reuseOptions:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.reuseOptions,notForReuse:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.notForReuse||!1,precedence:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.precedence,customTags:$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.customTags||{}}};if($scope.messagesObject.category&&""!==$scope.messagesObject.category){var tempCopyObj=$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts.filter(function(e){return e.category==$scope.messagesObject.category});tempCopyObj=tempCopyObj[0]||[],tempCopyObj.message=_tempMessage,payload.nodeOptions.multiCategoryPrompts=$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts}else payload.nodeOptions.message=angular.copy(_tempMessage),payload.nodeOptions.errorMessage=angular.copy($scope.messagesObject.nodeInfo&&$scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.errorMessage)||[];BTFlowtaskService.updateFlowtaskNodeInfo($workflowService.selectedStream()._id,$scope.messagesObject.nodeInfo.dialogInfo.dialogId,$scope.messagesObject.nodeInfo.dialogNodeInstance.uId,payload).then(function(res){if(res&&res.data)if(finishSaving(".promptSaveSpin"+index),_isFromDelete)setTimeout(function(){$scope._allPrompts.splice(index,1)},1e3),$timeout(function(){$(".scrollDiv").scrollTop(2)},1e3),NotificationService.notify(i18n.i18nString("user_prompt_prompt_message_deletd_success"),"success");else{var filterObj=angular.copy(res.data.nodes.filter(function(e){return e.nodeId==$scope.messagesObject.nodeInfo.nodeInfo.nodeId}));filterObj=filterObj[0]||null,$scope.messagesObject.category&&""!==$scope.messagesObject.category&&filterObj.nodeOptions.multiCategoryPrompts?$.each($scope.messagesObject.nodeInfo.dialogNodeInstance.nodeOptions.multiCategoryPrompts,function(k,cat){var multiCategoryFilterObj=filterObj.nodeOptions.multiCategoryPrompts.filter(function(e){return e.category==cat.category});multiCategoryFilterObj=multiCategoryFilterObj[0]||[],cat.message.forEach(function(msg,index){msg._id=multiCategoryFilterObj.message[index]}),cat.errorMessage.forEach(function(msg,index){msg._id=multiCategoryFilterObj.errorMessage[index]})}):filterObj&&filterObj.nodeOptions.message&&($scope._allPrompts=angular.copy(filterObj.nodeOptions.message),$scope._allPrompts.forEach(function(message){message.text=decodeJS(message.text)})),NotificationService.notify("Prompt message "+(_isFrmCreate?"created":"updated")+" successfully","success")}},function(error){if(finishSaving(".promptSaveSpin"+index,"error"),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else _isFrmCreate?NotificationService.notify(i18n.i18nString("prompt_creation_failed"),"error"):NotificationService.notify("Prompt "+(_isFromDelete?"deletion":"update")+" failed.","error")})}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-forms");_module.directive("btUtterances",[function(){return{restrict:"EA",scope:{nlp:"=",streamId:"@",gSearchSelect:"=",cb:"=?",rightPanelCb:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/utterances-module/utterances-module.html",controller:"UtterancesModuleCtrl"}}])}(angular),function(ng){angular.module("bt-forms").directive("workflowsMapping",[function(){return{restrict:"EA",scope:{component:"=",resourceType:"=",mapId:"=",status:"=",resource:"="},controller:"BTWFMappingCtrl",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-mapping/bt-wf-mapping.html",link:function($scoe,ele,attrs){}}}])}(angular),function components(ng){angular.module("bt-components",["ui.bootstrap"]).directive("profilePic",[function(){return{restrict:"EA",scope:{context:"="},template:'<div style="display:inline-block;verticle-align:middle;"></div>',link:function($scope,$ele,$attrs){function addHexColor(c1){var c2="29bd89";c1=c1.slice(1);var hexStr=(parseInt(c1,16)+parseInt(c2,16)).toString(16);return"#"+hexStr.slice(0,7)}$scope.$watch("context",function(newVal,oldVal){var template;_.isObject($scope.context)&&($scope.context.profColor=$scope.context.profColor?$scope.context.profColor:"#29bd89",$scope.context.fN=$scope.context.firstName?$scope.context.firstName:$scope.context.fullName,$scope.context.fN=($scope.context.fN?$scope.context.fN:"-").toUpperCase(),$scope.context.lN=$scope.context.lastName?$scope.context.lastName:$scope.context.fullName,$scope.context.lN=($scope.context.lN?$scope.context.lN:"-").toUpperCase(),template="no-avatar"===$scope.context.profImage?'<div class="profile-pic" style="background-color:'+$scope.context.profColor+";color:"+addHexColor($scope.context.profColor)+';">'+$scope.context.lN[0]+$scope.context.fN[0]+"</div>":'<img ng-src="'+$scope.context.url+'"/>',$ele.html(template))})}}}]).directive("customEditor",["$compile",function($compile){return{restrict:"EA",scope:{callback:"=",keys:"=",data:"=",name:"@?",mode:"@?"},link:function($scope,$ele,$attrs){var editor,id;id="editor_"+btoa(Math.random()*Math.random()).replace(/=/g,""),editor=document.createElement("div"),editor.setAttribute("acify",""),editor.setAttribute("id",id),editor.setAttribute("mode",$scope.mode),editor.setAttribute("name",$scope.name),editor.setAttribute("ng-model","data"),editor.setAttribute("callback","callback"),editor.setAttribute("class","min_editor"),$(editor).addClass("max_editor"),$ele[0].appendChild(editor),$compile(editor)($scope)}}}]).directive("removeNoneAscii",[function(){return{restrict:"A",require:"^ngModel",link:function($scope,$ele,$attrs,ngModelCtrl){ngModelCtrl.$parsers.unshift(function(value){return value.replace(/[^\x00-\x7F]/g,"").replace(/\s+/g," ")})}}}]).directive("safeIframeInner",["$compile",function($compile){return{restrict:"EA",scope:{data:"=?"},link:function($scope,$ele,$attrs){$scope.$watch("data",function(newVal,oldVal){$ele[0].src="about:blank",$ele[0].contentDocument.write(newVal)})}}}]).directive("colorCircle",[function(){return{restrict:"A",scope:{color:"@",circleClass:"="},replace:!0,template:'<span class="{{circleClass}}" ></span>',link:function($scope,$ele,$attrs){$scope.$watch("color",function(newVal,oldVal){$($ele[0]).css("color",$scope.color)})}}}]).directive("btModalTitle",[function(){return{restrict:"E",scope:{title:"@?",bot:"=?",taskname:"@?",fontclass:"@?",genericImg:"@?"},replace:!0,template:'<div class="btmodaltitlediv"><span class="botinfosection"><span class="botIcon"><img class="avatar" ng-src="{{bot.icon || genericImg}}"/></span><span class="bottasksection"><span class="botname" >{{bot.name}}</span><h4 class="modal-title btmodaltitle">{{taskname}}</h4></span><span  ng-show="title" class="seperator">|</span><span class="modalActionSecton"><span class="modalAction" ng-show="title">{{title}}</span></span></div>',link:function($scope,$ele,$attrs){}}}]).directive("searchExpand",[function(){return{restrict:"A",link:function($scope,ele,$attrs){$(ele[0]).find(".searchBar").on("click",function(evt){if($(this).hasClass("btx-close")){if($(ele[0]).removeClass("searchExpand"),$(this).removeClass("btx-close"),$(this).addClass("btx-search"),$(ele[0]).find("input").val(""),$(ele[0]).hasClass("callclear")){var _callbackMethod=$(ele[0]).attr("callback");_callbackMethod?$scope[_callbackMethod]():$scope.clearSearch()}}else $(ele[0]).addClass("searchExpand"),$(this).addClass("btx-close"),$(this).removeClass("btx-search"),setTimeout(function(){$(ele[0]).find("input").focus()},350)}),$scope.closeSearch=function(){var _ele=$(ele[0]).find(".searchBar");_ele.hasClass("btx-close")&&($(_ele[0]).parent().removeClass("searchExpand"),_ele.removeClass("btx-close"),_ele.addClass("btx-search"))}}}}]).directive("encodeDecode",[function(){return{require:"ngModel",restrict:"A",link:function($scope,$ele,$attrs,ctrl){var getTextIncludingTags=function(name){return name?name.replace(/&lt;/g,"<").replace(/&gt;/g,">"):""};ctrl.$formatters.push(function(value){return value&&value.length?getTextIncludingTags(value):""}),ctrl.$parsers.push(function(value){return value&&value.length?(ctrl.$setViewValue(getTextIncludingTags(value)),value):""})}}}]).directive("onlyNumber",[function(){return{restrict:"EA",link:function($scope,$ele,$attrs){var allowedKeys=[8,35,36,37,38,39,40,45,46,116];$ele.on("keydown keyup",function(evt){var e=evt||window.event,charCode=e.which||e.keyCode;return e.ctrlKey&&65==charCode?!0:-1==allowedKeys.indexOf(charCode)&&charCode>31&&(47>charCode||charCode>57)&&!(charCode>=96&&105>=charCode)?!1:e.shiftKey?!1:!0})}}}]).directive("keyBouncer",["$timeout",function($timeout){return{restrict:"A",scope:{keys:"@",context:"="},link:function($scope,$ele,$attrs){var notHandled;$scope.keys=_.isArray($scope.keys)?$scope.keys:[],$($ele[0]).on("keydown",function(event){return notHandled=event.shiftKey?-1===$scope.keys.indexOf(event.keyCode):!0,_.isObject($scope.context)&&$timeout(function(){$scope.context.errorShow=!notHandled}),notHandled})}}}]).directive("disableTextarea",[function(){return{restrict:"A",link:function($scope,$ele,$attrs){$($ele[0]).find("textarea").attr("disabled",!0)}}}]).directive("autoGrow",[function(){return{restrict:"EA",link:function($scope,$ele,$attrs){autosize($ele)}}}]).directive("colorPicker",[function(){return{restrict:"A",require:"^ngModel",link:function($scope,$ele,$attrs,ngModelCtrl){function read(){var hex_value=$($ele[0]).spectrum("get").toHexString()||defaultColor;ngModelCtrl.$setViewValue(hex_value)}var defaultColor="#000";$($ele[0]).spectrum({color:defaultColor,showInitial:!0}),ngModelCtrl.$render=function(){$($ele[0]).spectrum("set",ngModelCtrl.$viewValue)},$($ele[0]).spectrum({change:function(tinycolor){$scope.$evalAsync(read)}}),$scope.$watch($attrs.ngModel,function(newVal,oldVal){ngModelCtrl.$setViewValue(newVal||defaultColor)})}}}]).directive("imgErrorAware",function(){return{restrict:"A",scope:{link:"@"},link:function(scope,element,attrs){var defaultImg="iVBORw0KGgoAAAANSUhEUgAAAV4AAACqCAYAAADlXyehAAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAOU0lEQVR4Ae2d567bSAxGld57770iCYK8/yPcf+kJ0pDee2+7nxb00rrWdYlN05MzQFayPBLJw/HnETW+u2hubu53RYMABCAAgTACi8MsYQgCEIAABGoCCC8DAQIQgEAwAYQ3GDjmIAABCCC8jAEIQAACwQQQ3mDgmIMABCCA8DIGIAABCAQTQHiDgWMOAhCAAMLLGIAABCAQTADhDQaOOQhAAAIIL2MAAhCAQDABhDcYOOYgAAEIILyMAQhAAALBBBDeYOCYgwAEIIDwMgYgAAEIBBNAeIOBYw4CEIAAwssYgAAEIBBMAOENBo45CEAAAggvYwACEIBAMAGENxg45iAAAQggvIwBCEAAAsEEEN5g4JiDAAQggPAyBiAAAQgEE0B4g4FjDgIQgADCyxiAAAQgEEwA4Q0GjjkIQAACCC9jAAIQgEAwAYQ3GDjmIAABCCC8jAEIQAACwQQQ3mDgmIMABCCA8DIGIAABCAQTQHiDgWMOAhCAAMLLGIAABCAQTADhDQaOOQhAAAIIL2MAAhCAQDABhDcYOOYgAAEIILyMAQhAAALBBBDeYOCYgwAEIIDwMgYgAAEIBBNAeIOBYw4CEIAAwssYgAAEIBBMAOENBo45CEAAAggvYwACEIBAMAGENxg45iAAAQggvIwBCEAAAsEEEN5g4JiDAAQggPAyBiAAAQgEE0B4g4FjDgIQgADCyxiAAAQgEEwA4Q0GjjkIQAACCC9jAAIQgEAwAYQ3GDjmIAABCCC8jAEIQAACwQQQ3mDgmIMABCCA8DIGIAABCAQTQHiDgWMOAhCAAMLLGIAABCAQTADhDQaOOQhAAAIIL2MAAhCAQDABhDcYOOYgAAEIILyMAQhAAALBBBDeYOCYgwAEIIDwMgYgAAEIBBNAeIOBYw4CEIAAwssYgAAEIBBMAOENBo45CEAAAggvYwACEIBAMAGENxg45iAAAQggvIwBCEAAAsEEEN5g4JiDAAQggPAyBiAAAQgEE0B4g4FjDgIQgADCyxiAAAQgEExgabA9zDkCnz9/rh4/flx9+vSp+vXrV7Vu3bpq/fr11caNG6slS5a4nuwOSsCY+v7Lly+vVq9eXXNdvJi5hmfD/nQIILzT4V69fPmyunPnTi245sKXL1+q58+fV8ePH69Fwo6zHZzA9+/fqxcvXvQ8YdWqVdXRo0crbWkQmCYBvv6nQF/i0BTdZcuWVYsWLZqCN+Wa1F2DuFrTbPjWrVv2ki0EpkaAGe8U0Ku8oNKC2tKlS+sZ7tq1a6vfv3/XszUda7b379/XJQkd37x5c5egNPvy+j8CmzZtqg4fPly9ffu2unnzZs1cZZ03b95wR8EgmSqB+Z/wqbrzdxjXh9/atm3bKomumma8et2rqTTx7Nmz+q01a9YgvL0gtRzbsGFDzfXp06d1jw8fPiC8Law4HEOAUkMM5y4rquVa27Jli+2ynSAB+3KTiW/fvk3QEpeGQH8CCG9/RmPv4euOP3/+HPv1ueB8Ap75jx8/5nfgCAQCCVBqCIRtpjT7+vjxY/1S9UctI2trqvtqhuwF+uvXr3WpYcWKFV2nqZ/6q2SxcuXK+px3797VpQwvPHaSrqnbblvK1qu2bH211bXVX+dp2Zvs2Oxdy7Sa/uicpk+ypXq1zlXc2qrZcV1bpZRe16o7jvgfL7YLLdUbNkZdVw9L1cRYDJUfcdLqCf2zGL3ro57nrzFM/pp50LkLjQ1vh/3xE0B4x8+07xUlLNaePHlSqdzQtsRJt8UXL1607vVWT+YlWqdOneo6fuXKlUofaK1bPXHiRKXX+oCdPXt2Xk1YS65u377ddf7evXur3bt3dx2zFxJGXc/q0xIY2bh8+XLdpZc/eqPp09WrV2sf9Z78PHPmTC3O165d6zxwlFAdPHiwtd6tc4dtWtFgrU3UR4lRtfd79+7Vlz506FD9peKXs6lmr+PNNup5dp1h89fMw0Jjw2ywnRwBSg2TY9t6Zf1AQqKjpg/7jRs3xlp3tGtKdHs1PdVviq76PXjwoF5H3Ouc+/fvd0RX70vgtVJg0GY+6Txr+lLRl4itOLDjmnVKzHTOOJpme/ZgUtfTaode7U9j1GoVL7qyoXXZmlku1IY9b5T8mX3LQ9vYsH5sJ0sA4Z0s355X12xRC/ntFlS3ptevX+/csvqTJNAXLlzomv1ppqkfWbQ1iZtEbfv27dWBAwfmzXbt6b5uuTUbPnfuXH2LrOtpBt6rvXr1qnNYM+OTJ092Xg+yI59U/tAsff/+/Z1TVGoRj2PHjtW+2i/LJBBWxuh0HnJHgqeZne4YrBwg3/0dh7/kOGI8ffp0HaO/g7Gykrfl98VmmPNGyZ/Z6zc2rB/byRJAeCfLt/XqqvN68dWtcHPmp5MlzhImE2kdk2AuVKdUH93e6nZ9x44dHVHVcX3wbAam9cASCAmira6QH/62XOeovGDCpZ/eqhyhGm9bWULn9GpHjhypSyQ7d+7squHu2bOnnoXKV13Xmnz9k6YvH9VaNYNWk/02n8cR49atW+t6usouitFavziGOW+U/Jkftm0bG/Y+28kTQHgnz7jVgi3wtw4SiXH9skqi2qtJYEyIJKLW/CxQD79804zcml+W5fft/batvjz0z5qVWvTa7/d6CGjnDLuVPX9tsVU5oVcbR4y+duzt9iuZDHPeKPlrxts2Npr9eD05Agjv5NgOdGXNNFUOsPb69et5dUJ7b9CtBMdu2Zvn+NmX+qnWp39+Bu376Hz/2gujF4ymnebrpj/+ddt+8xrDvlYt/fz58/VtvPmteqrqrs027hj9HUrTVvO1j7/fed7PQfPn7S00Nnw/9idL4P8pyGTtcPUFCOgWW7f39gBINTzdfo7a/Ae5eQ0rGeh42+za91E//yDGX9vvq1/Wppm5Sgy2+kDC2/yF4KzE6HMzaP58XmYlZ97nEveZ8SbJqh76WNPtZL/bU+s77NYLjGZXvf75Prq+98V/cPvNzob1bZL9fVlEfJttVmL0uemVOx3zfZpx8joHAWa8OfJQ1z/1oEszX9VgJQ5eLMblpi8paCWBbsf7NX+OFyirFfc7P8P7VmqQL4pB//yXyKzE6P0cNH8Z+ONDNwGEt5vHVF/pgYytKNAT+Uk0L0B+ZiQRtdtYCZJqgdb8vhdef771zbr1vtpM0fs6KzGOkj8fJ/s5CPz/6crhz1/rhQTNrybQEq9JNC8w/km+BP/SpUu1yX379lW7du3qmPezLH/On66z7RgI2PG+6qFgs0wyKzGOkr8AvJgYkgA13iGBjaO7ygh6kOZv1fXAx2aTEoVJCa+WkJno2HpexeQX+fvF/3rPLzXz62L9F4X6ZW1aCfDo0aOOe8349Ma4YzTGHaMD7vQ7b5T8DWiaboEEmPEGwjZTuu29e/du9fDhw/oDL2GQoFnTKgdff7Tj49hqxqS6rpatSXglSCpxyBc12W3WlnV7a/VnzRz1f89QHy9m4/Bt3NfQF4N+ESi2vtTgZ/Nmc1ZiHCV/FiPbPASY8U4xF6qp6nf3XnR1G6xfck2y6VdVNrPS32fQ322wmrJEyd/Omh9++ZX+HoG+OPQLrcxNZRH9JNmLrr7Uml8sFsOsxDhK/ixGtjkIILxTyINmj/o7CiZ+ckH7+jGF/lqXrzdOwj0Jpv7Wg/91lexL8Nt+UqsPu19brFveg//+JHkWmuLU/4XC/h5Em8+zEuMo+WuLmePTIbBobm7uvx+yT8f+X21VMzF76CMxnlR5YSHImnWr1KGasv8iaDtHfeX3ML9aa7tW1uOzFOOw+cvK/G/zixrvFDOuma1/qDMNV1Tb9EuU+vmgMkSvUkS/82bp/VmKcdj8zVIeSvaVUkPJ2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQC/wCwF1znWrp3KAAAAABJRU5ErkJggg==";scope.$watch("link",function(newVal,oldVal){"no-image"===newVal&&(element[0].src="data:image/png;base64,"+defaultImg)})}}}).directive("urlValidater",[function(){return{restrict:"A",require:"^ngModel",link:function($scope,$ele,$attrs,ngModelCtrl){var URL_REGEXP=/^((?:http|ftp)s?:\/\/)(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+(?:[A-Z]{2,6}\.?|[A-Z0-9-]{2,}\.?)|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?(?:\/?|[\/?]\S+)$/i;ngModelCtrl.$parsers.unshift(function(value){return!URL_REGEXP.test(value)&&URL_REGEXP.test("http://"+value)?"http://"+value:value}),ngModelCtrl.$validators.url=function(value){return ngModelCtrl.$isEmpty(value)||URL_REGEXP.test(value)}}}}]).directive("insertAfter",["$compile","$templateCache","$timeout",function($compile,$templateCache,$timeout){return{restrict:"EA",scope:{templateId:"=",ctx:"=",domId:"=",api:"=",colSpan:"@",propName:"@"},link:function($scope,ele,attrs){function clearDom(){$("#"+$scope.domId)&&$("#"+$scope.domId).html()&&($("#"+$scope.domId).remove(),$timeout(function(){atElement=void 0}))}function mountApi(){$scope.api.displayIO=function(index,display){display&&(clearDom(),atElement!==index&&($(ele[0]).after($compile($templateCache.get($scope.templateId))($scope)),atElement=index))}}var atElement;$scope.options={mode:"view",ace:window.ace},$scope[$scope.propName]=_.clone($scope.ctx),$scope.$watch("api.isUsed",function(newVal,oldVal){clearDom()},!0);for(var key in $scope[$scope.propName])$scope[$scope.propName].hasOwnProperty(key)&&"output"!==key&&"input"!==key&&delete $scope[$scope.propName][key];$scope.$watch("api",function(newVal,oldVal){_.isObject(newVal)&&!newVal.displayIO&&mountApi()})}}}]).directive("imgLoadStatus",["$timeout",function($timeout){return{restrict:"EA",scope:{link:"="},link:function(scope,element,attrs){function loadImage(){counter=0;var xhr=new XMLHttpRequest;xhr.open("GET",scope.link,!0),xhr.responseType="arraybuffer";var interval=setInterval(function(){element[0].src="data:image/png;base64,"+images[counter],setCounter()},250);xhr.onload=function(e){if(200===this.status){for(var uInt8Array=new Uint8Array(this.response),i=uInt8Array.length,binaryString=new Array(i);i--;)binaryString[i]=String.fromCharCode(uInt8Array[i]);var data=binaryString.join(""),base64=window.btoa(data);$timeout(function(){clearInterval(interval),element[0].src="data:image/png;base64,"+base64},1e3)}else $timeout(function(){clearInterval(interval),element[0].src="data:image/png;base64,"+defaultImg},1e3)},xhr.send()}function setCounter(){counter===images.length-1?counter=0:++counter}var images=["iVBORw0KGgoAAAANSUhEUgAAAV4AAACWCAYAAACW5+B3AAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAMIUlEQVR4Ae2dR4/UTBCGveSccxRw4IDgwv//B3vkQBBCQuScM+yn1/p6qO31zgxrT21NzdMSjO3pUPVU63VPu9u7tLy8vNKQIAABCEDAjcAWt5ZoCAIQgAAEWgIILx0BAhCAgDMBhNcZOM1BAAIQQHjpAxCAAAScCSC8zsBpDgIQgADCSx+AAAQg4EwA4XUGTnMQgAAEEF76AAQgAAFnAgivM3CagwAEIIDw0gcgAAEIOBNAeJ2B0xwEIAABhJc+AAEIQMCZAMLrDJzmIAABCCC89AEIQAACzgQQXmfgNAcBCEAA4aUPQAACEHAmgPA6A6c5CEAAAggvfQACEICAMwGE1xk4zUEAAhBAeOkDEIAABJwJILzOwGkOAhCAAMJLH4AABCDgTADhdQZOcxCAAAQQXvoABCAAAWcCCK8zcJqDAAQggPDSByAAAQg4E0B4nYHTHAQgAAGElz4AAQhAwJkAwusMnOYgAAEIILz0AQhAAALOBBBeZ+A0BwEIQADhpQ9AAAIQcCaA8DoDpzkIQAACCC99AAIQgIAzAYTXGTjNQQACEEB46QMQgAAEnAkgvM7AaQ4CEIAAwksfgAAEIOBMAOF1Bk5zEIAABBBe+gAEIAABZwIIrzNwmoMABCCA8NIHIAABCDgTQHidgdMcBCAAAYSXPgABCEDAmQDC6wyc5iAAAQggvPQBCEAAAs4EEF5n4DQHAQhAAOGlD0AAAhBwJoDwOgOnOQhAAAIIL30AAhCAgDMBhNcZOM1BAAIQQHjpAxCAAAScCSC8zsBpDgIQgADCSx+AAAQg4EwA4XUGTnMQgAAEEF76AAQgAAFnAgivM3CagwAEIIDw0gcgAAEIOBPY5twezUGgF4Hv3783Hz58aOvYvn17c+jQoV71URgCm0EA4d0M6rS5YQJfvnxpHjx40Jbft28fwrthkhTcTAJMNWwmfdqGAAQWkgAj3gUK+69fv5pbt26NPL5y5Uqzf//+0TkHEICADwGE14dziFZWVlaaHz9+jGz58+fP6DjTwfv375uXL1+2N5Xjx483W7bwwy5TfDP4gvBmiCI+jAjoxnLnzp32/M2bN+3nyZMnR99zAIEIBBgKRIgCNgxG4PPnz6vq+vTp06pzTiAQgQDCGyEK2DAYgYMHDzY7duxo61taWmo01UCCQDQCTDVEiwj29CKg+dwbN260a3337t3baK0vCQLRCCC80SKCPb0JSHzZWNEbIxXMkABTDTOES9UQgAAEuggw4u2iwrU1BN69e9e8fv260cOqrVu3Nto1duLEiWbPnj1r8toLX79+bZ48edJ8/Pix0U//U6dONZp7ffr0aZtt9+7dzblz52yR0bEtq3xqb5r06NGjRmWV1F69Vlm73x4/ftx+v3PnzubChQvN8+fPG62C0JZk+Sabdu3a1ebp+k/1ywdtX5Ztp0+fbrnIV6VSb1dZrkEA4aUPTCSgNbFlm27JLPGSEF+9erUVqnLdfv78+bNd2lXWDutTQiWRevv2bZtVebpSV1mtz5WQTkpqo6xmOHr06Jrs2khS2pdoSqiLYCqzBFjlr1271jlHrPJ3795tRVr55Zfynz17dlSvbjIkCKxHgKmG9chwvSVg342gC5o/1YhV6ffv360AaWNGV3r27NmqDRsaKauMhG5S6iqrMro+ZPr27VsruhJgmySmEvqupJGuRsYl/YtfpQyfi02AEe9ix3+i969evRrl0U92jXAlntp6rFGpRn8SqK6HWZqeKOnIkSPN5cuXW8FS2fXEuuTvU7bUMc2n7NDWaY2MJcK3b98e3SzKdEVdT3k7mq7LL5UXA42CSRCYhgAj3mkoLWgeiZKmE0rSFIFGvFqiZXeD2Twlr0TZCteZM2fashpZSqzGpT5lx9Xb9Z38KfZoTtfeQHSDqZNuNHaThpjoF4DK1XPJdVnOIVAIILyFBJ9rCOjntkSwJPsgzR5rOqJOKluShMn+lJ80/9mnbGlz2k/dRMrUicps2/b3R2DXuyzG2aaHciQITEMA4Z2G0oLm0ejOJrsZwR7X+VTGXpOYWXHTE/9xqU/ZcfV2facRr031uf1Ox7VtNr+9udTlOIeAJbC619lvOF54Ana0K4Gx4mkFx4pRgWZ/puvhk022rL1ejvuULXXM6nOcbbWfs7KBeuefAMI7/zGcmQdWUGuxtOeaC7aCJIPsuRVsfWfL6rxOfcrWdQ19Htm2oX2lvtkRQHhnx3bua7YjuHq+s16VUIurLVvnrc9rUH3K1nUNfW79nOTH0G1TXx4CCG+eWA7uybgHTVaIJZT1KNaKp80rI+2oscvoPmW76hvymrWt9qP2c8h2qSsXAYQ3VzwH9cY+QFPFdurBHtf5lNeKdi1Qtqzy1qlP2bquoc+tbfLDjnprP4dum/ryEEB488RycE/0Xlv709quy7VLyLpWKVgxliDZnV62bJfRfcp21TfkNSu8El1tuijJHpdrfEKgiwDC20WFay0BTR/YDQV6Z4OSBMdumigbENov//9Pom0FufwZHv0cL+9JsPntcZ+ytp5ZHGuThb0xFA5iYnfbrde2bkAPHz5st03bVSPr5ed6TgJ/V4vn9A+vxhDQi2/quVltAtDW3pKOHTs2EkptH5Zw6Cd2Gf2qfJfwqrz+GsSLFy/aqvR+Bo10NSq0mxBKO/Vnn7J1Xf9ybkf465XTzajchPTeBvkkEZ00kld99+/fH73AR2UuXbq0XjNcT0yAEW/i4E5yTQIo0bD/7JSAyktkrLDq9Y5FdPX9+fPn29ch6rhOeo1jEfYyStZ22643hg1Ztq5r6HP5VQRafmk0Ly66SY1LylvemqZ80wj1uPr4bn4JILzzGzsXyyUwegmMxMY+0dd0gEZr9p0NtUHaVqw8ZV5Udem1jlbI6zLlvE/ZUsesPrXlWUyKX7q56F0Uhw8fHttk8V+ZVEbveSAtJoGl5eXl7nf6LSYPvB5DQCM2jXYlOBLeaVMpp/nRMgL2KDttGxvNV/uluet79+611Umc9T7frqRfGJontjeyrnxcy0uAOd68sR3cM43Y7Mtxpm1go+VUf5+y09r3L/n0cLBMF+gmYl+MIyEuadwNZtxftijl+cxNAOHNHV+8G5iAHizqnb0l3bx5czRytet4yzREyccnBCwB5ngtDY4hMIGApljsaLYsIdNotxyrCruUbkKVfL2ABBjxLmDQcbkfAT1EK+t3tTxMS+a0GsQuk7Prn/u1RumMBBjxZowqPs2UgP4qsd1EoaVkVnT1F4oPHDgwUxuofL4JMOKd7/hh/SYQkOhev369/RPx+vtrWqWgqQU9eNRId9J63k0wmSaDEUB4gwUEc+aDgB6eXbx4cT6MxcpwBJhqCBcSDIIABLITQHizRxj/IACBcAQQ3nAhwSAIQCA7AYQ3e4TxDwIQCEcA4Q0XEgyCAASyE0B4s0cY/yAAgXAEEN5wIcEgCEAgOwGEN3uE8Q8CEAhHAOENFxIMggAEshNAeLNHGP8gAIFwBBDecCHBIAhAIDsBhDd7hPEPAhAIRwDhDRcSDIIABLITQHizRxj/IACBcAQQ3nAhwSAIQCA7AYQ3e4TxDwIQCEcA4Q0XEgyCAASyE0B4s0cY/yAAgXAEEN5wIcEgCEAgOwGEN3uE8Q8CEAhHAOENFxIMggAEshNAeLNHGP8gAIFwBBDecCHBIAhAIDsBhDd7hPEPAhAIRwDhDRcSDIIABLITQHizRxj/IACBcAQQ3nAhwSAIQCA7AYQ3e4TxDwIQCEcA4Q0XEgyCAASyE0B4s0cY/yAAgXAEEN5wIcEgCEAgOwGEN3uE8Q8CEAhHAOENFxIMggAEshNAeLNHGP8gAIFwBBDecCHBIAhAIDsBhDd7hPEPAhAIRwDhDRcSDIIABLITQHizRxj/IACBcAQQ3nAhwSAIQCA7AYQ3e4TxDwIQCEcA4Q0XEgyCAASyE0B4s0cY/yAAgXAEEN5wIcEgCEAgOwGEN3uE8Q8CEAhHAOENFxIMggAEshNAeLNHGP8gAIFwBBDecCHBIAhAIDsBhDd7hPEPAhAIRwDhDRcSDIIABLITQHizRxj/IACBcAQQ3nAhwSAIQCA7AYQ3e4TxDwIQCEcA4Q0XEgyCAASyE0B4s0cY/yAAgXAEEN5wIcEgCEAgO4H/ACUSKmrsy2IUAAAAAElFTkSuQmCC","iVBORw0KGgoAAAANSUhEUgAAAV4AAACWCAYAAACW5+B3AAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAMV0lEQVR4Ae3dR4/kRAMGYC85LzkHLRw4IODA//8He+RAECAhclxyZtHrT9XU+uvprpmuLWbcT0nQYSrYT1uvq92299LVq1evTwoBAgQIDBO4ZdhIBiJAgACBWUDw2hAIECAwWEDwDgY3HAECBASvbYAAAQKDBQTvYHDDESBAQPDaBggQIDBYQPAOBjccAQIEBK9tgAABAoMFBO9gcMMRIEBA8NoGCBAgMFhA8A4GNxwBAgQEr22AAAECgwUE72BwwxEgQEDw2gYIECAwWEDwDgY3HAECBASvbYAAAQKDBQTvYHDDESBAQPDaBggQIDBYQPAOBjccAQIEBK9tgAABAoMFBO9gcMMRIEBA8NoGCBAgMFhA8A4GNxwBAgQEr22AAAECgwUE72BwwxEgQEDw2gYIECAwWEDwDgY3HAECBASvbYAAAQKDBQTvYHDDESBAQPDaBggQIDBYQPAOBjccAQIEBK9tgAABAoMFBO9gcMMRIEBA8NoGCBAgMFhA8A4GNxwBAgQEr22AAAECgwUE72BwwxEgQEDw2gYIECAwWEDwDgY3HAECBASvbYAAAQKDBQTvYHDDESBAQPDaBggQIDBYQPAOBjccAQIEBK9tgAABAoMFBO9gcMMRIEBA8NoGCBAgMFhA8A4GNxwBAgQEr22AAAECgwUE72BwwxEgQEDw2gYIECAwWEDwDgY3HAECBASvbYAAAQKDBQTvYHDDESBAQPDaBggQIDBYQPAOBjccAQIEBK9tgAABAoMFBO9gcMMRIEBA8NoGCBAgMFjgtsHjGY7AqQR+++236fvvv5/b3H777dODDz54qvYqEziPAoL3PH4qlmkj8PPPP08ffPDB/Pq+++4TvBsZTy6ygEMNF/nTs+wECFxIATPeC/mxtS30n3/+Ob355pubyi+99NJ0//33b157QoDAfyMgeP8b9yGjXr9+ffr99983Y/3999+b52t68t13301ffvnlvFN57LHHpltu8UVuTZ/vGtdF8K7xUz2idcqO5e23357X+Jtvvpkfn3jiiSMSsKoXUcDU4CJ+apZ5I/DTTz9tnufJjz/+eMNrLwicRwHBex4/FcvULHD58uXpjjvumOtfunRpyqEGhcB5F3Co4bx/QpZvp0CO57722mvzub733nvvlHN9FQLnXUDwnvdPyPLtFUj4urBiL5MK50jAoYZz9GFYFAIEjkPAjPc4PudTr+W1a9emr7/+ev6x6tZbb51y1djjjz8+3XPPPTv7+uWXX6ZPPvlk+uGHH6Z89X/yySenHHv99NNP53Z333339Oyzz27to26behmvpXz00UdT2qZkvOW5yrn67eOPP57/fuedd07PP//89Pnnn085CyKXJGfdskx33XXXXGfb/9J/1iGXL2fZnnrqqSkuWdeU0u+2tt4jsBQQvEsRr+dzYstluoUj4ZUgfvnll+egKu/Xj3/88cd8alc5dziPCaqE1LfffjtXTZ1tZVvbnJ+bIN1XMkY5m+GRRx75v+q5kKSMn9BMUJfATOUEcNq/8sorW48Rp/0777wzh3TqZ71S/5lnntn0m52MQqBVwKGGVqkjqVffGyGrnOOnmbGm/PXXX3MA5cKMbeWzzz674YKNzAjTJkG3r2xrmzZ5v2f59ddf59BNANclYZqg31Yy083MuJTTrFdp45FALWDGW2t4Pn311VcbhXxlzww34ZlLjzMrzewvAbXtx6wcnijl4Ycfnl588cU5sNL2pLAu9Q9pW/poecxy5NLpzIwTwm+99dZmZ1EOVyz7KXdHy/tZr7SPQWbBCoGzCJjxnkVtpW0SSjmcUEoOEWTGm1O06qvB6jqlbkK5Dq6nn356bpuZZcJqVzmk7a5+t/0t61OWJ8d06x1IdjDLkh1NfZFGTPINIO2Wx5KXbb0mcJKA4D1J5gjfz9fthGAp9Q9p9fMcjliWtC0lwVR/ld93/POQtmXM1sfsRMqhk7S57bZ/v/Rtu5fFrmXLj3IKgbMICN6zqK20TWZ3dakvRqifL+ulTf1ewqwOt/ziv6sc0nZXv9v+lhlvXZav67/l+XLZ6vr1zmXZzmsCuwRu3Ap31fS31QvUs90ETB2edeDUYVRQ6q/p+fGpLnXb+v3y/JC2pY+b9bhr2ZbrebOWQb/rExC86/tMz7xGdaAuw7J+nWPBdSBlwPp1Hdj5W902r5flkLbLvnq/Ps/L1ntd9TdOQPCOsz73I9UzuOXxzuVZCctwrdsu6y5fLyEOabvsq/frej33rUfvsfW3XgHBu97P9tRrtuuHpjqIE5TLWWwdnnXdLEQ9a9y2UIe03dZfz/fqZVuux3I9e46rr3ULCN51f76nWrv6B7Q0rA891M+X9VK3Du1lQNVtU3dZDmm77Kv363rZsh71rHe5nr3H1t96BQTvej/bU69Z7mtbf7Wuz8utTyHbdpZCHcYJpPpKr7rttoU6pO22/nq+VwdvQjcXXZRSPy/veSTQIiB4W5SOpE4OH9QXFOTfMUtJ4NQXTZQLEGqWhHYdyOWf4cnX8XKfhLp+/fyQtnU/N+N5LrKodwzFISb11XYnjZ0d0IcffjhfNl2fNVLXz9WC77333omXLNd1PV+HwL9nj69jfazFDoHc+GZ5bDYXAeTS3lIeffTRTVAmEBIc+YpdZr9pvy140z7/GsQXX3wxd5X7M2Smm1lhfRFCGWf5eEjbZV+neV3P8E9ql51R2Qnlvg1Zp4Tovpl8+kuglhv4pM2VK1duGCaXI7///vvzewn1119//YYd2A2VvViNgBnvaj7K/SuSAExo1P/VhwTSQ0KmDtbc3rGEbv7+3HPPzbdDzPNlyW0cS7CXWXIut912x7CebZd99X6d9SoBnfXKbD4u2UntKqlbQjf1tgV1+qlLbV2/7/m6BATvuj7Pg9cmAZObwCRs6l/0czggs7X6ng3LwXJZceqU46LpK7d1rIN82aa8PqRt6eNmPeaS55iU9crOJfeieOihh3YOWdY/ldIm93lYluyUyqGMfPvIzF9Zv8Clq1evbr/H3/rX3RruEciMLTOwBE6Ct7WUdjk+WmbAI9q2jnHWesv1yrHrd999d+4u4Zz7+W4r+YaRcK13ZHW9/BiZwxC7bsRe1/f84gs4xnvxP8ObtgaZsdU3x2kd6Kzt0v8hbVuX7zT18uNgOVyQnUh9Y5wEcSm7djD7AjWBfFIol/49rktA8K7r87Q2nQXyw2Lu2VvKG2+8sQnJ+jzechii1PNIYJeAY7y7dPzt6AVyiKWezZZTyDLbLc+DVJ9Kd/RoAPYKmPHuJVLh2AXyI1o5fzenh+WUuZwNUp8mV5//fOxe1n+/gBnvfiM1jlwg/ypxOfMgFDkFrA7d/AvFDzzwwJErWf3TCJjxnkZL3aMUSOi++uqr8z8RnwsecpZCDi3kh8fMdPedz3uUaFZ6p4Dg3cnjjwT+J5Afz1544QUcBLoIONTQhVEnBAgQaBcQvO1WahIgQKCLgODtwqgTAgQItAsI3nYrNQkQINBFQPB2YdQJAQIE2gUEb7uVmgQIEOgiIHi7MOqEAAEC7QKCt91KTQIECHQRELxdGHVCgACBdgHB226lJgECBLoICN4ujDohQIBAu4DgbbdSkwABAl0EBG8XRp0QIECgXUDwtlupSYAAgS4CgrcLo04IECDQLiB4263UJECAQBcBwduFUScECBBoFxC87VZqEiBAoIuA4O3CqBMCBAi0Cwjedis1CRAg0EVA8HZh1AkBAgTaBQRvu5WaBAgQ6CIgeLsw6oQAAQLtAoK33UpNAgQIdBEQvF0YdUKAAIF2AcHbbqUmAQIEuggI3i6MOiFAgEC7gOBtt1KTAAECXQQEbxdGnRAgQKBdQPC2W6lJgACBLgKCtwujTggQINAuIHjbrdQkQIBAFwHB24VRJwQIEGgXELztVmoSIECgi4Dg7cKoEwIECLQLCN52KzUJECDQRUDwdmHUCQECBNoFBG+7lZoECBDoIiB4uzDqhAABAu0CgrfdSk0CBAh0ERC8XRh1QoAAgXYBwdtupSYBAgS6CAjeLow6IUCAQLuA4G23UpMAAQJdBARvF0adECBAoF1A8LZbqUmAAIEuAoK3C6NOCBAg0C4geNut1CRAgEAXAcHbhVEnBAgQaBcQvO1WahIgQKCLgODtwqgTAgQItAsI3nYrNQkQINBFQPB2YdQJAQIE2gUEb7uVmgQIEOgiIHi7MOqEAAEC7QL/AAvIR9p/pczhAAAAAElFTkSuQmCC","iVBORw0KGgoAAAANSUhEUgAAAV4AAACWCAYAAACW5+B3AAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAMe0lEQVR4Ae3dWa/jNAMG4Az7vu+rgAsuEHDB//8Hc8kFiwAJse/7DoPeSu74hLqnZ1qbk/ax9H1tT2I7fhreummSuXL16tVrk0KAAAECwwRuGtaTjggQIEBgJSB47QgECBAYLCB4B4PrjgABAoLXPkCAAIHBAoJ3MLjuCBAgIHjtAwQIEBgsIHgHg+uOAAECgtc+QIAAgcECgncwuO4IECAgeO0DBAgQGCwgeAeD644AAQKC1z5AgACBwQKCdzC47ggQICB47QMECBAYLCB4B4PrjgABAoLXPkCAAIHBAoJ3MLjuCBAgIHjtAwQIEBgsIHgHg+uOAAECgtc+QIAAgcECgncwuO4IECAgeO0DBAgQGCwgeAeD644AAQKC1z5AgACBwQKCdzC47ggQICB47QMECBAYLCB4B4PrjgABAoLXPkCAAIHBAoJ3MLjuCBAgIHjtAwQIEBgsIHgHg+uOAAECgtc+QIAAgcECgncwuO4IECAgeO0DBAgQGCwgeAeD644AAQKC1z5AgACBwQKCdzC47ggQICB47QMECBAYLCB4B4PrjgABAoLXPkCAAIHBAoJ3MLjuCBAgIHjtAwQIEBgsIHgHg+uOAAECgtc+QIAAgcECgncwuO4IECAgeO0DBAgQGCwgeAeD644AAQKC1z5AgACBwQKCdzC47ggQICB47QMECBAYLCB4B4PrjgABAoLXPkCAAIHBAoJ3MLjuCBAgIHjtAwQIEBgsIHgHg+uOAAECgtc+QIAAgcECgncwuO4IECAgeO0DBAgQGCxwy+D+dEegKfD7779PP/zww2r5rbfeOj3wwAPNdS0gsGQBwbvkd+/Itv2XX36ZPvjgg9Wo7rnnHsF7ZO+v4VwXcKjhuoVnBAgQGCJgxjuEuX8nf/311/Tmm2+uO3rppZeme++9d/3aEwIELo+A4L0878VeW3Lt2rXpjz/+WLfxzz//rJ8f05Pvv/9++vLLL1cfKo8++uh0002+tB3T+3sqYxG8p/JOH8E488Hy9ttvr0byzTffrB4ff/zxIxiZIZyagOnCqb3jCx7vzz//fGbrf/rppzOvvSCwFAHBu5R3ynZO999//3TbbbetJK5cuTLlUINCYIkCDjUs8V070W3O8dzXXnttda7v3XffPeVcX4XAEgUE7xLftRPe5oSvCytOeAc4kqE71HAkb6RhECCwHAEz3uW8V9229Lvvvpu+/vrrKT9W3XzzzVOuGnvsscemu+66a2ufv/766/TJJ59MP/7445Sv/k888cSUY6+ffvrpqt6dd945PfPMMxvbqOtmvfS3S/noo4+m1E1Jf/NzlXP128cff7xafvvtt0/PPffc9Pnnn085CyKXJGds2aY77rhjtc6m/0v7GUMuX862PfnkkyuXjDWltLuprr8R2EVA8O6idMTr5JzYcpluGWbCK0H88ssvr4Kq/L1+/PPPP1endpVzh/OYoEpIffvtt6tVs86msqluzs9NkJ5X0kc5m+Hhhx/+z+q5kKT0n9BMUJfAzMoJ4NR/5ZVXNh4jTv133nlnFdJZP+PK+k8//fS63XzIKAT2EXCoYR+9hdet742QoeT4aWasKX///fcqgHJhxqby2WefnblgIzPl1EnQnVc21U2d/P2Q5bfffluFbgK4LgnTBP2mkpluZsalXGRcpY5HAucJmPGeJ3TEy7/66qv16PKVPTPchGcuPc6sNLO/BNSmH7NyeKKUhx56aHrxxRdXgZW6rbAu6+9Tt7Sxy2O2I5dOZ2acEH7rrbfWHxblcMW8nXJ3tPw940r9GGQWrBA4lIAZ76EkF9ZOQimHE0rJIYLMeHOKVn01WL1OWTehXAfXU089taqbmWXCalvZp+62djcty3jK9uSYbv0Bkg+YeckHTX2RRkzyDSD15seS53W9JnARAcF7Ea0jWjdftxOCpdQ/pNXPczhiXlK3lART/VX+vOOf+9Qtfe76mA+RcugkdW655foXvE33sti2bflRTiFwKAHBeyjJhbWT2V1d6osR6ufz9VKn/lvCrA63/OK/rexTd1u7m5ZlxluX+et6WZ7Pt61ev/5wmdfzmsBFBc7umRetbf3FCtSz3QRMHZ514NRhVAZbf03Pj091qevWfy/P96lb2uj1uG3b5uPstQ3aPQ0BwXsa7/N/RlkH6jws69c5FlwHUhqqX9eBnWV13byel33qzts69OvLvG2HHqv2/l8Bwfv/+v9vvdczuPnxzvlZCfNwrevO152/ng9wn7rztg79uh7neeM4dN/aOy0BwXta7/d6tNt+aKqDOEE5n8XW4Vmvm8brWeO6s+rJPnWrZro8rbdtPo75OLtsgEZPRkDwnsxbfXag9Q9oWVIfeqifz9fLunVozwOqrpt152WfuvO2Dv263raMo571zsd56L61d1oCgve03u/1aHNf2/qrdX1ebn0K2aazFOowTiDVV3rVddedVU/2qVs10+VpHbwJ3Vx0UUr9vPzNI4EbFRC8Nyq38Ho5fFBfUJB7NqQkcOqLJsoFCPVwE9p1IJd/hidfx8t9Eur16+f71K3b6fE8F1nUHwzFISb11XatvvMB9OGHH64um67PGqnXz9WC7733XvOS5ay7yzp1m54vT+D6GeXL23ZbvEUgN76ZH5vNRQC5tLeURx55ZB2U+Y89wZGv2GX2m/qbgjf1869BfPHFF6umcn+GzHQzK6wvQij9zB/3qTtv6yKv6xl+q14+jMqHUO7bkDElRM+byae9BGq5gU/qvPDCC2e6yeXI77///upvCfXXX3/9zAdYFuyyzplGvVikgBnvIt+28zc6AZjQqP9XHxJICwmZOlhze8cSuln+7LPPrm6HmOfzkts4lmAvs+RcbrvpjmGHrDtv69CvM64S0BlXZvNxyYfUtpJ1S+hmvU1BnXbqUluXv++yTlnX43IFBO9y37u9tzwBk5vAJGzqX/RzOCCztfqeDfPOcllx1inHRdNWbutYB/m8Tnm9T93SRq/HXPIckzKufLjkXhQPPvjg1i7L+LNS6uQ+D/OSD6VyKCPfPjLzn5dd1pnX8Xp5AleuXr26+b5/yxuLLd5DIDO2zMASOAneXUupl+OjZQY8ou6ufdzoevNx5dj1u+++u2ou4Zz7+W4q+YaRcK0/yOr18mNkDkNsuxH7LuvUbXq+PAHHeJf3nnXZ4szY6pvj7NrJjdZL+/vU3XX7LrJefhwshwvyIVLfGCdBXMq2D5htgZr6CeRWKJf2d1mnrOtxmQKCd5nvm63uIJAfFnPP3lLeeOONdUjW5/GWwxBlPY8ELirgGO9Fxax/tAI5xFLPZsspZJntlucZfH0q3dFiGFhXATPerrwaX5pAfkQr5+/m9LCcMpezQerT5Orzn5c2Ptt7OQTMeC/H+2ArLolA/lXicuZBNimnd9Whm3+h+L777rskW2szlipgxrvUd852dxFI6L766qurfyI+FzPkLIUcWsgPj5npnnc+b5eN0ujRCQjeo3tLDWhfgfx49vzzz+/bjPoEmgIONTRpLCBAgEAfAcHbx1WrBAgQaAoI3iaNBQQIEOgjIHj7uGqVAAECTQHB26SxgAABAn0EBG8fV60SIECgKSB4mzQWECBAoI+A4O3jqlUCBAg0BQRvk8YCAgQI9BEQvH1ctUqAAIGmgOBt0lhAgACBPgKCt4+rVgkQINAUELxNGgsIECDQR0Dw9nHVKgECBJoCgrdJYwEBAgT6CAjePq5aJUCAQFNA8DZpLCBAgEAfAcHbx1WrBAgQaAoI3iaNBQQIEOgjIHj7uGqVAAECTQHB26SxgAABAn0EBG8fV60SIECgKSB4mzQWECBAoI+A4O3jqlUCBAg0BQRvk8YCAgQI9BEQvH1ctUqAAIGmgOBt0lhAgACBPgKCt4+rVgkQINAUELxNGgsIECDQR0Dw9nHVKgECBJoCgrdJYwEBAgT6CAjePq5aJUCAQFNA8DZpLCBAgEAfAcHbx1WrBAgQaAoI3iaNBQQIEOgjIHj7uGqVAAECTQHB26SxgAABAn0EBG8fV60SIECgKSB4mzQWECBAoI+A4O3jqlUCBAg0BQRvk8YCAgQI9BEQvH1ctUqAAIGmgOBt0lhAgACBPgKCt4+rVgkQINAUELxNGgsIECDQR0Dw9nHVKgECBJoCgrdJYwEBAgT6CAjePq5aJUCAQFNA8DZpLCBAgEAfAcHbx1WrBAgQaAoI3iaNBQQIEOgjIHj7uGqVAAECTQHB26SxgAABAn0EBG8fV60SIECgKSB4mzQWECBAoI/Av/GiZUpSApJ3AAAAAElFTkSuQmCC","iVBORw0KGgoAAAANSUhEUgAAAV4AAACWCAYAAACW5+B3AAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAMZklEQVR4Ae2dV4/UShBGveSccxTwwAMCHvj//2AfeSAIkBA55xyuPks91Pb1zs5iT+GqOS3da3umQ9Wp5nNPu9u7tLy8/LshQQACEICAG4ENbi3REAQgAAEItAQQXjoCBCAAAWcCCK8zcJqDAAQggPDSByAAAQg4E0B4nYHTHAQgAAGElz4AAQhAwJkAwusMnOYgAAEIILz0AQhAAALOBBBeZ+A0BwEIQADhpQ9AAAIQcCaA8DoDpzkIQAACCC99AAIQgIAzAYTXGTjNQQACEEB46QMQgAAEnAkgvM7AaQ4CEIAAwksfgAAEIOBMAOF1Bk5zEIAABBBe+gAEIAABZwIIrzNwmoMABCCA8NIHIAABCDgTQHidgdMcBCAAAYSXPgABCEDAmQDC6wyc5iAAAQggvPQBCEAAAs4EEF5n4DQHAQhAAOGlD0AAAhBwJoDwOgOnOQhAAAIIL30AAhCAgDMBhNcZOM1BAAIQQHjpAxCAAAScCSC8zsBpDgIQgADCSx+AAAQg4EwA4XUGTnMQgAAEEF76AAQgAAFnAgivM3CagwAEIIDw0gcgAAEIOBNAeJ2B0xwEIAABhJc+AAEIQMCZAMLrDJzmIAABCCC89AEIQAACzgQQXmfgNAcBCEAA4aUPQAACEHAmgPA6A6c5CEAAAggvfQACEICAMwGE1xk4zUEAAhBAeOkDEIAABJwJILzOwGkOAhCAAMJLH4AABCDgTADhdQZOcxCAAAQQXvoABCAAAWcCCK8zcJqDAAQggPDSByAAAQg4E0B4nYHTHAQgAAGElz4AAQhAwJkAwusMnOYgAAEIILz0AQhAAALOBBBeZ+A0BwEIQADhpQ9AAAIQcCawybk9moPAhMDXr1+bd+/etdebN29u9u3bN/mOEwhkJoDwZo7uyH379OlTc+/evdbKXbt2IbwjjxfmDUeAqYbhWFITBCAAgZkIMOKdCdP4Mv348aO5fv36xLALFy40u3fvnlxzAgEIjJcAwjve2Ey17Pfv3823b98meX79+jU5z3Ty9u3b5vnz5+1N5fDhw82GDfxIyxTfRfUF4V3UyAfwWzeWmzdvtpa+evWqPR49ejSA5ZgIgekEGD5M58O3/5DAx48fV7T+4cOHFddcQCAqAYQ3auQWwO69e/c2W7ZsaT1dWlpqNNVAgkAGAkw1ZIhiUh80n3vlypV2re/OnTsbrfUlQSADAYQ3QxQT+yDxZWNF4gAvqGtMNSxo4HEbAhD4dwQY8f479v+s5Tdv3jQvX75s9LBq48aNjXaNHTlypNmxY8dUmz5//tw8evSoef/+faOf/seOHWs09/r48eO23Pbt25tTp0511mHLKp/amyU9ePCgUVkltVevVdbut4cPH7bfb926tTlz5kzz9OnTRqsgtCVZvsmmbdu2tXm6/qf65YO2L8u248ePt1zkq1Kpt6ssn0HgbwggvH9DLXAZrYkt23SLGxIvCfHFixdboSqf2+P379/bpV1l7bCOEiqJ1OvXr9usytOVuspqfa6EdK2kNspqhoMHD/4vuzaSlPYlmhLqIpjKLAFW+UuXLnXOEav8rVu3WpFWfvml/CdPnpzUq5sMCQJDEmCqYUiaI6/LvhtBpmr+VCNWpZ8/f7YCpI0ZXenJkycrNmxopKwyErq1UldZldHnQ6YvX760oisBtkliKqHvShrpamRc0nr8KmU4QmC9BBjxrpdY4PwvXryYWK+f7BrhSjy19VijUo3+JFBdD7M0PVHSgQMHmvPnz7eCpbKriXXJ36dsqWOWo+zQ1mmNjCXCN27cmNwsynRFXU95O5o+l18qLwYaBZMgMC8CjHjnRXZk9UqUNJ1QkqYINOLVEi27G8zmKXklyla4Tpw40ZbVyFJiNS31KTut3q7v5E+xR3O69gaiG0yddKOxmzTERL8AVK6eS67Lcg2BPgQQ3j70ApXVz22JYEn2QZo913REnVS2JAmT/Sm/1vxnn7KlzVmPuomUqROV2bTpzw+6rndZTLNND+VIEJgXAYR3XmRHVq9GdzbZzQj2vM6nMvYziZkVNz3xn5b6lJ1Wb9d3GvHaVF/b73Re22bz25tLXY5rCPQlsLKn9q2N8qMlYEe7EhgrnlZwrBgVZ+zPdD18ssmWtZ+X8z5lSx3zOk6zrfZzXjZQ72ISQHgXJO5WUGuxtNeaC7aCJDz22gq2vrNldV2nPmXruoa+HrNtQ/tKfeMigPCOKx5zs8aO4Or5znpVQi2utmydt76uHehTtq5r6Gvr51p+DN029S02AYR3QeI/7UGTFWIJZT2KteJp8wqdHTV2oexTtqu+IT+zttV+1H4O2S51QQDhXZA+YB+gyWU79WDP63zKa0W7FihbVnnr1KdsXdfQ19Y2+WFHvbWfQ7dNfYtNAOFdkPjrvbb2p7Vdl2uXkHWtUrBiLEGyO71s2S6Ufcp21TfkZ1Z4JbradFGSPS+fcYTAUAQQ3qFIjrweTR/YDQV6Z4OSBMdumigbEKw7Em0ryOXP8OjneHlPgs1vz/uUtfXM41ybLOyNoXAQE7vbbrW2dQO6f/9+u23arhqx+bVb8M6dO6tuWVbeofLYdjkfN4E/K8zHbSfWrUFAL76p52a1CUBbe0s6dOjQRCj1j13CoZ/YZfSr8l3Cq/L6axDPnj1rq9L7GTTS1ajQbkIo7dTHPmXrutZzbUf4q5XTzajchPTeBvkkEV1rJK/6JKjlBT4qc+7cuRXNaDvy3bt3288k6levXl1xA9MXQ+VZ0TAXoyfAiHf0IZrNQAmgRMP+Z6cEVItExgqrXu9YRFffnz59un0dos7rpNc4FmEvo2Rtt+16Y9iQZeu6hr6WX0Wg5ZdG8+Kim9S0pLxFdJWvS6hVj02Wdfl8qDylPo4xCCC8MeI0iJUSGL0ERmJjn+hrOkCjNfvOhrpBbStWnjIvqrr0Wkcr5HWZct2nbKljXkdteRaT4pduLnoXxf79+6c2WfxXJpXRex7qpJtSmcrQrw+N/Os0VJ66Xq7HTWBpeXm5+z2A47Yb63oS0IhNIzAJjoR31lTKaX60jIA9ys7axt/mq/3S3PXt27fb6iTOep9vV9IvDImrvZHZfHoYqWmIaS9iHyqPbZfzcRNgjnfc8ZmbdRqx2ZfjzNrQ35ZT/X3KzmrfevLp4WCZLtBNxL4YR0Jc0rQbzDRBVXkJ8mqiXOofKk+pj+P4CSC8448RFs6JgB4s6p29JV27dm0iknYdb5mGKPk4QqAvAeZ4+xKkfFgCmmKxo9myhEyj3XIu5+xSurDOYvioCDDiHVU4MMabgB6ilfW7Wh6mJXNaDWKXydn1z9720V5OAox4c8YVr2YkoL9KXFYeqIiWd1nR1V8o3rNnz4y1kQ0CsxFgxDsbJ3IlJSDRvXz5cvsn4rWZQasUNLWgB48a6a61njcpFtyaMwGEd86AqX78BPTw7OzZs+M3FAvTEGCqIU0ocQQCEIhCAOGNEinshAAE0hBAeNOEEkcgAIEoBBDeKJHCTghAIA0BhDdNKHEEAhCIQgDhjRIp7IQABNIQQHjThBJHIACBKAQQ3iiRwk4IQCANAYQ3TShxBAIQiEIA4Y0SKeyEAATSEEB404QSRyAAgSgEEN4okcJOCEAgDQGEN00ocQQCEIhCAOGNEinshAAE0hBAeNOEEkcgAIEoBBDeKJHCTghAIA0BhDdNKHEEAhCIQgDhjRIp7IQABNIQQHjThBJHIACBKAQQ3iiRwk4IQCANAYQ3TShxBAIQiEIA4Y0SKeyEAATSEEB404QSRyAAgSgEEN4okcJOCEAgDQGEN00ocQQCEIhCAOGNEinshAAE0hBAeNOEEkcgAIEoBBDeKJHCTghAIA0BhDdNKHEEAhCIQgDhjRIp7IQABNIQQHjThBJHIACBKAQQ3iiRwk4IQCANAYQ3TShxBAIQiEIA4Y0SKeyEAATSEEB404QSRyAAgSgEEN4okcJOCEAgDQGEN00ocQQCEIhCAOGNEinshAAE0hBAeNOEEkcgAIEoBBDeKJHCTghAIA0BhDdNKHEEAhCIQgDhjRIp7IQABNIQQHjThBJHIACBKAQQ3iiRwk4IQCANAYQ3TShxBAIQiEIA4Y0SKeyEAATSEEB404QSRyAAgSgEEN4okcJOCEAgDQGEN00ocQQCEIhCAOGNEinshAAE0hBAeNOEEkcgAIEoBBDeKJHCTghAIA0BhDdNKHEEAhCIQgDhjRIp7IQABNIQQHjThBJHIACBKAT+A2KYgrpeQSSvAAAAAElFTkSuQmCC"],defaultImg="iVBORw0KGgoAAAANSUhEUgAAAV4AAACqCAYAAADlXyehAAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAOU0lEQVR4Ae2d567bSAxGld57770iCYK8/yPcf+kJ0pDee2+7nxb00rrWdYlN05MzQFayPBLJw/HnETW+u2hubu53RYMABCAAgTACi8MsYQgCEIAABGoCCC8DAQIQgEAwAYQ3GDjmIAABCCC8jAEIQAACwQQQ3mDgmIMABCCA8DIGIAABCAQTQHiDgWMOAhCAAMLLGIAABCAQTADhDQaOOQhAAAIIL2MAAhCAQDABhDcYOOYgAAEIILyMAQhAAALBBBDeYOCYgwAEIIDwMgYgAAEIBBNAeIOBYw4CEIAAwssYgAAEIBBMAOENBo45CEAAAggvYwACEIBAMAGENxg45iAAAQggvIwBCEAAAsEEEN5g4JiDAAQggPAyBiAAAQgEE0B4g4FjDgIQgADCyxiAAAQgEEwA4Q0GjjkIQAACCC9jAAIQgEAwAYQ3GDjmIAABCCC8jAEIQAACwQQQ3mDgmIMABCCA8DIGIAABCAQTQHiDgWMOAhCAAMLLGIAABCAQTADhDQaOOQhAAAIIL2MAAhCAQDABhDcYOOYgAAEIILyMAQhAAALBBBDeYOCYgwAEIIDwMgYgAAEIBBNAeIOBYw4CEIAAwssYgAAEIBBMAOENBo45CEAAAggvYwACEIBAMAGENxg45iAAAQggvIwBCEAAAsEEEN5g4JiDAAQggPAyBiAAAQgEE0B4g4FjDgIQgADCyxiAAAQgEEwA4Q0GjjkIQAACCC9jAAIQgEAwAYQ3GDjmIAABCCC8jAEIQAACwQQQ3mDgmIMABCCA8DIGIAABCAQTQHiDgWMOAhCAAMLLGIAABCAQTADhDQaOOQhAAAIIL2MAAhCAQDABhDcYOOYgAAEIILyMAQhAAALBBBDeYOCYgwAEIIDwMgYgAAEIBBNAeIOBYw4CEIAAwssYgAAEIBBMAOENBo45CEAAAggvYwACEIBAMAGENxg45iAAAQggvIwBCEAAAsEEEN5g4JiDAAQggPAyBiAAAQgEE0B4g4FjDgIQgADCyxiAAAQgEExgabA9zDkCnz9/rh4/flx9+vSp+vXrV7Vu3bpq/fr11caNG6slS5a4nuwOSsCY+v7Lly+vVq9eXXNdvJi5hmfD/nQIILzT4V69fPmyunPnTi245sKXL1+q58+fV8ePH69Fwo6zHZzA9+/fqxcvXvQ8YdWqVdXRo0crbWkQmCYBvv6nQF/i0BTdZcuWVYsWLZqCN+Wa1F2DuFrTbPjWrVv2ki0EpkaAGe8U0Ku8oNKC2tKlS+sZ7tq1a6vfv3/XszUda7b379/XJQkd37x5c5egNPvy+j8CmzZtqg4fPly9ffu2unnzZs1cZZ03b95wR8EgmSqB+Z/wqbrzdxjXh9/atm3bKomumma8et2rqTTx7Nmz+q01a9YgvL0gtRzbsGFDzfXp06d1jw8fPiC8Law4HEOAUkMM5y4rquVa27Jli+2ynSAB+3KTiW/fvk3QEpeGQH8CCG9/RmPv4euOP3/+HPv1ueB8Ap75jx8/5nfgCAQCCVBqCIRtpjT7+vjxY/1S9UctI2trqvtqhuwF+uvXr3WpYcWKFV2nqZ/6q2SxcuXK+px3797VpQwvPHaSrqnbblvK1qu2bH211bXVX+dp2Zvs2Oxdy7Sa/uicpk+ypXq1zlXc2qrZcV1bpZRe16o7jvgfL7YLLdUbNkZdVw9L1cRYDJUfcdLqCf2zGL3ro57nrzFM/pp50LkLjQ1vh/3xE0B4x8+07xUlLNaePHlSqdzQtsRJt8UXL1607vVWT+YlWqdOneo6fuXKlUofaK1bPXHiRKXX+oCdPXt2Xk1YS65u377ddf7evXur3bt3dx2zFxJGXc/q0xIY2bh8+XLdpZc/eqPp09WrV2sf9Z78PHPmTC3O165d6zxwlFAdPHiwtd6tc4dtWtFgrU3UR4lRtfd79+7Vlz506FD9peKXs6lmr+PNNup5dp1h89fMw0Jjw2ywnRwBSg2TY9t6Zf1AQqKjpg/7jRs3xlp3tGtKdHs1PdVviq76PXjwoF5H3Ouc+/fvd0RX70vgtVJg0GY+6Txr+lLRl4itOLDjmnVKzHTOOJpme/ZgUtfTaode7U9j1GoVL7qyoXXZmlku1IY9b5T8mX3LQ9vYsH5sJ0sA4Z0s355X12xRC/ntFlS3ptevX+/csvqTJNAXLlzomv1ppqkfWbQ1iZtEbfv27dWBAwfmzXbt6b5uuTUbPnfuXH2LrOtpBt6rvXr1qnNYM+OTJ092Xg+yI59U/tAsff/+/Z1TVGoRj2PHjtW+2i/LJBBWxuh0HnJHgqeZne4YrBwg3/0dh7/kOGI8ffp0HaO/g7Gykrfl98VmmPNGyZ/Z6zc2rB/byRJAeCfLt/XqqvN68dWtcHPmp5MlzhImE2kdk2AuVKdUH93e6nZ9x44dHVHVcX3wbAam9cASCAmira6QH/62XOeovGDCpZ/eqhyhGm9bWULn9GpHjhypSyQ7d+7squHu2bOnnoXKV13Xmnz9k6YvH9VaNYNWk/02n8cR49atW+t6usouitFavziGOW+U/Jkftm0bG/Y+28kTQHgnz7jVgi3wtw4SiXH9skqi2qtJYEyIJKLW/CxQD79804zcml+W5fft/batvjz0z5qVWvTa7/d6CGjnDLuVPX9tsVU5oVcbR4y+duzt9iuZDHPeKPlrxts2Npr9eD05Agjv5NgOdGXNNFUOsPb69et5dUJ7b9CtBMdu2Zvn+NmX+qnWp39+Bu376Hz/2gujF4ymnebrpj/+ddt+8xrDvlYt/fz58/VtvPmteqrqrs027hj9HUrTVvO1j7/fed7PQfPn7S00Nnw/9idL4P8pyGTtcPUFCOgWW7f39gBINTzdfo7a/Ae5eQ0rGeh42+za91E//yDGX9vvq1/Wppm5Sgy2+kDC2/yF4KzE6HMzaP58XmYlZ97nEveZ8SbJqh76WNPtZL/bU+s77NYLjGZXvf75Prq+98V/cPvNzob1bZL9fVlEfJttVmL0uemVOx3zfZpx8joHAWa8OfJQ1z/1oEszX9VgJQ5eLMblpi8paCWBbsf7NX+OFyirFfc7P8P7VmqQL4pB//yXyKzE6P0cNH8Z+ONDNwGEt5vHVF/pgYytKNAT+Uk0L0B+ZiQRtdtYCZJqgdb8vhdef771zbr1vtpM0fs6KzGOkj8fJ/s5CPz/6crhz1/rhQTNrybQEq9JNC8w/km+BP/SpUu1yX379lW7du3qmPezLH/On66z7RgI2PG+6qFgs0wyKzGOkr8AvJgYkgA13iGBjaO7ygh6kOZv1fXAx2aTEoVJCa+WkJno2HpexeQX+fvF/3rPLzXz62L9F4X6ZW1aCfDo0aOOe8349Ma4YzTGHaMD7vQ7b5T8DWiaboEEmPEGwjZTuu29e/du9fDhw/oDL2GQoFnTKgdff7Tj49hqxqS6rpatSXglSCpxyBc12W3WlnV7a/VnzRz1f89QHy9m4/Bt3NfQF4N+ESi2vtTgZ/Nmc1ZiHCV/FiPbPASY8U4xF6qp6nf3XnR1G6xfck2y6VdVNrPS32fQ322wmrJEyd/Omh9++ZX+HoG+OPQLrcxNZRH9JNmLrr7Uml8sFsOsxDhK/ixGtjkIILxTyINmj/o7CiZ+ckH7+jGF/lqXrzdOwj0Jpv7Wg/91lexL8Nt+UqsPu19brFveg//+JHkWmuLU/4XC/h5Em8+zEuMo+WuLmePTIbBobm7uvx+yT8f+X21VMzF76CMxnlR5YSHImnWr1KGasv8iaDtHfeX3ML9aa7tW1uOzFOOw+cvK/G/zixrvFDOuma1/qDMNV1Tb9EuU+vmgMkSvUkS/82bp/VmKcdj8zVIeSvaVUkPJ2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQCCG/J2SU2CEAgJQGEN2VacAoCECiZAMJbcnaJDQIQSEkA4U2ZFpyCAARKJoDwlpxdYoMABFISQHhTpgWnIACBkgkgvCVnl9ggAIGUBBDelGnBKQhAoGQC/wCwF1znWrp3KAAAAABJRU5ErkJggg==",counter=0;
scope.$watch("link",function(newVal,oldVal){newVal&&loadImage()})}}}]).directive("perfectScroll",["$timeout",function($timeout){return{restrict:"A",link:function(scope,iElement,iAttrs){function checkForTypeaHead(event){var _event=$(event.target);if(_event&&_event.parent()){var _parent=_event.parent();if(!_parent.hasClass("ui-autocomplete")){var _contextRefs=$(".contextTypeaheadDropdown :visible");if(_contextRefs&&_contextRefs.length){var _autoEle=$("[context-typeahead]");_autoEle&&_autoEle.length&&_autoEle.each(function(index,ele){$(ele).autocomplete&&$(ele).autocomplete("close")})}_contextRefs=null}}}function onMouseWheel(event){checkForTypeaHead(event)}function onScroll(event){checkForTypeaHead(event)}iAttrs.isnotpropogatewheel?!1:!0;$timeout(function(){$(window).width()>=600&&PerfectScrollbar.initialize(iElement[0],{wheelSpeed:2,wheelPropagation:!1,minScrollbarLength:25})}),scope.updatePerfectScrollbar=function(ele){$(window).width()>=600&&PerfectScrollbar.update(ele[0])},$(iElement).bind("mousewheel",onMouseWheel),$(iElement).bind("scroll",onScroll),scope.$on("$destroy",function(){$(iElement).unbind("mousewheel",onMouseWheel),$(iElement).unbind("scroll",onScroll),PerfectScrollbar.destroy(iElement[0])})}}}]).directive("perfectScrollPropagate",["$timeout",function($timeout){return{restrict:"A",link:function(scope,iElement,iAttrs){$timeout(function(){PerfectScrollbar.initialize(iElement[0],{wheelSpeed:2,wheelPropagation:!1,minScrollbarLength:25})}),scope.$watch(function(){PerfectScrollbar.update(iElement[0])})}}}]).directive("nestedAlertFields",["$compile",function($compile){return{restrict:"A",scope:!0,link:function(scope,ele,iAttrs){var html='<alert-field-form nested=true set-field-data="nestedFormField"on-cancel="nestedFormCancel({fieldForm : false})"  on-save="nestedFormSave(alertFieldDef,showIt)"wf-type="{{wfType}}"></alert-field-form>';$(ele[0]).html($compile(html)(scope))}}}]).directive("nestedSoapForm",["$compile",function($compile){return{restrict:"A",scope:!0,link:function(scope,ele,iAttrs){var html='<soap-alert-field set-field-data="nestedFormField"on-cancel="nestedFormCancel({fieldForm : false})"  on-save="nestedFormSave(alertFieldDef,showIt)"wf-type="{{wfType}}"></soap-alert-field>';$(ele[0]).html($compile(html)(scope))}}}]).directive("hasFocus",["$timeout",function($timeout){return{restrict:"A",link:function(scope,iElement,iAttrs){function handleEnter(e){switch(e.keyCode){case 13:$(iElement[0]).trigger("click")}}$(iElement[0]).keyup(function(e){handleEnter(e)})}}}]).directive("hightlight",["textparser",function(textparser){return{restrict:"EA",require:"^ngModel",link:function(scope,ele,attrs,ngModelCtrl){ngModelCtrl.$formatters.push(function(newVal){return newVal&&-1!==newVal.indexOf("&lt;%=")&&-1!==newVal.indexOf("%&gt;")?textparser.parse(newVal):newVal&&-1!==newVal.indexOf("&lt;%")&&-1!==newVal.indexOf("%&gt;")?textparser.parse(newVal):newVal&&-1!==newVal.indexOf("<%=")&&-1!==newVal.indexOf("%>")?textparser.parse(newVal):newVal&&-1!==newVal.indexOf("<%")&&-1!==newVal.indexOf("%>")?textparser.parse(newVal):newVal})}}}]).directive("errorAlert",["$compile",function($compile){return{restrict:"A",link:function(scope,ele,attrs){var contents=$(ele[0]).html()&&$(ele[0]).html().trim()||$(ele[0]).text()&&$(ele[0]).text().trim(),html='<div class="alert alert-danger alert-xs" role="alert" style="overflow:hidden;"><div><span><i class="fa fa-info-circle"></i>&nbsp;&nbsp;</span><span>'+contents+"</span></div></div>";$(ele[0]).html($compile(html)(scope))}}}]).directive("showItCodeView",["textparser",function(textparser){return{restrict:"EA",require:"^ngModel",link:function(scope,iElement,iAttrs,ngModelCtrl){ngModelCtrl.$formatters.push(function(value){return textparser.reWrap(value)})}}}]).directive("focusIt",[function(){return{restrict:"A",link:function(scope,iElement,iAttrs){$(iElement[0]).focus()}}}]).directive("copyToClipboard",[function(){return{restrict:"A",scope:{host:"@?"},link:function($scope,$ele,$attrs){function select_all(obj){var text_val=eval(obj);text_val.focus(),text_val.select(),r=text_val.createTextRange(),console.log(r),r.execCommand("copy")}$ele.on("click",function(){select_all($($scope.host)[0])})}}}]).directive("removeAttr",[function(){return{restrict:"A",scope:{prop:"=",activate:"@"},link:function(scope,iElement,iAttrs){var href=iAttrs.href,toggle=iAttrs.toggle;scope.$watch("prop",function(newVal){newVal===!0?iAttrs.$set("href","#dummy"):(iAttrs.$set("href",href),iAttrs.$set("toggle",toggle))})}}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("progressDock",function(){return{restrict:"EA",scope:{bridge:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/Progress-Dock/progress-dock.html",controller:["$scope","$timeout","NotificationService","BTStreamsService","$workflowService","$rootScope","$window","env_conf","_constants_","i18n",function($scope,$timeout,NotificationService,BTStreamsService,$workflowService,$rootScope,$window,env_conf,_constants_,i18n){function startTimer(){timer||(timer=setInterval(function(){$scope.progressDockNotification()},3e3))}var timer;$scope.assetsBase=env_conf["assets-url"],$scope.grayCircle=$scope.assetsBase+"progressIcons/grayCircle.svg",$scope.whiteCircle=$scope.assetsBase+"progressIcons/whiteCircle.svg",$scope.progressClose=$scope.assetsBase+"progressIcons/progressClose.svg",$scope.progressFailed=$scope.assetsBase+"progressIcons/progressFailed.svg",$scope.progressSucess=$scope.assetsBase+"progressIcons/progressSucess.svg",$scope.reloadIcon=env_conf["context-url"]+"/assets/icons-new/loader/loader.svg",$scope.redDot=$scope.assetsBase+"progressIcons/redDot.svg",$scope.progressClockIcon=$scope.assetsBase+"progressIcons/progressClockIcon.svg",$scope.trainingProgressIcon=$scope.assetsBase+"progressIcons/trainingProgressIcon.svg",$scope.dataIsInProgress=!1,$scope._constants_=_constants_,$scope.dataTrain=!1,$scope.progressHoverEnter=function(e){e.preventDefault(),e.stopImmediatePropagation()},$scope.stopPropagation=function(e){e.stopImmediatePropagation()};var groupByEngine=function(docData){var trainJobs=_.filter(docData,{action:"TRAIN"});$scope.failedJobs=_.filter(trainJobs,{status:"FAILURE"}),$scope.mlTrainJobsConfigured=_.filter(docData,{jobType:"CONFIGURED_BOT"}),$scope.mlTrainJobsPublished=_.filter(docData,{jobType:"PUBLISHED_BOT"}),$scope.kgTrainJobsPublished=_.filter(docData,{jobType:"PUBLISHED_KNOWLEDGEGRAPH"}),$scope.kgTrainJobsConfigured=_.filter(docData,{jobType:"CONFIGURED_KNOWLEDGEGRAPH"})};$scope.progressDockNotification=function(){setTimeout(function(){$rootScope.$emit("pefectScrollUpdate")},700),$scope.dataIsInProgress=!1,$scope.failedDockstatus=!1,$workflowService.selectedStream()._id&&BTStreamsService.getAllProgressDockNotifications($workflowService.selectedStream()._id).then(function(res){function checkForAnlaytics(){$scope.progressDockData&&$scope.progressDockData.length&&$scope.progressDockData.forEach(function(data,index){("SUCCESSINTENT_API"===data.jobType||"FAILINTENT_API"===data.jobType||"FAILTASK_API"===data.jobType||"PERFORMANCE_API"===data.jobType||"PINNED_API"===data.jobType)&&($scope.progressDockData.splice(index,1),checkForAnlaytics())})}res.data=_.reject(res.data,function(ele){return"CUSTOM_DASHBOARD_WIDGET"===ele.jobType||"TASKANALYSIS_API"===ele.jobType||"INTENT_API"===ele.jobType||"STATS_API"===ele.jobType||"CONVERSATIONGRAPH_API"===ele.jobType||"INSIGHTS_API"===ele.jobType}),$scope.progressDockData=res.data,groupByEngine(res.data),$scope.nullCheck();for(var i=0;i<res.data.length;i++)"IN_PROGRESS"===res.data[i].status&&($scope.dataIsInProgress=!0),("PUBLISHED_BOT"===res.data[i].jobType||"CONFIGURED_BOT"===res.data[i].jobType||"PUBLISHED_KNOWLEDGEGRAPH"===res.data[i].jobType||"CONFIGURED_KNOWLEDGEGRAPH"===res.data[i].jobType)&&($scope.dataTrain=!0),"ONTOLOGY_REPORT"!==res.data[i].jobType||"IN_PROGRESS"!==res.data[i].status&&"QUEUED"!==res.data[i].status||($workflowService.ontologyJobStatus(res.data[i]),$scope.dataIsInProgress=!0),"ONTOLOGY_REPORT"===res.data[i].jobType&&"FAILED"===res.data[i].status&&($workflowService.ontologyJobStatus(res.data[i]),$scope.failedDockstatus=!0),"CREATE_VERSION"!==res.data[i].jobType||"VERSIONING"!==res.data[i].action||"IN_PROGRESS"!==res.data[i].status&&"QUEUED"!==res.data[i].status||($scope.dataIsInProgress=!0,$workflowService.createVersionStatus(res.data[i])),"CREATE_VERSION"===res.data[i].jobType&&"VERSIONING"===res.data[i].action&&"FAILURE"===res.data[i].status&&($scope.failedDockstatus=!0,$workflowService.createVersionStatus(res.data[i]),$scope.bridge.createVersionStatus(res.data[i])),"PUBLISHED_KNOWLEDGEGRAPH"!==res.data[i].jobType&&"CONFIGURED_KNOWLEDGEGRAPH"!==res.data[i].jobType||"TRAIN"!==res.data[i].action||"IN_PROGRESS"!==res.data[i].status||($scope.dataIsInProgress=!0,$workflowService.kgTrainingStatus(res.data[i])),"PUBLISHED_KNOWLEDGEGRAPH"!==res.data[i].jobType&&"CONFIGURED_KNOWLEDGEGRAPH"!==res.data[i].jobType||"TRAIN"!==res.data[i].action||"FAILURE"!==res.data[i].status||($scope.failedDockstatus=!0,$workflowService.kgTrainingStatus(res.data[i])),"FAILURE"===res.data[i].status&&($scope.failedDockstatus=!0),"CONVERSATION_TESTING"===res.data[i].jobType&&$rootScope.$emit("onDockStatus",res.data[i]),"PUBLISH_BOT"===res.data[i].jobType&&$rootScope.$emit("publishBotStatus",res.data[i]),"SESSIONFLOW_API"===res.data[i].jobType&&$rootScope.$emit("onDockStatus",res.data[i]),("DASHBOARDREPORT_API"===res.data[i].jobType||"CHATSDASHBOARDREPORT_API"===res.data[i].jobType||"ENTERPRISEACTIONREPORT_API"===res.data[i].jobType||"CHANNELREPORT_API"===res.data[i].jobType||"ENTERPRISEDASHBOARDREPORT_API"===res.data[i].jobType||"SESSIONCOUNTFORCHART_API"===res.data[i].jobType||"AGENTTRANSFERREPORT_API"===res.data[i].jobType)&&$rootScope.$emit("usageMetricsStatus",res.data[i],res.data[i].jobType),"SUCCESSINTENT_API"===res.data[i].jobType&&$rootScope.$emit("onDockStatusIntent",res.data[i]),"FAILINTENT_API"===res.data[i].jobType&&$rootScope.$emit("onDockStatusIntentNot",res.data[i]),"FAILTASK_API"===res.data[i].jobType&&$rootScope.$emit("onDockStatusFailTask",res.data[i]),"PERFORMANCE_API"===res.data[i].jobType&&$rootScope.$emit("onDockStatusPerformance",res.data[i]),"PINNED_API"===res.data[i].jobType&&$rootScope.$emit("onDockStatusPinned",res.data[i]);if($scope.dataIsInProgress||clearInterval(timer),$scope.progressDockData.forEach(function(data,index){"EXPORT"===data.action&&"SUCCESS"===data.status&&data.store&&!data.store.toastSeen?("KNOWLEDGE_EXTRACTION"!==data.jobType&&"EXPORT_WIDGET_CSV"!==data.jobType&&(NotificationService.notify(i18n.i18nString("file_downloading",{dyn:$scope.getDockType(data.jobType)}),"success"),$timeout(function(){$("#"+data._id).find(".downloadExportFile").click()},500)),$scope.updateProgressDockNotification(data)):"BATCH_TESTING"===data.jobType&&"TRAIN"===data.action&&"SUCCESS"===data.status&&data.store&&!data.store.toastSeen?(NotificationService.notify(i18n.i18nString("data_training",{dyn:data.jobType.toLocaleLowerCase()}),"success"),$scope.updateProgressDockNotification(data)):"ONTOLOGY_REPORT"===data.jobType&&"SUCCESS"===data.status&&data.store&&!data.store.toastSeen?(NotificationService.notify(i18n.i18nString("kg_completed"),"success"),$workflowService.ontologyJobStatus(data),$workflowService.setCurrentDockId(data._id),$scope.updateProgressDockNotification(data),$scope.bridge.callAnalysisReport(data._id,data.status.toLowerCase())):"CREATE_VERSION"===data.jobType&&"VERSIONING"===data.action&&"success"===data.status.toLowerCase()&&data.store&&!data.store.toastSeen?(data&&data.store&&data.store.name&&NotificationService.notify("New Bot Version "+data.store.name+" is created.","success"),$workflowService.createVersionStatus(data),$scope.updateProgressDockNotification(data),$scope.bridge.createVersionStatus(data)):"PUBLISHED_KNOWLEDGEGRAPH"!==data.jobType&&"CONFIGURED_KNOWLEDGEGRAPH"!==data.jobType||"TRAIN"!==data.action||"success"!==data.status.toLowerCase()&&"failure"!==data.status.toLowerCase()||!data.store||data.store.toastSeen?"CLUSTERING"===data.action&&"SUCCESS"===data.status?$rootScope.$emit("scheduleClusterDone"):"CLUSTERING"===data.action&&"FAILURE"===data.status?$rootScope.$emit("scheduleClusterFailed"):"KFOLD_TRAIN"===data.action&&"FAILURE"===data.status?$rootScope.$emit("kfoldTrainingFailed",data):"KFOLD_TRAIN"===data.action&&"SUCCESS"===data.status?$rootScope.$emit("kfoldTrainingSuccess",data):"CONVERSATIONAL_TEST_EXPORT"===data.jobType&&"SUCCESS"===data.status&&data.store&&!data.store.toastSeen?(NotificationService.notify(i18n.i18nString("file_downloading",{dyn:$scope.getDockType(data.jobType)}),"success"),$timeout(function(){$("#"+data._id).find(".downloadExportFile").click()},500)):"QUERY"===data.action&&checkForAnlaytics():($workflowService.kgTrainingStatus(data),$scope.updateProgressDockNotification(data),$scope.bridge.kgTrainingStatus(data))}),res.data&&res.data.store&&res.data.store.timeoutMessage){var msg=res.data.store.timeoutMessage;NotificationService.notify(msg,"warning")}$scope.progressDockDataCopy=_.filter($scope.progressDockData,function(data){return"TRAIN"!==data.action?data:void 0})})},$scope.nullCheck=function(){$scope.lengthCheck=_.filter($scope.progressDockData,function(data){return"TRAIN"===data.action?data:void 0}),$scope.progressDockData&&0===$scope.progressDockData.length&&(NotificationService.notify(i18n.i18nString("no_active_jobs"),"success"),$(".dropdown.trainingProgress").removeClass("open"))},$scope.clearAllprogressDockAllNotifications=function(e){BTStreamsService.deleteProgressDockAllNotifications($workflowService.selectedStream()._id).then(function(res){BTStreamsService.getAllProgressDockNotifications($workflowService.selectedStream()._id).then(function(res){$scope.progressDockData=res.data,$scope.progressDockDataCopy=_.filter($scope.progressDockData,function(data){return"TRAIN"!==data.action?data:void 0})})})},$scope.clearProgressDockNotifications=function(notification){BTStreamsService.deleteProgressDockNotification($workflowService.selectedStream()._id,notification._id).then(function(res){if(res&&res.data){res.data.message;$scope.progressDockNotification()}})},$scope.updateProgressDockNotification=function(data){var payload={store:{toastSeen:!0,urlParams:data.store.urlParams}};BTStreamsService.updateProgressDockNotification($workflowService.selectedStream()._id,data._id,payload).then(function(res){console.log("toastseen")})},$scope.exportKfoldData=function(data,index,evt){function startKfoldExport(){BTStreamsService.mlKfoldScoreDownload($workflowService.selectedStream()._id).then(function(res){if(res&&res.data){$scope.hrefURL=res.data.fileUrl+"&clientfilename=Kfold_"+($workflowService.selectedStream().name||"Kfold_Data")+"_"+moment().format("YYYYMMDDHHmmSS")+".csv&batchtesting=true";var xyz="#index"+index;$(xyz).attr("href",$scope.hrefURL),$timeout(function(){$(xyz).get(0).click(function(e){e.preventDefault()})},750)}},function(err){err.data&&err.data.errors&&err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("prblm_in_fectching_kFold"),"error")})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}evt.preventDefault(),$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startKfoldExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export")):startKfoldExport()},$scope.downloadFile=function(data,index,evt){function startExport(){evt.preventDefault(),data.store&&data.store.urlParams?$scope.url=data.store.urlParams:$scope.url="&clientfilename="+$workflowService.selectedStream().name+"_"+data.action+".csv",BTStreamsService.downloadProgressDockExportFile(data.fileId).then(function(res){if(res&&res.data){$scope.hrefURL=res.data.fileUrl+$scope.url;var xyz="#index"+index;$(xyz).attr("href",$scope.hrefURL),$timeout(function(){$(xyz).get(0).click(function(e){e.preventDefault()})},750)}})}function cancleExport(){}function checkBoxCb(checkValue){$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps&&evt.originalEvent?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("download")):"ML_KFOLD"===data.jobType?$scope.exportKfoldData(index):startExport()},$scope.getDockType=function(jobType,data){var dockJobTypeName;return dockJobTypeName="BOT"==jobType?i18n.i18nString("bot_export"):"CONFIGURED_BOT"==jobType?i18n.i18nString("configuredModel"):"PUBLISHED_BOT"==jobType?i18n.i18nString("publishedModel"):"ML_UTTERANCE"==jobType?i18n.i18nString("mlUtteranceExport"):"ANALYSE"==jobType?i18n.i18nString("analyseExport"):"DEBUGLOGS_EXPORT"==jobType?i18n.i18nString("debuglogExport"):"KNOWLEDGE_GRAPH"==jobType?i18n.i18nString("kgTraining"):"BATCH_TESTING"==jobType?i18n.i18nString("batchTestingExecution"):"BOT_VARIABLE"==jobType?i18n.i18nString("botVariablesExport"):"KNOWLEDGE_EXTRACTION"==jobType?i18n.i18nString("kgExtractionExport"):"KG_EXPORT"==jobType?i18n.i18nString("kgGraphExport"):"CF_UTTERANCE"===jobType?i18n.i18nString("conversationFlowUtterance"):"SMALLTALK_EXPORT"==jobType?i18n.i18nString("smalltalkExport"):"SCENE_EXPORT"==jobType?i18n.i18nString("sceneExport"):"ONTOLOGY_REPORT"===jobType?i18n.i18nString("kgInspectReport"):"ONTOLOGY_EXPORT"===jobType?i18n.i18nString("kgInspectExport"):"RG_UTTERANCES"===jobType?i18n.i18nString("reGroupofUtterances"):"CREATE_VERSION"===jobType?i18n.i18nString("createVersion"):"CHANGE_LOGS"===jobType?i18n.i18nString("changelogs"):"KNOWLEDGE_GRAPH"===jobType?i18n.i18nString("knowledge_graph"):"PUBLISHED_KNOWLEDGEGRAPH"===jobType?i18n.i18nString("publishedModel"):"CONFIGURED_KNOWLEDGEGRAPH"===jobType?i18n.i18nString("configuredModel"):"EXPORT_VERSION"===jobType?i18n.i18nString("bot_export_version"):"ML_KFOLD"===jobType?i18n.i18nString("kfold_training"):"EXPORT_WIDGET_CSV"===jobType?i18n.i18nString("widgetCsvExport"):"CONVERSATIONAL_TEST_EXPORT"===jobType?i18n.i18nString("conversationTestExport"):"CONVERSATION_TESTING"===jobType?!data||"100"!==data.percentageComplete&&"SUCCESS"!==data.status||"RUN"!==data.action?data&&"FAILURE"===data.status&&"RUN"===data.action?i18n.i18nString("conversTestingFailed"):i18n.i18nString("convTestingInprogress"):i18n.i18nString("conversTestingComplete"):"PUBLISH_BOT"===jobType?i18n.i18nString("publishing_bot"):"SESSIONFLOW_API"===jobType?i18n.i18nString("conversation_flow"):"CHATSDASHBOARDREPORT_API"===jobType?i18n.i18nString("nav_tab_name_botDashboard")+" "+i18n.i18nString("msg")+" & "+i18n.i18nString("conversation"):"DASHBOARDREPORT_API"===jobType?i18n.i18nString("nav_tab_name_botDashboard")+" "+i18n.i18nString("success_task"):"CHANNELREPORT_API"===jobType?i18n.i18nString("nav_tab_name_botDashboard")+" "+i18n.i18nString("channels"):"ENTERPRISEACTIONREPORT_API"===jobType?i18n.i18nString("nav_tab_name_botDashboard")+" "+i18n.i18nString("success_task")+" Metrics":"ENTERPRISEDASHBOARDREPORT_API"===jobType?i18n.i18nString("nav_tab_name_botDashboard")+" "+i18n.i18nString("top_perform"):"SESSIONCOUNTFORCHART_API"===jobType?i18n.i18nString("nav_tab_name_botDashboard")+" "+i18n.i18nString("conversation_sessions"):"AGENTTRANSFERREPORT_API"===jobType?i18n.i18nString("nav_tab_name_botDashboard")+" "+i18n.i18nString("agent_transfer"):"PERFORMANCE_API"===jobType?i18n.i18nString("nlp_metrics")+" "+i18n.i18nString("performance"):"SUCCESSINTENT_API"===jobType?i18n.i18nString("nlp_metrics")+" "+i18n.i18nString("intent_found"):"FAILTASK_API"===jobType?i18n.i18nString("nlp_metrics")+" "+i18n.i18nString("Failed_task"):"FAILINTENT_API"===jobType?i18n.i18nString("nlp_metrics")+" "+i18n.i18nString("intent_not_found"):"PINNED_API"===jobType?i18n.i18nString("nlp_metrics")+" "+i18n.i18nString("Pinned"):"SCENE_EXPORT"===jobType?i18n.i18nString("scene_export"):data.jobType},$scope.viewStatus=function(jobType,data){"PUBLISH_BOT"==jobType&&$rootScope.publishStatusModal(data)},$scope.getDockVisibility=function(data){return"PUBLISHED_BOT"===data.jobType||"CONFIGURED_BOT"===data.jobType||"AUTO_VERSIONING"===data.action||"PUBLISHED_KNOWLEDGEGRAPH"===data.jobType||"CONFIGURED_KNOWLEDGEGRAPH"===data.jobType?!1:!0},$scope.getDockVisibilityTrain=function(data){return"PUBLISHED_BOT"===data.jobType||"CONFIGURED_BOT"===data.jobType||"PUBLISHED_KNOWLEDGEGRAPH"===data.jobType||"CONFIGURED_KNOWLEDGEGRAPH"===data.jobType?!0:!1},$scope.getEngineType=function(data){return"PUBLISHED_BOT"===data.jobType||"CONFIGURED_BOT"===data.jobType?"ML Engine":"PUBLISHED_KNOWLEDGEGRAPH"===data.jobType||"CONFIGURED_KNOWLEDGEGRAPH"===data.jobType?"KG Engine":void 0},$scope.bridge.timer=function(){timer&&(clearInterval(timer),timer=null),startTimer()},$scope.bridge.stopProgressDock=function(){timer&&(clearInterval(timer),timer=null)},$scope.bridge.cb=function(){$scope.bridge.timer()},$scope.openAnalysisReport=function(){$scope.bridge.openKnowledgeCollectionTab()}}]}})}(angular),function(ng){angular.module("bt-components").directive("acify",["textparser","$endpoints","$filter","$timeout","$workflowService","env_conf","i18n","$rootScope",function(textparser,$endpoints,$filter,$timeout,$workflowService,env_conf,i18n,$rootScope){return{restrict:"EA",scope:{callback:"=",mode:"=?",noFocus:"=?",validateError:"=?"},require:["^ngModel","^?form"],link:function(scope,iElement,iAttrs,ctrls){function updateContextVariables(){scope.contextsData=[],scope.contexts=[],scope.dialogNodeNames=$workflowService.dialogNodesNames(),scope.contextsData.session=$workflowService.contextData(),scope.contextsData&&scope.contextsData.entities&&delete scope.contextsData.entities,scope.contextsData&&scope.contextsData.mappedIntents&&delete scope.contextsData.mappedIntents,scope.contexts.push("session"),scope.dialogNodeNames&&Object.keys(scope.dialogNodeNames).length&&(scope.dialogNodeNames.entities&&scope.dialogNodeNames.entities.length&&(scope.contexts.push("entities"),scope.contextsData.entities=scope.dialogNodeNames.entities),scope.dialogNodeNames.mappedIntents&&scope.dialogNodeNames.mappedIntents.length&&(scope.contexts.push("mappedIntents"),scope.contextsData.mappedIntents=scope.dialogNodeNames.mappedIntents),scope.dialogNodeNames.nodes&&scope.dialogNodeNames.nodes.length&&(scope.contexts=scope.contexts.concat(scope.dialogNodeNames.nodes)))}function getContentValue(key){var filteredText=_.find(scope.bot.langVar,{key:key});return filteredText.value}function checkForGlobalVariables(currentLine,parentIndex){if(currentLine){var keyValue,_value,words=currentLine.split(" "),reg=new RegExp("[/{ ]{2}(\\s)?\\w+[.]\\w+[/}]{2}");reg.test(words)&&_.map(words,function(word,index){if(word.match(reg)){var textSplitValues=word.match(/[a-zA-Z]+/g);textSplitValues&&"content"===textSplitValues[0]?(keyValue=textSplitValues[1],_value=getContentValue(keyValue),parentIndex?$($($(".ace_layer .ace_line")[parentIndex]).find(".ace_operator")[index]).first().next().attr("title",_value):$($(".ace_layer .ace_line .ace_operator")[index]).first().next().attr("title",_value)):textSplitValues&&"env"===textSplitValues[0]&&(keyValue=textSplitValues[1],_value=getContentValue(keyValue),parentIndex?$($($(".ace_layer .ace_line")[parentIndex]).find(".ace_operator")[index]).attr("title",_value):$($(".ace_layer .ace_line .ace_operator")[index]).first().next().attr("title",_value))}})}}function splitLines(completeLine){var _individualLineArray=completeLine.split("\n");_.map(_individualLineArray,function(line,parentIndex){checkForGlobalVariables(line,parentIndex)})}function retrievePrecedingIdentifier(editor){var pos=editor.getCursorPosition(),text=editor.session.getLine(pos.row),textCopy=text.slice(0,text.length);checkForGlobalVariables(textCopy),pos=pos.column;for(var regex=/[a-zA-Z_0-9\$\-\.\u00A2-\uFFFF]/,buf=[],i=pos-1;i>=0&&regex.test(text[i]);i--)buf.push(text[i]);return buf.reverse().join("")}function initializeEditor(){function copyToClip(){var selection,success=!0,range=document.createRange(),input=ngModelCtrl.$viewValue||"";if(window.clipboardData)success=window.clipboardData.setData("Text",input);else{var tmpElem=$("<div>");tmpElem.css({position:"absolute",left:"-1000px",top:"-1000px"}),tmpElem.text(input),$("body").append(tmpElem),range.selectNodeContents(tmpElem.get(0)),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range);try{success=document.execCommand("copy"),console.log(success)}catch(e){console.log(e)}finally{tmpElem.remove()}}success&&NotificationService.notify(i18n.i18nString("script_copied_successfully"),"success")}ace.EditSession.prototype.$useWorker=!0,id=iAttrs.id,$(iElement[0]).css({width:"100%",height:"300px",border:"1px solid gray"});try{editor=ace.edit(id),tempAceEditor=editor,editor.setTheme(_defaultTheme),scope.mode=scope.mode||scope.callback.displayMode&&"view"===scope.callback.displayMode?!0:!1,editor.setReadOnly(scope.mode||!1),editor.getSession().setMode("ace/mode/javascript");ace.require("ace/ext/language_tools");editor.setOptions({enableBasicAutocompletion:!0}),_originalFontSize=editor.getFontSize();var rhymeCompleter={getCompletions:function(editor,session,pos,prefix,callback){updateContextVariables(),setTimeout(function(){var prevIdentifier=retrievePrecedingIdentifier(editor),wordList=[],identifierMatches=prevIdentifier.match(/[a-zA-Z]+/g);if(identifierMatches&&"env"===identifierMatches[0]&&(wordList=scope.bot.globalVar||[]),identifierMatches&&"content"===identifierMatches[0]&&(wordList=scope.bot.langVar||[]),identifierMatches&&"context"===identifierMatches[0]){var identifiersCount=prevIdentifier.split(".").length-1;if(1===identifiersCount)wordList=scope.contexts||[];else if(identifiersCount>1){var identifiers=prevIdentifier.split(".");""!==identifiers[identifiers.length-1]&&(identifiers[identifiers.length-1]="");for(var index=0;index<identifiers.length;index++)if(index>0&&""!==identifiers[index]){var _list=[];0===wordList.length&&(wordList=[]),scope.contextsData.session.hasOwnProperty(identifiers[index])?(wordList=scope.contextsData.session[identifiers[index]]||[],"object"!=typeof wordList||wordList[0]||(_list=[],$.map(wordList,function(item,key){_list.push(key)}),wordList=[],wordList=_list)):scope.contextsData.hasOwnProperty(identifiers[index])?(wordList=scope.contextsData[identifiers[index]]||[],"object"!=typeof wordList||wordList[0]||(_list=[],$.map(wordList,function(item,key){_list.push(key)}),wordList=[],wordList=_list)):wordList=""===identifiers[identifiers.length-1]?[]:[]}}}callback(null,wordList.map(function(word){return word&&word.key?{caption:word.key,value:word.key,meta:"static"}:{caption:word,value:word,meta:"static"}}))},70)},insertMatch:function(editor,data){editor.completer.insertMatch({value:data.caption})}};editor.completers=[rhymeCompleter],editor.commands.on("afterExec",function(e){("insertstring"===e.command.name||"backspace"===e.command.name)&&$timeout(function(){editor.execCommand("startAutocomplete")},50)}),$timeout(function(){$(".ace_text-input").attr("role","textbox"),scope.callback&&"view"===scope.callback.displayMode||scope.noFocus||editor.focus()}),scope.callback.focusEditor=function(){editor.focus()},$(window).on("focus",function(e){tempAceEditor.focus()}),editor.on("blur",function(e){scope.callback&&scope.callback.onBlur&&scope.callback.onBlur(editor)}),editor.on("focus",function(e){scope.callback&&scope.callback.onFocus&&scope.callback.onFocus()}),editor.getSession().on("change",function(e){ngModelCtrl.$setDirty(),scope.$evalAsync(set)})}catch(ex){console.log(ex)}var $iElement=$(iElement),_originalHeight=$iElement[0].style.height;$iElement.addClass("minimized"),$("body").attr("acifyState","minimized");var _toggleBtn=$('<span title="Full Screen" class="resizeToggle fa fa-expand" ></span>').on({click:function(e){$(iElement).hasClass("minimized")?($(e.target).attr("title","Back"),editor.setTheme("ace/theme/chaos"),editor.setFontSize(16),editor.focus(),$("body").attr("acifyState","maximized"),$("body").addClass("modal-open bt-modal-open"),$(iElement[0]).css({height:$(window).height()-50+"px"})):($(e.target).attr("title","Full Screen"),editor.setTheme(_defaultTheme),editor.setFontSize(_originalFontSize),$("body").attr("acifyState","minimized"),$(iElement[0]).css({height:_originalHeight}),scope.callback&&scope.callback.onMinimize&&scope.callback.onMinimize(editor,iElement),editor.focus()),$iElement.toggleClass("minimized maximized"),$iElement.find(".resizeToggle").toggleClass("fa-expand fa-compress"),editor.resize(!0)}}).appendTo($iElement);$('<div class="headerFrame"><img class="header-icon" src="'+$rootScope.logoFullInverted+'"><span class="header-title">'+i18n.i18nString("js_editor")+'</span></i><img class="copy-icon" title="Copy to Clipboard" src="'+env_conf["context-url"]+'/assets/debugConsoleIcons/copyJson-white.svg"></div>').appendTo($iElement),scope.$on("windowResize",function(){$(iElement).hasClass("maximized")&&($(iElement[0]).css({height:$(window).height()-50+"px"}),editor.resize(!0))}),$(".copy-icon").on("click",function(){copyToClip()}),$(iElement).keyup(function(e){$(iElement).hasClass("maximized")&&27===e.keyCode&&(e.preventDefault(),e.stopPropagation(),_toggleBtn.trigger("click"))})}function validateErrors(){if(!scope.validateError)return!0;var errors=editor.getSession().getAnnotations()||[],errorWarning=_.filter(errors,function(data){return"warning"==data.type||"error"==data.type});return errorWarning.length?!1:!0}function set(){var value=editor.getValue();ngModelCtrl.$setViewValue(value),$timeout(function(){splitLines(editor.getValue()),value&&value.trim()?ngModelCtrl.$setValidity("required",!0):(ngModelCtrl.$setValidity("required",!1),value=""),value&&value.trim()&&!validateErrors()?ngModelCtrl.$setValidity("codeerror",!1):ngModelCtrl.$setValidity("codeerror",!0)},600)}var editor,tempAceEditor,id,_defaultTheme="ace/theme/chrome",_originalFontSize=12,ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;scope.callback=scope.callback||{},ngModelCtrl.$name=iAttrs.name,scope.contextsData=[],scope.contexts=[],scope.contextsData=$workflowService.contextData(),scope.dialogNodeNames=$workflowService.dialogNodesNames(),scope.bot={variablesList:$workflowService.botEnvVariables(),globalVar:[],langVar:[]},0!==scope.bot.variablesList.length&&(scope.bot.globalVar=scope.bot.variablesList.map(function(val){return"env"==val.variableType?val:void 0}).filter(function(val){return void 0!==val}),scope.bot.langVar=scope.bot.variablesList.map(function(val){return"locale"==val.variableType?val:void 0}).filter(function(val){return void 0!==val})),$timeout(function(){try{initializeEditor(),editor.setValue(ngModelCtrl.$viewValue||"",1)}catch(ex){console.log(ex)}}),formCtrl.$addControl(ngModelCtrl),ngModelCtrl.$render=function(){editor&&editor.setValue(ngModelCtrl.$viewValue||"",1)},scope.callback.onInsert=function(data){ngModelCtrl.$setDirty(),editor.insert(data),editor.focus()},scope.callback.format=function(){var value=editor.getValue();value=value.replace(/ /g,""),ngModelCtrl.$setDirty(),editor.setValue($filter("styleit")(value),1)},scope.$on("$destroy",function(){ngModelCtrl.$$parentForm.$removeControl(ngModelCtrl)})}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("addTags",function(){return{restrict:"EA",scope:{tags:"=?",disabled:"=?",validateMode:"=?",placeholder:"=?",select2Options:"=?",entityData:"=?",updateSynonyms:"&",callback:"=?",type:"=?",eventCb:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/add-tags/add-tags.html",controller:["$scope","NotificationService","$timeout","$compile","i18n",function($scope,NotificationService,$timeout,$compile,i18n){function validateText(val){switch($scope.validateMode){case"field":case"entity":return validateFieldPattern(val);case"intent":case"task":
return $scope.intentPatternExp.test(val);default:return!0}}function showErrorMsg(){switch($scope.validateMode){case"field":case"entity":NotificationService.notify(i18n.i18nString("add_tags_with_notify",{dyn:$scope.validateMode}),"warning");break;case"intent":case"task":NotificationService.notify(i18n.i18nString("add_tags_without_notify",{dyn:$scope.validateMode}),"warning");break;default:return!0}}function validateFieldPattern(value){return value&&value.split("*").length-1===1?!0:!1}$scope.tags=_.isArray($scope.tags)?$scope.tags:[],$scope.intentPatternExp=/^[^*]+$/,$scope.select2Options=$scope.select2Options||{},$scope.select2Options=angular.extend({multiple:!0,simple_tags:!0,dropdownCssClass:"add-tags-dropdown",tags:[],placeholder:$scope.placeholder},$scope.select2Options),$scope.textChanged=function(){var tags=[];if($scope.eventCb&&($scope.elementInFocus||$scope.eleClicked)&&$timeout(function(){$scope.eventCb({event:"OnEnter",data:[]})},300),$scope.callback&&"intentPatterns"==$scope.callback.type&&$timeout(function(){$scope.callback.callMethod()},300),$scope.callback&&"entityPatterns"==$scope.callback.type&&$timeout(function(){$scope.callback.callMethod()},300),!($scope.tags.length<=0)&&($scope.tags.map(function(val){validateText(val)?tags.push(val):showErrorMsg()}),$scope.tags=tags,$scope.entityData)){var olddata=angular.copy($scope.entityData);$scope.entityData.synonyms?$scope.entityData.synonyms=$scope.tags:($scope.entityData.synonyms={},$scope.entityData.synonyms=$scope.tags);var newdata=angular.copy($scope.entityData);_.isEqual(newdata,olddata)||$scope.updateSynonyms({entityData:$scope.entityData})}},$scope.intentSorting=function(){$("ul.select2-choices").each(function(i,ele){$(ele).attr("ng-model","tags"),$(ele).sortable({containment:"parent",update:function(event,ui){var arr=[];$(event.target).find("li div").each(function(index){arr.push($(this).text())}),$scope.tags=arr}})})}}],link:function($scope,$element,$attrs){function bindEvents(){$($element[0]).find(".select2-input").off("focus").on("focus",function(evt){$scope.onFocus()}).off("focusout").on("focusout",function(evt){$scope.onBlur()}),$(".select2-search-field input").attr("placeholder",$scope.placeholder),$(".select2-search-choice-close").off("click").on("click",function(evt){$scope.onClick()})}$scope.onFocus=function(){$($element[0]).siblings(".pressEnterToSave").show(),$scope.elementInFocus=!0},$scope.onBlur=function(){$($element[0]).siblings(".pressEnterToSave").hide(),$scope.elementInFocus=!1,$scope.eleClicked=!1},$scope.onClick=function(){$scope.eleClicked=!0,$scope.textChanged()},$scope.$watch(function(){return $($element[0]).find(".select2-input").is(":visible")},function(){bindEvents()}),$scope.$on("$destroy",function(){$($element[0]).find(".select2-input").off("focus").off("focusout"),$(".select2-search-choice-close").off("click")})}}})}(angular),function(){"use strict";function autoGrow($workflowService,$timeout){function adjustHeight(element){$timeout(function(){if(element){var _ele=element[0];_ele.style.overflow="hidden",_ele.style.height="0",_ele.style.height=_ele.scrollHeight-2*(_ele.offsetHeight-_ele.offsetHeight)+"px"}},50)}function link(scope,element,attrs,ctrl){autosize(element),element.on("focus",function(e){adjustHeight(element)}),element.on("blur",function(e){if(element&&!attrs.defaultGrown){var _ele=element[0];_ele.style.height=""}adjustHeight(element)}),attrs.defaultGrown&&adjustHeight(element)}var directive={require:"ngModel",restrict:"A",link:link,scope:!1};return directive}angular.module("bt-components").directive("autoGrowTextarea",autoGrow),autoGrow.$inject=["$workflowService","$timeout"]}(),function(){"use strict";function contextTypeahead($workflowService,$timeout){function link($scope,element,attrs,ctrl){function getAccurateCaretPosition(ctrl){var CaretPos=0,array=[],res="";if(document.selection){ctrl.focus();var Sel=document.selection.createRange();Sel.moveStart("character",-ctrl.value.length),array=ctrl.value.match(/[^\s]+/g),array&&array.length>1?(res=array[array.length-1],CaretPos=res.length):CaretPos=Sel.text.length}else(ctrl.selectionStart||"0"==ctrl.selectionStart)&&(array=ctrl.value.match(/[^\s]+/g),array&&array.length>1?(res=array[array.length-1],CaretPos=res.length):CaretPos=ctrl.selectionStart);return CaretPos}function GetCaretPosition(ctrl){var CaretPos=0;if(document.selection){ctrl.focus();var Sel=document.selection.createRange();Sel.moveStart("character",-ctrl.value.length),CaretPos=Sel.text.length}else(ctrl.selectionStart||"0"==ctrl.selectionStart)&&(CaretPos=ctrl.selectionStart);return CaretPos}function ReturnWord(text,caretPos){var preText=(text.indexOf(caretPos),text.substring(0,caretPos));if(preText.indexOf(" ")>0){var words=preText.split(" "),word=words[words.length-1],array=word.match(/[^\s]+/g);return array&&array.length>1?array[array.length-1]:words[words.length-1]}var array1=preText.match(/[^\s]+/g);return array1&&array1.length>1?array1[array1.length-1]:preText}function getActiveWord(){var activeElement=document.activeElement;$scope.selected=activeElement.value,$scope.caretPos=GetCaretPosition(activeElement),$scope.accurateCaretPosition=getAccurateCaretPosition(activeElement),$scope.currentWord=ReturnWord(activeElement.value,$scope.caretPos);var identifierMatches=$scope.currentWord.match(/@+/g);if($scope.atMentionsData=[],identifierMatches){var identifiersCount=$scope.currentWord.split("@").length-1;if(1===identifiersCount){var _tempCurrWord=$scope.currentWord.split("@");$scope.currentWord=_tempCurrWord[_tempCurrWord.length-1],$scope.atMentionsData=$scope.atMentions}else if(identifiersCount>1){var identifiers=$scope.currentWord.split("@");""!==identifiers[identifiers.length-1]&&(identifiers[identifiers.length-1]=""),$scope.currentWord=identifiers[identifiers.length-1],$scope.atMentionsData=$scope.atMentions}}return $scope.currentWord}$scope._constants_=$scope.$root._constants_,$scope.atMentionsData=$scope.atMentions,$scope.selected="",$scope.currentWord="",$scope.triggeredFromSelect=$scope.triggeredFromSelect||!1,setTimeout(function(){element.bind("keydown",function(event){event.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&event.preventDefault()}).autocomplete({minLength:1,source:function(request,response){if($(element[0]).focus(),$scope.triggeredFromSelect)return void setTimeout(function(){$scope.triggeredFromSelect=!1},500);var term=getActiveWord();response($.ui.autocomplete.filter($scope.atMentionsData,term))},focus:function(event,ui){event.preventDefault()},select:function(e,ui){var item=ui.item.value||"",front=$scope.selected.substring(0,$scope.caretPos),lastIndex=front.lastIndexOf("@");front=front.substring(0,lastIndex)+"@";var back=$scope.selected.substring($scope.caretPos,$scope.selected.length);return $(this).val(front+item+back).trigger("input"),ctrl.$setViewValue($(this).val()),$scope.triggeredFromSelect=!0,$(":focus").blur(),setTimeout(function(){$(element[0]).focus()},500),!1},position:{collision:"flip"},open:function(event,ui){if($(".ui-autocomplete:visible").css({left:"+="+5*$scope.accurateCaretPosition}),window.outerWidth-210<$(".ui-autocomplete:visible").offset().left){var _leftToReposition=$(".ui-autocomplete:visible").offset().left-(window.outerWidth-210)+10;$(".ui-autocomplete:visible").css({left:"-="+_leftToReposition})}}}).autocomplete("widget").addClass("contextTypeaheadDropdown")},1e3),setTimeout(function(){$.each($(".panel-body, body"),function(){$(this).bind("mousewheel",function(event){$(".contextTypeaheadDropdown :visible").length&&-1===event.target.className.indexOf("ui-menu-item")&&void 0!==element.data("ui-autocomplete")&&element.autocomplete("close")}),$(this).scroll(function(){$(".contextTypeaheadDropdown :visible").length&&element.autocomplete("close")})})},1e3)}var directive={require:"ngModel",restrict:"A",link:link,scope:{customContexts:"@",value:"=",context:"=",atMentions:"=",triggeredFromSelect:"=?"}};return directive}angular.module("bt-components").directive("botMentions",contextTypeahead),contextTypeahead.$inject=["$workflowService","$timeout"]}(),function(ng){var _fullPageModalComponent=ng.module("bt-components");_fullPageModalComponent.directive("botModalSlider",function(){return{restrict:"EA",transclude:!0,controller:"botModalSliderCtrl",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bot-modal-slider/bot-modal-slider.html"}}),_fullPageModalComponent.controller("botModalSliderCtrl",["$scope","$rootScope","$timeout","$workflowService","BTStreamsService","builderUtility",function($scope,$rootScope,$timeout,$workflowService,BTStreamsService,builderUtility){$scope.openModalSlider=function(parentSelector){builderUtility.openModalSlider("#botModalSlider",parentSelector),$timeout(function(){$rootScope.$emit("pefectScrollUpdate")},300)},$scope.closeModalSlider=function(parentSelector){builderUtility.closeModalSlider("#botModalSlider",parentSelector)};var modalSlider=$scope.modalSlider||{};modalSlider.open=$scope.openModalSlider,modalSlider.close=$scope.closeModalSlider}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("botTooltip",["i18n",function(i18n){return{restrict:"EA",scope:{task:"=?",container:"@?",from:"@?",subType:"@?",parameterType:"=?",format:"=?",hoverText:"@?"},replace:!0,templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bot-tooltip/bot-tooltip.html",controller:["$scope","$workflowService","$templateCache","$compile",function($scope,$workflowService,$templateCache,$compile){$scope.stream=$workflowService.selectedStream(),$scope.seedSupportedLanguages=$workflowService.seedData().supportedLanguages,$scope.getLangNameByValue=function(langValue,isTitle){if(langValue=langValue||$workflowService.currentLanguage(),"published"!==$scope.task.state&&isTitle)return i18n.i18nString("few_languages");var language=_.find($scope.seedSupportedLanguages,{value:langValue});return language&&language.name||""},$scope.getLangArrayByValue=function(langValueString,task){if(!langValueString)return"";var langvalueArray=task.approvedLanguages||[],langNames=_.map(langvalueArray,function(langValue){var langObject=_.find($scope.seedSupportedLanguages,{value:langValue});return langObject.name});return langNames},$scope.isApproved=function(langValue){return-1!==$.inArray(langValue,$scope.task.approvedLanguages||[])?!0:!1};var templateObject={publish:"publishlangpopover.html",smartAlert:"smartAlertPopOver.html"},template=$scope.from?$scope.subType?templateObject[$scope.from][$scope.subType]:templateObject[$scope.from]:"langpopover.html",rawTemplate=$templateCache.get(template),compiledTemplate=$compile(rawTemplate)($scope);$scope.getLangTemplate=function(){return compiledTemplate},$scope.getLangString=function(str){return i18n.i18nString(str)}}],link:function($scope,$element,$attrs,ctrls){if(!($scope.from&&$scope.task&&$scope.task.approvedLanguages&&$scope.task.approvedLanguages.length<=2)){var count=0,_lanString=$scope.getLangString("bot_tool_tip_notify"),$popover=$($element[0]).popover({placement:"bottom",html:!0,delay:{show:300,hide:100},trigger:"manual",title:$scope.from?"":_lanString+$scope.getLangNameByValue("",!0),container:$scope.container?"."+$scope.container:".rightPanel",content:function(){return count+=1,$scope.getLangTemplate()}});$popover.on("mouseenter",function(){var _this=this;$(this).popover("show"),setTimeout(function(){$(".langlistScroll").scrollTop(1)},300),$(this.children[0]).addClass("displayBlock"),$(".popover").on("mouseleave",function(){$(_this).popover("hide")})}).on("mouseleave",function(){var _this=this;setTimeout(function(){$(".popover:hover").length||($(_this.children[0]).removeClass("displayBlock"),$(_this).popover("hide"))},200)}),$popover.on("hidden.bs.popover",function(e){$(".popover").remove()}),$popover.on("shown.bs.popover",function(e){$(".popover.in").addClass("langPubPop")})}}}}])}(angular),function(ng){"use strict";var _component=ng.module("bt-components");_component.directive("botsSelectionViewV2",function(){return{restrict:"EA",scope:{callback:"=",streamsList:"=",linkcb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bots-selection-view-v2/bots-selection-view-v2.html",controller:"botsSelectionViewV2Controller"}}),_component.controller("botsSelectionViewV2Controller",["$scope","$location","$workflowService","$timeout","$applicationService","BTStreamsService","NotificationService","$q","env_conf","$filter","i18n","$rootScope",function($scope,$location,$workflowService,$timeout,$applicationService,BTStreamsService,NotificationService,$q,env_conf,$filter,i18n,$rootScope){function setMyBots(){$scope.myBotsTest=$scope.$parent.myBots}function getMyBots(){$scope.selectedStream=$workflowService.selectedStream(),$scope.streamsList=$workflowService.streamsAll(),$scope.myBots=angular.copy($scope.streamsList).filter(function(bot){return bot.trainingData={},bot.trainingData.invocationNames=[],bot.trainingData.invocationNames.push(bot.name),$scope.linkedBots&&$scope.linkedBots.length&&-1!==_.pluck($scope.linkedBots,"_id").indexOf(bot._id)&&(bot.linked=!0),"universalbot"!==bot.type&&!bot.linked&&!bot.onMessageEnabled&&bot.purpose===$scope.selectedStream.purpose}),$workflowService.linkableBots=$scope.myBots.length?!0:!1,$scope.myBotsCopy=angular.copy($scope.myBots),$scope.linkcb&&$scope.linkcb.fetchingUnlinkedBots&&($scope.linkcb.fetchingUnlinkedBots=!1),setMyBots()}$applicationService.userInfo().userId;$scope.selectedStream=$workflowService.selectedStream(),$scope.currentLanguage=$workflowService.currentLanguage(),$scope.collapseArrow=env_conf["context-url"]+"/assets/images/down-arrow.png",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.grouping=env_conf["assets-url"]+"images/grouping.png",$scope.botLinkLoadingImage=env_conf["context-url"]+"/assets/ub2/loading.svg",$scope.currentPage=1,$scope.maxSize=3,$scope.itemsPerPage=10,$scope.utterance={},$scope.triggerPhrases={},$scope.update=i18n.i18nString("update"),$scope.linkbot=i18n.i18nString("link_bot"),$scope.entryPhrases={},$scope.exitPhrases={},$scope.trainingData={},$scope.trainingData.invocationNames=[],$scope.trainingData.trainingUtterances=[],$scope.limit=10,$scope.$on("updateLinkableBots",function(){getMyBots()}),$scope.redirectToLink=function(linkType){$rootScope.redirectToLink(linkType)},$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.backArrow=env_conf["context-url"]+"/assets/icons/back-arrow-gray.svg",$scope.getTasks=function(streamName){var tasks=$workflowService.botDetails(streamName);tasks?$scope.tasks=tasks:($scope.tasks=[],$scope.loaderMessage=i18n.i18nString("fetching_tasks"),$scope.isWorkProgress=!0,BTStreamsService.getBotDetails(streamName).then(function(res){tasks=res.data.tasks,$scope.tasks=_.filter(tasks.alerts.concat(tasks.actions,tasks.dialogs),{state:"published"}),$workflowService.botDetails(streamName,$scope.tasks),$scope.isWorkProgress=!1},function(err){$scope.isWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}))},$scope.cancelUBSelection=function(){$scope.callback.closeSelectionModal("#linkBot"),$scope.searchString="",$scope.linkedBots&&($scope.$parent.fetchLinkBots(),$scope.$parent.fetchUnlinkBots())},$scope.linkBot=function(e,bot){e.stopPropagation(),e.stopImmediatePropagation(),bot.botLinking=!0,bot.trainingData=bot.trainingData?bot.trainingData:{};var _trainingData=angular.copy(bot.trainingData);_trainingData&&_trainingData.invocationNames&&_trainingData.invocationNames.length?_trainingData.invocationNames=_.pluck(_trainingData.invocationNames,"text"):_trainingData.invocationNames=[];var _payload={trainingUtterances:_trainingData.trainingUtterances,invocationNames:_trainingData.invocationNames,botId:bot._id,linkedBotDetails:{_id:bot._id,displayName:bot.name}};BTStreamsService.addTrainingData($scope.selectedStream._id,_payload).then(function(response){if(response&&response.data){$timeout(function(){bot.botLinking=!1}),bot.linked?NotificationService.notify(i18n.i18nString("selected_updated"),"success"):(bot.linked=!0,NotificationService.notify(i18n.i18nString("selected_success"),"success")),$scope.selectedStream=response.data,$workflowService.selectedStream(response.data),$scope.linkcb.updateTrainStatus(),$scope.$emit("updateChecklist","linkedBots")}},function(err){err&&err.data&&err.data.errors&&err.data.errors.length&&err.data.errors[0]&&err.data.errors[0].code&&"DENIED_ACTION"===err.data.errors[0].code?NotificationService.notify(err.data.errors[0].msg,"error"):err&&err.data&&err.data.errors&&err.data.errors.length&&err.data.errors[0]?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_error"),"error"),$timeout(function(){bot.botLinking=!1})})},$scope.saveUtterance=function(utterance,bot){if(!utterance||!utterance.newUtterance.length)return void NotificationService.notify(i18n.i18nString("utterances_value"),"error");if(utterance&&utterance.newUtterance.length){if(bot.trainingData&&bot.trainingData.trainingUtterances&&bot.trainingData.trainingUtterances.length)if(bot.trainingData.trainingUtterances.indexOf(utterance.newUtterance)>=0){var _duplicateValue=angular.copy(utterance.newUtterance);NotificationService.notify(i18n.i18nString("duplicate_utterance_added",{duplicateValue:_duplicateValue}),"error")}else bot.trainingData.trainingUtterances.push(utterance.newUtterance);else bot.trainingData?(bot.trainingData.trainingUtterances=[],bot.trainingData.trainingUtterances.push(utterance.newUtterance)):(bot.trainingData={},bot.trainingData.trainingUtterances=[],bot.trainingData.trainingUtterances.push(utterance.newUtterance));utterance.newUtterance=""}},$scope.setUtterance=function(utterance){utterance.newUtterance=""},$scope.editUtteranceTag=function(index,utteranceInput,trainingData){$(".editInputUtterance").addClass("hide"),$(".tagUtterance").removeClass("hide"),$(".utteranceTag"+index).addClass("hide"),$(".inputUtteranceTag"+index).removeClass("hide"),$(".utterance-field").focus()};var _accordionParent=$("#accordion");_accordionParent.on("show.bs.collapse",".collapse",function(){_accordionParent.find(".collapse.in").collapse("hide"),$(this).parent().parent(".toggleClose").toggleClass("toggleClose").toggleClass("toggleOpen")}),_accordionParent.on("hidden.bs.collapse",function(){$(this).find(".toggleOpen").toggleClass("toggleOpen").toggleClass("toggleClose")}),$scope.deleteUtterance=function(index,utterance,bot,currentPage){currentPage>1&&(index=10*(currentPage-1)+index),bot.trainingData.trainingUtterances.splice(index,1)},$scope.getPageData=function(offset,type,bot){BTStreamsService.paginateTrainingData($scope.selectedStream._id,offset,$scope.limit,type,bot._id).then(function(response){response&&(bot.trainingData.trainingUtterances=response.data.result.trainingUtterances)})},$scope.linkcb.fetchUnlinkedBots=function(totalLinkedBots){$scope.linkedBots=totalLinkedBots,$scope.parentScope=$scope.$parent,getMyBots()},$scope.linkcb.cancelUBSelection=$scope.cancelUBSelection,$scope.searchBots=function(search){search.length>=2?$scope.myBots=$filter("filter")($scope.myBotsCopy,search):0===search.length&&($scope.loadingSearchResults=!0,$scope.myBots=[],$timeout(function(){$scope.loadingSearchResults=!1,$scope.myBots=$scope.myBotsCopy}))},$scope.editUtterence=function(e,index,bot){e.preventDefault();var editValue=$("#utteranceTag"+index).text();return bot.trainingData.trainingUtterances.indexOf(editValue)>=0?(NotificationService.notify(i18n.i18nString("utterances_dyn",{dyn:editValue}),"error"),void $("#utteranceTag"+index).text(bot.trainingData.trainingUtterances[index])):void(editValue&&editValue.length?bot.trainingData.trainingUtterances[index]=editValue:(NotificationService.notify(i18n.i18nString("utterances_value"),"error"),$("#utteranceTag"+index).text(bot.trainingData.trainingUtterances[index])))}}])}(angular),function(ng){"use strict";var _component=ng.module("bt-components");_component.directive("botsSelectionView",function(){return{restrict:"EA",scope:{streamsList:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bots-selection-view/bots-selection-view.html",controller:"botsSelectionViewController"}}),_component.controller("botsSelectionViewController",["$scope","$location","$workflowService","$timeout","$applicationService","BTStreamsService","NotificationService","$q","env_conf","i18n",function($scope,$location,$workflowService,$timeout,$applicationService,BTStreamsService,NotificationService,$q,env_conf,i18n){function linkedBotsList(stream){stream?(totalLinkedBots=[],totalLinkedBots=_.uniq(totalLinkedBots.concat(stream.configuredBots,stream.publishedBots,stream.awaitingApprovalBots))):totalLinkedBots=_.uniq(totalLinkedBots.concat($scope.selectedStream.configuredBots,$scope.selectedStream.publishedBots,$scope.selectedStream.awaitingApprovalBots))}function getMyBots(){$scope.selectedStream=$workflowService.selectedStream(),$scope.streamsList=$workflowService.streamsAll(),$scope.myBots=angular.copy($scope.streamsList).filter(function(bot){return totalLinkedBots&&totalLinkedBots.length&&-1!==_.pluck(totalLinkedBots,"_id").indexOf(bot._id)&&(bot.linked=!0),"universalbot"!==bot.type&&!bot.linked&&!bot.onMessageEnabled&&bot.purpose===$scope.selectedStream.purpose}),$workflowService.linkableBots=$scope.myBots.length?!0:!1}function successCallback(res){NotificationService.notify(i18n.i18nString("bots_selection_selected_bots_link_success"),"info"),$scope.$parent.closeModalSlider("#linkedBotsList"),$workflowService.selectedStream(res.data),totalLinkedBots=_.uniq(totalLinkedBots.concat(res.data.configuredBots,res.data.publishedBots,res.data.awaitingApprovalBots)),$scope.$parent.fetchLinkBots(),getMyBots()}function errorCallback(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bots_selection_selected_bots_link_fail"),"error")}$applicationService.userInfo().userId;$scope.selectedStream=$workflowService.selectedStream();var linkedBots=[],totalLinkedBots=[];linkedBotsList(),$scope.$on("updateLinkableBots",function(event,res){linkedBotsList(res.data),getMyBots()}),getMyBots(),$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.backArrow=env_conf["context-url"]+"/assets/icons/back-arrow-gray.svg",$scope.getTasks=function(streamName){var tasks=$workflowService.botDetails(streamName);tasks?$scope.tasks=tasks:($scope.tasks=[],$scope.loaderMessage="fetching tasks . . .",$scope.isWorkProgress=!0,BTStreamsService.getBotDetails(streamName).then(function(res){tasks=res.data.tasks,$scope.tasks=_.filter(tasks.alerts.concat(tasks.actions,tasks.dialogs),{state:"published"}),$workflowService.botDetails(streamName,$scope.tasks),$scope.isWorkProgress=!1},function(err){$scope.isWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}))},$scope.cancelUBSelection=function(){$scope.$parent.closeModalSlider("#linkedBotsList")},$scope.linkBots=function(){linkedBots=$scope.myBots.filter(function(bot){return bot.linked});var linkPayload={bots:linkedBots.map(function(bot){return{_id:bot._id,displayName:bot.name}})};linkPayload.bots.length?BTStreamsService.linkOrUnlinkBots($scope.selectedStream._id,"link",linkPayload).then(successCallback,errorCallback):NotificationService.notify(i18n.i18nString("please_select_atleast_one_bot"),"error")}}])}(angular),function(ng){var _fullPageModalComponent=ng.module("bt-components");_fullPageModalComponent.directive("bottomModalSlider",function(){return{restrict:"EA",transclude:!0,controller:"bottomModalSliderCtrl",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bottom-modal-slider/bottom-modal-slider.html"}}),_fullPageModalComponent.controller("bottomModalSliderCtrl",["$scope","$rootScope","$timeout","builderUtility",function($scope,$rootScope,$timeout,builderUtility){$scope.openBottomModalSlider=function(parentSelector){builderUtility.openBottomModalSlider("#bottomModalSlider",parentSelector),$timeout(function(){$rootScope.$emit("pefectScrollUpdate")},300)},$scope.closeBottomModalSlider=function(parentSelector){builderUtility.closeBottomModalSlider("#bottomModalSlider",parentSelector)};var modalSlider=$scope.modalSlider||{};modalSlider.open=$scope.openModalSlider,modalSlider.close=$scope.closeModalSlider}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("bsPopover",function(){return{restrict:"EA",link:function(scope,el,attrs){el.find("[data-toggle=popover]").popover()}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("btConversations",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-conversations/bt-conversations.html",controller:"btConversationsController"}}),_module.controller("btConversationsController",["$scope","env_conf","$rootScope","BTStreamsService","$workflowService","BTIdpService","NotificationService","i18n","jsEvents","$sce","channelsConfig",function($scope,env_conf,$rootScope,BTStreamsService,$workflowService,BTIdpService,NotificationService,i18n,jsEvents,$sce,channelsConfig){function setIframeStorage(){if(window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))){var jStorage=JSON.parse(localStorage.getItem("jStorage")),iframeTab=window.open("http://localhost:4200");iframeTab.localStorage.setItem("jStorage",JSON.stringify(jStorage)),iframeTab.close()}}function initData(){$scope.lodingForm=!1}$scope.streamId=$workflowService.selectedStream()._id,$scope.stream=$workflowService.selectedStream(),$scope.lodingForm=!0,$scope.assetsBase=env_conf["assets-url"],$scope.emptyAuth=env_conf["context-url"]+"/assets/authorization/empty_authorization.svg",window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.iframeUrl=$sce.trustAsResourceUrl("http://localhost:4200/analytics/dashboards/"+$scope.streamId+"/conversations"):$scope.iframeUrl=window.appConfig.API_SERVER_URL+"/analytics/dashboards/"+$scope.streamId+"/conversations";var iframe=$("#conversations");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")}),setTimeout(function(){initData()},0)}),setIframeStorage()}])}(angular),function(ng){var _fullPageModalComponent=ng.module("bt-components");_fullPageModalComponent.directive("btFullpageModal",function(){return{restrict:"EA",scope:{callback:"=",step:"=?",activeEntityFlow:"=?",workingTaskType:"=?",botType:"=?",initializeCreateBot:"=?",cb:"=",groupList:"=",groupCb:"=",views:"=?"},controller:"btFullpageModalCtrl",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-fullpage-modal/bt-fullpage-modal.html"}}),_fullPageModalComponent.controller("btFullpageModalCtrl",["$scope","$rootScope","$timeout","$workflowService","BTStreamsService","builderUtility","i18n",function($scope,$rootScope,$timeout,$workflowService,BTStreamsService,builderUtility,i18n){$scope.trainCB={},$scope._constants_=$rootScope._constants_,$scope.rightClass="right500",$scope.modalSlider={},$scope.customData={},$scope.openFullPageModal=function(stepNo,type,isStandard,customData){$(".kore-chat-window")&&$(".kore-chat-window").length&&!$(".kore-chat-window").hasClass("minimize")&&$(".kore-chat-window .minimize-btn").trigger("click"),$scope.step=stepNo,$scope.customData=customData||$scope.customData,$timeout(function(){return"openVediosPage"==type?($scope.modalType=type,void $("#btFullpageModal").modal("show")):"smallTalk"==type?($scope.modalType=type,void $("#btFullpageModal").modal("show")):"uiForms"==type||"uiFormsTest"===type||"uiFormsBranding"===type?($scope.modalType=type,void $("#btFullpageModal").modal("show")):(isStandard||("createBot"==type?($scope.modalType=type,$scope.openModalSlider("#botcreate")):$("#btFullpageModal").modal("show")),void(isStandard&&("importbot"==type&&($scope.botType=type),$scope.$emit("updateStep",4),$scope.openModalSlider("#botcreate"))))}),$scope.modalType=type,$workflowService.sampleBotModalTitle(i18n.i18nString("select_a_bot_type")),"createBot"===$scope.modalType&&($scope.modalTitle=$workflowService.sampleBotModalTitle())},$scope.closeFullPageModal=function(type){$(".botDetailsForm").removeClass("dialogModalOpen"),$scope.step=-1,$scope.modalType="","createBot"==type?$scope.closeModalSlider("#botcreate"):$("#btFullpageModal").modal("hide")},$scope.step=-1,$scope.frontNavigation=!0,$scope.loaderMessage=i18n.i18nString("working_on_it"),$scope.isWorkProgress=!1,$scope.isGlobalWorkProgress=!1,$scope.$on("showStatusLoader",function(evt,flag){$scope.isWorkProgress=flag}),$scope.$on("openFullPageModal",function(evt,type){var step=1;"trainBot"===type&&(step=3),$scope.openFullPageModal(step,type)}),$scope.updateStep=function(evt,stepNo,taskCreationInfo,stopStepUpdate,pageTitle,smartBotId){taskCreationInfo&&($scope.wfType=taskCreationInfo.taskType,$scope.isReport=taskCreationInfo.isReport),$scope.modalTitle=$workflowService.sampleBotModalTitle(),3!==stepNo?$scope.frontNavigation=!0:$scope.frontNavigation=!1,smartBotId&&($scope.smartBotId=smartBotId),stopStepUpdate||$timeout(function(){$scope.step=stepNo})},$scope.stepUpdate=function(step){$scope.$emit("updateStep",step)},$scope.$on("updateStep",$scope.updateStep),$scope.onCreateNewBot=function(){$scope.$emit("updateStep",4),$scope.openModalSlider("#botcreate"),$scope.initializeCreateBot=!1;var stream=$workflowService.selectedStream();$scope.$emit("loadBots",stream)},$scope.onCancelBotCreation=function(){$scope.initializeCreateBot=!1,$scope.closeModalSlider("#botcreate")},$scope.onModeSelected=function(selectedMode){$scope.openBotChooser(selectedMode)},$scope.openBotChooser=function(botType){$scope.botType=botType,$scope.initializeCreateBot=!0,$scope.$emit("updateStep",4)},$scope.setGroup=function(group){$scope.groupDetails=group},$scope.createGroup=function(group){$scope.newGroup=group},$scope.loadGroups=function(groups,cb){$scope.groups=groups,cb&&setTimeout(function(){cb()},1e3)},$scope.landingPageGroups=function(groups){$scope.groupList=groups},$scope.exportFile=function(fileType){$scope.callback.smallTalkExport(fileType)},$scope.getGroups=function(_streamId){$scope.groupCb.getSmallTalkGroups(_streamId)},$scope.loadBotStore=function(){$scope.callback.triggerLoadStore()},$scope.invokeBotsFormForStore=function(){$scope.$emit("loadBotsForm",{$event:event})},$scope.loadStoreNoBotsForm=function(){$scope.callback.loadStore()},$scope.callback=$.extend($scope.callback,{openFullPageModal:$scope.openFullPageModal,closeFullPageModal:$scope.closeFullPageModal,openBotChooser:$scope.openBotChooser,setGroup:$scope.setGroup,createGroup:$scope.createGroup,loadGroups:$scope.loadGroups,landingPageGroups:$scope.landingPageGroups,exportFile:$scope.exportFile,getGroups:$scope.getGroups})}])}(angular),function(ng){"use strict";var _component=ng.module("bt-components");_component.directive("btInvoices",function(){return{restrict:"AE",scope:{callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-invoices/bt-invoices.html",controller:"btInVoicesController"}}),_component.controller("btInVoicesController",["$scope","$rootScope","$location","$workflowService","$timeout","$applicationService","BTStreamsService","NotificationService","$q","env_conf","i18n","BTFlowtaskService","$modal","localstore","$sce",function($scope,$rootScope,$location,$workflowService,$timeout,$applicationService,BTStreamsService,NotificationService,$q,env_conf,i18n,BTFlowtaskService,$modal,localstore,$sce){function downloadURI(uri,name){var link=document.createElement("a");link.download=name,link.href=uri,link.target="_blank",document.body.appendChild(link),link.click(),document.body.removeChild(link)}function formatDate(date){var d=new Date(date),month=""+(d.getMonth()+1),day=""+d.getDate(),year=d.getFullYear();return month.length<2&&(month="0"+month),day.length<2&&(day="0"+day),
[month,day,year].join("")}function getInvoices(offset){$scope.isLoading=!0,offset=offset||0,BTStreamsService.getInvoices($scope.streamId,$scope.limit,offset).then(function(res){res=res.data,res&&res.invoices.length&&($scope.getInvoices=res.invoices,$scope.total=res.total,$scope.hasMore=res.hasMore),$scope.isLoading=!1},function(err){$scope.isLoading=!1,err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error")})}$scope.assetsPath=env_conf["assets-url"],$scope.basicPlan=env_conf["context-url"]+"/assets/billing/basic-plan.svg",$scope.standardPlan=env_conf["context-url"]+"/assets/billing/standard-plan.svg",$scope.enterprisePlan=env_conf["context-url"]+"/assets/billing/enterprise-plan.svg",$scope.autoRefresh=env_conf["context-url"]+"/assets/billing/auto-refresh.svg",$scope.freePlaceholder=env_conf["context-url"]+"/assets/billing/free-placeholder.svg",$scope.adminPlaceholder=env_conf["context-url"]+"/assets/billing/admin-placeholder.svg",$scope.downloadIcon=env_conf["context-url"]+"/assets/icons-new/download/download-gray.svg",$scope.tasksPerformance=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/tasksPerformance.svg",$scope.streamId=$workflowService.selectedStream()._id,$scope.botName=$workflowService.selectedStream().name,$scope.selectedStream=$workflowService.selectedStream(),$scope.appControls=$applicationService.userInfo().appControls,$scope.getInvoices=[],$scope.isLoading=!1,$scope.search="",$scope.limit=10,$scope.total=0,$scope.currentPage=1,$scope.hasMore=!1,$scope.$watch("currentPage",function(newVal){$scope.offset=($scope.currentPage-1)*$scope.limit,$scope.callback.getInvoices()}),$scope.callback.getInvoices=function(offset){offset=offset||0,getInvoices(offset)},$scope.exportBillingSession=function(bill){BTStreamsService.downloadProgressDockExportFile(bill.fileId).then(function(res){res=res.data;var dtFormat=formatDate(bill.createdAt)||moment(bill.createdAt).format("MMDDyyyy"),fileName="Invoice_"+dtFormat+".pdf";console.log(fileName),downloadURI(res.fileUrl,fileName),NotificationService.notify(i18n.i18nString("success"),"success")},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),$scope.chartLoader=!1})},$scope.clearSearch=function(){$scope.search=""};var init=function(){getInvoices()};init()}]),_component.filter("localString",function(){return function(input){return input&&input.toLocaleString()?input.toLocaleString():input}})}(angular),function(ng){var _component=angular.module("bt-components");_component.directive("btPagination",function(){return{restrict:"EA",scope:{getPageData:"&",limit:"=",totalItems:"=",showNumDropdown:"=?",metadata:"=?",updateLimit:"&?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-pagination/bt-pagination.html",controller:"PaginationCtrl"}}),_component.controller("PaginationCtrl",function($scope,$http,$timeout){function getData(){$scope.offset=($scope.currentPage-1)*$scope.limit;var objToSend={offset:$scope.offset};$scope.metadata&&(objToSend.testSuitID=$scope.metadata.testSuitID),$scope.getPageData(objToSend)}$scope.currentPage=1,$scope.offset=0,$scope.itemsOnPage="10",$scope.$on("changeCurrentPage",function(evt,pageNumber){$scope.currentPage=pageNumber}),$scope.$on("changeOffset",function(evt,offset){$scope.offset=offset}),$scope.pageChanged=function(){getData()},$scope.changeNoOfRecordsToShow=function(){$scope.currentPage=1,$scope.limit=$scope.itemsOnPage,$scope.updateLimit&&$scope.updateLimit({limitToUpdate:$scope.limit}),$timeout(function(){getData()})}})}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("btPdfAnno",function(){return{restrict:"EA",scope:{callbacks:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-pdf-anno/bt-pdf-anno.html",controller:"btPdfAnnoController"}}),_module.controller("btPdfAnnoController",["$scope","env_conf","$rootScope","$workflowService","$applicationService","BTStreamsService","NotificationService","i18n","jsEvents",function($scope,env_conf,$rootScope,$workflowService,$applicationService,BTStreamsService,NotificationService,i18n,jsEvents){function initData(){if(setTimeout(function(){$scope.lodingForm=!1},500),$scope.callbacks.fileName){var data={type:"callback",fileName:$scope.callbacks.fileName};$scope.callbacks.listData&&Object.keys($scope.callbacks.listData).length&&$scope.callbacks.listData._id&&(data._id=$scope.callbacks.listData._id),jsEvents.postMessageToChildIframes("pdfAnnoEvent","pdfAnnoIframeEvent",data)}}function userGuideModal(){var guidePayload={type:"userGuide",isNewUser:!0};jsEvents.postMessageToChildIframes("pdfAnnoEvent","pdfAnnoIframeEvent",guidePayload)}function annotateExtraction(){var payloadResponse={streamId:$scope.payload.streamId,fileId:$scope.callbacks.fileId,title:$scope.payload.title,header:$scope.payload.header,footer:$scope.payload.footer,ignoreText:$scope.payload.ignoreText,titlePageno:$scope.payload.title_pageno,headerPageno:$scope.payload.header_pageno,footerPageno:$scope.payload.footer_pageno,ignoreTextPageno:$scope.payload.ignoreTextPageno,ignorePages:$scope.payload.ignorePages,name:$scope.callbacks.fileName,extractionType:"annotation"};BTStreamsService.kgQnAnnotation($scope.streamId,payloadResponse).then(function(res){var kId=res.data._id;NotificationService.notify("Document Extraction In progress...","success");var interval=setInterval(function(){BTStreamsService.kgHistory($scope.streamId).then(function(res){var list=res.data.metaqnas,extractedObj=list.find(function(item,i){return item._id===kId});extractedObj&&Object.keys(extractedObj).length&&"inProgress"!==extractedObj.status&&($scope.extractedObj=extractedObj,$scope.callbacks.listData=extractedObj,clearInterval(interval),$scope.extractionSuccess=!0,$scope.loaderFlag=!1,"success"===extractedObj.status?(NotificationService.notify("Document Extraction Completed!","success"),$scope.openReviewModal()):"failed"===extractedObj.status&&NotificationService.notify("Document Extraction Failed!","error"))},function(err){$scope.loaderFlag=!1,$scope.extractionSuccess=!1,err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")})},2e3)},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error"),$scope.loaderFlag=!1})}function init(){}$scope.streamId=$workflowService.selectedStream()._id,$scope.stream=$workflowService.selectedStream(),$scope.isIframeLoaded=!1,$scope.lodingForm=!0,$scope.assetsBase=env_conf["assets-url"],$scope.backArrow=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-left-black.svg",$scope.gHelpIcon=env_conf["context-url"]+"/assets/icons/gHelpIcon.svg",$scope.ellipsisDark=env_conf["context-url"]+"/assets/icons/overflow.svg",$scope.loadingIcon=env_conf["context-url"]+"/assets/ub2/loading.svg",$scope.fileId=$scope.callbacks.fileId,$scope.payload={},$scope.extractionSuccess=!1,$scope.loaderFlag=!1,$scope.extractedObj={},$scope.reAnnotateFileName="",$scope.staticPath="http://localhost:4200/analytics/annotool/"+$scope.streamId+"/"+$scope.callbacks.fileId,$scope.prevsFileId="",window.location.href&&window.location.href.includes("localhost")?$scope.pdfAnnoUrl="http://localhost:4200/analytics/annotool/"+$scope.streamId+"/"+$scope.callbacks.fileId:$scope.pdfAnnoUrl=window.appConfig.API_SERVER_URL+"/analytics/annotool/"+$scope.streamId+"/"+$scope.callbacks.fileId;var iframe=$("#pdfanno");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")}),setTimeout(function(){initData()},4e3)}),$rootScope.$on("pdfAnnoIframeEvent",function(e,formEvent){var iframePaylod=formEvent.payload;"payload"===iframePaylod.type&&(initData(),$scope.payload=iframePaylod.data),"close"===iframePaylod.type&&$scope.goBack(),"init"===iframePaylod.type&&($scope.isIframeLoaded=iframePaylod.isIframeLoaded)}),$scope.callbacks.updateIframeData=function(){if($scope.lodingForm=!0,$scope.pdfAnnoUrl=window.appConfig.API_SERVER_URL+"/analytics/annotool/"+$scope.streamId+"/"+($scope.callbacks.fileId||""),$scope.prevsFileId=$scope.callbacks.fileId,$scope.callbacks.listData&&$scope.callbacks.listData.hasOwnProperty("fileId")){var payload={type:"refreshFileId",fileId:$scope.callbacks.listData.fileId};jsEvents.postMessageToChildIframes("pdfAnnoEvent","pdfAnnoIframeEvent",payload)}userGuideModal(),initData()},$scope.isFormValid=function(){return Object.keys($scope.payload).length?$scope.payload.title.length||$scope.payload.header.length||$scope.payload.footer.length||$scope.payload.ignoreText.length||$scope.payload.ignorePages.length?!0:void 0:!1},$scope.formReset=function(){$scope.extractionSuccess=!1,$scope.loaderFlag=!1,$scope.extractedObj={},$scope.payload={},$scope.closeReviewModal()};var closeFullPageModal=function(){$("body").hasClass("bt-modal-open")&&($("body").removeClass("bt-modal-open"),$(".modal-backdrop").remove()),$scope.callbacks.goBackFromAnnoToKG(),$scope.formReset(),setTimeout(function(){$("#btFullpageModal").modal("hide")},500)};$scope.goBack=function(){closeFullPageModal()},$scope.callbacks.reAnnotateDocument=function(listData){var payload={type:"reannotate",listData:listData};if(listData.name&&($scope.callbacks.listData=listData,$scope.reAnnotateFileName=listData.name,$scope.callbacks.fileName=listData.name,$scope.callbacks.fileId=listData.fileId),$scope.formReset(),$scope.lodingForm=!0,$scope.callbacks.listData&&$scope.callbacks.listData.hasOwnProperty("fileId"))if($scope.isIframeLoaded)jsEvents.postMessageToChildIframes("pdfAnnoEvent","pdfAnnoIframeEvent",payload);else if(!$scope.isIframeLoaded)var interval=setInterval(function(){$scope.isIframeLoaded&&(jsEvents.postMessageToChildIframes("pdfAnnoEvent","pdfAnnoIframeEvent",payload),clearInterval(interval))},1e3);initData()},$scope.startExtractionProcess=function(){$scope.isFormValid()&&!$scope.extractionSuccess?($scope.loaderFlag=!0,$scope.callbacks.listData&&$scope.callbacks.listData.streamId&&$scope.callbacks.listData._id&&("failed"===$scope.callbacks.listData.status||"success"===$scope.callbacks.listData.status)&&!$scope.callbacks.listData.createCopy?BTStreamsService.kgKeDelete($scope.callbacks.listData.streamId,$scope.callbacks.listData._id).then(function(res){annotateExtraction()},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&(NotificationService.notify(err.data.errors[0].msg,"error"),annotateExtraction())}):annotateExtraction()):$scope.isFormValid()&&$scope.extractionSuccess?$scope.openReviewModal():NotificationService.notify("Please annotate pdf","error")},$scope.reviewQuestions=function(){$scope.isFormValid()&&$scope.extractionSuccess?Object.keys($scope.extractedObj).length&&($scope.extractedObj.pdfType=!0,$scope.callbacks.updateAnnoKgExtractTwo($scope.extractedObj),$scope.closeReviewModal()):$scope.callbacks.listData&&"success"===$scope.callbacks.listData.status?($scope.callbacks.listData.pdfType=!0,$scope.callbacks.updateAnnoKgExtractTwo($scope.callbacks.listData),$scope.closeReviewModal()):NotificationService.notify("You can only review the questions once you have annotated and extracted","error")},$scope.extractAgain=function(){$scope.extractionSuccess=!1,$scope.closeReviewModal()},$scope.callbacks.kgExtNewCallback.goBackFromOntoNew=function(){closeFullPageModal(),$(".kg-extraction-form-two").modal("hide"),$scope.callbacks.goBackFromAnnoToKG()},$scope.clockwise=function(){var data={type:"clockwise"};jsEvents.postMessageToChildIframes("pdfAnnoEvent","pdfAnnoIframeEvent",data)},$scope.anticlockwise=function(){var data={type:"anticlockwise"};jsEvents.postMessageToChildIframes("pdfAnnoEvent","pdfAnnoIframeEvent",data)},$scope.openReviewModal=function(){$("#review-modal").modal("show")},$scope.closeReviewModal=function(){$("#review-modal").modal("hide")},init()}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("btPerformance",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-performance/bt-performance.html",controller:"btPerformanceController"}}),_module.controller("btPerformanceController",["$scope","env_conf","$rootScope","BTStreamsService","$workflowService","BTIdpService","NotificationService","i18n","jsEvents","$sce","channelsConfig",function($scope,env_conf,$rootScope,BTStreamsService,$workflowService,BTIdpService,NotificationService,i18n,jsEvents,$sce,channelsConfig){function setIframeStorage(){if(window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))){var jStorage=JSON.parse(localStorage.getItem("jStorage")),iframeTab=window.open("http://localhost:4200");iframeTab.localStorage.setItem("jStorage",JSON.stringify(jStorage)),iframeTab.close()}}function initData(){$scope.lodingForm=!1}$scope.streamId=$workflowService.selectedStream()._id,$scope.stream=$workflowService.selectedStream(),$scope.lodingForm=!0,$scope.assetsBase=env_conf["assets-url"],window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.iframeUrl=$sce.trustAsResourceUrl("http://localhost:4200/analytics/dashboards/"+$scope.streamId+"/performance"):$scope.iframeUrl=window.appConfig.API_SERVER_URL+"/analytics/dashboards/"+$scope.streamId+"/performance";var iframe=$("#performance");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")}),setTimeout(function(){initData()},0)}),setIframeStorage()}])}(angular),function(ng){"use strict";var _component=ng.module("bt-components");_component.directive("planUsage",function(){return{restrict:"AE",scope:{cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-plan-usage/bt-plan-usage.html",controller:"btPlanUsageController"}}),_component.controller("btPlanUsageController",["$scope","$rootScope","$location","$workflowService","$timeout","$applicationService","BTStreamsService","NotificationService","$q","env_conf","i18n","BTFlowtaskService","$modal","localstore","$sce","$translator","mixPanel",function($scope,$rootScope,$location,$workflowService,$timeout,$applicationService,BTStreamsService,NotificationService,$q,env_conf,i18n,BTFlowtaskService,$modal,localstore,$sce,$translator,mixPanel){function getBillingSessions(){var payload={startDate:$scope.startDate.toISOString(),endDate:$scope.endDate.toISOString(),type:$scope.filterDate.value||"",streamId:$workflowService.selectedStream()._id};"date_custom"===$scope.filterDate.value&&(payload.type="date_day"),$scope.filterComponent=payload,console.log(payload),$scope.chartLoader=!0,$("#barGraph").html(""),BTStreamsService.getBillingsession(payload).then(function(res){res=res.data,$scope.averageSessions=res.averageSessions,drawBarGraph(res.modifiedResult)},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),$(".convoLoader").addClass("hide"),$(".noTasksDiv").removeClass("hide"),$scope.chartLoader=!1})}function initCustomDP(){$timeout(function(){daterangepickerInput=$("#planUsageDaterange").daterangepicker({startDate:$scope.startDate||moment.parseZone(),endDate:$scope.endDate||moment.parseZone(),maxDate:moment.parseZone(new Date).format("MM-DD-YYYY"),opens:"right",drops:"down",parentEl:"#planUsagePicker",customClass:"bot-dash-datepicker",locale:{applyLabel:i18n.i18nString("apply"),cancelLabel:i18n.i18nString("cancel")}}),$("#planUsageDaterange").on("apply.daterangepicker",function(ev,picker){if(ev){var timezone=moment.tz.guess();"America/Los_Angeles"===timezone?$scope.startDate=moment.parseZone(picker.startDate,timezone).add({hour:1,day:0}):$scope.startDate=moment.parseZone(picker.startDate,timezone).add({day:1}),$scope.endDate=moment.parseZone(picker.endDate,timezone),$scope.endDate.diff($scope.startDate,"days")>180?NotificationService.notify("Custom date interval of maximum 180 days allowed.","warning"):getBillingSessions()}}),$("#planUsageDaterange").on("cancel.daterangepicker",function(){"7days"==$scope.appliedSelectedRange?($("#planUsageDaterange").data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$("#planUsageDaterange").data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),$(".filer-btns .nav-pills li.left a").click()):"24hours"==$scope.appliedSelectedRange&&($("#planUsageDaterange").data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$("#planUsageDaterange").data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),$(".filer-btns .nav-pills li.center a").click())}),$("#planUsageDaterange").on("outsideClick.daterangepicker",function(){"7days"==$scope.appliedSelectedRange?($("#planUsageDaterange").data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$("#planUsageDaterange").data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),$(".filer-btns .nav-pills li.left a").click()):"24hours"==$scope.appliedSelectedRange&&($("#planUsageDaterange").data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$("#planUsageDaterange").data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),$(".filer-btns .nav-pills li.center a").click())})},300)}function drawBarGraph(data){if($(".convoLoader").addClass("hide"),$("#barGraph").html(""),data.length){$(".noTasksDiv").addClass("hide");var noDataFound=data.every(function(res){return 0===res.billingSessions});if(noDataFound)return $(".noTasksDiv").removeClass("hide"),void($scope.chartLoader=!1)}else $(".noTasksDiv").removeClass("hide");$scope.chartLoader=!1,"date_month"===$scope.filterDate.value?data.forEach(function(d){d.date=moment.parseZone(d.date).format("MMM-YY"),d.billingSessions=+d.billingSessions}):data.forEach(function(d){d.date=moment.parseZone(d.date).format("DD-MMM"),d.billingSessions=+d.billingSessions}),$scope.chartLoader=!1,setTimeout(function(){var margin={top:20,bottom:40,left:40,right:2},width=$("#barGraph").width()-margin.left-margin.right,height=350-margin.top-margin.bottom,tooltip=d3.select("#barGraph").append("div").attr("class","toolTip").style("opacity",0),svg=d3.select("#barGraph").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),x=null;x=data.length>2?d3.scaleBand().range([1,width]).padding(.5):d3.scaleBand().range([1,width]).padding(.8),x.domain(data.map(function(d){return d.date}));var xAxis=d3.axisBottom().scale(x).tickSize(0).tickPadding([10]),xAxisDataLength=x.domain().length;xAxisDataLength>8&&17>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%2===0})).scale(x):xAxisDataLength>16&&33>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%3===0})).scale(x):xAxisDataLength>32&&49>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%5===0})).scale(x):xAxisDataLength>48&&65>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%7===0})).scale(x):xAxisDataLength>64&&90>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%10===0})).scale(x):xAxisDataLength>89&&120>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%12===0})).scale(x):xAxisDataLength>119&&140>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%14===0})).scale(x):xAxisDataLength>139&&160>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%16===0})).scale(x):xAxisDataLength>159&&180>xAxisDataLength?xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%18===0})).scale(x):xAxisDataLength>179&&(xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%20===0})).scale(x)),svg.append("g").attr("transform","translate(0,"+height+")").call(xAxis);var y0Max=d3.max([d3.max(data,function(d){return d.billingSessions})]),y=d3.scaleLinear().domain([0,y0Max]).range([height,0]),yAxisLeft=d3.axisLeft().scale(y).tickSizeInner(-width).tickSizeOuter(0).tickPadding(7);y0Max>7?yAxisLeft.tickValues([0,1*y0Max/5,2*y0Max/5,3*y0Max/5,4*y0Max/5,5*y0Max/5]):yAxisLeft.tickValues(d3.range(0,y0Max+1)).tickFormat(d3.format(",.0f")),svg.append("g").call(yAxisLeft).attr("class","yAxis"),svg.append("g").attr("class","grid").call(yAxisLeft.tickSize(-width,0,0).tickFormat("")),svg.selectAll("barGraph").data(data).enter().append("rect").attr("x",function(d){return x(d.date)}).attr("y",function(d){return y(d.billingSessions)}).attr("width",x.bandwidth()).attr("height",function(d){return height-y(d.billingSessions)}).attr("fill","#0D6EFD").on("mouseover",function(d){tooltip.html('<div><span class="title">Date: </span><span class="value">'+d.date+'</span></div><div><span class="title">'+(1===$scope.selectedAccount.accountType?"Requests":"Sessions")+': </span><span class="value">'+d.billingSessions+"</span></div>").style("opacity",1).style("display","block")}).on("mousemove",function(d){tooltip.style("left",d3.event.pageX-300+"px").style("top",d3.mouse(this)[1]-50+"px")}).on("mouseleave",function(d){tooltip.style("opacity",0).style("display","none")})},0)}function getActivePlan(){if($scope.selectedStream=$workflowService.selectedStream(),$scope.selectedStream&&($scope.selectedStream.license&&($scope.cb.license=$scope.selectedStream.license,$scope.cb.license.totalCredits=$scope.cb.license.baseAllowedCredits+$scope.cb.license.extraCredits-$scope.cb.license.creditsUsed||0,$scope.cb.license.totalSessions=$scope.cb.license.baseAllowedSessions+$scope.cb.license.extraSessions-$scope.cb.license.sessionsUsed||0,$scope.cb.license.totalRequests=($scope.cb.license.baseAllowedRequests||0)-($scope.cb.license.requestsUsed||0),console.log($scope.cb.license)),$scope.selectedStream.supportplan)){if($scope.supportplan=$scope.selectedStream.supportplan,"year"===$scope.supportplan.billingPeriodUnit?($scope.supportPlanSwitch=!0,$scope.cb.supportPlans=$scope.cb.availableSupportPlansYear):($scope.supportPlanSwitch=!1,$scope.cb.supportPlans=$scope.cb.availableSupportPlansMonth),$scope.supportplan.endDate){var currentDate=moment(),endDate=moment($scope.supportplan.endDate);$scope.supportplan.remainingDays=endDate.diff(currentDate,"days")}console.log($scope.supportplan)}$scope.cb.license&&$scope.cb.license.planId&&($scope.currPlanId=$scope.cb.license.planId)}function getPlans(){$scope.isLoading=!0,BTStreamsService.getPlans($workflowService.selectedStream()._id,{}).then(function(res){res&&res.data&&($scope.cb.plans=res.data),getActivePlan(),$scope.isLoading=!1},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),$scope.isLoading=!1})}function getSupportPlans(){$scope.isLoading=!0,BTStreamsService.getSupportPlans($workflowService.selectedStream()._id).then(function(res){res&&res.data&&(res.data=_.sortBy(res.data,"planAmount"),$scope.cb.availableSupportPlansYear=_.filter(res.data,function(pln){return"year"===pln.billingPeriodUnit||"free"===pln._id}),$scope.cb.availableSupportPlansMonth=_.filter(res.data,function(pln){return"year"!==pln.billingPeriodUnit||"free"===pln._id}),$scope.cb.supportPlans=$scope.cb.availableSupportPlansYear),getActivePlan(),$scope.isLoading=!1},function(err){err&&err.data&&err.data.errors&&NotificationService.notify(err.data.errors[0].msg,"error"),$scope.isLoading=!1})}function getPlanValidations(){BTStreamsService.planValidation($scope.streamId).then(function(res){if(res&&res.data){var planvalidation=res.data,keys=Object.keys(planvalidation);keys&&keys.length?keys.forEach(function(key,i){var findIndex={};"month"===key?(findIndex=$scope.cb.plans.findIndex(function(item){return item._id===key}),-1!==findIndex&&($scope.cb.plans[findIndex].planvalidation=planvalidation[key]||[])):("month"!==key||"trial"===key)&&(findIndex=$scope.cb.plans.findIndex(function(item){return item._id===key}),-1!==findIndex&&($scope.cb.plans[findIndex].planvalidation=planvalidation[key]||[]))}):($scope.cb.plans&&$scope.cb.plans.forEach(function(item){item&&item.planvalidation&&delete item.planvalidation}),$scope.cb.plans&&$scope.cb.plans.forEach(function(item){item&&item.planvalidation&&delete item.planvalidation}))}},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error")})}function doPayment(){$scope.isIframeLoading=!0;var currentUrl=window.location.href,planIdCheck="paypro"===currentUser.billingSoftware?_.find($scope.cb.plans,{_id:$scope.targetPlanId||$scope.currPlanId}).productId:$scope.targetPlanId||$scope.currPlanId;if(!$scope.quantity)return void NotificationService.notify("Please enter quantity","error");var _params={productId:planIdCheck,streamId:$scope.streamId},payload={streamId:$scope.streamId,streamName:$workflowService.selectedStream().name,redirect_url:currentUrl,cancel_url:currentUrl,quantity:Number($scope.quantity)};BTStreamsService.planCheckout(_params,payload).then(function(res){if(res&&res.data){window.location.href&&window.location.href.includes("localhost")?$scope.iframeUrl=$sce.trustAsResourceUrl(res.data.hosted_page.url):$scope.iframeUrl=$sce.trustAsResourceUrl(res.data.hosted_page.url);var iframe=$("#payProIframe");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")}),setTimeout(function(){$scope.isIframeLoading=!1},0)}),$("#planPaymentConfirm").modal("show"),"paypro"===currentUser.billingSoftware&&(currentTransactionId=res.data.hosted_page.id),"paypro"===currentUser.billingSoftware?checkBotPaymentStatusNew():checkUrlOnline=setInterval(function(){checkURLchange(window.location.href,currentUrl)},2e3),$scope.closeCustomModal("reloadPlanModal")}},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),$scope.isIframeLoading=!1})}function getBTStreamsAndUpdate(initLoad){BTStreamsService.getBTStream($scope.streamId).then(function(res){$workflowService.selectedStream(res.data),$scope.selectedStream=$workflowService.selectedStream(),$scope.cb.confirmPublish&&$scope.cb.confirmPublish(),initLoad||init()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})}function groupBy(dataToGroupOn,fieldNameToGroupOn,fieldNameForGroupName,fieldNameForChildren){var result=_.chain(dataToGroupOn).groupBy(fieldNameToGroupOn).map(function(value,key){return{name:key,tasks:value}}).value();return console.log(result),result&&result.length&&result.forEach(function(item){item.tasks=_.chain(item.tasks).groupBy("path").map(function(value){var nestedVal=_.chain(value).groupBy("path").map(function(item,ind){return{name:ind,tasks:item,desc:item&&item[0]&&item[0].description?item[0].description:""}}).value();return nestedVal}).value(),item.tasks=_.flatten(item.tasks)}),result}function getAppControls(){var url="mp.user.appControlList",params={userId:currentUser.userInfo.id};$translator.translate(url,params).then(function(res){$scope.appControls=res.data;var _selectedAccount=$workflowService.selectedAccount();if(_selectedAccount&&_selectedAccount.accountId){var selectedAccount=_.find($scope.appControls.associatedAccounts,{accountId:_selectedAccount.accountId});$scope.selectedAccount&&($workflowService.selectedAccount(selectedAccount),$scope.selectedAccount=$workflowService.selectedAccount())}})}function mixPanelUpdateEvent(type){var _eventPayload={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,Category:"Monetisation","Sub Category":"Subscriptions",Level:"MONETISATION"},event="";"openedUsagePlanSlider"===type?event="Subscription - Plans displayed":"choosePlan"===type&&($scope.targetPlanId&&(_eventPayload.planId=$scope.targetPlanId,_eventPayload.planName=_.find($scope.cb.plans,{_id:$scope.targetPlanId}).name),event="Subscription - Plan Chosen"),console.log(event,_eventPayload),event&&mixPanel.postEvent(event,_eventPayload)}$scope.assetsPath=env_conf["assets-url"],$scope.basicPlan=env_conf["context-url"]+"/assets/billing/basic-plan.svg",$scope.standardPlan=env_conf["context-url"]+"/assets/billing/standard-plan.svg",$scope.enterprisePlan=env_conf["context-url"]+"/assets/billing/enterprise-plan.svg",$scope.autoRefresh=env_conf["context-url"]+"/assets/billing/auto-refresh.svg",$scope.freePlaceholder=env_conf["context-url"]+"/assets/billing/free-placeholder.svg",$scope.adminPlaceholder=env_conf["context-url"]+"/assets/billing/admin-placeholder.svg",$scope.closeDark=window.appConfig.CONTEXT_PATH+"/assets/icons-new/close/close-dark.svg",$scope.tasksPerformance=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/tasksPerformance.svg",$scope.streamId=$workflowService.selectedStream()._id,$scope.botName=$workflowService.selectedStream().name,$scope.selectedStream=$workflowService.selectedStream(),$scope.streamsAll=$workflowService.streamsAll(),$scope.appControls=$applicationService.userInfo().appControls;var currentUser=localstore.getAuthData().currentAccount;$scope.isLoading=!1,$scope.chartLoader=!1,$scope.planValidationDetails={},$scope.planValHeaders=[],$scope.planSelection=!1,$scope.supportPlanSelection=!1,$scope.planAmounts=[100,200,500,1e3],$scope.isIframeLoading=!1,$scope.currPlanId="",$scope.targetPlanId="",$scope.currentSelectedPlan={},$scope.iframeUrl="",$scope.selectedAccount=$workflowService.selectedAccount(),$scope.changePlanConfirm={},$scope.planConfirmDetails={},$scope.rightClass="right0",$scope.minReloadAmtinput=null,$scope.mantReloadAmtinput=null,$scope.quantity=null,$scope.averageSessions=0,$scope.planupdateType="",$scope.supportPlanSwitch=!0,$scope.paymentDetails=!1,$scope.filterDate={name:"Date",value:"date_day"},$scope.subDate={name:"1 Week",value:1},$scope.filterList=[{name:"Date",value:"date_day"},{name:"Month",value:"date_month"},{name:"Custom",value:"date_custom"}],$scope.subFilterList=[{name:"1 Week",value:1},{name:"2 Weeks",value:1},{name:"3 Weeks",value:3},{name:"4 Weeks",value:4}],$scope.endDate=moment(),$scope.startDate=moment().subtract(7,"days"),$scope.appliedSelectedDays=-1,$scope.filterComponent={startDate:"",endDate:""},$scope.supportplan={},$scope.supportHelpHtml='<p class="switchStatus">Switching plans is disabled</p><div class="desc" ><p class="path">You can reach out to us for switching your plan intervals</p><a href="https://support.kore.ai/" target="_blank">Contact Us</a></div>',$scope.viewMode=!1,$scope.autoReloadSwitch=!1;var currentTransactionId,checkUrlOnline,checkUrlTrial,daterangepickerInput;$scope.compareDetails=!1,$scope.faqsList={usagePlans:[{id:1,name:i18n.i18nString("usageplan_faq1"),url:$rootScope.helpLinks.RAND_355},{id:2,name:i18n.i18nString("usageplan_faq2"),url:$rootScope.helpLinks.RAND_355},{id:3,name:i18n.i18nString("usageplan_faq3"),url:$rootScope.helpLinks.RAND_355},{id:4,name:i18n.i18nString("usageplan_faq4"),url:$rootScope.helpLinks.RAND_355},{id:5,name:i18n.i18nString("usageplan_faq5"),url:$rootScope.helpLinks.RAND_355}],supportPlans:[{id:1,name:i18n.i18nString("usageplan_faq1"),url:$rootScope.helpLinks.RAND_355},{id:2,name:i18n.i18nString("usageplan_faq2"),url:$rootScope.helpLinks.RAND_355},{id:3,name:i18n.i18nString("usageplan_faq3"),url:$rootScope.helpLinks.RAND_355},{id:4,name:i18n.i18nString("usageplan_faq4"),url:$rootScope.helpLinks.RAND_355},{id:5,name:i18n.i18nString("usageplan_faq5"),url:$rootScope.helpLinks.RAND_355}]},$scope.changeQuantity=function(val){$scope.quantity=Number(val)},$scope.openPlanSlider=function(){$scope.planSelection=!0,$scope.streamsAll=$workflowService.streamsAll(),
setTimeout(function(){$scope.$parent.openModalSlider("#managePlanSelectionSlider"),$(".m-body-sec").scrollTop(0),$(".headerSticky").addClass("hide"),$(".footerSticky").addClass("hide")},500),mixPanelUpdateEvent("openedUsagePlanSlider")},$scope.closeSlider=function(){$scope.cb.plansSlider=!1,$scope.cb.planSelection===!0&&$scope.cb.close?$scope.cb.close():($scope.$parent.closeModalSlider("#managePlanSelectionSlider"),$scope.planSelection=!1),$scope.paymentDetails=!1,$scope.cb.openImportModal&&$scope.cb.openImportModal()},$scope.openSupportSlider=function(){$scope.supportPlanSelection=!0,setTimeout(function(){$scope.$parent.openModalSlider("#manageSupportPlanSlider"),$(".m-body-sec").scrollTop(0),$(".headerSticky").addClass("hide")},500),$scope.getDetails("support")},$scope.closeSupportSlider=function(){$scope.cb.plansSlider=!1,$scope.cb.supportPlan===!0&&$scope.cb.close?$scope.cb.close():($scope.$parent.closeModalSlider("#manageSupportPlanSlider"),$scope.supportPlanSelection=!1),$scope.paymentDetails=!1},$scope.reload=function(){$("#autoReload").modal("hide"),$("#reloadPlanModal").modal("show")},$scope.closeReloadModal=function(){$scope.closeCustomModal("reloadPlanModal"),$scope.cb.plansSlider=!1,$scope.cb.reloadAmount===!0&&$scope.cb.close&&$scope.cb.close()},$scope.autoReload=function(){$("#reloadPlanModal").modal("hide"),$("#autoReload").modal("show"),$scope.cb.license&&$scope.cb.license.freemiumSetting&&($scope.minReloadAmtinput=$scope.cb.license.freemiumSetting.autoRechargeThreshold,$scope.mantReloadAmtinput=$scope.cb.license.freemiumSetting.autoRechargeAmount)},$scope.closeautoReloadModal=function(){$scope.closeCustomModal("autoReload"),$scope.cb.plansSlider=!1,$scope.cb.reloadAmount===!0&&$scope.cb.close&&$scope.cb.close()},$scope.selectAmount=function(amt){$scope.quantity=amt},$scope.proceedToPay=function(){return $scope.quantity?void doPayment():void NotificationService.notify("Please enter quantity","error")},$scope.checkQuantityPrice=function(){$scope.quantity?doPayment():NotificationService.notify("Please enter amount","warning")},$scope.selectComponent=function(innerRightViewElement){$scope.$parent&&$scope.$parent.setSubMenuToOpen?$scope.$parent.setSubMenuToOpen(innerRightViewElement):$scope.cb&&$scope.cb.navigateTo&&($scope.cb.navigateTo("",innerRightViewElement),$scope.closeSlider())},$scope.selectedDate=function(type){$scope.filterDate=type,$scope.subDate={},"date_day"===type.value?($scope.subDate={name:"1 Week",value:1},$scope.selectSubDate($scope.subDate),$scope.subFilterList=[{name:"1 Week",value:1},{name:"2 Weeks",value:1},{name:"3 Weeks",value:3},{name:"4 Weeks",value:4}]):"date_month"===type.value?($scope.subDate={name:"1 Month",value:1},$scope.selectSubDate($scope.subDate),$scope.subFilterList=[{name:"1 Month",value:1},{name:"2 Months",value:2},{name:"3 Months",value:3},{name:"6 Months",value:6}]):"date_custom"===type.value&&($scope.subFilterList=[],initCustomDP())},$scope.selectSubDate=function(type){$scope.subDate=type,$scope.endDate=moment.parseZone(),$scope.filterDate&&type.value&&("date_day"===$scope.filterDate.value?$scope.startDate=moment.parseZone().subtract(type.value,"weeks"):"date_month"===$scope.filterDate.value&&($scope.startDate=moment.parseZone().subtract(type.value,"months"))),getBillingSessions()},$scope.exportBillingSession=function(){var params={startDate:$scope.startDate.toISOString(),endDate:$scope.endDate.toISOString(),type:$scope.filterDate.value||"",streamId:$workflowService.selectedStream()._id,timezone:moment.tz.guess()};NotificationService.notify("Downloading started","success"),console.log(params),BTStreamsService.downloadBillingsession(params).then(function(res){res=res.data;var fileName=$scope.selectedStream.name+"_BillingSessions.csv";$("#exportBillingLink").attr("href",res.fileUrl),$("#exportBillingLink").attr("download",fileName),$("#exportBillingLink")[0].click(),NotificationService.notify("Downloaded successfully","success")},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),$scope.chartLoader=!1})},$scope.toggleMonthYear=function(event){$scope.supportPlanSwitch?($scope.cb.supportPlans=$scope.cb.availableSupportPlansMonth,$scope.supportPlanSwitch=!1):($scope.cb.supportPlans=$scope.cb.availableSupportPlansYear,$scope.supportPlanSwitch=!0)},$scope.openCancelSubsModal=function(){$scope.openCustomModal("cancelSubscription")},$scope.cancelSubscription=function(revoke){var payload={};revoke&&(payload.revoke=!0),BTStreamsService.supportPlanCancel($scope.streamId,payload).then(function(res){revoke?$scope.openCustomModal("requestCancelled"):($scope.$emit("reloadBots",$scope.selectedStream),NotificationService.notify(i18n.i18nString("success"),"success"))},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error")})},$scope.getDetails=function(type){var details=[],result=[],scrollHeight=$(".botPlansBody").height()+100||700;$scope.compareDetails=!$scope.compareDetails,$scope.cb.plans&&"plan"===type&&(details=[],$scope.cb.plans.forEach(function(plan){var validations=Object.values(plan.validations);details=details.concat(validations)}),result=groupBy(details,"category","name","tasks"),$scope.cb.planDetails=result,setTimeout(function(){$(".m-body-sec").scroll(function(){$(this).scrollTop()>700?($(".headerSticky").removeClass("hide"),$(".footerSticky").removeClass("hide")):$(this).scrollTop()<=scrollHeight&&($(".headerSticky").addClass("hide"),$(".footerSticky").addClass("hide"))})},200),setTimeout(function(){var compId=document.getElementById("comparePlans");$(".m-body-sec").scrollTop(compId.offsetTop)},500)),$scope.cb.supportPlans&&"support"===type&&(details=[],$scope.cb.supportPlans.forEach(function(plan){var validations=Object.values(plan.validations);details=details.concat(validations)}),result=groupBy(details,"category","name","tasks"),$scope.cb.planDetails=result,setTimeout(function(){$(".m-body-sec").scroll(function(){$(this).scrollTop()>700?($(".headerSticky").removeClass("hide"),$(".footerSticky").removeClass("hide")):$(this).scrollTop()<=scrollHeight&&($(".headerSticky").addClass("hide"),$(".footerSticky").addClass("hide"))})},200),setTimeout(function(){var compId=document.getElementById("comparePlans2");$(".m-body-sec").scrollTop(compId.offsetTop)},500))},$scope.choosePlan=function(id,type){$scope.targetPlanId=id;var selectedId,selectedPlan={},wantedPlan={},confirmData={},_params={};"support"===type?$scope.supportplan.planId?$scope.proceedSupportPayment():($scope.paymentDetails=!0,selectedId=$scope.targetPlanId,selectedPlan=_.find($scope.cb.supportPlans,{_id:selectedId}),selectedPlan&&($scope.changePlanConfirm={currentPlanId:$scope.currPlanId,currentPlan:$scope.supportplan.planName,newPlan:selectedPlan.name,newPrice:selectedPlan.planAmount,planAmount:selectedPlan.planAmount||0,totalCost:selectedPlan.planAmount||0,costPerRequest:selectedPlan.costPerRequest||0}),$scope.closeCustomModal("planPaymentConfirm")):($scope.currPlanId||"free"!==$scope.targetPlanId?"free"!==$scope.targetPlanId&&(!$scope.currPlanId||$scope.cb.license&&Number($scope.cb.license.totalCredits||0)<100)?($scope.paymentDetails=!0,selectedId=$scope.targetPlanId,selectedPlan=_.find($scope.cb.plans,{_id:selectedId}),selectedPlan&&($scope.changePlanConfirm={name:selectedPlan.name||"---",planAmount:selectedPlan.planAmount.toLocaleString("en-us")+".00",costPerRequest:selectedPlan.costPerRequest||0}),$scope.closeCustomModal("planPaymentConfirm")):2===$scope.cb.license.status?(wantedPlan=_.find($scope.cb.plans,{_id:$scope.targetPlanId}),confirmData={newPlan:wantedPlan.name+" - "+wantedPlan.billingUnit,newPrice:wantedPlan.costPerSession,costPerRequest:wantedPlan.costPerRequest||0},$scope.changePlanConfirm=confirmData,$("#expiredPlanUpdate").modal("show")):(_params={streamId:$scope.streamId,targetPlanId:$scope.targetPlanId},$scope.closeCustomModal("planSwitchSucess"),$(".confirmmsg").removeClass("hide"),$(".closeConfirm").addClass("hide"),$(".proceedUpdate").removeClass("hide"),$(".cancelUpdate").removeClass("hide"),BTStreamsService.planValidate(_params).then(function(res){res=res.data,confirmData={currentPlanId:$scope.currPlanId,currentPlan:$scope.cb.license.planName,newPlan:_.find($scope.cb.plans,{_id:$scope.targetPlanId}).name,newCycle:$scope.cb.license.endDate||"",newPrice:_.find($scope.cb.plans,{_id:$scope.targetPlanId}).costPerSession,updateType:res.updateType,costPerRequest:_.find($scope.cb.plans,{_id:$scope.targetPlanId}).costPerRequest},$scope.planupdateType=res.updateType,$scope.changePlanConfirm=confirmData,"upgrade"===res.updateType?"large"===$scope.targetPlanId&&$scope.cb.license.totalCredits<1e3?$scope.openCustomModal("upgradeToEnterprise"):$("#validateChangePlanUpdate").modal("show"):$("#validateChangePlanDowngrade").modal("show")},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error")})):($scope.cb.publishFreeBot=!0,$scope.selectComponent("publish"),$scope.cb.confirmPublish&&($scope.cb.publishFreeBot=!0,$scope.cb.confirmPublish()),$scope.closeSlider()),mixPanelUpdateEvent("choosePlan")),$(".m-body-sec").scrollTop(0)},$scope.proceedToSupportPay=function(){$scope.closeCustomModal("supportUpgrade"),$scope.closeCustomModal("supportDowngrade"),$scope.paymentDetails=!0},$scope.supportPlanConfirm=function(){$scope.closeCustomModal("supportDowngrade"),$scope.openCustomModal("confirmCancelSubscription")},$scope.revokeProceed=function(){$scope.cancelSubscription(!0)},$scope.revokeDownUpProceed=function(){$scope.openCustomModal("requestDownUpCancelled")},$scope.reloadBots=function(){$scope.$emit("reloadBots",$scope.selectedStream)},$scope.proceedSupportPayment=function(){$scope.isIframeLoading=!0;var selectedPlan={};selectedPlan=_.find($scope.cb.supportPlans,{_id:$scope.targetPlanId});var _payload={newPlanId:selectedPlan._id,oldPlanId:$scope.supportplan.planId||"",streamId:$scope.streamId,streamName:$scope.selectedStream.name};BTStreamsService.supportPlanChange($scope.streamId,selectedPlan.productId,_payload).then(function(res){if(res&&res.data&&res.data.hosted_page.url){window.location.href&&window.location.href.includes("localhost")?$scope.iframeUrl=$sce.trustAsResourceUrl(res.data.hosted_page.url):$scope.iframeUrl=$sce.trustAsResourceUrl(res.data.hosted_page.url);var iframe=$("#payProIframe");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")}),setTimeout(function(){$scope.isIframeLoading=!1},0)}),$("#planPaymentConfirm").modal("show")}"paypro"===currentUser.billingSoftware&&(currentTransactionId=res.data.hosted_page.id),"paypro"===currentUser.billingSoftware?checkBotPaymentStatusNew():checkUrlOnline=setInterval(function(){checkURLchange(window.location.href,currentUrl)},2e3)},function(err){$scope.isIframeLoading=!1,err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error")})},$scope.navToSupportPlans=function(){$scope.paymentDetails=!1},$scope.proceedUpdate=function(){if($(".waitLoad").removeClass("hide"),"trial"===$scope.currPlanId){$("#validateChangePlanUpdate").modal("hide"),$("#botUsePlanModal").modal("show"),$(".currentPanel").addClass("hide"),$(".botAddressPanel").removeClass("hide"),"paypro"===currentUser.billingSoftware?($(".forChargebee").addClass("hide"),$(".doNewPayment").removeClass("btn-current"),$(".supportedPaypro").removeClass("hide")):($(".forChargebee").removeClass("hide"),$(".doNewPayment").addClass("btn-current"),$(".supportedPaypro").addClass("hide")),$(".planselectionScreen").addClass("hide"),$(".planAddressScreen").removeClass("hide"),$(".doNewPayment").removeClass("hide");var selectedId=$scope.targetPlanId,selectedPlan=_.find($scope.cb.plans,{_id:selectedId});"month"===selectedPlan.billingPeriodUnit?durationType="Monthly":durationType="Annual",$(".planTypeText").text(selectedPlan.name),$(".planDuration").text(durationType),$(".selectedBotPrice").text("$ "+selectedPlan.planAmount.toLocaleString("en-us")),$(".waitLoad").addClass("hide")}else{var _params2={streamId:$scope.streamId,targetPlanId:$scope.targetPlanId},findPlan=_.find($scope.cb.plans,{_id:$scope.targetPlanId});findPlan&&(_params2.quantity=findPlan.planAmount),BTStreamsService.planChange(_params2).then(function(res){$(".confirmmsg").addClass("hide"),$scope.closeCustomModal("validateChangePlanDowngrade"),$scope.closeCustomModal("validateChangePlanUpdate"),$scope.openCustomModal("planSwitchSucess"),$(".waitLoad").addClass("hide"),init(),"publish"!==$scope.cb.page&&getBTStreamsAndUpdate()},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),$(".waitLoad").addClass("hide")})}},$scope.proceedEnterprise=function(){$scope.closeCustomModal("upgradeToEnterprise"),$scope.paymentDetails=!0;var selectedPlan=_.find($scope.cb.plans,{_id:$scope.targetPlanId});$scope.changePlanConfirm=selectedPlan},$scope.proceedUpdatePay=function(){doPayment()},$scope.getFreeSessions=function(){1===$scope.selectedAccount.accountType&&"private"===$scope.selectedStream.visibility.namespace?$scope.selectedAccount.adminPreferences&&$scope.selectedAccount.adminPreferences.autoApproval&&($scope.cb.publishFreeBot=!0,$scope.selectComponent("publish")):($scope.cb.publishFreeBot=!0,$scope.selectComponent("publish")),$scope.cb.confirmPublish&&($scope.cb.publishFreeBot=!0,$scope.cb.confirmPublish()),$scope.closeSlider(),$scope.choosePlan("free")},$scope.submitToAdmin=function(){1===$scope.selectedAccount.accountType&&$scope.selectedAccount.adminPreferences&&$scope.selectedAccount.adminPreferences.autoApproval&&($scope.cb.publishSubmitToAdmin=!0,$scope.selectComponent("publish")),"private"!==$scope.selectedStream.visibility.namespace&&($scope.cb.publishSubmitToAdmin=!0,$scope.selectComponent("publish")),$scope.cb.confirmPublish&&($scope.cb.publishSubmitToAdmin=!0,$scope.cb.confirmPublish()),$scope.closeSlider()},$scope.setupAutoReload=function(isDelete){if(!$scope.mantReloadAmtinput||!$scope.minReloadAmtinput)return void NotificationService.notify("Please enter amount","warning");if($scope.minReloadAmtinput&&$scope.mantReloadAmtinput){var params={streamId:$scope.streamId,autoRecharge:!0,autoRechargeThreshold:$scope.minReloadAmtinput,autoRechargeAmount:$scope.mantReloadAmtinput};isDelete&&(params.isDelete=!0),$(".waitLoad").removeClass("hide"),BTStreamsService.planAutoRecharge($scope.streamId,params).then(function(res){getBTStreamsAndUpdate(),$scope.reload(),NotificationService.notify(i18n.i18nString("success"),"success"),$(".waitLoad").addClass("hide")},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),$(".waitLoad").addClass("hide")})}},$scope.closeUpDownGrade=function(){$scope.closeCustomModal("planSwitchSucess"),$scope.closeCustomModal("validateChangePlanUpdate"),$scope.closeCustomModal("validateChangePlanDowngrade"),$scope.closeSlider(),getBTStreamsAndUpdate(),$scope.cb.confirmPublish?($scope.cb.publishPaidBot=!0,$scope.closeSlider(),$scope.closeCustomModal("planPaymentConfirm"),$scope.targetPlanId&&$scope.planConfirmDetails&&($scope.cb.planAmount=$scope.planConfirmDetails.amount_paid,"small"===$scope.targetPlanId?$scope.cb.planName="Basic":"medium"===$scope.targetPlanId?$scope.cb.planName="Standard":"large"===$scope.targetPlanId&&($scope.cb.planName="Enterprise"),$scope.cb.confirmPublish())):($scope.closeCustomModal("planPaymentConfirm"),$scope.selectComponent("planUsage"),$scope.cb.plansSlider||$scope.$emit("reloadBots",$scope.selectedStream))},$scope.openCustomModal=function(targetId){targetId&&$("#"+targetId).modal("show")},$scope.closeCustomModal=function(targetId){targetId&&$("#"+targetId).modal("hide")},$scope.closePaymentModal=function(){$scope.closeCustomModal("planPaymentConfirm"),clearInterval(checkUrlOnline),clearInterval(checkUrlTrial),checkUrlOnline=void 0,checkUrlTrial=void 0,currentTransactionId=void 0,$scope.cb.plansSlider=!1},$scope.gotoDetails=function(){$scope.cb.confirmPublish?($scope.cb.publishPaidBot=!0,$scope.closeSlider(),$scope.closeCustomModal("planPaymentConfirm"),$scope.targetPlanId&&$scope.planConfirmDetails&&($scope.cb.planAmount=$scope.planConfirmDetails.amount_paid,"small"===$scope.targetPlanId?$scope.cb.planName="Basic":"medium"===$scope.targetPlanId?$scope.cb.planName="Standard":"large"===$scope.targetPlanId&&($scope.cb.planName="Enterprise"),$scope.cb.confirmPublish())):($scope.closeCustomModal("planPaymentConfirm"),$scope.selectComponent("planUsage"),$scope.cb.plansSlider||$scope.$emit("reloadBots",$scope.selectedStream))},$scope.paymentDone=function(){var selectedId,selectedPlan;$scope.planSelection?($scope.closeCustomModal("planPaymentConfirm"),selectedId=$scope.targetPlanId,selectedPlan=_.find($scope.cb.plans,{_id:selectedId}),selectedPlan&&($scope.changePlanConfirm={newPlan:selectedPlan.name||"---",newPrice:selectedPlan.costPerSession,costPerRequest:selectedPlan.costPerRequest}),"private"!==$scope.selectedStream.visibility.namespace?$scope.openCustomModal("planSwitchSucess"):$scope.closeUpDownGrade()):$scope.supportPlanSelection?($scope.closeCustomModal("planPaymentConfirm"),selectedId=$scope.targetPlanId,selectedPlan=_.find($scope.cb.plans,{_id:selectedId}),selectedPlan&&($scope.changePlanConfirm={newPlan:selectedPlan.name||"---",currentPlan:$scope.supportplan.planName}),$scope.reloadBots()):$scope.cb.reloadAmount?($scope.closeCustomModal("planPaymentConfirm"),$scope.$emit("reloadBots",$scope.selectedStream)):($scope.closeCustomModal("planPaymentConfirm"),$scope.cb.plansSlider||$scope.$emit("reloadBots",$scope.selectedStream),$scope.selectComponent("planUsage"))},$scope.isAdminCheck=function(){var _selectedAcc=$workflowService.selectedAccount();return _selectedAcc&&_selectedAcc.roles&&_selectedAcc.roles.length>0?($scope.viewMode=!1,!0):($scope.viewMode=!0,!1)},$scope.contactUs=function(){window.open("https://kore.ai/contact-us/"),$scope.targetPlanId="large",mixPanelUpdateEvent("choosePlan")},$scope.gotoDashboard=function(){$scope.selectComponent("summary")},$scope.redirectToUrl=function(url){window.open(url)};var checkBotPaymentStatusNew=function(){if(currentTransactionId){var _params={reqId:currentTransactionId,streamId:$scope.streamId};BTStreamsService.paymentstatus(_params).then(function(res){res=res.data,"success"===res.status?($(".iframeContent").addClass("hide"),$(".confirmPay").removeClass("hide"),$scope.planConfirmDetails=res,clearInterval(checkUrlOnline),clearInterval(checkUrlTrial),checkUrlOnline=void 0,checkUrlTrial=void 0,currentTransactionId=void 0):"failed"===res.status?($("#planPaymentConfirm").modal("hide"),clearInterval(checkUrlOnline),clearInterval(checkUrlTrial),checkUrlOnline=void 0,checkUrlTrial=void 0,currentTransactionId=void 0):"pending"===res.status&&setTimeout(function(){checkBotPaymentStatusNew()},2e3)},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error"),clearInterval(checkUrlOnline),clearInterval(checkUrlTrial),checkUrlOnline=void 0,checkUrlTrial=void 0,currentTransactionId=void 0})}},checkURLchange=function(currentURL,oldURL){currentURL!==oldURL&&(checkBotPaymentStatus(),currentURL=oldURL,window.location.href=oldURL,clearInterval(checkUrlOnline),clearInterval(checkUrlTrial),checkUrlOnline=void 0,checkUrlTrial=void 0)};getBTStreamsAndUpdate(!0),$scope.formatDate=function(date){var dateOut=new Date(date);return dateOut};var init=function(){return getAppControls(),$scope.isAdminCheck(),$scope.selectedStream&&$scope.selectedStream.isDeflect?(NotificationService.notify(i18n.i18nString("plans_smart_assist_desc"),"warning"),void getSupportPlans()):($scope.cb&&$scope.cb.planSelection===!0?$scope.openPlanSlider():$scope.cb&&$scope.cb.reloadAmount?$scope.reload():$scope.cb&&$scope.cb.supportSelection===!0&&!$scope.viewMode&&$scope.openSupportSlider(),1===$scope.selectedAccount.accountType&&(getPlans(),getSupportPlans(),getPlanValidations()),void setTimeout(function(){getBillingSessions()},100))};init()}]),_component.filter("customDate",function(){return function(input){return input?moment.parseZone(input).format("DD MMM, yyyy"):input}}),_component.directive("onlyDigits",function(){return{require:"ngModel",restrict:"A",link:function(scope,element,attr){element.bind("input",function(){var position=this.selectionStart-1,fixed=this.value.replace(/[^0-9\.]/g,"");"."===fixed.charAt(0)&&(fixed=fixed.slice(1));var pos=fixed.indexOf(".")+1;pos>=0&&(fixed=fixed.substr(0,pos)+fixed.slice(pos).replace(".","")),this.value!==fixed&&(this.value=fixed,this.selectionStart=position,this.selectionEnd=position)})}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("btSupport",function(){return{restrict:"AE",scope:{callback:"=",selectedCurrentTab:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-support/bt-support.html",controller:["$scope","$workflowService","env_conf","$timeout","i18n","interactiveHelp","$element","navigator","mixPanel",function($scope,$workflowService,env_conf,$timeout,i18n,interactiveHelp,$element,navigator,mixPanel){function warnuserToOpenBot(){var msg="";msg=$(".noBotsPlaceholder:visible").length?i18n.i18nString("please_create"):i18n.i18nString("please_select_product");var message="<p><i class='fa fa-exclamation-circle fa-2x' aria-hidden='true' style='color: #009dac;'></i></p> "+msg;window.bootbox.dialog({message:message,title:"",className:"alert-modal",buttons:{main:{label:i18n.i18nString("ok_label"),className:"btn-default",callback:angular.noop}},onEscape:!1,closeButton:!1})}function warnuserToOpenProcessApp(){var msg=i18n.i18nString("please_select_process"),message="<p><i class='fa fa-exclamation-circle fa-2x' aria-hidden='true' style='color: #009dac;'></i></p> "+msg;window.bootbox.dialog({message:message,title:"",className:"alert-modal",buttons:{main:{label:i18n.i18nString("ok_label"),className:"btn-default",callback:angular.noop}},onEscape:!1,closeButton:!1})}function warnuserToNavigateToFlow(){var msg=i18n.i18nString("please_navigate_to_flow"),message="<p><i class='fa fa-exclamation-circle fa-2x' aria-hidden='true' style='color: #009dac;'></i></p> "+msg;window.bootbox.dialog({message:message,title:"",className:"alert-modal",buttons:{main:{label:i18n.i18nString("ok_label"),className:"btn-default",callback:angular.noop}},onEscape:!1,closeButton:!1})}$scope.helpDoc=env_conf["context-url"]+"/assets/help-slider-icons/support/help-doc.svg",$scope.community=env_conf["context-url"]+"/assets/help-slider-icons/support/community.svg",$scope.quick=env_conf["context-url"]+"/assets/help-slider-icons/support/quick.svg",$scope.whatsNew=env_conf["context-url"]+"/assets/help-slider-icons/support/whatsNew.svg",$scope.contactUS=env_conf["context-url"]+"/assets/help-slider-icons/support/contactUS.svg",$scope.academy=env_conf["context-url"]+"/assets/help-slider-icons/support/academy.svg",$scope.productTour=env_conf["context-url"]+"/assets/help-slider-icons/support/productTour.svg",$scope.keyboardShortcut=env_conf["context-url"]+"/assets/help-slider-icons/support/keyboardShortcut.svg",$scope.backArrow=env_conf["context-url"]+"/assets/help-slider-icons/Vector.svg",$scope.detailsIntro=env_conf["context-url"]+"/assets/help-slider-icons/support/details/details-intro.svg",$scope.detailsDialog=env_conf["context-url"]+"/assets/help-slider-icons/support/details/details-dialog.svg",$scope.detailsFaq=env_conf["context-url"]+"/assets/help-slider-icons/support/details/details-faq.svg",$scope.detailsTraining=env_conf["context-url"]+"/assets/help-slider-icons/support/details/details-training.svg",$scope.detailsTesting=env_conf["context-url"]+"/assets/help-slider-icons/support/details/details-testing.svg",$scope.detailsChannels=env_conf["context-url"]+"/assets/help-slider-icons/support/details/details-channels.svg",$scope.detailsAnalytics=env_conf["context-url"]+"/assets/help-slider-icons/support/details/details-analytics.svg",$scope.detailsConversation=env_conf["context-url"]+"/assets/help-slider-icons/support/details/details-conversation.svg",$scope.appVersion=env_conf["app-version"],$scope.buildDigitalForm=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/build_digital_form.svg",$scope.buildProcessApp=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/build_process_app.svg",$scope.configureChannel=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/configure_a_channel.svg",$scope.configureHumanTask=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/configure_human_task.svg",$scope.introductionProcessApps=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/introduction_process_apps.svg",$scope.publishProcessApp=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/publish_process_app.svg",$scope.simulateProcessApp=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/simulate_process_app.svg",$scope.analyze=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/analyze.svg",$scope.defineTriggers=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/define_Triggers.svg",$scope.integrate=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/Integrate.svg",$scope.selfServicePortal=env_conf["context-url"]+"/assets/help-slider-icons/support/process-app/Self_Service_Portal.svg",$scope.quickStartObject=[],$scope.appVersion&&($scope.uiVersion=$scope.appVersion.split(/\.(?=[^\.]+$)/)[0]),$scope.supportObject=[{title:i18n.i18nString("get_started"),desc:i18n.i18nString("explore_guides"),icon:$scope.quick,iconClass:"btx-carrot-right",openSlider:!0},{eventId:"productTour",id:"product_tour",title:i18n.i18nString("product_touR"),desc:i18n.i18nString("quick_walkthrough"),icon:$scope.productTour,iconClass:"btx-external-link1"},{eventId:"document",title:i18n.i18nString("help_documentation"),desc:i18n.i18nString("navigate_documentation"),icon:$scope.helpDoc,iconClass:"btx-external-link1",link:"https://developer.kore.ai/docs/bots/concepts/about-bots/"},{eventId:"community",title:i18n.i18nString("kore_community"),desc:i18n.i18nString("mavigate_community"),icon:$scope.community,iconClass:"btx-external-link1",link:"https://community.kore.ai/"},{eventId:"whatsNew",id:"whats_New",title:i18n.i18nString("whatsNew",{dyn:$scope.uiVersion}),desc:i18n.i18nString("notes_on_release"),icon:$scope.whatsNew,iconClass:"btx-about"},{eventId:"contactUs",title:i18n.i18nString("contact_us"),desc:i18n.i18nString("contact_support_desc"),icon:$scope.contactUS,iconClass:"btx-external-link1",link:"https://support.kore.ai/"},{eventId:"koreAcademy",title:i18n.i18nString("Academy"),desc:i18n.i18nString("get_trained_certified"),icon:$scope.academy,iconClass:"btx-external-link1",link:"https://academy.kore.ai/"},{eventId:"documentCanny",title:i18n.i18nString("submit_a_request"),desc:i18n.i18nString("submit_via_canny_request"),icon:$scope.helpDoc,iconClass:"btx-external-link1",link:window.appConfig.API_SERVER_URL+"/accounts/canny/sso"}],$scope.keyBoardShortcuts={title:i18n.i18nString("keyboard_shortcuts"),icon:$scope.keyboardShortcut,iconClass:"btx-external-link1",showSlider:!0},$element.on("click","[kr-show-interactive-help]",function(e){var _hid=$(e.currentTarget).attr("kr-show-interactive-help");if(_hid){if("TAKE_TOUR"===_hid){var helpMixpanelEvent={Level:"Support",Category:"Support","Sub Category":"Help"};mixPanel.postEvent("Enter What's New",helpMixpanelEvent)}else if("BOT_WALK_THROUGH"===_hid||"PROCESSAPP_WALK_THROUGH"===_hid){var productTourMixpanelEvent={Level:"Support",Category:"Support","Sub Category":"Help"};mixPanel.postEvent("Enter Product Tour",productTourMixpanelEvent)}if("BOT_WALK_THROUGH"===_hid){var _curState=navigator.setORGetPreviousState(),baseComponent=_curState.path[0];"botDetailsForm"!==baseComponent&&warnuserToOpenBot(),$(".btFullpageModal.modal:visible").length&&$(".closeBtn:visible").click(),$("[ng-click=\"callbacks.navigateTo('skills')\"]:visible").length&&$("[ng-click=\"callbacks.navigateTo('skills')\"]:visible").trigger("click")}if("PROCESSAPP_WALK_THROUGH"===_hid){var processAppPath=$("#processFlowsFrame")[0].contentWindow.location.pathname;"/builderx/process/flow"!==processAppPath&&("/builderx/process/home"===processAppPath?warnuserToOpenProcessApp():warnuserToNavigateToFlow())}interactiveHelp.openHelp(_hid),$scope.closeHelp()}}),$scope.updateProcessQuickStartGuide=function(){"processApps"==$scope.selectedCurrentTab?$scope.quickStartObject=[{title:i18n.i18nString("introduction_process_apps"),desc:i18n.i18nString("introduction_process_apps_desc"),icon:$scope.introductionProcessApps,extendedText:{description:i18n.i18nString("introduction_process_apps_expand"),link:"https://developer.kore.ai/docs/process-apps/getting-started/"}},{title:i18n.i18nString("build_business_flow"),desc:i18n.i18nString("build_business_flow_desc"),icon:$scope.buildProcessApp,extendedText:{description:i18n.i18nString("build_business_flow_expand"),link:"https://developer.kore.ai/docs/process-apps/flow/"}},{title:i18n.i18nString("defining_trigger"),desc:i18n.i18nString("defining_trigger_desc"),icon:$scope.defineTriggers,extendedText:{description:i18n.i18nString("defining_trigger_expand"),link:"https://developer.kore.ai/docs/process-apps/flow/triggers/"}},{title:i18n.i18nString("integrate_process_app"),desc:i18n.i18nString("integrate_process_app_desc"),icon:$scope.integrate,extendedText:{description:i18n.i18nString("integrate_process_app_expand"),link:"https://developer.kore.ai/docs/process-apps/flow/integrations/integrations/"}},{title:i18n.i18nString("digital_form_info"),desc:i18n.i18nString("digital_form_info_desc"),icon:$scope.buildDigitalForm,extendedText:{description:i18n.i18nString("digital_form_expand"),link:"https://developer.kore.ai/docs/process-apps/forms/"}},{title:i18n.i18nString("configure_delivery_channel"),desc:i18n.i18nString("configure_delivery_channel_desc"),icon:$scope.configureChannel,extendedText:{description:i18n.i18nString("configure_delivery_channel_expand"),link:"https://developer.kore.ai/docs/process-apps/settings/channels/"}},{title:i18n.i18nString("simulate_your_app"),desc:i18n.i18nString("simulate_your_app_desc"),icon:$scope.simulateProcessApp,extendedText:{description:i18n.i18nString("simulate_your_app_expand"),link:"https://developer.kore.ai/docs/process-apps/simulate/"}},{title:i18n.i18nString("self_service_portal"),desc:i18n.i18nString("self_service_portal_desc"),icon:$scope.selfServicePortal,extendedText:{description:i18n.i18nString("self_service_portal_expand"),link:"https://developer.kore.ai/docs/process-apps/self-service-portal/"}},{title:i18n.i18nString("analyze_process_app"),desc:i18n.i18nString("analyze_process_app_desc"),icon:$scope.analyze,extendedText:{description:i18n.i18nString("analyze_process_app_expand"),link:"https://developer.kore.ai/docs/process-apps/dash-board/"}}]:("bots"==$scope.selectedCurrentTab||"dataForm"==$scope.selectedCurrentTab)&&($scope.quickStartObject=[{title:i18n.i18nString("introduce_virtual"),desc:i18n.i18nString("basics_virtual"),icon:$scope.detailsIntro,extendedText:{text:i18n.i18nString("virtual_assistant_builder"),description:i18n.i18nString("learn_intelligent_va"),link:"https://developer.kore.ai/docs/bots/chatbot-overview/koreai-platform/"}},{title:i18n.i18nString("designing_conversation"),desc:i18n.i18nString("collaborate_team"),icon:$scope.detailsConversation,extendedText:{text:i18n.i18nString("conversation_desginer"),description:i18n.i18nString("reflect_cd_flows"),link:"https://developer.kore.ai/docs/bots/bot-builder-tool/bot-creation/storyboard/"
}},{title:i18n.i18nString("dialog_building"),desc:i18n.i18nString("dialog_building_desc"),icon:$scope.detailsDialog,extendedText:{text:i18n.i18nString("dialog_builder"),description:i18n.i18nString("auto_generate_cf"),link:"https://developer.kore.ai/docs/bots/chatbot-overview/using-the-dialog-builder-tool/"}},{title:i18n.i18nString("create_faqs"),desc:i18n.i18nString("enhance_kg"),icon:$scope.detailsFaq,extendedText:{text:i18n.i18nString("knowledge_graph"),description:i18n.i18nString("build_faqs"),link:"https://developer.kore.ai/docs/bots/bot-builder-tool/knowledge-task/creating-a-knowledge-graph/"}},{title:i18n.i18nString("nl_training"),desc:i18n.i18nString("train_intents_entities"),icon:$scope.detailsTraining,extendedText:{text:i18n.i18nString("multipronged_nlp"),description:i18n.i18nString("add_sample_utterance_desc"),link:"https://developer.kore.ai/docs/bots/nlp/optimizing-bots/"}},{title:i18n.i18nString("Validate"),desc:i18n.i18nString("measure_effectiveness"),icon:$scope.detailsTesting,extendedText:{text:i18n.i18nString("utterance_regression"),description:i18n.i18nString("validate_model_confusion"),link:"https://developer.kore.ai/docs/bots/test-your-bot/testing-your-bot-with-nlp/#"}},{title:i18n.i18nString("omni_channel"),desc:i18n.i18nString("enable_chat_voice_channels"),icon:$scope.detailsChannels,extendedText:{text:i18n.i18nString("channels"),description:i18n.i18nString("enable_channels_vs"),link:"https://developer.kore.ai/docs/bots/channel-enablement/adding-channels-to-your-bot/"}},{title:i18n.i18nString("analyze"),desc:i18n.i18nString("get_actionable_insights"),icon:$scope.detailsAnalytics,extendedText:{text:i18n.i18nString("metrics_dashboard"),description:i18n.i18nString("explore_nlp_models"),link:"https://developer.kore.ai/docs/bots/analyzing-your-bot/analyzing-your-bot/"}}])},$scope.closeHelp=function(){$("#helpModal .modalHeader .closeCross").click()},$scope.addbackground=function(quickStart,index){if($("#collapse"+index)&&!quickStart.expanded){quickStart.expanded=!0;var getStartedItemEvent={Level:"Support",Category:"Support","Sub Category":"Help","Getting Started item":quickStart.title};mixPanel.postEvent("Enter Getting Started item",getStartedItemEvent)}else quickStart.expanded=!1;_.forEach($scope.quickStartObject,function(quickStartValue,indexValue){quickStartValue.expanded&&index!==indexValue&&($("#collapse"+indexValue).removeClass("in"),quickStartValue.expanded=!1)})},$scope.openQuickStartSlider=!1,$scope.openSupportList=function(support){if(_.forEach($scope.quickStartObject,function(quickStartValue){quickStartValue.expanded&&($(".panel-collapse.collapse.in").removeClass("in"),quickStartValue.expanded=!1)}),$scope.updateProcessQuickStartGuide(),support.openSlider){$scope.openQuickStartSlider=!0,$scope.callback.openQuickStartSlider=!0;var getStartedEvent={Level:"Support",Category:"Support","Sub Category":"Help"};mixPanel.postEvent("Enter Getting Started",getStartedEvent)}support.link&&($scope.linkEvent(support.eventId),window.open(support.link,"_blank")),support.showSlider&&$scope.callback.showShortcut("fromSupport")},$scope.linkEvent=function(type){var event="",eventInfo={Level:"Support",Category:"Support","Sub Category":"Help"};"document"===type?event="Enter Documentation":"community"===type?event="Enter Community":"koreAcademy"===type?event="Enter Academy":"contactUs"===type&&(event="Enter Contact us"),event&&mixPanel.postEvent(event,eventInfo)},$scope.closeQuickStart=function(){$scope.openQuickStartSlider=!1,$scope.callback.openQuickStartSlider=!1},$scope.showVideo=!1,$scope.showQuickStartVideo=function(quickStart){quickStart.videoUrl&&(quickStart.playVideo=!0)},$scope.redirectToLink=function(quickStart){if(quickStart&&quickStart.extendedText&&quickStart.extendedText.link){var getStartedItemClickEvent={Level:"Support",Category:"Support","Sub Category":"Help","Getting Started item":quickStart.title};mixPanel.postEvent("View Getting Started item page",getStartedItemClickEvent),window.open(quickStart.extendedText.link,"_blank")}},console.log($scope.supportObject)}]}})}(angular),function(ng){var _taskChooserComponent=ng.module("bt-components");_taskChooserComponent.directive("btTaskChooser",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/bt-task-chooser/bt-task-chooser.html",controller:"btTaskChooserCtrl"}}),_taskChooserComponent.controller("btTaskChooserCtrl",["$scope","$location","$workflowService","$timeout","$rootScope","$modal","i18n",function($scope,$location,$workflowService,$timeout,$rootScope,$modal,i18n){var alertTasks=$workflowService.alertTasks(),actionTasks=$workflowService.actionTasks(),knowledgeTasks=$workflowService.knowledgeTasks();$scope.callback=$scope.callback||{},$scope.loaderMessage=i18n.i18nString("working_on_it_lowercase"),$scope.taskTypes=[{id:"dialog",name:i18n.i18nString("bt_task_chooser_dialog_label"),description:i18n.i18nString("bt_task_chooser_dialog_desc"),path:window.appConfig.CONTEXT_PATH+"/flowTask/new",type:"flowtask",iconClass:"fa fa-comments"},{id:"alert",name:i18n.i18nString("alert_label_capital_A"),description:i18n.i18nString("bt_task_chooser_alert_desc"),path:window.appConfig.CONTEXT_PATH+"/new",type:"alert",iconClass:"fa fa-bell"},{id:"information",name:i18n.i18nString("info_task"),description:i18n.i18nString("bt_task_chooser_info_desc"),path:window.appConfig.CONTEXT_PATH+"/new",type:"action",iconClass:"fa fa-pie-chart"},{id:"action",name:i18n.i18nString("event_action"),description:i18n.i18nString("bt_task_chooser_action_desc"),path:window.appConfig.CONTEXT_PATH+"/new",type:"action",iconClass:"fa fa-flash"},{id:"knowledge",name:i18n.i18nString("knowledge"),description:i18n.i18nString("bt_task_chooser_knowledge_desc"),path:window.appConfig.CONTEXT_PATH+"/knowledgecreate",type:"knowledge",iconClass:"fa fa-question-circle"},{id:"flows",name:i18n.i18nString("constants.flows"),description:i18n.i18nString("bt_task_chooser_alerts_desc"),path:window.appConfig.CONTEXT_PATH+"/alert/new/map/new",type:"flows",iconClass:"fa fa-link"}],$scope.callback.openTaskCreateModal=function(){$("#taskCreateOverlayModal").modal("show"),$(".taskTypeDiv ").removeClass("selected"),$("#taskCreateOverlayModal").on("shown.bs.modal",function(){$("body").addClass("modal-open"),$("body").addClass("bt-modal-open")}),$("#taskCreateOverlayModal").on("hidden.bs.modal",function(){$("body").removeClass("modal-open"),$("body").removeClass("bt-modal-open")})},$scope.isWorkProgress=!1,$scope.footerInfoTitle="What task type should I choose?",$scope.footerHeaderId="bt-task-chooser",$scope.footerPanelId="bt-task-chooser-panel",$rootScope.$on("showOrHideStatusLoader",function(evt,newValue){}),$scope.initiateWorkflowCreation=function(type){$workflowService.workflowType(type),$workflowService.mpAlertInfo({}),$workflowService.alertInfo({}),$workflowService.actionInfo({}),$workflowService.mpActionInfo({}),$workflowService.currentStep(3),$workflowService.alertData({}),$workflowService.authData({}),$workflowService.requestData({}),$workflowService.responseData({}),$workflowService.settingsData({})};var selectedTaskObject=[];$scope.getPath=function(selectedTask){return selectedTaskObject=_.filter($scope.taskTypes,function(task){return task.id===selectedTask}),$scope.initiateWorkflowCreation(selectedTaskObject[0].type),selectedTaskObject[0].path},$scope.taskObject={},$scope.taskObject.selectedTask="",$scope.gotoTaskCreation=function(){return console.log($scope.taskObject.selectedTask),"action"===$scope.taskObject.selectedTask||"information"===$scope.taskObject.selectedTask||"alert"===$scope.taskObject.selectedTask||"dialog"===$scope.taskObject.selectedTask?($scope.getPath($scope.taskObject.selectedTask),$rootScope.$broadcast("initTaskCreation"),void $scope.launchTaskGeneralInfoModal()):"flows"===$scope.taskObject.selectedTask?($scope.getPath($scope.taskObject.selectedTask),$rootScope.$broadcast("initTaskCreation"),$scope.activeEntityFlow={},void $scope.launchTaskGeneralInfoModal()):"knowledge"===$scope.taskObject.selectedTask?void $scope.callback.openOntologyModel():void $location.path($scope.getPath($scope.taskObject.selectedTask))},$scope.selectTask=function(selectedTask){$scope.taskObject.selectedTask=selectedTask,$scope.gotoTaskCreation()},$scope.callback.closeTaskCreateModal=function(){$scope.$emit("updateStep",-1),$scope.taskObject.selectedTask="",$timeout(function(){$("body").removeClass("modal-open")})},$scope.isEligibleToShow=function(taskTypeID){var isEligible="flows"==taskTypeID?(alertTasks||[]).length>0||(actionTasks||[]).length>0:!0;return"knowledge"==taskTypeID&&(isEligible=(knowledgeTasks||[]).length>0?!1:!0),isEligible},$scope.launchTaskGeneralInfoModal=function(log){var taskCreationInfo={taskType:selectedTaskObject[0].type,isReport:"information"===selectedTaskObject[0].id};$scope.$emit("updateStep",2,taskCreationInfo)}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("channelHeader",function(){return{restrict:"EA",scope:{callback:"=",tabIndex:"@",formObject:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/channel-header/channel-header.html",controller:["$scope","$workflowService",function($scope,$workflowService){$scope.wfType=$scope.callback.wfType,$scope.context=$scope.callback.context,$scope.stream=$workflowService.selectedStream(),$scope.tmpltPrePath=$scope.$root.tmpltPrePath}]}})}(angular),function(ng){angular.module("bt-components").directive("channelUxEditor",[function(){return{restrict:"EA",scope:{wfType:"=",keys:"=",context:"=",onSave:"=",onCancel:"=",response:"=",displayMode:"=",channelConfs:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/channel-ux-editor/channel-ux-editor.html",controller:["$scope","NotificationService","_constants_","koreUxMap","$workflowService","form_util","i18n",function($scope,NotificationService,_constants_,koreUxMap,$workflowService,form_util,i18n){function openModal(){$("#channel_response_editor").modal({backdrop:"static",show:!0})}function closeModal(){$("#channel_response_editor").modal("hide")}function assignUxMap(){$scope.channelConfs=$scope.responses}function mergeSameChannelUxMaps(responses,payload){var index=_.findIndex(responses,{channel:payload.channel});-1!=index?responses.splice(index,1,payload):responses.push(payload),assignUxMap()}function splitCodeIntoNormalAndCode(code){var result;return code=(code.replace(/var printf=print;/g,"")||"").trim(),result=/printf\s?[(](.+)[)]/g.exec(code),result=result&&result[1]||"",code=(code.replace(/printf\s?[(](.+)[)]/g,"")||"").trim(),code=(code.replace(/<%|%>/g,"")||"").trim(),{code:code,normal:$scope.context.transform(result)}}$scope.editor={},$scope._constants_=_constants_,$scope.tabs={},$scope.codeCallback={},$scope.channels=$workflowService.seedData().botChannelsTypes,$scope.responses=_.isArray($scope.channelConfs)?$scope.channelConfs:[],$scope.responses=$scope.responses.filter(function(channel){return"default"!=channel.channel}),$scope.web_mobile_client=i18n.i18nString("constants.iconsTooltips_rtm"),$scope.$watch("channelConfs",function(newVal,oldVal){_.isArray(newVal)&&($scope.responses=newVal.filter(function(channel){return"default"!=channel.channel}))}),$scope.notifyUser=function(type,notify){notify&&"normal"===type?NotificationService.notify(i18n.i18nString("chnl_ux_normal_editor_noty")):notify&&"code"===type&&NotificationService.notify(i18n.i18nString("chnl_ux_normal__r_js_editor_noty"))},$scope.codePreviewRep=function(){$scope.codePreviewIsOn=!0;var body=$scope.context.wrap($scope.editor.normal,$scope.editor.code),payload={payload:$scope.response,koreUxMap:{body:body}};return $scope.codePreview="",koreUxMap.execute(payload).then(function(res){$scope.codePreview=res.result,$scope.codePreviewIsOn=!1},function(err){err.error=err.error?'<div class="alert alert-sm alert-danger">'+err.error+"</div>":err.error,$scope.codePreview=err.error,$scope.codePreviewIsOn=!1})},$scope.save=function(form){if(form.$invalid)return void form_util.touch(form);if(!$scope.editor.normal&&!$scope.editor.code)return void NotificationService.notify(i18n.i18nString("pls_provide_valid_chnl_res"),"warning");var payload={channel:$scope.editor.channel,body:$scope.context.wrap($scope.editor.normal,$scope.editor.code)};"no-value"!=editIndex?$scope.responses[editIndex]=angular.copy(payload):mergeSameChannelUxMaps($scope.responses,angular.copy(payload)),$scope.onSave(ng.copy($scope.responses)),assignUxMap(),editIndex="no-value",closeModal()},$scope.cancel=function(){closeModal(),$scope.onCancel()},$scope.addChanneResponse=function(dontInitialize){dontInitialize||($scope.editor={code:"",normal:"",edit:!1},$scope.tabs.normal=!0,$scope.tabs.code=!1),editIndex="no-value",openModal(),form_util.makeItClean($scope.channel_info)},$scope.closeModal=function(){$("#channel_response_editor").modal("hide")};var editIndex="no-value";$scope.editResponse=function(index){var response,code;editIndex=index,response=$scope.responses[index],$scope.editor={edit:!0},$scope.editor.channel=response.channel,code=splitCodeIntoNormalAndCode(response.body),$scope.editor.normal=code.normal,$scope.editor.code=code.code,$scope.tabs.normal=!(!code.normal||!code.normal.trim()),$scope.tabs.code=!(!code.code||!code.code.trim()),$scope.addChanneResponse(!0)},$scope.deleteResponse=function(index){$scope.responses.splice(index,1),assignUxMap()}}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("chunkFileUpload",function(){return{restrict:"EA",scope:{chunkFileModel:"=",elementId:"=",elementName:"=",required:"=",onFileChange:"=",uploadStatus:"=",allowedFileTypes:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/chunk-file-upload/chunk-file-upload.html",controller:["$scope","$timeout","NotificationService","BTStreamsService","$workflowService","i18n","$translator","$endpoints","$applicationService",function($scope,$timeout,NotificationService,BTStreamsService,$workflowService,i18n,$translator,$endpoints,$applicationService){function getUID(pattern){var _pattern=pattern||"xxxxyx";return _pattern=_pattern.replace(/[xy]/g,function(c){var r=16*Math.random()||0,v="x"===c?r:r&&3||8;return v.toString(16)})}function cnvertFiles(_this,_file,customFileName){var recState={};if(_file&&_file.size&&_file.size>filetypes.file.limit.size)return void alert(filetypes.file.limit.msg);if(_file&&customFileName&&(_file.name=customFileName),_file&&(_file.name||customFileName)){var _fileName=customFileName||_file.name,fileType=_fileName.split(".").pop().toLowerCase();recState.name=_fileName,recState.mediaName=getUID(),recState.fileType=_fileName.split(".").pop().toLowerCase();if(filetypes.image.indexOf(recState.fileType)>-1?(recState.type="image",recState.uploadFn="acceptFileRecording"):filetypes.video.indexOf(recState.fileType)>-1?(recState.type="video",recState.uploadFn="acceptVideoRecording"):filetypes.audio.indexOf(recState.fileType)>-1?(recState.type="audio",recState.uploadFn="acceptFile"):(recState.type="attachment",recState.componentSize=_file.size,recState.uploadFn="acceptFile"),allowedFileTypes&&-1!==allowedFileTypes.indexOf(fileType))if("audio"===recState.type||"video"===recState.type){var rd=new FileReader;rd.onload=function(e){var blob=new Blob([e.target.result],{type:_file.type}),url=(URL||webkitURL).createObjectURL(blob),video=document.createElement(recState.type);video.preload="metadata",0===video.readyState?(video.addEventListener("loadedmetadata",function(evt){Math.round(evt.target.duration);"audio"===recState.type&&((URL||webkitURL).revokeObjectURL(url),getFileToken(_this,_file,recState))}),"video"===recState.type&&video.addEventListener("loadeddata",function(e){recState.resulttype=getDataURL(video),(URL||webkitURL).revokeObjectURL(url),getFileToken(_this,_file,recState)}),video.src=url):((URL||webkitURL).revokeObjectURL(url),getFileToken(_this,_file,recState))},rd.readAsArrayBuffer(_file)}else if(-1!==_file.type.indexOf("image")){var imgRd=new FileReader;imgRd.onload=function(e){var blob=new Blob([e.target.result],{type:_file.type}),url=(URL||webkitURL).createObjectURL(blob),img=new Image;img.src=url,img.onload=function(){recState.resulttype=getDataURL(img),getFileToken(_this,_file,recState)}},imgRd.readAsArrayBuffer(_file)}else getFileToken(_this,_file,recState);else{var evt={fileExtensionError:!0};$scope.fileIUploadStatus("error",evt)}}}function getAccessToken(){var authObj=$translator.getAuthObj();return authToken=authObj.token_type+" "+authObj.accessToken,authToken}function getFileToken(_obj,_file,recState){var auth=getAccessToken(),_account=$workflowService.selectedAccount();$.ajax({type:"POST",url:$endpoints.urlWithVersion+"/attachment/file/token",dataType:"json",headers:{Authorization:auth,AccountId:_account.accountId,state:"configured"},success:function(response){fileToken=response.fileToken,ele=$("#"+$scope.elementId),acceptAndUploadFile(_obj,_file,recState)},error:function(msg){msg.responseJSON&&msg.responseJSON.errors&&msg.responseJSON.errors.length&&"401"===msg.responseJSON.errors[0].httpStatus&&NotificationService.notify(msg.responseJSON.errors[0],"error")}})}function acceptAndUploadFile(_this,file,recState){var _scope=_this,ele=ele||$("#"+$scope.elementId),uc=getfileuploadConf(recState);if(uc.chunkUpload=file.size>appConsts.CHUNK_SIZE,uc.chunkSize=appConsts.CHUNK_SIZE,uc.file=file,uc.chunkUpload)notifyFlie(_scope,recState),initiateRcorder(recState,ele),$scope.koreChunkUploader(uc);else{var reader=new FileReader;reader.onloadend=function(evt){if(evt.target.readyState===FileReader.DONE){var converted=reader.result.replace(/^.*;base64,/,""),resultGet=(reader.result,converted);recState.resulttype=resultGet,acceptFileRecording(_scope,recState,ele)}},reader.readAsDataURL(file)}}function getfileuploadConf(_recState){var userId=$applicationService.userInfo().userId,_account=$workflowService.selectedAccount();return appConsts.UPLOAD={FILE_ENDPOINT:$endpoints.urlWithVersion+"/users/"+userId+"/file",FILE_TOKEN_ENDPOINT:$endpoints.urlWithVersion+"/attachment/file/token",FILE_CHUNK_ENDPOINT:$endpoints.urlWithVersion+"/users/"+userId+"/file/:fileToken/chunk"},_accessToken=getAccessToken(),_uploadConfg={},_uploadConfg.url=appConsts.UPLOAD.FILE_ENDPOINT,_uploadConfg.tokenUrl=appConsts.UPLOAD.FILE_TOKEN_ENDPOINT,_uploadConfg.chunkUrl=appConsts.UPLOAD.FILE_CHUNK_ENDPOINT,_uploadConfg.fieldName="file",_uploadConfg.data={fileExtension:_recState.fileType,fileContext:"bulkImport",filename:_recState.name},_uploadConfg.headers={Authorization:_accessToken,AccountId:_account.accountId,state:"configured"},_uploadConfg}function notifyFlie(_this,_recState,_tofileId){_this=_this;var _data={};_data.meta={thumbNail:_recState.resulttype?_recState.resulttype:void 0},_data.values={componentId:_recState.mediaName,componentType:_recState.type,componentFileId:_tofileId,componentData:{filename:_recState.name}},_recState.componentSize&&(_data.values.componentSize=_recState.componentSize),onComponentReady(_this,_data)}function initiateRcorder(_recState,ele){var _scope=this;ele=ele||$("#"+$scope.elementId),ele.on("success.ke.koreChunkUploader",function(e){onFileToUploaded(_scope,e,_recState)}),ele.on("error.ke.koreChunkUploader",onUploadError)}function onFileToUploaded(_this,evt,_recState){_this=_this;var _data=evt.params;if(!_data||!_data.fileId)return void onError();if(_recState.mediaName){var _tofileId=_data.fileId;notifyfileCmpntRdy(_this,_recState,_tofileId)}}function onUploadError(_this,evt,_recState){$scope.fileIUploadStatus("error",evt),attachmentInfo={},filechunkUploaderCounter=0}function onError(){$scope.fileIUploadStatus("error"),attachmentInfo={},filechunkUploaderCounter=0}function onComponentReady(_this,data){_this=_this;var status="pending";data&&data.values&&data.values.componentFileId&&(status="success"),$scope.fileIUploadStatus(status,data)}function acceptFileRecording(_this,_recState,ele){var _scope=_this,_uc=getfileuploadConf(_recState),_imageCntn=_recState.resulttype;notifyfileCmpntRdy(_scope,_recState),_uc.data[_uc.fieldName]={fileName:_recState.name,data:_imageCntn,type:"image/png"},_uc.data.thumbnail={fileName:_recState.name+"_thumb",data:_imageCntn,type:"image/png"},ele=$("#"+$scope.elementId),initiateRcorder(_recState,ele),$scope.koreChunkUploader(_uc)}function notifyfileCmpntRdy(_this,_recState,_tofileId){_this=_this;var _data={};_data.meta={thumbNail:_recState.resulttype},_data.values={componentId:_recState.mediaName,componentType:_recState.type,componentFileId:_tofileId,componentData:{filename:_recState.name}},onComponentReady(_this,_data)}function MultipartData(){this.boundary="--------MultipartData"+Math.random(),this._fields=[]}function chunkUploader(element,options){this.options=options,this.$element=element,this.options.chunkUpload?startChunksUpload(this):startUpload(this)}function getConnection(_this){return new kfrm.net.HttpRequest}function loadListener(_this,evt){_this.events.success.params=$.parseJSON(evt.target.response),attachmentInfo.fileId=_this.events.success.params.fileId,filechunkUploaderCounter=1,_this.$element.trigger(_this.events.success)}function errorListener(_this,evt){_this.events.error.params=evt,_this.$element.trigger(_this.events.error)}function progressListener(_this,evt){console.log("in progress ----------------------",evt)}function setOptions(_this,opts){return _this.options=opts,_this}function commitFile(_this){var _scope=_this,_conc=getConnection(_this),_mdat=new MultipartData;if(_conc.addEventListener("load",function(evt){200===evt.target.status?_scope.$element.parent().length&&loadListener(_scope,evt):errorListener(_scope,evt)},!1),_conc.addEventListener("error",function(evt){errorListener(_scope,evt)},!1),_conc.withCredentials=!1,_conc.open("PUT",_this.options.chunkUrl.replace(/\/chunk/,"")),_this.options.headers)for(var header in _this.options.headers)_this.options.headers.hasOwnProperty(header)&&_conc.setRequestHeader(header,_this.options.headers[header]);if(_mdat.append("totalChunks",_scope.totalChunks),_mdat.append("messageToken",_scope.messageToken),_this.options.data)for(var key in _this.options.data)_this.options.data.hasOwnProperty(key)&&_mdat.append(key,_this.options.data[key]);_conc.setRequestHeader("Content-Type","multipart/form-data; boundary="+_mdat.boundary),_conc.send(_mdat.toString())}function uploadChunk(_this){var _scope=_this,_conc=getConnection(_this),_mdat=new MultipartData;if(_conc.addEventListener("load",function(evt){if(200===evt.target.status){if(_scope.currChunk++,!_scope.$element.parent().length)return;_scope.currChunk===_scope.totalChunks?commitFile(_scope):initUploadChunk(_scope)}else errorListener(_scope,evt)},!1),_conc.addEventListener("error",function(evt){errorListener(_scope,evt)},!1),_conc.withCredentials=!1,_conc.open("POST",_this.options.chunkUrl),_this.options.headers)for(var header in _this.options.headers)_this.options.headers.hasOwnProperty(header)&&_conc.setRequestHeader(header,_this.options.headers[header]);_mdat.append("chunkNo",_scope.currChunk),_mdat.append("messageToken",_scope.messageToken),_mdat.append("chunk",{data:_scope.chunk,fileName:_scope.options.file.name}),_conc.setRequestHeader("Content-Type","multipart/form-data; boundary="+_mdat.boundary),_conc.send(_mdat.toString())}function initUploadChunk(_this){var _scope=_this,file=_scope.options.file,start=_scope.options.chunkSize*_scope.currChunk,stop=_scope.currChunk===_scope.totalChunks-1?file.size:(_scope.currChunk+1)*_scope.options.chunkSize,reader=new FileReader,blob=file.slice(start,stop);reader.onloadend=function(evt){if(evt.target.readyState===FileReader.DONE&&_scope.$element.parent().length){var dataObj=evt.target.result;dataObj=dataObj.replace(/^.*;base64,/,""),dataObj=dataObj.replace("data:application/octet-stream;base64,",""),_scope.chunk=dataObj,_scope.currChunk<_scope.totalChunks&&_scope.$element.parent().length&&uploadChunk(_scope)}else errorListener(_scope,evt)},reader.readAsDataURL(blob)}function startChunksUpload(_this){$scope.fileIUploadStatus("pending");var _scope=_this,_conc=getConnection(_this);if(_conc.addEventListener("error",function(evt){errorListener(_scope,evt)},!1),_conc.addEventListener("load",function(evt){200===evt.target.status?(_scope.messageToken=JSON.parse(evt.target.response).fileToken,_scope.totalChunks=Math.floor(_scope.options.file.size/_scope.options.chunkSize)+1,_scope.currChunk=0,_scope.options.chunkUrl=_scope.options.chunkUrl.replace(":fileToken",_scope.messageToken),_scope.$element.parent().length&&initUploadChunk(_scope)):errorListener(_scope,evt)},!1),_conc.withCredentials=!1,_conc.open("POST",_this.options.tokenUrl),_this.options.headers)for(var header in _this.options.headers)_this.options.headers.hasOwnProperty(header)&&_conc.setRequestHeader(header,_this.options.headers[header]);_conc.send()}function startUpload(_this){$scope.fileIUploadStatus("pending");var _scope=_this,_conc=getConnection(_this),_mdat=new MultipartData;if(_conc.upload&&_conc.upload.addEventListener&&_conc.upload.addEventListener("progress",function(evt){progressListener(_scope,evt)},!1),_conc.addEventListener("load",function(evt){_scope.$element.parent().length&&loadListener(_scope,evt)},!1),_conc.addEventListener("error",function(evt){errorListener(_scope,evt)},!1),_conc.withCredentials=!1,_conc.open("POST",_this.options.url),_this.options.headers)for(var header in _this.options.headers)_this.options.headers.hasOwnProperty(header)&&_conc.setRequestHeader(header,_this.options.headers[header]);if(_this.options.data)for(var key in _this.options.data)_this.options.data.hasOwnProperty(key)&&_mdat.append(key,_this.options.data[key]);_conc.setRequestHeader("Content-Type","multipart/form-data; boundary="+_mdat.boundary),_conc.send(_mdat.toString())}function updateConnection(){function getHTTPConnecton(){var xhr=!1;return xhr=new XMLHttpRequest,xhr?xhr:"undefined"!=typeof XDomainRequest?new XDomainRequest:xhr}function HttpRequest(){var xhr=getHTTPConnecton();if(!xhr)throw"Unsupported HTTP Connection";try{xhr.withCredentials=!0}catch(e){}return xhr.onreadystatechange=function(){return xhr.onReadyStateChange&&xhr.onReadyStateChange.call(xhr)},xhr}kfrm.net.HttpRequest=HttpRequest}var appConsts={},attachmentInfo={},fileToken=null,kfrm={};kfrm.net={};var allowedFileTypes=$scope.allowedFileTypes||["json"];appConsts.CHUNK_SIZE=10362880;var filetypes={},audio=["m4a","amr","wav","aac","mp3"],video=["mp4","mov","3gp","flv"],image=["png","jpg","jpeg"];filetypes.audio=audio,filetypes.video=video,filetypes.image=image,filetypes.file={limit:{size:262144e3,msg:i18n.i18nString("please_limit_the_individualfile")}},filetypes.determineFileType=function(extension){return extension=extension.toLowerCase(),filetypes.image.indexOf(extension)>-1?"image":filetypes.video.indexOf(extension)>-1?"video":filetypes.audio.indexOf(extension)>-1?"audio":"attachment"},$scope.removeAttachment=function(){filechunkUploaderCounter=0,attachmentInfo={},document.getElementById("captureAttachmnts").value=""},$scope.fileChanged=function(event){var file=$(event.target).prop("files")[0];return $scope.newFileData=file,$(event.target).val(""),file&&file.size&&file.size>filetypes.file.limit.size?void alert(filetypes.file.limit.msg):void cnvertFiles(this,file)},MultipartData.prototype.append=function(key,value){this._fields.push([key,value])},MultipartData.prototype.toString=function(){var boundary=this.boundary,body="";return this._fields.forEach(function(field){if(body+="--"+boundary+"\r\n",field[1].data){var file=field[1];body+=file.fileName?'Content-Disposition: form-data; name="'+field[0]+'"; filename="'+file.fileName+'"':'Content-Disposition: form-data; name="'+field[0]+'"',body+="\r\n",file.type&&(body+="Content-Type: UTF-8; charset=ISO-8859-1\r\n"),body+="Content-Transfer-Encoding: base64\r\n",body+="\r\n"+file.data+"\r\n"}else body+='Content-Disposition: form-data; name="'+field[0]+'";\r\n\r\n',body+=field[1]+"\r\n"}),body+="--"+boundary+"--"};var _cls=chunkUploader.prototype;_cls.events={error:$.Event("error.ke.koreChunkUploader"),progressChange:$.Event("progress.ke.koreChunkUploader"),success:$.Event("success.ke.koreChunkUploader")},$scope.fileIUploadStatus=function(type,data){var eventData={status:type||"clear",data:data,formData:$scope.newFileData};$scope.uploadStatus&&$scope.uploadStatus(eventData)},$scope.koreChunkUploader=function(option){var _args=Array.prototype.slice.call(arguments,1);return $("#"+$scope.elementId).each(function(){var $this=$("#"+$scope.elementId),data="";return options="object"==typeof option&&option,data?option&&("string"==typeof option&&data[option]?data[option].apply(data,_args):options&&startUpload(setOptions(data,options))):$this.data("ke.koreChunkUploader",data=new chunkUploader($this,options)),option&&data[option]&&data[option].apply(data,_args)})},$scope.koreChunkUploader.Constructor=chunkUploader,updateConnection()}]}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("clearSearch",function($timeout){return{restrict:"EA",link:function(scope,el,attrs){$(el).on("hide.bs.dropdown",function(){scope.search={}})}}})}(angular),function(ng){var _module=ng.module("bt-components");_module.directive("contentEditable",function(){return{restrict:"A",require:"?ngModel",link:function(scope,element,attrs,ngModel){function readViewText(){element.html();ngModel.$setViewValue($(element[0]).val())}ngModel&&(element.bind("blur keyup change",function(){scope.$apply(readViewText)}),scope.$on("after-drop",function(n,o){readViewText()}))}}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("contextMenu",[function(){return{restrict:"EA",scope:{context:"=",text:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/context-menu/context-menu.html",link:function($scope,$ele,$attrs){function handleContextMenu(event){var x=($($ele[0]).find(".dropdown-menu").offset(),event.offsetX),y=event.offsetY;getSelectedText()?($($ele[0]).find(".dropdown-menu").addClass("rich-editor-dropdown"),$($ele[0]).find(".dropdown-menu").css({top:y+"px",left:x+"px"})):$($ele[0]).find(".dropdown-menu").removeClass("rich-editor-dropdown")}function getSelectedText(){var text="";return window.getSelection?text=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(text=document.selection.createRange().text),text}$scope.addSynonym=function(){console.log($scope.context),($scope.context.addSynonym||angular.noop)(getSelectedText())},$scope.addPattern=function(){console.log($scope.context),($scope.context.addPattern||angular.noop)(getSelectedText())},document.addEventListener?$ele[0].addEventListener("contextmenu",function(e){handleContextMenu(e),e.preventDefault()},!1):$ele[0].attachEvent("oncontextmenu",function(){handleContextMenu(e),window.event.returnValue=!1}),$(document).on("click",function(){$($ele[0]).find(".dropdown-menu").removeClass("rich-editor-dropdown")})}}}])}(angular),function(){"use strict";function contextTypeahead($workflowService,$timeout){function link($scope,element,attrs,ctrl){function updateContextVariables(){$scope.contexts=[],$scope.contextsData=[],$scope.contextsData.session=$workflowService.contextData(),$scope.contextsData&&$scope.contextsData.entities&&delete $scope.contextsData.entities,$scope.contextsData&&$scope.contextsData.mappedIntents&&delete $scope.contextsData.mappedIntents,$scope.contexts.push("session"),$scope.dialogNodeNames=$workflowService.dialogNodesNames(),$scope.dialogNodeNames&&Object.keys($scope.dialogNodeNames).length&&($scope.dialogNodeNames.entities&&$scope.dialogNodeNames.entities.length&&($scope.contexts.push("entities"),$scope.contextsData.entities=$scope.dialogNodeNames.entities),$scope.dialogNodeNames.mappedIntents&&$scope.dialogNodeNames.mappedIntents.length&&($scope.contexts.push("mappedIntents"),$scope.contextsData.mappedIntents=$scope.dialogNodeNames.mappedIntents),$scope.customContexts&&$scope.customContexts.length&&($scope.contexts=$scope.contexts.concat($scope.customContexts)),$scope.dialogNodeNames.nodes&&$scope.dialogNodeNames.nodes.length&&($scope.contexts=$scope.contexts.concat($scope.dialogNodeNames.nodes)));
}function getAccurateCaretPosition(ctrl){var CaretPos=0,array=[],res="";if(document.selection){ctrl.focus();var Sel=document.selection.createRange();Sel.moveStart("character",-ctrl.value.length),array=ctrl.value.match(/[^\s]+/g),array&&array.length>1?(res=array[array.length-1],CaretPos=res.length):CaretPos=Sel.text.length}else(ctrl.selectionStart||"0"==ctrl.selectionStart)&&(array=ctrl.value.match(/[^\s]+/g),array&&array.length>1?(res=array[array.length-1],CaretPos=res.length):CaretPos=ctrl.selectionStart);return CaretPos}function GetCaretPosition(ctrl){var CaretPos=0;if(document.selection){ctrl.focus();var Sel=document.selection.createRange();Sel.moveStart("character",-ctrl.value.length),CaretPos=Sel.text.length}else(ctrl.selectionStart||"0"==ctrl.selectionStart)&&(CaretPos=ctrl.selectionStart);return CaretPos}function ReturnWord(text,caretPos){var preText=(text.indexOf(caretPos),text.substring(0,caretPos));if(preText.indexOf(" ")>0){var words=preText.split(" "),word=words[words.length-1],array=word.match(/[^\s\{{]+/g);return array&&array.length>1?array[array.length-1]:words[words.length-1]}var array1=preText.match(/[^\s\{{]+/g);return array1&&array1.length>1?array1[array1.length-1]:preText}function getActiveWord(){updateContextVariables();var activeElement=document.activeElement;$scope.selected=activeElement.value,$scope.caretPos=GetCaretPosition(activeElement),$scope.accurateCaretPosition=getAccurateCaretPosition(activeElement),$scope.currentWord=ReturnWord(activeElement.value,$scope.caretPos);var identifierMatches=$scope.currentWord.match(/[a-zA-Z]+/g);if($scope.availableContexts=[],identifierMatches&&"env"===identifierMatches[0]){$scope.availableContexts=$scope.bot.globalVar||[];var _tempCurrWordEnv=$scope.currentWord.split(".");$scope.currentWord=_tempCurrWordEnv[_tempCurrWordEnv.length-1]}if(identifierMatches&&"content"===identifierMatches[0]){$scope.availableContexts=$scope.bot.langVar||[];var _tempCurrWordCont=$scope.currentWord.split(".");$scope.currentWord=_tempCurrWordCont[_tempCurrWordCont.length-1]}if(identifierMatches&&"context"===identifierMatches[0]){var identifiersCount=$scope.currentWord.split(".").length-1;if(1===identifiersCount){$scope.availableContexts=$scope.contexts||[];var _tempCurrWord=$scope.currentWord.split(".");$scope.currentWord=_tempCurrWord[_tempCurrWord.length-1]}else if(identifiersCount>1){var identifiers=$scope.currentWord.split(".");""!==identifiers[identifiers.length-1]&&(identifiers[identifiers.length-1]="");for(var _currArrayData=[],index=0;index<identifiers.length;index++)if(index>0&&""!==identifiers[index]){var _list=[];0===_currArrayData.length&&(_currArrayData=[]),$scope.contextsData.session.hasOwnProperty(identifiers[index])?(_currArrayData=$scope.contextsData.session[identifiers[index]]||[],"object"!=typeof _currArrayData||_currArrayData[0]||(_list=[],$.map(_currArrayData,function(item,key){_list.push(key)}),_currArrayData=[],_currArrayData=_list)):$scope.contextsData.hasOwnProperty(identifiers[index])?(_currArrayData=$scope.contextsData[identifiers[index]]||[],"object"!=typeof _currArrayData||_currArrayData[0]||(_list=[],$.map(_currArrayData,function(item,key){_list.push(key)}),_currArrayData=[],_currArrayData=_list)):_currArrayData=""===identifiers[identifiers.length-1]?[]:[]}$scope.availableContexts=_currArrayData,$scope.currentWord=identifiers[identifiers.length-1]}}return $scope.currentWord}function getContentValue(key){var filteredText=_.find($scope.bot.langVar,{key:key});return filteredText.value}function getEnvValue(key){var filteredText=_.find($scope.bot.globalVar,{key:key});return filteredText.value}$scope.contexts=[],$scope.contextsData=[],$scope.contextsData.session=$workflowService.contextData(),$scope.dialogNodeNames=$workflowService.dialogNodesNames(),$scope.selectedStream=$workflowService.selectedStream(),$scope.selected="",$scope.availableContexts=[],$scope.currentWord="",$scope.triggeredFromSelect=!1,$scope.bot={variablesList:$workflowService.botEnvVariables(),globalVar:[],langVar:[]},0!==$scope.bot.variablesList.length&&($scope.bot.globalVar=$scope.bot.variablesList.map(function(val){return"env"==val.variableType?val:void 0}).filter(function(val){return void 0!==val}),$scope.bot.langVar=$scope.bot.variablesList.map(function(val){return"locale"==val.variableType?val:void 0}).filter(function(val){return void 0!==val})),setTimeout(function(){element.bind("mouseover",function(event){if(!$(this).attr("title")){var keyValue,_value,_ele=event.currentTarget,_textValue=_ele.value,words=_textValue.split(" "),reg=new RegExp("[/{ ]{2}(\\s)?\\w+[.]\\w+[/}]{2}"),prepareTitle="";reg.test(words)&&(_.map(words,function(word,index){if(word.match(reg)){var textSplitValues=word.match(/[a-zA-Z]+/g);textSplitValues&&"content"===textSplitValues[0]?(keyValue=textSplitValues[1],_value=getContentValue(keyValue),prepareTitle=prepareTitle+"{ "+keyValue+":"+_value+"} \n"):textSplitValues&&"env"===textSplitValues[0]&&(keyValue=textSplitValues[1],_value=getEnvValue(keyValue),prepareTitle=prepareTitle+"{ "+keyValue+":"+_value+"} \n")}}),$(this).attr("title",prepareTitle))}}),element.bind("keydown",function(event){event.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&event.preventDefault()}).autocomplete({minLength:1,source:function(request,response){if($scope.triggeredFromSelect)return void($scope.triggeredFromSelect=!1);var term=getActiveWord();_.map($scope.availableContexts,function(value,index){value&&value.key&&(value.label=value.key)}),response($.ui.autocomplete.filter($scope.availableContexts,term))},focus:function(event,ui){event.preventDefault()},select:function(e,ui){var item=ui.item.label||"",front=$scope.selected.substring(0,$scope.caretPos),lastIndex=front.lastIndexOf(".");front=front.substring(0,lastIndex)+".";var back=$scope.selected.substring($scope.caretPos,$scope.selected.length);return $(this).val(front+item+back).trigger("input"),$scope.triggeredFromSelect=!0,!1},position:{collision:"flip"},open:function(event,ui){if($(".ui-autocomplete:visible").css({left:"+="+5*$scope.accurateCaretPosition}),window.outerWidth-210<$(".ui-autocomplete:visible").offset().left){var _leftToReposition=$(".ui-autocomplete:visible").offset().left-(window.outerWidth-210)+10;$(".ui-autocomplete:visible").css({left:"-="+_leftToReposition})}}}).autocomplete("widget").addClass("contextTypeaheadDropdown")},1e3)}var directive={require:"ngModel",restrict:"A",link:link,scope:{customContexts:"=",value:"=",context:"="}};return directive}angular.module("bt-components").directive("contextTypeahead",contextTypeahead),contextTypeahead.$inject=["$workflowService","$timeout"]}(),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("conversationTesting",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/conversation-testing/conversation-testing.html",controller:"conversationTestingController"}}),_module.controller("conversationTestingController",["$scope","env_conf","$rootScope","BTStreamsService","$workflowService","BTIdpService","NotificationService","i18n","jsEvents","$sce","channelsConfig",function($scope,env_conf,$rootScope,BTStreamsService,$workflowService,BTIdpService,NotificationService,i18n,jsEvents,$sce,channelsConfig){function initData(){$scope.lodingForm=!1}function checkOnConnectEvents(){$scope.stream&&$scope.stream.botEvents&&$scope.stream.botEvents.ON_CONNECT_EVENT&&$scope.stream.botEvents.ON_CONNECT_EVENT.enabled?$rootScope.isConversationTesting=!0:$rootScope.isConversationTesting=!1}$scope.streamId=$workflowService.selectedStream()._id,$scope.stream=$workflowService.selectedStream(),$scope.lodingForm=!0,$scope.assetsBase=env_conf["assets-url"],$scope.emptyAuth=env_conf["context-url"]+"/assets/authorization/empty_authorization.svg",$scope.testCaseCloneMode=!1,channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.availableChannels=Object.values(channelsConfig.channelsObject),$scope.selectedTestCaseList=[],$scope.createTestCaseConfig={},$scope.runTestForm={version:"configured",authProfile:""},$rootScope.isConversationTesting=!1,$scope.authLoading=!1,$scope.btTestFormApi={},$scope.btTestStatus={},$scope.dockCounter=!1,window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.iframeUrl=$sce.trustAsResourceUrl("http://localhost:4200/builderx/conversation-testing/"+$scope.streamId):$scope.iframeUrl=window.appConfig.API_SERVER_URL+"/builderx/conversation-testing/"+$scope.streamId;var iframe=$("#conversationTesting");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")}),setTimeout(function(){initData()},0)}),$scope.iframeEvent=function(e,data){if(data&&data.payload&&data.payload.type)switch(data.payload.type){case"openRecordTestCaseModal":checkOnConnectEvents(),$scope.initiateChatBot&&$scope.initiateChatBot(),$rootScope.$emit("startRecording");break;case"cloneRecordTestCaseModal":$rootScope.manageTestCaseModal("clone",data.payload.form);break;case"openDeleteModel":$scope.selectedTestCaseList=[data.payload.data],$scope.openCustomModal("multiDeleteTestCaseModal");break;case"multiDeleteTestCaseModal":$scope.selectedTestCaseList=data.payload.selectedTestCaseList,$scope.openCustomModal("multiDeleteTestCaseModal");break;case"checkDockStatus":$scope.checkDockStatus();break;case"openCreateTokenModal":$scope.openCreateTokenModal&&$scope.openCreateTokenModal();break;case"runTestCaseModal":$scope.openCustomModal("runTestCasesModal"),$scope.selectedTestCaseList=data.payload.selectedTestCaseList,$scope.getIdpList();break;case"downloadChatJson":$scope.initiateChatBot&&$scope.initiateChatBot(),setTimeout(function(){$scope.downloadChatJson()},500)}},$scope.$on("conversationTestingEvent",$scope.iframeEvent),$scope.getIdpList=function(){$scope.authLoading=!0,BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.authLists=res.data,$scope.authLoading=!1},function(res){$scope.authLoading=!1,NotificationService.notify(i18n.i18nString("notify_idp"),"error")})},$scope.selectVersion=function(version){version&&($scope.runTestForm.version=version)},$scope.runTestCase=function(){$scope.selectedTestCaseList&&$scope.selectedTestCaseList.length>0&&($scope.dockCounter=!1,BTStreamsService.runtestcases($scope.streamId,{testCaseIds:$scope.selectedTestCaseList,version:$scope.runTestForm.version}).then(function(res){var msg="Executing Test Case";$scope.selectedTestCaseList.length>1&&(msg="Executing Test Cases"),NotificationService.notify(msg,"success"),$scope.closeCustomModal("runTestCasesModal"),$scope.checkDockStatus(),jsEvents.postMessageToChildIframes("resetSelectedCases","conversationTestingEvent",{})},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")}))},$scope.deleteTestCase=function(){if($scope.selectedTestCaseList&&$scope.selectedTestCaseList.length>0){var testcaseIds=[];$scope.selectedTestCaseList.forEach(function(cas){testcaseIds.push(cas._id)}),BTStreamsService.deletetestcase($scope.streamId,{testCaseIds:testcaseIds}).then(function(res){NotificationService.notify("Deleted successfully","success"),$scope.closeCustomModal("multiDeleteTestCaseModal"),jsEvents.postMessageToChildIframes("reloadTestCases","conversationTestingEvent",{})},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}},$scope.testIdp=function(idpId){$scope.btTestFormApi.isConversationTesting=!0,$scope.btTestFormApi.afterInit=function(){$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success){success?NotificationService.notify(i18n.i18nString("auth_test_success"),"success"):NotificationService.notify(i18n.i18nString("auth_test_failed"),"error"),$scope.btTestFormApi.close()},$scope.btTestFormApi.init({_id:idpId?idpId:$scope.newAuth&&$scope.newAuth.selected._id,type:"idp",testFor:"idp"})},$scope.downloadChatJson=function(){$rootScope.$emit("downloadChatJson"),setTimeout(function(){$("#recordStop").modal("hide")},200)},$rootScope.$on("onDockStatus",function($event,data){data&&"IN_PROGRESS"===data.status?jsEvents.postMessageToChildIframes("testCasesProgressData","conversationTestingEvent",data):!data||"SUCCESS"!==data.status&&"FAILURE"!==data.status||$scope.dockCounter||(jsEvents.postMessageToChildIframes("reloadTestCases","conversationTestingEvent",data),$scope.dockCounter=!0)}),$scope.checkDockStatus=function(){$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer")},$scope.openCustomModal=function(targetId){targetId&&$("#"+targetId).modal("show")},$scope.closeCustomModal=function(targetId){targetId&&$("#"+targetId).modal("hide")};var init=function(){BTStreamsService.getBTStream($scope.stream._id).then(function(res){res&&res.data&&($workflowService.selectedStream(res.data),$scope.stream=res.data)},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})};init(),$scope.$on("$destroy",function(){$rootScope.isConversationTesting=!1,$scope.btTestFormApi.isConversationTesting=!1})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("createTestCase",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/conversation-testing/create-test-case.html",controller:"createTestCaseController"}}),_module.controller("createTestCaseController",["$scope","env_conf","$rootScope","BTStreamsService","$workflowService","NotificationService","i18n","jsEvents","$sce","channelsConfig","form_util",function($scope,env_conf,$rootScope,BTStreamsService,$workflowService,NotificationService,i18n,jsEvents,$sce,channelsConfig,form_util){function buildChatData(testForm){if(testForm&&testForm.chatData&&testForm.chatData.testCases){var testcases=[];return testForm.chatData.testCases.forEach(function(element){testcases=testcases.concat(element.messages)}),testcases}}function resetForm(){$scope.createTestCaseConfig.createTestCaseFlag=!1,$scope.testForm={channel:$scope.defaultChannel},$scope.tagsFlag=!1,$scope.testCaseCloneMode=!1,$scope.inlineErrorMsg="",$scope.testCaseForm&&$scope.testCaseForm.$setPristine(),$scope.testForm.name=""}$scope.streamId=$workflowService.selectedStream()._id,$scope.stream=$workflowService.selectedStream(),$scope.lodingForm=!0,$scope.assetsBase=env_conf["assets-url"],$scope.testCaseCloneMode=!1,channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.availableChannels=Object.values(channelsConfig.channelsObject),$scope.defaultChannel=_.find($scope.availableChannels,function(ch){return"rtm"===ch.id}),$scope.testForm={channel:$scope.defaultChannel},$scope.selectedTestCaseList=[],$scope.testForm.tags=[],$scope.tagsFlag=!1,$scope.select2Options={multiple:!0,simple_tags:!0,tags:[],placeholder:"Type & Enter"},$scope.searchChannel="",$scope.recentTags=[],$scope.inlineErrorMsg="",$scope.testCaseForm={},$rootScope.manageTestCaseModal=function(type,form){if($scope.getRecentTags(),$scope.createTestCaseConfig.createTestCaseFlag=!0,"create"===type)$scope.testCaseCloneMode=!1;else if("clone"===type&&form){$scope.testForm._id=form._id,$scope.testForm.name="Copy of "+form.name,$scope.testForm.description=form.description;var findChannel=_.find($scope.availableChannels,function(ch){return ch.id===form.channel.id});findChannel&&findChannel.id&&($scope.testForm.channel=findChannel),$scope.testForm.tags=form.tags,$scope.testCaseCloneMode=!0,$scope.select2Options.tags=form.tags}setTimeout(function(){$scope.openCustomModal("recordTestCaseModal"),setTimeout(function(){$("#testCaseNameInput").focus()},500)},0),$scope.tagsFlag=!0,setTimeout(function(){PerfectScrollbar.initialize($(".select2-results")[0])},50)},$scope.selectChannel=function(option){$scope.testForm.channel=option},$scope.addTag=function(tag){$scope.testForm.tags.push(tag)},$scope.getRecentTags=function(){BTStreamsService.recentTags($scope.streamId).then(function(res){res&&res.data.tags?$scope.recentTags=res.data.tags:$scope.recentTags=[]},function(err){$scope.recentTags=[],err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Recent tags loading failed","error")})},$scope.createNewTestCase=function(_form){if(!_form.$valid)return void form_util.touch(_form);$scope.testForm.clone=$scope.testCaseCloneMode,$rootScope&&$rootScope.recordedChatData&&($scope.testForm.chatData=JSON.parse($rootScope.recordedChatData));var payload={name:$scope.testForm.name,description:$scope.testForm.description,channel:$scope.testForm.channel.id,schedule:"",serviceMap:[],preprocessor:"",testSteps:[],tags:$scope.testForm.tags||[],authProfiles:[]};$scope.testForm.chatData&&(payload.testSteps=buildChatData($scope.testForm)),BTStreamsService.createtestcase($scope.streamId,payload).then(function(res){NotificationService.notify($scope.testForm.name+" is successfully added to Conversation Testing","success"),jsEvents.postMessageToChildIframes("reloadTestCases","conversationTestingEvent",$scope.testForm),$scope.closeCustomModal("recordTestCaseModal"),resetForm(),$scope.$emit("updateChecklist","conversationTesting")},function(err){err&&err.data&&err.data.errors?err.data.errors[0].msg===i18n.i18nString("testcase_name_already_exist")?$scope.inlineErrorMsg=err.data.errors[0].msg:NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Something went wrong!!","error")})},$scope.cloneTestCase=function(_form){if(!_form.$valid)return void form_util.touch(_form);$scope.testForm.clone=$scope.testCaseCloneMode,$rootScope&&$rootScope.recordedChatData&&($scope.testForm.chatData=JSON.parse($rootScope.recordedChatData));var payload={name:$scope.testForm.name,description:$scope.testForm.description,channel:$scope.testForm.channel.id,schedule:"",serviceMap:[],preprocessor:"",testSteps:$scope.testForm.teststeps,tags:$scope.testForm.tags||[],authProfiles:[]};BTStreamsService.clonetestcase($scope.streamId,$scope.testForm._id,payload).then(function(res){NotificationService.notify($scope.testForm.name+" is successfully added to Conversation Testing","success"),jsEvents.postMessageToChildIframes("reloadTestCases","conversationTestingEvent",$scope.testForm),$scope.closeCustomModal("recordTestCaseModal"),resetForm()},function(err){err&&err.data&&err.data.errors?err.data.errors[0].msg===i18n.i18nString("testcase_name_already_exist")?$scope.inlineErrorMsg=err.data.errors[0].msg:NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("something_went_wrong"),"error")})},$scope.downloadChatJson=function(){$rootScope.$emit("downloadChatJson"),setTimeout(function(){$("#recordStop").modal("hide")},200)},$scope.exportJson=function(){$scope.testForm&&$scope.testForm._id&&jsEvents.postMessageToChildIframes("exportJson","conversationTestingEvent",$scope.testForm)},$scope.isFormValid=function(){return $scope.testForm?$scope.testForm.name&&$scope.testForm.channel.id?void 0:!0:!1},$scope.openCustomModal=function(targetId){targetId&&$("#"+targetId).modal("show")},$scope.closeCustomModal=function(targetId){targetId&&$("#"+targetId).modal("hide"),$(".talkToBot").show(),resetForm()},$scope.resetInlineMsg=function(){$scope.inlineErrorMsg=""}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("countBoard",function(){return{restrict:"EA",scope:{data:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/count-board/count-board.html",controller:"countBoardController"}}),_module.controller("countBoardController",["$scope","env_conf",function($scope,env_conf){$scope.channels=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/channels.svg",$scope.helpDarkIcon=env_conf["context-url"]+"/assets/icons-new/help/help-dark.svg"}]),_module.filter("slice",function(){return function(arr,start,end){return(arr||[]).slice(start,end)}}),_module.filter("channelNameDisp",function(){return function(input){return"googleactions"===input?"Google Assistant":"hangoutchat"===input?"Hangouts Chat":input}})}(angular),function(ng){"use strict";var _component=angular.module("bt-components");_component.directive("createModeSelector",function(){return{restrict:"EA",scope:{onCancel:"&",onModeSelected:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/create-mode-selector/create-mode-selector.html",controller:"createBotModeController"}}),_component.controller("createBotModeController",["$scope","$location","$workflowService","env_conf","$timeout","$rootScope","$modal","NotificationService","i18n","mixPanel",function($scope,$location,$workflowService,env_conf,$timeout,$rootScope,$modal,NotificationService,i18n,mixPanel){window.appConfig.CONTEXT_PATH+"/assets/createBot/";$scope.defaultImg=env_conf["context-url"]+"/img/newBot.png";var selectedAccount=$workflowService.selectedAccount();$scope.contentTypes=[{id:"standardbot",name:i18n.i18nString("standard_name"),description:i18n.i18nString("standard_desc"),path:"",type:"default",show:!1},{id:"browsebotsamples",name:i18n.i18nString("start_store"),description:i18n.i18nString("start_desc"),path:"",type:"browsebotsamples",icon:env_conf["context-url"]+"/assets/home/icon-home.svg",show:!0},{id:"importbot",name:i18n.i18nString("import_name"),description:i18n.i18nString("import_desc"),path:"",icon:env_conf["context-url"]+"/assets/home/icon-import.svg",type:"default",show:!0},{id:"browsesmartbot",name:i18n.i18nString("smart_name"),description:i18n.i18nString("smart_desc"),path:"",icon:env_conf["context-url"]+"/assets/home/icon-document.svg",type:"browsesmartbot",show:!selectedAccount.accountType},{id:"newbot",name:i18n.i18nString("new_bot_name"),description:i18n.i18nString("new_bot_desc"),path:"",icon:env_conf["context-url"]+"/assets/home/icons-robot.svg",type:"",show:!0}],$scope.updateStep=function(stepNo){$scope.$emit("updateStep",stepNo)},$scope.isWorkProgress=!1,$scope.footerInfoTitle=i18n.i18nString("what_option_should_i_choose"),$scope.footerHeaderId="bt-mode-selectorr",$scope.footerPanelId="bt-mode-selector-panel",$scope.backArrow=env_conf["context-url"]+"/assets/icons/closeCross.png",$rootScope.$on("showOrHideStatusLoader",function(evt,newValue){$scope.isWorkProgress=newValue});var selectedModeObject=[];$scope.getPath=function(selectedMode){return selectedModeObject=_.filter($scope.contentTypes,function(contentType){return contentType.id===selectedMode}),$scope.initiateWorkflowCreation(selectedModeObject[0].type),selectedModeObject[0].path},$scope.modeObject={},$scope.modeObject.selectedMode="",$scope.selectMode=function(selectedMode,contentType){if("universalbot"===selectedMode){var allStreams=$workflowService.streamsAll();if(!(allStreams.length&&allStreams.length>1))return void NotificationService.notify(i18n.i18nString("please_create_atleast_two_stndrd_bot"),"warning");var employeeBots=_.filter(allStreams,{purpose:"employee"}),customerBots=_.filter(allStreams,{purpose:"customer"});if(employeeBots.length<2&&customerBots.length<2)return void NotificationService.notify(i18n.i18nString("standard_notify"),"warning")}"browsebotsamples"===selectedMode?($scope.$parent.invokeBotsFormForStore(),mixPanel.postEvent("Launch Botstore")):"browsesmartbot"===selectedMode?$scope.$emit("updateStep",5):($workflowService.streamType(selectedMode),contentType&&"importbot"===contentType.id&&(selectedMode="importbot"),$scope.modeObject.selectedMode=selectedMode,$scope.onModeSelected(selectedMode),$scope.closeModeSelectorModal()),$timeout(function(){$("#botModalSlider .modalContent .modalBody .form-group input").first().focus(),$(".botListSearch input.botListSearchInput").focus()},150)},$scope.closeModeSelectorModal=function(){$scope.modeObject.selectedMode=""}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("streamChooser",function(){return{restrict:"AE",scope:{type:"@",streamId:"@",scResponder:"&"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/custom-chooser/custom-chooser.html",controller:["$scope","$translator","$filter","$q",function($scope,$translator,$filter,$q){if($scope.loadingItems=!0,"stream"===$scope.type)$translator.translate("bt.streams.get",{}).then(function(res){$scope.items=$filter("orderBy")(res.data,"+name"),$scope.loadingItems=!1});else if("alert"===$scope.type)$q.all([$translator.translate("bt.streams.alerts.get",{streamId:$scope.streamId}),$translator.translate("bt.streams.actions.get",{streamId:$scope.streamId})]).then(function(res){var alerts=res[0].data.filter(function(obj){return"published"===obj.state&&!obj.parentId}),actions=res[1].data.filter(function(obj){return"published"===obj.state&&!obj.parentId});$scope.items=alerts.concat(actions),$scope.items=$filter("orderBy")($scope.items,"+name"),$scope.loadingItems=!1});else if("action"===$scope.type){var types={a:"action",l:"alert",s:"bot",z:"flow"},_type=$scope.$parent&&$scope.$parent.selectedAlert?types[$scope.$parent.selectedAlert._id[0]]:"action";"alert"===_type?$q.all([$translator.translate("bt.streams.actions.get",{streamId:$scope.streamId}),$translator.translate("bt.dialogs.get",{streamId:$scope.streamId})]).then(function(res){var actions=res[0].data.filter(function(obj){return"published"===obj.state&&!obj.parentId});$scope.dialogs=res[1].data.filter(function(obj){return"published"===obj.state&&!obj.parentId}),$scope.dialogs.length?$translator.translate("bt.components.get",{streamId:$scope.streamId}).then(function(res){var components=res.data.filter(function(obj){return"published"===obj.status});$.each($scope.dialogs,function(key,dialog){$.each(dialog.nodes,function(index,component){var result=components.filter(function(o){return o._id===component.componentId});$scope.dialogs[key].nodes[index]=result[0]}),$scope.dialogs.length-1===key&&($scope.items=actions.concat($scope.dialogs),$scope.items=$filter("orderBy")($scope.items,"+name"),$scope.loadingItems=!1)})}):($scope.items=actions,$scope.items=$filter("orderBy")($scope.items,"+name"),$scope.loadingItems=!1)}):$translator.translate("bt.streams.actions.get",{streamId:$scope.streamId}).then(function(res){$scope.items=res.data.filter(function(obj){return"published"===obj.state&&!obj.parentId}),$scope.items=$filter("orderBy")($scope.items,"+name"),$scope.loadingItems=!1})}$scope.selectItem=function(item){var retObj={};retObj[$scope.type]=item;var isAlertToDialogMapping=!1,types={a:"action",l:"alert",s:"bot",z:"flow",d:"dialog"},_type=$scope.$parent&&$scope.$parent.selectedAlert?types[$scope.$parent.selectedAlert._id[0]]:"action",_selectedActionType=item?types[item._id[0]]:"action";"alert"===_type&&"dialog"===_selectedActionType&&(isAlertToDialogMapping=!0),retObj[$scope.type].isAlertToDialogMapping=isAlertToDialogMapping,$scope.scResponder(retObj)},$scope.flowSearchFilter=function(filter){return function(items){return filter.name?items.name&&-1!==items.name.toLowerCase().indexOf(filter.name&&filter.name.toLowerCase()):!0}}}]}})}(angular),function(ng){"use strict";var _component=ng.module("bt-components");_component.directive("daasTables",function(){return{restrict:"AE",scope:{onCancel:"&",servicenodetype:"=",resource:"=",componentid:"=",requestservicedata:"=",reqdefcb:"=",callbacks:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/daas-tables/bt-daas-tables.html",controller:"daasTablesViewController"}}),_component.directive("datePicker",function(){return{restrict:"AE",require:"ngModel",link:function(scope,elm,attr,ctrl){elm.daterangepicker({singleDatePicker:!0,autoApply:!0,timePicker:!0,startDate:moment(),endDate:moment(),maxDate:moment(new Date).format("YYYY-MM-DD h:mm:ss"),drops:"up",autoUpdateInput:!1,locale:{format:"YYYY-MM-DD h:mm:ss"}},function(start,end,label){ctrl.$setViewValue(start.format("YYYY-MM-DD h:mm:ss"))}),elm.on("apply.daterangepicker",function(ev,picker){$(this).val(picker.startDate.format("YYYY-MM-DD h:mm:ss"))})}}}),_component.controller("daasTablesViewController",["$scope","$rootScope","$location","$workflowService","$timeout","$applicationService","BTStreamsService","NotificationService","$q","env_conf","i18n","BTFlowtaskService","$modal","localstore",function($scope,$rootScope,$location,$workflowService,$timeout,$applicationService,BTStreamsService,NotificationService,$q,env_conf,i18n,BTFlowtaskService,$modal,localstore){function load(){$scope.callbacks&&$scope.callbacks.nodeInfo&&$scope.callbacks.nodeInfo.status&&($scope.selectedStreamState=$scope.callbacks.nodeInfo.status)}function getTables(){BTStreamsService.daasTables($applicationService.userInfo().userId,$scope.streamId).then(function(res){res.data.tables.length||NotificationService.notify("No tables found","error"),res.data&&res.data.tables&&($scope.tables=res.data.tables,updateData())},function(error){var msg=error.errors?error.errors[0].msg:i18n.i18nString("fetch_lookup");NotificationService.notify(msg,"error")})}function updateData(){if($scope.requestservicedata&&$scope.requestservicedata.name&&"dataTable"==$scope.requestservicedata.resource){$scope.tableForm={name:$scope.requestservicedata.name,action:$scope.requestservicedata.method,filterRules:[{field:"",operand:"",value:""}],operator:"and",skip:null,limit:null},$scope.requestservicedata.query&&$scope.requestservicedata.query.expressions&&($scope.tableForm.filterRules=$scope.requestservicedata.query.expressions,$scope.tableForm.operator=$scope.requestservicedata.query.operator||"and"),$scope.requestservicedata.data&&($scope.addData=$scope.requestservicedata.data||{}),$scope.requestservicedata.skip&&($scope.tableForm.skip=$scope.requestservicedata.skip),$scope.requestservicedata.limit&&($scope.tableForm.limit=$scope.requestservicedata.limit);var obj=$scope.tables.find(function(o){return o.name===$scope.tableForm.name});obj&&obj.fields&&($scope.selectedFields=obj.fields);var actObj=$scope.actionList.find(function(o){return o.value===$scope.requestservicedata.method});actObj&&actObj.displayName&&($scope.actionName=actObj.displayName),$scope.updateText()}else $scope.reset()}$scope.assetsBase=env_conf["assets-url"],$scope.streamId=$workflowService.selectedStream()._id,$scope.tableForm={name:null,action:null,filterRules:[{field:"",operand:"",value:""}],operator:"and",skip:null,limit:null},$scope.ruleObj={field:"",operand:"",value:""},$scope.actionList=[{id:1,name:"Add Data",info:"Add a data record into the data table",value:"insert",displayName:"Add Data"},{id:2,name:"Get Data",info:"Filter and get the data from the data table",value:"query",displayName:"Get Data"},{id:3,name:"Update Data",info:"Update specific data in the data table",value:"update",displayName:"Update Data"},{id:4,name:"Delete Data",info:"Delete specific data from the data table",value:"delete",displayName:"Delete Data"}],$scope.tables=[],$scope.addData={},$scope.selectedFields=[],$scope._payload={},$scope.sampleResponse={},$scope.actionName="",$scope.options={aceMode:"ace/mode/javascript",mode:"view"===$scope.displayMode?"tree":"code",ace:window.ace},$scope.sampleResponseIndex=0,$scope.filterText="",$scope.assignText="",$scope.selectedStreamState="",load(),getTables(),$scope.onChangeData=function(name){$scope.reset(),$scope.tableForm.name=name;var obj=$scope.tables.find(function(o){return o.name===$scope.tableForm.name});$scope.selectedFields=obj.fields,$scope.selectedFields||NotificationService.notify("No table view columns found","error")},$scope.setFilterValue=function(form,data){form.field=data.name,form.type=data.type},$scope.actionSelected=function(list){$scope.tableForm.action=list.value,$scope.actionName=list.displayName,$scope.updateText()},$scope.updateText=function(){"insert"==$scope.tableForm.action?$scope.assignText="Provide values to be added to the data table. You may specify a static value or a reference to the context object for each of the columns in the data table.":"query"==$scope.tableForm.action?$scope.filterText="Define the rows to be selected from the data table by configuring the selection criteria using one or more columns.":"update"==$scope.tableForm.action?($scope.assignText="Provide values to be updated in the data table. You may specify a static value or a reference to the context object for each of the columns in the data table.",
$scope.filterText="Define the rows to be updated in the data table by configuring the modification criteria using one or more columns."):"delete"==$scope.tableForm.action&&($scope.filterText="Define the rows to be deleted in the data table by configuring the deletion criteria using one or more columns.")},$scope.isFormValid=function(form){var isAddDataValid=!0;return isAddDataValid="insert"==$scope.tableForm.action?!0:$scope.isFilterRuleValid(form),!form.name||!form.action||!isAddDataValid},$scope.isFilterRuleValid=function(form){if(form&&form.filterRules){var isAddDataValid=form.filterRules.every(function(res){return res.field&&res.operand&&res.value?!0:!1});return isAddDataValid}},$scope.daasTestCloseModal=function(){$scope.closeModalSlider("#daas-test")},$scope.testData=function(){$scope.callbacks.openDaasTest(),BTStreamsService.daasSaveServiceNode($scope.componentid,$scope.streamId,$scope._payload).then(function(response){NotificationService.notify("Saved successfully","success"),$scope.callbacks.nodeInfo.payload=response.config.data.payload,$scope.callbacks.nodeInfo.serviceNodeType=response.config.data.serviceNodeType,$scope.reqdefcb.onServiceSave($scope.callbacks.nodeInfo),BTFlowtaskService.executeComponent($scope.streamId,$scope.componentid).then(function(res){$scope.sampleResponse=res.data,$scope.callbacks.sampleResponse=res.data},function(res){var err=res.data,errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("some_thing_wrong_label");NotificationService.notify(errMsg,"error");var parsedErrObj={};try{parsedErrObj=JSON.parse(err.errors[0].msg)}catch(e){parsedErrObj=err.errors[0].msg||{errors:[{msg:i18n.i18nString("bt_reqst_unkown_msg"),code:"Unknown"}]}}$scope.sampleResponse=parsedErrObj,$scope.callbacks.sampleResponse=parsedErrObj})})},$scope.saveTable=function(type){if(!$scope.isFormValid($scope.tableForm)){"insert"==$scope.tableForm.action?$scope._payload={serviceNodeType:$scope.servicenodetype,payload:{data:$scope.addData,name:$scope.tableForm.name,method:$scope.tableForm.action,resource:$scope.resource}}:"query"==$scope.tableForm.action?$scope._payload={serviceNodeType:$scope.servicenodetype,payload:{query:{expressions:$scope.tableForm.filterRules,operator:$scope.tableForm.operator},name:$scope.tableForm.name,method:$scope.tableForm.action,resource:$scope.resource,skip:$scope.tableForm.skip,limit:$scope.tableForm.limit}}:"delete"==$scope.tableForm.action?$scope._payload={serviceNodeType:$scope.servicenodetype,payload:{query:{expressions:$scope.tableForm.filterRules,operator:$scope.tableForm.operator},name:$scope.tableForm.name,method:$scope.tableForm.action,resource:$scope.resource}}:"update"==$scope.tableForm.action&&($scope._payload={serviceNodeType:$scope.servicenodetype,payload:{data:$scope.addData,query:{expressions:$scope.tableForm.filterRules,operator:$scope.tableForm.operator},name:$scope.tableForm.name,method:$scope.tableForm.action,resource:$scope.resource}});var protipHtml='<div class="help_hint_data mt-10"><div class="bulb-icon"><i class="btx-bulb"></i></div><div class="hint-content">Any changes to the data in the Test mode will also result in permanent changes to the Table.</div></div>';if("TEST"==type)return void window.bootbox.dialog({message:"The configurations used to define the Service Definition will be saved before initiating the Test"+protipHtml,title:"Confirm to proceed",className:"daas-confirm-dialog with-protip-info",onEscape:function(){},closeButton:!1,buttons:{success:{label:i18n.i18nString("confirm"),className:"btn_md",callback:function(){$scope.testData()}},main:{label:i18n.i18nString("cancel"),className:"closeCancel btn_md",callback:function(){}}}});BTStreamsService.daasSaveServiceNode($scope.componentid,$scope.streamId,$scope._payload).then(function(response){NotificationService.notify("Saved successfully","success"),$scope.callbacks.nodeInfo.payload=response.config.data.payload,$scope.callbacks.nodeInfo.serviceNodeType=response.config.data.serviceNodeType,$scope.reqdefcb.onServiceSave($scope.callbacks.nodeInfo),"SAVE"==type&&$scope.onCancel()})}},$scope.daasCloseModal=function(){updateData(),$scope.onCancel()};var original=angular.copy($scope.tableForm);$scope.reset=function(){$scope.addData={},$scope.tableForm=angular.copy(original)},$scope.tableForm.filterRules.push($scope.ruleObj),$scope.addSimpleValidation=function(){if($scope.isFilterRuleValid($scope.tableForm)&&$scope.tableForm.filterRules.length<50){var ruleObj={field:"",operand:"",value:""};$scope.tableForm.filterRules.push(ruleObj)}},$scope.removeSimpleValidation=function(rule){var index=$scope.tableForm.filterRules.indexOf(rule);$scope.tableForm.filterRules.splice(index,1)}}])}(angular),function(ng){"use strict";var _component=ng.module("bt-components");_component.directive("daasViews",function(){return{restrict:"AE",scope:{onCancel:"&",servicenodetype:"=",resource:"=",componentid:"=",requestservicedata:"=",reqdefcb:"=",callbacks:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/daas-views/bt-daas-views.html",controller:"daasViewsViewController"}}),_component.controller("daasViewsViewController",["$scope","$rootScope","$location","$workflowService","$timeout","$applicationService","BTFlowtaskService","BTStreamsService","NotificationService","$q","env_conf","i18n",function($scope,$rootScope,$location,$workflowService,$timeout,$applicationService,BTFlowtaskService,BTStreamsService,NotificationService,$q,env_conf,i18n){function load(){$scope.callbacks&&$scope.callbacks.nodeInfo&&$scope.callbacks.nodeInfo.status&&($scope.selectedStreamState=$scope.callbacks.nodeInfo.status)}function getViews(){BTStreamsService.daasViews($applicationService.userInfo().userId,$scope.streamId).then(function(res){res.data.views.length||NotificationService.notify("No views found","error"),res.data&&res.data.views&&($scope.views=res.data.views,updateData())},function(error){var msg=error.errors?error.errors[0].msg:i18n.i18nString("fetch_lookup");NotificationService.notify(msg,"error")})}function getTables(){BTStreamsService.daasTables($applicationService.userInfo().userId,$scope.streamId).then(function(res){var result=res.data.tables;if($scope.totTables=res.data.tables,result&&result.length)for(var i=0;i<result.length;i++)for(var j=0;j<result[i].fields.length;j++)result[i].fields[j].tableName=result[i].name,$scope.selectedFields.push(result[i].fields[j]);result.length||NotificationService.notify("No table columns found","error")},function(error){var msg=error.errors?error.errors[0].msg:i18n.i18nString("fetch_lookup");NotificationService.notify(msg,"error")})}function updateData(){$scope.requestservicedata&&$scope.requestservicedata.name&&"view"==$scope.requestservicedata.resource?($scope.viewForm={name:$scope.requestservicedata.name,filterRules:$scope.ruleConditionAnd,limit:null,offset:null},$scope.requestservicedata.query&&$scope.requestservicedata.query.expressions&&($scope.viewForm.filterRules.rules=$scope.requestservicedata.query.expressions,$scope.viewForm.filterRules.condition=$scope.requestservicedata.query.operator||"and"),$scope.requestservicedata.skip&&($scope.viewForm.skip=$scope.requestservicedata.skip),$scope.requestservicedata.limit&&($scope.viewForm.limit=$scope.requestservicedata.limit)):$scope.reset()}$scope.streamId=$workflowService.selectedStream()._id,$scope.viewForm={name:"",filterRules:"",limit:null,skip:null},$scope.ruleConditionAnd={condition:"and",rules:[]},$scope.viewForm.filterRules=$scope.ruleConditionAnd,$scope.views=[],$scope.selectedFields=[],$scope.sampleResponse={},$scope.options={aceMode:"ace/mode/javascript",mode:"view"===$scope.displayMode?"tree":"code",ace:window.ace},$scope.assetsBase=env_conf["assets-url"],$scope.sampleResponseIndex=0,$scope.totTables={},$scope.selectedStreamState="",load(),getViews(),getTables(),$scope.onChangeData=function(name){$scope.viewForm.name=name.name;var filteredTables=($scope.views.find(function(o){return o.name===$scope.viewForm.name}),$scope.totTables.find(function(o){return o.name==name.query.dataSet}));filteredTables&&(filteredTables.fields.tableName=filteredTables.name,$scope.selectedFields=filteredTables.fields),$scope.viewForm.filterRules.rules=[],$scope.viewForm.filterRules.rules.push({field:"",operand:"",value:""})},$scope.selectView=function(name){$scope.viewForm.name=name},$scope.isFormValid=function(form){var isAddDataValid=$scope.isFilterRuleValid(form);return!form.name||!isAddDataValid},$scope.isFilterRuleValid=function(form){if(form&&form.filterRules&&form.filterRules.rules){var isAddDataValid=form.filterRules.rules.every(function(res){return res.field&&res.operand&&res.value?!0:!1});return isAddDataValid}},$scope.daasTestCloseModal=function(){$scope.closeModalSlider("#daas-test")},$scope.testData=function(){$scope.callbacks.openDaasTest(),BTStreamsService.daasSaveServiceNode($scope.componentid,$scope.streamId,$scope._payload).then(function(response){NotificationService.notify("Saved Successfully","success"),$scope.callbacks.nodeInfo.payload=response.config.data.payload,$scope.callbacks.nodeInfo.serviceNodeType=response.config.data.serviceNodeType,$scope.reqdefcb.onServiceSave($scope.callbacks.nodeInfo),BTFlowtaskService.executeComponent($scope.streamId,$scope.componentid).then(function(res){$scope.sampleResponse=res.data,$scope.callbacks.sampleResponse=res.data},function(res){var err=res.data,errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("some_thing_wrong_label");NotificationService.notify(errMsg,"error");var parsedErrObj={};try{parsedErrObj=JSON.parse(err.errors[0].msg)}catch(e){parsedErrObj=err.errors[0].msg||{errors:[{msg:i18n.i18nString("bt_reqst_unkown_msg"),code:"Unknown"}]}}$scope.sampleResponse=parsedErrObj,$scope.callbacks.sampleResponse=parsedErrObj})},function(error){var msg=error.errors?error.errors[0].msg:i18n.i18nString("fetch_lookup");NotificationService.notify(msg,"error")})},$scope.saveView=function(type){if(!$scope.isFormValid($scope.viewForm)){if($scope._payload={serviceNodeType:"datatable",payload:{query:{expressions:$scope.viewForm.filterRules.rules,operator:$scope.viewForm.filterRules.condition},name:$scope.viewForm.name,method:"query",resource:"view",skip:$scope.viewForm.skip,limit:$scope.viewForm.limit}},"TEST"==type)return void window.bootbox.dialog({message:"The configurations used to define the Service Definition will be saved before initiating the Test",title:"Confirm to proceed",className:"daas-confirm-dialog",onEscape:function(){},closeButton:!1,buttons:{success:{label:i18n.i18nString("confirm"),className:" btn_md",callback:function(){$scope.testData()}},main:{label:i18n.i18nString("cancel"),className:"closeCancel btn_md",callback:function(){}}}});BTStreamsService.daasSaveServiceNode($scope.componentid,$scope.streamId,$scope._payload).then(function(response){NotificationService.notify("Saved Successfully","success"),$scope.callbacks.nodeInfo.payload=response.config.data.payload,$scope.callbacks.nodeInfo.serviceNodeType=response.config.data.serviceNodeType,$scope.reqdefcb.onServiceSave($scope.callbacks.nodeInfo),"SAVE"==type&&$scope.onCancel()},function(error){var msg=error.errors?error.errors[0].msg:i18n.i18nString("fetch_lookup");NotificationService.notify(msg,"error")})}},$scope.daasCloseModal=function(){updateData(),$scope.onCancel()};var original=angular.copy($scope.viewForm);$scope.reset=function(){$scope.viewForm=angular.copy(original)},$scope.addSimpleValidation=function(){if($scope.isFilterRuleValid($scope.viewForm)&&$scope.viewForm.filterRules.rules.length<50){var ruleObj={field:"",operand:"",value:""};$scope.viewForm.filterRules.rules.push(ruleObj)}},$scope.removeSimpleValidation=function(rule){var index=$scope.viewForm.filterRules.rules.indexOf(rule);$scope.viewForm.filterRules.rules.splice(index,1)}}])}(angular),function(ng){var _module=ng.module("bt-components");_module.directive("draggable",function(){return{restrict:"AC",scope:{},link:function(scope,element){var el=element[0];el.draggable=!0,el.addEventListener("dragstart",function(e){return e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("Text","<%="+$.trim(this.innerHTML)+"%>"),this.classList.add("drag"),!1},!1),el.addEventListener("dragend",function(e){return this.classList.remove("drag"),!1},!1)}}})}(angular),function(ng){var _module=ng.module("bt-components");_module.directive("droppable",function(){return{scope:{drop:"&"},link:function(scope,element,attrs){var el=element[0];el.addEventListener("dragover",function(e){return e.dataTransfer.dropEffect="move",e.preventDefault&&e.preventDefault(),this.classList.add("over"),!1},!1),el.addEventListener("dragenter",function(e){return this.classList.add("over"),!1},!1),el.addEventListener("dragleave",function(e){return this.classList.remove("over"),!1},!1),el.addEventListener("drop",function(e){if(e.stopPropagation&&e.stopPropagation(),this.classList.remove("over"),navigator.userAgent.toLowerCase().indexOf("firefox")<0){var item=e.dataTransfer.getData("Text");this.value=this.value?this.value+item:item}return scope.$apply("drop()"),!1},!1)}}})}(angular),function(ng){angular.module("bt-components").directive("btCheckbox",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-checkbox/bt-checkbox.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function getValue(options){return options=_.isArray(options)?options:[],options=angular.copy(options),options=options.filter(function(option){return option.selected}),options.map(function(option){switch($scope.schema.type){case"string":return option.value+"";case"number":return+option.value;default:return option.value}})}function bindInitialValue(initial){_.isArray(initial)&&initial.length>0?(initial.map(function(value){$scope.options.map(function(option){option.selected=option.value===value+""})}),ngModelCtrl.$setDirty()):_.isArray(initial)&&($scope.options.map(function(option){option.selected=!1}),ngModelCtrl.$setPristine())}var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,$scope.options=angular.copy($scope.schema.staticDropDownFields),ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch("options",function(newVal,oldVal){(ngModelCtrl.$dirty||newVal)&&(ngModelCtrl.$setViewValue(getValue(newVal)),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&0!==getValue(newVal).length))},!0),bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").config(["datepickerConfig",function(datepickerConfig){datepickerConfig.showWeeks=!1,datepickerConfig.datepickerMode="year"}]).directive("btDate",["$timeout","$filter",function($timeout,$filter){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-date/bt-date.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function bindInitialValue(initial){_.isUndefined(initial)?($scope.control.value="",ngModelCtrl.$setPristine()):($scope.control.value=initial,ngModelCtrl.$setDirty())}$scope.control={};var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,$scope.options=angular.copy($scope.schema.staticDropDownFields),ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch("control.value",function(newVal,oldVal){(ngModelCtrl.$dirty||newVal)&&(ngModelCtrl.$setViewValue($filter("date")(newVal,$scope.schema.format)),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&newVal))},!0),bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.dateOptions={formatYear:"yy",startingDay:1,showWeeks:!1},$scope.$watch("schema",function(newVal){initializeControl()}),$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0}}}}])}(angular),function(ng){angular.module("bt-components").directive("btDatetime",["$filter",function($filter){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-datetime/bt-datetime.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function setDateTimeValue(date,time){date&&(date=date||new Date,time=time||new Date,date.setHours(time.getHours()),date.setMinutes(time.getMinutes()),$scope.control.value=$filter("date")(date,$scope.schema.format))}function bindInitialValue(initial){_.isUndefined(initial)?($scope.control.value=void 0,ngModelCtrl.$setPristine()):($scope.control.value=initial,ngModelCtrl.$setDirty())}$scope.control={};var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,$scope.options=angular.copy($scope.schema.staticDropDownFields),ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch("control.value",function(newVal,oldVal){(ngModelCtrl.$dirty||newVal)&&(ngModelCtrl.$setViewValue($filter("date")(newVal,$scope.schema.format)),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&newVal))},!0),$scope.$watch("control.time",function(newVal,oldVal){var date=$scope.control.date,time=$scope.control.time;setDateTimeValue(date,time)}),$scope.$watch("control.date",function(newVal,oldVal){var date=$scope.control.date,time=$scope.control.time;setDateTimeValue(date,time)}),bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)},$scope.showDateTimePicker=function(){$scope.showPicker=!$scope.showPicker}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btDirectory",[function(){return{restrict:"EA",scope:{schema:"=",authId:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-directory/bt-directory.html",link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){angular.module("bt-components").directive("btDynamicdropdown",["$translator","$timeout","$applicationService","i18n",function($translator,$timeout,$applicationService,i18n){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",authId:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-dynamicdropdown/bt-dynamicdropdown.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function getValue(value){var item;return $scope.schema.isMultiSelect?($scope.addValue(value),$scope.values):(item=$scope.options.filter(function(option){return option.value==value})[0]||{},item.value=convertValue($scope.schema.type,item.value),item)}function loadOptions(dropdownInfo){$scope.control.loading=!0,$translator.translate("bt.dropdown.test",{instanceId:$scope.authId||"none"},dropdownInfo).then(function(res){$scope.options=res.data,bindInitialValue($scope.schema.initial),$scope.control.loading=!1},function(err){$scope.control.loading=!1,resetValue(),TRIED_COUNT++<RETRY_COUNT&&loadOptions(dropdownInfo)})}function dependencies(){return keys.map(function(key){fields[key]=formCtrl[key]&&formCtrl[key].$modelValue}),fields}function dependencyFieldsLoaded(values){var readyToLoad=!0;return Object.keys(values).map(function(key){!_.isObject(values[key])||_.isDate(values[key])||values[key].value?values[key]||(readyToLoad=!1):readyToLoad=!1}),readyToLoad}function extractOnlyValues(fields){return fields=angular.copy(fields),Object.keys(fields).map(function(key){fields[key]=fields[key]&&fields[key].value||fields[key]}),fields}function resetValue(){$scope.control.value="",$scope.options=[]}function validValue(value){return $scope.schema.isMultiSelect?!!(_.isArray(value)&&value.length>0):!!value}function convertValue(type,value){switch(type){case"string":return value+"";case"number":return+value;default:return value}}function bindInitialValue(initial){!_.isUndefined(initial)&&_.isString(initial)?($scope.control.value=initial,ngModelCtrl.$setDirty()):!_.isUndefined(initial)&&_.isArray(initial)&&initial.length>0?(initial.map($scope.addValue),ngModelCtrl.$setDirty()):!_.isUndefined(initial)&&_.isArray(initial)&&0===initial.length?($scope.values=[],$scope.valuetags=[]):initial||($scope.control.value="",$scope.values=[],ngModelCtrl.$setPristine())}var RETRY_COUNT=5,TRIED_COUNT=0,ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm,dropdownInfo=angular.copy($scope.schema.dynamicDropDownInfo),keys=$scope.schema.dependsOn,fields={};$scope.authId=$applicationService.authId(),$scope.control={},$scope.values=[],$scope.valuetags=[],$scope.options=[],$scope.form=formCtrl;var key=$scope.schema.isMultiSelect?"values":"control.value";$scope.select2config={allowClear:!0,placeholder:i18n.i18nString("select_a_key")},ngModelCtrl.$name=$scope.schema.key,$scope.control.loading=!1,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch(key,function(newVal,oldVal){$timeout(function(){(ngModelCtrl.$dirty||validValue(newVal))&&(ngModelCtrl.$setViewValue(getValue(newVal)),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&!!validValue(newVal)))})},$scope.schema.isMultiSelect),$scope.shouldLoad=_.partial(dependencyFieldsLoaded,fields),0===keys.length?loadOptions(dropdownInfo):$scope.$watch(dependencies,function(newVal,oldVal){resetValue(),dependencyFieldsLoaded(newVal)&&(dropdownInfo.fields=extractOnlyValues(fields),loadOptions(dropdownInfo))},!0),$scope.addValue=function(value){var item;value&&(item=$scope.options.filter(function(option){return option.value==value})[0],item.value=convertValue($scope.schema.type,item.value),$scope.values.push(angular.copy(item)),$scope.valuetags.push(item.title),$scope.control.value="")},$scope.deleteValue=function(index){$scope.values.splice(index,1),$scope.valuetags.splice(index,1)},ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btEmail",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-email/bt-email.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function getValue(value){return $scope.schema.isMultiSelect?_.isArray(value)&&value.length>0:!!value}function validValue(value){return $scope.schema.isMultiSelect?_.isArray(value)&&value.length>0:!!value}function bindInitialValue(initial){!_.isUndefined(initial)&&_.isString(initial)?($scope.control.value=initial,ngModelCtrl.$setDirty()):!_.isUndefined(initial)&&_.isArray(initial)&&initial.length>0?($scope.values=initial,ngModelCtrl.$setDirty()):initial||($scope.values=[],$scope.control.value="",ngModelCtrl.$setPristine())}$scope.control={},$scope.values=[];var key=$scope.schema.isMultiSelect?"values":"control.value",ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch(key,function(newVal,oldVal){(ngModelCtrl.$dirty||validValue(newVal))&&(ngModelCtrl.$setViewValue(newVal),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&!!getValue(newVal)))},$scope.schema.isMultiSelect),$scope.addValue=function(value){value&&($scope.values.push(value),$scope.control.value="")},$scope.deleteValue=function(index){$scope.values.splice(index,1)},bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btFileupload",["$timeout","BTFileUploadService","i18n",function($timeout,BTFileUploadService,i18n){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-fileupload/bt-fileupload.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function getValue(value){return _.isArray(value)&&value.length>0?!0:!1}$scope.control={value:[],file:"",filelist:[]};var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(evt){$timeout(function(){ngModelCtrl.$setDirty(),("click"===evt.type||"blur"===evt.type||"keyup"===evt.type)&&(evt.target.files=[]),$scope.control.filelist.length>0||evt.target.files&&evt.target.files[0]&&($scope.control.file=evt.target.files[0],$scope.uploadFile())})}),$scope.$watch("control.value",function(newVal,oldVal){(ngModelCtrl.$dirty||newVal)&&(ngModelCtrl.$setViewValue(newVal),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&getValue(newVal)))},!0),$scope.uploadFile=function(){if($scope.schema.allowMultiple||$scope.deleteFile(0),!$scope.fileuploading){$scope.fileuploading=!0;var data=new FormData;data.append("file",$scope.control.file),data.append("fileContext","marketplace"),data.append("fileExtension","png"),BTFileUploadService.uploadFile(data).then(function(response){$scope.control.filelist.push($scope.control.file.name),$scope.control.value.push(response.data.fileId),$scope.control.filesuploaded=i18n.i18nString("files_uploaded",{dyn:$scope.control.filelist.length}),$scope.fileuploading=!1},function(response){$scope.fileuploading=!1})}},$scope.deleteFile=function(index){$scope.control.filelist.splice(index,1),$scope.control.value.splice(index,1),$scope.control.filesuploaded=i18n.i18nString("files_uploaded",{dyn:$scope.control.filelist.length})},ngModelCtrl.$render=function(){$scope.control.filelist=[],$scope.control.value=[],$scope.control.filesuploaded=0,ngModelCtrl.$setPristine()}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btLabel",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-label/bt-label.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){$scope.control={value:$scope.schema.mapping};var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),ngModelCtrl.$setDirty(),ngModelCtrl.$setViewValue($scope.control.value)}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btLocation",["$geolocator","$rootScope","i18n",function($geolocator,$rootScope,i18n){return{restrict:"EA",require:["^ngModel","^form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-location/bt-location.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function bindInitialValue(initial){_.isUndefined(initial)?($scope.control.viewValue="",ngModelCtrl.$setPristine()):($scope.control.viewValue=initial.title||initial,ngModelCtrl.$setDirty())}$scope.control={viewValue:"",modelValue:{}};var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm,userSearch=!1;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$scope.locationSelected=!1,$scope.locations=[],$scope.locating=!0,$geolocator.getCurrentCoordinates().then(function(res){res.location?$geolocator.getLocation(res.location).then(function(res){$scope.locations=res.locations,$scope.locating=!1},function(err){$scope.locating=!1,$scope.locations=[],$scope.locationSelected=!1}):$scope.locating=!1}),$scope.toggleSuggestions=function(){$scope.control.viewValue||userSearch?$scope.showSuggestions=!1:($scope.showSuggestions=!0,$scope.enableUserSearch=!0)},$scope.searchLocation=function(){$scope.control.viewValue&&($scope.searching=!0,$geolocator.getLocation($scope.control.viewValue).then(function(res){userSearch=!0,$scope.locations=res.locations,$scope.searching=!1,$scope.showSuggestions=!0,$scope.locationSelected=!1},function(err){$scope.searching=!1,$scope.locations=[]}))},$scope.pickLocation=function(index){var modelValue={};$scope.control.viewValue=$scope.locations[index].address,modelValue.value=$scope.locations[index].coords,modelValue.title=$scope.control.viewValue,$scope.control.modelValue=modelValue,ngModelCtrl.$setDirty(),$scope.locations=[],$scope.enableUserSearch=!1,$scope.locationSelected=!0},$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch("control.modelValue",function(newVal,oldVal){(ngModelCtrl.$dirty||newVal)&&(0!==Object.keys(newVal).length||0!==Object.keys(oldVal).length)&&(ngModelCtrl.$setViewValue(newVal),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&!!newVal))}),bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.locatingLabel=i18n.i18nString("locating"),$scope.locate=i18n.i18nString("locate"),$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btNestedform",["$compile",function($compile){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-nestedform/bt-nestedform.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function isValid(value){return value&&_.isArray(value)?value.length>0:!1}var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,$scope.values=[],$scope.isNestedForm=!0,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch("values",function(newVal,oldVal){(ngModelCtrl.$dirty||newVal)&&(ngModelCtrl.$setViewValue(newVal),
$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&isValid(newVal)))},!0),$scope.getValue=function(value){return _.isObject(value)?value.value:value},$scope.save=function(data){var payload={};Object.keys(data).map(function(key){data[key]&&(payload[key]=data[key])}),$scope.values.push(payload),$scope.hide()},$scope.deleteValue=function(index){$scope.values.splice(index,1)},$scope.show=function(){$scope.showForm=!0},$scope.hide=function(){$scope.showForm=!1};var template_='<div ng-if="showForm"><dynamic-form nestedform="isNestedForm" auth-id="authId" fields="schema.fields" on-save="save(data)" on-cancel="hide()" ></dynamic-form></div>';$ele.find(".nested-form").html(template_),$compile($ele.find(".nested-form"))($scope)}$scope.$watch("schema",function(){$scope.showForm=!1,initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btPassword",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-password/bt-password.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){$scope.control={};var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch("control.value",function(newVal,oldVal){(ngModelCtrl.$dirty||newVal)&&(ngModelCtrl.$setViewValue(newVal),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&!!newVal))}),ngModelCtrl.$render=function(){$scope.control.value=ngModelCtrl.$viewValue,ngModelCtrl.$setPristine()}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btRadio",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-radio/bt-radio.html",link:function($scope,$ele,$attrs,ctrls){}}}])}(angular),function(ng){angular.module("bt-components").directive("btSearchcontrol",[function(){return{restrict:"EA",scope:{schema:"=",authId:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-searchcontrol/bt-searchcontrol.html",link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){angular.module("bt-components").directive("btStaticdropdown",["i18n",function(i18n){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-staticdropdown/bt-staticdropdown.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function validValue(value){return $scope.schema.isMultiSelect?!!(_.isArray(value)&&value.length>0):!!value}function getValue(value){var item;return $scope.schema.isMultiSelect?$scope.values:(item=$scope.options.filter(function(option){return option.value==value})[0]||{},item.value=convertValue($scope.schema.type,item.value),item)}function convertValue(type,value){switch(type){case"string":return value+"";case"number":return+value;default:return value}}function bindInitialValue(initial){!_.isUndefined(initial)&&_.isString(initial)?($scope.control.value=initial,ngModelCtrl.$setDirty()):!_.isUndefined(initial)&&_.isArray(initial)&&initial.length>0?(initial.map($scope.addValue),ngModelCtrl.$setDirty()):($scope.control.value="",$scope.valuetags=[],$scope.values=[],ngModelCtrl.$setPristine())}$scope.control={},$scope.options=angular.copy($scope.schema.staticDropDownFields),$scope.select2config={allowClear:!0,placeholder:i18n.i18nString("select_a_key")},$scope.values=[],$scope.valuetags=[];var key=$scope.schema.isMultiSelect?"values":"control.value",ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch(key,function(newVal,oldVal){(ngModelCtrl.$dirty||validValue(newVal))&&(ngModelCtrl.$setViewValue(getValue(newVal)),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&!!validValue(newVal)))},$scope.schema.isMultiSelect),$scope.addValue=function(value){var item;value&&(item=$scope.options.filter(function(option){return option.value==value})[0],item.value=convertValue($scope.schema.type,item.value),$scope.values.push(angular.copy(item)),$scope.valuetags.push(item.title),$scope.control.value="")},$scope.deleteValue=function(index){$scope.values.splice(index,1),$scope.valuetags.splice(index,1)},bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btTextarea",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-textarea/bt-textarea.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function bindInitialValue(initial){_.isUndefined(initial)?($scope.control.value="",ngModelCtrl.$setPristine()):($scope.control.value=initial,ngModelCtrl.$setDirty())}$scope.control={};var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch("control.value",function(newVal,oldVal){(ngModelCtrl.$dirty||newVal)&&(ngModelCtrl.$setViewValue(newVal),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&!!newVal))}),bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btTextbox",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-textbox/bt-textbox.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function getValue(value){return $scope.schema.isMultiSelect?_.isArray(value)&&value.length>0:!!value}function validValue(value){return $scope.schema.isMultiSelect?_.isArray(value)&&value.length>0:!!value}function bindInitialValue(initial){!_.isUndefined(initial)&&_.isString(initial)?($scope.control.value=initial,ngModelCtrl.$setViewValue(initial),ngModelCtrl.$setDirty()):!_.isUndefined(initial)&&_.isArray(initial)&&initial.length>0?($scope.values=initial,ngModelCtrl.$setViewValue(initial),ngModelCtrl.$setDirty()):($scope.values=[],$scope.control.value="",ngModelCtrl.$setPristine())}$scope.control={},$scope.values=[];var key=$scope.schema.isMultiSelect?"values":"control.value",ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){if(!ngModelCtrl.$viewValue)if(ngModelCtrl.$setDirty(),$scope.schema.isMultiSelect){var _ignore=!0;_ignore=$scope.schema.isRequired?!!$scope.values.length:!0,ngModelCtrl.$setValidity("required",_ignore)}else ngModelCtrl.$setValidity("required",!$scope.schema.isRequired)}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch(key,function(newVal,oldVal){if(ngModelCtrl.$dirty||validValue(newVal))if(ngModelCtrl.$setViewValue(newVal),$scope.schema.isRequired&&!$scope.schema.isMultiSelect)ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&!!getValue(newVal));else{var _ignore=!0;_ignore=$scope.schema.isRequired?!!$scope.values.length:!0,ngModelCtrl.$setValidity("required",_ignore)}},$scope.schema.isMultiSelect),$scope.addValue=function(value){value&&($scope.values.push(value),$scope.values=_.uniq($scope.values),$scope.control.value="")},$scope.deleteValue=function(index){$scope.values.splice(index,1)},bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btTimezone",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-timezone/bt-timezone.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){$scope.control={value:(new Date).getTimezoneOffset().toString()};var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),ngModelCtrl.$setDirty(),ngModelCtrl.$setViewValue($scope.control.value)}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btTypeahead",["$translator","$timeout","$applicationService","i18n",function($translator,$timeout,$applicationService,i18n){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",authId:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-typeahead/bt-typeahead.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function getValue(value){var item;return $scope.schema.isMultiSelect?$scope.values:$scope.options.length?(item=$scope.options.filter(function(option){return option.title==value})[0]||{},item.value=convertValue($scope.schema.type,item.value),item):$scope.schema.editable&&checkValidity(value)?item={title:value,value:value}:null}function checkValidity(value){var emailRegEx=/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|xyz|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i;return"email"!==$scope.schema.type?!0:emailRegEx.test(value)?!0:!1}function dependencies(){return keys.map(function(key){fields[key]=formCtrl[key]&&formCtrl[key].$modelValue}),fields}function dependencyFieldsLoaded(values){var readyToLoad=!0;return Object.keys(values).map(function(key){!_.isObject(values[key])||_.isDate(values[key])||values[key].value?values[key]||(readyToLoad=!1):readyToLoad=!1}),readyToLoad}function extractOnlyValues(fields){return fields=angular.copy(fields),Object.keys(fields).map(function(key){fields[key]=fields[key]&&fields[key].value||fields[key]}),fields}function resetValue(){$scope.control.value="",$scope.options=[],TRIED_COUNT=0}function validValue(value){return $scope.schema.isMultiSelect?!!(_.isArray(value)&&value.length>0):!!value}function convertValue(type,value){switch(type){case"string":return value+"";case"number":return+value;default:return value}}function bindInitialValue(initial){!_.isUndefined(initial)&&_.isString(initial)?($scope.control.value=initial,ngModelCtrl.$setDirty()):!_.isUndefined(initial)&&_.isArray(initial)&&initial.length>0?(initial.map($scope.addValue),ngModelCtrl.$setDirty()):($scope.control.value="",$scope.values=[],ngModelCtrl.$setPristine())}var TRIED_COUNT=0,ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm,typeahead=angular.copy($scope.schema.dynamicDropDownInfo),fields={},keys=$scope.schema.dependsOn,key=$scope.schema.isMultiSelect?"values":"control.value";$scope.authId=$applicationService.authId(),$scope.control={},$scope.options=[],$scope.values=[],$scope.valuetags=[],$scope.form=formCtrl,$scope.control.loading=!0,$scope.select2config={allowClear:!0,placeholder:i18n.i18nString("select_a_key")},ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch(key,function(newVal,oldVal){(ngModelCtrl.$dirty||validValue(newVal))&&(ngModelCtrl.$setViewValue(getValue(newVal)),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&validValue(newVal)))},$scope.schema.isMultiSelect),$scope.selected=function(option,index){$scope.control.value=option.title,$timeout(function(){$scope.hideOptions=!0})},$(document).on("click",function(){$timeout(function(){$scope.hideOptions=!0})}),keys.length>0&&$scope.$watch(dependencies,function(newVal,oldVal){return dependencyFieldsLoaded(newVal)?void 0:void resetValue()},!0),$scope.shouldLoad=_.partial(dependencyFieldsLoaded,fields),$scope.getData=function(query){$scope.loading=!0,$scope.hideOptions=!1,dependencyFieldsLoaded(fields)&&query&&(typeahead.fields=extractOnlyValues(fields),typeahead.fields.query=query||"",$scope.loading=!0,$scope.options=[],$translator.translate("bt.dropdown.test",{instanceId:$scope.authId||"none"},typeahead).then(function(res){$scope.options=res.data,$scope.loading=!1},function(err){$scope.loading=!1,$scope.options=[]}))},$scope.addValue=function(value){var item;value&&(item=$scope.options.filter(function(option){return option.title==value})[0]||{},item.value=convertValue($scope.schema.type,item.value),$scope.values.push(angular.copy(item)),$scope.valuetags.push(item.title),$scope.control.value="")},$scope.deleteValue=function(index){$scope.values.splice(index,1),$scope.valuetags.splice(index,1)},bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("btUrl",[function(){return{restrict:"EA",require:["^ngModel","^?form"],scope:{schema:"=",validator:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/bt-url/bt-url.html",link:function($scope,$ele,$attrs,ctrls){function initializeControl(){function getValue(value){return $scope.schema.isMultiSelect?_.isArray(value)&&value.length>0:!!value}function validValue(value){return $scope.schema.isMultiSelect?_.isArray(value)&&value.length>0:!!value}function bindInitialValue(initial){!_.isUndefined(initial)&&_.isString(initial)?($scope.control.value=initial,ngModelCtrl.$setDirty()):!_.isUndefined(initial)&&_.isArray(initial)&&initial.length>0?($scope.values=initial,ngModelCtrl.$setDirty()):($scope.control.value="",$scope.values=[],ngModelCtrl.$setPristine())}$scope.control={value:""},$scope.values=[];var key=$scope.schema.isMultiSelect?"values":"control.value",ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,ngModelCtrl.$name=$scope.schema.key,formCtrl.$addControl(ngModelCtrl),_.isArray($scope.validator)&&$scope.validator.push(function(){ngModelCtrl.$viewValue||(ngModelCtrl.$setDirty(),ngModelCtrl.$setValidity("required",!$scope.schema.isRequired))}),$ele.on("keyup blur change click",function(){ngModelCtrl.$setDirty()}),$scope.$watch(key,function(newVal,oldVal){(ngModelCtrl.$dirty||validValue(newVal))&&(ngModelCtrl.$setViewValue(newVal),$scope.schema.isRequired&&ngModelCtrl.$setValidity("required",$scope.schema.isRequired&&getValue(newVal)))},$scope.schema.isMultiSelect),$scope.addValue=function(value){value&&($scope.values.push(value),$scope.control.value="")},$scope.deleteValue=function(index){$scope.values.splice(index,1)},bindInitialValue($scope.schema.initial),ngModelCtrl.$render=function(){bindInitialValue(ngModelCtrl.$viewValue)}}$scope.$watch("schema",function(){initializeControl()})}}}])}(angular),function(ng){angular.module("bt-components").directive("dynamicForm",["$timeout","$applicationService",function($timeout,$applicationService){return{restrict:"EA",scope:{inputFields:"=fields",authId:"=",onSave:"&",onCancel:"&",nestedform:"=?",isTestingGoing:"=?",hideControls:"@?",bridge:"=?",dynamic:"=?",submit:"=?"},controller:["$scope","form_util",function($scope,form_util){function runValidators(){$scope.validators.map(function(validator){validator()})}function clone(obj){try{return JSON.parse(JSON.stringify(obj))}catch(ex){return obj}}$scope.showFields=!1,$scope.fieldsInfo=[],$scope.payload={},$scope.$watch("fields",function(newVal,oldVal){$scope.payload={},$scope.showFields=!1,_.isArray(newVal)&&($scope.fields.map(function(field){$scope.payload[field.key]=field.value||field.initial,field.initial=field.value||field.initial}),$scope.showFields=!0,$scope.fieldsInfo=$scope.fields)}),$scope.bridge=$scope.bridge||{},$scope.options={mode:"code",ace:window.ace},$scope.$watch("inputFields",function(newVal,oldVal){_.isArray(newVal)&&($scope.fields=clone(newVal))}),$scope.$watch("authId",function(newVal,oldVal){$scope.fields=clone($scope.inputFields),newVal&&$applicationService.authId($scope.authId)}),$scope.validators=[],$scope.submit=function(form){runValidators(),form.$valid&&$scope.onSave({data:$scope.payload})},$scope.dynamic={},$scope.bridge.submit=function(){$scope.submit($scope.dynamic.payloadForm)},$scope.bridge.save=function(){return $scope.dynamic.payloadForm?(runValidators(),$scope.dynamic.payloadForm.$valid?$scope.payload:void 0):{error:"noPayloadForm"}}}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/dynamic-form/dynamic-form.html",link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("dynamicHeight",function(){return{restrict:"EA",scope:{dynaoffset:"=?",offsetExclude:"=",heightProperty:"@?"},link:function(scope,el,attrs){if(scope.dynaoffset=scope.dynaoffset||0,scope.heightProperty=scope.heightProperty||"max-height",!scope.offsetExclude){$(el).css(scope.heightProperty,$(window).height()+parseInt(scope.dynaoffset)),$(el).css("max-height",$(window).height()+parseInt(scope.dynaoffset));var resizer=function(event){$(el).css(scope.heightProperty,$(window).height()+parseInt(scope.dynaoffset)),$(el).css("max-height",$(window).height()+parseInt(scope.dynaoffset)),$(el).hasClass("ps-container")&&PerfectScrollbar.update($(".ps-container")[0])};$(window).resize(resizer),scope.$on("$destroy",function(){$(window).off("resize",resizer),el.off()})}}}})}(angular),function(){"use strict";function emailPhone($workflowService,$timeout,i18n){function link(scope,element,attrs,ctrl){function validate(value,phoneNumber){var valid=!1;phoneNumber===!0?$workflowService.isPhone(value)&&(valid="true"===scope.basicValidation?scope.countryCode===i18n.i18nString("Bt_chnl_cisco_config_countryCode_label")?!1:pn.test(value):scope.countryCode===i18n.i18nString("Bt_chnl_cisco_config_countryCode_label")?!1:libphonenumber.isValidNumber(scope.countryCode+value,"")):valid=emailRegEx.test(value),value&&value.trim().length>0?(ctrl.$setValidity("mobRequired",!0),ctrl.$setValidity("invalidFormat",valid)):ctrl.$setValidity("invalidFormat",!0)}var numberRegEx=/^\d+$/,emailRegEx=/(?!^[.+&'_-]*@.*$)(^[_\w\d+&'-]+(\.[_\w\d+&'-]*)*@[\w\d-]+(\.[\w\d-]+)*\.(([\d]{1,3})|([\w]{2,}))$)/i,phoneNumber=!1,pn=/^[ ()+]*([0-9][ ()+]*){8,14}$/;scope.$on("onCountryCodeSelected",function(){if(!scope.emailOnly){var value=element[0].value.replace(/-/g,"");$timeout(function(){validate(value,!0)})}}),scope.emailOnly&&"false"!==scope.emailOnly||ctrl.$formatters.push(function(value){return value&&value.length?$workflowService.formatPhone(value):""}),ctrl.$parsers.push(function(value){if(void 0!==scope.emailOnly&&scope.emailOnly===!0)return phoneNumber=!1,validate(value,phoneNumber),value;var newValue=value.replace(/-/g,"");return value.length>0&&(numberRegEx.test(newValue)?(ctrl.$setViewValue($workflowService.formatPhone(newValue)),phoneNumber=newValue.length>=3||phoneNumber===!0?!0:!1):phoneNumber=!1),"+"===value.substring(0,1)&&(phoneNumber=!0,ctrl.$setViewValue("")),void 0!==scope.phoneOnly&&scope.phoneOnly===!0&&(phoneNumber=!0),ctrl.$render(),void 0!==scope.phoneCodes&&scope.phoneCodes({value:phoneNumber}),validate(newValue,phoneNumber),value})}var directive={require:"ngModel",restrict:"A",link:link,scope:{phoneCodes:"&?",phoneOnly:"=",emailOnly:"=",countryCode:"@",basicValidation:"@?"}};return directive}angular.module("bt-components").directive("emailPhone",emailPhone),emailPhone.$inject=["$workflowService","$timeout","i18n"]}(),function(ng){var _entityOrFieldDrpdwnCmp=ng.module("bt-components");_entityOrFieldDrpdwnCmp.directive("entityorfieldDropdown",function(){return{restrict:"EA",scope:{offsetObject:"=?",entitiesList:"=?",selectedTask:"=?",showentityDropdown:"=?",context:"=?",selectedUtterance:"=?",callBacks:"=?"},replace:!0,controller:["$scope","_constants_",function($scope,_constants_){$scope.constants=_constants_}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/entityorfield-dropdown/entityorfield-dropdown.html",link:function($scope,$element,$attrs,ctrls){function getSelectedText(){var text="";return window.getSelection?(text=window.getSelection().toString(),console.log(window.getSelection().getRangeAt(0))):document.selection&&"Control"!=document.selection.type&&(text=document.selection.createRange().text),text}function updateDropDownPostion(showDropdown,offsetObject){if(!showDropdown)return void $($element[0]).removeClass("entity-selection-dropdown");if($scope.entitiesList&&$scope.entitiesList.length){$($element[0]).css({top:offsetObject.verticalH+20,left:offsetObject.offsetX+6}),$($element[0]).addClass("entity-selection-dropdown"),PerfectScrollbar.update($(".scrollDiv")[0]);var _container=$($element[0]).closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=$($element[0]).offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight-50},"slow")}}}return $scope.constants.config.hideMLEE?!0:($scope.callBacks=$scope.callBacks||{},$scope.entity={searchName:""},$scope.callBacks.updateDropDownPostion=updateDropDownPostion,$scope.selectedTaskType="",$scope.mapEntityToWord=function(entity){var entityID="";if("DialogIntent"==$scope.selectedTaskType){if($scope.isEntityAlreadyMapped(entity.name)&&!entity.isArray)return;entityID=entity._id}else{if($scope.isEntityAlreadyMapped(entity.title))return;entityID=entity.key}($scope.context.mapEntityToWord||angular.noop)(getSelectedText(),entityID)},$scope.$watch("showentityDropdown",function(newVal,oldVal){updateDropDownPostion(newVal)}),$scope.mappedEntityNames=[],$scope.$watchCollection("selectedUtterance",function(newVal,oldVal){$scope.selectedUtterance&&$scope.selectedUtterance.entities&&$scope.selectedUtterance.entities.length?$scope.mappedEntityNames=_.pluck($scope.selectedUtterance.entities,"entityName"):$scope.mappedEntityNames=[]}),$scope.$watchCollection("selectedTask",function(newVal,oldVal){$scope.selectedTask&&Object.keys($scope.selectedTask).length&&($scope.selectedTaskType="dialog"==$scope.selectedTask.taskType?"DialogIntent":$scope.selectedTask.taskType)}),$scope.isEntityAlreadyMapped=function(name){return-1!==$.inArray(name,$scope.mappedEntityNames)},$scope.getColorBasedOnMap=function(entity){var name="DialogIntent"==$scope.selectedTaskType?entity.name:entity.title;return $scope.isEntityAlreadyMapped(name)&&!entity.isArray?"#ddd":"#333"},void($scope.getClassBasedOnMap=function(entity){var name="DialogIntent"==$scope.selectedTaskType?entity.name:entity.title;return $scope.isEntityAlreadyMapped(name)&&!entity.isArray?"entityDisable":"entityEnable"}))}}})}(angular),function(ng){angular.module("bt-components").directive("expander",[function(){return{restrict:"EA",scope:{item:"=",index:"=",onDelete:"&",onChange:"&"},transclude:!0,templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/expander/expander.html",controller:["$scope",function($scope){$scope.item.selected="active"===$scope.item.state}],link:function($scope,ele,attrs,controller,$transcludeFn,i18n){$scope["delete"]=function(){$scope.onDelete({flow:$scope.item})},$scope.verified=i18n.i18nString("Verified"),$scope.verify=i18n.i18nString("verify"),$scope.setState=function(){$scope.item.selected=!$scope.item.selected,$scope.item.state=$scope.item.selected?"active":"inactive",$scope.onChange({flow:$scope.item})},$scope.$watch("item.state",function(newVal,oldVal){$scope.item.selected="active"==newVal}),$scope.operExpander=function(){$scope.item._open=!$scope.item._open};var transcludeScope,transcludeClone;$transcludeFn(function(clone,scope){ele.find("._expander_content").append(clone),transcludeScope=scope,transcludeClone=clone}),$scope.$on("destroy",function(){transcludeClone.remove(),transclusionScope.$destroy()})}}}])}(angular),function(ng){"use strict";ng.module("bt-components").directive("fileModel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var model=$parse(attrs.fileModel),onChangeFunc=scope.$eval(attrs.onFileChange);element.bind("change",function(event){scope.$apply(function(){model.assign(scope,element[0].files[0]),onChangeFunc(event,scope)})})}}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("focusMe",function($timeout){return{restrict:"EA",link:function(scope,el,attrs){scope.$watch(attrs.focusMe,function(value){value===!0&&$timeout(function(){el[0].focus()})})}}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("footerInfo",function(){return{transclude:!0,templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/footer-info/footer-info.html",link:function(scope,elem,attrs){}}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("helpLink",function(){return{restrict:"EA",scope:{helpLinkUrl:"@",isFooterLink:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/help-component/help-link.html",controller:"helpLinkController"}}),_module.controller("helpLinkController",["$scope","$timeout","$rootScope","env_conf",function($scope,$timeout,$rootScope,env_conf){$scope.isHelpLinkClicked=!1,$scope.targettedHelpLink="",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.goToLink=function(helpUrl,$event){$event.stopPropagation(),$scope.isHelpLinkClicked=!0,$scope.$emit("triggerHelpLinkUpdate"),window.open($rootScope.helpLinks[helpUrl],"_blank")},$scope.getHelpLink=function(helpUrl){return $rootScope.helpLinks[helpUrl]},$scope.targettedHelpLink=$scope.getHelpLink($scope.helpLinkUrl),$timeout(function(){$("[role=tabpanel]").on("show.bs.collapse",function(e){$scope.isHelpLinkClicked&&($(e.target).siblings().addClass("collapsed"),e.preventDefault(),$scope.isHelpLinkClicked=!1)}).on("hide.bs.collapse",function(e){$scope.isHelpLinkClicked&&($(e.target).siblings().removeClass("collapsed"),e.preventDefault(),$scope.isHelpLinkClicked=!1)})},3e3)}])}(angular),angular.module("app.helpers").directive("helpButton",["env_conf","i18n",function(env_conf,i18n){return{restrict:"EA",scope:{helpId:"=?"},template:'<div class="help-button"><a kr-show-help="{{helpId}}" class="help-link"><i ng-src="{{gHelpIcon}}" class="help-icon btx-help"></i><span class="help-text">'+i18n.i18nString("help_main")+"</span></a></div>",link:function($scope,$ele,$attrs){$scope.gHelpIcon=env_conf["context-url"]+"/assets/icons/gHelpIcon.svg"}}}]),function(ng){var _module=angular.module("bt-components");_module.directive("helpContent",function(){return{restrict:"EA",scope:{helpId:"=?",cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/help-content/help-content.html",controller:"helpContentController"}}),_module.controller("helpContentController",["$scope","$element","$rootScope","$timeout","env_conf","navigator","$window","interactiveHelp","$workflowService","$compile","i18n","mixPanel",function($scope,$element,$rootScope,$timeout,env_conf,navigator,$window,interactiveHelp,$workflowService,$compile,i18n,mixPanel){function warnuserToOpenBot(){var msg="";msg=$(".noBotsPlaceholder:visible").length?i18n.i18nString("please_create"):i18n.i18nString("please_select_product");var message="<p><i class='fa fa-exclamation-circle fa-2x' aria-hidden='true' style='color: #009dac;'></i></p> "+msg;window.bootbox.dialog({message:message,title:"",className:"alert-modal",buttons:{main:{label:i18n.i18nString("ok_label"),className:"btn-default",callback:angular.noop}},onEscape:!1,closeButton:!1})}$scope.helpLinks=$rootScope.helpLinks,$scope.appVersion=env_conf["app-version"],$scope.uiVersion=$scope.appVersion.split(/\.(?=[^\.]+$)/)[0],$scope.processAppLinks=["processApps","process_dashboard","process_flow","process_forms","process_settings"],$scope.processHelpPage=!1;var alerts_help_content='<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_alert_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ALERT_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("create_alert_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_71}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_rest_api")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_72}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_soap_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_73}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_webhook_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_74}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_rss_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_75}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_auth_service_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_76}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_response_alert")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_77}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_alert_scheduling")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_78}}"><i class="btx-external-link1"></i></a></span></div></div>',actions_help_content='<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_action_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ACTION_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("create_action_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_79}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_rest_api")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_80}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_soap_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_81}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_auth_service_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_82}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_response_action")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_83}}"><i class="btx-external-link1"></i></a></span></div></div>',information_help_content='<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_information_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("create_information_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_TASK_BASIC}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_rest_api")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_REQ_REST}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_soap_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_REQ_SOAP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_auth_service_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_AUTH}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_response_information")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_RES}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_table_format")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_84}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_cards_show")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_85}}"><i class="btx-external-link1"></i></a></span></div></div>',_helpContentMap={
noBotsForm:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_virtual")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.CHAT_OVER_VIEW}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("basicConcepts_Va")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.CHAT_CONCEPT}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_Va_platform")+'<a href="https://kore.ai/" target="_blank">'+i18n.i18nString("constants.iconsTooltips_kore")+"</a>"+i18n.i18nString("platform")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.GET_STARTED}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_detection_intent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_share_bots_team")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("analyze_va_performance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ANALYZE}}"><i class="btx-external-link1"></i></a></span></div></div>',customDashboard:'<div class="accordion" id="accordionExample">              <div class="main-content">     <div class="card-header" id="headingOne">     <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                 <img class="image-class-open" ng-src={{openArrow}}>                 <img class="image-class-close" ng-src={{closeArrow}}>                   <span class="How-to-use-Analytics"> '+i18n.i18nString("how_to_use_analytics")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_289}}"><i class="btx-external-link1"></i></a></span>                   </div>                <div class="collapsed-item">                    <div id="collapseOne" class="collapse" data-parent="#accordionExample">                        <div class="accordion-text">                            '+i18n.i18nString("provides_listing_success")+'</div>                            <div class="accord-info">                        <div class="accord-text"> '+i18n.i18nString("analytics_dataset")+' </div>                       <div class="accord-list"> <div class="accord-list-items">'+i18n.i18nString("metricType")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("taskName")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("userInput")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("isDeveloper")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("failure_details")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("field_synonyms_for_selected_lang_err_label2")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("channel_small")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("sessionId")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("trainingStatus")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("pinStatus")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("matchType")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("userId")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("taskType_small")+'</div> </div></div></div> </div> </div>                         <div class="main-content">                         <div class="card-header" id="headingTwo">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseTwo">                 <i class="btx-carrot-right"></i>                  <img class="image-class-close" ng-src={{closeArrow}}>                   <span class="How-to-use-Analytics">'+i18n.i18nString("how_to_use_message_fields")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_290}}"><i class="btx-external-link1"></i></a></span></div>                <div class="collapsed-item">                    <div id="collapseTwo" class="collapse" data-parent="#accordionExample">                        <div class="accordion-text">                   '+i18n.i18nString("provides_user_messages")+'</div>                            <div class="accord-info">                        <div class="accord-text"> '+i18n.i18nString("message_dataset")+' </div>                       <div class="accord-list">                        <div class="accord-list-items">'+i18n.i18nString("messageType")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("isDeveloper")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("messageId")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("userId")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("field_synonyms_for_selected_lang_err_label2")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("channel_small")+'</div>                        <div class="accord-list-items">'+i18n.i18nString("sessionId")+'</div> </div></div> </div></div> </div>                        <div class="main-content">                         <div class="card-header" id="headingThree">                          <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseThree">                           <i class="btx-carrot-right"></i>                            <img class="image-class-close" ng-src={{closeArrow}}>                             <span class="How-to-use-Analytics"> '+i18n.i18nString("how_to_use_session_fields")+'</span> </span>                             <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_291}}"><i class="btx-external-link1"></i></a></span> </div>                          <div class="collapsed-item">                              <div id="collapseThree" class="collapse" data-parent="#accordionExample">                                  <div class="accordion-text">                                  '+i18n.i18nString("session_desc")+'</div>                                      <div class="accord-info">                                  <div class="accord-text"> '+i18n.i18nString("sessions_dataset")+' </div>                                 <div class="accord-list">                               <div class="accord-list-items">'+i18n.i18nString("userId")+'</div>                                  <div class="accord-list-items">'+i18n.i18nString("channel_small")+'</div>                                  <div class="accord-list-items">'+i18n.i18nString("field_synonyms_for_selected_lang_err_label2")+'</div>                                  <div class="accord-list-items">'+i18n.i18nString("date_small")+'</div> </div></div> </div></div> </div>                                  <div class="main-content">                                    <div class="card-header" id="headingFour">                                    <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseFour">                                     <i class="btx-carrot-right"></i>                                      <img class="image-class-close" ng-src={{closeArrow}}>                                       <span class="How-to-use-Analytics">'+i18n.i18nString("how_use_filterby")+'</span> </span>                                        <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_292}}"><i class="btx-external-link1"></i></a></span>                                       </div>                                    <div class="collapsed-item">                                        <div id="collapseFour" class="collapse" data-parent="#accordionExample">                                            <div class="accordion-text">                                            '+i18n.i18nString("you_can_filter_datasets")+'</div>                                            </div></div>  </div>                                            <div class="main-content">                                             <div class="card-header" id="headingFive">                                              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseFive">                                               <i class="btx-carrot-right"></i>                                                <img class="image-class-close" ng-src={{closeArrow}}>                                                 <span class="How-to-use-Analytics"> '+i18n.i18nString("how_to_use_groupby")+'</span> </span>                                                 <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_293}}"><i class="btx-external-link1"></i></a></span> </div>                                              <div class="collapsed-item">                                                  <div id="collapseFive" class="collapse" data-parent="#accordionExample">                                                      <div class="accordion-text">                                                      '+i18n.i18nString("you_can_aggregate")+'</div>                                                        </div> </div> </div>                                                      <div class="main-content">                                                       <div class="card-header" id="headingSix">                                                     <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseSix">                                                         <i class="btx-carrot-right"></i>                                                          <img class="image-class-close" ng-src={{closeArrow}}>                                                           <span class="How-to-use-Analytics"> '+i18n.i18nString("how_to_use_sortby")+'</span> </span>                                                           <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_294}}"><i class="btx-external-link1"></i></a></span> </div>                                                        <div class="collapsed-item">                                                            <div id="collapseSix" class="collapse" data-parent="#accordionExample">                                                                <div class="accordion-text">                                                                '+i18n.i18nString("you_can_sort_datarecords")+'</div>                                                                   </div></div> </div>                                                                <div class="main-content">                                                                <div class="card-header" id="headingSeven">                                                                 <span class="How-to-design"> '+i18n.i18nString("how_to_design_manage")+'</span> </span>                                                                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_295}}"><i class="btx-external-link1"></i></a></span>                                                                </div></div>',storyboard:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_is_storyboard")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_307}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_scenes")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_308}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("various_message_templates")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_309}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_get_feedback_scenes")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_310}}"><i class="btx-external-link1"></i></a></div></div>',storyDetails:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("storydetails_build_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_54}}"><i class="btx-external-link1"></i></a></span></div></div>               <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("explain_universal_bot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOTS_TYPES}}"><i class="btx-external-link1"></i></a></span></div></div>               <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_universal_bot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_20}}"><i class="btx-external-link1"></i></a></span></div></div>               <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_smart_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_21}}"><i class="btx-external-link1"></i></a></div></div>               <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_bots_codevelopers")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>               <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>               <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("introduction_chatbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span start-guided-help="learnBots">'+i18n.i18nString("guided_help")+'</span></div></div>               <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_hello_world")+'</div><div class="col-xs-6 helpsassetsDiv"><span kr-show-interactive-help="BUILD_HELLO_BOT" >'+i18n.i18nString("guided_help")+'</span></div></div>               <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("see_whats_new",{dyn:$scope.uiVersion})+' </div><div class="col-xs-6 helpsassetsDiv"><span kr-show-interactive-help="TAKE_TOUR" >'+i18n.i18nString("take_a_tour")+"</span></div></div>",settings:'<div class="accordion" id="accordionExample">   <div class="main-content">                <div class="card-header" id="headingOne">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("why_train_universal_bots")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_333}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseOne" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("universal_bots_needs_desc")+'</div>                            </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingTwo">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseTwo">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("how_to_train_universal_bots")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_334}}"><i class="btx-external-link1"></i></a></span> </div>                    <div class="collapsed-item">                     <div id="collapseTwo" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("training_includes_universal")+"</div>                          <div><ul><li>"+i18n.i18nString("providing_training_utterances")+"</li>                          <li>"+i18n.i18nString("marking_linked_bots")+" </li>                          <li>"+i18n.i18nString("reviewing_linked_bot")+'</li></ul></div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingThree">                             <span class="How-to-design">'+i18n.i18nString("what_invocation_name")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_335}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFour">                             <span class="How-to-design">'+i18n.i18nString("train_utterances_linkedbots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_336}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFive">                             <span class="How-to-design">'+i18n.i18nString("what_fallback_bots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_337}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFive">                             <span class="How-to-design">'+i18n.i18nString("what_eligible_bots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_338}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingSeven">                             <span class="How-to-design">'+i18n.i18nString("how_improve_universal_bot")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_339}}"><i class="btx-external-link1"></i></a></span>                            </div></div>',training:'<div class="accordion" id="accordionExample">   <div class="main-content">                <div class="card-header" id="headingOne">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("why_train_universal_bots")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_333}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseOne" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("universal_bots_needs_desc")+'</div>                            </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingTwo">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseTwo">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("how_to_train_universal_bots")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_334}}"><i class="btx-external-link1"></i></a></span> </div>                    <div class="collapsed-item">                     <div id="collapseTwo" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("training_includes_universal")+"</div>                          <div><ul><li>"+i18n.i18nString("providing_training_utterances")+"</li>                          <li>"+i18n.i18nString("marking_linked_bots")+" </li>                          <li>"+i18n.i18nString("reviewing_linked_bot")+'</li></ul></div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingThree">                             <span class="How-to-design">'+i18n.i18nString("what_invocation_name")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_335}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFour">                             <span class="How-to-design">'+i18n.i18nString("train_utterances_linkedbots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_336}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFive">                             <span class="How-to-design">'+i18n.i18nString("what_fallback_bots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_337}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFive">                             <span class="How-to-design">'+i18n.i18nString("what_eligible_bots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_338}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingSeven">                             <span class="How-to-design">'+i18n.i18nString("how_improve_universal_bot")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_339}}"><i class="btx-external-link1"></i></a></span>                            </div></div>',linkedBotTraining:'<div class="accordion" id="accordionExample">   <div class="main-content">                <div class="card-header" id="headingOne">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("why_train_universal_bots")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_333}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseOne" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("universal_bots_needs_desc")+'</div>                            </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingTwo">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseTwo">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("how_to_train_universal_bots")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_334}}"><i class="btx-external-link1"></i></a></span> </div>                    <div class="collapsed-item">                     <div id="collapseTwo" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("training_includes_universal")+"</div>                          <div><ul><li>"+i18n.i18nString("providing_training_utterances")+"</li>                          <li>"+i18n.i18nString("marking_linked_bots")+" </li>                          <li>"+i18n.i18nString("reviewing_linked_bot")+'</li></ul></div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingThree">                             <span class="How-to-design">'+i18n.i18nString("what_invocation_name")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_335}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFour">                             <span class="How-to-design">'+i18n.i18nString("train_utterances_linkedbots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_336}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFive">                             <span class="How-to-design">'+i18n.i18nString("what_fallback_bots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_337}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFive">                             <span class="How-to-design">'+i18n.i18nString("what_eligible_bots")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_338}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingSeven">                             <span class="How-to-design">'+i18n.i18nString("how_improve_universal_bot")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_339}}"><i class="btx-external-link1"></i></a></span>                            </div></div>',uiForms:'<div class="accordion" id="accordionExample">   <div class="main-content">                <div class="card-header" id="headingOne">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("what_are_digital_forms")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_314}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseOne" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("digital_form_desc")+'</div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingTwo">                             <span class="How-to-design">'+i18n.i18nString("create_digitalform")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_315}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingThree">                             <span class="How-to-design">'+i18n.i18nString("what_digital_component")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_316}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFour">                             <span class="How-to-design">'+i18n.i18nString("how_invoke_digitalform")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_317}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFive">                             <span class="How-to-design">'+i18n.i18nString("can_present_forms")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_318}}"><i class="btx-external-link1"></i></a></span>                            </div>                <div class="main-content">                <div class="card-header" id="headingSix">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseSix">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("can_capture_userinput")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_319}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseSix" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("yes_can_use_conversation")+'</div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingSeven">                             <span class="How-to-design">'+i18n.i18nString("how_does_formComponents")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_320}}"><i class="btx-external-link1"></i></a></span>                            </div></div>',
botVersion:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("create_botversions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_321}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("restore_old_version")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_322}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("autocreated_version")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_323}}"><i class="btx-external-link1"></i></a></div></div>',manageSessions:'<div class="accordion" id="accordionExample">   <div class="main-content">                <div class="card-header" id="headingOne">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("what_conversation_sessions")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_340}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseOne" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("conversation_sessions_desc")+'</div>                            </div></div> </div>                            <div class="main-content">                <div class="card-header" id="headingTwo">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseTwo">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("what_inactivity_duration")+'</span> </span></div>                 <div class="collapsed-item">                     <div id="collapseTwo" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("time_elapsed_lastinteraction")+'</div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingThree">                             <span class="How-to-design">'+i18n.i18nString("how_manage_sonversationsessions")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_341}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFour">                             <span class="How-to-design">'+i18n.i18nString("what_happens_conversationsession_closed")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_342}}"><i class="btx-external-link1"></i></a></span>                            </div>                             </div>',dataForm:'<div class="accordion" id="accordionExample">   <div class="main-content">                <div class="card-header" id="headingOne">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("what_data_as_service")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_324}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseOne" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                        '+i18n.i18nString("datatables_desc")+'</div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingTwo">                             <span class="How-to-design">'+i18n.i18nString("how_define_datatables")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_325}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                <div class="card-header" id="headingThree">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseThree">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("how_do_manage_data")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_326}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseThree" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("datamanagement_desc")+'</div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingFour">                             <span class="How-to-design">'+i18n.i18nString("what_are_indexes")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_327}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingFive">                             <span class="How-to-design">'+i18n.i18nString("what_bot_app_assignments")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_328}}"><i class="btx-external-link1"></i></a></span>                            </div>                <div class="main-content">                <div class="card-header" id="headingSix">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseSix">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("what_table_view")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_329}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseSix" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("table_views_desc")+'</div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingSeven">                          <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseSeven">                              <i class="btx-carrot-right"></i>                               <img class="image-class-close" ng-src={{closeArrow}}>                                <span class="How-to-use-Analytics">'+i18n.i18nString("what_join_rule")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_330}}"><i class="btx-external-link1"></i></a></span> </div>                             <div class="collapsed-item">                                 <div id="collapseSeven" class="collapse" data-parent="#accordionExample">                                     <div class="accordion-text">                                     '+i18n.i18nString("these_rules_tableview")+'</div>                                        </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingSeven">                             <span class="How-to-design">'+i18n.i18nString("what_are_apps")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_331}}"><i class="btx-external-link1"></i></a></span>                            </div>                            <div class="main-content">                            <div class="card-header" id="headingEight">                             <span class="How-to-design">'+i18n.i18nString("what_are_reserves_words")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_332}}"><i class="btx-external-link1"></i></a></span>                            </div></div>',customdashboardDetails:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("customdashboard_build_platform")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_54}}"><i class="btx-external-link1"></i></a></span></div></div>                 <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("explain_universal_bot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOTS_TYPES}}"><i class="btx-external-link1"></i></a></span></div></div>                 <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_universal_bot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_20}}"><i class="btx-external-link1"></i></a></span></div></div>                 <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_smart_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_21}}"><i class="btx-external-link1"></i></a></div></div>                 <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_bots_codevelopers")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                 <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                 <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("introduction_chatbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span start-guided-help="learnBots">'+i18n.i18nString("guided_help")+'</span></div></div>                 <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_hello_world")+'</div><div class="col-xs-6 helpsassetsDiv"><span kr-show-interactive-help="BUILD_HELLO_BOT" >'+i18n.i18nString("guided_help")+'</span></div></div>                 <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("see_whats_new",{dyn:$scope.uiVersion})+' </div><div class="col-xs-6 helpsassetsDiv"><span kr-show-interactive-help="TAKE_TOUR" >'+i18n.i18nString("take_a_tour")+"</span></div></div>",botsForm:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_virtual")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.CHAT_OVER_VIEW}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("basicConcepts_Va")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.CHAT_CONCEPT}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_Va_platform")+'<a href="https://kore.ai/" target="_blank">'+i18n.i18nString("constants.iconsTooltips_kore")+"</a>"+i18n.i18nString("platform")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.GET_STARTED}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_detection_intent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_share_bots_team")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("analyze_va_performance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ANALYZE}}"><i class="btx-external-link1"></i></a></span></div></div>',processApps:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_app_introduction")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.PROCESS_INTRO}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("build_proces_app")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.CREATE_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_proces_app_codev")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.SHARE_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>',process_dashboard:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_import_export_help")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.IMPORT_EXPORT_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_proces_app_codev")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.SHARE_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_add_channels")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ADD_CHANNEL_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_app_publish_help")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.PUBLISH_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("define_process_flow")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DEFINE_FLOW_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>',process_flow:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("define_process_trigger")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.TRIGGER_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("stencils_flow_design")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STENILS_USE_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_app_events")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.USE_EVENTS_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("form_trigger_access_control")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ACEESS_CONTROL_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_task_human_task")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DEFINE_HUMANTASK_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_call_subflow")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.CALL_SUBFLOW_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_app_simulator")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.SIMULATE_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_steps_walkthrough")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.CREATE_PUBLISH_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>',process_forms:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_app_define_form")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.PROCESS_FORMS_INTRO}}"><i class="btx-external-link1"></i></a></span></div></div>',process_settings:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_import_export_help")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.IMPORT_EXPORT_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_view_change_logs")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.PROCESS_APP_CHANGE_LOG}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_bot_permissions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_PERMISSION_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("process_create_versions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.VERSION_CREATE_PROCESS_APP}}"><i class="btx-external-link1"></i></a></span></div></div>',manageComponents:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_dialogtasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DIALOG_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_dialogtask")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_50}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_subintents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_51}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_dialogcomponent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_52}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_dialog_status")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_PUBLISH_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>',dialogTasks:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_dialogtasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DIALOG_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_dialogtask")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_50}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_subintents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_51}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_dialogcomponent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_52}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_dialog_status")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_PUBLISH_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_is_subIntent_scope")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_351}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("What_is_group_node")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_352}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_can_achieve_contextual_NLU")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_353}}"><i class="btx-external-link1"></i></a></span></div></div>',dialogSettings:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_dialogtasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DIALOG_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_dialogtask")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_50}}"><i class="btx-external-link1"></i></a></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_subintents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_51}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_dialogcomponent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_52}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_dialog_status")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_PUBLISH_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>',dialogEditor:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_dialogtask")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_50}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_dialog_builder")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DIALOG_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_nodes_use_them")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_40}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_transitions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_41}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_bot_messages")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_dialogcomponent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_52}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_webhook_node")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_44}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_transfer_humanagent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.AGENT_TRANSFER_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("gets_started_dialog_covers")+' </div><div class="col-xs-6 helpsassetsDiv"><span kr-show-interactive-help="CONVERSE_DIALOG_WALK_THROUGH" >'+i18n.i18nString("guide_tour")+"</span></div></div>",manageInterruption:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_dialogtasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DIALOG_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_dialogtask")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_50}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_subintents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_51}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_dialogcomponent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_52}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_dialog_status")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_PUBLISH_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>',importDialog:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_dialogtasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DIALOG_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_dialogtask")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_50}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_subintents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_51}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_dialogcomponent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_52}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_dialog_status")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_PUBLISH_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("import_export_definition")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_54}}"><i class="btx-external-link1"></i></a></span></div></div>',
knowledgeCollection:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_knowledge_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ADDKT_LEARNMORE}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_knowledgegraph")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.KNOWLEDGE_TASK_CREATE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_import_knowledgegraph")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_63}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_classes_kg")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_64}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_synonyms_kg")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_65}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_kgextraction")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.KNOWLEDGE_EXTRACT}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_extract_faqs")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_67}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_extract_documents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_68}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_extracted_faqs")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_69}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_formats_extraction")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_70}}"><i class="btx-external-link1"></i></a></span></div></div>',botOntology:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_knowledge_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ADDKT_LEARNMORE}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_knowledgegraph")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.KNOWLEDGE_TASK_CREATE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_import_knowledgegraph")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_63}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_classes_kg")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_64}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_synonyms_kg")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_65}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>',kgExtract:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_kgextraction")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.KNOWLEDGE_EXTRACT}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_extract_faqs")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_67}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_extract_documents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_68}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_extracted_faqs")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_69}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_formats_extraction")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_70}}"><i class="btx-external-link1"></i></a></span></div></div>',kgAnnotationTool:'<div class="accordion" id="accordionExample"><div class="main-content">                <div class="card-header" id="headingOne">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_is_annotation")+'</span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.KG_ANNOTATION}}"><i class="btx-external-link1"></i></a></span> </div>                <div class="collapsed-item">                <div id="collapseOne" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">               '+i18n.i18nString("link_annotation")+'</div>                </div></div> </div>                <div class="main-content">                <div class="main-content">                <div class="card-header" id="headingTwo">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseTwo">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("when_should_annotate")+' </span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.KG_ANNOTATION}}"><i class="btx-external-link1"></i></a></span> </div>                <div class="collapsed-item">                <div id="collapseTwo" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("when_donot_faqs")+'</div>                </div></div> </div>                <div class="main-content">                <div class="main-content">                <div class="card-header" id="headingThree">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseThree">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_types_files")+' </span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.KG_ANNOTATION}}"><i class="btx-external-link1"></i></a></span> </div>                <div class="collapsed-item">                <div id="collapseThree" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("as_now_annoted")+"</div>                </div></div> </div>",alertTasks:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_alert_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ALERT_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("create_alert_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_71}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_rest_api")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_72}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_soap_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_73}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_webhook_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_74}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_rss_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_75}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_auth_service_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_76}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_response_alert")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_77}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_alert_scheduling")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_78}}"><i class="btx-external-link1"></i></a></span></div></div>',ALERTS_TASK_BASIC:alerts_help_content,ALERT_REQ_REST:alerts_help_content,ALERT_REQ_SOAP:alerts_help_content,ALERT_REQ_WEBHOOK:alerts_help_content,ALERT_REQ_RSS:alerts_help_content,ALERT_RES:alerts_help_content,ALERT_SETTING:alerts_help_content,actionTasks:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_action_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.ACTION_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("create_action_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_79}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_rest_api")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_80}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_soap_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_81}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_auth_service_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_82}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_response_action")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_83}}"><i class="btx-external-link1"></i></a></span></div></div>',ACTIONS_TASK_BASIC:actions_help_content,ACTIONS_REQ_REST:actions_help_content,ACTIONS_REQ_SOAP:actions_help_content,ACTIONS_RES:actions_help_content,informationTasks:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_information_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("create_information_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_TASK_BASIC}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_rest_api")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_REQ_REST}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_soap_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_REQ_SOAP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_auth_service_request")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_AUTH}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_response_information")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.INFORMATION_RES}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_table_format")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_84}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_cards_show")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_85}}"><i class="btx-external-link1"></i></a></span></div></div>',INFORMATION_TASK_BASIC:information_help_content,INFORMATION_REQ_REST:information_help_content,INFORMATION_REQ_SOAP:information_help_content,INFORMATION_RES:information_help_content,flows:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_flows")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.FLOWS_TASK_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_create_flows")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_86}}"><i class="btx-external-link1"></i></a></span></div></div>',machineLearningUtterances:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents_utterances")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.NOUTTERANCES_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("import_export_utterances")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_87}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_machinelearning")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_88}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_ml_model")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_196}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_139}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("gets_started_training")+' </div><div class="col-xs-6 helpsassetsDiv"><span kr-show-interactive-help="TRAINING_WALK_THROUGH" >'+i18n.i18nString("guide_tour")+"</span></div></div>",synonyms:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_synonyms")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.SYNONYMS_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_139}}"><i class="btx-external-link1"></i></a></span></div></div>',patterns:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_patterns")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.PATTERNS_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_139}}"><i class="btx-external-link1"></i></a></span></div></div>',negativePatterns:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_negative_patterns")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.NEGATIVE_PATTERNS_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_139}}"><i class="btx-external-link1"></i></a></span></div></div>',traits:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_traits")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_281}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_282}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_283}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_284}}"><i class="btx-external-link1"></i></a></span></div></div>',mlThresholds:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_threshold")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_196}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'?</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_139}}"><i class="btx-external-link1"></i></a></span></div></div>',nlAdvancedSettings:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_threshold")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_196}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'?</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_139}}"><i class="btx-external-link1"></i></a></span></div></div>',botSummary:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("analyze_bot_performance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_ANALYZE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_bot_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_TASKS_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_bots_codevelopers")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_add_channels")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_CHANNEL_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_publish_bot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_PUBLISH_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("nav_changes")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.UI_NAVIGATON}}"><i class="btx-external-link1"></i></a></span></div></div>',linkedBots:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("universal_differ_standard")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_119}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("link_universal_bot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_120}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("train_test_universal")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_121}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("publish_universal")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_176}}"><i class="btx-external-link1"></i></a></span></div></div>',defaultDialog:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_standard_responses")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STANDARD_RESPONSE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_prompt_editor")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_fallback")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DEFAULT_DAILOG_UNIVERSAL_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_event_customdata")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_130}}"><i class="btx-external-link1"></i></a></span></div></div>',
defaultDialogUniversal:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_standard_responses")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STANDARD_RESPONSE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_prompt_editor")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_fallback")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DEFAULT_DAILOG_UNIVERSAL_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_event_customdata")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_130}}"><i class="btx-external-link1"></i></a></span></div></div>',standardResponses:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_standard_responses")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STANDARD_RESPONSE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_prompt_editor")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_fallback")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DEFAULT_DAILOG_UNIVERSAL_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_event_customdata")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_130}}"><i class="btx-external-link1"></i></a></span></div></div>',eventsManage:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_standard_responses")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STANDARD_RESPONSE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_prompt_editor")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_fallback")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.DEFAULT_DAILOG_UNIVERSAL_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_event_customdata")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_130}}"><i class="btx-external-link1"></i></a></span></div></div>',amendEntity:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_standard_responses")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STANDARD_RESPONSE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_prompt_editor")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>',ignoreWords:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_standard_responses")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STANDARD_RESPONSE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_prompt_editor")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>',advancedSettings:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_standard_responses")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STANDARD_RESPONSE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_prompt_editor")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>',multiIntentDetection:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_interruptions")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_137}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_customize_standard_responses")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.STANDARD_RESPONSE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_prompt_editor")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_138}}"><i class="btx-external-link1"></i></a></span></div></div>',sentimentManagement:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_analyz_usertone")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_285}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_sentiment")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_286}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_event_customdata")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_287}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_context_object")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_288}}"><i class="btx-external-link1"></i></a></span></div></div>',testTrain:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_bots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_139}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'?</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_threshold")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_196}}"><i class="btx-external-link1"></i></a></span></div></div>',batchTesting:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_batchtesting")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BATCH_TESTING_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'?</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_threshold")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_196}}"><i class="btx-external-link1"></i></a></span></div></div>',conversationTesting:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_use_conversation_testing")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.CONVERSATION_TESTING_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'?</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_threshold")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_196}}"><i class="btx-external-link1"></i></a></span></div></div>',channels:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_add_channels")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_CHANNEL_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_define_channel_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_150}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_templates_websdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_173}}"><i class="btx-external-link1"></i></a></span></div></div>',botkitSDK:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_botkit")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_170}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_webmobilesdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_171}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_register_apps")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_172}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_templates_websdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_173}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_access_definition")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_174}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_175}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.AGENT_TRANSFER_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',manageApps:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_botkit")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_170}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_webmobilesdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_171}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_register_apps")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_172}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_templates_websdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_173}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_access_definition")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_174}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_175}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.AGENT_TRANSFER_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',apps:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_botkit")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_170}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_webmobilesdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_171}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_register_apps")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_172}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_templates_websdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_173}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_access_definition")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_174}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_175}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.AGENT_TRANSFER_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',agentTransfer:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_botkit")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_170}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_webmobilesdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_171}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_register_apps")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_172}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_templates_websdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_173}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_access_definition")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_174}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_175}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.AGENT_TRANSFER_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',webMobileSDK:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_botkit")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_170}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_webmobilesdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_171}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_to_register_apps")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_172}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_templates_websdk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_173}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_access_definition")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_174}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_175}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_agenttransfer")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.AGENT_TRANSFER_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',publish:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_publish_bot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_PUBLISH_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_selectively_botcomponent")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.FULL_VERSION_CTRL}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_publish_universal")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_176}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_upgrade_tasks")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_177}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_recall_suspend")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_178}}"><i class="btx-external-link1"></i></a></span></div></div>',metrics:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_view_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_188}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_view_exception")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_189}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_view_botexecution")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_190}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_gain_conversation")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_191}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'?</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_threshold")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_196}}"><i class="btx-external-link1"></i></a></span></div></div>',sessionFlow:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_view_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_188}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_view_exception")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_189}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_view_botexecution")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_190}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_gain_conversation")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_191}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_intents")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_192}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_entities")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_193}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_train_kg")+'?</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_194}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("improve_intent_detection")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_195}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("configure_threshold")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_196}}"><i class="btx-external-link1"></i></a></span></div></div>',generalSettings:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_build_multilang")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_271}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_set_preferences")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_272}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_components_lang_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_273}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authorization")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_AUTHENTICATION_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authentication")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_274}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_redact_pii")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_275}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_reusebale")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_276}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_variables")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_smartbots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_smartbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_inheritance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_280}}"><i class="btx-external-link1"></i></a></span></div></div>',
languageManagement:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_build_multilang")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_271}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_set_preferences")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_272}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_components_lang_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_273}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authorization")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_AUTHENTICATION_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authentication")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_274}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_redact_pii")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_275}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_reusebale")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_276}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_variables")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_smartbots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_smartbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_inheritance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_280}}"><i class="btx-external-link1"></i></a></span></div></div>',authorization:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_build_multilang")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_271}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_set_preferences")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_272}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_components_lang_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_273}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authorization")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_AUTHENTICATION_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authentication")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_274}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_redact_pii")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_275}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_reusebale")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_276}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_variables")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_smartbots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_smartbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_inheritance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_280}}"><i class="btx-external-link1"></i></a></span></div></div>',IIPMasking:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_build_multilang")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_271}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_set_preferences")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_272}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_components_lang_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_273}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authorization")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_AUTHENTICATION_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authentication")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_274}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_redact_pii")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_275}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_reusebale")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_276}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_variables")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_smartbots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_smartbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_inheritance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_280}}"><i class="btx-external-link1"></i></a></span></div></div>',botFunctions:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_build_multilang")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_271}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_set_preferences")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_272}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_components_lang_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_273}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authorization")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_AUTHENTICATION_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authentication")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_274}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_redact_pii")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_275}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_reusebale")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_276}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_variables")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_smartbots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_smartbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_inheritance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_280}}"><i class="btx-external-link1"></i></a></span></div></div>',variableManagement:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_build_multilang")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_271}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_set_preferences")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_272}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_components_lang_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_273}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authorization")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_AUTHENTICATION_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authentication")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_274}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_redact_pii")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_275}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_reusebale")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_276}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_variables")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_smartbots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_smartbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_inheritance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_280}}"><i class="btx-external-link1"></i></a></span></div></div>',variableManagementContent:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_build_multilang")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_271}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_set_preferences")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_272}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_components_lang_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_273}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authorization")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_AUTHENTICATION_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authentication")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_274}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_redact_pii")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_275}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_reusebale")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_276}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_variables")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_smartbots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_smartbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_inheritance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_280}}"><i class="btx-external-link1"></i></a></span></div></div>',developerShare:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_bots_codevelopers")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_export_import")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_viewlog_botdefintion")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_CHANGELOG_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',botImportExport:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_bots_codevelopers")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_export_import")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_viewlog_botdefintion")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_CHANGELOG_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',importBot:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_bots_codevelopers")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_export_import")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_viewlog_botdefintion")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_CHANGELOG_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',changeLogs:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("share_bots_codevelopers")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_SHARE_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_export_import")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_viewlog_botdefintion")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_CHANGELOG_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>',planUsage:'<div class="accordion" id="accordionExample">                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("plan_usage_help1_qs")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_355}}"><i class="btx-external-link1"></i></a></span></div></div>                            <div class="main-content">                <div class="card-header" id="headingThree">              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseThree">                  <i class="btx-carrot-right"></i>                   <img class="image-class-close" ng-src={{closeArrow}}>                    <span class="How-to-use-Analytics">'+i18n.i18nString("plan_usage_help2_qs")+'</span> </span>                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_356}}"><i class="btx-external-link1"></i></a></span> </div>                 <div class="collapsed-item">                     <div id="collapseThree" class="collapse" data-parent="#accordionExample">                         <div class="accordion-text">                         '+i18n.i18nString("plan_usage_help1_ans")+'</div>                            </div></div> </div>                            <div class="main-content">                            <div class="card-header" id="headingFour">                          <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseFour">                              <i class="btx-carrot-right"></i>                               <img class="image-class-close" ng-src={{closeArrow}}>                                <span class="How-to-use-Analytics">'+i18n.i18nString("plan_usage_help3_qs")+'</span> </span>                                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_357}}"><i class="btx-external-link1"></i></a></span> </div>                             <div class="collapsed-item">                                 <div id="collapseFour" class="collapse" data-parent="#accordionExample">                                     <div class="accordion-text">                                     '+i18n.i18nString("plan_usage_help2_ans")+'</div>                                        </div></div> </div>                                        <div class="main-content">                                        <div class="card-header" id="headingFive">                                      <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseFive">                                          <i class="btx-carrot-right"></i>                                           <img class="image-class-close" ng-src={{closeArrow}}>                                            <span class="How-to-use-Analytics">'+i18n.i18nString("plan_usage_help4_qs")+'</span> </span>                                            <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_358}}"><i class="btx-external-link1"></i></a></span> </div>                                         <div class="collapsed-item">                                             <div id="collapseFive" class="collapse" data-parent="#accordionExample">                                                 <div class="accordion-text">                                                 '+i18n.i18nString("plan_usage_help3_ans")+'</div>                                                    </div></div> </div>                                                    <div class="main-content">                                                    <div class="card-header" id="headingSix">                                                  <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseSix">                                                      <i class="btx-carrot-right"></i>                                                       <img class="image-class-close" ng-src={{closeArrow}}>                                                        <span class="How-to-use-Analytics">'+i18n.i18nString("plan_usage_help5_qs")+'</span> </span>                                                        <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_359}}"><i class="btx-external-link1"></i></a></span> </div>                                                     <div class="collapsed-item">                                                         <div id="collapseSix" class="collapse" data-parent="#accordionExample">                                                             <div class="accordion-text">                                                             '+i18n.i18nString("plan_usage_help4_ans")+'</div>                                                                </div></div> </div>                                                                <div class="main-content">                                                                <div class="card-header" id="headingSeven">                                                              <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseSeven">                                                                  <i class="btx-carrot-right"></i>                                                                   <img class="image-class-close" ng-src={{closeArrow}}>                                                                    <span class="How-to-use-Analytics">'+i18n.i18nString("plan_usage_help6_qs")+'</span> </span>                                                                    <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_360}}"><i class="btx-external-link1"></i></a></span> </div>                                                                 <div class="collapsed-item">                                                                     <div id="collapseSeven" class="collapse" data-parent="#accordionExample">                                                                         <div class="accordion-text">                                                                         '+i18n.i18nString("plan_usage_help5_ans")+"</div>                                                                            </div></div> </div></div>",inVoices:'<div class="accordion" id="accordionExample">                <div class="main-content">                                                    <div class="card-header" id="headingSix">                                                  <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseSix">                                                      <i class="btx-carrot-right"></i>                                                       <img class="image-class-close" ng-src={{closeArrow}}>                                                        <span class="How-to-use-Analytics">'+i18n.i18nString("invoice1_qs")+'</span> </span>                                                        <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_361}}"><i class="btx-external-link1"></i></a></span> </div>                                                     <div class="collapsed-item">                                                         <div id="collapseSix" class="collapse" data-parent="#accordionExample">                                                             <div class="accordion-text">                                                             '+i18n.i18nString("invoice1_ans")+"</div>                                                                </div></div> </div></div>",smartBotSettings:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_build_multilang")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_271}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_components_lang_specific")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_273}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authorization")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.BOT_AUTHENTICATION_HELP}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_authentication")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_274}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_redact_pii")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_275}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_reusebale")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_276}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_variables")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_277}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_smartbots")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_smartbot")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_279}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_manage_inheritance")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_280}}"><i class="btx-external-link1"></i></a></span></div></div>',
smallTalk:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_smalltalk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_296}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_are_greeting")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_297}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_create_smalltalk")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_298}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_groups")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_299}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_use_patterns_defining")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_300}}"><i class="btx-external-link1"></i></a></span></div></div>',widgets:'<div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("what_digital_views")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_301}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_configure_widget")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_302}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_setup_panels")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_303}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_include_widgets")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_304}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_test_panels")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_305}}"><i class="btx-external-link1"></i></a></span></div></div>                <div class="row helpContentContainer"><div class="col-xs-6 helpQuestionDiv">'+i18n.i18nString("how_host_digitalviews")+'</div><div class="col-xs-6 helpsassetsDiv"><span><a target="_blank" href="{{helpLinks.RAND_306}}"><i class="btx-external-link1"></i></a></span></div></div>',botDashboard:'<div class="accordion" id="accordionExample"><div class="main-content">                <div class="card-header" id="headingOne">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_realtimestatus")+'</span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_343}}"><i class="btx-external-link1"></i></a></span> </div>                <div class="collapsed-item">                <div id="collapseOne" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("realtime_status_desc")+'</div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingTwo">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseTwo">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_usage_metrics")+' </span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_344}}"><i class="btx-external-link1"></i></a></span> </div>                <div class="collapsed-item">                <div id="collapseTwo" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("usage_metrics_desc")+'</div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingThree">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseThree">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_differ_msg_conversation")+'</span> </span></div>                <div class="collapsed-item">                <div id="collapseThree" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("messages_volley")+'</div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingFour">                <span class="How-to-design">'+i18n.i18nString("what_various_graphs")+'</span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_345}}"><i class="btx-external-link1"></i></a></span>                </div>                <div class="main-content">                <div class="card-header" id="headingFive">                <span class="How-to-design">'+i18n.i18nString("how_filter_msg_conversation")+'</span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_346}}"><i class="btx-external-link1"></i></a></span>                </div>',containmentDashboard:'<div class="accordion" id="accordionExample"><div class="main-content">                <div class="card-header" id="headingOne">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseOne">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_realtimestatus")+'</span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_347}}"><i class="btx-external-link1"></i></a></span> </div>                <div class="collapsed-item">                <div id="collapseOne" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("realtime_status_desc")+'</div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingTwo">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseTwo">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_contianment_metrics")+'</span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_348}}"><i class="btx-external-link1"></i></a></span> </div>                <div class="collapsed-item">                <div id="collapseTwo" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("containment_metrics_desc")+'</div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingThree">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseThree">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_are_selfservice")+'</span> </span> </div>                <div class="collapsed-item">                <div id="collapseThree" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                 '+i18n.i18nString("self_service_desc")+'</div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingFour">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseFour">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_included_dropoffs")+'</span> </span> </div>                <div class="collapsed-item">                <div id="collapseFour" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("included_all_sessions")+' </div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingFive">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseFive">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("what_agenttransfer")+'</span> </span></div>                <div class="collapsed-item">                <div id="collapseFive" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("agent_transfer_desc")+'</div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingSix">                <span class="accord-item collapsed" data-toggle="collapse" data-target="#collapseSix">                <i class="btx-carrot-right"></i>                <img class="image-class-close" ng-src={{closeArrow}}>                <span class="How-to-use-Analytics">'+i18n.i18nString("how_do_see_conversationflows")+' </span> </span> </div>                <div class="collapsed-item">                <div id="collapseSix" class="collapse" data-parent="#accordionExample">                <div class="accordion-text">                '+i18n.i18nString("for_eachflow_relevant_details")+'</div>                </div></div> </div>                <div class="main-content">                <div class="card-header" id="headingSeven">                <span class="How-to-design">'+i18n.i18nString("what_various_metrics")+'</span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_349}}"><i class="btx-external-link1"></i></a></span>                </div>                <div class="main-content">                <div class="card-header" id="headingEight">                <span class="How-to-design">'+i18n.i18nString("how_filter_msg_conversation")+'</span> </span>                <span class="article-info"><a target="_blank" href="{{helpLinks.RAND_350}}"><i class="btx-external-link1"></i></a></span>                </div>'};$(document).on("click",".btx-external-link1",function(event){if($(event.currentTarget)&&$(event.currentTarget).closest(".helpContentContainer").length&&$(event.currentTarget).closest(".helpContentContainer").find(".helpQuestionDiv").length&&$(event.currentTarget).closest(".helpContentContainer").find(".helpQuestionDiv").text()){var componentType=$(event.currentTarget).closest(".helpContentContainer").find(".helpQuestionDiv").text(),faqMixpanelEvent={streamId:$workflowService.selectedStream()._id,Level:"Support",Category:"Support","Sub Category":"FAQs","FAQ Question":componentType};mixPanel.postEvent("View FAQs",faqMixpanelEvent)}});var _helpContentFnMap={};$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.appVersion=env_conf["app-version"],$scope.uiVersion=$scope.appVersion.split(/\.(?=[^\.]+$)/)[0],$scope.dynamicContent="";var _stream=$workflowService.selectedStream(),_curState=navigator.setORGetPreviousState();navigator.navigationTree&&navigator.navigationTree.menuItem&&navigator.currentNavigationObj&&navigator.currentNavigationObj.selectedMenuItem&&navigator.navigationTree.menuItem[navigator.currentNavigationObj.selectedMenuItem]&&navigator.navigationTree.menuItem[navigator.currentNavigationObj.selectedMenuItem].name&&($scope.faqHeader=navigator.navigationTree.menuItem[navigator.currentNavigationObj.selectedMenuItem].name);var baseComponent=_curState.path[0];if($scope.openArrow=env_conf["context-url"]+"/assets/images/left-arrow.png",$scope.closeArrow=env_conf["context-url"]+"/assets/images/down-arrow.png","botDetailsForm"===baseComponent&&_stream&&"universalbot"===_stream.type&&($scope.hideProductTour=!0),("botsForm"===baseComponent||"noBotsForm"===baseComponent)&&($scope.showVersion=!0),$scope.helpId)try{if(_helpContentFnMap[$scope.helpId]||($scope.processAppLinks.includes($scope.helpId)&&($scope.processHelpPage=!0),_helpContentFnMap[$scope.helpId]=$compile(_helpContentMap[$scope.helpId]),$element.find(".dynamicContent").html(_helpContentFnMap[$scope.helpId]($scope))),!_helpContentMap[$scope.helpId])throw"helpId not defined in _helpContentMap"}catch(e){console.error("KORE LOG: "+$scope.helpId+"should be defined in _helpContentMap in help-content.js")}else{var _currComponent=_curState.path[_curState.path.length-1];_curState.menu&&(_currComponent=_curState.menu),console.log(_currComponent),_helpContentMap[_currComponent]&&(_helpContentFnMap[_currComponent]||(_helpContentFnMap[_currComponent]=$compile(_helpContentMap[_currComponent])),$element.find(".dynamicContent").html(_helpContentFnMap[_currComponent]($scope)),$(".accord-item").click(function(){$timeout(function(){$rootScope.$emit("pefectScrollUpdate")},500)}))}$scope.searchkeyPressed=function(e){13===e.which&&$scope.searchQuery&&$window.open($rootScope.developerURL+"?s="+$scope.searchQuery,"_blank")},$scope.invokeSupportSite=function(e){$window.open($rootScope.supportURL,"_blank")},$element.on("click","[kr-show-interactive-help]",function(e){var _hid=$(e.target).attr("kr-show-interactive-help");if(_hid){if("BOT_WALK_THROUGH"===_hid){var _curState=navigator.setORGetPreviousState(),baseComponent=_curState.path[0];"botDetailsForm"!==baseComponent&&warnuserToOpenBot(),$(".btFullpageModal.modal:visible").length&&$(".closeBtn:visible").click(),$("[ng-click=\"callbacks.navigateTo('skills')\"]:visible").length&&$("[ng-click=\"callbacks.navigateTo('skills')\"]:visible").trigger("click")}interactiveHelp.openHelp(_hid),$scope.closeHelp()}}),$scope.closeHelp=function(){$("#helpModal .modalHeader .closeCross").click()},$element.on("click","[kr-show-help-video]",function(e){var _vid=$(e.target).attr("kr-show-help-video");$scope.$emit("showTrainingVideo",_vid||"")}),$scope.openShortCut=function(){$scope.cb.showShortcut()},$scope.linkEvent=function(type){var event="",eventInfo={Level:"Support",Category:"Support","Sub Category":"Academy"};"document"===type?(event="Enter Documentation",eventInfo["Sub Category"]="Documentation"):"community"===type?(event="Enter Community",eventInfo["Sub Category"]="Community"):"faq"===type&&(event="Open FAQs",eventInfo["Sub Category"]="FAQs"),event&&mixPanel.postEvent(event,eventInfo)},$scope.hideProcessAppProductTour=function(){var processAppPath=$("#processFlowsFrame")[0].contentWindow.location.pathname;return"/builderx/process/flow"!==processAppPath}}])}(angular),function(ng){var _module=angular.module("bt-login");_module.directive("iframeOnload",function($timeout){return{restrict:"EA",scope:{callBack:"&iframeOnload"},link:function(scope,element,attrs){element.on("load",function(){return scope.callBack(element)})}}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("initiateScroll",function($timeout){return{restrict:"EA",link:function(scope,el,attrs){$(el).on("scroll",function(){$(el).parent().hasClass("autoScroll")&&$(el).parent().removeClass("autoScroll")}),$(el).parent().siblings().on("click",function(){scope.totalLinkedBots.length>5&&$(el).parent().addClass("autoScroll"),$(el).animate({scrollTop:0})})}}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("inputNote",function($compile,$timeout){return{scope:{noteDescription:"=",waitTime:"@?",closeNote:"@?",focusit:"=?"},compile:function(elem,attrs,transclude){var template='<div class="inputNote" ng-show="showNote"><div class="col-xs-1 bulbicon"><span><i class="btx-bulb" ng-src="'+window.appConfig.CONTEXT_PATH+'/assets/images/24x29-bulbicon.png"></i></span></div><div class="col-xs-11"><span class="name" ng-bind-html="$root.getSanitizedText(noteDescription)"></span></div></div>';return elem.after(template),function(scope,elem,attrs){$(elem[0]).find(".inputNote");$compile($(elem[0]).next())(scope),$(elem[0]).on("focus",function(){scope.$apply(function(){scope.showNote=!0})}),$(elem[0]).on("blur",function(){return"false"===scope.closeNote?void(scope.showNote=!0):void scope.$apply(function(){scope.waitTime?$timeout(function(){scope.showNote=!1},scope.waitTime):scope.showNote=!1})}),scope.focusit&&$timeout(function(){$(elem[0]).focus()},500)}}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("ivrSettings",function(){return{restrict:"EA",scope:{ivrOptions:"=?",bridge:"=",callback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/ivr-settings/ivr-settings.html",controller:"ivrSettingsController"}}),_module.controller("ivrSettingsController",["$scope","$workflowService","env_conf","$element","$timeout","$rootScope","form_util","i18n",function($scope,$workflowService,env_conf,$element,$timeout,$rootScope,form_util,i18n){function unique(array){for(var a=array.concat(),i=0;i<a.length;++i)for(var j=i+1;j<a.length;++j)a[i]===a[j]&&a.splice(j--,1);return a}function sortableCallback(e,ui){$scope.paginationOptions.currentPage>1&&(ui.item.sortable.index=($scope.paginationOptions.currentPage-1)*$scope.paginationOptions.itemsPerPage+ui.item.sortable.index,ui.item.sortable.dropindex=($scope.paginationOptions.currentPage-1)*$scope.paginationOptions.itemsPerPage+ui.item.sortable.dropindex)}var _selectedStream=$workflowService.selectedStream();$scope.stream=_selectedStream,$scope.assetsBase=env_conf["assets-url"],$scope.showUtteraceDefaultTip=!1,$scope.addAnotherPlain=i18n.i18nString("add_plain_text"),$scope.providePlainText=i18n.i18nString("initial_prompt_place"),$scope.cb&&($scope.displayMode=$scope.cb.modeOfAccess||{}),$scope.callback&&($scope.callback.updateVxmlGlobalKeys=function(vxvalues){$scope.vxmlGlobalKeys=vxvalues}),_selectedStream&&_selectedStream.channels&&($scope.isTwilioEnabled=1==_selectedStream.channels.filter(function(val){return"twiliovoice"==val.type}).length,$scope.isAudioCodesEnabled=1==_selectedStream.channels.filter(function(val){return"audiocodes"==val.type}).length);var _defaultIVRProps={initialPrompts:[],nomatchPrompts:[],timeoutPrompts:[],grammars:[{inputMode:"speech",type:"custom",value:""}],advance:{timeout:1e4,retry_limit:3,bargein:!1,enable_log:!1,recording:"stop",properties:[]}};_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable_transcript&&(_defaultIVRProps.grammars[0].type="disable"),$scope.ivrOptions=$scope.ivrOptions||angular.copy(_defaultIVRProps),$scope.constants=$rootScope._constants_,$scope.ivrOptions&&$scope.ivrOptions.advance&&void 0===$scope.ivrOptions.advance.properties&&($scope.ivrOptions.advance.properties=[]),$scope.ivrAudio=$scope.assetsBase+"ivrIcons/ivr-audio.svg",$scope.ivrMove=$scope.assetsBase+"ivrIcons/ivr-move.svg",$scope.ivrJS=$scope.assetsBase+"ivrIcons/ivr-js.svg",$scope.ivrTextGreen=$scope.assetsBase+"ivrIcons/ivr-text.svg",$scope.ivrTextBlack=$scope.assetsBase+"ivrIcons/ivr-text-black.svg",$scope.ivrText=$scope.ivrTextGreen,$scope.ivrIcon=$scope.assetsBase+"ivrIcons/ivrIcon.svg",$scope.ivrIconGray=$scope.assetsBase+"ivrIcons/ivrIconGray.svg",$scope.rightArrow=$scope.assetsBase+"ivrIcons/rightArrow.svg",$scope.closeIcon=$scope.assetsBase+"ivrIcons/closeIcon.svg",$scope.ivrTimeouts=[];for(var i=1;60>=i;i++)$scope.ivrTimeouts[1e3*i]=i+(i>1?" secs":" sec");$scope.ivrRetries=[];for(var j=1;10>=j;j++)$scope.ivrRetries[j]=j;$scope.bridge.getIVROptions=function(){return $scope.ivrOptions},$scope.toInt=function(val){return parseInt(val,10)},$scope.vxmlGlobalKeys=[];var tempVxmlGlobalKeys=[];$scope.callback.updateVxmlGlobalKeysShare=function(vxmlNameList){tempVxmlGlobalKeys=vxmlNameList,$scope.vxmlGlobalKeys=tempVxmlGlobalKeys.filter(function(v,i){return tempVxmlGlobalKeys.lastIndexOf(v)===i})},$scope.callback.updateVxmlCancel=function(vxmlName){$scope.vxmlGlobalKeys=angular.copy(vxmlName)},_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.properties&&($scope.vxmlGlobalCopyKeys=_.pluck(_selectedStream.ivrSettings.properties||[],"name"),_selectedStream&&_selectedStream.audioCodesSettings&&($scope.vxmlGlobalCopyKeys=$scope.vxmlGlobalCopyKeys.concat(_.pluck(_selectedStream.audioCodesSettings.properties||[],"name")))),$scope.ivrOptions&&$scope.ivrOptions.advance&&$scope.ivrOptions.advance.properties&&($scope.vxmlNodeKeys=_.pluck($scope.ivrOptions.advance.properties||[],"name")),$scope.vxmlGlobalCopyKeys||($scope.vxmlGlobalCopyKeys=[]),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys)),$scope.vxmlselect2Opts={};var _emptyVxmlProp={name:"",value:""};$scope.vxmlProp=angular.copy(_emptyVxmlProp),$scope.addVxmlProp=function(e,item,array,saveIndicatorSelector){return $scope.readonly?!1:void(item&&item.value&&(array.push(angular.copy(item)),$scope.vxmlProp=angular.copy(_emptyPrompt)))};var _defaultGrammar={inputMode:"speech",type:"custom",value:""};_selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable_transcript&&(_defaultGrammar.type="disable"),$scope.addGrammar=function(){$scope.ivrOptions.grammars.push(angular.copy(_defaultGrammar)),$scope.saveIVROptions(".grammar .savingIndicator")},$scope.resetGrammarValue=function(grammar){grammar.value=""},$scope.deleteGrammar=function(index){$scope.ivrOptions.grammars.splice(index,1),$scope.saveIVROptions(".grammar .savingIndicator")};var _emptyPrompt={type:"text",value:""},_emptyIVRProp={value:""};$scope.timeoutPrompt=angular.copy(_emptyPrompt),$scope.intialPrompt=angular.copy(_emptyPrompt),$scope.nomatchPrompt=angular.copy(_emptyPrompt),$scope.customGrammarCB={},$scope.customGrammarCB.onBlur=function(editor,ele){$scope.saveIVROptions(".grammar .savingIndicator")},$scope.jsPromptCB={},$scope.jsPromptCB.onMinimize=function(editor,ele){$(ele).closest(".textbox-jseditor").find(".save").click()},$scope.editIVRScript=function(ele){$(ele.target.closest(".textbox-jseditor")).find("[acify] .resizeToggle").click()},$scope.selectJSprompt=function(ele){$timeout(function(){$(ele.target.closest(".ivr-propmpt")).find("[acify] .resizeToggle").click()},300)},$scope.addAltPrompt=function(prompt){"file"===prompt.type&&(prompt.alt=[{type:"text",value:""}])},$scope.showConfirmDialog=function(grammar,oldVal){$scope.resetGrammarValue(grammar),$("#confirmGrammarChannel").modal();var newVal=grammar.channel;grammar.channel=oldVal,setTimeout(function(){$("#confirmGrammarChannel .proceed-btn").click(function(){grammar.channel=newVal,$("#confirmGrammarChannel").modal("hide")}),$("#confirmGrammarChannel .cancel-btn").click(function(){grammar.channel=oldVal,$("#confirmGrammarChannel").modal("hide")})})},$scope.addprompt=function(e,item,array,saveIndicatorSelector,ignoreKey){if($scope.readonly)return!1;var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;(13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened||ignoreKey)&&(e.preventDefault(),item&&item.value&&(array.push([angular.copy(item)]),$scope.saveIVROptions(saveIndicatorSelector),$scope.timeoutPrompt=angular.copy(_emptyPrompt),$scope.intialPrompt=angular.copy(_emptyPrompt),$scope.nomatchPrompt=angular.copy(_emptyPrompt),$scope.vxmlProp=angular.copy(_emptyIVRProp)))},$scope.editVXMLPrompt=function(e,label,item,array,saveIndicatorSelector,ignoreKey){var _autoCompleteContextOpened=$(".ui-autocomplete.contextTypeaheadDropdown :visible").length>0?!0:!1;(ignoreKey||13===e.keyCode&&!e.shiftKey&&!_autoCompleteContextOpened)&&(ignoreKey||e.preventDefault(),(ignoreKey||item&&item.value)&&$scope.callback.call("saved"))},$scope.deletePrompt=function(e,baseIndex,index,array,saveIndicatorSelector){return $scope.readonly?!1:(array[baseIndex].splice(index,1),0===array[baseIndex].length&&array.splice(baseIndex,1),void $scope.saveIVROptions(saveIndicatorSelector))},$scope.deletealtPrompt=function(index,baseIndex,prompt){var altTab=prompt[baseIndex].alt;altTab.splice(index,1)},$scope.checkForSaveRDelete=function(item,baseIndex,index,array,saveIndicatorSelector,noEmptyDelete){return $scope.readonly?!1:(noEmptyDelete||!item||item.value||(array[baseIndex].splice(index,1),0===array[baseIndex].length&&array.splice(baseIndex,1)),void $scope.saveIVROptions(saveIndicatorSelector))},setTimeout(function(){$(".accordion-toggle").click(function(event){$(".modalBody").animate({scrollTop:event.currentTarget.offsetTop-350},1e3)})},2e3);var ivrPromptSortableCallback=function(e,ui){$timeout(function(){$scope.saveIVROptions("")},300)},conSortableCallback=function(e,ui){$timeout(function(){$(e.target).find("[checked='checked']").each(function(){$(this).click()}),$scope.hasUnsavedConnection=!0},300)};$scope.sortableOptions={handle:".sortBar","ui-floating":!0,update:sortableCallback},$scope.ivrPromptsSortableOptions={handle:".sortBar","ui-floating":!0,update:ivrPromptSortableCallback},$scope.ivrPromptsSortableInnerOptions={handle:".sortBar","ui-floating":!0,update:ivrPromptSortableCallback},$scope.conSortableOptions={connectWith:".sortableConnectionContainer",cancel:".unsortable",update:conSortableCallback,axis:"y"},$scope.addSubPrompt=function(e,array,saveIndicatorSelector){array.push(angular.copy(_emptyPrompt)),$scope.saveIVROptions(saveIndicatorSelector)},$scope.saveIVROptions=function(saveIndicatorSelector){return $scope.readonly?!1:void 0},$scope.addXMLProperty=function(params,properties,form){properties.push(params),$scope.ivrOptions&&$scope.ivrOptions.advance&&$scope.ivrOptions.advance.properties&&($scope.vxmlNodeKeys=_.pluck($scope.ivrOptions.advance.properties||[],"name"),$scope.vxmlGlobalKeys=unique($scope.vxmlGlobalCopyKeys.concat($scope.vxmlNodeKeys))),$scope.closeNodeVxmlProp()},$scope.closeNodeVxmlProp=function(form){form&&form_util.makeItClean(form),$("#node_vxml_add").modal("hide"),$scope.vprop={name:"",value:""}},$scope.addNodeVxmlProp=function(form){"groupNodeIntent"===$scope.callback.type?($scope.nodevxmlform&&($scope.nodevxmlform.$invalid=!1,$scope.nodevxmlform.$dirty=!1,form_util.makeItClean($scope.nodevxmlform)),$scope.vprop={name:"",value:""},$("#node_vxml_add").modal("show"),$scope.vprop={name:"",value:""}):($("#vxml-add").modal("show"),$scope.vprop={name:"",value:""})},$scope.selectVXMLProp=function(prop){var _selectedGlobalProp,_selectedNodeProp;if(prop&&prop.name){var _globalProps=$scope.stream.ivrSettings.properties.concat($scope.stream.audioCodesSettings.properties),_nodeProps=$scope.ivrOptions.advance.properties;_nodeProps&&_nodeProps.length&&(_selectedNodeProp=_.find(_nodeProps,{name:prop.name}),void 0!==_selectedNodeProp&&(prop.value=_selectedNodeProp.value)),_globalProps&&_globalProps.length&&(_selectedGlobalProp=_.find(_globalProps,{name:prop.name}),void 0===_selectedGlobalProp?prop.value=_selectedNodeProp.value:prop.value=_selectedGlobalProp.value)}},$scope.deleteVxmlPrompt=function(e,index,array,saveIndicatorSelector,label){array.splice(index,1),$scope.callback.call("deleted")},$scope.callback=_.extend($scope.callback,{openAudioCodesVoiceProp:$scope.callback.openAudioCodesVoiceProp})}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("keywordHighlight",["$timeout",function($timeout){return{restrict:"EA",require:["^ngModel","^?form"],scope:{tokens:"=",name:"@",isRequired:"@",isDisabled:"@",textPattern:"@",textMinlength:"@",textMaxlength:"@",onBlur:"&",api:"=",placeholder:"@"},controller:["$scope",function($scope){}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/keyword-highlight/keyword-highlight.html",link:function($scope,$element,$attrs,ctrls){function validate(value){return value=(value||"").trim(),0!==$scope.textMaxlength&&$scope.textMaxlength&&(value=value.slice(0,$scope.textMaxlength)),setValidity($scope.pattern.test(value)),value}function moveTheCursorToEnd(element,moveIt){var range,selection;moveIt&&(document.createRange?(range=document.createRange(),range.selectNodeContents(element),range.collapse(!1),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range)):document.selection&&(range=document.body.createTextRange(),range.moveToElementText(element),range.collapse(!1),range.select()))}function highlightTokens(value,tokens){value&&(tokens=Object.keys(tokens),tokens.map(function(token){value=value.replace(new RegExp("\\s+("+token+")\\s+","i")," <span>$1</span> "),value=value.replace(new RegExp("^("+token+")\\s+","i"),"<span>$1</span> "),value=value.replace(new RegExp("\\s+("+token+")$","i")," <span>$1</span>"),value=value.toLowerCase()==token.toLowerCase()?value.replace(new RegExp("("+token+")","i"),"<span>$1</span> "):value}),$($element[0]).find(".keyword_highlight").html(value))}function setValidity(validity){ngModelCtrl.$setValidity("pattern",validity)}function removeNonAsciiChars(string){return string=string||"",string.replace(/[^\x00-\x7F]/g,"").replace(/\s+/g," ")}var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.form=formCtrl,$scope.value="",$scope.tokens=_.isObject($scope.tokens)?$scope.tokens:{},$scope.pattern=new RegExp($scope.textPattern),$scope.textMinlength=_.isNumber(+$scope.textMinlength)?+$scope.textMinlength:1,$scope.textMaxlength=_.isNumber(+$scope.textMaxlength)?+$scope.textMaxlength:60,$scope.api=_.isObject($scope.api)?$scope.api:{},$scope.api.onKeyDown=$scope.api.onKeyDown||angular.noop,ngModelCtrl.$name=$scope.name,formCtrl.$addControl(ngModelCtrl),$scope.$watch("value",function(newVal,oldVal){var value=newVal+"";$($element[0]).find(".keyword_highlight").css("display",value&&0===value.length?"none":"block"),$($element[0]).find(".keyword_placeholder").css("display",value&&0===value.length?"block":"none"),ngModelCtrl.$dirty&&(ngModelCtrl.$setViewValue(newVal),$scope.isRequired&&ngModelCtrl.$setValidity("required",$scope.isRequired&&!!newVal)),1==value.length?($($element[0]).find(".keyword_highlight").focus(),moveTheCursorToEnd($($element[0]).find(".keyword_highlight")[0],!0)):0===value.length&&$($element[0]).find(".keyword_placeholder").focus()}),$scope.$watch("tokens",function(newVal,oldVal){_.isObject(newVal)&&highlightTokens($scope.value,newVal)},!0),$($element[0]).find(".keyword_highlight").on("keyup change click keydown",function(evt){return 13==evt.keyCode||$scope.value&&$scope.value.length==$scope.textMaxlength&&8!=evt.keyCode&&46!=evt.keyCode?($scope.api.onKeyDown(evt),!1):void $timeout(function(){ngModelCtrl.$setDirty(),$scope.value=$($element[0]).find(".keyword_highlight").text(),$scope.value=removeNonAsciiChars($scope.value),validate($scope.value)})}),$($element[0]).find(".keyword_highlight").on("blur",function(evt){$scope.onBlur()}),$scope.api.highlight=function(tokens){
tokens&&_.isObject(tokens)&&($scope.tokens=tokens,highlightTokens($scope.value,tokens))},$timeout(function(){$($element.find(".keyword_highlight")[0]).trigger("click")}),$scope.$parent.$watch($attrs.ngModel,function(newVal){newVal!==$($element[0]).text()&&newVal&&($scope.value=removeNonAsciiChars(newVal),$($element[0]).find(".keyword_highlight").html(newVal))})}}}])}(angular),function(ng){angular.module("bt-components").directive("koreUxEditor",["textparser","$endpoints","$filter","$timeout","form_util","channelsConfig","$interval","$workflowService","NotificationService","koreUxMap","BTStreamsService","env_conf","$applicationService","i18n",function(textparser,$endpoints,$filter,$timeout,form_util,channelsConfig,$interval,$workflowService,NotificationService,koreUxMap,BTStreamsService,env_conf,$applicationService,i18n){return{restrict:"E",scope:{config:"=?",uxmaps:"=?",json:"=response",displayMode:"=",callbackObject:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/kore-ux-editor/kore-ux-editor.html",controller:["$scope",function($scope,iElement,iAttrs,ctrls){function resetKeys(){$scope.showStandardKeys=!1,$scope.showResponseKeys=!1,$scope.showSessionKeys=!1,$scope.showReportKeys=!1,$scope.showBotVariableKeys=!1}function refreshEditors(){$scope.refresh.jscode=!0,$scope.refresh.markup=!0,$timeout(function(){$scope.refresh.jscode=!1,$scope.refresh.markup=!1})}function isMarkUp(markup,code){return code&&code.trim()?!1:!0}function parse(string){try{return JSON.parse(string)}catch(ex){return string}}function openPreviewModal(){$timeout(function(){$(".response-preview").modal({backdrop:"static",show:!0})},1e3)}function hideSpinner(){$scope.spinner.show=!1}function idpTestListenersRegistration(verifyInitializer){$scope.btTestFormApi.afterInit=function(){console.info("idp test afterInit callback is called"),$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(){console.info("idp test afterTest callback is called"),$timeout(function(){verifyInitializer()},2e3)},$scope.btTestFormApi.afterClose=hideSpinner,$scope.btTestFormApi.onError=hideSpinner,$scope.btTestFormApi.onCancel=hideSpinner}function taskTestListenersRegistration(){$scope.btTestFormApi.afterInit=function(){console.info("task test afterInit callback is called"),$scope.btTestFormApi.test()},$scope.btTestFormApi.afterClose=hideSpinner,$scope.btTestFormApi.onError=hideSpinner,$scope.btTestFormApi.onCancel=hideSpinner}function insideKeys(key){if(!$scope.keys)return!1;for(var i=0;i<$scope.keys.length;i++)if(key===$scope.keys[i])return!0;return!1}function reTransformIt(values,type){if(!values)return values;values=values.replace(/'+/g,""),values=values.split("+");for(var i=0;i<values.length;i++)insideKeys(values[i])&&(values[i]="<%="+values[i]+"%>");return values.join("")}function wrapItInside(print,code){return print=print?transformMarkupToTemplate(print,$scope.keys):"",code=code&&code.trim()?"<% "+code+" %>":"",code+print}function splitCodeIntoNormalAndCode(string){var markup="",code="";return-1!=string.indexOf("<% ")&&-1!=string.lastIndexOf("%>")&&(code=string.substring(string.indexOf("<% ")+2,string.lastIndexOf("%>"))),markup=string.replace(code,"").replace(/<%%>/g,""),code=(code.replace(/var printf=print;/g,"")||"").trim(),code=code.replace(/printf/g,"print"),code=(code.replace(/printf\s?[(](.+)[)]/g,"")||"").trim(),code=(code.replace(/<%|%>/g,"")||"").trim(),{jscode:code,markup:reTransformIt(markup)}}function transformMarkupToTemplate(string,keys){return string}$scope.javascriptEditor={},$scope.editors={},$scope.markdownCbs={},$scope.jsEditorCbs={},$scope.addedChannels=[],$scope.selectedChannel="",$scope.showList=!1,$scope.responses={},$scope.selectedKey="",$scope.previewing=i18n.i18nString("Previewing"),$scope.preview=i18n.i18nString("ux_preview"),$scope.selectedKeyVariable="",$scope.tabs={jscode:!1,markup:!0},$scope.assetsBase=env_conf["assets-url"],$scope._channelConfig=channelsConfig,channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channels=Object.values(channelsConfig.channelsObject),$scope.javascriptEditor={id:"javascript_editor",controls:{codeicon:{name:"","class":" fa fa-code ",tooltip:"write javacript code"},variableKeys:{name:"Variable Keys ","class":"fa fa-key style-div-main pull-left",tooltip:"Variable Keys"},preview:{name:"Preview ","class":"fa fa-caret-down style-div-main",tooltip:"Preview",btnClass:"pull-right"}}},$scope.options={mode:"code",ace:window.ace},$scope.btTestFormApi={},$scope.btTestStatus={},$scope.markdownConfig={popupModal:!0};var isWFacebook=!1,wfacebookIndex=0;$scope.channels=$scope.channels.map(function(channel,i){return channel.used=!1,"wfacebook"===channel.id&&(isWFacebook=!0,wfacebookIndex=i),channel}),isWFacebook&&$scope.channels.splice(wfacebookIndex,1),$scope.channels=_.filter($scope.channels,{enable:!0}),$scope.refresh={jscode:!1,markup:!1},$scope.channelsIcons={slack:{"class":"",image:env_conf["context-url"]+"/img/slack.png"},sms:{"class":"fa fa-comments-o",image:""},email:{"class":"fa fa-envelope",image:""},skype:{"class":"fa fa-skype",image:""},facebook:{"class":"fa fa-facebook fb",image:""},websdk:{"class":"fa fa-code",image:""},kore:{"class":"",image:env_conf["context-url"]+"/img/logo.svg"},rtm:{"class":"",image:env_conf["context-url"]+"/img/web_mobile.svg"},widgetsdk:{"class":"",image:env_conf["context-url"]+"/img/widgetsdk.svg"},spark:{"class":"",image:env_conf["context-url"]+"/img/spark.svg"}},$scope.channelsHavingPreview={email:"email",kore:"kore",sms:"sms",slack:"slack",rtm:"rtm","default":"default",widgetsdk:"widgetsdk"},$scope.$watch("config",function(newVal,oldVal){_.isObject(newVal)?($scope.keys=($scope.config||{}).keys||[],$scope.sessionKeys=($scope.config||{}).sessionKeys||{},$scope.standardKeys=($scope.config||{}).standardKeys||[],$scope.reportKeys=($scope.config||{}).reportKeys||[],$scope.preview=($scope.config||{}).preview||$scope.channelsHavingPreview,$scope.botVariablesKeys=$workflowService.botEnvVariables()):($scope.keys=[],$scope.sessionKeys={},$scope.standardKeys=[],$scope.reportKeys=[],$scope.preview=$scope.channelsHavingPreview,$scope.botVariablesKeys=$workflowService.botEnvVariables())},!0),$scope.$watch("uxmaps",function(newVal,oldVal){_.isArray(newVal)&&(newVal.map(function(channel){$scope.responses[channel.channel]=splitCodeIntoNormalAndCode(channel.body),"default"!=channel.channel&&$scope.channelSelected(channel.channel)}),$scope.selectedChannel&&"default"!=$scope.selectedChannel||$scope.view("default"))}),$scope.addChannel=function(){$scope.showList=!0},$scope.channelSelected=function(channelId){var channelInfo;"cancel"==channelId||_.find($scope.addedChannels,{id:channelId})||(channelInfo=$scope.channels.filter(function(channel){return channel.id===channelId})[0],channelInfo.used=!0,channelInfo&&$scope.addedChannels.push(channelInfo)),$scope.selectedChannel="",$scope.showList=!1,"cancel"!==channelId&&$scope.view(channelId)},$scope.getJsSamples=function(){BTStreamsService.sampleJsTamplates().then(function(res){$scope.demoTemplates=res.data||[]})},$scope.getJsSamples(),$scope.deleteAddedChannel=function(index,type){$scope.activeChannel==type&&refreshEditors(),$scope.channels.map(function(channel){channel.id==type&&(channel.used=!1)}),$scope.addedChannels.splice(index,1),delete $scope.responses[type],index=_.findIndex($scope.uxmaps,{channel:type}),-1!=index&&$scope.uxmaps.splice(index,1),$scope.view("default")},$scope.activeChannel="default",$scope.view=function(type){refreshEditors(),$scope.editors=angular.copy($scope.responses[type]||{jscode:"",markup:""}),$scope.tabs.jscode=$scope.editors.jscode&&$scope.editors.jscode.trim(),$scope.tabs.markup=$scope.editors.markup&&$scope.editors.markup.trim(),$scope.tabs.jscode&&$scope.tabs.markup||($scope.tabs.jscode=!0),$scope.activeChannel=type},$scope.cancel=function(){var index;refreshEditors(),$scope.responses[$scope.activeChannel]?$scope.editors=angular.copy($scope.responses[$scope.activeChannel]):($scope.view("default"),index=_.findIndex($scope.addedChannels,{id:$scope.activeChannel}),$scope.addedChannels.splice(index,1))},$scope.save=function(){$scope.responses[$scope.activeChannel]=angular.copy($scope.editors),$scope.uxmaps=_.isArray($scope.uxmaps)?$scope.uxmaps:[];var index=_.findIndex($scope.uxmaps,{channel:$scope.activeChannel});-1==index?$scope.uxmaps.push({body:wrapItInside($scope.editors.markup,$scope.editors.jscode),channel:$scope.activeChannel,isMarkdown:isMarkUp($scope.editors.markup,$scope.editors.jscode)}):$scope.uxmaps[index]={body:wrapItInside($scope.editors.markup,$scope.editors.jscode),channel:$scope.activeChannel,isMarkdown:isMarkUp($scope.editors.markup,$scope.editors.jscode)}},$scope.$watch("editors",function(newVal,oldVal){newVal&&_.isObject(newVal)&&$scope.save()},!0),$scope.keySelected=function(key){$scope.selectedKey=key},$scope.keySelectedVariable=function(botVariable){"locale"===botVariable.variableType?$scope.selectedKey="content."+botVariable.key:$scope.selectedKey=botVariable.variableType+"."+botVariable.key},$scope.showKeys=function(){$scope.selectedKey="",resetKeys(),$(".keys-tree").modal({backdrop:"static",show:!0})},$scope.useKey=function(){var key=$scope.selectedKey;key&&""!==key&&($scope.tabs.jscode?$scope.jsEditorCbs.onInsert(key):(key="<%="+key+"%>",$scope.markdownCbs.onInsert(key))),$scope.closeKeysModal()},$scope.closeKeysModal=function(){$scope.selectedKey="",$(".keys-tree").modal("hide")},$scope.notifyUser=function(notify,type){notify&&notify.trim()&&"jscode"===type?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_js_notify")):notify&&notify.trim()&&"markup"===type?NotificationService.notify(i18n.i18nString("bot_welcomeMessage_markup_notify")):refreshEditors()},$scope.openPreview=function(){$scope.viewPreview()},$scope.closePreview=function(){$(".response-preview").modal("hide"),$scope.previewIsOn=!1,$scope.spinner.show=!1},$scope.spinner={show:!1},$scope.hasKoreUx=function(){var markup=$scope.editors.markup&&$scope.editors.markup.trim(),jscode=$scope.editors.jscode&&$scope.editors.jscode.trim();return jscode||markup},$scope.openPreviewWithSample=function(){openPreviewModal(),$scope.previewIsOn=!0,$scope.spinner.show=!0,$scope.preview="";var body=wrapItInside($scope.editors.markup,$scope.editors.jscode),markup=isMarkUp($scope.editors.markup,$scope.editors.jscode),payload={uxMap:{body:body},entity:{type:"l"===$scope.config.task._id[0]?"alert":"action",id:$scope.config.task._id},requestChain:[]};$scope.isError=!1,BTStreamsService.uxPreview($workflowService.selectedStream()._id,markup,$scope.activeChannel,payload).then(function(res){$scope.preview=res.data&&res.data.body,$scope.previewIsOn=!1,$scope.spinner.show=!1},function(err){var error=err.data&&err.data.errors&&err.data.errors[0].msg||err.data;$scope.preview=parse(error),$scope.previewIsOn=!1,$scope.spinner.show=!1,$scope.isError=!0})},$scope.viewPreview=function(){function triggerTaskTest(){var taskConfig={type:"l"===$scope.config.task._id[0]?"alert":"action",testFor:"task",definition:$scope.config.task};taskTestListenersRegistration(),$scope.btTestStatus.streamAccountId=$scope.btTestStatus.streamAccountId||"none",taskConfig.accountId=$scope.btTestStatus.streamAccountId,$scope.btTestFormApi.init(taskConfig)}function verifyInitializer(){var payload={idp:$scope.config.task.idp,tenant:idpConfig.tenant,entity:{type:"l"===$scope.config.task._id[0]?"alert":"action",id:$scope.config.task._id},sso_type:idpConfig.sso_type,userId:$applicationService.userInfo().userId,streamAccountId:$scope.btTestStatus.streamAccountId,initializer:$scope.config.task.initializer,actionId:$scope.config.task._id};$scope.config.task.initializer.length?BTStreamsService.ExecuteInitializer(payload).then(function(res){return res.data.response&&res.data.response[0]&&400===res.data.response[0].status?(NotificationService.notify(i18n.i18nString("initializer_Execution_failed")+res.data.response[0].name,"error"),$scope.spinner.testingInProgress=!1,void($scope.spinner.show=!1)):void $scope.callbackObject.afterInitializerExecution(triggerTaskTest)},function(err){$scope.spinner.testingInProgress=!1,NotificationService.notify(i18n.i18nString("something_went_wrong"),"error")}):triggerTaskTest()}$scope.previewIsOn=!0,$scope.spinner.show=!0;var idpConfig=$scope.config.authList.filter(function(idp){return idp.name===$scope.config.task.idp})[0];!idpConfig||"none"==$scope.config.task.idp&&"none"==$scope.config.task.sso_type?(idpConfig=idpConfig||{},verifyInitializer()):(idpConfig=idpConfig||{},idpConfig.type="idp",idpConfig.testFor="idp",idpTestListenersRegistration(verifyInitializer),$scope.btTestFormApi.init(idpConfig,function(res){$scope.spinner.show=!1}))},$scope.btTestFormApi.makeRequest=function(payload){$scope.preview="";var body=wrapItInside($scope.editors.markup,$scope.editors.jscode),markup=isMarkUp($scope.editors.markup,$scope.editors.jscode);payload.uxMap={body:body},$scope.btTestFormApi.closeModal(),openPreviewModal(),$scope.isError=!1,BTStreamsService.uxPreview($workflowService.selectedStream()._id,markup,$scope.activeChannel,payload).then(function(res){$scope.preview=res.data&&res.data.body,$scope.previewIsOn=!1,$scope.spinner.show=!1},function(err){var error=err.data&&err.data.errors&&err.data.errors[0].msg||err.data;$scope.preview=parse(error),$scope.previewIsOn=!1,$scope.spinner.show=!1,$scope.isError=!0})},$workflowService.registerModalHiddenEvent(),$scope.markdownCbs.showKeys=$scope.showKeys,$scope.markdownCbs.channelsHavingPreview=$scope.channelsHavingPreview,$scope.markdownCbs.openPreview=$scope.openPreview,$scope.markdownCbs.openPreviewWithSample=$scope.openPreviewWithSample,$scope.markdownCbs.hasKoreUx=$scope.hasKoreUx,$scope.markdownCbs.spinner=$scope.spinner,$scope.markdownCbs.displayMode=$scope.displayMode,$scope.markdownCbs.isFromKoreUxEditor=!0,$scope.checkForPreviewDisable=function(control){return"preview"!==control||$scope.channelsHavingPreview[$scope.activeChannel]?"preview"===control&&($scope.spinner.show||!$scope.hasKoreUx()||"view"===$scope.displayMode)||"variableKeys"===control&&(!$scope.activeChannel||"view"===$scope.displayMode):!$scope.channelsHavingPreview[$scope.activeChannel]},$scope.previewCall=function(){var classAction=$("#preview-option-toggle").parent().hasClass("open")?"removeClass":"addClass";$("#preview-option-toggle").parent()[classAction]("open")},$scope.onSelected=function(control,type){"codeicon"!==type&&("variableKeys"===type&&($("#preview-option-toggle").parent().removeClass("open"),$scope.showKeys()),"style"!=type&&"preview"!=type&&($(".dropdown").removeClass("open"),$("#preview-option-toggle").parent().removeClass("open")),"preview"===type&&($scope.previewCall||angular.noop)())}}],link:function($scope,$iElement,$attrs){}}}])}(angular),function(ng){var _langSelectorCmpt=angular.module("bt-components");_langSelectorCmpt.directive("languageSelector",function(){return{restrict:"EA",scope:{fromSettings:"@?",language:"=?",hideLable:"=",updateLanguage:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/language-selector/language-selector.html",controller:"languageSelectorCtrl"}}),_langSelectorCmpt.controller("languageSelectorCtrl",["$scope","$interval","$rootScope","$workflowService","$timeout",function($scope,$interval,$rootScope,$workflowService,$timeout){$scope.selectLanguage=function(selectedLanguage){return selectedLanguage&&"false"!==$scope.fromSettings?($scope.i18n.language=_.filter($scope.supportedLanguages,function(language){return language.value===selectedLanguage})[0],void(_.isEmpty($scope.i18n.language)?$scope.setDefaultLanguage():($scope.i18n.languageValue=$scope.i18n.language.value,setLanguage(!0)))):void $scope.setDefaultLanguage()},$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.getLanguageNameByName=function(name){return"<div>"+name+"</div>"},$scope.selectConfig={minimumResultsForSearch:-1,formatResult:function(d){return $(d.text)},formatSelection:function(d){return $(d.text)}},$scope.setDefaultLanguage=function(){$scope.i18n.language=$scope.supportedLanguages&&$scope.supportedLanguages[0],$scope.i18n.languageValue=$scope.i18n.language.value,setLanguage(!0)},$scope.setLanguageCode=function(val){$scope.i18n.languageValue=val,setLanguage(null,newVal)},$scope.getLanguageName=function(val){var index=$scope.supportedLanguages.findIndex(function(lang){return lang.value===val});return index?$scope.supportedLanguages[index].name:$scope.supportedLanguages[0].name},$scope.redirectToLinkStreamForm=function(type,e){e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()),$rootScope.redirectToLink(type,e)};var setLanguage=function(isOnLoad,langValue){langValue&&($scope.i18n.language=_.filter($scope.supportedLanguages,function(language){return language.value===langValue})[0]),$scope.language=$scope.i18n.language,$scope.updateLanguage&&$scope.updateLanguage($scope.language),isOnLoad||($timeout(function(){$scope.$emit("onLanguageChange")}),"ar"===langValue?($("#arabicInput").attr("dir","rtl"),setTimeout(function(){$("div .charactersLength").addClass("arabicLength")},500)):$("#arabicInput").attr("dir","ltr"))};$scope.i18n={},$scope.searchLang="",$scope._constants_=$rootScope._constants_,$scope.seedData=$workflowService.seedData(),$scope.streamData=$workflowService.selectedStream(),$scope.supportedLanguages=$scope.seedData.supportedLanguages||[{name:"English"},{name:"German"},{name:"Spanish"}],$scope.selectLanguage($scope.streamData.defaultLanguage),$scope.$watchCollection("i18n.language",function(newVal,oldVal){setLanguage(null,newVal.value)}),$scope.$watchCollection("i18n.languageValue",function(newVal,oldVal){setLanguage(!1,newVal)})}])}(angular),function(ng){angular.module("bt-components").directive("markdownEditor",["textparser","$endpoints","$filter","form_util","$timeout","$interval","$sce","channelsConfig","$workflowService","i18n",function(textparser,$endpoints,$filter,form_util,$timeout,$interval,$sce,channelsConfig,$workflowService,i18n){return{restrict:"EA",scope:{config:"=?",mode:"=?",callback:"=",controls:"=?",tokens:"=?",activeChannel:"=",markdownid:"@?",noFocus:"=?"},require:["^ngModel","^?form"],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/markdown-editor/markdown-editor.html",link:function($scope,iElement,iAttrs,ctrls){function handleControls(show){Object.keys($scope.markdown.controls).map(function(control){$scope.markdown.controls[control].visible=show})}function updateContextVariables(){$scope.contexts=[],$scope.contextsData=[],$scope.dialogNodeNames=$workflowService.dialogNodesNames(),$scope.contextsData.session=$workflowService.contextData(),$scope.contextsData&&$scope.contextsData.entities&&delete $scope.contextsData.entities,$scope.contextsData&&$scope.contextsData.mappedIntents&&delete $scope.contextsData.mappedIntents,$scope.contexts.push("session"),$scope.dialogNodeNames&&Object.keys($scope.dialogNodeNames).length&&($scope.dialogNodeNames.entities&&$scope.dialogNodeNames.entities.length&&($scope.contexts.push("entities"),$scope.contextsData.entities=$scope.dialogNodeNames.entities),$scope.dialogNodeNames.mappedIntents&&$scope.dialogNodeNames.mappedIntents.length&&($scope.contexts.push("mappedIntents"),$scope.contextsData.mappedIntents=$scope.dialogNodeNames.mappedIntents),$scope.dialogNodeNames.nodes&&$scope.dialogNodeNames.nodes.length&&($scope.contexts=$scope.contexts.concat($scope.dialogNodeNames.nodes)))}function getContentValue(key){var filteredText=_.find($scope.bot.langVar,{key:key});return filteredText.value}function getEnvValue(key){var filteredText=_.find($scope.bot.globalVar,{key:key});return filteredText.value}function checkForGlobalVariables(currentLine,parentIndex){if(currentLine){var keyValue,_value,words=currentLine.split(" "),reg=new RegExp("[/{ ]{2}(\\s)?\\w+[.]\\w+[/}]{2}"),prepareTitle="";reg.test(words)&&(_.map(words,function(word,index){if(word.match(reg)){var textSplitValues=word.match(/[a-zA-Z]+/g);textSplitValues&&"content"===textSplitValues[0]?(keyValue=textSplitValues[1],_value=getContentValue(keyValue),prepareTitle=prepareTitle+"{ "+keyValue+":"+_value+"} \n"):textSplitValues&&"env"===textSplitValues[0]&&(keyValue=textSplitValues[1],_value=getEnvValue(keyValue),prepareTitle=prepareTitle+"{ "+keyValue+":"+_value+"} \n")}}),$($(".ace_layer .ace_line_group .ace_line .ace_xml")[parentIndex]).attr("title",prepareTitle))}}function splitLines(completeLine){var _individualLineArray=completeLine.split("\n");_.map(_individualLineArray,function(line,parentIndex){checkForGlobalVariables(line,parentIndex)})}function retrievePrecedingIdentifier(editor){var pos=editor.getCursorPosition(),text=editor.session.getLine(pos.row),textCopy=text.slice(0,text.length);checkForGlobalVariables(textCopy,pos.row),pos=pos.column;for(var regex=/[a-zA-Z_0-9\$\-\.\u00A2-\uFFFF]/,buf=[],i=pos-1;i>=0&&regex.test(text[i]);i--)buf.push(text[i]);return buf.reverse().join("")}function initializeEditor(){ace.EditSession.prototype.$useWorker=!0,id=$scope.markdown.id,$(iElement[0]).css({width:"100%",height:"300px",border:"1px solid gray"}),editor=ace.edit(id),editor.setTheme("ace/theme/chrome"),editor.setReadOnly($scope.mode||!1),editor.getSession().setMode("ace/mode/markdown");ace.require("ace/ext/language_tools");editor.setOptions({enableBasicAutocompletion:!0,wrap:!0});var rhymeCompleter={getCompletions:function(editor,session,pos,prefix,callback){updateContextVariables(),setTimeout(function(){var prevIdentifier=retrievePrecedingIdentifier(editor),wordList=[],identifierMatches=prevIdentifier.match(/[a-zA-Z]+/g);if(identifierMatches&&"env"===identifierMatches[0]&&(wordList=$scope.bot.globalVar||[]),identifierMatches&&"content"===identifierMatches[0]&&(wordList=$scope.bot.langVar||[]),identifierMatches&&"context"===identifierMatches[0]){var identifiersCount=prevIdentifier.split(".").length-1;if(1===identifiersCount)wordList=$scope.contexts||[];else if(identifiersCount>1){var identifiers=prevIdentifier.split(".");""!==identifiers[identifiers.length-1]&&(identifiers[identifiers.length-1]="");for(var index=0;index<identifiers.length;index++)if(index>0&&""!==identifiers[index]){var _list=[];0===wordList.length&&(wordList=[]),$scope.contextsData.session.hasOwnProperty(identifiers[index])?(wordList=$scope.contextsData.session[identifiers[index]]||[],"object"!=typeof wordList||wordList[0]||(_list=[],$.map(wordList,function(item,key){_list.push(key)}),wordList=[],wordList=_list)):$scope.contextsData.hasOwnProperty(identifiers[index])?(wordList=$scope.contextsData[identifiers[index]]||[],"object"!=typeof wordList||wordList[0]||(_list=[],$.map(wordList,function(item,key){_list.push(key)}),wordList=[],wordList=_list)):wordList=""===identifiers[identifiers.length-1]?[]:[]}}}callback(null,wordList.map(function(word){return word&&word.key?{caption:word.key,value:word.key,meta:"static"}:{caption:word,value:word,meta:"static"}}))},50)},insertMatch:function(editor,data){editor.completer.insertMatch({value:data.caption})}};editor.completers=[rhymeCompleter],editor.commands.on("afterExec",function(e){"insertstring"===e.command.name?editor.execCommand("startAutocomplete"):"backspace"===e.command.name&&$timeout(function(){editor.execCommand("startAutocomplete")},100)}),$timeout(function(){$(".ace_text-input").attr("role","textbox"),$scope.callback&&$scope.callback.displayMode&&"VIEW"===$scope.callback.displayMode||$scope.noFocus||editor.focus()}),$scope.callback.focusEditor=function(){editor.focus()},$(window).on("focus",function(e){editor.focus()}),editor.on("blur",function(e){$scope.callback&&$scope.callback.onBlur&&$scope.callback.onBlur()}),editor.on("focus",function(e){$scope.callback&&$scope.callback.onFocus&&$scope.callback.onFocus()})}var editor,id;$scope.imageSource=i18n.i18nString("image_source"),$scope.hyperLink=i18n.i18nString("hyper_link"),$scope.previewing=i18n.i18nString("Previewing"),$scope.preview=i18n.i18nString("ux_preview"),$scope.imageUrl=i18n.i18nString("image_url"),$scope.hyperLinkCaps=i18n.i18nString("hyper_link_caps"),$scope.imageALt=i18n.i18nString("image_alt"),$scope.hyperText=i18n.i18nString("hyper_text"),$scope.markdownid=$scope.markdownid||"markdown_editor";var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;if($scope.config=_.isObject($scope.config)?$scope.config:{inlineModal:!0},$scope.callback=_.isObject($scope.callback)?$scope.callback:{},$scope.linkInfo={},$scope.keys=[],$scope.contextsData=[],$scope.contexts=[],$scope.bot={variablesList:$workflowService.botEnvVariables(),globalVar:[],langVar:[]},0!==$scope.bot.variablesList.length&&($scope.bot.globalVar=$scope.bot.variablesList.map(function(val){return"env"==val.variableType?val:void 0}).filter(function(val){return void 0!==val}),$scope.bot.langVar=$scope.bot.variablesList.map(function(val){return"locale"==val.variableType?val:void 0}).filter(function(val){return void 0!==val})),$scope.markdown={id:$scope.markdownid,controls:{style:{name:i18n.i18nString("style"),"class":"fa fa-caret-down style-div-main",tooltip:i18n.i18nString("style")},bold:{name:"","class":"fa fa-bold",tooltip:i18n.i18nString("bold")},italic:{name:"","class":"fa fa-italic",tooltip:i18n.i18nString("italic")},link:{name:"","class":"fa fa-link",tooltip:i18n.i18nString("link")},image:{name:"","class":"fa fa-picture-o",tooltip:i18n.i18nString("Image")},ordered:{name:"","class":"fa fa-list-ol",tooltip:i18n.i18nString("ordered")},unordered:{name:"","class":"fa fa-list-ul",tooltip:i18n.i18nString("unordered")},indent:{name:"","class":"fa fa-indent",tooltip:i18n.i18nString("indent")},line:{name:"","class":"fa fa-minus",tooltip:i18n.i18nString("constants.iconsTooltips_line")},variableKeys:{name:i18n.i18nString("Variable_keys"),"class":"fa fa-key style-div-main pull-left",tooltip:i18n.i18nString("Variable_keys")},preview:{name:i18n.i18nString("preview_name"),"class":"fa fa-caret-down style-div-main",tooltip:i18n.i18nString("preview_name"),btnClass:"pull-right"}}},$scope.callback.isFromUserPrompt){var plainText={name:i18n.i18nString("plain_text"),"class":"style-div-main",tooltip:i18n.i18nString("plain_text"),btnClass:"pull-left fontsize12"},javaScriptEditor={name:i18n.i18nString("javascript"),"class":"style-div-main",tooltip:i18n.i18nString("js_editor"),btnClass:"pull-left reduceOpacity fontsize12"},promptsPreview={name:i18n.i18nString("preview_name"),"class":"style-div-main",tooltip:i18n.i18nString("preview_name"),btnClass:"pull-left reduceOpacity fontsize12"};$scope.markdown.controls.plainText=plainText,$scope.markdown.controls.javaScriptEditor=javaScriptEditor,$scope.markdown.controls.promptsPreview=promptsPreview}$scope.contextsData=$workflowService.contextData(),$scope.headingsList=[{id:"opt-1",tag:$sce.trustAsHtml("<h1>"+i18n.i18nString("heading_1_label")+"</h1>")},{id:"opt-2",tag:$sce.trustAsHtml("<h2>"+i18n.i18nString("heading_2_label")+"</h2>")},{id:"opt-3",tag:$sce.trustAsHtml("<h3>"+i18n.i18nString("heading_3_label")+"</h3>")},{id:"opt-4",tag:$sce.trustAsHtml("<h4>"+i18n.i18nString("heading_4_label")+"</h4>")},{id:"opt-5",tag:$sce.trustAsHtml("<h5>"+i18n.i18nString("heading_5_label")+"</h5>")},{id:"opt-6",tag:$sce.trustAsHtml("<h6>"+i18n.i18nString("heading_6_label")+"</h6>")},{id:"opt-7",tag:$sce.trustAsHtml("<h6>"+i18n.i18nString("pre")+"</h6>")}],$scope.$watch("controls",function(newVal,oldVal){_.isArray(newVal)?(handleControls(!1),$scope.controls.map(function(control){$scope.markdown.controls[control].visible=!0})):handleControls(!0)},!0),$scope.$watch("activeChannel",function(newVal,oldVal){$scope.mode=$scope.mode||$scope.callback.displayMode&&"view"===$scope.callback.displayMode?!0:!1,Object.keys($scope.markdown.controls).forEach(function(control){"promptsPreview"===control?$scope.markdown.controls[control].channelDisable=!1:$scope.markdown.controls[control].channelDisable=$scope.mode});var channelConfig=_.find(channelsConfig.channels,{id:newVal});channelConfig&&channelConfig.markdownDisable&&channelConfig.markdownDisable.forEach(function(control){var uiControl=$scope.markdown.controls[control];uiControl&&(uiControl.channelDisable=!0)})},!0),$scope.$watch("tokens",function(newVal,oldVal){_.isArray(newVal)&&($scope.keys=newVal.map(function(token){return token=token.replace(/\^/g,"\\^"),token=token.replace(/\$/g,"\\$"),token=token.replace(/\+/g,"\\+"),token=token.replace(/\./g,"\\."),token=token.replace(/\*/g,"\\*"),token=token.replace(/\[/g,"\\["),token=token.replace(/\]/g,"\\]"),token=token.replace(/\(/g,"\\("),token=token.replace(/\)/g,"\\)"),token=token.replace(/\{/g,"\\{"),token=token.replace(/\}/g,"\\}"),token=token.replace(/\?/g,"\\?"),token=token.replace(/\|/g,"\\|")}))}),ngModelCtrl.$name=iAttrs.name,formCtrl.$addControl(ngModelCtrl),ngModelCtrl.$render=function(){var _ngViewTimer;_ngViewTimer=$interval(function(){editor&&(editor.setValue(ngModelCtrl.$viewValue||"",1),$interval.cancel(_ngViewTimer))})},$timeout(function(){function set(){var value=editor.getValue();$timeout(function(){splitLines(editor.getValue()),value&&value.trim()?ngModelCtrl.$setValidity("required",!0):(ngModelCtrl.$setValidity("required",!1),value="")},600),ngModelCtrl.$setViewValue(value)}function handleToolBarAction(text){var range=editor.selection.getRange();editor.session.replace(range,text),editor.focus()}function handleModalDisplay(show){form_util.makeItClean($scope.linkForm),$(iElement).find(".helper_form_modal").modal(show?"show":"hide")}initializeEditor(),editor.getSession().on("change",function(e){ngModelCtrl.$setDirty(),$scope.$evalAsync(set)}),$scope.onSelected=function(control,type,event){var range=editor.selection.getRange(),text=editor.session.getTextRange(range);"variableKeys"===type&&($scope.callback.showKeys(),$(".markdown-preview-option-toggle").parent().removeClass("open")),"plainText"===type||"javaScriptEditor"===type||"promptsPreview"===type?($scope.callback.switchEditor(type),$(".markdown-preview-option-toggle").parent().removeClass("open")):"style"!=type&&"preview"!=type&&($(".dropdown").removeClass("open"),$(".markdown-preview-option-toggle").parent().removeClass("open")),($scope[type]||angular.noop)(text,event)},$scope.bold=function(text){function verifyForUndo(text){var chunk;return chunk=text.replace(/\*/g,""),"*"+chunk+"*"==text}return verifyForUndo(text)?(text=text.replace(/\*/g,""),void handleToolBarAction(text)):(text="*"+text+"*",void handleToolBarAction(text))},$scope.italic=function(text){function verifyForUndo(text){var chunk;return chunk=text.replace(/~/g,""),"_"+chunk+"_ "==text}return verifyForUndo(text)?(text=text.replace(/_/g,""),void handleToolBarAction(text)):(text="_"+text+"_ ",void handleToolBarAction(text))},$scope.link=function(text){var link=-1!=(text||"").search(/^(https:\/\/|http:\/\/)/)?text:"",linkText=link?"":text;$scope.linkInfo={type:"link",link:link,linkText:linkText},$scope.linkInfo.inlineShow=$scope.config.inlineModal,$scope.linkInfo.modalShow=$scope.config.popupModal,handleModalDisplay($scope.config.popupModal)},$scope.image=function(text){var link=-1!=(text||"").search(/^(https:\/\/|http:\/\/)/)?text:"",linkText=link?"":text;$scope.linkInfo={type:"image",link:link,linkText:linkText},$scope.linkInfo.inlineShow=$scope.config.inlineModal,$scope.linkInfo.modalShow=$scope.config.popupModal,handleModalDisplay($scope.config.popupModal)},$scope.underscore=function(text){handleToolBarAction(text)},$scope.ordered=function(text){text=text.split("\n"),text=text.map(function(chunk,i){return-1!=chunk.search(/^([0-9]+?\.\s)/)?chunk.replace(/^([0-9]+?\.\s)/,""):i+1+". "+chunk}),text=text.join("\n"),handleToolBarAction(text)},$scope.unordered=function(text){text=text.split("\n"),text=text.map(function(chunk,i){return-1!=chunk.search(/\*\s/)?chunk.replace(/\*\s/,""):"* "+chunk}),text=text.join("\n"),handleToolBarAction(text)},$scope.line=function(text){text+="\n___",handleToolBarAction(text)},$scope.style=function(text,event){$(event.currentTarget).closest("markdown-editor").find("#style-options-toggle").click()},$scope.preview=function(text){var classAction=$(".markdown-preview-option-toggle").parent().hasClass("open")?"removeClass":"addClass";
$(".markdown-preview-option-toggle").parent()[classAction]("open")},$scope.indent=function(text){function verifyForUndo(text){var chunk;return chunk=text.replace(/^>>/,""),">>"+chunk==text}return verifyForUndo(text)?(text=text.replace(/^>>/,""),void handleToolBarAction(text)):(text=">>"+text,void handleToolBarAction(text))},$scope.optionSelected=function(id){function verifyForUndo(text){var chunk;return chunk=text.replace(/(#h1|#h2|#h3|#h4|#h5|#h6|```|{quote})/g,""),"opt-7"===id||"opt-8"===id?optionsObject[id]+""+chunk+optionsObject[id]==text:optionsObject[id]+""+chunk==text}var range=editor.selection.getRange(),text=editor.session.getTextRange(range),optionsObject={"opt-1":"#h1","opt-2":"#h2","opt-3":"#h3","opt-4":"#h4","opt-5":"#h5","opt-6":"#h6","opt-7":"```","opt-8":"{quote}"};if(verifyForUndo(text))return text=text.replace(/(#h1|#h2|#h3|#h4|#h5|#h6|```|{quote})/g,""),void handleToolBarAction(text);switch(text=text.replace(/(#h1|#h2|#h3|#h4|#h5|#h6|```|{quote})/g,""),id){case"opt-1":text="#h1"+text;break;case"opt-2":text="#h2"+text;break;case"opt-3":text="#h3"+text;break;case"opt-4":text="#h4"+text;break;case"opt-5":text="#h5"+text;break;case"opt-6":text="#h6"+text;break;case"opt-7":text="```"+text+"```";break;case"opt-8":text="{quote}"+text+"{quote}"}handleToolBarAction(text)},$scope.saveLink=function(form){var text,link,hoverText;return form.$invalid?void form_util.touch(form):(text=$scope.linkInfo.link,link=$scope.linkInfo.linkText,hoverText=$scope.linkInfo.hoverText,"link"==$scope.linkInfo.type?text="["+link+"]("+text+")":"image"==$scope.linkInfo.type&&(text="!["+link+"]("+text+")"),handleToolBarAction(text),void $scope.cancelLink())},$scope.cancelLink=function(){$scope.linkInfo={},handleModalDisplay(!1)},$scope.callback.onInsert=function(data){ngModelCtrl.$setDirty(),editor.insert(data),editor.focus()},$scope.callback.format=function(){var value=editor.getValue();value=value.replace(/ /g,""),ngModelCtrl.$setDirty(),editor.setValue($filter("styleit")(value),1)},$scope.$on("$destroy",function(){ngModelCtrl.$$parentForm.$removeControl(ngModelCtrl)})}),$scope.validateURL=function(){return{test:function(uri){var p=/(\w*\W*)?\w*(\.(\w)+)+(\W\d+)?(\/\w*(\W*\w)*)*/;return uri.match(p)?!0:!1}}}()}}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("mlEntitySelection",["$timeout","$sce","$sanitize","_constants_","$compile","$workflowService",function($timeout,$sce,$sanitize,_constants_,$compile,$workflowService){return{restrict:"EA",scope:{offsetObject:"=?",showentityDropdown:"=?",focusedUtterance:"=?",selectedUtteranceIndex:"=?",startEndIndex:"=?",selectedUtterence:"=?",utteranceBeforeEdit:"@?",callBacks:"=?",fromEdit:"=?",disableEvents:"=?"},controller:["$scope","_constants_",function($scope,_constants_){$scope.constants=_constants_}],link:function($scope,$element,$attrs,ctrls){function updateEntityWordMapIndex(evt,editAction){if($scope.selectedUtterence.entities&&$scope.selectedUtterence.entities.length){var a=(window.getSelection().getRangeAt(0),rangy.getSelection()),n=a.saveCharacterRanges($element[0]),r=$($element[0]).text().length,cursorPosition=n[0].characterRange.start;console.log("================================================"),console.log(a),console.log("================================================"),$.each($scope.selectedUtterence.entities,function(i,entity){if(console.log(cursorPosition,entity.startIndex+1),entity.startIndex+1>=cursorPosition&&"adding"==editAction&&(entity.startIndex=entity.startIndex+($scope.focusedUtterance.length-$scope.utteranceBeforeEdit.length),entity.endIndex=entity.endIndex+($scope.focusedUtterance.length-$scope.utteranceBeforeEdit.length)),entity.startIndex+1<=cursorPosition&&entity.endIndex+1>=cursorPosition&&"adding"==editAction&&(entity.endIndex=entity.endIndex+($scope.focusedUtterance.length-$scope.utteranceBeforeEdit.length)),entity.startIndex>cursorPosition&&entity.endIndex>cursorPosition&&"removing"==editAction&&(entity.startIndex=entity.startIndex-($scope.utteranceBeforeEdit.length-$scope.focusedUtterance.length),entity.endIndex=entity.endIndex-($scope.utteranceBeforeEdit.length-$scope.focusedUtterance.length)),entity.startIndex==cursorPosition&&entity.endIndex>cursorPosition&&"removing"==editAction&&(entity.endIndex=entity.endIndex-($scope.utteranceBeforeEdit.length-$scope.focusedUtterance.length)),entity.startIndex+1<=cursorPosition&&entity.endIndex>cursorPosition&&"removing"==editAction&&(entity.endIndex=entity.endIndex-($scope.utteranceBeforeEdit.length-$scope.focusedUtterance.length)),$scope.focusedUtterance.substring(entity.startIndex,entity.endIndex)&&$scope.focusedUtterance.substring(entity.startIndex,entity.endIndex)||(entityIndexToDelete=i),"SPAN"==a.focusNode.parentNode.tagName){$lastSpanFocused=$(a.focusNode.parentNode);var nodeInnerContent=$(a.focusNode.parentNode).text()&&$(a.focusNode.parentNode).text().trim();nodeInnerContent||(entityIndexToDelete=$(a.focusNode.parentNode).attr("entityindex"))}$lastSpanFocused||(entityIndexToDelete=$(a.focusNode.parentNode).attr("entityindex"),$lastSpanFocused="notfocus"),entity.startIndex==cursorPosition&&entity.endIndex==cursorPosition&&(entityIndexToDelete=i)}),-1!==entityIndexToDelete&&($scope.selectedUtterence.entities.splice(entityIndexToDelete,1),entityIndexToDelete=-1),$scope.fromEdit=!0,$scope.selectedUtterence.sentence=$("<div>"+$scope.focusedUtterance+"</div>").text(),$scope.callBacks.mapColorEntityToWord($scope.selectedUtterence),$scope.$apply();var i=$($element[0]).text().length;r>i?n[0]&&(n[0].characterRange.end+=i-r,n[0].characterRange.start=n[0].characterRange.end,a.restoreCharacterRanges($element[0],n)):a.restoreCharacterRanges($element[0],n)}$scope.utteranceBeforeEdit=$($element[0]).text()}function getSelectionCharOffsetsWithin(element){element=element[0];var sel,range,priorRange,start=0,end=0;return"undefined"!=typeof window.getSelection?(range=window.getSelection().getRangeAt(0),priorRange=range.cloneRange(),priorRange.selectNodeContents(element),priorRange.setEnd(range.startContainer,range.startOffset),start=priorRange.toString().length,end=start+range.toString().length):"undefined"!=typeof document.selection&&"Control"!=(sel=document.selection).type&&(range=sel.createRange(),priorRange=document.body.createTextRange(),priorRange.moveToElementText(element),priorRange.setEndPoint("EndToStart",range),start=priorRange.text.length,end=start+range.text.length),{start:start,end:end}}function getTextStartEndIndex(){var mainDiv=$($element[0]),sel=getSelectionCharOffsetsWithin(mainDiv);return sel}function getSelectedText(){var text="";if(window.getSelection){if(text=window.getSelection().toString()){$scope.startEndIndex=getTextStartEndIndex(),-1==$scope.constants.wordSensitive.indexOf(selectedLanguage)&&getWholeWordIndex($scope.startEndIndex);var nlpWord=$scope.focusedUtterance&&$scope.focusedUtterance.trim()||"";text=nlpWord.substring($scope.startEndIndex.start,$scope.startEndIndex.end)}}else document.selection&&"Control"!=document.selection.type&&(text=document.selection.createRange().text);return text}function getWholeWordIndex(indexObject){var nlpWord=$scope.focusedUtterance&&$scope.focusedUtterance.trim()||"";if(0!==indexObject.start&&" "==nlpWord.charAt(indexObject.start)&&(indexObject.start=indexObject.start+1),nlpWord.length!==indexObject.end&&" "!==nlpWord.charAt(indexObject.end-1)){var subString2=nlpWord.substring(indexObject.end);-1!==subString2.indexOf(" ")?indexObject.end=indexObject.end:/[?||*||,||.||!]/.test(subString2)&&(indexObject.end=indexObject.end+subString2.length-1)}}function handleContextMenu(event){if($scope.disableEvents)return!1;var x=($($element[0]).find(".dropdown-menu").offset(),event.offsetX),y=event.offsetY,_container=$($element[0]).closest(".ps-container"),_scrollHeight="";_container&&(_scrollHeight=$($element[0]).offset().top-_container.offset().top+_container.scrollTop()),$($element[0]).closest("#intentPanel").is(":visible")&&(_scrollHeight-=60),event.verticalH=_scrollHeight,getSelectedText()?($scope.offsetObject=event,$scope.callBacks.updateDropDownPostion(!0,$scope.offsetObject),$($element[0]).find(".dropdown-menu").css({top:y+"px",left:x+"px"})):($scope.offsetObject=event,$scope.callBacks.updateDropDownPostion(!1,$scope.offsetObject))}function hideContextMenu(evt){$(evt.target).closest("ul").hasClass("entity-selection-dropdown")||getSelectedText()||$scope.callBacks.updateDropDownPostion(!1,$scope.offsetObject)}if($scope.constants.config.hideMLEE)return $($element[0]).on("keyup keydown",function(evt){("13"==evt.keyCode||$scope.disableEvents)&&evt.preventDefault()}),!0;var $lastSpanFocused="notfocus",entityIndexToDelete=-1,selectedLanguage=(rangy.createRange($element[0]),$workflowService.currentLanguage());$scope.constants=_constants_,$($element[0]).on("click","span",function(evt){return $scope.disableEvents?!1:(evt.stopPropagation(),evt.preventDefault(),console.log($(this).attr("startIndex")),console.log("span"),$scope.selectedUtteranceIndex=$($(this).parent()).attr("utteranceIndex"),$scope.startEndIndex={start:$(this).attr("startIndex"),end:$(this).attr("endIndex")},void $scope.callBacks.updateDropDownPostion(!0,$scope.offsetObject))}),$($element[0]).on("change click keydown",function(evt){("13"==evt.keyCode||$scope.disableEvents)&&evt.preventDefault(),$scope.focusedUtterance=$($element[0]).text(),$scope.selectedUtteranceIndex=$($element[0]).attr("utteranceIndex")}),$($element[0]).on("keyup",function(evt){("13"==evt.keyCode||$scope.disableEvents)&&evt.preventDefault(),$scope.focusedUtterance=$($element[0]).text(),$scope.selectedUtteranceIndex=$($element[0]).attr("utteranceIndex");var oldVal=$scope.utteranceBeforeEdit,newVal=$scope.focusedUtterance;oldVal&&newVal&&oldVal.length<newVal.length&&updateEntityWordMapIndex(evt,"adding"),oldVal&&newVal&&oldVal.length>newVal.length&&updateEntityWordMapIndex(evt,"removing")}),$($element).on("focus",function(evt){$scope.focusedUtterance=$($element[0]).text(),$scope.utteranceBeforeEdit=$($element[0]).text(),$timeout(function(){$(".entityInfoDiv").hide(),$(".mlutterenceFocused").is(":visible")&&$(".mlutterenceFocused").removeClass("mlutterenceFocused"),$scope.selectedUtterence.entities&&$scope.selectedUtterence.entities.length&&$($element[0]).closest(".uttrence-view").addClass("mlutterenceFocused"),$($element[0]).parent(".utterenceeditsection").siblings(".entityInfoDiv").show()},200),$("document").off("keypress").on("keypress",".spantags",function(evt){console.log("span inside"),console.log(this)})}),$($element).on("focusout",function(evt){}),document.addEventListener?$element[0].addEventListener("contextmenu",function(e){handleContextMenu(e),e.preventDefault()},!1):$element[0].attachEvent("oncontextmenu",function(){handleContextMenu(e),window.event.returnValue=!1}),$($element[0]).dblclick(function(event){handleContextMenu(event),event.preventDefault()}),$($element[0]).mouseup(function(event){handleContextMenu(event),event.preventDefault()}),$(document).off("click.entity").on("click.entity",function(e){$(e.target).parent().hasClass("entity")&&hideContextMenu(e)})}}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("nluWarning",function(){return{restrict:"EA",scope:{iconType:"=",nluRules:"=",type:"=",id:"=",container:"=",cb:"&",parentClass:"=",placement:"=",intentsObj:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/nlp-warnings/nlp-warnings.html",controller:["$scope","$timeout","NotificationService","BTStreamsService","$workflowService","i18n","env_conf",function($scope,$timeout,NotificationService,BTStreamsService,$workflowService,i18n,env_conf){function buildWarnData(){$scope.intentsObj=$scope.intentsObj||{},$scope.nluRules&&$scope.nluRules&&Object.keys($scope.nluRules).length&&($.each($scope.nluRules,function(key,val){val&&val.severity&&(val.severity=val.severity.toLowerCase(),val.type=key,val.type=key,val.utteranceCount=("number"==typeof val.utteranceCount?Math.round(val.utteranceCount):val.utteranceCount)||"",val.requiredCount=("number"==typeof val.requiredCount?Math.round(val.requiredCount):val.requiredCount)||"",val.result=("number"==typeof val.result?Math.round(val.result):val.result)||"",val.score=val.score||0,val._intentCount=val.intents?val.intents.length:("number"==typeof val.utteranceCount?Math.round(val.utteranceCount):val.utteranceCount)||"",val.intentName="intent ",val.intents&&val.intents.length&&(val.intents.length>1&&(val.intentName="intents "),val.intents.forEach(function(intent,i){3>i&&(val.intentName&&i&&(val.intentName=val.intentName+", "),val.intentName=val.intentName+("'"+$scope.intentsObj[intent.taskId].intent+"'"))})),val.text=i18n.i18nString(val.type+$scope.messageType,{utteranceCount:val.utteranceCount||0,requiredCount:val.requiredCount||0,result:val.result||0,intentCount:val._intentCount||0,score:val.score||0,intentName:val.intentName||""}),val.desc=i18n.i18nString(val.type+$scope.descType,{utteranceCount:val.utteranceCount||0,requiredCount:val.requiredCount||0,result:val.result||0,intentCount:val._intentCount||0,score:val.score||0,intentName:val.intentName||""}),"error"===val.severity.toLowerCase()?$scope.warnObj.errors.push(val):"warning"===val.severity.toLowerCase()&&$scope.warnObj.warnings.push(val),$scope.warnObj.all.push(val))}),$scope.warnObj.errors.length?($scope.primaryType="warning",$scope.warnIcon=env_conf["context-url"]+"/assets/icons/nluError.svg"):($scope.primaryType="info",$scope.warnIcon=env_conf["context-url"]+"/assets/icons/nluWarn.svg"))}function getTemplate(){return $("#nluPopoverContent_"+$scope.type+$scope.id)[0]}var _ele="#nlu_"+$scope.type+$scope.id;$scope.warn=env_conf["context-url"]+"/assets/icons/nluWarningInfo.svg",$scope.error=env_conf["context-url"]+"/assets/icons/nluErrorInfo.svg",$scope.messageType="_msg"+("utterance"===$scope.type?"_utterance":""),$scope.descType="_desc"+("utterance"===$scope.type?"_utterance":""),$scope.viewUtterance=function(){$scope.clearPopOversforNav(),$scope.cb()},$scope.warnIcon="",$scope.selectedTab="all",$scope.warnObj={warnings:[],errors:[],all:[],popoverInitiated:!1},$scope.nluPopover=function(){return $scope.warnObj.all.length?($scope.warnObj.id=$scope.type+$scope.id,$scope.warnObj.hovered=null,$scope.clearPopOversforNav(),void($scope.warnObj.timer=setTimeout(function(){$scope.warnObj.id===$scope.type+$scope.id&&$(_ele).popover("show")},500))):($scope.clearPopOversforNav(),$(".nluWarnTriggers").popover("hide"),$scope.warnObj.id=null,void($scope.warnObj.hovered=null))},$scope.hideNluPopover=function(menu,menuComponent){clearTimeout($scope.warnObj.timer),setTimeout(function(e){$scope.warnObj.hovered||$(_ele).popover("hide")},300)},$scope.clearPopOversforNav=function(){$(".nluWarnTriggers").popover("hide"),clearTimeout($scope.warnObj.timer)},$scope.initPopover=function(){if($scope.warnObj.all.length||!$scope.warnObj.popoverInitiated){$scope.warnObj.popoverInitiated=!0;var popOverClass="nluPopoverContent_"+$scope.type+$scope.id,placement="auto";"intent"!==$scope.type&&(placement="left"),setTimeout(function(){$(_ele)&&$(_ele).popover&&$(_ele).popover("destroy"),$(_ele).popover({html:!0,trigger:"manual",placement:$scope.placement||placement,container:$scope.container||"body",content:getTemplate()}).data("bs.popover").tip().addClass("nluPopover "+popOverClass+(" items"+$scope.warnObj.all.length)+("infoIcon"===$scope.iconType?" nluInfoPopover":"")),setTimeout(function(){$(_ele).off("shown.bs.popover").on("shown.bs.popover",function(e){$("."+popOverClass).off("mouseenter").on("mouseenter",function(e){$scope.warnObj.hovered=$scope.type+$scope.id}),$("."+popOverClass).off("mouseleave").on("mouseleave",function(e){$scope.warnObj.hovered=null,$(".nluWarnTriggers").popover("hide")})})},100)},100)}},"published"!==$workflowService.selectedStreamState()&&buildWarnData(),$scope.selectTab=function(type){$scope.selectedTab=type},$scope.$on("$destroy",function(){$scope.clearPopOversforNav(),$(".popover").remove(),$(_ele).popover&&$(_ele).popover("destroy")})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("notifier",["uuid4","$timeout",function(uuid4,$timeout){return{restrict:"EA",scope:{bridge:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/notifier/notifier.html",controller:["$scope",function($scope){$scope.notificationClick=function(navigateInfo){$scope.bridge.onNotificationClick&&$scope.bridge.onNotificationClick(navigateInfo)}}],link:function($scope,$ele,$attrs){$scope.notifications=[],$scope.types=[],$scope.supportedTypes=[{type:"error","class":"error-color",name:"Error"},{type:"warning","class":"warning-color",name:"Warning"},{type:"log","class":"warning-color",name:"Log"}],$scope.newNodeCollors={message:{type:"message",name:"Message",pluralName:"Messages",icon:"bxpw-icon-flowMenu-comment",bgcolor:"#3C85F6",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!1},entity:{type:"entity",name:"Entity",pluralName:"Entities",icon:"bxpw-icon-ask-question",bgcolor:"#6AB872",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!1},dialogAct:{type:"dialogAct",name:"Confirmation",pluralName:"Confirmations",icon:"bxpw-icon-flowMenu-split",bgcolor:"#437A91",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!1},intent:{type:"intent",name:"Intent",pluralName:"Intents",icon:"bxpw-icon-pp-icon",bgcolor:"#381472",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!1},agentTransfer:{type:"agentTransfer",name:"Agent Transfer",pluralName:"Agent Transfers",icon:"bxpw-icon-agent-transfer",bgcolor:"#845832",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!1},form:{type:"form",name:"Digital Form",pluralName:"Forms",icon:"bxpw-icon-digital-form",bgcolor:"#AD33D8",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!1,internalNode:!1},service:{type:"service",name:"Service",pluralName:"Services",icon:"bxpw-icon-flowMenu-connect-to-API",bgcolor:"#B893F2",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!0},script:{type:"script",name:"Script",pluralName:"Scripts",icon:"bxpw-icon-bot-functions",bgcolor:"#9F9F9F",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!0},logic:{type:"logic",name:"Logic",pluralName:"Logics",icon:"bxpw-icon-logic",bgcolor:"#EA3330",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!0},SDKWebHook:{type:"SDKWebHook",name:"Webhook",pluralName:"Webhooks",icon:"bxpw-icon-webhook",bgcolor:"#845932",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!0},process:{type:"process",name:"Process",pluralName:"Process",icon:"bxpw-icon-process",bgcolor:"#135423",bgcolorOpacity:"",fcolor:"#fffff !important",stencil:!0,dragable:!0,internalNode:!0}},$scope.bridge.notify=function(notifiction){var _index=_.findIndex($scope.supportedTypes,{type:notifiction.type});return-1!==_index?(notifiction.id="bt-nf-"+uuid4.generate(),notifiction.typeMeta=$scope.supportedTypes[_index],$scope.notifications.push(notifiction),notifiction.id):void 0},$scope.bridge.update=function(notifiction,id){var _index=_.findIndex($scope.notifications,{id:id});-1!==_index&&(notifiction.id=id,$scope.notifications[_index]=notifiction)},$scope.bridge.remove=function(id){var _index=_.findIndex($scope.notifications,{id:id});-1!==_index&&$scope.notifications.splice(_index,1)},$scope.$watch("notifications",function(nv,ov){var _ntfs=nv.map(function(obj){return obj.type});_ntfs=_ntfs.filter(function(v,i){return _ntfs.indexOf(v)===i}),$scope.types=_ntfs.map(function(type){return _.find($scope.supportedTypes,{type:type})})},!0),$ele.on("show.bs.dropdown",function(){$ele.resize()})}}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("richEditor",["$timeout","$sce","$sanitize","_constants_","$compile","$workflowService",function($timeout,$sce,$sanitize,_constants_,$compile,$workflowService){return{restrict:"E",require:["^ngModel","^?form"],scope:{tokens:"=?",name:"@",isRequired:"@",isDisabled:"@",api:"=",placeholder:"@",context:"=",noteDescription:"=?",testing:"=?",intentNotFound:"=?",intentVerified:"=?",entityList:"=?",taskDetails:"=?",selectedUtterance:"=?",startEndIndex:"=?"},controller:["$scope",function($scope){}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/rich-editor/rich-editor.html",link:function($scope,$element,$attrs,ctrls){function focusControls(){$timeout(function(){$($element[0]).find(".keyword_highlight").focus()})}function handleControlDisplay(value){angular.noop()}function getSanitizedText(text){return text=text||"",text.escapeHTML()}function moveTheCursorToEnd(element,moveIt){var range,selection;moveIt&&(document.createRange?(range=document.createRange(),range.selectNodeContents(element),range.collapse(!1),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range)):document.selection&&(range=document.body.createTextRange(),range.moveToElementText(element),range.collapse(!1),range.select()))}function insertTextAtCursor(text){var sel,range;text=getTextIncludingTags(text),window.getSelection?(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount&&(range=sel.getRangeAt(0),range.deleteContents(),range.insertNode(document.createTextNode(text)))):document.selection&&document.selection.createRange&&(document.selection.createRange().text=text)}function getSelectionCharOffsetsWithin(element){element=element[0];var sel,range,priorRange,start=0,end=0;if("undefined"!=typeof window.getSelection){var _selectedText=window.getSelection()&&window.getSelection().toString()||"",_spaceAt=" "==_selectedText.charAt(0)?"startPos":" "==_selectedText.charAt(_selectedText.length-1)?"endPos":"noSpace",_startOffset="";"startPos"==_spaceAt?(range=window.getSelection().getRangeAt(0),_startOffset=window.getSelection().baseOffset+1,range.setStart(range.startContainer,_startOffset)):"endPos"==_spaceAt&&(range=window.getSelection().getRangeAt(0),_startOffset=window.getSelection().extentOffset-1,range.setEnd(range.startContainer,_startOffset));try{range=window.getSelection().getRangeAt(0),priorRange=range.cloneRange(),priorRange.selectNodeContents(element),priorRange.setEnd(range.startContainer,range.startOffset),start=priorRange.toString().length,end=start+range.toString().length}catch(e){}}else"undefined"!=typeof document.selection&&"Control"!=(sel=document.selection).type&&(range=sel.createRange(),priorRange=document.body.createTextRange(),priorRange.moveToElementText(element),priorRange.setEndPoint("EndToStart",range),start=priorRange.text.length,end=start+range.text.length);return{start:start,end:end}}function getTextStartEndIndex(){var mainDiv=$($element[0]).find(".keyword_highlight"),sel=getSelectionCharOffsetsWithin(mainDiv);return sel}function getSelectedText(){var text="";if(window.getSelection){text=window.getSelection().toString(),$scope.startEndIndex=getTextStartEndIndex(),getWholeWordIndex($scope.startEndIndex);var nlpWord=$scope.value&&$scope.value.trim()||"";text&&(text=nlpWord.substring($scope.startEndIndex.start,$scope.startEndIndex.end))}else document.selection&&"Control"!=document.selection.type&&(text=document.selection.createRange().text);return text}function getWholeWordIndex(indexObject){var nlpWord=$scope.value&&$scope.value.trim()||"";if(0!==indexObject.start&&" "!==nlpWord.charAt(indexObject.start-1)){var subString1=nlpWord.substring(0,indexObject.start);indexObject.start=subString1.lastIndexOf(" ")+1}if(nlpWord.length!==indexObject.end&&" "!==nlpWord.charAt(indexObject.end+1)){var subString2=nlpWord.substring(indexObject.end);-1!==subString2.indexOf(" ")?indexObject.end=indexObject.end+subString2.indexOf(" "):indexObject.end=indexObject.end+subString2.length}if(nlpWord.length!==indexObject.end&&" "==nlpWord.charAt(indexObject.end+1)){var subString3=nlpWord.substring(indexObject.end);-1!==subString3.indexOf(" ")?indexObject.end=indexObject.end+subString3.indexOf(" "):indexObject.end=indexObject.end+subString3.length}}function isEntityMatched(value,token){var _RegExpArray=[new RegExp("("+token.value+")","i")],isEntitymatched=!1;return $.each(_RegExpArray,function(i,regExpr){return regExpr.test(value)?void(isEntitymatched=!0):token.value&&-1!==token.value.indexOf("$")&&-1!==value.indexOf(token.value)?void(isEntitymatched=!0):void 0}),isEntitymatched}function IsJsonString(str){try{JSON.parse(str)}catch(e){return!1}return!0}function highlightTokens(value,tokens){if(value&&(!tokens||!tokens[0]||"currencyv2"!==tokens[0].fieldType&&"currencyv2"!==tokens[0].type||tokens[0].position)){var _wordsArray=getWordsFromUtterance(value);tokens=tokens||[],tokens.map(function(token,i){if(IsJsonString(token.value)&&(token.value=JSON.parse(token.value)),!(token.value instanceof Array||token.value&&(""+token.value).trim()))return token.color="#ddd",void(token["class"]="color-circle-o");var ifColor="",elseColor="";token.value instanceof Array?(ifColor=$scope.constants.entityColors[i%12+""],elseColor=$scope.constants.entityColors[i%12+""],$.each(token.value,function(j,entityValue){processAndMapColor(token,value,_wordsArray,ifColor,elseColor,entityValue),value="en"==$scope.selectedLanguage||"fr"==$scope.selectedLanguage||"es"==$scope.selectedLanguage||"de"==$scope.selectedLanguage?_wordsArray.join(" "):_wordsArray.join("")})):"string"==typeof token.value?(isEntityMatched(value,token)?(token.color=$scope.constants.entityColors[i%12+""],token["class"]="color-circle"):(token.color=$scope.constants.entityColors[i%12+""],token["class"]="color-circle"),value=value.replace(new RegExp("("+token.value+")","i"),'<span entityID="'+token.componentId+'" style="color:'+token.color+';cursor:pointer;">$1</span>')||value):"object"==typeof token.value&&(ifColor=$scope.constants.entityColors[i%12+""],elseColor=$scope.constants.entityColors[i%12+""],processAndMapColor(token,value,_wordsArray,ifColor,elseColor),value="en"==$scope.selectedLanguage||"fr"==$scope.selectedLanguage||"es"==$scope.selectedLanguage||"de"==$scope.selectedLanguage?_wordsArray.join(" "):_wordsArray.join(""))}),-1!==value.indexOf("<span")?$($element[0]).find(".keyword_highlight").html(value+""):$($element[0]).find(".keyword_highlight").html(getSanitizedText(value+"")),moveTheCursorToEnd($($element[0]).find(".keyword_highlight")[0],!0),$scope.tokens=tokens}}function processAndMapColor(token,value,_wordsArray,ifColor,elseColor,tokenValue){tokenValue=tokenValue||token.value;var wordToReplace,wordIndexArray=[];tokenValue.entityPosition?wordIndexArray=_.uniq(tokenValue.entityPosition.split("-")):token&&token.position&&null!==token.position[0]&&(wordIndexArray=_.uniq(token.position[0].split("-"))),$.each(wordIndexArray,function(i,wordIndex){wordToReplace="en"==$scope.selectedLanguage||"fr"==$scope.selectedLanguage||"es"==$scope.selectedLanguage||"de"==$scope.selectedLanguage?_wordsArray[wordIndex-1]:_wordsArray[wordIndex];var wordObject={};wordObject.value=wordToReplace,isEntityMatched(value,wordObject)?(token.color=ifColor,token["class"]="color-circle"):(token.color=elseColor,token["class"]="color-circle"),"en"==$scope.selectedLanguage||"fr"==$scope.selectedLanguage||"es"==$scope.selectedLanguage||"de"==$scope.selectedLanguage?_wordsArray[wordIndex-1]='<span entityID="'+(token.componentId||token.componentID)+'" style="color:'+token.color+';cursor:pointer;">'+_wordsArray[wordIndex-1]+"</span>":_wordsArray[wordIndex]='<span entityID="'+(token.componentId||token.componentID)+'" style="color:'+token.color+';cursor:pointer;">'+_wordsArray[wordIndex]+"</span>"})}function getWordsFromUtterance(utterance){var _wordsArrayValue;return utterance?"en"==$scope.selectedLanguage||"fr"==$scope.selectedLanguage||"es"==$scope.selectedLanguage||"de"==$scope.selectedLanguage?(_wordsArrayValue=_.without(utterance.split(/([,]| )/)," "),_wordsArrayValue=_.without(_wordsArrayValue,"")):(_wordsArrayValue=utterance.split(""),_wordsArrayValue=_wordsArrayValue):utterance}function handleContextMenu(event,mappedWord){if(!$scope.constants.config.hideMLEE){var parentScope=$scope.$parent;if((!parentScope.intent||_.isEmpty(parentScope.intent)||!parentScope.intent.name)&&parentScope.nlp.text&&parentScope.nlp.text.trim()&&parentScope.intentVerified)return!1;var x=($($element[0]).find(".dropdown-menu").offset(),event.offsetX),y=event.offsetY;getSelectedText()||mappedWord?($($element[0]).find(".dropdown-menu").addClass("rich-editor-dropdown"),PerfectScrollbar.update($(".scrollDiv")[0]),$($element[0]).find(".dropdown-menu").css({top:y+"px",left:x+"px"})):$($element[0]).find(".dropdown-menu").removeClass("rich-editor-dropdown")}}function hideContextMenu(evt){$(evt.target).closest("ul").hasClass("entityfielddropdown")||getSelectedText()||$($element[0]).find(".dropdown-menu").removeClass("rich-editor-dropdown")}var ngModelCtrl=ctrls[0],formCtrl=ctrls[1]||ngModelCtrl.$$parentForm;$scope.mappedEntityNames=[],$scope.form=formCtrl,$scope.value="",$scope.tokens=_.isObject($scope.tokens)?$scope.tokens:[],$scope.api=_.isObject($scope.api)?$scope.api:{},$scope.api.onKeyDown=$scope.api.onKeyDown||angular.noop,$scope.context=$scope.context||{},$scope.selectedLanguage=$workflowService.currentLanguage(),$scope.constants=_constants_,ngModelCtrl.$name=$scope.name,formCtrl.$addControl(ngModelCtrl),$scope.mapEntityToWord=function(entity){var entityID="";if("dialog"==$scope.taskDetails.taskType){if($scope.isEntityAlreadyMapped(entity.name)&&!entity.isArray)return;entityID=entity._id}else{if($scope.isEntityAlreadyMapped(entity.title)&&!entity.isMultiSelect)return;entityID=entity.key}var selectedWord=getSelectedText()||$scope.mappedEntityWord;($scope.context.mapEntityToWord||angular.noop)(selectedWord,entityID),$($element[0]).find(".dropdown-menu").removeClass("rich-editor-dropdown")},focusControls(),$scope.$watch("value",function(newVal,oldVal){var value=newVal?newVal:"";handleControlDisplay(newVal),""===$($element[0]).find(".keyword_highlight").text()&&$($element[0]).find(".keyword_highlight").text(""),ngModelCtrl.$dirty&&(ngModelCtrl.$setViewValue(getTextIncludingTags(newVal)),$scope.isRequired&&ngModelCtrl.$setValidity("required",$scope.isRequired&&!!newVal)),1==value.length?moveTheCursorToEnd($($element[0]).find(".keyword_highlight")[0],!0):newVal&&!oldVal&&moveTheCursorToEnd($($element[0]).find(".keyword_highlight")[0],!0)}),$($element[0]).find(".keyword_highlight").dblclick(function(event){handleContextMenu(event),event.preventDefault()}),$($element[0]).find(".keyword_highlight").mouseup(function(event){handleContextMenu(event),event.preventDefault()}),$($element[0]).find(".keyword_highlight").on("click","span",function(evt){evt.stopImmediatePropagation(),evt.stopPropagation(),evt.preventDefault(),console.log($(this).attr("entityID")),console.log("span");var word=$(this).text();word=word&&word.trim(),$scope.mappedEntityWord=word;var sentence=$($element[0]).find(".keyword_highlight").text();sentence=sentence&&sentence.trim();var start=sentence.indexOf(word),end=start+word.length;$scope.startEndIndex={start:start,end:end},handleContextMenu(evt,!0)}),$scope.$watch("tokens",function(newVal,oldVal){_.isArray(newVal)&&highlightTokens($scope.value,newVal,oldVal),$scope.mappedEntityNames=[],_.isArray($scope.tokens)&&$scope.tokens.length?$.each($scope.tokens,function(i,token){(_.isArray(token.value)&&token.value.length||!_.isArray(token.value)&&token.value)&&$scope.mappedEntityNames.push(token.name)}):$scope.mappedEntityNames=[]},!0),$scope.addSynonym=function(){($scope.context.addSynonym||angular.noop)(getSelectedText())},$scope.addFieldSynonym=function(){($scope.context.addFieldSynonym||angular.noop)(getSelectedText())},$scope.addPattern=function(){($scope.context.addPattern||angular.noop)(getSelectedText())},$scope.addFieldPattern=function(){($scope.context.addFieldPattern||angular.noop)(getSelectedText())},document.getElementsByClassName("keyword_highlight")[0].onpaste=function(e){var pastedText="";
return window.clipboardData&&window.clipboardData.getData?pastedText=window.clipboardData.getData("Text"):e.clipboardData&&e.clipboardData.getData&&(pastedText=e.clipboardData.getData("text/plain")),pastedText=getSanitizedText(pastedText),insertTextAtCursor(pastedText),!1},String.prototype.escapeHTML=function(){var escapeTokens={"<":"&lt;",">":"&gt;"},htmlTags=/[<>]/g;return(""+this).replace(htmlTags,function(match){return escapeTokens[match]})},$($element[0]).find(".keyword_highlight").on("keyup change click keydown",function(evt){return $scope.isDisabled?!1:13==evt.keyCode||$scope.value&&$scope.value.length==$scope.textMaxlength&&8!=evt.keyCode&&46!=evt.keyCode?($scope.api.onKeyDown(evt),!1):(27===evt.keyCode&&$($element[0]).find(".keyword_highlight").text(""),$timeout(function(){ngModelCtrl.$setDirty(),$scope.value=getSanitizedText($($element[0]).find(".keyword_highlight").text())}),void($($element[0]).find(".keyword_highlight").text()||$timeout(function(){handleControlDisplay(""),$scope.value="",focusControls()})))}),$timeout(function(){$($element.find(".keyword_highlight")[0]).trigger("click")}),getTextIncludingTags=function(name){return name.replace(/&lt;/g,"<").replace(/&gt;/g,">")},document.addEventListener?$element[0].addEventListener("contextmenu",function(e){handleContextMenu(e),e.preventDefault()},!1):$element[0].attachEvent("oncontextmenu",function(){handleContextMenu(e),window.event.returnValue=!1}),$(document).off("click.train").on("click.train",hideContextMenu),ngModelCtrl.$render=function(){$scope.value!=ngModelCtrl.$viewValue&&($scope.value=ngModelCtrl.$viewValue,handleControlDisplay(ngModelCtrl.$viewValue))},$scope.isEntityAlreadyMapped=function(name){return-1!==$.inArray(name,$scope.mappedEntityNames)},$scope.getColorBasedOnMap=function(entity){var name="dialog"==$scope.taskDetails.taskType?entity.name:entity.title,taskType=$scope.taskDetails.taskType;return $scope.isEntityAlreadyMapped(name)&&("dialog"==taskType&&!entity.isArray||"dialog"!==taskType&&!entity.isMultiSelect)?"#ddd":"#333"},$scope.getClassBasedOnMap=function(entity){var name="dialog"==$scope.taskDetails.taskType?entity.name:entity.title,taskType=$scope.taskDetails.taskType;return $scope.isEntityAlreadyMapped(name)&&("dialog"==taskType&&!entity.isArray||"dialog"!==taskType&&!entity.isMultiSelect)?"entityDisable":"entityEnable"}}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("runbotConfig",function(){return{restrict:"EAQ",scope:{onComplete:"&",wfType:"@",botConfig:"@",updateConfig:"=",cb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/runbot-config/runbot-config.html",controller:["$scope","$element","$timeout","$rootScope","$workflowService","BTFlowtaskService","NotificationService","BTStreamsService","$modal","urlutil","env_conf","$applicationService","i18n",function($scope,$element,$timeout,$rootScope,$workflowService,BTFlowtaskService,NotificationService,BTStreamsService,$modal,urlutil,env_conf,$applicationService,i18n){function startSaving(className){$element.find(className).addClass("fa fa-refresh fa-spin"),$scope.saveStatus=i18n.i18nString("saving")}function finishSaving(className,isError){$element.find(className).removeClass("fa fa-refresh fa-spin"),"error"===isError?($scope.saveStatus=i18n.i18nString("saving_failed"),$element.find(className).addClass("fa fa-times")):($scope.saveStatus=i18n.i18nString("saved_successfully"),$element.find(className).addClass("fa fa-check")),setTimeout(function(){$element.find(className).removeClass("fa fa-check fa-times")},3e3),setTimeout(function(){$scope.saveStatus=""},2800)}$scope.serviceNodes=[],$scope.config={},$scope.saveStatus="",$scope.initLoading=!0;var _selectedStream=$workflowService.selectedStream(),_dialogId="";"string"==typeof $scope.botConfig&&($scope.botConfig=JSON.parse($scope.botConfig)),$scope.config.mode=$scope.botConfig.enableTryoutMode,$scope._constants_=$rootScope._constants_,$scope.cb.updateServiceNodes=function(res){"string"==typeof $scope.botConfig&&($scope.botConfig=JSON.parse($scope.botConfig)),$scope.serviceNodes=res.nodes,_dialogId=res.dialogId,$.each($scope.serviceNodes,function(i,node){$.each(node.sampleResponse,function(j,response){response.isDefault&&(node.selectedResponse=response.name)})}),$.each($scope.serviceNodes,function(i,node){if($scope.botConfig[node._id]){var result=$.grep(node.sampleResponse,function(e){return e.name===$scope.botConfig[node._id]});result.length>0&&result[0].isDefault&&(node.selectedResponse=$scope.botConfig[node._id])}}),0===$scope.serviceNodes.length&&($scope.botConfig={enableTryoutMode:!1}),$scope.config.mode=$scope.botConfig.enableTryoutMode,$scope.saveConfigurations()},$scope.saveConfigurations=function(){var _payload={};_payload.enableTryoutMode=$scope.config.mode,$scope.config.mode&&$.each($scope.serviceNodes,function(j,node){_payload[node._id]=node.selectedResponse}),$scope.initLoading||startSaving(".runbotConfigSave"),BTFlowtaskService.setDialogTaskBotConfiguration(_selectedStream._id,_dialogId,_payload).then(function(res){res&&res.data&&($scope.botConfig=res.data,$scope.updateConfig("updateBotConfig",res&&res.data),$scope.initLoading?$scope.initLoading=!1:setTimeout(function(){finishSaving(".runbotConfigSave")},1e3))},function(error){if($scope.initLoading?$scope.initLoading=!1:setTimeout(function(){finishSaving(".runbotConfigSave","error")},1e3),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}]}})}(angular),function(ng){var _sampleBotsComponent=ng.module("bt-components");_sampleBotsComponent.directive("sampleBotConfiguration",function(){return{restrict:"EA",scope:{onCancel:"=",options:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/sample-bots/sample-bot-configuration.html",controller:"sampleBotConfigurationCtrl"}}),_sampleBotsComponent.controller("sampleBotConfigurationCtrl",["$scope","env_conf","BTStreamsService","BTFlowtaskService","$applicationService","$workflowService","BTFileUploadService","NotificationService","$location","$rootScope","form_util","i18n","mixPanel","$timeout","$sce",function($scope,env_conf,BTStreamsService,BTFlowtaskService,$applicationService,$workflowService,BTFileUploadService,NotificationService,$location,$rootScope,form_util,i18n,mixPanel,$timeout,$sce){function getBase64(file){var _reader=new FileReader;_reader.onloadend=function(loadEvent){$scope.ImgString=_reader.result},_reader.readAsDataURL(file)}function getStreamIconData(newIconOverride,hideNotify){var url;url=env_conf["components-source"],getFileObject(url+$scope.selectedIcon.uploadPath,function(fileObject){$scope.aboutBotData.iconFile=fileObject;var showNotification=!hideNotify&&newIconOverride;$scope.uploadStreamIcon(showNotification,newIconOverride)})}function prepareSampleBotVariables(variables){var sampleBotVariables={};return variables&&variables.length&&$.each(variables,function(i,variable){sampleBotVariables[variable.key]=variable}),$scope.sampleBotVariables=sampleBotVariables,sampleBotVariables}function setTabs(options){$scope.stream.solutionBotSettings?($scope.stream.solutionBotSettings.configInstURL&&$scope.stream.solutionBotSettings.configInstURL.startsWith("www.")&&($scope.stream.solutionBotSettings.configInstURL="http://"+$scope.stream.solutionBotSettings.configInstURL),options&&"configure"===options.id?($scope.sections[1].active=!0,$scope.sections[0].active=!1):($scope.sections[0].active=!0,$scope.sections[1].active=!1),$scope.sections[0].enabled=!0,$scope.sections[1].enabled=!0):($scope.sections[0].active=!1,$scope.sections[1].enabled=!0,$scope.sections[1].active=!0)}function goHome(){$workflowService.navigateTabIndex(".tasks-pane"),$rootScope.$emit("selectOrChangeBot",$scope.stream),$scope.onCancel(),$(".bootbox-close-button").trigger("click")}function reloadApp(){var stream=$workflowService.selectedStream();$scope.onCancel(!0),$scope.$emit("loadBots",stream)}if($scope.char_remaining=i18n.i18nString("char_remaining"),$scope.selectedSampleBot=$workflowService.selectedSampleBot(),$scope.stream=$workflowService.selectedStream(),$scope.stream.solutionBotSettings&&$scope.stream.solutionBotSettings.configInstFileId?($scope.showPdfLoading=!0,$scope.planeText=!1):$scope.planeText=!0,$scope.stream.demoVideoLink&&$scope.stream.demoVideoLink.length&&$scope.stream.demoVideoLink[0]){var videoPaths=$scope.stream.demoVideoLink[0].split("/"),vimeoId=videoPaths[videoPaths.length-1];$scope.demoVideoLink=$sce.trustAsResourceUrl("https://player.vimeo.com/video/"+vimeoId)}$scope.mixpanelEvents={instructionsRead:!1},$scope.backArrow=env_conf["context-url"]+"/assets/landingImages/backArrow.svg",$scope.cancel=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.sections=[{name:"instructionsForm",active:!1,enabled:!1},{name:"aboutBotForm",active:!1,enabled:!1,formName:"aboutBotForm"}],$scope.closeDropdown=function(){$("body").trigger("click")},$scope.defaultBotIcons=[{id:"icon1",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-1.png",uploadPath:"/assets/botIcons/updatedIcons/icon-1.png"},{id:"icon2",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-2.png",uploadPath:"/assets/botIcons/updatedIcons/icon-2.png"},{id:"icon3",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-3.png",uploadPath:"/assets/botIcons/updatedIcons/icon-3.png"},{id:"icon4",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-4.png",uploadPath:"/assets/botIcons/updatedIcons/icon-4.png"},{id:"icon5",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-5.png",uploadPath:"/assets/botIcons/updatedIcons/icon-5.png"},{id:"icon6",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-6.png",uploadPath:"/assets/botIcons/updatedIcons/icon-6.png"},{id:"icon7",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-7.png",uploadPath:"/assets/botIcons/updatedIcons/icon-7.png"},{id:"icon8",path:env_conf["context-url"]+"/assets/botIcons/smallIcons/icon-8.png",uploadPath:"/assets/botIcons/updatedIcons/icon-8.png"}],$scope.customStreamData={},$scope.selectedIcon=JSON.parse(JSON.stringify($scope.defaultBotIcons[0]));var getFileBlob=function(url,cb){var xhr=new XMLHttpRequest;xhr.open("GET",url),xhr.responseType="blob",xhr.addEventListener("load",function(){cb(xhr.response)}),xhr.send()},blobToFile=function(blob,name){return blob.lastModifiedDate=new Date,blob.name=name,blob},getFileObject=function(filePathOrUrl,cb){getFileBlob(filePathOrUrl,function(blob){cb(blobToFile(blob,"newBot.png"))})};$scope.resetIconUpload=function(){$scope.selectedIcon=JSON.parse(JSON.stringify($scope.defaultBotIcons[0])),$scope.resetingIcon=!0,$scope.selectNewDefaultBotIcon($scope.selectedIcon,!0),NotificationService.notify("Icon reset successful","success"),$scope.customStreamData={},$("#customStreamData")&&$("#customStreamData").length&&($("#customStreamData")[0].value=null)},$scope.loadStreamIcon=function(){if($scope.customStreamData&&$scope.customStreamData.iconFile&&$scope.customStreamData.iconFile.name){var _ext=$scope.customStreamData.iconFile.name.substring($scope.customStreamData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),$scope.imageExtensionError=!0,void $scope.resetIconUpload();$scope.imageExtensionError=!1;var reader=new FileReader;reader.onload=function(loadEvent){$scope.$apply(function(){$scope.customStreamData.iconUploading=!0,$scope.customStreamData.uploadedIcon=loadEvent.target.result,$scope.confirmUploadOfNewIcon()})},reader.readAsDataURL($scope.customStreamData.iconFile)}},$scope.confirmUploadOfNewIcon=function(){$scope.selectedIcon.id="custom",$scope.aboutBotData.iconFile=$scope.customStreamData.iconFile,$scope.uploadStreamIcon(!0,!0,!0)},$scope.selectNewDefaultBotIcon=function(iconObj,hideNotify){$scope.selectedIcon=JSON.parse(JSON.stringify(iconObj)),getStreamIconData(!0,hideNotify)},getStreamIconData(),$scope.uploadStreamIcon=function(showNotification,newIconOverride,customIcon){if($scope.aboutBotData&&$scope.aboutBotData.iconFile&&$scope.aboutBotData.iconFile.name){var _ext=$scope.aboutBotData.iconFile.name.substring($scope.aboutBotData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),$scope.fileExtensionError=!0,void $scope.resetIconUpload();$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.aboutBotData.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.aboutBotData.iconFile.name,fileId:response.data.fileId};customIcon?$scope.defaultImg=$scope.customStreamData.uploadedIcon:$scope.defaultImg=$scope.selectedIcon.path,$scope.aboutBotData.icon=fileUploaded,showNotification&&NotificationService.notify(i18n.i18nString("bot_icon_uploaded_successfully"),"success"),getBase64($scope.aboutBotData.iconFile),$scope.iconUploading=!1,$scope.customStreamData.iconUploading=!1},function(response){showNotification&&NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.iconUploading=!1})}},$("embed").ready(function(){setTimeout(function(){$scope.showPdfLoading=!1,$("embed").removeClass("displayBlock")},1e3)}),$scope.initDate=function(index){$timeout(function(){var container=$("#dateInstalPicker"+index);daterangepickerInput=container.daterangepicker({singleDatePicker:!0,showDropdowns:!0,opens:"right",parentEl:".setupSolBotBody",customClass:"bot-dash-datepicker",locale:{applyLabel:i18n.i18nString("apply"),cancelLabel:i18n.i18nString("cancel")}})},300)},$scope.getSampleBotVariables=function(){BTFlowtaskService.getsSampleBotAllVariables($applicationService.userInfo().userId,$scope.stream.sampleBotId,$workflowService.selectedStream()._id).then(function(res){prepareSampleBotVariables(res.data.variables)},function(err){console.log("Failed to get sampleBot variables")})},$scope.getBotVariables=function(botid){BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,botid).then(function(res){$workflowService.botEnvVariables(res.data.variables);var _botVariables=res.data.variables;if($scope.botVariables=[],$scope.constants=$rootScope._constants_,$.each(_botVariables,function(i,variable){delete variable.createdBy,delete variable.createdOn,delete variable.modifiedBy,delete variable.modifiedOn,delete variable.__v,delete variable._id,delete variable.streamId,"askOnInstall"===variable.scope&&(variable.value=""),"env"===variable.variableType&&$scope.botVariables.push(variable)}),$scope.botVariables&&$scope.botVariables.length){$scope.sections[2]={name:"variablesForm",active:!1,enabled:!1,formName:"variablesForm"},$scope.sections[2].enabled=!1;_.find($scope.botVariables,function(variable){return"prePopulated"===variable.scope||"askOnInstall"===variable.scope?($scope.sections[2].enabled=!0,variable):void 0})}$scope.tempBotVariables=angular.copy($scope.botVariables)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_fetch_var"),"error")})},$scope.getBotVariables($scope.stream._id),$scope.getSampleBotVariables(),setTabs($scope.options),$scope.options||($scope.options={}),$scope.options.setTabs=setTabs,$scope.aboutBotData={},$scope.aboutBotData.name=$scope.stream.name,$scope.aboutBotData.color=$scope.stream.color,$scope.enabledSections=function(){return _.filter($scope.sections,function(section){return section.enabled===!0})},$scope.getActiveSectionIndex=function(){return _.findIndex($scope.sections,function(section){return section.active===!0})},$scope.canShowBack=function(){return $scope.enabledSections().length>0&&$scope.getActiveSectionIndex()>0?!0:!1},$scope.canShowNext=function(){return $scope.enabledSections().length>0&&$scope.getActiveSectionIndex()<$scope.enabledSections().length-1?!0:!1},$scope.canShowFinish=function(){return $scope.getActiveSectionIndex()===$scope.enabledSections().length-1?!0:!1},$scope.validateSection=function(section){return section&&section.formName&&$scope[section.formName]&&$scope[section.formName].$invalid?(form_util.touch($scope[section.formName]),!1):!0},$scope.next=function(){$scope.disableNext=!0;var index=$scope.getActiveSectionIndex(),sectionIndex=index+1;if(2===sectionIndex);sectionIndex<$scope.sections.length&&$scope.navigate($scope.sections[sectionIndex])},$scope.navigate=function(section){if($scope.sections.forEach(function(section){section.active=!1}),section.active=!0,!$scope.mixpanelEvents.instructionsRead&&section&&"aboutBotForm"===section.formName){$scope.mixpanelEvents.instructionsRead=!0;var data={action:"mixPanelEvent",payload:{event:"VA - New Bot instructions read",eventPayload:{Category:"Activation","Sub Category":"Conversation - Dialog Task",Level:"ONBOARDING AND ACTIVATION","VA App Name":$scope.aboutBotData.name,streamId:$scope.aboutBotData._id},product:"Conversational-App"}};$rootScope.$broadcast("mixPanelEvent",data)}$("html, body").animate({scrollTop:0},"fast"),$scope.disableNext=!1},$scope.stream.demoVideoLink||!$scope.stream.solutionBotSettings||$scope.stream.solutionBotSettings.configInstURL||$scope.next(),$scope.deleteStreamIcon=function(){$scope.aboutBotData.iconFile=null,$scope.aboutBotData.icon=null,$("#sbots_iconFile").val("")},$scope.isFormValid=function(){return!$scope.aboutBotForm.$invalid},$scope.installSampleBot=function(){if($scope.validateSection($scope.sections[1])&&(!$scope.sections[2]||!$scope.sections[2].enabled||$scope.validateSection($scope.sections[1]))){var installSampleBotData={};installSampleBotData.name=$scope.aboutBotData.name,installSampleBotData.color=$scope.aboutBotData.color,$scope.aboutBotData.iconType||(installSampleBotData.icon=$scope.aboutBotData.icon.fileId),$scope.botInstalling=!0;var variablePayload=$scope.botVariables;BTStreamsService.addbulkBotVariables($applicationService.userInfo().userId,$scope.stream._id,variablePayload).then(function(res){BTStreamsService.editStream($workflowService.selectedStream()._id,installSampleBotData).then(function(response){var data={action:"mixPanelEvent",payload:{event:"VA - New Bot Icon configured",eventPayload:{Category:"Activation","Sub Category":"Activation - VA",Level:"ONBOARDING AND ACTIVATION","VA App Name":$scope.aboutBotData.name,streamId:$scope.aboutBotData._id,"VA Icon config":"Generic"},product:"Conversational-App"}};$scope.aboutBotData.iconType||(data.payload.eventPayload["VA Icon config"]="Custom"),$rootScope.$broadcast("mixPanelEvent",data),$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),response.data)),BTStreamsService.updateMPStream($workflowService.selectedStream()._id,installSampleBotData).then(function(response){try{var data2=angular.copy(data);data2.payload.event="VA - New Bot Initiated",data2.payload.eventPayload["VA - Inititiation Mode"]="Store",$rootScope.$broadcast("mixPanelEvent",data2)}catch(e){console.log("instalation event failed")}NotificationService.notify(i18n.i18nString("bot_installed_success_noty"),"success"),$location.path(window.appConfig.CONTEXT_PATH),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data),$scope.$emit("streamUpdate"),reloadApp()}),$scope.botInstalling=!0},function(res){NotificationService.notify(res.data.errors[0].msg,"error"),$scope.botInstalling=!1})},function(res){NotificationService.notify(res.data.errors[0].msg,"error"),$scope.botInstalling=!1})},function(err){$scope.botInstalling=!1,NotificationService.notify(i18n.i18nString("bot_installation_err"),"error")})}},$scope.goToHome=function(){goHome();"<p><i class='fa fa-exclamation-circle fa-2x' aria-hidden='true' style='color: #009dac;'></i></p> "+i18n.i18nString("sample_bot_cofig_incomplete")}}])}(angular),function(ng){var _sampleBotsComponent=ng.module("bt-components");_sampleBotsComponent.directive("btSelectSampleBots",function(){return{restrict:"EA",scope:{onCancel:"&"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/sample-bots/select-sample-bot.html",controller:"btSampleBotsCtrl"}}),_sampleBotsComponent.controller("btSampleBotsCtrl",["$scope","BTStreamsService","$workflowService","env_conf","$rootScope","$location","$timeout","i18n",function($scope,BTStreamsService,$workflowService,env_conf,$rootScope,$location,$timeout,i18n){function getSamplebots(){BTStreamsService.getSampleBots().then(function(res){$scope.fetchingSampleBots=!1,$scope.sampleBots=res.data},function(err){$scope.fetchingSampleBots=!1,NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}function getStreamById(id){BTStreamsService.getBTStream(id).then(function(res){NotificationService.notify(res.data.name+i18n.i18nString("installed_succesfully"),"success"),$scope.isGlobalWorkProgress=!1,$workflowService.selectedSampleBot(res.data),$workflowService.selectedStream(res.data),$scope.updateStep(3)},function(err){NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}$scope.defaultImg=env_conf["context-url"]+"/img/newBot.png",$scope.fetchingSampleBots=!0,getSamplebots(),$scope.allBots=$workflowService.streamsAll(),$scope.footerInfoTitle=i18n.i18nString("sampleBot_choose"),$scope.footerHeaderId="bt-select-samplebot",$scope.footerPanelId="bt-select-samplebot-panel",$scope.loaderMessage=i18n.i18nString("installing_label"),$scope.backArrow=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.smartInstall=env_conf["context-url"]+"/assets/icons/smartInstall.svg",$scope.searchBotIntl=function(){$timeout(function(){$(".splScrollTop").scrollTop(0)},350)},$scope.updateStep=function(stepNo){$scope.$emit("updateStep",stepNo)},$(".searchBar").click(function(){$(this).hasClass("fa-remove")?($(".chooseBotInstall").removeClass("hide"),$(this).removeClass("fa-remove"),$(".botListSearch").removeClass("searchExpand"),$(this).addClass("fa-search"),$scope.search=""):($(".chooseBotInstall").addClass("hide"),$(this).addClass("fa-remove"),$(this).removeClass("fa-search"),$(".botListSearch").addClass("searchExpand"),$timeout(function(){$(".botListSearchInput").focus()},350))}),$scope.installSampleBot=function(bot){$scope.selectedSampleBot=bot,$scope.isWorkProgress=!0,BTStreamsService.installSampleBot(bot.id).then(function(res){$workflowService.currentLanguage($scope.selectedSampleBot.defaultLanguage),getStreamById(res.data._id),$scope.isWorkProgress=!1,$scope.$emit("updateChecklist","configure")},function(err){NotificationService.notify(err.data.errors[0].msg,"error"),$scope.isWorkProgress=!1})}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("sampleTempalets",function(){return{restrict:"EA",scope:{selectedChannel:"=",selectedCallback:"=",demoTemplates:"=?",tabIndex:"=",resetTempCb:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/sample-js-tempalets/sample-js-tempalets.html",controller:["$scope","$timeout","NotificationService","BTStreamsService","$workflowService","i18n",function($scope,$timeout,NotificationService,BTStreamsService,$workflowService,i18n){function getTamplets(){if($scope.demoTemplates){var templates=[];if($.each($scope.demoTemplates,function(i,tempalet){"web-sdk"==tempalet.channel&&(tempalet.channel="rtm"),tempalet.channel==$scope.selectedChannel&&templates.push(tempalet)}),templates&&templates.length>0){var sampleTemplateobj={};sampleTemplateobj.type="Channel Templates",sampleTemplateobj.template=templates,$scope.channelTempalets.push(sampleTemplateobj)}}if($scope.customLibraryTemplates&&$scope.customLibraryTemplates.length>0){var customTemplateObj={};customTemplateObj.type="Custom Templates",customTemplateObj.template=$scope.customLibraryTemplates,$scope.channelTempalets.push(customTemplateObj)}}function decodeJS(_obj){try{return decodeURIComponent(_obj)}catch(e){return _obj}}if($scope.channelTempalets=[],$scope.selectedTemplate={},$scope.$watch("tabIndex",function(){$scope.channelTempalets=[],getTamplets()}),$scope.$watch("selectedChannel",function(newVal,oldVal){newVal!==oldVal&&($scope.selectedTemplate.name="",$scope.getchannelTempalets())}),$scope.getchannelTempalets=function(tab){$scope.channelTempalets=[],getTamplets()},$scope.selectedTemplate)var _prevTempaletType=angular.copy($scope.selectedTemplate.name);$scope.resetTempCb&&($scope.resetTempCb.resetTemplate=function(){$scope.selectedTemplate.name=""}),$scope.selectTemplateJSCode=function(template1){$scope.selectedTemplate.name=angular.copy(template1.name),_prevTempaletType!=$scope.selectedTemplate.name&&NotificationService.alert(i18n.i18nString("current_msg_overwritten"),[$scope.saveTemplateType,$scope.revertTemplateType],{okText:i18n.i18nString("ok_label")})},$scope.revertTemplateType=function(){""!==_prevTempaletType&&($scope.selectedTemplate.name=angular.copy(_prevTempaletType))},$scope.saveTemplateType=function(){$scope.selectedChannel?$.each($scope.channelTempalets,function(i,tempaletsByType){var currentTem=_.find(tempaletsByType.template,function(item){return item.name==$scope.selectedTemplate.name?(item.templatType=tempaletsByType.type,item):void 0});currentTem&&(_prevTempaletType=currentTem.name,"Custom Templates"===currentTem.templatType?$scope.selectedCallback=decodeJS(currentTem.template):$scope.selectedCallback=decodeJS(currentTem.sample.js))}):NotificationService.notify(i18n.i18nString("please_select_chnl"),"warning")}}]}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("saveStatus",function(){return{restrict:"EA",scope:{saveInProgress:"=",saveFrom:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/save-status/save-status.html",controller:["$scope","$timeout","$workflowService",function($scope,$timeout,$workflowService){$scope.saveSuccessCB=!1,$scope.$watch("saveInProgress",function(newVal,oldVal){$scope.saveInProgress&&($scope.saveSuccessCB=!0,$scope.savedTarget=$workflowService.saveFrom(),$("#saveSuccessCB").fadeIn("fast",function(){}),$timeout(function(){$("#saveSuccessCB").fadeOut("slow",function(){$scope.saveSuccessCB=!1})},5e3))})}]}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("whenScroll",function($timeout){return{restrict:"EA",link:function(scope,el,attrs){var raw=el[0],atBottom=!1,atTop=!0,_bufferSize=20;el.unbind("scroll").bind("scroll",function(){atTop&&raw.scrollTop+raw.offsetHeight>=.9*raw.scrollHeight?!scope.loadingBatch&&scope.clientNodes&&scope._originalData.length-10<=scope.clientNodes[scope.clientNodes.length-1].seq&&scope.isDataAvailable?(scope.loadingBatch=!0,scope.loadingClientBatch=!1,scope.$apply(attrs.whenScroll)):!scope.loadingClientBatch&&scope._originalData.length>=scope.clientNodes.length&&(scope.loadingClientBatch=!0,$timeout(function(){scope.pushBatch(_bufferSize,scope.clientNodes[scope.clientNodes.length-1].seq),atBottom=!0})):atBottom&&0===raw.scrollTop&&$timeout(function(){scope.popBatch(_bufferSize,scope.clientNodes[0].seq),atTop=!0})}),scope.setToInitialContion=function(){scope.loadingClientBatch=!1}}}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("searchOptions",function(){return{restrict:"EA",scope:{searchData:"=",searchCallback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/search-options/search-options.html",controller:["$scope","$timeout","i18n","env_conf","jsEvents",function($scope,$timeout,i18n,env_conf,jsEvents){$scope.currentNodeNum=0,$scope.searchDataTemp=[],$scope.searchStr="",$scope.searchTextInfo="";var _prevSearchTxt="";$scope.$watch("searchData",function(oldVal,newVal){$scope.currentNodeNum=0}),$scope.updatedData=function(){jsEvents.postMessageToChildIframes("dialogSearchFocus","#dialogIFrame",{})},$scope.searchForNodes=function(){return _prevSearchTxt===$scope.searchStr?void $scope.nextSearch():(_prevSearchTxt=$scope.searchStr,$scope.searchDataTemp=[],$scope.currentNodeNum=0,$scope.searchTextInfo="0 of 0",void($scope.searchStr.length>0&&$scope.searchData&&$scope.searchData.length>0?($.each($scope.searchData,function(k,obj){obj.val&&-1!==obj.val.toLowerCase().indexOf($scope.searchStr.toLowerCase())&&$scope.searchDataTemp.push(obj)}),$scope.searchDataTemp.length>0?$scope.searchTextInfo="1 of "+$scope.searchDataTemp.length:$scope.searchTextInfo="0 of 0","function"==typeof $scope.searchCallback&&$scope.searchCallback($scope.searchStr,$scope.searchDataTemp[0]?$scope.searchDataTemp[0].key:"",$scope.searchDataTemp[0]?$scope.searchDataTemp[0].val:"")):0===$scope.searchStr.length&&$scope.clearSearch()))},$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.chevronCircleUp=env_conf["context-url"]+"/assets/icons/chevronCircleUp.svg",$scope.chevronCircleDown=env_conf["context-url"]+"/assets/icons/chevronCircleDown.svg",$scope.prevSearch=function(){$scope.currentNodeNum>0&&($scope.currentNodeNum--,$scope.searchCallback($scope.searchStr,$scope.searchDataTemp[$scope.currentNodeNum].key,$scope.searchDataTemp[$scope.currentNodeNum]?$scope.searchDataTemp[$scope.currentNodeNum].val:"")),$scope.searchDataTemp.length>0&&($scope.searchTextInfo=$scope.currentNodeNum+1+i18n.i18nString("of")+$scope.searchDataTemp.length)},$scope.nextSearch=function(){$scope.currentNodeNum<$scope.searchDataTemp.length-1&&($scope.currentNodeNum++,$scope.searchCallback($scope.searchStr,$scope.searchDataTemp[$scope.currentNodeNum].key,$scope.searchDataTemp[$scope.currentNodeNum]?$scope.searchDataTemp[$scope.currentNodeNum].val:"")),$scope.searchDataTemp.length>0&&($scope.searchTextInfo=$scope.currentNodeNum+1+i18n.i18nString("of")+$scope.searchDataTemp.length)},$scope.clearSearch=function(){$scope.searchDataTemp=[],$scope.currentNodeNum=0,$scope.searchTextInfo="",$scope.searchStr="",$scope.searchCallback("","",""),$timeout(function(){$("#dialogSearchIn").focus()},200)},$scope.collapseSearch=function(){$scope.searchStr||($scope.expandview=!1)},$scope.expandSearch=function(){$scope.expandview=!0,$timeout(function(){$("#dialogSearchIn").focus()},200)}}]}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("btSelect2",["i18n",function(i18n){return{restrict:"EA",scope:{data:"=",defaultValue:"@?",onSelection:"&"},controller:function($scope){$scope.select2config={allowClear:!0,placeholder:$scope.defaultValue||i18n.i18nString("select_a_key")},$scope.keySelected=function(key){$scope.onSelection({data:key}),$scope.showList=!1,$scope.currentValue=""},$scope.resetValue=function(){$scope.currentValue="",$scope.showList=!$scope.showList}},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/selectify2/selectify2.html",link:function($scope,$element,$attrs){}}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("sendContact",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/send-contact/send-contact.html",scope:{callback:"="},controller:["$scope","$workflowService","BTStreamsService",function($scope,$workflowService,BTStreamsService){$scope.streamObject=$workflowService.selectedStream(),$scope.getMpStream=function(){BTStreamsService.getMPStream($scope.streamObject._id).then(function(res){res.data&&($scope.streamObject.sendVcf=res.data.sendVcf+"")})},$scope.getMpStream(),$scope.callback.updateMpStream=function(){var mpPostData={};mpPostData._id=$scope.streamObject._id,mpPostData.name=$scope.streamObject.name,mpPostData.sendVcf="true"===$scope.streamObject.sendVcf,BTStreamsService.updateMPStream($scope.streamObject._id,mpPostData).then(function(response){$scope.streamObject.sendVcf=response.sendVcf;
},function(error){})}}]}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("slideBottom",function($timeout){return{restrict:"EA",link:function(scope,el,attrs){var dropDownToogle=0;$(el).on("click",function(){dropDownToogle=$(el).siblings(".dropdown-menu").height(),setTimeout(function(){$(el).siblings(".dropdown-menu").animate({scrollTop:0}),$(el).parents(".ps-container").first().animate({scrollTop:$(el).parents(".ps-container").first().height()+dropDownToogle})},200)})}}})}(angular),function(ng){var _smartBotsComponent=ng.module("bt-components");_smartBotsComponent.directive("btSelectSmartBots",function(){return{restrict:"EA",scope:{onCancel:"&"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/smart-bots/select-smart-bot.html",controller:"btSmartBotsCtrl"}}),_smartBotsComponent.controller("btSmartBotsCtrl",["$scope","BTStreamsService","$workflowService","env_conf","$rootScope","$location","$timeout","NotificationService","i18n",function($scope,BTStreamsService,$workflowService,env_conf,$rootScope,$location,$timeout,NotificationService,i18n){function getSmartbots(id){BTStreamsService.getSmartBots().then(function(res){$scope.fetchingSmartBots=!1,$scope.smartBots=res.data},function(err){$scope.fetchingSmartBots=!1,NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}function getStreamById(id){BTStreamsService.getBTStream(id).then(function(res){$scope.isGlobalWorkProgress=!1,$workflowService.selectedSmartBot(res.data),$workflowService.selectedStream(res.data),$scope.updateStep(6)},function(err){NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}$scope.defaultImg=env_conf["context-url"]+"/img/newBot.png",$scope.fetchingSmartBots=!0,$scope.allBots=$workflowService.streamsAll(),$scope.searchBotIntl=function(){$timeout(function(){$(".splScrollTop").scrollTop(0)},350)},getSmartbots(),$scope.loaderMessage=i18n.i18nString("installing_label"),$scope.backArrow=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.smartInstall=env_conf["context-url"]+"/assets/icons/smartInstall.svg",$scope.updateStep=function(stepNo){$scope.$emit("updateStep",stepNo,null,null,null,$scope.smartBotId)},$(".searchBar").click(function(){$(this).hasClass("fa-remove")?($(".chooseBotInstall").removeClass("hide"),$(this).removeClass("fa-remove"),$(".botListSearch").removeClass("searchExpand"),$(this).addClass("fa-search"),$scope.search=""):($(".chooseBotInstall").addClass("hide"),$(this).addClass("fa-remove"),$(this).removeClass("fa-search"),$(".botListSearch").addClass("searchExpand"),$timeout(function(){$(".botListSearchInput").focus()},350))}),$scope.installSmartBot=function(bot){$scope.selectedSmartBot=bot,$scope.isWorkProgress=!0,BTStreamsService.installSmartBot(bot.id).then(function(res){$scope.smartBotId=res.data.sbStreamId,NotificationService.notify(res.data.name+i18n.i18nString("installed_succesfully"),"success"),getStreamById(res.data._id),$scope.isWorkProgress=!1},function(err){NotificationService.notify(err.data.errors[0].msg,"error"),$scope.isWorkProgress=!1})}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("statusLoader",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/status-loader/status-loader.html",controller:["$scope","$rootScope",function($scope,$rootScope){$scope.isGlobalWorkProgress=!1;var updateGlobalWorkProgressDestroy=$rootScope.$on("updateGlobalWorkProgress",function(evt,status){$scope.isGlobalWorkProgress=status});$scope.$on("$destroy",function(){updateGlobalWorkProgressDestroy&&updateGlobalWorkProgressDestroy()})}]}})}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("stepProgress",["$timeout",function($timeout){return{restrict:"EA",scope:{steps:"=",activeStepNumber:"=",onClick:"="},controller:function($scope){},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/step-progress/step-progress.html",link:function($scope,$ele,$attrs){$timeout(function(){var width=100/$scope.steps;$($ele[0]).find(".step-progress-step").css("width",width+"%")})}}}])}(angular),function(ng){angular.module("bt-components").directive("sumoSelect",["$timeout","i18n","$rootScope",function($timeout,i18n,$rootScope){return{restrict:"EA",scope:{name:"=?",disabled:"=?",options:"=",value:"=",titleKey:"@?",valueKey:"@?",placeholder:"@?",callback:"=",search:"=?",sanitize:"=?",subtype:"@?"},controller:["$scope","$rootScope",function($scope,$rootScope){var tagBody="(?:[^\"'>]|\"[^\"]*\"|'[^']*')*",tagOrComment=new RegExp("<(?:!--(?:(?:-*[^->])*--+|-?)|script\\b"+tagBody+">[\\s\\S]*?</script\\s*|style\\b"+tagBody+">[\\s\\S]*?</style\\s*|/?[a-z]"+tagBody+")>","gi");$scope.removeTags=function(html){if(html){var oldHtml;do oldHtml=html,html=html.replace(tagOrComment,"");while(html!==oldHtml);return html.replace(/>/g,"&gt;"),html.replace(/</g,"&lt;")}},$scope.options.forEach(function(val){val[$scope.titleKey]=$scope.removeTags(val[$scope.titleKey]),val[$scope.valueKey]=$scope.removeTags(val[$scope.valueKey]),$scope.subtype&&val&&val.id&&val.id.startsWith("ivr")&&"ivrVoice"!==val.id&&(val.name=val.name.concat(" "+i18n.i18nString("webhook")))}),$scope.titleKey=$scope.titleKey||"name",$scope.valueKey=$scope.valueKey||"value",$scope.channelFilter=function(input){return"googleactions"===input?"Google Assistant":"hangoutchat"===input?"Hangouts Chat":input}}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/sumo-select/sumo-select.html",link:function($scope,$ele,$attrs,ngModelCtrl){function render(){$($ele[0]).find("select").SumoSelect(config)}$scope.callback&&($scope.callback.selectAllByDefault=function(){setTimeout(function(){var a=$($ele[0]).find("select")[0].sumo;a.selectAll(),$($ele[0]).find(".btnOk").trigger("click"),$scope.optionsLoaded=!1},150)});var config={placeholder:$scope.placeholder,csvDispCount:2,okCancelInMulti:!0,selectAll:!0,captionFormatAllSelected:$scope.placeholder,search:$scope.search,locale:[i18n.i18nString("ok_label"),i18n.i18nString("cancel"),i18n.i18nString("select_all")],searchText:i18n.i18nString("search_label")};$scope.$watch("options",function(newVal){newVal=newVal.map(function(ele){return $scope.sanitize&&(ele.value=$rootScope.getSanitizedText(ele.value)),ele}),$($ele[0]).find("select")[0].sumo&&$timeout(function(){$($ele[0]).find("select")[0].sumo.reload()})}),$scope.$watch("value",function(newVal){$($ele[0]).find("select")[0].sumo&&$timeout(function(){$($ele[0]).find("select")[0].sumo.reload()})}),$timeout(function(){render()})}}}])}(angular),function(ng){angular.module("bt-components").directive("toggleSwitch",["$rootScope","$timeout",function($rootScope,$timeout){return{restrict:"EA",scope:{disabled:"=?",onClick:"=?"},require:"?ngModel",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/switch/switch.html",link:function($scope,ele,attrs,ngModelCtrl){function read(){ngModelCtrl.$setViewValue(_input.prop("checked"))}var isChecked,label;ngModelCtrl&&($scope.yesNo=attrs.yesNo,$scope.noOpt=attrs.noOpt,$scope.disabled&&(label=ele.find("label")&&ele.find("label")[0],label&&(label.style.opacity=.5)),$(ele[0]).click(function(){_input=ele.find("input"),$scope.disabled||(isChecked=_input.prop("checked"),isChecked?_input[0].checked=!1:_input[0].checked=!0,$timeout(function(){($scope.onClick||angular.noop)()}),$scope.$evalAsync(read))}),$scope.$parent.$watch(attrs.ngModel,function(value){ele.find("input")[0].checked=value&&!0,ngModelCtrl.$setViewValue(value)}),ngModelCtrl.render=function(){ele.find("input")[0].checked=_input.prop("checked")})}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("sortableTable",["$filter",function($filter){return{restrict:"EA",scope:{tableData:"=",callback:"&",onEdit:"&",onDelete:"&",showActions:"@",onView:"&"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/table/table.html",link:function($scope,$element,$attr){$scope.showActionCtrls=!1,$scope.$watch("showActions",function(newVal,oldVal){$scope.showActionCtrls="true"===newVal?!0:!1}),$scope.tdata={head:[],rows:[]},$scope.$watch("tableData",function(nv,ov){nv&&($scope.tdata.head=$scope.tableData.headers,$scope.tdata.rows=$scope.tableData.rows,$scope.rows=$scope.tdata.rows,$scope.cols=$scope.tdata.head.map(function(col){return col.name}))},!0),$scope.selectedCls=function(column){return column===$scope.sort.column&&"$sort-"+$scope.sort.descending},$scope.edit=function(index,row){$scope.onEdit({index:index,row:row})},$scope["delete"]=function(index,row){$scope.onDelete({index:index,row:row})},$scope.view=function(index,row){$scope.onView({index:index,row:row})},$scope.moveUp=function(index){0!==index&&$scope.callback({type:"up",index:index})},$scope.moveDown=function(index){index!==$scope.tdata.rows.length-1&&$scope.callback({type:"down",index:index})}}}}])}(angular),function(ng){angular.module("bt-components").directive("tagsBox",[function(){return{restrict:"E",scope:{tags:"=",onDelete:"=?",key:"@?"},controller:["$scope",function($scope){$scope.onDelete=$scope.onDelete||angular.noop,$scope.deletetag=function(index){$scope.tags.splice(index,1),$scope.onDelete(index)}}],link:function($scope,ele,attrs){},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/tags-box/tags-box.html"}}])}(angular),function(){var testApp;testApp=angular.module("bt-components"),testApp.directive("tagInput",function(){return{restrict:"E",scope:{inputTags:"=taglist",callback:"=",autocomplete:"=autocomplete"},controller:["$scope","$workflowService",function($scope,$workflowService){$scope.getDisplayName=function(_contact){var _str=_contact.firstName[0]+""+_contact.lastName[0];return _str.toUpperCase()}}],link:function($scope,element,attrs){function validateEmail(email){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(String(email).toLowerCase())}if($scope.defaultWidth=220,$scope.tagText="",$scope.placeholder=attrs.placeholder,$scope.autocomplete){$scope.autocompleteFocus=function(event,ui){return $(element).find("input").val(ui.item.value),!1},$scope.autocompleteSelect=function(event,ui){return $scope.$apply("tagText='"+ui.item.value+"'"),$scope.$apply("addTag()"),!1},$(element).find("input").autocomplete({minLength:2,source:function(request,response){var item;return response(function(){var i,len,ref,results;for(ref=$scope.autocomplete.filter(function(contact){return!contact.isAdded}),$scope.callback.unique&&$scope.inputTags&&$scope.inputTags.length&&ref&&$scope.inputTags.forEach(function(item){var findIndex=ref.findIndex(function(contact){return item._id===contact._id});-1!==findIndex&&ref.splice(findIndex,1)}),ref=ref.map(function(a){return a&&a.fullName+" ("+a.emailId+")"}),ref=ref.filter(function(element){return void 0!==element}),results=[],i=0,len=ref.length;len>i;i++)item=ref[i],-1!==item.toLowerCase().indexOf(request.term.toLowerCase())&&results.push(item);return results}())},highlight:!0,select:function(_this){return function(event,ui){return $scope.autocompleteSelect(event,ui)}}(this)}).autocomplete("widget").addClass("contactsDropdown");var _blurListner=function(){$(this).val().length>1&&$(this).val("")};$(element).find("input").on("blur",_blurListner)}$scope.callback.inviteOtherDomainUser=function(e,obj){if(obj&&obj.validateEmail||e&&(13===e.keyCode||188===e.keyCode||32===e.keyCode)){if(0===$scope.tagText.length)return void($scope.tagText="");$scope.tagText=$scope.tagText.replace(/,/g,""),$scope.tagText=$scope.tagText.trim();var _contact={emailId:$scope.tagText.trim(),otherDomain:!0,inValidEmail:!validateEmail($scope.tagText)};$scope.inputTags.push(_contact),$scope.inputTags=_.uniq($scope.inputTags),$scope.validEmailList=_.filter($scope.inputTags,{inValidEmail:!1}),$scope.tagText=""}},$scope.addTag=function(){if(0===$scope.tagText.length)return void($scope.tagText="");$scope.tagText=$scope.tagText.match(/\(([^)]+)\)/)[1].trim(),$scope.inputTags=_.uniq($scope.inputTags);for(var i=0;i<$scope.inputTags.length;i++)if($scope.inputTags[i].emailId===$scope.tagText)return void($scope.tagText="");var _contact=$scope.autocomplete.filter(function(contact){return contact.emailId===$scope.tagText});_contact&&_contact[0]&&$scope.inputTags.push(_contact[0]),$scope.tagText=""},$scope.deleteTag=function(key){$scope.inputTags.length>0&&0===$scope.tagText.length&&void 0===key?$scope.inputTags.pop():void 0!==key&&$scope.inputTags.splice(key,1)},$scope.$watch("tagText",function(newVal,oldVal){$scope.callback.enable=validateEmail(newVal);var tempEl,dummyText;return newVal!==oldVal||void 0!==newVal?(dummyText=newVal.replace("<","----").replace(">","----"),tempEl=$("<span>"+dummyText+"</span>").appendTo("body"),$scope.inputWidth=tempEl.width()+20,$scope.inputWidth<$scope.defaultWidth&&($scope.inputWidth=$scope.defaultWidth),tempEl.remove()):void 0});var _keydownListner=function(e){var key;return key=e.which,(9===key||13===key)&&e.preventDefault(),8===key?$scope.$apply("deleteTag()"):void 0};element.bind("keydown",_keydownListner),$scope.$on("$destroy",function(){$(element).find("input").on("blur",_blurListner),element.unbind("keydown",_keydownListner),element.unbind("keyup",_keyupListner)});var _keyupListner=function(e){var key;return key=e.which,9===key||13===key||188===key?(e.preventDefault(),$scope.$apply("addTag()")):void 0};return element.bind("keyup",_keyupListner)},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/tagsInput/tagsInput.html"}})}.call(this),function(ng){var _component=angular.module("bt-components");_component.directive("taskCreateOverlay",function(){return{restrict:"EA",scope:{callback:"=",alerts:"=",actions:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/task-create-overlay/task-create-overlay.html",controller:"taskCreateOverlayController"}}),_component.controller("taskCreateOverlayController",["$scope","$location","$workflowService","$timeout","$rootScope","$modal","i18n",function($scope,$location,$workflowService,$timeout,$rootScope,$modal,i18n){$scope.callback=$scope.callback||{},$scope.loaderMessage=i18n.i18nString("working_on_it_lowercase"),$scope.taskTypes=[{id:"dialog",name:i18n.i18nString("bt_task_chooser_dialog_label"),description:i18n.i18nString("bt_task_chooser_dialog_desc"),path:window.appConfig.CONTEXT_PATH+"/flowTask/new",type:"flowtask",iconClass:"fa fa-comments"},{id:"alert",name:i18n.i18nString("alert"),description:i18n.i18nString("bt_task_chooser_alert_desc"),path:window.appConfig.CONTEXT_PATH+"/new",type:"alert",iconClass:"fa fa-bell"},{id:"information",name:i18n.i18nString("info_task"),description:i18n.i18nString("bt_task_chooser_info_desc"),path:window.appConfig.CONTEXT_PATH+"/new",type:"action",iconClass:"fa fa-pie-chart"},{id:"action",name:i18n.i18nString("action_label"),description:i18n.i18nString("bt_task_chooser_action_desc"),path:window.appConfig.CONTEXT_PATH+"/new",type:"action",iconClass:"fa fa-flash"},{id:"knowledge",name:i18n.i18nString("knowledge"),description:i18n.i18nString("bt_task_chooser_knowledge_desc"),path:window.appConfig.CONTEXT_PATH+"/knowledgecreate",type:"knowledge",iconClass:"fa fa-question-circle"},{id:"flows",name:i18n.i18nString("constants.flows"),description:i18n.i18nString("bt_task_chooser_alerts_desc"),path:window.appConfig.CONTEXT_PATH+"/alert/new/map/new",type:"flows",iconClass:"fa fa-link"}],$scope.callback.openTaskCreateModal=function(){$("#taskCreateOverlayModal").modal("show"),$(".taskTypeDiv ").removeClass("selected"),$("#taskCreateOverlayModal").on("shown.bs.modal",function(){$("body").addClass("modal-open"),$("body").addClass("bt-modal-open")}),$("#taskCreateOverlayModal").on("hidden.bs.modal",function(){$("body").removeClass("modal-open"),$("body").removeClass("bt-modal-open")})},$scope.isWorkProgress=!1,$rootScope.$on("showOrHideStatusLoader",function(evt,newValue){$scope.isWorkProgress=newValue}),$scope.initiateWorkflowCreation=function(type){$workflowService.workflowType(type),$workflowService.mpAlertInfo({}),$workflowService.alertInfo({}),$workflowService.actionInfo({}),$workflowService.mpActionInfo({}),$workflowService.currentStep(3),$workflowService.alertData({}),$workflowService.authData({}),$workflowService.requestData({}),$workflowService.responseData({}),$workflowService.settingsData({})};var selectedTaskObject=[];$scope.getPath=function(selectedTask){return selectedTaskObject=_.filter($scope.taskTypes,function(task){return task.id===selectedTask}),$scope.initiateWorkflowCreation(selectedTaskObject[0].type),selectedTaskObject[0].path},$scope.taskObject={},$scope.taskObject.selectedTask="",$scope.gotoTaskCreation=function(){return console.log($scope.taskObject.selectedTask),"action"===$scope.taskObject.selectedTask||"information"===$scope.taskObject.selectedTask||"alert"===$scope.taskObject.selectedTask||"knowledge"===$scope.taskObject.selectedTask?($scope.getPath($scope.taskObject.selectedTask),$rootScope.$broadcast("initTaskCreation"),void $scope.launchTaskGeneralInfoModal()):"flows"===$scope.taskObject.selectedTask?($rootScope.$broadcast("initTaskCreation"),$("#taskCreateOverlayModal").modal("hide"),$scope.callback.closeTaskCreateModal(),void $scope.callback.openCreateFlowDialog()):void $location.path($scope.getPath($scope.taskObject.selectedTask))},$scope.selectTask=function(selectedTask){$scope.taskObject.selectedTask=selectedTask,$scope.gotoTaskCreation()},$scope.callback.closeTaskCreateModal=function(){$scope.taskObject.selectedTask="",$location.path(window.appConfig.CONTEXT_PATH),$timeout(function(){$("body").removeClass("modal-open")})},$scope.isEligibleToShow=function(taskTypeID){return"flows"==taskTypeID?($scope.alerts||[]).length>0||($scope.actions||[]).length>0:!0},$scope.launchTaskGeneralInfoModal=function(log){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-task-form/task-generalinfo.html",controller:"taskGeneralInfoCtrl",windowClass:"task-generalinfo-modal",backdrop:"static",keyboard:!1,resolve:{parms:function(){return{taskType:selectedTaskObject[0].type,isReport:"information"===selectedTaskObject[0].id}}}}),$("#taskCreateOverlayModal").hide()}}])}(angular),function(){var _module=angular.module("bt-components");_module.directive("taskmodal",function(){return{restrict:"EA",controller:"taskModalCtrl",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/task-modal/task-modal.html"}}),_module.controller("taskModalCtrl",["$scope","$rootScope","$workflowService",function($scope,$rootScope,$workflowService){$scope.isEditTask=!1,$scope.taskEditInfo=$workflowService.taskEditInfo(),$scope.closeTaskCreateOrEditModal=function(){$("#taskCreateOrEditModal").modal("hide")},$rootScope.$on("updateEditTask",function(event,flag){flag&&($scope.taskEditInfo=$workflowService.taskEditInfo(),$scope.taskType=$scope.taskEditInfo.taskType,$("#taskCreateOverlayModal").modal("hide"),$rootScope.$emit("updateGlobalWorkProgress",!1),$("#taskCreateOrEditModal").modal("show")),$scope.isEditTask=flag})}])}(angular),function(ng){angular.module("bt-components").directive("templateContainer",["$timeout","$location","$rootScope","$workflowService","$filter","env_conf",function($timeout,$location,$rootScope,$workflowService,$filter,env_conf){return{restrict:"EA",scope:{onSave:"&",onCancel:"&",keys:"=",wfType:"=",displayMode:"=?",template:"=",cbBridge:"=",editReport:"=?"},controller:["$scope",function($scope){if("dialog"===$scope.wfType)$scope.data=$scope.editReport;else{var entity="alert"===$scope.wfType?$workflowService.alertInfo():$workflowService.actionInfo();entity.isReport&&($scope.data=entity.report)}}],link:function($scope,ele,attrs){function modifyKeys(keys){var _outKeys=[];return _outKeys=keys&&keys.length&&keys.map(function(key){return"response."===key.substring(0,9)&&(key=key.substring(9,key.length)),key})}function sendData(){var componentInfo={addon_key:"component",key:"component-key"},report_data={data:transformData($scope.data),keys:"alert"===$scope.wfType?$scope.keys:modifyKeys($scope.keys),dataTypes:dataTypes,displayMode:$scope.displayMode,wfType:$scope.wfType,contextsData:$workflowService.contextData(),dialogNodeNames:$workflowService.dialogNodesNames()};host.dispatch("onData",componentInfo,report_data,angular.noop)}function arrangeData(items,keys){var template={templateInfo:[]},mappings=items.map(function(item){var obj={};return obj.key=btoa(100*Math.random()+"").replace(/=/g,""),"object"==typeof item.key?(Object.keys(item.key).map(function(key){keyMap[item.key[key]]?item.key[key]="<%= "+item.key[key]+" %>":item.key[key]="<% "+item.key[key]+" %>"}),obj.value=item.key,obj):(keyMap[item.key]?obj.value="<%= "+item.key+" %>":obj.value="<% "+item.key+" %>",obj)});return items=items.map(function(item){return mappings.map(function(mapping){(mapping.value&&mapping.value.replace&&mapping.value.replace(/<%=/g,"").replace(/<%|%>/g,"").trim())===item.key?item.key=mapping.key:"object"==typeof mapping.value&&_.isEqual(mapping.value,item.key)&&(item.key=mapping.key)}),item}),template.templateInfo=items,template.mappings=mappings,template}function transformData(data){if($scope.template!==(data&&data.config&&data.config.name))return[];var mappings=data&&data.mappings||[],items=data&&data.config&&data.config.templateInfo||[];return items=items.map(function(item){return mappings.map(function(mapping){mapping.key===item.key&&"object"!=typeof mapping.value?(item.key=mapping.value&&mapping.value.replace&&mapping.value.replace(/<%=/g,"").replace(/<%|%>/g,"")||"",item.key=item.key.trim()):mapping.key===item.key&&"object"==typeof mapping.value&&(item.key={},Object.keys(mapping.value).map(function(key){item.key[key]=mapping.value[key].replace(/<%=/g,"").replace(/<%|%>/g,""),item.key[key]=(item.key[key]||"").trim()}))}),item}),{config:items}}function initialize(){function setup(extension){var iframeParams=host.create(extension,angular.noop);return iframe=document.createElement("iframe"),iframe.setAttribute("id",iframeParams.id),iframe.setAttribute("name",iframeParams.name),iframe.setAttribute("src",iframeParams.src+"?v="+$rootScope.appVersion),iframe.setAttribute("frameBorder",0),iframe.setAttribute("scrollable","no"),iframe.setAttribute("class","column"),iframe.style.width="100%",iframe.style.minHeight="100px",document.getElementById(extension.key).innerHTML="",document.getElementById(extension.key).appendChild(iframe),!0}var extension={addon_key:"component",key:"component-key",url:source+url};setup(extension)}var iframe,dataTypes=[{name:"String",value:"string"},{name:"Number",value:"number"},{name:"Date",value:"date"}],keyMap={},templates=$workflowService.templates(),callback=angular.noop(),url=$filter("filter")(templates,{value:$scope.template})[0];url=url&&url.link;var source=env_conf["components-source"];$scope.$watch("keys",function(newVal,oldVal){newVal&&Array.isArray(newVal)&&(keyMap={},newVal.map(function(key){keyMap[key]=key}),initialize())}),host.defineModule("api",{save:function(title,body,options,callback){console.log(angular.copy(body)),body||(body={config:[]}),body.config=body.config||[],$scope.onSave({config:arrangeData(body.config,$scope.keys),callback:callback})},cancel:function(title,body,options){$scope.onCancel()},getData:function(){return sendData(),$scope.keys},resize:function(){iframe.style.height=iframe.contentWindow.document.body.offsetHeight+"px"},close:function(){$scope.cbBridge.closeTemplateModal&&$scope.cbBridge.closeTemplateModal()}}),$scope.$on("templateConfSave",function(evt,data){callback=data.callback||angular.noop(),host.dispatch("onSave",{addon_key:"component",key:"component-key"},{},angular.noop)}),$scope.$on("onTemplateConfSaveSuccess",function(evt,data){entity="alert"===$scope.wfType?$workflowService.alertInfo():$workflowService.actionInfo(),entity.isReport&&($scope.data=entity.report)}),$scope.$on("$destroy",function(){console.log("This scope is destroyed")})}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-components");_module.directive("versionComparision",function(){return{restrict:"EA",scope:{customData:"=",closeFullCallback:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/version-comparision/version-comparision.html",controller:"versionCompController"}}),_module.controller("versionCompController",["$scope","env_conf","$rootScope","$workflowService","$applicationService","BTStreamsService","NotificationService","i18n","jsEvents","$sce",function($scope,env_conf,$rootScope,$workflowService,$applicationService,BTStreamsService,NotificationService,i18n,jsEvents,$sce){function initData(){var data={type:"init",name:$scope.stream.name,streamId:$scope.customData.streamId,botType:$scope.customData.botType,baseVersionId:$scope.customData.baseVersionId,secondaryVersionId:$scope.customData.secondaryVersionId,baseVersionDate:$scope.customData.baseVersionDate,secondaryVersionDate:$scope.customData.secondaryVersionDate,baseName:$scope.customData.baseName,secondaryName:$scope.customData.secondaryName};jsEvents.postMessageToChildIframes("versionComparision","versionComparisionEvent",data),setTimeout(function(){$scope.lodingForm=!1},500)}$scope.streamId=$workflowService.selectedStream()._id,$scope.stream=$workflowService.selectedStream(),$scope.lodingForm=!0,$scope.assetsBase=env_conf["assets-url"],$scope.queryString="?name="+$scope.stream.name+"&streamId="+$scope.customData.streamId+"&botType="+$scope.customData.botType+"&baseVersionId="+$scope.customData.baseVersionId+"&secondaryVersionId="+$scope.customData.secondaryVersionId+"&baseVersionDate="+$scope.customData.baseVersionDate+"&secondaryVersionDate="+$scope.customData.secondaryVersionDate+"&baseName="+$scope.customData.baseName+"&secondaryName="+$scope.customData.secondaryName,window.location.href&&window.location.href.includes("localhost")?$scope.iframeUrl=$sce.trustAsResourceUrl("http://localhost:4200/analytics/version-comparision"+$scope.queryString):$scope.iframeUrl=window.appConfig.API_SERVER_URL+"/analytics/version-comparision"+$scope.queryString;var iframe=$("#versionComparision");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")}),setTimeout(function(){initData()},500)}),$rootScope.$on("versionComparisionEvent",function(e,formEvent){var iframePaylod=formEvent.payload;"close"===iframePaylod.type&&closeFullPageModal()}),$scope.customData.updateIframeData=function(){$scope.lodingForm=!0,$scope.queryString="?name="+$scope.stream.name+"&streamId="+$scope.customData.streamId+"&botType="+$scope.customData.botType+"&baseVersionId="+$scope.customData.baseVersionId+"&secondaryVersionId="+$scope.customData.secondaryVersionId+"&baseVersionDate="+$scope.customData.baseVersionDate+"&secondaryVersionDate="+$scope.customData.secondaryVersionDate+"&baseName="+$scope.customData.baseName+"&secondaryName="+$scope.customData.secondaryName,$scope.iframeUrl=window.appConfig.API_SERVER_URL+"/analytics/version-comparision"+$scope.queryString,$scope.customData.secondaryVersionId&&initData()};var closeFullPageModal=function(){setTimeout(function(){$scope.closeFullCallback()},500)}}])}(angular),function(ng){var _module=angular.module("bt-components");_module.directive("wysiwygEditor",["util","$timeout","textparser",function(util,$timeout,textparser){return{restrict:"EA",scope:{name:"@",placeholder:"@",keys:"=",vars:"="},require:"^ngModel",controller:["$scope","util","$timeout",function($scope,util,$timeout){$scope.justabliss={},$scope.onChange=function(value){value&&(value=value.split(","),"variable"===value[0]?util.insertAtCursor("<%"+value[1]+"%>",$scope.name):"sample"===value[0]&&util.insertAtCursor("<%="+value[1]+"%>",$scope.name),$timeout(function(){$("#"+$scope.name).trigger("change")}),$scope.justabliss.title="")}}],templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/wysiwyg-editor/wysiwyg-editor.html",link:function(scope,element,attrs,ngModelCtrl){function set(){ngModelCtrl.$setViewValue($("#"+scope.name).html())}$timeout(function(){var medium=new Medium({element:$("#"+scope.name)[0],mode:Medium.richMode,tags:null,pasteAsText:!1,drag:!0,attributes:null});$("#"+scope.name).wysiwygEvt(),$("#"+scope.name).on("change",function(){scope.$evalAsync(set)}),$("#"+scope.name+"bold").mousedown(function(){return medium.invokeElement("b",{}),!1}),$("#"+scope.name+"underline").mousedown(function(){return medium.invokeElement("u",{}),!1}),$("#"+scope.name+"italic").mousedown(function(){return medium.invokeElement("i",{}),!1})}),function($){$.fn.wysiwygEvt=function(){return this.each(function(){var $this=$(this),htmlOld=$this.html();$this.bind("blur keyup paste copy cut mouseup",function(){var htmlNew=$this.html();htmlOld!==htmlNew&&($this.trigger("change"),htmlOld=htmlNew)})})}}(jQuery),ngModelCtrl.$render=function(){$("#"+scope.name).html($("#"+scope.name).html())},ngModelCtrl.$parsers.push(function(newVal){return newVal&&-1!==newVal.indexOf("&lt;%=")&&-1!==newVal.indexOf("%&gt;")?textparser.parse(newVal):newVal&&-1!==newVal.indexOf("&lt;%")&&-1!==newVal.indexOf("%&gt;")?textparser.parse(newVal):newVal&&-1!==newVal.indexOf("<%=")&&-1!==newVal.indexOf("%>")?textparser.parse(newVal):newVal&&-1!==newVal.indexOf("<%")&&-1!==newVal.indexOf("%>")?textparser.parse(newVal):newVal}),scope.$parent.$watch(attrs.ngModel,function(newVal){newVal!==$("#"+scope.name).html()&&$("#"+scope.name).html(newVal),$("#"+scope.name).trigger("change")})}}}])}(angular);