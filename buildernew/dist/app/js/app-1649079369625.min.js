/* minification dated 2022-04-04 */
!function(ng){"use strict";!function(){String.prototype.endsWith=function(suffix){return-1!==this.indexOf(suffix,this.length-suffix.length)},window.appConfig&&(window.appConfig.API_SERVER_URL="https://qa-bots.kore.ai"),window.appConfig||(window.appConfig={API_SERVER_URL:"https://qa1-bots.kore.ai",CONTEXT_PATH:"",MESSENGER_URL:"https://qa.kore.com",BOT_ADMIN_URL:"https://qa-admin.kore.ai",LOAD_WHATFIX:!0,INLINE_MANUAL_SITE_KEY:"052870f28d65bd4a4d91ff683003e274",ON_PREMISE:!1,HIDE_SSO_LOGIN:!1,SSO_PROVIDERS:{google:!0,microsoft:!0,linkedin:!0,github:!1},SDK_SPEECH_URL:"https://qa-speech.kore.ai/",GOOGLE_ANALYTICS_KEY:"UA-104304523-1",ENABLE_GOOGLE_SPEECH:!1,GOOGLE_MAPS_API_KEY:"AIzaSyBrFX3oIiPxvRTmywKPBFfudkttUej7nAU",ENABLE_GOOGLE_MAPS:!0,ENABLE_SHARE_LOCATION:!0,USE_SESSION_STORE:!1,NO_CARRY_SSO_EMAIL:!1,ENABLE_SESSION_EXPIRY_TIMER:!0,SESSION_VALIDITY_POLLING:!0,DIRECT_SSO_LOGIN:!1,SMALLTALK_DEPTH:2,MIX_PANEL_TOKEN:"ed0fdb1ab47068a456b068ff3a92ddf4",ENABLE_MIX_PANEL:!1,MIX_PANEL_DEV:!1,USE_SERVER_SOCKET_URL:!1,enableHomepage:!0,homePageIframeUrl:"https://pilot-site.kore.ai/bot-home-3/"}),window.appConfig&&(window.appConfig.TMPLT_PRE_PATH=window.appConfig.CONTEXT_PATH?window.appConfig.CONTEXT_PATH+"/":"")}(),window.appConfig&&(window.appConfig.MP_URL=location.protocol+"//"+location.host+"/botstore"),window.___app_kickOff=function(){ng.element(document).ready(function(){ng.bootstrap(document,["BuilderApp"])})}(),window._log_info=function(){window.localStorage.enableLogs&&console.info.apply(console,arguments)};var btBuilderApp=ng.module("BuilderApp",["ngRoute","ngSanitize","ui.select2","ng.jsoneditor","datePicker","ui.bootstrap","validation.match","LocalStorageModule","dibari.angular-ellipsis","angular-uuid","ui.tree","ui.tree-filter","ui.highlight","bt-components","bt-streams","utterances-module","patterns-module","synonyms-module","bt-wf-create","bt-flowTask-create","bt-flowTask-edit","bt-flowTask-view","bt-forms","bt-login","ml-threshold","bt-wf-mapping","bt-bot-publish","bt-resource-view","bt-resource-versions","bt-wf-edit","bt-app-create","bt-app-view","bt-stream-edit","bt-stream-create","bt-wf-logs","bt-chat-settings","app.helpers","factories","services","version.manager","bt-kora-users","bt-kora-logs","bt-changelog","bt-knowledge-create","bt-train-bot","bt-solution-install","bt-kore-components","jsonFormatter","ui.sortable","manage-components","bt-import-bot","bt-variable-management","ngCsv","ngTagsInput","oc.lazyLoad"]);btBuilderApp.filter("trustUrl",function($sce){return function(url){return $sce.trustAsResourceUrl(url)}}),btBuilderApp.config(["$locationProvider",function($locationProvider){$locationProvider.html5Mode(!0)}]),btBuilderApp.config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("AuthInterceptor","languageInterceptor","i18nLagInterceptor","accountInterceptor","stateInterceptor","cryptoInterceptor","accessTokenTimerInterceptor","timezoneInterceptor"),$httpProvider.useApplyAsync([!0]),$httpProvider.defaults.headers["delete"]={"Content-Type":"application/json;charset=utf-8"}}]),btBuilderApp.config(["$rootScopeProvider",function($rootScopeProvider){$rootScopeProvider.digestTtl(20)}]),btBuilderApp.run(["$rootScope","$http","$timeout","$templateCache","_constants_","$window","$endpoints","$translator","$applicationService","$location","$localstorage","BTSeedDataService","$workflowService","env_conf","domEvents","versionMonitor","$anchorScroll","security","scriptLoader","i18n",function($rootScope,$http,$timeout,$templateCache,_constants_,$window,$endpoints,$translator,$applicationService,$location,$localstorage,BTSeedDataService,$workflowService,env_conf,domEvents,versionMonitor,$anchorScroll,security,scriptLoader,i18n){function getJSON(string){var json;try{return json=JSON.parse(string)}catch(e){return!1}}function decodeBase64(string){try{return atob(string)}catch(e){return!1}}$rootScope._=_,$rootScope.contextPath=env_conf["context-url"],$rootScope.tmpltPrePath=window.appConfig.TMPLT_PRE_PATH,$rootScope.appVersion=env_conf["app-version"],$rootScope.appConfig=window.appConfig,$rootScope.logoIcon=window.appConfig.CONTEXT_PATH+"/assets/landingImages/logo.png",$rootScope.logoIconSmart=window.appConfig.CONTEXT_PATH+"/assets/landingImages/smart-logo.svg",$rootScope.logoFull=window.appConfig.CONTEXT_PATH+"/assets/landingImages/kore-logo.svg",$rootScope.logoFullInverted=window.appConfig.CONTEXT_PATH+"/img/kore-logo-inverse.svg",window.appConfig.PFIZER&&($rootScope.logoIcon=window.appConfig.CONTEXT_PATH+"/assets/landingImages/logo-pfizer.svg",$rootScope.logoFull=window.appConfig.CONTEXT_PATH+"/assets/landingImages/pfizer-logo.svg",$rootScope.logoFullInverted=window.appConfig.CONTEXT_PATH+"/img/pfizer-logo-inverse.svg"),domEvents.register(),scriptLoader.loadScripts();var _lskey="bt.userInfo";$localstorage.get(_lskey);if($templateCache.put("langpopover.html","This is the content of the template"),"object"==typeof localStorage)try{localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage")}catch(e){Storage.prototype._setItem=Storage.prototype.setItem,Storage.prototype.setItem=function(){},alert(i18n.i18nString("website_loaded"))}daterangepicker.prototype.hoverDate=function(){};var id_token,json,endIdToken,qp,search=$location.search(),hash=$location.hash();if(search&&search.iframeBodyClass&&$("html, body").addClass(search.iframeBodyClass),search&&search.lang&&($workflowService.i18nSelectedLanguage(search.lang),localStorage.setItem("queryParamLang",search.lang)),search.emailId||search.phoneNo){security.resetlocalStoragAfterLogout();var _emailJson={email:search.emailId||search.phoneNo};window.localStorage.setItem("emailIdStorage",JSON.stringify(_emailJson))}if(search.utm_source||search.utm_campaign||search.utm_id||search.utm_term||search.utm_content){var uatDetails={"UTM Source":search.utm_source||"","UTM Campaign":search.utm_campaign||"","UTM Id":search.utm_id||"","UTM Term":search.utm_term||"","UTM Content":search.utm_content||""};window.localStorage.setItem("utmDetails",JSON.stringify(uatDetails))}if(search.streamId){var invitedStreamId="";search.streamId&&(invitedStreamId=search.streamId,localStorage.setItem("invitedBot",invitedStreamId))}var checkForPendingInstalation=window.localStorage.getItem("installFromStore");if(search&&search.qp){var getQueryParams=atob(search.qp);if(getQueryParams){var queryParamsObj=JSON.parse(getQueryParams);queryParamsObj&&"botStore"===queryParamsObj.origin&&($workflowService.globalStoreQueryParams(queryParamsObj),(queryParamsObj.streamId||queryParamsObj.processId)&&(queryParamsObj.streamId&&$workflowService.globalStoreQueryParams(queryParamsObj),queryParamsObj.processId&&$workflowService.toInstallProcessApp(queryParamsObj),$location.search({}),$location.hash("")))}}else if(checkForPendingInstalation){var storeParms=JSON.parse(checkForPendingInstalation);$workflowService.globalStoreQueryParams(storeParms)}if("login"===hash||"signup"===hash){security.resetlocalStoragAfterLogout();var _emailJsonObj={email:search.email||search.emailId||search.phoneNo};_emailJsonObj.email?window.localStorage.setItem("emailIdStorage",JSON.stringify(_emailJsonObj)):window.localStorage.removeItem("emailIdStorage"),$location.path(window.appConfig.CONTEXT_PATH+"/login")}else if(hash.indexOf("id_token")>-1){json=getJSON(search.query),qp=decodeBase64(search.qp),qp&&(qp=getJSON(qp));var _obj;if(endIdToken=hash.indexOf("&email")>-1?hash.indexOf("&email"):hash.length,id_token=hash.substring(hash.indexOf("id_token")+9,endIdToken),$location.path().indexOf("kora")>-1&&(_obj={isFromKora:!0,path:$location.path()},$workflowService.kgDataFromKora(_obj)),qp.hasOwnProperty("usecaseType"))_obj={},"faq"==qp.usecaseType?(_obj={kgId:qp.kgId,landOnKg:!0,streamId:qp.streamId,selectedAccount:qp.selectedAccount},qp.workbenchSolutionType&&(_obj.workbenchSolutionType=qp.workbenchSolutionType),qp.returnUrl&&(_obj.returnUrl=qp.returnUrl),qp.fromWorkbench?_obj.fromWorkbench=!0:_obj.fromSmart=!0,$workflowService.kgDataFromKora(_obj)):"conversation"==qp.usecaseType&&(_obj={dgId:qp.dgId,landOnDialog:!0,streamId:qp.streamId,selectedAccount:qp.selectedAccount,state:qp.state},qp.workbenchSolutionType&&(_obj.workbenchSolutionType=qp.workbenchSolutionType),qp.fromWorkbench?_obj.fromWorkbench=!0:_obj.fromSmart=!0,qp.returnUrl&&(_obj.returnUrl=qp.returnUrl),$workflowService.kgDataFromKora(_obj));else if(qp.landOnPublish)_obj={landOnPublish:!0,streamId:qp.streamId,accountId:qp.selectedAccount,selectedAccount:qp.selectedAccount},qp.fromWorkbench?_obj.fromWorkbench=!0:_obj.fromSmart=!0,qp.returnUrl&&(_obj.returnUrl=qp.returnUrl),$workflowService.kgDataFromKora(_obj);else if(qp&&qp.landOnSummary){var _sampleObj={landOnSummary:!0,streamId:qp.streamId,accountId:qp.selectedAccount};$workflowService.sampleBotDataFromBotStore(_sampleObj)}else if(qp&&qp.streamId){var _obj1={landOnStream:!0,streamId:qp.streamId,selectedAccount:qp.selectedAccount};$workflowService.kgDataFromKora(_obj1)}else if(qp&&qp.processId){var _objProcess={processId:qp.processId,selectedAccount:qp.selectedAccount};$workflowService.toInstallProcessApp(_objProcess)}security.ssoLogin(id_token,json,qp),$location.search({}),$location.hash("")}else if(hash.indexOf("iir")>-1){var idp_redirect_key=hash.substring(hash.indexOf("iir")+4,endIdToken);window.location.href=$endpoints.baseUrl+$endpoints.apiPreFix+"/sso/login/idpinit/redirect/callback?iir="+idp_redirect_key}else"_accountactivation"===hash?(security.resetlocalStoragAfterLogout(),$location.path(window.appConfig.CONTEXT_PATH+"/login")):"_resetpassword"===hash?$location.path(window.appConfig.CONTEXT_PATH+"/login"):"accountsList"===search.form?(security.resetOAuth(),search.form="accountsList"):security.resumeOldSession();$rootScope.$on("$locationChangeSuccess",function(event,newUrl,oldUrl){window.appConfig.GOOGLE_ANALYTICS_KEY&&$window.ga("send","pageview",$location.path());var _noHeaderPattern=new RegExp("login|requestbtaccess|acceptbtlicense");newUrl&&_noHeaderPattern.test(newUrl)?$rootScope.showHeader=!1:$rootScope.showHeader=!0}),$rootScope.lableData={},$rootScope.changeLanguage=function(languageType){env_conf["components-source"];$rootScope.lableData=i18n.i18nString("resource")},$rootScope.resolveHostUrl=function(){var url=window.location.protocol+"//"+window.location.host;return"https://qa-bots.kore.ai"===url?"https://qa-smartassist.kore.ai/":"https://qa1-bots.kore.ai"===url?"https://qa1-smartassist.kore.ai/":"https://uat.kore.ai"===url?"https://uat-smartassist.kore.ai/":"https://uat-demo.kore.ai"===url?"https://demo-app-smartassist.kore.ai/":"https://staging-bots.korebots.com"===url?"https://staging-smartassist.kore.ai/":"https://pilot-bots.kore.ai"===url?"https://pilot-app.smartassist.ai/":"https://bots.kore.ai"===url?"https://smartassist.kore.ai/":"https://jp-bots.kore.ai"===url?"https://smartassist-jp.kore.ai/":url+"/"},$rootScope.resolveWorkbenchHostUrl=function(){var url=window.location.protocol+"//"+window.location.host,workbenchData=$workflowService.kgDataFromKora(),workbenchSolutionType=workbenchData.workbenchSolutionType;if(workbenchData&&workbenchData.returnUrl)return workbenchData.returnUrl;if("Banking"===workbenchSolutionType){if("https://staging-bots.korebots.com/botbuilder"===url||"https://staging-bots.korebots.com"===url)return"https://staging-workbench-external.korebots.com/workbench";if("https://bots.kore.ai/botbuilder"===url||"https://bots.kore.ai"===url)return"https://bankassist.kore.ai/workbench";if("https://bankassist-dev-bots.kore.ai"===url)return"https://bankassist-dev.kore.ai";if("https://bankassist-qa-bots.kore.ai"===url)return"https://bankassist-qa.kore.ai";if("https://bankingassistant-qa-bots.kore.ai"===url)return"https://bankingassistant-qa.kore.ai";url=window.appConfig.WORKBENCH_SERVER_URL+"/workbench"}else{if("ITSM"===workbenchSolutionType)return"https://staging-bots.korebots.com/botbuilder"===url||"https://staging-bots.korebots.com"===url?"https://itassist-qa.kore.ai":"https://itassist.kore.ai";if("HR"===workbenchSolutionType)return"https://staging-bots.korebots.com/botbuilder"===url||"https://staging-bots.korebots.com"===url?"https://hrassist-qa.kore.ai":"https://hrassist.kore.ai";if("Applicant"===workbenchSolutionType)return"https://staging-bots.korebots.com/botbuilder"===url||"https://staging-bots.korebots.com"===url?"https://applicantassist-qa.kore.ai":"https://applicantassist.kore.ai";url=window.appConfig.WORKBENCH_SERVER_URL+"/workbench"}return url},$rootScope.$on("$locationChangeStart",function(event,next,current){if($(".join-accounts-modal .pendingAccounts").length||$(".join-accounts-modal .requestAck").length)return void security.logout();if($(".alert-modal.navigationRouteModule").length)return!1;var _inAppBack=$("#dialogCloseAction"),isBotDetalForm=$("#botDetailsFormDir"),isBotForm=$("#botsFormDir");if(_inAppBack.length&&security.isAuthenticated()){console.log("#dialogCloseAction"),event.preventDefault();var message='<p><i class="fa fa-exclamation-circle fa-2x" aria-hidden="true" style="color: #009dac;"></i></p> "'+i18n.i18nString("are_you_sure")+'"</br>"'+i18n.i18nString("want_navigate")+'"';return void window.bootbox.dialog({message:message,title:"",className:"alert-modal zindexshowmodal navigationRouteModule",buttons:{main:{label:i18n.i18nString("no"),className:"btn closeCancel",callback:angular.noop},yes:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){$timeout(function(){_inAppBack[_inAppBack.length-1].click()})}}},onEscape:!1,closeButton:!1})}if(isBotDetalForm&&isBotDetalForm.length&&security.isAuthenticated()){console.log("#botDetailsFormDir"),event.preventDefault();var backHome='<p><i class="fa fa-exclamation-circle fa-2x" aria-hidden="true" style="color: #009dac;"></i></p> "'+i18n.i18nString("are_you_sure")+'"</br>"'+i18n.i18nString("want_navigate")+'"';return void window.bootbox.dialog({message:backHome,title:"",className:"alert-modal zindexshowmodal navigationRouteModule",buttons:{main:{label:i18n.i18nString("no"),className:"btn closeCancel",callback:angular.noop},yes:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){$timeout(function(){$(".backToBotList").click()})}}},onEscape:!1,closeButton:!1})}if(isBotForm&&isBotForm.length&&security.isAuthenticated()){console.log("#botsFormDir"),event.preventDefault();var popMessage='<p><i class="fa fa-exclamation-circle fa-2x" aria-hidden="true" style="color: #009dac;"></i></p> "'+i18n.i18nString("are_you_sure")+'"</br>"'+i18n.i18nString("want_navigate")+'"';return void window.bootbox.dialog({message:popMessage,title:"",className:"alert-modal zindexshowmodal navigationRouteModule",buttons:{main:{label:i18n.i18nString("no"),className:"btn closeCancel",callback:angular.noop},yes:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){$timeout(function(){security.logout()})}}},onEscape:!1,closeButton:!1})}/\/alert|action\/.*\/edit/.test(current)&&($workflowService.alertInfo()||$workflowService.actionInfo()||$location.path(window.appConfig.CONTEXT_PATH))}),$rootScope._constants_=_constants_}])}(angular),function(ng){"use strict";var btBuilderApp=ng.module("BuilderApp");btBuilderApp.controller("MainController",["$scope","$rootScope","$location","$localstorage","$window","$timeout","$endpoints","_constants_","$http","BTSeedDataService","BTProcessAppDataService","$workflowService","BTStreamsService","$translator","env_conf","$applicationService","security","$sce","$sanitize","$modal","$modalStack","AuthService","NotificationService","scriptLoader","$route","BTFileUploadService","languageConfig","localstore","jsEvents","i18n","mixPanel",function($scope,$rootScope,$location,$localstorage,$window,$timeout,$endpoints,_constants_,$http,BTSeedDataService,BTProcessAppDataService,$workflowService,BTStreamsService,$translator,env_conf,$applicationService,security,$sce,$sanitize,$modal,$modalStack,AuthService,NotificationService,scriptLoader,$route,BTFileUploadService,languageConfig,localstore,jsEvents,i18n,mixPanel){function checkOnboarding(){$scope.checkingOnboarding=setInterval(function(){$scope.mainControlDependencies.securityAuthenticated&&$scope.mainControlDependencies.translationsLoaded&&(clearInterval($scope.checkingOnboarding),console.log("completed checking user status"),$scope.securityAuthenticated&&($rootScope.koreUserInfo.isBotsOnboarded||$scope.showWelcomeForm()))},1e3)}function load(){function updateUserProfile(userObj){var _usrInfo=localstore.getAuthData();_usrInfo.currentAccount.userInfo=angular.copy(userObj.koreUserInfo,_usrInfo.currentAccount.userInfo),$rootScope.koreUserInfo=_usrInfo.currentAccount.userInfo,"no-avatar"!==$rootScope.koreUserInfo&&($rootScope.profileImgLinkPrefix=$endpoints.baseUrl+$endpoints.apiPreFix+"/getMediaStream/profilePictures/"+$applicationService.userInfo().userId+"/r_64x64_profile.png",$rootScope.profileImgLinkPrefix=$rootScope.profileImgLinkPrefix+"?v=1.1"+1e3*Math.random()),localstore.getAuthData(_usrInfo)}$scope.mainLoad=!0;var showNotificationBar=!0;$scope._trainStatus=null,$scope._speechTrainStatus=null,$scope.showClaimDomain=!1,$scope.claimDomainMsg=i18n.i18nString("claim_your_domain"),$rootScope.$on("$locationChangeStart",function(event,to,from){/alert|action|new/.test(to)||($scope.showControls=!1,$scope.$emit("WORKFLOW_FINISHED"))}),$scope.launchUserProfile=function(){function showUserProfileModal(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-user-profile/bt-user-profile.html",controller:"BTUserProfileCtrl",backdrop:"static",windowClass:"taskCreateOverlayModal userOverlay height-width-100 bt-user-profile-modal",resolve:{config:function(){return{cbBridge:updateUserProfile}}}}),$rootScope.$on("onUserprofileClose",function(){$modalStack.dismissAll()})}$timeout(function(){showUserProfileModal()},500)},$scope.switchBotStore=function(){var targetURL=$endpoints.baseUrl;$window.open(targetURL+"/enterprise","_blank")},$scope.launchAdminConsole=function(){var targetURL=window.appConfig.BOT_ADMIN_URL;targetURL&&$window.open(targetURL,"_blank")},$scope.skipUpdateBar=function(){AuthService.profileUpdate({enableTips:!1}).then(function(res){$(".notificationHeader").css("height","0"),$applicationService.userInfo()&&$applicationService.userInfo().koreUserInfo&&($applicationService.userInfo().koreUserInfo.enableTips=!1)},function(err){console.error("Error updating enableTips info")})},$scope.getTextIncludingTags=function(name){return name&&name.trim()?name.replace(/&lt;/g,"<").replace(/&gt;/g,">"):""},$scope.launchBotStore=function(){var targetURL=window.appConfig.MP_URL;$window.open(targetURL,"_blank")},$scope.launchKoreMessaging=function(){var targetURL=window.appConfig.MESSENGER_URL;targetURL&&$window.open(targetURL,"_blank")},$rootScope.isAdmin=function(){var _selectedAcc=$workflowService.selectedAccount();return _selectedAcc&&_selectedAcc.roles&&_selectedAcc.roles.length>0&&_selectedAcc.roles.indexOf("admin")>-1?!0:!1},$rootScope.isAdminCheck=function(){var _selectedAcc=$workflowService.selectedAccount();return _selectedAcc&&_selectedAcc.roles&&_selectedAcc.roles.length>0?!0:!1},$rootScope.showConfirmationPopup=function(msg,callBackFn){NotificationService.alert(msg,callBackFn,arguments)},$rootScope.scrollToDiv=function(parentEle,targetEle){$timeout(function(){$(parentEle).animate({scrollTop:$(targetEle).position().top},800,"swing")},800)},window.$location=$location,$rootScope.logOut=function(){$location.search(""),$timeout(function(){localStorage.removeItem("previousState"),security.logout()},500)},$rootScope.redirectToLink=function(linkType,event,isExtLink){event&&(event.stopImmediatePropagation(),event.stopPropagation());var targetURL="https://developer.kore.ai/docs/bots/bot-builder/";linkType&&(targetURL=$rootScope.helpLinks[linkType]),isExtLink&&(targetURL=linkType),$window.open(targetURL,"_blank")},$rootScope.getSanitizedText=function(text){text=text||"";try{text=$sanitize(text)}catch(ex){console.warn(ex)}return text},botOptions.logLevel="debug",botOptions.koreAPIUrl=$endpoints.urlWithVersion,botOptions.assertionFn=assertion,botOptions.koreAnonymousFn=koreAnonymousFn,botOptions.test=!1,botOptions.showDownloadPopUps=_constants_.showDownloadPopUps,botOptions.openDownloadfWarnModal=function(cb){function startExport(){cb()}function cancleExport(){}function checkBoxCb(checkValue){_constants_.updateDownloadPopUppreferance(checkValue)}_constants_.config.showDownloadPopUps?NotificationService.userConfirm(_constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("download")):startExport()},$rootScope.isOnPremise()&&!window.appConfig.USE_SERVER_SOCKET_URL&&(botOptions.reWriteSocketURL={protocol:"https"===location.protocol||"https:"===location.protocol?"wss":"ws",hostname:location.hostname,port:location.port}),botOptions.botInfo={},botOptions.client="botbuilder",chatConfig={chatTitle:"Kora Bot",botOptions:botOptions,allowIframe:!1,isTTSEnabled:!0,isSpeechEnabled:!0,isSpeechAuthorizationRequired:_constants_.config.ENABLE_SPEECH_AUTHORIZATION,allowGoogleSpeech:!1,googleSpeechKey:_constants_.config.googleSpeechAPIKey,allowLocation:window.appConfig.ENABLE_SHARE_LOCATION,loadHistory:_constants_.config.loadHistory,messageHistoryLimit:10,autoEnableSpeechAndTTS:_constants_.config.autoEnableSpeechAndTTS,graphLib:_constants_.config.graphLib,pickersConfig:{showDatePickerIcon:!1,showDateRangePickerIcon:!1,showClockPickerIcon:!1,showTaskMenuPickerIcon:!1,showradioOptionMenuPickerIcon:!1}},authToken=null,$scope.initialTTSEnaleDecision=chatConfig.isTTSEnabled,$scope.welcomeFormCb.selectBot=function(bot){$scope.callbacks&&$scope.callbacks.selectOrChangeBot&&$scope.callbacks.selectOrChangeBot(bot)},$scope.welcomeFormCb.showView=function(viewType){$scope.callbacks&&$scope.callbacks.showView&&$scope.callbacks.showView(viewType)},$scope.closeNotificationBar=function(){showNotificationBar=!1,$scope.showClaimDomain=!1},$scope.welcomeFormCb.showView=function(viewType){$scope.callbacks&&$scope.callbacks.showView&&$scope.callbacks.showView(viewType)},$scope.closeNotificationBar=function(){showNotificationBar=!1,$scope.showClaimDomain=!1}}function stopAutoTrainStatusPoll(){$scope._trainStatus&&(clearTimeout($scope._trainStatus),$scope._trainStatus=null)}function pollTrainStatus(timeout){return setInterval(function(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data?"Finished"===res.data.trainingStatus?(NotificationService.notify(i18n.i18nString("bot_training_completed"),"success"),stopAutoTrainStatusPoll(),$rootScope.$emit("MLUtterencesTrainFinished"),$rootScope.$emit("MLScoreUtterencesTrainFinished"),$rootScope.$emit("TestTrainUtterencesTrainFinished"),$rootScope.$emit("IntentUtterencesTrainFinished"),$rootScope.$emit("SmallTalkTrainFinished"),$rootScope.$emit("patternTrainFinished"),$rootScope.$broadcast("SynonymsTrainFinished"),$rootScope.$emit("linkedBotTrainingFinished"),$rootScope.$emit("isMlInSyncWithEntityRules")):"Failed"===res.data.trainingStatus&&(NotificationService.notify(i18n.i18nString("bot_training_failed"),"error"),stopAutoTrainStatusPoll(),$rootScope.$emit("MLUtterencesTrainFailed"),$rootScope.$emit("MLScoreUtterencesTrainFailed"),$rootScope.$emit("IntentUtterencesTrainFailed"),$rootScope.$emit("SmallTalkTrainFailed"),$rootScope.$emit("patternTrainFailed"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("SynonymsTrainFailed"),$rootScope.$emit("linkedBotTrainingFailed"),$rootScope.$emit("isMlInSyncWithEntityRules")):(NotificationService.notify(i18n.i18nString("bot_training_failed"),"error"),stopAutoTrainStatusPoll(),$rootScope.$emit("MLUtterencesTrainFailed"),$rootScope.$emit("IntentUtterencesTrainFailed"),$rootScope.$emit("SmallTalkTrainFailed"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("SynonymsTrainFailed"))},function(err){stopAutoTrainStatusPoll();var _msg=i18n.i18nString("error_on_fetching_bot_train_status");err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(_msg,"error"),$rootScope.$emit("MLUtterencesTrainFailed"),$rootScope.$emit("IntentUtterencesTrainFailed")})},timeout)}function stopSpeechTrainStatusPoll(){$scope._speechTrainStatus&&(clearTimeout($scope._speechTrainStatus),$scope._speechTrainStatus=null)}function pollSpeechTrainStatus(timeout){return setInterval(function(){BTStreamsService.trainBotSpeechStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&"TRAINED"===res.data.status?(NotificationService.notify(i18n.i18nString("bot_training_completed"),"success"),stopSpeechTrainStatusPoll(),$rootScope.$emit("MLSpeechTrainFinished")):(res&&res.data&&"ERROR"===res.data.status||"AUTHORIZATION_CHECK_FAILURE"===res.data.status||"INVALID_ACCESS_TOKEN"===res.data.status)&&(NotificationService.notify(i18n.i18nString("bot_speech_training_failed"),"error"),stopSpeechTrainStatusPoll(),$rootScope.$emit("MLSpeechTrainFailed"))},function(err){stopSpeechTrainStatusPoll();var _msg=i18n.i18nString("error_on_fetching_speech_train_status");err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(_msg,"error"),$rootScope.$emit("MLSpeechTrainFailed")})},timeout)}function invalidateLocalStore(){var _usrInfo=localstore.getAuthData();if(localstore.removeSelectedAccount(),localstore.setAuthData({}),_usrInfo&&_usrInfo.currentAccount&&_usrInfo.currentAccount.userInfo&&_usrInfo.currentAccount.userInfo.emailId){var _oldEmail={email:_usrInfo.currentAccount.userInfo.emailId};window.localStorage.setItem("emailIdStorage",JSON.stringify(_oldEmail))}window.location.reload(!0)}function showMaxRequestLimit(response){var _msg2="";response&&response.data&&response.data.errors&&response.data.errors.length&&response.data.errors[0]&&response.data.errors[0].msg&&(_msg2=response.data.errors[0].msg);var linkObj={link:"https://developer.kore.ai/docs/bots/bot-settings/bot-management/subscription-plans/",text:"here",okText:i18n.i18nString("ok")};NotificationService.alert(_msg2,function(){},{linkObj:linkObj})}function getAccessToken(){var authObj=$translator.getAuthObj();return authToken=authObj.token_type+" "+authObj.accessToken}function getProcessAppsData(){BTProcessAppDataService.getProcessAppsData().then(function(res){$workflowService.processAppsData(res.data.pfApplications),$rootScope.$emit("updateProcessData")},function(err){$workflowService.processAppsData([])})}function accept(){var url="mp.user.acceptbtlicense",params={userId:$applicationService.userInfo().userId};$translator.translate(url,params).then(function(){},function(){})}function getSeedData(){var url;url=env_conf["components-source"],BTSeedDataService.getSeedData().then(function(res){$workflowService.seedData(res.data),languageConfig.prepareLanguage()},function(err){$workflowService.seedData([])}),$http.get(url+"config/templates.json").then(function(res){$workflowService.templates(res.data)}),$rootScope.changeLanguage("en_us")}function destroyApp(){chatApp&&chatApp.destroy&&(_loggerInstance.isRecording=!1,$(".talkToBot").hasClass("minimized-bot")&&$(".talkToBot").removeClass("minimized-bot"),chatApp.destroy())}function getDomain(){var _usrInfo=$applicationService.userInfo().koreUserInfo,emailID=_usrInfo.emailId,domainName=emailID.split("@"),domain=domainName[1].split(".");$scope.userDomain=domain[0],$scope.userDomain&&"kore"===$scope.userDomain.toLowerCase()?$("body").addClass("kore-user"):$("body").addClass("non-kore-user")}function assertion(options,callback){var authData;try{authData=JSON.parse(localStorage.getItem("ls.bt.userInfo"))}catch(ex){security.logout()}$translator.translate("bt.post.sts",{}).then(function(res){var data=res.data;options.assertion=data.jwt,options.chatHistory=chatApp.chatHistory,options.botDetails=chatApp.botDetails,callback(null,options)})}function download(filename,data){if(navigator.msSaveBlob){var blob=new Blob([data],{type:"data:text/plain;charset=utf-8"});return window.navigator.msSaveOrOpenBlob(blob,filename)}var element=document.createElement("a");element.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(data)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}$scope.mainCntrlCb={};var _botInfo,botOptions={},chatConfig={},onBoardingFlow={onboardingJourneyStarted:!1,onboardingJourneyCompleted:!1};$scope.mainControlDependencies={securityAuthenticated:!1,translationsLoaded:!1},$scope.welcomeFormCb={};var _loggerInstance={};botOptions.logLevel="debug",botOptions.koreAPIUrl=$endpoints.urlWithVersion,botOptions.assertionFn=assertion,botOptions.koreAnonymousFn=koreAnonymousFn,botOptions.test=!1,botOptions.showDownloadPopUps=_constants_.showDownloadPopUps,botOptions.openDownloadfWarnModal=function(cb){function startExport(){cb()}function cancleExport(){}function checkBoxCb(checkValue){_constants_.updateDownloadPopUppreferance(checkValue)}_constants_.config.showDownloadPopUps?NotificationService.userConfirm(_constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("download")):startExport()},$rootScope.licenseUpdate=!1,$rootScope.isOnPremise=function(){return window.appConfig.ON_PREMISE},$rootScope.isOnPremise()&&!window.appConfig.USE_SERVER_SOCKET_URL&&(botOptions.reWriteSocketURL={protocol:"https"===location.protocol||"https:"===location.protocol?"wss":"ws",hostname:location.hostname,port:location.port}),botOptions.botInfo={},botOptions.client="botbuilder",chatConfig={chatTitle:"Kora Bot",botOptions:botOptions,allowIframe:!1,isTTSEnabled:!0,isSpeechEnabled:!0,allowGoogleSpeech:!1,messageHistoryLimit:10,pickersConfig:{showDatePickerIcon:!1,showDateRangePickerIcon:!1,showClockPickerIcon:!1,showTaskMenuPickerIcon:!1,showradioOptionMenuPickerIcon:!1}};var chatApp,authToken=null;$scope.checkingOnboarding=null,clearInterval($scope.checkingOnboarding),$scope.selectAccount=function(account){if(localstore.setFromLoginScreenFlag(),localStorage.removeItem("previousState"),account.hasOwnProperty("idp")){var dataobject={};dataobject.username=$applicationService.userInfo().appControls.userInfo.emailId,dataobject.idp=account.idp,account.client_email=$applicationService.userInfo().appControls.userInfo.emailId,localStorage.setItem("selectedSSOAccount",JSON.stringify(account)),security.handleSSORedirect(dataobject,"direct")}else localStorage.removeItem("selectedSSOAccount"),localstore.setSelectedAccount(account),window.location.reload()},$rootScope.$on("botTestStart",function($event,data,containerInfo,debugFn,debugConsoleTrigger,onNewMessageCallback,botHistoryUpdateCB,recordProgress,recordStop,_userInfo){function getContextObj(){if(_queue.length&&!_serviceInProgress){var _event=_queue[_queue.length-1],_contextId=_event.contextId;_queue=[],_serviceInProgress=!0,BTStreamsService.getContextById(_contextId,$workflowService.selectedStream()._id).then(function(res){if(_serviceInProgress=!1,_event.context=res.data,debugFn(_event),_queue.length){var lasteventUpdateObj=_queue[_queue.length-1],eventUpdate=moment(lasteventUpdateObj.updatedOn),lastUpdate=moment(res.data.updatedOn);(_contextId!==lasteventUpdateObj.contextId||eventUpdate.isAfter(lastUpdate))&&getContextObj()}},function(res){_serviceInProgress=!1})}}var eventInfo={$email:$applicationService.userInfo().emailPhone,FirstName:$applicationService.userInfo().firstName,LastName:$applicationService.userInfo().lastName,Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Storyboard"};mixPanel.postEvent("Conversation - Talk to Bot",eventInfo),_botInfo=data,chatConfig.sesId=_userInfo.authObj.sesId,localStorage.setItem("currentBotLanguage",$workflowService.currentLanguage()),_botInfo&&(chatConfig.botOptions.botInfo=_botInfo,chatConfig.botOptions.speechSocketUrl="wss://speech.kore.ai/stream/kore/decode",
chatConfig.botOptions.ttsSocketUrl="wss://speech.kore.ai/tts/ws",chatConfig.botOptions.koreSpeechAPIUrl=window.appConfig.SDK_SPEECH_URL),void 0!==containerInfo?(chatConfig.container=containerInfo,chatConfig.DisableDragResize=!0):(chatConfig.container="body",chatConfig.DisableDragResize=!1),chatConfig.botOptions||(chatConfig.botOptions={}),chatConfig.botIcon=$workflowService.selectedStream().icon,chatConfig.allowGoogleSpeech=window.appConfig.ENABLE_GOOGLE_SPEECH,window.appConfig.ON_PREMISE&&(chatConfig.googleSpeechKey=window.appConfig.GOOGLE_SPEECH_API_KEY),chatConfig.botOptions.userIdentity=JSONPath({json:localstore.getAuthData(),path:"$..currentAccount.userInfo.emailId"})[0],chatConfig.botOptions.recorderWorkerPath=env_conf["speech-worker-url"],chatConfig.isSendButton=!1,$scope.initialTTSEnaleDecision&&(chatConfig.isTTSEnabled="en"===_botInfo.defaultLanguage?!0:!1),destroyApp(),$rootScope.isConversationTesting?chatConfig.isConversationTesting=$rootScope.isConversationTesting:chatConfig.isConversationTesting=!1;var logger_config={botName:botOptions.botInfo.name,botId:botOptions.botInfo._id};_loggerInstance=new KoreLogger(logger_config);var _chatWinConfig={koreLogger:_loggerInstance};$rootScope.$broadcast("loggerInstance",_loggerInstance);var koreBot=koreBotChat(_chatWinConfig,i18n);$rootScope.koreBot=koreBot,chatApp=koreBot.show(chatConfig),"function"==typeof debugConsoleTrigger&&chatApp.addListener("debugConsole",debugConsoleTrigger),"function"==typeof recordProgress&&chatApp.addListener("recordInProgress",recordProgress),"function"==typeof recordStop&&chatApp.addListener("recordStop",recordStop);var _queue=[],_serviceInProgress=!1,debugFunInstance=function(data){data.contextId&&"contextUpdate"===data.type?(_queue.push(data),getContextObj()):debugFn(data)};debugFn&&chatApp.addListener("debugLog",debugFunInstance),"function"==typeof onNewMessageCallback&&chatApp.addListener("newMessageEvent",onNewMessageCallback),"function"==typeof botHistoryUpdateCB&&chatApp.addListener("botHistoryUpdate",botHistoryUpdateCB),chatApp.addListener("message",function(msg){console.log("Received Message::",msg.data);var dataObj=JSON.parse(msg.data);"bot"===dataObj.from&&"bot_response"===dataObj.type&&console.log(dataObj)}),chatApp.addListener("startTraining",function(){$rootScope.$broadcast("getProgressDockStatus"),BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){NotificationService.notify(i18n.i18nString("bot_train"),"info"),$rootScope.$emit("triggerAutoTrainStatusPoll")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})})}),$rootScope.$on("botTestEnd",function($event){destroyApp()}),$rootScope.$on("downloadChatJson",function($event){var chatData=JSON.stringify(_loggerInstance.getData());$rootScope.recordedChatData=chatData,download("TestSuit.json",chatData),_loggerInstance.newTestSuit&&_loggerInstance.newTestSuit()}),$rootScope.$on("closeDownloadModal",function($event){$(".record-btn").removeClass("record-btn").addClass("record-stop")}),$rootScope.$on("triggerAutoTrainStatusPoll",function($event){stopAutoTrainStatusPoll();var _trainStatus=pollTrainStatus(10);setTimeout(function(){clearTimeout(_trainStatus),_trainStatus=null,$scope._trainStatus=pollTrainStatus(2e4)},10)});var autoTrainStatusHandler=$rootScope.$on("stopAutoTrainStatusPoll",function($event){stopAutoTrainStatusPoll()});$rootScope.$on("triggerSpeechTrainStatusPoll",function($event){stopSpeechTrainStatusPoll();var _trainStatus=pollSpeechTrainStatus(10);setTimeout(function(){clearTimeout(_trainStatus),_trainStatus=null,$scope._speechTrainStatus=pollSpeechTrainStatus(3e5)},10)}),$rootScope.$on("stopSpeechTrainStatusPoll",function($event){stopSpeechTrainStatusPoll()}),$("#reAuthBtnOk").click(function(){invalidateLocalStore()}),window.invalidateLocalStore=invalidateLocalStore,window.showMaxRequestLimit=showMaxRequestLimit,$scope.showWelcomeForm=function(guideId){if(!onBoardingFlow.onboardingJourneyStarted){onBoardingFlow.onboardingJourneyStarted=!0;var eventInfo={$email:$applicationService.userInfo().emailPhone,FirstName:$applicationService.userInfo().firstName,LastName:$applicationService.userInfo().lastName,Category:"Onboarding",SubCategory:"Welcome Message","Event Description":"When the user lands on the welcome message with the options of either collaborating on an existing prooject vs creating a virtual assistant vs creating process app"};mixPanel.postEvent("User Onboarding - Welcome",eventInfo)}$scope.welcomeFormCb.selectAccount=$scope.selectAccount,guideId?$scope.welcomeFormCb.guideId=guideId:$scope.welcomeFormCb.guideId=null,$(".bt-welcome-modal").length&&$(".bt-welcome-modal").remove();$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-welcome-form/bt-welcome.html",controller:"BTWelcomeForm",windowClass:"bt-welcome-modal",backdrop:"static",size:"lg",resolve:{config:function(){return{component:$scope.welcomeFormCb||{}}}}});setTimeout(function(){$(".bt-welcome-modal").css({"z-index":"1050"})},500)},$scope.startTourGuide=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-guided-tour/bt-guided-tour.html",controller:"BTGuidedTour",windowClass:"bt-guided-modal",backdrop:"static",keyboard:!1,resolve:{config:function(){return{component:$scope.welcomeFormCb||{}}}}})},$rootScope.$on("startTourGuide",$scope.startTourGuide),$rootScope.$on("security:authenticated",function($event){console.log("security:authenticated"),window.appConfig.SESSION_VALIDITY_POLLING&&jsEvents.securityAuthenticationStatus();var userData=$applicationService.userInfo().appControls.userInfo,appControls=$applicationService.userInfo().appControls;$rootScope.koreUserInfo=userData,"no-avatar"!==$rootScope.koreUserInfo&&($rootScope.profileImgLinkPrefix=$endpoints.baseUrl+$endpoints.apiPreFix+"/getMediaStream/profilePictures/"+$applicationService.userInfo().userId+"/r_64x64_profile.png",$rootScope.profileImgLinkPrefix=$rootScope.profileImgLinkPrefix+"?v=1.1"+1e3*Math.random()),(!userData.isBTLicenseAccepted||appControls.isBillingEnabled&&!userData.isBTLicenseAccepted_update)&&(userData.isBTLicenseAccepted?userData.isBTLicenseAccepted_update||($rootScope.licenseUpdate=!0):accept()),!appControls.associatedAccounts.length||appControls.isSelectAccountFlow?$location.path(window.appConfig.CONTEXT_PATH+"/accountsetup"):(botOptions.bearer=getAccessToken,getSeedData(),$location.path(window.appConfig.CONTEXT_PATH),$scope.securityAuthenticated=!0,$scope.mainControlDependencies.securityAuthenticated=!0,setTimeout(function(){getProcessAppsData()},2e3),setTimeout(function(){checkOnboarding()},500),setTimeout(function(){$rootScope.$broadcast("security:loadbotshome",null)},200)),$scope.showClaimDomain=!1,getDomain()}),$scope.initialTTSEnaleDecision=chatConfig.isTTSEnabled,$scope.$on("$destroy",function(){clearInterval($scope.checkingOnboarding),autoTrainStatusHandler()}),$rootScope.$on("closeProgressModal",function($event){chatApp.closeModal(chatConfig)}),$rootScope.$on("minimizeBot",function($event){chatApp.minimizeBot(chatConfig)}),$rootScope.$on("startRecording",function($event){chatApp.startRecording(chatConfig)}),$rootScope.$on("stopRecording",function($event){chatApp.stopRecording(chatConfig)}),$rootScope.$on("loadMainCtrl",function($event){console.log("loadMainCtrl"),$scope.mainControlDependencies.translationsLoaded=!0;var language;angular.element(document.querySelector(".landingPleaseWait"));language=localStorage.getItem("queryParamLang"),load()})}]),function($){$("#xUpgradeBtnCancel").click(function(){window.location.href=window.location.origin+"?showLogin=true"}),$("#upgradeBtnCancel").click(function(){window.location.href=window.location.origin+"?showLogin=true"}),$("#xTermsBtnCancel").click(function(){window.location.href=window.location.origin+"?showLogin=true"}),$("#upgradeBtn").click(function(){"individual"===window.__licenceType?window.location.href=window.location.origin+"#_messages?info=account":window.location.href=window.location.origin+"?showLogin=true"}),$("#reloadBtnOk").click(function(){window.localStorage.kore_builder_version=window._buliderVersion,window.location.reload(!0)}),$.fn.hasScrollBar=function(){return this.get(0)?this.get(0).scrollHeight>this.innerHeight():!1}}(jQuery),function(){_.bounce=function(value){return value},_.addProps=function(condition,dest,source){return condition&&_.merge(dest,source),dest},_.delProps=function(condition,dest,source){return condition&&Object.keys(source).map(function(key){delete dest[key]}),dest}}()}(angular),function(ng){"use strict";var btBuilderApp=ng.module("BuilderApp");btBuilderApp.config(["$routeProvider",function($routeProvider){var originalWhen=$routeProvider.when;$routeProvider.when=function(path,route){route.resolve||(route.resolve={});return angular.extend(route.resolve,{dependents:function(appResover){return appResover.resolveDependencies()}}),originalWhen.call($routeProvider,path,route)},$routeProvider.when(window.appConfig.CONTEXT_PATH?window.appConfig.CONTEXT_PATH:"/",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bots-landing-forms/bots-home/bots-home.html",controller:"botsHomeCtrl"}).when(window.appConfig.CONTEXT_PATH+"/login",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-login/bt-login.html",controller:"BTLoginCtrl",reloadOnSearch:!1}).when(window.appConfig.CONTEXT_PATH+"/info/:infoType",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-login/templates/bt-information.html",controller:"BTInfoCtrl"}).when(window.appConfig.CONTEXT_PATH+"/requestsfbtaccess",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-login/templates/sf-bt-request-access.html",controller:"STBTRequestAccessCtrl"}).when(window.appConfig.CONTEXT_PATH+"/requestbtaccess",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-login/templates/bt-request-access.html",controller:"BTRequestAccessCtrl"}).when(window.appConfig.CONTEXT_PATH+"/acceptbtlicense",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-login/templates/bt-accept-license.html",controller:"BTAcceptLicenseCtrl"}).when(window.appConfig.CONTEXT_PATH+"/accountsetup",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/account-setup/account-setup.html",controller:"BTAccountSetupCtrl"}).when(window.appConfig.CONTEXT_PATH+"/streamcreate",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-stream-create/bt-stream-create.html",controller:"BTStreamCreateCtrl"}).when(window.appConfig.CONTEXT_PATH+"/flowTask/new",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-flowtask-create/bt-flowtask-create.html",controller:"BTFlowTaskCreateCtrl"}).when(window.appConfig.CONTEXT_PATH+"/flowTask/edit/:flowtaskID",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-flowtask-edit/bt-flowtask-edit.html",controller:"BTFlowTaskEditCtrl"}).when(window.appConfig.CONTEXT_PATH+"/flowTask/view/:flowtaskID",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-flowtask-view/bt-flowtask-view.html",controller:"BTFlowTaskViewCtrl"}).when(window.appConfig.CONTEXT_PATH+"/knowledgecreate",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-knowledge-create/bt-knowledge-create.html",controller:"BTKnowledgeCreateCtrl"}).when(window.appConfig.CONTEXT_PATH+"/knowledge/:displayMode/:knowledgeID",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-knowledge-create/bt-knowledge-create.html",controller:"BTKnowledgeCreateCtrl"}).when(window.appConfig.CONTEXT_PATH+"/streamedit/:streamId",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-stream-edit/bt-stream-edit.html",controller:"BTStreamEditCtrl"}).when(window.appConfig.CONTEXT_PATH+"/utterances/:streamId",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/utterances-module/utterances-module.html",controller:"UtterancesModuleCtrl"}).when(window.appConfig.CONTEXT_PATH+"/patterns/:streamId",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/patterns-module/patterns-module.html",controller:"PatternsModuleCtrl"}).when(window.appConfig.CONTEXT_PATH+"/synonyms/:streamId",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/synonyms-module/synonyms-module.html",controller:"SynonymsModuleCtrl"}).when(window.appConfig.CONTEXT_PATH+"/new",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-create/bt-wf-create.html",controller:"BTWFCreateCtrl"}).when(window.appConfig.CONTEXT_PATH+"/nlp/bots/:botId/chatsettings",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-chat-settings/bt-chat-settings.html",controller:"BTChatSettings"}).when(window.appConfig.CONTEXT_PATH+"/stream/:streamId/channel/:channelId",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/channel-forms/bot-channels-form.html",controller:"botChannelsController"}).when(window.appConfig.CONTEXT_PATH+"/stream/:streamId/new/channel/:createChannel",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bot-forms/channel-forms/bot-channels-form.html",controller:"botChannelsController"}).when(window.appConfig.CONTEXT_PATH+"/:resourceType/:resourceId/action/:action",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-edit/bt-wf-edit.html",controller:"BTWFEditCtrl"}).when(window.appConfig.CONTEXT_PATH+"/:resourceType/:resourceId/map/:mapId",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-mapping/bt-wf-mapping.html",controller:"BTWFMappingCtrl"}).when(window.appConfig.CONTEXT_PATH+"/:resourceType/:resourceId/versionHistory",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-resource-versions/bt-resource-versions.html",controller:"BTResourceVersionsCtrl"}).when(window.appConfig.CONTEXT_PATH+"/:taskType/:taskId/logs",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-logs-view/bt-wf-logs-view.html",controller:"BTWfLogsViewCtrl"}).when(window.appConfig.CONTEXT_PATH+"/bot/solution/install",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-solution-install/bt-solution-install.html",controller:"BTSolutionInstall"}).when(window.appConfig.CONTEXT_PATH+"/botpublish",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-bot-publish/bt-bot-publish.html",controller:"BTBotPublishCtrl"}).when(window.appConfig.CONTEXT_PATH+"/:resourceType/:resourceId/:flowtype",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-resource-view/bt-resource-view.html",controller:"BTResourceViewCtrl"}).when(window.appConfig.CONTEXT_PATH+"/bot/changelog",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-changelog/bt-changelog.html",controller:"BTChangeLogCtrl"}).when(window.appConfig.CONTEXT_PATH+"/createtaskoverlay",{templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/components/task-create-overlay/task-create-overlay.html",controller:"taskCreateOverlayController"}).otherwise({redirectTo:window.appConfig.CONTEXT_PATH?window.appConfig.CONTEXT_PATH:"/"})}])}(angular),function(ng){"use strict";ng.module("factories",[])}(angular),function(ng){"use strict";ng.module("factories").factory("builderUtility",function($timeout){var _builderUitility={textToHtml:function(input){return input=input||"",input=input.replace(/&lt;/g,"<").replace(/&gt;/g,">")},htmlToText:function(iput){return input=input||"",input=input.replace(/</g,"&lt;").replace(/>/g,"&gt;"),input},openModal:function(modalEle){$(modalEle).modal("show")},closeModal:function(modalEle){$(modalEle).modal("hide")},openModalSlider:function(modalEle,parentSelector){var sliderEle=$(modalEle);parentSelector&&(sliderEle=$(parentSelector).find(modalEle)),sliderEle.addClass("open"),sliderEle.show(),sliderEle.find(".botModalDialog").animate({right:"0"}),$("body").addClass("bt-modal-open")},openBottomModalSlider:function(modalEle,parentSelector){var sliderEle=$(modalEle);parentSelector&&(sliderEle=$(parentSelector).find(modalEle)),sliderEle.addClass("open"),sliderEle.show(),sliderEle.find(".botModalDialog").animate({bottom:"-55px"}),$("body").addClass("bt-modal-open")},closeModalSlider:function(modalEle,parentSelector){var sliderEle=$(modalEle);parentSelector&&(sliderEle=$(parentSelector).find(modalEle)),sliderEle.removeClass("open"),sliderEle.find(".botModalDialog").animate({right:"-"+sliderEle.find(".botModalDialog").width()+"px"}),$timeout(function(){sliderEle.hide(),$(".modal-backdrop.in").is(":visible")||$("body").removeClass("bt-modal-open")},200)},closeBottomModalSlider:function(modalEle,parentSelector){var sliderEle=$(modalEle);parentSelector&&(sliderEle=$(parentSelector).find(modalEle)),console.log(sliderEle.find(".botModalDialog").height()),sliderEle.find(".botModalDialog").animate({bottom:"-"+sliderEle.find(".botModalDialog").height()+"px"}),$timeout(function(){sliderEle.removeClass("open"),sliderEle.hide(),$(".modal-backdrop.in").is(":visible")||$("body").removeClass("bt-modal-open")},200)},rmBTModalOpenClass:function(){$("body").removeClass("bt-modal-open"),$("body").removeClass("modal-open")}};return _builderUitility})}(angular),function(ng){"use strict";ng.module("factories").factory("flowsUtil",[function(){function arrangeMappings(mappings){var results=[],obj={};return mappings.map(function(mapping,index){var key="";mapping.sourceResourceId&&mapping.targetResourceId?(key=mapping.sourceResourceId+"-"+mapping.targetResourceId,obj[key]?(compareVersion(obj[key].sourceResourceVersion,mapping.sourceResourceVersion,mapping)||compareVersion(obj[key].targetResourceVersion,mapping.targetResourceVersion,mapping))&&(obj[key].oldVersions.push(_.clone(obj[key])),obj[key].index=index,obj[key].sourceResourceVersion=mapping.sourceResourceVersion,obj[key].targetResourceVersion=mapping.targetResourceVersion):obj[key]={index:index,sourceResourceVersion:mapping.sourceResourceVersion,targetResourceVersion:mapping.targetResourceVersion,oldVersions:[]}):(key=mapping.alertId+"-"+mapping.actionId,obj[key]?(compareVersion(obj[key].alertVersion,mapping.alertVersion,mapping)||compareVersion(obj[key].actionVersion,mapping.actionVersion,mapping))&&(obj[key].oldVersions.push(_.clone(obj[key])),obj[key].index=index,obj[key].alertVersion=mapping.alertVersion,obj[key].actionVersion=mapping.actionVersion):obj[key]={index:index,alertVersion:mapping.alertVersion,actionVersion:mapping.actionVersion,oldVersions:[]})}),Object.keys(obj).map(function(key){var mapping=mappings[obj[key].index];mapping.oldVersions=[],obj[key].oldVersions.map(function(version){mapping.oldVersions.push(mappings[version.index]),"active"===mappings[version.index].state&&mapping.parentMapId===mappings[version.index].mapId&&(mappings[version.index].parentOf=mapping.mapId,results.push(mappings[version.index]))}),results.push(mapping)}),results}function compareVersion(version1,version2,mapping){return version1=version1.split(".").map(function(number){return+number}),version2=version2.split(".").map(function(number){return+number}),+version1[0]>+version2[0]?!1:+version1[0]==+version2[0]&&+version1[1]>+version2[1]?!1:+version1[0]==+version2[0]&&+version1[1]==+version2[1]&&"active"===mapping.state?!1:!0}return{arrangeFlows:arrangeMappings}}])}(angular),function(ng){"use strict";ng.module("factories").factory("templateCompiler",function($compile){var dirMap={noBotsForm:{js:"js/lazycomponents/nobots-form/nobots-form.js",template:'<nobots-form ng-if="views.noBotsForm" class="bots"></nobots-form>'},botsForm:{js:"js/lazycomponents/bots-form/bots-form.js",template:'<bots-form ng-if="views.botsForm"  class="bots myBots" id="botsFormDir"></bots-form>'},botDetailsForm:{js:"js/lazycomponents/bot-details-form/bot-details-form.js",template:'<bot-details-form ng-if="views.botDetailsForm"  class="botDetails botDetailsForm" id="botDetailsFormDir"></bot-details-form>'},botsBillingForm:{js:"js/lazycomponents/bots-billing/bots-billing.js",template:'<bots-billing ng-if="views.botsBillingForm" class="botsBilling"></bots-billing>'},teamForm:{js:"js/lazycomponents/team/team.js",template:'<team class="team" ng-if="views.teamForm"></team>'}},_builderUitility={getCompilerFn:function(id){return dirMap[id].compileFn},getDirectiveObject:function(id){return dirMap[id]},setCompileFn:function(id,compileFn){dirMap[id].compileFn=compileFn}};return Object.keys(dirMap).forEach(function(id){dirMap[id].id=id}),_builderUitility})}(angular),function(ng){"use strict";ng.module("services",[])}(angular),function(ng){"use strict";ng.module("services").service("accessControlService",function($workflowService){function prepareObject(result){return _clientResultObj=[],angular.forEach(Object.keys(result),function(component,key){var _clientCompObj={};_clientCompObj._id=component,_clientCompObj.VIEW=result[component].indexOf("VIEW")>-1?!0:!1,_clientCompObj.FULL=result[component].indexOf("FULL")>-1?!0:!1,_clientCompObj.NO=result[component].indexOf("NO")>-1?!0:!1,_clientCompObj.dependencies=[],dependencies[component]&&dependencies[component].length>0&&(_clientCompObj.dependencies=dependencies[component]),_clientResultObj.push(_clientCompObj)}),_clientResultObj}var _clientResultObj=[],viewMode="",result={},dependencies={BOTBUILDER_TASKS:["BOTBUILDER_KNOWLEDGE_GRAPH"],BOTBUILDER_NATURAL_LANGUAGE:["BOTBUILDER_BATCH_TESTING"],BOTBUILDER_BOT_SETTINGS:["BOTBUILDER_BOT_DEVELOPERS","BOTBUILDER_BOT_IMPORT"],BOTBUILDER_EXTENSIONS:["BOTBUILDER_APPS_AND_SCOPES"]},serverDependencies={BOTBUILDER_TASKS:["BOTBUILDER_NATURAL_LANGUAGE","BOTBUILDER_PUBLISH_BOT","BOTBUILDER_KNOWLEDGE_GRAPH"]},setPermissions=function(permissions){result=permissions,prepareObject(result)},getPermissions=function(){return _clientResultObj},getAccessRight=function(_componentid){var _serverComponent=_.find(_clientResultObj,{_id:_componentid});return _serverComponent&&"NO"===result[_serverComponent._id][0]?result[_serverComponent._id][0]:"published"===$workflowService.selectedStreamState()?"VIEW":_serverComponent&&"NO"!==result[_serverComponent._id][0]?result[_serverComponent._id][0]:void 0},setRetrieveValue=function(mode){return"published"===$workflowService.selectedStreamState()?"VIEW":mode?void(viewMode=mode):viewMode},getDependency=function(_componentid){var dependencyResult=_.find(_clientResultObj,{_id:_componentid});return dependencyResult?dependencyResult.dependencies:void 0},getServerDependency=function(_serverComponentId){var result=!1,serverDependencyList=serverDependencies[_serverComponentId];return angular.forEach(serverDependencyList,function(component,index){var accessRight=getAccessRight(component);"NO"!==accessRight&&(result=!0)}),result};return{getPermissions:getPermissions,getAccessRight:getAccessRight,setRetrieveValue:setRetrieveValue,getDependency:getDependency,setPermissions:setPermissions,getServerDependency:getServerDependency}})}(angular),function(ng){"use strict";ng.module("services").service("BTActionsService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var getActions=function(_streamId){return _streamId?translate("bt.streams.actions.get",{streamId:_streamId},{}):translate("bt.actions.get",{},{})},getBTAction=function(actionId){return translate("bt.actionsId.get",{actionId:actionId},{})},createBTAction=function(data){return translate("bt.actions.post",{},data)},updateBTAction=function(actionId,actionObj){return translate("bt.actionsId.put",{actionId:actionId},actionObj)},deleteBTAction=function(actionId){return translate("bt.actionsId.delete",{actionId:actionId})},upPublishBTAction=function(actionId){return translate("bt.actionsId.unpublish",{actionId:actionId})},cloneBTAction=function(actionId){return translate("bt.actionsId.clone",{actionId:actionId})},upgradeBTAction=function(actionId){return translate("bt.actionsId.upgrade",{actionId:actionId})},upgradeMPAction=function(actionId,id){return translate("mp.actionsId.upgrade",{actionId:actionId},{actionId:id})},unlockBTAction=function(actionId,streamId){return translate("bt.actionsId.unlock",{streamId:streamId},{resources:[{resourceType:"action",resourceId:actionId}]})},unlockDialog=function(dialogId,streamId,userId,requestData){return translate("bt.dialogsId.unlock",{dialogId:dialogId,streamId:streamId,userId:userId},requestData)},checkUpgrade=function(actionId){return translate("bt.action.checkupgrade",{actionId:actionId})},getMPAction=function(actionId){return translate("mp.actionsId.get",{actionId:actionId},{})},createMPAction=function(data){return translate("mp.actions.post",{},data)},updateMPAction=function(actionId,actionObj){return translate("mp.actionsId.put",{actionId:actionId},actionObj)},deleteMPAction=function(actionId){return translate("mp.actionsId.delete",{actionId:actionId})},configured=function(actionId){return translate("bt.action.configured",{actionId:actionId})},getErrorCodes=function(actionId){return translate("bt.action.errorCodes",{actionId:actionId})},getVersions=function(actionId){return translate("bt.action.getVersions",{actionId:actionId})},getApiLogs=function(actionId,offset,limit){return translate("bt.action.logs.get",{actionId:actionId,offset:offset,limit:limit})},getFieldPattern=function(actionId,fieldName){return translate("bt.action.field.pattern.get",{actionId:actionId,fieldName:fieldName,patternId:""})},createFieldPattern=function(actionId,fieldName,patterns){return translate("bt.action.field.pattern.create",{actionId:actionId,fieldName:fieldName,patternId:""},patterns)},deleteFieldPattern=function(actionId,fieldName,patternId){var payload=_.isObject(actionId)?actionId:null;return translate("bt.action.field.pattern.delete",payload||{actionId:actionId,fieldName:fieldName,patternId:patternId})};return{getActions:getActions,createBTAction:createBTAction,updateBTAction:updateBTAction,unlockBTAction:unlockBTAction,unlockDialog:unlockDialog,deleteBTAction:deleteBTAction,getBTAction:getBTAction,getMPAction:getMPAction,createMPAction:createMPAction,updateMPAction:updateMPAction,deleteMPAction:deleteMPAction,cloneBTAction:cloneBTAction,upgradeBTAction:upgradeBTAction,upgradeMPAction:upgradeMPAction,checkUpgrade:checkUpgrade,configured:configured,getErrorCodes:getErrorCodes,getVersions:getVersions,getApiLogs:getApiLogs,getFieldPattern:getFieldPattern,createFieldPattern:createFieldPattern,deleteFieldPattern:deleteFieldPattern,upPublishBTAction:upPublishBTAction}}])}(angular),function(ng){"use strict";ng.module("services").service("BTAlertsService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var getAlerts=function(_streamId){return _streamId?translate("bt.streams.alerts.get",{streamId:_streamId},{}):translate("bt.alerts.get",{},{})},deleteBTAlert=function(alertId){return translate("bt.alertsId.delete",{alertId:alertId})},upPublishBTAlert=function(alertId){return translate("bt.alertsId.unpublish",{alertId:alertId})},cloneBTAlert=function(alertId){return translate("bt.alertsId.clone",{alertId:alertId})},upgradeBTAlert=function(alertId){return translate("bt.alertsId.upgrade",{alertId:alertId})},upgradeMPAlert=function(alertId,id){return translate("mp.alertsId.upgrade",{alertId:alertId},{alertId:id})},unlockBTAlert=function(alertId,streamId){return translate("bt.alertsId.unlock",{streamId:streamId},{resources:[{resourceType:"alert",resourceId:alertId}]})},checkUpgrade=function(alertId){return translate("bt.alert.checkupgrade",{alertId:alertId})},deleteMPAlert=function(alertId){return translate("mp.alertsId.delete",{alertId:alertId})},createBTAlert=function(data){return translate("bt.alerts.post",{},data)},createMPAlert=function(data){return translate("mp.alerts.post",{},data)},createBTAlertUp=function(alertId,data){return translate("bt.alerts.put",{alertId:alertId},data)},updateMPAlert=function(alertId,data){return translate("mp.alerts.put",{alertId:alertId},data)},getBTAlert=function(alertId){return translate("bt.alertsId.get",{alertId:alertId})},getMPAlert=function(alertId){return translate("mp.alertsId.get",{alertId:alertId})},resolveUxMap=function(data){return translate("builder.resolve_uxmap",{},data)},configured=function(alertId){return translate("bt.alert.configured",{alertId:alertId})},getErrorCodes=function(alertId){return translate("bt.alert.errorCodes",{alertId:alertId})},getVersions=function(alertId){return translate("bt.alert.getVersions",{alertId:alertId})},getApiLogs=function(alertId,offset,limit){return translate("bt.alert.logs.get",{alertId:alertId,offset:offset,limit:limit})},getFieldPattern=function(alertId,fieldName){return translate("bt.alert.field.pattern.get",{alertId:alertId,fieldName:fieldName,patternId:""})},createFieldPattern=function(alertId,fieldName,patterns){return translate("bt.alert.field.pattern.create",{alertId:alertId,fieldName:fieldName,patternId:""},patterns)},deleteFieldPattern=function(alertId,fieldName,patternId){var payload=_.isObject(alertId)?alertId:null;return translate("bt.alert.field.pattern.delete",payload||{alertId:alertId,fieldName:fieldName,patternId:patternId})};return{getAlerts:getAlerts,deleteBTAlert:deleteBTAlert,deleteMPAlert:deleteMPAlert,createBTAlert:createBTAlert,createMPAlert:createMPAlert,createBTAlertUp:createBTAlertUp,updateMPAlert:updateMPAlert,unlockBTAlert:unlockBTAlert,getBTAlert:getBTAlert,getMPAlert:getMPAlert,cloneBTAlert:cloneBTAlert,upgradeBTAlert:upgradeBTAlert,upgradeMPAlert:upgradeMPAlert,checkUpgrade:checkUpgrade,resolveUxMap:resolveUxMap,configured:configured,getErrorCodes:getErrorCodes,getVersions:getVersions,getApiLogs:getApiLogs,getFieldPattern:getFieldPattern,createFieldPattern:createFieldPattern,deleteFieldPattern:deleteFieldPattern,upPublishBTAlert:upPublishBTAlert}}])}(angular),function(ng){"use strict";ng.module("services").service("AppsDataService",["$translator","$applicationService",function($translator,$applicationService){var getAppsList=function(streamId,getAppsUsage){return getAppsUsage=getAppsUsage||!1,$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged?$translator.translate("bt.org.apps.get"):getAppsUsage?$translator.translate("bt.appsListUsage.get",{streamId:streamId}):$translator.translate("bt.apps.get",{streamId:streamId})},getBotsList=function(){return $translator.translate("bt.streams.get")};return{getAppsList:getAppsList,getBotsList:getBotsList}}])}(angular),function(ng){"use strict";ng.module("services").service("AuthService",["$translator","$rootScope","security","localstore",function($translator,$rootScope,security,localstore){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var profileUpdate=function(payload){return translate("bt.put.profileUpdate",{},payload)},changePassword=function(payload){return translate("bt.put.changePassword",{},payload)},changePasswordByPolicy=function(payload){return translate("bt.put.changePasswordByPolicy",{},payload)},getAuthorization=function(data){return translate("bt.login.post",{},data)},requestToJoinAccounts=function(type,accounts){return translate("bt.join.accounts.post",{type:type},accounts)},getAllowedAccountsToJoin=function(data){return translate("bt.join.accounts.get",{},data)},getAppControlList=function(userId){return translate("mp.user.appControlList",{userId:userId})},sendLoginAuditEvent=function(){return translate("bt.post.audit.login",{},{eventOrigin:0})},refreshToken=function(){var _koreUserInfo,OAUTH_DEFAULT_PROPS={client_id:"1",client_secret:"1",scope:"friends",grant_type:"password"};if(_koreUserInfo=localstore.getAuthData(),_koreUserInfo||security.logout(),_koreUserInfo&&_koreUserInfo.currentAccount){var auth,params={};if(auth=_koreUserInfo.currentAccount.authorization)return params=OAUTH_DEFAULT_PROPS,params.grant_type="refresh_token",params.refresh_token=auth.refreshToken,getAuthorization(params);security.logout()}else security.logout()};return{getAuthorization:getAuthorization,refreshToken:refreshToken,profileUpdate:profileUpdate,changePassword:changePassword,changePasswordByPolicy:changePasswordByPolicy,getAllowedAccountsToJoin:getAllowedAccountsToJoin,
requestToJoinAccounts:requestToJoinAccounts,getAppControlList:getAppControlList,sendLoginAuditEvent:sendLoginAuditEvent}}])}(angular),function(ng){"use strict";var _service=ng.module("services");_service.service("batchTestingService",["$translator",function($translator){function getAllTestSuits(userId,streamId,payload){return $translator.translate("bt.get.getAllTestSuits",{streamId:streamId},payload)}function createTestSuit(userId,streamId,payload){return $translator.translate("bt.post.createTestSuit",{streamId:streamId},payload)}function updateTestSuit(userId,streamId,testSuitID,payload){return $translator.translate("bt.put.updateTestSuit",{streamId:streamId,testSuitID:testSuitID},payload)}function runTestSuit(userId,streamId,testSuitID,payload){return $translator.translate("bt.post.runTestSuit",{streamId:streamId,testSuitID:testSuitID},payload)}function getDetailsByTestRunID(userId,streamId,testSuitID,testRunID,payload){return $translator.translate("bt.get.getDetailsByTestRunID",{streamId:streamId,testSuitID:testSuitID,testRunID:testRunID},payload)}function viewReport(userId,streamId,testSuitID,payload,offset,limit){return $translator.translate("bt.get.viewReport",{streamId:streamId,testSuitID:testSuitID,offset:offset,limit:limit},payload)}return{getAllTestSuits:getAllTestSuits,createTestSuit:createTestSuit,updateTestSuit:updateTestSuit,runTestSuit:runTestSuit,getDetailsByTestRunID:getDetailsByTestRunID,viewReport:viewReport}}])}(angular),function(ng){"use strict";var _service=ng.module("services");_service.service("botOntologyService",["$translator",function($translator){function getTerms(userId,streamId,payload){return $translator.translate("bt.get.getAllTestSuits",{streamId:streamId},payload)}function createTerm(userId,ktObject){return $translator.translate("bt.post.ktCreate",{},ktObject)}function updateTerm(userId,ktObject){return $translator.translate("bt.put.ktUpdate",{ktId:ktObject._id},ktObject)}function createQA(userId,streamId,testSuitID,payload){return $translator.translate("bt.post.runTestSuit",{streamId:streamId,testSuitID:testSuitID},payload)}function updateQA(userId,streamId,testSuitID,testRunID,payload){return $translator.translate("bt.get.getDetailsByTestRunID",{streamId:streamId,testSuitID:testSuitID,testRunID:testRunID},payload)}function getQAForTerm(userId,streamId,testSuitID,payload){return $translator.translate("bt.get.viewReport",{streamId:streamId,testSuitID:testSuitID},payload)}function getFAQS(userId,ktID,searchParam,offSet,limit){return $translator.translate("bt.get.getorsearchfaq",{ktId:ktID,searchParam:searchParam,offSet:offSet,limit:limit})}function addFAQ(userId,faqObject){return $translator.translate("bt.post.addFaqs",{},faqObject)}function updateFAQ(userId,faqData,faqID){return $translator.translate("bt.put.editfaqs",{faqID:faqID},faqData)}function createClass(userId,streamId,classData){return $translator.translate("bt.post.createClass",{streamId:streamId},classData)}function updateClass(userId,streamId,classData,classId){return $translator.translate("bt.put.updateClass",{classId:classId,streamId:streamId},classData)}function deleteClass(userId,streamId,classId){return $translator.translate("bt.delete.deleteClass",{classId:classId,streamId:streamId})}function getClasses(userId,streamId,offset,limit,state){return $translator.translate("bt.get.getClasses",{streamId:streamId,offset:offset,limit:limit,state:state})}function getImportFAQStatus(userId,streamId,callName){return $translator.translate("bt.get.getImportFAQStatus",{streamId:streamId,callName:callName})}function getTrainStatus(userId,streamId,callName){return $translator.translate("bt.get.getImportFAQStatus",{streamId:streamId,callName:callName})}function getNodesLockStatus(userId,ktID){return $translator.translate("bt.get.getNodesLockStatus",{ktID:ktID})}function exportOntology(userId,payload){return $translator.translate("bt.post.exportontology",{userId:userId},payload)}function cudOntologyNode(userId,streamId,ktId,cudOntologyData){return $translator.translate("bt.post.CUD_OntologyNode",{userId:userId,streamId:streamId,ktId:ktId},cudOntologyData)}function getOntologyReport(userId,streamId,ktId,lang){return $translator.translate("bt.get.ontologyReport",{userId:userId,streamId:streamId,ktId:ktId,lang:lang})}function analysisReport(userId,streamId,ktId,dockId,lang){return $translator.translate("bt.get.analysisReport",{userId:userId,streamId:streamId,ktId:ktId,dockId:dockId,lang:lang})}function exportOntologyReport(userId,streamId,ktId,lang){return $translator.translate("bt.get.exportOntologyReport",{userId:userId,streamId:streamId,ktId:ktId,lang:lang})}return{getTerms:getTerms,createTerm:createTerm,updateTerm:updateTerm,createQA:createQA,updateQA:updateQA,getQAForTerm:getQAForTerm,getFAQS:getFAQS,addFAQ:addFAQ,updateFAQ:updateFAQ,createClass:createClass,updateClass:updateClass,deleteClass:deleteClass,getClasses:getClasses,getImportFAQStatus:getImportFAQStatus,getTrainStatus:getTrainStatus,exportOntology:exportOntology,cudOntologyNode:cudOntologyNode,getNodesLockStatus:getNodesLockStatus,getOntologyReport:getOntologyReport,analysisReport:analysisReport,exportOntologyReport:exportOntologyReport}}])}(angular),function(ng){"use strict";ng.module("services").service("BTFileUploadService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var uploadFile=function(data){return translate("bt.uploadFile.post",{},data)};return{uploadFile:uploadFile}}])}(angular),function(ng){"use strict";ng.module("services").service("BTFiltersService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var createFilter=function(alertid,data){return translate("bt.filters.post",{alertId:alertid},data)},getFilter=function(){return translate("bt.filters.get")},getFiltersByAlertId=function(alertId,alertVersion){return translate("bt.getFiltersByAlertId.get",{alertId:alertId,alertVersion:alertVersion})},updateFilter=function(filterId,data){return translate("bt.filtersId.put",{filterId:filterId},data)},deleteFilter=function(filterid){return translate("bt.filtersId.delete",{filterId:filterid})};return{createFilter:createFilter,getFilter:getFilter,updateFilter:updateFilter,deleteFilter:deleteFilter,getFiltersByAlertId:getFiltersByAlertId}}])}(angular),function(ng){"use strict";ng.module("services").service("BTFlowtaskService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var getDialog=function(_streamId,_dialogId){return translate("get.dialog",{streamId:_streamId,dialogId:_dialogId},{})},getFlowtaks=function(_streamId,_dialogId,universalStreamId){return _dialogId&&_dialogId.length>0?translate("bt.dialog.get",{streamId:_streamId,dialogId:_dialogId},{}):universalStreamId&&universalStreamId.length>0?translate("bt.dialogsUB.get",{streamId:_streamId,parentBotId:universalStreamId}):translate("bt.dialogs.get",{streamId:_streamId},{})},getFlowtaksByState=function(_streamId){return translate("bt.dialogsByState.get",{streamId:_streamId},{})},getRegenerateDialog=function(_streamId,_dialogId){return translate("bt.regenerateDialog.get",{streamId:_streamId,dialogId:_dialogId},{})},getRegenerateDialogSelected=function(_streamId,_dialogId,_formId){return translate("bt.getRegenerateDialogSelected.get",{streamId:_streamId,dialogId:_dialogId},{formId:_formId})},deleteFlowtask=function(_streamId,_dialogId){return translate("bt.dialog.delete",{streamId:_streamId,dialogId:_dialogId})},cloneDialogTask=function(streamId,dialogId,payload){return $translator.translate("bt.put.cloneDialogTask",{streamId:streamId,dialogId:dialogId},payload)},recallFlowtask=function(_streamId,_dialogId){return translate("bt.dialog.recall",{streamId:_streamId,dialogId:_dialogId})},messagePreviewFlowtask=function(_streamId,_dialogId,_nodeId,message){return translate("bt.dialog.messagePreview",{streamId:_streamId,dialogId:_dialogId,nodeId:_nodeId},message,{})},unpublishFlowtask=function(_streamId,_dialogId){return translate("bt.dialog.unpublish",{streamId:_streamId,dialogId:_dialogId})},createFlowtask=function(streamId,flowtask){return translate("bt.dialog.post",{streamId:streamId},flowtask,{})},finishFlowtask=function(streamId,dialogId){return translate("bt.dialog.configure",{streamId:streamId,dialogId:dialogId})},updateFlowtask=function(streamId,dialogId,flowtask){return translate("bt.dialog.put",{streamId:streamId,dialogId:dialogId},flowtask,{})},upgradeFlowtask=function(streamId,dialogId){return translate("bt.dialogsId.upgrade",{streamId:streamId,dialogId:dialogId})},migrateFlowtask=function(streamId,dialogId){return translate("bt.dialog.migrate",{streamId:streamId,dialogId:dialogId})},addlinkedtasks=function(streamId,dialogId,payload){return translate("bt.dialogsId.addlinkedtasks",{streamId:streamId,dialogId:dialogId},payload)},getIntentSuggestions=function(streamId,dialogId){return translate("bt.dialogsId.intentSuggestions",{streamId:streamId,dialogId:dialogId})},getFlowtaskComponents=function(streamId,dialogId){return translate("bt.dialogComponent.get",{streamId:streamId,dialogId:dialogId})},getDialogTaskBotConfiguration=function(streamId,dialogId){return translate("bt.dialogBotConfig.get",{streamId:streamId,dialogId:dialogId})},setDialogTaskBotConfiguration=function(streamId,dialogId,payload){return translate("bt.dialogBotConfig.put",{streamId:streamId,dialogId:dialogId},payload)},getEntitiesOrIntents=function(streamId,type){return translate("bt.get.intenetsOrEntities",{streamId:streamId,type:type})},updateFlowtaskNodeInfo=function(streamId,dialogId,nodeId,nodeInfo){return translate("bt.dialogComponent.updateNode",{streamId:streamId,dialogId:dialogId,nodeId:nodeId},nodeInfo)},unlockFlowTask=function(dialogId){return translate("bt.lock.release",{resourceId:dialogId})},getComponents=function(_streamId,_componentId){return _componentId&&_componentId.length>0?translate("bt.component.get",{streamId:_streamId,componentId:_componentId},{}):translate("bt.components.get",{streamId:_streamId},{})},getComponentsByType=function(_streamId,type,isConfiguredOnly){return isConfiguredOnly=isConfiguredOnly?isConfiguredOnly:!1,translate("bt.componentsByType.get",{streamId:_streamId,type:type,isConfiguredOnly:isConfiguredOnly},{})},getComponentsByTypeAndState=function(_streamId,type,state){return translate("bt.componentsByTypeAndState.get",{streamId:_streamId,type:type,state:state},{})},getSearchComponentsByType=function(_streamId,type,isConfiguredOnly,name){return isConfiguredOnly=isConfiguredOnly?isConfiguredOnly:!1,"intent"===type||"subDialog"===type?translate("bt.componentsBySearchTypeIntent.get",{streamId:_streamId,type:"intent",isConfiguredOnly:isConfiguredOnly,intentName:name},{}):translate("bt.componentsBySearchType.get",{streamId:_streamId,type:type,isConfiguredOnly:isConfiguredOnly,name:name},{})},getSearchComponentFormType=function(_streamId,type,name){return translate("bt.componentsBysearchFormType.get",{streamId:_streamId,type:type,name:name},{})},deleteComponent=function(_streamId,_componentId){return translate("bt.component.delete",{streamId:_streamId,componentId:_componentId})},createComponent=function(_streamId,component){return translate("bt.component.post",{streamId:_streamId},component,{})},updateComponentSynonyms=function(_streamId,_componentId,payload){return translate("bt.component.synonyms.put",{streamId:_streamId,componentId:_componentId},payload,{})},updateComponentPatterns=function(_streamId,_componentId,payload){return translate("bt.component.patterns.put",{streamId:_streamId,componentId:_componentId},payload,{})},updateComponentTraits=function(_streamId,_componentId,payload){return translate("bt.component.traits.put",{streamId:_streamId,componentId:_componentId},payload)},updateNegativePatterns=function(_streamId,_userId,payload){return translate("bt.component.negativePatterns.post",{streamId:_streamId,userId:_userId},payload,{})},updateComponent=function(_streamId,_componentId,component){return translate("bt.component.put",{streamId:_streamId,componentId:_componentId},component,{})},executeComponent=function(_streamId,_componentId,params){return translate("bt.component.execute",{streamId:_streamId,componentId:_componentId},params,{})},resolveUxMap=function(data){return translate("builder.resolve_uxmap",{},data)},importDialog=function(_streamId,_dialogId,data,params){var _params={streamId:_streamId,dialogId:_dialogId};return _params[params.importType]=!0,translate("bt.dialog.import",_params,data,[params.importType])},importNewBot=function(userId,payload){return translate("bt.newBot.import",{userId:userId},payload)},importExistingBot=function(userId,botId,payload,params){var _params={userId:userId,botId:botId};return _params[params.importType]=!0,translate("bt.existingBot.import",_params,payload,[params.importType])},botImportStatus=function(userId,requestId){return translate("bt.botImport.status",{userId:userId,requestId:requestId})},botutteranceImportStatus=function(userId,_streamId,_requestId){return translate("bt.botImportUtterance.status",{userId:userId,streamId:_streamId,requestId:_requestId})},startImporting=function(userId,_streamId,payload){return translate("bt.utterance.botImport",{userId:userId,streamId:_streamId},payload)},exportDialog=function(_streamId,dialogId){return translate("bt.dialog.export",{streamId:_streamId,dialogId:dialogId})},addFormNodeBatch=function(_streamId,dialogId,payload){return translate("bt.addFormNode.batch",{streamId:_streamId,dialogId:dialogId},payload)},exportBot=function(_streamId,payload){return translate("bt.export",{streamId:_streamId},payload)},addVariables=function(userId,_streamId,payload){return translate("bt.post.variables",{userId:userId,streamId:_streamId},payload)},deleteVariable=function(userId,_streamId,variableId){return translate("bt.delete.variables",{userId:userId,streamId:_streamId,variableId:variableId})},editVariable=function(userId,_streamId,variableId,payload){return translate("bt.put.variables",{userId:userId,streamId:_streamId,variableId:variableId},payload)},getVariables=function(userId,_streamId,variableType){return translate("bt.get.variables",{userId:userId,streamId:_streamId,variableType:variableType})},getVariablesByCollection=function(userId,_streamId,variableType,collectionRefId){return translate("bt.get.variablesByCollection",{userId:userId,streamId:_streamId,variableType:variableType,collectionRefId:collectionRefId})},getAllVariables=function(userId,_streamId,variableType){return translate("bt.get.allVariables",{userId:userId,streamId:_streamId})},getsSampleBotAllVariables=function(userId,_streamId,standardBotId){return translate("bt.get.getsSampleBotAllVariables",{userId:userId,streamId:_streamId,standardBotId:standardBotId})},saveCustomLookup=function(userId,dialogId,entityId,data){return translate("bt.entity.lookup",{userId:userId,dialogId:dialogId,entityId:entityId},data)},getLookupJson=function(userId,lookupId){return translate("bt.getLookup.json",{userId:userId,lookupId:lookupId})},exportStatusBot=function(_streamId){return translate("bt.get.exportStatusBot",{streamId:_streamId})},getDialogIdps=function(_streamId,dialogId){return translate("bt.get.getDialogIdps",{streamId:_streamId,dialogId:dialogId})},exportStatusBotVersion=function(_streamId){return translate("bt.get.exportStatusBotVersion",{streamId:_streamId})},getProcessApps=function(_streamId){return translate("bt.get.getProcessApps",{streamId:_streamId})};return{getDialog:getDialog,getFlowtaks:getFlowtaks,deleteFlowtask:deleteFlowtask,cloneDialogTask:cloneDialogTask,editVariable:editVariable,deleteVariable:deleteVariable,recallFlowtask:recallFlowtask,messagePreviewFlowtask:messagePreviewFlowtask,unpublishFlowtask:unpublishFlowtask,createFlowtask:createFlowtask,finishFlowtask:finishFlowtask,updateFlowtask:updateFlowtask,upgradeFlowtask:upgradeFlowtask,getFlowtaskComponents:getFlowtaskComponents,getRegenerateDialog:getRegenerateDialog,getRegenerateDialogSelected:getRegenerateDialogSelected,getEntitiesOrIntents:getEntitiesOrIntents,updateFlowtaskNodeInfo:updateFlowtaskNodeInfo,unlockFlowTask:unlockFlowTask,getComponents:getComponents,deleteComponent:deleteComponent,createComponent:createComponent,updateComponent:updateComponent,updateComponentSynonyms:updateComponentSynonyms,updateComponentPatterns:updateComponentPatterns,executeComponent:executeComponent,resolveUxMap:resolveUxMap,importDialog:importDialog,exportDialog:exportDialog,saveCustomLookup:saveCustomLookup,getLookupJson:getLookupJson,getDialogTaskBotConfiguration:getDialogTaskBotConfiguration,setDialogTaskBotConfiguration:setDialogTaskBotConfiguration,exportBot:exportBot,addVariables:addVariables,getVariables:getVariables,getVariablesByCollection:getVariablesByCollection,importExistingBot:importExistingBot,importNewBot:importNewBot,botImportStatus:botImportStatus,getComponentsByType:getComponentsByType,addlinkedtasks:addlinkedtasks,getIntentSuggestions:getIntentSuggestions,getSearchComponentsByType:getSearchComponentsByType,getSearchComponentFormType:getSearchComponentFormType,exportStatusBot:exportStatusBot,startImporting:startImporting,botutteranceImportStatus:botutteranceImportStatus,getComponentsByTypeAndState:getComponentsByTypeAndState,updateNegativePatterns:updateNegativePatterns,getAllVariables:getAllVariables,getsSampleBotAllVariables:getsSampleBotAllVariables,updateComponentTraits:updateComponentTraits,getDialogIdps:getDialogIdps,addFormNodeBatch:addFormNodeBatch,exportStatusBotVersion:exportStatusBotVersion,getFlowtaksByState:getFlowtaksByState,getProcessApps:getProcessApps,migrateFlowtask:migrateFlowtask}}])}(angular),function(ng){"use strict";ng.module("services").service("BTIdpService",["$translator","$q","$rootScope",function($translator,$q,$rootScope){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var getIdpList=function(_streamId){return translate("bt.streamidps.get",{streamId:_streamId},{})},getCallBackUrl=function(){return translate("bt.callbackurl.get",{},{})},createIdp=function(_streamId,idpConfig){return translate("bt.idp.post",{streamId:_streamId},idpConfig)},createStreamUserAccount=function(idpConfig){return idpConfig.label=idpConfig.idpName||"Test Account",translate("bt.idp.test",idpConfig,{})},deleteStreamUserAccount=function(accId){return translate("bt.idp.account.delete",{accId:accId},{})},testIdp=function(idpConfig){return translate("bt.apikey_basic.test",{},idpConfig)},getIdp=function(appId,_streamId){return translate("bt.idp.get",{appId:appId,streamId:_streamId},{})},getIdpByName=function(appName,_streamId){return translate("bt.idp.getbyname",{refId:appName,streamId:_streamId},{})},editIdp=function(appId,_streamId,idpConfig){return translate("bt.idp.put",{appId:appId,streamId:_streamId},idpConfig)},deleteIdp=function(appId,_streamId){return translate("bt.idp.delete",{appId:appId,streamId:_streamId},{})},testRequestChain=function(requestObj){return translate("bt.testAlert.post",{},requestObj)},connectors=function(){return canAccessConnectors()?translate("bt.alert.connectors",{},{}):$q.reject({errors:[{msg:"Not a managed user",code:"Unauthorized"}]})},canAccessConnectors=function(){return $rootScope.isManaged};return{getIdpList:getIdpList,getCallBackUrl:getCallBackUrl,createIdp:createIdp,testIdp:testIdp,createStreamUserAccount:createStreamUserAccount,deleteStreamUserAccount:deleteStreamUserAccount,getIdp:getIdp,getIdpByName:getIdpByName,deleteIdp:deleteIdp,editIdp:editIdp,connectors:connectors,testRequestChain:testRequestChain}}])}(angular),function(ng){"use strict";ng.module("services").service("BTKoraService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var getKoraUsers=function(streamId,offset,limit){return translate("bt.kora.users.get",{streamId:streamId,offset:offset,limit:limit},{})},getKoraLogs=function(userId,streamId,offset,limit){return translate("bt.kora.logs.get",{streamId:streamId,uId:userId,offset:offset,limit:limit},{})};return{getKoraUsers:getKoraUsers,getKoraLogs:getKoraLogs}}])}(angular),function(ng){"use strict";ng.module("services").service("localstore",function($timeout){var _storeType="localStorage";return window.appConfig&&window.appConfig.USE_SESSION_STORE&&(_storeType="sessionStorage"),{setAuthData:function(authData){window[_storeType].setItem("jStorage",JSON.stringify(authData))},getAuthData:function(){var _authData;try{var _j=window[_storeType].getItem("jStorage");if("{}"===_j||""===_j)return _authData;_authData=JSON.parse(_j)}catch(ex){return _authData}return _authData},setSelectedAccount:function(account){var _storeType="sessionStorage";window[_storeType].setItem("selectedAccount",JSON.stringify(account))},getSelectedAccount:function(){var _authData,_storeType="sessionStorage";try{var _j=window[_storeType].getItem("selectedAccount");if("{}"===_j||""===_j)return _authData;_authData=JSON.parse(_j)}catch(ex){return _authData}return _authData},removeSelectedAccount:function(authData){var _storeType="sessionStorage";window[_storeType].removeItem("selectedAccount")},removeFromLoginScreenFlag:function(){var _storeType="localStorage";window[_storeType].removeItem("fromLoginScreen")},setFromLoginScreenFlag:function(){var _storeType="localStorage";window[_storeType].setItem("fromLoginScreen",!0)},getFromLoginScreenFlag:function(){var _storeType="localStorage";return window[_storeType].getItem("fromLoginScreen")}}})}(angular),function(ng){"use strict";ng.module("services").service("nlpService",function(){var _nlpStore={},intents=function(intents){_nlpStore.intents=intents},alerts=function(alerts){_nlpStore.alerts=alerts};return{intents:intents,alerts:alerts,nlpStore:_nlpStore}})}(angular),function(ng){"use strict";ng.module("services").service("NotificationService",["$timeout","i18n","env_conf",function($timeout,i18n,env_conf){function encodeMsg(msg){return msg=msg||"",msg.replace(/</g,"&lt;").replace(/>/g,"&gt;")}var clearAll=function(){$.noty.closeAll()},notify=function(msg,type,timeout){msg=encodeMsg(msg),type=type||"warning",type="info"===type?"success":type;var icon="",typeClass="";"success"===type?(typeClass="green",icon="btx-billing-checked"):"error"===type?(typeClass="pink",icon="btx-warning"):"warning"===type&&(typeClass="yellow",icon="btx-info"),msg='<div class="defaultToast '+typeClass+'"><div class="toastIcon"><i class="'+icon+'"></i></div><div> '+msg+' </div><i class="btx-close"></i></div>';var notifier=noty({layout:"topRight",text:msg,type:type,animation:{open:"animated fadeIn alertWarning0",easing:"swing",speed:500}}),interval=setInterval(function(){notifier.$bar&&$($(notifier.$bar[0]).closest("ul")).remove(),$("#"+notifier.options.id).click(),clearInterval(interval)},timeout||1e4)},alert=function(text,cb,args,layout,isModal,heading){if(args.addHtmlContent||(text=encodeMsg(text)),!$("#noty_topCenter_layout_container").find("li").length){text=args.linkObj&&args.linkObj.link?"<span>"+text+"</span> <a href="+args.linkObj.link+' target="_blank">'+args.linkObj.text+"</a>":"<span>"+text+"</span>",heading=heading||"<span>"+i18n.i18nString("are_you_sure_label")+"</span>";var msg=""+text;$.noty.closeAll();var loader=noty({layout:layout||"topCenter",type:"warning",animation:{open:"animated fadeIn alertDelete",easing:"swing",speed:500},callback:{onClose:function(){$("body").removeClass("alertDeleteBoxShown")}},modal:isModal+""=="undefined"?!0:!1,text:"",template:'<div class="modal-header"><h4 class="modal-title">'+heading+'</h4></div><div class="noty_message  modal-body alertModel"><div><i class="btx-warning text-danger"></i></div>'+msg+"</div>",buttons:[{addClass:"btn btn-default text-danger",text:""+(args.okText||i18n.i18nString("ok_label")),onClick:function($noty){$noty.close(),$timeout(function(){_.isArray(cb)?cb[0].apply(void 0,args):cb.apply(void 0,args)})}},{addClass:"btn btn-danger",text:args.cancelText||i18n.i18nString("cancel"),onClick:function($noty){$noty.close(),_.isArray(cb)&&cb[1].apply(void 0,[])}}]});$timeout(function(){$($(loader.$bar[0]).closest(".i-am-new")).addClass("alertDeleteBox"),$("body").addClass("alertDeleteBoxShown")},10)}},userConfirm=function(text,cb,args,layout,isModal,heading){if(!$("#noty_topCenter_layout_container").find("li").length){args.addHtmlContent||(text=encodeMsg(text));var msg="<span>"+text+"</span>",checkBox="",bodyClass="textCenter";args.checkBox&&args.checkBox.enable&&(checkBox='<div class="checkbox checkbox-primary styledCSS"><input  type="checkbox" id="showHideDownloadPopup"><label for="showHideDownloadPopup">'+i18n.i18nString("dont_show_this_msg")+"</label></div>",bodyClass="textJustify userConfirmNotifi");var loader=noty({layout:layout||"topCenter",type:"warning",animation:{open:"animated fadeIn alertDelete",easing:"swing",speed:500},callback:{onClose:function(){args.checkBox&&args.checkBox.enable&&(args.checkBox.enable=$("#showHideDownloadPopup")[0].checked,args.checkBox.checkBoxCb(args.checkBox.enable)),$("body").removeClass("alertDeleteBoxShown")}},modal:isModal+""=="undefined"?!0:!1,text:"",template:'<div class="modal-header"><h4 class="modal-title">'+heading+'</h4></div><div class="noty_message '+bodyClass+' modal-body">'+msg+checkBox+"</div>",buttons:[{addClass:"btn "+(args.btnClass||""),text:args.okText||i18n.i18nString("ok"),onClick:function($noty){args.checkBox&&args.checkBox.enable&&(args.enable=$(showHideDownloadPopup).checked),$noty.close(),$timeout(function(){_.isArray(cb)?cb[0].apply(void 0,args):cb.apply(void 0,args)})}},{addClass:"btn btn-danger cancleUserConfirm",text:args.cancelText||i18n.i18nString("cancel"),onClick:function($noty){$noty.close(),_.isArray(cb)&&cb[1].apply(void 0,[])}}]});$timeout(function(){$($(loader.$bar[0]).closest(".i-am-new")).addClass("alertDeleteBox"),$("body").addClass("alertDeleteBoxShown")},10)}},confirmDialog=function(text,cb,args,layout,isModal,heading){var _buttons=[];args&&args.noCancelBtn&&_buttons.push({addClass:"btn btn-default text-danger centerButton",text:""+(args.okText||i18n.i18nString("ok_label")),onClick:function($noty){$noty.close(),$timeout(function(){_.isArray(cb)?cb[0].apply(void 0,args):cb.apply(void 0,args)})}}),args&&args.noCancelBtn||(_buttons.push({addClass:"btn btn-default text-danger",text:""+(args.okText||i18n.i18nString("ok_label")),onClick:function($noty){$noty.close(),$timeout(function(){_.isArray(cb)?cb[0].apply(void 0,args):cb.apply(void 0,args)})}}),_buttons.push({addClass:"btn btn-danger",text:args.cancelText||i18n.i18nString("cancel"),onClick:function($noty){$noty.close(),_.isArray(cb)&&cb[1].apply(void 0,[])}}));var template='<div class="noty_message  modal-body"><div><i class="btx-warning text-danger"></i></div>'+text+"</div>";heading&&(template='<div class="modal-header"><h4 class="modal-title">'+heading+"</h4></div>"+template);var loader=noty({layout:layout||"topCenter",type:"warning",animation:{open:"animated fadeIn alertDelete",easing:"swing",speed:500},callback:{onClose:function(){$("body").removeClass("alertDeleteBoxShown")}},modal:isModal+""=="undefined"||isModal+""=="null"?!0:!1,text:"",template:template,buttons:_buttons});$timeout(function(){$($(loader.$bar[0]).closest(".i-am-new")).addClass("alertDeleteBox"),$("body").addClass("alertDeleteBoxShown")},10)},alertNotify=function(head,msg,type){notify(msg,type)},loader=function(msg,type){msg=encodeMsg(msg),msg+="...",msg='<i class="fa fa-circle-o-notch fa-spin"></i>&nbsp;&nbsp;<span>'+msg+"</span>";var loaderToast=noty({layout:"center",text:msg,type:type||"warning",animation:{open:"animated fadeIn alertLoading",easing:"swing",speed:500}});return $($(loaderToast.$bar[0]).closest("ul")).addClass("loadertoast"),function(){loaderToast.$bar&&loaderToast.$bar.length&&$($(loaderToast.$bar[0]).closest("ul")).remove(),$(".loadertoast").remove(),$("#"+loaderToast.options.id).click()}},loadingMessage=function(msg,type){msg=encodeMsg(msg),msg+="...",msg='<div class="loading-div"><i class="fa fa-spinner fa-spin"></i>&nbsp;&nbsp;<span>'+msg+"<span></div>";var loadingMessage=noty({layout:"center",text:msg,animation:{open:"animated fadeIn alertLoading",easing:"swing",speed:500}});return function(){$timeout(function(){$("#"+loadingMessage.options.id).click()})}},timerAlert=function(message,config,context){message=encodeMsg(message),message="<span>"+message+"</span>";var msg=message,succCb=config.callbacks.success,failCb=config.callbacks.failure,succArgs=config.arguments.success,failArgs=config.arguments.failure,succBtnTxt=config.btnText.success,failBtnTxt=config.btnText.failure;noty({layout:"topCenter",type:"warning",animation:{open:"animated fadeIn alertWarning3",easing:"swing",speed:500},modal:!0,text:"",template:'<div class="noty_message modal-body">'+msg+'<span class="noty_text"></span><div class="noty_close"></div></div>',buttons:[{addClass:"btn btn-default",text:succBtnTxt,onClick:function($noty){$noty.close(),$timeout(function(){succCb.apply(context,succArgs)})}},{addClass:"btn btn-danger",text:failBtnTxt,onClick:function($noty){failCb.apply(context,failArgs),$noty.close()}}]})},confirm=function(config){var text,defaultConfig={msg:"",heading:"",successCb:angular.noop,failCb:angular.noop,layout:"",isModal:!0,btnTexts:{success:i18n.i18nString("ok_label"),fail:i18n.i18nString("cancel")}};config=angular.extend(defaultConfig,config),text=encodeMsg(config.msg),text="<span class="+config.bodyClass+">"+text+"</span>";var msg=text,note=config.note?"<br><br><span class="+config.noteClass+'> <span class="label">'+i18n.i18nString("note_label2")+"</span> "+config.note+"</span>":"";msg+=note;var template='<div class="noty_message  modal-body"><div class='+config["class"]+'><i class="btx-warning text-danger"></i></div>'+msg+"</div>";config.heading&&(template='<div class="modal-header"><h4 class="modal-title">'+config.heading+"</h4></div>"+template);var _cnf={layout:config.layout||"topCenter",type:"warning",animation:{open:"animated fadeIn alertDelete",easing:"swing",speed:500},callback:{onClose:function(){$("body").removeClass("alertDeleteBoxShown")}},modal:config.isModal?!0:!1,text:"",template:template,buttons:[{addClass:"btn btn-default text-danger",text:config.btnTexts.success,onClick:function($noty){$noty.close(),$timeout(function(){config.successCb()})}},{addClass:"btn btn-danger",text:config.btnTexts.fail,onClick:function($noty){$noty.close(),config.failCb()}}]};config.cancelCb&&_cnf.buttons.push({addClass:"btn btn-danger close_noty_cnfm fa fa-fw",text:'<i class="fa fa-times" id="close_noty_cnfm_id" aria-hidden="true"></i>',onClick:function($noty){$noty.close(),config.cancelCb()}});var loader=noty(_cnf);$timeout(function(){$($(loader.$bar[0]).closest(".i-am-new")).addClass("alertDeleteBox"),$("body").addClass("alertDeleteBoxShown")},10)},suggestion=function(config){var text,defaultConfig={msg:"",heading:"",successCb:angular.noop,failCb:angular.noop,layout:"",isModal:!0,btnTexts:{success:i18n.i18nString("ok_label")}};config=angular.extend(defaultConfig,config),text=encodeMsg(config.msg),text="<span class="+config.bodyClass+">"+text+"</span>";var heading=config.heading?"<span class="+config.headerClass+">"+config.heading+"</span><br>":"",msg=heading+text,note=config.note?"<br><br><span class="+config.noteClass+'> <span class="label">'+i18n.i18nString("note_label2")+"</span> "+config.note+"</span>":"";msg+=note;var _cnf={layout:config.layout||"topCenter",type:"warning",animation:{open:"animated fadeIn alertDelete",easing:"swing",speed:500},callback:{onClose:function(){$("body").removeClass("alertDeleteBoxShown")}},modal:config.isModal?!0:!1,text:"",template:'<div class="noty_message  modal-body"><div class='+config["class"]+'><i class="btx-warning text-danger"></i></div>'+msg+"</div>",buttons:[{addClass:"btn btn-default text-danger",text:config.btnTexts.success,
onClick:function($noty){$noty.close(),$timeout(function(){config.successCb()})}}]};config.cancelCb&&_cnf.buttons.push({addClass:"btn btn-danger close_noty_cnfm fa fa-fw",text:'<i class="fa fa-times" id="close_noty_cnfm_id" aria-hidden="true"></i>',onClick:function($noty){$noty.close(),config.cancelCb()}});var loader=noty(_cnf);$timeout(function(){$($(loader.$bar[0]).closest(".i-am-new")).addClass("alertDeleteBox"),$("body").addClass("alertDeleteBoxShown")},10)},removeLoader=function(){$("#noty_center_layout_container").empty()},retObj={alert:alert,loader:loader,loadingMessage:loadingMessage,notify:notify,confirm:confirm,timerAlert:timerAlert,alertNotify:alertNotify,confirmDialog:confirmDialog,removeLoader:removeLoader,userConfirm:userConfirm,suggestion:suggestion,clearAll:clearAll};return window.NotificationService=retObj,retObj}])}(angular),function(ng){"use strict";ng.module("services").service("BTParamMapService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var getAlert=function(alertId){return translate("bt.paramMap.alert.get",{alertId:alertId})},getAction=function(actionId){return translate("bt.paramMap.action.get",{actionId:actionId})},createParamMap=function(paramMap){return translate("bt.paramMap.post",{actionId:paramMap.actionId},paramMap)},updateParamMap=function(mappingId,paramMap){return translate("bt.paramMap.maping.put",{mappingId:mappingId},paramMap)},updateAlertDialogParamMap=function(mappingId,paramMap){return translate("bt.alertDialogParamMap.maping.put",{mappingId:mappingId},paramMap)},getMappedActions=function(actionId,version){return translate("bt.paramMap.action.get",{actionId:actionId,version:version},{})},getMappedDialogs=function(dialogId,version){return translate("bt.paramMap.dialog.get",{dialogId:dialogId,version:version},{})},getMappedAlerts=function(alertId,version){return translate("bt.paramMap.alert.get",{alertId:alertId,version:version},{})},getMappedAlertAction=function(mappingId){return translate("bt.paramMap.maping.get",{mappingId:mappingId},{})},getMappedAlertDialog=function(mappingId){return translate("bt.paramDialogMap.maping.get",{mappingId:mappingId},{})},deleteMappedAlertAction=function(mappingId){return translate("bt.paramMap.maping.delete",{mappingId:mappingId},{})},deleteMappedAlertDialog=function(mappingId){return translate("bt.paramDialogMap.maping.delete",{mappingId:mappingId},{})},getDotKeys=function(jsonObject){return jsonObject&&jsonObject.metainfo&&delete jsonObject.metainfo,translate("bt.dotKeys.post",{},jsonObject)};return{getAlert:getAlert,getDotKeys:getDotKeys,getAction:getAction,getMappedAlertAction:getMappedAlertAction,getMappedAlertDialog:getMappedAlertDialog,updateAlertDialogParamMap:updateAlertDialogParamMap,deleteMappedAlertAction:deleteMappedAlertAction,deleteMappedAlertDialog:deleteMappedAlertDialog,createParamMap:createParamMap,updateParamMap:updateParamMap,getMappedActions:getMappedActions,getMappedAlerts:getMappedAlerts,getMappedDialogs:getMappedDialogs}}])}(angular),function(ng){"use strict";ng.module("services").service("BTProcessAppDataService",["$translator",function($translator){var getProcessAppsData=function(){return $translator.translate("bt.processAppsdata.get")};return{getProcessAppsData:getProcessAppsData}}])}(angular),function(ng){"use strict";ng.module("services").service("BTSeedDataService",["$translator",function($translator){var getSeedData=function(){return $translator.translate("bt.seeddata.get")},getSeedCategories=function(){return $translator.translate("bt.seedCategories.get")};return{getSeedData:getSeedData,getSeedCategories:getSeedCategories}}])}(angular),function(ng){"use strict";ng.module("services").service("BTSlashCommandsService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}function getCommand(streamId){return translate("bt.command.get",{streamId:streamId},{})}function createCommand(streamId,command){return translate("bt.command.create",{streamId:streamId},command)}function editCommand(streamId,command){return translate("bt.command.edit",{streamId:streamId},command)}function deleteCommand(streamId){return translate("bt.command.delete",{streamId:streamId},{})}function getSubCommand(actionId){return translate("bt.subCommand.get",{actionId:actionId},{})}function createSubCommand(actionId,subCommand){return translate("bt.subCommand.create",{actionId:actionId},subCommand)}function editSubCommand(actionId,id,subCommand){return translate("bt.subCommand.edit",{actionId:actionId,id:id},subCommand)}function deleteSubCommand(actionId,id){return translate("bt.subCommand.delete",{actionId:actionId,id:id},{})}return{getCommand:getCommand,createCommand:createCommand,editCommand:editCommand,deleteCommand:deleteCommand,getSubCommand:getSubCommand,createSubCommand:createSubCommand,editSubCommand:editSubCommand,deleteSubCommand:deleteSubCommand}}])}(angular),function(ng){"use strict";ng.module("services").service("soap",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}function getDescription(payload){return translate("bt.soap.desc",{},payload)}function execute(payload){return translate("bt.soap.execute",{},payload)}return{getDescription:getDescription,execute:execute}}])}(angular),function(ng){"use strict";ng.module("services").service("BTStreamsService",["$translator",function($translator){function alexaExport(userId,streamId,echoShow){return $translator.translate("bt.post.alexaExport",{streamId:streamId,echoShow:echoShow})}function mlUtterencesScore(streamId,payload){return $translator.translate("bt.post.mlUtterencesScore",{streamId:streamId},payload)}function mlKfoldScore(streamId){return $translator.translate("bt.get.mlKfoldScore",{streamId:streamId})}function mlKfoldScoreDownload(streamId){return $translator.translate("bt.get.mlKfoldScoreDownload",{streamId:streamId})}function sampleJsTamplates(channel,name,sample){return $translator.translate("bt.get.sampleJsTamplates",{channel:channel,name:name,sample:sample})}function createKnowledgeTask(userId,ktObject){return $translator.translate("bt.post.ktCreate",{},ktObject)}function updateThresholds(streamId,thresholdObject){return $translator.translate("bt.threshold.update",{streamId:streamId},thresholdObject)}function updateKnowledgeTask(userId,ktObject){return $translator.translate("bt.put.ktUpdate",{ktId:ktObject._id},ktObject)}function updateMLSynonym(streamId,reset,resetkey,mlSynonymObj){return $translator.translate("bt.mlSynonym.update",{streamId:streamId,reset:reset,resetkey:resetkey},mlSynonymObj)}function getMLSynonym(streamId){return $translator.translate("bt.mlSynonym.get",{streamId:streamId})}function deleteKnowledgeTask(userId,knowledgeID){return $translator.translate("bt.delete.ktDelete",{knowledgeID:knowledgeID})}function getAllKtsList(userId,requestData){return $translator.translate("bt.get.ktGet",requestData,requestData)}function ktGetAllLanguage(userId,requestData){return $translator.translate("bt.get.ktGetAllLanguage",requestData,requestData)}function saveAndUpdateFAQ(userId,faqObject){return $translator.translate("bt.post.addFaqs",{},faqObject)}function getPossibleTags(userId,ktId,queryObject){return $translator.translate("bt.post.getPossibleTags",{ktId:ktId},queryObject)}function faqBulkUpdate(userId,faqCollection){return $translator.translate("bt.put.faqBulkUpdate",{},faqCollection)}function getFAQS(userId,ktID){return $translator.translate("bt.get.getfaqs",{ktId:ktID})}function getOrSearchFAQS(userId,ktID,searchParam,offSet,limit,parentId,withallchild,filter){return $translator.translate("bt.get.getorsearchfaq",{ktId:ktID,searchParam:searchParam,offSet:offSet,limit:limit,parentId:parentId,withallchild:withallchild,filter:filter})}function deleteKtGlobalSynonyms(streamId,synonymsId){return $translator.translate("bt.delete.deleteKtGlobalSynonyms",{streamId:streamId,synonymsId:synonymsId})}function editKtGlobalSynonyms(streamId,synonymsId,payload){return $translator.translate("bt.put.editKtGlobalSynonyms",{streamId:streamId,synonymsId:synonymsId},payload)}function removeFAQ(userId,faqID){return $translator.translate("bt.delete.removeFaqs",{faqID:faqID})}function updateFAQ(userId,faqData,faqID){return $translator.translate("bt.put.editfaqs",{faqID:faqID},faqData)}function uploadFAQFile(userId,importedFileData){return $translator.translate("bt.post.uploadfaqfile",{},importedFileData,{"Content-Type":"txt/csv"})}function importFAQFileBYFileID(userId,importFileData){return $translator.translate("bt.post.importfaqsbyfileid",{},importFileData)}function importFAQFileBYFileIDForce(userId,importFileData){return $translator.translate("bt.post.importfaqsbyfileidForce",{},importFileData)}function uploadBotFunctionsFile(userId,importedFileData){return $translator.translate("bt.post.uploadbotfuncfile",{},importedFileData)}function addBotFunctions(streamId,payload){return $translator.translate("bt.post.botfunction",{streamId:streamId},payload)}function getBotFunctions(streamId){return $translator.translate("bt.get.botfunction",{streamId:streamId})}function deleteBotFunctions(streamId,payload){return $translator.translate("bt.delete.botfunction",{streamId:streamId},payload)}function getUrl(url){return $translator.translate("bt.get.url",{url:url})}function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var makeSDKSubscription=function(streamId,requestData){return $translator.translate("bt.flowtask.SDKSubscription",{streamId:streamId},requestData)},deleteSDKSubscription=function(streamId,requestData){return $translator.translate("bt.flowtask.SDKSubscription.delete",{streamId:streamId},requestData)},getKtGlobalSynonyms=function(streamId,offset,limit,search,keyword,state,ktId){return $translator.translate("bt.get.getKtGlobalSynonyms",{streamId:streamId,offset:offset,limit:limit,search:search,keyword:keyword,state:state,ktId:ktId})},addKtGlobalSynonyms=function(streamId,payload){return $translator.translate("bt.post.addKtGlobalSynonyms",{streamId:streamId},payload)},botFunctionsDownloadFile=function(streamId,fileId){return $translator.translate("bt.get.botFunctionsDownloadFile",{streamId:streamId,fileId:fileId})},getDialogs=function(streamId){return translate("bt.dialogs.get",{streamId:streamId})},getStreams=function(){return translate("bt.streams.get",{},{})},editStream=function(streamId,streamObj){return translate("bt.streams.edit",{streamId:streamId},streamObj)},editNlSettings=function(streamId,streamObj){return translate("bt.streams.editnl",{streamId:streamId},streamObj)},deleteBTStream=function(streamId){return translate("bt.streamsId.delete",{streamId:streamId})},deleteMPStream=function(streamId){return translate("mp.streamsId.delete",{streamId:streamId})},getStreamAlerts=function(streamId){return translate("bt.streams.alerts.get",{streamId:streamId})},getStreamActions=function(streamId){return translate("bt.streams.actions.get",{streamId:streamId})},createBTStream=function(userId,streamData){return $translator.translate("bt.streams.post",{},streamData)},createMPStream=function(userId,streamData){return $translator.translate("mp.streams.post",{},streamData)},getBTStream=function(streamId,params,payload,headers){return $translator.translate("bt.streamsId.get",{streamId:streamId},{},headers)},getMPStream=function(streamId){return $translator.translate("mp.streamsId.get",{streamId:streamId})},getSolutionBotStream=function(streamId){return $translator.translate("solution.streamsId.get",{streamId:streamId})},updateMPStream=function(streamId,streamData){return $translator.translate("mp.streamsId.put",{streamId:streamId},streamData)},getErrorCodes=function(streamId){return $translator.translate("bt.stream.errorCodes",{streamId:streamId})},getMappings=function(streamId){return $translator.translate("bt.mapsin.stream",{streamId:streamId})},getAlertDialogMappings=function(streamId){return $translator.translate("bt.alertdialogmapsin.stream",{streamId:streamId})},getSynonyms=function(streamId,taskName){return $translator.translate("temp.synonyms.get",{streamId:streamId,taskName:taskName})},postSynonyms=function(streamId,synonyms){return $translator.translate("temp.synonyms.post",{streamId:streamId},synonyms)},updateWelcomeMessages=function(streamId,payload){return $translator.translate("bt.welcomeMessage.post",{streamId:streamId},payload)},getGenericMessages=function(streamId){return translate("bt.nlp.messages.get",{streamId:streamId})},editGenericMessages=function(streamId,messages){return translate("bt.nlp.messages.edit",{streamId:streamId},messages)},editOverrideMessages=function(streamId,messages){return translate("bt.nlp.messages.override",{streamId:streamId},messages)},channelSchema=function(){return $translator.translate("bt.channel.fieldschema",{})},testNlp=function(streamId,sentence){return $translator.translate("bt.nlp.test",{streamId:streamId},sentence)},getTrainLogs=function(streamId,sentence){return $translator.translate("bt.post.trainlogs",{streamId:streamId},sentence)},updateTryMode=function(streamId,payload){return $translator.translate("bt.stream.trymode",{streamId:streamId},payload)},trainBotIntentLogs=function(streamId,postData){return $translator.translate("bt.post.trainbotintentlogs",{streamId:streamId},postData)},trainBotIntentBunchLogs=function(streamId,postData){return $translator.translate("bt.post.trainbotintentBunchlogs",{streamId:streamId},postData)},removeTrainBotIntentLogs=function(streamId,deleteData){return $translator.translate("bt.delete.removeTrainbotintentlogs",{streamId:streamId},deleteData)},createPattern=function(streamId,pattern){return $translator.translate("bt.pattern.create",{streamId:streamId},pattern)},taskPattern=function(streamId,pattern){return $translator.translate("bt.taskPattern.edit",{streamId:streamId},pattern)},fieldPatternSortOrEdit=function(streamId,pattern){return $translator.translate("bt.fieldPattern.edit",{streamId:streamId},pattern)},getPatterns=function(streamId){return $translator.translate("bt.pattern.get",{streamId:streamId})},deletePattern=function(context){return $translator.translate("bt.pattern.delete",context)},getAccounts=function(streamId,isDeveloper,isTryOutUserConnection){return $translator.translate("bt.stream.accounts",{streamId:streamId,isTryOutUserConnection:isTryOutUserConnection,isDeveloper:isDeveloper})},getRingCentralAccount=function(streamId,isDeveloper,isTryOutUserConnection,idpName){return $translator.translate("bt.stream.ringcentral.accounts",{streamId:streamId,isTryOutUserConnection:isTryOutUserConnection,isDeveloper:isDeveloper,idpName:idpName})},getAuthinfo=function(streamId){return $translator.translate("bt.stream.authinfo",{streamId:streamId})},createAlertFieldSynonyms=function(taskId,fieldName,payload){return $translator.translate("field.synonyms.alerts.put",{taskId:taskId,fieldName:fieldName},payload)},importEmojis=function(streamId){return $translator.translate("import.emojis.post",{streamId:streamId})},getAlertsFieldSynonyms=function(taskId,fieldName){return $translator.translate("field.synonyms.alerts.get",{taskId:taskId,fieldName:fieldName})},createActionsFieldSynonyms=function(taskId,fieldName,payload){return $translator.translate("field.synonyms.actions.put",{taskId:taskId,fieldName:fieldName},payload)},getActionsFieldSynonyms=function(taskId,fieldName){return $translator.translate("field.synonyms.actions.get",{taskId:taskId,fieldName:fieldName})},deleteChannel=function(streamId,channelType,gateway,payload){return gateway?$translator.translate("bt.stream.ciscoChannel.delete",{streamId:streamId,channelType:channelType,gateway:gateway}):$translator.translate("bt.stream.channel.delete",{streamId:streamId,channelType:channelType},payload)},createOrEditChannel=function(streamId,channelType,payload){return $translator.translate("bt.stream.channel.create",{streamId:streamId,channelType:channelType},payload)},getEmbedwebsdkDetails=function(streamId){return $translator.translate("bt.stream.getEmbedwebsdkDetails",{streamId:streamId})},postEmbedwebsdkDetails=function(streamId,payload){return $translator.translate("bt.stream.postEmbedwebsdkDetails",{streamId:streamId},payload)},ivrVoiceReset=function(streamId){return $translator.translate("bt.stream.ivrVoiceReset",{streamId:streamId})},testAuthorizeChannel=function(streamId,channel,rurl,params){return $translator.translate("bt.stream.channelAuthorize",{streamId:streamId,channel:channel,rurl:rurl},params)},addChannelToBot=function(botId,payload){return $translator.translate("bt.stream.addChannel",{botId:botId},payload)},getuserAdditionalIdentities=function(userId){return $translator.translate("bt.user.getIdentities",{userId:userId})},setupchecklist=function(userId,streamId){return $translator.translate("bt.get.setupchecklist",{userId:userId,streamId:streamId})},updateChecklist=function(userId,streamId,payload){return $translator.translate("bt.put.updateChecklist",{userId:userId,streamId:streamId},payload)},isFreeEmail=function(emailId){return $translator.translate("bt.user.isFreeEmail",{emailId:emailId})},addUserIdentity=function(userId,params,payload){return $translator.translate("bt.user.addIdentity",{userId:userId},params,payload)},deleteUserIdentity=function(userId,identity,params){return $translator.translate("bt.user.deleteIdentity",{userId:userId,identity:identity},params)},resendIdentityVerification=function(userId,params,payload){return $translator.translate("bt.user.resendIdentityVerification",{userId:userId},params,payload)},verifyOTP=function(token,params,payload){return $translator.translate("bt.user.verifyId",{token:token},params,payload)},getWebhookUrl=function(streamId,isWorkPlace){return isWorkPlace?$translator.translate("bt.stream.wfb.webhookget",{streamId:streamId}):$translator.translate("bt.stream.fb.webhookget",{streamId:streamId})},getWebhookUrlForChannel=function(requestData){return $translator.translate("bt.stream.channel.webhookget",requestData)},getBotChatScenarios=function(streamId,streamName,result,offset,limit,search){return $translator.translate("bot.chat.scenarios",{streamId:streamId,streamName:streamName,result:result,offset:offset,limit:limit,search:search})},createLock=function(resourceId){return $translator.translate("bt.lock.create",{resourceId:resourceId},{})},getLock=function(resourceId){return $translator.translate("bt.lock.get",{resourceId:resourceId})},releaseLock=function(resourceId){return $translator.translate("bt.lock.release",{resourceId:resourceId},{})},regenerateSubDialog=function(streamId,formId,payload){return $translator.translate("bt.dialogsId.regenerate",{streamId:streamId,formId:formId},payload)},shareBot=function(streamId,payload){return $translator.translate("bt.bot.share",{streamId:streamId},payload)},inviteUser=function(userId,payload){return $translator.translate("bt.bot.inviteUser",{userId:userId},payload)},dashboardCount=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,languages,payload){return $translator.translate("bt.dashboardCount.get",{userId:userId,orgId:orgId,streamId:streamId,startDate:startDate,endDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,languages:languages},payload)},dashboardCountUniversal=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,linkedbots,languages,payload){return $translator.translate("bt.dashboardCountUniversal.get",{userId:userId,orgId:orgId,streamId:streamId,startDate:startDate,endDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,linkedbots:linkedbots,languages:languages},payload)},dashboardChatsUniversal=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,linkedbots,languages,payload){return $translator.translate("bt.dashboardChatsUniversal.get",{userId:userId,orgId:orgId,streamId:streamId,startDate:startDate,endDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,linkedbots:linkedbots,languages:languages},payload)},performingBotsUniversal=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,linkedbots,languages){return $translator.translate("bt.performingBotsUniversal.get",{userId:userId,orgId:orgId,streamId:streamId,startDate:startDate,endDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,linkedbots:linkedbots,languages:languages})},sessionsCount=function(userId,orgId,streamId,startDate,endDate,channels,languages,payload){return $translator.translate("bt.sessionsCount.put",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,channels:channels,languages:languages},payload)},sessionsCountUniversal=function(userId,orgId,streamId,startDate,endDate,channels,linkedBots,languages,payload){return $translator.translate("bt.sessionsCountUniversal.put",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,channels:channels,linkedBots:linkedBots,languages:languages},payload)},agentTransferMetrics=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,languages,payload){return $translator.translate("bt.agentTransferMetrics.get",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,languages:languages},payload)},agentTransferMetricsUniversal=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,linkedbots,languages,payload){return $translator.translate("bt.agentTransferMetricsUniversal.get",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,linkedbots:linkedbots,languages:languages},payload)},tasksMetrics=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,languages,limit,payload){return $translator.translate("bt.tasksMetrics.get",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,languages:languages,limit:limit},payload)},tasksMetricsUniversal=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,linkedbots,languages,limit,payload){return $translator.translate("bt.tasksMetricsUniversal.get",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,linkedbots:linkedbots,languages:languages,limit:limit},payload)},tasksMetricsExport=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,linkedbots,languages,limit,payload){return $translator.translate("bt.tasksMetricsExport.get",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,linkedbots:linkedbots,languages:languages,limit:limit},payload)},sessionsGraph=function(userId,orgId,streamId,startDate,endDate,sessionInterval,channels,languages,payload){return $translator.translate("bt.sessionsGraph.put",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,sessionInterval:sessionInterval,channels:channels,languages:languages},payload)},sessionsGraphUniversal=function(userId,orgId,streamId,startDate,endDate,sessionInterval,channels,linkedbots,languages,payload){return $translator.translate("bt.sessionsGraphUniversal.put",{userId:userId,orgId:orgId,streamId:streamId,fromDate:startDate,toDate:endDate,sessionInterval:sessionInterval,channels:channels,linkedbots:linkedbots,languages:languages},payload)},channelsMetrics=function(userId,orgId,streamId,dimensions,startDate,endDate,payload){return $translator.translate("bt.channelsMetrics.get",{userId:userId,orgId:orgId,streamId:streamId,dimensions:"channel",fromDate:startDate,toDate:endDate},payload)},channelsMetricsUniversal=function(userId,orgId,streamId,dimensions,startDate,endDate,linkedbots,payload){return $translator.translate("bt.channelsMetricsUniversal.get",{userId:userId,orgId:orgId,streamId:streamId,dimensions:"channel",fromDate:startDate,toDate:endDate,linkedbots:linkedbots},payload)},realTimeDashboard=function(userId,orgId,streamId,metrics){return $translator.translate("bt.realTimeDashboard.get",{userId:userId,orgId:orgId,streamId:streamId,metrics:metrics})},realTimeDashboardChannels=function(userId,orgId,streamId,dimensions,metrics){return $translator.translate("bt.realTimeDashboardChannels.get",{userId:userId,orgId:orgId,streamId:streamId,dimensions:dimensions,metrics:metrics})},dashboardCharts=function(userId,orgId,streamId,startDate,endDate,dimensions,channels,botTasks,languages,payload){return $translator.translate("bt.dashboardCharts.get",{userId:userId,orgId:orgId,streamId:streamId,startDate:startDate,endDate:endDate,dimensions:dimensions,channels:channels,botTasks:botTasks,languages:languages},payload)},smartAlertSubscription=function(streamId,componentId,payload){return $translator.translate("bt.put.smartAlertSubscription",{streamId:streamId,componentId:componentId},payload)},savePiiDataOptions=function(streamId,componentId,payload){return $translator.translate("bt.post.savePiiDataOptions",{streamId:streamId,componentId:componentId},payload)},btExportVariables=function(userId,streamId,format){return $translator.translate("bt.post.btExportVariables",{userId:userId,streamId:streamId,format:format})},btExportVariablesStatus=function(userId,streamId){return $translator.translate("bt.get.btExportVariablesStatus",{userId:userId,streamId:streamId})},btImportVariables=function(userId,streamId,payload,format){return $translator.translate("bt.post.btImportVariables",{userId:userId,streamId:streamId,format:format},payload)},btImportVariablesStatus=function(userId,streamId,_requestId){return $translator.translate("bt.get.btImportVariablesStatus",{userId:userId,streamId:streamId,requestId:_requestId})},btGetAllCollections=function(userId,streamId){return $translator.translate("bt.get.btCollections",{userId:userId,streamId:streamId})},btCreateCollection=function(userId,streamId,payload){return $translator.translate("bt.post.btCollections",{userId:userId,streamId:streamId},payload)},btUpdateCollection=function(userId,streamId,collectionId,payload){return $translator.translate("bt.update.btCollections",{userId:userId,streamId:streamId,collectionId:collectionId},payload)},btDeleteCollection=function(userId,streamId,collectionId){return $translator.translate("bt.delete.btCollections",{userId:userId,streamId:streamId,collectionId:collectionId})},btEditVariableCollection=function(userId,streamId,name){return $translator.translate("bt.editVariable.btCollection",{userId:userId,streamId:streamId,name:name})},addbulkBotVariables=function(userId,streamId,payload){return $translator.translate("bt.put.addBulkBotVariables",{userId:userId,streamId:streamId},payload)},promoteToOwner=function(streamId,payload){return $translator.translate("bt.bot.owner",{streamId:streamId},payload)},getContacts=function(streamId){return $translator.translate("bt.developers.get",{streamId:streamId})},getUserInfo=function(userId){return $translator.translate("bt.user.resolve",{id:userId})},authorizeIdp=function(context,payload){return $translator.translate("bt.stream.auth.test",context,payload)},getChangeLog=function(streamId,offset,limit){return void 0===offset||void 0===limit?$translator.translate("bt.get.changelog",{streamId:streamId}):$translator.translate("bt.get.changelog.limit",{streamId:streamId,offset:offset,limit:limit})},getChangeLogFilter=function(streamId,offset,limit,payload){return $translator.translate("bt.post.changelog.filter",{streamId:streamId,offset:offset,limit:limit},payload)},getChangeLogExport=function(userId,streamId,payload,status,filetype){return $translator.translate("bt.post.changelogExport",{userId:userId,streamId:streamId,status:status,filetype:filetype},payload)},getSessions=function(streamId){return translate("bt.sessions.get",{streamId:streamId})},getChatHistory=function(streamId,msgId,direction,limit,showTimeLines){return $translator.translate("bt.get.chatHistory",{streamId:streamId,msgId:msgId,direction:direction,limit:limit,showTimeLines:showTimeLines})},getAnalyzeRecords=function(streamId,offset,limit,payload,mode){return $translator.translate("bt.post.getRecords",{streamId:streamId,offset:offset,limit:limit,mode:mode},payload)},updateAnalyzeRecord=function(streamId,recordId,payload){return $translator.translate("bt.post.updateRecord",{streamId:streamId,recordId:recordId},payload)},getAnalysisDetails=function(streamId,koralogId){return $translator.translate("bt.get.analysisDetail",{streamId:streamId,koralogId:koralogId})},getAnalysisPerformanceRecordDetails=function(streamId,requestTransitionRecordId,responseTransitionRecordId){return $translator.translate("bt.get.analysisPerformanceRecordDetail",{streamId:streamId,requestTransitionRecordId:requestTransitionRecordId,responseTransitionRecordId:responseTransitionRecordId})},analyzeGetRecordsExport=function(streamId,payload){return $translator.translate("bt.post.getRecordsExport",{streamId:streamId},payload)},analyzeStatus=function(userId,streamId){return $translator.translate("bt.post.analyzeStatus",{userId:userId,streamId:streamId})},metaTags=function(streamId,start_date,end_date){return $translator.translate("bt.get.metaTags",{streamId:streamId,start_date:start_date,end_date:end_date},{},["start_date","end_date"])},channelSpecficChannelId=function(userId,streamId,start_date,end_date,offset,limit){return $translator.translate("bt.get.channelSpecficChannelId",{userId:userId,streamId:streamId,start_date:start_date,end_date:end_date,offset:offset,limit:limit},{},["start_date","end_date","offset","limit"])},analyzeRecordTags=function(streamId,payload){return $translator.translate("bt.post.analyzeRecordTags",{streamId:streamId},payload)},getDebugLogRecords=function(streamId,offset,limit,payload){return $translator.translate("bt.post.getDebugLogRecords",{streamId:streamId,offset:offset,limit:limit},payload)},generateDebugLogRecords=function(streamId,payload){return $translator.translate("bt.post.generateDebugLogRecords",{streamId:streamId},payload)},debugLogPolling=function(streamId,taskId){return $translator.translate("bt.get.debugLogPolling",{streamId:streamId,taskId:taskId})},getKoreUserIdsOnSearch=function(userId,streamId,start_date,end_date,search){return $translator.translate("bt.get.getKoreUserIdsOnSearch",{userId:userId,streamId:streamId,start_date:start_date,end_date:end_date,search:search},{},["start_date","end_date","search"])},getChannelsUserdIdsOnSearch=function(userId,streamId,start_date,end_date,search){return $translator.translate("bt.get.getChannelsUserdIdsOnSearch",{userId:userId,streamId:streamId,start_date:start_date,end_date:end_date,search:search},{},["start_date","end_date","search"])},analyzeDefaultFilter=function(streamId,payload){return $translator.translate("bt.post.getDefaultFilter",{streamId:streamId},payload)},analyzeGetDefaultFilter=function(streamId){return $translator.translate("bt.get.getDefaultFilter",{streamId:streamId})},analyzeEditDefaultFilter=function(streamId,payload){return $translator.translate("bt.put.getDefaultFilter",{streamId:streamId},payload)},getAllNamespaces=function(userId,streamId,headers){return $translator.translate("bt.get.allNamespaces",{userId:userId,streamId:streamId},"",headers)},createNamespace=function(userId,streamId,payload){return $translator.translate("bt.post.createNamespace",{userId:userId,streamId:streamId},payload)},updateNamespace=function(userId,streamId,namespaceId,payload){return $translator.translate("bt.put.updateNamespace",{userId:userId,streamId:streamId,namespaceId:namespaceId},payload)},deleteNamespace=function(userId,streamId,namespaceId){return $translator.translate("bt.delete.deleteNamespace",{userId:userId,streamId:streamId,namespaceId:namespaceId
})},getNSVariables=function(userId,streamId,namespaceId){return $translator.translate("bt.get.getNSVariables",{userId:userId,streamId:streamId,namespaceId:namespaceId})},addNamespaceKg=function(userId,ktId,payload){return $translator.translate("bt.put.addNamespaceKg",{userId:userId,ktId:ktId},payload)},enableNamespace=function(userId,streamId,payload){return $translator.translate("bt.put.enableNamespace",{userId:userId,streamId:streamId},payload)},createCustomTemplate=function(streamId,payload){return $translator.translate("bt.post.createCustomTemplate",{streamId:streamId},payload)},getAllCustomTemplate=function(streamId){return $translator.translate("bt.get.getAllCustomTemplate",{streamId:streamId})},deleteCustomTemplate=function(streamId,_id){return $translator.translate("bt.delete.deleteCustomTemplate",{streamId:streamId,customTemplateId:_id})},getCustomTemplateData=function(streamId,_id){return $translator.translate("bt.get.getCustomTemplateData",{streamId:streamId,customTemplateId:_id})},updateCustomTemplate=function(streamId,_id,payload){return $translator.translate("bt.put.updateCustomTemplate",{streamId:streamId,customTemplateId:_id},payload)},customTemplatePreview=function(streamId,_id,payload){return $translator.translate("bt.post.customTemplatePreview",{streamId:streamId,customTemplateId:_id},payload)},getAllProgressDockNotifications=function(streamId){return $translator.translate("bt.get.getAllProgressDockNotifications",{streamId:streamId})},deleteProgressDockAllNotifications=function(streamId){return $translator.translate("bt.delete.deleteProgressDockAllNotifications",{streamId:streamId})},deleteProgressDockNotification=function(streamId,_id){return $translator.translate("bt.delete.deleteProgressDockNotification",{streamId:streamId,notificationsId:_id})},updateProgressDockNotification=function(streamId,_id,payload){return $translator.translate("bt.put.updateProgressDockNotification",{streamId:streamId,notificationsId:_id},payload)},downloadProgressDockExportFile=function(fileId){return $translator.translate("bt.get.downloadProgressDockExportFile",{fileId:fileId})},downloadImageExportFile=function(fileId){return $translator.translate("bt.get.downloadImageExportFile",{fileId:fileId})},batchtestingReportLink=function(streamId,fileId){return $translator.translate("bt.get.batchtestingReportLink",{streamId:streamId,fileId:fileId})},getUtterances=function(taskId,offset,limit,search,autoTrained,streamId){return search=search||"",autoTrained=autoTrained||"false",streamId?translate("bt.utterancesstream.get",{taskId:taskId,offset:offset,limit:limit,searchParam:search,autoTrainedParam:autoTrained,streamId:streamId}):translate("bt.utterances.get",{taskId:taskId,offset:offset,limit:limit,searchParam:search,autoTrainedParam:autoTrained})},createUtterances=function(payload){return translate("bt.utterances.create",{},payload)},createBulkUtterances=function(payload){return translate("bt.bulkUtterances.create",{},payload)},trainUtterances=function(streamId,payload){return $translator.translate("bt.utterances.trainutterance",{streamId:streamId},payload)},trainBotSpeech=function(streamId){return $translator.translate("bt.post.speechTrain",{streamId:streamId})},trainBotSpeechStatus=function(streamId){return $translator.translate("bt.post.speechTrainStatus",{streamId:streamId})},autoTrainStatus=function(streamId){return $translator.translate("bt.stream.autoTrainStatus",{streamId:streamId})},trainFaq=function(streamId,ktId){return $translator.translate("bt.train.faq",{streamId:streamId,ktId:ktId})},editUtterances=function(payload,utteranceId){return $translator.translate("bt.utterances.edit",{utteranceId:utteranceId},payload)},getUtterancesbyId=function(utteranceId){return $translator.translate("bt.utterances.getbyid",{utteranceId:utteranceId})},deleteUtterances=function(payload,utteranceId){return $translator.translate("bt.utterances.delete",{utteranceId:utteranceId},payload)},standardPublish=function(streamId,payload){return $translator.translate("bt.post.standardPublish",{streamId:streamId},payload)},solutionPublish=function(streamId,payload){return $translator.translate("bt.post.solutionPublish",{streamId:streamId},payload)},sampleBotPublish=function(streamId,payload){return $translator.translate("bt.post.sampleBotPublish",{streamId:streamId},payload)},getSessionKeys=function(streamId){return $translator.translate("bt.get.sessionKeys",{streamId:streamId})},previewMarkup=function(channel,payload){return $translator.translate("bt.post.markupPreview",{channel:channel},payload)},uxPreview=function(streamId,markup,channel,payload){return markup=(markup||!1).toString(),channel=channel||"default",$translator.translate("bt.post.uxPreview",{streamId:streamId,markup:markup,channel:channel},payload)},getContextById=function(contextId,streamId){return $translator.translate("bt.get.context",{contextId:contextId,streamId:streamId},{})},publishFlow=function(mappingId){return $translator.translate("bt.post.pubilshFlow",{mappingId:mappingId},{})},publishAlertDialogFlow=function(mappingId){return $translator.translate("bt.post.pubilshAlertDialogFlow",{mappingId:mappingId},{})},validateAlertDialogFlow=function(mappingId,dialogId){return $translator.translate("bt.paramMap.dialogValidate.get",{mappingId:mappingId,dialogId:dialogId},{})},twilioChannelSms=function(mappingId){return $translator.translate("twilioChannel",{mappingId:mappingId},{})},ExecuteInitializer=function(payload){return $translator.translate("bt.initializer.execute",{},payload)},linkOrUnlinkBots=function(streamId,type,payload){return $translator.translate("bt.universalbots.linkunlink",{streamId:streamId,type:type},payload)},getBotDetails=function(streamName){return $translator.translate("mp.getBotDetails",{streamName:streamName})},userProfileDetails=function(param){return $translator.translate("mp.user.getUserProfileDetails",param)},userConversation=function(params){return $translator.translate("mp.user.getUserConversation",params)},getSampleBots=function(){return $translator.translate("bt.getSampleBots")},getSmartBots=function(){return $translator.translate("bt.getSmartBots")},removeBotInheritance=function(streamId){return $translator.translate("bt.removeBotInheritance",{streamId:streamId})},ktNodeUnlock=function(streamId,ktid,payload){return $translator.translate("bt.put.ktNodeUnlock",{streamId:streamId,ktid:ktid},payload)},unlockDailogComponent=function(streamId,payload){return $translator.translate("bt.post.dailogComponentUnlock",{streamId:streamId},payload)},cloneDialogComponent=function(streamId,componentId,payload){return $translator.translate("bt.put.cloneDialogComponent",{streamId:streamId,componentId:componentId},payload)},unlockDialog=function(dialogId,streamId,requestData){return translate("bt.dialogsId.unlock",{dialogId:dialogId,streamId:streamId},requestData)},installSampleBotFromStore=function(botId){return $translator.translate("bt.get.sampleBotInstallFromStore",{botId:botId})},sampleBotpollStatus=function(userId,streamId){return $translator.translate("bt.get.sampleBotpollStatus",{userId:userId,statusId:streamId})},installSampleBot=function(botId){return $translator.translate("bt.post.sampleBotInstall",{botId:botId})},installSmartBot=function(streamId){return $translator.translate("bt.get.smartBotInstall",{streamId:streamId})},editDefaultDialog=function(streamId,_payload){return translate("bt.stream.default_dialog",{streamId:streamId},_payload)},downloadDefaultLanguage=function(botId,language){return $translator.translate("bt.get.defaultLanguage",{botId:botId,language:language})},updateLanguageJson=function(botId,language,data){return $translator.translate("bt.post.updateLanguageJson",{botId:botId,language:language},data)},addSupportedLanguage=function(botId,language,payload){return $translator.translate("bt.post.addSupportedLanguage",{botId:botId,language:language},payload)},utteranceImport=function(userId,streamId,payload){return $translator.translate("bt.post.utteranceImport",{userId:userId,streamId:streamId},payload)},utteranceExport=function(userId,streamId,status,filetype){return $translator.translate("bt.post.utteranceExport",{userId:userId,streamId:streamId,status:status,filetype:filetype})},botOntoBulkDel=function(userId,payload){return $translator.translate("bt.delete.botOntoBulkDel",{userId:userId},payload)},utteranceStatus=function(userId,streamId){return $translator.translate("bt.post.utteranceStatus",{userId:userId,streamId:streamId})},newEvent=function(userId,streamId,payload){return $translator.translate("bt.put.newEvent",{userId:userId,streamId:streamId},payload)},getRoles=function(userId,streamId,orgId){return $translator.translate("bt.get.getRoles",{userId:userId,streamId:streamId,orgId:orgId})},getGroups=function(userId,streamId,orgId){return $translator.translate("bt.get.getOrg",{userId:userId,streamId:streamId,orgId:orgId})},getCodevelopers=function(userId,streamId){return $translator.translate("bt.get.coDevelopers",{userId:userId,streamId:streamId})},getSharePermissions=function(){return $translator.translate("bt.get.SharePermissions",{})},getPermissionsForRole=function(roleId){return $translator.translate("bt.get.PermissionByRole",{roleId:roleId})},kgExtractImport=function(streamId,payload){return $translator.translate("bt.post.kgExtractImport",{streamId:streamId},payload)},kgStatusPoll=function(streamId,kgImportId){return $translator.translate("bt.get.kgStatusPoll",{streamId:streamId,kgImportId:kgImportId})},kgHistory=function(streamId){return $translator.translate("bt.get.kgHistory",{streamId:streamId})},kgQuesAns=function(streamId,kgExtractId,offset,limit,search,filter){return $translator.translate("bt.get.kgQuesAns",{streamId:streamId,kgExtractId:kgExtractId,offset:offset,limit:limit,search:search,filter:filter})},kgDragDropFaq=function(userId,payload){return $translator.translate("bt.post.kgDragDropFaq",{userId:userId},payload)},kgQnADel=function(streamId,kEId,quesId){return $translator.translate("bt.delete.kgQnADel",{streamId:streamId,kEId:kEId,quesId:quesId})},kgQnAUpdate=function(streamId,kEId,quesId,payload){return $translator.translate("bt.put.kgQnAUpdate",{streamId:streamId,kEId:kEId,quesId:quesId},payload)},kgKeDelete=function(streamId,kEId){return $translator.translate("bt.delete.kgKeDelete",{streamId:streamId,kEId:kEId})},kgQnABulkDel=function(streamId,kEId,payload){return $translator.translate("bt.delete.kgQnABulkDel",{streamId:streamId,kEId:kEId},payload)},kgExportFaq=function(streamId,kEId){return $translator.translate("bt.get.kgExportFaq",{streamId:streamId,kEId:kEId})},kgImportFaq=function(streamId,kEId,payload){return $translator.translate("bt.post.kgImportFaq",{streamId:streamId,kEId:kEId},payload)},kgQnAnnotation=function(streamId,payload){return $translator.translate("bt.post.kgQnAnnotation",{streamId:streamId},payload)},hangoutChannel=function(userId,botId,payload){return $translator.translate("bt.post.hangoutChannel",{userId:userId,botId:botId},payload)},rcsBusinessChannel=function(userId,streamId,payload){return $translator.translate("bt.post.rcsBusinessChannel",{userId:userId,streamId:streamId},payload)},rcsLaunch=function(userId,streamId,payload){return $translator.translate("bt.post.rcsLaunch",{userId:userId,streamId:streamId},payload)},createPanel=function(streamId,payload){return $translator.translate("bt.post.createPanel",{streamId:streamId},payload)},getPannelById=function(streamId,panelId){return $translator.translate("bt.get.getPannelById",{streamId:streamId,panelId:panelId})},deletePanel=function(streamId,panelId){return $translator.translate("bt.delete.deletePanel",{streamId:streamId,panelId:panelId})},getBotPanels=function(streamId){return $translator.translate("bt.get.getBotPanels",{streamId:streamId})},updatePannelById=function(streamId,panelId,payload){return $translator.translate("bt.put.updatePannelById",{streamId:streamId,panelId:panelId},payload)},createWidget=function(streamId,payload){return $translator.translate("bt.post.createWidget",{streamId:streamId},payload)},getWidgetById=function(streamId,widgetId){return $translator.translate("bt.get.getWidgetById",{streamId:streamId,widgetId:widgetId})},deleteWidget=function(streamId,widgetId){return $translator.translate("bt.delete.deleteWidget",{streamId:streamId,widgetId:widgetId})},getBotWidgets=function(streamId){return $translator.translate("bt.get.getBotWidgets",{streamId:streamId})},updateWidgetById=function(streamId,widgetId,payload){return $translator.translate("bt.put.updateWidgetById",{streamId:streamId,widgetId:widgetId},payload)},rootSessionFlow=function(userId,orgId,streamId,view,startDate,endDate,lang,channels){var _dynParams=[];return lang&&_dynParams.push("lang"),channels&&_dynParams.push("channels"),$translator.translate("bt.get.rootSessionFlow",{userId:userId,orgId:orgId,streamId:streamId,view:view,startDate:startDate,endDate:endDate,lang:lang,channels:channels},{},_dynParams)},postRootSessionFlow=function(userId,orgId,streamId,view,payload,mode){var qParams={userId:userId,orgId:orgId,streamId:streamId,view:view};return mode&&(qParams.mode=mode),$translator.translate("bt.post.postRootSessionFlow",qParams,payload)},nodeSessionFlow=function(userId,orgId,streamId,view,payload){return $translator.translate("bt.post.nodeSessionFlow",{userId:userId,orgId:orgId,streamId:streamId,view:view},payload)},utterancesSessionFlow=function(userId,orgId,streamId,payload){return $translator.translate("bt.post.utterancesSessionFlow",{userId:userId,orgId:orgId,streamId:streamId},payload)},uttSessionOutgo=function(userId,orgId,streamId,payload){return $translator.translate("bt.post.uttSessionOutgo",{userId:userId,orgId:orgId,streamId:streamId},payload)},totalUtteranceCount=function(userId,orgId,streamId,payload){return $translator.translate("bt.post.totalUtteranceCount",{userId:userId,orgId:orgId,streamId:streamId},payload)},dropOffs=function(userId,orgId,streamId,payload){return $translator.translate("bt.post.dropOffs",{userId:userId,orgId:orgId,streamId:streamId},payload)},extractUtterance=function(userId,orgId,streamId,payload){return $translator.translate("bt.post.extractUtterance",{userId:userId,orgId:orgId,streamId:streamId},payload)},botTasksSummary=function(streamId){return $translator.translate("bt.get.botTasksSummary",{streamId:streamId})},botSummary=function(streamId){return $translator.translate("bt.get.botSummary",{streamId:streamId})},livebankChannel=function(userId,streamId,payload){return $translator.translate("bt.post.livebankChannel",{userId:userId,streamId:streamId},payload)},getTraitGroups=function(userId,streamId){return $translator.translate("bt.get.getTraitGroups",{userId:userId,streamId:streamId})},getTraitGroupById=function(userId,streamId,traitGroupId){return $translator.translate("bt.get.getTraitGroupById",{userId:userId,streamId:streamId,traitGroupId:traitGroupId})},deleteTraitsGroup=function(userId,streamId,traitGroupId,payload){return $translator.translate("bt.delete.deleteTraitsGroup",{userId:userId,streamId:streamId,traitGroupId:traitGroupId},payload)},updateTraitGroup=function(userId,streamId,traitGroupId,payload){return $translator.translate("bt.put.updateTraitGroup",{userId:userId,streamId:streamId,traitGroupId:traitGroupId},payload)},createTraitGroup=function(userId,streamId,payload){return $translator.translate("bt.post.createTraitGroup",{userId:userId,streamId:streamId},payload)},getTraitsByGroupId=function(userId,streamId,traitGroupId){return $translator.translate("bt.get.getTraitsByGroupId",{userId:userId,streamId:streamId,traitGroupId:traitGroupId})},getTraitsById=function(userId,streamId,traitGroupId,traitId){return $translator.translate("bt.get.getTraitsById",{userId:userId,streamId:streamId,traitGroupId:traitGroupId,traitId:traitId})},updateTraitsById=function(userId,streamId,traitGroupId,traitId,payload){return $translator.translate("bt.put.updateTraitsById",{userId:userId,streamId:streamId,traitGroupId:traitGroupId,traitId:traitId},payload)},getKgManageWords=function(streamId,kgTId,reset){return $translator.translate("bt.get.getKgManageWords",{streamId:streamId,kgTId:kgTId,reset:reset})},updateKgManageWords=function(streamId,kgTId,reset,payload){return $translator.translate("bt.put.updateKgManageWords",{streamId:streamId,kgTId:kgTId,reset:reset},payload)},resetKgManageWords=function(streamId){return $translator.translate("bt.get.resetKgManageWords",{streamId:streamId})},saveSentiment=function(userId,streamId,payload){return $translator.translate("bt.post.saveSentiment",{userId:userId,streamId:streamId},payload)},editSentiment=function(userId,streamId,eventId,payload){return $translator.translate("bt.put.editSentiment",{userId:userId,streamId:streamId,eventId:eventId},payload)},deleteSentiment=function(userId,streamId,payload){return $translator.translate("bt.delete.deleteSentiment",{userId:userId,streamId:streamId},payload)},kgExtractIsVisited=function(streamId,kEId,payload){return $translator.translate("bt.put.kgExtractIsVisited",{streamId:streamId,kEId:kEId},payload)},scheduleCluster=function(streamId,payload){return $translator.translate("bt.post.scheduleCluster",{streamId:streamId},payload)},reorderSentiment=function(userId,streamId,payload){return $translator.translate("bt.post.reorderSentiment",{userId:userId,streamId:streamId},payload)},createGroup=function(streamId,_payload){return $translator.translate("bt.put.createGroup",{streamId:streamId},_payload)},getSmallTalkGroups=function(streamId){return $translator.translate("bt.get.smallTalkGroups",{streamId:streamId})},getSmallTalk=function(streamId){return $translator.translate("bt.get.smallTalk",{streamId:streamId})},updateGroup=function(payload,streamId,groupId){return $translator.translate("bt.put.smallTalkGroups",{streamId:streamId,groupId:groupId},payload)},creteNewNode=function(payload,streamId,groupId){return $translator.translate("bt.post.createNewNode",{streamId:streamId,groupId:groupId},payload)},getCurrentGroupNodes=function(streamId,groupId,_offset){return $translator.translate("bt.get.currentGroupNodes",{streamId:streamId,groupId:groupId,skip:_offset.skip,limit:_offset.limit})},updateNode=function(payload,streamId,groupId){return $translator.translate("bt.put.updateNode",{streamId:streamId,groupId:groupId,nodeId:payload.nodeId},payload)},deleteNode=function(nodeId,streamId,groupId){return $translator.translate("bt.delete.smallTalkNode",{streamId:streamId,groupId:groupId,nodeId:nodeId})},deleteGroup=function(streamId,groupId){return $translator.translate("bt.delete.smallTalkGroup",{streamId:streamId,groupId:groupId})},paginateSmallTalk=function(streamId,groupId,_offset){return $translator.translate("bt.get.smallTalkPaginate",{streamId:streamId,groupId:groupId,skip:_offset.skip,limit:_offset.limit})},searchUserSays=function(streamId,groupId,userSays){return $translator.translate("bt.get.smallTalkSearch",{streamId:streamId,groupId:groupId,userSays:userSays})},exportSmallTalk=function(streamId,_payload){return $translator.translate("bt.export.smallTalk",{streamId:streamId},_payload)},startImporting=function(streamId,payload){return $translator.translate("bt.post.importSmallTalkFile",{streamId:streamId},payload)},statusImportingSmallTalk=function(userId,streamId){return $translator.translate("bt.get.statusImportSmallTalk",{userId:userId,streamId:streamId})},migrateSmallTalk=function(streamId){return $translator.translate("bt.post.migrateSmallTalk",{streamId:streamId})},reOderSmallTalk=function(streamId,payload){return $translator.translate("bt.put.reOrderSmallTalk",{streamId:streamId},payload)},reOrderQuestions=function(streamId,groupId,nodeId,payload){return $translator.translate("bt.put.reOrderQuestions",{streamId:streamId,groupId:groupId,nodeId:nodeId},payload)},deleteRunDetails=function(streamId,testSuiteId,runDetails){return $translator.translate("bt.delete.deleteRunDetails",{streamId:streamId,testSuiteId:testSuiteId,runDetails:runDetails})},deleteRunDetailsAll=function(streamId,testSuiteId){return $translator.translate("bt.delete.deleteRunDetailsAll",{streamId:streamId,testSuiteId:testSuiteId})},initiateOntologyAnalysis=function(_payload){return $translator.translate("bt.post.ontologyAnalyzer",{},_payload)},fbInstallApp=function(streamId,payload){return $translator.translate("bt.post.fbInstallApp",{streamId:streamId},payload)},getbotSpecficUsers=function(streamId,start_date,end_date,offset,limit){return $translator.translate("bt.get.getbotSpecficUsers",{streamId:streamId,start_date:start_date,end_date:end_date,offset:offset,limit:limit},{},["start_date","end_date","offset","limit"])},disableLanguage=function(streamId,language){return $translator.translate("bt.post.disableLanguage",{streamId:streamId,language:language})},defaultLanguage=function(streamId,language){return $translator.translate("bt.post.defaultLanguage",{streamId:streamId,language:language})},reEnableLanguage=function(streamId,language){return $translator.translate("bt.post.reEnableLanguage",{streamId:streamId,language:language})},upgradeUniversalBot=function(userId,streamId,payload){return $translator.translate("bt.put.upgradeUniversalBot",{streamId:streamId,userId:userId},payload)},getLinkBot=function(streamId,linkBotId){return $translator.translate("bt.get.linkbot",{streamId:streamId,botId:linkBotId})},addTrainingData=function(streamId,payload){return $translator.translate("bt.post.addTrainingData",{streamId:streamId},payload)},searchText=function(streamId,searchText,type,linkBotId){return $translator.translate("bt.get.searchText",{streamId:streamId,search:searchText,type:type,botId:linkBotId})},paginateTrainingData=function(streamId,offset,limit,search,type,linkBotId){return $translator.translate("bt.get.paginateTrainingData",{streamId:streamId,offset:offset,limit:limit,search:search,type:type,botId:linkBotId})},saveTriggerPhaseSettings=function(streamId,payload){return $translator.translate("bt.put.updateTriggerPhrase",{streamId:streamId},payload)},createUiForm=function(streamId,payload){return $translator.translate("bt.post.createUiForm",{streamId:streamId},payload)},updateUiForm=function(streamId,formId,payload){return $translator.translate("bt.put.updateUiForm",{streamId:streamId,formId:formId},payload)},getBotUiForms=function(streamId,isConfiguredOnly){return $translator.translate(isConfiguredOnly?"bt.get.getBotUiForms.configured":"bt.get.getBotUiForms",{streamId:streamId})},getBotUiFormById=function(streamId,formId){return $translator.translate("bt.get.getBotUiFormById",{streamId:streamId,formId:formId})},deleteBotUiFormById=function(streamId,formId){return $translator.translate("bt.delete.deleteBotUiFormById",{streamId:streamId,formId:formId})},intigrateFormToPanel=function(streamId,panelId,payload){return $translator.translate("bt.post.intigrateFormToPanel",{streamId:streamId,panelId:panelId},payload)},createVersion=function(streamId,payload){return $translator.translate("bt.post.createVersion",{streamId:streamId},payload)},getBotVersionDateRange=function(streamId,startDate,endDate,sortBy){return $translator.translate("bt.get.botVersionDateRange",{streamId:streamId,startDate:startDate,endDate:endDate,sortBy:sortBy})},getBotVersions=function(streamId,sortBy){return $translator.translate("bt.get.botVersion",{streamId:streamId,sortBy:sortBy})},deleteBotVersion=function(streamId,payload){return $translator.translate("bt.delete.deleteBotVersion",{streamId:streamId},payload)},exportBotVersion=function(streamId,payload){return $translator.translate("bt.post.exportBotVersion",{streamId:streamId},payload)},restoreBotVersion=function(streamId,payload){return $translator.translate("bt.post.restoreBotVersion",{streamId:streamId},payload)},getVersionStatus=function(streamId,statusId){return $translator.translate("bt.post.versionStatus",{streamId:streamId,statusId:statusId})},getRestoreStatus=function(streamId,statusId){return $translator.translate("bt.get.restoreStatus",{streamId:streamId,statusId:statusId})},deleteVersion=function(streamId,payload){return $translator.translate("bt.delete.deleteVersion",{streamId:streamId},payload)},daasTables=function(userId,streamId){return $translator.translate("bt.get.daasTables",{userId:userId,streamId:streamId})},daasViews=function(userId,streamId){return $translator.translate("bt.get.daasViews",{userId:userId,streamId:streamId})},daasSaveServiceNode=function(componentId,streamId,_payload){return $translator.translate("bt.daasSaveServiceNode",{componentId:componentId,streamId:streamId},_payload)},publishImportBot=function(streamId,_payload){return $translator.translate("bt.post.autoPublish",{streamId:streamId},_payload)},getAdvancedConfigurations=function(streamId){return $translator.translate("bt.get.nlpConfigurations",{streamId:streamId})},getAdvancedConfigurationsByName=function(streamId,configName){return $translator.translate("bt.get.advancedNlConfigsByName",{streamId:streamId,configName:configName})},getSavedConfiguration=function(streamId){return $translator.translate("bt.get.savedConfigurations",{streamId:streamId})},addConfiguration=function(streamId,payload){return $translator.translate("bt.post.addConfiguration",{streamId:streamId},payload)},deleteConfiguration=function(streamId,configId){return $translator.translate("bt.delete.deleteConfiguration",{streamId:streamId,configId:configId})},editConfigurations=function(streamId,configId,_payload){return $translator.translate("bt.put.editConfiguration",{streamId:streamId,configId:configId},_payload)},createCustomModel=function(streamId,_payload){return $translator.translate("bt.post.createCustomModel",{streamId:streamId},_payload)},updateCustomModel=function(streamId,customModelParamID,_payload){return $translator.translate("bt.put.updateCustomModel",{streamId:streamId,customModelParamID:customModelParamID},_payload)},deleteDialogIntentModel=function(streamId,customModelParamID){return $translator.translate("bt.delete.deleteDialogIntentModel",{streamId:streamId,customModelParamID:customModelParamID})},getDeploymentStatus=function(streamId){return $translator.translate("sa.get.deploymentStatus",{streamId:streamId})},updateBotConfigurations=function(streamId,payload){return $translator.translate("bt.put.botConfigurations",{streamId:streamId},payload)},getSampleBotSettings=function(streamId){return $translator.translate("bt.get.getConfigurations",{streamId:streamId})},getPlans=function(streamId,payload){return $translator.translate("bt.get.plans",{streamId:streamId},payload)},planChange=function(payload){return $translator.translate("bt.put.planChange",{},payload)},planValidate=function(params){return $translator.translate("bt.get.planValidate",params)},planCheckout=function(params,payload){return $translator.translate("bt.publish.payment",params,payload)},paymentstatus=function(params){return $translator.translate("bt.plan.paymentstatus",params)},cancelPlanSub=function(streamId,payload){return $translator.translate("bt.cancel.planSub",{streamId:streamId},payload)},planAutoRecharge=function(streamId,payload){return $translator.translate("bt.autorecharge.payasyougo",{streamId:streamId},payload)},planValidation=function(streamId){return $translator.translate("bt.get.planvalidation",{streamId:streamId})},getBillingsession=function(params){return $translator.translate("bt.get.billingSession",params)},downloadBillingsession=function(params){return $translator.translate("bt.download.billingSession",params)},getInvoices=function(streamId,limit,skip){return $translator.translate("bt.get.invoices",{streamId:streamId,limit:limit,skip:skip})},getSupportPlans=function(streamId){return $translator.translate("bt.get.getSupportPlans",{streamId:streamId})},supportPlanChange=function(streamId,planId,payload){return $translator.translate("bt.post.supportPlanChange",{streamId:streamId,planId:planId},payload)},supportPlanCancel=function(streamId,payload){return $translator.translate("bt.post.supportPlanCancel",{streamId:streamId},payload)},supportPlanValidate=function(streamId,targetPlanId){return $translator.translate("bt.get.supportPlanValidate",{streamId:streamId,targetPlanId:targetPlanId})},updatePinnedMenus=function(userId,payload){return $translator.translate("bt.put.pinmenus",{userId:userId},payload)},getPinnedMenus=function(streamId){return $translator.translate("bt.get.pinmenus",{streamId:streamId})},createtestcase=function(streamId,payload){return $translator.translate("bt.coversationTesting.createtestcase",{streamId:streamId},payload)},clonetestcase=function(streamId,testCaseId,payload){return $translator.translate("bt.coversationTesting.clonetestcase",{streamId:streamId,testCaseId:testCaseId},payload)},deletetestcase=function(streamId,payload){return $translator.translate("bt.coversationTesting.deletetestcase",{streamId:streamId},payload)},recentTags=function(streamId){return $translator.translate("bt.coversationTesting.recentTags",{streamId:streamId})},runtestcases=function(streamId,payload){return $translator.translate("bt.coversationTesting.runtestcases",{streamId:streamId},payload)},getScenes=function(streamId,metaInfo,limit,skip,status){return $translator.translate("bt.getscenes",{streamId:streamId,metaInfo:metaInfo,limit:limit,skip:skip,status:status})},createScene=function(streamId,payload){return $translator.translate("bt.createScene",{streamId:streamId},payload)},deleteScene=function(streamId,sceneId){return $translator.translate("bt.deleteScene",{streamId:streamId,sceneId:sceneId})},cloneScene=function(streamId,sceneId,payload){return $translator.translate("bt.cloneScene",{streamId:streamId,sceneId:sceneId},payload)},editScene=function(streamId,sceneId,payload){return $translator.translate("bt.editScene",{streamId:streamId,sceneId:sceneId},payload)},importScene=function(streamId,payload){return $translator.translate("bt.importScene",{streamId:streamId},payload)},resetShareURL=function(queryParams){return $translator.translate("bt.resetShareURL",queryParams,{})},exportScene=function(streamId,sceneId,payload){return $translator.translate("bt.exportScene",{streamId:streamId,sceneId:sceneId},payload)},updateScene=function(streamId,sceneId,payload){return $translator.translate("bt.updateScene",{streamId:streamId,sceneId:sceneId},payload)},allTranslationengines=function(streamId){return $translator.translate("get.allTranslationengines",{streamId:streamId})},gettranslationEngine=function(streamId,transEngineId){return $translator.translate("get.translationEngine",{streamId:streamId,transEngineId:transEngineId})},editTranslationEngine=function(streamId,transEngineId,payload){return $translator.translate("edit.translationEngine",{streamId:streamId,transEngineId:transEngineId},payload)},deletTranslationEngine=function(streamId,transEngineId){return $translator.translate("delete.translationEngine",{streamId:streamId,transEngineId:transEngineId})},createtranslationEngine=function(streamId,payload){return $translator.translate("create.translationEngine",{streamId:streamId},payload)};return{getContextById:getContextById,publishFlow:publishFlow,publishAlertDialogFlow:publishAlertDialogFlow,validateAlertDialogFlow:validateAlertDialogFlow,twilioChannelSms:twilioChannelSms,uxPreview:uxPreview,previewMarkup:previewMarkup,getSessionKeys:getSessionKeys,standardPublish:standardPublish,solutionPublish:solutionPublish,getChangeLog:getChangeLog,getChangeLogFilter:getChangeLogFilter,getChangeLogExport:getChangeLogExport,getUserInfo:getUserInfo,getContacts:getContacts,shareBot:shareBot,createLock:createLock,getDialogs:getDialogs,getLock:getLock,releaseLock:releaseLock,getWebhookUrl:getWebhookUrl,authorizeIdp:authorizeIdp,channelSchema:channelSchema,promoteToOwner:promoteToOwner,deleteChannel:deleteChannel,regenerateSubDialog:regenerateSubDialog,createOrEditChannel:createOrEditChannel,getEmbedwebsdkDetails:getEmbedwebsdkDetails,postEmbedwebsdkDetails:postEmbedwebsdkDetails,ivrVoiceReset:ivrVoiceReset,getBotChatScenarios:getBotChatScenarios,getPatterns:getPatterns,deletePattern:deletePattern,getAccounts:getAccounts,getRingCentralAccount:getRingCentralAccount,getAuthinfo:getAuthinfo,
updateTryMode:updateTryMode,getStreams:getStreams,editStream:editStream,deleteBTStream:deleteBTStream,createPattern:createPattern,taskPattern:taskPattern,fieldPatternSortOrEdit:fieldPatternSortOrEdit,deleteMPStream:deleteMPStream,getStreamAlerts:getStreamAlerts,getStreamActions:getStreamActions,createBTStream:createBTStream,createMPStream:createMPStream,getBTStream:getBTStream,getMPStream:getMPStream,getMappings:getMappings,getAlertDialogMappings:getAlertDialogMappings,updateMPStream:updateMPStream,getErrorCodes:getErrorCodes,getSynonyms:getSynonyms,postSynonyms:postSynonyms,getGenericMessages:getGenericMessages,editGenericMessages:editGenericMessages,editOverrideMessages:editOverrideMessages,testNlp:testNlp,getTrainLogs:getTrainLogs,createAlertFieldSynonyms:createAlertFieldSynonyms,importEmojis:importEmojis,getAlertsFieldSynonyms:getAlertsFieldSynonyms,createActionsFieldSynonyms:createActionsFieldSynonyms,getActionsFieldSynonyms:getActionsFieldSynonyms,saveAndUpdateFAQ:saveAndUpdateFAQ,createKnowledgeTask:createKnowledgeTask,getAllKtsList:getAllKtsList,ktGetAllLanguage:ktGetAllLanguage,uploadFAQFile:uploadFAQFile,updateFAQ:updateFAQ,importFAQFileBYFileID:importFAQFileBYFileID,importFAQFileBYFileIDForce:importFAQFileBYFileIDForce,uploadBotFunctionsFile:uploadBotFunctionsFile,addBotFunctions:addBotFunctions,getBotFunctions:getBotFunctions,deleteBotFunctions:deleteBotFunctions,botFunctionsDownloadFile:botFunctionsDownloadFile,getUrl:getUrl,getFAQS:getFAQS,removeFAQ:removeFAQ,deleteKnowledgeTask:deleteKnowledgeTask,updateKnowledgeTask:updateKnowledgeTask,btExportVariables:btExportVariables,btImportVariables:btImportVariables,btImportVariablesStatus:btImportVariablesStatus,btGetAllCollections:btGetAllCollections,btCreateCollection:btCreateCollection,btUpdateCollection:btUpdateCollection,btDeleteCollection:btDeleteCollection,btEditVariableCollection:btEditVariableCollection,btExportVariablesStatus:btExportVariablesStatus,getOrSearchFAQS:getOrSearchFAQS,getSessions:getSessions,getUtterances:getUtterances,createUtterances:createUtterances,editUtterances:editUtterances,getUtterancesbyId:getUtterancesbyId,trainUtterances:trainUtterances,trainFaq:trainFaq,deleteUtterances:deleteUtterances,getSolutionBotStream:getSolutionBotStream,trainBotIntentLogs:trainBotIntentLogs,removeTrainBotIntentLogs:removeTrainBotIntentLogs,ExecuteInitializer:ExecuteInitializer,getWebhookUrlForChannel:getWebhookUrlForChannel,makeSDKSubscription:makeSDKSubscription,deleteSDKSubscription:deleteSDKSubscription,updateThresholds:updateThresholds,updateMLSynonym:updateMLSynonym,getMLSynonym:getMLSynonym,linkOrUnlinkBots:linkOrUnlinkBots,getBotDetails:getBotDetails,userProfileDetails:userProfileDetails,userConversation:userConversation,getSampleBots:getSampleBots,getSmartBots:getSmartBots,removeBotInheritance:removeBotInheritance,ktNodeUnlock:ktNodeUnlock,unlockDailogComponent:unlockDailogComponent,unlockDialog:unlockDialog,cloneDialogComponent:cloneDialogComponent,sampleBotPublish:sampleBotPublish,installSampleBot:installSampleBot,installSampleBotFromStore:installSampleBotFromStore,sampleBotpollStatus:sampleBotpollStatus,installSmartBot:installSmartBot,editDefaultDialog:editDefaultDialog,testAuthorizeChannel:testAuthorizeChannel,addChannelToBot:addChannelToBot,getuserAdditionalIdentities:getuserAdditionalIdentities,setupchecklist:setupchecklist,updateChecklist:updateChecklist,addUserIdentity:addUserIdentity,isFreeEmail:isFreeEmail,resendIdentityVerification:resendIdentityVerification,deleteUserIdentity:deleteUserIdentity,verifyOTP:verifyOTP,autoTrainStatus:autoTrainStatus,trainBotSpeech:trainBotSpeech,trainBotSpeechStatus:trainBotSpeechStatus,dashboardCount:dashboardCount,dashboardCountUniversal:dashboardCountUniversal,dashboardChatsUniversal:dashboardChatsUniversal,dashboardCharts:dashboardCharts,performingBotsUniversal:performingBotsUniversal,downloadDefaultLanguage:downloadDefaultLanguage,updateLanguageJson:updateLanguageJson,addSupportedLanguage:addSupportedLanguage,getPossibleTags:getPossibleTags,faqBulkUpdate:faqBulkUpdate,alexaExport:alexaExport,sessionsCount:sessionsCount,sessionsCountUniversal:sessionsCountUniversal,agentTransferMetrics:agentTransferMetrics,agentTransferMetricsUniversal:agentTransferMetricsUniversal,tasksMetrics:tasksMetrics,tasksMetricsUniversal:tasksMetricsUniversal,tasksMetricsExport:tasksMetricsExport,sessionsGraph:sessionsGraph,sessionsGraphUniversal:sessionsGraphUniversal,smartAlertSubscription:smartAlertSubscription,savePiiDataOptions:savePiiDataOptions,getAnalyzeRecords:getAnalyzeRecords,analyzeGetRecordsExport:analyzeGetRecordsExport,updateAnalyzeRecord:updateAnalyzeRecord,channelsMetrics:channelsMetrics,channelsMetricsUniversal:channelsMetricsUniversal,realTimeDashboard:realTimeDashboard,realTimeDashboardChannels:realTimeDashboardChannels,getAnalysisDetails:getAnalysisDetails,getAnalysisPerformanceRecordDetails:getAnalysisPerformanceRecordDetails,getDebugLogRecords:getDebugLogRecords,generateDebugLogRecords:generateDebugLogRecords,debugLogPolling:debugLogPolling,getChatHistory:getChatHistory,mlUtterencesScore:mlUtterencesScore,mlKfoldScore:mlKfoldScore,mlKfoldScoreDownload:mlKfoldScoreDownload,trainBotIntentBunchLogs:trainBotIntentBunchLogs,sampleJsTamplates:sampleJsTamplates,getKtGlobalSynonyms:getKtGlobalSynonyms,addKtGlobalSynonyms:addKtGlobalSynonyms,editKtGlobalSynonyms:editKtGlobalSynonyms,deleteKtGlobalSynonyms:deleteKtGlobalSynonyms,updateWelcomeMessages:updateWelcomeMessages,createCustomTemplate:createCustomTemplate,getAllCustomTemplate:getAllCustomTemplate,deleteCustomTemplate:deleteCustomTemplate,getCustomTemplateData:getCustomTemplateData,updateCustomTemplate:updateCustomTemplate,customTemplatePreview:customTemplatePreview,utteranceImport:utteranceImport,utteranceExport:utteranceExport,utteranceStatus:utteranceStatus,addbulkBotVariables:addbulkBotVariables,getAllProgressDockNotifications:getAllProgressDockNotifications,deleteProgressDockAllNotifications:deleteProgressDockAllNotifications,deleteProgressDockNotification:deleteProgressDockNotification,updateProgressDockNotification:updateProgressDockNotification,downloadProgressDockExportFile:downloadProgressDockExportFile,downloadImageExportFile:downloadImageExportFile,batchtestingReportLink:batchtestingReportLink,analyzeStatus:analyzeStatus,metaTags:metaTags,channelSpecficChannelId:channelSpecficChannelId,analyzeRecordTags:analyzeRecordTags,botOntoBulkDel:botOntoBulkDel,newEvent:newEvent,kgExtractImport:kgExtractImport,kgStatusPoll:kgStatusPoll,kgHistory:kgHistory,kgQuesAns:kgQuesAns,kgDragDropFaq:kgDragDropFaq,kgQnADel:kgQnADel,kgQnAUpdate:kgQnAUpdate,kgKeDelete:kgKeDelete,getCodevelopers:getCodevelopers,getRoles:getRoles,getGroups:getGroups,getSharePermissions:getSharePermissions,getPermissionsForRole:getPermissionsForRole,kgQnABulkDel:kgQnABulkDel,kgExportFaq:kgExportFaq,kgImportFaq:kgImportFaq,kgQnAnnotation:kgQnAnnotation,hangoutChannel:hangoutChannel,rcsBusinessChannel:rcsBusinessChannel,rcsLaunch:rcsLaunch,inviteUser:inviteUser,rootSessionFlow:rootSessionFlow,postRootSessionFlow:postRootSessionFlow,nodeSessionFlow:nodeSessionFlow,utterancesSessionFlow:utterancesSessionFlow,uttSessionOutgo:uttSessionOutgo,totalUtteranceCount:totalUtteranceCount,dropOffs:dropOffs,botTasksSummary:botTasksSummary,botSummary:botSummary,editNlSettings:editNlSettings,livebankChannel:livebankChannel,getTraitGroups:getTraitGroups,updateTraitGroup:updateTraitGroup,createTraitGroup:createTraitGroup,deleteTraitsGroup:deleteTraitsGroup,getTraitGroupById:getTraitGroupById,getTraitsByGroupId:getTraitsByGroupId,getTraitsById:getTraitsById,updateTraitsById:updateTraitsById,getKgManageWords:getKgManageWords,updateKgManageWords:updateKgManageWords,saveSentiment:saveSentiment,resetKgManageWords:resetKgManageWords,editSentiment:editSentiment,deleteSentiment:deleteSentiment,kgExtractIsVisited:kgExtractIsVisited,scheduleCluster:scheduleCluster,reorderSentiment:reorderSentiment,getSmallTalkGroups:getSmallTalkGroups,getSmallTalk:getSmallTalk,updateGroup:updateGroup,creteNewNode:creteNewNode,createGroup:createGroup,getCurrentGroupNodes:getCurrentGroupNodes,updateNode:updateNode,deleteNode:deleteNode,extractUtterance:extractUtterance,deleteGroup:deleteGroup,paginateSmallTalk:paginateSmallTalk,searchUserSays:searchUserSays,exportSmallTalk:exportSmallTalk,startImporting:startImporting,statusImportingSmallTalk:statusImportingSmallTalk,migrateSmallTalk:migrateSmallTalk,reOderSmallTalk:reOderSmallTalk,initiateOntologyAnalysis:initiateOntologyAnalysis,reOrderQuestions:reOrderQuestions,createPanel:createPanel,getPannelById:getPannelById,getBotPanels:getBotPanels,updatePannelById:updatePannelById,createWidget:createWidget,getWidgetById:getWidgetById,getBotWidgets:getBotWidgets,updateWidgetById:updateWidgetById,deletePanel:deletePanel,deleteWidget:deleteWidget,fbInstallApp:fbInstallApp,getbotSpecficUsers:getbotSpecficUsers,deleteRunDetails:deleteRunDetails,deleteRunDetailsAll:deleteRunDetailsAll,upgradeUniversalBot:upgradeUniversalBot,getLinkBot:getLinkBot,addTrainingData:addTrainingData,searchText:searchText,paginateTrainingData:paginateTrainingData,createUiForm:createUiForm,updateUiForm:updateUiForm,getAllNamespaces:getAllNamespaces,createNamespace:createNamespace,updateNamespace:updateNamespace,deleteNamespace:deleteNamespace,getNSVariables:getNSVariables,addNamespaceKg:addNamespaceKg,enableNamespace:enableNamespace,getBotUiForms:getBotUiForms,getBotUiFormById:getBotUiFormById,deleteBotUiFormById:deleteBotUiFormById,intigrateFormToPanel:intigrateFormToPanel,getKoreUserIdsOnSearch:getKoreUserIdsOnSearch,getChannelsUserdIdsOnSearch:getChannelsUserdIdsOnSearch,analyzeDefaultFilter:analyzeDefaultFilter,analyzeGetDefaultFilter:analyzeGetDefaultFilter,analyzeEditDefaultFilter:analyzeEditDefaultFilter,disableLanguage:disableLanguage,defaultLanguage:defaultLanguage,reEnableLanguage:reEnableLanguage,createVersion:createVersion,getBotVersions:getBotVersions,getBotVersionDateRange:getBotVersionDateRange,deleteBotVersion:deleteBotVersion,exportBotVersion:exportBotVersion,restoreBotVersion:restoreBotVersion,getVersionStatus:getVersionStatus,getRestoreStatus:getRestoreStatus,deleteVersion:deleteVersion,saveTriggerPhaseSettings:saveTriggerPhaseSettings,daasTables:daasTables,daasViews:daasViews,daasSaveServiceNode:daasSaveServiceNode,publishImportBot:publishImportBot,getAdvancedConfigurations:getAdvancedConfigurations,getAdvancedConfigurationsByName:getAdvancedConfigurationsByName,addConfiguration:addConfiguration,getSavedConfiguration:getSavedConfiguration,deleteConfiguration:deleteConfiguration,editConfigurations:editConfigurations,createCustomModel:createCustomModel,updateCustomModel:updateCustomModel,deleteDialogIntentModel:deleteDialogIntentModel,getDeploymentStatus:getDeploymentStatus,updateBotConfigurations:updateBotConfigurations,getSampleBotSettings:getSampleBotSettings,getPlans:getPlans,planChange:planChange,planValidate:planValidate,planCheckout:planCheckout,paymentstatus:paymentstatus,cancelPlanSub:cancelPlanSub,planAutoRecharge:planAutoRecharge,planValidation:planValidation,getBillingsession:getBillingsession,downloadBillingsession:downloadBillingsession,getInvoices:getInvoices,getSupportPlans:getSupportPlans,supportPlanChange:supportPlanChange,supportPlanCancel:supportPlanCancel,supportPlanValidate:supportPlanValidate,getPinnedMenus:getPinnedMenus,createtestcase:createtestcase,clonetestcase:clonetestcase,deletetestcase:deletetestcase,recentTags:recentTags,runtestcases:runtestcases,updatePinnedMenus:updatePinnedMenus,createBulkUtterances:createBulkUtterances,getScenes:getScenes,createScene:createScene,cloneScene:cloneScene,deleteScene:deleteScene,editScene:editScene,importScene:importScene,createtranslationEngine:createtranslationEngine,allTranslationengines:allTranslationengines,gettranslationEngine:gettranslationEngine,editTranslationEngine:editTranslationEngine,deletTranslationEngine:deletTranslationEngine,exportScene:exportScene,resetShareURL:resetShareURL,updateScene:updateScene}}])}(angular),function(ng){"use strict";ng.module("services").service("BTTeamsService",["$translator",function($translator){function translate(urlIdentifier,params,payload,headers){return $translator.translate(urlIdentifier,params,payload,headers)}var getTeams=function(){return translate("bt.teams.get",{},{})};return{getTeams:getTeams}}])}(angular),function(ng){"use strict";ng.module("services").service("$workflowService",function($timeout){var _taskEditInfo,_taskMode,_saveFrom,_alertInfo,_mpAlertInfo,_actionInfo,_mpActionInfo,_flowTaskInfo,serveri18nLang,_selectedStream={},__selectedStreamState="",nlptext="",alertTasks=[],actionTasks=[],dialogTasks=[],informationTasks=[],knowledges=[],_dialogtasksByState=[],_knowledgeTasksByState=[],_informationTasksByState=[],_actionTasksByState=[],_alertTasksByState=[],_allTasksSortedData=[],_uiFormsTasksByState=[],smallTalk=[],_breadCrumb=[],_sideBarView=null,_authInfo={sso_type:"",idpName:""},_requestObject=[{datatype:"",sampleResponse:""}],_wfType="",_wfFields=[],_wfFilters=[],_rqChainObjects=[],_koreUXMap={title:"",body:""},_alrtFldObjects=[],_currentStep=1,_seedData={},_processData=[],_sampleResponseKeys={},_mappingInfo={},_streams=[],_alertDescription="",_alert="",_alertData={},_authData={},_reqData={},_resData={},_setData={},_templates=[],_publishInfo={},_stremType="",_cache=null,_authlist={},_nlpStream={},_navigateTabIndex=".tasks-pane",connectors=[],botDetails={},sampleBotModalTitle="",selectedSampleBot="",sampleBots=[],smartBots=[],_publishedOrSuspended=!1,_isTaskPublished=!1,nlpTrainInput={},_sessionContexts={},_dialogNodesNames={},_isInCAP=!1,selectedLanguage={},currentLanguage="en",i18nSelectedLang="en",supportedLanguages={},botVariables=[],importBotId="",selectedAccount="",_customLibraries=[],_configurationData=[],_savedConfigurationData=[],_slidersList=[],_mlPharam={},debugConsoleTheme="LightTheme",_builderResumeState={},appVersion="",componentsList=[],docData={},createVerData={},trainStatus={},themeMode="LightTheme",searchQry={},universalModalSeen=!1,_kgStateData="",sampleBotData={},processStoreData={},searchSubTask={},newDialogUpgrade=null,displayMode=!1,_currentTrainStatus={},_globalStoreQueryParams=null,newBotSetup={};return{isInCAP:function(flag){return flag===!1||flag===!0?void(_isInCAP=flag):_isInCAP},publishedOrSuspended:function(flag){return flag?void(_publishedOrSuspended=flag):_publishedOrSuspended},globalStoreQueryParams:function(parms){return parms?(_globalStoreQueryParams=parms,void window.localStorage.setItem("installFromStore",JSON.stringify(_globalStoreQueryParams))):_globalStoreQueryParams},isTaskPublished:function(flag){return flag?void(_isTaskPublished=flag):_isTaskPublished},streamType:function(type){return type?void(_stremType=type):_stremType},nlpText:function(text){return text&&(nlptext=text),nlptext},cache:function(cacheValue){return cacheValue&&(_cache=cacheValue),_cache},nlpStream:function(nlpStream){return"object"==typeof nlpStream&&(_nlpStream=nlpStream),_nlpStream},publishEntity:function(publishInfo){return publishInfo?void(_publishInfo=publishInfo):_publishInfo},templates:function(_templs){return _templs?void(_templates=_templs):_templates},mappingInfo:function(_map){return _map?void(_mappingInfo=_map):_mappingInfo},sampleResponseKeys:function(_res){return _res?void(_sampleResponseKeys=_res):_sampleResponseKeys},isPhone:function(value){var numberRegEx=/^\d\d+$/;return numberRegEx.test(value.trim())},formatPhone:function(value){return value.length>=4&&value.length<=6?value=value.replace(/(\d{3})(\d{3})?/,"$1-$2"):value.length>=7&&value.length<=20&&(value=value.replace(/(\d{3})(\d{3})(\d{4})?/,"$1-$2-$3")),value},streamsAll:function(_res){return _res?void(_streams=_res):_streams},seedData:function(_data){return _data?void(_seedData=_data):_seedData},processAppsData:function(_data){return _data?void(_processData=_data):_processData},currentStep:function(_step){return _step?void(_currentStep=_step):_currentStep},cloneData:function(data){var clonedData=null;try{clonedData=JSON.parse(JSON.stringify(data))}catch(e){clonedData=_.cloneDeep(data)}return clonedData||data},selectedStream:function(_stream){if(_stream&&!_stream.hasOwnProperty("_id"))_selectedStream={};else if(_stream){if(_stream.taskCounts){_stream._taskCounts={};var tasksInProgress=0;$.each(_stream.taskCounts,function(key,value){_stream._taskCounts[key]={indevelopment:0,published:0},"faqCount"==key&&(_stream._taskCounts[key].published=_stream.taskCounts.faqCount||0,_stream._taskCounts[key].indevelopment=_stream.taskCounts.faqCount||0),"flows"==key?_stream.taskCounts&&_stream.taskCounts.flows&&_stream.taskCounts.flows&&(_stream._taskCounts[key].indevelopment=_stream.taskCounts.flows.paramMaps.length+_stream.taskCounts.flows.taskDGParamMaps.length,_stream._taskCounts[key].published=_stream.taskCounts.flows.taskDGParamMaps.length||0):"smalltalks"==key?(_stream.taskCounts&&_stream.taskCounts.smalltalks&&$.each(value,function(i,value){value&&"published"===value.state&&(_stream._taskCounts[key].published=value.count||0),value&&"configured"===value.state&&(_stream._taskCounts[key].indevelopment=value.count||0)}),_stream._taskCounts.totalIndevelopment=(_stream._taskCounts.totalIndevelopment||0)+_stream._taskCounts[key].indevelopment,_stream._taskCounts.totalPublished=(_stream._taskCounts.totalPublished||0)+_stream._taskCounts[key].published,_stream._taskCounts.totalTasks=_stream._taskCounts.totalIndevelopment+_stream._taskCounts.totalPublished,_stream._taskCounts.totalTasksInUse=_stream._taskCounts.totalTasks-tasksInProgress):"forms"===key?(_stream.taskCounts&&_stream.taskCounts.forms&&$.each(value,function(i,value){(value&&"published"===value.state||"suspended"===value.state)&&(_stream._taskCounts[key].published=value.count||0),!value||"configured"!==value.state&&"awaitingApproval"!==value.state&&"rejected"!==value.state||(_stream._taskCounts[key].indevelopment=value.count||0)}),_stream._taskCounts.totalIndevelopment=(_stream._taskCounts.totalIndevelopment||0)+_stream._taskCounts[key].indevelopment,_stream._taskCounts.totalPublished=(_stream._taskCounts.totalPublished||0)+_stream._taskCounts[key].published,_stream._taskCounts.totalTasks=_stream._taskCounts.totalIndevelopment+_stream._taskCounts.totalPublished,_stream._taskCounts.totalTasksInUse=_stream._taskCounts.totalTasks-tasksInProgress):"widgets"==key||"panels"===key?(_stream.taskCounts&&_stream.taskCounts.widgets&&"widgets"===key&&(_stream._taskCounts[key]={published:0,indevelopment:0},$.each(value,function(i,value){(value&&"published"===value.state||"suspended"===value.state)&&(_stream._taskCounts[key].published=(_stream._taskCounts[key].published||0)+(value.count||0)),!value||"configured"!==value.state&&"awaitingApproval"!==value.state&&"rejected"!==value.state||(_stream._taskCounts[key].indevelopment=(_stream._taskCounts[key].indevelopment||0)+(value.count||0))})),_stream.taskCounts&&_stream.taskCounts.panels&&"panels"===key&&(_stream._taskCounts[key]={published:0,indevelopment:0},$.each(value,function(i,value){!value||"published"!==value.state&&"suspended"!==value.state||(_stream._taskCounts[key].published=(_stream._taskCounts[key].published||0)+(value.count||0)),!value||"configured"!==value.state&&"awaitingApproval"!==value.state&&"rejected"!==value.state||(_stream._taskCounts[key].indevelopment=(_stream._taskCounts[key].indevelopment||0)+(value.count||0))})),_stream._taskCounts.totalIndevelopment=(_stream._taskCounts.totalIndevelopment||0)+_stream._taskCounts[key].indevelopment,_stream._taskCounts.totalPublished=(_stream._taskCounts.totalPublished||0)+_stream._taskCounts[key].published,_stream._taskCounts.totalTasks=_stream._taskCounts.totalIndevelopment+_stream._taskCounts.totalPublished,_stream._taskCounts.totalTasksInUse=_stream._taskCounts.totalTasks-tasksInProgress):"faqCount"!==key&&($.each(value,function(i,value){_stream._taskCounts[key].indevelopment=_stream._taskCounts[key].indevelopment+(value.count||0)-(value.deletedCount||0),value&&"published"==value.state&&(_stream._taskCounts[key].published=value.count||0),value&&"inProgress"==value.state&&(tasksInProgress=(tasksInProgress||0)+value.count)}),_stream._taskCounts.totalIndevelopment=(_stream._taskCounts.totalIndevelopment||0)+_stream._taskCounts[key].indevelopment,_stream._taskCounts.totalPublished=(_stream._taskCounts.totalPublished||0)+_stream._taskCounts[key].published,_stream._taskCounts.totalTasks=_stream._taskCounts.totalIndevelopment+_stream._taskCounts.totalPublished,_stream._taskCounts.totalTasksInUse=_stream._taskCounts.totalTasks-tasksInProgress)})}return"private"===_stream.visibility.namespace?_stream.isInMarket=!1:_stream.isInMarket=!0,_isInCAP=_stream._taskCounts&&_stream._taskCounts.totalTasksInUse?!0:!1,_stream.isInMarket&&(_isInCAP=!0),_selectedStream=_stream}return _selectedStream},configurationList:function(configuration){return configuration?_configurationData=configuration:_configurationData},savedConfigurationsList:function(savedConfiguration){return savedConfiguration?_savedConfigurationData=savedConfiguration:_savedConfigurationData},registerSliders:function(slidersList){return slidersList?_slidersList=slidersList:_slidersList},selectedStreamState:function(state){return state?__selectedStreamState=state:__selectedStreamState},customLibraries:function(data){return data?_customLibraries=data:_customLibraries},contextData:function(_context){return _context?void(_sessionContexts=_context):_sessionContexts},botEnvVariables:function(_variables){return _variables?void(botVariables=_variables):botVariables},mlPharams:function(mlPharam){return mlPharam?(_mlPharam=mlPharam,_selectedStream):_mlPharam},importedNewBotId:function(streamId){return streamId?void(importBotId=streamId):importBotId},dialogNodesNames:function(_nodes){return _nodes?void(_dialogNodesNames=_nodes):_dialogNodesNames},workflowType:function(_type){return _type?void(_wfType=_type):_wfType},alertDescription:function(_desc){return _desc?void(_alertDescription=_desc):_alertDescription},authInfo:function(_info){return _info?void(_authInfo=_info):_authInfo},taskEditInfo:function(_info){return _info?void(_taskEditInfo=_info):_taskEditInfo},taskMode:function(_info){return _info?void(_taskMode=_info):_taskMode},storeSearchQry:function(_info){return _info?void(searchQry=_info):searchQry},subTabSearchQuery:function(subTaskQry){return subTaskQry?void(searchSubTask=subTaskQry):searchSubTask},saveFrom:function(_info){return _info?void(_saveFrom=_info):_saveFrom},resetTaskEditInfo:function(){_taskEditInfo=void 0},alertInfo:function(_info){return _info?void(_alertInfo=_info):_alertInfo},mpAlertInfo:function(_info){return _info?void(_mpAlertInfo=_info):_mpAlertInfo},actionInfo:function(_info){return _info?void(_actionInfo=_info):_actionInfo},mpActionInfo:function(_info){return _info?void(_mpActionInfo=_info):_mpActionInfo},flowtaskInfo:function(_info){return _info?void(_flowTaskInfo=_info):_flowTaskInfo},requestObject:function(_rqObj){return _rqObj?void(_requestObject=_rqObj):_requestObject},workflowFields:function(_fields){return _fields?void(_wfFields=_fields):_wfFields},workflowFilters:function(_filters){return _filters?void(_wfFilters=_filters):_wfFilters},requestChainObjects:function(rqObj,index){return rqObj?void _rqChainObjects.push(rqObj):_rqChainObjects},alrtFldObjects:function(alrtField,index){return alrtField?void _alrtFldObjects.push(alrtField):_alrtFldObjects},koreUXMap:function(_map){return _map?void(_koreUXMap=_map):_koreUXMap},alertSelected:function(alert){return alert?void(_alert=alert):_alert},alertData:function(alertData){return alertData?void(_alertData=alertData):_alertData},authData:function(authData){return authData?void(_authData=authData):_authData},requestData:function(reqData){return reqData?void(_reqData=reqData):_reqData},responseData:function(resData){return resData?void(_resData=resData):_resData},settingsData:function(setData){return setData?void(_setData=setData):_setData},authlist:function(list){return list?void(_authlist=list):_authlist},alertTasks:function(alertsList){return alertsList?void(alertTasks=alertsList):alertTasks},actionTasks:function(actionslist){return actionslist?void(actionTasks=actionslist):actionTasks},dialogTasks:function(flowTasksList){return flowTasksList?void(dialogTasks=flowTasksList):dialogTasks},smallTalk:function(smallTalkList){return smallTalkList?void(smallTalk=smallTalkList):smallTalk},dialogTasksByState:function(tasksByState){return tasksByState?void(_dialogtasksByState=tasksByState):_dialogtasksByState},alertTasksByState:function(tasksByState){return tasksByState?void(_alertTasksByState=tasksByState):_alertTasksByState},actionTasksByState:function(tasksByState){return tasksByState?void(_actionTasksByState=tasksByState):_actionTasksByState},informationTasksByState:function(tasksByState){return tasksByState?void(_informationTasksByState=tasksByState):_informationTasksByState},knowledgeTasksByState:function(tasksByState){return tasksByState?void(_knowledgeTasksByState=tasksByState):_knowledgeTasksByState},uiFormsTasksByState:function(tasksByState){return tasksByState?void(_uiFormsTasksByState=tasksByState):_uiFormsTasksByState},allTasksSortedData:function(tasksByState){return tasksByState?void(_allTasksSortedData=tasksByState):_allTasksSortedData},informationTasks:function(informationList){return informationList?void(informationTasks=informationList):informationTasks},knowledgeTasks:function(knowledgeList){return knowledgeList?void(knowledges=knowledgeList):knowledges},btAppVersion:function(version){return version?void(appVersion=version):appVersion},universalModalShowStatus:function(showType){return void 0!==showType?void(universalModalSeen=showType):universalModalSeen},builderResumeState:function(paths){var pathObj={path:[]},localPath=window.localStorage.getItem("previousState");return localPath&&(_builderResumeState=JSON.parse(localPath)),paths?(pathObj.path=paths,pathObj.selectedStream={_id:_selectedStream._id,accountId:_selectedStream.accountId,defaultLanguage:_selectedStream.defaultLanguage},pathObj.selectedStreamState=__selectedStreamState,pathObj.selectedLanguage=currentLanguage,pathObj.account=selectedAccount,pathObj.appVersion=appVersion,"universalbot"===_selectedStream.type&&(pathObj.universalSeen=universalModalSeen),window.localStorage.setItem("previousState",JSON.stringify(pathObj)),void(_builderResumeState=pathObj)):_builderResumeState},breadCrumb:function(breadCrumbData){return breadCrumbData?void(_breadCrumb=breadCrumbData):_breadCrumb},sideBarView:function(view){return view?void(_sideBarView=view):_sideBarView},newDialogUpgrade:function(setId,reset){if(setId)newDialogUpgrade=setId;else{if(!reset)return newDialogUpgrade;newDialogUpgrade=null}},navigateTabIndex:function(index){return index?void(_navigateTabIndex=index):_navigateTabIndex||".tasks-pane"},botConnectors:function(connectorsList){return connectorsList?void(connectors=connectorsList):connectors},registerModalHiddenEvent:function(){},reigisterModalShownEvent:function(){},botDetails:function(streamName,details){return details?void(botDetails[streamName]=details):botDetails[streamName]?botDetails[streamName]:!1},sampleBotModalTitle:function(name){return name?void(sampleBotModalTitle=name):sampleBotModalTitle},selectedSampleBot:function(sampleBot){return sampleBot?void(selectedSampleBot=sampleBot):selectedSampleBot},selectedSmartBot:function(sampleBot){return sampleBot?void(selectedSampleBot=sampleBot):selectedSampleBot},allSampleBots:function(bots){return bots?void(sampleBots=bots):sampleBots},allSmartBots:function(bots){return bots?void(smartBots=bots):smartBots},nlpTrainInput:function(input){return input?void(nlpTrainInput=input):nlpTrainInput},selectedLanguage:function(language){return language?void(selectedLanguage=language):selectedLanguage},currentLanguage:function(language){return language?void(currentLanguage=language):currentLanguage},i18nSelectedLanguage:function(language){return language?void(i18nSelectedLang=language):i18nSelectedLang},serveri18nLang:function(language){return language?(serveri18nLang=language,void window.localStorage.setItem("queryParamLang",language)):serveri18nLang},supportedLanguages:function(languages){return languages?void(supportedLanguages=languages):supportedLanguages},selectedAccount:function(account){return account?void(selectedAccount=account):selectedAccount},kgDataFromKora:function(kgStateData){return kgStateData?void(_kgStateData=kgStateData):_kgStateData},defaultComponentIVRProps:function(){var _defaultIVRProps={initialPrompts:[],nomatchPrompts:[],timeoutPrompts:[],errorPrompts:[],grammars:[{inputMode:"speech",type:"custom",value:""}],advance:{timeout:1e4,retry_limit:3,bargein:!1,properties:[],enable_log:!1,recording:"stop"}};return _selectedStream&&_selectedStream.ivrSettings&&_selectedStream.ivrSettings.enable_transcript&&(_defaultIVRProps.grammars[0].type="disable"),_defaultIVRProps},debugConsoleThemeInfo:function(type){return type?void(debugConsoleTheme=type):debugConsoleTheme},selectedDialogComponents:function(data){return data?void(componentsList=data):componentsList},setCurrentDockId:function(dockId){return dockId?void(dockId=dockId):dockId},ontologyJobStatus:function(data){return data?void(docData=data):docData},kgTrainingStatus:function(data){return data?void(trainStatus=data):trainStatus},createVersionStatus:function(data){return data?void(createVerData=data):createVerData},saveThemeMode:function(type){return type?void(themeMode=type):themeMode},sampleBotDataFromBotStore:function(data){return data?void(sampleBotData=data):sampleBotData},toInstallProcessApp:function(data){return data?void(processStoreData=data):processStoreData},flowTaskDisplayMode:function(datavalue){return"string"!=typeof datavalue?displayMode:void(displayMode=datavalue)},currTrainStatus:function(status){return status?void(_currentTrainStatus=status):_currentTrainStatus},newBotSetupProgress:function(obj){return obj?void(newBotSetup=obj):newBotSetup}}})}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components",["bt-components"]);_module.controller("BTAddSynonymsCtrl",["$scope","$translator","$modalInstance","$workflowService","BTStreamsService","config","env_conf","i18n",function($scope,$translator,$modalInstance,$workflowService,BTStreamsService,config,env_conf,i18n){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.synonymsSelect2Options={maxTagLength:128},$scope.manageSynonym={},$scope.assetsBase=env_conf["assets-url"],$scope.fromPP=!1,$scope.saving=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),config.isFromPP&&($scope.fromPP=!0),$scope.closeModal=function(){$modalInstance.close()},$scope.addBotSynonym=function(){var payload={},currentSynonmyms=angular.copy($scope.manageSynonym.synonyms);if($scope.saveInProgress=!0,config.parentSynonyms&&config.parentSynonyms[$scope.manageSynonym.keyword]&&config.parentSynonyms[$scope.manageSynonym.keyword].length){var existingSynonyms=angular.copy(config.parentSynonyms[$scope.manageSynonym.keyword]);existingSynonyms=existingSynonyms.concat(currentSynonmyms),config.parentSynonyms[$scope.manageSynonym.keyword]=existingSynonyms}else config.parentSynonyms[$scope.manageSynonym.keyword]=currentSynonmyms;payload=angular.copy(config.parentSynonyms),BTStreamsService.postSynonyms($scope.stream._id,{synonyms:payload}).then(function(res){$workflowService.selectedStream(res.data),$workflowService.nlpStream(res.data),$scope.saveInProgress=!1,config&&config.cbBridge&&config.cbBridge.onBotUpdate&&config.cbBridge.onBotUpdate(res.data),$scope.closeModal()},function(err){$scope.saveInProgress=!1})}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToWeChatCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.closeModal=function(){
$modalInstance.close()},$scope.assetsBase=env_conf["assets-url"]}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToAlexaCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToAudioCodesCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToEmailCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","BTStreamsService","NotificationService","env_conf","$applicationService","_constants_","$timeout","i18n",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,BTStreamsService,NotificationService,env_conf,$applicationService,_constants_,$timeout,i18n){function addBotToChannel(type,value){var payload={channels:[{type:type,value:value}]};BTStreamsService.addChannelToBot($scope.stream._id,payload).then(function(response){NotificationService.notify(i18n.i18nString("bt_add_to_email_verification_successful"),"success"),$scope.selectedIdentity=value,$scope.verificationSuccessfull=!0},function(err){var errMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||"";NotificationService.notify(errMsg,"error")})}function switchVerifyEmailForm(){$scope.resend=!0,$scope.resendEmail=!0,$(".add-bot").animate({scrollTop:0},"slow")}function switchVerifyPhoneForm(){$scope.resend=!0,$scope.resendPhone=!0,$timeout(function(){$(".verificationCodeInput").trigger("focus"),$(".add-bot").animate({scrollTop:0},"slow")},20)}function addNewIdentity(payload,type){$scope.IdentityType=type;var params={userId:curUserDetails.userId,addBot:!0,streamId:$scope.stream._id};BTStreamsService.addUserIdentity(curUserDetails.userId,payload,params).then(function(res){"email"===$scope.IdentityType?(NotificationService.notify(i18n.i18nString("formtitles_verify_email"),"success"),switchVerifyEmailForm()):(NotificationService.notify(i18n.i18nString("please_verify_phone_number"),"success"),switchVerifyPhoneForm()),getAdditionalIdenties()},function(err){var errorMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||"";errorMsg&&"CompanyEmailNotAllowed"===errorMsg?errorMsg=i18n.i18nString("company_mail_not_allowed"):errorMsg&&"Validation errors/ Invalid arguments"===errorMsg&&(errorMsg="email"===$scope.IdentityType?i18n.i18nString("please_enter_valid_email"):i18n.i18nString("please_enter_valid_mobile_number")),NotificationService.notify(errorMsg,"error")})}function updatePhoneIdentityStatus(){for(var i=0;i<$scope.identities.phone.length;i++)if($scope.identities.phone[i].val===$scope.selectedPhoneNumber)return void($scope.identities.phone[i].status="verified")}function deleteOldIdentity(oldPhoneNumber,newPhoneNumber){var params={userId:curUserDetails.userId,identity:encodeURIComponent(oldPhoneNumber)};BTStreamsService.deleteUserIdentity(curUserDetails.userId,encodeURIComponent(oldPhoneNumber),params).then(function(res){},function(err){var errorMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||"";NotificationService.notify(errorMsg,"error")})}function parsePhoneNumber(phoneValue){var result={countryCode:"",phoneNumber:""},tempPhoneValue=phoneValue;"+"!==phoneValue.substring(0,1)?tempPhoneValue="+"+phoneValue:phoneValue=phoneValue.replace("+","");var regionCode=libphonenumber.getRegionCodeForNumber(tempPhoneValue,""),cCode=libphonenumber.getCountryCodeForRegion(regionCode);return result.countryCode=getCountryCodeByValue(cCode),result.phoneNumber=phoneValue.replace(cCode,""),result}function getCountryCodeByValue(value){value="+"+value;var countryCodesData=$scope._constants_.countryCodes;for(var code in countryCodesData)if(countryCodesData[code].value===value)return countryCodesData[code]}function filterAdditionalIdentities(response){var associatedIdentities=response.data;$scope.identities=null,$scope.identities={email:[],phone:[]};var emailIds=associatedIdentities.filter(function(id){return"email"===id.type});$scope.identities.email=emailIds;var phoneIds=associatedIdentities.filter(function(id){return"phone"===id.type});$scope.identities.phone=phoneIds}function getAdditionalIdenties(){BTStreamsService.getuserAdditionalIdentities($applicationService.userInfo().userId).then(function(res){filterAdditionalIdentities(res)},function(err){var errorMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||"";NotificationService.notify(errorMsg,"error")})}function InitializeComponents(){$scope.selectItem($scope._constants_.countryCodes[0]),$scope.emailChannel?$timeout(function(){$(".fullInputWidth.ng-valid-email").trigger("focus")},20):$timeout(function(){$(".phone-field").trigger("focus")},20)}$scope.stream=$workflowService.selectedStream();var curUserDetails=$applicationService.userInfo();$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.identities=config.component.additionalIdentities,$scope.assetsBase=env_conf["assets-url"],$scope.emailId=null,$scope.emailChannel="email"===$scope.source.type?!0:!1,$scope._constants_=_constants_,$scope.phoneNumber={countryCode:"",countryName:"",number:""},$scope.resend=!1,$scope.resendEmail=!1,$scope.resendPhone=!1,$scope.resendMailStatusText=i18n.i18nString("email_sent"),$scope.phone={},$scope.phone.phoneOTP="",$scope.codeSent=i18n.i18nString("code_sent"),$scope.resendPhoneVerifyStatusText=i18n.i18nString("verify"),$scope.isFromChangePhoneNumber=!1,$scope.oldPhoneNumber=null,$scope.verificationSuccessfull=!1,$scope.selectedIdentity=null,$scope.email=i18n.i18nString("bt_add_to_email_email"),$scope.message=i18n.i18nString("bt_add_to_email_message"),$scope.stream.icon||($scope.stream.icon=config.component.botIcon),$scope.closeModal=function(){$scope.resetSelectedIdentity(),$modalInstance.close()},$scope.resendEmailVerify=function(){var payload={emailId:$scope.selectedEmail},params={};$scope.resendMailStatusText=i18n.i18nString("sending_email_label"),BTStreamsService.resendIdentityVerification(curUserDetails.userId,payload,params).then(function(res){$scope.resendMailStatusText=i18n.i18nString("email_sent_name"),$timeout(function(){$scope.resendMailStatusText=i18n.i18nString("email_sent")},5e3)},function(err){var errorMsg=i18n.i18nString("resend_email_failed");NotificationService.notify(errorMsg,"error"),$scope.resendMailStatusText=i18n.i18nString("email_sent")})},$scope.scrollDown=function(){$(".add-bot").animate({scrollTop:500},"slow")},$scope.goStepBack=function(){$scope.resend=!1,$scope.resendPhone=!1,$scope.resendEmail=!1,$scope.verificationSuccessfull=!1},$scope.addEmailId=function(emailId){if($scope.selectedEmail=emailId,$scope.selectedIdentity&&"unverified"===$scope.selectedIdentity.status)return NotificationService.notify(i18n.i18nString("please_verify_your_email"),"warning"),void switchVerifyEmailForm();if($scope.selectedIdentity&&"verified"===$scope.selectedIdentity.status)return void addBotToChannel("email",emailId);for(var i=0;i<$scope.identities.email.length;i++){var identity=$scope.identities.email[i];if(identity.val===emailId&&"unverified"===identity.status)NotificationService.notify(i18n.i18nString("please_verify_your_email"),"warning"),switchVerifyEmailForm();else if(identity.val===emailId&&"verified"===identity.status)return void addBotToChannel("email",emailId)}BTStreamsService.isFreeEmail(emailId).then(function(res){var payload={emailId:emailId};addNewIdentity(payload,"email")},function(err){var errorMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("error_in_checking_email");NotificationService.notify(errorMsg,"error")})},$scope.chooseEmailIdentity=function(identity){$scope.selectedIdentity=identity,$scope.selectedEmail=$scope.selectedIdentity.val,"verified"!==identity.status&&$scope.resendEmailVerify(),$scope.addEmailId($scope.selectedIdentity.val)},$scope.resetSelectedIdentity=function(){$scope.selectedIdentity=null},$scope.selectItem=function(item){console.log(item),$scope.phoneNumber.countryCode=item.value,$scope.phoneNumber.countryName=item.name,$scope.countryCodeChoosen=item,$(".dropdown").removeClass("open"),$scope.channelForm&&$timeout(function(){$scope.channelForm.phoneOnly.$$parseAndValidate()},100),$(".add-bot").animate({scrollTop:0},"slow")},$timeout(function(){$(".add-bot").on("click",".dropdown-menu",function(evt){evt.stopPropagation()})},500),$scope.choosePhoneIdentity=function(identity){$scope.selectedIdentity=identity,$scope.selectedPhoneNumber=identity.val,"verified"!==identity.status&&$scope.resendPhoneCode(),$scope.addPhoneNumber($scope.selectedIdentity)},$scope.addPhoneNumber=function(phoneNumber){if(phoneNumber.countryCode?(phoneNumber=phoneNumber.countryCode+phoneNumber.number,phoneNumber=phoneNumber.replace(/-/g,"")):phoneNumber=phoneNumber.val,$scope.selectedPhoneNumber=phoneNumber,$scope.selectedIdentity&&"unverified"===$scope.selectedIdentity)return NotificationService.notify(i18n.i18nString("please_Verify_your_phone_number"),"warning"),void switchVerifyPhoneForm();if($scope.selectedIdentity&&"verified"===$scope.selectedIdentity)return void addBotToChannel("sms",phoneNumber);for(var i=0;i<$scope.identities.phone.length;i++){var identity=$scope.identities.phone[i];if(identity.val===phoneNumber&&"unverified"===identity.status)return NotificationService.notify(i18n.i18nString("please_Verify_your_phone_number"),"warning"),void switchVerifyPhoneForm();if(identity.val===phoneNumber&&"verified"===identity.status)return void addBotToChannel("sms",phoneNumber)}if($scope.isFromChangePhoneNumber){if(phoneNumber===$scope.oldPhoneNumber)return void switchVerifyPhoneForm();deleteOldIdentity($scope.oldPhoneNumber,phoneNumber),$scope.oldPhoneNumber=null,$scope.isFromChangePhoneNumber=!1}var payload={phoneNo:phoneNumber};addNewIdentity(payload,"phone")},$scope.changeMobileNumber=function(){$scope.isFromChangePhoneNumber=!0,$scope.oldPhoneNumber=$scope.selectedPhoneNumber,$scope.resend=!1,$scope.resendPhone=!1,$timeout(function(){$(".phone-field").trigger("focus")},20)},$scope.resendPhoneCode=function(){if($scope.codeSent!==i18n.i18nString("code_sent_name")){var payload={phoneNo:$scope.selectedPhoneNumber},params={};$scope.codeSent=i18n.i18nString("sending_code"),BTStreamsService.resendIdentityVerification(curUserDetails.userId,payload,params).then(function(res){$scope.codeSent=i18n.i18nString("code_sent_name"),$timeout(function(){$scope.codeSent=i18n.i18nString("code_sent")},5e3)},function(err){var errorMsg=i18n.i18nString("resend_Code_failed");NotificationService.notify(errorMsg,"error"),$scope.codeSent=i18n.i18nString("code_sent")})}},$scope.phoneVerify=function(){var formattedPhone=parsePhoneNumber($scope.selectedPhoneNumber),data={phone:!0,countryCode:formattedPhone.countryCode.value,emailPhone:formattedPhone.phoneNumber,token:$scope.phone.phoneOTP,redirectForm:"bot-channels-form",userId:curUserDetails.userId},params={token:data.token},payload={};data.phone&&(payload.phoneNo=(data.countryCode+data.emailPhone).replace(/-/g,""),params.phoneNo=encodeURIComponent(payload.phoneNo)),data.userId&&(params.userId=data.userId),BTStreamsService.verifyOTP(data.token,payload,params).then(function(res){NotificationService.notify(i18n.i18nString("otp_verified_success"),"success"),updatePhoneIdentityStatus(),$scope.phone.phoneOTP="",addBotToChannel("sms",$scope.selectedPhoneNumber)},function(err){var errorMsg=err&&err.data&&err.data.errors&&err.data.errors[0].msg||i18n.i18nString("please_enter_correct_otp");errorMsg&&"TOKEN_NOT_FOUND"===errorMsg&&(errorMsg=i18n.i18nString("please_enter_correct_otp")),NotificationService.notify(errorMsg,"error")})},InitializeComponents()}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToGoogleHomeCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.closeModal=function(){$modalInstance.close()},$scope.assetsBase=env_conf["assets-url"]}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToHangoutChatCtrl",["$scope","$modalInstance","env_conf",function($scope,$modalInstance,env_conf){$scope.closeModal=function(){$modalInstance.close()},$scope.assetsBase=env_conf["assets-url"]}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToIVRCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.webhookURL=config.component.channelSource.url||env_conf.API_SERVER_URL+"/chatbot/hooks/"+$scope.stream._id,$scope.webhookURLV2=config.component.channelSource.url_v2||env_conf.API_SERVER_URL+"/chatbot/v2/webhook/"+stream._id,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToIVRVoiceCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToLineCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToLivePersonCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToMatterMostCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.intergrationType=$scope.stream.channels.filter(function(val){return"mattermost"==val.type})[0].integrationType,$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToTwilioVoiceCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"];var mobileArray=[];$.each($scope.source.numbers,function(i,numbers){var formatNumber=numbers.countryCode+numbers.number;mobileArray.push(formatNumber)}),$scope.twilioVoiceNumbers=mobileArray.join(",")||"",$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToWebmobileCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToWhatsappCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf","$timeout",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf,$timeout){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1;var clipWebhook_url;$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.phoneNum=$scope.stream.channels.filter(function(val){return"whatsapp"===val.type})[0].from,$scope.closeModal=function(){$modalInstance.close()},$scope.whatsapp={link:"https://wa.me/"+$scope.phoneNum},$timeout(function(){clipWebhook_url=new Clipboard('[data-clipboard-target="#whatsAppForm_link"]'),$scope.isSafariwh=!1,clipWebhook_url.on("success",function(e){}),clipWebhook_url.on("error",function(e){$scope.isSafariwh=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0||function(p){return"[object SafariRemoteNotification]"===p.toString()}(!window.safari||safari.pushNotification)})})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToWidgetSdkCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToWorkplaceCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToYammerCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1,$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.manageSynonym={},$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTAddToUnbluCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","env_conf","$timeout",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,env_conf,$timeout){$scope.stream=$workflowService.selectedStream(),$scope.saveInProgress=!1;$scope.source=config.component.channelSource,$scope.assetsBase=env_conf["assets-url"],$scope.phoneNum=$scope.stream.channels.filter(function(val){return"unblu"===val.type})[0].from,$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btAnalyzeDetails",[function(){return{restrict:"EA",scope:{cb:"=",filterComponent:"=",currentTab:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-analyze-details/bt-analyze-details.html",controller:["$scope","$workflowService","BTStreamsService","$timeout","env_conf","NotificationService","form_util","$modal","$applicationService","channelsConfig","i18n",function($scope,$workflowService,BTStreamsService,$timeout,env_conf,NotificationService,form_util,$modal,$applicationService,channelsConfig,i18n){function init(task,intentName,recordTags){$('[data-toggle="tooltip"]').tooltip(),$scope.nlpData={},$scope.nlpData=task.NLAnalysis,$scope.nlpData?$scope.nlpData.input=task.input||"":($scope.nlpData={},$scope.nlpData.input=task.input||""),$scope.task=task,$scope.utteranceStr=$scope.task.originalInputWithoutTranslation,$scope.nlpData&&$scope.nlpData.nlProcessing&&$scope.nlpData.nlProcessing.spellCorrectedInput&&($scope.originalInputAfterTranslation=$scope.task.input[0]),$scope.channelType=$scope.task.channel||"---",$scope.nluLanguage=$scope.getLanguage($scope.task.nluLanguage),$scope.botLanguage=$scope.getLanguage($scope.task.language),$scope.intent="---"!==intentName?intentName:$scope.task.task||"---",$scope.entity=$scope.nlpData&&$scope.nlpData.finalResolver&&$scope.nlpData.finalResolver.entities&&$scope.nlpData.finalResolver.entities.length?$scope.nlpData.finalResolver.entities.join(", "):"---",$scope.flow=$scope.originalIntent&&$scope.originalIntent.flow&&$scope.originalIntent.flow.join(" > ")||task.flow&&task.flow.join(" > ")||"---",$scope.recordTags=recordTags,$scope.jsonData=JSON.stringify($scope.task,null,"	");var jsonDomEle=document.getElementById("jsonInfo");jsonDomEle&&(jsonDomEle.innerHTML=JSON.stringify($scope.task,void 0,2)),$scope.showjson="Show JSON",jsonDivToggle(),updateNLPLines()}function jsonDivToggle(){setTimeout(function(){$(".showJson").click(function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(".eachSection.jsonData").slideToggle("slow","linear"),"Show JSON"===$scope.showjson?$scope.showjson="Hide JSON":$scope.showjson="Show JSON"})},500)}function loadPerformanceData(offset,limit,fromScroll,showExcludeText){if(!$scope.performanceDetails.all.loading){$scope.performanceDetails.all.loading=!0;var payload={type:"performance"},dateObj=getISOdates($scope.cb.filterComponent.days);payload.filters={componentId:[$scope.performanceTask.componentId],from:dateObj.from,to:dateObj.to},$scope.cb.filterComponent.isDeveloper||(payload.filters.isDeveloper=!1),$scope.cb.filterComponent&&$scope.cb.filterComponent.channels&&$scope.cb.filterComponent.channels.length&&(payload.filters.channel=$scope.cb.filterComponent.channels);var userValues=[];$scope.cb.filterComponent.users&&$scope.cb.filterComponent.users.length&&(_.forEach($scope.cb.filterComponent.users,function(user){user.value&&user.id?(delete user.value,user=user.id):user.value&&!user.id?user=user.value:!user.value&&user.id&&(user=user.id),userValues.push(user)}),userValues&&userValues.length&&($scope.cb.filterComponent.users=userValues)),$scope.cb.filterComponent.users.length>0&&!showExcludeText?"Channel ID"===$scope.cb.toggleCheck?payload.filters.channelUIds=$scope.cb.filterComponent.users:payload.filters.userId=$scope.cb.filterComponent.users:$scope.cb.filterComponent.users.length>0&&showExcludeText&&("Channel ID"===$scope.cb.toggleCheck?payload.filters.excludeChannelUIds=$scope.cb.filterComponent.users:payload.filters.excludeUserIds=$scope.cb.filterComponent.users),$scope.cb.filterComponent.languages.length>0&&(payload.filters.language=$scope.cb.filterComponent.languages),$scope.cb.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.cb.filterComponent.tasks),payload.sort={order:$scope.performanceDetails.all.sortBy,by:"timestamp"},BTStreamsService.getAnalyzeRecords($scope.stream._id,offset,limit,payload).then(function(res){res.data&&($scope.tasksValue=res.data,$scope.performanceDetails.all.moreavailable=res.data.moreavailable,fromScroll?$scope.performanceCollection=$scope.performanceCollection.concat(res.data.result):$scope.performanceCollection=res.data.result,$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.components=_.uniq($scope.components.concat(res.data.components?res.data.components:[])),handleGroupedTasks()),$scope.performanceDetails.all.loading=!1},function(error){if($scope.performanceDetails.all.loading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}function loadSuccessPerformanceData(offset,limit,fromScroll,showExcludeText){if(!$scope.performanceDetails.success.loading){$scope.performanceDetails.success.loading=!0;var payload={type:"performance"},dateObj=getISOdates($scope.cb.filterComponent.days);payload.filters={componentId:[$scope.performanceTask.componentId],wasSuccessfull:!0,from:dateObj.from,to:dateObj.to},$scope.cb.filterComponent.isDeveloper||(payload.filters.isDeveloper=!1),$scope.cb.filterComponent&&$scope.cb.filterComponent.channels&&$scope.cb.filterComponent.channels.length&&(payload.filters.channel=$scope.cb.filterComponent.channels),$scope.cb.filterComponent.users.length>0&&!showExcludeText?"Channel ID"===$scope.cb.toggleCheck?payload.filters.channelUIds=$scope.cb.filterComponent.users:payload.filters.userId=$scope.cb.filterComponent.users:$scope.cb.filterComponent.users.length>0&&showExcludeText&&("Channel ID"===$scope.cb.toggleCheck?payload.filters.excludeChannelUIds=$scope.cb.filterComponent.users:payload.filters.excludeUserIds=$scope.cb.filterComponent.users),$scope.cb.filterComponent.languages.length>0&&(payload.filters.language=$scope.cb.filterComponent.languages),$scope.cb.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.cb.filterComponent.tasks),payload.sort={order:$scope.performanceDetails.success.sortBy,by:"timestamp"},BTStreamsService.getAnalyzeRecords($scope.stream._id,offset,limit,payload).then(function(res){res.data&&($scope.performanceDetails.success.moreavailable=res.data.moreavailable,fromScroll?$scope.performanceSuccessCollection=$scope.performanceSuccessCollection.concat(res.data.result):$scope.performanceSuccessCollection=res.data.result,$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.components=_.uniq($scope.components.concat(res.data.components?res.data.components:[])),handleGroupedTasks()),$scope.performanceDetails.success.loading=!1},function(error){if($scope.performanceDetails.success.loading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}function loadFailurePerformanceData(offset,limit,fromScroll,showExcludeText){if(!$scope.performanceDetails.failure.loading){$scope.performanceDetails.failure.loading=!0;var payload={type:"performance"},dateObj=getISOdates($scope.cb.filterComponent.days);payload.filters={componentId:[$scope.performanceTask.componentId],wasSuccessfull:!1,from:dateObj.from,to:dateObj.to},$scope.cb.filterComponent.isDeveloper||(payload.filters.isDeveloper=!1),$scope.cb.filterComponent&&$scope.cb.filterComponent.channels&&$scope.cb.filterComponent.channels.length&&(payload.filters.channel=$scope.cb.filterComponent.channels),$scope.cb.filterComponent.users.length>0&&!showExcludeText?"Channel ID"===$scope.cb.toggleCheck?payload.filters.channelUIds=$scope.cb.filterComponent.users:payload.filters.userId=$scope.cb.filterComponent.users:$scope.cb.filterComponent.users.length>0&&showExcludeText&&("Channel ID"===$scope.cb.toggleCheck?payload.filters.excludeChannelUIds=$scope.cb.filterComponent.users:payload.filters.excludeUserIds=$scope.cb.filterComponent.users),$scope.cb.filterComponent.languages.length>0&&(payload.filters.language=$scope.cb.filterComponent.languages),$scope.cb.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.cb.filterComponent.tasks),payload.sort={order:$scope.performanceDetails.failure.sortBy,by:"timestamp"},BTStreamsService.getAnalyzeRecords($scope.stream._id,offset,limit,payload).then(function(res){res.data&&($scope.performanceDetails.failure.moreavailable=res.data.moreavailable,fromScroll?$scope.performanceFailureCollection=$scope.performanceFailureCollection.concat(res.data.result):$scope.performanceFailureCollection=res.data.result?res.data.result:[],$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.components=_.uniq($scope.components.concat(res.data.components?res.data.components:[])),handleGroupedTasks()),$scope.performanceDetails.failure.loading=!1},function(error){if($scope.performanceDetails.failure.loading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}function updateNLPLines(){setTimeout(function(){var analyzeLeftLineHeight=$(".analyzeTab .eachModel.mlm").height()+22+($(".analyzeTab .eachModel.fmm").height()+22)+32;$("head").append("<style>.analyzeTab .intentTitle:before{height:"+analyzeLeftLineHeight+"px !important;}</style>")},500)}function handleGroupedTasks(){setTimeout(function(){$(".eachTableRow").click(function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(this).hasClass("active")?($(this).toggleClass("active"),$(this).siblings(".serviceJsonBody").slideToggle("slow","linear")):($(".eachTableRow.active").siblings(".serviceJsonBody").slideToggle("slow","linear"),$(".eachTableRow.active").toggleClass("active"),$(this).toggleClass("active"),$(this).siblings(".serviceJsonBody").slideToggle("slow","linear"))})},2e3)}function getISOdates(days){var dateObj={};return-1===days?($scope.filterComponent.startDate.toISOString?dateObj.from=$scope.filterComponent.startDate.toISOString():dateObj.from=$scope.filterComponent.startDate,$scope.filterComponent.endDate.toISOString?dateObj.to=$scope.filterComponent.endDate.toISOString():dateObj.to=$scope.filterComponent.endDate):(dateObj.from=moment().subtract(days,"d").toISOString(),
dateObj.to=moment().toISOString()),dateObj}function sensitiveInfoHandling(){_.filter($scope.appControls.associatedAccounts,function(data){data.accountId===$scope.stream.accountId&&($scope.hideSensitiveInfo=data.enableDebugInfo)})}$scope.assetsBase=env_conf["assets-url"],$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.checkTickIcon=$scope.assetsBase+"headerIcons/checkTickIcon.svg",$scope.checkTickIconDisabled=$scope.assetsBase+"headerIcons/checkTickIconDisabled.svg",$scope.caretDown=env_conf["context-url"]+"/assets/icons/caretDown.svg",$scope.user_icon=env_conf["context-url"]+"/assets/icons/user_icon.png",$scope.list_icon=env_conf["context-url"]+"/assets/icons/list_icon.png",$scope.chat_message=env_conf["context-url"]+"/assets/icons/chat_bubble.png",$scope.stream=$workflowService.selectedStream(),$scope.utteranceStr="",$scope.originalInputAfterTranslation="",$scope.nluLanguage="",$scope.botLanguage="",$scope.languageCodes={en:"English",de:"German",es:"Spanish",fr:"French",pt:"Portugese",it:"Italian",zh_cn:"Chinese Simiplified",zh_tw:"Chinese Traditional",id:"Indonesian",ko:"Korean",nl:"Dutch",ja:"Japanese",ar:"Arabic",fi:"Finnish",ru:"Russian",pl:"Polish",uk:"Ukrainian",sv:"Swedish",kk:"Kazakh",ca:"Catalan"},$scope.channelType="",$scope.intent="",$scope.entity="",$scope.showNlpEditPanel=!1,$scope.showUserProfile=!1,$scope.nlpData={},$scope.serviceJsonData={},$scope.jsonDataLoading=!1,$scope.currScreen=0,$scope.originalIntent=null,$scope.tasksValue={},$scope.success=i18n.i18nString("success"),$scope.failure=i18n.i18nString("failure"),$scope.appControls=$applicationService.userInfo().appControls,$scope.performanceDetails={all:{moreavailable:!0,loading:!1,fetchingMore:!1,sortBy:"desc"},success:{moreavailable:!0,loading:!1,fetchingMore:!1,sortBy:"desc"},failure:{moreavailable:!0,loading:!1,fetchingMore:!1,sortBy:"desc"}},channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channelsConfig=channelsConfig,$scope.performanceCollection=[],$scope.performanceSuccessCollection=[],$scope.performanceFailureCollection=[],$scope.tasks=[],$scope.components=[],$scope.users=[],$scope.options={mode:"code",ace:window.ace,theme:"ace/theme/clouds_midnight"},"undefined"==typeof Array.prototype.find&&(Array.prototype.find=function(callback,thisArg){for(var i=0;i<this.length;i++)if(callback.call(thisArg||window,this[i],i,this))return this[i];return void 0}),$scope.getLanguage=function(code){return code?(code=code.toLowerCase(),$scope.languageCodes[code]&&""!==$scope.languageCodes[code]?$scope.languageCodes[code]:"---"):"---"},$scope.handleDropdownClose=function(e){-1!==e.currentTarget.className.indexOf("analyze-dropdown")&&-1!==e.target.parentElement.className.indexOf("filterIcon")&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation())},$scope.getComponentName=function(compId){if($scope.components.length>0){var entry=$scope.components.find(function(e){return e._id===compId});return entry&&entry._id?entry.name:"---"}return"---"},$scope.updateScroll=function(type,currScreen){$scope.currScreen=currScreen,$scope.closeChatHistoryJsonModal(),"chatHistory"===type&&$scope.trainBotCB.winningIntentMsgId?($scope.trainBotCB.scrollCompleted=!1,setTimeout(function(){setTimeout(function(){$scope.trainBotCB.scrollCompleted=!0},350);var container=$(".analyzeEditTask .tab-content .chatHistoryScroll"),scrollTo=$("#"+$scope.originalIntent.messageId),position=scrollTo.offset().top-container.offset().top+container.scrollTop();container.scrollTop(position)},250)):"chatHistory"!==type||$scope.trainBotCB.winningIntentMsgId?setTimeout(function(){$(".analyzeEditTask .tab-content").animate({scrollTop:2},"slow")},150):$scope.trainBotCB.scrollCompleted=!0,updateNLPLines(),"nlp"===type&&$scope.trainBotCB.reloadLines(),("nlp"===type||"details"===type)&&($scope.showUserProfile=!1)},$scope.closeChatHistoryJsonModal=function(){$(".jsonResponseContainer").hide()},$scope.getJsonData=function(task,event){$scope.jsonDataLoading=!0,$scope.serviceJsonData={},BTStreamsService.getAnalysisPerformanceRecordDetails($scope.stream._id,task.requestTransitionRecordId,task.responseTransitionRecordId).then(function(res){res.data&&res.data&&($scope.serviceJsonData=res.data,$("#jsonServiceInfo").html("{}"),setTimeout(function(){$(event.currentTarget.nextElementSibling).find("#jsonServiceInfo").html(JSON.stringify($scope.serviceJsonData,void 0,2))},500)),$scope.jsonDataLoading=!1},function(error){$scope.jsonDataLoading=!1,NotificationService.notify("Data is not available for this record.","error")})},$scope.scrollUpdate=function(){setTimeout(function(){$("#allContainer").scrollTop(2),$("#successContainer").scrollTop(2),$("#failureContainer").scrollTop(2)},300)},$scope.cb.reloadTask=function(task,type,originalIntent,intentName,recordTags,taskValue,showExcludeText){$scope.type=type,$scope.originalIntent=originalIntent,"performance"===type?($scope.performanceTask=task,loadPerformanceData(0,30,!1,showExcludeText),loadSuccessPerformanceData(0,30,!1,showExcludeText),loadFailurePerformanceData(0,30,!1,showExcludeText),$scope.scrollUpdate()):(init(task,intentName,recordTags),$scope.trainBotCB.loadData($scope.nlpData),$scope.trainBotCB.loadChatNLPData(task,$scope.nlpData,originalIntent,$scope.trainBotCB.winningIntentMsgId,taskValue)),sensitiveInfoHandling()},$scope.updatePage=function(type,order){"all"===type?($scope.performanceDetails.all.sortBy=order,loadPerformanceData(0,30,!1)):"failure"===type?($scope.performanceDetails.failure.sortBy=order,loadFailurePerformanceData(0,30,!1)):"success"===type&&($scope.performanceDetails.success.sortBy=order,loadSuccessPerformanceData(0,30,!1))};var allContainer=$("#allContainer");allContainer.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.performanceDetails.all.moreavailable&&loadPerformanceData($scope.performanceCollection.length,30,!0)});var successContainer=$("#successContainer");successContainer.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.performanceDetails.success.moreavailable&&loadSuccessPerformanceData($scope.performanceSuccessCollection.length,30,!0)});var failureContainer=$("#failureContainer");failureContainer.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.performanceDetails.failure.moreavailable&&loadFailurePerformanceData($scope.performanceFailureCollection.length,30,!0)}),$scope.closeModal=function(){$scope.trainBotCB.closeEditPanel(),$(".analyzeEditTask").modal("hide"),$scope.showUserProfile=!1,$scope.closeChatHistoryJsonModal(),$scope.currScreen=0,$(".userProfileMainComponent").length&&$(".userProfileMainComponent .img-icons").length&&$(".userProfileMainComponent .img-icons").removeClass("active")},$scope.getDate=function(timestamp){return moment(timestamp).format("MM-DD-YYYY")},$scope.getTime=function(timestamp){return moment(timestamp).format("h:mm A")},$scope.getEmail=function(userId){if($scope.users.length>0){var entry=$scope.users.find(function(e){return e._id===userId});return entry&&entry.emailId?entry.emailId:userId}return userId},$scope.trainBotCB={},$scope.trainBotCB.showTitle="false",$scope.trainBotCB.openEditPanel=function(type,expandIndex){$scope.showNlpEditPanel=!0,$scope.trainBotCB.loading=!0,$scope.nlpEditData=$scope.nlpData.type,$timeout(function(){$scope.trainBotCB.initEditPanel($scope.nlpData,type,expandIndex)},600)},$scope.trainBotCB.closeEditPanel=function(){$scope.showNlpEditPanel=!1,$(".model").removeClass("active")},$scope.UserProfileCB={},$scope.openUserProfile=function(type,$event){"utterance"===type&&$scope.trainBotCB.winningIntentMsgId&&($scope.showUserProfile=!1,$scope.trainBotCB.scrollCompleted=!1,setTimeout(function(){setTimeout(function(){$scope.trainBotCB.scrollCompleted=!0},350);var container=$(".analyzeEditTask .tab-content .chatHistoryScroll"),scrollTo=$("#"+$scope.originalIntent.messageId),position=scrollTo.offset().top-container.offset().top+container.scrollTop();container.scrollTop(position)},250)),$(".userProfileMainComponent .img-icons").hasClass("active")&&$(".userProfileMainComponent .img-icons").removeClass("active"),$(event.target).parent().addClass("active"),("profile"===type||"conversation"===type)&&($scope.showUserProfile=!0,$scope.UserProfileCB.loading=!0,$timeout(function(){$scope.userId=$scope.task.userId;var dateObj={};$scope.filterValues=angular.copy($scope.filterComponent),dateObj.from=$scope.filterValues.startDate,dateObj.to=$scope.filterValues.endDate,dateObj.days=$scope.filterValues.days;var timeStampValue=$scope.originalIntent.timestampValue;$scope.UserProfileCB.panelType=type,$scope.UserProfileCB.initPanel(type,dateObj,timeStampValue,$scope.userId)},0))},$scope.UserProfileCB.closeProfilePanel=function(){$scope.showUserProfile=!1,$(".model").removeClass("active"),$(".userProfileMainComponent").length&&$(".userProfileMainComponent .img-icons").length&&$(".userProfileMainComponent .img-icons").removeClass("active")},$scope.UserProfileCB.initPanel=function(){console.log("Intializing Panel")},$scope.isEmpty=function(obj){for(var prop in obj)if(obj.hasOwnProperty(prop))return!1;return!0},$scope.prepareCopyClipboard=function(type,e){e.preventDefault(),e.stopPropagation(),$scope.success=!0;var selection,range=document.createRange(),input=JSON.stringify($scope.task);"performance"===type&&(input=JSON.stringify($scope.serviceJsonData)),window.clipboardData?$scope.success=window.clipboardData.setData("Text",input):($scope.tmpElem=$("<div>"),$scope.tmpElem.css({position:"absolute",left:"-1000px",top:"-1000px"}),$scope.tmpElem.text(input),$("body").append($scope.tmpElem),range.selectNodeContents($scope.tmpElem.get(0)),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range))},$scope.copyDebugToClipboard=function(type,e){function copyToClipboardFF(text){window.prompt("Copy to clipboard: Ctrl C, Enter",text)}if(e.preventDefault(),e.stopPropagation(),!window.clipboardData)try{$scope.success=document.execCommand("copy",!1,null)}catch(e){var input=JSON.stringify($scope.task);"performance"===type&&(input=JSON.stringify($scope.serviceJsonData)),copyToClipboardFF(input)}finally{$scope.tmpElem.remove()}$scope.success&&NotificationService.notify(i18n.i18nString("json_copied_success"),"success")},$scope.getStatusCode=function(code){return 200===code?"200(OK)":202===code?"202(Accepted)":405===code?"405(Method Not Allowed)":404===code?"404(Not Found)":code},$scope.updateUserName=function(type){"koreID"===type?$scope.cb.toShowKoreID=!0:$scope.cb.toShowKoreID=!1}}],link:function($scope,$ele,$attrs){}}}]),_module.filter("channelNameDisp",function(){return function(input){return"googleactions"===input?"Google Assistant":"hangoutchat"===input?"Hangouts Chat":input}})}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btAnalyzeFilter",[function(){return{restrict:"EA",scope:{stream:"=?",allTasksData:"=",filterComponent:"=",components:"=",currentTab:"=",cb:"=",selectedTagsArray:"=",moreFilterValues:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-analyze-filter/bt-analyze-filter.html",controller:["$scope","$workflowService","$location","$filter","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","NotificationService","uuid4","$translator","form_util","$modal","$q","AppsDataService","$applicationService","i18n",function($scope,$workflowService,$location,$filter,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,NotificationService,uuid4,$translator,form_util,$modal,$q,AppsDataService,$applicationService,i18n){function init(){$scope.sumocb={languagescb:{changeText:!0},userscb:{changeText:!0},channelscb:{changeText:!0},taskscb:{changeText:!0},componentscb:{changeText:!0},sessionscb:{changeText:!0}},$scope.channels=[],$scope.supportedLanguages=[],$scope.tasks=[],$scope.scriptComponents=[],$scope.getDefaultFilter(1),$scope.stream&&$scope.stream.channels&&$scope.stream.channels.forEach(function(value,key){value.type.startsWith("ivr")&&"ivrVoice"!==value.type?$scope.channels.push({value:value.displayName+"(Webhook)",type:value.type}):"audiocodes"===(value.name?value.name:value.type)?$scope.channels.push({value:"IVR - AudioCodes",type:value.type}):$scope.channels.push({value:value.name?value.name:value.type,type:value.type})}),$scope.cb.channelNames=$scope.channels,$scope.stream.supportedLanguages.forEach(function(value,key){$scope.supportedLanguages.push({value:getLanguageName(value),type:value})}),$scope.prepareTaskData(),$scope.components&&$scope.components.forEach(function(value,key){$scope.scriptComponents.push({value:value.name,id:value._id})}),$scope.cb.editFilter()}function getLanguageName(type){var name="";if($scope.seedSupportedLanguages&&$scope.seedSupportedLanguages.length)for(var i=0;i<$scope.seedSupportedLanguages.length;i++)if($scope.seedSupportedLanguages[i].value===type){name=$scope.seedSupportedLanguages[i].name;break}return name}function checkCustomTagValue(){var valueCheck=!1;return $scope.selectedTagsArray.forEach(function(value,key){""!==value.name&&0===value.values.length&&(valueCheck=!0)}),valueCheck}function makeAPICall(){$scope.selectedUsers.length&&($scope.selectedUsersIds=[],$scope.kore.searchUserName="",$scope.kore.searchUserId="",$scope.users=[],$scope.selectedUsersCopy=angular.copy($scope.selectedUsers),$scope.selectedUsers.forEach(function(data){$scope.selectedUsersIds.push(data.id)}));var filterComponent={users:$scope.selectedUsersIds||[],components:$scope.selectedComponents,startDate:$scope.startDate,endDate:$scope.endDate,languages:$scope.selectedLanguages,channels:$scope.selectedChannels,tasks:$scope.selectedTasks,utteranceType:$scope.utterance.type,isAmbiguous:$scope.ambiguous.type,customTags:$scope.customTags,days:$scope.days,isDeveloper:$scope.isDeveloper,tags:prepareTagsPayload($scope.filterComponent),tagsObj:$scope.filterComponent.tagsObj,sessions:$scope.selectedSession};$scope.selectedComponents&&$scope.scriptComponents&&$scope.selectedComponents.length&&$scope.scriptComponents.length&&$scope.scriptComponents.length===$scope.selectedComponents.length&&(filterComponent.components=[]),$scope.selectedLanguages&&$scope.supportedLanguages&&$scope.selectedLanguages.length&&$scope.supportedLanguages.length&&$scope.supportedLanguages.length===$scope.selectedLanguages.length&&(filterComponent.languages=[]),$scope.selectedChannels&&$scope.channels&&$scope.selectedChannels.length&&$scope.channels.length&&$scope.channels.length===$scope.selectedChannels.length&&(filterComponent.channels=[]),$scope.selectedTasks&&$scope.tasks&&$scope.tasks.length&&$scope.selectedTasks.length&&$scope.tasks.length===$scope.selectedTasks.length&&(filterComponent.tasks=[]),$scope.filterComponent.tags.and.forEach(function(value,key){return""===value.name?(filterComponent.tags={and:[]},filterComponent):void 0}),$scope.showExcludeText?$scope.cb.showExcludeText=!0:$scope.cb.showExcludeText=!1,$scope.excludeCustomTagValue?$scope.cb.excludeCustomTagValue=!0:$scope.cb.excludeCustomTagValue=!1,"Kore ID"===$scope.cb.toggleCheck?($scope.selectedUsersIds=[],$scope.selectedUsers.forEach(function(data){data.id&&!data.value?$scope.selectedUsersIds.push(data.id):data.value&&$scope.selectedUsersIds.push(data.value)}),$scope.selectedDefaultFilterObject.users=$scope.selectedUsersIds):$scope.selectedDefaultFilterObject.users=$scope.selectedUsers,$scope.selectedDefaultFilterObject.days=$scope.days;var dateObj=getISOdates($scope.days);$scope.selectedDefaultFilterObject.from=dateObj.from,$scope.selectedDefaultFilterObject.to=dateObj.to,$scope.selectedDefaultFilterObject.language=$scope.selectedLanguages,$scope.selectedDefaultFilterObject.channels=$scope.selectedChannels,$scope.selectedDefaultFilterObject.ambiguous=$scope.ambiguous.type,$scope.selectedDefaultFilterObject.isDeveloper=$scope.isDeveloper,$scope.selectedDefaultFilterObject.utterenceType=$scope.utterance.type,$scope.selectedDefaultFilterObject.sessionType=$scope.sessionType.value||"all",$scope.selectedDefaultFilterObject.sessionStatus=$scope.sessionStatus.value||"all",prepareTagsPayload($scope.filterComponent).and&&prepareTagsPayload($scope.filterComponent).and.length&&prepareTagsPayload($scope.filterComponent).and[0]&&prepareTagsPayload($scope.filterComponent).and[0].values&&prepareTagsPayload($scope.filterComponent).and[0].values.length&&($scope.selectedDefaultFilterObject.tags={},$scope.selectedDefaultFilterObject.tags=prepareTagsPayload($scope.filterComponent).and),$scope.cb.saveAsDefaultFilterValue=!1,filterComponent.selectedValuesUserids=$scope.selectedUsers,filterComponent.sessionType=$scope.sessionType.value||"all",filterComponent.sessionStatus=$scope.sessionStatus.value||"all",$scope.cb.selectedValuesUserids=$scope.selectedUsers,$scope.taskValues=[],_.forEach($scope.tasks,function(task){var selectValue=!1;_.forEach($scope.selectedTasks,function(selectedTask){task.id===selectedTask&&(selectValue=!0)}),selectValue&&$scope.taskValues.push(task.value)}),filterComponent.taskValues=$scope.taskValues,"failedTask"===$scope.currentTab&&(filterComponent.components=[]),$scope.cb.applyFilter(filterComponent,!0,{}),$scope.closeModal()}function prepareTagsPayload(filterComponent){return filterComponent.tags={and:[]},$scope.selectedTagsArray.forEach(function(value,key){filterComponent.tags.and.push({name:value.name,values:value.values,type:value.type})}),filterComponent.tags}function getISOdates(days){var dateObj={};return-1===days?(dateObj.from=moment(new Date($scope.startDate)).toISOString(),dateObj.to=moment(new Date($scope.endDate)).toISOString()):(dateObj.from=moment().subtract(days,"d").toISOString(),dateObj.to=moment().toISOString()),dateObj}$scope.assetsBase=env_conf["assets-url"],$scope.stream=$workflowService.selectedStream(),$scope.seedSupportedLanguages=$workflowService.seedData().supportedLanguages,$scope.utterance={},$scope.utterance.type="both",$scope.ambiguous={},$scope.ambiguous.type="showAll";$applicationService.userInfo().koreUserInfo;$scope.selectedLanguages=[],$scope.selectedSession=[],$scope.selectedUsers=[],$scope.selectedChannels=[],$scope.selectedTasks=[],$scope.selectedComponents=[],$scope.customTags="",$scope.startDate="",$scope.endDate="",$scope.days=7;var daterangepickerInput;$scope.users=[],$scope.channels=[],$scope.supportedLanguages=[],$scope.tasks=[],$scope.scriptComponents=[],$scope.isDeveloper=!0,$scope.checkTickIcon=$scope.assetsBase+"headerIcons/checkTickIcon.svg",$scope.caretDown=$scope.assetsBase+"headerIcons/caretDown.svg",$scope.trashIcon=$scope.assetsBase+"icons/trashIcon.svg",$scope.minusIcon=$scope.assetsBase+"icons/minus-icon.svg",$scope.disabledMinusIcon=$scope.assetsBase+"images/left-menu-img/disabledMinus.svg",$scope.andIcon=$scope.assetsBase+"icons/andIcon.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.selectedTag="",$scope.customTagsArray=[],$scope.selectedUsersCopy=[],$scope.selectedDefaultFilterObject={},$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:i18n.i18nString("contain"),isInclude:!0}}),$scope.search={},$scope.search.nameSearchQuery="",$scope.togglePattern=!1,$scope.cb.toggleCheck="Channel ID",$scope.cb.channelNames=[],$scope.sessionTypeList=[{name:i18n.i18nString("all"),value:"all"},{name:i18n.i18nString("interactive"),value:"interactive"},{name:i18n.i18nString("non_interactive_label"),value:"noninteractive"}],$scope.sessionType={name:i18n.i18nString("all"),value:"all"},$scope.sessionStatusList=[{name:i18n.i18nString("active_label"),value:"active"},{name:i18n.i18nString("closed"),value:"closed"}],$scope.sessionStatus={name:i18n.i18nString("closed"),value:"closed"},$scope.dateDisplayName=i18n.i18nString("24_hours");var continueWithUserId,cancelWithUserId;$scope.includeExcludeArray=[{id:"include",label:i18n.i18nString("include")},{id:"exclude",label:i18n.i18nString("exclude")}],$scope.includeExcludeValue={id:"include",label:i18n.i18nString("include")},$scope.selectedContainArray=[{id:"contain",label:i18n.i18nString("contain"),isInclude:!0},{id:"doesNotContain",label:i18n.i18nString("does_not_contain"),isInclude:!1}],$scope.showExcludeText=!1,$scope.excludeCustomTagValue=!1,$scope.tooltipForKoreIds=i18n.i18nString("search_kore_platform"),$scope.select=i18n.i18nString("select"),$scope.kore={searchUserId:"",searchUserName:""},$scope.toShowText=!1,$scope.resetUserId=function(){$scope.includeExcludeValue={id:"include",label:i18n.i18nString("include")},$scope.showExcludeText=!1,$scope.selectedUsers=[],$("#showSwitchToggle").modal("hide")},continueWithUserId=function(){$scope.continueWithUserId()},cancelWithUserId=function(){$scope.cancelWithUserId()},$scope.yesContinueWithUserId=function(){$("#showSwitchToggle").modal("hide")},$scope.continueWithUserId=function(){$scope.selectedUsers&&$scope.selectedUsers.length&&$scope.togglePattern?($scope.selectedUsers=[],$scope.cb.toggleCheck="Kore ID"):$scope.selectedUsers&&$scope.selectedUsers.length&&!$scope.togglePattern&&($scope.selectedUsers=[],$scope.cb.toggleCheck="Channel ID"),$("#showSwitchToggle").modal("hide")},$scope.cancelWithUserId=function(){$scope.togglePattern?($scope.togglePattern=!1,$scope.cb.toggleCheck="Channel ID"):$scope.togglePattern||($scope.togglePattern=!0,$scope.cb.toggleCheck="Kore ID"),$("#showSwitchToggle").modal("hide")},$scope.filterToggle=function(){$scope.filterComponent.contacts=[],$scope.filterComponent.specficChannelUId=[],$scope.selectedUsersIds=[],$scope.selectedUsers&&$scope.selectedUsers.length&&$scope.togglePattern?($scope.cb.toggleCheck="Kore ID",NotificationService.alert("Changing the toggle to Kore User Id will clear the current user selection",[continueWithUserId,cancelWithUserId],{okText:i18n.i18nString("ok")})):$scope.selectedUsers&&$scope.selectedUsers.length&&!$scope.togglePattern?($scope.cb.toggleCheck="Channel ID",NotificationService.alert("Changing the toggle to Channel User Id will clear the current user selection",[continueWithUserId,cancelWithUserId],{okText:i18n.i18nString("ok")})):$scope.togglePattern?$scope.cb.toggleCheck="Kore ID":$scope.cb.toggleCheck="Channel ID"},$scope.excludeUserIds=function(includeExlude){$scope.selectedUsers&&$scope.selectedUsers.length&&$("#showSwitchToggle").modal("show"),$scope.includeExcludeValue=includeExlude,$scope.includeExcludeValue&&"exclude"==$scope.includeExcludeValue.id?$scope.showExcludeText=!0:$scope.showExcludeText=!1},$scope.excludeCustomTags=function(selectedContain,selectedTag){selectedTag.isContains=selectedContain,selectedTag&&selectedTag.isContains&&"doesNotContain"==selectedTag.isContains.id?$scope.excludeCustomTagValue=!0:$scope.excludeCustomTagValue=!1},$scope.saveAsDefaultFilter=function(){var payload={},dateObj=getISOdates($scope.days);"notTrained"===$scope.utterance.type&&($scope.utterance.type="notTrained"),payload={from:dateObj.from,to:dateObj.to,taskNames:$scope.selectedTasks,channels:$scope.selectedChannels,tags:prepareTagsPayload($scope.filterComponent),language:$scope.selectedLanguages,utterenceType:$scope.utterance.type,isDeveloper:$scope.isDeveloper,ambiguous:$scope.ambiguous.type,filterAt:"NLPMetrics"},$scope.sessionType&&$scope.sessionType.value&&"all"===$scope.sessionType.value?payload.sessionCategory=[0,1]:$scope.sessionType&&$scope.sessionType.value&&"interactive"===$scope.sessionType.value?payload.sessionCategory=[1]:$scope.sessionType&&$scope.sessionType.value&&"noninteractive"===$scope.sessionType.value&&(payload.sessionCategory=[0]),$scope.sessionStatus&&$scope.sessionStatus.value&&(payload.sessionStatus=$scope.sessionStatus.value),payload.channelUIds||(payload.channelUIds=[]),payload.koreUIds||(payload.koreUIds=[]),payload.excludeChannelUIds||(payload.excludeChannelUIds=[]),payload.excludeUserIds||(payload.excludeUserIds=[]),$scope.filterComponent.users=[],$scope.selectedUsers&&$scope.selectedUsers.length&&$scope.selectedUsers.length>0&&!$scope.showExcludeText?"Channel ID"===$scope.cb.toggleCheck?(_.forEach($scope.selectedUsers,function(selectedUser){$scope.filterComponent.users.push(selectedUser)}),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.id&&payload.channelUIds.push(selectedUser.id)})):(_.forEach($scope.selectedUsers,function(selectedUser){$scope.filterComponent.users.push(selectedUser)}),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.id&&payload.koreUIds.push(selectedUser.id)})):$scope.selectedUsers&&$scope.selectedUsers.length&&$scope.selectedUsers.length>0&&$scope.showExcludeText&&("Channel ID"===$scope.cb.toggleCheck?(_.forEach($scope.selectedUsers,function(selectedUser){$scope.filterComponent.users.push(selectedUser)}),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.id&&payload.excludeChannelUIds.push(selectedUser.id)})):(_.forEach($scope.selectedUsers,function(selectedUser){$scope.filterComponent.users.push(selectedUser)}),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.id&&payload.excludeUserIds.push(selectedUser.id)}))),$scope.selectedPayloadTags=prepareTagsPayload($scope.filterComponent),$scope.selectedPayloadTags.and&&$scope.selectedPayloadTags.and.length>0&&$scope.selectedPayloadTags.and.forEach(function(payloadTag){if($scope.selectedTagsArray.forEach(function(value,key){value.name==payloadTag.name&&(payloadTag.isInclude=value.isContains.isInclude)}),!payloadTag.name.length){var index=$scope.selectedPayloadTags.and.indexOf(payloadTag);$scope.selectedPayloadTags.and.splice(index,1)}}),payload.tags=$scope.selectedPayloadTags.and,$scope.showExcludeText?$scope.cb.showExcludeText=!0:$scope.cb.showExcludeText=!1,$scope.selectedComponents.length&&"performance"===$scope.currentTab&&$scope.scriptComponents.length!==$scope.selectedComponents.length?payload.componentId=$scope.selectedComponents:$scope.scriptComponents.length===$scope.selectedComponents.length&&(payload.componentId=[]),$scope.supportedLanguages.length===$scope.selectedLanguages.length&&(payload.language=[]),$scope.channels.length===$scope.selectedChannels.length&&(payload.channels=[]),$scope.tasks.length===$scope.selectedTasks.length&&(payload.taskNames=[]),$scope.filterComponent.tags.and.forEach(function(value,key){return""===value.name?(payload.tags={and:[]},payload):void 0}),Object.keys($scope.selectedDefaultFilterObject).length&&$scope.selectedDefaultFilterObject.filterAt?BTStreamsService.analyzeEditDefaultFilter($scope.stream._id,payload).then(function(response){$scope.cb.saveAsDefaultFilterValue=!0,console.log(response),$scope.selectedDefaultFilterObject=response.data,$scope.selectedDefaultFilterObject.days=$scope.days,$scope.selectedDefaultFilterObject.users=[],$scope.selectedDefaultFilterObject.users=$scope.filterComponent.users,$scope.filterComponent.selectedValuesUserids=$scope.selectedUsers,$scope.cb.selectedValuesUserids=$scope.filterComponent.selectedValuesUserids,$scope.taskValues=[],_.forEach($scope.tasks,function(task){var selectValue=!1;_.forEach($scope.selectedTasks,function(selectedTask){task.id===selectedTask&&(selectValue=!0)}),selectValue&&$scope.taskValues.push(task.value)}),$scope.filterComponent.taskValues=$scope.taskValues,NotificationService.notify("Saved as Default Filter","success"),setTimeout(function(){$scope.cb.applyFilter($scope.filterComponent,"",$scope.selectedDefaultFilterObject,!1,!0),$(".analyzeFilter").modal("hide")},200)},function(error){console.log(error),$(".analyzeFilter").modal("hide")}):BTStreamsService.analyzeDefaultFilter($scope.stream._id,payload).then(function(response){$scope.cb.saveAsDefaultFilterValue=!0,console.log(response),$scope.showSelectedDefaultObject=!0,$scope.selectedDefaultFilterObject=response.data,$scope.selectedDefaultFilterObject.days=$scope.days,$scope.selectedDefaultFilterObject.users=[],$scope.selectedDefaultFilterObject.users=$scope.filterComponent.users,$scope.filterComponent.selectedValuesUserids=$scope.selectedUsers,$scope.cb.selectedValuesUserids=$scope.filterComponent.selectedValuesUserids,$scope.taskValues=[],_.forEach($scope.tasks,function(task){var selectValue=!1;_.forEach($scope.selectedTasks,function(selectedTask){task.id===selectedTask&&(selectValue=!0)}),selectValue&&$scope.taskValues.push(task.value)}),$scope.filterComponent.taskValues=$scope.taskValues,NotificationService.notify("Saved as Default Filter","success"),setTimeout(function(){$scope.cb.applyFilter($scope.filterComponent,"",$scope.selectedDefaultFilterObject,!1,!0),$(".analyzeFilter").modal("hide")},200)},function(error){console.log(error),$(".analyzeFilter").modal("hide")}),$scope.moreFilterModal=!1},$scope.prepareTaskData=function(){$scope.tasks=[],$scope.allTasksData=[].concat($workflowService.alertTasks(),$workflowService.actionTasks(),$workflowService.dialogTasks(),$workflowService.informationTasks(),$workflowService.knowledgeTasks()),$scope.allTasksData&&$scope.allTasksData.forEach(function(value,key){value.child?value.child.forEach(function(childVal,childKey){$scope.tasks.push({value:childVal.name,id:childVal._id,redId:childVal.refId})}):$scope.tasks.push({value:value.name,id:value._id,redId:value.refId})})},$scope.cb.reConstuctTasks=function(allTasksData){$scope.tasks=[],$scope.prepareTaskData(),$scope.components&&$scope.components.forEach(function(value,key){$scope.scriptComponents.push({value:value.name,id:value._id})})},$scope.updateScrollfunction=function(){setTimeout(function(){PerfectScrollbar.update($("#scrollUpdateItems")[0])},750)},$scope.resetDatePicker=function(){$('div[name="daterange"]').data("daterangepicker").maxDate=moment(),$('div[name="daterange"]').data("daterangepicker").setStartDate(moment($scope.startDate)),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment($scope.endDate)),$('div[name="daterange"]').data("daterangepicker").updateView()},$scope.getDefaultFilter=function(days){$scope.days=days,1===days?$scope.dateDisplayName=i18n.i18nString("24_hours"):7===days&&($scope.dateDisplayName=i18n.i18nString("last_seven_days")),-1!==days&&($scope.appliedSelectedDays=days),-1!==days&&($scope.endDate=moment().toISOString(),$scope.startDate=moment().subtract(days,"d").toISOString()),-1==days&&$scope.resetDatePicker()},$timeout(function(){$(".sessionType_help").popover({html:!0,content:"<p>"+i18n.i18nString("help_interactive")+"</p><p>"+i18n.i18nString("help_non_interactive")+"</p><p>"+i18n.i18nString("help_developer")+'</p><p><a class="knowmore" target="_blank" href="https://github.com/Koredotcom/chatbot-test-runner">'+i18n.i18nString("knowMore")+"</a></p>",trigger:"hover",delay:{hide:1e3,show:100}})}),$timeout(function(){function getCustomMetaTags(){var dateObject=getISOdates($scope.appliedSelectedDays);BTStreamsService.metaTags($scope.stream._id,dateObject.from,dateObject.to).then(function(response){$scope.customTagsArray=response.data.tags},function(error){})}daterangepickerInput=$('div[name="daterange"]').daterangepicker({locale:{applyLabel:i18n.i18nString("apply"),cancelLabel:i18n.i18nString("close")},startDate:moment(new Date($scope.startDate)).startOf("hour").format("MM-DD-YYYY")||moment(),endDate:moment(new Date($scope.endDate)).startOf("hour").add(32,"hour").format("MM-DD-YYYY")||moment(),maxDate:moment(),opens:"right",drops:"up",timePicker:!0,customClass:"nlp-datepicker"}),$(".daterangepicker").addClass("nlp-datepicker"),$('div[name="daterange"]').on("apply.daterangepicker",function(ev,picker){$scope.appliedSelectedDays=-1,ev&&($scope.startDate=picker.startDate._d,$scope.endDate=picker.endDate._d),moment().format()<moment($scope.endDate).format()&&($scope.endDate=moment().format()),getCustomMetaTags();$scope.dateDisplayName=moment($scope.startDate).format("MMM DD YYYY")+" - "+moment($scope.endDate).format("MMM DD YYYY")}),$('div[name="daterange"]').on("cancel.daterangepicker",function(){
7==$scope.appliedSelectedDays?($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):-1!==$scope.appliedSelectedDays&&($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),$scope.days=$scope.appliedSelectedDays}),$('div[name="daterange"]').on("outsideClick.daterangepicker",function(){7==$scope.appliedSelectedDays?($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):-1!==$scope.appliedSelectedDays&&($('div[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('div[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),$scope.days=$scope.appliedSelectedDays}),$('input[name="daterangepicker_start"]').on("click",function(evt){evt.stopPropagation()}),$('input[name="daterangepicker_end"]').on("click",function(evt){evt.stopPropagation()}),$(".daterangepicker_input").on("click",function(evt){evt.stopPropagation()}),$(".calendar-table").on("click",function(evt){setTimeout(function(){$(".daterangeCustomDropdown").addClass("open")},0)})},300),$scope.getDate=function(timestamp){var date=new Date(timestamp);return date=moment().format("MM-DD-YYYY")},$scope.getTime=function(timestamp){var dateStr=new Date(timestamp).toLocaleString().split(", ")[1];return dateStr.split(":")[0]+":"+dateStr.split(":")[1]+" "+dateStr.split(" ")[1]},$scope.resetFilter=function(moreFilters){$scope.selectedLanguages=[],$scope.selectedSession=[],$scope.selectedUsers=[],$scope.includeExcludeValue={id:"include",label:i18n.i18nString("include")},$scope.selectedUsersIds=[];var dateObj=getISOdates(1);$scope.selectedDefaultFilterObject={filterAt:"NLPMetrics",koreUIds:[],channelUIds:[],taskNames:[],utterenceType:"both",channels:[],language:[],excludeUserIds:[],excludeChannelUIds:[],ambiguous:"showAll",from:dateObj.from,to:dateObj.to,isDeveloper:!0,tags:[],users:[]},$scope.showExcludeText=!1,$scope.selectedChannels=[],$scope.selectedTasks=[],$scope.selectedComponents=[],$scope.utterance.type="both",$scope.ambiguous.type="showAll",$scope.customTags="",$scope.isDeveloper=!0,$scope.moreFilterValues=[],$scope.selectedTagsArray=[],$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:i18n.i18nString("contain"),isInclude:!0}}),$scope.invalidValue=!1,moreFilters||($scope.getDefaultFilter(1),$scope.endDate=moment().format("MM-DD-YYYY"),$scope.startDate=moment().subtract(1,"d").format("MM-DD-YYYY"),$scope.sessionStatus={name:"All",value:"all"},$scope.sessionType={name:"All",value:"all"})},$scope.applyFilter=function(){var flag;return $scope.selectedTagsArray&&$scope.selectedTagsArray.length&&$scope.selectedTagsArray[0]&&""!==$scope.selectedTagsArray[0].name&&checkCustomTagValue()?(NotificationService.notify(i18n.i18nString("check_custom_tag"),"warning"),!1):($scope.selectedTagsArray&&$scope.selectedTagsArray.length&&$scope.selectedTagsArray[0]&&""!==$scope.selectedTagsArray[0].name&&($scope.tempArray=$scope.selectedTagsArray.filter(function(value,key){return""===value.name||void 0===value.name?(flag=!0,!1):!0})),void(flag?($scope.selectedTagsArray=$scope.tempArray,makeAPICall()):makeAPICall()))},$scope.searchValues=function(term,value){$scope.returnValue=[];var filterValue=value.filter(function(el){return null!==el&&""!==el&&void 0!==el});return value&&filterValue.forEach(function(item,index){item&&item.toLowerCase().indexOf(term.toLowerCase())>=0&&$scope.returnValue.push(item)}),$scope.returnValue},$scope.filterCustomTags=function(customTag){var _item=_.find($scope.selectedTagsArray,{name:customTag.name});return _item?!1:!0},$scope.cb.loadFilter=function(res,filterSaveDefaultValue){res.users||(res.users=[]),filterSaveDefaultValue.days?$scope.getDefaultFilter(filterSaveDefaultValue.days):$scope.getDefaultFilter(res.days),$scope.selectedDefaultFilterObject=filterSaveDefaultValue,$scope.selectedDefaultFilterObject.excludeChannelUIds||($scope.selectedDefaultFilterObject.excludeChannelUIds=[]),$scope.selectedDefaultFilterObject.excludeUserIds||($scope.selectedDefaultFilterObject.excludeUserIds=[]),$scope.selectedDefaultFilterObject.channelUIds||($scope.selectedDefaultFilterObject.channelUIds=[]),$scope.selectedDefaultFilterObject.koreUIds||($scope.selectedDefaultFilterObject.koreUIds=[]),res.selectedValuesUserids?$scope.selectedUsersCopy=res.selectedValuesUserids:res&&res.users&&res.users.length&&($scope.selectedUsers=[],_.forEach(res.users,function(user){var _selected={};_selected.id=user.value,user.value&&user.value.length&&"undefined"!=typeof user.value&&user.value.split("/")&&user.value.split("/")[1]&&!user.value.split("/")[2]?_selected.value=user.value.split("/")[1]:user.value&&user.value.length&&"undefined"!=typeof user.value&&user.value.split("/")&&user.value.split("/")[1]&&user.value.split("/")[2]&&(_selected.value=user.value.split("/")[2]),$scope.selectedUsers.push(_selected)})),Object.keys($scope.selectedDefaultFilterObject)&&Object.keys($scope.selectedDefaultFilterObject).length&&(res.users.length||$scope.selectedDefaultFilterObject.excludeChannelUIds.length?(res.users.length||$scope.selectedDefaultFilterObject.excludeUserIds.length)&&(res.users.length||$scope.selectedDefaultFilterObject.channelUIds.length)?res.users.length||$scope.selectedDefaultFilterObject.koreUIds.length||($scope.selectedUsers=[],$scope.cb.toggleCheck="Channel ID"):($scope.selectedUsers=[],$scope.cb.toggleCheck="Channel ID"):($scope.cb.toggleCheck="Channel ID",$scope.selectedUsers=[]),"Channel ID"==$scope.cb.toggleCheck?$scope.togglePattern=!1:"Kore ID"==$scope.cb.toggleCheck&&($scope.togglePattern=!0),res.users&&res.users.length?$scope.filterComponent.exclude?($scope.includeExcludeValue={id:"exclude",label:i18n.i18nString("exclude")},$scope.showExcludeText=!0):($scope.showExcludeText=!1,$scope.includeExcludeValue={id:"include",label:i18n.i18nString("include")}):($scope.includeExcludeValue={id:"include",label:i18n.i18nString("include")},$scope.showExcludeText=!1)),$scope.selectedLanguages=res.languages,$scope.selectedSession=res.sessions,res&&res.users&&res.users.length?$scope.selectedUsersCopy.length&&($scope.selectedUsers=[],res.users.forEach(function(respData){$scope.selectedUsersCopy.forEach(function(user){respData===user.id?$scope.selectedUsers.push(user):respData.id===user.id&&$scope.selectedUsers.push(user)})})):($scope.selectedUsersIds=[],$scope.togglePattern=!1),$scope.selectedComponents=res.components,$scope.selectedChannels=res.channels,$scope.selectedTasks=res.tasks,$scope.utterance.type=res.utteranceType,$scope.ambiguous.type=res.isAmbiguous,$scope.customTags=res.customTags,$scope.endDate=res.endDate,$scope.startDate=res.startDate,$scope.days=res.days,$scope.isDeveloper=res.isDeveloper;var dateObject=getISOdates($scope.days);BTStreamsService.metaTags($scope.stream._id,dateObject.from,dateObject.to).then(function(response){$scope.customTagsArray=response.data.tags},function(error){}),_.forEach($scope.customTagsArray,function(customTag){customTag.isContains={id:"contain",label:i18n.i18nString("contain"),isInclude:!0}}),res.tags&&res.tags.and&&res.tags.and.length?($scope.selectedTagsArray=res.tags.and,_.forEach($scope.selectedTagsArray,function(selectedTag){selectedTag.isInclude===!1?selectedTag.isContains={id:"doesNotContain",label:i18n.i18nString("does_not_contain"),isInclude:!1}:selectedTag.isInclude===!0&&(selectedTag.isContains={id:"contain",label:i18n.i18nString("contain"),isInclude:!0})})):$scope.selectedTagsArray.length||$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:i18n.i18nString("contain"),isInclude:!0}}),$scope.appliedSelectedDays=angular.copy($scope.days),setTimeout(function(){$scope.selectedLanguages&&0===$scope.selectedLanguages.length&&$scope.sumocb&&$scope.sumocb.languagescb&&$scope.sumocb.languagescb.selectAllByDefault(),$scope.selectedChannels&&0===$scope.selectedChannels.length&&$scope.sumocb&&$scope.sumocb.channelscb&&$scope.sumocb.channelscb.selectAllByDefault(),$scope.selectedTasks&&0===$scope.selectedTasks.length&&$scope.sumocb&&$scope.sumocb.taskscb&&$scope.sumocb.taskscb.selectAllByDefault(),$scope.selectedComponents&&0===$scope.selectedComponents.length&&$scope.sumocb&&$scope.sumocb.componentscb&&$scope.sumocb.componentscb.selectAllByDefault(),$(".user-chanels-addin-drpdown").on("hide.bs.dropdown",function(e){$scope.selectedUsersIds=[],$scope.kore.searchUserName="",$scope.kore.searchUserId="",$scope.users=[],$scope.selectedUsersCopy=angular.copy($scope.selectedUsers),$scope.selectedUsers.forEach(function(data){$scope.selectedUsersIds.push(data.id)})}),PerfectScrollbar.initialize($(".items-list")[0],{wheelSpeed:2,wheelPropagation:!1}),$scope.prepareTaskData()},150)},$scope.cb.loadComponents=function(res){$scope.components=res,$scope.scriptComponents=[],$scope.components&&$scope.components.forEach(function(value,key){$scope.scriptComponents.push({value:value.name,id:value._id})}),$scope.scriptComponents=_.uniq($scope.scriptComponents,"id")},$scope.closeModal=function(){$(".analyzeFilter").modal("hide")},$scope.addCustomTags=function(index){$scope.selectedTagsArray.length===index+1&&$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:i18n.i18nString("contain"),isInclude:!0}})},$scope.removeCustomsTags=function(index){$scope.selectedTagsArray.splice(index,1),$($(".host .tags input")[index]).val("")},$scope.moreFilterModal=!1,$scope.moreFilterToggle=function(){$scope.selectedTagsArray.length||$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:i18n.i18nString("contain"),isInclude:!0}}),1===$scope.selectedLanguages.length&&($scope.selectedLanguages=[]),1===$scope.selectedChannels.length&&($scope.selectedChannels=[]),$scope.moreFilterModal=!$scope.moreFilterModal,$scope.cb.loadFilter($scope.filterComponent,$scope.selectedDefaultFilterObject)},$scope.selectSessionType=function(item){$scope.sessionType=item},$scope.selectSessionStatus=function(item){$scope.sessionStatus=item},$scope.closeFilterDropdown=function(){$(".advancedFilters").dropdown("toggle"),$scope.closeModal()},$scope.addAdvancedFilters=function(event){$scope.closeFilterDropdown(),$scope.applyFilter()},$scope.dynamicHeight=function(e,selectedTag){setTimeout(function(){var ele=e.target;ele.style.height="30px",$(ele).hasClass("ng-invalid")?(selectedTag.invalidValue=!0,$(".disabledClass").attr("disabled","disabled")):(selectedTag.invalidValue=!1,$(".disabledClass").removeAttr("disabled"))},150)},$scope.calculateHeight=function(e){var ele=e.target;ele.style.height="auto"},$scope.updatedropDown=function(tag,index){$scope.search.nameSearchQuery="",tag.selectedValues=[],tag.selectedValues=tag.values,$scope.selectedTagsArray[index]=tag,$scope.selectedTagsArray[index].values=[],$scope.selectedTagsArray[index].isContains={id:"contain",label:i18n.i18nString("contain"),isInclude:!0},$scope.addCustomTags(index)},$scope.searchClick=function(event){event.preventDefault(),event.stopPropagation()},$scope.addingUserAndChannelIds=function(e){e.stopPropagation()},$scope.saveUserAndChannelIds=function(e){$scope.selectedUsersIds=[],$scope.kore.searchUserId="",$scope.kore.searchUserName="",$scope.users=[],$scope.selectedUsersCopy=angular.copy($scope.selectedUsers),$scope.selectedUsers.forEach(function(data){$scope.selectedUsersIds.push(data.id)}),$(".user-chanels-addin-drpdown").removeClass("open")},$scope.closeUserAndChannelIds=function(e){$scope.selectedUsers=[],$scope.users=[],$scope.kore.searchUserId="",$scope.kore.searchUserName="",$(".user-chanels-addin-drpdown").removeClass("open")},$scope.addingUserAndChannelIdsToFilter=function(user){$scope.flag=!1,0===$scope.selectedUsers.length?$scope.selectedUsers.push(user):($scope.selectedUsers.forEach(function(value,key){value.id===user.id&&($scope.flag=!0)}),$scope.flag||$scope.selectedUsers.push(user)),$(".kr-sg-dropdowns.excludeIds .dropdown.dropdown-open.open").length&&$(".kr-sg-dropdowns.excludeIds .dropdown.dropdown-open").removeClass("open")},$scope.removeuserChannelFilterData=function(index,e){e.stopPropagation(),$scope.selectedUsers.splice(index,1),$scope.selectedUsersIds=angular.copy($scope.selectedUsers)},$scope.getKoreUserIds=function(e){if(0===$scope.kore.searchUserName.length&&($scope.toShowText=!1),$scope.users=[],13===e.keyCode&&$scope.kore.searchUserName.length>=3){var search=$scope.kore.searchUserName,dateObj=getISOdates($scope.days);BTStreamsService.getKoreUserIdsOnSearch($applicationService.userInfo().userId,$scope.stream._id,dateObj.from,dateObj.to,search).then(function(response){_.forEach(response.data.userIds,function(value){value.userId?$scope.users.push({value:value.emailId,id:value.userId}):$scope.users.push({value:value.emailId,id:value._id}),$scope.users.length<=0?$scope.toShowText=!0:$scope.toShowText=!1})},function(error){})}},$scope.getChannelUserIds=function(e){if(0===$scope.kore.searchUserId.length&&($scope.toShowText=!1),13===e.keyCode&&$scope.kore.searchUserId.length>=3){var search=$scope.kore.searchUserId,dateObj=getISOdates($scope.days);BTStreamsService.getChannelsUserdIdsOnSearch($applicationService.userInfo().userId,$scope.stream._id,dateObj.from,dateObj.to,search).then(function(response){$scope.users=[],_.forEach(response.data.channelUIds,function(value){$scope.users.push({value:value.id,id:value.channelUId})}),$scope.users.length&&($(".kr-sg-dropdowns.excludeIds .dropdown.dropdown-open.open").length||$(".kr-sg-dropdowns.excludeIds .dropdown.dropdown-open").addClass("open")),$scope.users.length<=0?$scope.toShowText=!0:$scope.toShowText=!1},function(error){})}},$scope.clearSearchField=function(user){$scope.kore.searchUserId="",$scope.kore.searchUserName="",$scope.user=user,$scope.user.id="",$scope.user.value="",$scope.toShowText=!1},init()}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btAnalyze",[function(){return{restrict:"EA",scope:{stream:"=",allTasks:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-analyze/bt-analyze.html",controller:["$scope","$workflowService","$location","_constants_","BTStreamsService","$timeout","$routeParams","env_conf","NotificationService","uuid4","$translator","form_util","$modal","$q","$element","AppsDataService","$applicationService","BTFlowtaskService","BTSeedDataService","$rootScope","localstore","i18n","channelsConfig",function($scope,$workflowService,$location,_constants_,BTStreamsService,$timeout,$routeParams,env_conf,NotificationService,uuid4,$translator,form_util,$modal,$q,$element,AppsDataService,$applicationService,BTFlowtaskService,BTSeedDataService,$rootScope,localstore,i18n,channelsConfig){function getCustomMetaTags(){var dateObject=getISOdates($scope.filterComponent.days);BTStreamsService.metaTags($scope.stream._id,dateObject.from,dateObject.to).then(function(response){$scope.filterComponent.tagsObj=response.data.tags},function(error){})}function init(){$scope.stream=$workflowService.selectedStream(),$scope.users=$scope.users||[],$scope.tasks=$scope.tasks||[],$scope.components=$scope.components||[],$scope.intentFoundCollection=[],$scope.intentNotFoundCollection=[],$scope.failedTaskCollection=[],$scope.performanceCollection=[],$scope.pinnedTasksCollection=[],$scope.debugLogsCollection=[],$scope.statements_label=i18n.i18nString("statements_label"),$scope.statement_label=i18n.i18nString("statement_label"),fetchIntentFoundCollection(0,20,!1),fetchIntentNotFoundCollection(0,20,!1),fetchFailedTaskCollection(0,20,!1),fetchPerformanceCollection(0,20,!1),fetchPinnedTaskCollection(0,20,!1),fetchDebugLogCollection(0,20,!1),setTimeout(function(){initiateScrolls()},2e3)}function initFirstTabData(){$scope.intentFoundCollection=[];var searchQuery=$workflowService.storeSearchQry();searchQuery&&"debugLog"===searchQuery.navigateTo&&($workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:""}),setTimeout(function(){$("#debugLogTabSelector").click()},200))}function fetchScriptServiceComponents(type){BTFlowtaskService.getComponentsByType($scope.stream._id,type).then(function(res){var _botComponents=[];res&&res.data&&res.data.length>0&&$.each(res.data,function(k,comp){"configured"===comp.status&&_botComponents.push(comp)}),$scope.scriptServiceComponents=$scope.scriptServiceComponents.concat(_botComponents)},function(error){if($scope.nodeObjListLoading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("fetch_error"),"error")})}function getDefaultFilter(days,str){$scope.defaultFilterMsg=i18n.i18nString("last_24_hours"),$scope.defaultTag={},$scope.defaultTag.value=i18n.i18nString("last_24_hours")}function getISOdates(days){var dateObj={};return-1===days?(dateObj.from=moment(new Date($scope.filterComponent.startDate)).toISOString(),dateObj.to=moment(new Date($scope.filterComponent.endDate)).toISOString()):(dateObj.from=moment().subtract(days,"d").toISOString(),dateObj.to=moment().toISOString()),dateObj}function analyzeDefaultFilter(type){BTStreamsService.analyzeGetDefaultFilter($scope.stream._id).then(function(res){if(console.log(res),$scope.filterSaveDefaultValue=res.data,Object.keys($scope.filterSaveDefaultValue).length){$scope.analyzeCB.saveAsDefaultFilterValue=!0,$scope.filterComponent.startDate=moment($scope.filterSaveDefaultValue.from).format("MM-DD-YYYY"),$scope.filterComponent.endDate=moment($scope.filterSaveDefaultValue.to).format("MM-DD-YYYY");var date1=new Date($scope.filterComponent.startDate),date2=new Date($scope.filterComponent.endDate),Difference_In_Time=date2.getTime()-date1.getTime(),Difference_In_Days=Difference_In_Time/864e5;Difference_In_Days>7||0===Difference_In_Days?$scope.filterSaveDefaultValue.days=-1:1===Difference_In_Days?$scope.filterSaveDefaultValue.days=1:$scope.filterSaveDefaultValue.days=7,$scope.filterSaveDefaultValue.users||($scope.filterSaveDefaultValue.users=[]),$scope.filterSaveDefaultValue.channelUIds&&$scope.filterSaveDefaultValue.channelUIds.length?($scope.analyzeCB.showExcludeText=!1,_.forEach($scope.filterSaveDefaultValue.channelUIds,function(user){$scope.filterSaveDefaultValue.users.push(user)})):$scope.filterSaveDefaultValue.excludeChannelUIds&&$scope.filterSaveDefaultValue.excludeChannelUIds.length?($scope.analyzeCB.showExcludeText=!0,_.forEach($scope.filterSaveDefaultValue.excludeChannelUIds,function(user){$scope.filterSaveDefaultValue.users.push(user)})):$scope.filterSaveDefaultValue.excludeUserIds&&$scope.filterSaveDefaultValue.excludeUserIds.length?($scope.analyzeCB.showExcludeText=!0,_.forEach($scope.filterSaveDefaultValue.excludeUserIds,function(user){$scope.filterSaveDefaultValue.users.push(user)})):$scope.filterSaveDefaultValue.koreUIds&&$scope.filterSaveDefaultValue.koreUIds.length&&($scope.analyzeCB.showExcludeText=!1,_.forEach($scope.filterSaveDefaultValue.koreUIds,function(user){$scope.filterSaveDefaultValue.users.push(user)}))}$scope.taskValues=[],_.forEach($scope.allTasks,function(task){_.forEach($scope.filterSaveDefaultValue.taskNames,function(selectedTask){task._id===selectedTask&&$scope.taskValues.push(task.label?task.label:task.name)})}),$scope.filterComponent.taskValues=$scope.taskValues,$scope.analyzeCB.loadFilter($scope.filterComponent,$scope.filterSaveDefaultValue),$scope.analyzeCB.applyFilter($scope.filterComponent,"",$scope.filterSaveDefaultValue,!0,!0),type||fetchIntentFoundCollection(0,20,!1),"intentFound"===type?($scope.intentFoundCollection=[],$scope.regroupDone.message=!1,$scope.regroupDone.progress=!1,fetchIntentFoundCollection(0,20,!1)):"intentNotFound"===type?($scope.intentNotFoundCollection=[],fetchIntentNotFoundCollection(0,20,!1)):"failedTask"===type?($scope.failedTaskCollection=[],fetchFailedTaskCollection(0,20,!1)):"performance"===type?($scope.performanceCollection=[],fetchPerformanceCollection(0,20,!1)):"pinned"===type?($scope.pinnedTasksCollection=[],fetchPinnedTaskCollection(0,20,!1)):"debugLog"===type&&($scope.debugLogsCollection=[],fetchDebugLogCollection(0,20,!1))},function(error){if($scope.dataAvailble.successIntent.fetching=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function catchDockErrorMsg(data){data&&data.response&&data.response.message?NotificationService.notify(data.response.message,"error"):NotificationService.notify(i18n.i18nString("error_handle"),"error")}function asyncPutRootIntentFlow(res){$scope.tasksValue=res.data,res.data.totalCount?$scope.dataAvailble.successIntent.total=res.data.totalCount:$scope.dataAvailble.successIntent.total=0,$scope.dataAvailble.successIntent.moreAvailable=res.data.moreavailable;var dataSet=res.data.result?res.data.result:[];$scope.intentFromScroll?$scope.intentFoundCollection=$scope.intentFromScroll?$scope.intentFoundCollection.concat(dataSet):dataSet:$scope.intentFoundCollection=dataSet,$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.dataAvailble.successIntent.fetching=!1,handleGroupedTasks(),$scope.analyzeCB.intentFoundCollection=$scope.intentFoundCollection}function asyncPutRootIntentNotFlow(res){res.data.totalCount?$scope.dataAvailble.failedintent.total=res.data.totalCount:$scope.dataAvailble.failedintent.total=0,$scope.dataAvailble.failedintent.moreAvailable=res.data.moreavailable;var dataset=res.data.result?res.data.result:[];$scope.intentNotFromScroll?$scope.intentNotFoundCollection=$scope.intentNotFromScroll?$scope.intentNotFoundCollection.concat(dataset):dataset:$scope.intentNotFoundCollection=dataset,$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.dataAvailble.failedintent.fetching=!1,handleGroupedTasks(),$scope.analyzeCB.intentNotFoundCollection=$scope.intentNotFoundCollection}function asyncPutRootFailIntentFlow(res){res.data.totalCount?$scope.dataAvailble.failed.total=res.data.totalCount:$scope.dataAvailble.failed.total=0,$scope.dataAvailble.failed.moreAvailable=res.data.moreavailable;var dataset=res.data.result?res.data.result:[];$scope.intentFailFromScroll?$scope.failedTaskCollection=$scope.intentFailFromScroll?$scope.failedTaskCollection.concat(dataset):dataset:$scope.failedTaskCollection=dataset,$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.dataAvailble.failed.fetching=!1,handleGroupedTasks(),$scope.analyzeCB.failedTaskCollection=$scope.failedTaskCollection}function asyncPutRootPerformanceFlow(res){res.data.totalCount?$scope.dataAvailble.performance.total=res.data.totalCount:$scope.dataAvailble.performance.total=0,$scope.dataAvailble.performance.moreAvailable=res.data.moreavailable;var dataset=res.data.result?res.data.result:[];$scope.intentPerformanceFromScroll?$scope.performanceCollection=$scope.intentPerformanceFromScroll?$scope.performanceCollection.concat(dataset):dataset:$scope.performanceCollection=dataset,$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.components=_.uniq($scope.components.concat(res.data.components?res.data.components:[])),$scope.analyzeCB.loadComponents($scope.scriptServiceComponents),$scope.dataAvailble.performance.fetching=!1,handleGroupedTasks(),$scope.analyzeCB.performanceCollection=$scope.performanceCollection}function asyncPutRootPinnnedFlow(res){res.data.totalCount?$scope.dataAvailble.pinned.total=res.data.totalCount:$scope.dataAvailble.pinned.total=0,$scope.dataAvailble.pinned.moreAvailable=res.data.moreavailable;var dataset=res.data.result?res.data.result:[];$scope.intentPinnedFromScroll?$scope.pinnedTasksCollection=$scope.intentPinnedFromScroll?$scope.pinnedTasksCollection.concat(dataset):dataset:$scope.pinnedTasksCollection=dataset,$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.dataAvailble.pinned.fetching=!1,handleGroupedTasks()}function fetchIntentFoundCollection(offset,limit,fromScroll){function getAnalyzeIntentRecordsData(){var deferred=$q.defer(),mode="async";return BTStreamsService.getAnalyzeRecords($scope.stream._id,offset,limit,payload,mode).then(function(res){deferred.resolve(res)},function(err){deferred.reject(err)}),deferred.promise}if(!$scope.dataAvailble.successIntent.fetching){$scope.intentFromScroll=fromScroll,$scope.dataAvailble.successIntent.fetching=!0;var payload={},dateObj=getISOdates($scope.filterComponent.days);payload.type="successintent",payload.filters={from:dateObj.from,to:dateObj.to},$scope.filterComponent.languages&&$scope.filterComponent.languages.length&&$scope.filterComponent.languages.length>0&&(payload.filters.language=$scope.filterComponent.languages),$scope.filterComponent.channels&&$scope.filterComponent.channels.length&&$scope.filterComponent.channels.length>0&&(payload.filters.channel=$scope.filterComponent.channels),"intentNotFound"!==$scope.currentTab&&$scope.filterComponent.tasks&&$scope.filterComponent.tasks.length&&$scope.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.filterComponent.tasks),$scope.filterComponent.sessions&&$scope.filterComponent.sessions.length>0&&(payload.filters.sessions=$scope.filterComponent.sessions),$scope.filterComponent.isDeveloper||(payload.filters.isDeveloper=$scope.filterComponent.isDeveloper),$scope.filterComponent.sessionStatus?payload.filters.sessionStatus=$scope.filterComponent.sessionStatus:payload.filters.sessionStatus="all","all"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[0,1]:"interactive"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[1]:"noninteractive"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[0]:payload.filters.sessionCategory=[0,1],"notTrained"===$scope.filterComponent.utteranceType?payload.filters.trained=!1:"trained"===$scope.filterComponent.utteranceType&&(payload.filters.trained=!0),$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&$scope.filterComponent.tags.and.length>0&&($scope.filterComponent.tags.and.forEach(function(payloadTag){if($scope.selectedTagsArray.forEach(function(value,key){value.name==payloadTag.name&&(payloadTag.isInclude=value.isContains.isInclude)}),payloadTag.isContains&&delete payloadTag.isContains,!payloadTag.name.length){var index=$scope.filterComponent.tags.and.indexOf(payloadTag);$scope.filterComponent.tags.and.splice(index,1)}}),payload.filters.tags=$scope.filterComponent.tags),$scope.filterToggle.successIntent.utterances?($scope.filterToggle.successIntent.intent=!1,payload.groupby="input"):$scope.filterToggle.successIntent.intent&&($scope.filterToggle.successIntent.utterances=!1,payload.groupby="taskId"),payload.sort={order:$scope.dataAvailble.successIntent.sortby,by:"timestamp"},Object.keys($scope.filterSaveDefaultValue).length&&($scope.filterSaveDefaultValue.days&&(dateObj=getISOdates($scope.filterSaveDefaultValue.days),payload.filters.from=dateObj.from,payload.filters.to=dateObj.to),$scope.filterSaveDefaultValue.tags&&$scope.filterSaveDefaultValue.tags.length&&$scope.filterSaveDefaultValue.tags[0]&&$scope.filterSaveDefaultValue.tags[0].values&&$scope.filterSaveDefaultValue.tags[0].values.length&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.tags={},payload.filters.tags.and=[],payload.filters.tags.and=$scope.filterSaveDefaultValue.tags),$scope.filterSaveDefaultValue.excludeChannelUIds&&$scope.filterSaveDefaultValue.excludeChannelUIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeChannelUIds=$scope.filterSaveDefaultValue.excludeChannelUIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.excludeUserIds&&$scope.filterSaveDefaultValue.excludeUserIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeUserIds=$scope.filterSaveDefaultValue.excludeUserIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Kore ID"):$scope.filterSaveDefaultValue.channelUIds&&$scope.filterSaveDefaultValue.channelUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.channelUIds=$scope.filterSaveDefaultValue.channelUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.koreUIds&&$scope.filterSaveDefaultValue.koreUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.userId=$scope.filterSaveDefaultValue.koreUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Kore ID"),$scope.filterSaveDefaultValue.language&&$scope.filterSaveDefaultValue.language.length&&$scope.filterSaveDefaultValue.language.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.language=$scope.filterSaveDefaultValue.language),"all"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[0,1]:"interactive"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[1]:"noninteractive"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[0]:$scope.filterComponent.sessionType||(payload.filters.sessionCategory=[0,1]),$scope.filterSaveDefaultValue.sessionStatus?payload.filters.sessionStatus=$scope.filterSaveDefaultValue.sessionStatus:$scope.filterComponent.sessionStatus||(payload.filters.sessionStatus="all"),$scope.filterSaveDefaultValue.channels&&$scope.filterSaveDefaultValue.channels.length&&$scope.filterSaveDefaultValue.channels.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.channel=$scope.filterSaveDefaultValue.channels),"intentNotFound"!==$scope.currentTab&&$scope.filterSaveDefaultValue.taskNames&&$scope.filterSaveDefaultValue.taskNames.length&&$scope.filterSaveDefaultValue.taskNames.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.taskId=$scope.filterSaveDefaultValue.taskNames),!$scope.filterSaveDefaultValue.isDeveloper&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.isDeveloper=$scope.filterSaveDefaultValue.isDeveloper),"notTrained"===$scope.filterSaveDefaultValue.utterenceType&&$scope.analyzeCB.saveAsDefaultFilterValue?payload.filters.trained=!1:"trained"===$scope.filterSaveDefaultValue.utterenceType&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.trained=!0)),$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&!$scope.analyzeCB.showExcludeText&&!$scope.analyzeCB.saveAsDefaultFilterValue?"Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.channelUIds||(payload.filters.channelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.channelUIds.push(selectedUser.value):payload.filters.channelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!1):(payload.filters.userId||(payload.filters.userId=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.userId.push(selectedUser.value):payload.filters.userId.push(selectedUser);
}),$scope.filterComponent.exclude=!1):$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&$scope.analyzeCB.showExcludeText&&("Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.excludeChannelUIds||(payload.filters.excludeChannelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeChannelUIds.push(selectedUser.value):payload.filters.excludeChannelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!0):(payload.filters.excludeUserIds||(payload.filters.excludeUserIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeUserIds.push(selectedUser.value):payload.filters.excludeUserIds.push(selectedUser)}),$scope.filterComponent.exclude=!0)),0===offset?payload.ignoreCount=!1:payload.ignoreCount=!0,reloadDockStatusIntent=!0,getAnalyzeIntentRecordsData().then(function(res){$scope.checkDockStatus()},function(error){if($scope.dataAvailble.successIntent.fetching=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}function fetchIntentNotFoundCollection(offset,limit,fromScroll){function getAnalyzeIntentNotRecordsData(){var deferred=$q.defer(),mode="async";return BTStreamsService.getAnalyzeRecords($scope.stream._id,offset,limit,payload,mode).then(function(res){deferred.resolve(res)},function(err){deferred.reject(err)}),deferred.promise}if(!$scope.dataAvailble.failedintent.fetching){$scope.intentNotFromScroll=fromScroll,$scope.dataAvailble.failedintent.fetching=!0;var payload={},dateObj=getISOdates($scope.filterComponent.days);payload.filters={from:dateObj.from,to:dateObj.to},payload.type="failintent",$scope.filterComponent.languages&&$scope.filterComponent.languages.length&&$scope.filterComponent.languages.length>0&&(payload.filters.language=$scope.filterComponent.languages),$scope.filterComponent.sessions&&$scope.filterComponent.sessions.length>0&&(payload.filters.sessions=$scope.filterComponent.sessions),$scope.filterComponent.channels&&$scope.filterComponent.channels.length&&$scope.filterComponent.channels.length>0&&(payload.filters.channel=$scope.filterComponent.channels),$scope.filterComponent.isDeveloper||(payload.filters.isDeveloper=$scope.filterComponent.isDeveloper),$scope.filterComponent.sessionStatus?payload.filters.sessionStatus=$scope.filterComponent.sessionStatus:payload.filters.sessionStatus="all","all"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[0,1]:"interactive"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[1]:"noninteractive"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[0]:payload.filters.sessionCategory=[0,1],"intentNotFound"===$scope.currentTab&&"hideAmbiguous"===$scope.filterComponent.isAmbiguous?payload.filters.isAmbiguous=!1:"intentNotFound"===$scope.currentTab&&"showAmbiguous"===$scope.filterComponent.isAmbiguous&&(payload.filters.isAmbiguous=!0),$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&$scope.filterComponent.tags.and.length>0&&($scope.filterComponent.tags.and.forEach(function(payloadTag){if($scope.selectedTagsArray.forEach(function(value,key){value.name==payloadTag.name&&(payloadTag.isInclude=value.isContains.isInclude)}),payloadTag.isContains&&delete payloadTag.isContains,!payloadTag.name.length){var index=$scope.filterComponent.tags.and.indexOf(payloadTag);$scope.filterComponent.and.splice(index,1)}}),payload.filters.tags=$scope.filterComponent.tags),payload.groupby=$scope.filterToggle.failedintent.utterances?"input":"",payload.sort={order:$scope.dataAvailble.failedintent.sortby,by:"timestamp"},Object.keys($scope.filterSaveDefaultValue).length&&($scope.filterSaveDefaultValue.days&&(dateObj=getISOdates($scope.filterSaveDefaultValue.days),payload.filters.from=dateObj.from,payload.filters.to=dateObj.to),$scope.filterSaveDefaultValue.tags&&$scope.filterSaveDefaultValue.tags.length&&$scope.filterSaveDefaultValue.tags[0]&&$scope.filterSaveDefaultValue.tags[0].values&&$scope.filterSaveDefaultValue.tags[0].values.length&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.tags={},payload.filters.tags.and=[],payload.filters.tags.and=$scope.filterSaveDefaultValue.tags),$scope.filterSaveDefaultValue.excludeChannelUIds&&$scope.filterSaveDefaultValue.excludeChannelUIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeChannelUIds=$scope.filterSaveDefaultValue.excludeChannelUIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.excludeUserIds&&$scope.filterSaveDefaultValue.excludeUserIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeUserIds=$scope.filterSaveDefaultValue.excludeUserIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Kore ID"):$scope.filterSaveDefaultValue.channelUIds&&$scope.filterSaveDefaultValue.channelUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.channelUIds=$scope.filterSaveDefaultValue.channelUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.koreUIds&&$scope.filterSaveDefaultValue.koreUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.userId=$scope.filterSaveDefaultValue.koreUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Kore ID"),$scope.filterSaveDefaultValue.language&&$scope.filterSaveDefaultValue.language.length&&$scope.filterSaveDefaultValue.language.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.language=$scope.filterSaveDefaultValue.language),"all"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[0,1]:"interactive"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[1]:"noninteractive"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[0]:$scope.filterComponent.sessionType||(payload.filters.sessionCategory=[0,1]),$scope.filterSaveDefaultValue.sessionStatus?payload.filters.sessionStatus=$scope.filterSaveDefaultValue.sessionStatus:$scope.filterComponent.sessionStatus||(payload.filters.sessionStatus="all"),$scope.filterSaveDefaultValue.channels&&$scope.filterSaveDefaultValue.channels.length&&$scope.filterSaveDefaultValue.channels.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.channel=$scope.filterSaveDefaultValue.channels),!$scope.filterSaveDefaultValue.isDeveloper&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.isDeveloper=$scope.filterSaveDefaultValue.isDeveloper)),$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&!$scope.analyzeCB.showExcludeText&&!$scope.analyzeCB.saveAsDefaultFilterValue?"Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.channelUIds||(payload.filters.channelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.channelUIds.push(selectedUser.value):payload.filters.channelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!1):(payload.filters.userId||(payload.filters.userId=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.userId.push(selectedUser.value):payload.filters.userId.push(selectedUser)}),$scope.filterComponent.exclude=!1):$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&$scope.analyzeCB.showExcludeText&&("Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.excludeChannelUIds||(payload.filters.excludeChannelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeChannelUIds.push(selectedUser.value):payload.filters.excludeChannelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!0):(payload.filters.excludeUserIds||(payload.filters.excludeUserIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeUserIds.push(selectedUser.value):payload.filters.excludeUserIds.push(selectedUser)}),$scope.filterComponent.exclude=!0)),0===offset?payload.ignoreCount=!1:payload.ignoreCount=!0,payload.groupby=$scope.filterToggle.failedintent.utterances?"input":"",payload.sort={order:$scope.dataAvailble.failedintent.sortby,by:"timestamp"},reloadDockStatusIntentNot=!0,getAnalyzeIntentNotRecordsData().then(function(res){$scope.checkDockStatus()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$scope.dataAvailble.failedintent.fetching=!1})}}function fetchFailedTaskCollection(offset,limit,fromScroll){function getAnalyzeFailIntentRecordsData(){var deferred=$q.defer(),mode="async";return BTStreamsService.getAnalyzeRecords($scope.stream._id,offset,limit,payload,mode).then(function(res){deferred.resolve(res)},function(err){deferred.reject(err)}),deferred.promise}if(!$scope.dataAvailble.failed.fetching){$scope.intentFailFromScroll=fromScroll,$scope.dataAvailble.failed.fetching=!0;var payload={},dateObj=getISOdates($scope.filterComponent.days);payload.filters={from:dateObj.from,to:dateObj.to},payload.type="failtask",$scope.filterComponent.languages&&$scope.filterComponent.languages.length&&$scope.filterComponent.languages.length>0&&(payload.filters.language=$scope.filterComponent.languages),$scope.filterComponent.tasks&&$scope.filterComponent.tasks.length&&$scope.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.filterComponent.tasks),$scope.filterComponent.channels&&$scope.filterComponent.channels.length&&$scope.filterComponent.channels.length>0&&(payload.filters.channel=$scope.filterComponent.channels),$scope.filterComponent.sessions&&$scope.filterComponent.sessions.length>0&&(payload.filters.sessions=$scope.filterComponent.sessions),$scope.filterComponent.isDeveloper||(payload.filters.isDeveloper=$scope.filterComponent.isDeveloper),$scope.filterComponent.sessionStatus?payload.filters.sessionStatus=$scope.filterComponent.sessionStatus:payload.filters.sessionStatus="all","all"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[0,1]:"interactive"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[1]:"noninteractive"===$scope.filterComponent.sessionType?payload.filters.sessionCategory=[0]:payload.filters.sessionCategory=[0,1],$scope.filterToggle.failed.utterances&&($scope.filterToggle.failed.intent=!1,payload.groupby="input"),$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&$scope.filterComponent.tags.and.length>0?($scope.filterComponent.tags.and.forEach(function(payloadTag){if($scope.selectedTagsArray.forEach(function(value,key){value.name==payloadTag.name&&(payloadTag.isInclude=value.isContains.isInclude)}),payloadTag.isContains&&delete payloadTag.isContains,!payloadTag.name.length){var index=$scope.filterComponent.tags.and.indexOf(payloadTag);$scope.filterComponent.and.splice(index,1)}}),payload.filters.tags=$scope.filterComponent.tags):$scope.filterToggle.failed.intent&&($scope.filterToggle.failed.utterances=!1,payload.groupby="taskId"),payload.sort={order:$scope.dataAvailble.failed.sortby,by:"timestamp"},Object.keys($scope.filterSaveDefaultValue).length&&($scope.filterSaveDefaultValue.days&&(dateObj=getISOdates($scope.filterSaveDefaultValue.days),payload.filters.from=dateObj.from,payload.filters.to=dateObj.to),$scope.filterSaveDefaultValue.tags&&$scope.filterSaveDefaultValue.tags.length&&$scope.filterSaveDefaultValue.tags[0]&&$scope.filterSaveDefaultValue.tags[0].values&&$scope.filterSaveDefaultValue.tags[0].values.length&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.tags={},payload.filters.tags.and=[],payload.filters.tags.and=$scope.filterSaveDefaultValue.tags),$scope.filterSaveDefaultValue.excludeChannelUIds&&$scope.filterSaveDefaultValue.excludeChannelUIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeChannelUIds=$scope.filterSaveDefaultValue.excludeChannelUIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.excludeUserIds&&$scope.filterSaveDefaultValue.excludeUserIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeUserIds=$scope.filterSaveDefaultValue.excludeUserIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Kore ID"):$scope.filterSaveDefaultValue.channelUIds&&$scope.filterSaveDefaultValue.channelUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.channelUIds=$scope.filterSaveDefaultValue.channelUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.koreUIds&&$scope.filterSaveDefaultValue.koreUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.userId=$scope.filterSaveDefaultValue.koreUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Kore ID"),$scope.filterSaveDefaultValue.language&&$scope.filterSaveDefaultValue.language.length&&$scope.filterSaveDefaultValue.language.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.language=$scope.filterSaveDefaultValue.language),"all"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[0,1]:"interactive"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[1]:"noninteractive"===$scope.filterSaveDefaultValue.sessionType?payload.filters.sessionCategory=[0]:$scope.filterComponent.sessionType||(payload.filters.sessionCategory=[0,1]),$scope.filterSaveDefaultValue.sessionStatus?payload.filters.sessionStatus=$scope.filterSaveDefaultValue.sessionStatus:$scope.filterComponent.sessionStatus||(payload.filters.sessionStatus="all"),$scope.filterSaveDefaultValue.channels&&$scope.filterSaveDefaultValue.channels.length&&$scope.filterSaveDefaultValue.channels.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.channel=$scope.filterSaveDefaultValue.channels),$scope.filterSaveDefaultValue.taskNames&&$scope.filterSaveDefaultValue.taskNames.length&&$scope.filterSaveDefaultValue.taskNames.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.taskId=$scope.filterSaveDefaultValue.taskNames),!$scope.filterSaveDefaultValue.isDeveloper&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.isDeveloper=$scope.filterSaveDefaultValue.isDeveloper)),$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&!$scope.analyzeCB.showExcludeText&&!$scope.analyzeCB.saveAsDefaultFilterValue?"Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.channelUIds||(payload.filters.channelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.channelUIds.push(selectedUser.value):payload.filters.channelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!1):(payload.filters.userId||(payload.filters.userId=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.userId.push(selectedUser.value):payload.filters.userId.push(selectedUser)}),$scope.filterComponent.exclude=!1):$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&$scope.analyzeCB.showExcludeText&&("Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.excludeChannelUIds||(payload.filters.excludeChannelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeChannelUIds.push(selectedUser.value):payload.filters.excludeChannelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!0):(payload.filters.excludeUserIds||(payload.filters.excludeUserIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeUserIds.push(selectedUser.value):payload.filters.excludeUserIds.push(selectedUser)}),$scope.filterComponent.exclude=!0)),0===offset?payload.ignoreCount=!1:payload.ignoreCount=!0,payload.sort={order:$scope.dataAvailble.failed.sortby,by:"timestamp"},reloadDockStatusIntentFail=!0,getAnalyzeFailIntentRecordsData().then(function(res){$scope.checkDockStatus()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$scope.dataAvailble.failed.fetching=!1})}}function fetchPerformanceCollection(offset,limit,fromScroll){function getAnalyzePerfomanceIntentRecordsData(){var deferred=$q.defer(),mode="async";return BTStreamsService.getAnalyzeRecords($scope.stream._id,offset,limit,payload,mode).then(function(res){deferred.resolve(res)},function(err){deferred.reject(err)}),deferred.promise}if(!$scope.dataAvailble.performance.fetching){$scope.intentPerformanceFromScroll=fromScroll,$scope.dataAvailble.performance.fetching=!0;var payload={},dateObj=getISOdates($scope.filterComponent.days);payload.filters={from:dateObj.from,to:dateObj.to},payload.type="performance",$scope.filterComponent.components&&$scope.filterComponent.components.length>0&&(payload.filters.componentId=$scope.filterComponent.components),$scope.filterComponent.channels&&$scope.filterComponent.channels.length&&$scope.filterComponent.channels.length>0&&(payload.filters.channel=$scope.filterComponent.channels),$scope.filterComponent.sessions&&$scope.filterComponent.sessions.length>0&&(payload.filters.sessions=$scope.filterComponent.sessions),$scope.filterComponent.tasks&&$scope.filterComponent.tasks.length&&$scope.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.filterComponent.tasks),$scope.filterComponent.isDeveloper||(payload.filters.isDeveloper=$scope.filterComponent.isDeveloper),$scope.filterToggle.performance.utterances&&($scope.filterToggle.performance.intent=!1,payload.groupby="componentId"),$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&$scope.filterComponent.tags.and.length>0?($scope.filterComponent.tags.and.forEach(function(payloadTag){if($scope.selectedTagsArray.forEach(function(value,key){value.name==payloadTag.name&&(payloadTag.isInclude=value.isContains.isInclude)}),payloadTag.isContains&&delete payloadTag.isContains,!payloadTag.name.length){var index=$scope.filterComponent.tags.and.indexOf(payloadTag);$scope.filterComponent.and.splice(index,1)}}),payload.filters.tags=$scope.filterComponent.tags):$scope.filterToggle.performance.intent&&($scope.filterToggle.performance.utterances=!1,payload.groupby="taskId"),payload.sort={order:$scope.dataAvailble.performance.sortby,by:"avg_res"},Object.keys($scope.filterSaveDefaultValue).length&&($scope.filterSaveDefaultValue.days&&(dateObj=getISOdates($scope.filterSaveDefaultValue.days),payload.filters.from=dateObj.from,payload.filters.to=dateObj.to),$scope.filterSaveDefaultValue.tags&&$scope.filterSaveDefaultValue.tags.length&&$scope.filterSaveDefaultValue.tags[0]&&$scope.filterSaveDefaultValue.tags[0].values&&$scope.filterSaveDefaultValue.tags[0].values.length&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.tags={},payload.filters.tags.and=[],payload.filters.tags.and=$scope.filterSaveDefaultValue.tags),$scope.filterSaveDefaultValue.excludeChannelUIds&&$scope.filterSaveDefaultValue.excludeChannelUIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeChannelUIds=$scope.filterSaveDefaultValue.excludeChannelUIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.excludeUserIds&&$scope.filterSaveDefaultValue.excludeUserIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeUserIds=$scope.filterSaveDefaultValue.excludeUserIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Kore ID"):$scope.filterSaveDefaultValue.channelUIds&&$scope.filterSaveDefaultValue.channelUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.channelUIds=$scope.filterSaveDefaultValue.channelUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.koreUIds&&$scope.filterSaveDefaultValue.koreUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.userId=$scope.filterSaveDefaultValue.koreUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Kore ID"),$scope.filterSaveDefaultValue.componentId&&$scope.filterSaveDefaultValue.componentId.length>0&&(payload.filters.componentId=$scope.filterSaveDefaultValue.componentId),$scope.filterSaveDefaultValue.channels&&$scope.filterSaveDefaultValue.channels.length&&$scope.filterSaveDefaultValue.channels.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.channel=$scope.filterSaveDefaultValue.channels),$scope.filterSaveDefaultValue.taskNames&&$scope.filterSaveDefaultValue.taskNames.length&&$scope.filterSaveDefaultValue.taskNames.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.taskId=$scope.filterSaveDefaultValue.taskNames),!$scope.filterSaveDefaultValue.isDeveloper&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.isDeveloper=$scope.filterSaveDefaultValue.isDeveloper)),$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&!$scope.analyzeCB.showExcludeText&&!$scope.analyzeCB.saveAsDefaultFilterValue?"Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.channelUIds||(payload.filters.channelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.channelUIds.push(selectedUser.value):payload.filters.channelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!1):(payload.filters.userId||(payload.filters.userId=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.userId.push(selectedUser.value):payload.filters.userId.push(selectedUser)}),$scope.filterComponent.exclude=!1):$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&$scope.analyzeCB.showExcludeText&&("Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.excludeChannelUIds||(payload.filters.excludeChannelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeChannelUIds.push(selectedUser.value):payload.filters.excludeChannelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!0):(payload.filters.excludeUserIds||(payload.filters.excludeUserIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeUserIds.push(selectedUser.value):payload.filters.excludeUserIds.push(selectedUser)}),$scope.filterComponent.exclude=!0)),0===offset?payload.ignoreCount=!1:payload.ignoreCount=!0,payload.sort={order:$scope.dataAvailble.performance.sortby,by:"avg_res"},reloadDockStatusPerformance=!0,getAnalyzePerfomanceIntentRecordsData().then(function(res){$scope.checkDockStatus()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$scope.dataAvailble.performance.fetching=!1})}}function fetchPinnedTaskCollection(offset,limit,fromScroll){function getAnalyzePinnedIntentRecordsData(){var deferred=$q.defer(),mode="async";return BTStreamsService.getAnalyzeRecords($scope.stream._id,offset,limit,payload,mode).then(function(res){deferred.resolve(res)},function(err){deferred.reject(err)}),deferred.promise}if(!$scope.dataAvailble.pinned.fetching){$scope.intentPinnedFromScroll=fromScroll,$scope.dataAvailble.pinned.fetching=!0;var payload={},dateObj=getISOdates($scope.filterComponent.days);payload.filters={from:dateObj.from,to:dateObj.to},payload.type="pinned",$scope.filterComponent.languages&&$scope.filterComponent.languages.length&&$scope.filterComponent.languages.length>0&&(payload.filters.language=$scope.filterComponent.languages),$scope.filterComponent.channels&&$scope.filterComponent.channels.length&&$scope.filterComponent.channels.length>0&&(payload.filters.channel=$scope.filterComponent.channels),$scope.filterComponent.tasks&&$scope.filterComponent.tasks.length&&$scope.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.filterComponent.tasks),$scope.filterComponent.sessions&&$scope.filterComponent.sessions.length>0&&(payload.filters.sessions=$scope.filterComponent.sessions),$scope.filterComponent.isDeveloper||(payload.filters.isDeveloper=$scope.filterComponent.isDeveloper),$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&$scope.filterComponent.tags.and.length>0&&($scope.filterComponent.tags.and.forEach(function(payloadTag){if($scope.selectedTagsArray.forEach(function(value,key){value.name==payloadTag.name&&(payloadTag.isInclude=value.isContains.isInclude)}),payloadTag.isContains&&delete payloadTag.isContains,!payloadTag.name.length){var index=$scope.filterComponent.tags.and.indexOf(payloadTag);$scope.filterComponent.and.splice(index,1)}}),payload.filters.tags=$scope.filterComponent.tags);var currentUser=localstore.getAuthData().currentAccount;payload.filters.pinnedBy=[],payload.filters.pinnedBy.push(currentUser.userInfo.id),$scope.filterToggle.pinned.utterances?($scope.filterToggle.pinned.intent=!1,payload.groupby="input"):$scope.filterToggle.pinned.intent&&($scope.filterToggle.pinned.utterances=!1,payload.groupby="taskId"),payload.sort={order:$scope.dataAvailble.pinned.sortby,by:"timestamp"},Object.keys($scope.filterSaveDefaultValue).length&&($scope.filterSaveDefaultValue.days&&(dateObj=getISOdates($scope.filterSaveDefaultValue.days),payload.filters.from=dateObj.from,payload.filters.to=dateObj.to),$scope.filterSaveDefaultValue.tags&&$scope.filterSaveDefaultValue.tags.length&&$scope.filterSaveDefaultValue.tags[0]&&$scope.filterSaveDefaultValue.tags[0].values&&$scope.filterSaveDefaultValue.tags[0].values.length&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.tags={},payload.filters.tags.and=[],payload.filters.tags.and=$scope.filterSaveDefaultValue.tags),$scope.filterSaveDefaultValue.excludeChannelUIds&&$scope.filterSaveDefaultValue.excludeChannelUIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeChannelUIds=$scope.filterSaveDefaultValue.excludeChannelUIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.excludeUserIds&&$scope.filterSaveDefaultValue.excludeUserIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeUserIds=$scope.filterSaveDefaultValue.excludeUserIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Kore ID"):$scope.filterSaveDefaultValue.channelUIds&&$scope.filterSaveDefaultValue.channelUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.channelUIds=$scope.filterSaveDefaultValue.channelUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.koreUIds&&$scope.filterSaveDefaultValue.koreUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.userId=$scope.filterSaveDefaultValue.koreUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Kore ID"),$scope.filterSaveDefaultValue.language&&$scope.filterSaveDefaultValue.language.length&&$scope.filterSaveDefaultValue.language.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.language=$scope.filterSaveDefaultValue.language),$scope.filterSaveDefaultValue.channels&&$scope.filterSaveDefaultValue.channels.length&&$scope.filterSaveDefaultValue.channels.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.channel=$scope.filterSaveDefaultValue.channels),$scope.filterSaveDefaultValue.taskNames&&$scope.filterSaveDefaultValue.taskNames.length&&$scope.filterSaveDefaultValue.taskNames.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.taskId=$scope.filterSaveDefaultValue.taskNames),!$scope.filterSaveDefaultValue.isDeveloper&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.isDeveloper=$scope.filterSaveDefaultValue.isDeveloper)),$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&!$scope.analyzeCB.showExcludeText&&!$scope.analyzeCB.saveAsDefaultFilterValue?"Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.channelUIds||(payload.filters.channelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.channelUIds.push(selectedUser.value):payload.filters.channelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!1):(payload.filters.userId||(payload.filters.userId=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.userId.push(selectedUser.value):payload.filters.userId.push(selectedUser)}),$scope.filterComponent.exclude=!1):$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&$scope.analyzeCB.showExcludeText&&("Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.excludeChannelUIds||(payload.filters.excludeChannelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeChannelUIds.push(selectedUser.value):payload.filters.excludeChannelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!0):(payload.filters.excludeUserIds||(payload.filters.excludeUserIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeUserIds.push(selectedUser.value):payload.filters.excludeUserIds.push(selectedUser)}),$scope.filterComponent.exclude=!0)),0===offset?payload.ignoreCount=!1:payload.ignoreCount=!0,payload.sort={order:$scope.dataAvailble.pinned.sortby,by:"timestamp"},reloadDockStatusPinned=!0,getAnalyzePinnedIntentRecordsData().then(function(res){$scope.checkDockStatus()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$scope.dataAvailble.pinned.fetching=!1})}}function fetchDebugLogCollection(offset,limit,fromScroll){if(!$scope.dataAvailble.logs.fetching){$scope.dataAvailble.logs.fetching=!0;var payload={},dateObj=getISOdates($scope.filterComponent.days);payload.filters={fromDate:dateObj.from,toDate:dateObj.to},payload.filters.isDeveloper=!0,$scope.filterComponent.languages&&$scope.filterComponent.languages.length&&$scope.filterComponent.languages.length>0&&(payload.filters.language=$scope.filterComponent.languages),$scope.filterComponent.channels&&$scope.filterComponent.channels.length&&$scope.filterComponent.channels.length>0&&(payload.filters.channel=$scope.filterComponent.channels),
$scope.filterComponent.sessions&&$scope.filterComponent.sessions.length>0&&(payload.filters.sessions=$scope.filterComponent.sessions),$scope.filterComponent.tasks&&$scope.filterComponent.tasks.length&&$scope.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.filterComponent.tasks),$scope.filterComponent.isDeveloper||(payload.filters.isDeveloper=$scope.filterComponent.isDeveloper);localstore.getAuthData().currentAccount;payload.filters.sort={order:$scope.dataAvailble.logs.sortby,by:"timestamp"},Object.keys($scope.filterSaveDefaultValue).length&&($scope.filterSaveDefaultValue.days&&(dateObj=getISOdates($scope.filterSaveDefaultValue.days),payload.filters.from=dateObj.from,payload.filters.to=dateObj.to),$scope.filterSaveDefaultValue.excludeChannelUIds&&$scope.filterSaveDefaultValue.excludeChannelUIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeChannelUIds=$scope.filterSaveDefaultValue.excludeChannelUIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.excludeUserIds&&$scope.filterSaveDefaultValue.excludeUserIds.length&&$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.excludeUserIds=$scope.filterSaveDefaultValue.excludeUserIds,$scope.filterComponent.exclude=!0,$scope.analyzeCB.toggleCheck="Kore ID"):$scope.filterSaveDefaultValue.channelUIds&&$scope.filterSaveDefaultValue.channelUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue?(payload.filters.channelUIds=$scope.filterSaveDefaultValue.channelUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Channel ID"):$scope.filterSaveDefaultValue.koreUIds&&$scope.filterSaveDefaultValue.koreUIds.length&&!$scope.analyzeCB.showExcludeText&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.userId=$scope.filterSaveDefaultValue.koreUIds,$scope.filterComponent.exclude=!1,$scope.analyzeCB.toggleCheck="Kore ID"),$scope.filterSaveDefaultValue.language&&$scope.filterSaveDefaultValue.language.length&&$scope.filterSaveDefaultValue.language.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.language=$scope.filterSaveDefaultValue.language),$scope.filterSaveDefaultValue.channels&&$scope.filterSaveDefaultValue.channels.length&&$scope.filterSaveDefaultValue.channels.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.channel=$scope.filterSaveDefaultValue.channels),$scope.filterSaveDefaultValue.taskNames&&$scope.filterSaveDefaultValue.taskNames.length&&$scope.filterSaveDefaultValue.taskNames.length>0&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.taskId=$scope.filterSaveDefaultValue.taskNames),!$scope.filterSaveDefaultValue.isDeveloper&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.isDeveloper=$scope.filterSaveDefaultValue.isDeveloper)),$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&!$scope.analyzeCB.showExcludeText&&!$scope.analyzeCB.saveAsDefaultFilterValue?"Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.channelUIds||(payload.filters.channelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.channelUIds.push(selectedUser.value):payload.filters.channelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!1):(payload.filters.userId||(payload.filters.userId=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.userId.push(selectedUser.value):payload.filters.userId.push(selectedUser)}),$scope.filterComponent.exclude=!1):$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&$scope.analyzeCB.showExcludeText&&("Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.excludeChannelUIds||(payload.filters.excludeChannelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeChannelUIds.push(selectedUser.value):payload.filters.excludeChannelUIds.push(selectedUser)}),$scope.filterComponent.exclude=!0):(payload.filters.excludeUserIds||(payload.filters.excludeUserIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeUserIds.push(selectedUser.value):payload.filters.excludeUserIds.push(selectedUser)}),$scope.filterComponent.exclude=!0)),BTStreamsService.getDebugLogRecords($scope.stream._id,offset,limit,payload).then(function(res){$scope.dataAvailble.logs.totalCount=res.data.totalCount,$scope.dataAvailble.logs.moreAvailable=res.data.hasMore;var dataset=res.data.logs?res.data.logs:[];$scope.debugLogsCollection=fromScroll?$scope.debugLogsCollection.concat(dataset):dataset,$scope.users=_.uniq($scope.users.concat(res.data.users?res.data.users:[])),$scope.tasks=_.uniq($scope.tasks.concat(res.data.tasks?res.data.tasks:[])),$scope.dataAvailble.logs.fetching=!1,handleGroupedTasks(),$scope.analyzeCB.debugLogsCollection=$scope.debugLogsCollection},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error");$scope.dataAvailble.logs.fetching=!1})}}function initFirstTab(classname){setTimeout(function(){var ele=$("."+classname+" ul li").first();ele.find("a").trigger("click")},350)}function handleGroupedTasks(){setTimeout(function(){$(".groupByTask").click(function(e){e.stopImmediatePropagation(),e.stopPropagation(),$scope.performanceCollection&&$(this).closest(".parentGroupDivBlock").attr("parentindex")&&$scope.performanceCollection[$(this).closest(".parentGroupDivBlock").attr("parentindex")]&&($scope.performanceCollection[$(this).closest(".parentGroupDivBlock").attr("parentindex")].isOpen=!0),$(this).closest(".parentGroupDivBlock").toggleClass("active"),$(this).closest(".eachTableRow").siblings(".grouped").toggleClass("groupedElements"),$(this).closest(".eachTableRow").siblings(".grouped").slideToggle()}),$(".fa-compress").click(function(e){e.stopImmediatePropagation(),e.stopPropagation(),$scope.performanceCollection&&$(this).closest(".parentGroupDivBlock").attr("parentindex")&&$scope.performanceCollection[$(this).closest(".parentGroupDivBlock").attr("parentindex")]&&($scope.performanceCollection[$(this).closest(".parentGroupDivBlock").attr("parentindex")].isOpen=!1),$(this).closest(".parentGroupDivBlock").toggleClass("active"),$(this).closest(".parentGroupDivBlock").find(".grouped").toggleClass("groupedElements"),$(this).closest(".parentGroupDivBlock").find(".grouped").slideToggle()})},1500)}function initiateScrolls(){$("#intentFoundContainer").scrollTop(2),$("#intentNotFoundContainer").scrollTop(2),$("#failedTaskContainer").scrollTop(2),$("#performanceContainer").scrollTop(2),$("#pinnedContainer").scrollTop(2),$("#debugLogsContainer").scrollTop(2)}$scope.assetsBase=env_conf["assets-url"],$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.checkTickIcon=$scope.assetsBase+"headerIcons/checkTickIcon.svg",$scope.checkTickIconDisabled=$scope.assetsBase+"headerIcons/checkTickIconDisabled.svg",$scope.caretDown=env_conf["context-url"]+"/assets/icons/caretDown.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.analyzeCB={},$scope.contacts=[],$scope.defaultFilter=!0,$scope.defaultFilterMsg="",getDefaultFilter(1,"one week"),$scope._constants_=_constants_,$scope.filterTags=[],$scope.moreFilterValues=[],$scope.users=[],$scope.tasksValue={},$scope.tasks=[],$scope.selectedChannels=[],$scope.components=[],$scope.filterSaveDefaultValue={};var reloadDockStatusIntent=!1,reloadDockStatusIntentNot=!1,reloadDockStatusIntentFail=!1,reloadDockStatusPerformance=!1,reloadDockStatusPinned=!1;$scope.intentFromScroll=!1,$scope.intentNotFromScroll=!1,$scope.intentFailFromScroll=!1,$scope.intentPerformanceFromScroll=!1,$scope.intentPinnedFromScroll=!1,$scope.trainOffset=-17,$scope.currentTrainOpentask=null,$scope.currentTab="intentFound",$scope.scriptServiceComponents=[],$scope.requestStatus={interval:null},$scope.caretDown=$scope.assetsBase+"icons/caretDown.svg",$scope.selectedTagsArray=[],$scope.currentBotLanguage=$workflowService.currentLanguage(),$scope.categories=$workflowService.seedData().category,$scope.regroupDone={message:!1,progress:!1,error:"",dockError:!1};var otherNodesClickCount=0;$scope.isSessionFlowAvail=!1,$scope.isRequesting=!1,$scope.showTraitsNew={},$scope.showTraitsNew.isPTE=$workflowService.selectedStream().isPTE,$scope.allTasks=[].concat($workflowService.alertTasks(),$workflowService.actionTasks(),$workflowService.dialogTasks(),$workflowService.informationTasks(),$workflowService.knowledgeTasks()),$scope.languageCodes={en:"English",de:"German",es:"Spanish",fr:"French",pt:"Portugese",it:"Italian",zh_cn:"Chinese Simiplified",zh_tw:"Chinese Traditional",id:"Indonesian",ko:"Korean",nl:"Dutch",ja:"Japanese",ar:"Arabic",fi:"Finnish",ru:"Russian",pl:"Polish",uk:"Ukrainian",sv:"Swedish",kk:"Kazakh",ca:"Catalan",ge:"MultiLingual"},$scope.filterToggle={successIntent:{utterances:!0,intent:!1},failedintent:{utterances:!0,intent:!1},failed:{utterances:!0,intent:!1},performance:{utterances:!0,intent:!1},pinned:{utterances:!0,intent:!1}},$scope.filterTab={intentFound:{tab_name:"Intent found"},intentNotFound:{tab_name:"Intent not found"},failedTask:{tab_name:"Failed task"},performance:{tab_name:"Performance"},pinned:{tab_name:"Pinned"},debugLog:{tab_name:"Debug Log"}},$scope.dataAvailble={successIntent:{total:0,moreAvailable:!0,fetching:!1,sortby:"desc"},failedintent:{total:0,moreAvailable:!0,fetching:!1,sortby:"desc"},failed:{total:0,moreAvailable:!0,fetching:!1,sortby:"desc"},performance:{total:0,moreAvailable:!0,fetching:!1,sortby:"desc"},pinned:{total:0,moreAvailable:!0,fetching:!1,sortby:"desc"},logs:{total:0,moreAvailable:!0,fetching:!1,sortby:"desc"}},channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channelsConfig=channelsConfig,$scope.editTaskLoading=!1;var streamId=$workflowService.selectedStream()._id;$scope.currTask=null;var isClusterDoneToday=!1;$scope.analyzeCB.toShowKoreID=!1,$scope.filterComponent={users:[],endDate:moment().format("MM-DD-YYYY"),startDate:moment().subtract(1,"d").format("MM-DD-YYYY"),languages:[],channels:[],tasks:[],components:[],utteranceType:"both",isAmbiguous:"showAll",customTags:"",days:1,isDeveloper:!0,tags:{and:[]},tagsObj:{},specficChannelUId:[],contacts:[],sessions:[]};var userInform=localstore.getAuthData();userInform&&userInform.currentAccount&&userInform.currentAccount.userInfo&&userInform.currentAccount.userInfo.personalInfo&&userInform.currentAccount.userInfo.personalInfo.language&&"ja"===userInform.currentAccount.userInfo.personalInfo.language&&($scope.defaultFilter=!1,$scope.showJapaneseFilter=!0,$scope.tooltipValue=$scope.filterComponent.startDate+" - "+$scope.filterComponent.endDate,$scope.dateValue=i18n.i18nString("last_24_hours")),getCustomMetaTags(),"undefined"==typeof Array.prototype.find&&(Array.prototype.find=function(callback,thisArg){for(var i=0;i<this.length;i++)if(callback.call(thisArg||window,this[i],i,this))return this[i];return void 0}),$scope.stream=$workflowService.selectedStream(),$scope.stream?$scope.linkedBots=($scope.stream.publishedBots||[]).concat($scope.stream.configuredBots||[]):$scope.linkedBots=[],fetchScriptServiceComponents("script"),fetchScriptServiceComponents("service"),fetchScriptServiceComponents("SDKWebHook"),$scope.checkShowTraits=function(e,intentValue){$scope.categoryIds=[],_.forEach($scope.categories,function(category){$scope.categoryIds.push(category._id)});var _payload={name:$workflowService.selectedStream().name,type:$workflowService.selectedStream().type,description:$workflowService.selectedStream().description,color:$workflowService.selectedStream().color,categoryIds:$scope.categoryIds,hasTenant:!1,isPTE:$scope.showTraitsNew.isPTE,offKoraConfirmation:$workflowService.selectedStream().offKoraConfirmation,skipMakeEditLinks:$workflowService.selectedStream().skipMakeEditLinks,purpose:$workflowService.selectedStream().purpose};BTStreamsService.editStream(streamId,_payload).then(function(response){response&&response.data&&($workflowService.selectedStream().isPTE=response.data.isPTE)},function(res){}),$scope.analyzeCB.applyFilter($scope.filterComponent,"",{})},$scope.statusAnalyze=function(){BTStreamsService.analyzeStatus($applicationService.userInfo().userId,streamId).then(function(response){"pending"==response.data.status?$element.find(".export-analyze-modal-body p")[0].innerHTML=i18n.i18nString("pending_please_wait"):"success"==response.data.status?($scope.downloadURL=response.data.downloadURL,$scope.downloadURL?($element.find(".export-analyze-modal-body p")[0].innerHTML=i18n.i18nString("downloading_please_wait"),setTimeout(function(){$element.find("#analyzedownloadButton")[0].click()}),setTimeout(function(){$element.find(".export-analyze-modal").removeClass("show").addClass("fade"),$element.find(".export-analyze-modal-body p")[0].innerHTML=i18n.i18nString("pleasewait_fetching_label")},3500),clearInterval($scope.requestStatus.interval)):alert("Please allow popups for this website")):"failed"===response.data.status?($element.find(".export-analyze-modal-body p")[0].innerHTML="Failed to fetch the data.",clearInterval($scope.requestStatus.interval),setTimeout(function(){$element.find(".export-analyze-modal").removeClass("show").addClass("fade"),$element.find(".export-analyze-modal-body p")[0].innerHTML=i18n.i18nString("pleasewait_fetching_label")},2e3)):""===response.data&&void 0===response.data.status&&(setTimeout(function(){$element.find(".export-analyze-modal").removeClass("show").addClass("fade"),$element.find(".export-analyze-modal-body p")[0].innerHTML=i18n.i18nString("some_thing_went_wrong")},2e3),clearInterval($scope.requestStatus.interval))},function(error){$element.find(".export-analyze-modal-body p")[0].innerHTML=i18n.i18nString("failed_to_fetch_data"),clearInterval($scope.requestStatus.interval),setTimeout(function(){$element.find(".export-analyze-modal").removeClass("show").addClass("fade"),$element.find(".export-analyze-modal-body p")[0].innerHTML=i18n.i18nString("pleasewait_fetching_label")},2e3)})},$scope.geneateDebugLog=function(){function startLogExport(){var payload={},dateObj=getISOdates($scope.filterComponent.days);payload={fromDate:dateObj.from,toDate:dateObj.to},payload.streamId=$scope.stream._id,payload.isDeveloper=!0,$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&("Channel ID"===$scope.analyzeCB.toggleCheck?(payload.channelUIds=[],payload.channelUIds=angular.copy($scope.filterComponent.users)):(payload.userId=[],payload.userId=angular.copy($scope.filterComponent.users))),$scope.filterComponent.languages.length>0&&(payload.language=$scope.filterComponent.languages),$scope.filterComponent.channels.length>0&&(payload.channel=$scope.filterComponent.channels),$scope.filterComponent.tasks.length>0&&(payload.taskId=$scope.filterComponent.tasks),$scope.filterComponent.isDeveloper||(payload.isDeveloper=$scope.filterComponent.isDeveloper),payload.timezone=moment.tz.guess(),BTStreamsService.generateDebugLogRecords($scope.stream._id,payload).then(function(response){NotificationService.notify("Exporting Analyze data ... ","success"),"IN_PROGRESS"===response.data.status||"SUCCESS"===response.data.status?($rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open")):"FAILED"===response.data.status&&$rootScope.$broadcast("getProgressDockStatus")},function(error){if("RequestExists"===error.data.errors[0].code){var msg=error.data.errors[0].code;NotificationService.notify(msg,"warning")}})}function cancleLogExport(){}function checkBoxCb(checkValue){$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startLogExport,cancleLogExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_Debug_log")):startExport()},$scope.analyzeCB.analyzeExport=$scope.geneateDebugLog,$scope.analyzeExport=function(tab){function startExport(){var payload={},dateObj=getISOdates($scope.filterComponent.days);payload.type=tab,payload.filters={from:dateObj.from,to:dateObj.to},$scope.filterComponent.languages.length>0&&(payload.filters.language=$scope.filterComponent.languages),$scope.filterComponent.channels.length>0&&(payload.filters.channel=$scope.filterComponent.channels),$scope.filterComponent.tasks.length>0&&(payload.filters.taskId=$scope.filterComponent.tasks),$scope.filterComponent.isDeveloper||(payload.filters.isDeveloper=$scope.filterComponent.isDeveloper),"notTrained"===$scope.filterComponent.utteranceType&&(payload.filters.trained=!1),$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&$scope.filterComponent.tags.and.length>0&&(_.forEach($scope.filterComponent.tags.and,function(payloadTag){payloadTag.isContains&&delete payloadTag.isContains}),payload.filters.tags=$scope.filterComponent.tags),"trained"===$scope.filterComponent.utteranceType&&(payload.filters.trained=!0),$scope.filterToggle.successIntent.utterances&&"performance"!==$scope.currentTab&&($scope.filterToggle.successIntent.intent=!1,payload.groupby="input"),$scope.filterToggle.successIntent.utterances&&"performance"===$scope.currentTab?($scope.filterToggle.successIntent.intent=!1,payload.groupby="componentId"):$scope.filterToggle.successIntent.intent&&($scope.filterToggle.successIntent.utterances=!1,payload.groupby="taskId"),"failintent"===tab&&"hideAmbiguous"===$scope.filterComponent.isAmbiguous?payload.filters.isAmbiguous=!1:"failintent"===tab&&"showAmbiguous"===$scope.filterComponent.isAmbiguous&&(payload.filters.isAmbiguous=!0),payload.sort={order:$scope.dataAvailble.successIntent.sortby,by:"timestamp"},payload.timezone=moment.tz.guess(),Object.keys($scope.filterSaveDefaultValue).length&&$scope.analyzeCB.saveAsDefaultFilterValue&&(payload.filters.from=$scope.filterSaveDefaultValue.from,payload.filters.to=$scope.filterSaveDefaultValue.to,$scope.filterSaveDefaultValue.tags&&$scope.filterSaveDefaultValue.tags.length&&$scope.filterSaveDefaultValue.tags[0]&&$scope.filterSaveDefaultValue.tags[0].values&&$scope.filterSaveDefaultValue.tags[0].values.length&&(payload.filters.tags={},payload.filters.tags.and=[],payload.filters.tags.and=$scope.filterSaveDefaultValue.tags),$scope.filterSaveDefaultValue.excludeChannelUIds&&$scope.filterSaveDefaultValue.excludeChannelUIds.length?payload.filters.excludeChannelUIds=$scope.filterSaveDefaultValue.excludeChannelUIds:$scope.filterSaveDefaultValue.excludeUserIds&&$scope.filterSaveDefaultValue.excludeUserIds.length?payload.filters.excludeUserIds=$scope.filterSaveDefaultValue.excludeUserIds:$scope.filterSaveDefaultValue.channelUIds&&$scope.filterSaveDefaultValue.channelUIds.length?payload.filters.channelUIds=$scope.filterSaveDefaultValue.channelUIds:$scope.filterSaveDefaultValue.koreUIds&&$scope.filterSaveDefaultValue.koreUIds.length?payload.filters.userId=$scope.filterSaveDefaultValue.koreUIds:$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&!$scope.analyzeCB.showExcludeText?"Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.channelUIds||(payload.filters.channelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.channelUIds.push(selectedUser.value):payload.filters.channelUIds.push(selectedUser)})):(payload.filters.userId||(payload.filters.userId=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.userId.push(selectedUser.value):payload.filters.userId.push(selectedUser)})):$scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0&&$scope.analyzeCB.showExcludeText&&("Channel ID"===$scope.analyzeCB.toggleCheck?(payload.filters.excludeChannelUIds||(payload.filters.excludeChannelUIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeChannelUIds.push(selectedUser.value):payload.filters.excludeChannelUIds.push(selectedUser)})):(payload.filters.excludeUserIds||(payload.filters.excludeUserIds=[]),_.forEach($scope.filterComponent.users,function(selectedUser){selectedUser.value?payload.filters.excludeUserIds.push(selectedUser.value):payload.filters.excludeUserIds.push(selectedUser)}))),$scope.filterSaveDefaultValue.language&&$scope.filterSaveDefaultValue.language.length&&$scope.filterSaveDefaultValue.language.length>0&&(payload.filters.language=$scope.filterSaveDefaultValue.language),$scope.filterSaveDefaultValue.channels&&$scope.filterSaveDefaultValue.channels.length&&$scope.filterSaveDefaultValue.channels.length>0&&(payload.filters.channel=$scope.filterSaveDefaultValue.channels),$scope.filterSaveDefaultValue.taskNames&&$scope.filterSaveDefaultValue.taskNames.length&&$scope.filterSaveDefaultValue.taskNames.length>0&&(payload.filters.taskId=$scope.filterSaveDefaultValue.taskNames),$scope.filterSaveDefaultValue.isDeveloper||(payload.filters.isDeveloper=$scope.filterSaveDefaultValue.isDeveloper),"notTrained"===$scope.filterSaveDefaultValue.utterenceType?payload.filters.trained=!1:"trained"===$scope.filterSaveDefaultValue.utterenceType&&(payload.filters.trained=!0),"failintent"===tab&&"hideAmbiguous"===$scope.filterSaveDefaultValue.ambiguous?payload.filters.isAmbiguous=!1:"failintent"===tab&&"showAmbiguous"===$scope.filterSaveDefaultValue.ambiguous&&(payload.filters.isAmbiguous=!0)),BTStreamsService.analyzeGetRecordsExport($scope.stream._id,payload).then(function(response){NotificationService.notify(i18n.i18nString("exporting_analyze_data"),"success"),"IN_PROGRESS"===response.data.status||"SUCCESS"===response.data.status?($rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open")):"FAILED"===response.data.status&&$rootScope.$broadcast("getProgressDockStatus")},function(error){if("RequestExists"===error.data.errors[0].code){var msg=error.data.errors[0].code;NotificationService.notify(msg,"warning")}})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_metrics")):startExport()},$scope.analyzeCB.analyzeExport=$scope.analyzeExport,$rootScope.$on("onDockStatusIntent",function($event,data){if(reloadDockStatusIntent&&"SUCCESSINTENT_API"===data.jobType)if(data&&"IN_PROGRESS"===data.status)$scope.sessionFlowLoading=!0;else if(data&&"SUCCESS"===data.status&&100===data.percentageComplete&&data.response){var response={data:data.response};asyncPutRootIntentFlow(response),reloadDockStatusIntent=!1}else data&&"FAILURE"===data.status&&($scope.sessionFlowLoading=!1,otherNodesClickCount=0,$scope.isSessionFlowAvail=!1,$scope.isRequesting=!1,reloadDockStatusIntent=!1,$scope.dataAvailble.successIntent.fetching=!1,catchDockErrorMsg(data))}),$rootScope.$on("onDockStatusIntentNot",function($event,data){if(reloadDockStatusIntentNot&&"FAILINTENT_API"===data.jobType)if(data&&"IN_PROGRESS"===data.status)$scope.sessionFlowLoading=!0;else if(data&&"SUCCESS"===data.status&&100===data.percentageComplete&&data.response){var response={data:data.response};asyncPutRootIntentNotFlow(response),reloadDockStatusIntentNot=!1}else data&&"FAILURE"===data.status&&($scope.sessionFlowLoading=!1,otherNodesClickCount=0,$scope.isSessionFlowAvail=!1,$scope.isRequesting=!1,reloadDockStatusIntentNot=!1,catchDockErrorMsg(data))}),$rootScope.$on("onDockStatusFailTask",function($event,data){if(reloadDockStatusIntentFail&&"FAILTASK_API"===data.jobType)if(data&&"IN_PROGRESS"===data.status)$scope.sessionFlowLoading=!0;else if(data&&"SUCCESS"===data.status&&100===data.percentageComplete&&data.response){var response={data:data.response};asyncPutRootFailIntentFlow(response),reloadDockStatusIntentFail=!1}else data&&"FAILURE"===data.status&&($scope.sessionFlowLoading=!1,otherNodesClickCount=0,$scope.isSessionFlowAvail=!1,$scope.isRequesting=!1,reloadDockStatusIntentFail=!1,catchDockErrorMsg(data))}),$rootScope.$on("onDockStatusPerformance",function($event,data){if(reloadDockStatusPerformance&&"PERFORMANCE_API"===data.jobType)if(data&&"IN_PROGRESS"===data.status)$scope.sessionFlowLoading=!0;else if(data&&"SUCCESS"===data.status&&100===data.percentageComplete&&data.response){var response={data:data.response};asyncPutRootPerformanceFlow(response),reloadDockStatusPerformance=!1}else data&&"FAILURE"===data.status&&($scope.sessionFlowLoading=!1,otherNodesClickCount=0,$scope.isSessionFlowAvail=!1,$scope.isRequesting=!1,reloadDockStatusPerformance=!1,catchDockErrorMsg(data))}),$rootScope.$on("onDockStatusPinned",function($event,data){if(reloadDockStatusPinned&&"PINNED_API"===data.jobType)if(data&&"IN_PROGRESS"===data.status)$scope.sessionFlowLoading=!0;else if(data&&"SUCCESS"===data.status&&100===data.percentageComplete&&data.response){var response={data:data.response};asyncPutRootPinnnedFlow(response),reloadDockStatusPinned=!1}else data&&"FAILURE"===data.status&&($scope.sessionFlowLoading=!1,otherNodesClickCount=0,$scope.isSessionFlowAvail=!1,$scope.isRequesting=!1,reloadDockStatusPinned=!1,catchDockErrorMsg(data))}),$scope.checkDockStatus=function(){$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer")},$scope.initPopover=function(tag,moreFilter){var dateTooltip=!1;("date"===tag.type||"utteranceType"===tag.type||"isDeveloper"===tag.type)&&(dateTooltip=!0);var filterTagPopoverNew="#filterTagPopover"+tag.type;setTimeout(function(){$("#popOverEvent"+tag.type).popover({html:!dateTooltip,trigger:"hover",placement:moreFilter?"left":"bottom",content:function(){return dateTooltip&&7===$scope.filterComponent.days?"Invalid date"===moment($scope.filterComponent.startDate).format("MM-DD-YYYY")&&"Invalid date"===moment($scope.filterComponent.endDate).format("MM-DD-YYYY")?(tag.tooltipValue=$scope.filterComponent.startDate+" - "+$scope.filterComponent.endDate,tag.tooltipValue):(tag.tooltipValue=moment($scope.filterComponent.startDate).format("MM-DD-YYYY, hh:mm A")+"  to  "+moment($scope.filterComponent.endDate).format("MM-DD-YYYY, hh:mm A"),tag.tooltipValue):dateTooltip&&-1===$scope.filterComponent.days?(tag.tooltipValue=moment(new Date($scope.filterComponent.startDate)).format("MM-DD-YYYY, hh:mm A")+"  to  "+moment(new Date($scope.filterComponent.endDate)).format("MM-DD-YYYY, hh:mm A"),tag.tooltipValue):dateTooltip?(tag.tooltipValue=moment($scope.filterComponent.startDate).format("MM-DD-YYYY, hh:mm A")+"  to  "+moment($scope.filterComponent.endDate).format("MM-DD-YYYY, hh:mm A"),tag.tooltipValue):$(filterTagPopoverNew).html()}})},100)},$scope.handleDropdownClose=function(e){-1!==e.currentTarget.className.indexOf("analyze-dropdown")&&-1!==e.target.parentElement.className.indexOf("filterIcon")&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation())},$scope.getDate=function(timestamp){return moment(timestamp).format("MM-DD-YYYY")},$scope.getTime=function(timestamp){return moment(timestamp).format("h:mm:ss A")},$scope.editFilter=function(){analyzeDefaultFilter(),$scope.scriptServiceComponents&&$scope.scriptServiceComponents.length>0&&$scope.analyzeCB.loadComponents($scope.components),$timeout(function(){$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&0===$scope.filterComponent.tags.and.length?($scope.selectedTagsArray=[],$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:"Contain",isInclude:!0}})):($scope.selectedTagsArrayCopy=angular.copy($scope.selectedTagsArray),$scope.selectedTagsArray=[],$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&$scope.filterComponent.tags.and.length&&$scope.filterComponent.tags.and.forEach(function(value,key){var forAutoSuggestionValues=_.findIndex($scope.filterComponent.tagsObj,{name:value.name});$scope.selectedTagsArray.push({name:value.name,values:value.values,type:value.type,selectedValues:$scope.filterComponent.tagsObj[forAutoSuggestionValues].values,isContains:value.isContains})}),$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:"Contain",isInclude:!0}}))},350),$(".analyzeFilter").modal("show"),$(".customTagsDivScroll").click(function(event){event.preventDefault(),event.stopPropagation(),event.stopImmediatePropagation()})},$scope.analyzeCB.editFilter=$scope.editFilter,$rootScope.$on("scheduleClusterDone",function(){isClusterDoneToday||($scope.regroupDone.message=!0,$scope.regroupDone.progress=!1,isClusterDoneToday=!0)}),$rootScope.$on("scheduleClusterFailed",function(){isClusterDoneToday||($scope.regroupDone.progress=!1,$scope.regroupDone.dockError=!0,$scope.regroupDone.error=i18n.i18nString("regrouping_of_utterences_failed"))}),$(".clustering-progress").popover({trigger:"hover"}),$scope.scheduleCluster=function(){$scope.regroupDone.dockError=!1,$scope.regroupDone.error="",BTStreamsService.scheduleCluster($workflowService.selectedStream()._id,{}).then(function(res){$rootScope.$broadcast("startTimer"),$scope.regroupDone.progress=!0},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&(1001===err.data.errors[0].code?($scope.regroupDone.progress=!0,$rootScope.$broadcast("startTimer")):1002===err.data.errors[0].code?isClusterDoneToday=!0:1003===err.data.errors[0].code&&($scope.regroupDone.progress=!1,$scope.regroupDone.message=!1,$scope.regroupDone.error=i18n.i18nString("regrouping_has_failed")))})},$scope.scheduleCluster(),$scope.pinTask=function(task,e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),task.pinned?task.pinned=!1:task.pinned=!0;var payload={pinned:task.pinned,index:task._index};BTStreamsService.updateAnalyzeRecord($scope.stream._id,task._id,payload).then(function(res){task.pinned?NotificationService.notify(i18n.i18nString("record_pinned_sucess"),"success"):NotificationService.notify(i18n.i18nString("record_unpinned_sucess"),"success"),$scope.pinnedTasksCollection||($scope.pinnedTasksCollection=[]),$scope.pinnedTasksCollection.push(task)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.testTrainCB={},$scope.testTrainCB.onTasksLoaded=function(){$scope.allTasks=[].concat($workflowService.alertTasks(),$workflowService.actionTasks(),$workflowService.dialogTasks(),$workflowService.informationTasks(),$workflowService.knowledgeTasks()),$timeout(function(){$scope.analyzeCB.reConstuctTasks($scope.allTasks)},500)},$scope.showTrainModal=!1,$scope.trainTask=function(e,task){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),$scope.currentTrainOpentask=task,$scope.showTrainModal=!0,$workflowService.nlpTrainInput({});var params={input:[task.input]};$workflowService.nlpTrainInput({log:params}),$scope.testTrainCB.initMethod(),$(".analyzeTrain").modal("show"),setTimeout(function(){var analyzeLeftLineHeight=$(".analyzeTrain .eachModel.mlm").height()+22+($(".analyzeTrain .eachModel.fmm").height()+22)+52;$("head").append("<style>.analyzeTrain .intentTitle:before{height:"+analyzeLeftLineHeight+"px !important;}</style>");
},350)},$scope.closeTestTrainModal=function(){$(".analyzeTrain").modal("hide"),$workflowService.nlpTrainInput({}),$scope.testTrainCB.initMethod()},$scope.analyzeCB.applyFilter=function(comp,nochangeTraits,saveForDefault,showDefaultFilterValue,noDefaultfilterApplied){$scope.filterComponent=angular.copy(comp),Object.keys(saveForDefault)&&Object.keys(saveForDefault).length&&noDefaultfilterApplied?($scope.filterSaveDefaultValue=saveForDefault,$scope.filterComponent.startDate=$scope.filterSaveDefaultValue.from,$scope.filterComponent.endDate=$scope.filterSaveDefaultValue.to,$scope.filterComponent.tags.and=$scope.filterSaveDefaultValue.tags,$scope.filterSaveDefaultValue.days&&($scope.filterComponent.days=$scope.filterSaveDefaultValue.days),$scope.filterComponent.tasks=$scope.filterSaveDefaultValue.taskNames,$scope.filterComponent.languages=$scope.filterSaveDefaultValue.language,$scope.filterComponent.isAmbiguous=$scope.filterSaveDefaultValue.ambiguous,$scope.filterComponent.isDeveloper=$scope.filterSaveDefaultValue.isDeveloper,$scope.filterSaveDefaultValue.componentId&&($scope.filterComponent.components=$scope.filterSaveDefaultValue.componentId),"notTrained"===$scope.filterSaveDefaultValue.utterenceType&&($scope.filterSaveDefaultValue.trained=!1,$scope.filterSaveDefaultValue.utterenceType="notTrained"),$scope.filterComponent.utteranceType=$scope.filterSaveDefaultValue.utterenceType,$scope.filterComponent.channels=$scope.filterSaveDefaultValue.channels,showDefaultFilterValue?_.forEach($scope.filterSaveDefaultValue.users,function(user){var _selected={};_selected.value=user,$scope.filterComponent.users.push(_selected)}):$scope.filterComponent.users=$scope.filterSaveDefaultValue.users):$scope.filterSaveDefaultValue={},$scope.defaultFilter=!1,$scope.showJapaneseFilter=!1,nochangeTraits&&($scope.showTraitsNew.isPTE=!0),showDefaultFilterValue||("intentFound"===$scope.currentTab?fetchIntentFoundCollection(0,20,!1):"intentNotFound"===$scope.currentTab?fetchIntentNotFoundCollection(0,20,!1):"failedTask"===$scope.currentTab?fetchFailedTaskCollection(0,20,!1):"performance"===$scope.currentTab?fetchPerformanceCollection(0,20,!1):"pinned"===$scope.currentTab?fetchPinnedTaskCollection(0,20,!1):"debugLog"===$scope.currentTab&&fetchDebugLogCollection(0,20,!1)),$scope.filterTags=[],$scope.moreFilterValues=[];var daysCount,sD=new Date($scope.filterComponent.startDate),eD=new Date($scope.filterComponent.endDate),timeDiff=eD.getTime()-sD.getTime(),countDays=timeDiff/864e5;countDays&&countDays.toString()&&"undefined"!=typeof countDays.toString().split&&countDays.toString().split(".")&&countDays.toString().split(".")[0]&&countDays.toString().split(".")[0].length?countDays&&countDays.toString()&&"undefined"!=typeof countDays.toString().split&&countDays.toString().split(".")&&countDays.toString().split(".")[1]&&countDays.toString().split(".")[1].length?(countDays+=1,daysCount=countDays.toString().split(".")[0]):daysCount=countDays.toString().split(".")[0]:daysCount=countDays;var showCount;if(showCount=daysCount&&"1"===daysCount?daysCount+" Day":daysCount+" Days",7===$scope.filterComponent.days?"Invalid date"===moment($scope.filterComponent.startDate).format("MM-DD-YYYY")&&"Invalid date"===moment($scope.filterComponent.endDate).format("MM-DD-YYYY")?$scope.filterTags.push({value:i18n.i18nString("last7_days"),type:"date",tooltipValue:$scope.filterComponent.startDate+" - "+$scope.filterComponent.endDate}):$scope.filterTags.push({value:i18n.i18nString("last7_days"),type:"date",tooltipValue:moment($scope.filterComponent.startDate).format("MM-DD-YYYY, hh:mm A")+"  to  "+moment($scope.filterComponent.endDate).format("MM-DD-YYYY, hh:mm A")}):-1===$scope.filterComponent.days?$scope.filterTags.push({value:i18n.i18nString("custom"),type:"date",tooltipValue:moment(new Date($scope.filterComponent.startDate)).format("MM-DD-YYYY, hh:mm A")+"  to  "+moment(new Date($scope.filterComponent.endDate)).format("MM-DD-YYYY, hh:mm A"),count:showCount}):$scope.filterTags.push({value:i18n.i18nString("last_24_hours"),type:"date",tooltipValue:moment($scope.filterComponent.startDate).format("MM-DD-YYYY, hh:mm A")+"  to  "+moment($scope.filterComponent.endDate).format("MM-DD-YYYY, hh:mm A")}),$scope.filterComponent.languages&&$scope.filterComponent.languages.length&&$scope.filterComponent.languages.length>0){$scope.filterComponent.selectedLanguagesDisplay=[];var languageCount=0;_.forEach($scope.filterComponent.languages,function(language){var lang=$scope.getLanguage(language);5>languageCount&&($scope.filterComponent.selectedLanguagesDisplay.push(lang),languageCount++)}),"performance"!==$scope.currentTab?($scope.filterTags.push({value:i18n.i18nString("Bot_Languages"),type:"language",tooltipValue:$scope.filterComponent.selectedLanguagesDisplay,count:$scope.filterComponent.languages.length}),$scope.moreFilterValues.push({value:i18n.i18nString("Bot_Languages"),type:"language",tooltipValue:$scope.filterComponent.selectedLanguagesDisplay,count:$scope.filterComponent.languages.length})):NotificationService.notify(i18n.i18nString("filter_not_applicable_lang")+$scope.filterTab[$scope.currentTab].tab_name+i18n.i18nString("records"),"warning")}if($scope.filterComponent.users&&$scope.filterComponent.users.length&&$scope.filterComponent.users.length>0){$scope.filterComponent.selectedUsersDisplay=[];var userCount=0;_.forEach($scope.filterComponent.users,function(user){var _selected="";_selected=user.value&&user.value.length&&"undefined"!=typeof user.value.split&&user.value.split("/")&&user.value.split("/").length&&user.value.split("/")[1]&&user.value.split("/")[1].length?user.value.split("/")[1]:user&&"undefined"!=typeof user.split&&user.split("/")&&user.split("/").length&&user.split("/")[1]&&user.split("/")[1].length&&!user.split("/")[2]?user.split("/")[1]:user&&"undefined"!=typeof user.split&&user.split("/")&&user.split("/").length&&user.split("/")[1]&&user.split("/")[1].length&&user.split("/")[2]?user.split("/")[2]:user.id&&user.id.length?user.id:user.value&&user.value.length?user.value:user,5>userCount&&($scope.filterComponent.selectedUsersDisplay.push(_selected),userCount++)}),$scope.filterTags.push({value:i18n.i18nString("users"),type:"user",count:$scope.filterComponent.users.length,tooltipValue:$scope.filterComponent.selectedUsersDisplay}),$scope.moreFilterValues.push({value:i18n.i18nString("users"),type:"user",count:$scope.filterComponent.users.length,tooltipValue:$scope.filterComponent.selectedUsersDisplay})}if($scope.filterComponent.tasks&&$scope.filterComponent.tasks.length&&$scope.filterComponent.tasks.length>0){var taskCount=0;$scope.filterComponent.selectedTasksDisplay=[],_.forEach($scope.filterComponent.taskValues,function(task){5>taskCount&&($scope.filterComponent.selectedTasksDisplay.push(task),taskCount++)}),"intentNotFound"!==$scope.currentTab?($scope.filterTags.push({value:i18n.i18nString("Tasks_and_languages_label"),type:"task",count:$scope.filterComponent.tasks.length,tooltipValue:$scope.filterComponent.selectedTasksDisplay}),$scope.moreFilterValues.push({value:i18n.i18nString("Tasks_and_languages_label"),type:"task",count:$scope.filterComponent.tasks.length,tooltipValue:$scope.filterComponent.selectedTasksDisplay})):NotificationService.notify(i18n.i18nString("filter_not_applicable_taskname")+$scope.filterTab[$scope.currentTab].tab_name+i18n.i18nString("records"),"warning")}if($scope.filterComponent.channels&&$scope.filterComponent.channels.length&&$scope.filterComponent.channels.length>0){$scope.selectedChannels=[],$scope.filterComponent.selectedChannelsDisplay=[],$scope.filterComponent.channels.forEach(function(value){$scope.analyzeCB.channelNames.find(function(e){e.type===value&&$scope.selectedChannels.push(e.value)})});var channelCount=0;_.forEach($scope.selectedChannels,function(channel){5>channelCount&&($scope.filterComponent.selectedChannelsDisplay.push(channel),channelCount++)}),$scope.filterTags.push({value:i18n.i18nString("channel_name"),type:"channel",tooltipValue:$scope.filterComponent.selectedChannelsDisplay,count:$scope.filterComponent.channels.length}),$scope.moreFilterValues.push({value:i18n.i18nString("channel_name"),type:"channel",tooltipValue:$scope.filterComponent.selectedChannelsDisplay,count:$scope.filterComponent.channels.length})}if($scope.filterComponent.components&&$scope.filterComponent.components.length&&$scope.filterComponent.components.length>0)if("performance"===$scope.currentTab){$scope.filterComponent.componentsService=[],$scope.filterComponent.componentsToDisplay=[],_.forEach($scope.scriptServiceComponents,function(servicecomponent){_.forEach($scope.filterComponent.components,function(component){servicecomponent._id===component&&$scope.filterComponent.componentsService.push(servicecomponent.name)})});var componentCount=0;_.forEach($scope.filterComponent.componentsService,function(componentService){5>componentCount&&($scope.filterComponent.componentsToDisplay.push(componentService),componentCount++)}),$scope.filterTags.push({value:i18n.i18nString("Components"),type:"component",count:$scope.filterComponent.components.length,tooltipValue:$scope.filterComponent.componentsToDisplay}),$scope.moreFilterValues.push({value:i18n.i18nString("Components"),type:"component",count:$scope.filterComponent.components.length,tooltipValue:$scope.filterComponent.componentsToDisplay})}else NotificationService.notify(i18n.i18nString("filter_not_applicable_component")+$scope.filterTab[$scope.currentTab].tab_name+i18n.i18nString("records"),"warning");if($scope.filterComponent.sessions&&$scope.filterComponent.sessions.length>0&&($scope.filterTags.push({value:i18n.i18nString("Session_type"),type:"sessions",tooltipValue:$scope.filterComponent.sessions,count:$scope.filterComponent.sessions.length}),$scope.moreFilterValues.push({value:i18n.i18nString("Session_type"),type:"sessions",tooltipValue:$scope.filterComponent.sessions,count:$scope.filterComponent.sessions.length})),"notTrained"===$scope.filterComponent.utteranceType||"trained"===$scope.filterComponent.utteranceType)if("intentFound"===$scope.currentTab){var tooltip=$scope.filterComponent.utteranceType;"notTrained"===$scope.filterComponent.utteranceType?tooltip=i18n.i18nString("not_trained"):"trained"===$scope.filterComponent.utteranceType&&(tooltip=i18n.i18nString("trained_label")),$scope.filterTags.push({value:i18n.i18nString("utterance_type"),type:"utteranceType",tooltipValue:tooltip}),$scope.moreFilterValues.push({value:i18n.i18nString("utterance_type"),type:"utteranceType",tooltipValue:tooltip})}else NotificationService.notify(i18n.i18nString("filter_not_applicable_utterance")+$scope.filterTab[$scope.currentTab].tab_name+i18n.i18nString("records"),"warning");if(("hideAmbiguous"===$scope.filterComponent.isAmbiguous||"showAmbiguous"===$scope.filterComponent.isAmbiguous)&&("intentNotFound"===$scope.currentTab?($scope.filterTags.push({value:i18n.i18nString("ambiguous_type"),type:"ambiguousType",tooltipValue:$scope.filterComponent.isAmbiguous}),$scope.moreFilterValues.push({value:i18n.i18nString("ambiguous_type"),type:"ambiguousType",tooltipValue:$scope.filterComponent.isAmbiguous})):NotificationService.notify(i18n.i18nString("filter_not_applicable_ambiguous")+$scope.filterTab[$scope.currentTab].tab_name+i18n.i18nString("records"),"warning")),$scope.filterComponent.isDeveloper||"undefined"==typeof $scope.filterComponent.isDeveloper||($scope.filterTags.push({value:i18n.i18nString("Developer_Interactions"),type:"isDeveloper",tooltipValue:"Excluded"}),$scope.moreFilterValues.push({value:i18n.i18nString("Developer_Interactions"),type:"isDeveloper",tooltipValue:"Excluded"})),$scope.filterComponent.tags&&$scope.filterComponent.tags.and&&$scope.filterComponent.tags.and.length)if("debugLog"!==$scope.currentTab){$scope.selectedFilterTags=[],$scope.selectedFilterTagsValues=[];var tagsCount=0;_.forEach($scope.filterComponent.tags.and,function(tag){var _selectedTagName="",selectedTagValue="";selectedTagValue=tag.values,_selectedTagName=tag.name,5>tagsCount&&($scope.selectedFilterTags.push(_selectedTagName+":"+selectedTagValue),tagsCount++)}),$scope.filterTags.push({value:i18n.i18nString("custom_tags"),type:"customTags",count:$scope.filterComponent.tags.and.length,tooltipValue:$scope.selectedFilterTags}),$scope.moreFilterValues.push({value:i18n.i18nString("custom_tags"),type:"customTags",count:$scope.filterComponent.tags.and.length,tooltipValue:$scope.selectedFilterTags})}else NotificationService.notify(i18n.i18nString("filter_not_applicable_custom")+$scope.filterTab[$scope.currentTab].tab_name+i18n.i18nString("records"),"warning")},$scope.removeFilterTag=function(index,tag){"date"===tag.type?($scope.filterComponent.endDate=moment().format("MM-DD-YYYY"),$scope.filterComponent.startDate=moment().subtract(1,"d").format("MM-DD-YYYY"),$scope.filterComponent.days=1,$scope.filterSaveDefaultValue.days=1,"date"===tag.type&&"last 7 days"!==tag.value&&$scope.filterTags.push({value:i18n.i18nString("last_24_hours"),type:"date",tooltipValue:moment($scope.filterComponent.startDate).format("MM-DD-YYYY, hh:mm A")+"  to  "+moment($scope.filterComponent.endDate).format("MM-DD-YYYY, hh:mm A")})):"language"===tag.type?$scope.filterComponent.languages=[]:"user"===tag.type?($scope.filterComponent.users=[],$scope.filterSaveDefaultValue.excludeChannelUIds=[],$scope.filterSaveDefaultValue.excludeUserIds=[],$scope.filterSaveDefaultValue.channelUIds=[],$scope.filterSaveDefaultValue.koreUIds=[]):"task"===tag.type?$scope.filterComponent.tasks=[]:"channel"===tag.type?$scope.filterComponent.channels=[]:"sessions"===tag.type?$scope.filterComponent.sessions=[]:"component"===tag.type?$scope.filterComponent.components=[]:"utteranceType"===tag.type?$scope.filterComponent.utteranceType="both":"isDeveloper"===tag.type?$scope.filterComponent.isDeveloper=!0:"customTags"===tag.type?($scope.selectedTagsArray=[],$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:"Contain",isInclude:!0}}),$scope.filterComponent.tags.and=[],$scope.filterSaveDefaultValue.tags=[]):"ambiguousType"===tag.type&&($scope.filterComponent.isAmbiguous="showAll"),tag.value&&"last 7 days"===tag.value?NotificationService.notify(i18n.i18nString("date_filter_warning"),"warning"):($scope.filterTags.splice(index,1),$scope.moreFilterValues.splice(index,1),(0===$scope.filterTags.length||0===$scope.moreFilterValues.length)&&$scope.clearFilterTags(),init())},$scope.clearFilterTags=function(){$scope.filterTags=[],$scope.moreFilterValues=[],$scope.filterComponent={users:[],endDate:moment().format("MM-DD-YYYY"),components:[],startDate:moment().subtract(1,"d").format("MM-DD-YYYY"),languages:[],channels:[],tasks:[],utteranceType:"both",isAmbiguous:"showAll",customTags:"",days:7,isDeveloper:!0,tags:{and:[]},tagsObj:$scope.filterComponent.tagsObj,sessions:[]},$scope.selectedTagsArray=[],$scope.filterSaveDefaultValue={};var dateObj=getISOdates(7);$scope.filterSaveDefaultValue={filterAt:"NLPMetrics",koreUIds:[],channelUIds:[],taskNames:[],utterenceType:"both",channels:[],language:[],excludeUserIds:[],excludeChannelUIds:[],ambiguous:"showAll",from:dateObj.from,to:dateObj.to,isDeveloper:!0,tags:[]},$scope.filterSaveDefaultValue.days=7,$scope.selectedTagsArray.push({name:"",values:[],type:"",isContains:{id:"contain",label:"Contain",isInclude:!0}}),$scope.defaultFilter=!0,userInform&&userInform.currentAccount&&userInform.currentAccount.userInfo&&userInform.currentAccount.userInfo.personalInfo&&userInform.currentAccount.userInfo.personalInfo.language&&"ja"===userInform.currentAccount.userInfo.personalInfo.language&&($scope.defaultFilter=!1,$scope.showJapaneseFilter=!0,$scope.tooltipValue=$scope.filterComponent.startDate+" - "+$scope.filterComponent.endDate,$scope.dateValue=i18n.i18nString("last_24_hours")),init()},$scope.getEmail=function(userId){return userId||"---"},$scope.getLanguage=function(code){return code?(code=code.toLowerCase(),$scope.languageCodes[code]&&""!==$scope.languageCodes[code]?$scope.languageCodes[code]:"---"):"---"},$scope.getTaskName=function(taskId,task){if(task&&task.resourceInfo&&"SMALLTALK"===task.resourceInfo.type)return task.resourceInfo.name;if(!taskId||!task)return"---";var linkedBotName="";if(!($scope.tasks.length>0)){if("universalbot"===$scope.stream.type&&task&&task.linkedBotId){var result1=$.grep($scope.linkedBots,function(e){return e._id===task.linkedBotId});return result1&&result1.length>0?linkedBotName=result1[0].botName+" : ":task.linkedBotId===$scope.stream._id&&(linkedBotName=$scope.stream.name+" : "),task&&"FAQ"==task.taskType?(linkedBotName||"")+i18n.i18nString("deleted_faq",{dyn:taskId}):!task||"dialog"!=task.taskType&&"action"!=task.taskType&&"alert"!=task.taskType?"---":(linkedBotName||"")+i18n.i18nString("deleted_task",{dyn:taskId})}return task&&"FAQ"==task.taskType?i18n.i18nString("deleted_faq",{dyn:taskId}):!task||"dialog"!=task.taskType&&"action"!=task.taskType&&"alert"!=task.taskType?"---":i18n.i18nString("deleted_task",{dyn:taskId})}var currentLanguage=$workflowService.currentLanguage();$scope.currentBotLanguage=$workflowService.currentLanguage();var entry;if(entry=(!task||"alert"!==task.taskType&&"action"!==task.taskType&&"information"!==task.taskType)&&task&&"FAQ"!==task.taskType&&-1===taskId.indexOf("dg-")?$scope.tasks.find(function(e){return e.refId===taskId}):$scope.tasks.find(function(e){return e._id===taskId}),!entry&&!task.linkedBotId)return"FAQ"==task.taskType?i18n.i18nString("deleted_faq",{dyn:taskId}):i18n.i18nString("deleted_task",{dyn:taskId});if(!task||"FAQ"!=task.taskType){if(entry&&entry._id&&entry.localeData&&entry.localeData[currentLanguage]){if("universalbot"===$scope.stream.type&&task&&task.linkedBotId){var result=$.grep($scope.linkedBots,function(e){return e._id===task.linkedBotId});result&&result.length>0?linkedBotName+=result[0].botName+" : ":task.linkedBotId===$scope.stream._id&&(linkedBotName+=$scope.stream.name+" : ")}return linkedBotName+""+(entry&&entry.localeData&&entry.localeData[currentLanguage].name||i18n.i18nString("deleted_task",{dyn:taskId}))}return task&&"FAQ"==task.taskType?i18n.i18nString("deleted_faq",{dyn:taskId}):!task||"dialog"!=task.taskType&&"action"!=task.taskType&&"alert"!=task.taskType?"---":i18n.i18nString("deleted_task",{dyn:taskId})}if("universalbot"===$scope.stream.type&&task&&task.linkedBotId){var faQresult=$.grep($scope.linkedBots,function(e){return e._id===task.linkedBotId});return faQresult&&faQresult.length>0?linkedBotName+=faQresult[0].botName+" : ":task.linkedBotId===$scope.stream._id&&(linkedBotName+=$scope.stream.name+" : "),linkedBotName+""+(entry&&entry.questionPayload?entry.questionPayload.question:i18n.i18nString("deleted_faq",{dyn:taskId}))}return entry&&entry._id&&entry.questionPayload&&entry.questionPayload.question?entry.questionPayload.question||"---":void 0},$scope.getComponentName=function(compId){if($scope.components.length>0){var entry=$scope.components.find(function(e){return e._id===compId});return entry&&entry._id?entry.name:"---"}return"---"},$scope.getSuccessRatio=function(total,successCount){return total&&successCount&&successCount>0?100*total/successCount:0},$scope.getTaskErrorTitle=function(records){if(!records)return"";var count=0;return records.records.forEach(function(obj){obj.wasSuccessfull||count++}),count>=3?""+count+i18n.i18nString("sucessive_failure_uccurred"):"---"},$scope.editTask=function(task,type,e){$scope.showTraitsNew.isPTE&&($scope.editTaskLoading=!1),"performance"===type?($scope.analyzeCB.filterComponent=angular.copy($scope.filterComponent),$scope.analyzeCB.reloadTask(task,type,null,"---","","",$scope.analyzeCB.showExcludeText),$(".analyzeEditTask").modal("show"),initFirstTab("serviceContainer"),"script"===task.logType||"webhook"===task.logType?($(".statusCode").hide(),$(".getStatusCode").hide()):($(".statusCode").show(),$(".getStatusCode").show())):"debugLog"===type?($scope.analyzeCB.filterComponent=angular.copy($scope.filterComponent),task.input="debuglog",task.resourceInfo={type:"debuglog",name:"testdebug"},task.messageId=task.messageStoreId,task.hasOwnProperty("flow")||(task.flow=[]),task.language=$scope.getLanguage(task.botLanguage),$scope.analyzeCB.reloadTask(task,type,task,$scope.getTaskName(task.taskId,task),task,$scope.tasksValue),$(".analyzeEditTask").modal("show"),initFirstTab("editTaskBody")):setTimeout(function(){if($(".traits .kr-sg-dropdowns .dropdown.dropdown-open.open").length)return $(".analyzeEditTask").modal("hide"),e.stopPropagation(),e.stopImmediatePropagation(),!1;$scope.editTaskLoading=!0;var payload={};payload.botAnalyticsId=task._id,$q.all([BTStreamsService.getAnalysisDetails($scope.stream._id,task.koralogstatusId),BTStreamsService.analyzeRecordTags($scope.stream._id,payload)]).then(function(res){$scope.currTask=task,$scope.analyzeCB.reloadTask(res[0].data,type,task,$scope.getTaskName(task.taskId,task),res[1].data,$scope.tasksValue),$scope.editTaskLoading=!1,$(".analyzeEditTask").modal("show"),initFirstTab("editTaskBody")},function(error){$scope.loading=!1,$scope.editTaskLoading=!1})},0)},$scope.updatePage=function(tab,type){$timeout(function(){"successIntent"===tab?("toggle"!==type&&($scope.dataAvailble.successIntent.sortby=type),fetchIntentFoundCollection(0,20,!1)):"failedIntent"===tab?("toggle"!==type&&($scope.dataAvailble.failedintent.sortby=type),fetchIntentNotFoundCollection(0,20,!1)):"failed"===tab?("toggle"!==type&&($scope.dataAvailble.failed.sortby=type),fetchFailedTaskCollection(0,20,!1)):"performance"===tab?("toggle"!==type&&($scope.dataAvailble.performance.sortby=type),fetchPerformanceCollection(0,20,!1)):"pinned"===tab?("toggle"!==type&&($scope.dataAvailble.pinned.sortby=type),fetchPinnedTaskCollection(0,20,!1)):"debugLog"===tab&&("toggle"!==type&&($scope.dataAvailble.logs.sortby=type),fetchDebugLogCollection(0,20,!1))},350)},$scope.updateUserName=function(type){"koreID"===type?$scope.analyzeCB.toShowKoreID=!0:$scope.analyzeCB.toShowKoreID=!1},$scope.updateCurrentTab=function(type){$scope.currentTab=type,"intentFound"==type&&($scope.regroupDone.message=!1),$scope.defaultFilter?"intentFound"===type?($scope.intentFoundCollection=[],$scope.regroupDone.message=!1,$scope.regroupDone.progress=!1,fetchIntentFoundCollection(0,20,!1)):"intentNotFound"===type?($scope.intentNotFoundCollection=[],fetchIntentNotFoundCollection(0,20,!1)):"failedTask"===type?($scope.failedTaskCollection=[],fetchFailedTaskCollection(0,20,!1)):"performance"===type?($scope.performanceCollection=[],fetchPerformanceCollection(0,20,!1)):"pinned"===type?($scope.pinnedTasksCollection=[],fetchPinnedTaskCollection(0,20,!1)):"debugLog"===type&&($scope.debugLogsCollection=[],fetchDebugLogCollection(0,20,!1)):$scope.analyzeCB.applyFilter($scope.filterComponent,!1,$scope.filterSaveDefaultValue)};var formContainerEle=$("#intentFoundContainer");formContainerEle.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.dataAvailble.successIntent.moreAvailable&&fetchIntentFoundCollection($scope.intentFoundCollection.length,20,!0)});var intentNotFoundContainer=$("#intentNotFoundContainer");intentNotFoundContainer.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.dataAvailble.failedintent.moreAvailable&&fetchIntentNotFoundCollection($scope.intentNotFoundCollection.length,20,!0)});var failedTaskContainer=$("#failedTaskContainer");failedTaskContainer.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.dataAvailble.failed.moreAvailable&&fetchFailedTaskCollection($scope.failedTaskCollection.length,20,!0)});var performanceContainer=$("#performanceContainer");performanceContainer.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.dataAvailble.performance.moreAvailable&&fetchPerformanceCollection($scope.performanceCollection.length,20,!0)});var pinnedContainer=$("#pinnedContainer");pinnedContainer.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.dataAvailble.pinned.moreAvailable&&fetchPinnedTaskCollection($scope.pinnedTasksCollection.length,20,!0)});var debugLogsContainer=$("#debugLogsContainer");debugLogsContainer.on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$scope.dataAvailble.logs.moreAvailable&&fetchDebugLogCollection($scope.debugLogsCollection.length,20,!0)}),initFirstTabData(),$scope.$emit("nestedComponentLoaded",{id:"analyze",flag:!1})}],link:function($scope,$ele,$attrs){}}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-app-create",[]);_module.controller("BTAppCreateCtrl",["$scope","$translator","$modalInstance","avalSreams","config","$filter","$rootScope","$routeParams","$timeout","$location","$workflowService","BTSeedDataService","NotificationService","BTAlertsService","BTActionsService","BTStreamsService","$applicationService","i18n","env_conf",function($scope,$translator,$modalInstance,avalSreams,config,$filter,$rootScope,$routeParams,$timeout,$location,$workflowService,BTSeedDataService,NotificationService,BTAlertsService,BTActionsService,BTStreamsService,$applicationService,i18n,env_conf){function maskStr(str){return Array(str.length).join("*")}$scope.config=config,$scope.categoryConfig={allowclear:!0,multiple:!0,placeholder:"Select Bots"},$scope.edit=i18n.i18nString("edit"),$scope.createNew=i18n.i18nString("create_new"),$scope.stream=$workflowService.selectedStream(),$scope.algthms=[{id:"RS256",label:"RS256"},{id:"HS256",label:"HS256"}],$scope.assetsBase=env_conf["assets-url"],$scope.jweEnforce={isJtiEnforced:!1,isJweEnforced:!1},$scope.init=function(){new Clipboard("[data-clipboard-target]");if($scope.selectedBots=[],$scope.availableBots=avalSreams,$scope.anonyChat=!0,$scope.newUser=!0,$scope.headerTitle=config.type,"Edit"===config.type&&$scope.loadApp(config.app),config.context&&"addChannel"===config.context){var _botIndex=$scope.selectedBots.indexOf(config.bot._id);0>_botIndex&&$scope.selectedBots.push(config.bot._id)}},$scope.createApplication=function(){var _params={},_urlParams={streamId:$workflowService.selectedStream()._id};_params.appName=$scope.appName,_params.algorithm=$scope.selectedAlg.id,"RS256"===_params.algorithm&&(_params.key=$scope.publicKey),_params.scope=[],$scope.anonyChat&&_params.scope.push("anonymouschat"),$scope.newUser&&_params.scope.push("registration"),_params.bots=$scope.selectedBots,_params.pushNotifications={enable:!1,webhookUrl:""},$scope.pushNotification&&(_params.pushNotifications.enable=!0,_params.pushNotifications.webhookUrl=$scope.pushUrl),$scope.saveInProgress=!0;var svcname="bt.apps.create";$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.create"),"Edit"===config.type&&(svcname="bt.apps.edit",$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.edit"),_urlParams.appId=config.app.clientId,_urlParams.streamId=$scope.stream._id),$scope.jweEnforce.isJtiEnforced?_params.isJtiEnforced=!0:_params.isJtiEnforced=!1,$scope.jweEnforce.isJweEnforced?_params.isJweEnforced=!0:_params.isJweEnforced=!1,$translator.translate(svcname,_urlParams,_params).then(function(res){if(res&&res.data&&200===res.status){$scope.saveInProgress=!1;var botsMap=_.indexBy($scope.availableBots,"_id"),bots=[];if(res.data.bots.forEach(function(botId){bots.push(botsMap[botId])}),res.data.bots=bots,$scope.appNameConfirm=res.data.appName,$scope.clientId=res.data.clientId,$scope.secretKey=res.data.clientSecret,$scope.secretKeyUI=maskStr($scope.secretKey),$rootScope.$emit("app.created"),config.context&&"addChannel"===config.context){var _msg="app.created";"Edit"===config.type&&(_msg="app.edited"),config.cb(_msg,res.data),$scope.closeModal()}else $scope.confirmApp=!0}else $scope.saveInProgress=!1,NotificationService.notify(i18n.i18nString("App_Already_Exists"),"error")},function(errRes){$scope.saveInProgress=!1,errRes&&errRes.data&&errRes.data.errors?errRes.data.errors.length&&"AppAlreadyExists"===errRes.data.errors[0].code?NotificationService.notify(i18n.i18nString("App_Already_Exists"),"error"):NotificationService.notify(errRes.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})},$scope.loadApp=function(app){$scope.appName=app.appName,$scope.jweEnforce={isJtiEnforced:app.isJtiEnforced,isJweEnforced:app.isJweEnforced},app.scope.indexOf("anonymouschat")<0&&($scope.anonyChat=!1),app.scope.indexOf("registration")<0&&($scope.newUser=!1),$scope.selectedAlg={id:app.algorithm,label:app.algorithm},$timeout(function(){"RS256"===app.algorithm&&($scope.publicKey=app.key)},100),app.pushNotifications&&($scope.pushNotification=app.pushNotifications.enable,$timeout(function(){app.pushNotifications.enable&&($scope.pushUrl=app.pushNotifications.webhookUrl)},100)),$scope.selectedBots=_.pluck(app.bots,"_id")},$scope.closeModal=function(){$modalInstance.close()},$scope.showHideSecret=function(){$scope.secretKeyUI=$scope.secretKey,$scope.secretKeyShown=!0},$scope.refreshSecretToken=function(){$scope.secretKeyInProgress=!0,$scope.secretKeyShown=!1;var svcname="bt.apps.regenerate.key";$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.regenerate.key"),$translator.translate(svcname,{appId:$scope.clientId,streamId:$workflowService.selectedStream()._id},{}).then(function(res){res&&res.data&&200===res.status?($scope.secretKey=res.data.clientSecret,$scope.secretKeyUI=maskStr($scope.secretKey),$scope.secretKeyInProgress=!1,$rootScope.$emit("app.updated")):($scope.secretKeyInProgress=!1,NotificationService.notify(i18n.i18nString("error_alert"),"error"))},function(errRes){$scope.secretKeyInProgress=!1,errRes&&errRes.data&&errRes.data.errors.length?NotificationService.notify(errRes.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("error_alert"),"error")})},$scope.init()}])}(angular),function(ng){"use strict";var _module=ng.module("bt-app-view",[]);_module.controller("BTAppViewCtrl",["$scope","$modalInstance","config",function($scope,$modalInstance,config){$scope.app=config.app,$scope.closeModal=function(){$modalInstance.close()}}])}(angular),function(ng){var _mod=ng.module("bt-bot-publish",[]);_mod.directive("btBotPublish",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-bot-publish/bt-bot-publish.html",controller:"BTBotPublishCtrl",scope:{onClose:"="}}}]),_mod.controller("BTBotPublishCtrl",["$scope","$rootScope","$q","env_conf","$routeParams","$location","$applicationService","$translator","BTAlertsService","BTActionsService","BTFlowtaskService","BTStreamsService","BTTeamsService","NotificationService","BTParamMapService","form_util","$workflowService","flowsUtil","$timeout","BTIdpService","BTFileUploadService","$element","localstore","i18n",function($scope,$rootScope,$q,env_conf,$routeParams,$location,$applicationService,$translator,BTAlertsService,BTActionsService,BTFlowtaskService,BTStreamsService,BTTeamsService,NotificationService,BTParamMapService,form_util,$workflowService,flowsUtil,$timeout,BTIdpService,BTFileUploadService,$element,localstore,i18n){function stepObject(id,name,active){this.name=name,this.id=id,this.active=active}function prepareStepsAndViews(){$scope.steps.push(new stepObject(1,"Define Deployment",!0)),"smartbot"===$scope.stream.publishType&&"samplebot"!==$scope.stream.publishType&&$scope.steps.push(new stepObject(3,"Enable Try Mode",!1)),$scope.steps.push(new stepObject(4,"Review & Confirm",!1))}function showStep(stepNo){tasksSelected()||(NotificationService.notify(i18n.i18nString("please_select_atleast_oneTask"),"warning"),stepNo=$scope.currentStep),$scope.currentStep=stepNo,$scope.steps.map(function(step,index){index===$scope.currentStep?step.active=!0:step.active=!1}),collectSelectedTasks()}function checkUpgrade(task){"l"===task._id[0]?BTAlertsService.checkUpgrade(task._id).then(function(res){
task.upgradeInfo=res.data,task.versionType="selectable"===task.upgradeInfo.versionChange?"minor":task.upgradeInfo.versionChange,task.upgradeType="mandatory"},function(err){console.log(err)}):"a"===task._id[0]?BTActionsService.checkUpgrade(task._id).then(function(res){task.upgradeInfo=res.data,task.versionType="selectable"===task.upgradeInfo.versionChange?"minor":task.upgradeInfo.versionChange,task.upgradeType="mandatory"},function(err){console.log(err)}):"d"===task._id[0]&&console.log("d")}function fetchFlows(task){var taskInfo;taskInfo=$scope.allTasks.filter(function(item){return item._id==task.parentId})[0],taskInfo&&("l"===task._id[0]?$q.all([BTParamMapService.getMappedAlerts(task._id,taskInfo.version),BTParamMapService.getMappedDialogs(task._id,taskInfo.version)]).then(function(res){task.flows=flowsUtil.arrangeFlows(res[0].data),task.flows=task.flows.concat(flowsUtil.arrangeFlows(res[1].data))},function(err){task.flows=[]}):"a"===task._id[0]?BTParamMapService.getMappedActions(task._id,taskInfo.version).then(function(res){task.flows=flowsUtil.arrangeFlows(res.data)},function(err){task.flows=[]}):"d"===task._id[0]&&BTParamMapService.getMappedDialogs(task.parentId,taskInfo.version).then(function(res){task.flows=flowsUtil.arrangeFlows(res.data)},function(err){task.flows=[]}))}function assignFlowsToTask(){$scope.alerts=$scope.alerts||[],$scope.actions=$scope.actions||[],$scope.dialogs=$scope.dialogs||[],$scope.alerts.map(function(alert){alert._selected=!0,alert.parentId&&(fetchFlows(alert),checkUpgrade(alert))}),$scope.actions.map(function(action){action._selected=!0,action.parentId&&(fetchFlows(action),checkUpgrade(action))}),$scope.dialogs.map(function(dialog){dialog._selected=!0,dialog.parentId&&($scope.configuredDialogFlowId=dialog._id,fetchFlows(dialog))})}function tasksSelected(){return collectSelectedTasks(),$scope.tasks.length>0}function collectSelectedTasks(){$scope.tasks=[],$scope.alerts=$scope.alerts||[],$scope.actions=$scope.actions||[],$scope.dialogs=$scope.dialogs||[],$scope.alerts.map(function(alert){alert.approvedLanguages=angular.copy(alert.approvedLanguagesCopy),alert.approvedLangString=convertToString(alert.approvedLanguages),alert._selected&&($scope.streamPublishInfo.published&&(alert.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),$scope.tasks.push(angular.copy(alert)))}),$scope.actions.map(function(action){action.approvedLanguages=angular.copy(action.approvedLanguagesCopy),action.approvedLangString=convertToString(action.approvedLanguages),action._selected&&($scope.streamPublishInfo.published&&(action.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),$scope.tasks.push(angular.copy(action)))}),$scope.dialogs.map(function(dialog){dialog.approvedLanguages=angular.copy(dialog.approvedLanguagesCopy),dialog.approvedLangString=convertToString(dialog.approvedLanguages),dialog._selected&&($scope.streamPublishInfo.published&&(dialog.namespaceTo=$scope.streamPublishInfo.visibility&&$scope.streamPublishInfo.visibility.namespace),$scope.tasks.push(angular.copy(dialog)))}),$scope.partialLanguageTasks=$scope.getPartialLanguageTasks($scope.tasks)||[]}function publishBotTasks(payload){$scope.messages=[];var service="smartbot"==$scope.stream.publishType?BTStreamsService.solutionPublish:BTStreamsService.standardPublish;"samplebot"===$scope.stream.publishType&&(service=BTStreamsService.sampleBotPublish),service($scope.stream._id,payload).then(function(res){function processTasks(){res.data.map(function(message){var _msg=taskMap[message.resourceId];void 0===_msg&&message.result&&message.result.name&&(_msg=message.result.name),"SUCCESS"===message.status?messages.push({type:"success",message:$scope.streamPublishInfo.enterprise?_msg:_msg+" "+i18n.i18nString("published_success")}):"FAILURE"===message.status&&messages.push({type:"error",error:getErrorMsg(message.result),message:_msg+" "+i18n.i18nString("publish_Failed"),context:getResource(payload,message.resourceId),taskId:message.resourceId})}),$scope.messages=messages,$scope.openModal()}$scope.publishInProgress=!1;var messages=[];processTasks()},function(err){$scope.publishInProgress=!1;var msg=err.data.errors[0].msg||i18n.i18nString("error_handle_msg");NotificationService.notify(msg,"error")})}function publishTasks(payload){if($scope.showVisibiltyForSmartBot()||(delete payload.isChat,delete payload.isMention),$scope.alertDialogMappingsToPublish.length){var alertDialogMappingPayloadPromise=[];$scope.alertDialogMappingsToPublish=_.uniq($scope.alertDialogMappingsToPublish),$.each($scope.alertDialogMappingsToPublish,function(i,flow){var promise=BTStreamsService.publishAlertDialogFlow(flow);alertDialogMappingPayloadPromise.push(promise)}),$q.all(alertDialogMappingPayloadPromise).then(function(results){publishBotTasks(payload)},function(err){publishBotTasks(payload)})}else publishBotTasks(payload)}function getErrorMsg(message){var msg=message&&message.errors&&message.errors[0].msg||i18n.i18nString("error_handle_msg");return msg}function getResource(publishInfo,id){var payload={},resource=publishInfo.resources.filter(function(resource){return resource.resourceId===id});return"smartbot"==$scope.stream.publishType&&(payload={botDesc:publishInfo.botDesc,configInst:publishInfo.configInst,configInstURL:publishInfo.configInstURL}),payload.resources=resource,payload}function verifyFlowsStatus(callback){var errorMsg,ok=!0,allFilled=!0,namespaceTo=!0,messages={flow:i18n.i18nString("please_verify_all_the_flows"),upgrade:i18n.i18nString("please_Fill_upgradecomments"),namespace:i18n.i18nString("please_select_the_destination")};($scope.tasks||[]).map(function(task){"l"===task._id[0]?task.parentId&&"manual"===task.upgradeInfo.upgrade?!task.parentId||task.upgradeShortMessage&&task.upgradeLongMessage&&task.upgradeVersionComment||(allFilled=!1,errorMsg=messages.upgrade,task.upgradeVersionComment&&(errorMsg=i18n.i18nString("please_fill_up_short_and_long"))):task.parentId&&"automatic"===task.upgradeInfo.upgrade&&(!task.parentId||task.upgradeShortMessage&&task.upgradeVersionComment||(allFilled=!1,errorMsg=messages.upgrade,task.upgradeVersionComment&&(errorMsg=i18n.i18nString("please_fill_up_short_msg")))):task.parentId&&!task.upgradeVersionComment&&(allFilled=!1,errorMsg=messages.upgrade),task.namespaceTo||task.parentId||(namespaceTo=task.namespaceTo,errorMsg=messages.namespace),(task.flows||[]).map(function(flow){"active"!=flow.state&&(ok=!1)})}),ok?allFilled&&namespaceTo?checkForMandatoryFieldsOfSolutionBot(callback):NotificationService.notify(errorMsg,"warning"):NotificationService.notify(messages.flow,"warning")}function checkForMandatoryFieldsOfSolutionBot(callback){var ok=!0;return"smartbot"===$scope.stream.publishType&&(ok=$scope.upgrade.description),ok?void checkForVersionTypeAndUpgrade(callback):void NotificationService.notify(i18n.i18nString("please_fill_up_all_required_fields"),"warning")}function checkForVersionTypeAndUpgrade(callback){var ok=!0;if(($scope.tasks||[]).map(function(task){task._id&&0===task._id.indexOf("dg-")||!task.parentId||task.upgradeType&&task.versionType||(ok=!1)}),!ok)return void NotificationService.notify(i18n.i18nString("please_upgrade_version_type_details"),"warning");if("smartbot"==$scope.stream.publishType)return void callback();if("smartbot"!==$scope.selectedStream.publishType&&"samplebot"!==$scope.selectedStream.publishType&&"public"===$scope.streamPublishInfo.namespaceTo&&!$scope.streamPublishInfo.botStoreSettingsCheck&&$rootScope.wfAdmin)return void NotificationService.notify(i18n.i18nString("please_check_to_confirm_bot_store_settings"),"warning");if("samplebot"===$scope.selectedStream.publishType&&!$scope.upgrade.description)return void NotificationService.notify(i18n.i18nString("please_add_bot_description"),"warning");var confirmationMessage="",botVisbilityMessage="";"employee"===$scope.stream.purpose?botVisbilityMessage=i18n.i18nString("you_are_about_to_publish")+" <b>"+$scope.getTextIncludingTags($scope.stream.name)+"</b> "+i18n.i18nString("for_use_by_selected_users"):"customer"===$scope.stream.purpose&&(botVisbilityMessage=i18n.i18nString("you_are_about_to_publish")+" <b>"+$scope.getTextIncludingTags($scope.stream.name)+"</b> "+i18n.i18nString("for_use_by_anonymous_users")),confirmationMessage="enterprise"===$scope.streamPublishInfo.namespaceTo?botVisbilityMessage:i18n.i18nString("you_are_about_to_publish")+" <b>"+$scope.getTextIncludingTags($scope.stream.name)+"</b> "+i18n.i18nString("into_kore_ai_bots_store"),window.bootbox.dialog({message:confirmationMessage,title:$scope.publishPageTitle(),className:"alert-modal",buttons:{success:{label:i18n.i18nString("no"),className:"btn-primary",callback:function(){}},main:{label:i18n.i18nString("yes"),className:"btn-primary",callback:function(){callback()}}},onEscape:function(){}})}function deleteMapping(flow,index,task){flow.targetResourceId?BTParamMapService.deleteMappedAlertDialog(flow.mapId).then(function(res){task.flows.splice(index,1),NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("flow_deleted_sucess"),"success")},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),i18n.i18nString("flow_deletion_failed"),"error")}):BTParamMapService.deleteMappedAlertAction(flow.mapId).then(function(res){task.flows.splice(index,1),NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("flow_deleted_sucess"),"success")},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),i18n.i18nString("flow_deletion_failed"),"error")})}function isAnyCommunicationModeSelected(){return $scope.upgrade.isChat||$scope.upgrade.isMention}function convertToString(approvedLanguages){return approvedLanguages&&approvedLanguages.length?approvedLanguages.length<=2?approvedLanguages.join(", "):approvedLanguages[0]+", "+approvedLanguages[1]+"<span class='ovalcountcircle'>+"+(approvedLanguages.length-2)+"</span>":""}$scope._constants_=$rootScope._constants_,$scope.stream=$workflowService.selectedStream(),$scope.seedSupportedLanguages=$workflowService.seedData().supportedLanguages,$scope.selectedStream=$scope.stream,$scope.stream.showInMp=$scope.stream.showInMp||!1,$scope.authLists=null,$scope.dataloaded=!1,$scope.needAuth=!1,$scope.isTryModeUpdated=!1,$scope.account=[],$scope.trymodecallback={},$scope.currentStep=0,$scope.steps=[],$scope.tryMode=!1,$scope.alertDialogMappingsToPublish=[],$scope.publishInProgress=!1;var currentUser=localstore.getAuthData().currentAccount;if($scope.alertTasks=i18n.i18nString("alertTasks_ready_for_deployment"),$scope.actionTasks=i18n.i18nString("actionTasks_ready_for_deployment"),$scope.dialogTasks=i18n.i18nString("dialogTasks_ready_for_deployment"),$scope.taskFlows=i18n.i18nString("tasks_and_flows"),$scope.upgradeLabel=i18n.i18nString("upgrade"),$scope.new_deployment_label=i18n.i18nString("new_deployment_label"),$scope.smart_bot_desc_label=i18n.i18nString("smart_bot_desc_label"),$scope.sample_bot_desc_label=i18n.i18nString("sample_bot_desc_label"),$scope.configuration_instructions_label=i18n.i18nString("configuration_instructions_label"),$scope.configuration_instructions_url=i18n.i18nString("configuration_instructions_url"),$scope.enabled=i18n.i18nString("enabled"),$scope.disabled=i18n.i18nString("disabled"),$scope.saving=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.smartBotDesc=i18n.i18nString("enter_desc_for_smartBot_placeholder"),$scope.sampleBotDesc=i18n.i18nString("sample_bot_desc_placeholder"),$scope.isDomainKore="kore"===currentUser.domain.split(".")[0],$scope.showVisibilty=function(){return $rootScope.wfAdmin&&"customer"===$scope.stream.purpose&&"standardbot"===$scope.stream.publishType&&!$scope.stream.isInMarket},$scope.showVisibiltyForSmartBot=function(){return $rootScope.wfAdmin&&"smartbot"===$scope.stream.publishType&&!$scope.stream.isInMarket&&$scope.isDomainKore},$scope.changeVisibility=function(){BTStreamsService.editStream($scope.stream._id,{showInMp:$scope.stream.showInMp}).then(function(response){$workflowService.selectedStream(angular.extend($scope.stream,response.data))},function(res){NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.bulbSvg=env_conf["context-url"]+"/assets/images/bulbicon.svg",prepareStepsAndViews(),$scope.btTestFormApi={},$scope.btTestStatus={},0===Object.keys($scope.stream).length)return void $location.path(window.appConfig.CONTEXT_PATH);$scope.upgrade={description:$scope.stream.botDesc,instructions:$scope.stream.configInst,instructionsURL:$scope.stream.configInstURL,botType:$scope.stream.botType||"solution",isChat:!0,isMention:!0},$scope.streamPublishInfo={published:!1,visibility:$scope.stream.visibility,enterprise:"enterprise"==$scope.stream.visibility.namespace||"enterpriseNpublic"==$scope.stream.visibility.namespace},$scope.streamPublishInfo.published=$rootScope.hasPublishedAlerts||$rootScope.hasPublishedActions||$rootScope.hasPublishedFlowtasks,$scope.isAuthorized=function(){return $rootScope.wfAdmin||window.localStorage.enablePublish},$scope.trymodecallback.showStep=showStep,$scope.stepClick=function(step){step-1>1&&!$scope.isTryModeUpdated&&"smartbot"===$scope.stream.publishType?$scope.trymodecallback.updateTryMode(step-1):showStep(step-1)},$scope.helpLink=$rootScope.helpLinks.DEPLOYMENTTAB_HELP,$scope.next=function(){var step=$scope.currentStep+1;$scope.helpLink=$rootScope.helpLinks.CONFIRMTAB_HELP,1===$scope.currentStep&&step>1?$scope.trymodecallback.updateTryMode(step):showStep(step)},$scope.back=function(){$scope.currentStep--},$scope.cancel=function(){$scope.onClose(!1)},$scope.getType=function(id){return"l"===id[0]?"Alert Task":"d"===id[0]?"Dialog Task":"Action Task"},$scope.assignDefaultPublishDestination=function(){"smartbot"==$scope.stream.publishType||"samplebot"==$scope.stream.publishType?($scope.streamPublishInfo.namespaceTo="public",$scope.streamPublishInfo.namespaceHide=!0):"smartbot"!=$scope.stream.publishType&&"samplebot"!==$scope.stream.publishType&&$rootScope.isManaged&&!$rootScope.wfAdmin?($scope.streamPublishInfo.namespaceTo="enterprise",$scope.streamPublishInfo.namespaceHide=!0):$scope.streamPublishInfo.published&&($scope.streamPublishInfo.namespaceHide=!0,$scope.streamPublishInfo.namespaceTo=$scope.streamPublishInfo.visibility.namespace),$scope.streamPublishInfo.namespaceTo="enterprise",$scope.tasks.map(function(task){task.namespaceTo=$scope.streamPublishInfo.namespaceTo})},$scope.allTasks=[],$scope.alerts=[],$scope.actions=[],$scope.dialogtask=[],$scope.mappings=[],$scope.alertLoading=!0,$scope.actionLoading=!0,$scope.dialogLoading=!0,$scope.loadingFlows=!0,$q.all([BTAlertsService.getAlerts($scope.stream._id),BTActionsService.getActions($scope.stream._id),BTFlowtaskService.getFlowtaks($scope.stream._id),BTStreamsService.getMappings($scope.stream._id)]).then(function(results){$scope.allTasks=$scope.allTasks.concat(results[0].data),$scope.allTasks=$scope.allTasks.concat(results[1].data),$scope.allTasks=$scope.allTasks.concat(results[2].data),$scope.alerts=results[0].data.filter(function(alert){return alert.supportedLanguages=_.map(_.union($scope.selectedStream.supportedLanguages,alert.approvedLanguages||[]),function(each){var slObject={};return alert.approvedLanguages=alert.approvedLanguages||[],0===alert.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(alert.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject}),alert.supportedLanguages=_.sortBy(alert.supportedLanguages,"selected"),alert.approvedLanguagesCopy=[],_.map(alert.supportedLanguages,function(lang){lang.selected&&alert.approvedLanguagesCopy.push(lang.value)}),alert.approvedLanguages=angular.copy(alert.approvedLanguagesCopy),alert.approvedLangString=convertToString(alert.approvedLanguagesCopy),"configured"===alert.state}),$scope.actions=results[1].data.filter(function(action){return action.supportedLanguages=_.map(_.union($scope.selectedStream.supportedLanguages,action.approvedLanguages||[]),function(each){var slObject={};return action.approvedLanguages=action.approvedLanguages||[],0===action.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(action.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject}),action.supportedLanguages=_.sortBy(action.supportedLanguages,"selected"),action.approvedLanguagesCopy=[],_.map(action.supportedLanguages,function(lang){lang.selected&&action.approvedLanguagesCopy.push(lang.value)}),action.approvedLanguages=angular.copy(action.approvedLanguagesCopy),action.approvedLangString=convertToString(action.approvedLanguagesCopy),"configured"===action.state}),$scope.dialogs=results[2].data.filter(function(dialog){return dialog.supportedLanguages=_.map(_.union($scope.selectedStream.supportedLanguages,dialog.approvedLanguages),function(each){var slObject={};return dialog.approvedLanguages=dialog.approvedLanguages||[],0===dialog.approvedLanguages.length?slObject.selected=!0:slObject.selected=!1,-1!==_.indexOf(dialog.approvedLanguages,each)&&(slObject.selected=!0,slObject.disable=!0),slObject.value=each,slObject}),dialog.supportedLanguages=_.sortBy(dialog.supportedLanguages,"selected"),dialog.approvedLanguagesCopy=[],_.map(dialog.supportedLanguages,function(lang){lang.selected&&dialog.approvedLanguagesCopy.push(lang.value)}),dialog.approvedLanguages=angular.copy(dialog.approvedLanguagesCopy),dialog.approvedLangString=convertToString(dialog.approvedLanguagesCopy),"configured"===dialog.state}),$scope.mappings=results[3].data,$scope.mappings=flowsUtil.arrangeFlows($scope.mappings),assignFlowsToTask(),$scope.alertLoading=!1,$scope.actionLoading=!1,$scope.dialogLoading=!1,$scope.loadingFlows=!1,$timeout(function(){PerfectScrollbar.update($element.find(".bot-publish[perfect-scroll]")[0])},300)},function(err){$scope.alerts=[],$scope.actions=[],$scope.mappings=[],$scope.alertLoading=!1,$scope.actionLoading=!1,$scope.loadingFlows=!1});var taskMap={};$scope.confirm=function(){function triggerPublish(){$scope.publishInProgress=!0;var payload={resources:[]};$scope.tasks.map(function(task){var parent;task.parentId&&(parent=$scope.allTasks.filter(function(item){return item._id===task.parentId})[0]||{}),task.approvedLanguagesCopy&&delete task.approvedLanguagesCopy;var taskUpgradeInfo={namespace:task.parentId?"enterpriseNpublic"==parent.visibility.namespace?"enterprise":task.namespaceTo:"enterpriseNpublic"==task.namespaceTo?"enterprise":task.namespaceTo,resourceId:task._id,namespaceIds:task.parentId?parent.visibility.namespaceIds:task.namespaceIds||[],resourceType:getType(task._id),upgradeShortMsg:task.upgradeShortMessage,upgradeLongMsg:task.upgradeLongMessage,versionComment:task.upgradeVersionComment,approvalRequestedLanguages:task.approvedLanguages};"enterprise"===taskUpgradeInfo.namespace?taskMap[task._id]=task.name:(taskMap[task.parentId?task.parentId:task._id]=task.name,taskMap[task._id]=task.name),task.parentId&&(taskUpgradeInfo.versionType=task.versionType,_.addProps(task.upgradeInfo&&"automatic"!==task.upgradeInfo.upgrade,taskUpgradeInfo,{upgradeType:task.upgradeType})),payload.resources.push(taskUpgradeInfo)}),("smartbot"==$scope.stream.publishType||"samplebot"==$scope.stream.publishType)&&($scope.upgrade.description&&(payload.botDesc=$scope.upgrade.description),"samplebot"==$scope.stream.publishType&&$scope.upgrade.instructions?payload.configInstFileId=$scope.upgrade.instructions:payload.configInst=$scope.upgrade.instructions,"smartbot"==$scope.stream.publishType&&$scope.upgrade.instructionsURL&&(payload.configInstURL=$scope.upgrade.instructionsURL)),"smartbot"==$scope.stream.publishType&&(payload.botType=$scope.upgrade.botType,$scope.isDomainKore||(payload.botType="enterprise"),"workplacefb"===$scope.upgrade.botType&&(payload.isChat=$scope.upgrade.isChat,payload.isMention=$scope.upgrade.isMention)),publishTasks(payload)}function getType(id){return"l"==id[0]?"alert":"d"==id[0]?"dialog":"action"}verifyFlowsStatus(triggerPublish)},$scope.getTextIncludingTags=function(name){return name.escapeHTML()},String.prototype.escapeHTML=function(){var escapeTokens={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"},htmlTags=/[<>"']/g;return(""+this).replace(htmlTags,function(match){return escapeTokens[match]})},$scope.openModal=function(){$("#errorMsgStatus").modal({backdrop:"static",show:!0})},$scope.closeModal=function(){$("#errorMsgStatus").modal("hide"),$timeout(function(){$("body").removeClass("modal-open")}),$scope.onClose(!0)},$scope.retry=function(payload){var service="smartbot"==$scope.stream.publishType?BTStreamsService.solutionPublish:BTStreamsService.standardPublish;service($scope.stream._id,payload.context).then(function(res){var messages=[];res.data.map(function(message){var _msg=taskMap[message.resourceId];void 0===_msg&&message.result&&message.result.name&&(_msg=message.result.name),"SUCCESS"===message.status?messages.push({type:"success",taskId:message.resourceId,message:_msg+" "+i18n.i18nString("published_success")}):"FAILURE"===message.status&&messages.push({type:"error",error:getErrorMsg(message.result),message:_msg+" "+i18n.i18nString("publish_Failed"),context:getResource(payload.context,message.resourceId),taskId:message.resourceId})}),messages.map(function(message){var msgIndex=_.findIndex($scope.messages,{taskId:message.taskId});-1!==msgIndex&&($scope.messages[msgIndex]=message)})},function(err){var msg=err.data.errors[0].msg||i18n.i18nString("error_handle_msg");NotificationService.notify(msg,"error")})},$scope.showBTStoreSettingsModal=!1,$scope.bssCallback={},$scope.openBotStoreSettingsModal=function(){$scope.showBTStoreSettingsModal=!0,$(".botStoreSettingsModal").modal("show"),$timeout(function(){$scope.bssCallback.loadGeneralSettings()})},$scope.closeBotStoreSettingsModal=function(){$scope.showBTStoreSettingsModal=!1,$(".botStoreSettingsModal").modal("hide")},$scope.retryAll=function(){var payload={resources:[]},publishInfo=$scope.messages.filter(function(message){return"error"===message.type});"smartbot"==$scope.stream.publishType&&(payload={botDesc:publishInfo[0].context.botDesc,configInst:publishInfo[0].context.configInst,configInstURL:publishInfo[0].context.configInstURL,resources:[]}),publishInfo.map(function(info){payload.resources.push(info.context.resources[0])}),publishTasks(payload)},$scope.deleteMapping=function(){NotificationService.alert(i18n.i18nString("you_really_want_to_delete_this_flow"),deleteMapping,arguments)},$scope.updateMapping=function(flow){flow.targetResourceId?BTStreamsService.validateAlertDialogFlow(flow.mapId,$scope.configuredDialogFlowId).then(function(res){$scope.alertDialogMappingsToPublish.push(flow.mapId)},function(err){console.log(err),flow.state=!1}):BTStreamsService.publishFlow(flow.mapId).then(function(res){},function(err){console.log(err),flow.state=!1})},$scope.$watch("upgrade.isChat",function(newVal,oldVal){isAnyCommunicationModeSelected()||(NotificationService.notify(i18n.i18nString("atleast_one_communication_mode"),"warning"),$scope.upgrade.isChat=oldVal)}),$scope.$watch("upgrade.isMention",function(newVal,oldVal){isAnyCommunicationModeSelected()||(NotificationService.notify(i18n.i18nString("atleast_one_communication_mode"),"warning"),$scope.upgrade.isMention=oldVal)}),$scope.changeWorkPlaceCommunication=function(){},$scope.publishPageTitle=function(){return"smartbot"===$scope.selectedStream.publishType?i18n.i18nString("deploySmartBot"):"samplebot"===$scope.selectedStream.publishType?i18n.i18nString("deploySampleBot"):i18n.i18nString("deployStandardBot")},$scope.updateFooterHeader=function(){return $scope.footerInfoTitle=i18n.i18nString("publishing_tasks"),$scope.footerHeaderId="bt-botpublish",$scope.footerPanelId="bt-botpublish-panel",$scope.nameDescription=i18n.i18nString("after_you_have_defined_and_saved"),!0},$scope.uploadInstructionsDocument=function(){if($scope.upgrade.instructionsFile.name){var _ext=$scope.upgrade.instructionsFile.name.substring($scope.upgrade.instructionsFile.name.lastIndexOf("."));if(".pdf"!==_ext)return NotificationService.notify(i18n.i18nString("upload_only_pdf_files"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1,$scope.upgrade.instructionsFileName=$scope.upgrade.instructionsFile.name;var data=new FormData;data.append("file",$scope.upgrade.instructionsFile),data.append("fileContext","workflows"),data.append("fileExtension","pdf"),$scope.fileUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){$scope.upgrade.instructions=response.data.fileId,NotificationService.notify($scope.upgrade.instructionsFile.name+i18n.i18nString("uploaded_label_spaced"),"success"),$scope.fileUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.fileUploading=!1})},$scope.addLanguage=function(e,language,task){language.selected?(language.selected=!0,task.approvedLanguagesCopy.push(language.value),task.approvedLanguages.push(language.value)):(language.selected=!1,task.approvedLanguagesCopy.splice(_.indexOf(task.approvedLanguagesCopy,language.value),1),task.approvedLanguages.splice(_.indexOf(task.approvedLanguages,language.value),1)),task.approvedLangString=convertToString(task.approvedLanguages),task._selected=!0;var _selectedLanguages=task.supportedLanguages.filter(function(lang){return lang.selected}),_defaultApprovedLanguages=task.supportedLanguages.filter(function(lang){return lang.disable});_selectedLanguages&&0===_selectedLanguages.length&&"published"!==task.state&&0===_defaultApprovedLanguages.length&&(task._selected=!1)},$scope.editTask=function(e,task){var _defaultApprovedLanguages=task.supportedLanguages.filter(function(lang){return lang.disable});if(task._selected&&"published"!==task.state&&0===_defaultApprovedLanguages.length)for(var i=0;i<task.supportedLanguages.length;i++)task.supportedLanguages[i].selected=!0,$scope.addLanguage(e,task.supportedLanguages[i],task);else if("published"!==task.state&&0===_defaultApprovedLanguages.length)for(var j=0;j<task.supportedLanguages.length;j++)task.supportedLanguages[j].selected=!1,$scope.addLanguage(e,task.supportedLanguages[j],task)},$scope.getNameByValue=function(langValueString,task){if(!langValueString)return"";var langvalueArray=task.approvedLanguages,langNames=_.map(langvalueArray,function(langValue){var langObject=_.find($scope.seedSupportedLanguages,{value:langValue});return langObject.name});return langNames},$scope.getPartialLanguageTasks=function(tasks){var filteredTasks=_.filter(tasks,function(task){return task.approvedLanguages.length!==task.supportedLanguages.length});return filteredTasks}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-changelog",[]);_module.controller("BTChangeLogCtrl",["$scope","_constants_","$workflowService","$location","$timeout","BTStreamsService","i18n",function($scope,_constants_,$workflowService,$location,$timeout,BTStreamsService,i18n){return $scope._constants_=_constants_,$scope.stream=$workflowService.selectedStream(),$scope.logs=[],$scope.loading=!1,$scope.currentPage=1,0===Object.keys($scope.stream).length?void $location.path(window.appConfig.CONTEXT_PATH):($scope.getChanageLogs=function(){$scope.loading=!0,BTStreamsService.getChangeLog($scope.stream._id).then(function(res){$scope.logs=res.data.btlogs.map(function(log){return log.created=new Date(log.createdOn).toLocaleString(),log.username=_.isObject(log.userId)?log.userId.firstName+" "+log.userId.lastName:log.userId,log}),$scope.loading=!1},function(err){$scope.logs=[],$scope.loading=!1})},$scope.getChanageLogs(),void($scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)}))}])}(angular),function(ng){"use strict";var _module=ng.module("bt-chat-settings",[]);_module.controller("BTChatSettings",["$scope","_constants_","$workflowService","$location","$timeout","BTStreamsService",function($scope,_constants_,$workflowService,$location,$timeout,BTStreamsService){function goBack(){$location.path(window.appConfig.CONTEXT_PATH)}return $scope._constants_=_constants_,$scope.views={utterances:!1,chatVerify:!1,intentEntity:!0,settings:!1,synonyms:!1,patterns:!1,chatResponse:!1,chatHistory:!1,logs:!1,failedScenarios:!1},$scope._constants_.config.UTTERANCES&&($scope.views.utterances=!0,$scope.views.intentEntity=!1),$scope.stream=$workflowService.nlpStream(),$scope.tasks=[],!_.isObject($scope.stream)||_.isObject($scope.stream)&&0===Object.keys($scope.stream).length?void goBack():($scope.navigate=function(view){Object.keys($scope.views).map(function(view){$scope.views[view]=!1}),$scope.views[view]=!0},$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.goBack=goBack,void($scope._constants_.config.UTTERANCES?$scope.navigate("utterances"):$scope.navigate("intentEntity")))}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btContainmentDashboard",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-containment-dashboard/bt-containment-dashboard.html",controller:"btContainmentDashBoardController"}}),_module.controller("btContainmentDashBoardController",["$scope","$window","$workflowService","$element","$location","$sce",function($scope,$window,$workflowService,$element,$location,$sce){$scope.stream=$workflowService.selectedStream(),window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.containmentDashBoadUrl=$sce.trustAsResourceUrl("http://localhost:4200/analytics/containment/"+$scope.stream._id):$scope.containmentDashBoadUrl=window.appConfig.API_SERVER_URL+"/analytics/containment/"+$scope.stream._id;var iframe=$("#containmentDashBoardFrame");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")})})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btCustomDashboard",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-custom-dashboard/bt-custom-dashboard.html",controller:"btCustomDashBoardController"}}),_module.controller("btCustomDashBoardController",["$scope","$window","$workflowService","$element","$location","$sce",function($scope,$window,$workflowService,$element,$location,$sce){$scope.stream=$workflowService.selectedStream(),window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.customDashBoadUrl=$sce.trustAsResourceUrl("http://localhost:4200/analytics/customdashboard/"+$scope.stream._id):$scope.customDashBoadUrl=window.appConfig.API_SERVER_URL+"/analytics/customdashboard/"+$scope.stream._id;var iframe=$("#customDashBoardFrame");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")})})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btDashboard",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-dashboard/bt-dashboard.html",controller:"botDashBoardController"}}),_module.controller("botDashBoardController",["$scope","$window","$workflowService","$element","$location","_constants_","BTStreamsService","$timeout","$routeParams","NotificationService","$modal","env_conf","$q","BTSeedDataService","$filter","BTIdpService","$translator","$rootScope","$applicationService","$endpoints","channelsConfig","i18n",function($scope,$window,$workflowService,$element,$location,_constants_,BTStreamsService,$timeout,$routeParams,NotificationService,$modal,env_conf,$q,BTSeedDataService,$filter,BTIdpService,$translator,$rootScope,$applicationService,$endpoints,channelsConfig,i18n){function importModalSliderOpen(){$timeout(function(){$scope.modalSlider.open("#universalBotDashSlider")},500)}function importModalSliderClose(){$timeout(function(){$scope.modalSlider.close("#universalBotDashSlider");
},500)}function getStream(){BTStreamsService.getBTStream($workflowService.selectedStream()._id).then(function(res){$scope.botName=res.data.name},function(error){console.error("getStreams Failed",error)})}function tasksMetrics(){var channels=$scope.selectedChannels.toString(),languages=$scope.selectedLangauges.toString(),payload={};payload.filters={},payload.filters.tags=$scope.filterComponent.tags,payload.filters.sessionCategory=$scope.selectedSessionFilter;var errorHandle=function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")};"universalbot"===$scope.stream.type?BTStreamsService.tasksMetricsUniversal($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),"organization,task",channels,"",$scope.selectedLinkedBots.toString(),languages,"-1",payload).then(function(res){$scope.checkDockStatus()},errorHandle):BTStreamsService.tasksMetrics($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),"organization,task",channels,"",languages,"-1",payload).then(function(res){$scope.checkDockStatus()},errorHandle)}function agentTransferMetrics(){var channels=$scope.selectedChannels.toString(),languages=$scope.selectedLangauges.toString(),dimension="task",payload={};payload.filters={},payload.filters.tags=$scope.filterComponent.tags,payload.filters.sessionCategory=$scope.selectedSessionFilter;var errorHandle=function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")};"universalbot"===$scope.stream.type?BTStreamsService.agentTransferMetricsUniversal($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),dimension,channels,"",$scope.selectedLinkedBots.toString(),languages,payload).then(function(res){$scope.checkDockStatus()},errorHandle):BTStreamsService.agentTransferMetrics($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),dimension,channels,"",languages,payload).then(function(res){$scope.checkDockStatus()},errorHandle)}function fetchDataFromServer(){var dimension="organization,date_day";"24hours"===$scope.selectedRange&&(dimension="organization,date_hour");var channels=$scope.selectedChannels.toString(),languages=$scope.selectedLangauges.toString(),payload={};payload.filters={},payload.filters.tags=$scope.filterComponent.tags,payload.filters.sessionCategory=$scope.selectedSessionFilter,$scope.dashboardLoading=!0,$scope.groupbarChartLoading=!0,$scope.taskCompletionLoading=!0;var errorHandleDashboardCount=function(error){if($scope.dashboardLoading=!1,$scope.groupbarChartLoading=!1,$scope.taskCompletionLoading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")};"universalbot"===$scope.stream.type?BTStreamsService.dashboardChatsUniversal($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),dimension,channels,"",$scope.selectedLinkedBots.toString(),languages,payload).then(function(res){$scope.checkDockStatus()},errorHandleDashboardCount):(BTStreamsService.dashboardCharts($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),dimension,channels,"",languages,payload).then(function(res){$scope.checkDockStatus()},errorHandleDashboardCount),BTStreamsService.dashboardCount($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),dimension,channels,"",languages,payload).then(function(res){$scope.checkDockStatus()},errorHandleDashboardCount));var errorHandleSessionsCount=function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")};"universalbot"===$scope.stream.type?BTStreamsService.sessionsCountUniversal($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),channels,$scope.selectedLinkedBots.toString(),languages,payload).then(function(res){responseHandleSessionsCount(res)},errorHandleSessionsCount):BTStreamsService.sessionsCount($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),channels,languages,payload).then(function(res){responseHandleSessionsCount(res)},errorHandleSessionsCount);var errorHandleChannelsMetrics=function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")};"universalbot"===$scope.stream.type?BTStreamsService.channelsMetricsUniversal($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,"channels",$scope.start.toISOString(),$scope.end.toISOString(),$scope.selectedLinkedBots.toString(),payload).then(function(res){$scope.checkDockStatus()},errorHandleChannelsMetrics):BTStreamsService.channelsMetrics($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,"channels",$scope.start.toISOString(),$scope.end.toISOString(),payload).then(function(res){$scope.checkDockStatus()},errorHandleChannelsMetrics)}function performingBotsDashboard(){var dimension="organization,linkedbot",channels=$scope.selectedChannels.toString(),languages=$scope.selectedLangauges.toString();BTStreamsService.performingBotsUniversal($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),dimension,channels,"",$scope.selectedLinkedBots.toString(),languages).then(function(res){$scope.checkDockStatus()},function(err){console.log(err)})}function sessionsGraph(){var channels=$scope.selectedChannels.toString(),languages=$scope.selectedLangauges.toString(),payload={};payload.filters={},payload.filters.tags=$scope.filterComponent.tags,payload.filters.sessionCategory=$scope.selectedSessionFilter,$scope.dashboardLoading=!0;var responseHandle=function(res){res&&res.data&&($scope.dashboardLoading=!1,$scope.sessionsGraphData=res.data)},errorHandle=function(error){if($scope.dashboardLoading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")};"universalbot"===$scope.stream.type?BTStreamsService.sessionsGraphUniversal($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),sessionInterval,channels,$scope.selectedLinkedBots.toString(),languages,payload).then(responseHandle,errorHandle):BTStreamsService.sessionsGraph($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),sessionInterval,channels,languages,payload).then(responseHandle,errorHandle)}function intentGraphData(){var payload={},payload1={},channels=$scope.selectedChannels.toString(),languages=$scope.selectedLangauges.toString();payload.type="successintent",payload.filters={from:$scope.start.toISOString(),to:$scope.end.toISOString(),isDeveloper:!1},channels&&channels.length&&(payload.filters.channel=channels),languages&&languages.length&&(payload.filters.language=[],payload.filters.language=$scope.selectedLangauges),""!==$scope.selectedLinkedBots.toString()?($element.find(".pieGraphContainer").css("visibility","hidden"),payload.filters.linkedBotId=angular.copy($scope.selectedLinkedBots)):$element.find(".pieGraphContainer").css("visibility","visible"),payload1=angular.copy(payload),payload1.type="failintent",payload.filters.tags=$scope.filterComponent.tags,payload1.filters.tags=$scope.filterComponent.tags,payload.filters.sessionCategory=$scope.selectedSessionFilter,payload1.filters.sessionCategory=$scope.selectedSessionFilter,$q.all([$translator.translate("bt.post.getRecordsCount",{streamId:$workflowService.selectedStream()._id,offset:0,limit:10},payload),$translator.translate("bt.post.getRecordsCount",{streamId:$workflowService.selectedStream()._id,offset:0,limit:10},payload1)]).then(function(res){$scope.pieChartSucess=res[0].data.totalCount,$scope.pieChartFailed=res[1].data.totalCount,$scope.tasksStats.intentSucess=res[0].data.totalCount,$scope.tasksStats.intentFailed=res[1].data.totalCount,drawPieChartNew()},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function drawBarGraph(graphData){$scope.barGraphAvailable=!1,setTimeout(function(){var margin={top:20,right:20,bottom:30,left:60},width=$element.find(".bar-graph").width()-margin.left-margin.right,height=320-margin.top-margin.bottom;d3.timeParse("%d-%b-%y %H:%M:%S");$element.find(".bar-graph").html("");var svg=d3.select(".bar-graph").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),barDate="",dateFormat="",dataset=[],dataset1=[],dataset2=[],obj={};if(graphData)dataset=graphData;else{var i;for(i=0;i<$scope.tasksStats.taskBarGraph.length;i++)dateFormat=$scope.tasksStats.barGraphDate[i].toUpperCase(),barDate="7days"===$scope.selectedRange||"custom"===$scope.selectedRange?moment.parseZone(dateFormat).format("DD-MMM"):moment(dateFormat).format("HH:mm"),obj={x:barDate,y:$scope.tasksStats.taskBarGraph[i],y0:0},dataset1.push(obj);for(i=0;i<$scope.tasksStats.queriesTotal.length;i++)dateFormat=$scope.tasksStats.barGraphDate[i].toUpperCase(),barDate="7days"===$scope.selectedRange||"custom"===$scope.selectedRange?moment.parseZone(dateFormat).format("DD-MMM"):moment(dateFormat).format("HH:mm"),obj={x:barDate,y0:$scope.tasksStats.taskBarGraph[i],y:$scope.tasksStats.queriesTotal[i]},dataset2.push(obj);dataset.push(dataset1),dataset.push(dataset2)}if(0===dataset[0].length&&0===dataset[1].length||0===$scope.tasksStats.tasksPerformedTotal)$scope.barGraphAvailable=!0,dataset=[];else{var x=d3.scaleBand().range([30,width]).padding(.1);x.domain(dataset[0].map(function(d){return d.x}));var y=d3.scaleLinear().domain([0,d3.max(dataset,function(d){return d3.max(d,function(d){return d.y0+d.y})})]).range([height,0]),colors=["#28A745","#E4E5E7"],yAxis=d3.axisLeft().scale(y).ticks(5).tickSize(-width,0,0).tickFormat(function(d){return d}),xAxis=null;if("7days"===$scope.selectedRange)xAxis=d3.axisBottom().scale(x);else if("24hours"===$scope.selectedRange)xAxis=d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%2===0})).scale(x);else{var xAxisDataLength=x.domain().length;xAxis=xAxisDataLength>16&&33>xAxisDataLength?d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%4===0})).scale(x):xAxisDataLength>32&&49>xAxisDataLength?d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%5===0})).scale(x):xAxisDataLength>48&&65>xAxisDataLength?d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%6===0})).scale(x):xAxisDataLength>64&&90>xAxisDataLength?d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%7===0})).scale(x):xAxisDataLength>89?d3.axisBottom().tickValues(x.domain().filter(function(d,i){return i%8===0})).scale(x):d3.axisBottom().scale(x)}d3.select(".bar-graph").append("div");svg.append("g").attr("class","y axis").call(yAxis),svg.append("g").attr("class","x axis").attr("transform","translate(0,0)").attr("transform","translate(0,"+(height+5)+")").call(xAxis);var divTooltip=d3.select(".bar-graph").append("div").attr("class","barTooltip"),groups=svg.selectAll("g.cost").data(dataset).enter().append("g").attr("class","cost").style("fill",function(d,i){return colors[i]});groups.selectAll("rect").data(function(d){return d}).enter().append("rect").attr("x",function(d){return x(d.x)}).attr("y",function(d){return y(d.y0+d.y)}).attr("height",function(d){return y(d.y0)-y(d.y0+d.y)}).attr("width",x.bandwidth()-2).on("mousemove",function(d){var _condition,_color=d3.select(this).style("fill");"rgb(228, 229, 231)"===_color?_condition="faq":"rgb(40, 167, 69)"===_color&&(_condition="tasks");var _calValue,_calName;if("faq"===_condition){var postiveVal=d.y;_calValue=postiveVal,_calValue=0>postiveVal?-1*postiveVal:postiveVal,_calName=i18n.i18nString("faqs")}else _calValue=d.y-d.y0,_calName=i18n.i18nString("Tasks_and_languages_label");divTooltip.style("opacity",.9),divTooltip.style("display","inline-block"),divTooltip.html("<div class='title tasksAndFaqTooltipData'>"+_calName+"<div/><div class='sub-title' style='color:#009dab'>"+_calValue+"</div>").style("left",d3.event.pageX-$(".bar-graph").offset().left+25+"px").style("top",d3.event.pageY-$(".bar-graph").offset().top-60+"px")}).on("mouseout",function(d){divTooltip.style("opacity",0)})}},0)}function drawLineGraph(graphData){var xAxis,margin={top:30,right:40,bottom:30,left:50},width=$element.find(".graph-container").width()-margin.left-margin.right,height=350-margin.top-margin.bottom,x=d3.scaleTime().range([0,width]),y0=d3.scaleLinear().range([height,0]),y1=d3.scaleLinear().range([height,0]),xAxisTicks=$scope.dashboardCounts.results.length,xCount=1;xCount=14>xAxisTicks?1:27>xAxisTicks?2:40>xAxisTicks?3:53>xAxisTicks?4:66>xAxisTicks?5:79>xAxisTicks?6:7,xAxis="24hours"===$scope.selectedRange?d3.axisBottom().scale(x).ticks(8):d3.axisBottom().scale(x).ticks(d3.timeDay.every(xCount)).tickFormat(d3.timeFormat("%b %d"));var yAxisLeft=d3.axisLeft().scale(y0).tickSizeInner(-width).tickSizeOuter(0).tickPadding(5),yAxisRight=d3.axisRight().scale(y1).tickSizeInner(-width).tickSizeOuter(0).tickPadding(5),valueline=d3.line().x(function(d){return x(d.date)}).y(function(d){return y0(d.close)});valueline.curve(d3.curveMonotoneX);var valueline2=d3.line().x(function(d){return x(d.date)}).y(function(d){return y1(d.open)});valueline2.curve(d3.curveMonotoneX),$element.find(".graph-container").html("");var svg=d3.select(".graph-container").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");$scope.linechartAvailable=!0;var data=[];if(graphData)data=graphData;else{var sessionObj={};"24hours"===$scope.selectedRange?(date_type_chart="date_hour",$scope.sessionsGraphData.modifiedResult.forEach(function(val,ind){var currDate=new Date(val.date.toUpperCase());sessionObj[currDate.getTime()]=val.botSessions})):(date_type_chart="date_day",$scope.sessionsGraphData.modifiedResult.forEach(function(val,ind){var currDate=moment(new Date(val.date)).format("DD-MMM-YY");sessionObj[currDate]=val.botSessions})),$scope.dashboardCounts.results=$scope.dashboardCounts.results||[];var dateFormat1,currDate2;$scope.dashboardCounts.results.forEach(function(res,ind){"24hours"===$scope.selectedRange?(date_type_chart="date_hour",dateFormat1=new Date(res[date_type_chart].toUpperCase()),currDate2=dateFormat1.getTime(),data.push({date:dateFormat1,close:Number(res.noOfChats),open:Number(void 0===sessionObj[currDate2]?0:sessionObj[currDate2])})):(dateFormat1=new Date(res[date_type_chart]),currDate2=moment(dateFormat1).format("DD-MMM-YY"),dateFormat1.setHours("00"),dateFormat1.setMinutes("00"),data.push({date:dateFormat1,close:Number(res.noOfChats),open:Number(void 0===sessionObj[moment(dateFormat1).format("DD-MMM-YY")]?0:sessionObj[moment(dateFormat1).format("DD-MMM-YY")])}))});var chatObj={};$scope.dashboardCounts.results.forEach(function(stat,ind){var dateFormat2=new Date(stat[date_type_chart].toUpperCase()),date2="24hours"===$scope.selectedRange?dateFormat2.getTime():moment(dateFormat2).format("DD-MMM-YY");chatObj[date2]=stat.noOfChats}),"24hours"===$scope.selectedRange?$scope.sessionsGraphData.modifiedResult.forEach(function(val,ind){var dateFormat1=new Date(val.date.toUpperCase()),currDate2=dateFormat1.getTime();chatObj.hasOwnProperty(currDate2)||data.push({date:dateFormat1,close:Number(0),open:Number(val.botSessions)})}):$scope.sessionsGraphData.modifiedResult.forEach(function(val,ind){var dateFormat1=new Date(val.date.toUpperCase()),currDate2=moment(dateFormat1).format("DD-MMM-YY");"24hours"!==$scope.selectedRange&&(dateFormat1.setHours("00"),dateFormat1.setMinutes("00")),chatObj.hasOwnProperty(currDate2)||data.push({date:dateFormat1,close:Number(0),open:Number(val.botSessions)})}),data.sort(function(x,y){var date1=new Date(x.date),date2=new Date(y.date);return date1-date2})}if(0===data.length&&($scope.linechartAvailable=!1),data.length){data.forEach(function(d){d.date=d.date,d.close=+d.close,d.open=+d.open}),x.domain(d3.extent(data,function(d){return d.date}));var y0Max=d3.max(data,function(d){return Math.max(d.close)});y0.domain([0,y0Max]);var y1Max=d3.max(data,function(d){return Math.max(d.open)});y1.domain([0,y1Max]),yAxisLeft.tickValues([0,1*y0Max/5,2*y0Max/5,3*y0Max/5,4*y0Max/5,5*y0Max/5]),yAxisRight.tickValues([0,1*y1Max/5,2*y1Max/5,3*y1Max/5,4*y1Max/5,5*y1Max/5]),svg.append("g").attr("class","xAxis").attr("transform","translate(0,"+height+")").call(xAxis),svg.append("g").attr("class","ySideLeft").call(yAxisLeft),svg.append("g").attr("class","ySideRight").attr("transform","translate("+width+" ,0)").call(yAxisRight);var path0=svg.append("path").data([data]).style("stroke","#009dab").style("fill","none").style("stroke-width","4px").attr("class","chartsLine").attr("d",valueline),totalLength0=path0.node().getTotalLength();path0.attr("stroke-dasharray",totalLength0+" "+totalLength0).attr("stroke-dashoffset",totalLength0).transition().duration(1e3).attr("stroke-dashoffset",0);var path1=svg.append("path").data([data]).style("stroke","#f97300").style("fill","none").style("stroke-width","2px").attr("class","sessionsLine").attr("d",valueline2),totalLength1=path1.node().getTotalLength();path1.attr("stroke-dasharray",totalLength1+" "+totalLength1).attr("stroke-dashoffset",totalLength1).transition().duration(1e3).attr("stroke-dashoffset",0),setTimeout(function(){var div=d3.select(".graph-container").append("div"),circles0=svg.selectAll("g1.dot").data(data).enter().append("g");circles0.append("circle").attr("cx",function(d,i){return x(d.date)}).attr("cy",function(d,i){return y0(d.close)}).attr("r",5).attr("class","chartsCircle").style("fill","#fff"),circles0.append("circle").attr("cx",function(d,i){return x(d.date)}).attr("cy",function(d,i){return y0(d.close)}).attr("r",4).attr("class","chartsCircle").style("fill","#009dab").on("mouseover",function(d){div.transition().duration(200).style("opacity",.9).style("position","absolute"),div.html("<div class='title chartsAndSessionsTooltipData'>"+i18n.i18nString("noofmsgs")+"<div/><div class='sub-title' style='color:#009dab'>"+d.close+"</div>").style("left",d3.event.pageX-$("g").offset().left+"px").style("top",d3.event.pageY-$("g").offset().top-45+"px")}).on("mouseout",function(d){div.transition().duration(500).style("opacity",0)});var circles1=svg.selectAll("g1.dot").data(data).enter().append("g");circles1.append("circle").attr("cx",function(d,i){return x(d.date)}).attr("cy",function(d,i){return y1(d.open)}).attr("r",5).attr("class","sessionsCircle").style("fill","#fff"),circles1.append("circle").attr("cx",function(d,i){return x(d.date)}).attr("cy",function(d,i){return y1(d.open)}).attr("r",4).attr("class","sessionsCircle").style("fill","#eaa724").on("mouseover",function(d){div.transition().duration(1e3).style("opacity",.9).style("display","inline-block").style("position","absolute"),div.html("<div class='title chartsAndSessionsTooltipData'>No.of Conversations<div/><div class='sub-title' style='color:#b47700'>"+d.open+"</div>").style("left",d3.event.pageX-$("g").offset().left-10+"px").style("top",d3.event.pageY-$("g").offset().top-45+"px")}).on("mouseout",function(d){div.transition().duration(200).style("opacity",0)})},1e3)}}function groupBarChart(){$element.find(".groupbar-chart").html(""),$scope.linechartAvailable=!0;var data=[],sessionObj={},chatObj={},chatData=$scope.dashboardCounts.results;"24hours"===$scope.selectedRange?(date_type_chart="date_hour",$scope.sessionsGraphData.modifiedResult&&$scope.sessionsGraphData.modifiedResult.forEach(function(val,ind){var currDate=val.date.toUpperCase();sessionObj[currDate]={a:val.noOfInteractiveSessions,b:val.noOfNonInteractiveSessions}})):(date_type_chart="date_day",$scope.sessionsGraphData.modifiedResult&&$scope.sessionsGraphData.modifiedResult.forEach(function(val,ind){var currDate=val.date.toUpperCase();sessionObj[currDate]={a:val.noOfInteractiveSessions,b:val.noOfNonInteractiveSessions}})),chatData.forEach(function(stat,ind){var dateFormat=stat[date_type_chart].toUpperCase();data.push({date:dateFormat,close:Number(stat.noOfChats),open:void 0===sessionObj[dateFormat]?{a:0,b:0}:sessionObj[dateFormat]})}),chatData.forEach(function(stat,ind){var dateFormat=stat[date_type_chart].toUpperCase();chatObj[dateFormat]=stat.noOfChats}),"24hours"===$scope.selectedRange?$scope.sessionsGraphData.modifiedResult&&$scope.sessionsGraphData.modifiedResult.forEach(function(val,ind){var dateFormat=val.date.toUpperCase();chatObj.hasOwnProperty(dateFormat)||data.push({date:dateFormat,close:Number(0),open:{a:val.noOfInteractiveSessions,b:val.noOfNonInteractiveSessions}})}):$scope.sessionsGraphData.modifiedResult&&$scope.sessionsGraphData.modifiedResult.forEach(function(val,ind){var dateFormat13=val.date.toUpperCase();chatObj.hasOwnProperty(dateFormat13)||data.push({date:dateFormat13,close:Number(0),open:{a:val.noOfInteractiveSessions,b:val.noOfNonInteractiveSessions}})}),data.sort(function(x,y){var date1=new Date(x.date),date2=new Date(y.date);return date1-date2});var noDataFound=data.every(function(res){return 0===res.close});if(0===data.length||noDataFound)return $scope.linechartAvailable=!1,void($scope.groupbarChartLoading=!1);if(data.length){"24hours"===$scope.selectedRange?(data.shift(),data.map(function(d){d.date=moment(d.date).format("h:mm a")})):data.map(function(d){d.date=moment.parseZone(d.date).format("Do MMM")});var AllData=[];data.forEach(function(val,ind){AllData.push({date:val.date,values:[{name:"nicCount",value:val.open.b,yoffset:val.open.b,yscale:0,total:val.open.a+val.open.b,msgCount:val.close,sessionT:val.open.a+val.open.b,icTotal:val.open.a,nicTotal:val.open.b,tipdate:val.date},{name:"icCount",value:val.open.a,yoffset:val.open.a+val.open.b,yscale:0,total:val.open.a+val.open.b,msgCount:val.close,sessionT:val.open.a+val.open.b,icTotal:val.open.a,nicTotal:val.open.b,tipdate:val.date},{name:"msgCount",value:val.close,yoffset:val.close,yscale:1,total:val.close,msgCount:val.close,sessionT:val.open.a+val.open.b,icTotal:val.open.a,nicTotal:val.open.b,tipdate:val.date}]})});var stack_key_mapping={icCount:"converse",nicCount:"converse",msgCount:"message"},_barStacked=function(){var d3Container=d3.select(".groupbar-chart"),margin={top:40,right:30,bottom:30,left:80},width=$element.find(".groupbar-chart").width()-margin.left-margin.right,height=350-margin.top-margin.bottom,container=d3Container.append("svg"),svg=container.attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),color=d3.scaleOrdinal().range(["#135423","#28A745","#0D6EFD"]),x0=d3.scaleBand().rangeRound([90,width]).padding([.2]),x1=d3.scaleBand(),y0=d3.scaleLinear().rangeRound([height,0]),y1=d3.scaleLinear().rangeRound([height,0]),xAxis=d3.axisBottom(x0).scale(x0).tickSizeOuter(0),yAxisLeft=d3.axisLeft(y0).scale(y0).tickPadding(30),yAxisRight=d3.axisLeft(y1).scale(y1).tickSizeInner(-width+70).tickSizeOuter(0).tickPadding(15);x0.domain(AllData.map(function(d){return d.date})),x1.domain(["converse","message"]).rangeRound([0,x0.bandwidth()]).padding([.05]),AllData.length>16&&AllData.length<33?xAxis.tickValues(x0.domain().filter(function(d,i){return i%2===0?d:""})):AllData.length>32&&AllData.length<49?xAxis.tickValues(x0.domain().filter(function(d,i){return i%3===0?d:""})):AllData.length>48&&AllData.length<65?xAxis.tickValues(x0.domain().filter(function(d,i){return i%4===0?d:""})):AllData.length>64&&AllData.length<90?xAxis.tickValues(x0.domain().filter(function(d,i){return i%5===0?d:""})):AllData.length>89&&xAxis.tickValues(x0.domain().filter(function(d,i){return i%6===0?d:""})),y0.domain([0,d3.max(AllData,function(d){return d.values[0].value+d.values[1].value})]),y1.domain([0,d3.max(AllData,function(d){return Math.max(d.values[2].value)})]);var maxY0axis=d3.max(AllData,function(d){return d.values[0].value+d.values[1].value}),maxY1axis=d3.max(AllData,function(d){return Math.max(d.values[2].value)});8>maxY0axis?yAxisLeft.tickValues(d3.range(0,maxY0axis+1)).tickFormat(d3.format(",.0f")):yAxisLeft.tickValues([0,1*maxY0axis/6,2*maxY0axis/6,3*maxY0axis/6,4*maxY0axis/6,5*maxY0axis/6,6*maxY0axis/6]),8>maxY1axis?yAxisRight.tickValues(d3.range(0,maxY1axis+1)).tickFormat(d3.format(",.0f")):yAxisRight.tickValues([0,1*maxY1axis/6,2*maxY1axis/6,3*maxY1axis/6,4*maxY1axis/6,5*maxY1axis/6,6*maxY1axis/6]),svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis).selectAll("text");var y0SideList=svg.append("g").attr("class","y0 axis").call(yAxisLeft);y0SideList.append("text").attr("class","ySideLeft").attr("transform","translate(-42,0)").attr("y",-40).attr("x",-15).attr("dy",".91em").text("Total").style("fill","#28A745").style("font-size","12px").style("font-weight","normal").style("font-family","Inter").style("text-anchor","middle"),y0SideList.append("text").attr("class","ySideLeft").attr("transform","translate(-15,0)").attr("y",-25).attr("x",-15).attr("dy",".91em").text("Conversations").style("fill","#28A745").style("font-size","12px").style("font-weight","normal").style("font-family","Inter").style("text-anchor","middle"),svg.select(".y0.axis").selectAll(".tick").attr("class","ySideLeft");var y1SideList=svg.append("g").attr("class","y1 axis").attr("transform","translate(80,0)").call(yAxisRight);y1SideList.append("text").attr("class","ySideRight").attr("transform","translate(-28,0)").attr("y",-40).attr("x",-15).attr("dy",".91em").style("fill","#0D6EFD").style("font-size","12px").style("font-weight","normal").style("font-family","Inter").style("text-anchor","middle").text("Total"),y1SideList.append("text").attr("class","ySideRight").attr("transform","translate(-15,0)").attr("y",-25).attr("x",-15).attr("dy",".91em").style("fill","#0D6EFD").style("font-size","12px").style("font-weight","normal").style("font-family","Inter").style("text-anchor","middle").text("Messages"),svg.select(".y1.axis").selectAll(".tick").attr("class","ySideRight"),svg.append("g").selectAll("g").data(AllData).enter().append("g").attr("class","g").attr("transform",function(d){return"translate("+x0(d.date)+",0)"}).selectAll("rect").data(function(d){return d.values}).enter().append("rect").attr("width",x1.bandwidth()).attr("x",function(d){return x1(stack_key_mapping[d.name])}).attr("y",function(d){return 0===d.yscale?y0(d.yoffset):y1(d.yoffset)}).attr("height",function(d){return height-(0===d.yscale?y0(d.value):y1(d.value))}).style("fill",function(d){return color(d.name)}).on("mouseover",function(d){tooltip.html('<div class="rowdata"><span class="value">'+d.tipdate+'</span></div><div class="rowdata"><span class="bg-color total-msg"></span>Total  Messages : <span class="value">'+d.msgCount+'</span></div><div class="rowdata"><span><div class="total"><div class="self"></div><div class="drp"></div></div></span>Total Conversations : <span class="value">'+d.sessionT+'</span></div><div class="rowdata"><span class="bg-color ic-conv"></span>Interactive Conversations : <span class="value">'+d.icTotal+'</span></div><div class="rowdata"><span class="bg-color nic-conv"></span>Non- interactive Conversations : <span class="value">'+d.nicTotal+"</span></div>").style("opacity",1).style("display","block")}).on("mousemove",function(d){tooltip.style("left",d3.event.pageX-230+"px").style("top",d3.mouse(this)[1]-60+"px")}).on("mouseleave",function(d){tooltip.style("opacity",0).style("display","none")});var tooltip=d3Container.append("div").attr("class","toolTip").style("opacity",0)};_barStacked(),$scope.groupbarChartLoading=!1}}function drawUniPieChart(res){function removePerfTooltip(){$(".tooltipPerfBots").remove()}function showTooltip(e,d,i){var html='<span class="tooltipPerfBots" style="width: 175px; background-opacity:.5"><span class="header1">'+e.data.streamName.slice(0,e.data.streamName.indexOf("("))+"</span></span>",x=d3.event.pageX,y=d3.event.pageY;0===$(".tooltipViz").length&&d3.select(".topPerformingBotsDiv").append("div").attr("class","vz-weighted_tree-tip").style("position","absolute").style("left",x-$(".topPerformingBotsDiv").offset().left+"px").style("top",y-$(".topPerformingBotsDiv").offset().top-45+"px").style("opacity",0).html(html).transition().style("opacity",1)}function midAngle(d){return d.startAngle+(d.endAngle-d.startAngle)/2}$scope.topPerformingBots=res,$element.find("#performingPieChart").html("");for(var svg=(d3.select("#performingPieChart").append("svg").attr("class","topPerformUniBot"),d3.select("svg.topPerformUniBot")),width=600,height=260,radius=Math.min(width,height)/2,g=svg.append("g").attr("transform","translate("+width/2+","+height/1.625+")"),color=(d3.select("#labels"),d3.scaleOrdinal(["#66c4cc","#ff5d5d","#ff8d8d","#f9c97b","#ff7d7d","#f7b74e","#32b0bb","#95d16e","#009dab","#afdc92","#4cbac4","#19a6b3","#ff6d6d","#f8c065","#f6ae38","#f5a623","#a2d780","#88cb5c","#7bc64a","#ff9d9d"])),pie=d3.pie().sort(null).value(function(d){return d.noOfDialogFAQSuccess}),path=d3.arc().outerRadius(radius-20).innerRadius(0),outerArc=d3.arc().innerRadius(1.33*(radius-20)).outerRadius(1.33*(radius-20)),label=d3.arc().outerRadius(radius-40).innerRadius(radius-40),csvData="streamName,noOfDialogFAQSuccess\n",i=0;i<res.data.results.length;i++){var dialogFAQSuccess=res.data.results[i].noOfDialogSuccess1+res.data.results[i].noOfFaqSuccess+res.data.results[i].noOfActionSuccess;csvData+=res.data.results[i].streamName+" ("+dialogFAQSuccess.toString()+"),"+dialogFAQSuccess.toString()+"\n"}var data=d3.csvParse(csvData);data.forEach(function(d){return d.noOfDialogFAQSuccess=+d.noOfDialogFAQSuccess,d});
var arc=g.selectAll(".arc").data(pie(data)).enter().append("g").attr("class","arc"),labelPositions=[];arc.append("path").attr("d",path).attr("fill",function(d){return color(d.data.streamName)}),arc.append("text").attr("transform",function(d,i){var pos=outerArc.centroid(d);(d.endAngle-d.startAngle)/(2*Math.PI)*100;return labelPositions.push(angular.copy(pos)),midAngle(d)<.5*Math.PI?pos[1]=pos[1]-20:midAngle(d)>1.5*Math.PI&&(pos[0]=pos[0]-25,pos[1]=pos[1]-25),"translate("+pos+")"}).attr("fill",function(d,i){return"#8a959f"}).attr("text-anchor","left").attr("dx",function(d){var ac=0;return midAngle(d)<Math.PI?d.value<5&&(ac=-60):ac=-50,ac}).attr("dy",5).append("tspan").attr("x","0").attr("dy","1.2em").text(function(d){var strName;return(d.endAngle-d.startAngle)/(2*Math.PI)*100>4?(strName=d.data.streamName.replace(/[(][0-9]*?[)]/g,""),strName.length>14?d.data.streamName.replace(/[(][0-9]*?[)]/g,"").slice(0,12)+"...":d.data.streamName.replace(/[(][0-9]*?[)]/g,"")):(d.endAngle-d.startAngle)/(2*Math.PI)*100<4&&(strName=d.data.streamName.replace(/[(][0-9]*?[)]/g,""),d.value<10&&strName.length>14)?d.data.streamName.replace(/[(][0-9]*?[)]/g,"").slice(0,8)+"...":void 0}).on("mouseover",showTooltip).on("mouseout",removePerfTooltip).append("tspan").attr("x",function(d){return midAngle(d)<Math.PI?"20":"-30"}).attr("dy","1.2em").text(function(d){return(d.endAngle-d.startAngle)/(2*Math.PI)*100>4?d.data.streamName.match(/[(][0-9]*?[)]/g)[0]:null});g.selectAll("polyline").data(pie(data),function(d){return d.data.streamName}).enter().append("polyline").attr("points",function(d,i){var pos=label.centroid(d),percent=(outerArc.centroid(d),(d.endAngle-d.startAngle)/(2*Math.PI)*100);return 0>percent?[0,0]:[[pos[0],pos[1]],[labelPositions[i][0],labelPositions[i][1]]]}).style("fill","none").attr("stroke",function(d,i){return"#8a959f"}).style("stroke-width","1px")}function drawPieChartNew(graphData){var w=260,h=260,r=130,dataset=[];$scope.pieGraphAvailable=!0;var pieObj={};$scope.tasksStats.intentSucess>0||$scope.tasksStats.intentFailed>0?(pieObj["Intent Recognized"]=$scope.tasksStats.intentSucess,pieObj["Intent Failed"]=$scope.tasksStats.intentFailed):$scope.pieGraphAvailable=!1,graphData||!$scope.tasksStats.intentFailed&&!$scope.tasksStats.intentSucess?$scope.tasksStats.intentFailed||$scope.tasksStats.intentSucess?dataset=graphData:$scope.pieGraphAvailable=!1:dataset=[$scope.tasksStats.intentFailed,$scope.tasksStats.intentSucess],dataset[0]&&dataset[0].length<0&&($scope.pieGraphAvailable=!1),$element.find(".pie-chart").html("");var svg=d3.select(".pie-chart").append("svg").attr("width",w).attr("height",h),g=svg.append("g").attr("transform","translate("+w/2+","+h/2+")");g.append("g").attr("class","slices"),g.append("g").attr("class","labelName");var pie=d3.pie().sort(null).value(function(d){return d.value}),arc=d3.arc().outerRadius(1*r).innerRadius(0*r),colorRange=d3.scaleOrdinal().range(["#28A745","#7027E5"]),color=d3.scaleOrdinal().range(colorRange.range()),data_ready=pie(d3.entries(pieObj)),slice=g.select(".slices").selectAll("path.slice").data(data_ready);slice.enter().append("path").attr("d",arc).style("fill",function(d){return color(d.data.key)}).attr("class","slice").on("mouseover",function(d){d3.select("#tooltip").html(d.data.value+" "+d.data.key).style("opacity",1).style("display","block")}).on("mousemove",function(){d3.select("#tooltip").style("left",d3.event.pageX-50+"px").style("top",d3.event.pageY-50+"px")}).on("mouseleave",function(){d3.select("#tooltip").style("opacity",0).style("display","none")}),data_ready&&data_ready.length&&(data_ready[0].data.text=Math.round(100*data_ready[0].data.value/(data_ready[0].data.value+data_ready[1].data.value)),data_ready[1].data.text=Math.round(100*data_ready[1].data.value/(data_ready[0].data.value+data_ready[1].data.value)),g.selectAll("mySlices").data(data_ready).enter().append("text").text(function(d){return d.data.text?d.data.text+"%":void 0}).attr("transform",function(d){return"translate("+arc.centroid(d)+")"}).style("text-anchor","middle").style("fill","#ffffff").style("font-size",14)),slice.exit().remove()}function drawPieChart(graphData){var w=350,h=350,colors=["#e04e4c","#009dab"],dataset=[];$scope.pieGraphAvailable=!0,$scope.tasksStats.intentSucess>0||$scope.tasksStats.intentFailed>0?($scope.tasksStats.intentFailed=Math.round($scope.tasksStats.intentFailed/($scope.tasksStats.intentSucess+$scope.tasksStats.intentFailed)*100),$scope.tasksStats.intentSucess=100-$scope.tasksStats.intentFailed):$scope.pieGraphAvailable=!1,graphData||!$scope.tasksStats.intentFailed&&!$scope.tasksStats.intentSucess?$scope.tasksStats.intentFailed||$scope.tasksStats.intentSucess?dataset=graphData:$scope.pieGraphAvailable=!1:dataset=[$scope.tasksStats.intentFailed,$scope.tasksStats.intentSucess],dataset[0]&&dataset[0].length<0&&($scope.pieGraphAvailable=!1);var _zeroDataIndex=dataset.indexOf(0);_zeroDataIndex>-1&&dataset.splice(_zeroDataIndex,1);var outerRadius=w/2-20,innerRadius=0,arc=d3.arc().innerRadius(innerRadius).outerRadius(outerRadius),pie=d3.pie();d3.scaleOrdinal(d3.schemeCategory10);$element.find(".pie-chart").html("");var svg=d3.select(".pie-chart").append("svg").attr("width",w).attr("height",h),arcs=svg.selectAll("g.arc").data(pie(dataset)).enter().append("g").attr("class","arc").attr("transform","translate("+outerRadius+","+outerRadius+")").on("mouseover",function(d){1===d.index?$scope.piechartTooltipMsg=$scope.pieChartFailed+" Intent Failed":$scope.piechartTooltipMsg=$scope.pieChartSucess+" Intent Recognized",d3.select("#tooltip").html($scope.piechartTooltipMsg).style("opacity",1).style("display","block")}).on("mousemove",function(){d3.select("#tooltip").style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY+10+"px")}).on("mouseleave",function(){d3.select("#tooltip").style("opacity",0).style("display","none")}).on("click",function(d,type){$scope.selectedChartData.data=d,$scope.selectedChartData.type=type});arcs.append("path").attr("fill",function(d,i){return 1===d.index?colors[0]:colors[1]}).attr("d",arc),arcs.append("text").attr("transform",function(d){return"translate("+arc.centroid(d)+")"}).attr("text-anchor","middle").style("fill","#ffffff").text(function(d){return d.value+"%"})}function getDashboardData(){var start,end;if("custom"===$scope.selectedRange?(start=$scope.startDate,end=moment()._d.getDate()===$scope.endDate._d.getDate()&&moment()._d.getDay()===$scope.endDate._d.getDay()&&moment()._d.getYear()===$scope.endDate._d.getYear()?moment():$scope.endDate,sessionInterval="date_day"):"7days"===$scope.selectedRange?(start=moment().subtract({days:7}),end=moment(),sessionInterval="date_day"):"24hours"===$scope.selectedRange&&(start=moment().subtract({hours:24}),end=moment(),sessionInterval="date_day_hour"),$scope.appliedSelectedRange=angular.copy($scope.selectedRange),$scope.filterStatement=generateFilterString(start,end),"7days"===$scope.selectedRange||"24hours"===$scope.selectedRange)$scope.start=start,$scope.end=end,"universalbot"==$scope.stream.type&&performingBotsDashboard(),fetchDataFromServer(),agentTransferMetrics(),tasksMetrics(),sessionsGraph(),intentGraphData();else{if(end.diff(start,"days")>90&&1!==$scope.selectedAccount.accountType)return;$scope.start=start,$scope.end=end,"universalbot"==$scope.stream.type&&performingBotsDashboard(),fetchDataFromServer(),agentTransferMetrics(),tasksMetrics(),sessionsGraph(),intentGraphData()}}function realTimeDashboardData(){BTStreamsService.realTimeDashboard($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id).then(function(res){$scope.realTimeUsers=res.data.nUsers,$scope.realTimeChannels=res.data.aChannels,$scope.realTimeSessions=res.data.nSessions,$scope.realTimeAgentSessions=res.data.nAgentSessions,0===$scope.realTimeUsers?($scope.realTimeUsersData=!1,$scope.realTimeUsers=i18n.i18nString("real_time_user")):$scope.realTimeUsersData=!0,0===$scope.realTimeChannels.length?($scope.realTimeChannelData=!1,$scope.realTimeChannnel=i18n.i18nString("real_time_channel")):$scope.realTimeChannelData=!0,0===$scope.realTimeSessions&&0===$scope.realTimeAgentSessions?($scope.realTimeSessions=i18n.i18nString("real_time_session"),$scope.realTimeSessionData=!1):$scope.realTimeSessionData=!0})}function generateFilterString(start,end){var str="<strong>"+i18n.i18nString("all")+"</strong>"+i18n.i18nString("chat_sessions")+" ";if(start&&end){var _format="MM-DD-YYYY",startStr=start.format(_format),endStr=end.format(_format);str+=startStr===endStr?""+i18n.i18nString("on")+" "+startStr:""+i18n.i18nString("between")+" <strong>"+startStr+"</strong> "+i18n.i18nString("to_label")+" <strong>"+endStr+"</strong>"}var _selectedChannels=_.pluck($scope.channels.filter(function(channel){return $scope.selectedChannels.indexOf(channel.id)>-1}),"name"),_selectedLangauges=_.pluck($scope.langauges.filter(function(langauge){return $scope.selectedLangauges.indexOf(langauge.value)>-1}),"name");return $scope.channelsStr=commaSeperatedStr(_selectedChannels),$scope.langaugesStr=commaSeperatedStr(_selectedLangauges),str}function generateFilterTags(){$scope.filterTags=[];var _selectedChannels=_.pluck($scope.channels.filter(function(channel){return $scope.selectedChannels.indexOf(channel.id)>-1}),"name"),_selectedLangauges=_.pluck($scope.langauges.filter(function(langauge){return $scope.selectedLangauges.indexOf(langauge.value)>-1}),"name");$scope.channelsStr=commaSeperatedStr(_selectedChannels),$scope.langaugesStr=commaSeperatedStr(_selectedLangauges),_selectedChannels&&_selectedChannels.length&&$scope.enabledChannelsFilterDetails.length!==$scope.selectedChannels.length&&$scope.filterTags.push({value:i18n.i18nString("channel_name"),type:"channel",tooltipValue:$scope.channelsStr,count:_selectedChannels.length}),_selectedLangauges&&_selectedLangauges.length&&$scope.filterTags.push({value:i18n.i18nString("Language"),type:"language",tooltipValue:$scope.langaugesStr,count:_selectedLangauges.length})}function commaSeperatedStr(arr){var str="";return arr.length&&(str+=1===arr.length?arr.join(","):2===arr.length?arr.join(" and "):arr.join(",")),str}function loadChannelFilter(){function dispSelectedFilterOpt(name){var $select="$scope.selected"+name.charAt(0).toUpperCase()+name.slice(1);$select=$select.lastIndexOf("s")==$select.length-1?$select:$select+"s";var $selectorEach=$(".channel-filter [name="+name+"]");$selectorEach.each(function(){var t=eval($select).indexOf($(this).val())>-1?$(this).prop("checked",!0):$(this).prop("checked",!1)})}var seedData=$workflowService.seedData();$scope.sumocb={sessioncb:{changeText:!0},channelcb:{changeText:!0}},channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.channels=Object.values(channelsConfig.channelsObject),$scope.langauges=seedData.supportedLanguages,$scope.stream&&$scope.stream.channels&&($scope.enabledChannelsFilter=$scope.stream.channels.map(function(v){return v.type})),$scope.enabledChannelsFilterDetails=[],$scope.enabledLangsFilterDetails=[],$scope.sessionTypes=[{type:i18n.i18nString("interactive")},{type:i18n.i18nString("non_interactive")}];var temp;if($scope.enabledChannelsFilter&&$scope.enabledChannelsFilter.length)for(var i=0;i<$scope.enabledChannelsFilter.length;i++)temp=$scope.channels.filter(function(v){return v.id===$scope.enabledChannelsFilter[i]}),$scope.enabledChannelsFilterDetails.push(temp[0]);for(var j=0;j<$scope.stream.supportedLanguages.length;j++)$workflowService.seedData().nluSupportedLanguages&&(temp=$workflowService.seedData().nluSupportedLanguages.filter(function(v){return $scope.stream.supportedLanguages[j]===v.value}),$scope.enabledLangsFilterDetails.push(temp[0]));$scope.selectedChannels=[],$scope.selectedLangauges=[],$scope.selectedLinkedBots=[],$element.on("click",".dropdown-menu input, .dropdown-menu label",function(e){e.stopPropagation()}),$element.find(".channel-filter.dropdown").on("show.bs.dropdown",function(e){e.stopPropagation()}),setTimeout(function(){0===$scope.conversationFilter.selectedSession.length&&$scope.sumocb.sessioncb&&$scope.sumocb.sessioncb.selectAllByDefault&&$scope.sumocb.sessioncb.selectAllByDefault(),0===$scope.conversationFilter.selectedChannel.length&&$scope.sumocb.channelcb.selectAllByDefault()},150),$scope.toggled=function(open){open&&(importModalSliderOpen(),getCustomMetaTags(),$timeout(function(){$scope.selectedChannelsCopy&&$scope.selectedChannelsCopy.length&&($('.channel-filter [name="langauge"], .channel-filter [name="channels"], .channel-filter [name="linkedBot"],#all-langauge, #all-linkedbot, #uniBotInteraction').each(function(){$(this).prop("checked",!1)}),$scope.selectedChannels=angular.copy($scope.selectedChannelsCopy),$scope.selectedChannels.forEach(function(data){$(".checkWithTitle #"+data).prop("checked",!0)})),0===$scope.filterComponent.tags.and.length?($scope.selectedTagsArray=[],$scope.selectedTagsArray.push({name:"",values:[],type:""})):($scope.selectedTagsArrayCopy=angular.copy($scope.selectedTagsArray),$scope.selectedTagsArray=[],$scope.filterComponent.tags.and.forEach(function(value,key){var forAutoSuggestionValues=_.findIndex($scope.customTagsArray,{name:value.name});$scope.selectedTagsArray.push({name:value.name,values:value.values,type:value.type,selectedValues:$scope.customTagsArray[forAutoSuggestionValues].selectedValues})}),$scope.selectedTagsArray.push({name:"",values:[],type:""}))})),$scope.selectedSessionFilterCopy&&$scope.selectedSessionFilterCopy.length&&($scope.conversationFilter.selectedSession=angular.copy($scope.selectedSessionFilterCopy)),$scope.selectedChannelsCopy&&$scope.selectedChannelsCopy.length&&($scope.conversationFilter.selectedChannel=angular.copy($scope.selectedChannelsCopy)),setTimeout(function(){0===$scope.conversationFilter.selectedSession.length&&$scope.sumocb.sessioncb.selectAllByDefault(),0===$scope.conversationFilter.selectedChannel.length&&$scope.sumocb.channelcb.selectAllByDefault(),"universalbot"===$scope.stream.type&&$scope.selectedLinkedBotsCopy&&$scope.selectedLinkedBotsCopy.length&&($scope.selectedLinkedBots=angular.copy($scope.selectedLinkedBotsCopy),$scope.selectedLinkedBotsCopy.forEach(function(streamId){$element.find('input[id="'+streamId+'"]').prop("checked",!0)}))},200)},$scope.doneChannelFilter=function(){$scope.selectedLangauges=$element.find('.channel-filter [name="langauge"]:checked').map(function(_,el){return $(el).val()}).get(),$scope.selectedLinkedBots=$element.find('.channel-filter [name="linkedBot"]:checked').map(function(_,el){return $(el).val()}).get(),$scope.selectedLangaugesCopy=angular.copy($scope.selectedLangauges),$scope.selectedLinkedBotsCopy=angular.copy($scope.selectedLinkedBots),$scope.selectedSessionFilter=[],$scope.selectedChannels=[],$scope.conversationFilter.selectedSession.map(function(ses){$scope.selectedSessionFilter.push("Interactive"===ses?1:0)}),$scope.conversationFilter.selectedChannel.map(function(ch){$scope.selectedChannels.push(ch)}),$scope.selectedSessionFilterCopy=angular.copy($scope.conversationFilter.selectedSession),$scope.selectedChannelsCopy=angular.copy($scope.selectedChannels),generateFilterTags(),prepareTagsPayload(),getDashboardData()}}function load(){"private"!==$workflowService.selectedStream().visibility.namespace?($timeout(function(){daterangepickerInput=$('input[name="daterange"]').daterangepicker({startDate:$scope.startDate||moment(),endDate:$scope.endDate||moment(),maxDate:moment(new Date).format("MM-DD-YYYY"),opens:"left",customClass:"bot-dash-datepicker",locale:{applyLabel:i18n.i18nString("apply"),cancelLabel:i18n.i18nString("cancel")}}),$('input[name="daterange"]').on("apply.daterangepicker",function(ev,picker){if(ev){var timezone=moment.tz.guess();"America/Los_Angeles"===timezone?$scope.startDate=moment(picker.startDate,timezone).add({hour:1,day:0}):$scope.startDate=moment(picker.startDate,timezone),$scope.endDate=picker.endDate,$scope.endDate.diff($scope.startDate,"days")>90&&1!==$scope.selectedAccount.accountType?NotificationService.notify(i18n.i18nString("custom_date"),"warning"):getDashboardData()}}),$('input[name="daterange"]').on("cancel.daterangepicker",function(){"7days"==$scope.appliedSelectedRange?($('input[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('input[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),$(".filer-btns .nav-pills li.left a").click()):"24hours"==$scope.appliedSelectedRange&&($('input[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('input[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),$(".filer-btns .nav-pills li.center a").click())}),$('input[name="daterange"]').on("outsideClick.daterangepicker",function(){"7days"==$scope.appliedSelectedRange?($('input[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('input[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),$(".filer-btns .nav-pills li.left a").click()):"24hours"==$scope.appliedSelectedRange&&($('input[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('input[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY")),$(".filer-btns .nav-pills li.center a").click())})},300),$(".rightPanel.paddingRightPanel").addClass("realTimeDashboardDiv"),loadChannelFilter(),$scope.selectRange("24hours"),realTimeDashboardData()):($(".rightPanel.paddingRightPanel").addClass("fakeDataDivChild"),$scope.fakeDataUI=!0,$scope.tasksStats.tasksPerformedTotal=null,$scope.tasksStats.alertsTotal=null,$scope.scount=null)}function getCustomMetaTags(){BTStreamsService.metaTags($scope.stream._id,$scope.start.toISOString(),$scope.end.toISOString()).then(function(response){$scope.customTagsArray=response.data.tags},function(error){})}function prepareTagsPayload(){return checkCustomTagValue()?(NotificationService.notify(i18n.i18nString("check_custom_tag"),"warning"),!1):($scope.filterComponent.tags.and=[],$scope.selectedTagsArray.forEach(function(value,key){""!==value.name?$scope.filterComponent.tags.and.push({name:value.name,values:value.values,type:value.type}):""===$scope.selectedTagsArray[0].name&&($scope.filterComponent.tags.and=[])}),importModalSliderClose(),$scope.filterComponent.tags)}function checkCustomTagValue(){var valueCheck=!1;return $scope.selectedTagsArray.forEach(function(value,key){""!==value.name&&0===value.values.length&&(valueCheck=!0)}),valueCheck}var daterangepickerInput;$scope.selectedChannels=[],$scope.assetsBase=env_conf["assets-url"],$scope._channelConfig=channelsConfig,$scope.tasksStats={alertsTotal:0,actionsTotal:0,chatsTotal:0,tasksTotal:0,queriesTotal:[],tasksPerformedTotal:0,alertsConTotal:0,taskBarGraph:[]},$scope.tasksCount={actionsTotal:0,actionsConTotal:0,queriesTotal:0,queriesConTotal:0,dialogsTotal:0,dialogsConTotal:0},$scope.stream=$workflowService.selectedStream(),$scope.selectedAccount=$workflowService.selectedAccount(),$scope._constants_=_constants_,$scope.topBotsCompleteList=[],$scope.scount=0,$scope.agentTransferCount=0,$scope.topAgentTransferCompleteList=[],$scope.piechartTooltipMsg="Intent Recognised",$scope.selectedChartData={type:0,data:""},$scope.dashboardLoading=!1,$scope.groupbarChartLoading=!1,$scope.taskCompletionLoading=!1,$scope.barGraphAvailable=!0,$scope.topPerformingBots=0,$scope.emptyIllustration=env_conf["context-url"]+"/img/empty-illustration.png",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.caretRight=env_conf["context-url"]+"/assets/icons/caretRight.svg",$scope.caretRightGreen=env_conf["context-url"]+"/assets/icons/caretDown.svg",$scope.arrowAngle=env_conf["context-url"]+"/assets/icons/arrowAngle.svg",$scope.caretDownWhit=env_conf["context-url"]+"/assets/icons/caretDownWhit.svg",$scope.refreshIconGreen=env_conf["context-url"]+"/assets/icons/refreshGray.svg",$scope.timeIcon=env_conf["context-url"]+"/assets/icons/time.svg",$scope.checkTickIcon=env_conf["context-url"]+"/assets/icons/checkTickIcon.svg",$scope.chatsConversation=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/chatsConversation.svg",$scope.tasksPerformance=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/tasksPerformance.svg",$scope.intentRecognised=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/intentRecognised.svg",$scope.tasks=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/tasks.svg",$scope.agentTransfer=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/agentTransfer.svg",$scope.channels=env_conf["context-url"]+"/assets/dashboardEmptyStateImgs/channels.svg",$scope.helpDarkIcon=env_conf["context-url"]+"/assets/icons-new/help/help-dark.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.realTime=moment().format("HH:mm:ss"),$scope.realTimeZone=moment.tz(moment.tz.guess()).format("z"),$scope.realTimeDashboardInterval=[1e4,3e4,6e4,12e4,3e5,6e5],$scope.maintainTimeInterval=parseInt(localStorage.dashboardRefreshInterval)||3e4,$scope.realTimeSessionData=!0,$scope.realTimeChannelData=!0,$scope.realTimeUsersData=!0,$scope.checkTickIcon=$scope.assetsBase+"headerIcons/checkTickIcon.svg",$scope.caretDown=$scope.assetsBase+"headerIcons/caretDown.svg",$scope.trashIcon=$scope.assetsBase+"icons/trashIcon.svg",$scope.minusIcon=$scope.assetsBase+"icons/minus-circle.svg",$scope.disabledMinusIcon=$scope.assetsBase+"images/left-menu-img/disabledMinus.svg",$scope.andIcon=$scope.assetsBase+"icons/andIcon.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.bulbIcon=env_conf["context-url"]+"/assets/icons-new/bulb/bulb-blue.svg",$scope.selectedTag="",$scope.selectedTagsArray=[],$scope.selectedTagsArray.push({name:"",values:[],type:""}),$scope.filterComponent=[],$scope.filterComponent.tags={},$scope.noofmsgs=i18n.i18nString("noofmsgs"),$scope.filterComponent.tags.and=[],$scope.sessionTypes=[{type:"Interactive"},{type:"Non-interactive"}],$scope.conversationFilter={selectedSession:[],selectedChannel:[]},$scope.selectedSessionFilter=[],$scope.select_label=i18n.i18nString("select"),$scope.tasksAndFaqData=[{title:i18n.i18nString("tasks"),data:[]}],$scope.coversionOfTime=function(time){var timeInterval;return 1e4===time?timeInterval=i18n.i18nString("10_seconds"):3e4===time?timeInterval=i18n.i18nString("30_seconds"):6e4===time?timeInterval=i18n.i18nString("1_minute"):12e4===time?timeInterval=i18n.i18nString("2_minutes"):3e5===time?timeInterval=i18n.i18nString("5_minutes"):6e5===time&&(timeInterval=i18n.i18nString("10_minutes")),timeInterval},$scope.updateTimeInterval=function(time,e){window.dashboardRefreshIntervalTimer&&clearInterval(window.dashboardRefreshIntervalTimer),$scope.maintainTimeInterval=time,localStorage.setItem("dashboardRefreshInterval",$scope.maintainTimeInterval),window.dashboardRefreshIntervalTimer=setInterval(function(){realTimeDashboardData(),$scope.realTimeDashboardChannelData(),$scope.realTime=moment().format("HH:mm:ss"),$scope.realTimeZone=moment.tz(moment.tz.guess()).format("z")},$scope.maintainTimeInterval)},window.dashboardRefreshIntervalTimer&&clearInterval(window.dashboardRefreshIntervalTimer),window.dashboardRefreshIntervalTimer=setInterval(function(){realTimeDashboardData(),$scope.realTimeDashboardChannelData(),$scope.realTime=moment().format("HH:mm:ss"),$scope.realTimeZone=moment.tz(moment.tz.guess()).format("z")},$scope.maintainTimeInterval),$scope.sessionsGraphData=[];var sessionInterval="date_day";$scope.botName="";var date_type_chart="",type_chart="";$scope.languagesAndChannelsData=[{title:i18n.i18nString("channels"),data:[],isLinkedBotSelected:!1}],$scope.isLinkedBotSelectedClone=!1,$scope.search={},$scope.search.nameSearchQuery="",$scope.modalSlider={},$scope.rightClass="right500",$scope.isFilterDisabled=function(){return 0===$element.find('#universalBotDashSlider input[type="checkbox"]:checked').length},$scope.isAllSelected=function(name){return $element.find("input[name="+name+"]").length===$element.find("input[name="+name+"]:checked").length},$scope.resetFilter=function(){$scope.selectedLangauges=[],$scope.selectedChannels=[],$scope.selectedLinkedBots=[],$scope.conversationFilter.selectedSession=[],$scope.conversationFilter.selectedChannel=[],$scope.selectedSessionFilter=[],$('.channel-filter [name="langauge"], .channel-filter [name="channels"], .channel-filter [name="linkedBot"],#all-channels, #all-langauge, #all-linkedbot, #uniBotInteraction').each(function(){$(this).prop("checked",!0)}),$scope.selectedTagsArray=[],$scope.selectedTagsArray.push({name:"",values:[],type:""}),0===$scope.conversationFilter.selectedSession.length&&$scope.sumocb.sessioncb.selectAllByDefault(),0===$scope.conversationFilter.selectedChannel.length&&$scope.sumocb.channelcb.selectAllByDefault()},$scope.closeSliderDashboard=function(){importModalSliderClose()},$scope.selectAllClick=function(e){e.currentTarget.checked?$("[name="+e.currentTarget.id.slice(4)+"]:not(:checked)").trigger("click"):$("[name="+e.currentTarget.id.slice(4)+"]:checked").trigger("click")},getStream(),$scope.downloadCSV=function(){var channels=$scope.selectedChannels.toString(),languages=$scope.selectedLangauges.toString();return BTStreamsService.tasksMetricsExport($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id,$scope.start.toISOString(),$scope.end.toISOString(),"organization,task",channels,"",$scope.selectedLinkedBots.toString(),languages,"-1").then(function(res){return $.each(res.data.results,function(i,result){delete result.organization,delete result.id,delete result.createdOn,delete result.icon,delete result.createdBy,delete result.state}),res.data.results},function(err){console.log("Error ",err)})},$scope.triggerDownloadCSV=function(){function startExport(){$timeout(function(){$(".downloadCSVHide").trigger("click")},350)}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_task")):startExport()};var taskResponseHandle=function(res){if(res&&res.data){$scope.topBotsCompleteList=[];var dialogsTotal=0,dialogsConTotal=0,actionsTotal=0,queriesTotal=0,queriesConTotal=0,actionsConTotal=0,tasksMetricsCount=0;$.each(res.data.results,function(index,result){var obj={};obj.tasksCount={actionsEntTotal:0,actionsConTotal:0,queriesEntTotal:0,queriesConTotal:0,dialogsEntTotal:0,dialogsConTotal:0},actionsTotal+=void 0===(result.noOfEntUserActions||result.noOfUserActions)?0:result.noOfEntUserActions||result.noOfUserActions,actionsConTotal+=result.noOfConUserActions||0,queriesTotal+=void 0===(result.noOfEntFaqSuccess||result.noOfFaqSuccess)?0:result.noOfEntFaqSuccess||result.noOfFaqSuccess,queriesConTotal+=result.noOfConFaqSuccess||0,dialogsTotal+=void 0===(result.noOfEntDialogSuccess||result.noOfDialogSuccess1)?0:result.noOfEntDialogSuccess||result.noOfDialogSuccess1,dialogsConTotal+=result.noOfConDialogSuccess||0,tasksMetricsCount=dialogsTotal+dialogsConTotal+actionsTotal+actionsConTotal+queriesTotal+queriesConTotal,obj.name=result.name,obj.icon=result.icon,obj.id=result.id,obj.tasksCount.tasksMetricsCount=result.total,$scope.topBotsCompleteList.push(obj)})}},agentTransferResponseHandle=function(res){if(res&&res.data){var totalCount=0;$scope.topAgentTransferCompleteList=res.data;for(var i=0;i<res.data.results.length;i++)totalCount+=res.data.results[i].noOfAgentTransfers;$scope.agentTransferCount=totalCount}};$scope.dashboardCounts=[];var responseHandleDashboardCount=function(res){if(res&&res.data){$scope.dashboardLoading=!1,$scope.taskCompletionLoading=!1;var alertsTotal=0,alertsConTotal=0,actionsTotal=0,actionsConTotal=0,chatsTotal=0,tasksTotal=0,dialogsTotal=0,dialogsConTotal=0,tasksPerformedTotal=0,queriesTotal=0,queriesConTotal=0,alertSuccess=0,alertConSuccess=0,actionSuccess=0,actionConSuccess=0,dialogFail=0,dialogConFail=0,queriesSuccess=0,queriesConSuccess=0,queriesFail=0,queriesConFail=0,alertFail=0,alertConFail=0,actionFail=0,actionConFail=0,taskBarGraph=0,queriesTotalEach=0,queriesConTotalEach=0;$scope.tasksStats={alertsTotal:0,actionsTotal:0,chatsTotal:0,tasksTotal:0,queriesTotal:[],barGraphDate:[],tasksPerformedTotal:0,alertsConTotal:0,taskBarGraph:[]},$.each(res.data.results,function(index,result){alertsTotal+=void 0===(result.noOfEntUserAlerts||result.noOfUserAlerts)?0:result.noOfEntUserAlerts||result.noOfUserAlerts,alertsConTotal+=result.noOfConUserAlerts||0,actionsTotal+=void 0===(result.noOfEntUserActions||result.noOfUserActions)?0:result.noOfEntUserActions||result.noOfUserActions,actionsConTotal+=result.noOfConUserActions||0,queriesTotal+=void 0===(result.noOfEntFaqSuccess||result.noOfFaqSuccess)?0:result.noOfEntFaqSuccess||result.noOfFaqSuccess,queriesConTotal+=result.noOfConFaqSuccess||0,queriesTotalEach=void 0===(result.noOfEntFaqSuccess||result.noOfFaqSuccess)?0:result.noOfEntFaqSuccess||result.noOfFaqSuccess,queriesConTotalEach=result.noOfConFaqSuccess||0,dialogsTotal+=void 0===(result.noOfEntDialogSuccess||result.noOfDialogSuccess1)?0:result.noOfEntDialogSuccess||result.noOfDialogSuccess1,dialogsConTotal+=result.noOfConDialogSuccess||0,result.noOfChats=Number(void 0===(result.noOfEntChatRequest||result.noOfChatRequest)?0:result.noOfEntChatRequest||result.noOfChatRequest)+Number(result.noOfConChatRequest||0)+Number(void 0===(result.noOfEntChatResponse||result.noOfChatResponse)?0:result.noOfEntChatResponse||result.noOfChatResponse)+Number(result.noOfConChatResponse||0),chatsTotal+=result.noOfChats,result.taskGraph=Number(void 0===(result.noOfEntUserActions||result.noOfUserActions)?0:result.noOfEntUserActions||result.noOfUserActions)+Number(result.noOfConUserActions||0)+Number(void 0===(result.noOfEntDialogSuccess||result.noOfDialogSuccess1)?0:result.noOfEntDialogSuccess||result.noOfDialogSuccess1)+Number(result.noOfConDialogSuccess||0)+Number(void 0===(result.noOfEntUserAlerts||result.noOfUserAlerts)?0:result.noOfEntUserAlerts||result.noOfUserAlerts)+Number(result.noOfConUserAlerts||0),taskBarGraph=result.taskGraph,$scope.tasksStats.taskBarGraph.push(result.taskGraph),$scope.tasksStats.queriesTotal.push(queriesTotalEach+queriesConTotalEach),$scope.tasksStats.barGraphDate.push(result.date_day||result.date_hour),alertSuccess+=void 0===(result.noOfEntAlertSuccess||result.noOfAlertSuccess)?0:result.noOfEntAlertSuccess||result.noOfAlertSuccess,alertConSuccess+=result.noOfConAlertSuccess||0,actionSuccess+=void 0===(result.noOfEntActionSuccess||result.noOfActionSuccess)?0:result.noOfEntActionSuccess||result.noOfActionSuccess,actionConSuccess+=result.noOfConActionSuccess||0,dialogFail+=void 0===(result.noOfEntDialogFail||result.noOfDialogFail)?0:result.noOfEntDialogFail||result.noOfDialogFail,dialogConFail+=result.noOfConDialogFail||0,queriesSuccess+=void 0===(result.noOfEntFaqSuccess||result.noOfFaqSuccess)?0:result.noOfEntFaqSuccess||result.noOfFaqSuccess,queriesConSuccess+=result.noOfconFaqSuccess||0,queriesFail+=void 0===(result.noOfEntFaqFail||result.noOfFaqFail)?0:result.noOfEntFaqFail||result.noOfFaqFail,queriesConFail+=result.noOfconFaqFail||0,alertFail+=void 0===(result.noOfEntAlertFail||result.noOfAlertFail)?0:result.noOfEntAlertFail||result.noOfAlertFail,alertConFail+=result.noOfconAlertFail||0,actionFail+=void 0===(result.noOfEntActionFail||result.noOfActionFail)?0:result.noOfEntActionFail||result.noOfActionFail,actionConFail+=result.noOfConActionFail||0}),tasksTotal=alertsTotal+alertsConTotal+actionsTotal+actionsConTotal+chatsTotal,tasksPerformedTotal=actionsTotal+actionsConTotal+dialogsTotal+dialogsConTotal+queriesTotal+queriesConTotal,
$scope.tasksStats.alertsConTotal=alertsTotal+alertsConTotal,$scope.tasksStats.alertsTotal=alertsTotal+alertsConTotal,$scope.tasksStats.actionsTotal=actionsTotal+actionsConTotal,$scope.tasksStats.chatsTotal=chatsTotal,$scope.tasksStats.tasksTotal=tasksTotal,tasksPerformedTotal=actionsTotal+actionsConTotal+dialogsTotal+dialogsConTotal+queriesTotal+queriesConTotal,$scope.tasksStats.tasksPerformedTotal=tasksPerformedTotal,drawBarGraph()}},responseHandleDashboardChats=function(res){if(res&&res.data){$scope.dashboardLoading=!1,$scope.dashboardCounts=res.data;var alertsTotal=0,alertsConTotal=0,actionsTotal=0,actionsConTotal=0,chatsTotal=0,tasksTotal=0,dialogsTotal=0,dialogsConTotal=0,tasksPerformedTotal=0,queriesTotal=0,queriesConTotal=0,alertSuccess=0,alertConSuccess=0,actionSuccess=0,actionConSuccess=0,dialogFail=0,dialogConFail=0,queriesSuccess=0,queriesConSuccess=0,queriesFail=0,queriesConFail=0,alertFail=0,alertConFail=0,actionFail=0,actionConFail=0,taskBarGraph=0,queriesTotalEach=0,queriesConTotalEach=0;$scope.tasksStats={alertsTotal:0,actionsTotal:0,chatsTotal:0,tasksTotal:0,queriesTotal:[],barGraphDate:[],tasksPerformedTotal:0,alertsConTotal:0,taskBarGraph:[]},$.each(res.data.results,function(index,result){alertsTotal+=void 0===(result.noOfEntUserAlerts||result.noOfUserAlerts)?0:result.noOfEntUserAlerts||result.noOfUserAlerts,alertsConTotal+=result.noOfConUserAlerts||0,actionsTotal+=void 0===(result.noOfEntUserActions||result.noOfUserActions)?0:result.noOfEntUserActions||result.noOfUserActions,actionsConTotal+=result.noOfConUserActions||0,queriesTotal+=void 0===(result.noOfEntFaqSuccess||result.noOfFaqSuccess)?0:result.noOfEntFaqSuccess||result.noOfFaqSuccess,queriesConTotal+=result.noOfConFaqSuccess||0,queriesTotalEach=void 0===(result.noOfEntFaqSuccess||result.noOfFaqSuccess)?0:result.noOfEntFaqSuccess||result.noOfFaqSuccess,queriesConTotalEach=result.noOfConFaqSuccess||0,dialogsTotal+=void 0===(result.noOfEntDialogSuccess||result.noOfDialogSuccess1)?0:result.noOfEntDialogSuccess||result.noOfDialogSuccess1,dialogsConTotal+=result.noOfConDialogSuccess||0,result.noOfChats=Number(void 0===(result.noOfEntChatRequest||result.noOfChatRequest)?0:result.noOfEntChatRequest||result.noOfChatRequest)+Number(result.noOfConChatRequest||0)+Number(void 0===(result.noOfEntChatResponse||result.noOfChatResponse)?0:result.noOfEntChatResponse||result.noOfChatResponse)+Number(result.noOfConChatResponse||0),chatsTotal+=result.noOfChats,result.taskGraph=Number(void 0===(result.noOfEntUserActions||result.noOfUserActions)?0:result.noOfEntUserActions||result.noOfUserActions)+Number(result.noOfConUserActions||0)+Number(void 0===(result.noOfEntDialogSuccess||result.noOfDialogSuccess1)?0:result.noOfEntDialogSuccess||result.noOfDialogSuccess1)+Number(result.noOfConDialogSuccess||0)+Number(void 0===(result.noOfEntUserAlerts||result.noOfUserAlerts)?0:result.noOfEntUserAlerts||result.noOfUserAlerts)+Number(result.noOfConUserAlerts||0),taskBarGraph=result.taskGraph,$scope.tasksStats.taskBarGraph.push(result.taskGraph),$scope.tasksStats.queriesTotal.push(queriesTotalEach+queriesConTotalEach),$scope.tasksStats.barGraphDate.push(result.date_day||result.date_hour),alertSuccess+=void 0===(result.noOfEntAlertSuccess||result.noOfAlertSuccess)?0:result.noOfEntAlertSuccess||result.noOfAlertSuccess,alertConSuccess+=result.noOfConAlertSuccess||0,actionSuccess+=void 0===(result.noOfEntActionSuccess||result.noOfActionSuccess)?0:result.noOfEntActionSuccess||result.noOfActionSuccess,actionConSuccess+=result.noOfConActionSuccess||0,dialogFail+=void 0===(result.noOfEntDialogFail||result.noOfDialogFail)?0:result.noOfEntDialogFail||result.noOfDialogFail,dialogConFail+=result.noOfConDialogFail||0,queriesSuccess+=void 0===(result.noOfEntFaqSuccess||result.noOfFaqSuccess)?0:result.noOfEntFaqSuccess||result.noOfFaqSuccess,queriesConSuccess+=result.noOfconFaqSuccess||0,queriesFail+=void 0===(result.noOfEntFaqFail||result.noOfFaqFail)?0:result.noOfEntFaqFail||result.noOfFaqFail,queriesConFail+=result.noOfconFaqFail||0,alertFail+=void 0===(result.noOfEntAlertFail||result.noOfAlertFail)?0:result.noOfEntAlertFail||result.noOfAlertFail,alertConFail+=result.noOfconAlertFail||0,actionFail+=void 0===(result.noOfEntActionFail||result.noOfActionFail)?0:result.noOfEntActionFail||result.noOfActionFail,actionConFail+=result.noOfConActionFail||0}),tasksTotal=alertsTotal+alertsConTotal+actionsTotal+actionsConTotal+chatsTotal,tasksPerformedTotal=actionsTotal+actionsConTotal+dialogsTotal+dialogsConTotal+queriesTotal+queriesConTotal,$scope.tasksStats.alertsConTotal=alertsTotal+alertsConTotal,$scope.tasksStats.alertsTotal=alertsTotal+alertsConTotal,$scope.tasksStats.actionsTotal=actionsTotal+actionsConTotal,$scope.tasksStats.chatsTotal=chatsTotal,$scope.tasksStats.tasksTotal=tasksTotal,tasksPerformedTotal=actionsTotal+actionsConTotal+dialogsTotal+dialogsConTotal+queriesTotal+queriesConTotal,$scope.tasksStats.tasksPerformedTotal=tasksPerformedTotal,groupBarChart()}},responseHandleChannelsMetrics=function(res){var payload={};if(payload.filters={},payload.filters.sessionCategory=$scope.selectedSessionFilter,res&&res.data){$scope.channelsData=res.data;for(var channelsData=[],i=0;i<res.data.results.length;i++){var obj={};obj.name=$scope._channelConfig.channelsObject[res.data.results[i].channel].name,obj.count=res.data.results[i].noOfChatRequest+res.data.results[i].noOfChatResponse,obj.icon=$scope._channelConfig.channelsObject[res.data.results[i].channel].icon,channelsData.push(obj)}$scope.languagesAndChannelsData[0].data=channelsData,$scope.selectedLinkedBots&&0!==$scope.selectedLinkedBots.length?($scope.languagesAndChannelsData[0].isLinkedBotSelected=!0,$scope.isLinkedBotSelectedClone=!0):($scope.languagesAndChannelsData[0].isLinkedBotSelected=!1,$scope.isLinkedBotSelectedClone=!1)}},responseHandleSessionsCount=function(res){if(res&&res.data){for(var sum=0,i=0;i<res.data.sessionBuckets.length;i++)sum+=res.data.sessionBuckets[i].sessions;$scope.scount=sum}};$scope.selectRange=function(selectedRange){$scope.fakeDataUI||($scope.selectedRange=selectedRange,"custom"===$scope.selectedRange?("7days"==$scope.appliedSelectedRange?($('input[name="daterange"]').data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM-DD-YYYY")),$('input[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))):"24hours"==$scope.appliedSelectedRange&&($('input[name="daterange"]').data("daterangepicker").setStartDate(moment().format("MM-DD-YYYY")),$('input[name="daterange"]').data("daterangepicker").setEndDate(moment().format("MM-DD-YYYY"))),daterangepickerInput.click()):"7days"===$scope.selectedRange?getDashboardData():"24hours"===$scope.selectedRange&&getDashboardData())};var reloadDockStatus=!0;$rootScope.$on("usageMetricsStatus",function($event,data,type){reloadDockStatus&&(data&&"IN_PROGRESS"===data.status?console.log(data):data&&"SUCCESS"===data.status&&100===data.percentageComplete&&data.response?"DASHBOARDREPORT_API"===type?"universalbot"===$scope.stream.type?(responseHandleDashboardCount({data:data.response}),responseHandleDashboardChats({data:data.response})):responseHandleDashboardCount({data:data.response}):"CHATSDASHBOARDREPORT_API"===type?responseHandleDashboardChats({data:data.response}):"ENTERPRISEACTIONREPORT_API"===type?taskResponseHandle({data:data.response}):"CHANNELREPORT_API"===type?responseHandleChannelsMetrics({data:data.response}):"ENTERPRISEDASHBOARDREPORT_API"===type?drawUniPieChart({data:data.response}):"SESSIONCOUNTFORCHART_API"===type?responseHandleSessionsCount({data:data.response}):"AGENTTRANSFERREPORT_API"===type&&agentTransferResponseHandle({data:data.response}):data&&"FAILURE"===data.status&&100===data.percentageComplete&&console.log(data))}),$scope.checkDockStatus=function(){$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer")},$scope.realTimeDashboardChannelData=function(){BTStreamsService.realTimeDashboardChannels($applicationService.userInfo().userId,$applicationService.userInfo().orgId,$workflowService.selectedStream()._id).then(function(res){$scope.realTimeChannelsData=res.data})},$scope.refreshRealTimeData=function(){realTimeDashboardData(),$scope.realTimeDashboardChannelData(),$scope.realTime=moment().format("HH:mm:ss"),$scope.realTimeZone=moment.tz(moment.tz.guess()).format("z")},$scope.filterTags=[],$scope.clearFilterTags=function(){$scope.filterTags=[],$scope.resetFilter(),$scope.doneChannelFilter()},$scope.removeFilterTag=function(index,tag){"channel"===tag.type&&$scope.conversationFilter.selectedChannel.splice(index,1),$scope.filterTags.splice(index,1),$scope.doneChannelFilter()},load(),angular.element($window).on("resize",function(e){"dashboard"==$scope.activeType&&(groupBarChart(),drawBarGraph(),drawPieChartNew())}),$timeout(function(){angular.element($window).trigger("resize")},350),$scope.hideSessionsGraph=function(){$(".legend-label.sessions").hasClass("sessionsOpacity")?($(".ySideRight").css("display","block"),$(".sessionsLine").css("display","block"),$(".sessionsCircle").css("display","block"),$(".legend-label.sessions").removeClass("sessionsOpacity")):($(".ySideRight").css("display","none"),$(".sessionsLine").css("display","none"),$(".sessionsCircle").css("display","none"),$(".legend-label.sessions").addClass("sessionsOpacity"))},$scope.hideChartsGraph=function(){$(".legend-label.bot-chats").hasClass("sessionsOpacity")?($(".ySideLeft").css("display","block"),$(".chartsLine").css("display","block"),$(".chartsCircle").css("display","block"),$(".legend-label.bot-chats").removeClass("sessionsOpacity")):($(".ySideLeft").css("display","none"),$(".chartsLine").css("display","none"),$(".chartsCircle").css("display","none"),$(".legend-label.bot-chats").addClass("sessionsOpacity"))},$scope.updatedropDown=function(tag,index){$scope.search.nameSearchQuery="",tag.selectedValues=[],tag.selectedValues=tag.values,$scope.selectedTagsArray[index]=tag,$scope.selectedTagsArray[index].values=[],$scope.addCustomTags(index)},$scope.addCustomTags=function(index){$scope.selectedTagsArray.length===index+1&&$scope.selectedTagsArray.push({name:"",values:[],type:""})},$scope.removeCustomsTags=function(index){$scope.selectedTagsArray.splice(index,1),$($(".host .tags input")[index]).val("")},$scope.searchValues=function(term,value){$scope.returnValue=[];var filterValue=value.filter(function(el){return null!==el&&""!==el&&void 0!==el});return value&&filterValue.forEach(function(item,index){item&&item.toLowerCase().indexOf(term.toLowerCase())>=0&&$scope.returnValue.push(item)}),$scope.returnValue},$scope.dynamicHeight=function(e,selectedTag){setTimeout(function(){var ele=e.target;ele.style.height="30px",$(ele).hasClass("ng-invalid")?(selectedTag.invalidValue=!0,$(".disabledClass").attr("disabled","disabled")):(selectedTag.invalidValue=!1,$(".disabledClass").removeAttr("disabled"))},150)},$scope.migrationBanner=!0,$scope.closeMigrationBanner=function(){$scope.migrationBanner=!1},$scope.calculateHeight=function(e){var ele=e.target;ele.style.height="auto"},$scope.searchClick=function(event){event.preventDefault(),event.stopPropagation()},$scope.filterCustomTags=function(customTag){var _item=_.find($scope.selectedTagsArray,{name:customTag.name});return _item?!1:!0},$scope.$emit("nestedComponentLoaded",{id:"dashboard",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.$on("$destroy",function(){window.dashboardRefreshIntervalTimer&&clearInterval(window.dashboardRefreshIntervalTimer),$(".rightPanel.paddingRightPanel").removeClass("realTimeDashboardDiv")})}]),_module.filter("slice",function(){return function(arr,start,end){return(arr||[]).slice(start,end)}}),_module.filter("patternChange",function(){return function(input){return input.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&Lt;/g,"<").replace(/&Gt;/g,">")}})}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btDatatableService",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-datatable-service/bt-datatable-service.html",controller:"btDatatableServiceController"}}),_module.controller("btDatatableServiceController",["$scope","$window","$workflowService","$element","$location",function($scope,$window,$workflowService,$element,$location){$scope.DaasUrl=window.appConfig.API_SERVER_URL+"/analytics/tables";var iframe=$("#DaasFrame");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")})})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTDialogReportsCtrl",["$scope","$translator","$modalInstance","$modal","config","$filter","$rootScope","$routeParams","$timeout","$location","$workflowService","BTSeedDataService","NotificationService","BTAlertsService","BTActionsService","BTStreamsService","$applicationService","form_util","i18n",function($scope,$translator,$modalInstance,$modal,config,$filter,$rootScope,$routeParams,$timeout,$location,$workflowService,BTSeedDataService,NotificationService,BTAlertsService,BTActionsService,BTStreamsService,$applicationService,form_util,i18n){$scope.config=config,$scope.reportCb={},$scope.reportCb.editTemplateOpened=function(){$scope.showEditReportTemplate=!0},$scope.reportCb.editTemplateClosed=function(){$scope.showEditReportTemplate=!1},$scope.reportCb.onDialogReportSaved=function(dialog){$scope.config.component=dialog,$scope.config.dialogReportCB.onDialogReportSave(dialog),$scope.closeModal()},$scope.editReportText=i18n.i18nString("bt_dialog_report_editReport"),$scope.generateReport=i18n.i18nString("bt_dialog_report_generateReport"),$modalInstance.opened.then(function(){$timeout(function(){$(".bt-dialog-reports-modal").modal({show:!0,backdrop:"static"})},300)}),$scope.sampleResponseKeys=[],$scope.init=function(){$scope.component=$scope.config.component,$scope.editReport=$scope.config.editReport,$scope.displayMode=$scope.config.displayMode},$scope.closeModal=function(){$modalInstance.close(),$scope.savingReport=!1},$scope.saveReport=function(){$scope.reportCb.getReportForm().$invalid?form_util.touch($scope.reportCb.getReportForm()):$scope.savingReport=!0,setTimeout(function(){$scope.savingReport=!1},1e4),$rootScope.$on("confSaveTriggerStatus",function(e,status){$scope.savingReport=!1,console.log("report saved")}),$rootScope.$broadcast("confSaveTrigger",{callback:function(res){$scope.savingReport=!1}})},$scope.init()}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btExportBot",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-export/bt-exportBot.html",controller:"BTExportBotCtrl"}}),_module.controller("BTExportBotCtrl",["$scope","$translator","$filter","$rootScope","$routeParams","$timeout","$location","$workflowService","NotificationService","$applicationService","BTFlowtaskService","env_conf","accessControlService","_constants_","BTStreamsService","i18n","mixPanel",function($scope,$translator,$filter,$rootScope,$routeParams,$timeout,$location,$workflowService,NotificationService,$applicationService,BTFlowtaskService,env_conf,accessControlService,_constants_,BTStreamsService,i18n,mixPanel){function startPollExportStatus(timeout){return setInterval(function(){BTFlowtaskService.exportStatusBot(_selectedStream._id).then(function(res){res&&res.data&&($rootScope.$broadcast("getProgressDockStatus"),$scope.bot.exportType=res.data.exportType,"success"===res.data.status?($scope.callback.exporttype=res.data.exportType.charAt(0).toUpperCase()+res.data.exportType.substr(1),$scope.callback.downloadFlag=!1,$scope.createdOn=res.data.createdOn,$scope.downloadFileId=res.data.fileId,$scope.storeParams=res.data.store.urlParams,stopExportBotPolling("success")):"failed"===res.data.status&&stopExportBotPolling("failed"))},function(err){400==err.status&&$rootScope.$broadcast("getProgressDockStatus"),stopExportBotPolling();var _msg=i18n.i18nString("error_on_fetching_bot_export_status");err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(_msg,"error")})},timeout)}function stopExportBotPolling(_status){$scope._exportStatusInit&&(clearTimeout($scope._exportStatusInit),$scope._exportStatusInit=null),"success"===_status?finishedExport():$scope.callback.exporting="failed"}function finishedExport(){$scope._exportStatusInit&&clearTimeout($scope._exportStatusInit),$scope.callback.exporting="finished"}function getAllCollections(){BTStreamsService.btGetAllCollections($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){res&&res.data&&($scope.btCollectionVariables.collectionList=res.data,$scope.btCollectionVariables.collectionList&&$scope.btCollectionVariables.collectionList.length?$scope.btCollectionVariables.collectionList.forEach(function(item){item.isActive&&($scope.btCollectionVariables.selectedCollection=item)}):$scope.btCollectionVariables.collectionType="EMPTY")},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_collections"),"error")})}function checkCollectionsExist(){var selectedAccount=$workflowService.selectedAccount();console.log(selectedAccount),selectedAccount&&selectedAccount.customSettings&&selectedAccount.customSettings.useCollections===!0&&(getAllCollections(),$scope.btCollectionVariables.useCollections=selectedAccount.customSettings.useCollections)}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.bot={},$scope.taskToLoad=300,$scope.bot.exportType="published",$scope.selectedAccount=$workflowService.selectedAccount(),$scope.partialImportAllowed=!$scope.selectedAccount.platformVersion||!$scope.selectedAccount.accountType,$scope.callback.exporting="initial",$scope.reloadpng=env_conf["context-url"]+"/assets/images/reload.png",$scope.help=env_conf["context-url"]+"/assets/icons-new/help/help-dark.svg",$scope._exportStatusInit=null,$scope.callback.downloadUrl=null,$scope._constants_=_constants_,$scope.callback.downloadFlag=!1;var _selectedStream=$workflowService.selectedStream();$scope.botType=_selectedStream.type,$scope.allTasksSortedData=$workflowService.allTasksSortedData(),$scope.selectedState="published",$scope.allTasksSelectedPublished=!0,$scope.allTasksSelectedIndevelopment=!0,$scope.allFormsSelectedPublished=!0,$scope.allFormsSelectedIndevelopment=!0,$scope.bot.independentTasks=!0,$scope.bot.independentForms=!0,$scope.allTasksDataPublishedCopy=[],$scope.allFormsDataPublishedCopy=[],$scope.allTasksDataIndevelopmentCopy=[],$scope.allFormsDataIndevelopmentCopy=[],$scope.suspendedCheck=[],$scope.rejectedCheck=[],$scope.suspendedFormsCheck=[],$scope.rejectedFormsCheck=[],$scope.manageCollectionVarEnable=!1,$scope.btCollectionVariables={},$scope.btCollectionVariables.collectionList=[],$scope.btCollectionVariables.useCollections=!1,$scope.btCollectionVariables.collectionType="EXPORT",$scope.tasksLoaded=!1,$scope.formsNoded=!1,$scope.prepareFormsData=function(){$scope.formsNoded||($scope.formsNoded=!0,$scope.allTasksSortedData=$workflowService.allTasksSortedData(),$scope.allTasksSortedData&&$scope.allTasksSortedData.uiForms&&$scope.allTasksSortedData.uiForms.published&&$scope.allTasksSortedData.uiForms.published.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData&&$scope.allTasksSortedData.uiForms&&$scope.allTasksSortedData.uiForms.published&&($scope.allFormsDataPublished=$scope.allFormsDataPublished.concat($scope.allTasksSortedData.uiForms.published)),$scope.allTasksSortedData&&$scope.allTasksSortedData.uiForms&&($scope.suspendedFormsCheck=_.filter($scope.allTasksSortedData.uiForms,function(data){return"suspended"==data.state})),$scope.allTasksSortedData&&$scope.allTasksSortedData.uiForms&&$scope.allTasksSortedData.uiForms.indevelopment&&$scope.allTasksSortedData.uiForms.indevelopment.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData.uiForms&&$scope.allTasksSortedData.uiForms.indevelopment&&($scope.allFormsDataIndevelopment=$scope.allFormsDataIndevelopment.concat($scope.allTasksSortedData.uiForms.indevelopment)),$scope.allTasksSortedData&&$scope.allTasksSortedData.uiForms&&($scope.rejectedFormsCheck=_.filter($scope.allTasksSortedData.uiForms,function(data){return"rejected"==data.state})))},$scope.prepareTasksData=function(){$scope.allTasksSortedData=$workflowService.allTasksSortedData(),$scope.allTasksSortedData&&$scope.allTasksSortedData.dialogTasks&&$scope.allTasksSortedData.dialogTasks.published&&$scope.allTasksSortedData.dialogTasks.published.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData&&$scope.allTasksSortedData.actionTasks&&$scope.allTasksSortedData.actionTasks.published&&$scope.allTasksSortedData.actionTasks.published.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData&&$scope.allTasksSortedData.alertTasks&&$scope.allTasksSortedData.alertTasks.published&&$scope.allTasksSortedData.alertTasks.published.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData&&$scope.allTasksSortedData.informationTasks&&$scope.allTasksSortedData.informationTasks.published&&$scope.allTasksSortedData.informationTasks.published.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData&&$scope.allTasksSortedData.actionTasks&&$scope.allTasksSortedData.actionTasks.published&&($scope.allTasksDataPublished=$scope.allTasksDataPublished.concat($scope.allTasksSortedData.actionTasks.published)),$scope.allTasksSortedData&&$scope.allTasksSortedData.informationTasks&&$scope.allTasksSortedData.informationTasks.published&&($scope.allTasksDataPublished=$scope.allTasksDataPublished.concat($scope.allTasksSortedData.informationTasks.published)),$scope.allTasksSortedData&&$scope.allTasksSortedData.alertTasks&&$scope.allTasksSortedData.alertTasks.published&&($scope.allTasksDataPublished=$scope.allTasksDataPublished.concat($scope.allTasksSortedData.alertTasks.published)),$scope.allTasksSortedData&&$scope.allTasksSortedData.dialogTasks&&$scope.allTasksSortedData.dialogTasks.published&&($scope.allTasksDataPublished=$scope.allTasksDataPublished.concat($scope.allTasksSortedData.dialogTasks.published)),$scope.suspendedCheck=_.filter($scope.allTasksDataPublished,function(data){return"suspended"==data.state}),$scope.allTasksDataPublished=_.filter($scope.allTasksDataPublished,function(data){return"published"==data.state}),$scope.allTasksSortedData&&$scope.allTasksSortedData.dialogTasks&&$scope.allTasksSortedData.dialogTasks.indevelopment&&$scope.allTasksSortedData.dialogTasks.indevelopment.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData&&$scope.allTasksSortedData.actionTasks&&$scope.allTasksSortedData.actionTasks.indevelopment&&$scope.allTasksSortedData.actionTasks.indevelopment.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData&&$scope.allTasksSortedData.alertTasks&&$scope.allTasksSortedData.alertTasks.indevelopment&&$scope.allTasksSortedData.alertTasks.indevelopment.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData&&$scope.allTasksSortedData.informationTasks&&$scope.allTasksSortedData.informationTasks.indevelopment&&$scope.allTasksSortedData.informationTasks.indevelopment.forEach(function(task){task.selected=!0}),$scope.allTasksSortedData.actionTasks&&$scope.allTasksSortedData.actionTasks.indevelopment&&($scope.allTasksDataIndevelopment=$scope.allTasksDataIndevelopment.concat($scope.allTasksSortedData.actionTasks.indevelopment)),$scope.allTasksSortedData.informationTasks&&$scope.allTasksSortedData.informationTasks.indevelopment&&($scope.allTasksDataIndevelopment=$scope.allTasksDataIndevelopment.concat($scope.allTasksSortedData.informationTasks.indevelopment)),$scope.allTasksSortedData.alertTasks&&$scope.allTasksSortedData.alertTasks.indevelopment&&($scope.allTasksDataIndevelopment=$scope.allTasksDataIndevelopment.concat($scope.allTasksSortedData.alertTasks.indevelopment)),$scope.allTasksSortedData.dialogTasks&&$scope.allTasksSortedData.dialogTasks.indevelopment&&($scope.allTasksDataIndevelopment=$scope.allTasksDataIndevelopment.concat($scope.allTasksSortedData.dialogTasks.indevelopment)),$scope.allTasksDataIndevelopment=_.filter($scope.allTasksDataIndevelopment,function(data){return"configured"==data.state||"inProgress"==data.state||"awaitingApproval"==data.state||"published"==data.state}),$timeout(function(){$scope.tasksLoaded=!0},300)},$scope.getTasks=function(){$scope.callback.getAllTasks().then(function(res){$scope.prepareTasksData(),$scope.prepareSliderData()},function(params){})},$scope.tasksSelectionLengthIndevelopment=i18n.i18nString("bt_export_all_tasks"),$scope.formsSelectionLengthIndevelopment=i18n.i18nString("bt_export_all_forms"),$scope.formsSelectionLengthPublished=i18n.i18nString("bt_export_all_forms"),$scope.tasksSelectionLengthPublished=i18n.i18nString("bt_export_all_tasks"),$scope.allTasksDataPublished=[],$scope.allFormsDataPublished=[],$scope.allTasksDataIndevelopment=[],$scope.allFormsDataIndevelopment=[],$scope.orderType="-lMod",$scope.taskName={actionTasks:i18n.i18nString("action_tasks_uppercase"),alertTasks:i18n.i18nString("alert_tasks_uppercase"),dialogTasks:i18n.i18nString("dialog_tasks_uppercase"),informationTasks:i18n.i18nString("information_tasks_uppercase"),forms:i18n.i18nString("uiForms_uppercase")},$scope.isSmartBot=function(){return"solution"===_selectedStream.type?!0:!1},$scope.isSampleBot=function(){return"sample"===_selectedStream.type?!0:!1},"universalbot"==_selectedStream.type?($scope.linkedBots=[{task:"Linked Bots",value:"linkedBots",selected:!0,name:i18n.i18nString("linked_bots")},{task:"Small Talk",value:"smallTalk",selected:!0,name:i18n.i18nString("small_talk")}],$scope.settings=[{task:"Bot Settings",value:"botSettings",selected:!0,name:i18n.i18nString("bot_settings")},{task:"Bot Variables",value:"botVariables",selected:!0,name:i18n.i18nString("bot_variables")},{task:"Voice Call Properties",value:"ivrSettings",selected:!0,name:i18n.i18nString("ivr_properties_normal")}],$scope.nlp=2===_selectedStream.universalBotVersion?[{task:"Training Data",value:"training_data",selected:!0,name:i18n.i18nString("training_data")},{task:"Bot Synonyms",value:"bot_synonyms",selected:!0,name:i18n.i18nString("ddval_synonyms")},{task:"Settings",value:"nlpSettings",selected:!0,name:i18n.i18nString("settings")},{task:"Default Dialog",value:"defaultDialog",selected:!0,name:i18n.i18nString("default_dialog")},{task:"Standard Responses",value:"standardResponses",selected:!0,name:i18n.i18nString("ddval_standard")}]:[{task:"NLP Settings",value:"nlpSettings",name:i18n.i18nString("nlp_settings"),selected:!0},{task:"Default Dialog",value:"defaultDialog",name:i18n.i18nString("default_dialog"),selected:!0},{task:"Standard Responses",name:i18n.i18nString("default_dialog"),value:"standardResponses",selected:!0}],$scope.categories=[{key:"Bot Components",list:$scope.linkedBots,selected:!0,name:i18n.i18nString("botComponents")},{key:"NLP Data",list:$scope.nlp,selected:!0,name:i18n.i18nString("nlp_data")},{key:"Settings",list:$scope.settings,selected:!0,name:i18n.i18nString("settings")},{key:"Custom Dashboards",selected:!0,name:i18n.i18nString("custonDashboards")}]):($scope.tasks=[{task:"Tasks",value:"botTask",selected:!0,name:i18n.i18nString("Tasks_label")},{task:"Knowledge Graph",value:"knowledgeGraph",selected:!0,name:i18n.i18nString("knowledge_graph")},{task:"Small Talk",value:"smallTalk",selected:!0,name:i18n.i18nString("small_talk")}],$scope.tasks.push({task:"Digital Forms",value:"forms",selected:!0,name:i18n.i18nString("ui_forms_label")}),$scope.settings=[{task:"Bot Settings",value:"botSettings",selected:!0,name:i18n.i18nString("bot_settings")},{task:"Bot Variables",value:"botVariables",selected:!0,name:i18n.i18nString("bot_variables")},{task:"Voice Call Properties",value:"ivrSettings",selected:!0,name:i18n.i18nString("ivr_properties_normal")}],$scope.nlp=[{task:"NLP Settings",value:"nlpSettings",selected:!0,name:i18n.i18nString("nlp_settings")},{task:"Utterances",value:"utterances",selected:!0,name:i18n.i18nString("Utterances")},{task:"Patterns",value:"patterns",selected:!0,name:i18n.i18nString("Patterns")},{task:"Standard Responses",value:"standardResponses",selected:!0,name:i18n.i18nString("ddval_standard")}],$scope.categories=[{key:"Bot Tasks",list:$scope.tasks,selected:!0,name:i18n.i18nString("task_name")},{key:"NLP Data",list:$scope.nlp,selected:!0,name:i18n.i18nString("nlp_data")},{key:"Settings",list:$scope.settings,selected:!0,name:i18n.i18nString("settings")},{key:"Custom Dashboards",selected:!0,name:i18n.i18nString("custonDashboards")}]),$scope.showNameSearch=!1,$scope.search={},$scope.latestcategories=$workflowService.cloneData($scope.categories);(function(){return function(data,name){var blob=null,url="";if(navigator.msSaveBlob)return blob=new Blob(data,{type:"octet/stream"}),window.navigator.msSaveOrOpenBlob(blob,name);var a=document.createElement("a");document.body.appendChild(a),a.style="display: none",blob=new Blob(data,{type:"octet/stream"}),url=window.URL.createObjectURL(blob),a.href=url,a.download=name,a.click(),window.URL.revokeObjectURL(url)}})();$scope.callback.downloadFile=function(evt){evt.preventDefault(),$scope.url=$scope.storeParams,BTStreamsService.downloadProgressDockExportFile($scope.downloadFileId).then(function(res){if(res&&res.data){$scope.callback.downloadUrl=res.data.fileUrl+$scope.url;var xyz="#downloadFile";$(xyz).attr("href",$scope.callback.downloadUrl),$timeout(function(){$(xyz).get(0).click(function(e){e.stopPropagation()})},450)}})},$scope.exportBot=function(){function startExport(){NotificationService.notify(i18n.i18nString("bt_export_export_in_progress_noty"),"success"),$scope._exportStatusInit&&clearTimeout($scope._exportStatusInit),$scope.callback.exporting="pending";var taskResult,nlpdata,showFailedErrors,payload={exportOptions:{},exportType:$scope.bot.exportType};if(payload.IncludeDependentTasks=$scope.bot.independentTasks,$scope.btCollectionVariables.selectedCollection&&$scope.btCollectionVariables.useCollections&&(payload.activeCollectionRefId=$scope.btCollectionVariables.selectedCollection.refId),"universalbot"==_selectedStream.type)payload.exportOptions.botComponents=[],payload.exportOptions.nlpData=[],payload.exportOptions.settings=[],"published"===$scope.bot.exportType?(taskResult=$scope.categories[0].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.botComponents.push(key.value)}),nlpdata=$scope.categories[1].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.nlpData.push(key.value)}),showFailedErrors=$scope.categories[2].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.categories[3].key&&$scope.categories[3].selected?payload.customDashboards=!0:payload.customDashboards=!1):"latest"===$scope.bot.exportType&&(taskResult=$scope.latestcategories[0].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.botComponents.push(key.value)}),nlpdata=$scope.latestcategories[1].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.nlpData.push(key.value)}),showFailedErrors=$scope.latestcategories[2].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.latestcategories[3].key&&$scope.latestcategories[3].selected?payload.customDashboards=!0:payload.customDashboards=!1);else{if(payload.exportOptions.tasks=[],payload.exportOptions.nlpData=[],payload.exportOptions.settings=[],"published"===$scope.bot.exportType?(taskResult=$scope.categories[0].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.tasks.push(key.value)}),nlpdata=$scope.categories[1].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.nlpData.push(key.value)}),showFailedErrors=$scope.categories[2].list.forEach(function(key,value){
key.selected===!0&&payload.exportOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.categories[3].key&&$scope.categories[3].selected?payload.customDashboards=!0:payload.customDashboards=!1):"latest"===$scope.bot.exportType&&(taskResult=$scope.latestcategories[0].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.tasks.push(key.value)}),nlpdata=$scope.latestcategories[1].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.nlpData.push(key.value)}),showFailedErrors=$scope.latestcategories[2].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.latestcategories[3].key&&$scope.latestcategories[3].selected?payload.customDashboards=!0:payload.customDashboards=!1),"botTask"===payload.exportOptions.tasks[0]?payload.subTasks=$scope.saveTasksID($scope.bot.exportType):payload.subTasks={},payload.exportOptions.tasks.indexOf("forms")>-1){payload.IncludeFormDependentTasks=$scope.bot.independentForms;var subForms=$scope.saveFormsID($scope.bot.exportType);$("#formSelectionSlider .tableContainer .checkbox input:checked").length===$("#formSelectionSlider .tableContainer .checkbox input").length?payload.allForms=!0:(payload.allForms=!1,payload.subTasks.forms=subForms||{})}"botTask"===payload.exportOptions.tasks[0]&&$("#taskSelectionSlider .tableContainer .checkbox input:checked").length===$("#taskSelectionSlider .tableContainer .checkbox input").length?payload.allTasks=!0:payload.allTasks=!1}BTFlowtaskService.exportBot(_selectedStream._id,payload).then(function(res){if(res&&res.data&&($scope.bot.exportType=res.data.exportType,$scope.streamRefId=res.data._id||"",$scope.statusLogs=res.data.statusLogs||[],"pending"===res.data.status?($scope.callback.exporting=res.data.status,$rootScope.$broadcast("getProgressDockStatus"),$(".trainingProgress").addClass("open"),$scope._exportStatusInit=startPollExportStatus(3e3)):"success"===res.data.status?($rootScope.$broadcast("getProgressDockStatus"),$(".trainingProgress").addClass("open"),$scope.callback.exporttype=res.data.exportType.charAt(0).toUpperCase()+res.data.exportType.substr(1),stopExportBotPolling("success")):stopExportBotPolling("failed"),res.data&&res.data.store&&res.data.store.timeoutMessage)){var msg=res.data.store.timeoutMessage;NotificationService.notify(msg,"warning")}},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("bt_export_unexpected_err_while_exporting"),"error");if("RequestExists"===error.data.errors[0].code){var _msg1=error.data.errors[0].code;NotificationService.notify(_msg1,"warning")}$scope.callback.exporting="failed"})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};mixPanel.postEvent("Export Bot",_botInfo),$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_bot")):startExport()},$scope.callback.setToInitial=function(){$scope.callback.exporting="initial"},$scope.getExportBotStatus=function(){console.log("called"),BTFlowtaskService.exportStatusBot(_selectedStream._id).then(function(res){res&&res.data&&($scope.bot.exportType=res.data.exportType,"pending"===res.data.status?($scope.callback.exporting=res.data.status,$scope._exportStatusInit=startPollExportStatus(3e3)):"success"===res.data.status?($scope.createdOn=res.data.createdOn,$scope.callback.exporttype=res.data.exportType.charAt(0).toUpperCase()+res.data.exportType.substr(1),$scope.callback.downloadFlag=!0,$scope.downloadFileId=res.data.fileId,$scope.storeParams=res.data.store.urlParams,stopExportBotPolling("success")):""===res.data?$scope.callback.exporting="initial":stopExportBotPolling("failed"))})},$scope.callback.getDate=function(){var timestamp=$scope.createdOn;return void 0===timestamp?"--":moment(timestamp).format("MM-DD-YYYY")},$scope.callback.getTime=function(){var timestamp=$scope.createdOn;return void 0===timestamp?"--":moment(timestamp).format("h:mm A")},$scope.clickerTask=function(task,e,index){e.stopPropagation(),angular.element("#componentExport"+index).parent().hasClass("intermediate")&&angular.element("#componentExport"+index).parent().removeClass("intermediate"),task.list.forEach(function(key,value){key.selected=task.selected})},$scope.clickerTaskSelection=function(state,e,id){e.stopPropagation(),0===$(id+" .tableHeaderRow input:checked").length?"published"===state?"#formSelectionSlider"===id?$scope.allFormsDataPublishedCopy.forEach(function(key,value){key.selected=!1}):$scope.allTasksDataPublishedCopy.forEach(function(key,value){key.selected=!1}):"#formSelectionSlider"===id?$scope.allFormsDataIndevelopmentCopy.forEach(function(key,value){key.selected=!1}):$scope.allTasksDataIndevelopmentCopy.forEach(function(key,value){key.selected=!1}):"published"===state?"#formSelectionSlider"===id?$scope.allFormsDataPublishedCopy.forEach(function(key,value){key.selected=!0}):$scope.allTasksDataPublishedCopy.forEach(function(key,value){key.selected=!0}):"#formSelectionSlider"===id?$scope.allFormsDataIndevelopmentCopy.forEach(function(key,value){key.selected=!0}):$scope.allTasksDataIndevelopmentCopy.forEach(function(key,value){key.selected=!0})},$scope.clickerSubTaskSelection=function(e,selectedState,id){e.stopPropagation(),"published"===selectedState?$(id+" .tableContainer .checkbox input.check:checked").length===$(id+" .tableContainer .checkbox input.check").length?"#formSelectionSlider"===id?$scope.allFormsSelectedPublished=!0:$scope.allTasksSelectedPublished=!0:"#formSelectionSlider"===id?$scope.allFormsSelectedPublished=!1:$scope.allTasksSelectedPublished=!1:$(id+" .tableContainer .checkbox input.check:checked").length===$(id+" .tableContainer .checkbox input.check").length?"#formSelectionSlider"===id?$scope.allFormsSelectedIndevelopment=!0:$scope.allTasksSelectedIndevelopment=!0:"#formSelectionSlider"===id?$scope.allFormsSelectedIndevelopment=!1:$scope.allFormsSelectedIndevelopment=!1},$scope.clickerSubTask=function(task,e,index){e.stopPropagation();var count=0;task.list.forEach(function(key,value){key.selected&&count++}),count===task.list.length?(task.selected=!0,angular.element("#componentExport"+index).parent().removeClass("intermediate")):0===count?(task.selected=!1,angular.element("#componentExport"+index).parent().removeClass("intermediate")):0!==count&&(task.selected=!0,angular.element("#componentExport"+index).parent().addClass("intermediate"))},$scope.clickerLatestTask=function(task,e,index){e.stopPropagation(),angular.element("#componentlatest"+index).parent().hasClass("intermediate")&&angular.element("#componentlatest"+index).parent().removeClass("intermediate"),task&&task.list&&task.list.length&&task.list.forEach(function(key,value){key.selected=task.selected})},$scope.clickerLatestSubTask=function(task,e,index){e.stopPropagation();var count=0;task.list.forEach(function(key,value){key.selected&&count++}),count===task.list.length?(task.selected=!0,angular.element("#componentlatest"+index).parent().removeClass("intermediate")):0===count?(task.selected=!1,angular.element("#componentlatest"+index).parent().removeClass("intermediate")):0!==count&&(task.selected=!0,angular.element("#componentlatest"+index).parent().addClass("intermediate"))},$scope.prepareSliderData=function(){if("published"===$scope.selectedState){$scope.allTasksDataPublishedCopy=$workflowService.cloneData($scope.allTasksDataPublished);var selectAllPublishedFlag=_.filter($scope.allTasksDataPublishedCopy,{selected:!0});selectAllPublishedFlag.length===$scope.allTasksDataPublishedCopy.length?$scope.allTasksSelectedPublished=!0:$scope.allTasksSelectedPublished=!1}else{$scope.allTasksDataIndevelopmentCopy=$workflowService.cloneData($scope.allTasksDataIndevelopment);var selectAllIndevelopmentFlag=_.filter($scope.allTasksDataIndevelopmentCopy,{selected:!0});selectAllIndevelopmentFlag.length===$scope.allTasksDataIndevelopmentCopy.length?$scope.allTasksSelectedIndevelopment=!0:$scope.allTasksSelectedIndevelopment=!1}$timeout(function(){$scope.loadingTasksList=!1},200)},$scope.openTasksSlider=function(state,type){if($scope.taskToLoad=300,$scope.showNameSearch=!1,$scope.loadingTasksList=!0,$scope.search.nameSearchQuery="",$scope.selectedState=state,"forms"===type){if($scope.prepareFormsData(),"published"===$scope.selectedState){$scope.allFormsDataPublishedCopy=$workflowService.cloneData($scope.allFormsDataPublished);var selectAllPublishedFormsFlag=_.filter($scope.allFormsDataPublishedCopy,{selected:!0});selectAllPublishedFormsFlag.length===$scope.allFormsDataPublishedCopy.length?$scope.allFormsSelectedPublished=!0:$scope.allFormsSelectedPublished=!1}else{$scope.allFormsDataIndevelopmentCopy=$workflowService.cloneData($scope.allFormsDataIndevelopment);var selectAllFormsIndevelopmentFlag=_.filter($scope.allFormsDataIndevelopmentCopy,{selected:!0});selectAllFormsIndevelopmentFlag.length===$scope.allFormsDataIndevelopmentCopy.length?$scope.allFormsSelectedIndevelopment=!0:$scope.allFormsSelectedIndevelopment=!1}$scope.openModalSlider("#formSelectionSlider")}else $scope.tasksLoaded?$scope.prepareSliderData():$scope.callback.getAllTasks().then(function(res){$scope.prepareTasksData(),$scope.prepareSliderData()},function(params){}),$scope.openModalSlider("#taskSelectionSlider")},$scope.loadMore=function(type){"published"===type?$scope.taskToLoad=$scope.allTasksDataPublishedCopy.length:$scope.taskToLoad=$scope.allTasksDataIndevelopmentCopy.length},checkCollectionsExist(),$scope.openCollectionSlider=function(){$scope.manageCollectionVarEnable=!0,$scope.btCollectionVariables.exportBot=!0,$scope.btCollectionVariables.collectionType="EXPORT",setTimeout(function(){$scope.openModalSlider("#manageCollectionsSlider")},200)},$scope.btCollectionVariables.close=function(){$scope.closeModalSlider("#manageCollectionsSlider"),$scope.manageCollectionVarEnable=!1},$scope.taskSelectionSliderClose=function(){$scope.closeModalSlider("#taskSelectionSlider")},$scope.formSelectionSliderClose=function(){$scope.closeModalSlider("#formSelectionSlider")},$scope.saveTasksID=function(selectedState){var subTasks={};if(subTasks.dialogs=[],subTasks.alerts=[],subTasks.actions=[],"published"===selectedState?$scope.allTasksDataPublishedCopy.forEach(function(task){task.selected&&(task._id.startsWith("dg-")?subTasks.dialogs.push(task._id):task._id.startsWith("a-")?subTasks.actions.push(task._id):task._id.startsWith("l-")&&subTasks.alerts.push(task._id))}):$scope.allTasksDataIndevelopmentCopy&&$scope.allTasksDataIndevelopmentCopy.length&&$scope.allTasksDataIndevelopmentCopy.forEach(function(task){task.selected&&(task._id.startsWith("dg-")?subTasks.dialogs.push(task._id):task._id.startsWith("a-")?subTasks.actions.push(task._id):task._id.startsWith("l-")&&subTasks.alerts.push(task._id))}),"published"===selectedState){if($("#taskSelectionSlider .tableContainer .checkbox input:checked").length===$("#taskSelectionSlider .tableContainer .checkbox input").length)$scope.tasksSelectionLengthPublished=i18n.i18nString("bt_export_all_tasks");else{var selectedPublished=_.filter($scope.allTasksDataPublishedCopy,{selected:!0});$scope.tasksSelectionLengthPublished=selectedPublished.length+i18n.i18nString("bt_export_tasks")}$scope.allTasksDataPublished=$workflowService.cloneData($scope.allTasksDataPublishedCopy)}else if("indevelopment"===selectedState){if($("#taskSelectionSlider .tableContainer .checkbox input:checked").length===$("#taskSelectionSlider .tableContainer .checkbox input").length)$scope.tasksSelectionLengthIndevelopment=i18n.i18nString("bt_export_all_tasks");else{var selectedDevelopment=_.filter($scope.allTasksDataIndevelopmentCopy,{selected:!0});$scope.tasksSelectionLengthIndevelopment=selectedDevelopment.length+i18n.i18nString("bt_export_tasks")}$scope.allTasksDataIndevelopment=$workflowService.cloneData($scope.allTasksDataIndevelopmentCopy)}return $scope.closeModalSlider("#taskSelectionSlider"),subTasks},$scope.saveFormsID=function(selectedState){var subForms=[];return"published"===selectedState?$scope.allFormsDataPublishedCopy.forEach(function(task){task.selected&&subForms.push(task._id)}):$scope.allFormsDataIndevelopmentCopy&&$scope.allFormsDataIndevelopmentCopy.length&&$scope.allFormsDataIndevelopmentCopy.forEach(function(task){task.selected&&task.selected&&subForms.push(task._id)}),"published"===selectedState?($("#formSelectionSlider .tableContainer .checkbox input:checked").length===$("#formSelectionSlider .tableContainer .checkbox input").length?$scope.formsSelectionLengthPublished=i18n.i18nString("bt_export_all_forms"):$scope.formsSelectionLengthPublished=$("#formSelectionSlider .tableContainer .checkbox input:checked").length+i18n.i18nString("bt_export_forms"),$scope.allFormsDataPublished=$workflowService.cloneData($scope.allFormsDataPublishedCopy)):"indevelopment"===selectedState&&($("#formSelectionSlider .tableContainer .checkbox input:checked").length===$("#formSelectionSlider .tableContainer .checkbox input").length?$scope.formsSelectionLengthIndevelopment=i18n.i18nString("bt_export_all_forms"):$scope.formsSelectionLengthIndevelopment=$("#formSelectionSlider .tableContainer .checkbox input:checked").length+i18n.i18nString("bt_export_forms"),$scope.allFormsDataIndevelopment=$workflowService.cloneData($scope.allFormsDataIndevelopmentCopy)),$scope.closeModalSlider("#formSelectionSlider"),subForms},$scope.sortTaskList=function(sortType){"nameSort"==sortType&&("name"==$scope.orderType?$scope.orderType="-name":$scope.orderType="name"),"datesSort"==sortType&&("lMod"==$scope.orderType?$scope.orderType="-lMod":$scope.orderType="lMod")},$scope.activateNameSearch=function(show){show?$scope.showNameSearch=!0:($scope.search.nameSearchQuery="",$scope.showNameSearch=!1),setTimeout(function(){$(".focusNameSearch").focus()},100)},$scope.$emit("nestedComponentLoaded",{id:"exportBot",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.updateBotExport=function(e){$scope.exportBot()},$scope.$on("updateBotExport",function(evt){$scope.updateBotExport()})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-flowTask-create",["app.helpers","bt-forms"]);_module.controller("BTFlowTaskCreateCtrl",["$scope","$rootScope","$location","$workflowService","BTSeedDataService","NotificationService","BTAlertsService","BTActionsService","BTStreamsService",function($scope,$rootScope,$location,$workflowService,BTSeedDataService,NotificationService,BTAlertsService,BTActionsService,BTStreamsService){function navigateTo(screen){$scope.sections[screen]=!0,$scope.currentStage=screen,$("html, body").animate({scrollTop:0},"fast")}return $rootScope.saveAndExit=!1,$scope.displayMode="",$scope.wftype=$workflowService.workflowType(),$scope.selectedStream=$workflowService.selectedStream(),$workflowService.workflowType()?($scope.sections={showFlow:!1},$scope.entityObj={type:"flowtask"},$scope.currentStep=1,$scope.finishSetup=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.gotostream=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onCancel=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.navigateTo=function(screen){$rootScope.saveAndExit=!1,navigateTo(screen)},void navigateTo("showFlow")):void $location.path(window.appConfig.CONTEXT_PATH)}])}(angular),function(ng){"use strict";var _module=ng.module("bt-flowTask-edit",["app.helpers","bt-forms"]);_module.controller("BTFlowTaskEditCtrl",["$scope","$rootScope","$location","$workflowService","BTSeedDataService","NotificationService","BTAlertsService","BTActionsService","BTStreamsService",function($scope,$rootScope,$location,$workflowService,BTSeedDataService,NotificationService,BTAlertsService,BTActionsService,BTStreamsService){function navigateTo(screen){$scope.sections[screen]=!0,$scope.currentStage=screen,$("html, body").animate({scrollTop:0},"fast")}return $rootScope.saveAndExit=!1,$scope.displayMode="edit",$scope.wftype=$workflowService.workflowType(),$scope.flowtaskObj=$workflowService.flowtaskInfo(),$scope.selectedStream=$workflowService.selectedStream(),$workflowService.workflowType()?($scope.sections={showFlow:!1},$scope.entityObj={type:"flowtask"},$scope.currentStep=1,$scope.finishSetup=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.gotostream=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onCancel=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.navigateTo=function(screen){$rootScope.saveAndExit=!1,navigateTo(screen)},void navigateTo("showFlow")):void $location.path(window.appConfig.CONTEXT_PATH)}])}(angular),function(ng){"use strict";var _module=ng.module("bt-flowTask-view",["app.helpers","bt-forms"]);_module.controller("BTFlowTaskViewCtrl",["$scope","$rootScope","$location","$workflowService","BTSeedDataService","NotificationService","BTAlertsService","BTActionsService","BTStreamsService",function($scope,$rootScope,$location,$workflowService,BTSeedDataService,NotificationService,BTAlertsService,BTActionsService,BTStreamsService){function navigateTo(screen){$scope.sections[screen]=!0,$scope.currentStage=screen,$("html, body").animate({scrollTop:0},"fast")}return $rootScope.saveAndExit=!1,$scope.displayMode="view",$scope.wftype=$workflowService.workflowType(),$scope.flowtaskObj=$workflowService.flowtaskInfo(),$scope.selectedStream=$workflowService.selectedStream(),$workflowService.workflowType()?($scope.sections={showFlow:!1},$scope.entityObj={type:"flowtask"},$scope.currentStep=1,$scope.finishSetup=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.gotostream=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onCancel=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.navigateTo=function(screen){$rootScope.saveAndExit=!1,navigateTo(screen)},void navigateTo("showFlow")):void $location.path(window.appConfig.CONTEXT_PATH)}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btImportExport",["$workflowService","_constants_","$rootScope","i18n",function($workflowService,constants,$rootScope,_constants_,i18n){return{restrict:"EA",scope:{callback:"=",importFrom:"=",enterPrise:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-import-export/bt-import-export.html",controller:["$scope",function($scope){$scope.$emit("nestedComponentLoaded",{id:"btImportExport",flag:!1}),$scope.callback.activeTab="IMPORT";var searchQuery=$workflowService.storeSearchQry();searchQuery&&"export"===searchQuery.navigateTo&&($workflowService.storeSearchQry({userSearchQueryFlag:!1,searchQry:""}),setTimeout(function(){$("#exportBotTabSelection").click()},200)),$scope.checkActiveTab=function(type){"EXPORT"===type?$scope.callback.activeTab="EXPORT":"IMPORT"===type?$scope.callback.activeTab="IMPORT":$scope.callback.activeTab="IMPORT"}}]}}])}(angular),function(ng){var _module=angular.module("bt-import-bot",[]);_module.directive("btImportBot",function(){return{restrict:"EA",scope:{callback:"=",importFrom:"=",enterPrise:"=",importType:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-import/bt-importBot.html",controller:["$scope","$workflowService","BTFlowtaskService","NotificationService","$location","$endpoints","$applicationService","env_conf","$window","$route","BTFileUploadService","$rootScope","BTStreamsService","$timeout","$element","accessControlService","navigator","i18n","mixPanel",function($scope,$workflowService,BTFlowtaskService,NotificationService,$location,$endpoints,$applicationService,env_conf,$window,$route,BTFileUploadService,$rootScope,BTStreamsService,$timeout,$element,accessControlService,navigator,i18n,mixPanel){function startImportProgress(){progressInterval=setInterval(function(){$scope.totalProgress>90&&($scope.totalProgress=90),$scope.totalProgress+=.1},350)}function startPublishProgress(){progressIntervalPublish=setInterval(function(){$scope.totalProgressPublish>90&&($scope.totalProgressPublish=90),$scope.totalProgressPublish+=.1},350)}function startPollExportStatus(timeout){return setInterval(function(){BTFlowtaskService.exportStatusBot(_selectedStream._id).then(function(res){if(res&&res.data)if("success"===res.data.status&&res.data.fileId){var fileIdDownload=res.data.fileId,storeUrl=res.data.store.urlParams;BTStreamsService.downloadProgressDockExportFile(fileIdDownload).then(function(res){if(res&&res.data){$scope.hrefURL=res.data.fileUrl+storeUrl;var xyz="#backupButton";$(xyz).attr("href",$scope.hrefURL),$timeout(function(){$(xyz).get(0).click(function(e){e.stopPropagation()})},450)}},function(err){err&&err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg&&NotificationService.notify(err.data.errors[0].msg,"error")}),stopExportBotPolling("success")}else"failed"===res.data.status&&stopExportBotPolling("failed")},function(err){stopExportBotPolling("failed");var _msg=i18n.i18nString("error_on_fetching_bot_export_status");err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(_msg,"error")})},timeout)}function stopExportBotPolling(_status){$scope._exportStatusInit&&(clearTimeout($scope._exportStatusInit),$scope._exportStatusInit=null),"success"===_status?finishedExport():$scope.exporting="failed"}function finishedExport(){clearInterval($scope._exportStatusInit),$timeout(function(){$scope.exporting="finished",$scope.disableProceed=!1},3e3)}function getBTStreamsAndUpdate(){var streamId=_selectedStream&&_selectedStream._id?_selectedStream._id:"";"existingBotImport"!==$scope.importFrom&&$scope.newBotStreamId&&(streamId=$scope.newBotStreamId),streamId&&BTStreamsService.getBTStream(streamId).then(function(res){$workflowService.selectedStream(res.data),_selectedStream=res.data,$scope.selectedStream=res.data,$scope.getLicenseInfo()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})}function publishLogs(res){if($scope.messages=[],$scope.allowRetry=!0,res.length){var _msg;res.map(function(message){message.result&&message.result.name?_msg=message.result.name||message.result.resourceId:message.result&&message.result.hasOwnProperty("length")?_msg=message.result[0].name||message[0].result[0].resourceId:message.result&&"smalltalk"===message.resourceType&&!message.result.name&&(_msg="Small Talk"),"SUCCESS"===message.status?$scope.messages.push({type:"success",state:"published",message:_msg}):"FAILURE"===message.status&&$scope.messages.push({type:"error",error:getErrorMsg(message.result),message:_msg,taskId:message.resourceId})}),$scope.publishStatus="success",$scope.appControls.isBillingEnabled&&"sample"!==_selectedStream.type&&"solution"!==_selectedStream.type&&"universalbot"!==_selectedStream.type&&"private"===_selectedStream.visibility.namespace&&$scope.appControls&&$scope.selectedAccount.adminPreferences&&$scope.selectedAccount.adminPreferences.autoApproval&&$scope.selectedAccount.accountType&&1===$scope.selectedAccount.accountType?$scope.publishInTrailMsg=!0:$scope.publishInTrailMsg=!1}}function startPollPublishStatus(timeout){return setInterval(function(){BTFlowtaskService.botImportStatus($applicationService.userInfo().userId,$scope.streamRefId).then(function(res){"publish_success"===res.data.status?(pubStatus="success",stopPublish(pubStatus),res.data&&res.data.autoPublish&&publishLogs(res.data.autoPublish.response)):"publish_failed"===res.data.status&&(pubStatus="failed",stopPublish(pubStatus),res.data.autoPublish&&res.data.autoPublish.response.errors&&res.data.autoPublish.response.errors.length&&($scope.errorMess=res.data.autoPublish.response.errors[0].msg,NotificationService.notify($scope.errorMess,"error")))},function(err){$scope.allowRetry=!0,err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("something_went_wrong"),"error")})},timeout)}function getErrorMsg(message){var msg=message&&message.errors&&message.errors[0].msg||i18n.i18nString("something_went_wrong");return msg}function startPollImportStatus(timeout){return setInterval(function(){BTFlowtaskService.botImportStatus($applicationService.userInfo().userId,$scope.streamRefId).then(function(res){if(res&&res.data){res.data.streamId&&($scope.newBotStreamId=res.data.streamId,$workflowService.importedNewBotId(res.data.streamId)),$scope.statusLogs=res.data.statusLogs||[],$scope._failedStatus=_.filter($scope.statusLogs,{status:"failed"});var pubStatus="";$scope.initializeScrollBar||(setTimeout(function(){$(".import-bot-modal-body").scrollTop(2)},100),$scope.initializeScrollBar=!0),"success"===res.data.status?$scope.publishOptions&&$scope.publishOptions.autoPublish&&!$scope._failedStatus.length?(pubStatus="initial",finishedImport(pubStatus)):$scope._failedStatus.length&&$scope.publishOptions&&$scope.publishOptions.autoPublish?stopImportBotPolling("success"):$scope.publishOptions&&$scope.publishOptions.hasOwnProperty("autoPublish")?($scope._importStatusInit&&(clearTimeout($scope._importStatusInit),$scope._importStatusInit=null),pubStatus="initial",finishedImport(pubStatus)):stopImportBotPolling("success"):"publish_pending"===res.data.status?(setTimeout(function(){$scope.importing="finished"},200),setTimeout(function(){$scope.importing="",$scope.publishStatus="pending"},1e3),stopPublish(),startPublishProgress(),$scope._publishStatusInit=startPollPublishStatus(3e3)):"publish_success"===res.data.status?(pubStatus="success",finishedImport(),setTimeout(function(){$scope.importing=""},200),stopPublish(pubStatus),res.data&&res.data.autoPublish&&publishLogs(res.data.autoPublish.response)):"publish_failed"===res.data.status?(pubStatus="failed",finishedImport(),setTimeout(function(){$scope.importing=""},200),stopPublish(pubStatus),res.data.autoPublish&&res.data.autoPublish.response.errors&&res.data.autoPublish.response.errors.length&&($scope.errorMess=res.data.autoPublish.response.errors[0].msg,NotificationService.notify($scope.errorMess,"error"))):"failed"===res.data.status&&($scope.showFailedErrors=!1,stopImportBotPolling("failed"))}},function(err){stopImportBotPolling();var _msg=i18n.i18nString("bot_import_error");err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(_msg,"error")})},timeout)}function stopImportBotPolling(_status){$scope._importStatusInit&&(clearTimeout($scope._importStatusInit),$scope._importStatusInit=null),"success"===_status?finishedImport():$scope.importing="failed"}function stopPublish(_status){$scope._importStatusInit&&clearTimeout($scope._importStatusInit),$scope._publishStatusInit&&clearTimeout($scope._publishStatusInit),"success"===_status?finishedPublish(_status):"failed"===_status&&($scope.publishStatus="failed",clearInterval(progressIntervalPublish),progressIntervalPublish=null)}function writeAndDownloadLog(filename,data){if(navigator.msSaveBlob){var blob=new Blob([data],{type:"data:text/plain;charset=utf-8"});return window.navigator.msSaveOrOpenBlob(blob,filename)}var element=document.createElement("a");element.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(data)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function finishedImport(pubStatus){clearInterval(progressInterval),progressInterval=null,$scope.totalProgress=100,setTimeout(function(){$scope.importing="finished"},200),pubStatus&&setTimeout(function(){$scope.importing="",$scope.publishStatus=pubStatus},2e3),getBTStreamsAndUpdate()}function finishedPublish(){clearInterval(progressIntervalPublish),progressIntervalPublish=null,$scope.totalProgressPublish=100,setTimeout(function(){$scope.publishStatus="success"},200)}function getStreamIconData(){var url=env_conf["components-source"];getFileObject(url+"/assets/botIcons/new/bot-1.png",function(fileObject){$scope.newStreamData.iconFile=fileObject,$scope.loadStreamIcon(!1)})}function adjustCss(){var winHeight=$window.innerHeight;$(".import-bot-modal-body").css("max-height",winHeight-280+"px")}function isJson(str){try{JSON.parse(str)}catch(e){return!1}return!0}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_IMPORT"),$scope.publishPermission=accessControlService.getAccessRight("BOTBUILDER_PUBLISH_BOT"),$scope.assetsBase=env_conf["assets-url"],$scope.newBotStreamId="",$scope.selectedAccount=$workflowService.selectedAccount(),$scope.partialImportAllowed=!$scope.selectedAccount.platformVersion||!$scope.selectedAccount.accountType,$scope.parentDisplayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS");var _selectedStream=$workflowService.selectedStream();_selectedStream.permissions&&_selectedStream.permissions.BOTBUILDER_BOT_IMPORT[0]&&"newBotImport"==$scope.importFrom&&($scope.displayMode=_selectedStream.permissions.BOTBUILDER_BOT_IMPORT[0]),$scope.filesObj={loadingBotConfig:!1,loadingBotDefinition:!1},$scope.dialogProperties={includeComments:!0},$scope.botFunctions={},$scope.importBotDefinition="importBotDefinition",$scope.importConfig="importConfig",$scope.allowedFileTypes=["json"],$scope.uploadBotDefinitionStatus=function(event){event&&"pending"===event.status&&($scope.filesObj.loadingBotDefinition=!0,setTimeout(function(){$scope.$apply()},100)),"error"===event.status?($scope.importedBotData=null,$scope.importedBotName=null,$scope.filesObj.loadingBotDefinition=!1,event.data&&event.data.fileExtensionError?NotificationService.notify(i18n.i18nString("only_json_file"),"error"):NotificationService.notify(i18n.i18nString("save_script_error"),"error"),setTimeout(function(){$scope.$apply()},100)):event&&"success"===event.status?event.data&&event.data.values&&event.data.values.componentFileId&&($scope.filesObj.loadingBotDefinition=!1,$scope.importedBotName=event.data.values.componentData.filename,$scope.importedBotData=event.data.values,$scope.importedBotData.fileId=event.data.values.componentFileId,$scope.callback.definitionFormData=event.formData,setTimeout(function(){$scope.$apply()},100)):($scope.importedBotData=null,$scope.importedBotName=null)},$scope.uploadVariablesStatus=function(event){event&&"pending"===event.status&&(console.log("Loading File"),$scope.filesObj.loadingBotConfig=!0,setTimeout(function(){$scope.$apply()},100)),"error"===event.status?(console.log("Error Loading File"),$scope.filesObj.loadingBotConfig=!1,$scope.importedVariablesData=null,$scope.importedBotVariableName=null,event.data&&event.data.fileExtensionError?NotificationService.notify(i18n.i18nString("only_json_file"),"error"):NotificationService.notify(i18n.i18nString("save_script_error"),"error"),setTimeout(function(){$scope.$apply()},100)):event&&"success"===event.status?event.data&&event.data.values&&event.data.values.componentFileId&&($scope.filesObj.loadingBotConfig=!1,console.log("Error Loading Success"),$scope.importedBotVariableName=event.data.values.componentData.filename,$scope.importedVariablesData=event.data.values,$scope.importedVariablesData.fileId=event.data.values.componentFileId,$scope.callback.configFormData=event.formData,setTimeout(function(){$scope.$apply()},100)):($scope.importedVariablesData=null,$scope.importedBotVariableName=null)},$scope.statusLogsLimit=200,$scope.rightClass="right400",$scope.callback=$scope.callback||{},$scope.fileExtensionError=!1,$scope.imageExtensionError=!1,$scope.fileExtensionVariablesError=!1,$scope.importing="backupNote",$scope.importingSvg=env_conf["context-url"]+"/assets/images/importing.png",$scope.importSuccessBlue=env_conf["context-url"]+"/assets/images/import-success-blue.png",
$scope.importSuccessGreen=env_conf["context-url"]+"/assets/images/import-success.png",$scope.importWarningIcon=env_conf["context-url"]+"/assets/icons-new/import-warning/importing.png",$scope.importSucessSvg=env_conf["context-url"]+"/assets/images/import-success.png",$scope.importErrorSvg=env_conf["context-url"]+"/assets/images/import-error.png",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.checkDone=env_conf["context-url"]+"/assets/icons/Check-done.svg",$scope.warning=env_conf["context-url"]+"/assets/icons/Warning-orange.svg",$scope.bulbBlue=env_conf["context-url"]+"/assets/icons-new/bulb/bulb-blue.svg",$scope.bulbNavyBlue=env_conf["context-url"]+"/assets/icons-new/bulb/bulb-navy-blue.svg",$scope.successCheck=env_conf["context-url"]+"/assets/icons/success-check.svg",$scope.failImg=env_conf["context-url"]+"/assets/icons/fail-import-fullbot.svg",$scope.warningTriangle=env_conf["context-url"]+"/assets/icons-new/exclamation-triangle/exclamation-triangle-orange.svg",$scope.totalProgress=0,$scope.totalProgressPublish=0,$scope.bulbIcon=env_conf["context-url"]+"/assets/images/24x29-bulbicon.png",$scope.streamRefId="",$scope._importStatusInit=null;var progressInterval=null,progressIntervalPublish=null;$scope.importErrors=[],$scope.statusLogs=[],$scope.showFailedErrors=!0,$scope.initializeScrollBar=!1,$scope.disableProceed=!1,$scope.newStreamData={},$scope.newStreamData.iconFile=null,$scope.newStreamData.icon=env_conf["context-url"]+"/assets/botIcons/new/bot-1.png",$("#iconFile").val(""),$scope._constants_=$rootScope._constants_,$scope.defaultImg=env_conf["context-url"]+"/assets/botIcons/new/bot-1.png",$scope.bot={},$scope.bot.importType="fullImport",$scope.publish={},$scope.done_label=i18n.i18nString("done"),$scope.ok_text_label=i18n.i18nString("ok_label"),$scope.retry_label=i18n.i18nString("retry"),$scope.retrying_label=i18n.i18nString("retrying_label"),$scope.retry_all=i18n.i18nString("retry_all"),$scope.appControls=$applicationService.userInfo().appControls,$scope.license={},$scope.planSelectionCb={},$scope.selectedStream=$workflowService.selectedStream(),$scope.planValidationDetails={},$scope.isSmartBot=function(){return"solution"===_selectedStream.type?!0:!1},$scope.isSampleBot=function(){return"sample"===_selectedStream.type?!0:!1},"universalbot"==_selectedStream.type?($scope.linkedBots=[{task:i18n.i18nString("linked_bots"),value:"linkedBots",selected:!0},{task:i18n.i18nString("small_talk"),value:"smallTalk",selected:!0}],$scope.settings=[{task:i18n.i18nString("bot_settings"),value:"botSettings",selected:!0},{task:i18n.i18nString("bot_variables"),value:"botVariables",selected:!0},{task:i18n.i18nString("ivr_properties_normal"),value:"ivrSettings",selected:!0}],$scope.nlp=2===_selectedStream.universalBotVersion?[{task:i18n.i18nString("training_data"),value:"training_data",selected:!0},{task:i18n.i18nString("ddval_synonyms"),value:"bot_synonyms",selected:!0},{task:i18n.i18nString("settings"),value:"nlpSettings",selected:!0},{task:i18n.i18nString("default_dialog"),value:"defaultDialog",selected:!0},{task:i18n.i18nString("ddval_standard"),value:"standardResponses",selected:!0}]:[{task:i18n.i18nString("nlp_settings"),value:"nlpSettings",selected:!0},{task:i18n.i18nString("default_dialog"),value:"defaultDialog",selected:!0},{task:i18n.i18nString("ddval_standard"),value:"standardResponses",selected:!0}],$scope.categories=[{key:"Bot Components",list:$scope.linkedBots,selected:!0,value:i18n.i18nString("task_name")},{key:"NLP Data",list:$scope.nlp,selected:!0,value:i18n.i18nString("nlp_data")},{key:"Settings",list:$scope.settings,selected:!0,value:i18n.i18nString("settings")},{key:"Custom Dashboards",selected:!0,value:i18n.i18nString("custonDashboards")}]):($scope.tasks=[{task:i18n.i18nString("tasks_only"),value:"botTask",selected:!0},{task:i18n.i18nString("knowledge_graph"),value:"knowledgeGraph",selected:!0},{task:i18n.i18nString("small_talk"),value:"smallTalk",selected:!0}],$scope.tasks.push({task:i18n.i18nString("uiforms"),value:"forms",selected:!0}),$scope.settings=[{task:i18n.i18nString("bot_settings"),value:"botSettings",selected:!0},{task:i18n.i18nString("bot_variables"),value:"botVariables",selected:!0},{task:i18n.i18nString("ivr_properties_normal"),value:"ivrSettings",selected:!0}],$scope.nlp=[{task:i18n.i18nString("nlp_settings"),value:"nlpSettings",selected:!0,displayValue:i18n.i18nString("nlp_settings")},{task:i18n.i18nString("Utterances"),value:"utterances",selected:!0,displayValue:i18n.i18nString("Utterances")},{task:i18n.i18nString("Patterns"),value:"patterns",selected:!0,displayValue:"NLP Patterns"},{task:i18n.i18nString("ddval_standard"),value:"standardResponses",selected:!0,displayValue:i18n.i18nString("ddval_standard")}],$scope.categories=[{key:"Bot Tasks",list:$scope.tasks,selected:!0,value:i18n.i18nString("task_name")},{key:"NLP Data",list:$scope.nlp,selected:!0,value:i18n.i18nString("nlp_data")},{key:"Settings",list:$scope.settings,selected:!0,value:i18n.i18nString("settings")},{key:"Custom Dashboards",selected:!0,value:i18n.i18nString("custonDashboards")}]),$scope.componentDisplayNames={},$scope.linkedBots&&$scope.linkedBots.length&&$scope.linkedBots.forEach(function(value,key){$scope.componentDisplayNames[value.value]=value.task}),$scope.tasks&&$scope.tasks.length&&$scope.tasks.forEach(function(value,key){$scope.componentDisplayNames[value.value]=value.task}),$scope.settings&&$scope.settings.length&&$scope.settings.forEach(function(value,key){$scope.componentDisplayNames[value.value]=value.task}),$scope.nlp&&$scope.nlp.length&&$scope.nlp.forEach(function(value,key){$scope.componentDisplayNames[value.value]=value.displayValue}),$scope.categories&&$scope.categories.length&&$scope.categories.forEach(function(value,key){$scope.componentDisplayNames[value.value]=value.key}),$scope.utterances={},$scope.utterances.option="append",$scope.utterances.value="Append",$scope.patterns={},$scope.patterns.option="append",$scope.patterns.value="Append",$scope.readBotFile=function(){if($scope.importedBotName=$scope.importBot.name,$scope.importedBotName){var _ext=$scope.importedBotName.substring($scope.importedBotName.lastIndexOf("."));if(".json"!==_ext)return NotificationService.notify(i18n.i18nString("upload_json"),"error"),void($scope.fileExtensionError=!0);$scope.fileExtensionError=!1}var reader=new FileReader;reader.readAsText($scope.importBot),reader.onload=function(e){var data=reader.result;$scope.importedBotData=data,$scope.$apply()},angular.element("#importFile").val("")},$scope.showMoreStatusResults=function(logs){$scope.statusLogsLimit=logs.length+10},$scope.readBotVariablesFile=function(){if($scope.importedBotVariableName=$scope.importVariables.name,$scope.importedBotVariableName){var _ext=$scope.importedBotVariableName.substring($scope.importedBotVariableName.lastIndexOf("."));if(".json"!==_ext)return NotificationService.notify(i18n.i18nString("upload_json"),"error"),void($scope.fileExtensionVariablesError=!0);$scope.fileExtensionVariablesError=!1}var reader=new FileReader;reader.readAsText($scope.importVariables),reader.onload=function(e){var data=reader.result;$scope.importedVariablesData=data,$scope.$apply()},angular.element("#importVariableFile").val("")},$scope.startNewBotImporting=function(){isJson($scope.importedBotData)&&($scope.importedBotData=JSON.parse($scope.importedBotData)),isJson($scope.importedVariablesData)&&($scope.importedVariablesData=JSON.parse($scope.importedVariablesData)),$scope.importedVariablesData.name=$scope.$parent.streamObject.name.trim().replace(/\s\s+/g," "),$scope.importedVariablesData.color=$scope.$parent.streamObject.color,$scope.$parent.streamObject.purpose&&($scope.importedVariablesData.purpose=$scope.$parent.streamObject.purpose),$scope.importedVariablesData.icon=$scope.$parent.streamObject.icon.fileId||$scope.newStreamData.icon.fileId;var payload={botDefinition:$scope.importedBotData.fileId,configInfo:$scope.importedVariablesData.fileId,botFunctions:[],icon:$scope.importedVariablesData.icon,name:$scope.importedVariablesData.name,purpose:$scope.importedVariablesData.purpose};$scope.botFunctionFileId&&payload.botFunctions.push($scope.botFunctionFileId),BTFlowtaskService.importNewBot($applicationService.userInfo().userId,payload).then(function(res){res&&res.data&&($scope.streamRefId=res.data._id||"",$scope.statusLogs=res.data.statusLogs||[],"pending"===res.data.status?$scope._importStatusInit=startPollImportStatus(3e3):stopImportBotPolling("success"===res.data.status?"success":"failed"))},function(error){if($scope.importing="failed",error&&error.data&&error.data.errors){$scope.importErrors=error.data.errors;var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){$scope.importErrors=error.errors;var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("save_script_error"),"error")})},$scope.callback.importNewBot=function(){({streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name});return $("#arabicInput").val($("#arabicInput").val().trim().replace(/\s\s+/g," ")),$scope.importedBotData?$scope.importedVariablesData?$scope.fileExtensionVariablesError?void NotificationService.notify(i18n.i18nString("only_json_file"),"error"):$scope.$parent.streamObject.icon?($scope.importErrors=[],$scope.importing="inprogress",$scope.showImportModal("no_publish"),startImportProgress(),void $scope.uploadStreamIcon()):($scope.iconRequiredError=!0,void NotificationService.notify(i18n.i18nString("please_upload_botICon"),"error")):void NotificationService.notify(i18n.i18nString("bt_import_variable_file_required"),"error"):void NotificationService.notify(i18n.i18nString("bt_import_config_required"),"error")},$scope.callback.isFormValid=function(){return("existingBotImport"===$scope.importFrom||$scope.$parent.streamObject.name&&""!==$scope.$parent.streamObject.name)&&$scope.importedBotData&&$scope.importedVariablesData?$scope.fileExtensionVariablesError?!1:"existingBotImport"===$scope.importFrom||$scope.$parent.streamObject.icon?!0:!1:!1};var checkForChannels=function(){var _channels=[];return _channels=_.filter(_selectedStream.channels,function(channelObject){return channelObject.enable}),_.isArray(_channels)&&_channels.length>0&&"NO"!==$scope.publishPermission?($scope.disableAutoPublish=!1,$scope.publish.autoPublish=!0):($scope.disableAutoPublish=!0,$scope.publish.autoPublish=!1),_channels};$scope.showBackup=function(){({streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name});$scope.importing="backupNote",$scope.enabledChannels=checkForChannels(),$scope.showImportModal()},$scope.readMore=function(event){if(event){var e=event.currentTarget;$(e).toggleClass("less"),$(e).hasClass("less")?$(e)[0].innerText="Read less":$(e)[0].innerText="Read more"}else $scope.importing="backupNote1",$scope.initializeScrollBar||(setTimeout(function(){$(".psScrollZindex").scrollTop(2)},100),$scope.initializeScrollBar=!0)};(function(){var a=document.createElement("a");return document.body.appendChild(a),a.style="display: none",function(data,name){var blob=new Blob(data,{type:"octet/stream"}),url=window.URL.createObjectURL(blob);a.href=url,a.download=name,a.click(),window.URL.revokeObjectURL(url)}})();$scope.startExport=function(){function startExport(){$scope.disableProceed=!0;var taskResult,nlpdata,showFailedErrors,payload={exportType:"latest",exportOptions:{},allTasks:!0,IncludeDependentTasks:!0,subTasks:{dialogs:[],alerts:[],actions:[]}};payload.exportOptions.nlpData=[],payload.exportOptions.settings=[],"universalbot"==_selectedStream.type?(payload.exportOptions.botComponents=[],taskResult=$scope.categories[0].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.botComponents.push(key.value)}),nlpdata=$scope.categories[1].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.nlpData.push(key.value)}),showFailedErrors=$scope.categories[2].list.forEach(function(key,value){key.selected===!0&&payload.exportOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.categories[3].key&&$scope.categories[3].selected?payload.customDashboard=!0:payload.customDashboard=!1):(payload.exportOptions.tasks=[],taskResult=$scope.categories[0].list.forEach(function(key,value){payload.exportOptions.tasks.push(key.value)}),nlpdata=$scope.categories[1].list.forEach(function(key,value){payload.exportOptions.nlpData.push(key.value)}),showFailedErrors=$scope.categories[2].list.forEach(function(key,value){payload.exportOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.categories[3].key&&$scope.categories[3].selected?payload.customDashboard=!0:payload.customDashboard=!1),BTFlowtaskService.exportBot(_selectedStream._id,payload).then(function(res){res&&res.data&&("pending"===res.data.status?($scope.exporting=res.data.status,$scope._exportStatusInit=startPollExportStatus(3e3)):stopExportBotPolling("success"===res.data.status?"success":"failed"))},function(error){if($scope.disableProceed=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("save_script_error"),"error")})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_bot")):startExport()},$scope.getLicenseInfo=function(){$scope.license={},$scope.supportPlan={},$scope.selectedStream=$workflowService.selectedStream(),$scope.appControls=$applicationService.userInfo().appControls,$scope.selectedStream&&($scope.selectedStream.license&&($scope.license=$scope.selectedStream.license,$scope.license.totalCredits=$scope.license.baseAllowedCredits+$scope.license.extraCredits-$scope.license.creditsUsed,$scope.license.totalSessions=$scope.license.baseAllowedSessions+$scope.license.extraSessions-$scope.license.sessionsUsed,$scope.license.totalRequests=$scope.license.baseAllowedRequests-$scope.license.requestsUsed),$scope.selectedStream.planValidationDetails&&($scope.planValidationDetails=$scope.selectedStream.planValidationDetails))},$scope.openCustomModal=function(targetId){targetId&&$("#"+targetId).modal("show")},$scope.closeCustomModal=function(targetId){targetId&&$("#"+targetId).modal("hide")},$scope.startImport=function(publish){if(!$scope.importedBotData)return void NotificationService.notify(i18n.i18nString("bt_import_config_required"),"error");if(!$scope.importedVariablesData)return void NotificationService.notify(i18n.i18nString("bt_import_variable_file_required"),"error");if($scope.fileExtensionVariablesError)return void NotificationService.notify(i18n.i18nString("only_json_file"),"error");if(!$scope.newStreamData.icon)return $scope.iconRequiredError=!0,void NotificationService.notify(i18n.i18nString("please_upload_botICon"),"error");if(publish&&publish.autoPublish&&!publish.comments)return void NotificationService.notify(i18n.i18nString("publish_comments"),"warning");$scope.importErrors=[],$scope.importing="inprogress",$scope.publishOptions=publish,$(".psScrollZindex").animate({scrollTop:2}),startImportProgress(),isJson($scope.importedBotData)&&($scope.importedBotData=JSON.parse($scope.importedBotData)),isJson($scope.importedVariablesData)&&($scope.importedVariablesData=JSON.parse($scope.importedVariablesData)),$scope.importedVariablesData.icon=$scope.newStreamData.icon.fileId;var payload={importOptions:{},botDefinition:$scope.importedBotData.fileId,configInfo:$scope.importedVariablesData.fileId,botFunctions:[]};$scope.botFunctionFileId&&payload.botFunctions.push($scope.botFunctionFileId),publish&&publish.autoPublish&&(payload.autoPublish={versionComment:publish.comments}),payload.importOptions.nlpData=[],payload.importOptions.settings=[],payload.importOptions.options={},payload.importOptions.storyBoardScenes={includeComments:$scope.dialogProperties.includeComments};var taskResult,nlpdata,showFailedErrors;"universalbot"==_selectedStream.type?(payload.importOptions.botComponents=[],taskResult=$scope.categories[0].list.forEach(function(key,value){key.selected===!0&&payload.importOptions.botComponents.push(key.value)}),nlpdata=$scope.categories[1].list.forEach(function(key,value){key.selected===!0&&(payload.importOptions.nlpData.push(key.value),"patterns"===key.value&&(payload.importOptions.options.patterns=$scope.savePatternOptions()),"utterances"===key.value&&(payload.importOptions.options.utterances=$scope.saveUtteranceOptions()))}),showFailedErrors=$scope.categories[2].list.forEach(function(key,value){key.selected===!0&&payload.importOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.categories[3].key&&$scope.categories[3].selected?payload.importOptions.customDashboard=!0:payload.importOptions.customDashboard=!1):(payload.importOptions.tasks=[],taskResult=$scope.categories[0].list.forEach(function(key,value){key.selected===!0&&payload.importOptions.tasks.push(key.value)}),nlpdata=$scope.categories[1].list.forEach(function(key,value){key.selected===!0&&(payload.importOptions.nlpData.push(key.value),"patterns"===key.value&&(payload.importOptions.options.patterns=$scope.savePatternOptions()),"utterances"===key.value&&(payload.importOptions.options.utterances=$scope.saveUtteranceOptions()))}),showFailedErrors=$scope.categories[2].list.forEach(function(key,value){key.selected===!0&&payload.importOptions.settings.push(key.value)}),"Custom Dashboards"===$scope.categories[3].key&&$scope.categories[3].selected?payload.importOptions.customDashboard=!0:payload.importOptions.customDashboard=!1),BTFlowtaskService.importExistingBot($applicationService.userInfo().userId,_selectedStream._id,payload,$scope.bot).then(function(res){res&&res.data&&($scope.streamRefId=res.data._id||"",$scope.statusLogs=res.data.statusLogs||[],"pending"===res.data.status?$scope._importStatusInit=startPollImportStatus(3e3):"success"===res.data.status?$scope.publishOptions.autoPublish?finishedImport():stopImportBotPolling("success"):stopImportBotPolling("failed"))},function(error){if($scope.importing="failed",error&&error.data&&error.data.errors&&error.data.errors.length&&error.data.errors[0]&&error.data.errors[0].code&&"ImportWarning"===error.data.errors[0].code)$scope.importErrors=error.data.errors,$scope.showImportModal();else if(error&&error.data&&error.data.errors&&error.data.errors.length&&error.data.errors[0]&&error.data.errors[0].code&&"ImportWarning"!==error.data.errors[0].code){$scope.importErrors=error.data.errors;var importErrorsMsg=$scope.importErrors[0].msg.split("\n"),importErrorsArray=[];_.forEach(importErrorsMsg,function(msg){"NLP Patterns"===msg&&(msg="patterns"),$scope.componentDisplayNames[msg]&&importErrorsArray.push($scope.componentDisplayNames[msg])}),$scope.importErrors[0].msg=$scope.importErrors[0].msg.split("\n")[0],$scope.importErrors[0].errors=importErrorsArray}else if(error.errors&&_.isArray(error)){$scope.importErrors=error.errors;var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("save_script_error"),"error")})},$scope.openPlanUsage=function(planType){$("#upDownRequired").modal("hide"),"plan"===planType&&($scope.planSelectionCb.page="publish",$scope.planSelectionCb.planSelection=!0,$scope.planSelectionCb.supportSelection=!1),$scope.planSelectionCb.license=$scope.license,$scope.planSelectionCb.plansSlider=!0},$scope.submitToAdminPublish=function(){$scope.planSelectionCb.publishSubmitToAdmin=!0,$scope.publishBot($scope.publish,!0)},$scope.doubleClick=!1,$scope.planSelectionCb.confirmPublish=function(){$scope.doubleClick||($scope.doubleClick=!0,$timeout(function(){$scope.doubleClick=!1},1e3),$scope.publishBot($scope.publish,!0))},$scope.planSelectionCb.openImportModal=function(){$(".import-bot-modal-publish").show()},$scope.allowRetry=!0,$scope.publishBot=function(publish,retry){var payload={};return $scope.allowRetry=!1,retry&&setTimeout(function(){$(".import-bot-modal-publish .modal-body").animate({scrollTop:0})},100),publish&&publish.comments?!$scope.selectedStream||!$scope.license||$scope.license.planName||"private"!==$scope.selectedStream.visibility.namespace||!$scope.planSelectionCb||$scope.planSelectionCb.publishFreeBot||$scope.planSelectionCb.publishSubmitToAdmin||$scope.planSelectionCb.publishPaidBot?$scope.planValidationDetails&&$scope.planValidationDetails.exceededData&&$scope.license&&$scope.license.planName&&$scope.planValidationDetails.exceededData[$scope.license.planId]&&!$scope.planSelectionCb.publishFreeBot&&!$scope.planSelectionCb.publishSubmitToAdmin&&!$scope.planSelectionCb.publishPaidBot?void setTimeout(function(){$("#upDownRequired").modal("show")},0):(payload.versionComment=publish.comments,void BTStreamsService.publishImportBot(_selectedStream._id,payload).then(function(res){publishLogs(res.data)},function(err){$scope.allowRetry=!0,err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("something_went_wrong"),"error")})):($(".import-bot-modal-publish").hide(),void $scope.openPlanUsage("plan")):void NotificationService.notify(i18n.i18nString("publish_comments"),"warning")},$scope.allowRetry=!0,$scope.retry=function(payload){$scope.allowRetry=!1,payload.versionComment=$scope.publish&&$scope.publish.versionComments?$scope.publish.versionComments:"";var service="smartbot"==$scope.stream.publishType?BTStreamsService.solutionPublish:BTStreamsService.standardPublish;"smartbot"!==_selectedStream.publishType&&"samplebot"!==_selectedStream.publishType&&(payload.publishAllComponents=!1,payload.versionComment=payload.versionComment),service(_selectedStream._id,payload).then(function(res){publishLogs(res.data)},function(err){$scope.allowRetry=!0;var msg=err.data.errors[0].msg||i18n.i18nString("something_went_wrong_try_again");NotificationService.notify(msg,"error")})},$scope.toggleCommentValue=function(publish){publish.autoPublish||(publish.comments="")},$scope.downloadLog=function(){writeAndDownloadLog("botImportLog.json",JSON.stringify($scope.statusLogs))};var getFileBlob=function(url,cb){var xhr=new XMLHttpRequest;xhr.open("GET",url),xhr.responseType="blob",xhr.addEventListener("load",function(){cb(xhr.response)}),xhr.send()},blobToFile=function(blob,name){return blob.lastModifiedDate=new Date,blob.name=name,blob},getFileObject=function(filePathOrUrl,cb){getFileBlob(filePathOrUrl,function(blob){cb(blobToFile(blob,"newBot.png"))})};getStreamIconData(),$scope.loadStreamIcon=function(){if($scope.newStreamData&&$scope.newStreamData.iconFile&&$scope.newStreamData.iconFile.name){var _ext=$scope.newStreamData.iconFile.name.substring($scope.newStreamData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.imageExtensionError=!0);$scope.imageExtensionError=!1;var reader=new FileReader;reader.onload=function(loadEvent){$scope.$apply(function(){$scope.defaultImg=loadEvent.target.result})},reader.readAsDataURL($scope.newStreamData.iconFile)}},$scope.uploadStreamIcon=function(){if($scope.newStreamData.iconFile.name){var _ext=$scope.newStreamData.iconFile.name.substring($scope.newStreamData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.imageExtensionError=!0)}$scope.imageExtensionError=!1;var data=new FormData;data.append("file",$scope.newStreamData.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.newStreamData.iconFile.name,fileId:response.data.fileId};$scope.newStreamData.icon=fileUploaded,$scope.startNewBotImporting(),$scope.iconUploading=!1},function(error){NotificationService.notify(i18n.i18nString("oops_label")+error.data.errors[0].msg,"error"),$scope.iconUploading=!1,$scope.importing="failed"})},$scope.uploadFile=function(e){if($scope.botFunctions.botFuctionFile){var _ext="";if($scope.botFunctions.botFuctionFile.name){_ext=$scope.botFunctions.botFuctionFile.name.substring($scope.botFunctions.botFuctionFile.name.lastIndexOf("."));var supportingFileFormats=[".js"];if(-1===$.inArray(_ext,supportingFileFormats))return void NotificationService.notify(i18n.i18nString("upload_only_js_files"),"error")}var _fileLimit=5e5;if(e.target.files[0].size>_fileLimit)return void NotificationService.notify(i18n.i18nString("file_size_shouldnot_exced_err_noty"),"warning");var data=new FormData;data.append("file",$scope.botFunctions.botFuctionFile),data.append("fileContext","bulkImport"),data.append("fileExtension","txt"),$scope.fileuploading=!0,BTStreamsService.uploadBotFunctionsFile($applicationService.userInfo().userId,data).then(function(response){var fileUploaded={fileName:$scope.botFunctions.botFuctionFile.name,fileId:response.data.fileId};$scope.botFunctions.botFuctionFile=fileUploaded,$scope.fileuploading=!1,$scope.botFunctionFileName=$scope.botFunctions.botFuctionFile.fileName,$scope.botFunctionFileId=response.data.fileId},function(err){NotificationService.notify(i18n.i18nString("oops_label")+err.data.errors[0].msg,"error"),$scope.fileuploading=!1})}},$scope.deleteStreamIcon=function(){$scope.newStreamData.iconFile=null,$scope.newStreamData.icon=null,$("#iconFile").val("")},$scope.onCancel=function(){$scope.importedBotName="",$scope.importedBotData=null,$scope.importedBotVariableName="",$scope.importedVariablesData=null,$scope.botFunctions&&($scope.botFunctions.botFuctionFile="",$scope.botFunctions.botFuctionFile=null),$scope.publish={},_selectedStream.type&&"incrementalImport"!==$scope.bot.importType?$(".import-bot-modal-publish").modal("hide"):$(".import-bot-modal").modal("hide"),NotificationService.notify(i18n.i18nString("importWarningToast"),"warning")},$scope.closeImportModal=function(){$scope.importedBotName="",$scope.importedBotData=null,$scope.importedBotVariableName="",$scope.importedVariablesData=null,_selectedStream.type?$(".import-bot-modal-publish").modal("hide"):$(".import-bot-modal").modal("hide");var _streamId=$workflowService.selectedStream()._id;""!==$workflowService.importedNewBotId().trim()&&(_streamId=$workflowService.importedNewBotId().trim(),$workflowService.importedNewBotId("")),BTStreamsService.getBTStream(_streamId).then(function(res){var allStreams=$workflowService.streamsAll(),_eventToTrigger="selectOrChangeBot",_curState=navigator.setORGetPreviousState(),baseComponent=_curState.path[0];allStreams&&allStreams.length&&($scope.allBots=$workflowService.streamsAll(),$.each($scope.allBots,function(i,bot){bot._id===$workflowService.selectedStream()._id&&(bot=$workflowService.selectedStream())}),$workflowService.streamsAll($scope.allBots)),$workflowService.selectedStream(res.data),$scope.$emit("streamUpdate"),$scope.$emit("botImportSuccess");var eventInfoBotsCreate={Category:"Activation","Sub Category":"Activation - VA",Level:"ONBOARDING AND ACTIVATION","VA - Inititiation Mode":"Import"};if(mixPanel.postEvent("VA - New Bot Initiated",eventInfoBotsCreate),"botDetailsForm"===baseComponent&&(_eventToTrigger="selectBot"),allStreams&&allStreams.length)$rootScope.$emit(_eventToTrigger,res.data);else{var stream=res.data;$rootScope.$emit("loadNewStream",stream)}"newBotImport"!==$scope.importFrom?$scope.$parent.setCurrentTab(".tasks-pane"):$(".fullwidth-dialog").modal("hide")})},$scope.showImportModal=function(importValue){_selectedStream.type&&"no_publish"!==importValue&&"incrementalImport"!==$scope.bot.importType?($(".import-bot-modal-publish").modal("show"),setTimeout(function(){$(".psScrollZindex").animate({scrollTop:2}),$("#pubComments")[0].focus()},500)):$(".import-bot-modal").modal("show")},angular.element($window).on("resize",function(e){setTimeout(function(){adjustCss()},200)}),adjustCss(),$scope.clickerTask=function(task,e,index){e.stopPropagation(),angular.element("#component"+index).parent().hasClass("intermediate")&&angular.element("#component"+index).parent().removeClass("intermediate"),task&&task.list&&task.list.length&&task.list.forEach(function(key,value){key.selected=task.selected})},$scope.clickerSubTask=function(task,e,index){e.stopPropagation();var count=0;task.list.forEach(function(key,value){key.selected&&count++}),count===task.list.length?(task.selected=!0,angular.element("#component"+index).parent().removeClass("intermediate")):0===count?(task.selected=!1,angular.element("#component"+index).parent().removeClass("intermediate")):0!==count&&(task.selected=!0,angular.element("#component"+index).parent().addClass("intermediate"))},$scope.openTaskPropertiesSlider=function(close,resetproperties){resetproperties&&($scope.dialogProperties={includeComments:!0}),close?$scope.closeModalSlider("#openTaskPropertiesSlider"):$scope.openModalSlider("#openTaskPropertiesSlider")},$scope.openUtteranceSlider=function(){$scope.openModalSlider("#openUtteranceSlider")},$scope.utteranceSliderClose=function(){$scope.closeModalSlider("#openUtteranceSlider")},$scope.saveUtteranceOptions=function(){var options={};return"append"===$scope.utterances.option?(options.append=!0,options.replace=!1,$scope.utterances.value="Append"):(options.append=!1,options.replace=!0,$scope.utterances.value="Replace"),$scope.closeModalSlider("#openUtteranceSlider"),options},$scope.openPatternSlider=function(){$scope.openModalSlider("#openPatternSlider")},$scope.closeSliderPattern=function(){$scope.closeModalSlider("#openPatternSlider")},$scope.savePatternOptions=function(){var options={};return"append"===$scope.patterns.option?(options.append=!0,options.replace=!1,$scope.patterns.value="Append"):(options.append=!1,options.replace=!0,$scope.patterns.value="Replace"),$scope.closeModalSlider("#openPatternSlider"),options},$scope.$emit("nestedComponentLoaded",{id:"importBot",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.updateBotImport=function(e){$scope.showBackup()},$scope.$on("updateBotImport",function(evt){$scope.updateBotImport()})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-knowledge-create",[]);_module.directive("btKnowledgeCreate",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-knowledge-create/bt-knowledge-create.html",controller:"BTKnowledgeCreateCtrl"}}),_module.controller("BTKnowledgeCreateCtrl",["$scope","$routeParams","$location","$workflowService","$rootScope","i18n",function($scope,$routeParams,$location,$workflowService,$rootScope,i18n){return $(window).scrollTop(),$scope.displayMode="edit",$scope.taskEditInfo=$workflowService.taskEditInfo(),$scope.wftype=$scope.taskEditInfo.taskType,$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.displayMode=$workflowService.taskMode()||"New",$scope.wftype=$scope.taskEditInfo.taskType,$scope.selectedStream=$workflowService.selectedStream(),$scope.streamId=$scope.selectedStream._id,$workflowService.workflowType()?($scope.onStreamFormCancel=function(){$location.path(window.appConfig.CONTEXT_PATH),$("#btFullpageModal").modal("hide"),$("body").removeClass("bt-modal-open"),$rootScope.$emit("insertOrUpdateTask",$scope.wftype,$scope.taskEditInfo,!1),$rootScope.$emit("showContent"),$rootScope.$broadcast("updateEditTask",!1)},$scope.onCancel=function(){$scope.onStreamFormCancel()},$scope.onStreamFormSave=function(){$location.path(window.appConfig.CONTEXT_PATH)},void($scope.gotostream=function(){$location.path(window.appConfig.CONTEXT_PATH)})):void $location.path(window.appConfig.CONTEXT_PATH)}])}(angular),function(ng){"use strict";var btlogs=ng.module("bt-kora-logs",[]);
btlogs.controller("BTKoraLogsCtrl",["$scope","$rootScope","$q","$endpoints","$translator","BTKoraService","$routeParams","user","streamId","$modalInstance","$timeout",function($scope,$rootScope,$q,$endpoints,$translator,BTKoraService,$routeParams,user,streamId,$modalInstance,$timeout){var offset=0,limit=50,moreAvailable=!1;$scope.loadingMore=!1;var _ele;$scope.loadLogs=function(){$scope.koralogs="loading",$scope.modalTitle=user.firstName?"Chat history with "+user.firstName:"Chat history",_ele.scrollTop(_ele[0].scrollHeight),BTKoraService.getKoraLogs(user.id,streamId,offset,limit).then(function(res){offset+=limit,$scope.koralogs=res.data.koralogs.length?res.data.koralogs.reverse():[],$scope.registerScrollEvent(),moreAvailable=res.data?res.data.moreAvailable:!1,$timeout(function(){_ele.scrollTop(_ele[0].scrollHeight)},100)},function(errRes){moreAvailable=!1})},$scope.loadMoreLogs=function(){if(moreAvailable&&!$scope.loadingMore){$scope.loadingMore=!0;var _beforeHt=_ele[0].scrollHeight;BTKoraService.getKoraLogs(user.id,streamId,offset,limit).then(function(res){offset+=limit,res.data.koralogs.length&&($scope.koralogs=res.data.koralogs.reverse().concat($scope.koralogs),$scope.loadingMore=!1),moreAvailable=res.data?res.data.moreAvailable:!1,$timeout(function(){_ele.scrollTop(_ele[0].scrollHeight-_beforeHt)},500)},function(errRes){moreAvailable=!1,$scope.loadingMore=!1})}},$scope.closeModal=function(){$modalInstance.close(),$(".kora-logs-modal .modal-body").off("scroll")},$scope.registerScrollEvent=function(){$(".kora-logs-modal .modal-body").off("scroll").on("scroll",function(){$(this).scrollTop()<=0&&$scope.loadMoreLogs()})},$timeout(function(){$scope.koralogs="loading",_ele=$(".kora-logs-modal .modal-body"),$scope.loadLogs()},10)}]),btlogs.filter("convertmdtohtml",["$sce",function($sce){return function(val){var str=val;return str}}])}(angular),function(ng){"use strict";var btUsers=ng.module("bt-kora-users",[]);btUsers.filter("name",function(){return function(user){return user.firstName||user.lastName?user.firstName+" "+user.lastName:"Unknown"}}),btUsers.filter("email",function(){return function(user){return user.emailId?-1!==user.emailId.indexOf("botrtm.ignore")?user.id:user.emailId:user.phoneNo?user.phoneNo:"Unknown"}}),btUsers.controller("BTKoraUsersCtrl",["$scope","$rootScope","$q","$endpoints","$translator","BTKoraService","$routeParams","$modal",function($scope,$rootScope,$q,$endpoints,$translator,BTKoraService,$routeParams,$modal){var streamId=$scope.streamId,offset=0,limit=30,moreAvailable=!1;$scope.loadingMore=!1,$scope.loadUsers=function(){$scope.users="loading",BTKoraService.getKoraUsers(streamId,offset,limit).then(function(res){offset+=limit,res.data.users.length?$scope.users=res.data.users:$scope.users="norecords",moreAvailable=res.data?res.data.moreAvailable:!1},function(errRes){$scope.users="error"})},$scope.loadMoreUsers=function(){moreAvailable&&!$scope.loadingMore&&($scope.loadingMore=!0,BTKoraService.getKoraUsers(streamId,offset,limit).then(function(res){offset+=limit,res.data.users.length&&($scope.users=$scope.users.concat(res.data.users)),moreAvailable=res.data?res.data.moreAvailable:!1,$scope.loadingMore=!1},function(errRes){$scope.users="error",$scope.loadingMore=!1}))},$scope.showLogs=function(user){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-kora-logs/bt-kora-logs.html",controller:"BTKoraLogsCtrl",windowClass:"modal-kr kora-logs-modal",resolve:{user:function(){return user},streamId:function(){return streamId}}})},$(".logs-max-height").on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$(".kora-users-row").is(":visible")&&$scope.loadMoreUsers()}),$scope.loadUsers()}])}(angular),function(){"use strict";function Login($rootScope,$scope,$timeout,$location,security,$translator,$applicationService,NotificationService,$modal,localstore,i18n,mixPanel,env_conf,$sce){function prepareSSOOptions(){var options=[],config=window.appConfig;config&&config.SSO_PROVIDERS&&"object"==typeof config.SSO_PROVIDERS&&$.each(config.SSO_PROVIDERS,function(key,val){val&&$scope.allAvailableSSOoptions[key]&&options.push($scope.allAvailableSSOoptions[key])}),$scope.ssoOptions=options}function resizeIframe(){var iframe=document.getElementById("marketingContentFrame"),iframewindow=iframe.contentWindow?iframe.contentWindow:iframe.contentDocument.defaultView;setTimeout(function(){try{iframe.height=iframewindow.document.body.scrollHeight+50+"px",$("#marketingContentFrame").css({height:iframe.height})}catch(e){console.log("cross-origin")}},500)}function handleVerifyStatus(search,missingFields){var _identity=search.emailId||search.phoneNo,data={phone:search.phoneNo?!0:!1,emailPhone:_identity,username:_identity};missingFields&&(data.missingFields=missingFields),submitAutoLoginByData(data)}function activate(){mixPanel.reset();var search=$location.search()||{};search.email=search.email||search.emailId||search.phoneNo;var hash=$location.hash();if(search&&search.name&&($scope.firstName=search.name),"signup"===hash){if(search.email){var _signUpidentity=search.email||search.emailId||search.phoneNo;$scope.emailPhone=_signUpidentity}switchForms("pre-sign-up")}else if("login"===hash)if(search.email){var _identity=search.email||search.emailId||search.phoneNo,data={phone:search.phoneNo?!0:!1,emailPhone:_identity,username:_identity};submitAutoLoginByData(data,!0)}else search.sso&&ssoLogin(search.sso);else"_accountactivation"===hash?security.handleAccountActivation(search,{success:function(){$scope.emailPhone=search.emailId||search.phoneNo,handleVerifyStatus(search)},failure:function(res){res.data.errors&&res.data.errors.length&&($scope.searchParams=angular.copy(search),225==res.data.errors[0].code?switchForms("link-expired"):res.data.errors[0].moreInfo&&($scope.emailPhone=res.data.errors[0].moreInfo.userInfo.emailId,$scope.firstName=res.data.errors[0].moreInfo.userInfo.firstName,$scope.lastName=res.data.errors[0].moreInfo.userInfo.lastName,handleVerifyStatus(search,res.data.errors[0].moreInfo))),$scope.emailPhone&&security.getPasswordPolicy($scope.emailPhone,{updatePasswordPolicy:function(res){$scope.passwordPolicy=res}})}}):"_resetpassword"===hash?handleResetPassword(search):"accountsList"===search.form&&newBotLanding();"accountsList"!==search.form&&$location.search({}),$location.hash("")}function completeLogin(){$scope.loginComplete=!0}function switchForms(type,differentUser){if($scope.login.error=!1,$scope.error=!1,differentUser&&($scope.emailPhone="",$timeout(function(){var _ele=$("input:visible");$.each(_ele,function(k,ele){$(ele)&&$(ele).val()&&""===$(ele).val().trim()&&$(ele).focus()})},500)),"forgot"===type&&$scope.emailPhone){var userInfo={$email:$scope.emailPhone,Category:"Onboarding",SubCategory:"Signup"};mixPanel.reset(),mixPanel.setUserInfo($scope.emailPhone,userInfo),mixPanel.postEvent("Signup by Email - Forgot Password",userInfo)}$scope.formType=type,$scope.formTitle=$scope.formTitles[type],"landing-page"===type&&0===$scope.availableAccounts.length&&($scope.formTitle=$scope.formTitles["default"]),$scope.doFocus(),$rootScope.showLoginLoader=!1,setTimeout(function(){$scope.checkingId=!1},100),setTimeout(function(){$(".koreLoginContainer").scrollTop(1)},600)}function removeSession(indexNum){$scope.multiUsers.splice(indexNum,1)}function phoneCode(value){$scope.displayCountryCodes=value}function selectCountryCode(item){$scope.selectedCountryCode=item}function chooseAccount(item,evt){if(evt.stopPropagation(),evt.preventDefault(),$scope.appControlData.defaultAccountId=$scope.selectFavoriteAccount,$scope.appControlData.chosenAccountId=item.accountId,security.saveUserData($scope.appControlData),$scope.emailPhone||($scope.emailPhone=$scope.appControlData.userInfo.emailId),item.hasOwnProperty("idp")){item.client_email=$scope.appControlData.userInfo.emailId,localStorage.setItem("selectedSSOAccount",JSON.stringify(item));var newidp=item.idp;ssoLogin(newidp,"direct")}else $(".login-container").hide(),$rootScope.showLoginLoader=!0,$timeout(function(){localStorage.removeItem("selectedSSOAccount"),$location.search({}),localstore.setSelectedAccount(item),completeLogin(),security.authenticateSelectedUser(item)})}function chooseFavorite(item,$event){$scope.selectFavoriteAccount=item.accountId,security.saveUserData($scope.appControlData),$translator.translate("bt.prefs.update",{},{defaultAccountId:item.accountId}).then(function(res){$scope.appControlData.defaultAccountId=item.accountId})}function selectFavorite($event){var _currEle=$($event.currentTarget);_currEle.find(".favoriteAcccount").removeClass("hide")}function hideFavorite($event){var _currEle=$($event.currentTarget);_currEle.find(".favoriteAcccount").addClass("hide")}function checkResetPassLinkExpiry(search){var url="mp.user.resetPassLinkExpiry",params={token:search.token};return $translator.translate(url,params)}function handleResetPassword(search){checkResetPassLinkExpiry(search).then(function(){switchForms("reset-pass"),security.getPasswordPolicy(search.emailId,{updatePasswordPolicy:function(res){$scope.pwdPolicy=res}}),$scope.emailPhone=search.emailId,$scope.oneTimeToken=search.token},function(){NotificationService.notify(i18n.i18nString("reset_password_link"),"error")})}function linkedinInsightTracking(){var appConfig=window.appConfig;try{window&&window.lintrk&&appConfig.ENABLE_LINKEDIN_INSIGHT&&appConfig.LINKEDIN_INSIGHT_ID&&window.lintrk("track",{conversion_id:appConfig.LINKEDIN_INSIGHT_ID})}catch(e){console.log("Failed lintrk")}}function submitAutoLogin(form){linkedinInsightTracking(),$scope.emailPhone=form.emailPhone.$modelValue;var data={phone:$scope.displayCountryCodes,countryCode:$scope.selectedCountryCode.value,emailPhone:$scope.emailPhone,formType:$scope.formType};submitAutoLoginByData(data)}function submitAutoLoginByData(data,skipPreSignup){$scope.existingUser=!1,$scope.showSpinner=!0,security.autoLogin(data,{userExist:function(){$scope.showSpinner=!1,$scope.existingUser=!0,$scope.checkingId=!1},success:function(){$scope.showSpinner=!1,$scope.existingUser=!1,$scope.checkingId=!1},moreRequired:function(value){$timeout(function(){"pre-sign-up"===value&&skipPreSignup&&(value="sign-up"),switchForms(value),$scope.showSpinner=!1},500)},failure:function(response,isSecondaryIdentity){$scope.showSpinner=!1,$scope.checkingId=!1,$scope.error=!0,isSecondaryIdentity?$scope.errorMsg=i18n.i18nString("userid_failure"):$scope.errorMsg=$applicationService.getErrorMessage(response),NotificationService.notify($scope.errorMsg,"error")},stopFurther:function(res){$scope.showSpinner=!1,$scope.checkingId=!1,"ShowError"===res.reason&&NotificationService.notify(res.msg,"error",4e3)},updatePasswordPolicy:function(res){$scope.passwordPolicy=res,$scope.checkingId=!1}})}function submitMultiLogin(value){var data={phone:!1,emailPhone:value};security.autoLogin(data,{success:function(){completeLogin()}})}function submitLogin(form){var data={phone:$scope.displayCountryCodes,emailPhone:form.emailPhone.$modelValue,pass:form.pass.$modelValue};$scope.error=!1,$scope.login.error=!1,security.login(data,{success:function(){completeLogin()},moreRequired:function(value,currentAccount){$scope.loginComplete=!1,$scope.appControlData=currentAccount,$scope.availableAccounts=_.filter(currentAccount.associatedAccounts,function(account){return account.isDeveloper||!1}),$timeout(function(){switchForms(value)},500)},failure:function(res){$scope.error=!0,$scope.login.error=!0,$scope.passwordExpired?($scope.errorMsg=i18n.i18nString("password_expired"),$scope.passwordExpired=!1):$scope.errorMsg=$applicationService.getErrorMessage(res),NotificationService.notify($scope.errorMsg,"error")}})}function newBotLanding(){var jStorage=localstore.getAuthData();jStorage&&($scope.appControlData=jStorage.currentAccount,$scope.availableAccounts=_.filter(jStorage.currentAccount.associatedAccounts,function(account){return account.isDeveloper||!1}),$scope.appControlData.defaultAccountId&&""!==$scope.appControlData.defaultAccountId&&($scope.selectFavoriteAccount=$scope.appControlData.defaultAccountId),$scope.login.error=!1,$scope.error=!1,$scope.formType="landing-page",jStorage.currentAccount&&jStorage.currentAccount.userInfo&&jStorage.currentAccount.userInfo.profImage&&"no-avatar"!==jStorage.currentAccount.userInfo.profImage&&($scope.userAvatar=window.appConfig.API_SERVER_URL+"/api/1.1/getMediaStream/profilePictures/"+jStorage.currentAccount.userInfo.id+"/r_64x64_profile.png"),$scope.formTitle=$scope.formTitles["landing-page"],$scope.availableAccounts.length<=0&&($scope.formTitle=$scope.formTitles["default"])),$rootScope.showLoginLoader=!1,setTimeout(function(){$(".koreLoginContainer").scrollTop(1)},600)}function ssoLogin(idp,checkDirect){linkedinInsightTracking();var dataObject={idp:idp};$scope.emailPhone&&$scope.emailPhone.length&&($scope.displayCountryCodes?dataObject.username=($scope.selectedCountryCode.value+$scope.emailPhone).replace(/-/g,""):dataObject.username=$scope.emailPhone),security.handleSSORedirect(dataObject,checkDirect)}function submitResetLink(form){$scope.displayCountryCodes?console.log("Pending"):$scope.emailResetLinkLabel=i18n.i18nString("Sending");var data={phone:$scope.displayCountryCodes,countryCode:$scope.selectedCountryCode.value,emailPhone:form.emailPhone.$modelValue};security.sendResetLink(data,{success:function(){$scope.resetLinkSent=!0,$scope.displayCountryCodes?console.log("Pending"):($scope.emailResetLinkLabel=i18n.i18nString("sent"),$timeout(function(){$scope.emailResetLinkLabel=i18n.i18nString("email_resent_link")},5e3))},failure:function(res){$scope.error=!0,429===res.status?($scope.errorMsg=res.data.errors[0].msg,$timeout(function(){$scope.emailResetLinkLabel=i18n.i18nString("email_resent_link")},1e3)):$scope.errorMsg=res.data.errors[0].msg}})}function resetPassword(form){var data={pass:form.pass.$modelValue,passConfirm:form.passConfirm.$modelValue,token:$scope.oneTimeToken};security.passReset(data,{success:function(value){switchForms(value)},failure:function(res){$scope.errorReset=!0,$scope.errorMsg=res.data.errors[0].msg}})}function submitSignUp(form,isFromPassword){var data={phone:$scope.displayCountryCodes,emailPhone:form.emailPhone.$modelValue,firstName:form.koreFN.$modelValue,lastName:form.koreLN.$modelValue,pass:form.KoreSecure.$modelValue,passConfirm:form.KoreSecureConfirm.$modelValue};return form.KoreAccNa&&form.KoreAccNa.$modelValue&&(data.accountName=form.KoreAccNa.$modelValue||""),isFromPassword?(data.token=$scope.searchParams.token,data.emailId=form.emailPhone.$modelValue,void security.handleAccountActivation(data,{success:function(){$scope.emailPhone=form.emailPhone.$modelValue||$scope.displayCountryCodes,switchForms("credentials")},failure:function(res){$scope.errorSignUp=!0,$scope.errorMsg=res.data.errors[0].msg}})):void security.signUp(data,{success:function(value){$scope.emailPhone=form.emailPhone.$modelValue||$scope.displayCountryCodes,switchForms(value)},failure:function(res){$scope.error=!0,$scope.errorMsg=res.data.errors[0].msg}})}function resendCode(){$scope.codeSent=i18n.i18nString("code_sent_name"),$timeout(function(){$scope.codeSent=i18n.i18nString("code_sent")},5e3)}function resendEmail(showNotification){if($scope.emailSent!==i18n.i18nString("email_sent_name")){var payload={emailId:$scope.emailPhone};$scope.emailSent=i18n.i18nString("send_email"),security.resendVerification(payload,!1).then(function(){showNotification&&NotificationService.notify(i18n.i18nString("link_sent_to_your_email"),"success"),$scope.emailSent=i18n.i18nString("email_sent_name"),$timeout(function(){$scope.emailSent=i18n.i18nString("email_sent")},5e3)},function(res){$scope.error=!0,$scope.emailSent=i18n.i18nString("email_sent"),res.data&&res.data.errors&&res.data.errors.length&&res.data.errors[0].msg?($scope.errorMsg=res.data.errors[0].msg,NotificationService.notify($scope.errorMsg,"error")):NotificationService.notify(i18n.i18nString("error_handle_msg"),"error")})}}function cancel(){$scope.emailPhone=null,$scope.displayCountryCodes=!1,switchForms("default")}function changeEmailPhone(){var modalData;modalData=$scope.displayCountryCodes===!1?{alertType:"info",alertTitle:i18n.i18nString("change_email_title"),alertMessage:i18n.i18nString("change_email_message"),acceptButton:i18n.i18nString("change")}:{alertType:"info",alertTitle:i18n.i18nString("change_phone_title"),alertMessage:i18n.i18nString("change_phone_message"),acceptButton:"Change"}}function checkValidations(type,string){var format1=/[~!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/,format2=/(www|http|https)/;format1.test(string)||format2.test(string)?"firstName"==type?$scope.validations.invalidFirstName=!0:"lastName"==type?$scope.validations.invalidLastName=!0:$scope.validations.invalidAccountName=!0:"firstName"==type?$scope.validations.invalidFirstName=!1:"lastName"==type?$scope.validations.invalidLastName=!1:$scope.validations.invalidAccountName=!1}security.isAuthenticated()?$location.path(window.appConfig.CONTEXT_PATH):localstore.setFromLoginScreenFlag(),$scope.marketingBannerForms={"default":!0,credentials:!0,forgot:!0};var queryLanguage=window.localStorage.getItem("queryParamLang");$scope.language=queryLanguage||"en",$scope.marketingUrl="",window.appConfig.homePageIframeUrl&&($scope.marketingUrl=$sce.trustAsResourceUrl(window.appConfig.homePageIframeUrl+"?lan="+$scope.language)),window.appConfig&&window.appConfig.enableHomepage&&($scope.showMarketingBanner=!0,$scope.dynoff=-55),$scope.hideSSOBtns=window.appConfig.HIDE_SSO_LOGIN||!1,$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.multiUsers=null,$scope.emailSent=i18n.i18nString("email_sent"),$scope.codeSent=i18n.i18nString("code_sent"),$scope.emailResetLinkLabel=i18n.i18nString("email_reset"),$scope.charRemaining=i18n.i18nString("Generalform_charlimit"),$scope.userAvatar=env_conf["context-url"]+"/img/user-gray.svg",$scope.cOne=env_conf["context-url"]+"/assets/login/carousel/Bot_home_banner_Multilingual-Virtual-Assistants-1.jpg",$scope.cTwo=env_conf["context-url"]+"/assets/login/carousel/Bot_home_banner_conversation-testing.jpg",$scope.cThree=env_conf["context-url"]+"/assets/login/carousel/Use-Cases-Main-Banner.jpg",$scope.platform=env_conf["context-url"]+"/assets/login/carousel/Platform.svg",$scope.resetLinkSent=!1,$scope.passwordExpired=!1,$scope.showFormType=!1,$rootScope.showLoginLoader=window&&window.appConfig&&window.appConfig.DIRECT_SSO_LOGIN,$scope.ssoOptions=[];var searchParms=$location.search(),hashParms=$location.hash();$scope.defaultLoginPage="default","login"===hashParms&&(searchParms.email||searchParms.emailId||searchParms.phoneNo||searchParms.sso)&&($scope.checkingId=!0),$scope.allAvailableSSOoptions={google:{key:"google","class":"sso-google",icon:"bt-google-login",image:env_conf["context-url"]+"/assets/login/sso-icons/google-icon.svg",name:i18n.i18nString("label_google")},microsoft:{key:"microsoft","class":"sso-ms",icon:"btn-google-login",image:env_conf["context-url"]+"/assets/login/sso-icons/microsoft-icon.svg",name:i18n.i18nString("label_microsoft")},linkedin:{key:"linkedin","class":"sso-linkedin",icon:"btn-google-login",image:env_conf["context-url"]+"/assets/login/sso-icons/linkedin-icon.svg",name:i18n.i18nString("label_linkedin")},github:{key:"github","class":"ss0-gitHub",icon:"bt-google-login",image:env_conf["context-url"]+"/assets/login/sso-icons/github-icon.svg",name:i18n.i18nString("label_github")}},$scope.initCarousal=function(){setTimeout(function(){$("#carouselkoreLogin").carousel()})},prepareSSOOptions(),$scope.clearLocalStorage=function(){window&&window.localStorage&&window.localStorage.removeItem("previousState")},$scope.resizeIframe=resizeIframe,$scope.clearLocalStorage(),window&&window.appConfig&&window.appConfig.DIRECT_SSO_LOGIN?($scope.formType=$scope.defaultLoginPage,$scope.showFormType=!0,$translator.translate("bt.check.directSSOStatus").then(function(res){res&&res.data.defaultSSOEnabled?security.handleSSORedirect(res.data,"direct"):$rootScope.showLoginLoader=!1},function(err){$rootScope.showLoginLoader=!1})):($scope.formType=$scope.defaultLoginPage,$rootScope.showLoginLoader=!1,$scope.showFormType=!0),$scope.login={error:!1},$scope.passwordPolicy={hintText:i18n.i18nString("password_policy"),pattern:"^",minLength:8,maxLength:256},$scope.formTitles={"default":i18n.i18nString("formtitles_default"),credentials:i18n.i18nString("formtitles_credentials"),multi:i18n.i18nString("formtitles_multi"),forgot:i18n.i18nString("formtitles_forgot"),"reset-pass":i18n.i18nString("formtitles_reset_pass"),"sign-up":i18n.i18nString("formtitles_sign-up"),"pre-sign-up":i18n.i18nString("formtitles_pre_sign_up"),"verify-email":i18n.i18nString("formtitles_verify_email"),"verify-phone":i18n.i18nString("formtitles_verify_phone"),"disable-signup":i18n.i18nString("formtitles_disable_signup"),"landing-page":i18n.i18nString("formtitles_landing-page")},$scope.formTitle=$scope.formTitles[$scope.formType],queryLanguage&&"ja"==queryLanguage?$scope.showJapanesePolicy=!0:$scope.showJapanesePolicy=!1,$scope.emailPhone=null,$scope.oneTimeToken=null,$scope.countryCodes=[{name:"Canada",value:"+1"},{name:"India",value:"+91"}],$scope.selectedCountryCode=$scope.countryCodes[0],$scope.searchCountryCodes="",$scope.displayCountryCodes=!1,$scope.loginComplete=!1,$scope.error=!1,$scope.errorReset=!1,$scope.switchForms=switchForms,$scope.removeSession=removeSession,$scope.phoneCode=phoneCode,$scope.selectCountryCode=selectCountryCode,$scope.chooseAccount=chooseAccount,$scope.selectFavorite=selectFavorite,$scope.chooseFavorite=chooseFavorite,$scope.hideFavorite=hideFavorite,$scope.submitAutoLogin=submitAutoLogin,$scope.submitMultiLogin=submitMultiLogin,$scope.submitLogin=submitLogin,$scope.ssoLogin=ssoLogin,$scope.submitResetLink=submitResetLink,$scope.resetPassword=resetPassword,$scope.submitSignUp=submitSignUp,$scope.resendCode=resendCode,$scope.resendEmail=resendEmail,$scope.cancel=cancel,$scope.changeEmailPhone=changeEmailPhone,$scope.checkValidations=checkValidations,window.localStorage.setItem("sortType","BotName"),window.localStorage.setItem("botSortValue","allBots");var _usrInfo=JSON.parse(window.localStorage.getItem("emailIdStorage"));if(_usrInfo){$scope.emailPhone=_usrInfo.email||"";var _emailJson={email:$scope.emailPhone};window.localStorage.setItem("emailIdStorage",JSON.stringify(_emailJson))}var _queryEmail=$location.search().email;_queryEmail&&($scope.emailPhone=_queryEmail||""),$scope.doFocus=function(){$timeout(function(){var _ele=$(".sign-up-in input:visible");$.each(_ele,function(k,ele){return""===$(ele).val().trim()?($(ele).focus(),!1):void 0})},500)},$scope.showLoginForm=function(){switchForms("default")},$rootScope.$on("EVENT.PASSWORD_EXPIRY",function(name,res){$scope.passwordExpired=!0,$scope.error=!1,$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-user-profile/bt-change-password.html",controller:"BTChangePasswordCtrl",windowClass:"modal-kr changePwdLogin loginBG",resolve:{config:function(){return{userInfo:res.username||{}}}}})}),activate(),$scope.closeFlow=function(account){security.logout()},$scope.openLinks=function(type,$event){"community"===type?$rootScope.redirectToLink("https://community.kore.ai/",$event,!0):"koreAcademy"===type?$rootScope.redirectToLink("https://info.kore.ai/online-training-schedule",$event,!0):"documents"===type?$rootScope.redirectToLink("https://developer.kore.ai/docs/bots/chatbot-overview/koreai-platform/",$event,!0):"support"===type&&$rootScope.redirectToLink("https://support.kore.ai",$event,!0)},$scope.validations={invalidFirstName:!1,invalidLastName:!1,invalidAccountName:!1}}angular.module("bt-login",[]).controller("BTLoginCtrl",Login),Login.$inject=["$rootScope","$scope","$timeout","$location","security","$translator","$applicationService","NotificationService","$modal","localstore","i18n","mixPanel","env_conf","$sce"]}(),function(){"use strict";function acceptLicense($rootScope,$scope,$timeout,$location,security,$applicationService,$translator,mixPanel){function activate(){var _userInfo=$applicationService.userInfo();return _userInfo&&_userInfo.koreUserInfo&&_userInfo.koreUserInfo.isBTLicenseAccepted&&!_userInfo.koreUserInfo.isBTLicenseAccepted_update&&($scope.isUpdate=!0),$(".bt-modal-wrong-sso").length?!1:($("#termsConditions").modal({backdrop:"static",keyboard:!1}),$(document).on("shown.bs.modal","#termsConditions",function(evt){$timeout(function(){$("body").addClass("modal-open")},1e3)}),void PerfectScrollbar.initialize($("#termsConditions .modal-body")[0],{wheelSpeed:2,wheelPropagation:!0,minScrollbarLength:25}))}function accept(){$scope.apiCallInProgress=!0;var url="mp.user.acceptbtlicense",params={userId:$applicationService.userInfo().userId};$translator.translate(url,params).then(function(){var userInfo={$email:$applicationService.userInfo().emailPhone,FirstName:$applicationService.userInfo().firstName,LastName:$applicationService.userInfo().lastName};mixPanel.postEvent("License Agreement Accepted",userInfo),$scope.apiCallInProgress=!1,window.location=window.appConfig.CONTEXT_PATH},function(){$scope.apiCallInProgress=!1})}function decline(){var userInfo={$email:$applicationService.userInfo().emailPhone,FirstName:$applicationService.userInfo().firstName,LastName:$applicationService.userInfo().lastName};mixPanel.postEvent("License Agreement Declined",userInfo),security.logout()}$scope.accept=accept,$scope.decline=decline,$scope.enableAgree=!1,$scope.MP_URL=window.appConfig.MP_URL,$scope.apiCallInProgress=!1,activate()}angular.module("bt-login").controller("BTAcceptLicenseCtrl",acceptLicense),acceptLicense.$inject=["$rootScope","$scope","$timeout","$location","security","$applicationService","$translator","mixPanel"]}(),function(){"use strict";function information($routeParams,$rootScope,$scope,$timeout,$location,security,$translator,$applicationService,NotificationService,$modal,localstore,i18n,AuthInterceptor){$scope["case"]="default",$routeParams.infoType&&($scope["case"]=$routeParams.infoType),$scope.buttonText=i18n.i18nString("re_login"),$rootScope.showLoginLoader=!1,$rootScope.$emit("botTestEnd"),$scope.relogin=function(){security.resetlocalStoragAfterLogout(),$rootScope.showLoginLoader=!0,AuthInterceptor.setReAuthFormOpened(!1),security.redirectToLoginPath()}}angular.module("bt-login").controller("BTInfoCtrl",information),information.$inject=["$routeParams","$rootScope","$scope","$timeout","$location","security","$translator","$applicationService","NotificationService","$modal","localstore","i18n","AuthInterceptor"]}(),function(){"use strict";function requestAccess($rootScope,$scope,$timeout,$location,security,$applicationService,$translator,$routeParams,i18n){function activate(){$("#request-bt-access").modal({backdrop:"static",keyboard:!1}),PerfectScrollbar.initialize($("#request-bt-access .modal-body")[0],{wheelSpeed:2,wheelPropagation:!0,minScrollbarLength:25})}function submitRequest(){var url="mp.user.getBTAccess",params={userId:$applicationService.userInfo().userId};params.userId?requestForBTAccess(params,url):$scope.signUpAndAccessBt()}function requestForBTAccess(params,url){var payload={requestInfo:{firstName:$scope.firstName,lastName:$scope.lastName,emailId:$scope.businessEmail,companyName:$scope.companyName,jobTitle:$scope.jobTitle,message:$scope.message1+" \n\n"+$scope.message2+" \n\n"+$scope.message3}};$translator.translate(url,params,payload).then(function(){$scope.displayMessage=!0,$scope.message=i18n.i18nString("bt_reqst_access_reqst_sent_approval")+" <br>"+i18n.i18nString("bt_reqst_access_notified_through_email"),$timeout(function(){PerfectScrollbar.update($(".modalPerfectScroll")[0])},1e3)},function(response){NotificationService.notify(response.data.errors[0].msg,"error")})}function logout(){security.logout()}if($scope.submitRequest=submitRequest,$scope.logout=logout,$scope.firstName="",$scope.lastName="",$scope.businessEmail="",$scope.companyName="",$scope.jobTitle="",$scope.message1="",$scope.message2="",$scope.message3="",$scope.error=!1,$scope.displayMessage=!1,$scope.message=null,$scope.done=i18n.i18nString("done"),$scope.cancel=i18n.i18nString("cancel"),$applicationService.userInfo()&&$applicationService.userInfo().koreUserInfo){var _koreUserInfo=$applicationService.userInfo().koreUserInfo;$scope.firstName=_koreUserInfo.firstName||"",$scope.lastName=_koreUserInfo.lastName||"",$scope.businessEmail=_koreUserInfo.emailId||"",$scope.companyName=_koreUserInfo.orgDomain||""}var _isFreeDomain=$routeParams.isFreeDomain;_isFreeDomain&&"true"===_isFreeDomain&&($scope.message=i18n.i18nString("bt_reqst_access_only_enterprise_owners"),$scope.displayMessage=!0),$(document).on("shown.bs.modal","#request-bt-access",function(evt){$("body").removeClass("hidebodyscroll"),$("body").addClass("modal-open")}),activate(),$scope.signUpAndAccessBt=function(){var data={emailPhone:$scope.businessEmail,firstName:$scope.firstName,lastName:$scope.lastName};security.signUpUser(data,{success:function(value){var params={userId:value.data.userId},url="mp.user.getBTAccessPublic";requestForBTAccess(params,url)},failure:function(res){$scope.error=!0,$scope.errorMsg=res.data.errors[0].msg}})}}angular.module("bt-login").controller("BTRequestAccessCtrl",requestAccess),requestAccess.$inject=["$rootScope","$scope","$timeout","$location","security","$applicationService","$translator","$routeParams","i18n"]}(),function(){"use strict";function requestAccess($rootScope,$scope,$timeout,$location,security,$applicationService,$workflowService,$translator,$routeParams,env_conf,i18n){function activate(){$("#request-sf-bt-access").modal({backdrop:"static",keyboard:!1}),PerfectScrollbar.initialize($("#request-sf-bt-access .modal-body")[0],{wheelSpeed:2,wheelPropagation:!0,minScrollbarLength:25})}function submitRequest(userId){var url="mp.user.getSFBTAccess",params={userId:userId},payload={};payload=$scope.reqBTAccessDetails,payload.userId=userId,$translator.translate(url,params,payload).then(function(res){$scope.displayMessage=!0,$scope.message=i18n.i18nString("bt_reqst_access_reqst_sent_approval")+" <br>"+i18n.i18nString("bt_reqst_access_notified_through_email")},function(response){NotificationService.notify(response.data.errors[0].msg,"error")})}function logout(){security.logout()}$scope.streamData=$workflowService.selectedStream(),$scope.userInfo=$applicationService.userInfo(),$scope.reqBTAccessDetails={userId:$scope.userInfo.userId,FirstName:"",LastName:"",Email:"",Title:"",CompanyName:"",Number_Of_Employees:"",Industry:"",Phone:"",Describe_the_use_cases_for_bots_E:"",Does_the_backend_system_have_APIs_E:"",Do_you_have_access_to_those_APIs_E:"",How_many_users_would_use_this_bot_E:"",What_backend_sys_will_bot_interact_E:"",What_is_the_title_of_budget_owner_E:"",When_to_purchase_licenses_for_users_E:"",Who_is_the_budget_owner_E:"",Why_are_bots_valuable_for_org_E:""},$scope.closeSFBTAccessModal=function(){$location.path(window.appConfig.CONTEXT_PATH+"/login")},$scope.submitRequest=submitRequest,$scope.logout=logout,$scope.firstName="",$scope.lastName="",$scope.businessEmail="",$scope.companyName="",$scope.jobTitle="",$scope.message1="",$scope.message2="",$scope.message3="",$scope.error=!1,$scope.displayMessage=!1,$scope.message=null,$scope.bulbSvg=env_conf["context-url"]+"/assets/images/bulbicon.svg",$scope.dateField={format:"dd/MM/yyyy",title:"License Purchase Date",placeholder:"dd/mm/yyyy"};var _isFreeDomain=$routeParams.isFreeDomain;_isFreeDomain&&"true"===_isFreeDomain&&($scope.message=i18n.i18nString("sf_bt_reqest_only_enterprise_domain_notify"),$scope.displayMessage=!0),$(document).on("shown.bs.modal","#request-bt-access",function(evt){$("body").removeClass("hidebodyscroll"),$("body").addClass("modal-open")}),activate(),$scope.signUpAndAccessBt=function(){var _userId=$location.search().userId;if(_userId)submitRequest(_userId);else{var data={emailPhone:$scope.reqBTAccessDetails.Email,firstName:$scope.reqBTAccessDetails.FirstName,lastName:$scope.reqBTAccessDetails.LastName};security.signUpUser(data,{success:function(value){submitRequest(value.data.userId)},failure:function(res){
$scope.error=!0,$scope.errorMsg=res.data.errors[0].msg}})}}}angular.module("bt-login").controller("STBTRequestAccessCtrl",requestAccess),requestAccess.$inject=["$rootScope","$scope","$timeout","$location","security","$applicationService","$workflowService","$translator","$routeParams","env_conf","i18n"]}(),function(ng){"use strict";var _module=ng.module("manage-components",[]);_module.directive("manageComponentsForm",function(){return{restrict:"EA",scope:{onComplete:"&?",wfType:"@?",configure:"&?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-manage-components/manage-components.html",controller:["$window","$element","$rootScope","$scope","$workflowService","$location","$routeParams","BTStreamsService","$q","BTAlertsService","BTActionsService","BTFlowtaskService","$timeout","color","$filter","_constants_","NotificationService","form_util","indexerUtil","accessControlService","env_conf","$applicationService","i18n","mixPanel",function($window,$element,$rootScope,$scope,$workflowService,$location,$routeParams,BTStreamsService,$q,BTAlertsService,BTActionsService,BTFlowtaskService,$timeout,color,$filter,_constants_,NotificationService,form_util,indexerUtil,accessControlService,env_conf,$applicationService,i18n,mixPanel){function updateDialogEntities(){$scope.dialogEntities=_.filter(_botComponents,{type:"entity"})}function fetchBotComponentsByType(type,callback){"dialogact"===type&&(type="dialogAct"),"sdkwebhook"===type&&(type="SDKWebHook"),"agenttransfer"===type&&(type="agentTransfer");var state="published";("indevelopement"===$scope.selectedBotState||"configured"===$scope.selectedBotState)&&(state="configured"),BTFlowtaskService.getComponentsByTypeAndState(_selectedStream._id,type,state).then(function(res){$scope._botComponents=[],res&&res.data&&res.data.length>0&&($.each(res.data,function(k,comp){comp.status===$scope.selectedBotState&&$scope._botComponents.push(comp)}),updateDialogEntities(),$timeout(function(){callback(),updateComponentsUsage()},350))},function(error){if(_botComponents=[],error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("fetch_error"),"error")})}function getNodeUsedList(tmpNode){var flowtaskNames=[];return $.each($scope.flowTasks,function(k,task){$.each(task.nodes,function(k,node){return node.type!==tmpNode.type||node.componentId!==tmpNode._id&&node.componentId!==tmpNode.parentId?void 0:(flowtaskNames.push(task.name),!1)}),task.child&&task.child.length&&$.each(task.child[0].nodes,function(k,node){return node.type!==tmpNode.type||node.componentId!==tmpNode._id&&node.componentId!==tmpNode.parentId?void 0:(flowtaskNames.push(task.name),!1)})}),_.uniq(flowtaskNames)}function getNodeUsedListIds(tmpNode){var flowtaskIds=[];return $.each($scope.flowTasks,function(k,task){$.each(task.nodes,function(k,node){return node.type===tmpNode.type&&node.componentId===tmpNode._id?(flowtaskIds.push(task._id),!1):void 0})}),flowtaskIds}function updateComponentsUsage(){$scope._nodes=angular.copy($scope._botComponents),$.each($scope._nodes,function(k,comp){comp.flowtasksInvolved=getNodeUsedList(comp),comp.flowtasksInvolvedIds=getNodeUsedListIds(comp)}),$.each($scope._nodes,function(k,comp){comp.status===$scope.filterToggle&&($scope.componentsCount[comp.type.toLowerCase()]=$scope.componentsCount[comp.type.toLowerCase()]+1)}),$timeout(function(){$scope.showLoading=!1},500),$timeout(function(){$(".manageComponentRightContainer").scrollTop(1)},750)}function intialize(){_objList=[],_objConnection=[],count=0,dummyConnectionCount=0,_saveNodeInProgress=!1,_dialogObj={},_currentSourceNode="",_dummyConnectionId="",$scope.runBot.show=!0,$scope.objList={},$scope.firstNodeUId="",$scope.selectedNode="",$scope.isPropertyPanelOpened=!1,$scope.isDebugConsolePanelOpened=!1,$scope.nodeObjList=[],$scope.nodeObj={},$scope.nodeObjLabels={},resetFlag&&($scope.introObj={screenshots:[]},$scope.introObj.needsAuth=!1),$scope.streamId=_selectedStream._id,setDataForEdit(),$timeout(function(){$element.find(".flowTaskPropertyPanel").draggable({handle:".property-panel-header",containment:".dialogFieldset",drag:ondragging,stop:onPanelDragStop}).resizable({containment:".dialogFieldset",minWidth:500,maxWidth:700,handles:"e, w"}),$element.find(".flowTaskPropertyPanel").css("top","5px").css("right","5px").css("left","auto")})}function setDataForEdit(){$.each($scope.flowTasks,function(k,_dialogObj){BTFlowtaskService.getFlowtaskComponents($scope.streamId,_dialogObj._id).then(function(res){var _res=res&&res.data||[],_tempComponents={};$.each(_res,function(k,component){_tempComponents[component._id]=component}),$.each(_dialogObj.nodes,function(k,node){var _tempNodeObj=_tempComponents[node.componentId];if(_tempNodeObj&&_tempNodeObj.name){if($scope.objList[node.componentId]=$.extend(!0,{},_nodeObj,{type:_tempNodeObj.type,name:_tempNodeObj.name,uId:node.nodeId,desc:_tempNodeObj.desc,metadata:node.metadata,componentId:_tempNodeObj._id,nodeOptions:node.nodeOptions}),"intent"===_tempNodeObj.type&&($scope.objList[node.componentId].flowTaskId=node.flowTaskId,$scope.objList[node.componentId].intent=_tempNodeObj.intent,node.contextMap))if(node.contextMap.constructor===String)try{$scope.objList[node.componentId].contextMap=JSON.parse(node.contextMap)}catch(e){$scope.objList[node.componentId].contextMap={}}else $scope.objList[node.componentId].contextMap=node.contextMap;if($scope.objList[node.componentId].nodeTypeName=$scope.configurableElements[_tempNodeObj.type]?$scope.configurableElements[_tempNodeObj.type].name:"unknown",node.transitions&&node.transitions.length>0){var connectionNum=1;$.each(node.transitions,function(l,transition){var _tempConnId=transition.metadata&&transition.metadata.connId?transition.metadata.connId:"dummy"+dummyConnectionCount;dummyConnectionCount++;var _tempConnObj={connId:_tempConnId,sourceId:node.componentId,targetId:void 0!==transition["default"]?transition["default"]:transition.then,isDefault:void 0!==transition["default"]?!0:!1};transition["if"]=transition["if"]||{},_tempConnObj.ifConditionPrefix=void 0!==transition["if"].intent?"intent":void 0!==transition["if"].field?"field":"context","dialogAct"===node.type?(_tempConnObj.ifConditionPrefix="dialogAct",_tempConnObj.ifOperator="",_tempConnObj.value="",_tempConnObj.isDefault?(_tempConnObj.ifCondition="no",delete transition["if"]):_tempConnObj.ifCondition="yes"):void 0!==transition["default"]?(_tempConnObj.ifCondition="",_tempConnObj.ifOperator="",_tempConnObj.value="",delete transition["if"]):(void 0!==transition["if"].field?_tempConnObj.ifCondition=transition["if"].field||"":void 0!==transition["if"].intent?_tempConnObj.ifCondition=transition["if"].intent||"":_tempConnObj.ifCondition=transition["if"].context||"",_tempConnObj.ifOperator=transition["if"].op||"",_tempConnObj.value=transition["if"].value||""),transition.metadata&&transition.metadata.color?_tempConnObj.color=transition.metadata.color:(_tempConnObj.color=_connectionColors[l>0?l:0],transition.metadata?_dialogObj.nodes[k].transitions[l].metadata.color=_tempConnObj.color:_dialogObj.nodes[k].transitions[l].metadata={color:_tempConnObj.color}),$scope.objList[node.componentId].connections[_tempConnId]=$.extend(!0,{},_connObj,_tempConnObj),_tempConnObj.connObjNumber=connectionNum,_objConnection.push($.extend(!0,{},_connObj,_tempConnObj)),connectionNum++;var _tempConn=_tempConnId.replace("dummy","");isNaN(_tempConn)||parseInt(_tempConn)>dummyConnectionCount&&(dummyConnectionCount=parseInt(_tempConn)+5)})}_objList.push($.extend({},_tempNodeObj,{nodeId:node.nodeId}))}var _nodeNumber=node.nodeId.replace(node.type,"");$scope.objList[node.componentId]&&($scope.objList[node.componentId].nodeNumber=parseInt(_nodeNumber)+1),isNaN(_nodeNumber)||parseInt(_nodeNumber)>count&&(count=parseInt(_nodeNumber))}),count++},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("some_error_occured"),"error");$scope.closeManageComponentsModal()})})}function onPanelDragStop(e,u){if(e.target){var _parentEle=$element.find(".flowTaskConnectionBlock"),_ele=$(e.target),_right=parseInt(_parentEle.width())-u.position.left-parseInt(_ele.width());_ele.css("right",_right+"px"),_ele.css("left","auto")}}function ondragging(e,u){u.position.top<0&&(u.position.top=0);var _parentEleDrag=$element.find(".manageComponentRightContainer"),_propertyPanelEle=$(".flowTaskPropertyPanel");if(_parentEleDrag&&_propertyPanelEle){var _parentHeight=_parentEleDrag.height(),_propertyPanelEleHeight=_propertyPanelEle.height();_propertyPanelEleHeight+u.position.top>_parentHeight&&(u.position.top=10)}}function getUtterances(componentId){componentId&&BTStreamsService.getUtterances(componentId,$scope.utterences.length,10,"").then(function(res){$timeout(function(){$scope.propertyCb.updateUtterance&&$scope.propertyCb.updateUtterance(res)},300)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("getting_utterance"),"error")})}function writeAndDownloadDialog(filename,data){var element=document.createElement("a");element.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(data)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function setPropertyPanelWidth(){_flowTaskPropertyPanel.css("width",Math.floor(.6*_flowTaskConnectionBlock.width())),_flowTaskPropertyPanel.resizable&&_flowTaskPropertyPanel.resizable("option","maxWidth",Math.floor(.6*_flowTaskConnectionBlock.width()))}var _flowTaskConnectionBlock=$element.find(".flowTaskConnectionBlock"),_flowTaskPropertyPanel=$element.find(".flowTaskPropertyPanel");$scope.constants=_constants_,$scope.assetsBase=env_conf["assets-url"],$scope.stream=angular.copy($workflowService.selectedStream()),$scope.selectedBotState=$workflowService.selectedStreamState(),"indevelopment"===$scope.selectedBotState&&($scope.selectedBotState="configured"),$scope.showLoading=!0,$scope.componentsNames=[{type:"Intent",name:"User Intent",active:!0},{type:"Entity",name:"Entity",active:!1},{type:"Service",name:"Service",active:!1},{type:"Script",name:"Script",active:!1},{type:"Message",name:"Message",active:!1},{type:"dialogact",name:i18n.i18nString("configurable_dialogact_name"),active:!1},{type:"SDKWebHook",name:i18n.i18nString("configurable_webhook_name"),active:!1},{type:"agentTransfer",name:i18n.i18nString("configurable_agenttransfer_name"),active:!1},{type:"Form",name:i18n.i18nString("configurable_form_name"),active:!1},{type:"Logic",name:i18n.i18nString("configurable_logic_name"),active:!1},{type:"botAction",name:i18n.i18nString("configurable_botAction_name"),active:!1},{type:"process",name:i18n.i18nString("configurable_process_name"),active:!1}],$scope.componentsCount={intent:0,entity:0,service:0,script:0,message:0,dialogact:0,sdkwebhook:0,agenttransfer:0},$scope.flowTasks=$workflowService.dialogTasks(),$scope._botComponents=[],$scope._nodes=[],$scope.flowtaskApi={},$scope.flowtaskApi.type="ManageComponents",$scope.modeOfAccess=accessControlService.setRetrieveValue(),$scope.taskAccess=accessControlService.getAccessRight("BOTBUILDER_TASKS"),$scope.faClose=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.chevronLeft=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-left-gray.svg",BTFlowtaskService.getComponents($scope.stream._id).then(function(res){_botComponents=res&&res.data,updateDialogEntities()},function(error){_botComponents="error"}),$scope.closeManageComponentsModal=function(){$scope.$emit("updateStep",-1),$scope.$parent.closeFullPageModal(),$scope.$parent.modalType="createBot",$scope.$parent.callback.onFlowDialogClosed(!0)},$scope.unlockDailogComponent=function(node,event){function confirmUnlock(){var payload={resources:[{resourceType:"dialogComponent",resourceId:node._id}]};BTStreamsService.unlockDailogComponent($scope.stream._id,payload).then(function(response){return"FAILURE"==response.data[0].status?void NotificationService.confirmDialog(i18n.i18nString("manage_components_confirmDialog_nodeType",{nodeType:node.type},{nodeName:node.name}),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0}):void("SUCCESS"==response.data[0].status&&BTFlowtaskService.getComponents($scope.stream._id).then(function(res){_botComponents=res&&res.data,updateDialogEntities(),intialize(),$scope.showType($scope.currentIndex),NotificationService.notify(i18n.i18nString("dialog_success"),"success")},function(error){_botComponents="error"}))},function(error){NotificationService.notify(i18n.i18nString("error_label"),"error")})}function confirmTaskUnlock(){var resources=[];resources.push({resourceId:node.dialogId||node.flowtasksInvolvedIds[0],resourceType:"dialog"});var requestData={resources:resources};BTStreamsService.unlockDialog(node.dialogId,_selectedStream._id,requestData).then(function(response){"SUCCESS"==response.data[0].status&&($workflowService.navigateTabIndex(".tasks-pane"),NotificationService.notify(i18n.i18nString("task_unlock"),"success"),$rootScope.$broadcast("loadBots",$workflowService.selectedStream()))},function(error){NotificationService.notify(i18n.i18nString("error_label"),"error")})}function cancleTaskUnlock(){}if($scope.currentNode=angular.copy(node),event&&(event.preventDefault(),event.stopPropagation()),node&&node.flowtasksInvolvedIds?node.flowtasksInvolvedCount=node.flowtasksInvolvedIds.length:node.flowtasksInvolvedCount=1,1!=node.flowtasksInvolvedCount)return void NotificationService.confirmDialog(i18n.i18nString("manage_components_confirmDialog_clone_node",{nodeType:node.type},{nodeName:node.name}),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0});var taskUnLocked=$scope.checkTaskUnlock(node.flowtasksInvolvedIds[0]);taskUnLocked?confirmUnlock():NotificationService.userConfirm(i18n.i18nString("flowtask_unlock"),[confirmTaskUnlock,cancleTaskUnlock],{okText:i18n.i18nString("confirm")},"",void 0,i18n.i18nString("task_lock"))},$scope.checkTaskUnlock=function(dailogId){var dailog=_.find($scope.flowTasks,{_id:dailogId});return dailog.editable},$scope.flowtaskApi.updateManageComponenmts=function(nodeObj){$scope.unlockDailogComponent(nodeObj.nodeDataObj)},$scope.clearSearch=function(){$scope.componentsSearchQuery=""},$scope.showType=function(index){$scope.currentIndex=index,$scope.componentsNames=[{type:"Intent",name:i18n.i18nString("userIntent"),active:!1},{type:"Entity",name:i18n.i18nString("configurable_entity_name"),active:!1},{type:"Service",name:i18n.i18nString("configurable_service_name"),active:!1},{type:"Script",name:i18n.i18nString("configurable_script_name"),active:!1},{type:"Message",name:i18n.i18nString("constants.nlp_Message"),active:!1},{type:"dialogact",name:i18n.i18nString("configurable_dialogact_name"),active:!1},{type:"SDKWebHook",name:i18n.i18nString("configurable_webhook_name"),active:!1},{type:"agentTransfer",name:i18n.i18nString("configurable_agenttransfer_name"),active:!1},{type:"Form",name:i18n.i18nString("configurable_form_name"),active:!1},{type:"Logic",name:i18n.i18nString("configurable_logic_name"),active:!1},{type:"botAction",name:i18n.i18nString("configurable_botAction_name"),active:!1},{type:"process",name:i18n.i18nString("configurable_process_name"),active:!1}],$scope.componentsNames[index].active=!0;var type=$scope.componentsNames[index].type;"botAction"!==type&&(type=type.toLowerCase()),fetchBotComponentsByType(type,function(){$(".manageComponentRightContainer").scrollTop(0),$scope.showLoading=!0,$(".row").removeClass("componentSelectedBorder"),$scope.componentsSearchQuery&&($scope.componentsSearchQuery=""),$scope.propertyCb.closePropertyPanel(),$timeout(function(){$scope.showLoading=!1},350)})};var _objList=[],_objConnection=[],count=0,dummyConnectionCount=0,_saveNodeInProgress=!1,_dialogObj={},_currentSourceNode="",_dummyConnectionId="",_previousPropertyPanelUid="";$scope.flowtaskObj=$workflowService.flowtaskInfo()||{};var _selectedStream=$workflowService.selectedStream(),errorMessages=$workflowService.seedData().entityErrorMessages[_selectedStream.defaultLanguage]||{};errorMessages.string&&(errorMessages.label=errorMessages.string),$scope.runBot={show:!0,hideSubBar:!1,fromDialogTask:!1},$scope.objList={},$scope.firstNodeUId="",$scope.firstNodeComponentId="",$scope.selectedNode="",$scope.isPropertyPanelOpened=!1,$scope.isDebugConsolePanelOpened=!1,$scope.nodeObjList=[],$scope.isConnecting=!1,$scope.nodeObj={},$scope.nodeObjLabels={},$scope.isDebugResized=0,$scope.serviceTypeList=[{name:"REST",value:"rest"},{name:"SOAP",value:"soap"}],$scope.messagesObject=null,$scope.isPrompt=!0,$scope.utterences=[],$scope.authCB={},$scope.btTestFormApi={},$scope.btTestStatus={},$scope.notifierBridge={},$scope.notiRefs={},$scope.notiRefs.tempConnections=[],$scope.objListSearch=[],$scope.searchText="",$scope.searchUId="",$scope.runBot.hideSubBar=!1,$scope.dialogMode=null,$scope.displayMode="edit",$scope._constants_=$rootScope._constants_,$scope.isWorkProgress=!1,$scope.loaderMessage=i18n.i18nString("working_on_it"),$scope.importDialogHeader=i18n.i18nString("import_dialog_desc"),$scope.importModalTitle=i18n.i18nString("bt_streams_a_dialog"),$scope.doneImporting=!1,$scope.dialogRequiredError=!1;var _connectionColors=["#299d8e","#5ea8d3","#e9c369","#f3a261","#533a71","#6183d8","#50c5b7","#7ac74f","#1c77c3","#9f86c0"];$scope.botColor=_selectedStream.color,$scope.selectedStreamName=_selectedStream.name,$scope.configurableElements={message:{type:"message",name:i18n.i18nString("bot_response"),description:i18n.i18nString("configurable_msg_desc"),shortDesc:i18n.i18nString("manage_components_send_a_msg"),showCreate:!0},dialogAct:{type:"dialogAct",name:i18n.i18nString("confirmation"),description:i18n.i18nString("configurable_dialogact_desc"),shortDesc:i18n.i18nString("manage_components_confirmation_short_desc"),showCreate:!0},entity:{type:"entity",name:i18n.i18nString("entity"),description:i18n.i18nString("manage_components_entity_desc"),shortDesc:i18n.i18nString("manage_components_entity_shortdesc"),showCreate:!0},form:{type:"form",name:i18n.i18nString("form_node_name"),description:i18n.i18nString("configurable_form_desc"),shortDesc:i18n.i18nString("configurable_form_name"),showCreate:!0},logic:{type:"logic",name:i18n.i18nString("logic_node_name"),description:i18n.i18nString("configurable_logic_desc"),shortDesc:i18n.i18nString("configurable_logic_name"),showCreate:!0},service:{type:"service",name:i18n.i18nString("service"),description:i18n.i18nString("configurable_service_desc"),shortDesc:i18n.i18nString("manage_components_servicecall_short_desc"),showCreate:!0},script:{type:"script",name:i18n.i18nString("script"),description:i18n.i18nString("configurable_script_desc"),shortDesc:i18n.i18nString("manage_components_jsscript_short_desc"),showCreate:!0},subDialog:{type:"subDialog",name:i18n.i18nString("dialog"),description:i18n.i18nString("configurable_subdialog_desc"),shortDesc:i18n.i18nString("manage_components_dialog_short_desc"),showCreate:!1},SDKWebHook:{type:"SDKWebHook",name:i18n.i18nString("webhook_uppercase"),description:i18n.i18nString("configurable_webhook_desc"),shortDesc:i18n.i18nString("manage_components_webhook_short_desc"),showCreate:!0},intent:{type:"intent",name:i18n.i18nString("userintent"),description:i18n.i18nString("configurable_intent_desc"),shortDesc:i18n.i18nString("manage_components_userIntent_short_desc"),showCreate:!0}},$rootScope.appConfig.DISABLE_AGENT_TRANSFER||($scope.configurableElements.agentTransfer={type:"agentTransfer",name:i18n.i18nString("agent_transfer_uppercase"),description:i18n.i18nString("configurable_agenttransfer_desc"),shortDesc:i18n.i18nString("manage_components_agentTransfer_short_desc"),showCreate:!0});var resetFlag,_nodeObj={type:"",name:"",uId:"",connections:{},tempConnections:{},hide:!0,desc:"",componentId:"",nodeNumber:0},_connObj={connId:"",sourceId:"",targetId:"",isDefault:!1,ifConditionPrefix:"context",ifCondition:"",ifOperator:"",value:"",color:"#009dab",top:0,showBottom:!1,connObjNumber:1},_botComponents=[],_nodeColors={subDialog:"#eaa724",intent:"#57187f",entity:"#3ab962",script:"#9b9b9b",SDKWebHook:"#8B572A",agentTransfer:"#8B572A",service:"#4a4a4a",message:"#007eff",dialogAct:"#1d758e"};$element.connections({action:"updateColors",nodeColors:_nodeColors}),$scope.displayOpts={hideType:!1,hideNode:!1,hideConn:!1},$scope.serviceNodeOptions=[{value:"custom",name:$scope._constants_.flowtasks.serviceTypes.custom},{value:"htmltoimage",name:$scope._constants_.flowtasks.serviceTypes.htmlToImage},{value:"urltoimage",name:$scope._constants_.flowtasks.serviceTypes.urlToImage}],$scope.ifOperatorsFollowupIntents=[{name:"Contains",val:"cnt"},{name:"Exists",val:""}];var _defaultIVRProps=$workflowService.defaultComponentIVRProps();$scope.flowtaskApi.getIVRDefaults=function(){return _defaultIVRProps},$scope.flowtaskApi.getIfOperatorsFollowupIntents=function(){return $scope.ifOperatorsFollowupIntents},intialize(),$scope.editPrompt=function(messages,isPrompt,openIndex,category){return"view"===$scope.displayMode?!1:($scope.messagesObject={},$scope.isPrompt=isPrompt,$scope.messagesObject.messages={},$scope.messagesObject.taskId=_dialogObj._id,$scope.messagesObject.nodeId=$scope.selectedNode.nodeInfo._id,$scope.messagesObject.name=$scope.selectedNode.nodeInfo.name,$scope.messagesObject.nodeInfo=$scope.selectedNode.nodeInfo,$scope.messagesObject.category=category,$scope.dialogMode="prompt",void $timeout(function(){$scope.messagesObject={},$scope.isPrompt=isPrompt,messages.forEach(function(message){message.text=decodeURIComponent(message.text)}),$scope.messagesObject.messages=angular.copy(messages),$scope.messagesObject.taskId=_dialogObj._id,$scope.messagesObject.nodeId=$scope.selectedNode.nodeInfo._id,$scope.messagesObject.name=$scope.selectedNode.nodeInfo.name,$scope.messagesObject.nodeInfo=$scope.selectedNode.nodeInfo,$scope.messagesObject.category=category,openIndex&&-1!==openIndex&&($scope.messagesObject.openIndex=openIndex),$scope.messagesObject.nodeInfo.nodeInfo={editLocked:$scope.selectedNode.nodeInfo.editLocked},$timeout(function(){$("#userprompt_configure").modal({backdrop:"static",show:!0})},250)},100))},$scope.onPromptClose=function(){$("#userprompt_configure").modal("hide"),$scope.dialogMode=null},$scope.onDone=function(messages,multiCategory,promptType){if($("#userprompt_configure").modal("hide"),$scope.dialogMode=null,promptType&&"submit"===promptType){$scope.selectedNode.nodeInfo.submitMessage=angular.copy(messages),messages.forEach(function(message){message.text=encodeURIComponent(message.text)});$scope.propertyCb.updateSubmitMessages&&$scope.propertyCb.updateSubmitMessages(messages);$scope.selectedNode.nodeInfo.submitMessage=angular.copy(messages)}else if(multiCategory){$scope.selectedNode.nodeInfo.multiCategoryPrompts=multiCategory;$scope.propertyCb.updateMulticategoryMessages&&$scope.propertyCb.updateMulticategoryMessages(messages)}else{$scope.selectedNode.nodeInfo.message=angular.copy(messages),messages.forEach(function(message){message.text=encodeURIComponent(message.text)});$scope.propertyCb.updateMessages&&$scope.propertyCb.updateMessages(messages);$scope.selectedNode.nodeInfo.message=angular.copy(messages)}},$scope.editError=function(errors,openIndex,category){return"view"===$scope.displayMode?!1:($scope.errorObject={},$scope.errorObject.errors={},$scope.errorObject.taskId=_dialogObj._id,$scope.errorObject.nodeId=$scope.selectedNode.nodeInfo._id,$scope.errorObject.name=$scope.selectedNode.nodeInfo.name,$scope.dialogMode="error",$scope.errorObject.nodeInfo=$scope.selectedNode.nodeInfo,$scope.errorObject.category=category,openIndex&&-1!==openIndex&&($scope.errorObject.openIndex=openIndex),$scope.errorObject.nodeInfo.nodeInfo={editLocked:$scope.selectedNode.nodeInfo.editLocked},void $timeout(function(){$scope.errorObject={},errors.forEach(function(message){message.text=decodeURIComponent(message.text)}),$scope.errorObject.errors=angular.copy(errors),$scope.errorObject.taskId=_dialogObj._id,$scope.errorObject.nodeId=$scope.selectedNode.nodeInfo._id,$scope.errorObject.name=$scope.selectedNode.nodeInfo.name,$scope.errorObject.nodeInfo=$scope.selectedNode.nodeInfo,$scope.errorObject.category=category,openIndex&&-1!==openIndex&&($scope.errorObject.openIndex=openIndex),$scope.errorObject.nodeInfo.nodeInfo={editLocked:$scope.selectedNode.nodeInfo.editLocked},$timeout(function(){$("#errorprompt_configure").modal({backdrop:"static",show:!0})},250)},100))},$scope.onErrorPromptClose=function(){$("#errorprompt_configure").modal("hide"),$scope.dialogMode=null},$scope.onErrorPromptDone=function(messages,multiCategory){if($("#errorprompt_configure").modal("hide"),$scope.dialogMode=null,multiCategory){$scope.selectedNode.nodeInfo.multiCategoryPrompts=angular.copy(multiCategory);$scope.propertyCb.updateMulticategoryMessages&&$scope.propertyCb.updateMulticategoryMessages(messages)}else{$scope.selectedNode.nodeInfo.errorMessage=angular.copy(messages),messages.forEach(function(message){message.text=encodeURIComponent(message.text)});$scope.propertyCb.updateErrorMessages&&$scope.propertyCb.updateErrorMessages(messages);$scope.selectedNode.nodeInfo.errorMessage=angular.copy(messages)}},$scope.getNodeMessages=function(component,checkType){var _msg="";return component&&component.componentId&&$.each(_objList,function(k,obj){if(obj._id===component.componentId){if(checkType&&obj.message&&obj.message[0]&&"uxmap"===obj.message[0].type)_msg="Custom Javascript";else if(obj.message)try{_msg=decodeURIComponent(obj.message[0]&&obj.message[0].text)}catch(e){_msg=obj.message[0]&&obj.message[0].text||""}return!1}}),_msg},$scope.getNodeName=function(nodeId){return $scope.objList[nodeId]?$scope.objList[nodeId].name:nodeId},$scope.selectCurrentNode=function(uId,type,node,event){if($timeout(function(){$scope.propertyCb.startPropertyPanelAnimate(type)},500),_flowTaskPropertyPanel.css("width",Math.floor(.6*_flowTaskConnectionBlock.width())),_flowTaskPropertyPanel.removeClass("minimized"),$scope.isExpanded=!0,$scope.isMinimized=!1,event){var _ele=event.currentTarget;$(".row").removeClass("componentSelectedBorder"),_ele.className=_ele.className+" componentSelectedBorder"}node||(node=$scope.selectedNode.nodeInfo);var _refId="";$scope.selectedNode="",$timeout(function(){$scope.$apply()},50);var _sendObj={openSection:type,nodeInfo:{},dialogNodeInstance:{},dialogInfo:{dialogId:"",dummyConnCount:"",currentEntities:[],currentIntents:[],firstNodeId:$scope.firstNodeUId,firstNodeComponentId:$scope.firstNodeComponentId},displayMode:"VIEW"===$scope.modeOfAccess?"view":"edit"};_sendObj.nodeDataObj=node,_sendObj.dialogInfo.dialogId=node.dialogId?node.dialogId:node.flowtasksInvolvedIds[0],$.each($scope.objList,function(k,obj){var _tempNodeId=uId;obj.componentId===_tempNodeId?(obj.isSelected=!0,_sendObj.dialogNodeInstance=JSON.parse(JSON.stringify(obj)),_refId=obj.componentId,_previousPropertyPanelUid=uId):obj.isSelected=!1}),$.each(_objList,function(k,obj){obj._id===_refId&&(_sendObj.nodeInfo=obj,"intent"===obj.type&&($scope.utterences=[],getUtterances(_sendObj.nodeDataObj._id))),"entity"===obj.type&&_sendObj.dialogInfo.currentEntities.push({name:obj.name,compId:obj._id,uId:obj.nodeId,unitType:obj.unitType,defaultUnit:obj.defaultUnit}),"intent"===obj.type&&_sendObj.dialogInfo.currentIntents.push({name:obj.name,compId:obj._id,uId:obj.nodeId})}),$scope.isPropertyPanelOpened=!0,"intent"===node.type&&(_sendObj.dialogInfo.currentIntents.push({name:node.name,compId:node._id,uId:node._id}),_sendObj.dialogInfo.firstNodeId=_sendObj.dialogNodeInstance.uId),$.isEmptyObject(_sendObj.nodeInfo)&&(_sendObj.nodeInfo=node,_sendObj.dialogNodeInstance=JSON.parse(JSON.stringify(node))),$timeout(function(){$scope.selectedNode=_sendObj,$timeout(function(){angular.element($window).trigger("resize")},350)},200),$.each($scope.flowTasks,function(k,task){task._id===node.dialogId&&(_dialogObj=task)})},$scope.propertyCb={},$scope.getTraitsGroupsApi=function(){BTStreamsService.getTraitGroups($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$scope.traitGroups=angular.copy(res.data),$scope.propertyCb.allTraits=[];var alltraitsArr=[];$.each($scope.traitGroups,function(i,traits){$.each(traits.traits,function(j,trait){({groupId:traits._id,traitId:trait.traitId||j,traitName:trait.traitName});alltraitsArr.push(trait.traitName)})}),$scope.propertyCb.allTraits=_.uniq(alltraitsArr)},function(err){$scope.loadingTraits=!1,NotificationService.notify(i18n.i18nString("failed_traits"),"error")})},$scope.getTraitsGroupsApi(),$scope.propertyCb.closePropertyPanel=function(){$scope.isPropertyPanelOpened=!1,$element.find(".flowTaskPropertyPanel").css("width",""),$scope.selectedNode="",$(".row").removeClass("componentSelectedBorder")},$scope.dialogData=function(type,data){var _uId=$scope.selectedNode.dialogNodeInstance.uId,_componentId=$scope.selectedNode.dialogNodeInstance.componentId;if("updateDialog"===type){if(data&&data._id===_dialogObj._id){_dialogObj=data,$.each($scope.flowTasks,function(k,task){data._id===task._id&&(task=data)}),BTFlowtaskService.getComponents($scope.stream._id).then(function(res){$scope._botComponents=[],res&&res.data&&res.data.length>0&&($.each(res.data,function(k,comp){comp.status===$scope.selectedBotState&&$scope._botComponents.push(comp)}),updateDialogEntities())},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("err_while_updating_components"),"error")});var _tempConnObj={},_tempDefaultConnection={};$.each(data.nodes,function(k,node){if(_uId===node.nodeId){if($.each(node.transitions,function(k,transition){var _connection=$.extend(!0,{},_connObj);transition&&transition.metadata&&transition.metadata.connId?_connection.connId=transition.metadata.connId:(dummyConnectionCount++,_connection.connId="dummy"+dummyConnectionCount),_connection.sourceId=node.nodeId,void 0===transition["if"]&&(transition["if"]={}),_connection.ifConditionPrefix=void 0!==transition["if"].dialogAct?"dialogAct":void 0!==transition["if"].intent?"intent":void 0!==transition["if"].field?"field":"context",void 0===transition["default"]?(_connection.isDefault=!1,_connection.targetId=transition.then,"dialogAct"===_connection.ifConditionPrefix?(_connection.ifCondition=transition["if"].dialogAct||"yes",_connection.ifOperator="",_connection.value=""):"intent"===_connection.ifConditionPrefix?(_connection.ifCondition=transition["if"].intent||"",_connection.ifOperator="",_connection.value=""):"field"===_connection.ifConditionPrefix?(_connection.ifCondition=transition["if"].field,_connection.ifOperator=transition["if"].op||"",_connection.value=transition["if"].value||""):(_connection.ifCondition=transition["if"].context||"",_connection.ifOperator=transition["if"].op||"",_connection.value=transition["if"].value||"")):(_connection.targetId=transition["default"],_connection.isDefault=!0,delete transition["if"]),transition.metadata&&(_connection.color=transition.metadata.color||_connection.color),_connection.isDefault?(_tempDefaultConnection[_connection.connId]=_connection,_tempDefaultConnection[_connection.connId].connObjNumber=k+1):(_tempConnObj[_connection.connId]=_connection,
_tempConnObj[_connection.connId].connObjNumber=k+1)}),$scope.objList[_componentId]&&($scope.objList[_componentId].nodeOptions=node.nodeOptions,"intent"===$scope.objList[_componentId].type))if(node.contextMap&&node.contextMap.constructor===String)try{$scope.objList[_componentId].contextMap=JSON.parse(node.contextMap)}catch(e){$scope.objList[_componentId].contextMap={}}else $scope.objList[_componentId].contextMap=node.contextMap||{};return!1}}),Object.keys(_tempDefaultConnection).length>0&&(_tempConnObj=$.extend(!0,{},_tempConnObj,_tempDefaultConnection));for(var ke=0;ke<_objConnection.length;ke++)_objConnection[ke].sourceId!==_uId||_tempConnObj[_objConnection[ke].connId]||(_objConnection.splice(ke,1),ke--);$scope.objList[_componentId].connections={},$scope.objList[_componentId].tempConnections={},$.each(_tempConnObj,function(k,tempConn){var _isFound=!1;if($.each(_objConnection,function(l,connection){if(k===connection.connId){_isFound=!0;var _source=$element.find('.dragEleConn[data-id="'+tempConn.sourceId+'"]'),_target=$element.find('.dragEleConn[data-id="'+tempConn.targetId+'"]');return _source.length>0&&_target.length>0?(_source.connections({to:'.draggableEle [data-id="'+tempConn.targetId+'"]',"class":"line source-"+tempConn.sourceId+" target-"+tempConn.targetId,within:$element.find(".flowTaskConnectionBlock")[0],lineColor:tempConn.color,connectionNum:tempConn.connObjNumber}),$scope.objList[_componentId].connections[connection.connId]=tempConn,_objConnection[l]=tempConn,$scope.objList[_componentId].tempConnections&&$scope.objList[_componentId].tempConnections[connection.connId]&&delete $scope.objList[_componentId].tempConnections[connection.connId]):($scope.objList[_componentId].connections[connection.connId]=tempConn,$scope.objList[_componentId].tempConnections[connection.connId]=tempConn),!1}}),!_isFound){var _source=$element.find('.dragEleConn[data-id="'+tempConn.sourceId+'"]'),_target=$element.find('.dragEleConn[data-id="'+tempConn.targetId+'"]');_source.length>0&&_target.length>0?(_source.connections({to:'.draggableEle [data-id="'+tempConn.targetId+'"]',"class":"line source-"+tempConn.sourceId+" target-"+tempConn.targetId,within:$element.find(".flowTaskConnectionBlock")[0],lineColor:tempConn.color,connectionNum:tempConn.connObjNumber}),$scope.objList[_componentId].connections[tempConn.connId]=tempConn,_objConnection.push(_tempConnObj),$scope.objList[_componentId].tempConnections&&$scope.objList[_componentId].tempConnections[tempConn.connId]&&delete $scope.objList[_componentId].tempConnections[tempConn.connId]):($scope.objList[_componentId].connections[tempConn.connId]=tempConn,$scope.objList[_componentId].tempConnections[tempConn.connId]=tempConn)}})}}else"updateComponent"===type&&($.each($scope._botComponents,function(k,obj){return obj._id===data._id?(data.message&&data.message.length&&!data.message[0].text&&(data.message=$scope._botComponents[k].message),data.errorMessage&&data.errorMessage.length&&!data.errorMessage[0].text&&(data.errorMessage=$scope._botComponents[k].errorMessage),$scope._botComponents[k]=data,!1):void 0}),updateDialogEntities(),$.each($scope._nodes,function(k,obj){if(obj._id===data._id){var _flowTasksInvolved=$scope._nodes[k].flowtasksInvolved,flowtasksInvolvedIds=$scope._nodes[k].flowtasksInvolvedIds;return data.message&&data.message.length&&!data.message[0].text&&(data.message=$scope._nodes[k].message),data.errorMessage&&data.errorMessage.length&&!data.errorMessage[0].text&&(data.errorMessage=$scope._nodes[k].errorMessage),$scope._nodes[k]=data,$scope._nodes[k].flowtasksInvolved=_flowTasksInvolved,$scope._nodes[k].flowtasksInvolvedIds=flowtasksInvolvedIds,!1}}),$.each(_objList,function(k,obj){obj._id===data._id&&(data.message&&data.message.length&&!data.message[0].text&&(data.message=_objList[k].message),data.errorMessage&&data.errorMessage.length&&!data.errorMessage[0].text&&(data.errorMessage=_objList[k].errorMessage),_objList[k].nodeId&&(data.nodeId=_objList[k].nodeId),_objList[k]=data)}),$.each($scope.objList,function(k,obj){obj.componentId===data._id&&(obj.name=data.name,"intent"===data.type&&(obj.intent=data.intent))}))},$scope.deleteComponent=function(node,event){return event.preventDefault(),event.stopPropagation(),node.flowtasksInvolved.length>1||node.flowtasksInvolved.length>0||node.parentId?void NotificationService.confirmDialog(i18n.i18nString("manage_components_confirmDialog_delete_component",{nodeType:node.type},{nodeName:node.name}),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0}):void window.bootbox.dialog({message:i18n.i18nString("delete_selected_node"),title:i18n.i18nString("cannot_delete_title"),className:"alert-modal",buttons:{success:{label:i18n.i18nString("cancel"),className:"closeCancel",callback:function(){}},main:{label:i18n.i18nString("ok_uppercase"),className:"",callback:function(){$scope.propertyCb.closePropertyPanel();var _ele=event.currentTarget;_ele.className=_ele.className+" componentSelectedSpin",$(".componentSelectedSpin").removeClass("fa-trash-o"),$(".componentSelectedSpin").addClass("fa-spin fa-refresh"),BTFlowtaskService.deleteComponent($scope.stream._id,node._id).then(function(res){$(".row").removeClass("componentSelectedBorder"),$(".componentSelectedSpin").removeClass("fa-spin fa-refresh"),$(".componentSelectedSpin").addClass("fa-check"),$scope.componentsCount[node.type.toLowerCase()]=$scope.componentsCount[node.type.toLowerCase()]-1,0===$scope.componentsCount[node.type.toLowerCase()]&&$scope.showType(0),$.each($scope._botComponents,function(k,obj){return obj._id===node._id?($scope._botComponents.splice(k,1),!1):void 0}),updateDialogEntities(),$.each($scope._nodes,function(k,obj){return obj._id===node._id?($scope._nodes.splice(k,1),!1):void 0}),$.each(_objList,function(k,obj){return obj._id===node._id?(_objList.splice(k,1),!1):void 0}),NotificationService.notify(i18n.i18nString("node_deleted_sucess",{dyn:node.name}),"success")},function(error){if($(".componentSelectedSpin").removeClass("fa-spin fa-refresh"),$(".componentSelectedSpin").addClass("fa-times"),$timeout(function(){$(".componentSelectedSpin").removeClass("fa-times"),_ele.className="fa deleteNode fa-trash-o"},350),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}}})},$scope.getNodeTypeName=function(nodeType,flowTaskId){return"intent"===nodeType&&flowTaskId&&(nodeType="subDialog"),$scope.configurableElements[nodeType]?$scope.configurableElements[nodeType].name:""},$scope.onNodeClicked=function($event,_type){var _isDialog=!1;if("subDialog"===_type&&(_type="intent",_isDialog=!0),$($event.currentTarget).hasClass("eleType")){if($event.stopPropagation(),$scope.nodeObjList=[],$scope.nodeObjListLoading=!0,$($event.currentTarget).siblings().find(".open").removeClass("open"),"intent"===_type){var _prevNodeType=($($event.currentTarget).parents(".dummyConnections").siblings(".dragEleConn").data("type")||"").trim().toLowerCase();if("sdkwebhook"===_prevNodeType||"agenttransfer"===_prevNodeType)return void NotificationService.notify(i18n.i18nString("sdk_webhook"),"warning")}$($event.currentTarget).find(".dropdown").addClass("open"),"error"===_botComponents?BTFlowtaskService.getComponents(_selectedStream._id).then(function(res){_botComponents=res&&res.data,updateDialogEntities(),$scope.onNodeClicked($event)},function(error){_botComponents="error"}):($.each(_botComponents,function(k,component){component&&component.type===_type&&("intent"===_type&&_isDialog?component.dialogId&&$scope.nodeObjList.push(component):$scope.nodeObjList.push(component))}),$scope.nodeObjListLoading=!1);var _heightDiff=$($event.currentTarget).offset().top+230-parseInt($(".flowTaskConnectionBlock").height()),_widthDiff=$($event.currentTarget).offset().left+400-parseInt($(".flowTaskConnectionBlock").width());_widthDiff>0&&$timeout(function(){$(".flowTaskConnectionBlock").scrollLeft(_widthDiff+parseInt($(".flowTaskConnectionBlock").scrollLeft()))},500),_heightDiff>0&&$timeout(function(){$(".flowTaskConnectionBlock").scrollTop(_heightDiff+parseInt($(".flowTaskConnectionBlock").scrollTop()))},500)}},$scope.onRemove=function(typeID){return typeID===$scope.firstNodeUId?void NotificationService.notify(i18n.i18nString("first_node"),"error"):void window.bootbox.dialog({message:i18n.i18nString("delete_selected_node"),title:i18n.i18nString("cannot_delete_title"),className:"alert-modal",buttons:{success:{label:i18n.i18nString("cancel"),className:"closeCancel",callback:function(){}},main:{label:i18n.i18nString("ok_uppercase"),className:"",callback:function(){$scope.propertyCb.closePropertyPanel();var _params={name:_dialogObj.name,nodes:[],displayOption:_dialogObj.displayOption,visibility:_dialogObj.visibility},_isIntent=$scope.objList[typeID]&&"intent"===$scope.objList[typeID].type?!0:!1;_dialogObj.nodes&&_dialogObj.nodes.length>0&&$.each(_dialogObj.nodes,function(k,node){if(node.nodeId!==typeID){var _nodeObj=node;delete _nodeObj._id,node.transitions&&node.transitions.length>0&&$.each(node.transitions,function(k,transition){transition.then===typeID?(node.transitions[k].then="",_isIntent&&(node.transitions[k]["if"]={intent:""})):transition["default"]===typeID&&(node.transitions[k]["default"]=""),void 0!==transition["default"]&&transition["if"]&&delete node.transitions[k]["if"]}),_params.nodes.push(_nodeObj)}delete node.message}),BTFlowtaskService.updateFlowtask(_selectedStream._id,_dialogObj._id,_params).then(function(res){_dialogObj=res&&res.data;for(var i=0;i<_objList.length;i++)if(_objList[i]._id===$scope.objList[typeID].componentId){_objList.splice(i,1),i--;break}for(var j=0;j<_objConnection.length;j++)!_objConnection[j]||_objConnection[j].targetId!==typeID&&_objConnection[j].sourceId!==typeID||(_objConnection.splice(j,1),j--);delete $scope.objList[typeID],$scope.objListSearch=[],$.each($scope.objList,function(k,obj){$scope.objListSearch.push({key:obj.uId,val:obj.name}),obj.connections&&Object.keys(obj.connections).length>0&&($.each(obj.connections,function(k,conn){conn&&conn.targetId===typeID?(conn.targetId="",_isIntent&&(conn.ifCondition=""),obj.tempConnections={},$.each(obj.connections,function(k,conn){""===conn.targetId&&(obj.tempConnections[k]=conn)})):conn&&conn["default"]===typeID&&(conn["default"]="",obj.tempConnections[k]=conn)}),rearrangeConnectionsForObj(obj.uId))}),$timeout(function(){$scope.$apply(),updateEntityRegExWarnings(),updateEntityQuantityErrors(),updateEntityLOIEnumeratorErrors(),updateEntityLOILookupErrors(),updateServiceSampleResWarnings(),updateServiceReqDefWarnings(),updateScriptDefWarnings()})},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}}}})},$scope.onConfigure=function(typeID,type){$scope.selectCurrentNode(typeID,type)},$scope.exportDialog=function(){BTFlowtaskService.exportDialog(_selectedStream._id,$scope.flowtaskObj._id).then(function(res){writeAndDownloadDialog(res.data.name+".json",JSON.stringify(res.data))})},$scope.readDialog=function(){if($scope.importedDialogName=$scope.importDialog.name,$scope.importedDialogName){var _ext=$scope.importedDialogName.substring($scope.importedDialogName.lastIndexOf("."));if(".json"!==_ext)return NotificationService.notify(i18n.i18nString("upload_json"),"error"),void($scope.fileExtensionError=!0);$scope.fileExtensionError=!1,$scope.dialogRequiredError=!1}var reader=new FileReader;reader.readAsText($scope.importDialog),reader.onload=function(e){var data=reader.result;$scope.importedDialogData=data},angular.element("#importFile").val("")},$scope.confirmImport=function(){return $scope.importedDialogData?($scope.isWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("importing"),void BTFlowtaskService.importDialog(_selectedStream._id,$scope.flowtaskObj._id,$scope.importedDialogData).then(function(res){$scope.doneImporting=!0,$workflowService.flowtaskInfo(res.data),$scope.flowtaskObj=res.data,$scope.importModalTitle=i18n.i18nString("bt_streams_successful"),$scope.connections=getConnections(res.data.nodes),$scope.importDialogHeader=i18n.i18nString("dialog_backup_success"),intialize(),$scope.importResults=i18n.i18nString("manage_components_importResults",{nodesLength:$scope.flowtaskObj.nodes.length},{connectionsLength:$scope.connections.length}),$scope.isWorkProgress=!1,$scope.loaderMessage=i18n.i18nString("working_on_it"),$scope.displayMode="edit"},function(error){$scope.doneImporting=!0;var _msg=error.data.errors[0].msg;$scope.importDialogHeader=i18n.i18nString("dialog_backup_failure"),$scope.importResults=_msg,$scope.isWorkProgress=!1,$scope.loaderMessage=i18n.i18nString("working_on_it"),$scope.importModalTitle=i18n.i18nString("failed_label"),NotificationService.notify(_msg,"error")})):($scope.dialogRequiredError=!0,void NotificationService.notify(i18n.i18nString("dialog_file_req"),"error"))},$scope.finishImporting=function(){$scope.doneImporting=!1,$scope.importedDialogName=void 0,$scope.importedDialogData=void 0,$scope.importDialog=void 0,$scope.importDialogHeader=i18n.i18nString("import_dialog_desc"),$scope.importModalTitle=i18n.i18nString("bt_streams_a_dialog"),$scope.fileExtensionError=!1,$("#flowtask_import").modal("hide")},$scope.onFinishSetup=function(type){BTFlowtaskService.finishFlowtask(_selectedStream._id,_dialogObj._id).then(function(res){NotificationService.notify(i18n.i18nString("dialog_configured"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.configure=function(val){},$scope.validateTaskName=function(){var regexp=/^[a-zA-Z0-9][a-zA-Z0-9_<>* ]+$/,regexp2=/^[a-zA-Z0-9]/;return{test:function(value){return value&&1===value.length?regexp2.test(value):regexp.test(value)}}}(),$scope.updateServiceNodeType=function(value){"custom"!==value?$element.find(".serviceNodeSubType").attr("disabled","disabled"):$element.find(".serviceNodeSubType").removeAttr("disabled"),$scope.nodeObj.serviceType="",$scope.checkCreateNodeFormDirty()},$scope.onImportClicked=function(){NotificationService.notify(i18n.i18nString("onimport_click"),"warning")},$scope.onExportClicked=function(){NotificationService.notify(i18n.i18nString("onimport_click"),"warning")},$scope.toggleSize=function(e){$scope.isExpanded?_flowTaskPropertyPanel.css("width",Math.floor(500)):_flowTaskPropertyPanel.css("width",Math.floor(.6*_flowTaskConnectionBlock.width())),$scope.isExpanded=!$scope.isExpanded},$scope.toggleMinMax=function(e){$scope.isMinimized?_flowTaskPropertyPanel.removeClass("minimized"):_flowTaskPropertyPanel.addClass("minimized"),$scope.isMinimized=!$scope.isMinimized},angular.element($window).on("resize",function(e){$.isWindow(e.target)&&$scope&&$scope.isPropertyPanelOpened&&setPropertyPanelWidth()}),$scope.validateJs=function(){var code="var a = 2; \n\n var b = 3; \n\n console.log(a); \n\n console.log(r)";jsValidator.getError(code).then(function(res){console.log(res)},function(err){console.log("from factoryy..",err)})},$scope.showType(0),angular.element($window).on("resize",function(e){if($scope&&$scope.isPropertyPanelOpened){var _height=$(".wf-form-manageComponents .standard-response-header").height();$element.find(".flowTaskPropertyPanel").css("top","5px").css("height",_height-20+"px");var _innerPanelHeight=_height-79;$element.find(".flowTaskPropertyPanel .panel-body").length>0&&(_innerPanelHeight-=30*$element.find(".flowTaskPropertyPanel .panel-body").length),$element.find(".flowTaskPropertyPanel .panel-body").css("height",_innerPanelHeight+"px"),$scope.selectedNode.nodeInfo&&$scope.selectedNode.nodeInfo.parentId&&$element.find(".flowTaskPropertyPanel .panel-body").css("height",_innerPanelHeight-45+"px")}})}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btProcessApps",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-process-apps/bt-process-apps.html",controller:"btProcessAppsController"}}),_module.controller("btProcessAppsController",["$scope","$window","$workflowService","$element","$location","jsEvents","$sce",function($scope,$window,$workflowService,$element,$location,jsEvents,$sce){$scope.processFlowsURL=window.appConfig.API_SERVER_URL+"/builderx/process/home";var iframe=$("#processFlowsFrame");iframe.on("load",function(){iframe.contents().click(function(event){});var processStoreOptions=$workflowService.toInstallProcessApp();processStoreOptions&&processStoreOptions.processId&&jsEvents.postMessageToChildIframes("processStore","#processFlowsFrame",{resourceId:processStoreOptions.processId})})}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.filter("removeArrayPath",function(){return function(key,optional1,optional2){var _arrayPath,_arrayStartIndex=key.indexOf("[");return _arrayStartIndex>-1&&(_arrayPath=key.substring(_arrayStartIndex,key.length),key=key.substring(0,_arrayStartIndex)),key}}),_module.controller("BTRequestCtrl",["$scope","$rootScope","$translator","$modalInstance","$workflowService","BTStreamsService","config","BTFlowtaskService","urlutil","NotificationService","BTIdpService","$applicationService","$timeout","env_conf","i18n",function($scope,$rootScope,$translator,$modalInstance,$workflowService,BTStreamsService,config,BTFlowtaskService,urlutil,NotificationService,BTIdpService,$applicationService,$timeout,env_conf,i18n){function init(){if($scope.stream=$workflowService.selectedStream(),$scope.task=$workflowService.taskEditInfo(),$scope.component=config.component.nodeInfo,$scope.backArrow=env_conf["context-url"]+"/assets/icons/backArrow.svg",$scope.backArrowGreen=env_conf["context-url"]+"/assets/icons/caretRightGreen.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.testArrowIcon=env_conf["context-url"]+"/assets/icons/testArrowIcon.svg",$scope.helpIcon=env_conf["context-url"]+"/assets/icons/helpIcon.svg",$scope.saveInProgress=!1,$scope.testInProgress=!1,$scope.resSaveInProgress=!1,$scope.advOpt=!1,$scope.sampleResCB={},$scope.rawParamsCB={},$scope.modalSlider={},$scope.rightClass="right700",$scope.displayMode=config.component.displayMode,$scope.rawParamsCB.displayMode=config.component.displayMode,$scope.saving=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.testing=i18n.i18nString("testing_label"),$scope.test=i18n.i18nString("test_label"),$scope.request=i18n.i18nString("request"),$scope.post=i18n.i18nString("post_label"),$scope.sample_res=i18n.i18nString("sample_res"),$scope.sections={auth:!1,headers:!1,params:!1,curl:!1,testReq:!1},$scope.paramTypeMap={urlencoded:"application/x-www-form-urlencoded",raw:"application/json",xml:"application/xml",custom:""},$scope.contentTypeUIMap={urlencoded:"application/x-www-form-urlencoded",raw:"application/json",xml:"application/xml",custom:"Custom"},$scope.options={aceMode:"ace/mode/javascript",mode:"view"===$scope.displayMode?"tree":"code",ace:window.ace},$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.props={headers:[],params:[],rawParams:[],endPoint:{}},$scope.authCB=config.authCB,$scope.btTestFormApi=config.btTestFormApi,$scope.btTestStatus=config.btTestStatus,$scope.idpConfig={},$scope.piiDataEnabled={status:""},$scope.props.headers=processUIHeaders($scope.component.headers||[]),$scope.props.headers.push({key:"",value:""}),$scope.props.params=processUIHeaders($scope.component.payload||[]),$scope.props.params.push({key:"",value:""}),$workflowService.selectedStream().sbStreamId&&($scope.isChildBot=!0),$scope.props.rawParams=deProcessUIHeaders($scope.props.params),$scope.props.endPoint.requestUrl=processUIEndPoint($scope.component.endPoint),$scope.props.endPoint.connectorEnabled=$scope.component.endPoint&&$scope.component.endPoint.connectorEnabled||!1,$scope.props.endPoint.method=$scope.component.endPoint&&$scope.component.endPoint.method.toLowerCase()||"get",$scope.props.sampleResponse={},$scope.sampleResponseIndex=0,$scope.component.sampleResponse)for(var i=0;i<$scope.component.sampleResponse.length;i++)if($scope.component.sampleResponse[i].isDefault){if($scope.sampleResponseIndex=i,$scope.props.sampleResponse=$scope.component.sampleResponse[i].response,"string"==typeof $scope.props.sampleResponse)try{$scope.props.sampleResponse=JSON.parse($scope.props.sampleResponse)}catch(e){$scope.props.sampleResponse={}}break}$scope.props.paramType="urlencoded",loadParamType(),BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,$scope.stream._id).then(function(res){$scope.getAllVariables=res.data.variables},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("unexpected_error_while_fetching_bot_variables"),"error")}),BTFlowtaskService.getComponents($scope.stream._id,$scope.component._id).then(function(res){$scope.piiDataEnabled.status="undefined"==typeof res.data.endPoint||"undefined"==typeof res.data.endPoint.piiDataEnabled?!1:res.data.endPoint.piiDataEnabled},function(error){console.log("error",error)}),$timeout(function(){$scope.props.rawParams=$scope.component.payload&&$scope.component.payload.value?decodeURIComponent($scope.component.payload.value):""},200)}function loadParamType(){var h_index=_.findIndex($scope.props.headers,function(header){return"Content-Type"===header.key});if(-1!==h_index){var _formats=Object.keys($scope.contentTypeUIMap).map(function(key){return $scope.contentTypeUIMap[key]}),_selectedFormatIndex=_formats.indexOf($scope.props.headers[h_index].value);if(-1!==_selectedFormatIndex){var _cntTypeKeys=Object.keys($scope.contentTypeUIMap),_cntTypeIndex=_.findIndex(_cntTypeKeys,function(format){return format===_cntTypeKeys[_selectedFormatIndex]});-1!==_cntTypeIndex?$scope.props.paramType=_cntTypeKeys[_cntTypeIndex]:$scope.props.paramType="custom"}else $scope.props.paramType="custom"}else $scope.props.paramType="custom"}function bindEvents(){$modalInstance.opened.then(function(){$timeout(function(){$(".bt-request-modal").modal({show:!0,backdrop:"static"})},300)}),$scope.authCB.onModalShow=function(){$(".bt-request-modal").addClass("modalSmall")},$scope.authCB.onModalClose=function(){$(".bt-request-modal").removeClass("modalSmall"),$timeout(function(){$("body").addClass("modal-open")},700)},$scope.authCB.onCreateIDP=function(idpData){$scope.authLists.push({_id:idpData._id,name:idpData.name,sso_type:idpData.sso_type}),$scope.newAuth.selected=$scope.authLists.filter(function(authItem){return authItem.name===idpData.name})[0]},$scope.sampleResCB.onBlur=function(editor){var _value=editor.getText();""===_value&&($scope.props.sampleResponse={})},$scope.rawParamsCB.onBlur=function(editor){$scope.invalidPayload=!1;var _value=editor.getText();""===_value?$scope.props.rawParams="":($scope.props.rawParams=_value,editor.aceEditor.getSession().getAnnotations().length&&($scope.invalidPayload=!0))}}function initAuthData(){$scope.newAuth={},$scope.createNewIDP=function(){$scope.authCB.createNewIDP()},$scope.$watch("newAuth.selected",function(newValue,oldValue){(null===newValue||""===newValue)&&($scope.createNewIDP(),$scope.newAuth.selected=oldValue)}),BTIdpService.getIdpList($workflowService.selectedStream()._id).then(function(res){$scope.authLists=res.data,$scope.authLists.push({_id:"none",name:"none",sso_type:"none"}),$scope.newAuth.selected=$scope.authLists.filter(function(authItem){return authItem.name===($scope.component.idp||"none")})[0]},function(res){NotificationService.notify(i18n.i18nString("notify_idp"),"error")})}function processUIEndPoint(endPoint){if(!endPoint)return"";var _url=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol});return _url}function deProcessUIEndPoint(url,method){var uriParser=window.URI,components=uriParser.parse(url),endPoint={host:components.host,port:components.port?components.port+"":"",path:components.path,protocol:components.scheme,method:method};return endPoint.path+=components.query?"?"+components.query:"",endPoint.path+=components.fragment?"#"+components.fragment:"",endPoint}function objToArray(_obj){if(!_obj)return[];if("string"==typeof _obj)try{_obj=JSON.parse(_obj)}catch(e){return[]}var _arr=[];Object.keys(_obj).length&&Object.keys(_obj).forEach(function(key){_arr.push({key:key,value:_obj[key]})});return _arr}function processUIHeaders(headers){var _headers=[],headerObj={};try{headerObj=JSON.parse(headers.value)}catch(e){headerObj={}}Object.keys(headerObj).length&&Object.keys(headerObj).forEach(function(key){_headers.push({key:key,value:headerObj[key]})});return _headers}function deProcessUIHeaders(headers){var headerObj={};headers&&headers.length&&headers.forEach(function(header){header.key&&header.value&&(headerObj[header.key]=header.value)});return headerObj}function getTemplateTokens(str){if(str&&"string"==typeof str){var matchArr=str.match(/{{\s*[\w\.\[\]]+\s*}}/g);return matchArr&&matchArr.length?matchArr.map(function(x){return x.match(/[\w\.\[\]]+/)[0]}):[]}return[]}function arrayToKeyValueArray(_arr){var contextArr=[];_arr.forEach(function(key){contextArr.push({key:key,value:""})});return contextArr}function addToArray(data,array){return data&&data.length&&array.push.apply(array,data),array}function getContextParams(){var _params=[],rawStr=($scope.props.headers.length&&$scope.props.headers.forEach(function(header){header&&header.value&&addToArray(getTemplateTokens(header.value),_params)}),$scope.props.params.length&&$scope.props.params.forEach(function(header){header&&header.value&&addToArray(getTemplateTokens(header.value),_params)}),JSON.stringify($scope.props.rawParams));return addToArray(getTemplateTokens(rawStr),_params),addToArray(getTemplateTokens($scope.props.endPoint.requestUrl),_params),_params=_.uniq(_params)}function generateObjectByPath(_obj){var _returnObj={};return Object.keys(_obj).forEach(function(key){var _arrayPath,_originalKey,_parsedData,_arrayStartIndex=key.indexOf("[");if(_arrayStartIndex>-1){_arrayPath=key.substring(_arrayStartIndex,key.length),_originalKey=angular.copy(key);try{_parsedData=JSON.parse(_obj[_originalKey])}catch(e){NotificationService.notify(i18n.i18nString("valid_array"),"error")}key=key.substring(0,_arrayStartIndex)}var _tempObj={};key.split(".").reverse().forEach(function(_parsedKey){var _t={};_t[_parsedKey]=Object.keys(_tempObj).length?_tempObj:_arrayStartIndex>-1?_parsedData:_obj[key],_tempObj=_t}),angular.merge(_returnObj,_tempObj)}),_returnObj}function testRequest(){$scope.testInProgress=!0;var _executePayload=deProcessUIHeaders($scope.props.contextParams),_idpName=$scope.newAuth&&$scope.newAuth.selected&&$scope.newAuth.selected.name;_idpName&&"none"!==_idpName.toLowerCase()&&"oauth2_client_credential"!==$scope.newAuth.selected.sso_type&&(_executePayload["context.accountidtouse"]=$scope.accounts[0].streamAccountId),_executePayload=generateObjectByPath(_executePayload),BTFlowtaskService.executeComponent($scope.stream._id,$scope.component._id,_executePayload).then(function(res){$scope.props.sampleResponse=res.data,$scope.statusCode=res.data.statusCode,$scope.testInProgress=!1},function(res){var err=res.data;err&&err.errors&&err.errors[0].msg||i18n.i18nString("some_thing_wrong_label");$scope.statusCode=err.errors[0].code,$scope.testInProgress=!1;var parsedErrObj={};try{parsedErrObj=JSON.parse(err.errors[0].msg)}catch(e){parsedErrObj=err.errors[0].msg||{errors:[{msg:i18n.i18nString("bt_reqst_unkown_msg"),code:"Unknown"}]}}$scope.props.sampleResponse=parsedErrObj})}function saveToServer(_payload,silent,triggerTest){silent||($scope.saveInProgress=!0),BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&(config&&config.cbBridge&&config.cbBridge.onServiceSave&&config.cbBridge.onServiceSave(res.data),silent||$scope.closeModal(),triggerTest&&$scope.checkIdpAndExecuteAPI()),$scope.saveInProgress=!1},function(){$scope.saveInProgress=!1,$scope.testInProgress=!1})}function updateCurl(){}function curlToRequest(curlTxt){curlTxt=$.trim(curlTxt);var reqObj=curl.parse(curlTxt);$scope.props.paramType="raw",$scope.props.rawParams=reqObj.payload,$scope.props.params=objToArray($scope.props.rawParams),$scope.props.headers=objToArray(reqObj.header),$scope.props.endPoint.method=reqObj.method.toLowerCase(),$scope.props.endPoint.requestUrl=reqObj.url}function idpTestListenersRegistration(callTestRequest){$scope.btTestFormApi.afterInit=function(serviceAuth){console.info("idp test afterInit callback is called"),$scope.btTestFormApi.test(serviceAuth)},$scope.btTestFormApi.afterTest=function(){console.info("idp test afterTest callback is called"),console.info($scope.btTestStatus),$timeout(function(){callTestRequest()},2e3)},$scope.btTestFormApi.afterClose=function(){console.info("idp test afterClose callback is called"),$scope.testInProgress=!1},$scope.btTestFormApi.onError=function(){console.error("idp test onError callback is called"),console.log($scope.btTestStatus),$scope.testInProgress=!1},$scope.btTestFormApi.onCancel=function(){console.warn("idp test onCancel callback is called"),console.log($scope.btTestStatus),$scope.testInProgress=!1},$scope.btTestFormApi.onNewAccounts=function(accounts){$scope.accounts=accounts},$scope.btTestFormApi.onAuthTestModalOpen=function(){$(".bt-request-modal").addClass("modalSmall")},$scope.btTestFormApi.onAuthTestModalClose=function(){$(".bt-request-modal").removeClass("modalSmall"),$scope.testInProgress=!1}}$scope.closeModal=function(){$modalInstance.close()},$scope.hasArrayPath=function(key){var _arrayStartIndex=key.indexOf("[");return _arrayStartIndex>-1?!0:!1},$scope.showAdvancedOptions=function(){$scope.modalSlider.open("#requestmodelAdvanced")},$scope.closeRequestModal=function(){$scope.modalSlider.close("#requestmodelAdvanced")},$scope.navigate=function(section){for(var key in $scope.sections)$scope.sections.hasOwnProperty(key)&&($scope.sections[key]=!1);$scope.sections[section]=!0,"testReq"===section&&("urlencoded"===$scope.props.paramType&&($scope.props.rawParams=deProcessUIHeaders($scope.props.params)),$scope.updateContextParams()),"curl"===section&&updateCurl()},$scope.updateContextParams=function(index){$scope.props.contextParams=arrayToKeyValueArray(getContextParams());for(var splittedContextKey=[],i=0;i<$scope.props.contextParams.length;i++)splittedContextKey[i]=$scope.props.contextParams[i].key.split("."),splittedContextKey[i][0]="content"===splittedContextKey[i][0]?"locale":splittedContextKey[i][0];$timeout(function(){for(var i=0;i<splittedContextKey.length;i++){var contextParamVal=$scope.getAllVariables.filter(function(v){return v.variableType===splittedContextKey[i][0]&&v.key===splittedContextKey[i][1]});!contextParamVal[0]||!contextParamVal[0].value||"hidden"===contextParamVal[0].scope&&$scope.isChildBot||($scope.props.contextParams[i].value=contextParamVal[0].value)}},250)},$scope.onHeaderFocus=function(index){$scope.props.headers.length===index+1&&$scope.props.headers.push({key:"",value:""})},$scope.deleteHeader=function(index){$scope.props.headers.splice(index,1)},$scope.onParamFocus=function(index){$scope.props.params.length===index+1&&$scope.props.params.push({key:"",value:""})},$scope.deleteParam=function(index){$scope.props.params.splice(index,1);
},$scope.executeService=function(){$scope.testInProgress=!0,$scope.statusCode="",$scope.saveRequest(!0,!0)},$scope.saveSampleResponse=function(){var _payload={};if($scope.resSaveInProgress=!0,!$scope.component.sampleResponse||!$scope.component.sampleResponse.length){$scope.component.sampleResponse=[];var _obj={};_obj.name="sampleResponse",_obj.isDefault=!0,$scope.component.sampleResponse.push(_obj)}$scope.component.sampleResponse[$scope.sampleResponseIndex].response=JSON.stringify($scope.props.sampleResponse),_payload.sampleResponse=$scope.component.sampleResponse,BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&config&&config.cbBridge&&config.cbBridge.onServiceSave&&config.cbBridge.onServiceSave(res.data),$scope.resSaveInProgress=!1},function(){$scope.resSaveInProgress=!1})},$scope.saveRequest=function(silent,triggerTest){$timeout(function(){var _payload={};_payload.headers={type:"raw",value:JSON.stringify(deProcessUIHeaders($scope.props.headers))},"raw"===$scope.props.paramType||"xml"===$scope.props.paramType||"custom"===$scope.props.paramType?_payload.payload={type:"raw",value:$scope.props.rawParams?encodeURIComponent($scope.props.rawParams):""}:_payload.payload={type:"raw",value:JSON.stringify(deProcessUIHeaders($scope.props.params))},_payload.endPoint=deProcessUIEndPoint($scope.props.endPoint.requestUrl,$scope.props.endPoint.method),_payload.endPoint.connectorEnabled=$scope.props.endPoint.connectorEnabled,_payload.endPoint.piiDataEnabled=$scope.piiDataEnabled.status,_payload.idp=$scope.newAuth.selected&&$scope.newAuth.selected.name||"none",_payload.authRequired="none"===_payload.idp?!1:!0,saveToServer(_payload,silent,triggerTest)},100)},$scope.$watch("props.endPoint.requestUrl",function(newVal,oldVal){$scope.updateContextParams(),updateCurl()}),$scope.$watch("props.endPoint.method",function(newVal,oldVal){updateCurl(),newVal&&"get"===newVal?($scope.disableBody=!0,$scope.props.params=[],$scope.props.rawParams=deProcessUIHeaders($scope.props.params)):$scope.disableBody=!1,$timeout(function(){$(".bt-request-modal .headersTabBtn").click()},200)}),$scope.$watch("props.paramType",function(newVal,oldVal){"raw"===newVal?$scope.props.rawParams=deProcessUIHeaders($scope.props.params):($scope.props.params=objToArray($scope.props.rawParams),$scope.props.params.push({key:"",value:""})),$timeout(function(){"xml"===$scope.props.paramType?$scope.options.aceMode="ace/mode/xml":"custom"===$scope.props.paramType?$scope.options.aceMode="ace/mode/text":$scope.options.aceMode="ace/mode/json"},100)}),$scope.$watch("curlText",function(newVal,oldVal){}),$scope.curlOnBlur=function(){curlToRequest($scope.curlText)},$scope.onParamTypeChange=function(){var index=_.findIndex($scope.props.headers,function(header){return"Content-Type"===header.key});-1!==index&&$scope.deleteHeader(index),$scope.props.headers.unshift({key:"Content-Type",value:$scope.paramTypeMap[$scope.props.paramType]}),"custom"===$scope.props.paramType&&$timeout(function(){$(".bt-request-modal .headersTabBtn").click(),$timeout(function(){$(".bt-request-modal .headers-wrp .headerValue").first().focus()},100)})},$scope.checkIdpAndExecuteAPI=function(account){function callTestRequest(){testRequest()}var _idpName=$scope.newAuth&&$scope.newAuth.selected&&$scope.newAuth.selected.name;_idpName&&"none"!==_idpName.toLowerCase()?BTIdpService.getIdpByName(_idpName,$workflowService.selectedStream()._id).then(function(res){var idpConfig=res.data;if(idpConfig=idpConfig||{},idpConfig.type="idp",idpConfig.testFor="idp",idpTestListenersRegistration(callTestRequest),account)callTestRequest();else{$scope.btTestFormApi.init(idpConfig,"",!0);var data={isFromtestReq:!0};$scope.btTestFormApi.serviceNodeTestInfo(data)}},function(err){NotificationService.notify(i18n.i18nString("failed_fetch_idp"),"error"),$scope.idpConfig={}}):callTestRequest()},function(){init(),initAuthData(),bindEvents()}()}])}(angular),function(ng){var _module=angular.module("bt-resource-versions",[]);_module.directive("versionHistory",[function(){return{restrict:"EA",scope:{activeTask:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-resource-versions/bt-resource-versions.html",controller:"BTResourceVersionsCtrl"}}]),_module.controller("BTResourceVersionsCtrl",["$scope","BTAlertsService","BTActionsService","$routeParams","$location","$workflowService","$filter","$rootScope",function($scope,BTAlertsService,BTActionsService,$routeParams,$location,$workflowService,$filter,$rootScope){$scope.versions=[],$scope.selectedStream=$workflowService.selectedStream();var taskId=$scope.activeTask._id,taskType=$scope.activeTask.taskType;return $scope.selectedStream?($scope.options={mode:"text",ace:window.ace},$scope.context={bot:$scope.selectedStream.name,task:$scope.activeTask.name},"alert"===taskType?(BTAlertsService.getVersions(taskId).then(function(res){$scope.versions=res.data.map(function(version){return version.version=+version.version,version}),$scope.versions=$filter("orderBy")($scope.versions,"+version")},function(err){}),$scope.helpLink=$rootScope.helpLinks.VERSION_ALERT):"action"===taskType?(BTActionsService.getVersions(taskId).then(function(res){$scope.versions=res.data.map(function(version){return version.version=+version.version,version}),$scope.versions=$filter("orderBy")($scope.versions,"+version")},function(err){}),$scope.helpLink=$rootScope.helpLinks.VERSION_ACTION):$location.path(window.appConfig.CONTEXT_PATH),void($scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)})):void $location.path(window.appConfig.CONTEXT_PATH)}])}(angular),function(ng){var _mod=ng.module("bt-resource-view",["app.helpers"]);_mod.controller("BTResourceViewCtrl",["$scope","$rootScope","$routeParams","$location","$applicationService","BTAlertsService","BTActionsService","BTStreamsService","BTFlowtaskService","i18n",function($scope,$rootScope,$routeParams,$location,$applicationService,BTAlertsService,BTActionsService,BTStreamsService,BTFlowtaskService,i18n){function fetchResourceDetails(){var _promise;resourceType===apConstants.RESOURCE_TYPE_ALERT?_promise=BTAlertsService.getBTAlert(resourceId):resourceType===apConstants.RESOURCE_TYPE_ACTION?_promise=BTActionsService.getBTAction(resourceId):resourceType===apConstants.RESOURCE_TYPE_STREAM?_promise=BTStreamsService.getBTStream(resourceId):resourceType===apConstants.RESOURCE_TYPE_FLOWTASK&&(_promise=BTFlowtaskService.getFlowtaks(resourceId)),_promise.then(function(res){if($scope.resourceDetails=res.data,$scope.resourceDetails.createdBy=$scope.resourceDetails.createdBy.firstName+" "+$scope.resourceDetails.createdBy.lastName,resourceType===apConstants.RESOURCE_TYPE_ALERT){if($scope.resourceDetails.alertFieldsRequired){var alertFieldForTable={};alertFieldForTable.headers=[{name:"Name",sortable:!1},{name:"Description",sortable:!1},{name:"FieldType",sortable:!1}],alertFieldForTable.rows=[],$scope.resourceDetails.alertFieldsDefinition.forEach(function(defn){alertFieldForTable.rows.push({Name:defn.title,Description:defn.description,FieldType:defn.fieldType})}),$scope.alertFieldsInfo=alertFieldForTable}var rqInfoForTable={};rqInfoForTable.headers=[{name:"RqPath",sortable:!1},{name:"endpoint",sortable:!1}],rqInfoForTable.rows=[],$scope.resourceDetails.requestChain.forEach(function(defn){rqInfoForTable.rows.push({RqPath:defn.alertsPath,endpoint:defn.endPoint.protocol+"://"+defn.endPoint.host+(defn.endPoint.port?":"+defn.endPoint.port:"")+"/"+defn.endPoint.path})}),$scope.rqInfo=rqInfoForTable}if(resourceType===apConstants.RESOURCE_TYPE_ACTION){var payloadInfoForTable={};payloadInfoForTable.headers=[{name:"Title",sortable:!1},{name:"Key",sortable:!1},{name:"Fieldtype",sortable:!1},{name:"Type",sortable:!1}],payloadInfoForTable.rows=[],$scope.resourceDetails.payloadField.forEach(function(defn){payloadInfoForTable.rows.push({Title:defn.title,Key:defn.key,Fieldtype:defn.fieldType,Type:defn.type})}),$scope.payloadInfo=payloadInfoForTable;var rqActionInfoForTable={};rqActionInfoForTable.headers=[{name:"RqPath",sortable:!1},{name:"endpoint",sortable:!1}],rqActionInfoForTable.rows=[],$scope.resourceDetails.requestChain.forEach(function(defn){rqActionInfoForTable.rows.push({RqPath:defn.alertsPath,endpoint:defn.endPoint.protocol+"://"+defn.endPoint.host+(defn.endPoint.port?":"+defn.endPoint.port:"")+"/"+defn.endPoint.path})}),$scope.rqInfo=rqActionInfoForTable}loadResourceDetails()})}function loadResourceDetails(){$scope.resourceLoading=!1}var resourceType=$routeParams.resourceType,resourceId=$routeParams.resourceId,flowtype=$routeParams.flowtype,apConstants=$applicationService.getAppConstants();$scope._constants_=$rootScope._constants_,$scope.resourceLoading=!0,$scope.resourceType=resourceType,$scope.resourceId=resourceId,$scope.flowtype=flowtype,$scope.resourceDetails={},fetchResourceDetails(),$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onBack=function(wftype){wftype===apConstants.RESOURCE_TYPE_STREAM?$location.path("bt/new"):$location.path("bt/workflows")},$scope.onStreamFormEdit=function(){}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTResponseCtrl",["$scope","$rootScope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","$timeout","i18n",function($scope,$rootScope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,$timeout,i18n){function init(){$modalInstance.opened.then(function(){$timeout(function(){$(".bt-response-modal").modal({show:!0,backdrop:"static"})},300)}),$scope.stream=$workflowService.selectedStream(),$scope.component=config.component.nodeInfo,$scope.displayMode=config.component.displayMode,$scope.formInvalid=!0,$scope.saveInProgress=!1,$scope.advOpt=!1,$scope.soap={},$scope.name="",$scope.isDefault=!1,$scope.sampleResCB={},$scope.sections={auth:!0,headers:!1,params:!1,curl:!1,testReq:!1},$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.props={headers:[],params:[],endPoint:{}},-1===config.index?($scope.soap.sample={},$scope.component.sampleResponse&&$scope.component.sampleResponse.length||($scope.isDefault=!0)):($scope.soap.sample=$scope.component.sampleResponse&&$scope.component.sampleResponse[config.index].response&&$scope.component.sampleResponse[config.index].response||{},"object"!=typeof $scope.soap.sample&&($scope.soap.sample=JSON.parse($scope.soap.sample)),$scope.name=$scope.component.sampleResponse[config.index].name,$scope.isDefault=$scope.component.sampleResponse[config.index].isDefault),$scope.sampleResCB.onBlur=function(editor){var _value=editor.getText();_editorData=_value,""===_value&&($scope.soap.sample={}),$scope.checkFormValid()},$scope.disableDefaultCheck=!$scope.component.sampleResponse||1===$scope.component.sampleResponse.length&&-1!==config.index||!$scope.component.sampleResponse.length?!0:!1,$scope.options={mode:"view"===$scope.displayMode?"tree":"code",ace:window.ace,aceViewMode:"view"===$scope.displayMode?!0:!1}}function saveToServer(_payload){$scope.saveInProgress=!0,BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&(config&&config.cbBridge&&config.cbBridge.onServiceSave&&config.cbBridge.onServiceSave(res.data),$scope.closeModal()),$scope.saveInProgress=!1},function(error){if($scope.component.sampleResponse=_.uniq($scope.component.sampleResponse,function(item,key,a){return item.name}),$scope.saveInProgress=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}var _editorData="";$scope.saving=i18n.i18nString("saving"),$scope.add=i18n.i18nString("add"),$scope.closeModal=function(){$modalInstance.close()},$scope.checkFormValid=function(){return $scope.soap&&!$.isEmptyObject($scope.soap.sample)&&$scope.name&&""!==$scope.name.trim()?!1:!0},$scope.saveResponse=function(){var _payload={},_isCorrectJSON=!0;if(""!==_editorData)try{JSON.parse(_editorData)}catch(e){_isCorrectJSON=!1}if(_isCorrectJSON){if($scope.component.sampleResponse&&$scope.isDefault)for(var i=0;i<$scope.component.sampleResponse.length;i++)$scope.component.sampleResponse[i].isDefault=!1;if(_payload.sampleResponse=$scope.component.sampleResponse?$scope.component.sampleResponse:[],-1===config.index){var _newResponse={};_newResponse.response=JSON.stringify($scope.soap.sample),_newResponse.name=$scope.name.trim(),_newResponse.isDefault=$scope.isDefault,_payload.sampleResponse.push(_newResponse)}else{_payload.sampleResponse[config.index].response=JSON.stringify($scope.soap.sample),_payload.sampleResponse[config.index].name=$scope.name.trim(),_payload.sampleResponse[config.index].isDefault=$scope.isDefault;for(var _defaultAvaialable=!1,j=0;j<_payload.sampleResponse.length;j++)if(_payload.sampleResponse[j].isDefault){_defaultAvaialable=!0;break}_defaultAvaialable||(_payload.sampleResponse[0].isDefault=!0)}saveToServer(_payload)}else NotificationService.notify(i18n.i18nString("please_Correct_errors"))},$scope.checkFormValid(),function(){init()}()}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTSamplecontextCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","NotificationService","i18n",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,NotificationService,i18n){function init(){$scope.stream=$workflowService.selectedStream(),$scope.component=config.component,$scope.saveInProgress=!1,$scope.soap={},$scope.sampleResCB={};try{$scope.soap.sample=JSON.parse($scope.component.dialogComponent&&$scope.component.dialogComponent.previewContext||"{}")}catch(e){$scope.soap.sample={}}$scope.sampleResCB.onBlur=function(editor){var _value=editor.getText();_editorData=_value,""===_value&&($scope.soap.sample={})}}function saveToServer(_payload){$scope.saveInProgress=!0,BTFlowtaskService.updateComponent($scope.stream._id,$scope.component.dialogComponent._id,_payload).then(function(res){res&&res.data&&(config&&config.cbBridge&&config.cbBridge.onServiceSave&&config.cbBridge.onServiceSave(res.data,$scope.soap.sample),$scope.closeModal()),$scope.saveInProgress=!1},function(error){$scope.saveInProgress=!1})}var _editorData="";$scope.saving=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.options={mode:"view"===$scope.displayMode?"tree":"code",ace:window.ace},$scope.closeModal=function(){$modalInstance.close()},$scope.saveContextMap=function(){var _payload={},_isCorrectJSON=!0;if(""!==_editorData)try{JSON.parse(_editorData)}catch(e){_isCorrectJSON=!1}_isCorrectJSON?(_payload.previewContext=JSON.stringify($scope.soap.sample),saveToServer(_payload)):NotificationService.notify(i18n.i18nString("please_Correct_errors"))},function(){init()}()}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTScriptCtrl",["$scope","soap","$rootScope","$translator","$modalInstance","$workflowService","BTStreamsService","config","BTFlowtaskService","urlutil","NotificationService","i18n",function($scope,soap,$rootScope,$translator,$modalInstance,$workflowService,BTStreamsService,config,BTFlowtaskService,urlutil,NotificationService,i18n){function init(){$scope.stream=$workflowService.selectedStream(),$scope.component=config.component.nodeInfo,$scope.readonly=config.component.displayMode&&"view"===config.component.displayMode?!0:!1,$scope.saveInProgress=!1,$scope.scriptObj=config.component.nodeInfo.script&&decodeJS(config.component.nodeInfo.script)||"",$scope.codeCallback={}}function encodeJS(_obj){return encodeURIComponent(_obj)}function decodeJS(_obj){var decodeText="";try{decodeText=decodeURIComponent(_obj)}catch(ex){decodeText=_obj}finally{return decodeText}}function saveToServer(_payload){$scope.saveInProgress=!0,BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&(config&&config.cbBridge&&config.cbBridge.onScriptSave&&config.cbBridge.onScriptSave(res.data),$scope.closeModal()),$scope.saveInProgress=!1},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("save_script_error"),"error");$scope.saveInProgress=!1})}$scope.saving=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.closeModal=function(){$modalInstance.close()},$scope.saveScript=function(){if($scope.invalidScript)return void NotificationService.notify(i18n.i18nString("save_script"),"error");var _payload={};_payload.script=encodeJS($scope.scriptObj),saveToServer(_payload)},function(){init()}(),$scope.codeCallback.onBlur=function(editor){_.filter(editor.getSession().getAnnotations(),{type:"error"}).length?$scope.invalidScript=!0:$scope.invalidScript=!1},$scope.codeCallback.displayMode=config.component.displayMode}])}(angular),function(ng){"use strict";var _module=ng.module("bt-solution-install",[]);_module.directive("btSolutionInstall",function(){return{restrict:"EA",scope:{onCancel:"&",smartBotId:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-solution-install/bt-solution-install.html",controller:"BTSolutionInstall"}}),_module.controller("BTSolutionInstall",["$scope","$workflowService","BTStreamsService","BTFlowtaskService","$location","$endpoints","BTFileUploadService","NotificationService","form_util","$rootScope","env_conf","$applicationService","i18n",function($scope,$workflowService,BTStreamsService,BTFlowtaskService,$location,$endpoints,BTFileUploadService,NotificationService,form_util,$rootScope,env_conf,$applicationService,i18n){function goHome(){$workflowService.navigateTabIndex(".tasks-pane"),$rootScope.$emit("selectOrChangeBot",$scope.stream),$scope.onCancel(),$(".bootbox-close-button").trigger("click")}$scope.char_remaining=i18n.i18nString("char_remaining"),$scope.stream=$workflowService.selectedStream(),$workflowService.currentLanguage($scope.stream.defaultLanguage),$scope.stream.solutionBotSettings&&$scope.stream.solutionBotSettings.configInstFileId?($scope.showPdfLoading=!0,$scope.planeText=!1):$scope.planeText=!0,$scope.backArrow=env_conf["context-url"]+"/assets/settingsIcons/closeCross.png",$scope.sections=[{name:"instructionsForm",active:!1,enabled:!1},{name:"aboutBotForm",active:!1,enabled:!1,formName:"aboutBotForm"}],$("embed").ready(function(){setTimeout(function(){$scope.showPdfLoading=!1,$("embed").removeClass("displayBlock")},1e3)}),$scope.getBotVariables=function(smartbotid){BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,smartbotid).then(function(res){$workflowService.botEnvVariables(res.data.variables);var _botVariables=res.data.variables;if($scope.botVariables=[],$scope.constants=$rootScope._constants_,$.each(_botVariables,function(i,variable){delete variable.createdBy,delete variable.createdOn,delete variable.modifiedBy,delete variable.modifiedOn,delete variable.__v,delete variable._id,delete variable.streamId,"askOnInstall"===variable.scope&&(variable.value=""),"env"===variable.variableType&&$scope.botVariables.push(variable)}),$scope.botVariables&&$scope.botVariables.length){$scope.sections[2]={name:"variablesForm",active:!1,enabled:!1,formName:"variablesForm"},$scope.sections[2].enabled=!1;_.find($scope.botVariables,function(variable){return"prePopulated"===variable.scope||"askOnInstall"===variable.scope?($scope.sections[2].enabled=!0,variable):void 0})}$scope.tempBotVariables=angular.copy($scope.botVariables)},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("unexpected_error_while_fetching_bot_variables"),"error")})},$scope.smartBotId=$scope.smartBotId||$scope.stream.sbStreamId,$scope.getBotVariables($scope.stream._id),$scope.stream.solutionBotSettings?($scope.stream.solutionBotSettings.configInstURL&&$scope.stream.solutionBotSettings.configInstURL.startsWith("www.")&&($scope.stream.solutionBotSettings.configInstURL="http://"+$scope.stream.solutionBotSettings.configInstURL),$scope.sections[0].active=!0,$scope.sections[0].enabled=!0,$scope.sections[1].enabled=!0):($scope.sections[1].enabled=!0,$scope.sections[1].active=!0),$scope.aboutBotData={},$scope.aboutBotData.name=$scope.stream.name,$scope.aboutBotData.color=$scope.stream.color,$scope.aboutBotData.inheritanceType=$scope.stream.inheritanceType||1,$scope.enabledSections=function(){return _.filter($scope.sections,function(section){return section.enabled===!0})},$scope.getActiveSectionIndex=function(){return _.findIndex($scope.sections,function(section){return section.active===!0})},$scope.canShowBack=function(){return $scope.enabledSections().length>0&&$scope.getActiveSectionIndex()>0?!0:!1},$scope.canShowNext=function(){return $scope.enabledSections().length>0&&$scope.getActiveSectionIndex()<$scope.enabledSections().length-1?!0:!1},$scope.canShowFinish=function(){return $scope.getActiveSectionIndex()===$scope.enabledSections().length-1?!0:!1},$scope.validateSection=function(section){return section&&section.formName&&$scope[section.formName]&&$scope[section.formName].$invalid?(form_util.touch($scope[section.formName]),!1):!0},$scope.next=function(){$scope.disableNext=!0;var index=$scope.getActiveSectionIndex(),sectionIndex=index+1;if(2===sectionIndex);sectionIndex<$scope.sections.length&&$scope.navigate($scope.sections[sectionIndex])},$scope.navigate=function(section){$scope.sections.forEach(function(section){section.active=!1}),section.active=!0,$("html, body").animate({scrollTop:0},"fast"),$scope.disableNext=!1},$scope.uploadStreamIcon=function(){if($scope.aboutBotData.iconFile.name){var _ext=$scope.aboutBotData.iconFile.name.substring($scope.aboutBotData.iconFile.name.lastIndexOf("."));if(".png"!==_ext)return NotificationService.notify(i18n.i18nString("uploadfile_noty_error"),"error"),void($scope.fileExtensionError=!0)}$scope.fileExtensionError=!1;var data=new FormData;data.append("file",$scope.aboutBotData.iconFile),data.append("fileContext","marketplace"),data.append("fileExtension","png"),$scope.iconUploading=!0,BTFileUploadService.uploadFile(data).then(function(response){var fileUploaded={fileName:$scope.aboutBotData.iconFile.name,fileId:response.data.fileId};$scope.aboutBotData.icon=fileUploaded,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:fileUploaded.fileName}),"success"),$scope.iconUploading=!1},function(response){NotificationService.notify(i18n.i18nString("oops_label")+response.data.errors[0].msg,"error"),$scope.iconUploading=!1})},$scope.deleteStreamIcon=function(){$scope.aboutBotData.iconFile=null,$scope.aboutBotData.icon=null,$("#sbots_iconFile").val("")},$scope.isFormValid=function(){return!$scope.aboutBotForm.$invalid},$scope.installSolBot=function(){if($scope.validateSection($scope.enabledSections()[$scope.getActiveSectionIndex()])){var _aboutBotSection=_.find($scope.enabledSections(),{formName:"aboutBotForm"});if(!$scope.validateSection(_aboutBotSection))return void $scope.navigate(_aboutBotSection);var installSolBotData={};installSolBotData.name=$scope.aboutBotData.name,installSolBotData.color=$scope.aboutBotData.color,$scope.aboutBotData.iconType||(installSolBotData.icon=$scope.aboutBotData.icon.fileId),$scope.aboutBotData.inheritanceType?installSolBotData.inheritanceType=parseInt($scope.aboutBotData.inheritanceType):installSolBotData.inheritanceType=1,$scope.botInstalling=!0;var variablePayload=$scope.botVariables;BTStreamsService.addbulkBotVariables($applicationService.userInfo().userId,$scope.stream._id,variablePayload).then(function(res){BTStreamsService.editStream($workflowService.selectedStream()._id,installSolBotData).then(function(response){$workflowService.selectedStream(angular.extend($workflowService.selectedStream(),response.data)),BTStreamsService.updateMPStream($workflowService.selectedStream()._id,installSolBotData).then(function(response){NotificationService.notify(i18n.i18nString("bot_installed_success_noty"),"success"),$location.path(window.appConfig.CONTEXT_PATH),BTStreamsService.getStreams().then(function(res){$workflowService.streamsAll(res.data),$scope.$emit("streamUpdate"),goHome()}),$scope.botInstalling=!0},function(res){NotificationService.notify(res.data.errors[0].msg,"error"),$scope.botInstalling=!1})},function(res){NotificationService.notify(res.data.errors[0].msg,"error"),$scope.botInstalling=!1})},function(err){$scope.botInstalling=!1,NotificationService.notify(i18n.i18nString("bot_installation_err"),"error")})}},$scope.goToHome=function(){var message="<p><i class='fa fa-exclamation-circle fa-2x' aria-hidden='true' style='color: #009dac;'></i></p>"+i18n.i18nString("bt_solution_install_config_not_complete");window.bootbox.dialog({message:message,title:i18n.i18nString("bt_solution_install_cancel_install"),className:"alert-modal",buttons:{main:{label:i18n.i18nString("bt_solution_install_setup_later"),className:"btn-primary",callback:goHome},success:{label:i18n.i18nString("bt_solution_install_continue_setup"),className:"btn-primary",callback:function(){}}},onEscape:!0})}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btStore",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-store/bt-store.html",controller:"btStoreController"}}),_module.controller("btStoreController",["$scope","$window","$workflowService","$element","$location","$sce","$translator",function($scope,$window,$workflowService,$element,$location,$sce,$translator){if($scope.stream=$workflowService.selectedStream(),$scope.productSelected=$scope.productSelected||"Conversational-App",$scope.baseUrl=window.appConfig.API_SERVER_URL,window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost:4200"))&&($scope.baseUrl="http://localhost:4201"),$scope.selectedHomeTab&&"bots"===$scope.selectedHomeTab){var authObj=$translator.getAuthObj();authObj.accessToken;$scope.storeUrl=$scope.baseUrl+"/botstore/store?product=Conversational-App#from=botbuilder"}else $scope.welcomeForm&&("Process-App"===$scope.productSelected?$scope.storeUrl=$scope.baseUrl+"/botstore/store?product=Process-App&iFrame=vaOnboarding#from=processApp":$scope.storeUrl=$scope.baseUrl+"/botstore/store?product=Conversational-App&iFrame=vaOnboarding#from=botbuilder");var iframe=$("#storeFrame");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")})}),window.addEventListener("message",function(event){"closeStore"===event.data.action&&($scope.loadingStore=!1,window.scrollTo(0,0),$scope.$emit("updateStore",{loadStore:$scope.loadingStore}))}),$scope.$on("updateStoreIframeSrc",function(){if($scope.selectedHomeTab&&"bots"===$scope.selectedHomeTab){var authObj=$translator.getAuthObj();authObj.accessToken;$scope.storeUrl=window.appConfig.API_SERVER_URL+"/botstore/store?product=Conversational-App#from=botbuilder"}}),$scope.trustSrc=function(url){return $sce.trustAsResourceUrl(url)}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btStoryBoard",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-storyboard/bt-storyboard.html",controller:"btStoryBoardController"}}),_module.controller("btStoryBoardController",["$scope","$window","$workflowService","$element","$location","$sce","$util","BTStreamsService","$applicationService","i18n","mixPanel",function($scope,$window,$workflowService,$element,$location,$sce,$util,BTStreamsService,$applicationService,i18n,mixPanel){function prepareIframeUrlForScene(scene){window.location.href&&(window.location.href.includes("dev.kore")||window.location.href.includes("localhost"))?$scope.storyBoardUrl=$sce.trustAsResourceUrl("http://localhost:4200/builderx/conversation/stories/"+$scope.stream._id+"/"+scene._id+"/storyEdit"):$scope.storyBoardUrl=window.appConfig.API_SERVER_URL+"/builderx/conversation/stories/"+$scope.stream._id+"/"+scene._id+"/storyEdit"}function setForm(){$scope.createSceneObj={name:"",description:"",status:"In Progress"}}$scope.csvContent=null,$scope.importedSceneFile=null,$scope.fileName=null,$scope.userInfo=$applicationService.userInfo(),$scope.fileId=null,$scope.startImporting=!1,$scope.importScene={name:""},$scope.incliudeComments=!1,$scope.previewMode=!1,$scope.resetLinkImg=window.appConfig.CONTEXT_PATH+"/assets/images/resetGreenIcon.svg",$scope.stream=$workflowService.selectedStream(),$scope.openSceneModal=!1,setForm(),$scope.createSceneSlider=function(open,scene,clone){open?(setForm(),scene?clone?$scope.createSceneObj={name:"",description:"",status:"In Progress",_id:scene._id}:$scope.createSceneObj={name:scene.name,description:scene.description,status:scene.description||"In Progress",_id:scene._id}:setForm(),$scope.cloneScene=clone||!1,$scope.createSceneObj.showCreation=!0,$scope.modalSlider.open("#createScene")):($scope.createSceneObj.showCreation=!1,$scope.modalSlider.close("#createScene"))},$scope.botDetailsCb&&($scope.botDetailsCb.createSceneSlider=$scope.createSceneSlider),$scope.openExportSlider=function(scene){$scope.modalSlider.open("#exportStoryScene"),$scope.selectedScene=scene,$scope.shareInfo=scene.shareInfo[0],$scope.interactiveLink=$scope.shareInfo.link,$scope.shareInfo.isSecured=$scope.shareInfo.isSecured||!1},$scope.closeExportSlider=function(){$scope.modalSlider.close("#exportStoryScene")},$scope.botDetailsCb&&($scope.botDetailsCb.openExportSlider=$scope.openExportSlider),$scope.iframeEvent=function(e,data){if(data&&data.action)switch(data.action){case"openDialogTask":data.payload&&$scope.openDialog(data.payload);break;case"previewOpened":$scope.previewOpened(!0);break;case"previewClosed":$scope.previewOpened(!1);break;case"closeStoryConversation":$scope.closeScene()}},$scope.$on("dialogIframeEvent",$scope.iframeEvent),$scope.openDialog=function(data){return $util.isIE11OrEarlier()?($util.showUnSupportedBrowserWarningForDialog(),!1):void $scope.editOrViewWorkflow(data,"dialog")},$scope.previewOpened=function(mode){$scope.previewMode=mode};var iframe=$("#storyBoardFrame");iframe.on("load",function(){iframe.contents().click(function(event){iframe.trigger("click"),$("body").trigger("click")})}),$scope.$emit("nestedComponentLoaded",{id:"storyboard",flag:!1}),$scope.openScene=function(scene){prepareIframeUrlForScene(scene),$scope.openSceneModal=!0,$("#storySceneModal").modal("show")},$scope.botDetailsCb&&($scope.botDetailsCb.openScene=$scope.openScene),$scope.closeScene=function(){$("#storySceneModal").modal("hide"),$scope.openSceneModal=!1,$scope.cloneScene=!1},$scope.proceedCreateScene=function(){var payload={name:$scope.createSceneObj.name,description:$scope.createSceneObj.description,status:$scope.createSceneObj.status||"In Progress"};$scope.cloneScene&&$scope.createSceneObj._id?($scope.cloningInProgress=!0,BTStreamsService.cloneScene($workflowService.selectedStream()._id,$scope.createSceneObj._id,payload).then(function(res){$scope.cloningInProgress=!1,$scope.cloneScene=!1,$scope.callbacks.getScenes($workflowService.selectedStream()._id),$scope.createSceneSlider(),$scope.openScene(res.data)},function(err){$scope.cloningInProgress=!1})):$scope.createSceneObj._id?($scope.creatingScene=!0,BTStreamsService.editScene($workflowService.selectedStream()._id,$scope.createSceneObj._id,payload).then(function(res){$scope.creatingScene=!1,$scope.callbacks.getScenes($workflowService.selectedStream()._id)},function(err){$scope.creatingScene=!1})):BTStreamsService.createScene($workflowService.selectedStream()._id,payload).then(function(res){
$scope.creatingScene=!1,$scope.callbacks.getScenes($workflowService.selectedStream()._id),$scope.createSceneSlider(),$scope.openScene(res.data)},function(err){$scope.creatingScene=!1})},$scope.clearModal=function(){$scope.csvContent=null,$scope.fileName=null,$scope.fileId=null,$("#importStoryFile").val(null),$scope.importScene={name:""},$scope.incliudeComments=!1,$scope.fileExtensionError=!1},$scope.fileChangeListener=function(event){$scope.fileExtensionError=!1;var fileName="";if(event&&event.target&&event.target.files&&event.target.files.length&&event.target.files[0].name){fileName=event.target.files[0].name;var _ext=fileName.substring(fileName.lastIndexOf("."));if(".csv"!==_ext)return $("#importStoryFile").val(null),$scope.fileExtensionError=!0,void NotificationService.notify(i18n.i18nString("validation_csv"),"error");$scope.fileName=fileName,$scope.fileExtensionError=!1,$scope.onFileSelect(event.target,_ext)}},$scope.onFileSelect=function(input,ext){ext=(ext||"").replace(".","");var files=input.files;$scope.csvContent;if(files&&files.length){var fileToRead=files[0],onFileLoad=function(fileLoadedEvent){var textFromFileLoaded=fileLoadedEvent.target.result;$scope.csvContent=textFromFileLoaded;var data=new FormData;data.append("file",fileToRead),data.append("fileContext","bulkImport"),data.append("fileExtension",ext),data.append("Content-Type",fileToRead.type),BTStreamsService.uploadFAQFile($applicationService.userInfo().userId,data).then(function(response){$scope.fileId=response.data.fileId,NotificationService.notify(i18n.i18nString("file_uploaded_sucess_noty",{dyn:$scope.fileName}),"success"),$scope.fileExtensionError=!1,$("#importStoryFile").val(null)},function(errRes){errRes&&errRes.error.errors&&errRes.error.errors.length&&errRes.error.errors[0]&&errRes.error.errors[0].msg?NotificationService.notify(errRes.error.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_file"),"error")})},fileReader=new FileReader;fileReader.onload=onFileLoad,fileReader.readAsText(fileToRead,"UTF-8")}},$scope.importSelectedSceneFile=function(fileId){$scope.startImporting=!0;var payload={fileName:fileId,fileType:"csv",importType:"new",delimiter:",",includeComments:$scope.incliudeComments};$scope.importInfo&&"existing"===$scope.importInfo.importMode?(payload.importType="existing",payload.sceneId=$scope.importInfo.sceneId):payload.sceneName=$scope.importScene.name,BTStreamsService.importScene($workflowService.selectedStream()._id,payload).then(function(response){$scope.callbacks.getScenes($workflowService.selectedStream()._id);var eventPayload={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L1",Category:"Engagement L1",Description:"If the user taps on proceed to start with the new storyboard or successfully imports a scene to get started with a storyboard","Sub Category":"Conversation - Storyboard","Storyboard Source":"Import",Result:"Import SuccessFull"};mixPanel.postEvent("Conversation - Initiate Storyboard",eventPayload),$scope.clearModal(),$scope.closeImportStoryModal(),$scope.openImport=!1,$scope.startImporting=!1,NotificationService.notify(i18n.i18nString("scene_imported"),"success")},function(errRes){errRes=errRes.data;var _eventPayload={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L1",Category:"Engagement L1",Description:"If the user taps on proceed to start with the new storyboard or successfully imports a scene to get started with a storyboard","Sub Category":"Conversation - Storyboard","Storyboard Source":"Import",Result:"Import Failed"};$scope.startImporting=!1,errRes&&errRes.error&&errRes.error.errors&&errRes.error.errors.length&&errRes.error.errors[0]&&errRes.error.errors[0].msg?(NotificationService.notify(errRes.error.errors[0].msg,"error"),_eventPayload.failure=errRes.error.errors[0].msg):(_eventPayload.failure="Import Failed",NotificationService.notify(i18n.i18nString("failed_import"),"error")),mixPanel.postEvent("Conversation - Initiate Storyboard",_eventPayload)})},$scope.resetInteractiveLink=function(){console.log($scope.shareInfo);var hash=$scope.interactiveLink.split("/"),queryParams={streamId:$scope.stream._id,sceneId:$scope.selectedScene._id,hash:hash[hash.length-1]};BTStreamsService.resetShareURL(queryParams).then(function(res){$scope.shareInfo.link=res.data.newLink},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.protectedPassword=function(){var payload={shareInfo:[]};$scope.shareInfo.isSecured||($scope.shareInfo.password="",payload.shareInfo.push($scope.shareInfo),$scope.updatePassword(payload))},$scope.updatePassword=function(payload){return payload||(payload={shareInfo:[]},payload.shareInfo.push($scope.shareInfo)),$scope.shareInfo.isSecured&&!$scope.shareInfo.password?void NotificationService.notify(i18n.i18nString("need_password"),"error"):(NotificationService.notify(i18n.i18nString("scene_updated"),"success"),void BTStreamsService.updateScene($workflowService.selectedStream()._id,$scope.selectedScene._id,payload).then(function(res){},function(err){NotificationService.notify(err.data.errors[0].msg,"error")}))},$scope.copyInteractiveLink=function(text){var textarea=document.createElement("textarea");document.body.appendChild(textarea),textarea.value=text,textarea.select(),textarea.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(textarea),NotificationService.notify("Copied successfully","success")},$scope.openImportStoryModal=function(params){$scope.importScene.showImport=!0,setTimeout(function(){$scope.modalSlider.open("#importStoryScene"),$("#importStoryFile").length&&$("#importStoryFile").val(null)},500)},$scope.closeImportStoryModal=function(){$scope.modalSlider.close("#importStoryScene"),$scope.openImport=!1,$scope.startImporting||($scope.clearModal(),setTimeout(function(){$scope.importScene.showImport=!1},500))},$scope.botDetailsCb&&($scope.botDetailsCb.openImportStoryModal=$scope.openImportStoryModal,$scope.botDetailsCb.closeImportStoryModal=$scope.closeImportStoryModal)}])}(angular),function(ng){"use strict";var _module=ng.module("bt-stream-create",[]);_module.controller("BTStreamCreateCtrl",["$scope","$routeParams","$location",function($scope,$routeParams,$location){$(window).scrollTop(),$scope.displayMode="edit",$scope.streamId=$routeParams.streamId,$scope.onStreamFormCancel=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.onStreamFormSave=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.gotostream=function(){$location.path(window.appConfig.CONTEXT_PATH)}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-stream-edit",[]);_module.controller("BTStreamEditCtrl",["$scope","$routeParams","$location","BTStreamsService","NotificationService","$workflowService","i18n",function($scope,$routeParams,$location,BTStreamsService,NotificationService,$workflowService,i18n){$scope.displayMode="edit",$scope.streamId=$routeParams.streamId,$scope.selectedStream=$workflowService.selectedStream(),0===Object.keys($workflowService.selectedStream()).length&&$location.path(window.appConfig.CONTEXT_PATH),$scope.onEdit=function(){$scope.displayMode="view"===$scope.displayMode?"edit":"view"},$scope.deleteStream=function(){BTStreamsService.deleteStream($scope.streamId).then(function(res){NotificationService.notify(i18n.i18nString("bot_successfully_deleted"),"success"),$location.path(window.appConfig.CONTEXT_PATH)},function(err){NotificationService.notify(i18n.i18nString("bot_successfully_delete_fail"),"error")})},$scope.onStreamFormCancel=function(){$scope.displayMode="view",$location.path(window.appConfig.CONTEXT_PATH)},$scope.onStreamFormSave=function(){$scope.displayMode="view",$location.path(window.appConfig.CONTEXT_PATH)},$scope.gotostream=function(){$location.path(window.appConfig.CONTEXT_PATH)}}])}(angular),function(ng){"use strict";var btstreams=ng.module("bt-streams",["ui.bootstrap"]);btstreams.directive("adjustbotlist","i18n",function($window,$document,i18n){return function(scope,element){function setCss(){element.css("height",w.height()-element.offset().top+$(document).scrollTop()+"px")}var w=ng.element($window);$scope.saving=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$scope.utterances_label=i18n.i18nString("Utterances"),$scope.utterance_label=i18n.i18nString("utterence_label"),setCss(),scope.onWinResize=function(){setCss()},w.bind("resize",function(){scope.onWinResize()}),w.bind("scroll",function(){setCss()})}}),btstreams.filter("myBots",function($applicationService){return function(streams){return _.filter(streams,function(stream){return stream.createdBy.id===$applicationService.userInfo().userId})}}),btstreams.filter("sharedBots",function($applicationService){return function(streams){return _.filter(streams,function(stream){return stream.createdBy.id!==$applicationService.userInfo().userId})}}),btstreams.factory("indexerUtil",[function(){function isElementInView(element,fullyInView,srollEle){var pageTop=$(srollEle).scrollTop(),pageBottom=pageTop+$(srollEle).height(),elementTop=$(element).offset().top,elementBottom=elementTop+$(element).height();return fullyInView===!0?elementTop>pageTop&&pageBottom>elementBottom:pageBottom>=elementTop&&elementBottom>=pageTop}return{isElementVisible:isElementInView}}]),btstreams.factory("flowsUtil",[function(){function arrangeMappings(mappings){var results=[],obj={};return mappings.map(function(mapping,index){var key="";mapping.sourceResourceId&&mapping.targetResourceId?(key=mapping.sourceResourceId+"-"+mapping.targetResourceId,obj[key]?(compareVersion(obj[key].sourceResourceVersion,mapping.sourceResourceVersion,mapping)||compareVersion(obj[key].targetResourceVersion,mapping.targetResourceVersion,mapping))&&(obj[key].oldVersions.push(_.clone(obj[key])),obj[key].index=index,obj[key].sourceResourceVersion=mapping.sourceResourceVersion,obj[key].targetResourceVersion=mapping.targetResourceVersion):obj[key]={index:index,sourceResourceVersion:mapping.sourceResourceVersion,targetResourceVersion:mapping.targetResourceVersion,oldVersions:[]}):(key=mapping.alertId+"-"+mapping.actionId,obj[key]?(compareVersion(obj[key].alertVersion,mapping.alertVersion,mapping)||compareVersion(obj[key].actionVersion,mapping.actionVersion,mapping))&&(obj[key].oldVersions.push(_.clone(obj[key])),obj[key].index=index,obj[key].alertVersion=mapping.alertVersion,obj[key].actionVersion=mapping.actionVersion):obj[key]={index:index,alertVersion:mapping.alertVersion,actionVersion:mapping.actionVersion,oldVersions:[]})}),Object.keys(obj).map(function(key){var mapping=mappings[obj[key].index];mapping.oldVersions=[],obj[key].oldVersions.map(function(version){mapping.oldVersions.push(mappings[version.index]),"active"===mappings[version.index].state&&mapping.parentMapId===mappings[version.index].mapId&&(mappings[version.index].parentOf=mapping.mapId,results.push(mappings[version.index]))}),results.push(mapping)}),results}function compareVersion(version1,version2,mapping){return version1=version1.split(".").map(function(number){return+number}),version2=version2.split(".").map(function(number){return+number}),+version1[0]>+version2[0]?!1:+version1[0]==+version2[0]&&+version1[1]>+version2[1]?!1:+version1[0]==+version2[0]&&+version1[1]==+version2[1]&&"active"===mapping.state?!1:!0}return{arrangeFlows:arrangeMappings}}]),btstreams.controller("BTStreamsCtrl",["$scope","$rootScope","$q","$applicationService","pollFactory","$timeout","$route","$filter","$workflowService","BTSeedDataService","BTStreamsService","BTFlowtaskService","$translator","$location","BTAlertsService","BTActionsService","BTParamMapService","NotificationService","form_util","AppsDataService","$modal","BTIdpService","TimerNotification","$window","flowsUtil","uuid4","security","jsValidator","localstore","i18n",function($scope,$rootScope,$q,$applicationService,pollFactory,$timeout,$route,$filter,$workflowService,BTSeedDataService,BTStreamsService,BTFlowtaskService,$translator,$location,BTAlertsService,BTActionsService,BTParamMapService,NotificationService,form_util,AppsDataService,$modal,BTIdpService,TimerNotification,$window,flowsUtil,uuid4,security,jsValidator,localstore,i18n){function isEleVisible(element){return $(element).is(":visible")}function getConnections(data){var transitions=_.flatten(_.pluck(data,"transitions"));return _.filter(transitions,function(each){return"end"!==each["default"]&&!_.isEmpty(each["default"])||_.isUndefined(each["default"])})}function writeAndDownloadDialog(filename,data){if(navigator.msSaveBlob){var blob=new Blob([data],{type:"data:text/plain;charset=utf-8"});return window.navigator.msSaveOrOpenBlob(blob,filename)}var element=document.createElement("a");element.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(data)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function getConnectorsList(){BTIdpService.connectors().then(function(res){$scope.connectors=res.data,$workflowService.botConnectors(angular.copy(res.data))},function(err){$scope.connectors=[]})}function retainScrollPosition(){var _streamEle=$("#"+$workflowService.selectedStream()._id);if(_streamEle){var _container=_streamEle.closest(".ps-container");if(_container){var _scrollHeight=_streamEle.offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"slow")}}}function getSingleorPluralMessage(count,type){return count>1?count+" "+type+" tasks":count+" "+type+" task"}function load(){var currentUser=localstore.getAuthData().currentAccount;$scope.isDomainKore="kore"===currentUser.domain.split(".")[0],$scope.showContent=!1,$scope.activeTask=null,$scope.isGlobalWorkProgress=!1,$scope.isWorkProgress=!1,$scope.activeEntityFlow=null,$scope.dialogMode=null,$(".modal-backdrop").remove(),$q.all([BTSeedDataService.getSeedCategories(),BTStreamsService.getStreams(),BTStreamsService.getSampleBots(),BTStreamsService.getSmartBots()]).then(function(res){$workflowService.seedData();if($scope.loadingStreams=!1,$scope.categories=res[0].data.categories,$scope.streams=res[1].data,$workflowService.allSampleBots(res[2].data),$workflowService.allSmartBots(res[3].data),$scope.removeModalOpenClass(),$scope.streams.length>0){if($scope.streams=$filter("orderBy")($scope.streams,"+name"),$workflowService.streamsAll($scope.streams),""!==$workflowService.importedNewBotId().trim()){var importedBot=$scope.streams.filter(function(stream){return $workflowService.importedNewBotId()===stream._id});importedBot&&importedBot.length>0&&($workflowService.selectedStream(importedBot[0]),$workflowService.currentLanguage(importedBot[0].defaultLanguage),$scope.currentLanguage=importedBot[0].defaultLanguage),$workflowService.importedNewBotId(" ")}if($(".kore-chat-header .close-btn").trigger("click"),_.isObject($workflowService.selectedStream())&&!$workflowService.selectedStream()._id){var streamSelected=$scope.streams[0];$scope.streams[0].active=!0,$scope.changeBotLanguage(streamSelected.defaultLanguage),$.each($scope.streams,function(i,stream){return stream.createdBy.id===$applicationService.userInfo().userId?(stream.active=!0,streamSelected=stream,0!==i&&($scope.streams[0].active=!1),!1):void 0}),$workflowService.selectedStream(streamSelected),streamSelected.state&&"setup"===streamSelected.state&&($scope.showSolutionBotSetup=!0),$q.all([getAlerts(streamSelected._id),getActions(streamSelected._id),getFlowTasks(streamSelected._id),getKnowledgeTasks(streamSelected._id),getStream(streamSelected),getMappings(streamSelected._id),getAlertDialogMappings(streamSelected._id)]).then(function(res){showActiveTab(),$timeout(function(){$(window).trigger("resize"),retainScrollPosition()})})}else{$workflowService.selectedStream().state&&"setup"===$workflowService.selectedStream().state&&($scope.showSolutionBotSetup=!0),$q.all([getAlerts($workflowService.selectedStream()._id),getActions($workflowService.selectedStream()._id),getFlowTasks($workflowService.selectedStream()._id),getKnowledgeTasks($workflowService.selectedStream()._id),getStream($workflowService.selectedStream()),getMappings($workflowService.selectedStream()._id),getAlertDialogMappings($workflowService.selectedStream()._id)]).then(function(res){showActiveTab(),$timeout(function(){$(window).trigger("resize"),retainScrollPosition()})});for(var i=0;i<$scope.streams.length;i++)$scope.streams[i]._id===$workflowService.selectedStream()._id&&($scope.streams[i].active=!0)}}else $scope.loadingStream=!1},function(err){401!==+err.status&&NotificationService.notify("error",i18n.i18nString("loading_error"))})}function showActiveTab(){$scope.showContent=!0,$(".tasks-pane").removeClass("active"),$scope.navigateTabIndex=$workflowService.navigateTabIndex(),$($scope.navigateTabIndex).addClass("active")}function getMappings(id){var deferred=$q.defer();return $scope.loadingFlows=!0,$scope.mappings=[],BTStreamsService.getMappings(id).then(function(res){var _alertMappings=angular.copy(res.data);_alertMappings=_alertMappings.map(function(mapping){return mapping.actionStreamIcon=(_.find($scope.streams,{_id:mapping.actionStreamId})||{}).icon,mapping.alertStreamIcon=(_.find($scope.streams,{_id:mapping.alertStreamId})||{}).icon,mapping.actionName=mapping.actionName?mapping.actionName.replace(/&lt;/g,"<").replace(/&gt;/g,">"):"",mapping.actionStream=mapping.actionStream?mapping.actionStream.replace(/&lt;/g,"<").replace(/&gt;/g,">"):"",mapping.alertName=mapping.alertName?mapping.alertName.replace(/&lt;/g,"<").replace(/&gt;/g,">"):"",mapping.alertStream=mapping.alertStream?mapping.alertStream.replace(/&lt;/g,"<").replace(/&gt;/g,">"):"",mapping}),$scope.mappings=$scope.mappings.concat(_alertMappings),$scope.mappings=flowsUtil.arrangeFlows($scope.mappings),deferred.resolve(res)}),deferred.promise}function getAlertDialogMappings(id){var deferred=$q.defer();return $scope.loadingFlows=!0,BTStreamsService.getAlertDialogMappings(id).then(function(res){var _dialogMappings=angular.copy(res.data);triggerTaskLockReleasing(),_dialogMappings=_dialogMappings.map(function(mapping){return mapping.sourceStreamIcon=(_.find($scope.streams,{_id:mapping.sourceResourceStreamId})||{}).icon,mapping.targetStreamIcon=(_.find($scope.streams,{_id:mapping.targetResourceStreamId})||{}).icon,mapping.sourceResourceName=mapping.sourceResourceName?mapping.sourceResourceName.replace(/&lt;/g,"<").replace(/&gt;/g,">"):"",mapping.targetResourceName=mapping.targetResourceName?mapping.targetResourceName.replace(/&lt;/g,"<").replace(/&gt;/g,">"):"",mapping}),$scope.mappings=$scope.mappings.concat(_dialogMappings),$scope.mappings=flowsUtil.arrangeFlows($scope.mappings),$scope.loadingFlows=!1,deferred.resolve(res)}),deferred.promise}function getAlerts(id){if(id){var deferred=$q.defer();return $scope.alerts=$scope.alerts||[],$scope.loadingAlerts=!0,BTAlertsService.getAlerts(id).then(function(res){$scope.alerts=assignAlertParent(angular.copy(res.data)),angular.forEach($scope.alerts,function(alert,key){alert&&alert.name&&(alert.name=alert.name.replace(/&lt;/g,"<").replace(/&gt;/g,">")),alert&&alert.shortDesc&&(alert.shortDesc=alert.shortDesc.replace(/&lt;/g,"<").replace(/&gt;/g,">"))}),$scope.organizeDataBasedOnAlerts(),$scope.loadingAlerts=!1,deferred.resolve(res)},function(err){NotificationService.notify(i18n.i18nString("alerts_loading"),"error"),$scope.alerts=[]}),deferred.promise}}function getActions(id){if(id){var deferred=$q.defer();return $scope.reports=$scope.reports||[],$scope.actions=$scope.actions||[],$scope.loadingActions=!0,BTActionsService.getActions(id).then(function(res){var actions=assignActionParent(angular.copy(res.data)),_pureActions=[],_pureReports=[];actions.map(function(val){val.isReport?_pureReports.push(val):_pureActions.push(val),val&&val.name&&(val.name=val.name.replace(/&lt;/g,"<").replace(/&gt;/g,">")),val&&val.shortDesc&&(val.shortDesc=val.shortDesc.replace(/&lt;/g,"<").replace(/&gt;/g,">"))}),$scope.reports=_pureReports,$scope.actions=_pureActions,$scope.organizeDataBasedOnActions(),$scope.loadingActions=!1,deferred.resolve(res)},function(error){NotificationService.notify(i18n.i18nString("actions_loading"),"error"),$scope.actions=[],$scope.reports=[]}),deferred.promise}}function getFlowTasks(id){var deferred=$q.defer();return $scope.flowtasks=$scope.flowtasks||[],$scope.loadingFlows=!0,BTFlowtaskService.getFlowtaks(id).then(function(res){$scope.flowtasks=assignAlertParent(angular.copy(res.data)),$rootScope.hasPublishedFlowtasks=!1,angular.forEach($scope.flowtasks,function(flowtask,key){flowtask&&flowtask.name&&(flowtask.name=flowtask.name.replace(/&lt;/g,"<").replace(/&gt;/g,">")),flowtask&&flowtask.shortDesc&&(flowtask.shortDesc=flowtask.shortDesc.replace(/&lt;/g,"<").replace(/&gt;/g,">"))}),$rootScope.hasPublishedFlowtasks=_.find($scope.flowtasks,function(flowtask){var _hasPublished="published"===flowtask.state||"awaitingApproval"===flowtask.state;return!_hasPublished&&flowtask.child&&flowtask.child.length&&$.each(flowtask.child,function(k,child){return"published"===child.state||"awaitingApproval"===child.state?(_hasPublished=!0,!1):void 0}),_hasPublished})&&!0,canAccessService(),isInMarket($scope.flowtasks),$workflowService.flowTasks($scope.flowtasks),triggerTaskLockReleasing(),$scope.loadingFlows=!1,deferred.resolve(res)},function(err){$scope.flowtasks=[]}),deferred.promise}function getKnowledgeTasks(){var deferred=$q.defer();$scope.knowledgeTasks=$scope.knowledgeTasks||[],$scope.loadingKnowledge=!0;var requestData={streamId:$workflowService.selectedStream()._id};return BTStreamsService.getAllKtsList($applicationService.userInfo().userId,requestData).then(function(res){$scope.loadingKnowledge=!1,$scope.knowledgeTasks=angular.copy(res.data),angular.forEach($scope.knowledgeTasks,function(knowledgeTask,key){knowledgeTask&&knowledgeTask.name&&(knowledgeTask.name=knowledgeTask.name.replace(/&lt;/g,"<").replace(/&gt;/g,">")),knowledgeTask&&knowledgeTask.description&&(knowledgeTask.description=knowledgeTask.description.replace(/&lt;/g,"<").replace(/&gt;/g,">"))}),canAccessService(),isInMarket($scope.knowledgeTasks),$workflowService.knowledgeTasks($scope.knowledgeTasks),triggerTaskLockReleasing(),deferred.resolve(res)},function(err){NotificationService.notify(i18n.i18nString("kg_laoding"),"error"),$scope.knowledgeTasks=[]}),deferred.promise}function isInMarket(tasks){var _allTasks=[].concat($scope.alerts,$scope.actions,$scope.flowtasks);_isInCAP=-1!==_.findIndex(_allTasks,{state:"configured"})?!0:!1,_isInCAP=-1!==_.findIndex(_allTasks,{state:"published"})?!0:_isInCAP,_isInCAP=-1!==_.findIndex(_allTasks,{state:"awaitingApproval"})?!0:_isInCAP,$workflowService.isInCAP(_isInCAP);for(var i=0;i<tasks.length;i++)if("published"===tasks[i].state||"suspended"===tasks[i].state||"awaitingApproval"===tasks[i].state){$scope.selectedStream.isInMarket=!0,$workflowService.selectedStream($scope.selectedStream);break}for(var j=0;j<tasks.length;j++){if("published"===tasks[j].state||"suspended"===tasks[j].state){$workflowService.publishedOrSuspended(!0);break}$workflowService.publishedOrSuspended(!1)}for(var k=0;k<tasks.length;k++){if("published"===tasks[k].state)return void $workflowService.isTaskPublished(!0);$workflowService.isTaskPublished(!1)}}function assignAlertParent(alerts){var parents=alerts.filter(function(alert){return!alert.parentId}),childs=alerts.filter(function(alert){return alert.parentId});return parents=parents.map(function(parent){return childs.map(function(child){parent._id===child.parentId?(parent.child=[],parent.child.push(angular.copy(child)),parent.child[0].parent=angular.copy(parent),parent.isParent=!0):parent._id===child._id&&(parent.isChild=!0)}),parent}).filter(function(parent){return parent.isChild!==!0})}function assignActionParent(actions){var parents=actions.filter(function(action){return!action.parentId}),childs=actions.filter(function(action){return action.parentId});return parents=parents.map(function(parent){return childs.map(function(child){parent._id===child.parentId?(parent.child=[],parent.child.push(angular.copy(child)),parent.child[0].parent=angular.copy(parent),parent.isParent=!0):parent._id===child._id&&(parent.isChild=!0)}),parent}).filter(function(parent){return parent.isChild!==!0})}function getAccountForStream(){BTStreamsService.getAccounts($workflowService.selectedStream()._id,"true","true").then(function(res){$scope.account1=res.data,updateIDPData()},function(err){})}function loadAutoTrainMLStatus(){$scope.autotrainData={},$scope.selectedStream.hasOwnProperty("enableAutoUtteranceAddition")?$scope.autotrainData.enableAutoUtteranceAddition=$scope.selectedStream.enableAutoUtteranceAddition:$scope.autotrainData.enableAutoUtteranceAddition=!1}function saveBotStream(_payload){BTStreamsService.editStream($scope.selectedStream._id,_payload).then(function(res){$scope.selectedStream=res.data,$workflowService.selectedStream(angular.copy($scope.selectedStream)),NotificationService.notify(i18n.i18nString("settings_saved_sucessfully"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function getUserSessionContext(){BTStreamsService.getSessions($workflowService.selectedStream()._id).then(function(res){res&&res.data&&$workflowService.contextData(res.data)},function(err){})}function getStream(stream){var id=stream._id,deferred=$q.defer();$scope.loadingStream=!0,$scope.selectedStream={},$scope.authInfo=null,$scope.account1=null;var _reqStreamID=stream.state&&"setup"===stream.state?stream.sbStreamId:id,requests=[BTStreamsService.getBTStream(id),BTStreamsService.getMPStream(id)];return $q.all(requests).then(function(res){$scope.selectedStream=angular.extend($scope.selectedStream,res[0].data),loadAutoTrainMLStatus(),delete res[1].data.visibility,$scope.selectedStream=angular.extend($scope.selectedStream,res[1].data),$scope.selectedStream.name=$scope.selectedStream.name?$scope.selectedStream.name.replace(/&lt;/g,"<").replace(/&gt;/g,">"):"",$scope.selectedStream.description=$scope.selectedStream.description?$scope.selectedStream.description.replace(/&lt;/g,"<").replace(/&gt;/g,">"):"",$scope.selectedStream.state=res[0].data.state,$scope.supportedLanguages=mapSupportedLanguages(),$workflowService.supportedLanguages($scope.supportedLanguages),$workflowService.selectedStream(angular.copy($scope.selectedStream)),fetchLinkedBots(),getUserSessionContext(),BTStreamsService.getAuthinfo(id).then(function(res){res.data&&($scope.authInfo=res.data,$scope.idpConfigs=[],$.each($scope.authInfo,function(i,authData){BTIdpService.getIdpByName(authData.idpName,$workflowService.selectedStream()._id).then(function(res){$scope.idpConfigs.push(res.data)},function(err){$scope.idpConfigs=$scope.idpConfigs||[]})}),getAccountForStream())},function(err){}),BTStreamsService.getSolutionBotStream(_reqStreamID).then(function(res){("solution"===res.data.botType||"workplacefb"===res.data.botType||"enterprise"===res.data.botType)&&(res.data.isSolutionBot=!0),$scope.selectedStream=angular.extend($scope.selectedStream,res.data),$scope.selectedStream.bBanner||($scope.selectedStream.bBanner="no-image"),$workflowService.selectedStream(angular.copy($scope.selectedStream)),appendCategory($scope.selectedStream),$timeout(function(){$scope.loadingStream=!1}),deferred.resolve(res)},function(err){appendCategory($scope.selectedStream),$timeout(function(){$scope.loadingStream=!1}),deferred.resolve(res)})},function(err){$timeout(function(){$scope.loadingStream=!1}),deferred.reject(err)}),deferred.promise}function fetchLinkedBots(){"universalbot"===$scope.selectedStream.type&&($scope.linkedBots=[],$scope.configuredBots=angular.copy($scope.streams.filter(function(stream){return-1!==$scope.selectedStream.configuredBots.indexOf(stream._id)?(stream.state="linked",!0):void 0})),$scope.linkedBots=$scope.linkedBots.concat($scope.configuredBots),$scope.linkedBots=$scope.linkedBots.concat(angular.copy($scope.streams.filter(function(stream){return-1!==$scope.selectedStream.awaitingApprovalBots.indexOf(stream._id)?(stream.state="awaitingApproval",!0):void 0}))),$scope.linkedBots=$scope.linkedBots.concat(angular.copy($scope.streams.filter(function(stream){return-1!==$scope.selectedStream.publishedBots.indexOf(stream._id)?(stream.state="published",!0):void 0}))))}function getApps(){$scope.loadingApps=!0,$q.all([AppsDataService.getAppsList($scope.selectedStream._id),AppsDataService.getBotsList()]).then(function(res){$scope.loadingApps=!1,res[1]&&res[1].data?$scope.avalSreams=res[1].data:$scope.avalSreams=[],res[0]&&res[0].data&&res[0].data.apps?$scope.apps=res[0].data.apps:$scope.apps=[]},function(err){$scope.loadingApps=!1,NotificationService.alertNotify(i18n.i18nString("get_apps"))})}function clearActiveClass(isFormUpdateTask){if(!isFormUpdateTask)for(var i=0;i<$scope.streams.length;i++)$scope.streams[i].active=!1;$workflowService.navigateTabIndex(".tasks-pane"),$scope.navigateTabIndex=".tasks-pane",$(".tasks-pane").addClass("active").siblings().removeClass("active"),isFormUpdateTask||$(".panel-collapse.in").collapse("hide")}function openDialogTaskAccordion(){$timeout(function(){$("#flowDialogTasks").collapse("show"),$("#headFlowTask").removeClass("collapsed")},500)}function onDebugResizeStop(e,u){$scope.isDebugResized++}function debugConsoleTrigger(e){if("debugClick"===e.event)$scope.openDebugConsole();else if("minimizeClick"===e.event)$scope.isDebugMinimized=$scope.isDebugConsolePanelOpened,$scope.closeDebugConsolePanel();else if("maximizeClick"===e.event)$scope.isDebugMinimized&&($scope.openDebugConsole(),$scope.isDebugMinimized=!1);else{if("resetClick"===e.event)return void $scope.resetDebugConsole();if("closeClick"===e.event)return $scope.closeDebugConsolePanel(),void $scope.resetDebugConsole()}}function pushHistory(debug){$scope.debugInfo=$scope.debugInfo||[];var node=debug.history;node.debugTitle&&$scope.debugInfo.push(node),node.timestampFormated=moment(node.timestamp).local().format("DD/MMM/YYYY  hh.mm.ssA"),$timeout(function(){var _debugLogDiv=$(".debug-log-body .log-console-body");_debugLogDiv&&_debugLogDiv.scrollTop(_debugLogDiv[0].scrollHeight)},300)}function arrangeChannels(channel){var index;return $scope.selectedStream.channels.map(function(channelInfo,i){channelInfo.type===channel.type&&channelInfo.id===channel.id&&(index=i)}),_.isUndefined(index)?$scope.selectedStream.channels.push(channel):$scope.selectedStream.channels.splice(index,1,channel),$scope.selectedStream.channels}function deleteChannel(index){var channel=$scope.selectedStream.channels[index];BTStreamsService.deleteChannel($scope.selectedStream._id,channel.type).then(function(res){$scope.selectedStream.channels.splice(index,1),$workflowService.selectedStream(angular.copy($scope.selectedStream)),NotificationService.notify(i18n.i18nString("bt_streams_chnl_Deleted_sucess"),"success")},function(err){var errMsg=err&&err.errors&&err.errors[0].msg||i18n.i18nString("bt_chnl_form_chnl_delete_failed");NotificationService.notify(errMsg,"error")})}function getChannelName(type){return"rtm"===type?"Web / Mobile client":"widgetsdk"==type?"Widget SDK":type}function getChannelMessage(channel){var msg=i18n.i18nString("bt_streams_chnl_bot_not_able_to_respond",{dyn:getChannelName(channel.type)}),appendMsg=i18n.i18nString("bt_streams_you_Can_still_talk_to_bot"),message=" ",enableChannelExisted=!1;return $scope.selectedStream.channels.map(function(channelInfo,i){channelInfo.type===channel.type&&channelInfo.id===channel.id||!channelInfo.enable||(message=message+getChannelName(channelInfo.type)+", ",enableChannelExisted=!0)}),enableChannelExisted?(message=message.substr(0,message.length-2),msg+appendMsg+message+"."):msg}function deleteStream(stream){
$q.all([BTStreamsService.deleteBTStream(stream._id)]).then(function(res){if($scope.streams.splice(getStreamIndex(stream._id),1),NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("bt_streams_bot_deleted_success"),"success"),$scope.streams.length>0){var streamToSelect=$scope.streams[0];$.each($scope.streams,function(i,stream){return stream.createdBy.id===$applicationService.userInfo().userId?(streamToSelect=stream,!1):void 0}),$scope.selectApp(streamToSelect)}else $scope.selectedStream={},$("body").addClass("hidebodyscroll");$("body").removeClass("bt-modal-open"),isEleVisible("#termsConditions")||$("body").removeClass("modal-open")},function(err){NotificationService.alertNotify(i18n.i18nString("deletion_failed"),err.data?err.data.errors[0].msg:i18n.i18nString("some_thing_went_wrong_err_noty"),"error")})}function showLockErrorMessage(error,full){try{error=error.errors;var msg=_.isArray(error)?error[0].msg:i18n.i18nString("some_thing_went_wrong_err_noty");NotificationService.notify(msg,"error")}catch(ex){console.log(ex)}}function openModalByClass(modalClass){$(modalClass).modal("show")}function closeModalByClass(modalClass){$timeout(function(){isEleVisible("#termsConditions")||$("body").removeClass("modal-open"),$("body").removeClass("bt-modal-open")}),$(modalClass).modal("hide"),".utterances-form"===modalClass&&($(document).off("click.entity"),$scope.canShowUtterances=!1),".batchtesting-form"===modalClass&&($scope.canShowBatchTesting=!1),".ontology-form"===modalClass&&($scope.canShowontology=!1,$("body").removeClass("ontologymodalopen"),getKnowledgeTasks($workflowService.selectedStream()._id))}function triggerTaskLockReleasing(){var userId=$applicationService.userInfo().userId,callReleaseLock=function(resourceObject,resourceName){var proceedToReleaseLock=function(resourceObject){resourceObject&&resourceObject.lock&&resourceObject.lock.lockkey&&resourceObject.lock.userId==userId&&("flow"===resourceName&&(resourceObject._id=resourceObject.mapId),$scope.releaseLock(resourceName,resourceObject,!0),TimerNotification.removeTimer(resourceObject._id),delete resourceObject.lock)};proceedToReleaseLock(resourceObject),$.each(resourceObject.child||[],function(i,data){proceedToReleaseLock(data)})};$scope.alerts.map(function(alert){callReleaseLock(alert,"alert")}),$scope.actions.map(function(action){callReleaseLock(action,"action")}),$scope.reports.map(function(report){callReleaseLock(report,"action")}),$scope.mappings.map(function(mapping){callReleaseLock(mapping,"flow")}),$scope.knowledgeTasks.map(function(kt){callReleaseLock(kt,"knowledgeTask")}),$scope.selectedStream.lock&&$scope.selectedStream.lock.lockkey&&$scope.releaseLock("bot",$scope.selectedStream,!0)}function prepareTimer(timerConfig,entity,taskType){function warningSuccessCb(){this._stages.expiry=!0,entity.lock=entity.lock?entity.lock:{},entity.lock.locktime=!0,$scope.lockTask(entity,prepareTimer)}function warningCancelCb(){}function expirySuccessCb(){this._stages.expiry=!0,entity.lock=entity.lock?entity.lock:{},entity.lock.locktime=!0,$scope.lockTask(entity,prepareTimer)}function expiryCancelCb(){$scope.releaseLock(type,entity)}var types={a:"action",l:"alert",s:"bot",z:"flow"},entityTypes={a:"task",l:"task",s:"bot",z:"flow"},type="knowledgeTask"===taskType?"knowledgeTask":types[entity._id[0]],config={},entityType="knowledgeTask"===taskType?"task":entityTypes[entity._id[0]];return config.context={time:timerConfig.lockCreatedTime,expiry:timerConfig.locktime,task:timerConfig.resourceId,lockkey:timerConfig.lockkey,userId:timerConfig.userId,islocked:timerConfig.islocked,lockCreatedTime:timerConfig.lockCreatedTime},config.warning={msg:$scope._constants_.timerMsgs.warning.replace(/{task}/g,entity.name).replace(/{type}/g,entityType),actions:{success:warningSuccessCb,failure:warningCancelCb},arguments:{success:[],failure:[]},btnText:{success:i18n.i18nString("bt_streams_extend"),failure:i18n.i18nString("close")}},config.expiry={msg:$scope._constants_.timerMsgs.expiry.replace(/{task}/g,entity.name).replace(/{type}/g,entityType),actions:{success:expirySuccessCb,failure:expiryCancelCb},arguments:{success:[],failure:[]},btnText:{success:i18n.i18nString("bt_streams_extend"),failure:i18n.i18nString("close")}},config}function openModalDialog(entity,type){$scope.activeTask=entity,$scope.activeTask.taskType=type,openModalByClass(".version-form")}function deleteWorkflow(entity,type){var entityType="action"===type?entity.isReport?$scope._constants_.report:$scope._constants_.action:"flowtask"===type?"Dialog Task":"Alert";entityType="knowledgeTask"===type?$scope._constants_.knowledge:entityType,"alert"===type?$q.all([BTAlertsService.deleteBTAlert(entity._id)]).then(function(res){NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("alerttask_delete"),"success"),getAlerts($workflowService.selectedStream()._id),getMappings($workflowService.selectedStream()._id)},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),err.data.errors[0].msg,"error")}):"action"===type?$q.all([BTActionsService.deleteBTAction(entity._id)]).then(function(res){NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("delete_entitytype",{dyn:entityType}),"success"),getActions($workflowService.selectedStream()._id),getMappings($workflowService.selectedStream()._id)},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),err.data.errors[0].msg,"error")}):"knowledgeTask"===type?$q.all([BTStreamsService.deleteKnowledgeTask($applicationService.userInfo().userId,entity._id)]).then(function(res){NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("delete_entitytype",{dyn:entityType}),"success"),$scope.trainBot(),getKnowledgeTasks($workflowService.selectedStream()._id)},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),err.data.errors[0].msg,"error")}):"flowtask"===type&&$q.all([BTFlowtaskService.deleteFlowtask($workflowService.selectedStream()._id,entity._id)]).then(function(res){NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("delete_entitytype",{dyn:entityType}),"success"),getFlowTasks($workflowService.selectedStream()._id)},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),err.data.errors[0].msg,"error")})}function deleteMapping(entity,index){entity.mapId?BTParamMapService.deleteMappedAlertAction(entity.mapId).then(function(res){NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("flow_deleted_sucess"),"success"),$scope.mappings.splice(index,1),(entity.parentOf||entity.parentMapId)&&$route.reload()},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),i18n.i18nString("flow_deletion_failed"),"error")}):BTParamMapService.deleteMappedAlertDialog(entity._id).then(function(res){NotificationService.alertNotify(i18n.i18nString("deleted_label_exclamation"),i18n.i18nString("flow_deleted_sucess"),"success"),$scope.mappings.splice(index,1),(entity.parentOf||entity.parentMapId)&&$route.reload()},function(err){NotificationService.alertNotify(i18n.i18nString("delete_failure"),i18n.i18nString("flow_deletion_failed"),"error")})}function appendCategory(stream){var i,j,k;if(stream.categoryname=[],stream.categoryIds){for(j=0;j<stream.categoryIds.length;j++)for(i=0;i<$scope.categories.length;i++){stream.categoryIds[j]===$scope.categories[i]._id&&stream.categoryname.push($scope.categories[i].name);var subC=$scope.categories[i].subCategories;if(subC&&subC.length)for(k=0;k<subC.length;k++)stream.categoryIds[j]===subC[k]._id&&stream.categoryname.push(subC[k].name)}stream.categoryname=stream.categoryname.map(function(category,index){return 0!==index?" "+category:category}),stream.categoryname=stream.categoryname.join(",")}else stream.categoryname=""}function getStreamIndex(id){for(var i=0;i<$scope.streams.length;i++)if($scope.streams[i]._id===id)return i;return-1}function checkForChannels(callback){var _channels=[];_channels=_.filter($scope.selectedStream.channels,function(channelObject){return channelObject.enable});var msg=i18n.i18nString("bot_usage_desc");_.isArray(_channels)&&_channels.length>0?callback():NotificationService.notify(msg,"warning")}function scriptDefinition(contextData){var contextCopy=angular.copy(contextData),code=contextData.contextData.code.body;$scope.scriptObj=code.trim().substring(2,code.length-2),$scope.error=contextData.error.message+" at "+(contextData.error.lineno-9)+":"+contextData.error.colno,$scope.scriptNodeErrorHelp="We could not successfully execute the "+($scope.scriptNodeName||"")+" script node as the platform found errors as described above. Your current task is discarded. You can rerun the script by modifying the script here and also save the revised script to the script node.",delete contextCopy.contextData.contextForResolution.scriptErrorMeta,$scope.contextObject=contextCopy.contextData.contextForResolution,scriptNodeEditorModal=!0,$("debug-console-panel .fa.fa-window-minimize.toggleMinMax").click(),openModalByClass(".script-node-edit-form")}function encodeJS(_obj){return encodeURIComponent(_obj)}function saveToServer(_payload){$scope.saveInProgress=!0;var _streamId=$scope.contextData.botInfo.taskBotId,_componentId=$scope.contextData.context.scriptErrorMeta.componentId;BTFlowtaskService.updateComponent(_streamId,_componentId,_payload).then(function(res){res&&res.data&&BTFlowtaskService.getComponents(_streamId,_componentId).then(function(res){res&&res.data&&($rootScope.$broadcast("update node info",res.data),$scope.closeModal())}),$scope.saveInProgress=!1},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("save_script_error"),"error");$scope.saveInProgress=!1})}function mapSupportedLanguages(){var seedData=$workflowService.seedData();return _.compact(_.map(seedData.nluSupportedLanguages,function(lang){return-1!==_.indexOf($scope.selectedStream.nluSupportedLanguages,lang.value)?lang:void 0}))}var loader="",_isInCAP=!1;$scope.loadingStreams=!0,$scope.loadingStream=!0,$scope.loadingAlerts=!0,$scope.loadingActions=!0,$scope.loadingFlows=!0,$scope.loadingKnowledge=!0,$scope.showTestBot=!1,$scope.showSolutionBotSetup=!1,$scope.showFlowtaskSetup=!0,$scope.showContent=!1,$scope._count=8,$scope.count=8,$scope.views={bots:!0,apps:!1},$scope.authInfo=null,$scope.account1=null,$scope.btTestFormApi={},$scope.btTestStatus={},$scope.idpConfig=null,$scope.context={api:{}},$rootScope.showLoginLoader=!1,$scope.displayTabId=null,$scope.sdkCallback={isFromSettings:!0},$scope.changeLogCallback={},$scope.userShareCallback={},$scope.userImportCallback={},$scope.authorizationCallback={},$scope.variableMngtCallback={},$scope.asCallback={},$scope.gsCallback={},$scope.bssCallback={},$scope.navigateTabIndex=".tasks-pane",$scope.isHelpLinkClicked=!1,$scope.linkedBots=[],$scope.configuredBots=[],$scope.trymodecallback={},$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.autotrainData={},$scope.autotrainData.enableAutoUtteranceAddition=!1,$scope.activeTask=null,$scope.dialogMode=null,$scope.publishBot=!1,$scope.showMapping=!1,$scope.initializeCreateBot=!1,$scope.activeEntityFlow=null,$scope.currentLanguage="en",$scope.saving=i18n.i18nString("saving"),$scope.save=i18n.i18nString("save"),$workflowService.currentLanguage()&&""!==$workflowService.currentLanguage()&&($scope.currentLanguage=$workflowService.currentLanguage()),$scope.taskCreateCallback={},$scope.modeSelectorCallback={},$scope.aceEditorCallback={};var scriptNodeEditorModal=!1,updateShowTestBot=function(_canAccessService){$scope.showTestBot=_canAccessService},canAccessService=function(){var _allTasks=[].concat($scope.alerts,$scope.actions,$scope.flowtasks,$scope.reports),_allChildTasks=_.pluck(_allTasks,"child")||[];_allChildTasks=_.filter(_allChildTasks,function(data){return void 0!==data})||[],_allChildTasks=_.flatten(_allChildTasks||[]),_allTasks=[].concat(_allTasks,_allChildTasks);var _canAccessService=$scope.knowledgeTasks.length>0?!0:!1;return _canAccessService?void updateShowTestBot(_canAccessService):(_canAccessService=-1!==_.findIndex(_allTasks,{state:"configured"})?!0:_canAccessService)?void updateShowTestBot(_canAccessService):(_canAccessService=-1!==_.findIndex(_allTasks,{state:"published"})?!0:_canAccessService)?void updateShowTestBot(_canAccessService):(_canAccessService=-1!==_.findIndex(_allTasks,{state:"awaitingApproval"})?!0:_canAccessService)?void updateShowTestBot(_canAccessService):(_canAccessService=-1!==_.findIndex(_allTasks,{state:"rejected"})?!0:_canAccessService)?void updateShowTestBot(_canAccessService):void updateShowTestBot(_canAccessService)};$scope.isCreateTaskOpen=!1,$rootScope.$on("createTaskOpen",function(event,flag){$scope.isCreateTaskOpen=flag}),isEleVisible("#termsConditions")||$("body").removeClass("modal-open"),$scope.selectView=function(selectedView){Object.keys($scope.views).map(function(view){$scope.views[view]=!1}),$scope.views[selectedView]=!0,"apps"===selectedView&&getApps()},$scope.canShowUtterances=!1,$scope.showUtterances=function(){openModalByClass(".utterances-form"),$scope.canShowUtterances=!0},$scope.canShowBatchTesting=!1,$scope.showBatchTesting=function(){openModalByClass(".batchtesting-form"),$scope.canShowBatchTesting=!0},$scope.canShowontology=!1,$scope.openOntologyModel=function(noClose){function proceedToOpenOntology(){openModalByClass(".ontology-form"),$scope.canShowontology=!0,$(".kore-chat-window")&&$(".kore-chat-window").length&&!$(".kore-chat-window").hasClass("minimize")&&$(".kore-chat-window .minimize-btn").trigger("click")}noClose?$scope.lockTask($scope.knowledgeTasks[0],prepareTimer,"knowledgeTask").then(function(res){proceedToOpenOntology()},function(err){}):($scope.closeFullPageModal(),proceedToOpenOntology())},$scope.$on("openOntology",function(){$scope.openOntologyModel(!0)}),$scope.isEligibleForDeleteBot=function(stream){var createdBy=_.isObject(stream.createdBy)?stream.createdBy._id:stream.createdBy;return"universalbot"===$scope.selectedStream.type?$applicationService.userInfo().userId===createdBy&&"private"===$scope.selectedStream.visibility.namespace:$applicationService.userInfo().userId===createdBy};var _dialogSettingsCB={};if(_dialogSettingsCB.updateFlowData=function(flowData){$scope.flowtaskObj=flowData},$scope.openDialogSettings=function(flowtask){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/forms/dialog-settings/dialog-settings.html",controller:"DialogSettings",resolve:{config:function(){return{dialogObj:flowtask,cb:_dialogSettingsCB,load:load}}}})},$scope.exportDialog=function(flowtaskId){BTFlowtaskService.exportDialog($workflowService.selectedStream()._id,flowtaskId).then(function(res){writeAndDownloadDialog(res.data.name+".json",JSON.stringify(res.data))})},$scope.storeActiveFlowTask=function(flowtask){$scope.activeFlowTask=flowtask},$scope.importObj={},$scope.importObj.importDialog=null,$scope.readDialog=function(){if($scope.importedDialogName=$scope.importObj.importDialog.name,$scope.importedDialogName){var _ext=$scope.importedDialogName.substring($scope.importedDialogName.lastIndexOf("."));if(".json"!==_ext)return NotificationService.notify(i18n.i18nString("upload_json"),"error"),void($scope.fileExtensionError=!0);$scope.fileExtensionError=!1,$scope.dialogRequiredError=!1}var reader=new FileReader;reader.readAsText($scope.importObj.importDialog),reader.onload=function(e){var data=reader.result;!data||data&&!data.length?(NotificationService.notify(i18n.i18nString("upload_valid"),"error"),$scope.fileEmptyError=!0):$scope.fileEmptyError=!1,$scope.importedDialogData=data}},$scope.confirmImport=function(){if(!$scope.importedDialogData)return $scope.dialogRequiredError=!0,void NotificationService.notify(i18n.i18nString("dialog_file_req"),"error");$scope.isWorkProgress=!0,$scope.loaderMessage="Importing...";var _currFlowtaskID=$scope.activeFlowTask._id;("published"===$scope.activeFlowTask.state||"suspended"===$scope.activeFlowTask.state)&&(_currFlowtaskID=$scope.activeFlowTask.child[0]._id),BTFlowtaskService.importDialog($workflowService.selectedStream()._id,_currFlowtaskID,$scope.importedDialogData).then(function(res){$scope.doneImporting=!0,$workflowService.flowtaskInfo(res.data),$scope.flowtaskObj=res.data,$scope.importModalTitle=i18n.i18nString("bt_streams_successful"),$scope.connections=getConnections(res.data.nodes),$scope.importDialogHeader=i18n.i18nString("dialog_backup_success"),$scope.importResults="Analyzing file . . . \n\n"+$scope.flowtaskObj.nodes.length+" Nodes found and "+$scope.connections.length+" connections found \n\n Checking data integrity . . . \n\n No issues found. \n\n Replacing current dialog with imported data . . . \n\n All nodes and connections imported successfully!",$scope.isWorkProgress=!1,$scope.loaderMessage=i18n.i18nString("working_on_it"),$scope.displayMode="edit"},function(error){$scope.doneImporting=!0;var _msg=error.data.errors[0].msg;$scope.importDialogHeader=i18n.i18nString("dialog_backup_failure"),$scope.importResults=_msg,$scope.isWorkProgress=!1,$scope.loaderMessage=i18n.i18nString("working_on_it"),$scope.importModalTitle=i18n.i18nString("failed"),NotificationService.notify(_msg,"error")})},$scope.finishImporting=function(){$scope.doneImporting=!1,$scope.importedDialogName=void 0,$scope.importedDialogData=void 0,$scope.importObj.importDialog=void 0,$scope.importDialogHeader=i18n.i18nString("import_dialog_desc"),$scope.importModalTitle=i18n.i18nString("bt_streams_a_dialog"),$scope.fileExtensionError=!1,$("#flowtask_imports").modal("hide"),load()},$scope.onFinishSetup=function(type){BTFlowtaskService.finishFlowtask(_selectedStream._id,_dialogObj._id).then(function(res){NotificationService.notify(i18n.i18nString("dialog_configured"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})},$scope.availableActions={inProgress:{view:!0,edit:!0,editbasic:!1,clone:!1,upgrade:!1,map:!1,versions:!1,"delete":!0},configured:{view:!0,edit:!0,editbasic:!1,clone:!0,upgrade:!1,map:!1,versions:!1,"delete":!0,logs:!0},upgradeInProgress:{view:!0,edit:!0,editbasic:!1,clone:!1,upgrade:!1,map:!1,versions:!1,"delete":!0},published:{view:!0,edit:!1,editbasic:!0,clone:!0,upgrade:!0,map:!0,versions:!0,"delete":!1,command:!0,logs:!0,unpublish:!0},awaitingApproval:{view:!0,edit:!0,editbasic:!1,clone:!0,upgrade:!1,map:!1,versions:!1,"delete":!0,recall:!0},rejected:{view:!0,edit:!0,editbasic:!1,clone:!0,upgrade:!1,map:!1,versions:!1,"delete":!0},suspended:{view:!0,edit:!1,editbasic:!0,clone:!0,upgrade:!0,map:!1,versions:!0}},$scope.getAvailability=function(state,action){return $scope.availableActions[state][action]},$scope.setDisplayTabId=function(id){$(".kore-chat-window")&&$(".kore-chat-window").length&&!$(".kore-chat-window").hasClass("minimize")&&$(".kore-chat-window .minimize-btn").trigger("click"),$(id).hasClass("in")?$scope.displayTabId="":$scope.displayTabId=id,("#synonyms"==id||"#patterns"==id)&&($scope.displayTabId=id)},$scope.nlp={testText:""},$scope.$watch("$root.isManaged",function(){getConnectorsList()}),$scope.selectedStream={},$scope.enterpriseUser=$rootScope.licenseType,$scope.eligibleForPublishing=$scope.enterpriseUser||$rootScope.wfAdmin,$scope.isEligibleForAuthorization=function(){return"universalbot"!==$scope.selectedStream.type},$scope.isUniversalBot=function(){return"universalbot"===$scope.selectedStream.type},$scope.isEligibleForSdkConf=function(){return"universalbot"!==$scope.selectedStream.type},$scope.isEligibleToManageBot=function(stream){var createdBy=_.isObject(stream.createdBy)?stream.createdBy._id:stream.createdBy;return $rootScope.isManaged&&$applicationService.userInfo().userId===createdBy&&"universalbot"!==$scope.selectedStream.type},$scope.isEligibleForPublishing=function(){return $scope.eligibleForPublishing=$rootScope.isManaged||$rootScope.wfAdmin,$scope.eligibleForPublishing},$scope.isWorkFlowAdmin=function(){return $scope.isWFAdmin=$rootScope.wfAdmin,$scope.isWFAdmin},$scope.isEligibleToShare=function(){return $rootScope.isManaged},$scope.generateRandomId=function(prefix){$scope.stIconv=prefix+""+uuid4.generate()},$scope.generateRandomId(),$scope.isEligibleToReleaseLock=function(userId){return $applicationService.userInfo().userId===userId},$scope.isEligibleToDelete=function(task){return task&&"published"!==task.state&&"suspended"!==task.state?!0:$rootScope.wfAdmin},$scope.publishViews={},Object.defineProperty($scope.publishViews,"initialView",{get:function(){var value=!1;return $scope.publishViews.hasPublishedTasks=!1,$scope.publishViews.newTasksCount=0,$scope.publishViews.upgradeCount=0,$scope.publishViews.message="",$scope.alerts.map(function(alert){"configured"===alert.state&&(value=!0,$scope.publishViews.newTasksCount++),("published"===alert.state||"awaitingApproval"===alert.state)&&($scope.publishViews.hasPublishedTasks=!0),(alert.child||[]).map(function(child){"configured"===child.state&&(value=!0,$scope.publishViews.upgradeCount++),("published"===child.state||"awaitingApproval"===child.state)&&($scope.publishViews.hasPublishedTasks=!0)})}),$scope.actions.map(function(action){"configured"===action.state&&(value=!0,$scope.publishViews.newTasksCount++),("published"===action.state||"awaitingApproval"===action.state)&&($scope.publishViews.hasPublishedTasks=!0),(action.child||[]).map(function(child){"configured"===child.state&&(value=!0,$scope.publishViews.upgradeCount++),("published"===child.state||"awaitingApproval"===child.state)&&($scope.publishViews.hasPublishedTasks=!0)})}),$scope.reports.map(function(action){"configured"===action.state&&(value=!0,$scope.publishViews.newTasksCount++),("published"===action.state||"awaitingApproval"===action.state)&&($scope.publishViews.hasPublishedTasks=!0),(action.child||[]).map(function(child){"configured"===child.state&&(value=!0,$scope.publishViews.upgradeCount++),("published"===child.state||"awaitingApproval"===child.state)&&($scope.publishViews.hasPublishedTasks=!0)})}),$scope.flowtasks.map(function(flowTask){"configured"===flowTask.state&&(value=!0,$scope.publishViews.newTasksCount++),("published"===flowTask.state||"awaitingApproval"===flowTask.state)&&($scope.publishViews.hasPublishedTasks=!0),(flowTask.child||[]).map(function(child){"configured"===child.state&&(value=!0,$scope.publishViews.upgradeCount++),("published"===child.state||"awaitingApproval"===child.state)&&($scope.publishViews.hasPublishedTasks=!0)})}),$scope.publishViews.message=$scope.publishViews.upgradeCount>0||$scope.publishViews.newTasksCount>0?$scope.publishViews.upgradeCount>0&&$scope.publishViews.upgradeCount>0?" ("+getSingleorPluralMessage($scope.publishViews.upgradeCount," upgrade ")+" , "+getSingleorPluralMessage($scope.publishViews.newTasksCount," new ")+" )":$scope.publishViews.upgradeCount>0?" ("+getSingleorPluralMessage($scope.publishViews.upgradeCount," upgrade ")+"  )":" ( "+getSingleorPluralMessage($scope.publishViews.newTasksCount," new ")+" )":"",!value&&$scope.isEligibleForPublishing()},set:angular.noop,enumerable:!0,configurable:!0}),Object.defineProperty($scope.publishViews,"botPublish",{get:function(){return $rootScope.wfAdmin&&!$scope.publishViews.initialView&&!$scope.selectedStream.isSolutionBot&&!$scope.publishViews.hasPublishedTasks},set:angular.noop,enumerable:!0,configurable:!0}),Object.defineProperty($scope.publishViews,"solutionBotPublish",{get:function(){return!$scope.publishViews.initialView&&!$scope.publishViews.botPublish&&$scope.isEligibleForPublishing()&&$scope.isWorkFlowAdmin()&&$scope.selectedStream.isSolutionBot&&"sample"!==$scope.selectedStream.botType},set:angular.noop,enumerable:!0,configurable:!0}),Object.defineProperty($scope.publishViews,"standardBotPublish",{get:function(){return!$scope.publishViews.initialView&&!$scope.publishViews.botPublish&&$scope.isEligibleForPublishing()&&!$scope.selectedStream.isSolutionBot&&"sample"!==$scope.selectedStream.botType},set:angular.noop,enumerable:!0,configurable:!0}),Object.defineProperty($scope.publishViews,"sampleBotPublish",{get:function(){return!$scope.publishViews.initialView&&!$scope.publishViews.botPublish&&$scope.isEligibleForPublishing()&&$scope.isWorkFlowAdmin()&&"sample"===$scope.selectedStream.botType},set:angular.noop,enumerable:!0,configurable:!0}),$scope.isSelectedLanguageApproved=function(task){return-1!==$.inArray($workflowService.currentLanguage(),task.approvedLanguages||[])?!0:!1},$scope.allLanguagesApproved=function(task){return(task.approvedLanguages||[]).length==($scope.selectedStream.supportedLanguages||[]).length?!0:!1},security.isAuthenticated())load();else var unregisterEvent=$rootScope.$on("security:authenticated",function(){load(),unregisterEvent()});$scope.removeModalOpenClass=function(){$timeout(function(){isEleVisible("#termsConditions")||$("body").removeClass("modal-open"),$("body").removeClass("bt-modal-open")})},$scope.launchMigrationTool=function(){var activeUser=localstore.getAuthData().currentAccount;activeUser.environment=window.location.hostname;var _encryptedUserDetails="#"+base64.encode(JSON.stringify(activeUser)),_link="http://52.86.255.9/#/login/"+_encryptedUserDetails;window.open(_link,"_blank")},$scope.isTaskAvailable=function(taskName){return $scope[taskName].length>0},$scope.anyTaskAvailable=function(){return $scope.alerts.length||$scope.actions.length||$scope.reports.length||$scope.flowtasks.length||$scope.knowledgeTasks.length||$scope.mappings.length},$scope.organizeDataBasedOnAlerts=function(){$rootScope.hasPublishedAlerts=!1,$rootScope.hasPublishedAlerts=_.find($scope.alerts,function(alert){return"published"==alert.state||"awaitingApproval"==alert.state})&&!0,canAccessService(),isInMarket($scope.alerts),$workflowService.alerts($scope.alerts),triggerTaskLockReleasing()},$rootScope.$on("insertOrUpdateTask",function(event,taskType,taskObject,isNewTask){"flowTask"===taskType&&($scope.workingTaskType=""),$scope.updateTasks(taskType,taskObject,isNewTask)}),$rootScope.$on("showContent",function(){$scope.showContent=!0}),$scope.updateTasks=function(taskType,taskObject,isNewTask){$rootScope.$broadcast("reloadTasks",taskType),clearActiveClass(!0),$workflowService.navigateTabIndex($scope.navigateTabIndex),showActiveTab()},$scope.organizeDataBasedOnActions=function(){var actions=[];actions=$scope.actions.concat($scope.reports),$rootScope.hasPublishedActions=!1,$rootScope.hasPublishedActions=_.find(actions,function(action){return"published"==action.state||"awaitingApproval"==action.state})&&!0,canAccessService(),isInMarket(actions),$workflowService.actions(actions),triggerTaskLockReleasing()},$scope.getKnowledgeTasks=getKnowledgeTasks;var updateIDPData=function(accountDetails){var idpDetails=angular.copy($scope.idpConfigs);accountDetails?$.each(idpDetails,function(j,idpData){idpData.name===accountDetails.idp&&(idpDetails[j].account=[])}):$.each($scope.account1,function(i,accountData){$.each(idpDetails,function(j,idpData){idpData.name===accountData.idp&&(idpDetails[j].account=[accountData])})}),$scope.idpConfigs=angular.copy(idpDetails)};$scope.testIdp=function(index){$scope.btTestFormApi.afterInit=function(){$scope.btTestFormApi.test()},$scope.btTestFormApi.afterTest=function(success){success?NotificationService.notify(i18n.i18nString("auth_test_success"),"success"):NotificationService.notify(i18n.i18nString("auth_test_failed"),"error"),$scope.btTestFormApi.close()},$scope.btTestFormApi.onNewAccounts=function(accounts){$scope.account1=accounts,$scope.updateTryMode(!0),updateIDPData()},$scope.btTestFormApi.init({_id:$scope.idpConfigs[index]._id,type:"idp",testFor:"idp",isTryOutUserConnection:"true"})},$scope.changeAuthorization=function(accountAuth,index){BTIdpService.deleteStreamUserAccount(accountAuth[0].streamAccountId).then(function(){$scope.testIdp(index)},function(){})},$scope.streamSearchQuery="",$scope.getEncodedSearchName=function(searchQuery){return searchQuery&&searchQuery.trim()?$scope.getTextEncoded(searchQuery):void 0},$scope.getTextEncoded=function(name){return name.replace(/</g,"&lt;").replace(/>/g,"&gt;")},$scope.updateScroll=function(){PerfectScrollbar.update($(".sreamlist")[0]),$(".sreamlist").scrollTop(0)},$scope.getTextIncludingTags=function(name){return name?name.replace(/&lt;/g,"<").replace(/&gt;/g,">"):""},$scope.saveAutoTrainMLStatus=function(){var _payload={enableAutoUtteranceAddition:$scope.autotrainData.enableAutoUtteranceAddition};saveBotStream(_payload)},$scope.publishUniversalBot=function(){function triggerPublish(){var selectedBots=$scope.configuredBots.filter(function(bot){return bot.linked});if(selectedBots&&selectedBots.length){var linkPayload={bots:_.pluck(selectedBots,"_id")};BTStreamsService.linkOrUnlinkBots($scope.selectedStream._id,"publish",linkPayload).then(function(res){NotificationService.notify(i18n.i18nString("bt_streams_bots_published_success"),"success"),load()},function(err){})}else NotificationService.notify(i18n.i18nString("please_select_atleast_one_bot"),"error")}checkForChannels(triggerPublish)},$scope.createApp=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",resolve:{avalSreams:function(){return $scope.avalSreams}}})},$scope.goBack=function(modalClass){closeModalByClass(modalClass),$(".panel-heading").addClass("collapsed"),$(".panel-collapse.in").collapse("hide")},$scope.resetDisplayTabID=function(){$scope.displayTabId=""},$scope.closeVersionModal=function(){$scope.activeTask=null,$scope.dialogMode=null,closeModalByClass(".version-form")},$scope.enableOrDisableTryMode=function(mode,accountED,index){mode||!$scope.authInfo||accountED&&accountED.length&&"active"===$accountED[0].status?$scope.updateTryMode(!mode,index):$scope.testIdp(index)},$scope.updateTryMode=function(enable,indexParam){var payLoad={canTryOut:enable};BTStreamsService.updateTryMode($scope.selectedStream._id,payLoad).then(function(res){console.log(res),$scope.isTryModeUpdated=!0,$scope.selectedStream.canTryOut=enable},function(err){console.log(err)})},$rootScope.$on("app.created",function(event,args){getApps()}),$rootScope.$on("app.updated",function(event,args){getApps()}),$scope.triggerAppCreation=function(){$scope.selectView("apps"),$scope.createApp()},$scope.createApp=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Create"}}}})},$scope.editApp=function(app){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-create/bt-app-create.html",controller:"BTAppCreateCtrl",windowClass:"modal-kr",resolve:{avalSreams:function(){return $scope.avalSreams},config:function(){return{type:"Edit",app:app}}}})},$scope.viewApp=function(app){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-app-view/bt-app-view.html",controller:"BTAppViewCtrl",windowClass:"modal-kr",resolve:{config:function(){return{type:"View",app:app}}}})},$scope.deleteApp=function(app){function deleteAppRequest(){var svcname="bt.apps.delete";$applicationService.userInfo().appControls&&$applicationService.userInfo().appControls.isManaged&&(svcname="bt.org.apps.delete"),$translator.translate(svcname,{appId:app.clientId},{}).then(function(res){res&&200===res.status?(getApps(),NotificationService.notify(i18n.i18nString("app_deleted"),"success",1500)):alert(i18n.i18nString("error_alert"));
},function(errRes){alert(i18n.i18nString("error_alert"))})}NotificationService.alert(i18n.i18nString("delete_app_desc"),deleteAppRequest,[!0])},$rootScope.$on("taskCreateUpdate",function(){}),$scope.selectApp=function(stream,updateLanguage){$scope.showContent=!1,$scope.activeTask=null,$scope.activeEntityFlow=null,$scope.dialogMode=null,$scope.showSolutionBotSetup=!1,$("body").removeClass("bt-modal-open"),$scope.nlTraceData=[],stream&&(pollFactory.unSubscribeAll(),$rootScope.$emit("stopAutoTrainStatusPoll"),$rootScope.$emit("stopSpeechTrainStatusPoll"),$workflowService.selectedStream(stream),$workflowService.streamType(stream.type||"taskbot"),$scope.selectedStream=stream,clearActiveClass(),openDialogTaskAccordion(),stream.active=!0,$scope.showTestBot=!1,stream.state&&"setup"===stream.state&&($scope.showSolutionBotSetup=!0),$("body").removeClass("modal-open"),$scope.closeDebugConsolePanel(),$q.all([getAlerts(stream._id),getActions(stream._id),getKnowledgeTasks(stream._id),getStream(stream),getFlowTasks(stream._id),getMappings(stream._id),getAlertDialogMappings(stream._id)]).then(function(res){$scope.navigateTabIndex=".tasks-pane",$workflowService.navigateTabIndex($scope.navigateTabIndex),showActiveTab(),$timeout(function(){$(window).trigger("resize")})}),$(window).scrollTop(0),$scope.destroyChatBot(),$(".myTabs").scrollTop(0),updateLanguage||$scope.changeBotLanguage(stream.defaultLanguage))},$scope.enableNlpVerify=function(){var enable=!1;return $scope.alerts=_.isArray($scope.alerts)?$scope.alerts:[],$scope.actions=_.isArray($scope.actions)?$scope.actions:[],$scope.reports=_.isArray($scope.reports)?$scope.reports:[],$scope.alerts.map(function(alert){("configured"==alert.state||"published"==alert.state)&&(enable=!0)}),$scope.actions.map(function(action){("configured"==action.state||"published"==action.state)&&(enable=!0)}),$scope.reports.map(function(action){("configured"==action.state||"published"==action.state)&&(enable=!0)}),enable},$scope.manageChatResponse=function(){$location.path(window.appConfig.CONTEXT_PATH+"/nlp/"+$scope.selectedStream._id+"/response/edit/")},$scope.viewActionLogs=function(action){$scope.dialogMode="logs",openModalDialog(action,"action")},$scope.viewAlertLogs=function(alert){$scope.dialogMode="logs",openModalDialog(alert,"alert")},$scope.manageChatResponse=function(){$location.path(window.appConfig.CONTEXT_PATH+"/nlp/"+$scope.selectedStream._id+"/response/edit/")},$scope.selectStream=function(stream){$workflowService.selectedStream(stream),$location.path(window.appConfig.CONTEXT_PATH+"/workflows")},$scope.openBotChooser=function(botType){$scope.bottype=botType,$scope.initializeCreateBot=!0,openModalByClass(".stream-create-form")},$scope.onCreateNewBot=function(){closeModalByClass(".stream-create-form"),$scope.initializeCreateBot=!1,$workflowService.navigateTabIndex(".tasks-pane"),$scope.navigateTabIndex=".tasks-pane",$(".tasks-pane").addClass("active").siblings().removeClass("active"),load()},$scope.onCancelBotCreation=function(){$scope.initializeCreateBot=!1,closeModalByClass(".stream-create-form")},$scope.initiateBotCreation=function(type){closeModalByClass(".bot_type"),$("body").removeClass("modal-open"),$timeout(function(){$workflowService.streamType(type),$location.path(window.appConfig.CONTEXT_PATH+"/streamcreate")})},$scope.closeBotChooser=function(){$scope.bottype="taskbot",closeModalByClass(".bot_type"),$("body").removeClass("modal-open")},$scope.openModeSelector=function(){$scope.isEligibleForPublishing()&&$scope._constants_.config.ENABLE_UNIVERSAL_BOT?$scope.modeSelectorCallback.openModeSelectorModal():$scope.openBotChooser("taskbot")},$scope.verifyNlp=function(){$workflowService.nlpStream($scope.selectedStream),$location.path(window.appConfig.CONTEXT_PATH+"/nlp/bots/"+$scope.selectedStream._id+"/chatsettings")},$scope.viewChangeLog=function(selectedStream){$workflowService.selectedStream($scope.selectedStream),$location.path(window.appConfig.CONTEXT_PATH+"/bot/changelog")},$scope.initiateStreamCreation=function(){$location.path(window.appConfig.CONTEXT_PATH+"/streamcreate")},$scope.initiateWorkflowCreation=function(type,navigate){return $workflowService.workflowType(type),$workflowService.mpAlertInfo({}),$workflowService.alertInfo({}),$workflowService.actionInfo({}),$workflowService.mpActionInfo({}),$workflowService.currentStep(3),$workflowService.alertData({}),$workflowService.authData({}),$workflowService.requestData({}),$workflowService.responseData({}),$workflowService.settingsData({}),"knowledge"===type?void $location.path(window.appConfig.CONTEXT_PATH+"/knowledgecreate"):"flowtask"===type?void $location.path(window.appConfig.CONTEXT_PATH+"/flowTask/new"):void(navigate||$location.path(window.appConfig.CONTEXT_PATH+"/new"))},$scope.checkTaskAvailability=function(){return $scope.alerts.length||$scope.actions.length||$scope.flowtasks.length||$scope.knowledgeTasks.length||$scope.reports.length},$scope.initiateChatBot=function(){if($scope.resetDebugConsole(),$scope.checkTaskAvailability()&&$scope.showTestBot||"universalbot"===$scope.selectedStream.type&&$scope.linkedBots.length>0)$rootScope.$emit("botTestStart",$scope.selectedStream,void 0,$scope.pushDebugInfo,debugConsoleTrigger,null,$scope.pushHistoryInfo),setDomPropToDebugConsole();else{if("universalbot"===$scope.selectedStream.type)return void NotificationService.notify(i18n.i18nString("one_linkedbot"),"warning");NotificationService.notify(i18n.i18nString("bt_streams_atleast_one_bot_in_published_state"),"warning")}};var _element=$("#debugConsoleRT"),setDomPropToDebugConsole=function(){$timeout(function(){$("#debugConsoleRT .flowTaskDebugConsolePanel").draggable({handle:".nav.nav-tabs",containment:"document",cancel:".minimized"}).resizable({containment:"document",minWidth:430,maxWidth:800,minHeight:400,handles:"e, s, se",stop:onDebugResizeStop,resize:function(event,ui){var _minimized=ui.size.width<800,_ele=$(event.target).find(".toggleDebugConsolePanelSize");_ele&&(_ele.toggleClass("fa-compress",!_minimized),_ele.toggleClass("fa-expand",_minimized))}})})};$scope.resetDebugConsole=function(){$scope.debugInfo=[],$scope.debugContext="",$scope.debugRaw={},$scope.nlTraceData=[]},$scope.openDebugConsole=function(){$scope.isDebugConsolePanelOpened=!0,$timeout(function(){var _ele=_element.find(".flowTaskDebugConsolePanel");$(_ele.selector).css("left","0px").css("top","58px").css("width","800px"),$scope.showNlTraceInitContent()})};var emptySpace=String.fromCharCode(160),getSpaceByCount=function(count){for(var tempEmptySpace="",i=0;count>i;i++)tempEmptySpace+=emptySpace;return tempEmptySpace};$scope.showNlTraceInitContent=function(){$scope.nlTrace=["> Initailizing",""],$scope.nlTrace.push("> Tasks Loaded...");var taskList=[].concat($scope.alerts,$scope.actions,$scope.flowtasks),types={a:"Action",l:"Alert"},getTaskTypeByID=function(taskid){var taskType=types[taskid[0]];return taskType||-1!==taskid.indexOf("dg-")&&(taskType="Dialog"),taskType||""},getTaskName=function(taskData){return"published"!==taskData.state&&"suspended"!==taskData.state&&"rejected"!==taskData.state&&"private"!==$workflowService.selectedStream().visibility.namespace?taskData.name+"   @development":taskData.name};$.each(taskList,function(i,task){if($scope.nlTrace.push(getSpaceByCount(10)+""+getTaskTypeByID(task._id)+" Task   '"+getTaskName(task)+"'   "+(task.version||"")),task.isParent){var childTask=task.child[0];$scope.nlTrace.push(getSpaceByCount(10)+""+getTaskTypeByID(childTask._id)+" Task   '"+getTaskName(childTask)+"'   "+(childTask.version||""))}}),$.each($scope.knowledgeTasks,function(i,knowledgeData){$scope.nlTrace.push(getSpaceByCount(10)+"Knowledge Task   '"+knowledgeData.name+"'   "+(knowledgeData.version||""))}),$scope.nlTrace.push("> All Tasks Loaded Successfully"),$scope.nlTrace.push("> Ready for utterances")};var _scoringArray=["taskNameAnalysis","penaltyScoring","bonusScoring","wordScoring"],_keysToExclude=["activityType","debugTitle","foundInSentence"];$scope.pushHistoryInfo=function(debug){pushHistory(debug)},$scope.pushDebugInfo=function(debug){var tempDebug=angular.copy(debug);if(tempDebug.NLAnalysis&&tempDebug.NLAnalysis.length>0){$scope.nlTraceData=[],$scope.nlTraceData.push({type:"String",title:" > NL analysis",value:""});var recObjNL=function(spaceToAdd,obj){var initSpace=spaceToAdd;Object.keys(obj).length>0?$.each(obj,function(k,tempObj){void 0!==tempObj&&(tempObj&&tempObj.constructor===Object?($scope.nlTraceData.push({type:"Object",title:initSpace+" > "+k,value:""}),recObjNL(initSpace+getSpaceByCount(8),tempObj)):tempObj&&tempObj.constructor===Array?($scope.nlTraceData.push({type:"Array",title:initSpace+" > "+k,value:""}),recObjNL(initSpace+getSpaceByCount(8),tempObj)):-1===$.inArray(k,_keysToExclude)&&$scope.nlTraceData.push({type:"String",title:initSpace+k,value:tempObj}))}):-1===$.inArray(k,_keysToExclude)&&$scope.nlTraceData.push({type:"String",title:initSpace+"---",value:"---"})};$.each(tempDebug.NLAnalysis,function(i,nlAnalalysis){nlAnalalysis&&Object.keys(nlAnalalysis).length>0&&$.each(nlAnalalysis,function(k,obj){obj&&"history"!==k?obj.constructor===Object?(-1!==$.inArray(k,_scoringArray)?$scope.nlTraceData.push({type:"Object",title:" > "+k+getSpaceByCount(2)+"("+obj.debugTitle.slice(obj.debugTitle.indexOf(":")+2)+")",value:""}):$scope.nlTraceData.push({type:"Object",title:" > "+k,value:""}),recObjNL(getSpaceByCount(10),obj)):obj.constructor===Array?($scope.nlTraceData.push({type:"Array",title:" > "+k,value:""}),recObjNL(getSpaceByCount(10),obj)):-1===$.inArray(k,_keysToExclude)&&$scope.nlTraceData.push({type:"String",title:" > "+k,value:obj,noChild:!0}):0===obj?-1===$.inArray(k,_keysToExclude)&&$scope.nlTraceData.push({type:"String",title:k,value:obj}):(null===obj||void 0===obj)&&-1===$.inArray(k,_keysToExclude)&&$scope.nlTraceData.push({type:"String",title:k,value:"null"})})})}"contextUpdate"===tempDebug.type&&(debug=debug.context||{},$scope.debugRaw=debug,$scope.debugContext=debug),"contextUpdate"===tempDebug.type&&tempDebug.context.scriptErrorMeta&&$scope.validateJs(tempDebug),$timeout(function(){$scope.$digest()},350)},$scope.closeDebugConsolePanel=function(){$scope.isDebugConsolePanelOpened=!1;var _ele=_element.find(".flowTaskDebugConsolePanel");$timeout(function(){$(_ele.selector).css("width","")},500)},$scope.isChatWindowOpen=function(){return $(".kore-chat-window").is(":visible")},$scope.isSolutionBotSetup=!1,$scope.setupSolutionBot=function(){$scope.showSolutionBotSetup&&($scope.isSolutionBotSetup=!0,$scope.openFullPageModal(3),$("#btFullpageModal").off("hidden.bs.modal").on("hidden.bs.modal",function(){isEleVisible("#termsConditions")||$("body").removeClass("modal-open"),$("body").removeClass("bt-modal-open"),$scope.isSolutionBotSetup=!1}))},$scope.setupSampleBot=function(){$scope.showSolutionBotSetup&&($scope.openFullPageModal(3,"createBot"),$workflowService.selectedSampleBot($scope.selectedStream))},$scope.unlockTask=function(task){$scope.selectedTask=task,$timeout(function(){openModalByClass(".unlock-sol-bot")})},$scope.confirmUnlock=function(){var task=$scope.selectedTask;if($scope.taskUnlocking=!0,"a"===task._id.substring(0,1))BTActionsService.unlockBTAction(task._id,$workflowService.selectedStream()._id).then(function(res){closeModalByClass(".unlock-sol-bot"),$("body").removeClass("modal-open"),$route.reload(),$scope.taskUnlocking=!1},function(res){NotificationService.notify(i18n.i18nString("confirm_unlock")),$scope.taskUnlocking=!1});else if("l"===task._id.substring(0,1))BTAlertsService.unlockBTAlert(task._id,$workflowService.selectedStream()._id).then(function(res){closeModalByClass(".unlock-sol-bot"),$("body").removeClass("modal-open"),$route.reload(),$scope.taskUnlocking=!1},function(res){NotificationService.notify(i18n.i18nString("confirm_unlock")),$scope.taskUnlocking=!1});else{var userId=$applicationService.userInfo().userId,requestData={resources:[{resourceType:"dialog",resourceId:task._id}]};BTActionsService.unlockDialog(task._id,$workflowService.selectedStream()._id,userId,requestData).then(function(res){closeModalByClass(".unlock-sol-bot"),$("body").removeClass("modal-open"),$route.reload(),$scope.taskUnlocking=!1},function(res){NotificationService.notify(i18n.i18nString("confirm_unlock")),$scope.taskUnlocking=!1})}},$scope.duplicateTask=function(task){},$scope.destroyChatBot=function(){$rootScope.$emit("botTestEnd",$scope.selectedStream)},$scope.createChannel=function(){$location.path(window.appConfig.CONTEXT_PATH+"/stream/"+$workflowService.selectedStream()._id+"/channel")},$scope.editChannel=function(channel){function editChannel(){$location.path(window.appConfig.CONTEXT_PATH+"/stream/"+$workflowService.selectedStream()._id+"/channel/"+channel.type)}$workflowService.selectedStream();editChannel()},$scope.$on("streamUpdate",function(){angular.extend($scope.streams,$workflowService.streamsAll()),$scope.selectedStream=$workflowService.selectedStream(),$scope.generateRandomId(),$.each($scope.streams,function(i,streamDetails){streamDetails._id===$scope.selectedStream._id&&($scope.streams[i].active=!0)}),$scope.$broadcast("updateLinkableBots"),$timeout(function(){retainScrollPosition()},2e3)}),$rootScope.$on("triggerSelectApp",function(e,reload){$scope.streams=$workflowService.streamsAll(),$scope.selectedStream=$workflowService.selectedStream();for(var i=0;i<$scope.streams.length;i++)$scope.streams[i]._id===$scope.selectedStream._id&&($scope.selectApp($scope.streams[i],reload),retainScrollPosition())}),$rootScope.$on("triggerSolutionBotSetup",function(){$scope.showSolutionBotSetup=!1,$scope.showTestBot=!1,$scope.currentLanguage=$workflowService.currentLanguage()}),$scope.$on("triggerHelpLinkUpdate",function(){$scope.isHelpLinkClicked=!0,$timeout(function(){$scope.isHelpLinkClicked=!1})}),$rootScope.$on("delaytriggerSelectApp",function(){setTimeout(function(){$rootScope.$broadcast("triggerSelectApp",!1)},200)}),$scope.isCollapsed=function(ele){return $(ele).hasClass("collapsed")&&!$scope.isHelpLinkClicked},$scope.isDefaultDialogExpanded=function(ele){$scope.defaultDialogExpanded=$(ele).hasClass("collapsed")},$scope.onBotLinkingCompleted=function(){closeModalByClass(".bots-selection-form"),load()},$scope.enableordisableChannel=function(channel,enable){function modifyChannelStatus(){channel.enable=enable;var payload={channels:arrangeChannels(channel)};BTStreamsService.createOrEditChannel($scope.selectedStream._id,channel.type,channel).then(function(res){$workflowService.selectedStream().channels=payload.channels,NotificationService.notify(enable?getChannelName(channel.type)+" channel enabled":getChannelName(channel.type)+" channel disabled","info")},function(err){console.log("error")})}enable?modifyChannelStatus():NotificationService.alert(getChannelMessage(channel),modifyChannelStatus,[!0])},$scope.taskCreateCallback.openCreateFlowDialog=function(){$scope.activeEntityFlow={},openModalByClass(".flowtask-create-form")},$scope.modeSelectorCallback.onModeSelected=function(selectedMode){$scope.openBotChooser(selectedMode)},$scope.onFlowDialogClosed=function(reload){$scope.activeEntityFlow=null,isEleVisible("#termsConditions")||$("body").removeClass("modal-open"),$("body").removeClass("bt-modal-open"),closeModalByClass(".flowtask-create-form"),$scope.closeFullPageModal(),reload&&(load(),openDialogTaskAccordion())},$scope.deleteChannel=function(index){var channel=$scope.selectedStream.channels[index],msg=i18n.i18nString("bt_chnl_bot_will_not_available_noty",{dyn:channel.type});NotificationService.alert(msg,deleteChannel,arguments)},$workflowService.registerModalHiddenEvent(),$scope.editStream=function(stream){function editStream(){$workflowService.selectedStream(stream),$location.path("bt/streamedit/"+stream._id)}editStream()},$scope.deleteStream=function(stream){NotificationService.alert(i18n.i18nString("delete_stream"),deleteStream,arguments)},$scope.helpUrl="http://google.com",$scope.workflows={};$scope.lockTask=function(entity,prepareTimer,type){return TimerNotification.removeTimer(entity._id),BTStreamsService.createLock(entity._id).then(function(res){var config=res.data;config.lockCreatedTime=new Date(config.locktime),config.locktime=new Date(config.locktime),config.locktime.setMinutes(config.locktime.getMinutes()+$scope._constants_.timerTimeoutInMinutes),TimerNotification.registerTimer(prepareTimer(config,entity,type))},function(err){return showLockErrorMessage(err.data,err),$q.reject(err)})},$scope.releaseLock=function(type,entity,hideMsg){return BTStreamsService.releaseLock(entity._id).then(function(res){$rootScope.$broadcast("reloadTasks",type),hideMsg||NotificationService.notify(i18n.i18nString("release_lock_success",{dyn:entity.name}),"success")},function(err){return hideMsg||NotificationService.notify(i18n.i18nString("release_lock_failure",{dyn:entity.name}),"error"),$q.reject({data:{error:i18n.i18nString("lock_release_failed")}})})},$scope.$on("reloadTasks",function(evt,type){"alert"==type?getAlerts($workflowService.selectedStream()._id):"action"==type||"report"==type?getActions($workflowService.selectedStream()._id):"knowledgeTask"==type?getKnowledgeTasks($workflowService.selectedStream()._id):"flowTask"==type&&getFlowTasks($workflowService.selectedStream()._id)}),$rootScope.$on("onedittask",function(event,entity,type){$scope.editWorkflow(entity,type,"",!0)}),$scope.removeLoader=function(){$("#noty_center_layout_container").empty()},$scope.editWorkflow=function(entity,type,isFromUpgrade,isFromCreation){function triggerEdit(){"knowledgeTask"===type||isFromUpgrade||("flowtaskEdit"!==type&&isFromCreation?$scope.$emit("showStatusLoader",!0):loader=NotificationService.loader(i18n.i18nString("please_wait_noty"))),$scope.initiateWorkflowCreation(type,!0),"alert"===type?($workflowService.alertInfo(entity),$q.all([BTAlertsService.getMPAlert(entity._id),BTAlertsService.getBTAlert(entity._id)]).then(function(res){$workflowService.alertInfo(res[1].data),res[1].data.taskType=type,$workflowService.taskEditInfo(res[1].data),$workflowService.taskMode("edit"),$workflowService.mpAlertInfo(res[0].data),$workflowService.currentStep(3),isFromCreation||loader(),$scope.$emit("showStatusLoader",!1),$scope.removeLoader(),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3)},function(err){NotificationService.notify(i18n.i18nString("error_msg"),"error"),$workflowService.mpAlertInfo({}),$workflowService.alertInfo({}),isFromCreation||loader(),$scope.$emit("showStatusLoader",!1),$scope.removeLoader()})):"action"===type?$q.all([BTActionsService.getBTAction(entity._id),BTActionsService.getMPAction(entity._id)]).then(function(res){$workflowService.actionInfo(res[0].data),$workflowService.mpActionInfo(res[1].data),res[0].data.taskType=type,$workflowService.taskEditInfo(res[0].data),$workflowService.taskMode("edit"),$workflowService.currentStep(3),isFromCreation||loader(),$scope.$emit("showStatusLoader",!1),$scope.removeLoader(),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3)},function(err){NotificationService.notify(i18n.i18nString("error_msg"),"error"),$workflowService.mpActionInfo({}),$workflowService.actionInfo({}),isFromCreation||loader(),$scope.$emit("showStatusLoader",!1),$scope.removeLoader()}):"knowledgeTask"===type?$.each($workflowService.knowledgeTasks(),function(i,knowledge){knowledge._id===entity._id&&(knowledge.taskType="knowledgeTask",$workflowService.taskEditInfo(knowledge),$workflowService.taskMode("edit"),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3))}):"flowtaskEdit"===type&&(loader(),$scope.removeLoader(),entity.taskType="flowTask",$workflowService.taskEditInfo(entity),$workflowService.flowtaskInfo(entity),$workflowService.taskMode("edit"),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3))}$scope.workingTaskType=type,$scope.lockTask(entity,prepareTimer,type).then(function(res){triggerEdit()},function(err){})},$scope.showTrainBot=function(log){$scope.$emit("openFullPageModal","trainBot"),$workflowService.nlpTrainInput({})},$scope.openModalByClass=openModalByClass,$scope.closeModalByClass=closeModalByClass,$scope.isNotAParentOf=function(mapping){return!mapping.parentOf},$scope.editOrViewWorkflow=function(taskInfo,taskAction){"published"!==taskInfo.state&&"suspended"!==taskInfo.state?(taskAction="dialog"===taskAction?"flowtaskEdit":taskAction,$scope.editWorkflow(taskInfo,taskAction)):(taskAction="dialog"===taskAction?"flowtaskView":taskAction,$scope.viewWorkflow(taskInfo,taskAction))},$scope.viewWorkflow=function(entity,type){"knowledgeTask"!==type&&(loader=NotificationService.loader("Please wait")),$scope.initiateWorkflowCreation(type,!0),"alert"===type?($workflowService.alertInfo(entity),$q.all([BTAlertsService.getMPAlert(entity._id),BTAlertsService.getBTAlert(entity._id)]).then(function(res){$workflowService.mpAlertInfo(res[0].data),$workflowService.alertInfo(res[1].data),res[1].data.taskType=type,$workflowService.taskEditInfo(res[1].data),$workflowService.taskMode("view"),$workflowService.currentStep(3),loader(),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3)},function(err){NotificationService.notify(i18n.i18nString("error_msg"),"error"),$workflowService.mpAlertInfo({}),$workflowService.alertInfo({}),loader()})):"action"===type||"report"===type?$q.all([BTActionsService.getBTAction(entity._id),BTActionsService.getMPAction(entity._id)]).then(function(res){$workflowService.actionInfo(res[0].data),$workflowService.mpActionInfo(res[1].data),res[0].data.taskType=type,$workflowService.taskEditInfo(res[0].data),$workflowService.taskMode("view"),$workflowService.currentStep(3),loader(),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3)},function(err){NotificationService.notiy(i18n.i18nString("error_msg"),"error"),$workflowService.mpActionInfo({}),$workflowService.actionInfo({}),loader()}):"knowledgeTask"===type?$.each($workflowService.knowledgeTasks(),function(i,knowledge){knowledge._id===entity._id&&(knowledge.taskType="knowledgeTask",$workflowService.taskEditInfo(knowledge),$workflowService.taskMode("view"),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3))}):"flowtaskView"===type&&(loader(),$workflowService.flowtaskInfo(entity),entity.taskType="flowTask",$workflowService.taskEditInfo(entity),$workflowService.flowtaskInfo(entity),$workflowService.taskMode("view"),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3))},$scope.recallWorkflow=function(entity,type){function recallTask(){"alert"===type?BTAlertsService.configured(entity._id).then(function(res){$route.reload()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type?BTActionsService.configured(entity._id).then(function(res){$route.reload()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.recallFlowtask($workflowService.selectedStream()._id,entity._id).then(function(res){$route.reload()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})}NotificationService.alert(i18n.i18nString("recall_workflow"),recallTask,{okText:i18n.i18nString("continue"),cancelText:i18n.i18nString("cancel")})},$scope.unPublishWorkflow=function(entity,type){function unpublishWF(){"alert"===type?BTAlertsService.upPublishBTAlert(entity._id).then(function(res){NotificationService.alertNotify(i18n.i18nString("bt_streams_unpublish_label"),i18n.i18nString("bt_streams_alert_task_has_been_unpublished"),"success"),$route.reload()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type?BTActionsService.upPublishBTAction(entity._id).then(function(res){NotificationService.alertNotify(i18n.i18nString("bt_streams_unpublish_label"),i18n.i18nString("bt_streams_action_task_has_been_unpublished"),"success"),$route.reload()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.unpublishFlowtask($workflowService.selectedStream()._id,entity._id).then(function(res){NotificationService.alertNotify(i18n.i18nString("bt_streams_unpublish_label"),i18n.i18nString("bt_streams_dialog_task_has_been_unpublished"),"success"),$route.reload()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})}"action"===type?$scope._constants_.action:"alert";NotificationService.alert(i18n.i18nString("bt_streams_unpublish_task_from_marketplace"),unpublishWF,{okText:i18n.i18nString("continue"),cancelText:i18n.i18nString("cancel")})},$scope.cloneWorkflow=function(entity,type){"alert"===type?BTAlertsService.cloneBTAlert(entity._id).then(function(res){$route.reload()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type&&BTActionsService.cloneBTAction(entity._id).then(function(res){$route.reload()},function(err){NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.workflowHistory=function(entity,type){$scope.dialogMode="version",openModalDialog(entity,type)},$scope.upgradeWorkflow=function(entity,type){loader=NotificationService.loader(i18n.i18nString("please_wait_noty")),"alert"===type?BTAlertsService.upgradeBTAlert(entity._id).then(function(res){BTAlertsService.upgradeMPAlert(entity._id,res.data._id).then(function(res){$scope.editWorkflow(res.data,type,!0),loader(),getMappings($workflowService.selectedStream()._id),getAlertDialogMappings($workflowService.selectedStream()._id)},function(err){loader(),NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){loader(),NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type?BTActionsService.upgradeBTAction(entity._id).then(function(res){BTActionsService.upgradeMPAction(entity._id,res.data._id).then(function(res){$scope.editWorkflow(res.data,type,!0),loader(),getMappings($workflowService.selectedStream()._id),getAlertDialogMappings($workflowService.selectedStream()._id)},function(err){loader(),NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){loader(),NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,entity._id).then(function(res){$scope.editWorkflow(res.data,"flowtaskEdit",!0),loader()},function(err){loader(),NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.trainBot=function(){BTStreamsService.trainFaq($workflowService.selectedStream()._id).then(function(res){},function(err){})},$scope.deleteWorkflow=function(entity,type){var entityType="action"===type?entity.isReport?$scope._constants_.report:$scope._constants_.action:"flowtask"===type?"Dialog Task":"Alert";entityType="knowledgeTask"===type?$scope._constants_.knowledge:entityType,NotificationService.alert("Do you really want to delete this "+entityType,deleteWorkflow,arguments)},$scope.publishWorkflow=function(entity,type){$workflowService.publishEntity({entity:entity,type:type}),$location.path("bt/"+type+"/"+entity._id+"/publish")},$scope.command={context:{},data:{}},$scope.manageCommands=function(action){$scope.command.context={actionId:action._id,streamId:action.streamId,show:{_createSlash:!0},hidecheckbox:!0},$scope.command.data={},$scope.enableCommands=!0,$timeout(function(){openModalByClass(".slashcommands"),($scope.command.context.getSlashCommands||angular.noop)()})},$scope.exitCommand=function(){closeModalByClass(".slashcommands"),$timeout(function(){$scope.enableCommands=!1},100)},$scope.saveCommand=function(isValid,form){if(!isValid)return void form_util.touch(form);$scope.command.saving=!0;var errorMsg=i18n.i18nString("bt_cmnd_delete_failed");$scope.command.context.createSlashCommand&&$scope.command.context.createSlashCommand().then(function(res){NotificationService.notify(i18n.i18nString("cmd_Save_success"),"success"),$scope.command.saving=!1,$scope.exitCommand()},function(err){var error=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||errorMsg;NotificationService.notify(error,"error"),$scope.command.saving=!1})},$scope.setCurrentTab=function(tabId){$(".myTabs").scrollTop(0),$scope.displayTabId="",$scope.showSolutionBotSetup&&$scope.selectedStream.sbStreamId||($scope.navigateTabIndex=tabId,$(tabId).addClass("active").siblings().removeClass("active"),".settings-pane"===tabId?$scope.showSettingsPane=!0:$scope.showSettingsPane=!1,$workflowService.navigateTabIndex(tabId),$(".panel-heading").addClass("collapsed"),$(".panel-collapse.in").collapse("hide"),".tasks-pane"===tabId&&openDialogTaskAccordion(),$scope.defaultDialogExpanded=!1)},$scope.$watch("navigateTabIndex",function(nv,ov){".tasks-pane"===nv?$("body").removeAttr("non-tasks-pane-active"):$("body").attr("non-tasks-pane-active",!0)}),$scope.deleteCommand=function(){$scope.command.deleting=!0;var errorMsg=i18n.i18nString("bt_cmnd_delete_failed");$scope.command.context.deleteCommand&&$scope.command.context.deleteCommand().then(function(res){NotificationService.notify(i18n.i18nString("bot_cmnd_deleted_Successfully"),"success"),$scope.command.deleting=!1,$scope.exitCommand()},function(err){var error=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||errorMsg;NotificationService.notify(error,"error"),$scope.command.deleting=!1})},$scope.goToStreams=function(){$location.path(window.appConfig.CONTEXT_PATH+"/streamnew")},$scope.publishMapping=function(mapping,index){mapping.mapId?BTStreamsService.publishFlow(mapping.mapId).then(function(res){getMappings($workflowService.selectedStream()._id),getAlertDialogMappings($workflowService.selectedStream()._id),NotificationService.notify(i18n.i18nString("flow_publish"),"success")},function(err){console.log(err),NotificationService.notify(err.data.errors[0].msg,"error")}):BTStreamsService.publishAlertDialogFlow(mapping._id).then(function(res){getMappings($workflowService.selectedStream()._id),getAlertDialogMappings($workflowService.selectedStream()._id),NotificationService.notify(i18n.i18nString("flow_publish"),"success")},function(err){console.log(err),NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.mapWorkflows=function(entity,type){$scope.showMapping=!0,$scope.activeEntityFlow=angular.copy(entity),$scope.activeEntityFlow.taskType=type,openModalByClass(".flowtask-create-form")};$scope.$on("closeMappingWorkflowEvent",function(event){$scope.showMapping=!1});$scope.newMapping=function(){$location.path("bt/alert/new/map/new")},$scope.editMapping=function(entity,type,id){entity.mapId?(entity._id=entity.mapId,entity.name=entity.alertName+" "+entity.actionName):(entity._id=entity._id,entity.name=entity.sourceResourceName+" "+entity.targetResourceName),$scope.lockTask(entity,prepareTimer).then(function(){$scope.activeEntityFlow=entity,entity.taskType="flows",$workflowService.taskEditInfo(entity),$workflowService.taskMode("edit"),$timeout(function(){$rootScope.$emit("updateEditTask",!0)}),$scope.openFullPageModal(3)},function(err){})},$scope.deleteMapping=function(entity,index){NotificationService.alert(i18n.i18nString("flow_delete"),deleteMapping,arguments)},$scope.gotostreams=function(){$location.path(window.appConfig.CONTEXT_PATH)},$timeout(function(){$scope.slashCommandsForm&&($scope.slashCommandsForm._createSlash=!0)}),$scope.goToChatSettings=function(){$workflowService.nlpText(""),$scope.verifyNlp()},$scope.navigateToPage=function(pageId){switch($(".kore-chat-window")&&$(".kore-chat-window").length&&!$(".kore-chat-window").hasClass("minimize")&&$(".kore-chat-window .minimize-btn").trigger("click"),pageId){case 0:$scope.showUtterances();break;case 1:$workflowService.nlpText(""),$workflowService.nlpStream($scope.selectedStream),openModalByClass(".wf-form");break;case 2:$workflowService.nlpText(""),$workflowService.nlpStream($scope.selectedStream),$location.path(window.appConfig.CONTEXT_PATH+"/patterns/"+$scope.selectedStream._id);break;case 3:openModalByClass(".standard-responses-form");break;
case 4:$scope.showBatchTesting()}},$scope.richEditorCallbacks={onKeyDown:function(event){13==event.keyCode&&"keydown"==event.type&&$timeout(function(){$workflowService.nlpText($scope.nlp.testText),$scope.verifyNlp()})}},$workflowService.reigisterModalShownEvent(),$scope.manageBot=function(){$workflowService.selectedStream($scope.selectedStream),$location.path(window.appConfig.CONTEXT_PATH+"/bot/share")},$scope.$watch("streams",function(){$scope.streams&&$scope.streams.length>0?$("body").removeClass("hidebodyscroll"):$("body").addClass("hidebodyscroll")}),$scope.showCantPublishWarning=function(){NotificationService.confirmDialog(i18n.i18nString("show_publish_warning"),function(){},{okText:i18n.i18nString("ok"),noCancelBtn:!0})},$scope.isPublicBot=function(){var streamData=$workflowService.selectedStream();return streamData.visibility&&"public"===streamData.visibility.namespace&&$rootScope.isManaged&&!$rootScope.wfAdmin},$scope.publishStandardBot=function(){function triggerPublish(){$scope.publishBot=!0,$workflowService.selectedStream().publishType="standardbot",openModalByClass(".bot-publish-form")}return $scope.isPublicBot()?void $scope.showCantPublishWarning():void checkForChannels(triggerPublish)},$scope.linkBots=function(className){$workflowService.linkableBots?openModalByClass(className):NotificationService.notify(i18n.i18nString("bt_streams_no_linkablebots",{dyn:$scope.selectedStream.purpose}),"warning"),$scope.$broadcast("updateLinkableBots")},$scope.onCloseBotPublishDialog=function(mode){closeModalByClass(".bot-publish-form"),$scope.publishBot=!1,mode&&load()},$scope.publishSmartBot=function(){function triggerPublish(){$(".panel-collapse.in").collapse("hide"),$(".panel-heading").addClass("collapsed"),$scope.publishBot=!0,$workflowService.selectedStream().publishType="smartbot",openModalByClass(".bot-publish-form")}return $scope.isPublicBot()?void $scope.showCantPublishWarning():void checkForChannels(triggerPublish)},$scope.publishSampleBot=function(){function triggerPublish(){$(".panel-collapse.in").collapse("hide"),$(".panel-heading").addClass("collapsed"),$scope.publishBot=!0,$workflowService.selectedStream().publishType="samplebot",openModalByClass(".bot-publish-form")}checkForChannels(triggerPublish)},$scope.linkOrUnlinkBot=function(botId){var payLoad={bots:[botId]};BTStreamsService.linkOrUnlinkBots($scope.selectedStream._id,"unlink",payLoad).then(function(){load()},function(err){})},$scope.options={mode:"view",ace:window.ace},$scope.saveScript=function(){return $scope.invalidScript?void NotificationService.notify(i18n.i18nString("save_script"),"error"):($scope.saveInProgress=!0,void BTFlowtaskService.getComponents($scope.contextData.botInfo.taskBotId,$scope.contextData.context.scriptErrorMeta.componentId).then(function(res){var _component=res&&res.data,_payload={};if($scope.contextData.context.scriptErrorMeta.messageTemplateId){var _scriptPosition="message";"error"===$scope.contextData.context.scriptErrorMeta.msgTemplateIdType&&(_scriptPosition="errorMessage");var _channel=_.find(_component[_scriptPosition],{_id:$scope.contextData.context.scriptErrorMeta.messageTemplateId});_channel.text=encodeJS($scope.scriptObj),_payload[_scriptPosition]=_component[_scriptPosition],_payload[_scriptPosition]=_payload[_scriptPosition].map(function(channel){return{channel:channel.channel,text:channel.text,type:channel.type,_id:channel._id}})}else _payload.script=encodeJS($scope.scriptObj);saveToServer(_payload),$scope.contextData=void 0},function(error){if($scope.saveInProgress=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")}))},$scope.closeModal=function(){$scope.contextData=void 0,scriptNodeEditorModal=!1,closeModalByClass(".script-node-edit-form")},$scope.validateJs=function(contextData){var showToast=!0;if($scope._constants_.config.showScriptNodeError){contextData?(showToast=!1,$scope.contextData=angular.copy(contextData)):$scope.contextData.context.scriptErrorMeta.codeToBeRes.body="<%"+$scope.scriptObj+"%>";var data={};$scope.scriptNodeName=$scope.contextData.context.scriptErrorMeta.componentName,$scope.errNodeType=$scope.contextData.context.scriptErrorMeta.componentType,$scope.contextData.context&&(data.contextForResolution=$scope.contextData.context),$scope.contextData.context&&$scope.contextData.context.scriptErrorMeta&&$scope.contextData.context.scriptErrorMeta.contextForRes.dateTimeFields&&(data.dateTimeFields=$scope.contextData.context.scriptErrorMeta.contextForRes.dateTimeFields),$scope.contextData.context.scriptErrorMeta&&(data.code=$scope.contextData.context.scriptErrorMeta.codeToBeRes),function(data){jsValidator.getError(data).then(function(res){$scope.showError=!1,NotificationService.notify(i18n.i18nString("script_success"),"success")},function(err){$scope.showError=!0,showToast&&NotificationService.notify(i18n.i18nString("script_error"),"error"),scriptDefinition({contextData:data,error:err})})}(data)}},$scope.aceEditorCallback.onBlur=function(editor){_.filter(editor.getSession().getAnnotations(),{type:"error"}).length?$scope.invalidScript=!0:$scope.invalidScript=!1},$(document).on("show.bs.modal",".modal",function(event){if(scriptNodeEditorModal){var zIndex=1040+10*$(".modal:visible").length;$(this).css("z-index",zIndex),setTimeout(function(){$(".modal-backdrop").not(".modal-stack").css("z-index",zIndex-1).addClass("modal-stack")},0)}}),$rootScope.$on("validate script",function(e,data){$scope.validateJs(data)}),$scope.botExportCB=function(){},$scope.exporBot=function(){$modal.open({templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-export/bt-exportBot.html",controller:"BTExportBotCtrl",backdrop:"static",windowClass:"bt-dialog-exportBot modal-kr",resolve:{config:function(){return{botExportCB:$scope.botExportCB}}}})},$scope.changeBotLanguage=function(language,reload){$scope.currentLanguage=language,$workflowService.currentLanguage(language),reload&&$rootScope.$broadcast("triggerSelectApp",!0)}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btSummary",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-summary/bt-summary.html",controller:"botSummaryController"}}),_module.controller("botSummaryController",["$scope","$window","$workflowService","$element","$location","_constants_","BTStreamsService","$timeout","$routeParams","NotificationService","$modal","env_conf","$q","BTSeedDataService","$filter","BTIdpService","$translator","$rootScope","$applicationService","$endpoints","channelsConfig","BTFlowtaskService","i18n",function($scope,$window,$workflowService,$element,$location,_constants_,BTStreamsService,$timeout,$routeParams,NotificationService,$modal,env_conf,$q,BTSeedDataService,$filter,BTIdpService,$translator,$rootScope,$applicationService,$endpoints,channelsConfig,BTFlowtaskService,i18n){function preparePermissions(){$scope.permissions={botTasks:{permissionId:"BOTBUILDER_TASKS",dependentPermissions:["BOTBUILDER_KNOWLEDGE_GRAPH"],permission:"NO"==$scope.summary.botInfo.permissions.BOTBUILDER_TASKS[0]?$scope.summary.botInfo.permissions.BOTBUILDER_KNOWLEDGE_GRAPH[0]:$scope.summary.botInfo.permissions.BOTBUILDER_TASKS[0]},linkedBots:{permissionId:"BOTBUILDER_TASKS",permission:$scope.summary.botInfo.permissions.BOTBUILDER_TASKS?$scope.summary.botInfo.permissions.BOTBUILDER_TASKS[0]:"FULL"},smallTalk:{permissionId:"BOTBUILDER_TASKS",permission:$scope.summary.botInfo.permissions.BOTBUILDER_TASKS?$scope.summary.botInfo.permissions.BOTBUILDER_TASKS[0]:"FULL"},training:{permissionId:"BOTBUILDER_NATURAL_LANGUAGE",permission:$scope.summary.botInfo.permissions.BOTBUILDER_NATURAL_LANGUAGE?$scope.summary.botInfo.permissions.BOTBUILDER_NATURAL_LANGUAGE[0]:"FULL"},intelligence:{permissionId:"BOTBUILDER_NATURAL_LANGUAGE",permission:"NO"!==$scope.summary.botInfo.permissions.BOTBUILDER_NATURAL_LANGUAGE[0]?$scope.summary.botInfo.permissions.BOTBUILDER_NATURAL_LANGUAGE[0]:$scope.summary.botInfo.permissions.BOTBUILDER_BOT_SETTINGS[0]},defaultConversation:{permissionId:"BOTBUILDER_NATURAL_LANGUAGE",permission:"NO"!==$scope.summary.botInfo.permissions.BOTBUILDER_NATURAL_LANGUAGE[0]?$scope.summary.botInfo.permissions.BOTBUILDER_NATURAL_LANGUAGE[0]:$scope.summary.botInfo.permissions.BOTBUILDER_EXTENSIONS[0]},batchTesting:{permissionId:"BOTBUILDER_BATCH_TESTING",permission:$scope.summary.botInfo.permissions.BOTBUILDER_BATCH_TESTING?$scope.summary.botInfo.permissions.BOTBUILDER_BATCH_TESTING[0]:"FULL"},testTrain:{permissionId:"FULL",permission:"FULL"},channels:{permissionId:"BOTBUILDER_CHANNELS",permission:$scope.summary.botInfo.permissions.BOTBUILDER_CHANNELS?$scope.summary.botInfo.permissions.BOTBUILDER_CHANNELS[0]:"FULL"},agents:{permissionId:"BOTBUILDER_APPS_AND_SCOPES",permission:$scope.summary.botInfo.permissions.BOTBUILDER_APPS_AND_SCOPES?$scope.summary.botInfo.permissions.BOTBUILDER_APPS_AND_SCOPES[0]:"FULL"},publish:{permissionId:"BOTBUILDER_PUBLISH_BOT",permission:$scope.summary.botInfo.permissions.BOTBUILDER_PUBLISH_BOT?$scope.summary.botInfo.permissions.BOTBUILDER_PUBLISH_BOT[0]:"FULL"},analyze:{permissionId:"BOTBUILDER_BOT_ANALYTICS",permission:$scope.summary.botInfo.permissions.BOTBUILDER_BOT_ANALYTICS?$scope.summary.botInfo.permissions.BOTBUILDER_BOT_ANALYTICS[0]:"FULL"},configurations:{permissionId:"BOTBUILDER_BOT_SETTINGS",permission:$scope.summary.botInfo.permissions.BOTBUILDER_BOT_SETTINGS?$scope.summary.botInfo.permissions.BOTBUILDER_BOT_SETTINGS[0]:"FULL"},management:{permissionId:"BOTBUILDER_BOT_SETTINGS",dependentPermissions:["BOTBUILDER_BOT_DEVELOPERS","BOTBUILDER_BOT_IMPORT"],permission:"NO"==$scope.summary.botInfo.permissions.BOTBUILDER_BOT_SETTINGS[0]?"NO"==$scope.summary.botInfo.permissions.BOTBUILDER_BOT_DEVELOPERS[0]?$scope.summary.botInfo.permissions.BOTBUILDER_BOT_IMPORT[0]:$scope.summary.botInfo.permissions.BOTBUILDER_BOT_DEVELOPERS[0]:$scope.summary.botInfo.permissions.BOTBUILDER_BOT_SETTINGS[0]}},$timeout(function(){try{gridInit(),$timeout(function(){grid.refreshItems(),$scope.fetchingSummary=!1},1e3)}catch(e){console.log("Muri Load terinated")}},300)}function gridInit(){grid=new Muuri(".grid",{dragEnabled:!1,layout:{fillGaps:!0,horizontal:!1,alignRight:!1,alignBottom:!1,rounding:!0},showDuration:0})}function checkActiveTypePermisions(activeType,innerRightViewElement){return"NO"==$scope.permissions[activeType].permission?!1:"importBot"==innerRightViewElement?"NO"!==$scope.summary.botInfo.permissions.BOTBUILDER_BOT_IMPORT[0]:"developerShare"==innerRightViewElement?"NO"!==$scope.summary.botInfo.permissions.BOTBUILDER_BOT_DEVELOPERS[0]:"knowledgeCollection"==innerRightViewElement?"NO"!==$scope.summary.botInfo.permissions.BOTBUILDER_KNOWLEDGE_GRAPH[0]:"eventsManage"==innerRightViewElement?"NO"!==$scope.summary.botInfo.permissions.BOTBUILDER_EXTENSIONS[0]:"advancedSettings"==innerRightViewElement?"NO"!==$scope.summary.botInfo.permissions.BOTBUILDER_BOT_SETTINGS[0]:!0}function prepareTaskData(taskData){$scope.allTasksSummary=[],$scope.dialogSummary=[],$scope.actionsSummary=[],$scope.alertsSummary=[],$scope.knowledgeSummary=[],$scope.smallTalks=[];var botState=$scope.botDetails.streamState||$workflowService.selectedStreamState(),states=["configured","awaitingApproval","rejected"];if("indevelopment"==botState?(botState="configured",states=["configured","awaitingApproval","rejected"]):states=["published","suspended"],states.forEach(function(state){taskData.tasks[state]&&($scope.allTasksSummary=$scope.allTasksSummary.concat(taskData.tasks[state].items))}),taskData.knowledgeTasks&&taskData.knowledgeTasks[botState]){var ind=0;for(var key in taskData.knowledgeTasks[botState])key&&($scope.knowledgeSummary[ind]={},$scope.knowledgeSummary[ind].count=taskData.knowledgeTasks[botState][key],$scope.kgTotalCount=$scope.kgTotalCount+$scope.knowledgeSummary[ind].count,$scope.knowledgeSummary[ind].label=key,ind++)}taskData.smallTalkGroups[botState]&&($scope.smallTalks=_.cloneDeep(taskData.smallTalkGroups[botState])),$timeout(function(){grid&&grid.refreshItems&&grid.refreshItems()},5e3),$timeout(function(){grid&&grid.refreshItems&&grid.refreshItems(),$scope.fetchingSummary=!1},2e4)}function updateLanguages(){$scope.callbacks&&$scope.callbacks.supportedLanguages&&($scope.supportedLanguages=$scope.callbacks.supportedLanguages)}function mapSupportedLanguages(){var availableLanguages=_.cloneDeep($workflowService.seedData().supportedLanguages);return $scope.configuredLanguages=$workflowService.selectedStream().languageConfigurations,"indevelopment"===$workflowService.selectedStreamState()?($scope.languages=_.filter(availableLanguages,function(lan){return lan.value===$scope.stream.defaultLanguage?(lan.order=1,$scope.defaultLanguage=lan):lan.order=lan.name,$scope.configuredLanguages&&$scope.configuredLanguages[lan.value]&&$scope.configuredLanguages[lan.value].hasOwnProperty("enabled")?(lan.enabled=$scope.configuredLanguages[lan.value].enabled,lan):void 0}),$scope.languages&&$scope.languages.length<$scope.showlanguageCount&&($scope.showlanguageCount=$scope.languages.length),$scope.languages):"published"===$workflowService.selectedStreamState()?($scope.taskApprovedLanguages=$workflowService.selectedStream().taskApprovedLanguages,$scope.taskDisabledLanguages=$workflowService.selectedStream().publishedDisabledLangs,$scope.languages=_.filter(availableLanguages,function(lan){return lan.value===$scope.stream.defaultLanguage?(lan.order=1,$scope.defaultLanguage=lan):lan.order=lan.name,$scope.taskApprovedLanguages&&-1!==$scope.taskApprovedLanguages.indexOf(lan.value)?(lan.enabled=!0,lan):$scope.taskDisabledLanguages&&-1!==$scope.taskDisabledLanguages.indexOf(lan.value)?(lan.enabled=!1,lan):void 0}),$scope.languages):void 0}function planDisplayName(data){var keys=Object.keys(data);if(keys){var headers=[];keys.forEach(function(key){$scope.license.planId===key&&data[key]&&data[key][0]&&headers.push({planName:data[key][0].planName,id:key})});var selectedValid=_.find(headers,function(item){return item.id===$scope.license.planId});selectedValid&&($scope.planValHeaders=selectedValid)}}$scope.$emit("homeDirectivesLoaded");var grid;$scope.allinterruptions_error=i18n.i18nString("allinterruptions_error"),$scope.enable_label=i18n.i18nString("enabled"),$scope.notEnable_label=i18n.i18nString("not_enabled"),$scope.apiFailed=!1,$scope.showlanguageCount=3,$scope.botState="indevelopment"==$scope.botDetails.streamState?"configured":"published",$scope.fetchingSummary=!0,$scope.kgTotalCount=0,$scope.upgradeUniProgress="initial",$scope.selectedStream=$workflowService.selectedStream(),$scope.license={},$scope.supportPlan={},$scope.universalLink="https://developer.kore.ai/docs/bots/advanced-topics/universal-bot/universal-bots/#ub2.0",$scope.builderState=$workflowService.builderResumeState(),channelsConfig.getDynamicChannels($workflowService.selectedStream()),$scope.notificationEnabled=!1,$scope.planValidationDetails={},$scope.planValHeaders={},$scope.planSelection=!1,$scope.planSelectionCb={},$scope.enterpriseLicenseType=$workflowService.selectedStream().purpose,$scope.selectedAccount=$workflowService.selectedAccount(),$scope.showAllLang=function(params){$scope.manageLanguage()},$scope.searchGreen=function(e){$(e.currentTarget.parentElement).toggleClass("expand")},$scope.channelsConfig=channelsConfig,$scope.getTaskType={flowTask:i18n.i18nString("bt_task_chooser_dialog_label"),dialog:i18n.i18nString("bt_task_chooser_dialog_label"),alert:i18n.i18nString("alert"),action:i18n.i18nString("action_label")},$scope.botEventsKey={WELCOME_MESSAGE_EVENT:i18n.i18nString("welcome_event"),TASK_FAILURE_EVENT:i18n.i18nString("task_failure"),ON_CONNECT_EVENT:i18n.i18nString("on_connect"),FB_WELCOME_EVENT:i18n.i18nString("fb_welcome"),TELEGRAM_WELCOME_EVENT:i18n.i18nString("telegram_event"),CONVERSATION_END:i18n.i18nString("end_conversation"),TELEPHONY_WELCOME_EVENT:i18n.i18nString("telephony_welcome_ev"),RCS_OPTOUT_EVENT:i18n.i18nString("RCS_Opt_Out_Event"),RCS_OPTIN_EVENT:i18n.i18nString("RCS_Opt_In_Event"),INTENT_UNIDENTIFIED:i18n.i18nString("intent_identified"),showMsg:i18n.i18nString("show_msg"),triggerDialog:i18n.i18nString("trigger_dialog"),runScript:i18n.i18nString("run_script"),voiceProp:i18n.i18nString("ivr_properties_normal")},$scope.summary={},$scope.getBotTaskSummary=function(streamId){BTStreamsService.botTasksSummary(streamId).then(function(res){$scope.summary.alltasksInfo=res.data;var forms={configured:{},published:{}},panels={configured:{},published:{}},widgets={configured:{},published:{}};res.data.forms&&$.each(res.data.forms,function(i,val){val&&val.configured&&(forms.configured=val.configured),val&&val.awaitingApproval&&(forms.configured.count=forms.configured.count+val.awaitingApproval.count),val&&val.rejected&&(forms.configured.count=forms.configured.count+val.rejected.count),val&&val.published&&(forms.published=val.published)}),res.data.panels&&$.each(res.data.panels,function(i,val){val&&val.configured&&(panels.configured=val.configured),val&&val.awaitingApproval&&(panels.configured.count=panels.configured.count+val.awaitingApproval.count),val&&val.rejected&&(panels.configured.count=panels.configured.count+val.rejected.count),val&&val.published&&(panels.published=val.published)}),res.data.widgets&&$.each(res.data.widgets,function(i,val){val&&val.configured&&(widgets.configured=val.configured),val&&val.awaitingApproval&&(widgets.configured.count=widgets.configured.count+val.awaitingApproval.count),val&&val.rejected&&(widgets.configured.count=widgets.configured.count+val.rejected.count),val&&val.published&&(widgets.published=val.published)}),$scope.summary.alltasksInfo.forms=forms,$scope.summary.alltasksInfo.widgets=widgets,$scope.summary.alltasksInfo.panels=panels,prepareTaskData(res.data)})},$scope.getBotTaskSummary($scope.stream._id),$scope.getBotSummary=function(streamId){BTStreamsService.botSummary(streamId).then(function(res){res.data.debugLogs=res.data.debugLogs||[],res.data.channels=res.data.channels||[],$.each(res.data.channels,function(i,channel){channel.displayName=channel.displayName||($scope.channelsConfig.channelsObject[channel.type]?$scope.channelsConfig.channelsObject[channel.type].name:channel.type)}),$.each(res.data.debugLogs,function(key,value){value.createdDate=new moment(value.createdOn).format("MM-DD-YYYY"),value.createdTime=new moment(value.createdOn).format("hh:mm:ss A")}),$scope.summary.botInfo=res.data;var createdData=new moment(res.data.createdOn).format("Do MMMM YYYY"),createdTime=new moment(res.data.createdOn).format("hh:mm A");$scope.summary.created=createdData+" "+createdTime,$scope.botEvents=[],"universalbot"==res.data.type&&($scope.publishedBots=res.data.publishedBots.filter(function(bot){return _.filter(res.data.unpublishedBots.concat(res.data.awaitingApprovalBots),{_id:bot._id}).length?void 0:bot}),$scope.summary.botInfo.configured=res.data.configuredBots.concat($scope.publishedBots,res.data.awaitingApprovalBots),$scope.summary.botInfo.published=res.data.publishedBots),$.each($scope.summary.botInfo.botEvents,function(key,value){value.enabled&&(value.key=key,$scope.botEvents.push(value))}),$scope.summary.botInfo.codevelopers&&$scope.summary.botInfo.codevelopers.users&&$.each($scope.summary.botInfo.codevelopers.users,function(i,user){"Bot Owner"==user.roleInfo[0].role?(user.order=1,user.roleInfo[0].role="Owner"):("Bot Developer"==user.roleInfo[0].role&&(user.roleInfo[0].role="Developer"),"Bot Tester"==user.roleInfo[0].role&&(user.roleInfo[0].role="Tester"),user.order=user.firstName)}),preparePermissions()},function(err){NotificationService.notify(i18n.i18nString("error_summary"),"error"),$scope.fetchingSummary=!1,$scope.apiFailed=!0})},$scope.getBotSummary($scope.stream._id),$scope.getChanageLogs=function(){$scope.loading=!0,BTStreamsService.getChangeLog($scope.stream._id).then(function(res){$scope.logs=res.data.btlogs.map(function(log){return log.createdDate=new moment(log.createdOn).format("MM/DD/YYYY"),log.createdTime=new moment(log.createdOn).format("hh:mm A"),log.username=_.isObject(log.userId)?log.userId.firstName+" "+log.userId.lastName:log.userId,log}),$timeout(function(){grid&&grid.refreshItems&&grid.refreshItems()},3e3),$scope.loading=!1},function(err){$scope.logs=[],$scope.loading=!1})},$scope.getChanageLogs(),$scope.updateStateForSummary=function(){$scope.botState="indevelopment"==$scope.botDetails.streamState?"configured":"published",$scope.getBotTaskSummary($scope.stream._id),$scope.getBotSummary($scope.stream._id),$scope.getChanageLogs(),updateLanguages()};var streamUPdate=$rootScope.$on("updateStreamState",$scope.updateStateForSummary),summaryTasksUpdate=$rootScope.$on("updateSummaryData",$scope.updateStateForSummary);$scope.$on("$destroy",function(){streamUPdate(),summaryTasksUpdate()}),$scope.availableWidgets=[{widgetId:"tasks",name:i18n.i18nString("tasks"),selected:!0,position:1},{widgetId:"knowledgeCollection",name:i18n.i18nString("knowledge_collection_label"),selected:!0,position:2},{widgetId:"naturalLanguage",name:i18n.i18nString("natural_langname"),selected:!0,position:3},{widgetId:"channels",name:i18n.i18nString("channels"),selected:!0,position:4},{widgetId:"developers",name:i18n.i18nString("developers"),selected:!0,position:5},{widgetId:"changeLogs",name:i18n.i18nString("change_logs"),selected:!0,position:6},{widgetId:"authorization",name:i18n.i18nString("authorization_label"),selected:!0,position:7},{widgetId:"events",name:i18n.i18nString("events_label"),selected:!0,position:8},{widgetId:"language",name:i18n.i18nString("language_label"),selected:!0,position:9},{widgetId:"holdNResume",name:i18n.i18nString("hold_and_resume_label"),selected:!0,position:10},{widgetId:"botVariables",name:i18n.i18nString("bot_variables"),selected:!0,position:11},{widgetId:"others",name:i18n.i18nString("others"),selected:!0,position:12}],$scope.$emit("nestedComponentLoaded",{id:"dashboard",flag:!1}),$scope.assetsPath=env_conf["context-url"],$scope.botsIcon=env_conf["context-url"]+"/assets/icons/botsIcon.svg",$scope.searchIconGreen=env_conf["context-url"]+"/assets/icons/searchIconGreen.svg",$scope.devAvatar=env_conf["context-url"]+"/assets/icons/devAvatar.svg",$scope.arrowGreen=env_conf["context-url"]+"/assets/icons/arrowGreen.svg",$scope.channelIcon=env_conf["context-url"]+"/assets/botIcons/1.svg",$scope.upgradeUniversalIcon=env_conf["context-url"]+"/assets/ub2/universal2.svg",$scope.variableKeys={env:"Global",locale:"Content"},$scope.allInterruptOptions={developer:i18n.i18nString("allinterruptoptions_developer"),"false":i18n.i18nString("allinterruptions_false"),endUser:i18n.i18nString("allinterruptions_endusers"),holdCurrTask:i18n.i18nString("allinterruptions_holdcurrtask"),discardCurrTask:i18n.i18nString("allinterruptions_discardcurrtask"),continueCurrTask:i18n.i18nString("allinterruptions_continuecurrtask"),confFromUser:i18n.i18nString("allinterruptions_conffromuser"),notifyUser:i18n.i18nString("allinterruptions_notifyuser"),noConfFromUser:i18n.i18nString("allinterruptions_noconffromuser"),discardCurrTaskNoNotify:i18n.i18nString("allinterruptions_discardtasknonotify")},$scope.selectComponent=function(activeType,innerRightViewElement,cb,subtype){checkActiveTypePermisions(activeType,innerRightViewElement),subtype?$scope.setSubTabToOpen(innerRightViewElement,subtype):innerRightViewElement&&$scope.setSubMenuToOpen(innerRightViewElement),cb&&cb()},$scope.openForms=function(){$scope.selectComponent("botTasks","uiForms")},$scope.openPanelsWidgets=function(){$scope.selectComponent("botTasks","widgets")},$scope.importBot=function(){$scope.selectComponent("management","botImportExport")},$scope.openTasks=function(taskType){$scope.selectComponent("botTasks","dialogTasks")},$scope.createTask=function(taskType){$scope.selectComponent("botTasks",taskType),$scope.showForm(null,taskType)};var cb=function(){setTimeout(function(){$("#groupName").focus(),angular.element("#create-group").modal("show")},2e3)};$scope.createSmallTalk=function(){$scope.selectComponent("botTasks","smallTalk",cb)},$scope.openTask=function(task,type,quary){$scope.information=i18n.i18nString("information_label");var identified_task={},botState=$scope.botDetails.streamState||$workflowService.selectedStreamState();task&&"dialog"===task.type&&$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id).then(function(){identified_task=_.find($scope.dialogTasks,{_id:task._id}),identified_task&&("VIEW"==$scope.summary.botInfo.permissions.BOTBUILDER_TASKS[0]||"setup"==$scope.summary.botInfo.state&&$workflowService.selectedStream().sbStreamId?$scope.callbacks.viewWorkflow(identified_task,"flowtaskView"):$scope.callbacks.editOrViewWorkflow(identified_task,"dialog"))}),task&&"action"===task.type&&$scope.callbacks.getActions($workflowService.selectedStream()._id).then(function(){identified_task=_.find($scope.actionTasks,{_id:task._id}),identified_task&&("VIEW"==$scope.summary.botInfo.permissions.BOTBUILDER_TASKS[0]||"setup"==$scope.summary.botInfo.state&&$workflowService.selectedStream().sbStreamId?$scope.callbacks.viewWorkflow(identified_task,"action"):$scope.callbacks.editOrViewWorkflow(identified_task,"action"))}),task&&"alert"===task.type&&!task.isReport&&$scope.callbacks.getAlerts($workflowService.selectedStream()._id).then(function(){identified_task=_.find($scope.allAlerts,{_id:task._id}),identified_task&&("VIEW"==$scope.summary.botInfo.permissions.BOTBUILDER_TASKS[0]||"setup"==$scope.summary.botInfo.state&&$workflowService.selectedStream().sbStreamId?$scope.callbacks.viewWorkflow(identified_task,"alert"):$scope.callbacks.editOrViewWorkflow(identified_task,"alert"))}),task&&"information"===task.type&&task.isReport&&$scope.callbacks.getActions($workflowService.selectedStream()._id).then(function(){identified_task=_.find($scope.informationTasks,{_id:task._id}),identified_task&&("VIEW"==$scope.summary.botInfo.permissions.BOTBUILDER_TASKS[0]||"setup"==$scope.summary.botInfo.state&&$workflowService.selectedStream().sbStreamId?$scope.callbacks.viewWorkflow(identified_task,"information"):$scope.callbacks.editOrViewWorkflow(identified_task,"information"))}),"smallTalkGp"===type&&("indevelopment"==botState&&(botState="configured"),BTStreamsService.getSmallTalkGroups($workflowService.selectedStream()._id).then(function(response){var gp=response.data.filter(function(val){return val.groupId===quary.groupId});gp&&gp[0]?$scope.callbacks.openGroup(gp[0]):NotificationService.notify(i18n.i18nString("error_smalltalk"),"error")},function(err){NotificationService.notify(i18n.i18nString("error_smalltalk_data"),"error")})),"knowledgeTask"===type&&(botState=$scope.botDetails.streamState||$workflowService.selectedStreamState(),"indevelopment"==botState&&(botState="configured"),$scope.callbacks.getKnowledgeTasks($workflowService.selectedStream()._id).then(function(){identified_task=_.find($scope.knowledgeTasks,{state:botState}),identified_task?(quary&&$workflowService.storeSearchQry({userSearchQueryFlag:!0,searchQry:quary}),"configured"==botState&&("VIEW"==$scope.summary.botInfo.permissions.BOTBUILDER_KNOWLEDGE_GRAPH[0]||"setup"==$scope.summary.botInfo.state&&$workflowService.selectedStream().sbStreamId?$scope.callbacks.viewWorkflow(identified_task,"knowledgeTask"):$scope.callbacks.editWorkflow(identified_task,"knowledgeTask"),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id)),"published"==botState&&($scope.callbacks.viewWorkflow(identified_task,"knowledgeTask"),$scope.callbacks.getFlowTasks($workflowService.selectedStream()._id))):$scope.selectComponent("botTasks","knowledgeCollection")}))},$scope.manageNL=function(selection,subtab){$scope.selectComponent("training",selection,null,subtab)},$scope.openKt=function(){$scope.selectComponent("botTasks","knowledgeCollection")},$scope.openLinkedBots=function(){$scope.selectComponent("botTasks","linkedBots")},$scope.exportBot=function(){$workflowService.storeSearchQry({userNavigateFlag:!0,navigateTo:"export"}),$scope.selectComponent("management","botImportExport")},$scope.manageDebugLogs=function(){$workflowService.storeSearchQry({userNavigateFlag:!0,navigateTo:"debugLog"}),$scope.selectComponent("analyze","metrics")},$scope.manageChannels=function(channel){channel&&$workflowService.storeSearchQry({userNavigateFlag:!0,navigateTo:channel}),$scope.selectComponent("channels","channels")},$scope.manageBotVariables=function(){$scope.selectComponent("configurations","variableManagement")},$scope.manageContentVariables=function(){$scope.selectComponent("configurations","variableManagementContent")},$scope.manageBotInterruption=function(){$scope.selectComponent("intelligence","advancedSettings")},$scope.manageDeveloperShare=function(){$scope.selectComponent("management","developerShare")},$scope.manageLanguage=function(){$scope.selectComponent("configurations","languageManagement")},$scope.manageEvents=function(){$scope.selectComponent("defaultConversation","eventsManage")},$scope.manageAuthorizationProfile=function(){$scope.selectComponent("configurations","authorization")},$scope.manageBotFunctions=function(){$scope.selectComponent("configurations","botFunctions")},$scope.manageApiExtensions=function(innerRightViewElement){$scope.selectComponent("agents",innerRightViewElement)},$scope.manageIvrOptions=function(){$workflowService.storeSearchQry({userNavigateFlag:!0,navigateTo:"ivrVoice",step:3}),$scope.selectComponent("channels","channels")},$scope.managePiiSettings=function(){$scope.selectComponent("configurations","IIPMasking")},$scope.manageChangeLogs=function(){$scope.selectComponent("management","changeLogs")},$scope.checkForDropDown=function(){var isOpen=$(".taskCreateList").hasClass("open");return isOpen},$scope.supportedLanguages=mapSupportedLanguages(),$workflowService.supportedLanguages($scope.supportedLanguages),$scope.callbacks.supportedLanguages=$scope.supportedLanguages;$workflowService.seedData().supportedLanguages;if($scope.enabledLanguages=$scope.stream.supportedLanguages,$workflowService.selectedStream().supportedLanguages){var genericLanguage={},genericlang=!1;_.forEach($workflowService.selectedStream().supportedLanguages,function(valueLang){"ge"===valueLang&&(genericLanguage={value:"ge",dvalue:"ge",name:"Generic",enabled:!0},genericlang=!0)}),$rootScope.seedLanguages||($rootScope.seedLanguages={}),$rootScope.seedLanguages.ge={},genericlang&&($scope.callbacks.supportedLanguages.push(genericLanguage),$rootScope.seedLanguages.ge={value:"ge",dvalue:"ge",name:"Generic",enabled:!0})}$scope.checkForUniVersion=function(){$timeout(function(){!$scope.stream||$scope.stream.universalBotVersion&&1!==$scope.stream.universalBotVersion||"universalbot"!==$scope.stream.type||"configured"!==$scope.botState||!$scope.builderState||$scope.builderState.universalSeen||($element.find("#upgradeUniModal").removeClass("fade").addClass("show"),$scope.upgradeUniProgress="initial",$workflowService.universalModalShowStatus(!0),$scope.builderState.universalSeen=!0,window.localStorage.setItem("previousState",JSON.stringify($scope.builderState)))})},$scope.closeUpgradeUniModal=function(){$element.find("#upgradeUniModal").removeClass("show").addClass("fade")},$scope.redirectToLink=function(link,e){e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()),$rootScope.redirectToLink(link,e)},$scope.upgradeUni=function(){var _payload={universalBotVersion:2};$scope.upgradeUniProgress="pending",NotificationService.notify(i18n.i18nString("bot_upgrade_progress"),"success"),BTStreamsService.upgradeUniversalBot($applicationService.userInfo().userId,$scope.stream._id,_payload).then(function(response){response&&($scope.stream.universalBotVersion=response.data.universalBotVersion,$workflowService.selectedStream(response.data),$scope.stream=$workflowService.selectedStream(),$workflowService.selectedStream($scope.stream),NotificationService.notify(i18n.i18nString("bot_switch_success"),"success"),
$scope.callbacks.navigateTo(null,"linkedBots",!0),$timeout(function(){$scope.upgradeUniProgress="success",$element.find("#upgradeUniModal").removeClass("show").addClass("fade"),NotificationService.notify(i18n.i18nString("bot_upgrade_success"),"success")},500))},function(err){$scope.upgradeUniProgress="failed",NotificationService.notify("Something went wrong","error")})},$scope.closeNotification=function(){$scope.notificationEnabled=!1,$timeout(function(){grid&&gridInit()},500)},$scope.openPlanUsage=function(planType){"plan"===planType?($scope.planSelectionCb.planSelection=!0,$scope.planSelectionCb.supportSelection=!1):"reload"===planType&&($scope.planSelectionCb.planSelection=!1,$scope.planSelectionCb.reloadAmount=!0),$scope.planSelectionCb.license=$scope.license,$scope.planSelectionCb.supportPlan=$scope.supportPlan,$scope.planSelectionCb.plansSlider=!0},$scope.planSelectionCb.close=function(){$scope.closeModalSlider("#managePlanSelectionSlider"),$scope.planSelectionCb={}},$scope.getLicenseInfo=function(){if($scope.selectedStream){if($scope.selectedStream.license&&($scope.license=$scope.selectedStream.license,$scope.license.totalCredits=$scope.license.baseAllowedCredits+$scope.license.extraCredits-$scope.license.creditsUsed||0,$scope.license.totalSessions=$scope.license.baseAllowedSessions+$scope.license.extraSessions-$scope.license.sessionsUsed||0,$scope.license.totalRequests=$scope.license.baseAllowedRequests-$scope.license.requestsUsed||0),$scope.selectedStream.supportplan&&($scope.supportPlan=$scope.selectedStream.supportplan,$scope.supportPlan.endDate)){var currentDate=moment(),endDate=moment($scope.supportPlan.endDate);$scope.supportPlan.remainingDays=endDate.diff(currentDate,"days")}$scope.selectedStream.planValidationDetails&&($scope.notificationEnabled=!0,$scope.planValidationDetails=$scope.selectedStream.planValidationDetails,$scope.planValidationDetails&&planDisplayName($scope.planValidationDetails.exceededData))}},$scope.getLicenseInfo(),$scope.openLanguageGenericModal=function(){$("#languageModalGeneric").modal("show")},$scope.checkForGenericLanguage=function(){$scope.showGenericProtip=!1,$scope.seedDataNluSupportedLanguages=$workflowService.seedData().nluSupportedLanguages,_.forEach($scope.stream.supportedLanguages,function(value){"ge"===value&&($scope.showGenericProtip=!0)}),$workflowService.selectedStream().enableInputTranslation&&!$workflowService.selectedStream().multiLingualConfigurations?$scope.inputTranslation=!0:$workflowService.selectedStream().multiLingualConfigurations&&($scope.inputTranslation=!1),$scope.showSelectedLanguage="",_.forEach($scope.stream.supportedLanguages,function(value){"ge"===value&&$("#languageModalGeneric").modal("show")})},$scope.checkForGenericLanguage(),$scope.setLanguageCode=function(lang){$scope.showSelectedLanguage=lang},$scope.openLanguageSlider=function(){$scope.rightPanel&&$scope.rightPanel.innerRightPanel&&$scope.rightPanel.innerRightPanel.showView&&($workflowService.storeSearchQry({userSearchQueryFlag:!0,searchQry:"openLanguageTranslation"}),$scope.rightPanel.innerRightPanel.showView("languageManagement"),$scope.inputTranslation=!1)};var addNewSupportedLanguage=function(){var payload={preferredData:["definition","training","faqs","ontology","smalltalk","traits"],baseLanguage:"ge"};payload.multiLingualConfigurations={},payload.multiLingualConfigurations[$scope.showSelectedLanguage.value]={nluLanguage:$scope.showSelectedLanguage.value};var selectedNluLanguage=!1;_.forEach($scope.seedDataSupportedLanguages,function(eachLanguage){eachLanguage.value===$scope.showSelectedLanguage.value&&(selectedNluLanguage=!0)}),selectedNluLanguage?payload.multiLingualConfigurations[$scope.showSelectedLanguage.value]={nluLanguage:$scope.showSelectedLanguage.value}:payload.multiLingualConfigurations[$scope.showSelectedLanguage.value]={nluLanguage:"ge"},BTStreamsService.addSupportedLanguage($workflowService.selectedStream()._id,$scope.showSelectedLanguage.value,payload).then(function(res){$("#languageModalGeneric").modal("hide"),$scope.showGenericProtip=!1,$scope.inputTranslation=!1;var index=$scope.callbacks.supportedLanguages.findIndex(function(lang){return"ge"===lang.value});$scope.callbacks.supportedLanguages.splice(index,1),console.log($scope.callbacks.supportedLanguages)})["catch"](function(res){})};$scope.proceedLanguageEnable=function(){BTStreamsService.disableLanguage($workflowService.selectedStream()._id,"ge").then(function(response){response&&($scope.selectedStream=response.data,NotificationService.notify("Generic language is now changed to "+$scope.showSelectedLanguage.name,"success"),$workflowService.selectedStream(response.data),addNewSupportedLanguage())},function(errors){errors&&errors.data&&errors.data.errors&&errors.data.errors.length&&errors.data.errors[0]&&errors.data.errors[0].msg&&NotificationService.notify(errors.data.errors[0].msg,"error")})}}]),_module.filter("removeSpaces",function(){return function(input){return input?input.replace(/\s\s+/g," "):void 0}}),_module.filter("localString",function(){return function(number,type){if(number&&"sessions"===type)return number.toLocaleString();if(number){for(var abs=Math.abs(number),rounder=Math.pow(10,1),isNegative=0>number,key="",powers=[{key:"Q",value:Math.pow(10,15)},{key:"T",value:Math.pow(10,12)},{key:"B",value:Math.pow(10,9)},{key:"M",value:Math.pow(10,6)},{key:"K",value:1e3}],i=0;i<powers.length;i++){var reduced=abs/powers[i].value;if(reduced=Math.round(reduced*rounder)/rounder,reduced>=1){abs=reduced,key=powers[i].key;break}}return(isNegative?"-":"")+abs.toLocaleString()+key}return number}})}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTToimageCtrl",["$scope","$modalInstance","$workflowService","config","BTFlowtaskService","urlutil","NotificationService","$timeout","i18n",function($scope,$modalInstance,$workflowService,config,BTFlowtaskService,urlutil,NotificationService,$timeout,i18n){function init(){$scope.stream=$workflowService.selectedStream(),$scope.task=$workflowService.taskEditInfo(),$scope.component=config.component.nodeInfo,$scope.saveInProgress=!1,$scope.sampleResCB={},$scope.options={aceMode:"ace/mode/xml",mode:"view"===$scope.displayMode?"tree":"code",ace:window.ace},$scope.props={headers:[],endPoint:{}},$scope.invalidPayload=!0,$scope.authCB="none",$scope.idpConfig={},$scope.saving=i18n.i18nString("saving"),$scope.add=i18n.i18nString("add"),$timeout(function(){$scope.props.headers.push({key:"",value:""}),$scope.props.endPoint.requestUrl=processUIEndPoint($scope.component.endPoint),$scope.props.endPoint.method="get",$scope.props.htmlData=$scope.component.htmlData&&$scope.component.htmlData[0]&&$scope.component.htmlData[0].text||"",$scope.props.htmlData=$scope.props.htmlData.replace(/&lt;/gi,"<").replace(/&gt;/gi,">"),$scope.props.paramType="application/xml"},400),(void 0===$scope.component.renderSize||$scope.component.renderSize===[])&&($scope.component.renderSize=[{name:"Mobile",width:320,height:480},{name:"Desktop",width:1366,height:768}])}function processUIEndPoint(endPoint){if(!endPoint)return"";var _url=urlutil.concat({host:endPoint.host,path:endPoint.path,port:endPoint.port?endPoint.port+"":"",protocol:endPoint.protocol});return _url}function deProcessUIEndPoint(url,method){var uriParser=window.URI,components=uriParser.parse(url),endPoint={host:components.host,port:components.port?components.port+"":"",path:components.path,protocol:components.scheme,method:method};return endPoint.path+=components.query?"?"+components.query:"",endPoint.path+=components.fragment?"#"+components.query:"",endPoint}function bindEvent(){$scope.sampleResCB.onBlur=function(editor){var _value=editor.getText();""===_value&&($scope.props.htmlData=""),$scope.fieldEdit()}}function saveToServer(_payload){$scope.saveInProgress=!0,BTFlowtaskService.updateComponent($scope.stream._id,$scope.component._id,_payload).then(function(res){res&&res.data&&(config&&config.cbBridge&&config.cbBridge.onServiceSave&&config.cbBridge.onServiceSave(res.data),$scope.closeModal()),$scope.saveInProgress=!1},function(){$scope.saveInProgress=!1})}$scope.fieldEdit=function(){var _isInvalid=!1;$.each($scope.component.renderSize,function(k,size){(""===size.name||""===size.width||""===size.height)&&(_isInvalid=!0)}),_isInvalid?$scope.invalidPayload=!0:$scope.invalidPayload=!1},$scope.checkPosNumber=function(valNum,key,index){$scope.component.renderSize&&$scope.component.renderSize[index]&&(isNaN(valNum)?$scope.component.renderSize[index][key]=1:(1>valNum?$scope.component.renderSize[index][key]=1:valNum%1!==0&&($scope.component.renderSize[index][key]=parseInt(valNum)),$scope.component.renderSize[index][key]>1920&&($scope.component.renderSize[index][key]=1920)))},$scope.saveRequest=function(){if($scope.invalidPayload)NotificationService.notify(i18n.i18nString("bt_to_img_please_provide_valid_payload"),"warning");else{var _payload={};"urltoimage"===$scope.component.serviceNodeType?(_payload.headers={type:"raw",value:"{}"},_payload.payload={type:"raw",value:"{}"},_payload.idp="none",_payload.authRequired=!1,_payload.endPoint=deProcessUIEndPoint($scope.props.endPoint.requestUrl,$scope.props.endPoint.method),_payload.endPoint.connectorEnabled=!1):_payload.htmlData=[{text:$scope.props.htmlData,type:"uxmap"}],_payload.renderSize=[],$.each($scope.component.renderSize,function(k,size){size&&size.name&&size.width&&size.height&&_payload.renderSize.push({name:size.name,width:parseInt(size.width),height:parseInt(size.height)})}),saveToServer(_payload)}},$scope.addRenderSize=function(){$scope.component.renderSize&&$scope.component.renderSize.length<3?$scope.component.renderSize.push({name:"",width:"",height:""}):NotificationService.notify(i18n.i18nString("bt_to_img_cannot_add_more_than_3_render"),"warning"),$scope.fieldEdit()},$scope.removeRenderSize=function(index){$scope.component.renderSize&&$scope.component.renderSize.length>1&&$scope.component.renderSize&&$scope.component.renderSize[index]&&$scope.component.renderSize.splice(index,1),$scope.fieldEdit()},$scope.closeModal=function(){$modalInstance.close()},function(){init(),bindEvent()}()}])}(angular),function(ng){var _module=ng.module("bt-train-bot",[]);_module.filter("taskNameFormat",function(){return function(input,data){input=input||"";var out="";return out=input}}),_module.directive("btTrainBot",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-train-bot/bt-train-bot.html",controller:"BTTrainBotCtrl",scope:{trainOffset:"=",callFrom:"=",analyzerecord:"=",cb:"="}}}).controller("BTTrainBotCtrl",["$scope","$rootScope","$workflowService","$location","$sce","$sanitize","_constants_","BTStreamsService","$timeout","$routeParams","NotificationService","$modal","BTAlertsService","BTActionsService","BTFlowtaskService","$q","form_util","$applicationService","env_conf","accessControlService","i18n","mixPanel",function($scope,$rootScope,$workflowService,$location,$sce,$sanitize,_constants_,BTStreamsService,$timeout,$routeParams,NotificationService,$modal,BTAlertsService,BTActionsService,BTFlowtaskService,$q,form_util,$applicationService,env_conf,accessControlService,i18n,mixPanel){function getSavedConfiguration(){BTStreamsService.getSavedConfiguration($workflowService.selectedStream()._id).then(function(response){if(response&&response.data&&response.data&&response.data.length){var findMultiIntents=response.data.find(function(item){return"Multiple_Intent_Models"===item.configurationKeyName});findMultiIntents&&findMultiIntents.configurationValue&&($scope.multipleIntentModels=findMultiIntents.configurationValue)}})}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createUtterance"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Utterance Added"),"createPattern"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Pattern Added"),"createEntitySynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Entity Synonym added"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}function getSanitizedText(text){return text=text||"",text=text.replace(/<img(.+?)\/>/g,"&lt;img $1 /&gt;"),text.escapeHTML()}function getNLPText(){return $(".keyword_highlight").text()&&$(".keyword_highlight").text().trim()||$scope.nlp.text&&$scope.nlp.text.trim()||$workflowService.nlpText()}function getColorByEntity(entityName,forMapping){return forMapping?entityColors[entityName]||"":entityColors[entityName]?entityColors[entityName]:(entityColors[entityName]=$scope.constants.entityColors[Math.floor(12*Math.random())+1],entityColors[entityName])}function mapColorEntityToWord(utterance){function getSentenceByEntity(triplets,str){String.prototype.replaceBetween=function(start,end,what){return this.substring(0,start+1)+what+this.substring(end)},triplets.sort(function(a,b){return b[0]-a[0]});for(var triplet,ii=0;triplet=triplets[ii];ii++)str=str.replaceBetween(triplet[0]-1,triplet[1],triplet[2]);return str}if(utterance.entities&&utterance.entities.length){var _parentArray=[];$.each(utterance.entities,function(i,entity){var _childArray=[entity.startIndex,entity.endIndex,'<span contenteditable="true" class="spantags" entityIndex="'+i+'" startIndex="'+entity.startIndex+'" endIndex="'+entity.endIndex+'"  entityId="'+entity.entityId+'" style="cursor:pointer;color:'+getColorByEntity(entity.entityName)+'">'+utterance.sentence.substring(entity.startIndex,entity.endIndex)+"</span>"];_parentArray.push(_childArray)}),utterance.sentence=getSentenceByEntity(_parentArray,utterance.sentence),$(".keyword_highlight").html(utterance.sentence)}else $(".keyword_highlight").html(utterance.sentence)}function getUtterances(payload){var selectedTaskID="dialog"==$scope.identifiedTask.taskType?$scope.identifiedTask.nodes[0].componentId:$scope.identifiedTask._id;BTStreamsService.getUtterances(selectedTaskID,0,3e3).then(function(res){if($scope.utterences=[],$scope.utterences=$scope.utterences.concat(res.data.Sentences),$.each($scope.utterences,function(i,utterance){return utterance.sentence==($scope.nlp.text&&$scope.nlp.text.trim())?($scope.utterence=utterance,$scope.utterenceCopy=angular.copy(utterance),!1):void 0}),payload)if($scope.utterence&&$scope.utterence._id){if($scope.utterence.entities&&$scope.utterence.entities.length){$.each($scope.utterence.entities,function(i,entity){$.each(payload.entities,function(j,payloadEntity){(entity.startIndex<=payloadEntity.startIndex&&entity.endIndex>=payloadEntity.startIndex||entity.startIndex<=payloadEntity.endIndex&&entity.endIndex>=payloadEntity.endIndex||entity.startIndex>=payloadEntity.startIndex&&entity.endIndex<=payloadEntity.endIndex||entity.startIndex<=payloadEntity.startIndex&&entity.endIndex>=payloadEntity.endIndex)&&delete $scope.utterence.entities[i]})});var tempEntitesArray=$scope.utterence.entities||[];tempEntitesArray=_.without(tempEntitesArray,null),tempEntitesArray=_.without(tempEntitesArray,void 0),payload.entities=[].concat(payload.entities,tempEntitesArray),$scope.utterence=payload}else payload.entities=[].concat(payload.entities,$scope.utterence.entities)||[];$scope.editUtterence(payload,!0)}else $scope.addUtterance(payload)},function(err){$scope.fetching=!1})}function saveSynonymAtBot(newVal){newVal.map(function(task,i){var oldTask=$scope.oldTasks[i],fields=compareSynonyms(oldTask,task);if(fields.length>0){var payload={};fields.map(function(field){var name=getFieldName(field,task);name&&(payload[name]=task.fieldSynonyms[field])}),Object.keys(payload).map(function(fieldName){triggerFieldSynonymSave(task._id,fieldName,payload[fieldName])})}})}function compareSynonyms(source,destination){var keys=[];return source.fieldSynonyms=source.fieldSynonyms||{},destination.fieldSynonyms=destination.fieldSynonyms||{},Object.keys(destination.fieldSynonyms).map(function(key){source.fieldSynonyms[key]=source.fieldSynonyms[key]||[],destination.fieldSynonyms[key]=destination.fieldSynonyms[key]||[],source.fieldSynonyms[key].join(",")!=destination.fieldSynonyms[key].join(",")&&keys.push(key)}),keys}function getFieldName(field,task){for(var name,i=0;i<task.fields.length;i++)if(task.fields[i].title.toLowerCase()==field)return task.fields[i].title;return name}function triggerFieldSynonymSave(taskId,fieldName,synonyms){var payload={},deferred=$q.defer(),type="l"==taskId[0]?"alert":"l"==taskId[0]?"dialog":"action";return synonyms=synonyms.map(function(synonym){return(synonym||"").toLowerCase()}),payload[fieldName]=synonyms,"alert"===type?BTStreamsService.createAlertFieldSynonyms(taskId,fieldName,payload).then(function(res){return $scope.oldTasks=clone($scope.tasks),deferred.resolve()},function(err){return deferred.resolve()}):"action"===type?BTStreamsService.createActionsFieldSynonyms(taskId,fieldName,payload).then(function(res){return $scope.oldTasks=clone($scope.tasks),deferred.resolve()},function(err){return deferred.resolve()}):void 0}function getDate(timestamp){var date=new Date(timestamp).toLocaleString(),dateOnly=date.split(", ")[0];return dateOnly=dateOnly.replace(/\//g,"-"),moment(dateOnly).format("MM-DD-YYYY")}function getTime(timestamp){if(!timestamp)return"---";var dateStr=new Date(timestamp).toLocaleString().split(", ")[1];return dateStr.split(":")[0]+":"+dateStr.split(":")[1]+" "+dateStr.split(" ")[1]}function arrangeData(data,universalBotStreamId){if(data=angular.copy(data),data.response.finalResolver&&data.response.finalResolver.winningIntent&&data.response.finalResolver.winningIntent.length&&data.response.finalResolver.winningIntent[0]&&data.response.finalResolver.winningIntent[0].taskId&&$scope.tasks){var _index=_.findIndex($scope.tasks,function(task){return data.response.finalResolver.winningIntent[0].linkedDialog?data.response.finalResolver.winningIntent[0].linkedDialog&&"dialog"===data.response.finalResolver.winningIntent[0].showfaqDialog?task._id===data.response.finalResolver.winningIntent[0].linkedDialogID:data.response.finalResolver.winningIntent[0].linkedDialog&&"faq"===data.response.finalResolver.winningIntent[0].showfaqDialog?task._id===data.response.finalResolver.winningIntent[0].taskId:void 0:task._id===data.response.finalResolver.winningIntent[0].taskId});_index>-1&&($scope.identifiedTask=$scope.tasks[_index],"dialog"==$scope.identifiedTask.taskType&&$scope.getComponentsByDialogID(universalBotStreamId))}var entities=[];if($scope.identifiedTask&&"dialog"!==$scope.identifiedTask.taskType){var mergedEntites=_.map($scope.identifiedTask&&$scope.identifiedTask.entitiesArray||[],function(item){return _.extend(item,_.findWhere(data.response.finalResolver.entities&&data.response.finalResolver.entities.length&&data.response.finalResolver.entities||[],{field:item.title}))});data.response.finalResolver.entities=angular.copy(mergedEntites),data.response.finalResolver.entities&&data.response.finalResolver.entities.map(function(entity){if(entity.field=entity.field||entity.title,entity.field){var obj={};obj.name=entity.field,entity._id=entity.key,obj.type=entity.metadata||entity.type||entity.fieldType,obj.isArray=entity.isMultiSelect||"",obj.componentId=entity.componentID||entity.key,obj.value=entity.value,obj.dataType=entity.type||entity.entityType||entity.metadata||entity.fieldType,obj.taskType=entity.taskType,entities.push(obj)}}),data.response.finalResolver.entities=entities}return data}function clone(obj){return JSON.parse(JSON.stringify(obj))}function loadingEntities(id,verifyCB,arrangeDataCB){$scope.tasks=[];var tasksArray=[];$scope.oldTasks=[];var prepareTaskData=function(res){if($workflowService.alertTasks(res[0].data),$workflowService.actionTasks(res[1].data),$scope.allDialogTasks=res[2].data,res[0].data=res[0].data.map(function(task){return _.isArray(task.alertFieldsDefinition)?task.fields=_.clone(task.alertFieldsDefinition||[]):_.isArray(task.payloadField)&&_.isArray(task.queryField)&&(task.fields=(task.payloadField||[]).concat(task.queryField)),task.taskType="alert",task}),res[1].data=res[1].data.map(function(task){return _.isArray(task.alertFieldsDefinition)?task.fields=_.clone(task.alertFieldsDefinition||[]):_.isArray(task.payloadField)&&_.isArray(task.queryField)&&(task.fields=(task.payloadField||[]).concat(task.queryField)),task.taskType="action",task}),res[2].data=res[2].data.map(function(task){return _.isArray(task.alertFieldsDefinition)?task.fields=_.clone(task.alertFieldsDefinition||[]):_.isArray(task.payloadField)&&_.isArray(task.queryField)&&(task.fields=(task.payloadField||[]).concat(task.queryField)),task.taskType="dialog",task}),res&&res[2].data){var state=$workflowService.selectedStreamState();$scope.dialogIntents=_.filter(res[2].data,function(task){return"published"===state?"published"===task.state||"suspended"===task.state:"configured"===task.state||"awaitingApproval"===task.state})}$scope.dialogTasksData=res[2].data,$scope.ktData=angular.copy(res[4].data),res[4].data=res[4].data.map(function(task){return task.taskType="knowledge",task}),$.each(res[0].data,function(i,alertTask){alertTask.entitiesArray=alertTask.alertFieldsDefinition}),$.each(res[1].data,function(i,actionTask){actionTask.entitiesArray=[].concat(actionTask.payloadField,actionTask.queryField)}),tasksArray=tasksArray.concat(res[0].data),tasksArray=tasksArray.concat(res[1].data),tasksArray=tasksArray.concat(res[2].data),tasksArray=tasksArray.concat(res[4].data),$scope.tasks=tasksArray,$scope.tasks.map(function(task){delete task.task_patterns});var alertTasks=[],actionTasks=[],dialogTasks=[],knowledgeTasks=[];if(res[3].data.map(function(pattern){var obj={};Object.keys(pattern).map(function(key){"resourceId"===key?obj._id=pattern.resourceId:(obj.name=key,obj.patterns=pattern[key])}),$scope.tasks.map(function(task){task._id===obj._id&&(task.task_patterns=ng.copy(obj.patterns));var patterns=[];Object.keys(task.fieldPatterns||{}).map(function(field){patterns.push({key:task.fieldPatterns[field].map(function(pattern){return pattern.key}),fieldName:field,value:task.fieldPatterns[field].map(function(pattern){return pattern.value}),oldPatterns:task.fieldPatterns[field]})}),task.field_patterns=patterns,task.fieldPatterns=task.fieldPatterns||{}})}),$.each($scope.tasks,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each($scope.tasks,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})}),$scope.tasks.map(function(task){"alert"!==task.taskType||"inProgress"===task.state||task.isParent?"action"!==task.taskType||"inProgress"===task.state||task.isParent?"knowledge"!==task.taskType||task.isParent?"dialog"!==task.taskType||task.isParent||dialogTasks.push(task):knowledgeTasks.push(task):actionTasks.push(task):alertTasks.push(task)}),$scope.tasksByType=[],alertTasks.length&&$scope.tasksByType.push({type:i18n.i18nString("alert_tasks"),tasks:alertTasks}),actionTasks.length&&$scope.tasksByType.push({type:i18n.i18nString("constants.actions"),tasks:actionTasks}),dialogTasks.length&&$scope.tasksByType.push({type:i18n.i18nString("ddval_dialog"),tasks:dialogTasks}),knowledgeTasks.length){var _tempTasks=[];knowledgeTasks.forEach(function(task){_tempTasks.push({_id:task._id,name:i18n.i18nString("to_train_your_knowledge_desc"),taskType:i18n.i18nString("knowledge_label")})}),$scope.tasksByType.push({type:i18n.i18nString("knowledge_collection_label"),knowledgeTasks:knowledgeTasks,tasks:_tempTasks})}$scope.oldTasks=clone($scope.tasks),"true"==verifyCB&&$scope.verify(),$scope.cb&&$scope.cb.onTasksLoaded&&$scope.cb.onTasksLoaded(),arrangeDataCB&&arrangeDataCB()},requestData={streamId:id};"analyzeTrain"===$scope.callFrom?$q.all([BTStreamsService.getPatterns(id)]).then(function(response){var res=[],alertData={data:$workflowService.alertTasks()},actionData={data:$workflowService.actionTasks()},dialogTasks={data:$workflowService.dialogTasks()},KnowledegData={data:$workflowService.knowledgeTasks()};if(res.push(alertData),res.push(actionData),res.push(dialogTasks),response&&response.length&&response[0]){var patternsData=response[0];res.push(patternsData)}res.push(KnowledegData),prepareTaskData(res)}):$q.all([BTAlertsService.getAlerts(id),BTActionsService.getActions(id),BTFlowtaskService.getFlowtaksByState(id),BTStreamsService.getPatterns(id),BTStreamsService.getAllKtsList($applicationService.userInfo().userId,requestData)]).then(function(res){prepareTaskData(res)})}function updateTrainedInfo(task){task.trained=!0;var payload={trained:task.trained,index:task._index};BTStreamsService.updateAnalyzeRecord($scope.stream._id,task._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("utterance_trained_information_updated_sucess_noty"),"success")},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("error_handle"),"error")})}function startSaving(){$scope.uSaveInProgress=!0}function finishSaving(){$scope.uSaveInProgress=!1}function saveEditedUtterance(payload,dontTrain){BTStreamsService.editUtterances(payload,$scope.utterenceCopy._id).then(function(res){NotificationService.notify(i18n.i18nString("utterance_updated_sucess_noty"),"info"),$scope.utterence=res.data,dontTrain||$scope.trainBot(),dontTrain&&finishSaving(),setTimeout(function(){$scope.editId=-1},500)},function(err){409===err.status&&(finishSaving(".utteranceInput"+$scope.utterence._id,"error"),$scope.utterence.sentence=$scope.utterenceCopy.sentence,NotificationService.notify(i18n.i18nString("duplicate_utterance"),"error"),setTimeout(function(){$scope.editId=-1},500))})}function getErrorMsg(err,defaultMsg){return err=err&&err.data,err&&err.errors&&err.errors[0]&&err.errors[0].msg||defaultMsg}function init(){parms&&parms.log&&parms.log.input?($scope.nlp.text=parms.log.input[0],$scope.verify()):($scope.nlp.text="",$scope.debugInfo[$scope.debugkeys.utteranceReady]="",$scope.showNote=!0)}$scope.$emit("nestedComponentLoaded",{id:"testTrain",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE");var API_URL_PREFIX="/api/"+env_conf.version,API_SERVER_URL=env_conf.API_SERVER_URL,parms=$workflowService.nlpTrainInput(),emptySpace=String.fromCharCode(160),getSpaceByCount=function(count){for(var tempEmptySpace="",i=0;count>i;i++)tempEmptySpace+=emptySpace;return tempEmptySpace};$scope.allDialogTasks=[],$scope.assetsBase=env_conf["assets-url"],$scope.trainbotintent={},$scope.multipleIntent={},$scope.multipleIntent.selectedTask="",$scope.debuggerConsole={},$scope.upgradedTasks=[],$scope.debugkeys={utteranceReady:i18n.i18nString("connected_ready_for_utterance"),utteranceSent:i18n.i18nString("utterance_sent_waiting_for_response"),utteranceRecieve:i18n.i18nString("response_received_success"),intentMatch:getSpaceByCount(2)+i18n.i18nString("intent_match_label")},$scope.smallTalkIcon=env_conf["context-url"]+"/assets/smalltalk/faq.svg",$scope.debugInfo={},$scope.running_label=i18n.i18nString("running_label"),$scope.save_And_run_label=i18n.i18nString("save_And_run_label"),$scope.faq=i18n.i18nString("faq"),$scope.intent_label=i18n.i18nString("intent_label"),$scope.selected_label=i18n.i18nString("selected_label"),$scope.matched_label=i18n.i18nString("matched_label"),$scope.utterence=null;var entityColors={};$scope.openAccordion=function(){alert("openAccordion")},$scope.offsetHeightDefault=$scope.trainOffset||-70,$scope.rightPanelHeightDefault=$scope.trainOffset||-57,$scope.rightEditPanelHeightDefault=$scope.trainOffset||-57,$scope.verifying=!1,$scope.pattern={},$scope.synonym={},$scope.addmeta={},$scope.constants=_constants_,$scope.stream=$workflowService.selectedStream(),$scope.universalbot="universalbot"===$scope.stream.type;var streamId=$workflowService.selectedStream()._id;$workflowService.currentLanguage();"VIEW"===$scope.displayMode&&$(document).keydown(function(e){var keycode1=e.keyCode?e.keyCode:e.which;(0===keycode1||9===keycode1)&&(e.preventDefault(),e.stopPropagation())}),$scope.allStreams=$workflowService.streamsAll()||[],$scope.cb&&($scope.cb.initMethod=function(){$scope.verifying=!1,$scope.intent={},$scope.runInProgress=!1,$scope.testing=!1,$(".keyword_highlight").html(""),parms=$workflowService.nlpTrainInput(),init()}),$scope.universalStreams=$scope.allStreams.filter(function(bot){return _.find($scope.$parent.$parent.linkedBots,{_id:bot._id})?!0:!1});$scope.tasks=[];$scope.showNlpEditPanel=!1,$scope.showUserSaysError=!1,$scope.tasksByType=[],$scope.iconContextPath=env_conf["context-url"]+"/img",$scope.imageContext=env_conf["context-url"]+"/assets/icons",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.infoIcon=env_conf["context-url"]+"/assets/icons-new/info/info-gray.svg",$scope.nlp=$scope.nlp||{text:""},$scope.context={api:{}},$scope.parentIntent={},$scope.dialogIntents={},$scope.selectedTask=null,$scope.debugInfoLogs=[],$scope.intentTabs=[{name:i18n.i18nString("machine_learning"),id:"machineLearning"},{name:i18n.i18nString("synonyms_and_patterns_label"),id:"synonymsPatterns"}],$scope.activeType="machineLearning",$scope.isCollapsed=function(ele){return $(ele).hasClass("collapsed")},$scope.multipleIntentModels=!1,getSavedConfiguration(),$scope.richEditorInitialStage="init",$scope.intentVerified=!1,$scope.identifiedTask=null,$scope.newSynonym={},$scope.newSynonym.show=!1,$scope.addSynonym=function(form){if(form.$invalid)return void form_util.touch(form);var key="state";"DialogIntent"===$scope.identifiedTask.taskType&&(key="status"),"published"==$scope.identifiedTask[key]?($scope.currentCb="addSynonym",$scope.currentPatternData=angular.copy(form),NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"))):($scope.synonyms.push(angular.copy($scope.newSynonym)),$scope.hideAddSynonym(),$scope.newSynonym.key="",$scope.newSynonym.value=[])},$scope.showAddSynonym=function(){$scope.newSynonym.key="",$scope.newSynonym.value=[],$scope.AddTaskSynonymsForm.$setPristine(),$scope.newSynonym.show=!0,$timeout(function(){$(".key-phrase").focus()},350)},$scope.hideAddSynonym=function(){$scope.newSynonym.show=!1},$scope.trainBotCB={},$scope.trainBotCB.openEditPanel=function(type,expandIndex){$scope.showNlpEditPanel=!0,$scope.nlpEditData=$scope.nlpData.type,$scope.trainBotCB.loading=!0,$scope.trainBotCB.type=type,$timeout(function(){$scope.trainBotCB.initEditPanel($scope.nlpData,$scope.trainBotCB.type,expandIndex)},600)},$scope.trainBotCB.closeEditPanel=function(){$scope.showNlpEditPanel=!1,$(".model").removeClass("active")},$scope.nlpData={},$scope.newPattern={},$scope.newPattern.show=!1,$scope.showAddPattern=function(){$scope.newPattern.value="",$scope.newPattern.show=!0},$scope.hideAddPattern=function(){$scope.newPattern.show=!1},$scope.newFieldPattern={},$scope.newFieldPattern.show=!1,$scope.showAddFieldPattern=function(field){$scope.selectedField=field,$scope.newFieldPattern.show=!0},$scope.hideAddFieldPattern=function(){$scope.selectedField=null,$scope.newFieldPattern.show=!1};var keyValueSetter=function(obj,prop,val){if(prop=(prop+"").toLowerCase(),_.isEmpty(obj))obj={},obj[prop]=val;else for(var p in obj){if(obj.hasOwnProperty(p)&&prop==(p+"").toLowerCase()){obj[p]=val;break}obj[prop]=val}};$scope.upgrade=function(){$scope.isGlobalWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("upgrading_task_label");var taskType=$scope.getTaskType($scope.identifiedTask);$scope.upgradeWorkflow($scope.identifiedTask,taskType),
$scope.publishedMode&&$scope.saveOrUpdateUtterance("","hidePublishedMode")};var prepareEntityMatchInfo=function(matchInfo){if(matchInfo){var identifiedLabel,nerScore,identifiedBy=matchInfo.entityIdentifiedBy,identifiedUsing=matchInfo.entityIdentifiedUsing,identifiedEngine=identifiedBy.split(" ")[0];return"FM Engine"===identifiedBy?identifiedLabel=identifiedUsing.split(":")[0]:(identifiedLabel=identifiedUsing,nerScore=matchInfo.entityNERConfidenceScore),{identifiedEngine:identifiedEngine,identifiedUsing:identifiedUsing,identifiedLabel:identifiedLabel,nerScore:nerScore}}};if($scope.getTraitsGroupsApi=function(){BTStreamsService.getTraitGroups($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$scope.traitGroups=angular.copy(res.data),$scope.allTraits={traits:[],negativeTraits:[]};var alltraitsArr=[],allTraitsNegations=[];$.each($scope.traitGroups,function(i,traits){$.each(traits.traits,function(j,trait){({groupId:traits._id,traitId:trait.traitId||j,traitName:trait.traitName});alltraitsArr.push(trait.traitName),allTraitsNegations.push("!"+trait.traitName)})}),$scope.allTraits.traits=_.uniq(alltraitsArr),$scope.allTraits.negativeTraits=_.uniq(allTraitsNegations)},function(err){$scope.loadingTraits=!1,"NO"!==accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE")&&NotificationService.notify(i18n.i18nString("failed_traits"),"error")})},"NO"!==accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE")&&$scope.getTraitsGroupsApi(),$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?task.isReport?"information":"action":task&&"dialog"==task.taskType?"flowtask":""},$scope.getAlltasks=function(){loadingEntities(streamId,"true")},$scope.upgradeWorkflow=function(task,type){"alert"===type?BTAlertsService.upgradeBTAlert(task._id).then(function(response){BTAlertsService.upgradeMPAlert(task._id,response.data._id).then(function(upgradeRes){BTAlertsService.configured(upgradeRes.data._id).then(function(configRes){$scope.identifiedTask=configRes.data[0],loadingEntities(streamId,"true"),$scope.verify(),$rootScope.$broadcast("upadteTaskData","alert",configRes.data[0]),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type||"information"===type?BTActionsService.upgradeBTAction(task._id).then(function(response){BTActionsService.upgradeMPAction(task._id,response.data._id).then(function(upgradeRes){BTActionsService.configured(upgradeRes.data._id).then(function(configRes){$scope.identifiedTask=configRes.data[0],loadingEntities(streamId,"true"),$rootScope.$broadcast("upadteTaskData","action",configRes.data[0]),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,task._id).then(function(res){res.data.taskType="dialog",$rootScope.$broadcast("upadteTaskData","flowTask",res.data),$scope.identifiedTask=res.data,loadingEntities(streamId,"true"),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.updateSynonyms=function(entityData){var key="state";if("DialogIntent"===$scope.identifiedTask.taskType&&(key="status"),"published"==$scope.identifiedTask[key])$scope.currentCb="updateSynonyms",$scope.currententityData=entityData,NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{var streamId=$scope.stream._id;"universalbot"===$scope.stream.type&&(streamId=$scope.currUniversalBotStreamId);var cmpId=entityData._id,synonyms=entityData.synonyms;BTFlowtaskService.updateComponentSynonyms(streamId,cmpId,{synonyms:synonyms}).then(function(res){mixpanelEvent("createEntitySynonyms"),$scope.editEntitySynonym=null,$scope.editEntitySynonymId=null,NotificationService.notify(i18n.i18nString("entity_synonyms_added_sucess_noty"),"success")},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_entity_synonym_failed");NotificationService.notify(msg,"error")})}},$scope.updatePatterns=function(cmpId,patterns,entityData,fromDelete){var key="state";if("DialogIntent"===$scope.identifiedTask.taskType&&(key="status"),"published"==$scope.identifiedTask[key])$scope.currentCb="updatePatterns",$scope.cmpId=angular.copy(cmpId),$scope.currentPatterns=angular.copy(patterns),$scope.currentEntityData=angular.copy(entityData),$scope.currentDeleteFormdetails=angular.copy(fromDelete),NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{var streamId=$scope.stream._id;BTFlowtaskService.updateComponentPatterns(streamId,cmpId,{patterns:patterns}).then(function(res){mixpanelEvent("createPattern"),res&&res.data&&(entityData.patterns=res.data.patterns),$scope.addFieldPatternSaving=!1,$scope.newFieldPattern.value="",fromDelete&&NotificationService.notify(i18n.i18nString("pattern_deleted_sucessfully_noty"),"success")},function(error){$scope.addFieldPatternSaving=!1;var msg=i18n.i18nString("patrn_module_dup_patrn_err");NotificationService.notify(msg,"error")})}},$scope.addFieldPattern=function(form,newPatternData,entityData){var key="state";if("DialogIntent"===$scope.identifiedTask.taskType&&(key="status"),"published"==$scope.identifiedTask[key])$scope.currentCb="addPattern",$scope.currentNewPatternData=angular.copy(newPatternData),$scope.currententityData=angular.copy(entityData),NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{var taskId,field,input;if(form.$invalid)return void form_util.touch(form);$scope.selectedField=newPatternData;var task=$scope.identifiedTask,type="l"==(taskId||task._id)[0]?"alert":"d"==(taskId||task._id)[0]?"dialog":"action",payload={fieldName:field||$scope.selectedField.title,input:input||$scope.newFieldPattern.value};if(taskId=taskId||task._id,field=field||$scope.newFieldPattern,$scope.addFieldPatternSaving=!0,"alert"==type)BTAlertsService.createFieldPattern(taskId,payload.fieldName,payload).then(function(res){keyValueSetter($scope.identifiedTask.fieldPatterns,$scope.selectedField.title,res.data),$scope.addFieldPatternSaving=!1,$scope.newFieldPattern.value=""},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_field_pattern_failed_err");NotificationService.notify(msg,"error"),$scope.addFieldPatternSaving=!1});else if("action"==type)BTActionsService.createFieldPattern(taskId,payload.fieldName,payload).then(function(res){keyValueSetter($scope.identifiedTask.fieldPatterns,$scope.selectedField.title,res.data),$scope.addFieldPatternSaving=!1,$scope.newFieldPattern.value=""},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_field_pattern_failed_err");NotificationService.notify(msg,"error"),$scope.addFieldPatternSaving=!1});else if("dialog"==type){var patterns=[];return patterns.push($scope.newFieldPattern.value),entityData.patterns&&entityData.patterns.map(function(obj){patterns.push(obj.original)}),void $scope.updatePatterns(entityData._id,patterns,entityData)}}},$scope.deleteFieldPattern=function(pattern,field,entityData,index){function confirmDeletePattern(){var intent=$scope.identifiedTask,type="l"==intent._id[0]?"alert":"d"==intent._id[0]?"dialog":"action",context={};if("alert"==type)context={alertId:intent._id,patternId:pattern.key,streamId:$scope.stream._id,fieldName:field.title},BTAlertsService.deleteFieldPattern(context).then(function(res){$scope.identifiedTask.fieldPatterns[field.title]=_.filter($scope.identifiedTask.fieldPatterns[field.title],function(_pattern){return _pattern.key!==pattern.key})},function(err){NotificationService.notify(i18n.i18nString("field_pattern_delete_failed"),"error")});else if("action"==type)context={actionId:intent._id,patternId:pattern.key,streamId:$scope.stream._id,fieldName:field.title},BTActionsService.deleteFieldPattern(context).then(function(res){$scope.identifiedTask.fieldPatterns[field.title]=_.filter($scope.identifiedTask.fieldPatterns[field.title],function(_pattern){return _pattern.key!==pattern.key})},function(err){NotificationService.notify(i18n.i18nString("field_pattern_delete_failed"),"error")});else if("dialog"==type){entityData.patterns.splice(index,1);var patterns=[];return entityData.patterns&&entityData.patterns.map(function(obj){patterns.push(obj.original)}),void $scope.updatePatterns(entityData._id,patterns,entityData,!0)}}var key="state";if("DialogIntent"===$scope.identifiedTask.taskType&&(key="status"),"published"==$scope.identifiedTask[key])$scope.currentCb="addPattern",$scope.currentPattern=angular.copy(pattern),$scope.currentField=angular.copy(field),$scope.currentEntitydata=angular.copy(entityData),$scope.currnetIndex=angular.copy(index),NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"));else{var msg=i18n.i18nString("do_you_want_to_delete_this_pattern");$rootScope.showConfirmationPopup(msg,confirmDeletePattern)}},!_.isObject($scope.stream)||_.isObject($scope.stream)&&0===Object.keys($scope.stream).length)return void goBack();$scope.getComponentsByDialogID=function(universalBotStreamId){var streamId=$workflowService.selectedStream()._id;if($scope.universalbot&&$scope.selectedBot){var curr_stream=JSON.parse($scope.selectedBot);streamId=curr_stream._id}else $scope.universalbot&&universalBotStreamId&&(streamId=universalBotStreamId);BTFlowtaskService.getFlowtaskComponents(streamId,$scope.identifiedTask._id).then(function(res){$scope.identifiedTask.entitiesArray=_.filter(res.data,{type:"entity"})||[];var entities=[];data=angular.copy($scope.intent);var mergedEntites=_.filter($scope.identifiedTask&&$scope.identifiedTask.entitiesArray||[],function(item){return data.response.finalResolver&&data.response.finalResolver.connectedNodes&&-1!==data.response.finalResolver.connectedNodes.indexOf(item._id)?_.extend(item,_.findWhere(data.response.finalResolver.entities&&data.response.finalResolver.entities.length&&data.response.finalResolver.entities||[],{componentID:item._id})):_.extend(item,_.findWhere(data.response.finalResolver.entities&&data.response.finalResolver.entities.length&&data.response.finalResolver.entities||[],{componentID:item._id}))});data.response.finalResolver.entities=angular.copy(mergedEntites),data.response.finalResolver.entities&&data.response.finalResolver.entities.map(function(entity){if(entity.field=entity.field||entity.name,entity.field){var obj={};obj.name=entity.field,obj.isArray=entity.isArray||"",obj._id=entity._id,obj.type=entity.entityType||entity.metadata||entity.fieldType,obj.componentId=entity.componentID||entity._id,obj.value=entity.value,obj.dataType=entity.entityType,obj.taskType=entity.taskType,obj.patterns=entity.patterns,obj.synonyms=entity.synonyms,obj.color=entity.color,obj["class"]=entity["class"],obj.position=entity.position,obj.matchInfo=prepareEntityMatchInfo(entity.entityMatchInfo&&entity.entityMatchInfo[0])||{},entities.push(obj)}}),data.response.finalResolver.entities=entities,$scope.intent=data,($scope.intent.response.finalResolver.entities||[]).map(function(entity,i){entity.color=entity.color||"#ddd"})})},$scope.editEntityType=function(task,field){$scope.addmeta={task:task,field:field},$scope.openEntity()},$scope.cancelEntity=function(){$timeout(function(){$(".add-meta").modal("hide")})},$scope.openEntity=function(){$timeout(function(){$(".add-meta").modal("show")})},$scope.eventHandlers={onKeyDown:function(event){13==event.keyCode&&"keydown"==event.type&&$timeout($scope.verify)}};var prepareTreeData=function(startIndex,treeArray){var depth=treeArray.length-1,leaf=[{title:treeArray[startIndex]}];return depth>startIndex&&(leaf[0].tree=prepareTreeData(startIndex+1,treeArray)),leaf[0].tree&&leaf[0].tree[0]?leaf[0].tree[0].title=decodePattern(leaf[0].tree[0].title):leaf[0].tree=decodePattern(leaf[0].tree),leaf[0].title=decodePattern(leaf[0].title),leaf};$scope.intentRecongnized=!1,$scope.runInProgress=!1,$scope.verify=function(manualTrigger){if($scope.nlp.text=getNLPText(),$(".keyword_highlight").html(getSanitizedText($scope.nlp.text)),!$scope.nlp.text)return void($scope.showUserSaysError=!0);$scope.testing=!0,entityColors={},$scope.utterence=null,$scope.intentNotFound=!1,$scope.verifying=!1;var payload={input:$scope.nlp.text&&$scope.nlp.text.trim(),streamName:$scope.stream.name,timezone:moment.tz.guess(),isDeveloper:"indevelopment"===$workflowService.selectedStreamState()?!0:!1};$scope.parentIntent.name&&$scope.parentIntent.name!==i18n.i18nString("bot_level_intent_model_label")&&(payload.parentIntent=$scope.parentIntent.name),$(".testbotscroll").scrollTop(0),$scope.runInProgress=!0,$scope.debugInfo[$scope.debugkeys.utteranceSent]=payload,$scope.debuggerConsole.requestData=payload,$scope.identifiedTask=null,BTStreamsService.testNlp($scope.stream._id,payload).then(function(res){if(console.log($scope.allDialogTasks),$scope.trainBotCB.closeEditPanel(),res.data.response&&res.data.response.finalResolver&&res.data.response.finalResolver.ranking&&(res.data.response.finalResolver.ranking=_.uniq(res.data.response.finalResolver.ranking,"taskId")),res.data.response&&res.data.response.finalResolver&&res.data.response.finalResolver.winningIntent){var winningIntents=[];angular.forEach(res.data.response.finalResolver.winningIntent,function(task){if("FAQ"===task.activityType)winningIntents.push(task);else{var idx=_.findIndex(winningIntents,function(winningIntent){return winningIntent.taskId===task.taskId});-1===idx&&winningIntents.push(task)}}),res.data.response.finalResolver.winningIntent=winningIntents}res.data.response&&res.data.response.finalResolver&&res.data.response.finalResolver.winningIntent&&1===res.data.response.finalResolver.winningIntent.length&&$scope.universalbot&&($scope.currUniversalBotStreamId=res.data.response.finalResolver.winningIntent[0].streamId,loadingEntities(res.data.response.finalResolver.winningIntent[0].streamId,"false",function(){var _obj={response:$scope.nlpData};$scope.intent=arrangeData(_obj,$scope.currUniversalBotStreamId)})),$scope.nlpData=res.data.response,$scope.nlpData&&($scope.nlpData.input=res.data.input||[$scope.nlp.text]),res.data&&res.data.response&&res.data.response.hasOwnProperty("intentRescoring")&&!res.data.response.intentRescoring&&"universalbot"===$scope.stream.type&&($scope.nlpData.showIntentRankResolve=!0),res.data&&res.data.response&&res.data.response.hasOwnProperty("intentRescoring")&&!res.data.response.intentRescoring&&"universalbot"!==$scope.stream.type&&($scope.nlpData.intentRescoringDisabled=!0),res.data&&res.data.response&&res.data.response.hasOwnProperty("isPreferDefinitiveMatch")&&!res.data.response.isPreferDefinitiveMatch&&"universalbot"!==$scope.stream.type&&($scope.nlpData.isPreferDefinitiveMatchDisabled=!0),$scope.trainBotCB.loadData($scope.nlpData),$scope.showNote=!1,$scope.debuggerConsole.responseData=res.data,$scope.debugInfo[$scope.debugkeys.utteranceRecieve]=res.data,$scope.chooseTask="",$scope.selectedTask=null,$scope.knowledgeData={},$scope.knowledgeData.questions=[],$scope.richEditorInitialStage="esc",$scope.intentVerified=!0;var data=JSON.stringify(res.data);if(data=data.replace(/emptystring/g,""),data=JSON.parse(data),$scope.intent=arrangeData(data),delete $scope.debugInfo["Intent Match Analysis"],$scope.debugInfo["Intent Match Analysis"]=$scope.formatIntentMatchData(res.data.response)||[],$scope.debuggerConsole.requestData=res.data.request,$scope.debuggerConsole.responseData=res.data.response,$scope.intent.nlptext=$scope.nlp.text,$scope.intent.pattern=i18n.i18nString("intent_identified_based_on_pattern_match"),$scope.verifying=!0,($scope.intent.response.finalResolver&&$scope.intent.response.finalResolver.entities||[]).map(function(entity,i){entity.color="#ddd"}),data.response.finalResolver&&data.response.finalResolver.winningIntent&&data.response.finalResolver.winningIntent.length>0&&data.response.finalResolver.winningIntent[0].intent){if($scope.intentRecongnized=!0,$scope.addTrainBotIntentLogs(payload,data),$scope.debugInfo[$scope.debugkeys.intentMatch+" Successful"]=data.response.finalResolver.winningIntent[0].intent,delete $scope.debugInfo[$scope.debugkeys.intentMatch],"smalltalk"===data.response.finalResolver.winningIntent[0].activityType){var treeArray=data.response.finalResolver.winningIntent[0].graph;$scope.tree=prepareTreeData(0,treeArray)}data.response.finalResolver.winningIntent.length>1&&(delete $scope.debugInfo[$scope.debugkeys.intentMatch+" Successful"],$scope.debugInfo[$scope.debugkeys.intentMatch]="None"),$scope.intentNotFound=!1}else $scope.debugInfo[$scope.debugkeys.intentMatch]="None",delete $scope.debugInfo[$scope.debugkeys.intentMatch+" Successful"],$scope.intentNotFound=!0;$scope.testing=!1,$scope.runInProgress=!1,$scope.multipleIntent={},$scope.multipleIntent.selectedTask="",$scope.intent.response&&$scope.intent.response.finalResolver&&$scope.intent.response.finalResolver.winningIntent&&$scope.intent.response.finalResolver.winningIntent[0]&&$scope.intent.response.finalResolver.winningIntent[0].matchedPattern&&($scope.intent.response.finalResolver.winningIntent[0].matchedPattern=decodePattern($scope.intent.response.finalResolver.winningIntent[0].matchedPattern)),$scope.nlpData&&$scope.nlpData.finalResolver&&$scope.nlpData.finalResolver.winningIntent&&$scope.nlpData.finalResolver.winningIntent[0]&&$scope.nlpData.finalResolver.winningIntent[0].intent&&($scope.nlpData.finalResolver.winningIntent[0].intent=decodePattern($scope.nlpData.finalResolver.winningIntent[0].intent)),$scope.intent.response&&$scope.intent.response.finalResolver&&$scope.intent.response.finalResolver.winningIntent&&$scope.intent.response.finalResolver.winningIntent.length>1&&($scope.multipleIntent.selectedTask="none")},function(err){if($scope.debuggerConsole.responseData=err,$scope.nlp.text="",$scope.verifying=!1,$scope.intent={},$scope.runInProgress=!1,$scope.testing=!1,!(err&&err.data&&err.data.errors&&err.data.errors.length&&err.data.errors[0]&&err.data.errors[0].code&&4291===err.data.errors[0].code)){var msg=getErrorMsg(err,i18n.i18nString("nlp_verification_failed"));NotificationService.notify(msg,"error")}})},$scope.formatIntentMatchData=function(intentMatchLogs){function modifyObject(key1,key2,value,data){if(data[value]){if(key2?(data[key1]=data[key1]||{},data[key1][key2+" ("+data[value].debugTitle.slice(data[value].debugTitle.indexOf(":")+2)+") "]=data[value]):key2||(data[key1]=data[value]),"taskNameAnalysis"==value){var _wordBreakDown=data[value].wordBreakdown||[],_wordBreakDownTemp=[];$.each(_wordBreakDown,function(i,wordBreak){var serializedString=Object.keys(wordBreak).map(function(k){return k+": "+wordBreak[k]}).join(", ");_wordBreakDownTemp[serializedString]=void 0}),data[value].wordBreakdown=_wordBreakDownTemp,data[key1][key2+" ("+data[value].debugTitle.slice(data[value].debugTitle.indexOf(":")+2)+") "]=data[value]}key2&&delete data[value].debugTitle,delete data[value]}}var intentMatchData=intentMatchLogs.intentMatch||[],_tempIntentMatchData=[];return $.each(intentMatchData,function(i,data){modifyObject(i18n.i18nString("machine_modal_classification_score"),"",i18n.i18nString("ml_score"),data),modifyObject(i18n.i18nString("rule_engine_score"),"",i18n.i18nString("total_score"),data),modifyObject(i18n.i18nString("rules_applied"),i18n.i18nString("word_scoring_rules"),i18n.i18nString("word_scoring"),data),modifyObject(i18n.i18nString("rules_applied"),i18n.i18nString("bonus_scoring_rules"),i18n.i18nString("bonus_scoring"),data),modifyObject(i18n.i18nString("rules_applied"),i18n.i18nString("penality_scoring_rules"),i18n.i18nString("penality_scoring"),data),modifyObject(i18n.i18nString("rules_applied"),i18n.i18nString("task_naming_rules"),i18n.i18nString("task_name_analysis"),data),_tempIntentMatchData["Number of intents matched"]=(intentMatchData||[]).length,data.name==($scope.intent&&1==$scope.intent.intent.length&&$scope.intent.intent[0].name)?_tempIntentMatchData[data.name+" (Winning Intent) "]=data:_tempIntentMatchData[data.name]=data,delete data.debugTitle,delete data.foundInSentence,delete data.activityType,delete data.type,delete data.name}),_tempIntentMatchData},$scope.addTrainBotIntentLogs=function(payloadData,responseDetails,isFromDone){var payload={};$scope.callFrom&&"analyzeTrain"===$scope.callFrom?(payload={result:"success",time:Date.now(),mainbot:"kora",bot:$workflowService.selectedStream().name,task:responseDetails.response.finalResolver.winningIntent[0].intent,input:[payloadData.input],output:responseDetails.response.finalResolver.winningIntent[0].intent,server:API_SERVER_URL+API_URL_PREFIX,userid:$applicationService.userInfo().userId,botid:$workflowService.selectedStream()._id,logSequenceId:$scope.analyzerecord.koralogstatusId,taskId:$scope.analyzerecord.taskId},BTStreamsService.trainBotIntentLogs($scope.stream._id,payload).then(function(res){var data=JSON.stringify(res.data);data=data.replace(/emptystring/g,""),data=JSON.parse(data),$scope.trainbotintent={},$scope.trainbotintent.logid=data._id,isFromDone&&$scope.trainBot()},function(err){})):(payload=[],responseDetails.response.finalResolver.winningIntent.forEach(function(val){var obj={result:"success",time:Date.now(),mainbot:"kora",bot:$workflowService.selectedStream().name,task:val.intent,input:[payloadData.input],output:val.intent,server:API_SERVER_URL+API_URL_PREFIX,userid:$applicationService.userInfo().userId,botid:$workflowService.selectedStream()._id,logSequenceId:responseDetails.seqLogId,taskId:val.taskId};payload.push(obj)}),BTStreamsService.trainBotIntentBunchLogs($scope.stream._id,payload).then(function(res){var data=JSON.stringify(res.data);data=data.replace(/emptystring/g,""),data=JSON.parse(data),$scope.trainbotintent={},$scope.trainbotintent.logid=data._id,isFromDone&&$scope.trainBot()},function(err){}))},$scope.learnInProgress=!1,$scope.$watch("nlp.text",function(newVal,oldVal){newVal&&newVal.trim()?($scope.showUserSaysError=!1,oldVal||($scope.richEditorInitialStage="enter")):($scope.clear(),$scope.intentVerified=!1)}),$scope.addUtteranceAndTrainBot=function(){if($scope.selectedTask){if(!$scope.nlp.text||!$scope.nlp.text.trim())return $scope.showUserSaysError=!0,void $(".testbotscroll").scrollTop(0);if("knowledge"===$scope.selectedTask.taskType)return $scope.selectedQuestion?($scope.selectedQuestion.subQuestions.push($scope.nlp.text.trim()),void $scope.updateQuestionAnswers()):void NotificationService.notify(i18n.i18nString("selected_collection_doesnt_have_faq"),"error");var payload={taskId:"dialog"!==$scope.selectedTask.taskType?$scope.selectedTask._id:$scope.selectedTask.nodes[0].componentId,taskName:$scope.selectedTask.name,sentence:$scope.nlp.text.trim(),streamId:$scope.stream._id,type:"dialog"!==$scope.selectedTask.taskType?$scope.selectedTask.taskType:"DialogIntent"};$scope.ml.utteranceText="",$scope.learnInProgress=!0,BTStreamsService.createUtterances(payload).then(function(res){mixpanelEvent("createUtterance"),$scope.$emit("updateChecklist","machineLearningUtterances"),$scope.trainBot(),$scope.learnInProgress=!1,NotificationService.notify(i18n.i18nString("utterance_created_sucess_noty"),"info")},function(err){$scope.learnInProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})}},$scope.removeTrainBotIntentLogs=function(){var logids=[];logids.push($scope.trainbotintent.logid);var loader=NotificationService.loader(i18n.i18nString("pleasewait"));BTStreamsService.removeTrainBotIntentLogs($scope.stream._id,logids).then(function(res){loader();var responseData={_id:null,name:null,intent:[{name:null}],Entities:[],response:{finalResolver:{winningIntent:[]}}},data=JSON.stringify(responseData);data=data.replace(/emptystring/g,""),data=JSON.parse(data),$scope.identifiedTask=null,$scope.intent=arrangeData(data),$scope.intent.nlptext=$scope.nlp.text,$scope.intent.pattern=i18n.i18nString("intent_identified_based_on_pattern_match"),$scope.verifying=!0,($scope.intent.response.finalResolver.entities||[]).map(function(entity,i){entity.color="#ddd"}),$scope.testing=!1,$scope.nlp.text=getNLPText(),$(".keyword_highlight").html(getSanitizedText($scope.nlp.text))},function(err){loader()})},String.prototype.escapeHTML=function(){var escapeTokens={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"},htmlTags=/[<>"']/g;return(""+this).replace(htmlTags,function(match){return escapeTokens[match]})},$scope.getTextColor=function(value){return"Not Found"!=value&&value?"#999":"#ddd"},$scope.getClassName=function(value){return"Not Found"!=value&&value?"valuematch":"valuenotmatch"},$scope.getColorByEntity=getColorByEntity,$scope.context.mapColorEntityToWord=mapColorEntityToWord,$scope.entityCmpt={},$scope.context.api.mapEntityToWord=function(selectedSentence,entityID){console.log(selectedSentence),console.log(entityID);var focusedUtterance=$scope.nlp.text&&$scope.nlp.text.trim();console.log(focusedUtterance),console.log($scope.entityCmpt.startEndIndex),$.each($scope.intent.response.finalResolver.entities,function(i,intentEntity){if(entityID==intentEntity.componentId)if(intentEntity.isArray)if(intentEntity.value instanceof Array)intentEntity.value.push(selectedSentence);else{var value=angular.copy(intentEntity.value);intentEntity.value=[],value&&intentEntity.value.push(value),intentEntity.value.push(selectedSentence)}else intentEntity.value=selectedSentence});var selectedTaskID="dialog"==$scope.identifiedTask.taskType?$scope.identifiedTask.nodes[0].componentId:$scope.identifiedTask._id,selectedTaskType="dialog"==$scope.identifiedTask.taskType?"DialogIntent":$scope.identifiedTask.taskType,payload={taskId:selectedTaskID,sentence:focusedUtterance,streamId:streamId,taskName:$scope.identifiedTask.name,type:selectedTaskType};selectedSentence=focusedUtterance.substring($scope.entityCmpt.startEndIndex.start,$scope.entityCmpt.startEndIndex.end);var indexAfterTrim=selectedSentence.length-selectedSentence.trim().length;payload.entities=[];var sentenceEntObject={startIndex:$scope.entityCmpt.startEndIndex.start,endIndex:$scope.entityCmpt.startEndIndex.end-indexAfterTrim,entityId:entityID};if(payload.entities.push(sentenceEntObject),$scope.utterence){if($scope.utterence.entities&&$scope.utterence.entities.length){$.each($scope.utterence.entities,function(i,entity){(sentenceEntObject.startIndex<=entity.startIndex&&sentenceEntObject.endIndex>=entity.startIndex||sentenceEntObject.startIndex<=entity.endIndex&&sentenceEntObject.endIndex>=entity.endIndex||sentenceEntObject.startIndex>=entity.startIndex&&sentenceEntObject.endIndex<=entity.endIndex||sentenceEntObject.startIndex<=entity.startIndex&&sentenceEntObject.endIndex>=entity.endIndex)&&delete $scope.utterence.entities[i]});var tempEntitesArray=$scope.utterence.entities||[];tempEntitesArray=_.without(tempEntitesArray,null),tempEntitesArray=_.without(tempEntitesArray,void 0),payload.entities=[].concat(payload.entities,tempEntitesArray),$scope.utterence=payload}}else $scope.utterence=payload},$scope.knowledgeData={},$scope.knowledgeData.questions=[],$scope.getFaqsByKnowledge=function(knowledgeTaskId){var searchParam="",loader=NotificationService.loader(i18n.i18nString("please_wait_noty"));BTStreamsService.getOrSearchFAQS($applicationService.userInfo.userId,knowledgeTaskId,searchParam,0,1e3).then(function(response){loader(),$scope.knowledgeData=$scope.knowledgeData||{},$.each(response.data.faqs,function(i,questionsObject){response.data.faqs[i].subQuestionsToView=[],response.data.faqs[i].subQuestionsToView.push(response.data.faqs[i].question),questionsObject.subQuestions=questionsObject.subQuestions||[],$.each(questionsObject.subQuestions,function(j,subQuestionItem){response.data.faqs[i].subQuestionsToView.push(subQuestionItem)}),response.data.faqs[i].subAnswersToView=[],response.data.faqs[i].subAnswersToView.push(response.data.faqs[i].answer),questionsObject.subAnswers=questionsObject.subAnswers||[],$.each(questionsObject.subAnswers,function(j,subAnswerItem){response.data.faqs[i].subAnswersToView.push(subAnswerItem)})}),$scope.knowledgeData.questions=response.data.faqs})},$scope.updateQuestionAnswers=function(){var qaObject={question:$scope.selectedQuestion.question,answer:$scope.selectedQuestion.answer,_id:$scope.selectedQuestion._id,knowledgeTaskId:$scope.selectedTask._id,subQuestions:$scope.selectedQuestion.subQuestions,subAnswers:$scope.selectedQuestion.subAnswers,streamId:$workflowService.selectedStream()._id};$scope.learnInProgress=!0,BTStreamsService.updateFAQ($applicationService.userInfo().userId,qaObject,qaObject._id).then(function(response){response.data.subQuestionsToView=response.data.subQuestionsToView||[],angular.copy(response.data.subQuestions,response.data.subQuestionsToView),response.data.subQuestionsToView.unshift(response.data.question),response.data.subAnswersToView=response.data.subAnswersToView||[],angular.copy(response.data.subAnswers,response.data.subAnswersToView),response.data.subAnswersToView.unshift(response.data.answer),$scope.trainBot(),$scope.learnInProgress=!1,$scope.selectedQuestion=response.data;var index="";$.each($scope.knowledgeData.questions,function(i,questonsData){$scope.selectedQuestion._id===questonsData._id&&(index=i,$scope.knowledgeData.questions[i]=$scope.selectedQuestion)}),console.log($scope.knowledgeData.questions),$("#select3").select2("data",index),console.log($("#select3").select2("data")),$timeout(function(){$("#select3").trigger("change")}),NotificationService.notify(i18n.i18nString("question_and_answers_updated_sucess"),"success")},function(res){$scope.learnInProgress=!1,$scope.selectedQuestion.subQuestions.splice($scope.selectedQuestion.subQuestions.length-1,1);var $pickQuestionID=$("#select3");console.log($pickQuestionID.select2("data")),$pickQuestionID.select2("data",""),$timeout(function(){$pickQuestionID.trigger("change")}),NotificationService.notify(res.data.errors[0].msg,"error")})},$scope.selectQuestion=function(question){(question||0===question)&&(question=$scope.knowledgeData.questions[question],$scope.selectedQuestion=question)},$scope.selecTask=function(task){setTimeout(function(){return $scope.selectedTask=JSON.parse(task),"knowledge"===$scope.selectedTask.taskType?void $timeout(function(){$scope.closeTrainBotModal($scope.ktData),$scope.$emit("openOntology")},100):($scope.knowledgeData.questions=[],$scope.selectedQuestion=null,$scope.$broadcast("reloadML"),void 0)},70)},$scope.openOntology=function(){$timeout(function(){$scope.closeTrainBotModal($scope.ktData),$scope.$emit("openOntology")},100)},$scope.selectIntentFromMultiple=function(taskId){"none"===taskId?($scope.selectedTask=null,$scope.chooseTask=""):($scope.selectedTask=null,$scope.chooseTask="",$scope.tasksByType.forEach(function(eachTask,index){for(var i=0;i<eachTask.tasks.length;i++)eachTask.tasks[i]._id===taskId&&($scope.chooseTask=JSON.stringify(eachTask.tasks[i]),$scope.selecTask($scope.chooseTask))}))},$scope.selectBot=function(bot){$scope.universalbot?loadingEntities(JSON.parse(bot)._id,"true"):loadingEntities(JSON.parse(bot)._id)},$scope.selectUniversalBot=function(taskId,streamId){loadingEntities(streamId,"false",function(){$scope.selectIntentFromMultiple(taskId)})},$scope.$watch("tasks",function(newVal,oldVal){
saveSynonymAtBot(newVal)},!0),$scope.saveEntity=function(){var payload,task=$scope.tasks.filter(function(task){return task.name==$scope.addmeta.task})[0],id=task._id;task.alertFieldsDefinition?(task.alertFieldsDefinition.map(function(field){field.title===$scope.addmeta.field&&(field.metadata=$scope.addmeta.metadata)}),payload={alertFieldsDefinition:task.alertFieldsDefinition,allowEdit:!0},BTAlertsService.createBTAlertUp(id,payload).then(function(res){$scope.cancelEntity(),NotificationService.notify(i18n.i18nString("entity_type_added_sucess_noty"),"success")},function(err){var msg=getErrorMsg(err,i18n.i18nString("synonyms_adding_failed"));NotificationService.notify(msg,"error")})):(task.payloadField.map(function(field){field.title===$scope.addmeta.field&&(field.metadata=$scope.addmeta.metadata)}),task.queryField.map(function(field){field.title===$scope.addmeta.field&&(field.metadata=$scope.addmeta.metadata)}),payload={payloadField:task.payloadField,queryField:task.queryField,allowEdit:!0},BTActionsService.updateBTAction(id,payload).then(function(res){$scope.cancelEntity(),NotificationService.notify(i18n.i18nString("entity_type_added_sucess_noty"),"success")},function(err){var msg=getErrorMsg(err,i18n.i18nString("synonyms_adding_failed"));NotificationService.notify(msg,"error")}))},$scope.clear=function(){$scope.nlp={text:""},$scope.intent={},$scope.verifying=!1,$scope.testing=!1,$scope.intentNotFound=!1,$scope.selectedTask=null,$scope.knowledgeData={},$scope.knowledgeData.questions=[],$scope.identifiedTask=null,$scope.utterence=null},$scope.trainBotCB.getEntityValue=function(entityObject){var entityValue=entityObject.value;if(!entityValue&&0!==entityValue||"undefined"==typeof entityValue||void 0===entityValue)return"Not Found";if(entityValue instanceof Array){if("currencyv2"==entityObject.fieldType||"currencyv2"==entityObject.type){var res=entityValue[0][0].amount.toLocaleString("en-US",{style:"currency",currency:entityValue[0][0].code});return res}return entityValue[0]instanceof Array?entityValue.join(","):entityValue[0]instanceof Object?Object.values(entityValue[0]).join(","):entityValue.join(",")}if(entityValue instanceof Object)return entityValue="location"==entityObject.fieldType||"location"==entityObject.type?entityValue.formatted_address:"country"==entityObject.fieldType||"country"==entityObject.type?entityValue.shortName:entityValue[Object.keys(entityValue)];if("date"===entityObject.type){var date=new Date(entityObject.value);return moment(date).format("MM-DD-YYYY")}return"datetime"===entityObject.type?getDate(entityObject.value)+" "+getTime(entityObject.value):entityValue},$scope.isEntity=function(task){return task._id?-1!==task._id.indexOf("dc"):!1},$scope.initializePopover=function(id,index){var _id="#"+id;void 0!==index&&null!==index&&(_id+=index),setTimeout(function(){$(_id).popover()},200)},$scope.dialogTasksData=[],$scope.$on("checkAndRemoveUtterance",function(evt,id){$scope.utterence._id==id&&($scope.utterence=null)}),$scope.startTrain=function(){$scope.trainBot("intentNotMatch")},$scope.isLearnSuccess=!1,$scope.learnSuccessStatus=!1,$scope.trainBot=function(from){$scope.trainFrom="intentMatch",from&&($scope.trainFrom="intentNotMatch");var selectedTaskType=$scope.selectedTask&&$scope.selectedTask.taskType||$scope.identifiedTask&&$scope.identifiedTask.taskType;return"knowledge"===selectedTaskType?void BTStreamsService.trainFaq($workflowService.selectedStream()._id).then(function(res){$scope.isLearnSuccess=!0,$scope.learnSuccessStatus=!0,$timeout(function(){$scope.learnSuccessStatus=!1},1e3),$rootScope.$emit("triggerAutoTrainStatusPoll"),NotificationService.notify(i18n.i18nString("knowledge_task_utterance_trained_initiated_noty"),"info")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("problem_in_training_knowledge_task_noty"),"error"),$scope.$broadcast("trainFinished")}):void BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$scope.isLearnSuccess=!0,$rootScope.$emit("triggerAutoTrainStatusPoll"),NotificationService.notify(i18n.i18nString("utterance_train"),"info")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("problem_in_training_knowledge_task_noty"),"error"),$scope.$broadcast("trainFinished")})},$rootScope.$on("clearTestTrainText",function($evenr){$scope.nlp.text=""}),$rootScope.$on("TestTrainUtterencesTrainFinished",function($event){return finishSaving(".utteranceInput"),$scope.callFrom&&"analyzeTrain"===$scope.callFrom&&updateTrainedInfo($scope.analyzerecord),"intentNotMatch"===$scope.trainFrom?($scope.trainFrom="",void $scope.$broadcast("trainFinished")):void(($scope.nlp.text||!$scope.nlp.text.trim())&&$scope.verify())}),$scope.saveOrUpdateUtterance=function(options,value){var _streamId;if($scope.nlp.text||!$scope.nlp.text.trim()){_streamId="universalbot"===$scope.stream.type?$scope.intent.response.finalResolver.winningIntent[0].streamId:$workflowService.selectedStream()._id,$scope.publishedMode=!1;var selectedTaskID="dialog"==$scope.identifiedTask.taskType?$scope.identifiedTask.nodes[0].componentId:$scope.identifiedTask._id;$scope.identifiedTask.isPublishedVersion&&!value&&($scope.identifiedTask.actualId=$scope.identifiedTask._id,$scope.identifiedTask._id=$scope.identifiedTask.parentId,NotificationService.alert(i18n.i18nString("add_utter_published_noty"),[$scope.upgrade,$scope.cancelUpgrade],{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("sure_msg")),$scope.publishedMode=!0);var payload={taskId:selectedTaskID,sentence:$scope.nlp.text.trim(),entities:$scope.utterence&&$scope.utterence.entities||[],streamId:_streamId,type:$scope.identifiedTask.taskType,taskName:$scope.identifiedTask.name};"dialog"===payload.type&&(payload.type="DialogIntent"),$scope.utterence=null,$scope.utterence&&$scope.utterence._id?$scope.editUtterence(payload,!0):$scope.publishedMode||getUtterances(payload)}},$scope.$watchCollection("utterence",function(newVal,oldVal){var nlpText=$scope.nlp.text&&$scope.nlp.text.trim();nlpText&&$scope.utterence&&$.each($scope.intent.response.finalResolver.entities,function(i,entity){$.each($scope.utterence.entities,function(i,uEntity){if("dialog"==$scope.identifiedTask.taskType){if(uEntity.entityId==entity._id)return}else if(uEntity.entityId==entity._id)return})})}),$scope.$watch("entity",function(oldVal,newVal){console.log("entity changed")},!0),$scope.$watchCollection("intent.response.finalResolver.entities",function(newVal,oldVal){var nlpText=$scope.nlp.text&&$scope.nlp.text.trim();nlpText&&$scope.utterence&&$scope.utterence._id&&$scope.intent.response.finalResolver.entities&&$scope.intent.response.finalResolver.entities.length&&$.each($scope.intent.response.finalResolver.entities,function(i,entity){$.each($scope.utterence.entities,function(i,uEntity){if("dialog"==$scope.identifiedTask.taskType){if(uEntity.entityId==entity._id)return entity.value=nlpText.substring(uEntity.startIndex,uEntity.endIndex),void(entity["class"]="color-circle")}else if(uEntity.entityId==entity.key)return entity.value=nlpText.substring(uEntity.startIndex,uEntity.endIndex),void(entity["class"]="color-circle")})})}),$scope.addUtterance=function(payload){"information"===$scope.activeType&&(payload.type="action"),startSaving(".mainUtteranceInput"),BTStreamsService.createUtterances(payload).then(function(res){mixpanelEvent("createUtterance"),$scope.$emit("updateChecklist","machineLearningUtterances"),finishSaving(".mainUtteranceInput"),$scope.utterence=res.data,$scope.utterenceCopy=angular.copy($scope.utterence),$scope.utteranceText="",$scope.count++,NotificationService.notify(i18n.i18nString("utterance_created_sucess_noty"),"info"),$scope.verify()},function(err){finishSaving(".mainUtteranceInput","error"),err.data&&err.data.errors&&err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("problm_in_training_utter_noty"),"error")})},$scope.editUtterence=function(payload,dontTrain){startSaving(".utteranceInput"+$scope.utterence._id),saveEditedUtterance(payload,dontTrain)},$scope.closeTrainBotModal=function(knowledgetasks){$(document).off("click.entity"),$(document).off("click.train"),"configured"==knowledgetasks[0].state?$workflowService.taskEditInfo(knowledgetasks[0]):$workflowService.taskEditInfo(knowledgetasks[1])},$scope.expand=function(index){$scope.showIndex=$scope.showIndex==index?-1:index},$scope.validateFieldPattern=function(){return{test:function(value){return value&&value.split("*").length-1===1?!0:!1}}}(),function(id){init(),$scope.universalbot||loadingEntities(id)}(streamId)}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTUtterancesCtrl",["$scope","$rootScope","$translator","$modalInstance","$workflowService","BTStreamsService","config","BTFlowtaskService","NotificationService","mixPanel",function($scope,$rootScope,$translator,$modalInstance,$workflowService,BTStreamsService,config,BTFlowtaskService,NotificationService,mixPanel){function init(){$scope.stream=$workflowService.selectedStream(),$scope.component=config.component.nodeInfo,$scope.firstNodeComponentId=config.component.dialogInfo.firstNodeComponentId,$scope.saveInProgress=!1,$scope.utterances=[],$scope.utterancesCopy=[],getUtterances($scope.component.utterances),$scope.enterpriseLicenseType=$rootScope.licenseType,$scope.props={headers:[],params:[],endPoint:{}},$scope.utterancesCopy=angular.copy($scope.utterances)}function getUtterances(utterances){if(utterances)for(var i=0;i<utterances.length;i++)""===utterances[i].sentence&&(utterances.splice(i,1),i--);$scope.utterances=utterances;var obj={sentence:""};$scope.utterances||($scope.utterances=[]),$scope.utterances.push(obj)}function startSaving(className){$(className).addClass("fa fa-refresh fa-spin")}function finishSaving(className,isError){$(className).removeClass("fa fa-refresh fa-spin"),setTimeout(function(){"error"===isError?$(className).addClass("fa fa-times"):$(className).addClass("fa fa-check")},10),setTimeout(function(){$(className).removeClass("fa fa-check fa-times")},3e3)}function focusElement(initPageload){if(initPageload)setTimeout(function(){$(".sentenceInputEle"+($scope.utterances.length-1)).show().focus(),$(".sentenceInputEle"+($scope.utterances.length-2)).show().focus()},50);else for(var i=0;i<$scope.utterances.length;i++)if(""===$scope.utterances[i].sentence){setTimeout(function(){$(".sentenceInputEle"+i).show().focus()},100);break}}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createUtterance"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Intent Utterance Added"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}$scope.training=i18n.i18nString("training_label2"),$scope.train=i18n.i18nString("train"),setTimeout(function(){focusElement(!0)},500),$scope.addUtterance=function(index){if($scope.utterances.length-1===index){var obj={sentence:""};$scope.utterances.push(obj)}},$scope.removeUtterance=function(utterance,index){startSaving(".saveUtterance"+index),utterance._id?$scope.deleteUtterance(utterance,index):$scope.utterances.splice(index,1)},$scope.closeModal=function(){$modalInstance.close()},$scope.trainBot=function(){$scope.traingInProgress=!0,BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$scope.traingInProgress=!1,NotificationService.notify(i18n.i18nString("utterances_trained_sucessfully"),"info"),$scope.closeModal()},function(err){$scope.traingInProgress=!1,err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("utterences_training_intiated_err"),"error")})},$scope.pendingAction=[],$scope.save=function(){if($scope.isReqPending)$scope.pendingAction.push($scope.save);else{for(var sentences=[],i=0;i<$scope.utterances.length;i++)""!==$scope.utterances[i].sentence&&sentences.push($scope.utterances[i]);config&&config.cbBridge&&config.cbBridge.onServiceSave&&config.cbBridge.onServiceSave(sentences),$scope.trainBot()}},$scope.$watch("isReqPending",function(newval,oldval){newval===!1&&$scope.pendingAction.length&&$scope.pendingAction[0].call()}),$scope.saveUtterance=function(utterance,index){""!==utterance.sentence&&(startSaving(".saveUtterance"+index),utterance._id?$scope.editUtterence(utterance,index):$scope.saveUtteranceToServer(utterance,index))},$scope.saveUtteranceToServer=function(utterance,index){$scope.saveInProgress=!0;var payload={taskId:$scope.component._id,sentence:utterance.sentence,streamId:$scope.component.streamId,type:"DialogIntent"};BTStreamsService.createUtterances(payload).then(function(res){mixpanelEvent("createUtterance"),$scope.$emit("updateChecklist","machineLearningUtterances"),finishSaving(".saveUtterance"+index),$scope.utterances[index]=res.data,$scope.utterancesCopy[index]=res.data,$scope.saveInProgress=!1,focusElement(!1)},function(err){if($scope.saveInProgress=!1,finishSaving(".saveUtterance"+index,"error"),err.data.errors.length>0&&409===err.data.errors[0].code&&"Utterance already exists with same name"===err.data.errors[0].msg)NotificationService.notify(err.data.errors[0].msg,"error");else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(err.data.errors[0].msg,"error");$scope.utterances[index].sentence="",$scope.utterancesCopy[index]=""})},$scope.deleteUtterance=function(utterance,index){$scope.saveInProgress=!0;var payload={taskId:$scope.component._id,streamId:$scope.component.streamId,type:"DialogIntent"};BTStreamsService.deleteUtterances(payload,utterance._id).then(function(res){finishSaving(".saveUtterance"+index),$scope.saveInProgress=!1,$scope.utterances.splice(index,1),$scope.utterancesCopy.splice(index,1),focusElement(!1)},function(err){finishSaving(".saveUtterance"+index,"error"),focusElement(!0)})},$scope.editUtterence=function(utterance,index){$scope.saveInProgress=!0;var payload={taskId:$scope.component._id,sentence:utterance.sentence,streamId:$scope.component.streamId,type:"DialogIntent"};$scope.isReqPending=!0,BTStreamsService.editUtterances(payload,utterance._id).then(function(res){$scope.isReqPending=!1,$scope.utterancesCopy[index].sentence=utterance.sentence,finishSaving(".saveUtterance"+index),$scope.saveInProgress=!1,focusElement(!1)},function(err){$scope.pendingAction=[],$scope.isReqPending=!1,409===err.status&&(utterance.sentence=$scope.utterancesCopy[index].sentence,$scope.editUtterence(utterance,index),NotificationService.notify(i18n.i18nString("duplicate_utterance"),"error")),finishSaving(".saveUtterance"+index,"error")}),$scope.editId=-1},function(){init()}()}])}(angular),function(ng){var _module=angular.module("bt-variable-management",["ngSanitize","ngCsv"]);_module.directive("btVariableManagement",function(){return{restrict:"EA",scope:{callback:"=?",btcallback:"=",context:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-variableManagement/bt-variableManagement.html",controller:["$scope","$workflowService","$element","BTFlowtaskService","$timeout","NotificationService","$location","$endpoints","$applicationService","env_conf","BTStreamsService","BTFileUploadService","$interval","$rootScope","$filter","accessControlService","_constants_","i18n",function($scope,$workflowService,$element,BTFlowtaskService,$timeout,NotificationService,$location,$endpoints,$applicationService,env_conf,BTStreamsService,BTFileUploadService,$interval,$rootScope,$filter,accessControlService,_constants_,i18n){function startPollImportStatus(timeout){return setInterval(function(){BTStreamsService.btImportVariablesStatus($applicationService.userInfo().userId,_selectedStream._id,$scope.streamRefId).then(function(res){res&&res.data&&($scope.statusLogs=res.data.statusLogs||[],"success"===res.data.status&&"info"===$scope.statusLogs[0].logType?($scope.showSuccessMsg=!0,$(".downloadLogFile").hide(),$scope.logMessage=$scope.statusLogs[0].log,stopImportBotPolling("success")):"success"===res.data.status?($scope.showSuccessMsg=!1,$(".downloadLogFile").show(),stopImportBotPolling("success")):"failed"===res.data.status&&($scope.showSuccessMsg=!1,$scope.importmessage=res.data.message,$scope.error.mess=res.data.message,$scope.showFailedErrors=!1,stopImportBotPolling("failed")))},function(err){stopImportBotPolling();var _msg=i18n.i18nString("err_on_fetching_bot_variables");err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(_msg,"error")})},timeout)}function stopImportBotPolling(_status){$scope._importStatusInit&&(clearTimeout($scope._importStatusInit),$scope._importStatusInit=null),"success"===_status?($scope.importStep=4,$scope.getBotVariables()):"failed"===_status&&($scope.importStep=2)}function writeAndDownloadLog(filename,data){var element=document.createElement("a");element.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(data)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function initDragDropFile(){!function(window){function triggerCallback(e,callback){if(callback&&"function"==typeof callback){var files;e.dataTransfer?files=e.dataTransfer.files:e.target&&(files=e.target.files),callback.call(null,files)}}function makeDroppable(ele,callback){if(!($element.find('[type="file"]').length>0)){var input=document.createElement("input");input.setAttribute("type","file"),input.setAttribute("multiple",!0),input.style.display="none",input.id="fileInputID",input.addEventListener("change",function(e){triggerCallback(e,callback)}),ele=ele[1],ele.appendChild(input),ele.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.add("dragover")}),ele.addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover")}),ele.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover"),triggerCallback(e,callback)}),$(ele).find(".browseBtn")[0].addEventListener("click",function(){input.value=null,input.click()})}}window.makeDroppable=makeDroppable}(window),function(window){window.makeDroppable($(".fileDropContainer"),function(files){$scope.uploadJSONFile(files[0])})}(window)}function getAllCollections(){BTStreamsService.btGetAllCollections($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){res&&res.data&&($scope.btCollectionVariables.collectionList=res.data,$scope.btCollectionVariables.collectionList&&$scope.btCollectionVariables.collectionList.length?($scope.btCollectionVariables.collectionType="LIST",$scope.btCollectionVariables.collectionList.forEach(function(item,index){item.isActive&&($scope.collectionVariableForm.activeCollection=item)})):$scope.btCollectionVariables.collectionType="EMPTY")},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("failed_collections"),"error")})}function checkCollectionsExist(){var selectedAccount=$workflowService.selectedAccount();selectedAccount&&selectedAccount.customSettings&&selectedAccount.customSettings.useCollections===!0&&"env"===$scope.botVariableType&&(getAllCollections(),$scope.btCollectionVariables.useCollections=selectedAccount.customSettings.useCollections,$scope.add_global_variable=i18n.i18nString("add_global_variable"),$scope.edit_global_variable=i18n.i18nString("edit_global_variable"))}function processBotVariables(data){$workflowService.botEnvVariables(data),$scope.botVariables=data,$scope.botVariables instanceof Array?$scope.botVariables.forEach(function(obj){obj.originalKey=obj.key}):$scope.botVariables.originalKey=$scope.botVariables.key,$scope.tempBotVariables=angular.copy($scope.botVariables)}function attachTooltip(){setTimeout(function(){$('[data-toggle="popover"]').popover({trigger:"hover",placement:"top"}),"VIEW"!==$scope.displayMode&&$("[name='variableName']").focus(),$('[data-toggle="tooltip"]').tooltip()},200)}function isCollectionActive(refId){return $scope.collectionVariableForm.activeCollection.refId===refId?!0:!1}function editCollections(i,value){$scope.btCollectionVariables.useCollections&&$scope.tempBotVariables[i].value&&$scope.tempBotVariables[i].value.length&&($scope.audio.collection={},$scope.audioColShow={},BTStreamsService.btEditVariableCollection($applicationService.userInfo().userId,$workflowService.selectedStream()._id,value.key).then(function(res){res&&res.data&&res.data.length&&res.data.forEach(function(item){$scope.variableForm.collectionVal[item.refId]=item.value,$scope.audio.collection[item.refId]=item.audioTag}),$scope.btCollectionVariables.collectionList&&$scope.btCollectionVariables.collectionList.length&&$scope.btCollectionVariables.collectionList.forEach(function(item,index){$scope.audio.collection[item.refId]&&-1!==index&&($scope.audioColShow[index]=!0)})},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify("Failed to edit collection","error")}))}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_BOT_SETTINGS"),$scope.assetsBase=env_conf["assets-url"],$scope.infoIcon=env_conf["context-url"]+"/assets/icons/info.png",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.editIcon=env_conf["context-url"]+"/assets/icons-new/edit-pencil/pencil-gray.svg",$scope.help=env_conf["context-url"]+"/assets/icons-new/help/help-dark.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.environmentEmptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/empty-env-variables.png",$scope.contentEmptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/empty-content-variables.png",$scope.$emit("nestedComponentLoaded",{id:"variableManagement",flag:!1});var _selectedStream=$workflowService.selectedStream();$scope.allowNamespace=$workflowService.selectedStream().enableNameSpace,$scope.selectedStream=_selectedStream,"published"===$workflowService.selectedStreamState()&&($scope.displayMode="VIEW"),$scope.dropdownValueIndex=0,$scope.isNamespaceLoading=!0,$scope.selectBots=i18n.i18nString("select_bot"),$scope.nobots=i18n.i18nString("no_bots_caps"),$scope.constants=_constants_,$scope.callback=$scope.callback||{},$scope.showNameSearch=!1,$scope.showValueSearch=!1,$scope.showEditFooter=!0,$scope.manageVarTabEnable=!1,$scope.bt_var_manage_cb={},$scope.openVarManSlid=!1,"content"===$scope.context?$scope.botVariableType="locale":$scope.botVariableType="env",$scope.sampleBot="sample"===$workflowService.selectedStream().type?!0:!1,$scope.varGroup=[],$scope.varNamespace=[],$scope.namespacesList=[],$scope.addNewGroup=i18n.i18nString("add_new_group"),$scope.add={newVar:"",newName:""},$scope.ascendingOrder=!0,$scope.decendingOrder=!1,$scope.ascendingOrderNS=!0,$scope.decendingOrderNS=!1,$scope.sortKey="group",$scope.sortKeyNS="namespace",$scope.variableForm={},$scope.variableForm.collectionVal={},$scope.variableForm.variableKey="",$scope.variableForm.variableVal="",$scope.variableForm.variableGroup="",$scope.langVal={},$scope.variableForm.variableHint="",$scope.variableForm.scope="prePopulated",$scope.variableForm.propagateValue=!1,$scope.variableForm.linkedBotId="",$scope.showEditVariables=!0,$scope.botVariables=[],$scope.tempBotVariables=[],$scope.tempSearchBtVar=[],$scope.showInlineEditDiv=!1,$scope.showFooter=!0,$scope.currentPage=1,$scope.callback.showLoading=!0,$scope.saving=!1,$scope.newVariableCreating=!1,$scope.rightClass="right500",$scope.ellipsisVert=!1,$scope.importBot="",$scope.dragDropIcon=window.appConfig.CONTEXT_PATH+"/assets/images/import.png",$scope.wentWrongIcon=window.appConfig.CONTEXT_PATH+"/assets/images/wentwrong.png",$scope.importingIcon=env_conf["context-url"]+"/assets/images/importing.png",$scope.closeCross=env_conf["context-url"]+"/assets/landingImages/closeCross.png",$scope.importStep=0,$scope.importDoneIcon=env_conf["context-url"]+"/img/import-success.png",$scope.componentId="",$scope.audioTagShow=!1,$scope.audioColShow={},$scope.isLoading=!0;var totalLinkedBots=[];$scope.inpTags={text:[{tag:"default"}]},$scope.searchQry={name:"",value:""},$scope.selectedVariableDataType="string",$scope.dropdownValues=[""],$scope.dataTypes=[{dataType:"string",displayName:"String"},{dataType:"date",displayName:"Date"},{dataType:"dropDown",displayName:"Dropdown"}],$scope.dataTypesObj={},$.each($scope.dataTypes,function(i,val){$scope.dataTypesObj[val.dataType]=val.displayName}),$scope.char_remaining=i18n.i18nString("char_remaining"),$scope.edit_content_variable=i18n.i18nString("edit_content_variable"),$scope.add_content_variable=i18n.i18nString("add_content_variable"),$scope.edit_global_variable=i18n.i18nString("edit_environment_variable"),$scope.add_global_variable=i18n.i18nString("add_environment_variable"),$scope.savingLabel=i18n.i18nString("saving"),$scope.saveLabel=i18n.i18nString("save"),$scope.manageCollectionVarEnable=!1,$scope.btCollectionVariables={},$scope.collectionVariableForm={},$scope.btCollectionVariables.collectionList=[],$scope.btCollectionVariables.useCollections=!1,$scope.btCollectionVariables.collectionType="EMPTY",$scope.audio={tagLocation:"",collection:{}},$scope.volumeShow=!0,$scope.error={mess:""},$scope.modalText="Please Wait",$workflowService.selectedStream().sbStreamId&&($scope.isChildBot=!0),$scope.isSearching=!1,$scope.$watch("searchQry.name",function(newName,oldName){$scope.tempSearchBtVar=angular.copy($scope.tempBotVariables),void 0!==newName&&($scope.isSearching=""!==newName),$scope.isSearching&&($scope.tempSearchBtVar=$filter("filter")($scope.tempSearchBtVar,{originalKey:newName}))}),$scope.$watch("searchQry.value",function(newName,oldName){$scope.tempSearchBtVar=angular.copy($scope.tempBotVariables),void 0!==newName&&($scope.isSearching=""!==newName),$scope.isSearching&&($scope.tempSearchBtVar=$filter("filter")($scope.tempSearchBtVar,{value:newName}))}),"solution"===_selectedStream.type||"sample"===_selectedStream.type?$scope.showSetupOptions=!0:$scope.showSetupOptions=!1,$(".dropdown-submenu a.dropdownExport").on("click",function(e){$(this).next("ul").toggle(),e.stopPropagation(),e.preventDefault()}),$scope.bt_var_manage_cb.updateNsList=function(list){$scope.namespacesList=list},BTStreamsService.getBTStream(_selectedStream._id).then(function(res){$scope.volumeShow=res.data.ivrSettings&&res.data.ivrSettings.enable,$scope.botName=res.data.name},function(error){console.error("getStreams Failed",error)}),$scope.removeFile=function(){$scope.fileName=""},$scope.proceedFirst=function(){$scope.importStep=1,$timeout(function(){initDragDropFile()},500)},$scope.dropdownClickHandler=function(){$(".dropdown-sub-nav").hide(),$scope.modalText=i18n.i18nString("please_wait_label2")},$scope.audioTagClickHandler=function(){$scope.audioTagShow=!$scope.audioTagShow},$scope.audioColClickHandler=function(item,index){$scope.audioColShow[index]?$scope.audioColShow[index]=!1:$scope.audioColShow[index]=!0},$scope.onCancel=function(){$(".import-utterance-modal").modal("hide"),$scope.fileName=""},$scope.moveForward=function(stepNo){$scope.importStep=stepNo,1==stepNo&&$scope.removeFile()},$scope.goToStep=function(stepNo){$scope.error.mess="",1==stepNo&&$scope.moveForward(stepNo)},$scope.startImport=function(){$scope.importStep=3,BTStreamsService.uploadBotFunctionsFile($applicationService.userInfo().userId,$scope.data).then(function(response){var fileUploaded={fileName:$scope.fileObject.name,fileId:response.data.fileId},_extension=$scope.fileObject.name.substring($scope.fileObject.name.lastIndexOf(".")+1);BTStreamsService.btImportVariables($applicationService.userInfo().userId,_selectedStream._id,fileUploaded,_extension).then(function(res){res&&res.data&&($scope.streamRefId=res.data._id||"",$scope.statusLogs=res.data.statusLogs||[],"pending"===res.data.status?($scope.importing=res.data.status,$scope._importStatusInit=startPollImportStatus(3e3)):stopImportBotPolling("success"===res.data.status?"success":"failed"))},function(err){$scope.importStep=2,$scope.errorMsg=err.data.errors})},function(err){err&&err.data&&err.data.errors?($scope.importStep=2,$scope.errorMsg=err.data.errors):($scope.importStep=2,$scope.errorMsg=i18n.i18nString("unablle_to_import"))})},$scope.downloadLog=function(){writeAndDownloadLog("botVariablesLog",JSON.stringify($scope.statusLogs))},$scope.uploadJSONFile=function(fileObject){var _ext="";if(fileObject.name){_ext=fileObject.name.substring(fileObject.name.lastIndexOf(".")),_ext.slice(1).toUpperCase();var supportingFileFormats=[".json",".csv"];if(-1===$.inArray(_ext,supportingFileFormats))return NotificationService.notify(i18n.i18nString("upload_only_csv_json_error_noty"),"error"),void($scope.fileExtensionError=!0)}var reader=new FileReader;reader.readAsText(fileObject),reader.onload=function(e){var respnoseData=reader.result;if($scope.jsonData=respnoseData,!respnoseData||respnoseData&&!respnoseData.length)NotificationService.notify(i18n.i18nString("please_upload_a_Valid")+_ext.slice(1).toUpperCase()+i18n.i18nString("file_label"),"error"),$scope.fileEmptyError=!0;else{console.log("fileobject",fileObject.name),$scope.fileName=fileObject.name,$scope.fileExtensionError=!1;var data=new FormData;data.append("file",fileObject),data.append("fileContext","bulkImport"),data.append("fileExtension",_ext.substring(_ext.lastIndexOf(".")+1)),data.append("Content-Type",fileObject.type),$scope.data=data,$scope.fileObject=fileObject}}},$scope.importVariables=function(){$scope.importStep=0,$scope.ellipsisVert=!1,$(".import-utterance-modal").modal("show")},$scope.activateNameSearch=function(show){$scope.showValueSearch=!1,$scope.searchQry.name="",$scope.searchQry.value="",$scope.tempBotVariables=angular.copy($scope.botVariables),$scope.tempSearchBtVar=angular.copy($scope.tempBotVariables),setTimeout(function(){$(".focusNameSearch").focus()},100),show?$scope.showNameSearch=!0:$scope.showNameSearch=!1},$scope.manageNamespacesSlider=function(){$scope.manageVarTabEnable=!0,setTimeout(function(){$scope.openModalSlider("#manageVarNamespaceTable")},500)},$scope.bt_var_manage_cb.close=function(){$scope.closeModalSlider("#manageVarNamespaceTable"),$scope.manageVarTabEnable=!1},$scope.manageCollectionsSlider=function(){$scope.manageCollectionVarEnable=!0,setTimeout(function(){$scope.openModalSlider("#manageCollectionsSlider")},500)},$scope.btCollectionVariables.close=function(){$scope.closeModalSlider("#manageCollectionsSlider"),$scope.manageCollectionVarEnable=!1,$scope.btCollectionVariables.collectionType="EMPTY",checkCollectionsExist()},$scope.searchQuery=function(){$scope.collectionVariableForm.searchQuery.trim()},$scope.sortByCollection=function(col){$scope.collectionVariableForm.activeCollection=col,$scope.isLoading=!0;var collectionRefId=col.refId||"";BTFlowtaskService.getVariablesByCollection($applicationService.userInfo().userId,_selectedStream._id,$scope.botVariableType,collectionRefId).then(function(res){$workflowService.botEnvVariables(res.data.variables),$scope.botVariables=res.data.variables,$scope.varGroup=_.uniq(_.pluck(res.data.variables,"group")),$scope.varGroup.unshift($scope.addNewGroup),$scope.botVariables.forEach(function(obj){if(obj.originalKey=obj.key,obj.vNameSpace&&obj.vNameSpace.length&&$scope.varNamespace.length){var nsTempList=$scope.varNamespace.filter(function(val){return obj.vNameSpace.indexOf(val._id)>-1});obj.namespace=_.pluck(nsTempList,"name").join(",")}}),$scope.isChildBot&&($scope.botVariables=$scope.botVariables.filter(function(val){
return"hidden"!==val.scope})),$scope.tempBotVariables=angular.copy($scope.botVariables),$scope.callback.showLoading=!1,$scope.isLoading=!1},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("unexpected_error_while_fetching_bot_variables"),"error");$scope.callback.showLoading=!1,$scope.isLoading=!1})},$scope.autoCompleteCollection=function(event,index,col){0===index&&$scope.btCollectionVariables.collectionList.forEach(function(item,i){i>0&&!$scope.variableForm.collectionVal[item.refId]&&($scope.variableForm.collectionVal[item.refId]=$scope.variableForm.collectionVal[col.refId])})},checkCollectionsExist(),$scope.activateValueSearch=function(show){$scope.showNameSearch=!1,$scope.searchQry.name="",$scope.searchQry.value="",$scope.tempBotVariables=angular.copy($scope.botVariables),setTimeout(function(){$(".focusValueSearch").focus()},100),show?$scope.showValueSearch=!0:$scope.showValueSearch=!1},$scope.trackSearch=function(event){27===event.keyCode&&($scope.showValueSearch=!1,$scope.showNameSearch=!1,$scope.searchQry.name="",$scope.searchQry.value="",$scope.tempBotVariables=angular.copy($scope.botVariables))},$scope.btcallback.stopFetching=function(){setTimeout(function(){$scope.callback.showLoading=!1},1e3)},$scope.closeSlider=function(form){$scope.openVarManSlid=!1,$scope.selectedVariableDataType="string",$scope.closeModalSlider("#variableManagementSlider"),form.$setPristine(),form.$setUntouched()},$scope.selectDataType=function(type){$scope.dropdownValueIndex=0,"date"===type?$scope.variableForm.variableVal=null:$scope.variableForm.variableVal="",$scope.selectedVariableDataType=type},$scope.selectDefaultDropDownValue=function(index){$scope.dropdownValueIndex=index},$scope.removeDropDownValue=function(index){return $scope.dropdownValueIndex===index?void NotificationService.notify("Cannot delete selected value","error"):void($scope.dropdownValues.length>1?$scope.dropdownValues.splice(index,1):NotificationService.notify("At least one value is required","error"))},$scope.initDate=function(containerId){var container=$("#"+containerId);$timeout(function(){daterangepickerInput=container.daterangepicker({singleDatePicker:!0,showDropdowns:!0,opens:"right",customClass:"bot-dash-datepicker",locale:{applyLabel:i18n.i18nString("apply"),cancelLabel:i18n.i18nString("cancel")}})},300)},$scope.cancelCreateVariable=function(form){$scope.openVarManSlid=!1,$scope.selectedVariableDataType="string",$scope.closeModalSlider("#variableManagementSlider"),form&&(form.$setPristine(),form.$setUntouched()),setTimeout(function(){$scope.showEditFooter=!0,$scope.showEditVariables=!0,$scope.newVariableCreating=!1},500)},$scope.checkLengthValidation=function(val,limit,event){return val&&val.length>=limit?void event.preventDefault():void 0},$scope.handleLengthValidation=function(type,limit,event){setTimeout(function(){event.stopImmediatePropagation(),event.currentTarget.value.length>=limit&&(event.currentTarget.value=event.currentTarget.value.slice(0,limit),$(event.currentTarget).trigger("change"))},10);var availableTags=[];$scope.tempBotVariables.forEach(function(item){return void 0===item.group?!1:void availableTags.push(item.group)}),$("#tags").autocomplete({source:_.uniq(availableTags)})},$scope.checkKey=function(ev){return 13==ev.which?(ev.preventDefault(),void createNamespace()):void 0};var createNamespace=function(){if($scope.namespacesList.indexOf($scope.add.newName)>-1)return void NotificationService.notify(i18n.i18nString("dup_not_allowed"),"error");payload={name:$scope.add.newName},$("#dropdownMenuButton").parent().removeClass("open");var promise=new Promise(function(resolve,reject){BTStreamsService.createNamespace($applicationService.userInfo().userId,_selectedStream._id,payload).then(function(res){$scope.varNamespace.push(_.pick(res.data,"name","_id")),$scope.namespacesList.push($scope.add.newName),$scope.inpTags.text.push({tag:$scope.add.newName}),$scope.add.newName="",NotificationService.notify('"'+res.data.name+'"'+i18n.i18nString("ns_created"),"success"),resolve(res.data._id)},function(err){reject(err)})});return promise};$scope.createNamespace=createNamespace;var createNewVariable=function(nsId){var _obj={key:$scope.variableForm.variableKey,value:$scope.variableForm.variableVal,hint:$scope.variableForm.variableHint,audioTag:$scope.audio.tagLocation};if(_obj.variableType=$scope.botVariableType,_obj.group=$scope.variableForm.variableGroup==$scope.addNewGroup?$scope.add.newVar.trim():$scope.variableForm.variableGroup,("solution"===_selectedStream.type||"sample"===_selectedStream.type)&&(_obj.scope=$scope.variableForm.scope),"universalbot"===_selectedStream.type&&($scope.variableForm.propagateValue&&(_obj.linkedBotId=$scope.variableForm.linkedBotId),_obj.propagateValue=$scope.variableForm.propagateValue),nsId&&(_obj.vNameSpace=nsId),$scope.variableForm.collectionVal&&Object.keys($scope.variableForm.collectionVal).length&&$scope.btCollectionVariables.useCollections){var keys=Object.keys($scope.variableForm.collectionVal),colPayload=[];keys.length&&(keys.forEach(function(col){colPayload.push({collectionRefId:col||"",value:$scope.variableForm.collectionVal[col]||"",audioTag:$scope.audio.collection[col]||""})}),_obj.value=colPayload)}$scope.saveBotVariables(!1,!1,null,_obj),$scope.saving=!0};$scope.createVariable=function(form){if($scope.variableForm.propagateValue&&(void 0===$scope.variableForm.linkedBotId||""===$scope.variableForm.linkedBotId))return void NotificationService.notify(i18n.i18nString("please_provide_linked_bot"),"error");if(form.$setPristine(),form.$setUntouched(),$scope.saving=!0,$scope.inpTags.text.length>0){var nsList=_.pluck($scope.inpTags.text,"tag"),tempFiltered=$scope.varNamespace.filter(function(val){return nsList.indexOf(val.name)>-1}),idTemp=_.pluck(tempFiltered,"_id");createNewVariable(idTemp)}else createNewVariable()},$scope.inputNewGroup=function(name){$scope.variableForm.variableGroup=name,setTimeout(function(){$("#inputGroup").focus()})},$scope.addNewVariable=function(){$scope.isEditVariable=!1,$scope.variableForm.variableKey="",$scope.variableForm.collectionVal={},$scope.variableForm.variableVal="",$scope.audioTagShow=!1,$scope.variableForm.variableHint="",$scope.variableForm.variableGroup="",$scope.variableForm.propagateValue=!1,$scope.variableForm.linkedBotId="",$scope.audio.tagLocation="",$scope.audio.collection={},$scope.audioColShow={},$scope.inpTags.text=[{tag:"default"}],$element.find(".saveButton").removeClass("disabled"),$scope.variableForm.scope="prePopulated",$scope.selectedVariableDataType="string",$scope.showEditFooter=!1,$scope.newVariableCreating=!0,$("textarea.autoGrowTA").css("height","32px"),$scope.allowNamespace&&getAllNamespaces().then(function(res){$scope.isNamespaceLoading=!1},function(err){$scope.isNamespaceLoading=!1,NotificationService.notify(i18n.i18nString("failed_fetch_ns"),"error")}),$scope.openVarManSlid=!0,$timeout(function(){$scope.openModalSlider("#variableManagementSlider"),attachTooltip()})},$scope.saveButtonChange=function(){$element.find(".saveButton").removeClass("disabled")},$scope.exportVariables=function(format){function startExport(){BTStreamsService.btExportVariables($applicationService.userInfo().userId,_selectedStream._id,format).then(function(response){"PENDING"===response.data.status||"SUCCESS"===response.data.status?(NotificationService.notify("Exporting Variables ...","success"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open")):"failed"===response.data.status&&(NotificationService.notify(i18n.i18nString("exporting_variables_failed"),"error"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"))},function(error){if("RequestExists"===error.data.errors[0].code){var msg=error.data.errors[0].code;NotificationService.notify(msg,"warning")}else error&&error.data&&error.data.errors[0].code?NotificationService.notify(error.data.errors[0].msg,"error"):NotificationService.notify(error.data.errors[0].msg,"error")})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope.constants.updateDownloadPopUppreferance(checkValue)}$scope.constants.config.showDownloadPopUps?NotificationService.userConfirm($scope.constants.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_variables")):startExport()},$scope.attachOpenDropdown=function(){$("#namespace_var_slider .dropdown").off(),$("#namespace_var_slider .dropdown").on("show.bs.dropdown",function(event){$scope.add.newName="",setTimeout(function(){$("#namespaceInp").focus()},200)})},$scope.onDone=function(){$(".import-utterance-modal").modal("hide"),$scope.fileName="",$scope.callback.showLoading=!0,$scope.getBotVariables()};var getAllNamespaces=function(){var promise=new Promise(function(resolve,reject){BTStreamsService.getAllNamespaces($applicationService.userInfo().userId,_selectedStream._id).then(function(res){$scope.varNamespace=_.map(res.data,function(v){return _.pick(v,"name","_id")}),$scope.namespacesList=_.pluck(res.data,"name"),resolve()},function(err){$scope.getBotVariables(),NotificationService.notify("Failed to get namespaces","error"),reject()})});return promise};$scope.bt_var_manage_cb.getAllNamespaces=getAllNamespaces,$scope.getBotVariables=function(){$scope.isLoading=!0,BTFlowtaskService.getVariables($applicationService.userInfo().userId,_selectedStream._id,$scope.botVariableType).then(function(res){$workflowService.botEnvVariables(res.data.variables),$scope.botVariables=res.data.variables,$scope.varGroup=_.uniq(_.pluck(res.data.variables,"group")),$scope.varGroup.unshift($scope.addNewGroup),$scope.botVariables.forEach(function(obj){if(obj.originalKey=obj.key,obj.vNameSpace&&obj.vNameSpace.length&&$scope.varNamespace.length){var nsTempList=$scope.varNamespace.filter(function(val){return obj.vNameSpace.indexOf(val._id)>-1});obj.namespace=_.pluck(nsTempList,"name").join(",")}}),$scope.isChildBot&&($scope.botVariables=$scope.botVariables.filter(function(val){return"hidden"!==val.scope})),$scope.tempBotVariables=angular.copy($scope.botVariables),$scope.callback.showLoading=!1,$scope.isLoading=!1},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("unexpected_error_while_fetching_bot_variables"),"error");$scope.callback.showLoading=!1,$scope.isLoading=!1})},$scope.bt_var_manage_cb.getBotVariables=$scope.getBotVariables,$scope.allowNamespace?getAllNamespaces().then(function(res){$scope.getBotVariables()},function(err){NotificationService.notify(i18n.i18nString("failed_fetch_ns"),"error")}):$scope.getBotVariables(),$scope.addDropdownValue=function(){$scope.dropdownValues.push("")},$scope.saveDropDownValues=function(index){index>-1&&$scope.defaultDropdown===index?$scope.variableForm.variableVal=$scope.dropdownValues[index]:$scope.variableForm.variableVal=$scope.dropdownValues[0]},$scope.saveBotVariables=function(_fromEdit,_frmDelete,index,payload){var _tmpVariables=angular.copy($scope.tempBotVariables);if(_tmpVariables=_tmpVariables.map(function(item){return"solution"===_selectedStream.type||"sample"===_selectedStream.type?_.pick(item,"key","value","hint","variableType","_id","scope","audioTag","group","vNameSpace"):"universalbot"===_selectedStream.type?_.pick(item,"key","value","hint","variableType","_id","audioTag","group","propagateValue","linkedBotId"):_.pick(item,"key","value","hint","variableType","_id","audioTag","group","vNameSpace")}),$scope.sampleBot&&(!payload||_fromEdit||_frmDelete||(payload.meta={dataType:$scope.selectedVariableDataType||"string",values:[]},"dropDown"===$scope.selectedVariableDataType?payload.meta.values=$scope.dropdownValues||[]:(payload.meta.values=[],payload.meta.values.push(payload.value))),$scope.currEditKeyIndex>-1&&_tmpVariables.length&&_tmpVariables[$scope.currEditKeyIndex]&&_fromEdit&&(_tmpVariables[$scope.currEditKeyIndex].meta={dataType:$scope.selectedVariableDataType||"string",values:[]},"dropDown"===$scope.selectedVariableDataType?_tmpVariables[$scope.currEditKeyIndex].meta.values=$scope.dropdownValues||[]:(_tmpVariables[$scope.currEditKeyIndex].meta.values=[],_tmpVariables[$scope.currEditKeyIndex].meta.values.push(_tmpVariables[$scope.currEditKeyIndex].value)))),_fromEdit&&!_frmDelete&&$scope.variableForm.collectionVal&&Object.keys($scope.variableForm.collectionVal).length&&$scope.btCollectionVariables.useCollections){var keys=Object.keys($scope.variableForm.collectionVal),colPayload=[];keys.length&&(keys.forEach(function(col){isCollectionActive(col)?colPayload.push({collectionRefId:col||"",value:$scope.variableForm.collectionVal[col]||"",audioTag:$scope.audio.collection[col]||"",isActive:!0}):colPayload.push({collectionRefId:col||"",value:$scope.variableForm.collectionVal[col]||"",audioTag:$scope.audio.collection[col]||""})}),_tmpVariables[$scope.currEditKeyIndex].value=colPayload)}_fromEdit&&!_frmDelete&&BTFlowtaskService.editVariable($applicationService.userInfo().userId,_selectedStream._id,$scope.componentId,_tmpVariables[$scope.currEditKeyIndex]).then(function(res){$scope.saving=!1,$scope.showEditFooter=!0,$scope.showEditVariables=!0,$workflowService.botEnvVariables(res.data),NotificationService.notify(i18n.i18nString("bot_variable_updated"),"success"),$scope.getBotVariables(),$scope.activateValueSearch(),$scope.openVarManSlid=!1,$scope.closeModalSlider("#variableManagementSlider")},function(err){$scope.saving=!1,NotificationService.notify(err.data.errors[0].msg,"error")}),_fromEdit&&_frmDelete&&BTFlowtaskService.deleteVariable($applicationService.userInfo().userId,_selectedStream._id,_tmpVariables[$scope.currEditKeyIndex]._id).then(function(res){$scope.saving=!1,$scope.showEditFooter=!0,$scope.showEditVariables=!0,_tmpVariables.splice($scope.currEditKeyIndex,1),$("botVariable"+$scope.currEditKeyIndex).removeClass("saving"),$scope.botVariables=res.data,$scope.tempBotVariables.splice($scope.currEditKeyIndex,1),$scope.activateValueSearch(),$scope.getBotVariables(),NotificationService.notify(i18n.i18nString("bot_Variable_deleted"),"success")},function(err){$scope.saving=!1,NotificationService.notify(err.data.errors[0].msg,"error")}),_fromEdit||_frmDelete||BTFlowtaskService.addVariables($applicationService.userInfo().userId,_selectedStream._id,payload).then(function(res){$scope.saving=!1,$scope.showEditVariables=$scope.showEditFooter=!0,$workflowService.botEnvVariables(res.data),$scope.getBotVariables(),NotificationService.notify(i18n.i18nString("bot_variable_added"),"success"),$scope.cancelCreateVariable()},function(error){if($scope.saving=!1,_frmDelete?$("botVariable"+index).removeClass("saving"):processBotVariables($scope.botVariables),error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("unexpected_error_while_saving"),"error");$scope.newVariableCreating=!1,$scope.saving=!1})},$scope.editVariable=function(index,key){$scope.isEditVariable=!0,$scope.dropdownValues=[],$scope.selectedVariableDataType="string",$.each($scope.tempBotVariables,function(i,value){if($scope.tempBotVariables[i].showEditDiv=!1,value.key===key){var pattern=/\&gt/g;if(pattern.test(JSON.stringify($scope.tempBotVariables[i]))&&($scope.tempBotVariables[i]=JSON.parse(JSON.stringify($scope.tempBotVariables[i]).replace(/&gt;/g,">").replace(/&lt;/g,"<"))),$scope.variableForm.variableKey=$scope.tempBotVariables[i].key,$scope.variableForm.variableVal=$scope.tempBotVariables[i].value,$scope.variableForm.variableHint=$scope.tempBotVariables[i].hint,$scope.variableForm.scope=$scope.tempBotVariables[i].scope,$scope.tempBotVariables[i].meta&&$scope.tempBotVariables[i].meta.dataType&&$scope.sampleBot&&($scope.selectedVariableDataType=$scope.tempBotVariables[i].meta.dataType,"dropDown"===$scope.tempBotVariables[i].meta.dataType&&($scope.dropdownValues=$scope.tempBotVariables[i].meta.values||[],$.each($scope.dropdownValues,function(i,val){val===$scope.variableForm.variableVal&&($scope.dropdownValueIndex=i)}))),$scope.variableForm.variableGroup=$scope.tempBotVariables[i].group,editCollections(i,value),$scope.tempBotVariables[i].vNameSpace){var nsListTemp=$scope.varNamespace.filter(function(val){return $scope.tempBotVariables[i].vNameSpace.indexOf(val._id)>-1});if($scope.inpTags.text=_.pluck(nsListTemp,"name"),$scope.inpTags.text.indexOf("default")>0){var tempIndDef=$scope.inpTags.text.indexOf("default"),tempValFirst=$scope.inpTags.text[0];$scope.inpTags.text[0]="default",$scope.inpTags.text[tempIndDef]=tempValFirst}}else $scope.inpTags.text=[{tag:"default"}];$scope.audio.tagLocation=$scope.tempBotVariables[i].audioTag,$scope.currentIndexValuetoEdit=i,$scope.componentId=$scope.tempBotVariables[i]._id,"universalbot"===$scope.selectedStream.type&&($scope.variableForm.propagateValue=$scope.tempBotVariables[i].propagateValue,$scope.variableForm.linkedBotId=$scope.tempBotVariables[i].linkedBotId,setTimeout(function(){$(".kr-sg-dropdowns .dropdown").find(".dropdown-toggle .selectfield").html($scope.tempBotVariables[i].linkedBotName)},100))}}),$scope.isNamespaceLoading=!1,$scope.openVarManSlid=!0,$timeout(function(){$scope.openModalSlider("#variableManagementSlider"),attachTooltip()})},$scope.cancelEditDiv=function(index,key){$.each($scope.tempBotVariables,function(i,value){value.key===key&&($scope.tempBotVariables[i].showEditDiv=!1)}),$scope.tempBotVariables=angular.copy($scope.botVariables),$scope.showFooter=!0},$scope.saveVariables=function(index,key){function editVarNamespace(_id){return"globalType"===$('input[ng-model="botVariableType"]:checked').attr("id")&&""===$scope.tempBotVariables[$scope.currEditKeyIndex].value?void NotificationService.notify(i18n.i18nString("please_provide_variable_value"),"error"):($scope.saving=!0,$scope.tempBotVariables[$scope.currEditKeyIndex].originalKey=$scope.tempBotVariables[$scope.currEditKeyIndex].key,_id&&($scope.tempBotVariables[$scope.currEditKeyIndex].vNameSpace=_id),$scope.saveBotVariables(!0,!1),void $scope.cancelEditDiv(index,key))}if(""===key)return void NotificationService.notify(i18n.i18nString("please_provide_variable_name"),"error");if(""===$scope.variableForm.variableKey)return void NotificationService.notify(i18n.i18nString("please_provide_variable_name"),"error");if(""===$scope.variableForm.variableVal)return void($scope.sampleBot&&"dropDown"===$scope.selectedVariableDataType?NotificationService.notify(i18n.i18nString("please_provide_variable_value"),"error"):NotificationService.notify(i18n.i18nString("please_provide_variable_value"),"error"));if(index>-1)if($scope.currEditKeyIndex=index,$scope.tempBotVariables[index].key=$scope.variableForm.variableKey,$scope.tempBotVariables[index].value=$scope.variableForm.variableVal,$scope.tempBotVariables[index].audioTag=$scope.audio.tagLocation,$scope.tempBotVariables[index].variableType=$scope.botVariableType,$scope.tempBotVariables[index].group=$scope.variableForm.variableGroup==$scope.addNewGroup?$scope.add.newVar.trim():$scope.variableForm.variableGroup,$scope.tempBotVariables[index].hint=$scope.variableForm.variableHint,$scope.tempBotVariables[index].scope=$scope.variableForm.scope,"universalbot"===$scope.selectedStream.type&&($scope.tempBotVariables[index].propagateValue=$scope.variableForm.propagateValue,$scope.tempBotVariables[index].linkedBotId=$scope.variableForm.linkedBotId),$scope.inpTags.text.length>0){var nsList=_.pluck($scope.inpTags.text,"tag"),tempFiltered=$scope.varNamespace.filter(function(val){return nsList.indexOf(val.name)>-1}),idTemp=_.pluck(tempFiltered,"_id");editVarNamespace(idTemp)}else editVarNamespace(null);else $.each($scope.tempBotVariables,function(i,value){value.key===key&&($scope.currEditKeyIndex=i)}),editVarNamespace()},$scope.showDropDown=function(e){if(e.stopPropagation(),e.currentTarget){var _currEle=$(e.currentTarget);_currEle.siblings().removeClass("active"),_currEle.addClass("active"),_currEle.find(".dropdown").addClass("open")}},$(function(){$('[data-toggle="popover"]').popover()}),$scope.getLinkedBots=function(){if("universalbot"===_selectedStream.type){var confRecords=[],publishedRecords=[];confRecords=_.uniq(totalLinkedBots.concat(_selectedStream.configuredBots,_selectedStream.awaitingApprovalBots)),publishedRecords=_selectedStream.publishedBots.filter(function(bot){return _.filter(_selectedStream.unpublishedBots,{_id:bot._id}).length?void 0:bot}),$scope.totalLinkedBots=confRecords.concat(publishedRecords)}},$scope.selectedBot=function(bot){$(".kr-sg-dropdowns .dropdown").find(".dropdown-toggle .selectfield").html('<span class="botName" style="padding-left:10px;">'+bot.botName+"</span>"),$(".dropdown-menu.content-menu").prev().dropdown("toggle"),$scope.variableForm.linkedBotId=bot._id},$scope.deleteVariable=function(index,key){NotificationService.alert(i18n.i18nString("do_you_want_to_delete_this_bot_Variable"),function(){$.each($scope.tempBotVariables,function(i,value){value.key===key&&($scope.currEditKeyIndex=i)}),$("botVariable"+index).addClass("saving"),$scope.saveBotVariables(!0,!0,index)},{okText:i18n.i18nString("ok_uppercase")})},$scope.$emit("nestedComponentLoaded",{id:"variableManagement",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.sortByGroup=function(){$scope.sortKey="group"==$scope.sortKey?"-group":"group","-group"===$scope.sortKey?($scope.decendingOrder=!0,$scope.ascendingOrder=!1):($scope.ascendingOrder=!0,$scope.decendingOrder=!1)},$scope.sortByNamespace=function(){$scope.sortKey="namespace"==$scope.sortKey?"-namespace":"namespace","-namespace"===$scope.sortKey?($scope.decendingOrderNS=!0,$scope.ascendingOrderNS=!1):($scope.ascendingOrderNS=!0,$scope.decendingOrderNS=!1)}}]}}),_module.filter("dispTypeFilter",function(){return function(input){return"env"===input?"Global":"locale"===input?"Content":void 0}}),_module.filter("patternChangeVariable",function(){return function(input){return"object"==typeof input?input:input?input.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&Gt;/g,">").replace(/&Lt;/g,"<"):void 0}})}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.directive("btWatchVideos",function(){return{restrict:"EA",scope:{videoId:"=?"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-watch-videos/bt-watch-videos.html",controller:["$window","$element","$rootScope","$scope","$workflowService","$location","$routeParams","NotificationService","form_util","indexerUtil","accessControlService","env_conf","$timeout","i18n",function($window,$element,$rootScope,$scope,$workflowService,$location,$routeParams,NotificationService,form_util,indexerUtil,accessControlService,env_conf,$timeout,i18n){function load(){if($scope.videoId){var _selectVideo=_.find($scope.videoObject.videos,{id:$scope.videoId});$scope.selectVideoToPlay(_selectVideo)}}$scope.backToLanding=window.appConfig.CONTEXT_PATH+"/assets/landingImages/backArrow.svg",$scope.videoPlayIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/videoPlayIcon.svg",$scope.hideLoadMore=!1,$scope.paginate={},$scope.paginate.size=4,$("html").addClass("onBoardVideoMobileView"),$scope.loadMoreVideos=function(previoisSize){return previoisSize+=4,previoisSize>=$scope.videoObject.videos.length&&($scope.hideLoadMore=!0),previoisSize},$scope.selectVideoToPlay=function(videoLink){$scope.videoObject.selectedVideo=window.appConfig.CONTEXT_PATH+"/assets/icons/koreAiDefaultIcon.png",$timeout(function(){var link=angular.copy(videoLink);link.link=link.link+"?controls=1&autoplay=1&rel=0",$scope.videoObject.selectedVideo=angular.copy(link)},500)},$scope.closeVideo=function(){$("html").removeClass("onBoardVideoMobileView"),$scope.callback.closeFullPageModal()},$scope.videoObject={videos:[{id:"getstarted",link:"https://www.youtube.com/embed/9FM1RnBmY_8",title:i18n.i18nString("bt_watch_videos_get_started_label"),disc:i18n.i18nString("bt_watch_videos_get_started_desc"),tumbnail:"https://i.ytimg.com/vi/9FM1RnBmY_8/mqdefault.jpg"},{id:"overview",link:"https://www.youtube.com/embed/wH079pMroRs",title:i18n.i18nString("bt_watch_videos_overview_label"),disc:i18n.i18nString("bt_watch_videos_overview_desc"),tumbnail:"https://i.ytimg.com/vi/wH079pMroRs/mqdefault.jpg"},{id:"createnewbot",link:"https://www.youtube.com/embed/5AHi-Hz21Kw",title:i18n.i18nString("standard_name"),disc:i18n.i18nString("bt_watch_videos_create_new_bot_desc"),tumbnail:"https://i.ytimg.com/vi/5AHi-Hz21Kw/mqdefault.jpg"},{id:"tasktypes",link:"https://www.youtube.com/embed/ta15UkwWLaQ",title:i18n.i18nString("bt_watch_videos_task_type_label"),disc:i18n.i18nString("bt_watch_videos_task_type_desc"),tumbnail:"https://i.ytimg.com/vi/ta15UkwWLaQ/mqdefault.jpg"},{id:"builddialog",link:"https://www.youtube.com/embed/zF7k17SuG5U",title:i18n.i18nString("bt_watch_videos_build_a_dialog_label"),disc:i18n.i18nString("bt_watch_videos_build_a_dialog_desc"),tumbnail:"https://i.ytimg.com/vi/zF7k17SuG5U/mqdefault.jpg"},{id:"buildkt",link:"https://www.youtube.com/embed/8aUhwYKE-Q8",title:i18n.i18nString("bt_watch_videos_build_knowledge_task_label"),disc:i18n.i18nString("bt_watch_videos_build_knowledge_task_desc"),tumbnail:"https://i.ytimg.com/vi/8aUhwYKE-Q8/mqdefault.jpg"},{id:"nlptraining",link:"https://www.youtube.com/embed/8kRYauJQE8U",title:i18n.i18nString("bt_watch_videos_build_nlp_training_label"),disc:i18n.i18nString("bt_watch_videos_build_nlp_training_desc"),tumbnail:"https://i.ytimg.com/vi/8kRYauJQE8U/mqdefault.jpg"}],selectedVideo:{link:"https://www.youtube.com/embed/9FM1RnBmY_8?controls=1&autoplay=1&rel=0",title:i18n.i18nString("bt_watch_videos_get_started_label"),disc:i18n.i18nString("bt_watch_videos_get_started_desc"),tumbnail:"https://i.ytimg.com/vi/9FM1RnBmY_8/mqdefault.jpg"}},load()}]}})}(angular),function(ng){"use strict";var _module=ng.module("bt-wf-create",["app.helpers","bt-forms"]);_module.directive("btWfCreate",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-create/bt-wf-create.html",controller:"BTWFCreateCtrl"}}),_module.controller("BTWFCreateCtrl",["$scope","$filter","$rootScope","$routeParams","$timeout","$location","$workflowService","BTSeedDataService","NotificationService","BTAlertsService","BTActionsService","BTStreamsService","i18n",function($scope,$filter,$rootScope,$routeParams,$timeout,$location,$workflowService,BTSeedDataService,NotificationService,BTAlertsService,BTActionsService,BTStreamsService,i18n){function hideSections(){Object.keys($scope.sections).map(function(key){$scope.sections[key]=!1})}function errorSaveHandler(){triggerNextStep()}function triggerNextStep(){$scope.stages[$scope.entityObj.type][$scope.currentStage.curr].visited=!0,$scope.nextStep()}function navigateTo(screen){$scope.entityObj&&$scope.entityObj.type&&$scope.currentStep>=$scope.stages[$scope.entityObj.type][screen].no&&(hideSections(),$scope.sections[screen]=!0,$scope.currentStage=$scope.stages[$scope.entityObj.type][screen],$("html, body").animate({scrollTop:0},"fast"))}$rootScope.$on("initTaskCreation",function(){$scope.initiateTaskCreationFlow()}),$scope.initiateTaskCreationFlow=function(){return $rootScope.saveAndExit=!1,$scope.displayMode="",$scope.wftype=$workflowService.workflowType(),$scope.selectedStream=$workflowService.selectedStream(),$workflowService.workflowType()?($scope.callbacks={basic:{},auth:{},requestObj:{},responseObj:{},errorMsgs:{},settings:{},finishForm:{}},$scope.sections={basic:!0,auth:!1,requestObj:!1,responseObj:!1,errorMsgs:!1,settings:!1,finishForm:!1},$scope.entityObj={},$scope.currentStage=rss_webservice_stages.basic,$scope.currentStep=1,"alert"===$scope.wftype?$scope.stages={webhook:webhook_stages,rss:rss_webservice_stages,webservice:rss_webservice_stages}:"action"===$scope.wftype&&(resource=$workflowService.actionInfo(),$scope.resource=resource,$scope.stages={webservice:action_stages}),void navigateTo($scope.currentStage.curr)):void $location.path(window.appConfig.CONTEXT_PATH)};var rss_webservice_stages={basic:{prev:"start",curr:"basic",next:"auth",no:1},auth:{prev:"basic",curr:"auth",next:"requestObj",no:2},requestObj:{prev:"auth",curr:"requestObj",next:"responseObj",no:3},responseObj:{prev:"requestObj",curr:"responseObj",next:"settings",no:4},errorMsgs:{prev:"responseObj",curr:"errorMsgs",next:"settings",no:5},settings:{prev:"responseObj",curr:"settings",next:"finishForm",no:6},finishForm:{prev:"settings",curr:"finishForm",next:"end",no:7}},action_stages={basic:{prev:"start",curr:"basic",next:"auth",no:1},auth:{prev:"basic",curr:"auth",next:"requestObj",no:2},requestObj:{prev:"auth",curr:"requestObj",next:"responseObj",no:3},responseObj:{prev:"requestObj",curr:"responseObj",next:"finishForm",no:4},errorMsgs:{prev:"responseObj",curr:"errorMsgs",next:"finishForm",no:5},finishForm:{prev:"responseObj",curr:"finishForm",next:"end",no:6}},webhook_stages={basic:{prev:"start",curr:"basic",next:"requestObj",no:1},requestObj:{prev:"basic",curr:"requestObj",next:"responseObj",no:2},responseObj:{prev:"requestObj",curr:"responseObj",next:"finishForm",no:3},errorMsgs:{prev:"responseObj",curr:"errorMsgs",next:"finishForm",no:4},finishForm:{prev:"responseObj",curr:"finishForm",next:"end",no:5}};$scope.nextStep=function(){var section;$scope.currentStep<$scope.stages[$scope.entityObj.type][$scope.currentStage.curr].next.no&&($scope.currentStep=$scope.stages[$scope.entityObj.type][$scope.currentStage.curr].next.no),hideSections(),section=$scope.stages[$scope.entityObj.type][$scope.currentStage.curr].next,$scope.currentStage=$scope.stages[$scope.entityObj.type][section],$scope.currentStep=$scope.currentStage.no,"end"!==section&&$scope.stages[$scope.entityObj.type][$scope.currentStage.prev].visited&&($scope.sections[section]=!0)},$scope.previousStep=function(){var section;hideSections(),section=$scope.stages[$scope.entityObj.type][$scope.currentStage.curr].prev,$scope.currentStage=$scope.stages[$scope.entityObj.type][section],"start"!==section&&($scope.sections[section]=!0)},$scope.getStepNo=function(section){return $scope.entityObj&&$scope.entityObj.type?$scope.stages[$scope.entityObj.type][section].no:"action"===$scope.wftype?$scope.stages.webservice[section].no:1},$scope.onIntroFormResponse=function(wftype){$scope.entityObj="alert"===wftype?$workflowService.alertInfo():$workflowService.actionInfo(),triggerNextStep()},$scope.onAuthFormResponse=function(){triggerNextStep()},$scope.onReqObjectFormResponse=function(wftype){triggerNextStep()},$scope.onResObjectFormResponse=function(wftype){triggerNextStep()},$scope.onSettingsFormResponse=function(){triggerNextStep()},$scope.onSlashCommandsFormResponse=function(){triggerNextStep()},$scope.finishSetup=function(){$scope.markItConfigured($scope.wftype)},$scope.errorMsgSave=function(errors,cb){if("alert"===$scope.wftype){var alert={}||$workflowService.alertInfo();alert.errorCodes={pollError:errors},BTAlertsService.createBTAlertUp($workflowService.alertInfo()._id,alert).then(function(res){$workflowService.alertInfo(res.data),errorSaveHandler(),cb()},function(res){cb(),res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bt_wf_create_failed_to_update",{dyn:$scope._constants_.alert}),"error")})}else{var action={}||$workflowService.actionInfo();action.errorCodes={pollError:errors},BTActionsService.updateBTAction($workflowService.actionInfo()._id,action).then(function(res){$workflowService.actionInfo(res.data),
errorSaveHandler(),cb()},function(res){cb(),res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bt_wf_create_failed_to_update",{dyn:$scope._constants_.action}),"error")})}},$scope.gotostream=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.isItRestType=function(){var subtype;return subtype="alert"===$scope.wftype?$workflowService.alertInfo()&&$workflowService.alertInfo().subtype:$workflowService.actionInfo()&&$workflowService.actionInfo().subtype,"soap"!==subtype},$scope.onCancel=function(){$("#taskCreateOrEditModal").modal("hide")},$scope.onSaveAndExit=function(){switch($rootScope.saveAndExit=!0,$scope.currentStage.curr){case"basic":$rootScope.$broadcast("evt:nextActintro");break;case"auth":$rootScope.$broadcast("evt:nextActAuth");break;case"requestObj":$rootScope.$broadcast("evt:nextActReq");break;case"responseObj":$rootScope.$broadcast("evt:nextActRes");break;case"errorMsgs":$roooScope.$broadcast("evt:nextActErr");break;case"settings":$rootScope.$broadcast("evt:exitActSetng")}},$scope.navigateTo=function(screen){function triggerCurrentStageSave(navCb){callback==angular.noop?startNavigation():callback(navCb||angular.noop)}function startNavigation(){window.onbeforeunload=angular.noop,$rootScope.saveAndExit=!1,navigateTo(screen)}var isChanged=(($scope.callbacks[$scope.currentStage.curr]||{}).isChanged||angular.noop)(),callback=($scope.callbacks[$scope.currentStage.curr]||{}).triggerSave||angular.noop;return isChanged?void NotificationService.confirm({msg:i18n.i18nString("bt_wf_proceeding_noty"),successCb:_.partial(triggerCurrentStageSave,startNavigation),failCb:startNavigation,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("save"),fail:i18n.i18nString("discard_label")}}):void startNavigation()},$scope.$on("evt:nextSucc",function(evt,data){$rootScope.saveAndExit&&$location.path(window.appConfig.CONTEXT_PATH)}),$scope.isFinshSetupLoading=!1,$scope.markItConfigured=function(type){function triggerCall(){return $scope.isFinshSetupLoading=!0,"alert"===type?BTAlertsService.configured($workflowService.alertInfo()._id).then(function(res){return $scope.isFinshSetupLoading=!1,$location.path(window.appConfig.CONTEXT_PATH),res},function(err){NotificationService.notify(err.data.errors[0].msg,"error"),$scope.isFinshSetupLoading=!1}):"action"===type?BTActionsService.configured($workflowService.actionInfo()._id).then(function(res){return $scope.isFinshSetupLoading=!1,$location.path(window.appConfig.CONTEXT_PATH),res},function(err){$scope.isFinshSetupLoading=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):void 0}var isChanged=(($scope.callbacks[$scope.currentStage.curr]||{}).isChanged||angular.noop)(),callback=($scope.callbacks[$scope.currentStage.curr]||{}).triggerSave||angular.noop;isChanged&&callback!=angular.noop?callback(triggerCall):triggerCall()},$scope.getAlertType=function(){return $workflowService.alertInfo().type},$scope.isThisSectionRequired=function(section){if("basic"===section)return!0;var type="alert"===$scope.wftype?$scope.entityObj.type:"webservice";return $scope.stages&&$scope.stages[type]&&$scope.stages[type][section]}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-wf-edit",["app.helpers","bt-forms"]);_module.directive("btWfEdit",function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-edit/bt-wf-edit.html",controller:"BTWFEditCtrl"}}),_module.controller("BTWFEditCtrl",["$scope","$rootScope","$routeParams","$timeout","$location","$workflowService","BTSeedDataService","NotificationService","BTAlertsService","BTActionsService","BTStreamsService","i18n","env_conf","mixPanel","BTFlowtaskService","$applicationService",function($scope,$rootScope,$routeParams,$timeout,$location,$workflowService,BTSeedDataService,NotificationService,BTAlertsService,BTActionsService,BTStreamsService,i18n,env_conf,mixPanel,BTFlowtaskService,$applicationService){$scope.gotostream=function(){$location.path(window.appConfig.CONTEXT_PATH)},$rootScope.saveAndExit=!1,$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.junk=null,$scope.taskEditInfo=$workflowService.taskEditInfo(),$scope.wftype=$scope.taskEditInfo.taskType;var action=$workflowService.taskMode();$scope.action=action,$scope.selectedStream=$workflowService.selectedStream(),$scope.showSaveAndExit=!1,$scope.workflowSidebarData={},$scope.workflowSidebarData.stream=$workflowService.selectedStream(),$scope.workflowSidebarData.wfType=$scope.wftype,$scope.currentSection="introForm",$scope.chevronLeftGray=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-left-gray.svg",$scope.callbacks={introForm:{},authForm:{},reqObjForm:{},resObjForm:{},settingsForm:{},soapreqform:{}},$scope.displayMode=action,$scope.forms={introFormDisplayMode:action,authFormDisplayMode:action,reqObjFormDisplayMode:action,resObjFormDisplayMode:action,settingsFormDisplayMode:action,streamFormDisplayMode:action,errorFormDisplayMode:action,finishFormDisplayMode:action},$scope.sections={introForm:!0,authForm:!1,reqObjForm:!1,resObjForm:!1,settingsForm:!1,streamForm:!1,errorForm:!1,finishForm:!1},$scope.helplinks={introForm:{alert:"ALERTS_TASK_BASIC",action:"ACTIONS_TASK_BASIC",report:"INFORMATION_TASK_BASIC"},reqObjForm:{alert:{rest:"ALERT_REQ_REST",soap:"ALERT_REQ_SOAP",webhook:"ALERT_REQ_WEBHOOK",rss:"ALERT_REQ_RSS"},action:{rest:"ACTIONS_REQ_REST",soap:"ACTIONS_REQ_SOAP"},report:{rest:"INFORMATION_REQ_REST",soap:"INFORMATION_REQ_SOAP"}},resObjForm:{alert:"ALERT_RES",action:"ACTIONS_RES",report:"INFORMATION_RES"},settingsForm:{alert:"ALERT_SETTING"}},$scope.updateHelpLink=function(){var taskType="alert"===$scope.wfType?$scope.wfType:resource.isReport?"report":"action",currentSection="soapreqform"===$scope.currentSection?"reqObjForm":$scope.currentSection,connectionType="webservice"===resource.type?resource.subtype:resource.type;return"reqObjForm"===currentSection?$scope.helplinks[currentSection][taskType][connectionType]:$scope.helplinks[currentSection][taskType]},$scope.getBotVariables=function(){BTFlowtaskService.getAllVariables($applicationService.userInfo().userId,$workflowService.selectedStream()._id).then(function(res){$workflowService.botEnvVariables(res.data.variables)})},$scope.getBotVariables(),$scope.showFinishSetup=function(){return"soapreqform"!==$scope.currentSection?!0:$scope.callbacks.soapreqform.showSave()};var resource;return"alert"===$scope.wftype?(resource=$workflowService.alertInfo(),$scope.resource=resource):("action"===$scope.wftype||"report"===$scope.wftype)&&(resource=$workflowService.actionInfo(),$scope.resource=resource),$scope.$on("resourceUpdate",function(){"alert"===$scope.wftype?(resource=$workflowService.alertInfo(),$scope.resource=resource):"action"===$scope.wftype&&(resource=$workflowService.actionInfo(),$scope.resource=resource)}),$scope.$on("mpResourceUpdate",function(event,resourceInfo){if("alert"===resourceInfo.taskType){var mpalert={};mpalert._id=resourceInfo._id,mpalert.shortDesc=resourceInfo.shortDesc,BTAlertsService.updateMPAlert(resourceInfo._id,mpalert).then(function(res){$scope.saveInProgress=!1,$workflowService.mpAlertInfo(res.data),$rootScope.$emit("insertOrUpdateTask","alert",$workflowService.alertInfo(),!1)},function(res){console.log("res")})}else if("action"===resourceInfo.taskType){var mpAction={};mpAction._id=resourceInfo._id,mpAction.shortDesc=resourceInfo.shortDesc,BTActionsService.updateMPAction(resourceInfo._id,mpAction).then(function(res){$scope.saveInProgress=!1,$workflowService.mpActionInfo(res.data),$rootScope.$emit("insertOrUpdateTask","action",$workflowService.actionInfo(),!1)},function(res){console.log("res")})}}),_.isObject(resource)&&Object.keys(resource).length>0?($scope.streamDataId=resource.streamId,$scope.handleIntroForm=function(){"action"===$scope.workflowSidebarData.wfType.toLowerCase()||"report"===$scope.workflowSidebarData.wfType.toLowerCase()?$scope._constants_.action:$scope._constants_.alert;NotificationService.notify(i18n.i18nString("saved"),"success")},$scope.handleAuthForm=angular.noop(),$scope.handleReqObjForm=angular.noop(),$scope.handleResObjForm=angular.noop(),$scope.handleSettingsForm=angular.noop(),$scope.handleStreamForm=angular.noop(),$scope.handleErrorForm=function(){$rootScope.$broadcast("evt:nextSucc")},$scope.errorMsgSave=function(errors,cb){if("alert"===$scope.wftype){var alert={}||$workflowService.alertInfo();alert.errorCodes={pollError:errors},BTAlertsService.createBTAlertUp($workflowService.alertInfo()._id,alert).then(function(res){NotificationService.notify(i18n.i18nString("err_messages_saved_sucess"),"success"),$workflowService.alertInfo(res.data),$scope.handleErrorForm(),cb()},function(res){cb(),$rootScope.saveAndExit=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("err_messages_saved_err"),"error")})}else{var action={}||$workflowService.actionInfo();action.errorCodes={pollError:errors},BTActionsService.updateBTAction($workflowService.actionInfo()._id,action).then(function(res){cb(),NotificationService.notify(i18n.i18nString("err_messages_saved_sucess"),"success"),$workflowService.actionInfo(res.data),$scope.handleErrorForm()},function(res){cb(),$rootScope.saveAndExit=!1,res.data.errors&&res.data.errors[0]&&409===res.data.errors[0].code?NotificationService.notify(res.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("err_messages_saved_err"),"error")})}},$scope.isItRestType=function(){var subtype;return subtype="alert"===$scope.wftype?$workflowService.alertInfo()&&$workflowService.alertInfo().subtype:$workflowService.actionInfo()&&$workflowService.actionInfo().subtype,"soap"!==subtype},$scope.isItSoapType=function(){var subtype;return subtype="alert"===$scope.wftype?$workflowService.alertInfo()&&$workflowService.alertInfo().subtype:$workflowService.actionInfo()&&$workflowService.actionInfo().subtype,"soap"===subtype},$scope.isFinshSetupLoading=!1,$scope.markItConfigured=function(type){function triggerCall(){return $scope.isFinshSetupLoading=!0,"alert"===type&&"published"!==$workflowService.alertInfo().state&&"suspended"!==$workflowService.alertInfo().state?BTAlertsService.configured($workflowService.alertInfo()._id).then(function(res){var eventInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name,BotLanguage:$workflowService.currentLanguage(),Level:"Engagement L2",Category:"Engagement L2","Sub Category":"Conversation - Alert Task","Connection Type":connectionType[$workflowService.alertInfo().type],"Connection Mode":connectionMode[$workflowService.alertInfo().subtype]};return mixPanel.postEvent("Conversation - Alert Task completed",eventInfo),$scope.isFinshSetupLoading=!1,NotificationService.notify=notify,$scope.onCancel(),res},function(err){if(NotificationService.notify=notify,NotificationService.notify(err.data.errors[0].msg,"error"),$scope.isFinshSetupLoading=!1,"Authentication : Authentication is not defined"===err.data.errors[0].msg||"Request : Request is not defined"===err.data.errors[0].msg||"Request : Sample response data is not defined"===err.data.errors[0].msg){for(var key in $scope.sections)$scope.sections.hasOwnProperty(key)&&($scope.sections[key]=!1);$scope.sections.reqObjForm=!0,$scope.navigate("reqObjForm"),$timeout(function(){$rootScope.$emit("goToAuthTab")})}else if("Response : Channel UX map is not defined"===err.data.errors[0].msg||"Response : Response message is not defined"===err.data.errors[0].msg){for(var key1 in $scope.sections)$scope.sections.hasOwnProperty(key1)&&($scope.sections[key1]=!1);$scope.sections.resObjForm=!0,$scope.navigate("resObjForm")}else if("Schedule : Schedule Options not defined"===err.data.errors[0].msg){for(var key2 in $scope.sections)$scope.sections.hasOwnProperty(key2)&&($scope.sections[key2]=!1);$scope.sections.settingsForm=!0,$scope.navigate("settingsForm")}}):"action"===type&&"published"!==$workflowService.actionInfo().state&&"suspended"!==$workflowService.actionInfo().state?BTActionsService.configured($workflowService.actionInfo()._id).then(function(res){return $scope.isFinshSetupLoading=!1,NotificationService.notify=notify,$scope.onCancel(),res},function(err){if($scope.isFinshSetupLoading=!1,NotificationService.notify=notify,NotificationService.notify(err.data.errors[0].msg,"error"),"Authentication : Authentication is not defined"===err.data.errors[0].msg||"Request : Request is not defined"===err.data.errors[0].msg||"Request : Sample response data is not defined"===err.data.errors[0].msg){for(var key in $scope.sections)$scope.sections.hasOwnProperty(key)&&($scope.sections[key]=!1);$scope.sections.reqObjForm=!0,$scope.navigate("reqObjForm"),$timeout(function(){$rootScope.$emit("goToAuthTab")})}else if("Response : Channel UX map is not defined"===err.data.errors[0].msg||"Response : Response message is not defined"===err.data.errors[0].msg){for(var key1 in $scope.sections)$scope.sections.hasOwnProperty(key1)&&($scope.sections[key1]=!1);$scope.sections.resObjForm=!0,$scope.navigate("resObjForm")}else if("Schedule : Schedule Options not defined"===err.data.errors[0].msg){for(var key2 in $scope.sections)$scope.sections.hasOwnProperty(key2)&&($scope.sections[key2]=!1);$scope.sections.settingsForm=!0,$scope.navigate("settingsForm")}}):($scope.isFinshSetupLoading=!1,NotificationService.notify=notify,$scope.onCancel(),NotificationService.notify(i18n.i18nString("setup_added_success"),"success"),void 0)}var isChanged=(($scope.callbacks[$scope.currentSection]||{}).isChanged||angular.noop)(),callback=($scope.callbacks[$scope.currentSection]||{}).triggerSave||angular.noop,notify=NotificationService.notify.bind(NotificationService);if(NotificationService.notify=angular.noop,isChanged&&callback!=angular.noop?callback(triggerCall):triggerCall(),"alert"===$scope.wfType){$scope.alerttypes=$workflowService.seedData().alertTypes||[],$scope.alerttypes.length&&"Webservice"!==$scope.alerttypes[0].name&&$scope.alerttypes.reverse();for(var i=0;i<$scope.alerttypes.length;i++)if("email"===$scope.alerttypes[i].value){$scope.alerttypes.splice(i,1);break}}$scope.subtypes=$workflowService.seedData().webserviceTypes;var connectionType={},connectionMode={};$scope.alerttypes.forEach(function(value){connectionType[value.value]=value.name}),$scope.subtypes.forEach(function(value){connectionMode[value.value]=value.name})},$scope.navigate=function(section){function triggerCurrentStageSave(navCb){callback==angular.noop?startNavigation():callback(navCb||angular.noop)}function startNavigation(){window.onbeforeunload=angular.noop,"finishForm"===section?$scope.showSaveAndExit=!1:$scope.showSaveAndExit=!0;for(var key in $scope.sections)$scope.sections.hasOwnProperty(key)&&($scope.sections[key]=!1);$scope.sections[section]=!0,$scope.currentSection=section,$scope.isItSoapType()&&"reqObjForm"===$scope.currentSection&&($scope.currentSection="soapreqform"),$("html, body").animate({scrollTop:0},"fast"),$("#btFullpageModal .main-content").animate({scrollTop:0},"fast"),PerfectScrollbar.update($("#btFullpageModal .main-content")[0])}if("published"===$scope.resource.state&&"view"!==action)return void NotificationService.notify(i18n.i18nString("bt_wf_edit_bascic_Settings_published_state"),"warning");if("suspended"===$scope.resource.state&&"view"!==action)return void NotificationService.notify(i18n.i18nString("bt_wf_edit_bascic_Settings_suspended_state"),"warning");var isChanged=(($scope.callbacks[$scope.currentSection]||{}).isChanged||angular.noop)(),callback=($scope.callbacks[$scope.currentSection]||{}).triggerSave||angular.noop;return isChanged&&"view"!==action?void NotificationService.confirm({msg:i18n.i18nString("bt_wf_proceeding_noty"),successCb:_.partial(triggerCurrentStageSave,startNavigation),failCb:startNavigation,cancelCb:function(){return!1},isModal:!0,btnTexts:{success:i18n.i18nString("save"),fail:i18n.i18nString("discard_label")}}):void startNavigation()},$scope.isWebhook=function(){return"webhook"===$scope.resource.type},$workflowService.reigisterModalShownEvent(),$scope.clearSetUpLocalStorageFortask=function(setTaskId){var localPath=window.localStorage.getItem("previousState");localPath&&(localPath=JSON.parse(localPath),localPath.selectedTaskType&&!setTaskId&&delete localPath.selectedTaskType,localPath.selectedTaskId&&!setTaskId&&delete localPath.selectedTaskId,setTaskId&&(localPath.selectedTaskId=setTaskId),window.localStorage.setItem("previousState",JSON.stringify(localPath)))},$scope.onCancel=function(){$rootScope.$emit("updateSummaryData"),$scope.clearSetUpLocalStorageFortask(),$("#btFullpageModal").modal("hide"),$("body").removeClass("bt-modal-open"),$rootScope.$emit("insertOrUpdateTask",$scope.wftype,$scope.taskEditInfo,!1),$rootScope.$emit("showContent"),$rootScope.$broadcast("updateEditTask",!1)},$scope.onSaveAndExit=function(){$rootScope.saveAndExit=!0,$scope.sections.introForm?$rootScope.$broadcast("evt:nextActintro"):$scope.sections.authForm?$rootScope.$broadcast("evt:nextActAuth"):$scope.sections.reqObjForm?$rootScope.$broadcast("evt:nextActReq"):$scope.sections.resObjForm?$rootScope.$broadcast("evt:nextActRes"):$scope.sections.errorForm?$rootScope.$broadcast("evt:nextActErr"):$scope.sections.settingsForm&&$rootScope.$broadcast("evt:exitActSetng")},$scope.$on("evt:nextSucc",function(evt,data){$rootScope.saveAndExit&&$location.path(window.appConfig.CONTEXT_PATH)}),$("html, body").animate({scrollTop:0},"fast"),void $scope.$emit("nestedComponentLoaded",{id:"alertsActionsForm",flag:!1})):void $location.path(window.appConfig.CONTEXT_PATH)}])}(angular),function(ng){"use strict";var btstreams=ng.module("bt-wf-logs",[]);btstreams.directive("wfLogs",[function(){return{restrict:"EA",scope:{activeTask:"="},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-logs-view/bt-wf-logs-view.html",controller:"BTWfLogsViewCtrl"}}]),btstreams.controller("BTWfLogsViewCtrl",["$scope","BTActionsService","BTAlertsService","$routeParams","$workflowService","$location","i18n",function($scope,BTActionsService,BTAlertsService,$routeParams,$workflowService,$location,i18n){function parse(string){try{return JSON.parse(string)}catch(ex){return string}}var offset=0,limit=5,moreAvailable=!1;$scope.currentPage=1,$scope.selectedStream=$workflowService.selectedStream();var taskId=$scope.activeTask._id,taskType=$scope.activeTask.taskType;$scope.options={mode:"text",ace:window.ace},$scope.context={bot:$scope.selectedStream.name,task:$scope.activeTask.name},$scope.loadingMore=!1,$scope.refreshLogs=function(){offset=0,limit=5,moreAvailable=!1,$scope.getLogs()},$scope.getLogs=function(){$scope.loading=!0,$scope.currentPage=1,$scope.logs=[];var apiCall;apiCall="action"===taskType?BTActionsService.getApiLogs(taskId,offset,limit):BTAlertsService.getApiLogs(taskId,offset,limit),apiCall.then(function(res){var _logs=[];offset+=limit,moreAvailable=res.data&&res.data.moreAvailable?res.data.moreAvailable:!1,_logs=res.data.result?res.data.result:res.data,$scope.logs=_logs.map(function(log){delete log.actionId,delete log.alertId,log.hasOwnProperty("responseData")&&(log.responseData=parse(log.responseData));var tmpDate=new Date(log.createdOn).toLocaleString();return tmpDate=tmpDate.replace(/\//g,"-"),log.createdOn=tmpDate,delete log.$$hashKey,log}),$scope.loading=!1},function(err){$scope.logs=[],$scope.loading=!1})},$scope.getMoreLogs=function(){if(moreAvailable&&!$scope.loadingMore){$scope.loadingMore=!0;var apiCall;apiCall="action"===taskType?BTActionsService.getApiLogs(taskId,offset,limit):BTAlertsService.getApiLogs(taskId,offset,limit),apiCall.then(function(res){var _logs=res.data.result;offset+=limit,moreAvailable=res.data&&res.data.moreAvailable?res.data.moreAvailable:!1,$scope.loadingMore=!1;var _moreLogs=_logs.map(function(log){return delete log.actionId,delete log.alertId,log.hasOwnProperty("responseData")&&(log.responseData=parse(log.responseData)),delete log.$$hashKey,log});_logs&&_logs.length&&($scope.logs=$scope.logs.concat(_moreLogs)),$scope.loading=!1},function(err){$scope.loadingMore=!1})}},$scope.getLogs(),$("wf-logs .logs-page").on("scroll",function(event){$(this).scrollTop()+$(this).innerHeight()>=.9*$(this)[0].scrollHeight&&$("wf-logs .logs-page").is(":visible")&&$scope.getMoreLogs()}),$scope.exit=function(){$location.path(window.appConfig.CONTEXT_PATH)}}])}(angular),function(ng){"use strict";var _module=ng.module("bt-kore-components");_module.controller("BTWFMappingJSEditorCtrl",["$scope","soap","$rootScope","$translator","$modalInstance","$workflowService","config","NotificationService","i18n",function($scope,soap,$rootScope,$translator,$modalInstance,BTFlowtaskService,config,NotificationService,i18n){function init(){$scope.mappingScriptObj=config.component||"",$scope.jsEditorCbs={}}$scope.closeModal=function(){$modalInstance.close()},$scope.codeCallback=function(data){},$scope.saveScript=function(){config&&config.cbBridge&&config.cbBridge($scope.mappingScriptObj),$scope.closeModal()},function(){init()}()}])}(angular),function(ng){var _module=ng.module("bt-wf-mapping",[]);_module.directive("btWfMapping",[function(){return{restrict:"EA",scope:{onClose:"=",activeEntity:"=",component:"=",footerMappingid:"@"},templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/bt-wf-mapping/bt-wf-mapping.html",controller:"BTWFMappingCtrl"}}]),_module.controller("BTWFMappingCtrl",["$scope","$modal","$filter","BTStreamsService","$q","$rootScope","$routeParams","$applicationService","$translator","$workflowService","$util","NotificationService","BTParamMapService","$location","form_util","$timeout","i18n",function($scope,$modal,$filter,BTStreamsService,$q,$rootScope,$routeParams,$applicationService,$translator,$workflowService,$util,NotificationService,BTParamMapService,$location,form_util,$timeout,i18n){function getAlert(_resourceId){var type="l"===_resourceId[0]?"alert":"action";"alert"===type?$translator.translate("bt.alertsId.get",{alertId:_resourceId}).then(function(res){$scope.selectedAlert=res.data,$scope.isAlertToDialogMapping||initMappingStep2()}).then(function(){BTStreamsService.getMPStream($scope.selectedAlert.streamId).then(function(res){$scope.selectedAlertStream=res.data})}):"action"===type&&$translator.translate("bt.actionsId.get",{actionId:_resourceId}).then(function(res){$scope.selectedAlert=res.data,initMappingStep2()}).then(function(){BTStreamsService.getMPStream($scope.selectedAlert.streamId).then(function(res){$scope.selectedAlertStream=res.data})})}function getAction(_resourceId){$translator.translate("bt.actionsId.get",{actionId:_resourceId}).then(function(res){$scope.selectedAction=res.data,initMappingStep2()}).then(function(){BTStreamsService.getMPStream($scope.selectedAction.streamId).then(function(res){$scope.selectedActionStream=res.data})})}function getDialog(_streamId,_dialogId){$translator.translate("bt.dialog.get",{streamId:_streamId,dialogId:_dialogId}).then(function(res){$scope.selectedAction=res.data}).then(function(){BTStreamsService.getMPStream($scope.selectedAction.streamId).then(function(res){$scope.selectedActionStream=res.data,$translator.translate("bt.components.get",{streamId:$scope.selectedAction.streamId}).then(function(res){var components=res.data.filter(function(obj){return"published"===obj.status});$.each($scope.selectedAction.nodes,function(index,component){var result=components.filter(function(o){return o._id===component.componentId});$scope.selectedAction.nodes[index]=result[0],$scope.selectedAction.nodes.length-1===index&&initMappingStep2()})})})})}function getMappedAlertDialog(){BTParamMapService.getMappedAlertDialog($routeParams.mapId).then(function(res){$scope.mapping=res.data,getAlert(res.data.sourceResourceId),getDialog(res.data.targetResourceStreamId,res.data.targetResourceId),loader()},function(){$scope.mapping={},loader()})}function getMappedAlertAction(){BTParamMapService.getMappedAlertAction($routeParams.mapId).then(function(res){$scope.mapping=res.data,getAlert(res.data.alertId),getAction(res.data.actionId),loader()},function(){$scope.mapping={},loader()})}function checkForCompatibility(){var alertVisibility=$scope.selectedAlert&&$scope.selectedAlert.visibility||"",actionVisibility=$scope.selectedAction&&$scope.selectedAction.visibility||"";alertVisibility&&actionVisibility?$scope.notCompatible=$scope.selectedAlert&&$scope.selectedAction&&!_.isEqual($scope.selectedAlert.visibility,$scope.selectedAction.visibility):$scope.notCompatible=!1}function canBeAutomated(actionFields,mappedFields){var obj={};return mappedFields.map(function(key){obj[key]=key}),actionFields.reduce(function(prev,curr){return(prev&&obj[curr]||!1)&&!0},!0)}function initMappingStep2(){if($scope.notCompatible)return void NotificationService.notify(i18n.i18nString("bt_wf_mapping_both_entities_not_published_same_destination"),"error");if($scope.mappingObj={mapping:{},issuggestedaction:$scope.mapping.markAsSuggested,markAsAutomated:$scope.mapping.markAsAutomated,mappingname:$scope.mapping.name},_.isObject($scope.selectedAlert)&&($scope.selectedAlert.sample=$scope.selectedAlert&&$scope.selectedAlert.sample||{}),$scope.selectedAlert&&$scope.selectedAlert.sample){var data=getSampleResKeys($scope.selectedAlert,$scope.selectedAlert.sample);delete data.metainfo,$translator.translate("bt.dotKeys.post",{},data).then(function(res){$scope.alertFields=res.data,$scope.noAlertFields=!1},function(res){})}if($scope.selectedAction&&$scope.selectedAction.payloadField)if($scope.actionFields=$scope.selectedAction.payloadField.concat($scope.selectedAction.queryField),$scope.mapping.map)for(var i=0;i<$scope.mapping.map.length;i++){var obj=$scope.mapping.map[i];$scope.mappingObj.mapping[obj.actionKey]=obj.value||"",$scope.mappingObj.mapping[obj.actionKey+"label"]=obj.label||"",$scope.mappingObj.mapping[obj.actionKey+"visibility"]=obj.visibility||""}else for(var j=0;j<$scope.actionFields.length;j++){var field=$scope.actionFields[j];$scope.mappingObj.mapping[field.key]=field.mapping}else if($scope.selectedAction&&$scope.selectedAction.nodes){if($scope.actionFields=$scope.selectedAction.nodes.filter(function(node){return"entity"===node.type}),$.each($scope.actionFields,function(index,value){value.key=value.name,value.title=value.name,value.showKeyTextArea=!1}),$scope.editMode&&$scope.mapping.map&&$scope.actionFields.length!==$scope.mapping.map.length)for(var counter=0;counter<$scope.mapping.map.length;counter++){var map=$scope.mapping.map[counter];map.destinationKey=map.destinationKey.replace("context.entities.","");var result=$scope.actionFields.filter(function(o){return o.key===map.destinationLabel});if(!result.length){var _actionFieldObj={fieldType:"textbox",isRequired:!1,key:map.destinationKey,name:map.destinationKey,title:map.destinationKey,type:"entity",showKeyTextArea:!0};$scope.actionFields.push(_actionFieldObj)}$scope.mapping.map.length-1===counter&&$scope.addNewDialogFlowMapping()}if($scope.mapping.map)for(var mapCounter=0;mapCounter<$scope.mapping.map.length;mapCounter++){var _obj=$scope.mapping.map[mapCounter];_obj.destinationKey=_obj.destinationKey.replace("context.entities.",""),$scope.mappingObj.mapping[_obj.destinationKey]=_obj.value||"",$scope.mappingObj.mapping[_obj.destinationKey+"label"]=_obj.destinationLabel||""}else for(var mapCounter1=0;mapCounter1<$scope.actionFields.length;mapCounter1++){var _actionField=$scope.actionFields[mapCounter1];$scope.mappingObj.mapping[_actionField.key]=_actionField.mapping}}}function getParamMap(){if(!$scope.isAlertToDialogMapping||$scope.actionFields){var map=[],mapping=$scope.mappingObj.mapping,actionFields=[];if($scope.isAlertToDialogMapping?(actionFields=$scope.actionFields.slice(),$.each(actionFields,function(index,value){value.key=value.name})):actionFields=$scope.selectedAction.payloadField.concat($scope.selectedAction.queryField),$scope.isAlertToDialogMapping){for(var j=0;j<actionFields.length;j++)if(mapping[actionFields[j].key]){var _mapItem={};_mapItem.destinationKey=actionFields[j].key,_mapItem.destinationLabel=actionFields[j].title,_mapItem.value=$util.unescape(mapping[actionFields[j].key]+""),map.push(_mapItem)}}else for(var i=0;i<actionFields.length;i++)if(mapping[actionFields[i].key]){var mapItem={};mapItem.actionKey=actionFields[i].key,mapItem.actionKeyLabel=actionFields[i].title,mapItem.value=$util.unescape(mapping[actionFields[i].key]+""),mapItem.label=$util.unescape(mapping[actionFields[i].key+"label"]+""),mapItem.visibility=mapping[actionFields[i].key+"visibility"]||"hidden",map.push(mapItem)}for(k=0;k<map.length;k++){map[k];"workspace"!==map[k].actionKey&&"projects"!==map[k].actionKey||map[k].value||map.splice(k,1)}return map}}function getDialogParamsMapping(){var map=[],mapping=$scope.mappingObj.mapping,actionFields=[];actionFields=$scope.actionFields.slice(),$.each(actionFields,function(index,value){value.key=value.name});for(var j=0;j<actionFields.length;j++)if(mapping[actionFields[j].key]){var _mapItem={};_mapItem.destinationKey=actionFields[j]._id?"context.entities."+actionFields[j].key:actionFields[j].key,_mapItem.destinationLabel=actionFields[j].title,_mapItem.value=$util.unescape(mapping[$scope.actionFields[j].key]+""),map.push(_mapItem)}for(k=0;k<map.length;k++){map[k];"workspace"!==map[k].actionKey&&"projects"!==map[k].actionKey||map[k].value||map.splice(k,1)}return map}function saveDialogFlowMap(){$.each($scope.actionFields,function(index,value){value.name==="key"+(_newDialogMappingCount-1)||""===value.title?(delete $scope.mappingObj.mapping[$scope.actionFields[index].key],delete $scope.mappingObj.mapping[$scope.actionFields[index].key+"label"],$scope.actionFields.splice(index,1)):value.showKeyTextArea&&($scope.mappingObj.mapping[value.title]=$scope.mappingObj.mapping[value.key],$scope.mappingObj.mapping[value.title+"label"]=$scope.mappingObj.mapping[value.key+"label"],$scope.actionFields[index].key=$scope.actionFields[index].title,$scope.actionFields[index].name=$scope.actionFields[index].title)}),saveMapping()}function saveMapping(){if($scope.notCompatible)return void NotificationService.notify(i18n.i18nString("bt_wf_mapping_both_entities_not_published_same_destination"),"error");$scope.mappingInProgress=!0;var mappingData={};$scope.isAlertToDialogMapping?(mappingData.name=$scope.mappingObj.mappingname,mappingData.sourceResourceId=$scope.selectedAlert._id,mappingData.sourceResourceVersion=$scope.selectedAlert.version,mappingData.sourceResourceStreamId=$scope.selectedAlertStream._id,mappingData.targetResourceId=$scope.selectedAction._id,mappingData.targetResourceVersion="1.0",mappingData.targetResourceStreamId=$scope.selectedActionStream._id,mappingData.map=getDialogParamsMapping(),mappingData.state="configured",mappingData.markAsSuggested=$scope.mappingObj.issuggestedaction&&!0):(mappingData.name=$scope.mappingObj.mappingname,mappingData.alertStreamId=$scope.selectedAlertStream._id,mappingData.alertId=$scope.selectedAlert._id,mappingData.actionStreamId=$scope.selectedActionStream._id,mappingData.actionId=$scope.selectedAction._id,mappingData.alertVersion=$scope.selectedAlert.version,mappingData.actionVersion=$scope.selectedAction.version,mappingData.map=getParamMap(),mappingData.state="active",mappingData.markAsSuggested=$scope.mappingObj.issuggestedaction&&!0,mappingData.markAsAutomated=$scope.mappingObj.markAsAutomated&&!0),$scope.editMode?$scope.isAlertToDialogMapping?BTParamMapService.updateAlertDialogParamMap($routeParams.mapId,mappingData).then(function(res){$scope.mappingInProgress=!1,NotificationService.notify(i18n.i18nString("flow_updated_sucessfully",{dyn:mappingData.name}),"success"),goHome()},function(err){$scope.mappingInProgress=!1;var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("some_thing_went_wrong_tryAgain");409===err.status?(NotificationService.notify(msg,"error"),$scope.currentStep=1):NotificationService.notify(msg,"error")}):BTParamMapService.updateParamMap($routeParams.mapId,mappingData).then(function(res){
$scope.mappingInProgress=!1,NotificationService.notify(i18n.i18nString("flow_updated_sucessfully",{dyn:mappingData.name}),"success"),goHome()},function(err){$scope.mappingInProgress=!1;var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("some_thing_went_wrong_tryAgain");409===err.status?(NotificationService.notify(msg,"error"),$scope.currentStep=1):NotificationService.notify(msg,"error")}):$scope.isAlertToDialogMapping?$translator.translate("bt.paramDialogMap.post",{actionId:mappingData.targetResourceId},mappingData).then(function(res){$scope.mappingInProgress=!1,NotificationService.notify(i18n.i18nString("flow_saved_sucessfully",{dyn:mappingData.name}),"success"),goHome()},function(err){$scope.mappingInProgress=!1;var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("some_thing_went_wrong_tryAgain");409===err.status?(NotificationService.notify(msg,"error"),$scope.currentStep=1):NotificationService.notify(msg,"error")}):$translator.translate("bt.paramMap.post",{actionId:mappingData.actionId},mappingData).then(function(res){$scope.mappingInProgress=!1,NotificationService.notify(i18n.i18nString("flow_saved_sucessfully",{dyn:mappingData.name}),"success"),goHome()},function(err){$scope.mappingInProgress=!1;var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("some_thing_went_wrong_tryAgain");409===err.status?(NotificationService.notify(msg,"error"),$scope.currentStep=1):NotificationService.notify(msg,"error")})}function deleteMapping(){BTParamMapService.deleteMappedAlertAction($routeParams.mapId).then(function(res){NotificationService.alertNotify(i18n.i18nString("flow_deleted_success"),"success"),goHome()},function(err){NotificationService.alertNotify(i18n.i18nString("flow_deleted_failed"),"error")})}function getSampleResKeys(alert,data){var _sKey,_sampleResponse=parse(data),_sReqChain=alert.requestChain;return"webhook"===alert.type?_sKey=alert.alertsPath:_sReqChain.map(function(chain){"processor"===chain.linkType&&"_extract"===chain.linkDefinition.type&&(_sKey=chain.linkDefinition.key)}),_sKey&&data?_sampleResponse&&_sKey?resolveObjectPath(_sampleResponse,_sKey):_sampleResponse:parse(data)}function resolveObjectPath(source,path,result){return"string"==typeof source&&(source=parse(source)),-1===path.indexOf("$.")&&(path="$.."+path),result=JSONPath({json:source,path:path})[0],result instanceof Array?result[0]:"object"==typeof result?result:source}function parse(json){if("string"==typeof json)try{return JSON.parse(json)}catch(ex){return{}}else if("object"==typeof json)return json}function goHome(){$scope.component||$scope.exit(!0)}var $win=window;$scope.stream=$workflowService.selectedStream(),$scope.$emit("nestedComponentLoaded",{id:"flows",flag:!1}),$scope.form={},$scope.activeEntity=$scope.activeEntity||{},$scope.footerMappingid=$scope.activeEntity._id?$scope.footerMappingid:"tasks-create-mapping",$scope.isAlertToDialogMapping=!1,$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.tmpltPrePath=$scope.$root.tmpltPrePath,$scope.save_exit=i18n.i18nString("save_exit"),$scope.update=i18n.i18nString("update"),$scope.edit=i18n.i18nString("edit"),$scope.create=i18n.i18nString("create_label"),$scope.activeEntity&&$scope.activeEntity.mapId?($scope.resource=$scope.activeEntity,$scope.activeEntity.alertStreamId===$scope.stream._id?$scope.resourceType="alert":$scope.resourceType="action",$scope.mapId=$scope.activeEntity.mapId):$scope.activeEntity&&$scope.activeEntity._id&&$scope.activeEntity.sourceResourceStreamId?($scope.resource=$scope.activeEntity,$scope.activeEntity.sourceResourceStreamId===$scope.stream._id&&($scope.resourceType="alert"),$scope.mapId=$scope.activeEntity._id,"d"===$scope.activeEntity.targetResourceId[0]&&($scope.isAlertToDialogMapping=!0)):$scope.resource&&$scope.resource.targetResourceId?("d"===$scope.resource.targetResourceId[0]&&($scope.isAlertToDialogMapping=!0),"l"===$scope.resource.sourceResourceId[0]&&($scope.resourceType="alert"),$scope.mapId=$scope.resource._id):$scope.activeEntity&&$scope.activeEntity.taskType&&($scope.resourceType=$scope.activeEntity.taskType),$scope.resource=$scope.resource||{},$routeParams.mapId=$scope.mapId;var _resourceType=$scope.resourceType,_apConstants=$applicationService.getAppConstants(),_resourceId="";_resourceId=$scope.isAlertToDialogMapping?$scope.mapId?"alert"===$scope.resourceType?$scope.resource.sourceResourceId:$scope.resource.targetResourceId:$scope.activeEntity._id:$scope.mapId?"alert"===$scope.resourceType?$scope.resource.alertId:$scope.resource.actionId:$scope.activeEntity._id,$scope.editMode=!1,$scope.wfType=_resourceType,$scope.listMappings=!1;var _newDialogMappingCount=1;$scope.currentStep=1,$scope._constants_=$rootScope._constants_;var loader=angular.noop;$scope.mapId&&$scope.component&&(loader=NotificationService.loader("Please wait")),$routeParams.mapId?($scope.currentStep=2,$scope.editMode=!0,$scope.isAlertToDialogMapping?getMappedAlertDialog():getMappedAlertAction()):(_resourceType===_apConstants.RESOURCE_TYPE_ALERT?_resourceId&&getAlert(_resourceId):_resourceType===_apConstants.RESOURCE_TYPE_ACTION&&_resourceId&&getAction(_resourceId),$scope.selectedAlertStream=$workflowService.selectedStream()),$scope.clearSetUpLocalStorageFortask=function(setTask){var localPath=window.localStorage.getItem("previousState");localPath&&(localPath=JSON.parse(localPath),localPath.selectedTaskType&&!setTask&&delete localPath.selectedTaskType,localPath.selectedTaskId&&!setTask&&delete localPath.selectedTaskId,window.localStorage.setItem("previousState",JSON.stringify(localPath)))},$scope.mapping={},$scope.resourceDetails={},$scope.mappingObj={},$scope.noAlertFields=!1,$scope.changeStream=function(type){type===_apConstants.RESOURCE_TYPE_ALERT?($scope.selectedAlert=null,$scope.selectedAlertStream=null,$scope.showAlertStreamChooser=!0,$scope.showTypeaheadForAlert=!1):type===_apConstants.RESOURCE_TYPE_ACTION&&($scope.selectedAction=null,$scope.selectedActionStream=null,$scope.showActionStreamChooser=!0,$scope.showTypeaheadForAction=!1)},$scope.changeResource=function(type){type===_apConstants.RESOURCE_TYPE_ALERT?($scope.selectedAlert=null,$scope.showTypeaheadForAlert=!0):type===_apConstants.RESOURCE_TYPE_ACTION&&($scope.selectedAction=null,$scope.showTypeaheadForAction=!0),initMappingStep2()},$scope.toggleActionStreamChooser=function(){$scope.showTypeaheadForAction=!1,$scope.showActionStreamChooser=!$scope.showActionStreamChooser},$scope.toggleActionResourceChooser=function(){$scope.showActionStreamChooser=!1,$scope.showTypeaheadForAction=!$scope.showTypeaheadForAction},$scope.toggleAlertStreamChooser=function(){$scope.showTypeaheadForAlert=!1,$scope.showAlertStreamChooser=!$scope.showAlertStreamChooser},$scope.toggleAlertResourceChooser=function(){$scope.showAlertStreamChooser=!1,$scope.showTypeaheadForAlert=!$scope.showTypeaheadForAlert},$scope.setSelectedActionStream=function(data){$scope.showActionStreamChooser=!1,$scope.selectedActionStream=data.stream},$scope.setSelectedAction=function(data){$scope.showTypeaheadForAction=!1,$scope.selectedAction=data.action,$scope.isAlertToDialogMapping=$scope.selectedAction.isAlertToDialogMapping,checkForCompatibility(),initMappingStep2()},$scope.setSelectedAlertStream=function(data){$scope.showAlertStreamChooser=!1,$scope.selectedAlertStream=data.stream},$scope.setSelectedAlert=function(data){$scope.showTypeaheadForAlert=!1,$scope.selectedAlert=data.alert,checkForCompatibility(),initMappingStep2()},$scope.cancel=function(step){$location.path(window.appConfig.CONTEXT_PATH+"/workflows")},$scope.stepBack=function(event,steptogoto){$scope.currentStep=2,$scope.isStepNext=!1},$scope.isStepNext=!1,$scope.stepNext=function(from,to){var constraints=[{prop:"selectedAlertStream",msg:i18n.i18nString("bt_wf_mapping_ppls_select_alert_task_stream")},{prop:"selectedActionStream",msg:i18n.i18nString("bt_wf_mapping_ppls_select_action_task_stream")},{prop:"selectedAlert",msg:i18n.i18nString("bt_wf_mapping_ppls_select_alert_task")},{prop:"selectedAction",msg:i18n.i18nString("bt_wf_mapping_ppls_select_action_task")}];if(1===$scope.currentStep)for(var i=0;i<constraints.length;i++)if(!($scope[constraints[i].prop]&&$scope[constraints[i].prop].name&&Object.keys($scope[constraints[i].prop]).length>0))return void NotificationService.notify(constraints[i].msg,"error");var fields=$scope.actionFields.filter(function(field){return field.isRequired});fields=_.pluck(fields,"key");var mappedfields=_.pluck(getParamMap(),"actionKey");$scope.canbeAutomated=canBeAutomated(fields,mappedfields),$scope.isStepNext=!0,$scope.currentStep=3},$scope.$watch(function(){if($scope.selectedAction){var fields=[];$scope.selectedAction.payloadField?($scope.actionFields=$scope.selectedAction.payloadField.concat($scope.selectedAction.queryField).filter(function(field){return"hidden"!==field.visibility}),fields=$scope.actionFields.filter(function(field){return field.isRequired}),fields=_.pluck(fields,"key")):$scope.editMode&&$scope.isAlertToDialogMapping?$scope.actionFields&&$scope.actionFields.length&&""!==$scope.actionFields[$scope.actionFields.length-1].title&&$scope.addNewDialogFlowMapping():(0===$scope.actionFields.length&&($scope.actionFields=$scope.selectedAction.nodes.filter(function(node){return"entity"===node.type}),$scope.addNewDialogFlowMapping()),$scope.actionFields.length&&""!==$scope.actionFields[$scope.actionFields.length-1].title&&$scope.addNewDialogFlowMapping(),fields=$scope.actionFields.slice(),fields=_.pluck(fields,"name"));var mappedfields=_.pluck(getParamMap(),"actionKey");$scope.canbeAutomated=canBeAutomated(fields,mappedfields)}}),$scope.saveAndExit=function(valid,form){if(!$scope.form.mapping_form.$valid)return void form_util.touch($scope.form.mapping_form);var _customMapMissingKeysCount=0;$scope.isAlertToDialogMapping&&$.each($scope.actionFields,function(index,value){""===value.title&&(_customMapMissingKeysCount+=1)}),$scope.isAlertToDialogMapping&&_customMapMissingKeysCount>1?NotificationService.alert(i18n.i18nString("bt_wf_mapping_custom_fields_discarded"),saveDialogFlowMap,arguments):$scope.isAlertToDialogMapping?saveDialogFlowMap():saveMapping()},$scope.mappingInProgress=!1,$scope.deleteMapping=function(){NotificationService.alert(i18n.i18nString("you_really_want_to_delete_this_flow"),deleteMapping,arguments)},$scope.addNewDialogFlowMapping=function(){var actionFieldObj={fieldType:"textbox",isRequired:!1,key:"key"+_newDialogMappingCount,name:"key"+_newDialogMappingCount,title:"",type:"entity",showKeyTextArea:!0};$scope.actionFields.push(actionFieldObj),$scope.mappingObj.mapping[actionFieldObj.key]=actionFieldObj.mapping,_newDialogMappingCount+=1},$scope.removeDialogFlowMapping=function(index){delete $scope.mappingObj.mapping[$scope.actionFields[index].key],delete $scope.mappingObj.mapping[$scope.actionFields[index].key+"label"],$scope.actionFields.splice(index,1)},$scope.onDrop=function(key){$rootScope.$broadcast("after-drop"),$scope.mappingObj.mapping[key]=event.currentTarget.value},$scope.goToStreams=function(){$location.path(window.appConfig.CONTEXT_PATH+"/streamnew")},$scope.openMappingTextAreaModalDialog=function(field,type,fieldKey){var msgText=$scope.mappingObj.mapping[fieldKey]?$scope.mappingObj.mapping[fieldKey]:"",prompt=($scope.actionFields.filter(function(field){return field.key===fieldKey}),$win.bootbox.prompt({title:field+" - "+type,className:"textareaModal",inputType:"textarea",value:msgText,buttons:{confirm:{label:"Done"}},callback:function(result){null!==result&&($scope.mappingObj.mapping[fieldKey]=result)}}));prompt.init(function(){setTimeout(function(){prompt.find(".bootbox-form").prepend('<div class="jsEditorPromptHeader">Editor</div>')},100)})},$scope.exit=function(reload){$scope.clearSetUpLocalStorageFortask(),$rootScope.$broadcast("closeMappingWorkflowEvent"),$scope.$parent.callback.onFlowDialogClosed(reload)},$scope.updateFooterHeader=function(){return $scope.footerMappingid?($scope.footerInfoTitle=i18n.i18nString("create_new_flow"),$scope.footerHeaderId=$scope.footerMappingid,$scope.footerPanelId=$scope.footerMappingid+"-panel",$scope.nameDescription=i18n.i18nString("resource.bb053"),!0):!1},$timeout(function(){$("body").removeClass("modal-open"),$("body").removeClass("bt-modal-open"),$scope.$apply()})}])}(angular),function(ng){"use strict";var _module=ng.module("ml-threshold",[]);_module.directive("stopPropagation",function(){return{restrict:"A",link:function(scope,element){element.bind("click",function(event){event.stopPropagation()})}}}),_module.directive("mlThreshold",[function(){return{restrict:"EA",templateUrl:window.appConfig.TMPLT_PRE_PATH+"js/modules/ml-threshold/ml-threshold.html",controller:"MlThresholdController",link:function(scope,el,attrs){},scope:{selectedStream:"=",streamUpdateCb:"=",gSearchCb:"="}}}]),_module.directive("slideBottomMl",function(){return{restrict:"EA",link:function(scope,el,attrs){$(el).on("click",function(){setTimeout(function(){var _ele=$(el).parents(".ps-container").first(),dropDownHeight=$(el).siblings(".dropdown-menu").children(".content-menu").outerHeight();$(el).parents(".ps-container").first().animate({scrollTop:$(_ele)[0].scrollHeight+dropDownHeight}),$(el).siblings(".dropdown-menu").children(".content-menu").animate({scrollTop:10})},200)})}}}),_module.controller("MlThresholdController",["$scope","$translator","$rootScope","$workflowService","BTStreamsService","BTFlowtaskService","NotificationService","$timeout","accessControlService","$element","env_conf","$interval","$applicationService","botOntologyService","i18n","$http","$q",function($scope,$translator,$rootScope,$workflowService,BTStreamsService,BTFlowtaskService,NotificationService,$timeout,accessControlService,$element,env_conf,$interval,$applicationService,botOntologyService,i18n,$http,$q){function registerSlider(ele,obj){var slider=$(ele).bootstrapSlider(obj);return $(ele).slider().on("slideStop ",function(ev){onSliderChanged(ele,ev.value)}),$(ele).slider().on("slide",function(ev){formatTooltip(ele,ev.value)}),slider}function deRegisterSlider(ele){$(ele).slider().off("slideStop "),$(ele).slider().off("slide")}function formatTooltip(mode,val){switch(mode){case"#slider2":$("#proxMatch-slider").find(".tooltip-inner").text(val+"%");break;case"#slider3":$("#mlThreshold-slider").find(".tooltip-inner").text(val);break;case"#slider4":$("#defIntent-slider").find(".tooltip-inner").text(val+"%");break;case"#slider6":$("#suggestionKG-slider").find(".tooltip-inner").text(val);break;case"#slider7":$("#matchProx-slider").find(".tooltip-inner").text(val+"%");break;case"#slider8":$("#path-slider").find(".tooltip-inner").text(val+"%");break;case"#slider9":$("#auto-correct-slider").find(".tooltip-inner").text(val+"%");break;case"#slider10":$("#minMatch-slider").find(".tooltip-inner").text(val);break;case"#nGramSlider":$("#nGram-slider").find(".tooltip-inner").text(val);break;case"#matchScore-slider":$("#minMatchScore-slider").find(".tooltip-inner").text(val);break;case"#dual-slider":$(".dual-slider").find(".tooltip-min").find(".tooltip-inner").text("<"+val[0]+"%"),$(".dual-slider").find(".tooltip-max").find(".tooltip-inner").text("<"+val[1]+"%");break;case"#slider3CM":$("#mlThreshold-sliderCM").find(".tooltip-inner").text(val);break;case"#slider4CM":$("#defIntent-sliderCM").find(".tooltip-inner").text(val+"%");break;case"#nGramSliderCM":$("#nGram-sliderCM").find(".tooltip-inner").text(val);break;case"#slider11":val||(val=0),$("#fmThreshold-slider").find(".tooltip-inner").text(val+"%")}}function isObjEmpty(obj){for(var key in obj)if(obj.hasOwnProperty(key))return!1;return!0}function updateRREngineData(){obj.confidenceConfig[3].isPreferDefinitiveMatch&&($scope.rankResolveEngine.isPreferDefinitiveMatch=obj.confidenceConfig[3].isPreferDefinitiveMatch),obj.confidenceConfig[3].intentRescoring&&($scope.rankResolveEngine.intentRescoring=obj.confidenceConfig[3].intentRescoring),obj.confidenceConfig[2].isFMThreshold&&($scope.intentDetect.isFMThreshold=obj.confidenceConfig[2].isFMThreshold),checkFMSettingCount(),checkRRSettingCount()}function updateChangeLogs(obj,_trainOntology){var _payload={updatedConfig:"useBotSynonyms",useBotSynonyms:$scope.kgCollection.useBotSynonyms,mode:"faq"};BTStreamsService.updateThresholds($workflowService.selectedStream()._id,_payload).then(function(response){response&&($scope.selectedStream.confidenceConfigs=response.data.confidenceConfigs,$workflowService.selectedStream($scope.selectedStream,response.data),_trainOntology&&$scope.knowledgeTask._id&&$scope.trainBotOntology(),_trainOntology=!1,NotificationService.notify(i18n.i18nString("settings_saved_sucessfully"),"success"))},function(err){err.data&&err.data&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}function getMLParams(){BTStreamsService.getMLSynonym($workflowService.selectedStream()._id).then(function(res){var type3List=[];res.data&&res.data.length&&(res.data.forEach(function(item,i){if(1===item.type&&($workflowService.mlPharams(item),$scope.payload=item,$scope.prepareStopWords(item),$scope.originalMlData=angular.copy(item),$scope.intentParams=item.intentParams,$timeout(function(){clearSliders("ML"),prepareSliders("ML")})),2===item.type&&item.advancedMLConfigurations&&($scope.multipIntentModels.defaultIntents=item,item&&item.advancedMLConfigurations&&item.advancedMLConfigurations.length?$scope.multipIntentModels.defaultIntents.networkType=item.advancedMLConfigurations[0].configurationValue:item.advancedMLConfigurations.length?$scope.multipIntentModels.defaultIntents.networkType=$scope.networkTypeList.defaultValue||"Standard":$scope.multipIntentModels.defaultIntents.networkType=$scope.networkTypeList.defaultValue),3===item.type&&item.advancedMLConfigurations){var dialogIntents=[];if(item.dialogIntents&&item.dialogIntents.forEach(function(intent){intent&&dialogIntents.push($scope.dialogRefIdObj(intent,item))}),item.advancedMLConfigurations&&item.advancedMLConfigurations.length){var findNetwork=item.advancedMLConfigurations.find(function(item){return"network"===item.configurationKeyName});findNetwork&&(item.network=findNetwork.configurationValue)}else item.advancedMLConfigurations.length?item.network=$scope.networkTypeList.defaultValue||"Standard":item.network=$scope.networkTypeList.defaultValue;item.dialogIntents=dialogIntents,type3List.push(item)}}),$scope.multipIntentModels.dialogIntents=type3List),$scope.intentParams&&$scope.intentParams.useSynonyms&&($scope.filterToggle="disabled"),$scope.intentParams&&!$scope.intentParams.features&&($scope.intentParams.features="n_gram"),checkMultipIntentModel()},function(err){$scope.intentParams.useSynonyms=!1})}function clearSliders(type){"FM"==type&&(deRegisterSlider("#slider10"),deRegisterSlider("#slider11")),"KC"==type&&(deRegisterSlider("#slider6"),deRegisterSlider("#slider7"),deRegisterSlider("#slider8"),deRegisterSlider("#slider9"),deRegisterSlider("#dual-slider")),"ML"==type&&(deRegisterSlider("#slider3"),deRegisterSlider("#slider4"),deRegisterSlider("#nGramSlider"),deRegisterSlider("#skipGramSeq"),deRegisterSlider("#skipGramMax")),"RR"==type&&deRegisterSlider("#slider2"),"advConfig"===type&&deRegisterCustomSliders(),"CM"===type&&(deRegisterSlider("#slider3CM"),deRegisterSlider("#slider4CM"),deRegisterSlider("#nGramSliderCM"),deRegisterSlider("#skipGramSeqCM"),deRegisterSlider("#skipGramMaxCM"))}function prepareSliders(type){setTimeout(function(){if("FM"==type&&(fmSlider=registerSlider("#slider11",{tooltip:"always",tooltip_position:"bottom"}),fmSlider.bootstrapSlider("setValue",obj.confidenceConfig[2].fmThreshold),formatTooltip("#slider11",obj.confidenceConfig[2].fmThreshold)),"KC"==type){s6=registerSlider("#slider6",{tooltip:"always",tooltip_position:"bottom"}),s7=registerSlider("#slider7",{tooltip:"always",tooltip_position:"bottom"}),s8=registerSlider("#slider8",{tooltip:"always",tooltip_position:"bottom"}),s9=registerSlider("#slider9",{tooltip:"always",tooltip_position:"bottom"}),dualS=registerSlider("#dual-slider",{tooltip:"always",tooltip_split:!0,tooltip_position:"bottom"}),s6.bootstrapSlider("setValue",obj.confidenceConfig[1].suggestionsCount),s7.bootstrapSlider("setValue",obj.confidenceConfig[1].taskMatchTolerance),s8.bootstrapSlider("setValue",obj.confidenceConfig[1].pathCoverage),s9.bootstrapSlider("setValue",obj.confidenceConfig[1].autoCorrPercentage),formatTooltip("#slider6",obj.confidenceConfig[1].suggestionsCount),formatTooltip("#slider7",obj.confidenceConfig[1].taskMatchTolerance),formatTooltip("#slider8",obj.confidenceConfig[1].pathCoverage),formatTooltip("#slider9",obj.confidenceConfig[1].autoCorrPercentage);var array=[];array.push(Number(obj.confidenceConfig[1].minThreshold)),array.push(Number(obj.confidenceConfig[1].maxThreshold)),array.push(Number(obj.confidenceConfig[1].exactMatchThreshold)),dualS.bootstrapSlider("setValue",array);var slider=$("#knowledgeCollectionThresholds").find("#triple-slider")[0];noUiSlider.create(slider,{start:[array[0],array[1],array[2]],connect:[!1,!0,!0,!0],tooltips:[wNumb({decimals:0,suffix:"%"}),wNumb({decimals:0,suffix:"%"}),wNumb({decimals:0,suffix:"%"})],range:{min:[0],max:[100]}});for(var connect=slider.querySelectorAll(".noUi-connect"),classes=["c-1-color","c-2-color","c-3-color","c-4-color"],i=0;i<connect.length;i++)connect[i].classList.add(classes[i]);formatTooltip("#dual-slider",array),$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs[1].longResponses&&($scope.faqLong=$scope.selectedStream.confidenceConfigs[1].longResponses,obj.confidenceConfig[1].longResponses=$scope.selectedStream.confidenceConfigs[1].longResponses),$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs[1].searchInAnswer&&($scope.faqSearch=$scope.selectedStream.confidenceConfigs[1].searchInAnswer,obj.confidenceConfig[1].searchInAnswer=$scope.selectedStream.confidenceConfigs[1].searchInAnswer)}"ML"==type&&(s3=registerSlider("#slider3",{tooltip:"always",tooltip_position:"bottom"}),s4=registerSlider("#slider4",{tooltip:"always",tooltip_position:"bottom"}),nGram=registerSlider("#nGramSlider",{tooltip:"always",tooltip_position:"bottom"}),skipGramSeq=registerSlider("#skipGramSeq",{tooltip:"always",tooltip_position:"bottom"}),skipGramMax=registerSlider("#skipGramMax",{tooltip:"always",tooltip_position:"bottom"}),s3&&s4&&obj&&obj.confidenceConfig&&obj.confidenceConfig[0]&&(s3.bootstrapSlider("setValue",obj.confidenceConfig[0].minThreshold),s4.bootstrapSlider("setValue",obj.confidenceConfig[0].exactMatchThreshold)),$scope.intentParams&&$scope.intentParams.ngram&&$scope.intentParams.ngram[1]&&nGram&&(nGram.bootstrapSlider("setValue",$scope.intentParams.ngram[1]),formatTooltip("#nGramSlider",$scope.intentParams.ngram[1]),formatTooltip("#skipGramMax",$scope.intentParams.ngram[1]),formatTooltip("#skipGramSeq",$scope.intentParams.ngram[1])),$scope.intentParams&&$scope.intentParams.skip_gram&&skipGramSeq&&(skipGramSeq.bootstrapSlider("setValue",$scope.intentParams.skip_gram&&$scope.intentParams.skip_gram.seqLength?$scope.intentParams.skip_gram.seqLength:2),skipGramMax.bootstrapSlider("setValue",$scope.intentParams.skip_gram&&$scope.intentParams.skip_gram.maxSkipDistance?$scope.intentParams.skip_gram.maxSkipDistance:1)),formatTooltip("#slider3",obj.confidenceConfig[0].minThreshold),formatTooltip("#slider4",obj.confidenceConfig[0].exactMatchThreshold)),"RR"==type&&(s2=registerSlider("#slider2",{tooltip:"always",tooltip_position:"bottom"}),s2.bootstrapSlider("setValue",obj.confidenceConfig[3].taskMatchTolerance),formatTooltip("#slider2",obj.confidenceConfig[3].taskMatchTolerance),s11=registerSlider("#matchScore-slider",{tooltip:"always",tooltip_position:"bottom"}),s11.bootstrapSlider("setValue",obj.confidenceConfig[3].minMatchVal),formatTooltip("#matchScore-slider",obj.confidenceConfig[3].minMatchVal)),"CM"==type&&(s3=registerSlider("#slider3CM",{tooltip:"always",tooltip_position:"bottom"}),s4=registerSlider("#slider4CM",{tooltip:"always",tooltip_position:"bottom"}),nGram=registerSlider("#nGramSliderCM",{tooltip:"always",tooltip_position:"bottom"}),skipGramSeq=registerSlider("#skipGramSeqCM",{tooltip:"always",tooltip_position:"bottom"}),skipGramMax=registerSlider("#skipGramMaxCM",{tooltip:"always",tooltip_position:"bottom"}),formatTooltip("#slider3CM",obj.confidenceConfig[0].minThreshold),formatTooltip("#slider4CM",obj.confidenceConfig[0].exactMatchThreshold),formatTooltip("#nGramSliderCM",$scope.multipIntentModels.intentParams.ngram[1]),formatTooltip("#skipGramMaxCM",$scope.multipIntentModels.intentParams.ngram[1]),formatTooltip("#skipGramSeqCM",$scope.multipIntentModels.intentParams.ngram[1]),nGram.bootstrapSlider("setValue",$scope.multipIntentModels.intentParams.ngram[1]),skipGramSeq.bootstrapSlider("setValue",$scope.multipIntentModels.intentParams.skip_gram&&$scope.multipIntentModels.intentParams.skip_gram.seqLength?$scope.multipIntentModels.intentParams.skip_gram.seqLength:2),skipGramMax.bootstrapSlider("setValue",$scope.multipIntentModels.intentParams.skip_gram&&$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance?$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance:1),$scope.multipIntentModels&&$scope.multipIntentModels.selectedModel&&(s3.bootstrapSlider("setValue",$scope.multipIntentModels.selectedModel.minThreshold),s4.bootstrapSlider("setValue",$scope.multipIntentModels.selectedModel.exactMatchThreshold)))},100)}function onSliderChangedProxy(mode,val){$(".save-tip").show().text("Saving...");var currentEle=$(mode);switch(mode){case"#slider2":obj.confidenceConfig[3].taskMatchTolerance=val;break;case"#slider3":obj.confidenceConfig[0].minThreshold=val;break;case"#slider4":obj.confidenceConfig[0].exactMatchThreshold=val;break;case"#slider6":obj.confidenceConfig[1].suggestionsCount=val;break;case"#slider7":obj.confidenceConfig[1].taskMatchTolerance=val;break;case"#slider8":obj.confidenceConfig[1].pathCoverage=val;break;case"#slider9":obj.confidenceConfig[1].autoCorrPercentage=val;break;case"#slider10":obj.confidenceConfig[2].minMatchVal=val;break;case"#nGramSlider":$scope.intentParams.ngram[1]=val||1,delete $scope.intentParams.skip_gram;break;case"#skipGramSeq":$scope.intentParams.skip_gram=$scope.intentParams.skip_gram?$scope.intentParams.skip_gram:{},$scope.intentParams.skip_gram.seqLength=val,$scope.intentParams.skip_gram.maxSkipDistance=$scope.intentParams.skip_gram.maxSkipDistance?$scope.intentParams.skip_gram.maxSkipDistance:1,delete $scope.intentParams.ngram,delete $scope.intentParams.maxngram,delete $scope.intentParams.minngram;break;case"#skipGramMax":$scope.intentParams.skip_gram=$scope.intentParams.skip_gram?$scope.intentParams.skip_gram:{},$scope.intentParams.skip_gram.maxSkipDistance=val,$scope.intentParams.skip_gram.seqLength=$scope.intentParams.skip_gram.seqLength?$scope.intentParams.skip_gram.seqLength:2,delete $scope.intentParams.ngram,delete $scope.intentParams.maxngram,delete $scope.intentParams.minngram;break;case"#matchScore-slider":obj.confidenceConfig[3].minMatchVal=val;break;case"#dual-slider":obj.confidenceConfig[1].minThreshold=val[0],obj.confidenceConfig[1].maxThreshold=val[1],obj.confidenceConfig[1].exactMatchThreshold=val[2];break;case"#slider3CM":obj.confidenceConfig[0].minThreshold=val;break;case"#slider4CM":obj.confidenceConfig[0].exactMatchThreshold=val;break;case"#nGramSliderCM":$scope.multipIntentModels.intentParams.ngram&&$scope.multipIntentModels.intentParams.ngram.length||($scope.multipIntentModels.intentParams.ngram=[1,4]),$scope.multipIntentModels.intentParams.ngram[1]=val||1,delete $scope.multipIntentModels.intentParams.skip_gram;break;case"#skipGramSeqCM":$scope.multipIntentModels.intentParams.skip_gram=$scope.multipIntentModels.intentParams.skip_gram?$scope.multipIntentModels.intentParams.skip_gram:{},$scope.multipIntentModels.intentParams.skip_gram.seqLength=val,$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance=$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance?$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance:1,delete $scope.multipIntentModels.intentParams.ngram,delete $scope.multipIntentModels.intentParams.maxngram,delete $scope.multipIntentModels.intentParams.minngram;break;case"#skipGramMaxCM":$scope.multipIntentModels.intentParams.skip_gram=$scope.multipIntentModels.intentParams.skip_gram?$scope.multipIntentModels.intentParams.skip_gram:{},$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance=val,$scope.multipIntentModels.intentParams.skip_gram.seqLength=$scope.multipIntentModels.intentParams.skip_gram.seqLength?$scope.multipIntentModels.intentParams.skip_gram.seqLength:2,delete $scope.multipIntentModels.intentParams.ngram,delete $scope.multipIntentModels.intentParams.maxngram,delete $scope.multipIntentModels.intentParams.minngram;break;case"#slider11":obj.confidenceConfig[2].fmThreshold=val}if("#nGramSlider"===mode||"#skipGramSeq"===mode||"#skipGramMax"===mode)$scope.payload.intentParams=$scope.intentParams,saveMLSynonymSetting(null,!1,null,null,$scope.intentParams.features);else if(currentEle.hasClass("custom-configuration"))$scope.proceedEditConfig(currentEle.scope().config,"",val);else{if($scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType)return;formatTooltip(mode,val),doServiceCalls(obj)}}function fetchDefaultParams(serviceCall){var contextUrl=window.appConfig.CONTEXT_PATH;$http.get(contextUrl+restoreConfigurationPath[$scope.currLang.langVal]).then(function(response){$scope.rankResolveEngine.rankingParameters=response.data,$scope.defaultRankingParameters=angular.copy($scope.rankResolveEngine.rankingParameters),obj.confidenceConfig[3].rankingParameters=response.data,serviceCall&&doServiceCalls(obj,!1)})}function checkNetworkType(){var index;$scope.savedConfigurations&&$scope.savedConfigurations.length&&(index=$scope.savedConfigurations.findIndex(function(item){return"network"===item.configurationKeyName}),-1!==index&&$scope.savedConfigurations.splice(index,1),$scope.intentParams&&"V3"!==$scope.intentParams.type&&"V4"!==$scope.intentParams.type&&"V5"!==$scope.intentParams.type&&(index=$scope.savedConfigurations.findIndex(function(item){return"Multiple_Intent_Models"===item.configurationKeyName}),-1!==index&&$scope.savedConfigurations.splice(index,1))),originalCopy&&originalCopy.length&&(index=originalCopy.findIndex(function(item){return"network"===item.configurationKeyName}),-1!==index&&originalCopy.splice(index,1),$scope.intentParams&&"V3"!==$scope.intentParams.type&&"V4"!==$scope.intentParams.type&&"V5"!==$scope.intentParams.type&&(index=$scope.originalCopy.findIndex(function(item){return"Multiple_Intent_Models"===item.configurationKeyName}),-1!==index&&$scope.originalCopy.splice(index,1))),$scope.uiConfiguration&&$scope.uiConfiguration.length&&(index=$scope.uiConfiguration.findIndex(function(item){return"network"===item.configurationKeyName}),-1!==index&&$scope.uiConfiguration.splice(index,1),$scope.intentParams&&"V3"!==$scope.intentParams.type&&"V4"!==$scope.intentParams.type&&"V5"!==$scope.intentParams.type&&(index=$scope.uiConfiguration.findIndex(function(item){return"Multiple_Intent_Models"===item.configurationKeyName}),-1!==index&&$scope.uiConfiguration.splice(index,1))),checkMultipIntentModel()}function resetDefaultIntentParams(){$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType?($scope.multipIntentModels.intentParams.minngram=1,$scope.multipIntentModels.intentParams.maxngram=4,$scope.multipIntentModels.intentParams.ngram=[1,1],$scope.multipIntentModels.intentParams.useSynonyms=!1,$scope.multipIntentModels.intentParams.f_negation=!1,$scope.multipIntentModels.intentParams.useStopwords=!1,$scope.multipIntentModels.intentParams.usePlaceholders=!1,$scope.multipIntentModels.intentParams.features="n_gram",$scope.multipIntentModels.intentParams.skip_gram={
seqLength:2,maxSkipDistance:1},$scope.resetDefaultVal(),$scope.resetNgram()):($scope.intentParams.minngram=1,$scope.intentParams.maxngram=4,$scope.intentParams.ngram=[1,1],$scope.intentParams.useSynonyms=!1,$scope.intentParams.f_negation=!1,$scope.intentParams.useStopwords=!1,$scope.intentParams.usePlaceholders=!1,$scope.intentParams.features="n_gram",$scope.intentParams.skip_gram={seqLength:2,maxSkipDistance:1})}function checkFMSettingCount(){$scope.intentDetect.isFMThreshold?$scope.fmSettingsCount=2:$scope.fmSettingsCount=2,"en"!==$scope.currLang.langVal&&"de"!==$scope.currLang.langVal&&"es"!==$scope.currLang.langVal&&"fr"!==$scope.currLang.langVal&&($scope.fmSettingsCount=1)}function checkMLSettingCount(config){return $scope.multipIntentModels.configurationValue===!0?void($scope.mlSettingsCount=8):"SGD_V2"===$scope.intentParams.type?void($scope.mlSettingsCount=2):void("Standard"===config?$scope.mlSettingsCount=8:"MLP-BOW"===config?$scope.mlSettingsCount=8:"MLP-WordEmbeddings"===config?$scope.mlSettingsCount=7:"LSTM"===config?$scope.mlSettingsCount=7:"CNN"===config?$scope.mlSettingsCount=7:"Transformer"===config?$scope.mlSettingsCount=4:$scope.mlSettingsCount=8)}function checkRRSettingCount(){$scope.rankResolveEngine.intentRescoring?$scope.RRSettingsCount=2:$scope.RRSettingsCount=2,("de"===$scope.currLang.langVal||"fr"===$scope.currLang.langVal)&&($scope.RRSettingsCount=$scope.RRSettingsCount+1,$scope.rankResolveEngine.useDependencyParser&&($scope.RRSettingsCount=$scope.RRSettingsCount+2))}function editConfigurations(configuration,previousConfiguration,value,model){var _payload={};previousConfiguration||(_payload={configurationValue:configuration.value},startSaving("ml"===model?".ml-savingStatus":".savingStatus")),BTStreamsService.editConfigurations($scope.selectedStream._id,configuration._id,_payload).then(function(response){response&&response.data&&($scope.closeEditConfigCustom(),configuration.requiresTraining&&"ML"===configuration.nlpEngine&&"kfold"!==configuration.configurationKeyName&&($scope.trainShow=!0),configuration.requiresTraining&&"KG"===configuration.nlpEngine&&$scope.trainBotOntology(),NotificationService.notify(i18n.i18nString("settings_saved"),"success"),finishSaving("ml"===model?".ml-savingStatus":".savingStatus"),response.data&&"Multiple_Intent_Models"===response.data.configurationKeyName&&getMLParams(),autoTrainStatus())},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error"),stopSaving("ml"===model?".ml-savingStatus":".savingStatus")})}function doServiceCalls(obj,_trainOntology){"en"!==$scope.currLang.langVal&&"de"!==$scope.currLang.langVal&&"es"!==$scope.currLang.langVal&&"fr"!==$scope.currLang.langVal&&(delete obj.confidenceConfig[2].fmThreshold,delete obj.confidenceConfig[2].isFMThreshold),BTStreamsService.updateThresholds($workflowService.selectedStream()._id,obj).then(function(res){$(".save-tip").addClass("fa fa-check").show().text("saved..."),$timeout(function(){$(".save-tip").removeClass("fa fa-check").hide().text("saving...")},5e3),$scope.selectedStream.confidenceConfigs=res.data.confidenceConfigs,$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs[1].longResponses&&($scope.faqLong=$scope.selectedStream.confidenceConfigs[1].longResponses),$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs[1].searchInAnswer&&($scope.faqSearch=$scope.selectedStream.confidenceConfigs[1].searchInAnswer),_trainOntology&&$scope.knowledgeTask._id&&$scope.trainBotOntology(),_trainOntology=!1,$workflowService.selectedStream($scope.selectedStream,res.data),$("#noty_center_layout_container").empty(),NotificationService.notify(i18n.i18nString("settings_saved_sucessfully"),"success")},function(err){err.data&&err.data&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_went_wrong_err_noty"),"error"),$(".save-tip").removeClass("fa fa-check").hide().text("saving...")})}function saveMLSynonymSetting(type,reset,resetkey,isSynProceed,features){$element.find("#warningModal").removeClass("show").addClass("fade"),resetkey=resetkey||"",BTStreamsService.updateMLSynonym($workflowService.selectedStream()._id,""+reset,resetkey,$scope.payload).then(function(res){$workflowService.mlPharams(res.data),type&&($scope.resetDefaultVal("#slider3"),$scope.resetDefaultVal("#slider4")),"V3"==type||"n_gram"===features?($scope.intentParams=res.data.intentParams,nGram.bootstrapSlider("setValue",$scope.intentParams.ngram[1]),formatTooltip("#nGramSlider",$scope.intentParams.ngram[1]),$scope.payload.nerParams.type=res.data.nerParams.type):"skip_gram"===features&&($scope.intentParams=res.data.intentParams,skipGramSeq.bootstrapSlider("setValue",$scope.intentParams.skip_gram.seqLength),skipGramMax.bootstrapSlider("setValue",$scope.intentParams.skip_gram.maxSkipDistance),formatTooltip("#skipGramSeq",$scope.intentParams.skip_gram.seqLength),formatTooltip("#skipGramMax",$scope.intentParams.skip_gram.maxSkipDistance),$scope.payload.nerParams.type=res.data.nerParams.type),isSynProceed&&$scope.trainBot(),$scope.prepareStopWords(res.data),$scope.lodingStopWords=!1,$scope.searchWord.search="",$scope.originalMlData=angular.copy(res.data),$(".save-tip").addClass("fa fa-check").show().text("saved..."),$timeout(function(){$(".save-tip").removeClass("fa fa-check").hide().text("saving...")},5e3),$("#noty_center_layout_container").empty(),$scope.trainShow=!0,NotificationService.notify(i18n.i18nString("settings_saved_sucessfully"),"success")},function(err){$scope.lodingStopWords=!1,$scope.payload=angular.copy($scope.originalMlData),$scope.intentParams=angular.copy($scope.originalMlData.intentParams),err.data&&err.data&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_went_wrong_err_noty"),"error"),$(".save-tip").removeClass("fa fa-check").hide().text("saving...")})}function autoTrainStatus(){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithMlparams")&&!res.data.isMlInSyncWithMlparams?$scope.trainShow=!0:$scope.trainShow=!1,"Finished"===res.data.trainingStatus?$scope.trainStatus.saving=!1:$scope.enableSynonyms?$scope.trainStatus.saving=!0:$scope.trainStatus.saving=!0},function(err){var _msg=i18n.i18nString("err_on_fetching_msg");NotificationService.notify(_msg,"error")})}function loadCustomConfigurations(){$q.all([BTStreamsService.getAdvancedConfigurations($scope.selectedStream._id),BTStreamsService.getSavedConfiguration($scope.selectedStream._id)]).then(function(response){if(response[0]&&response[0].data){serverConfigOb=response[0].data;var _keys=Object.keys(response[0].data);-1!==_keys.indexOf("network")&&_keys.splice(_keys.indexOf("network"),1),angular.forEach(_keys,function(key,index){$scope.configurationList.push(response[0].data[key])}),$scope.uiConfiguration=_.filter($scope.configurationList,function(configuration){return configuration.language&&-1!==configuration.language.indexOf($workflowService.currentLanguage())||"ALL"===configuration.language?(configuration["class"]=mapClass[configuration.nlpEngine],configuration.value=configuration.defaultValue,configuration):void 0}),$workflowService.configurationList($scope.uiConfiguration),serverConfigOb&&serverConfigOb.network&&"network"===serverConfigOb.network.configurationKeyName&&($scope.networkTypeList=serverConfigOb.network)}if(response[1]&&response[1].data&&response[1].data.length){$scope.showEmptyConfig=!1,prepareSavedConfigurations(response[1].data);var index=response[1].data.findIndex(function(item){return"network"===item.configurationKeyName});-1!==index&&response[1].data.splice(index,1),$scope.totalConfigCount=response[1].data.length}response[1].data.length||($scope.showEmptyConfig=!0,$scope.savedConfigurations=[],$scope.totalConfigCount=0)},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}function getDialogs(){var deferred=$q.defer();return BTFlowtaskService.getFlowtaks($workflowService.selectedStream()._id).then(function(res){deferred.resolve(res.data)},function(err){deferred.reject(err)}),deferred.promise}function updateCustomModelConfigs(cell,type){if($scope.savedConfigurationsCM=[],"new"===type?($scope.multipIntentModels.formType="new",$scope.multipIntentModels.customConfigText=i18n.i18nString("new_custom_config_group"),$scope.multipIntentModels.intentParams={f_negation:!1,features:"n_gram",maxngram:4,minngram:1,ngram:[1,4],skip_gram:{seqLength:2,maxSkipDistance:1},type:"V3",usePlaceholders:!1,useStopwords:!1,useSynonyms:!1,useTestPlaceholders:!1},$scope.networkTypeList.value="Standard",obj&&obj.confidenceConfig[0]&&(obj.confidenceConfig[0].exactMatchThreshold=95,obj.confidenceConfig[0].minThreshold=.3,$scope.multipIntentModels.selectedModel.minThreshold=.3,$scope.multipIntentModels.selectedModel.exactMatchThreshold=95),$scope.multipIntentModels.nerParams.type="corenlp"):"default"===type?($scope.multipIntentModels.formType="default",$scope.multipIntentModels.customConfigText=i18n.i18nString("bot_level_intent_model_config_label")):"clone"===type?($scope.multipIntentModels.formType="clone",$scope.multipIntentModels.customConfigText=i18n.i18nString("clone_custom_config_group"),$scope.multipIntentModels.name="",$scope.multipIntentModels.dialogIntentsList=[]):"update"===type?($scope.multipIntentModels.formType="update",$scope.multipIntentModels.customConfigText=i18n.i18nString("update_custom_config_group"),$scope.multipIntentModels.name=cell.name,$scope.multipIntentModels.dialogIntentsList=cell.dialogIntents):($scope.multipIntentModels.formType="default",formReset()),"new"!==type&&($scope.multipIntentModels.intentParams&&($scope.multipIntentModels.intentParams.ngram&&0!==$scope.multipIntentModels.intentParams.ngram.length||($scope.multipIntentModels.intentParams.ngram=[1,4])),$scope.multipIntentModels.intentParams&&$scope.multipIntentModels.intentParams.useSynonyms&&($scope.filterToggle="disabled",$scope.multipIntentModels.intentParams.useSynonyms=!0),$scope.multipIntentModels.intentParams&&!$scope.multipIntentModels.intentParams.features&&($scope.multipIntentModels.intentParams.features="n_gram"),$scope.multipIntentModels.intentParams&&!$scope.multipIntentModels.intentParams.useStopwords&&($scope.multipIntentModels.intentParams.useStopwords=!0),$scope.multipIntentModels.intentParams&&!$scope.multipIntentModels.intentParams.usePlaceholders&&($scope.multipIntentModels.intentParams.usePlaceholders=!0),$scope.multipIntentModels.selectedModel.nerParams&&$scope.multipIntentModels.selectedModel.nerParams.type?$scope.multipIntentModels.nerParams.type=$scope.multipIntentModels.selectedModel.nerParams.type:$scope.multipIntentModels.nerParams.type="corenlp",$scope.prepareStopWords(cell)),cell&&cell.advancedMLConfigurations){var findIndex=cell.advancedMLConfigurations.findIndex(function(item,index){return"network"===item.configurationKeyName});-1!==findIndex?($scope.networkTypeList.value=cell.advancedMLConfigurations[findIndex].configurationValue,cell.advancedMLConfigurations&&cell.advancedMLConfigurations[findIndex]._id&&($scope.networkTypeList._id=cell.advancedMLConfigurations[findIndex]._id),$scope.multipIntentModels.selectedModel.advancedMLConfigurations.splice(findIndex,1)):$scope.networkTypeList.value="Standard"}$scope.multipIntentModels.selectedModel&&$scope.multipIntentModels.selectedModel.advancedMLConfigurations?prepareSavedConfigurations($scope.multipIntentModels.selectedModel.advancedMLConfigurations):$scope.savedConfigurationsCM=[],$scope.savedConfigurationsCM.length?$scope.showEmptyConfigCM=!1:$scope.showEmptyConfigCM=!0}function formReset(){$scope.multipIntentModels.name="",$scope.multipIntentModels.dialogIntentsList=[],$scope.multipIntentModels.formType="",$scope.savedConfigurationsCM=[],$scope.multipIntentModels.selectedModel={},$scope.invalidPattern=!1,$scope.invalidCustomValue=!1}function checkMultipIntentModel(){if($scope.savedConfigurations&&$scope.savedConfigurations.length){var findObj=$scope.savedConfigurations.find(function(item){return"Multiple_Intent_Models"===item.configurationKeyName});findObj&&findObj.value?$scope.multipIntentModels.configurationValue=!0:$scope.multipIntentModels.configurationValue=!1}}function checkMultipleIntentToggle(){if($scope.savedConfigurations&&$scope.savedConfigurations.length){var findIndex=$scope.savedConfigurations.findIndex(function(item){return $scope.loadConfiguration.configurationKeyName===item.configurationKeyName});-1!==findIndex&&($scope.savedConfigurations[findIndex].value?$scope.savedConfigurations[findIndex].value=!1:$scope.savedConfigurations[findIndex].value=!0)}}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.closeArrow=env_conf["context-url"]+"/assets/landingImages/closeCross.png";var _trainOntology=!1,obj={confidenceConfig:[{mode:"ml",isActive:!0,threshold:0,minThreshold:0,maxThreshold:0},{mode:"faq",isActive:!0,threshold:0,minThreshold:60,maxThreshold:80},{mode:"cs",isActive:!0,threshold:0,minThreshold:0,maxThreshold:0},{mode:"rr",isActive:!0,threshold:0,minThreshold:0,maxThreshold:0}]},restoreConfigurationPath={it:"/resources/dependency_sample_it.json",fr:"/resources/dependency_sample.json",de:"/resources/dependency_sample.json",ru:"/resources/dependency_sample_ru.json"},searchInAnsLang=["en","de","es","fr","it","pt","id","nl","fi","pl","sv","ca","te","mr","ta","kk","nb"],minMatchVal=.5;$scope.payload={},$scope.payload1={},$scope.searchWord={},$scope.faqLong={},$scope.faqSearch={},$scope.autoCorrectLangs=["en","kk","nl","ru","ja","fr"],$scope.selectedStream=$workflowService.selectedStream(),$scope.knowledgeTask=$workflowService.knowledgeTasksByState()||[],$scope.selectedLanguage=$workflowService.selectedLanguage(),$scope.selectedStream.multiLingualConfigurations&&$scope.selectedLanguage.value&&$scope.selectedStream.multiLingualConfigurations[$scope.selectedLanguage.value]?$scope.nluLanguage=$scope.selectedStream.multiLingualConfigurations[$scope.selectedLanguage.value].nluLanguage||"en":$scope.nluLanguage=$scope.selectedStream.defaultLanguage,$scope.trashIcon=env_conf["context-url"]+"/assets/icons-new/delete-trash/trash-red-delete.svg",$rootScope.statusInterval=$rootScope.statusInterval||{},$rootScope.ontologyTrainInProgress=$rootScope.ontologyTrainInProgress||{},$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]||!1;var _userInfo=$applicationService.userInfo();$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs.length&&$scope.selectedStream.confidenceConfigs[1]&&$scope.selectedStream.confidenceConfigs[1].longResponses&&Object.keys($scope.selectedStream.confidenceConfigs[1].longResponses).length>0?$scope.faqLong=angular.copy($scope.selectedStream.confidenceConfigs[1].longResponses):$scope.faqLong.readMore=!1,$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs.length&&$scope.selectedStream.confidenceConfigs[1]&&$scope.selectedStream.confidenceConfigs[1].searchInAnswer&&Object.keys($scope.selectedStream.confidenceConfigs[1].searchInAnswer).length>0?$scope.faqSearch=angular.copy($scope.selectedStream.confidenceConfigs[1].searchInAnswer):$scope.faqSearch.enabled=!1,$scope.helpIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/helpIcon.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.searchIcon=env_conf["context-url"]+"/assets/icons/search_gray.svg",$scope.tagClose=env_conf["context-url"]+"/assets/icons/close.svg",$scope.searchWord.search="",$scope.constants=$rootScope._constants_,$scope.intentParams={useSynonyms:!1},$scope.currLang={langVal:$workflowService.currentLanguage()},$scope.supportedLanguages=$workflowService.supportedLanguages(),$scope.assetsBase=env_conf["assets-url"],$scope.detectMultiIntent=!1,$scope.filterToggle="enabled",$scope.intentToggle="enabled",$scope.negativeToggle="enabled",$scope.rightClass="right400",$scope.refreshIcon=env_conf["context-url"]+"/assets/icons/refreshIcon.svg",$scope.closeCross=env_conf["context-url"]+"/assets/icons/closeCross.png",$scope.trainShow=!1,$scope.showKgTrainingDiv=!1,$scope.showTrainSavingDiv=!1,$scope.rightClass="right700",$scope.bulbicon=env_conf["context-url"]+"/assets/images/24x29-bulbicon.png",$scope.chevronRight=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-right-gray.svg";var s2,s3,s4,s6,s7,s8,s9,s10,s11,fmSlider,dualS,nGram,skipGramSeq,skipGramMax,customSlider;$scope.mlthreshold={},$scope.contextObj={qualifyContextualPaths:!1},$scope.dependencyDesc=i18n.i18nString("dependencyDesc"),$scope.editConfiguration=i18n.i18nString("edit_configuration"),$scope.viewConfiguration=i18n.i18nString("view_configuration"),$scope.settings_label=i18n.i18nString("settings_label"),$scope.setting_label=i18n.i18nString("setting_label"),$scope.reloadIcon=env_conf["context-url"]+"/assets/icons-new/reload/reloadIcon.svg",$scope.checkGreenIcon=env_conf["context-url"]+"/assets/icons-new/check-mark/check-green.svg",$scope.closeDarkIcon=env_conf["context-url"]+"/assets/icons-new/close/close-dark.svg",$scope.refreshStatus="",$scope.refreshStatus2="",$scope.intentParams={features:"n_gram"},$scope.search={},$scope.dialogSearch={},$scope.multipIntentModels={name:"",customConfigText:"",configurationValue:!1,dialogIntentsList:[],dialogIntents:[],defaultIntents:[],intentParams:[],intentData:{},formType:"",selectedModel:{},nerParams:{type:"corenlp"}},$scope.getDialogIntents=[],$scope.getAllDialogIntents=[];var mapClass={FM:"tags",ML:"tags warning-tag",KG:"tags green-tag",RR:"tags warning-tag-lite",SmallTalk:"tags blue-tag"},engineList=["ml","kg","fm","rr","st"],mapEngines={ml:"ML",kg:"KG",fm:"FM",rr:"RR",st:"SmallTalk",un:"Universal"},originalCopy=[];$scope.configurationList=[];var serverConfigOb={};if($scope.savedConfigurations=$workflowService.savedConfigurationsList()||[],$scope.uiConfiguration=$workflowService.configurationList()||[],$scope.savedConfigurations&&$scope.savedConfigurations.length&&(checkNetworkType(),$scope.totalConfigCount=$scope.savedConfigurations.length),$scope.options={mode:"view"===$scope.displayMode?"view":"code",ace:window.ace},$scope.configCB={},$scope.trainStatus={success:!1,failed:!1,saving:!1},$scope.kgTrainStatus={success:!1,failed:!1,saving:!1},$scope.hideRestore=!1,$scope.networkTypeList=[],$scope.fmSettingsCount=0,$scope.mlSettingsCount=0,$scope.RRSettingsCount=0,$scope.savedConfigurationsCM=[],$scope.showEmptyConfigCM=!1,$scope.FMPopover="Intent detection by FM engine using Patterns will continue to work even when this setting is disabled.",$scope.loadConfiguration={},$scope.preferDefinitiveDesc=i18n.i18nString("prefer_definitive_matches_desc"),$scope.preferDefinitiveDescLimit=100,$scope.FMPopover=i18n.i18nString("intent_detection_by_fm_engine"),$scope.two_settings=i18n.i18nString("ml_threshold_2_settings"),$scope.seven_settings=i18n.i18nString("ml_threshold_7_settings"),$scope.one_setting=i18n.i18nString("ml_threshold_1_settings"),$scope.selectedStream&&$scope.selectedStream.confidenceConfigs){var confidenceFaq=$scope.selectedStream.confidenceConfigs.filter(function(val){return"faq"===val.mode})[0],rrValues=$scope.selectedStream.confidenceConfigs.filter(function(val){return"rr"===val.mode})[0];confidenceFaq?$scope.kgCollection={autoCorrect:confidenceFaq.autoSpellCorrectEnabled,useBotSynonyms:confidenceFaq.useBotSynonyms,enPatternLemma:confidenceFaq.enPatternLemma}:$scope.kgCollection={autoCorrect:!1,useBotSynonyms:!1,enPatternLemma:!1},rrValues?$scope.rankResolveEngine={useDependencyParser:rrValues.useDependencyParser}:$scope.rankResolveEngine={useDependencyParser:!1}}else $scope.kgCollection={autoCorrect:!1,useBotSynonyms:!1,useKgSyns:!1,enPatternLemma:!1},$scope.rankResolveEngine={useDependencyParser:!1};$scope.knowledgeTasksList=function(){var requestData={streamId:$workflowService.selectedStream()._id};BTStreamsService.getAllKtsList(_userInfo.userId,requestData).then(function(res){var identified_task={};$scope.knowledgeTasks=res.data,identified_task=_.find($scope.knowledgeTasks,{state:"configured"}),isObjEmpty(identified_task)&&(identified_task=_.find($scope.knowledgeTasks,{state:"awaitingApproval"})),isObjEmpty(identified_task)||($scope.knowledgeTask=identified_task)})},$scope.prepareStopWords=function(dataObj){$scope.mlthreshold.stopWords=[],dataObj&&dataObj.intentData&&dataObj.intentData.stopwords&&($scope.mlthreshold.stopWords=dataObj.intentData.stopwords.replace(/\s\s+/g," ").split(" "),$scope.mlthreshold.stopWords=$scope.constants.getAlphabeticallySortedArray($scope.mlthreshold.stopWords))},$scope.updateFaqSearch=function(_trainOntology){var faqSearchObj={};$timeout(function(){$scope.faqSearch&&void 0!==$scope.faqSearch.enabled&&(faqSearchObj.enabled=$scope.faqSearch.enabled),$scope.faqSearch&&$scope.faqSearch.notifyUser&&(faqSearchObj.notifyUser=$scope.faqSearch.notifyUser),$scope.faqSearch&&$scope.faqSearch.responseType&&(faqSearchObj.responseType=$scope.faqSearch.responseType),$scope.faqSearch&&$scope.faqSearch.enabled&&"relevantWithReadMore"===$scope.faqSearch.responseType&&void 0!==$scope.faqSearch.useCustomReadMoreURL&&(faqSearchObj.useCustomReadMoreURL=$scope.faqSearch.useCustomReadMoreURL),$scope.faqSearch&&$scope.faqSearch.enabled&&$scope.faqSearch.useCustomReadMoreURL&&"relevantWithReadMore"===$scope.faqSearch.responseType&&void 0!==$scope.faqSearch.customReadMoreURL&&(faqSearchObj.customReadMoreURL=$scope.faqSearch.customReadMoreURL),obj.confidenceConfig[1].searchInAnswer=faqSearchObj,$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs[1].longResponses&&(obj.confidenceConfig[1].longResponses=$scope.selectedStream.confidenceConfigs[1].longResponses),doServiceCalls(obj,_trainOntology)})},$scope.manageResponseCB={},$scope.openManageResponse=function(key,event){$scope.showStandardResponses=!0,event.preventDefault(),event.stopImmediatePropagation(),event.stopPropagation(),setTimeout(function(){$scope.manageResponseCB.title=i18n.i18nString("ml_threshold_confirmation_dialog_for_component"),$scope.manageResponseCB.conditionKey=$scope.constants.pauseResumeMessages[key];var _btnValue="close";$scope.manageResponseCB.openManageResponse(_btnValue),$scope.manageResponseCB.initMessages($scope.displayMode)},200)},$scope.manageResponseCB.closeResponseScreen=function(){$scope.manageResponseCB.conditionKey={},$scope.showStandardResponses=!1,setTimeout(function(){$(".builderMaincontainer").addClass("bt-modal-open")},300)},$scope.getTrainStatus=function(){$scope.showKgTrainingDiv=!0;var callName="streams/"+$workflowService.selectedStream()._id+"/knowledgetask/"+$scope.knowledgeTask._id+"/trainBot";botOntologyService.getTrainStatus($applicationService.userInfo.userId,$workflowService.selectedStream()._id,callName).then(function(response){"success"==response.data.status?($interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id]),$rootScope.statusInterval[$scope.knowledgeTask._id]="",$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=!1,$scope.kgTrainStatus.success=!0,$scope.kgTrainStatus.saving=!1,$scope.kgTrainStatus.failed=!1,NotificationService.notify(i18n.i18nString("kg_train_success"),"success")):"in-progress"==response.data.status?($scope.kgTrainStatus.failed=!1,$scope.kgTrainStatus.success=!1,$scope.kgTrainStatus.saving=!0):"failure"==response.data.status&&($interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id]),response.data.heavyNodeCount&&NotificationService.notify(i18n.i18nString("training_heavynode"),"error"),$rootScope.statusInterval[$scope.knowledgeTask._id]="",$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=!1,$scope.kgTrainStatus.success=!1,$scope.kgTrainStatus.saving=!1,$scope.kgTrainStatus.failed=!0,NotificationService.notify(i18n.i18nString("kg_graph_training_failed"),"error"))},function(response){$interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id]),$rootScope.statusInterval[$scope.knowledgeTask._id]="",$rootScope.ontologyTrainInProgress[$scope.knowledgeTask._id]=!1,$scope.kgTrainStatus.failed=!0,$scope.kgTrainStatus.success=!1,$scope.kgTrainStatus.saving=!1,NotificationService.notify(i18n.i18nString("problem_train"),"error")})},$scope.trainBotOntology=function(){$scope.showKgTrainingDiv=!0,$element.find("#warningKgModal").removeClass("show").addClass("fade"),$scope.knowledgeTask&&$scope.knowledgeTask._id&&BTStreamsService.trainFaq($workflowService.selectedStream()._id,$scope.knowledgeTask._id).then(function(res){$scope.kgTrainStatus.failed=!1,$scope.kgTrainStatus.success=!1,$scope.kgTrainStatus.saving=!0,"in_progress"===res.data.status.toLowerCase()&&(NotificationService.notify(i18n.i18nString("kg_train"),"success"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"))},function(err){if(err.data.errors&&err.data.errors.length>0){var _msg=err.data.errors[0].msg;NotificationService.notify(_msg,"error")}else NotificationService.notify(i18n.i18nString("problem_train"),"error");$scope.kgTrainStatus.failed=!0,$scope.kgTrainStatus.success=!1,$scope.kgTrainStatus.saving=!1})};var cleanUpFunc=$rootScope.$on("kgTrainingStatus",function(e,data){data&&($scope.trainOntologyStatus=data.status.toLowerCase(),"success"===$scope.trainOntologyStatus?(NotificationService.notify(i18n.i18nString("kg_train_success"),"success"),$scope.kgTrainStatus.success=!0,$scope.kgTrainStatus.saving=!1,$scope.kgTrainStatus.failed=!1):"in_progress"===$scope.trainOntologyStatus?($scope.kgTrainStatus.success=!1,$scope.kgTrainStatus.saving=!0,$scope.kgTrainStatus.failed=!1):($scope.kgTrainStatus.success=!1,$scope.kgTrainStatus.saving=!1,$scope.kgTrainStatus.failed=!0))});$scope.$on("$destroy",function(){cleanUpFunc()}),$scope.showKgModal=function(){$element.find("#warningKgModal").removeClass("fade").addClass("show")},$scope.proceedAutoCorrectModal=function(){$element.find("#warningAutoCorrectModal").removeClass("show").addClass("fade"),_trainOntology=$scope.kgCollection.autoCorrect,$scope.saveToggleSwitch(_trainOntology),$rootScope.statusInterval[$scope.knowledgeTask._id]&&$interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id])},$scope.closeAutoCorrectModal=function(){$scope.kgCollection.autoCorrect=!$scope.kgCollection.autoCorrect,$element.find("#warningAutoCorrectModal").removeClass("show").addClass("fade")},$scope.showAutoCorrectModal=function(){$element.find("#warningAutoCorrectModal").removeClass("fade").addClass("show")},$scope.saveBotSynonymToggleSwitch=function(_trainOntology){$timeout(function(){obj.confidenceConfig[1].useBotSynonyms=$scope.kgCollection.useBotSynonyms,updateChangeLogs(obj,_trainOntology)},250)},$scope.proceedKgSynonyms=function(){$element.find("#warningKgSynonymModal").removeClass("show").addClass("fade"),_trainOntology=$scope.kgCollection.useBotSynonyms,$scope.saveBotSynonymToggleSwitch(_trainOntology),$rootScope.statusInterval[$scope.knowledgeTask._id]&&$interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id])},$scope.toggleLemPattern=function(){$scope.saveToggleSwitch(!0),$rootScope.statusInterval[$scope.knowledgeTask._id]&&$interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id])},$scope.closeKgSynonymModal=function(){$scope.kgCollection.useBotSynonyms=!$scope.kgCollection.useBotSynonyms,$element.find("#warningKgSynonymModal").removeClass("show").addClass("fade")},$scope.showKgSynonymModal=function(){$element.find("#warningKgSynonymModal").removeClass("fade").addClass("show")},$scope.closeKgModal=function(){$element.find("#warningKgModal").removeClass("show").addClass("fade"),$scope.faqSearch.enabled=!$scope.faqSearch.enabled,$scope.faqSearch.enabled===!0&&($scope.faqSearch.responseType="complete")},$scope.proceedFaqSearch=function(){$rootScope.statusInterval[$scope.knowledgeTask._id]&&$interval.cancel($rootScope.statusInterval[$scope.knowledgeTask._id]),$scope.faqSearch.enabled===!0&&($scope.faqSearch.responseType="complete"),_trainOntology=$scope.faqSearch.enabled,$element.find("#warningKgModal").removeClass("show").addClass("fade"),$scope.updateFaqSearch(_trainOntology)},$scope.toggleCheck=function(){$timeout(function(){$scope.faqLong.useCustomReadMoreURL===!1&&$scope.updateFaqLongResponse()},0)},$scope.toggleCheckSearch=function(){$timeout(function(){$scope.faqSearch.useCustomReadMoreURL===!1&&$scope.updateFaqSearch()},0)},$scope.updateFaqLongResponse=function(){var faqObject={};$timeout(function(){$scope.faqLong&&void 0!==$scope.faqLong.readMore&&(faqObject.readMore=$scope.faqLong.readMore),$scope.faqLong.readMore&&void 0!==$scope.faqLong.useCustomReadMoreURL&&(faqObject.useCustomReadMoreURL=$scope.faqLong.useCustomReadMoreURL),$scope.faqLong.readMore&&$scope.faqLong.useCustomReadMoreURL&&void 0!==$scope.faqLong.customReadMoreURL&&(faqObject.customReadMoreURL=$scope.faqLong.customReadMoreURL),obj.confidenceConfig[1].longResponses=faqObject,$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs[1].searchInAnswer&&(obj.confidenceConfig[1].searchInAnswer=$scope.selectedStream.confidenceConfigs[1].searchInAnswer),$scope.kgCollection.useBotSynonyms&&($scope.selectedStream.confidenceConfigs[1].useBotSynonyms=$scope.kgCollection.useBotSynonyms,obj.confidenceConfig[1].useBotSynonyms=$scope.kgCollection.useBotSynonyms),doServiceCalls(obj)})},$scope.setWordsscrollToBottom=function(){setTimeout(function(){$(".input").first().focus()},1e3),setTimeout(function(){$(".searchBar").off("click").on("click",function(){$scope.searchWord.search="",$(this).hasClass("fa-remove")?($(".stopWordsSearch").removeClass("searchExpand"),$(this).removeClass("fa-remove"),$(this).addClass("fa-search"),$scope.searchWord.search=""):($(".stopWordsSearch").addClass("searchExpand"),$(this).addClass("fa-remove"),$(this).removeClass("fa-search"),$timeout(function(){$(".stopWordsSearchInput").focus()},350))});var ele=$(".stopWordsBody"),bodyHeight=ele[0].scrollHeight;ele.scrollTop(bodyHeight)},500)},$scope.activateWordSearch=function(){$(".stopWordsBody").scrollTop(0)},$scope.deleteStopWordInSearch=function(text){$scope.lodingStopWords=!0,$scope.payload&&$scope.payload.intentData&&$scope.payload.intentData.stopwords&&($scope.payload.intentData.stopwords=$scope.payload.intentData.stopwords.replace(text,"")),saveMLSynonymSetting(null,!1)},$scope.manageStopWords=function(){$scope.showStopwordsModal=!0,$scope.openModalSlider("#manageStopWords"),$scope.setWordsscrollToBottom()},$scope.resetDefaultStopWords=function(){function resetStopwords(){saveMLSynonymSetting(null,!0,"intentData.stopwords")}function cancel(){}NotificationService.userConfirm(i18n.i18nString("reset_default_delete"),[resetStopwords,cancel],{okText:i18n.i18nString("confirm_and_reset"),btnClass:"redBtn"},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.editStopWords=function(){var tempStopwords="";setTimeout(function(){$.each($scope.mlthreshold.stopWords,function(i,stopword){tempStopwords=tempStopwords+stopword+" "}),$scope.payload.intentData.stopwords=tempStopwords.trim(),saveMLSynonymSetting(null,!1)},100)},$scope.closeManageStopWordsModalSlider=function(){$scope.closeModalSlider("#manageStopWords"),$scope.showStopwordsModal=!1},$scope.showModal=function(){$element.find("#warningModal").removeClass("fade").addClass("show")},$scope.closeModal=function(){$scope.multipIntentModels.intentParams?$scope.multipIntentModels.intentParams.useSynonyms=!$scope.multipIntentModels.intentParams.useSynonyms:$scope.intentParams.useSynonyms=!$scope.intentParams.useSynonyms,$scope.intentParams.useSynonyms?$scope.intentParams.useSynonyms=!$scope.intentParams.useSynonyms:$scope.intentParams.useSynonyms=!$scope.intentParams.useSynonyms,
$element.find("#warningModal").removeClass("show").addClass("fade")},$scope.enableDisableSynonym=function(){return $scope.intentParams&&$scope.intentParams.useSynonyms?$scope.filterToggle="enabled":$scope.filterToggle="disabled",$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType?($scope.multipIntentModels.intentParams&&$scope.multipIntentModels.intentParams.useSynonyms?$scope.filterToggle="enabled":$scope.filterToggle="disabled",void $element.find("#warningModal").removeClass("show").addClass("fade")):($scope.payload.intentParams=$scope.intentParams,void saveMLSynonymSetting(null,!1,"",!0))},$scope.enableDisableStopWords=function(){$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType||($scope.payload.intentParams=$scope.intentParams,saveMLSynonymSetting(null,!1))},$scope.enableDisablePlaceholders=function(){$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType||($scope.payload.intentParams=$scope.intentParams,saveMLSynonymSetting(null,!1))},$scope.savenerParams=function(type){$scope.payload.nerParams=$scope.payload.nerParams,saveMLSynonymSetting(null,!1)},$scope.redirectToLink=function(link,e){e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()),$rootScope.redirectToLink(link,e)},$scope.upgradeML=function(type){function upgrade(){$scope.intentParams.type=type,$scope.payload.intentParams=$scope.intentParams,"V3"===type?saveMLSynonymSetting(type,!0,"",!0):saveMLSynonymSetting(type,!1,"",!0)}function cancel(){}if("V3"===type){var msg=i18n.i18nString("new_version_of_ml_model")+' <span class="marginLeft5 bthelpLinksTextcolor pointer-hand"><a class="knowmore" target="_blank" href="https://developer.kore.ai/docs/bots/nlp/user-utterances/#ML-upgrade">'+i18n.i18nString("know_more")+'</a></span></br></br><span class="grayInfoText">'+i18n.i18nString("older_version_of_ml_model")+"</span>";NotificationService.userConfirm(msg,[upgrade,cancel],{okText:i18n.i18nString("upgrade_and_train"),addHtmlContent:!0},"",void 0,i18n.i18nString("confirm_proceed"))}else NotificationService.userConfirm("<strong>"+i18n.i18nString("older_version_of_ml_model")+"</strong></br>"+i18n.i18nString("we_strongle_recommend_to_stay"),[upgrade,cancel],{okText:i18n.i18nString("downgrade_label"),btnClass:"redBtn",addHtmlContent:!0},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.resetNgram=function(){saveMLSynonymSetting("V3",!0,"intentParams.ngram")},$scope.selectedStream.confidenceConfigs&&$scope.selectedStream.confidenceConfigs.length>0&&(obj.confidenceConfig[1].minThreshold=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].minThreshold?$scope.selectedStream.confidenceConfigs[1].minThreshold:60,obj.confidenceConfig[1].maxThreshold=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].maxThreshold?$scope.selectedStream.confidenceConfigs[1].maxThreshold:80,obj.confidenceConfig[2].wordCoverage=void 0===$scope.selectedStream.confidenceConfigs[2]?60:void 0!==$scope.selectedStream.confidenceConfigs[2].wordCoverage?$scope.selectedStream.confidenceConfigs[2].wordCoverage:60,obj.confidenceConfig[2].isFMThreshold=void 0===$scope.selectedStream.confidenceConfigs[2]?!1:void 0!==$scope.selectedStream.confidenceConfigs[2].isFMThreshold?$scope.selectedStream.confidenceConfigs[2].isFMThreshold:!1,obj.confidenceConfig[2].fmThreshold=void 0===$scope.selectedStream.confidenceConfigs[2]?2:void 0!==$scope.selectedStream.confidenceConfigs[2].fmThreshold?$scope.selectedStream.confidenceConfigs[2].fmThreshold:2,obj.confidenceConfig[3].taskMatchTolerance=void 0===$scope.selectedStream.confidenceConfigs[3]?2:void 0!==$scope.selectedStream.confidenceConfigs[3].taskMatchTolerance?$scope.selectedStream.confidenceConfigs[3].taskMatchTolerance:2,obj.confidenceConfig[3].minMatchVal=void 0===$scope.selectedStream.confidenceConfigs[3]?.5:$scope.selectedStream.confidenceConfigs[3].minMatchVal?$scope.selectedStream.confidenceConfigs[3].minMatchVal:.5,obj.confidenceConfig[3].useDependencyParser=$scope.selectedStream.confidenceConfigs[3]&&void 0!==$scope.selectedStream.confidenceConfigs[3].useDependencyParser?$scope.selectedStream.confidenceConfigs[3].useDependencyParser:!1,obj.confidenceConfig[3].isPreferDefinitiveMatch=$scope.selectedStream.confidenceConfigs[3]&&void 0!==$scope.selectedStream.confidenceConfigs[3].isPreferDefinitiveMatch?$scope.selectedStream.confidenceConfigs[3].isPreferDefinitiveMatch:!1,obj.confidenceConfig[3].intentRescoring=$scope.selectedStream.confidenceConfigs[3]&&void 0!==$scope.selectedStream.confidenceConfigs[3].intentRescoring?$scope.selectedStream.confidenceConfigs[3].intentRescoring:!1,obj.confidenceConfig[2].labelMatch=void 0===$scope.selectedStream.confidenceConfigs[2]?!0:$scope.selectedStream.confidenceConfigs[2].hasOwnProperty("labelMatch")?$scope.selectedStream.confidenceConfigs[2].labelMatch:!0,obj.confidenceConfig[0].minThreshold=void 0!==$scope.selectedStream.confidenceConfigs[0].minThreshold?$scope.selectedStream.confidenceConfigs[0].minThreshold:.3,obj.confidenceConfig[0].exactMatchThreshold=void 0!==$scope.selectedStream.confidenceConfigs[0].exactMatchThreshold?$scope.selectedStream.confidenceConfigs[0].exactMatchThreshold:95,obj.confidenceConfig[1].exactMatchThreshold=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].exactMatchThreshold?$scope.selectedStream.confidenceConfigs[1].exactMatchThreshold:95,obj.confidenceConfig[1].suggestionsCount=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].suggestionsCount?$scope.selectedStream.confidenceConfigs[1].suggestionsCount:3,obj.confidenceConfig[1].taskMatchTolerance=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].taskMatchTolerance?$scope.selectedStream.confidenceConfigs[1].taskMatchTolerance:5,obj.confidenceConfig[1].pathCoverage=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].pathCoverage?$scope.selectedStream.confidenceConfigs[1].pathCoverage:50,$scope.contextObj.qualifyContextualPaths=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].qualifyContextualPaths?$scope.selectedStream.confidenceConfigs[1].qualifyContextualPaths:!1,obj.confidenceConfig[1].autoCorrPercentage=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].autoCorrPercentage?$scope.selectedStream.confidenceConfigs[1].autoCorrPercentage:5,obj.confidenceConfig[1].qualifyContextualPaths=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].qualifyContextualPaths?$scope.selectedStream.confidenceConfigs[1].qualifyContextualPaths:!1,obj.confidenceConfig[1].autoSpellCorrectEnabled=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].autoSpellCorrectEnabled?$scope.selectedStream.confidenceConfigs[1].autoSpellCorrectEnabled:!1,obj.confidenceConfig[2].minMatchVal=$scope.selectedStream.confidenceConfigs[2]&&void 0!==$scope.selectedStream.confidenceConfigs[2].minMatchVal?$scope.selectedStream.confidenceConfigs[2].minMatchVal:.5,obj.confidenceConfig[1].enPatternLemma=$scope.selectedStream.confidenceConfigs[1]&&void 0!==$scope.selectedStream.confidenceConfigs[1].enPatternLemma?$scope.selectedStream.confidenceConfigs[1].enPatternLemma:!1),$scope.intentDetect={value:obj.confidenceConfig[2].labelMatch},$scope.showReset=function(a,b){$(a).removeClass("hide"),$scope.currentSlider=b},$scope.hideReset=function(a){$(a).addClass("hide")},$timeout(function(){updateRREngineData()}),$scope.resetDefaultVal=function(current){current=current||$scope.currentSlider;var defValue;switch(current){case"#slider2":defValue=2,obj.confidenceConfig[3].taskMatchTolerance=defValue,s2.bootstrapSlider("setValue",defValue);break;case"#slider3":defValue=.3,obj.confidenceConfig[0].minThreshold=defValue,s3.bootstrapSlider("setValue",defValue);break;case"#slider4":defValue=95,obj.confidenceConfig[0].exactMatchThreshold=defValue,s4.bootstrapSlider("setValue",defValue);break;case"#slider6":defValue=3,obj.confidenceConfig[1].suggestionsCount=defValue,s6.bootstrapSlider("setValue",defValue);break;case"#slider7":defValue=5,obj.confidenceConfig[1].taskMatchTolerance=defValue,s7.bootstrapSlider("setValue",defValue);break;case"#slider8":defValue=50,obj.confidenceConfig[1].pathCoverage=defValue,s8.bootstrapSlider("setValue",defValue);break;case"#slider9":defValue=5,obj.confidenceConfig[1].autoCorrPercentage=defValue,s9.bootstrapSlider("setValue",defValue);break;case"#slider10":defValue=.5,obj.confidenceConfig[2].minMatchVal=defValue,s10.bootstrapSlider("setValue",defValue);break;case"#matchScore-slider":defValue=.5,obj.confidenceConfig[3].minMatchVal=defValue,s11.bootstrapSlider("setValue",defValue);break;case"#dual-slider":var slider=$("#knowledgeCollectionThresholds").find("#triple-slider")[0];slider.noUiSlider.set([60,80,95]),defValue=[60,80],obj.confidenceConfig[1].minThreshold=defValue[0],obj.confidenceConfig[1].maxThreshold=defValue[1],obj.confidenceConfig[1].exactMatchThreshold=95,dualS.bootstrapSlider("setValue",defValue);break;case"#slider3CM":defValue=.3,obj.confidenceConfig[0].minThreshold=defValue,s3.bootstrapSlider("setValue",defValue);break;case"#slider4CM":defValue=95,obj.confidenceConfig[0].exactMatchThreshold=defValue,s4.bootstrapSlider("setValue",defValue);break;case"#slider11":defValue=2,obj.confidenceConfig[2].fmThreshold=defValue,fmSlider.bootstrapSlider("setValue",defValue)}$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType||(formatTooltip(current,defValue),doServiceCalls(obj))},$scope.closeTrainSaveDiv=function(){$scope.showTrainSavingDiv=!1},$scope.closeKgTrainDiv=function(){$scope.showKgTrainingDiv=!1},$scope.$on("getProgressDockStatus",function(){$scope.trainStatus.saving=!1,$scope.trainStatus.success=!0,$scope.trainStatus.failed=!1}),$scope.trainBot=function(callFrom){BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$scope.trainStatus.saving=!0,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!1,$scope.showTrainBtn=!1,$scope.showTrainSavingDiv=!0,$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$emit("clearTestTrainText"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),NotificationService.notify(i18n.i18nString("bot_train"),"info"),$scope.trainShow=!1,$(".ml-threshold-saving").addClass("trainingTop20")},function(err){$scope.trainStatus.saving=!1,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!0,err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})},$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.tripleSliderChanged=function(event){var intentSlid=Math.round($($("#triple-slider .noUi-handle")[0]).attr("aria-valuenow")),kgTask=Math.round($($("#triple-slider .noUi-handle")[1]).attr("aria-valuenow")),scoreSlid=Math.round($($("#triple-slider .noUi-handle")[2]).attr("aria-valuenow"));onSliderChanged("#dual-slider",[intentSlid,kgTask,scoreSlid])},$scope.updateConfigs=function(oldConfig,configuration){$scope.currentConfiguration=configuration,$scope.previousConfiguration=oldConfig,$element.find("#editConfig").removeClass("fade").addClass("show")},$scope.updateConfigsCB=function(oldConfig,configuration){$scope.currentConfiguration=configuration,$scope.previousConfiguration=oldConfig,$element.find("#editConfig").removeClass("fade").addClass("show")},$scope.editConfigs=function(index,configuration,value){$scope.currentConfiguration=configuration,value&&($scope.currentConfiguration.value=value),$element.find("#editConfig").removeClass("fade").addClass("show")};var onSliderChanged=_.debounce(onSliderChangedProxy,500);$scope.saveGram=function(feature){return $scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType?void("n_gramCM"===feature?($scope.multipIntentModels.intentParams.ngram[1]=$scope.multipIntentModels.intentParams.ngram&&$scope.multipIntentModels.intentParams.ngram.length?$scope.multipIntentModels.intentParams.ngram[1]:1,delete $scope.multipIntentModels.intentParams.skip_gram):"skip_gramCM"===feature&&($scope.multipIntentModels.intentParams.skip_gram=$scope.multipIntentModels.intentParams.skip_gram?$scope.multipIntentModels.intentParams.skip_gram:{},$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance=$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance?$scope.multipIntentModels.intentParams.skip_gram.maxSkipDistance:1,$scope.multipIntentModels.intentParams.skip_gram.seqLength=$scope.multipIntentModels.intentParams.skip_gram.seqLength?$scope.multipIntentModels.intentParams.skip_gram.seqLength:2,delete $scope.multipIntentModels.intentParams.ngram,delete $scope.multipIntentModels.intentParams.maxngram,delete $scope.multipIntentModels.intentParams.minngram)):("n_gram"===feature?($scope.intentParams.ngram[1]=$scope.intentParams.ngram&&$scope.intentParams.ngram.length?$scope.intentParams.ngram[1]:1,delete $scope.intentParams.skip_gram):"skip_gram"===feature&&($scope.intentParams.skip_gram=$scope.intentParams.skip_gram?$scope.intentParams.skip_gram:{},$scope.intentParams.skip_gram.maxSkipDistance=$scope.intentParams.skip_gram.maxSkipDistance?$scope.intentParams.skip_gram.maxSkipDistance:1,$scope.intentParams.skip_gram.seqLength=$scope.intentParams.skip_gram.seqLength?$scope.intentParams.skip_gram.seqLength:2,delete $scope.intentParams.ngram,delete $scope.intentParams.maxngram,delete $scope.intentParams.minngram),$scope.payload.intentParams=$scope.intentParams,void saveMLSynonymSetting(null,!1,null,null,feature))},$scope.saveToggleSwitch=function(_trainOntology){$timeout(function(){obj.confidenceConfig[1].autoSpellCorrectEnabled=$scope.kgCollection.autoCorrect,obj.confidenceConfig[1].useBotSynonyms=$scope.kgCollection.useBotSynonyms,obj.confidenceConfig[1].enPatternLemma=$scope.kgCollection.enPatternLemma,doServiceCalls(obj,_trainOntology)},250)},$scope.showRestore=function(){if($scope.selectedStream.confidenceConfigs[3]&&$scope.selectedStream.confidenceConfigs[3].rankingParameters){var compareValue=_.isEqual($scope.rankResolveEngine.rankingParameters,$scope.defaultRankingParameters);compareValue?$scope.hideRestore=!0:$scope.hideRestore=!1}},$scope.editConfigurations=function(){$scope.selectedStream.confidenceConfigs[3]&&$scope.selectedStream.confidenceConfigs[3].rankingParameters?($scope.rankResolveEngine.rankingParameters=$scope.selectedStream.confidenceConfigs[3].rankingParameters,$scope.showRestore()):($scope.rankResolveEngine.rankingParameters={},$scope.hideRestore=!1),$timeout(function(){$scope.openModalSlider("#editConfigurations")})},$scope.closeEditConfig=function(config){$scope.closeModalSlider("#editConfigurations")},$scope.updateConfig=function(){obj.confidenceConfig[3].rankingParameters=$scope.rankResolveEngine.rankingParameters,doServiceCalls(obj,!1)},$scope.compareJson=function(){if($scope.rankResolveEngine&&$scope.rankResolveEngine.rankingParameters){var compareValue=_.isEqual($scope.rankResolveEngine.rankingParameters,$scope.defaultRankingParameters);compareValue||$element.find("#restoreModal").removeClass("fade").addClass("show")}},$scope.closeRestoreModal=function(){$element.find("#restoreModal").removeClass("show").addClass("fade")},$scope.proceedConfiguration=function(){$element.find("#restoreModal").removeClass("show").addClass("fade"),fetchDefaultParams(!1)},$scope.intentDetectChange=function(){obj.confidenceConfig[2].labelMatch=$scope.intentDetect.value,doServiceCalls(obj,!1)},$scope.fmThresholdChange=function(){obj.confidenceConfig[2].fmThreshold=obj.confidenceConfig[2].fmThreshold||2,obj.confidenceConfig[2].isFMThreshold=$scope.intentDetect.isFMThreshold,doServiceCalls(obj,!1),checkFMSettingCount()},$scope.preferDefinitiveShowMore=function(){$scope.preferDefinitiveDescLimit=$scope.preferDefinitiveDesc.length},$scope.RREngineChange=function(type){"isPreferDefinitiveMatch"===type?(obj.confidenceConfig[3].isPreferDefinitiveMatch=$scope.rankResolveEngine.isPreferDefinitiveMatch,doServiceCalls(obj,!1)):"intentRescoring"===type&&(obj.confidenceConfig[3].intentRescoring=$scope.rankResolveEngine.intentRescoring,doServiceCalls(obj,!1)),checkRRSettingCount()},$scope.showEnableModal=function(){$scope.rankResolveEngine.useDependencyParser?($scope.rankResolveEngine.useDependencyParser=!1,obj.confidenceConfig[3].useDependencyParser=$scope.rankResolveEngine.useDependencyParser,$scope.resetDefaultVal("#matchScore-slider"),delete obj.confidenceConfig[3].minMatchVal,delete obj.confidenceConfig[3].rankingParameters,doServiceCalls(obj,!1)):$element.find("#enableModal").removeClass("fade").addClass("show"),checkRRSettingCount()},$scope.closeEnableModal=function(){$scope.rankResolveEngine.useDependencyParser=!1,$element.find("#enableModal").removeClass("show").addClass("fade")},$scope.enableDependency=function(){$scope.rankResolveEngine.useDependencyParser=!$scope.rankResolveEngine.useDependencyParser,$element.find("#enableModal").removeClass("show").addClass("fade"),obj.confidenceConfig[3].useDependencyParser=$scope.rankResolveEngine.useDependencyParser,obj.confidenceConfig[3].minMatchVal=minMatchVal,obj.confidenceConfig[3].rankingParameters={},doServiceCalls(obj,!1)},$scope.createConfiguration=function(){$scope.showEmptyConfig=!1,$scope.showEmptyConfigCM=!1};var addConfigurationCall=function(_payload,configuration,previousConfiguration,model){$scope.parentRelationError=!1,BTStreamsService.addConfiguration($scope.selectedStream._id,_payload).then(function(response){response&&response.data&&(configuration._id=response.data._id,configuration.requiresTraining=response.data.requiresTraining,configuration.isCustom||$scope.savedConfigurations.push(configuration),configuration.requiresTraining&&"ML"===configuration.nlpEngine&&"kfold"!==configuration.configurationKeyName&&($scope.trainShow=!0),configuration.requiresTraining&&"KG"===configuration.nlpEngine&&$scope.trainBotOntology(),originalCopy=angular.copy($scope.savedConfigurations),$workflowService.savedConfigurationsList(originalCopy),"slider"===configuration.uiComponent&&setTimeout(function(){advancedConfigSlider(configuration),advancedConfigSliderCM(configuration)},200),checkNetworkType(),$scope.totalConfigCount=originalCopy.length,finishSaving("ml"===model?".ml-savingStatus":".savingStatus"),NotificationService.notify(i18n.i18nString("settings_saved"),"success"),_.remove($scope.uiConfiguration,{_id:response.data._id}),$scope.search={},previousConfiguration&&BTStreamsService.deleteConfiguration($scope.selectedStream._id,previousConfiguration._id).then(function(response){_.remove($scope.savedConfigurations,{_id:previousConfiguration._id}),deRegisterCustomSliders(),$scope.uiConfiguration.push(previousConfiguration),originalCopy=angular.copy($scope.savedConfigurations),$workflowService.savedConfigurationsList(originalCopy),$timeout(function(){$scope.registerCustomSliders()}),$scope.totalConfigCount=originalCopy.length,autoTrainStatus()}))},function(err){err&&err.data&&err.data.errors?("The required parent configuration for this child configuration is not configured."===err.data.errors[0].msg&&($scope.parentRelationError=!0),NotificationService.notify(err.data.errors[0].msg,"error")):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error"),$scope.search={},stopSaving("ml"===model?".ml-savingStatus":".savingStatus")})},prepareSavedConfigurations=function(savedConfigurations){angular.forEach(savedConfigurations,function(config){var configData=serverConfigOb[config.configurationKeyName];_.remove($scope.uiConfiguration,{configurationKeyName:config.configurationKeyName}),configData?(config.uiComponent=configData.uiComponent,config.configurationName=configData.configurationName,config["class"]=mapClass[configData.nlpEngine],config.value=config.hasOwnProperty("configurationValue")?config.configurationValue:configData.value,config.defaultValue=configData.defaultValue,config.requiresTraining=configData.requiresTraining,"slider"===configData.uiComponent&&(config.range=configData.range,config.interval=configData.interval),"dropdown"===configData.uiComponent&&(config.range=configData.range)):config.isCustom&&(config.value=config.configurationValue)});var networkIndex=savedConfigurations.findIndex(function(item){return"network"===item.configurationKeyName});-1!==networkIndex&&($scope.networkTypeList=savedConfigurations[networkIndex],savedConfigurations.splice(networkIndex,1)),$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType?$scope.savedConfigurationsCM=savedConfigurations:($scope.savedConfigurations=savedConfigurations,originalCopy=angular.copy($scope.savedConfigurations),$workflowService.savedConfigurationsList(originalCopy))},advancedConfigSlider=function(configData){customSlider=configData.configurationKeyName,customSlider=registerSlider("#"+configData.configurationKeyName,{tooltip:"always",tooltip_position:"bottom"}),customSlider.bootstrapSlider("setValue",configData.value),$("#"+configData.configurationKeyName+"Slider").find(".tooltip-inner").text(configData.value)},advancedConfigSliderCM=function(configData){customSlider=configData.configurationKeyName,customSlider=registerSlider("#"+configData.configurationKeyName+"CM",{tooltip:"always",tooltip_position:"bottom"}),customSlider.bootstrapSlider("setValue",configData.value),$("#"+configData.configurationKeyName+"SliderCM").find(".tooltip-inner").text(configData.value)},startSaving=function(className){".ml-savingStatus"===className?$scope.refreshStatus2="refresh-spin":$scope.refreshStatus="refresh-spin"},stopSaving=function(className){".ml-savingStatus"===className?($scope.refreshStatus2="",$timeout(function(){$scope.refreshStatus2="times",resetStatus()},500)):($scope.refreshStatus="",$timeout(function(){$scope.refreshStatus="times",resetStatus()},500))},resetStatus=function(){$timeout(function(){$scope.refreshStatus="",$scope.refreshStatus2=""},2e3)},finishSaving=function(className){".ml-savingStatus"===className?($scope.refreshStatus2="",$timeout(function(){$scope.refreshStatus2="check",resetStatus()},500)):($scope.refreshStatus="",$timeout(function(){$scope.refreshStatus="check",resetStatus()},500))};$scope.addConfiguration=function(configuration,index,previousConfiguration){var _payload={configurationKeyName:configuration.configurationKeyName,nlpEngine:configuration.nlpEngine,configurationValue:configuration.value};configuration.isCustom&&(_payload.isCustom=configuration.isCustom),startSaving(".savingStatus"),addConfigurationCall(_payload,configuration,previousConfiguration)},$scope.addConfigurationCM=function(configuration,index,previousConfiguration){var _payload={configurationKeyName:configuration.configurationKeyName,nlpEngine:configuration.nlpEngine,configurationValue:configuration.value};return configuration.isCustom&&(_payload.isCustom=configuration.isCustom),$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType?($scope.savedConfigurationsCM.some(function(entry){return entry.configurationKeyName===configuration.configurationKeyName})||$scope.savedConfigurationsCM.push(configuration),void("slider"===configuration.uiComponent&&setTimeout(function(){advancedConfigSliderCM(configuration)},200))):void 0},$scope.addNetworkTypeConfig=function(configuration,type){function confirm(){if($scope.networkTypeList.value=type,!$scope.multipIntentModels.configurationValue||!$scope.multipIntentModels.formType)if(resetDefaultIntentParams(),configuration&&configuration._id)$scope.proceedEditConfig(configuration,"",type,"ml");else{var _payload={configurationKeyName:configuration.configurationKeyName,nlpEngine:configuration.nlpEngine,configurationValue:configuration.value};addConfigurationCall(_payload,configuration,"ml")}}function cancel(){}var knowmoreLink='<a href="https://developer.kore.ai/docs/bots/nlp/advanced-nlp-configurations/#Network_Type" target="_blank">know more</a>',_msg="Some of the ML Configurations may not be applicable for the '"+type+"' and changing the Network Type would result in disabling such configuration. "+knowmoreLink;NotificationService.userConfirm(_msg,[confirm,cancel],{okText:i18n.i18nString("confirm"),addHtmlContent:!0,btnClass:"redBtn"},"",void 0,i18n.i18nString("confirm_proceed"))},$scope.deleteConfiguration=function(index,configuration){return $scope.currentIndex=index,$scope.currentConfiguration=configuration,$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType?void $element.find("#deleteConfig").removeClass("fade").addClass("show"):void(configuration._id?$element.find("#deleteConfig").removeClass("fade").addClass("show"):($scope.savedConfigurations.splice(index,1),$scope.invalidPattern=!1,$scope.invalidCustomValue=!1,autoTrainStatus()))},$scope.closeDeleteConfig=function(){$element.find("#deleteConfig").removeClass("show").addClass("fade")},$scope.closeEditConfigCustom=function(config){if($element.find("#editConfig").removeClass("show").addClass("fade"),config){var res=_.find(originalCopy,{_id:config._id});config.value=res.value,res.isCustom&&(config.configurationKeyName=res.configurationKeyName),"slider"===config.uiComponent&&$("#"+config.configurationKeyName+"Slider").find(".tooltip-inner").text(res.value)}};var validateConfigKeyPattern=function(config){var lists=config.configurationKeyName.split("_");if(lists&&lists.length>1){var value=lists[0].toString().toLowerCase();return-1!==engineList.indexOf(value)&&lists[1].length?(config.nlpEngine=mapEngines[value],!0):!1}return!1};$scope.addCustomValue=function(e,config,form){if(e&&13===e.keyCode&&config.configurationKeyName&&void 0!==config.configurationKeyName&&config.value&&void 0!==config.value&&config.configurationKeyName.length&&config.value.length){$scope.invalidCustomKey=!1,$scope.invalidCustomValue=!1,config.invalidCustomKey=!1,config.invalidCustomValue=!1;var foundPattern=validateConfigKeyPattern(config);if(foundPattern){$scope.invalidPattern=!1,config.invalidPattern=!1;var _payload={configurationKeyName:config.configurationKeyName,nlpEngine:config.nlpEngine,configurationValue:config.value,isCustom:!0};if(startSaving(".savingStatus"),config._id){if(config._id){var previousConfiguration=_.find(originalCopy,{_id:config._id});config.configurationKeyName.toLowerCase()!==previousConfiguration.configurationKeyName.toLowerCase()?($scope.currentConfiguration=config,$scope.previousConfiguration=angular.copy(previousConfiguration),$element.find("#editConfig").removeClass("fade").addClass("show")):$scope.proceedEditConfig(config)}}else addConfigurationCall(_payload,config)}else $scope.invalidPattern=!0,config.invalidPattern=!0}else config.configurationKeyName&&!config.configurationKeyName.length&&config.value&&!config.value.length?($scope.invalidCustomValue=!0,$scope.invalidCustomKey=!0,config.invalidCustomValue=!0,config.invalidCustomKey=!0):config.configurationKeyName&&!config.configurationKeyName.length?($scope.invalidCustomKey=!0,config.invalidCustomKey=!0):config.value&&!config.value.length&&($scope.invalidCustomValue=!0,config.invalidCustomValue=!0)},$scope.addCustomKey=function(e,config,form){if(config.configurationKeyName&&void 0!==config.configurationKeyName&&config.configurationKeyName.length){var foundPattern=validateConfigKeyPattern(config);if(foundPattern){if(config.invalidPattern=!1,$scope.invalidPattern=!1,config._id&&13===e.keyCode){$scope.currentConfiguration=config;var previousConfiguration=_.find(originalCopy,{_id:config._id});$scope.previousConfiguration=angular.copy(previousConfiguration),$scope.currentConfiguration.configurationKeyName.toLowerCase()!==$scope.previousConfiguration.configurationKeyName.toLowerCase()&&$element.find("#editConfig").removeClass("fade").addClass("show")}}else $scope.invalidPattern=!0,config.invalidPattern=!0}else $scope.invalidPattern=!0,config.invalidPattern=!0},$scope.proceedDeleteConfig=function(index,configuration){return $scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType?($scope.savedConfigurationsCM.splice(index,1),deRegisterCustomSliders(),$timeout(function(){$scope.registerCustomSliders(),clearSliders("ML"),prepareSliders("ML"),$scope.closeDeleteConfig(),$scope.savedConfigurationsCM.length||($scope.showEmptyConfigCM=!0)}),void(configuration&&configuration.requiresTraining&&"ML"===configuration.nlpEngine&&($scope.trainShow=!0))):(startSaving(".savingStatus"),void BTStreamsService.deleteConfiguration($scope.selectedStream._id,configuration._id).then(function(response){configuration.value=configuration.defaultValue,configuration&&configuration.requiresTraining&&"ML"===configuration.nlpEngine&&($scope.trainShow=!0),configuration&&configuration.requiresTraining&&"KG"===configuration.nlpEngine&&$scope.trainBotOntology(),$scope.savedConfigurations.splice(index,1),$scope.savedConfigurations.length||($scope.showEmptyConfig=!0),$scope.uiConfiguration.push(configuration),$scope.closeDeleteConfig(),deRegisterCustomSliders(),originalCopy=angular.copy($scope.savedConfigurations),checkNetworkType(),$scope.totalConfigCount=originalCopy.length,$workflowService.savedConfigurationsList(originalCopy),finishSaving(".savingStatus"),NotificationService.notify("Settings deleted successfully","success"),$timeout(function(){$scope.registerCustomSliders(),clearSliders("ML"),prepareSliders("ML")})},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error"),stopSaving(".savingStatus")}))},$scope.proceedDeleteConfigCM=function(index,configuration){return $scope.multipIntentModels.configurationValue?($scope.savedConfigurationsCM.splice(index,1),deRegisterCustomSliders(),void $timeout(function(){$scope.registerCustomSliders(),clearSliders("ML"),prepareSliders("ML"),$scope.closeDeleteConfig()})):void 0},$scope.proceedEditConfig=function(configuration,previousConfiguration,value,model){if(value&&(configuration.value=value),$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType){var findIndex=$scope.savedConfigurationsCM.findIndex(function(item){return item.configurationKeyName===previousConfiguration.configurationKeyName});return-1!==findIndex&&($scope.savedConfigurationsCM[findIndex]=configuration),deRegisterCustomSlidersCM(),$timeout(function(){$scope.registerCustomSliders()}),void $scope.closeEditConfigCustom()}return previousConfiguration&&(configuration.isCustom&&(configuration.isEditCustom=!0),$scope.addConfiguration(configuration,null,previousConfiguration),$scope.closeEditConfigCustom()),!previousConfiguration&&configuration&&"Multiple_Intent_Models"===configuration.configurationKeyName?(configuration.value?$scope.openEnableMultiIntents():configuration.value||$scope.openDisableMultiIntents(),$scope.loadConfiguration=configuration,void(configuration.requiresTraining&&"ML"===configuration.nlpEngine&&"kfold"!==configuration.configurationKeyName&&($scope.trainShow=!0))):void(configuration&&configuration._id&&editConfigurations(configuration,previousConfiguration,value,model))},$scope.proceedEditConfigCM=function(configuration,previousConfiguration,value,model){value&&(configuration.value=value)};var checkForSearchInAnsw=function(){var currentLang=$workflowService.currentLanguage();searchInAnsLang.indexOf(currentLang)>=0?$scope.showSearchInAns=!0:$scope.showSearchInAns=!1};$scope.qualifyContextualPaths=function(){$timeout(function(){obj.confidenceConfig[1].qualifyContextualPaths=$scope.contextObj.qualifyContextualPaths,doServiceCalls(obj)},500)},$(".fundamentalMeaning").click(function(){$(this).hasClass("collapsed")?prepareSliders("FM"):clearSliders("FM")}),$(".knowledgeCollection").click(function(){$(this).hasClass("collapsed")?(prepareSliders("KC"),
checkForSearchInAnsw()):clearSliders("KC")}),$(".machinelearning").click(function(){$(this).hasClass("collapsed")?(checkMultipIntentModel(),$scope.multipIntentModels.configurationValue||prepareSliders("ML")):clearSliders("ML")}),$(".rankingResolverEngine").click(function(){$(this).hasClass("collapsed")?prepareSliders("RR"):clearSliders("RR")}),$(".advConfigurations").click(function(){$timeout($(this).hasClass("collapsed")?function(){$scope.registerCustomSliders()}:function(){clearSliders("advConfig")})}),autoTrainStatus(),$scope.$emit("nestedComponentLoaded",{id:"mlThreshold",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$(".faqSearchLink").popover({html:!0,content:'<p class="content">'+i18n.i18nString("you_may_host_custom")+'<span> <a class="knowmore" target="_blank" href="https://developer.kore.ai/docs/bots/nlp/knowledge-graph/#Search_by_Answer">'+i18n.i18nString("know_more")+"</a></span></p>",trigger:"hover",delay:{hide:1500}}),$(".manageLongResponse").popover({html:!0,content:'<p class="content">'+i18n.i18nString("you_may_host_custom")+'<span> <a class="knowmore" target="_blank" href="https://developer.kore.ai/docs/bots/nlp/knowledge-graph/#Search_by_Answer">'+i18n.i18nString("know_more")+"</a></span></p>",trigger:"hover",delay:{hide:1500}}),$scope.preventEvent=function(e){e.stopPropagation(),e.preventDefault()},$('[data-toggle="popover"]').popover(),$scope.addCustom=function(){var _obj={configurationKeyName:"",isCustom:!0,nlpEngine:"",value:"",invalidPattern:!0};$scope.savedConfigurations.push(_obj),$scope.invalidPattern=!0,$scope.invalidCustomValue=!0},$scope.addCustomCM=function(){var _obj={configurationKeyName:"",isCustom:!0,nlpEngine:"",value:"",invalidPattern:!0};$scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType&&$scope.savedConfigurationsCM.push(_obj),$scope.invalidPattern=!0,$scope.invalidCustomValue=!0},$scope.registerCustomSliders=function(){if($scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType){var customSlidersCM=_.filter($scope.savedConfigurationsCM,{uiComponent:"slider"});angular.forEach(customSlidersCM,function(slider){setTimeout(function(){advancedConfigSliderCM(slider)},200)})}else{var customSliders=_.filter($scope.savedConfigurations,{uiComponent:"slider"});angular.forEach(customSliders,function(slider){setTimeout(function(){advancedConfigSlider(slider)},200)})}};var deRegisterCustomSliders=function(){var customSliders=_.filter($scope.savedConfigurations,{uiComponent:"slider"});angular.forEach(customSliders,function(slider){setTimeout(function(){$("#"+slider.configurationKeyName).slider().off("slideStop "),$("#"+slider.configurationKeyName).slider().off("slide")},200)})},deRegisterCustomSlidersCM=function(){if($scope.multipIntentModels.configurationValue&&$scope.multipIntentModels.formType){var customSlidersCM=_.filter($scope.savedConfigurationsCM,{uiComponent:"slider"});angular.forEach(customSlidersCM,function(slider){setTimeout(function(){$("#"+slider.configurationKeyName+"CM").slider().off("slideStop "),$("#"+slider.configurationKeyName+"CM").slider().off("slide")},200)})}};$scope.checkNetworkTypeConfig=function(config){var type=$scope.networkTypeList.value;return checkMLSettingCount(type),"SGD_V2"===$scope.intentParams.type?!1:("featureExtraction"!==config&&"n_gram"!==config||"LSTM"!==type&&"MLP-WordEmbeddings"!==type&&"CNN"!==type&&"Transformer"!==type)&&("stopWords"!==config&&"entityPlaceHolders"!==config||"Transformer"!==type)?!0:!1},loadCustomConfigurations(),$scope.customConfigurations=function(cell,type){cell&&($scope.multipIntentModels.selectedModel=cell),$scope.multipIntentModels.intentParams=angular.copy(cell.intentParams),updateCustomModelConfigs(cell,type),cell&&cell.intentParams&&($scope.multipIntentModels.intentParams.usePlaceholders=cell.intentParams.usePlaceholders,$scope.multipIntentModels.intentParams.useStopwords=cell.intentParams.useStopwords),$timeout(function(){$scope.openModalSlider("#customConfigurations"),$timeout(function(){prepareSliders("CM"),$scope.registerCustomSliders()})})},$scope.closeCustomConfigurations=function(){$timeout(function(){$scope.closeModalSlider("#customConfigurations")}),getMLParams(),formReset()},$scope.updateCustomModel=function(){var _payload={dialogIntents:[],isDefault:!1,intentParams:{},nerParams:$scope.multipIntentModels.nerParams,intentData:{},streamId:$scope.selectedStream._id,language:"en",state:"configured",type:3,name:$scope.multipIntentModels.name,advancedMLConfigurations:[],exactMatchThreshold:95,minThreshold:0,maxThreshold:0,__v:0};if($scope.multipIntentModels.selectedModel&&$scope.multipIntentModels.selectedModel._id&&(_payload.intentData=$scope.multipIntentModels.selectedModel.intentData,_payload.language=$scope.multipIntentModels.selectedModel.language,_payload.type=$scope.multipIntentModels.selectedModel.type,_payload.advancedMLConfigurations=$scope.multipIntentModels.selectedModel.advancedMLConfigurations,_payload.exactMatchThreshold=$scope.multipIntentModels.selectedModel.exactMatchThreshold,_payload.minThreshold=$scope.multipIntentModels.selectedModel.minThreshold,_payload.maxThreshold=$scope.multipIntentModels.selectedModel.maxThreshold),$scope.multipIntentModels.dialogIntentsList.length&&$scope.multipIntentModels.dialogIntentsList.forEach(function(item){-1===_payload.dialogIntents.indexOf(item.refId)&&_payload.dialogIntents.push(item.refId)}),obj&&obj.confidenceConfig&&(_payload.exactMatchThreshold=obj.confidenceConfig[0].exactMatchThreshold,_payload.minThreshold=obj.confidenceConfig[0].minThreshold,_payload.maxThreshold=obj.confidenceConfig[0].maxThreshold),$scope.multipIntentModels.intentParams&&(_payload.intentParams=$scope.multipIntentModels.intentParams),$scope.mlthreshold&&$scope.mlthreshold.stopWords&&(_payload.intentData.stopwords=$scope.mlthreshold.stopWords.join(" ")),"default"!==$scope.multipIntentModels.formType){if(""===$scope.multipIntentModels.name.trim())return void NotificationService.notify("Group name is required","warning");_payload.name=$scope.multipIntentModels.name.trim()}if($scope.multipIntentModels.nerParams&&$scope.multipIntentModels.nerParams.type&&(_payload.nerParams=$scope.multipIntentModels.nerParams),"new"===$scope.multipIntentModels.formType||"clone"===$scope.multipIntentModels.formType){if($scope.savedConfigurationsCM){var advdConf1=[];$scope.savedConfigurationsCM.forEach(function(item){item&&item._id?advdConf1.push({_id:item._id,configurationKeyName:item.configurationKeyName,nlpEngine:item.nlpEngine,configurationValue:item.value}):advdConf1.push({configurationKeyName:item.configurationKeyName,nlpEngine:item.nlpEngine,configurationValue:item.value})}),$scope.networkTypeList&&advdConf1.push({configurationKeyName:$scope.networkTypeList.configurationKeyName,nlpEngine:$scope.networkTypeList.nlpEngine,configurationValue:$scope.networkTypeList.value||$scope.networkTypeList.defaultValue}),_payload.advancedMLConfigurations=advdConf1}BTStreamsService.createCustomModel($scope.selectedStream._id,_payload).then(function(response){response&&response.data&&(NotificationService.notify(i18n.i18nString("collection_created"),"success"),$scope.closeCustomConfigurations(),autoTrainStatus())},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}else if("update"===$scope.multipIntentModels.formType||"default"===$scope.multipIntentModels.formType){if($scope.savedConfigurationsCM){var advdConf2=[];$scope.savedConfigurationsCM.forEach(function(item){item&&item._id?advdConf2.push({_id:item._id,configurationKeyName:item.configurationKeyName,nlpEngine:item.nlpEngine,configurationValue:item.value}):advdConf2.push({configurationKeyName:item.configurationKeyName,nlpEngine:item.nlpEngine,configurationValue:item.value})}),$scope.networkTypeList&&($scope.networkTypeList._id?advdConf2.push({_id:$scope.networkTypeList._id,configurationKeyName:$scope.networkTypeList.configurationKeyName,nlpEngine:$scope.networkTypeList.nlpEngine,configurationValue:$scope.networkTypeList.value||$scope.networkTypeList.defaultValue}):advdConf2.push({configurationKeyName:$scope.networkTypeList.configurationKeyName,nlpEngine:$scope.networkTypeList.nlpEngine,configurationValue:$scope.networkTypeList.value||$scope.networkTypeList.defaultValue})),_payload.advancedMLConfigurations=advdConf2}var customId=$scope.multipIntentModels.selectedModel._id;customId||NotificationService.notify("customId not found!!","error"),BTStreamsService.updateCustomModel($scope.selectedStream._id,customId,_payload).then(function(response){response&&response.data&&(NotificationService.notify(i18n.i18nString("collection_updated"),"success"),$scope.closeCustomConfigurations(),autoTrainStatus())},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error")})}},$scope.isCustomFormValid=function(){return!0},$scope.openEnableMultiIntents=function(){$element.find("#enableMultiIntents").removeClass("fade").addClass("show")},$scope.openDisableMultiIntents=function(){$element.find("#disableMultiIntents").removeClass("fade").addClass("show")},$scope.closeModalMultiIntents=function(type,currConfig){$element.find("#disableMultiIntents").removeClass("show").addClass("fade"),$element.find("#enableMultiIntents").removeClass("show").addClass("fade"),$element.find("#deleteMultiIntents").removeClass("show").addClass("fade"),$element.find("#configCannotDel").removeClass("show").addClass("fade"),("enable"===type||"disable"===type)&&checkMultipleIntentToggle()},$scope.confirmMultiIntent=function(){editConfigurations($scope.loadConfiguration,"","","ML"),$scope.closeModalMultiIntents()},$scope.openDeleteConfirm=function(cell,index){return $scope.loadConfiguration=cell,$scope.loadConfiguration.isDefault?void $element.find("#configCannotDel").removeClass("fade").addClass("show"):void $element.find("#deleteMultiIntents").removeClass("fade").addClass("show")},$scope.deleteDialogIntentModel=function(){var customId=$scope.loadConfiguration._id;BTStreamsService.deleteDialogIntentModel($scope.selectedStream._id,customId).then(function(response){response&&response.data&&(NotificationService.notify(i18n.i18nString("collection_deleted"),"success"),$scope.closeModalMultiIntents(),getMLParams())},function(err){err&&err.data&&err.data.errors?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("some_thing_wrong_label"),"error"),$scope.closeModalMultiIntents()})},$scope.addDialogIntent=function(intent,index){-1==$scope.multipIntentModels.dialogIntentsList.indexOf(intent)&&$scope.multipIntentModels.dialogIntentsList.push(intent)},$scope.delDialogIntent=function(intent,index){$scope.multipIntentModels.dialogIntentsList.splice(index,1)},$scope.dialogRefIdObj=function(refId,item){var findObj=$scope.getDialogIntents.find(function(item){return item?item.refId===refId:void 0});return findObj?(item&&(findObj.defaultName=item.name),findObj):{}},$scope.identifyDefaultDialog=function(intent){var name=null;return intent&&intent.defaultName&&(name=intent.defaultName),name},$scope.getLanguageNameByCode=function(){if($scope.supportedLanguages&&$scope.supportedLanguages.length){var findLang=$scope.supportedLanguages.find(function(item){return item.value===$scope.currLang.langVal});findLang?$scope.currLang.langName=findLang.name:$scope.currLang.langName="---"}},$scope.init=function(){getDialogs().then(function(data){if(data&&data.length){var obj=_.uniq(data,function(x){return x.name});obj?$scope.getDialogIntents=obj:$scope.getDialogIntents=[]}getMLParams()},function(err){NotificationService.notify(i18n.i18nString("unable_fetch_dialogs"),"error")}),$scope.getLanguageNameByCode()},$scope.init()}]),_module.filter("configFilter",function(){return function(data,args){var list=args.list;return list&&list.length&&list.forEach(function(selectedCon){var findIndex=data.findIndex(function(config){return config.configurationKeyName===selectedCon.configurationKeyName});-1!==findIndex&&data.splice(findIndex,1)}),data}})}(angular),function(ng){"use strict";var _module=ng.module("patterns-module",[]);_module.controller("PatternsModuleCtrl",["$window","$element","$scope","BTStreamsService","$workflowService","BTActionsService","BTAlertsService","BTFlowtaskService","_constants_","NotificationService","$q","$timeout","$filter","$location","indexerUtil","env_conf","accessControlService","$rootScope","$applicationService","i18n","mixPanel",function($window,$element,$scope,BTStreamsService,$workflowService,BTActionsService,BTAlertsService,BTFlowtaskService,_constants_,NotificationService,$q,$timeout,$filter,$location,indexerUtil,env_conf,accessControlService,$rootScope,$applicationService,i18n,mixPanel){function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}function indexUpdateForTaskPatterns(mode){$scope.taskPatternsObject=angular.copy($scope.initialObject),$scope.allTasks=$scope.tasks,$scope.fieldPatternsLength=_.filter($scope.allTasks,function(data){return data.fields&&data.fields.length?data:void 0}),$scope.tasks.map(function(val){$scope.taskPatternsObject[val.name[0].toLowerCase()]&&$scope.taskPatternsObject[val.name[0].toLowerCase()].push(val)}),$scope.views.taskPatterns&&($scope.indexObject=angular.copy($scope.taskPatternsObject)),$scope.intentPatternsObject=_.uniq($scope.intentPatternsObject.concat($scope.tasks),"_id"),$scope.intentPatternsObject=_constants_.getAlphabeticallySortedArray($scope.intentPatternsObject,"name")}function prepareFieldIndexObject(){var fieldsArray=[];$scope.tasks.map(function(task){task.fields.map(function(field){var valueOfField=task.fieldPatterns&&task.fieldPatterns[field.title]?task.fieldPatterns[field.title].map(function(pattern){return pattern.original}):[];field.patterns=valueOfField,field.oldPatterns=task.fieldPatterns&&task.fieldPatterns[field.title];var object={task:task,fieldId:field.title,field:field};fieldsArray.push(object)})}),fieldsArray=$filter("orderBy")(fieldsArray,"fieldId"),$scope.fieldPatternsObject=angular.copy($scope.initialObject),$scope.allFields=fieldsArray,$scope.allFields=_.uniq($scope.allFields,function(p){return p.task._id}),$scope.fieldPatternsObject=fieldsArray||[],$scope.views.fieldPatterns&&($scope.indexObject=angular.copy($scope.fieldPatternsObject))}function indexUpdateForEntitiesOrIntentsPatterns(mode){$scope.allIntent=$scope.intents,$scope.allEntity=$scope.entities,"intentPatterns"===mode?($scope.intentPatternsObject=angular.copy($scope.initialObject),$scope.intentPatternsObject=$scope.intents,$scope.intentPatternsObject=$scope.intentPatternsObject.concat($scope.tasks),$scope.intentPatternsObject=_constants_.getAlphabeticallySortedArray($scope.intentPatternsObject,"name")):($scope.entityPatternsObject=$scope.entities,$scope.atMentionsData=[],$.each($scope.entityPatternsObject,function(i,entity){if("composite"!==entity.entityType){var _object={label:entity.name};$scope.atMentionsData.push(_object)}})),$scope.views.intentPatterns&&($scope.indexObject=angular.copy($scope.intentPatternsObject)),$scope.views.entityPatterns&&($scope.indexObject=angular.copy($scope.entityPatternsObject))}function updateIndexHeader(mode){switch(mode){case"taskPatterns":$scope.indexObject=angular.copy($scope.taskPatternsObject);break;case"fieldPatterns":$scope.indexObject=angular.copy($scope.fieldPatternsObject);break;case"intentPatterns":$scope.indexObject=angular.copy($scope.intentPatternsObject);break;case"entityPatterns":$scope.indexObject=angular.copy($scope.entityPatternsObject)}}function loadPatterns(){$scope.taskPatternsLoading=!0,$scope.tasks.map(function(task){delete task.task_patterns}),BTStreamsService.getPatterns($scope.stream._id).then(function(res){res.data.map(function(pattern){var obj={};Object.keys(pattern).map(function(key){"resourceId"===key?obj._id=pattern.resourceId:(obj.name=key,obj.patterns=pattern[key])}),$scope.tasks.map(function(task){task._id===obj._id&&(task.task_patterns=ng.copy(obj.patterns))})}),$scope.taskPatternsLoading=!1,indexUpdateForTaskPatterns()},function(err){$scope.taskPatternsLoading=!1})}function addPattern(pattern,event,task){$scope.pattern={},$scope.pattern.show=!0,$scope.pattern.text=pattern,$scope.pattern.intent=task?task._id:"",$scope.pattern.showTaskPattern=!0,$timeout(function(){$(".add-pattern").modal("show")}),event&&(event.preventDefault(),event.stopPropagation())}function addFieldPattern(pattern,event,task){$scope.pattern={},$scope.pattern.show=!0,$scope.pattern.text=pattern,$scope.pattern.intent=task?task._id:"",$scope.pattern.showFieldPattern=!0,$timeout(function(){$(".add-field-pattern").modal("show")}),event&&(event.preventDefault(),event.stopPropagation())}function createPattern(task,text,isInlineMode){var payload={input:text,intend:task.name,resourceId:task._id};$scope.saving=!0,BTStreamsService.createPattern(streamId,payload).then(function(){isInlineMode||$scope.cancelAddPattern(),$scope.tPattern.newTaskPattern="",$scope.cancelTaskPatternId(),$scope.editTaskPattern=null,loadPatterns(),$scope.saving=!1,NotificationService.notify(i18n.i18nString("patrn_module_added_sucess"),"success")},function(err){var msg=getErrorMsg(err,i18n.i18nString("patrn_module_adding_field"));NotificationService.notify(msg,"error"),$scope.saving=!1})}function validateFieldPattern(value){return value&&value.split("*").length-1>=1?!0:!1}function goBack(){$location.path(window.appConfig.CONTEXT_PATH)}function getDataFromServer(id){getEntitiesAndIntents(),$q.all([BTAlertsService.getAlerts(id),BTActionsService.getActions(id)]).then(function(res){$workflowService.alertTasks(res[0].data),$workflowService.actionTasks(res[1].data),loadingEntities(id)})}function loadingEntities(id,task,callbackFun){var tasks=[];$scope.taskFieldPatternsLoading=!0,task&&tasks.push(task),tasks=tasks.concat($workflowService.alertTasks()),tasks=tasks.concat($workflowService.actionTasks()),$scope.findParenttasks(tasks),tasks=tasks.map(function(task){_.isArray(task.alertFieldsDefinition)?task.fields=_.clone(task.alertFieldsDefinition||[]):_.isArray(task.payloadField)&&_.isArray(task.queryField)&&(task.fields=(task.payloadField||[]).concat(task.queryField));var patterns=[];return Object.keys(task.fieldPatterns||{}).map(function(field){var valueOfField=[];valueOfField=task.fieldPatterns[field].map(function(pattern){return pattern.original}),valueOfField.length&&patterns.push({key:task.fieldPatterns[field].map(function(pattern){return pattern.key}),fieldName:field,value:valueOfField,oldPatterns:task.fieldPatterns[field]})}),task.field_patterns=patterns,task}),$scope.tasks=JSON.parse(JSON.stringify(tasks)),$scope.allTasks=$scope.tasks,callbackFun&&callbackFun(),$scope.taskFieldPatternsLoading=!1,prepareFieldIndexObject(),loadPatterns()}function pullRemovedPatterns(task,newTask){var removedOnes=[],addedOnes=[];task.fields.map(function(field,i){var newPattern=newTask.fields[i].patterns,oldPattern=field.patterns,removed=_.difference(oldPattern,newPattern),added=_.difference(newPattern,oldPattern);removed.length>0&&removedOnes.push({taskId:task._id,field:field.title,value:removed,patterns:field.oldPatterns}),added.length>0&&addedOnes.push({taskId:task._id,field:field.title,value:added})}),handlePatternAddition(addedOnes),handlePatternRemoval(removedOnes)}function handlePatternRemoval(patternsToBeRemoved){var patterns=[];patternsToBeRemoved.map(function(stalePattern){stalePattern.value.map(function(value){stalePattern.patterns.map(function(patternInfo){patternInfo.original==value&&patterns.push({taskId:stalePattern.taskId,field:stalePattern.field,patternId:patternInfo.key})})})}),patterns.map(function(pattern){$scope.deleteFieldPattern({_id:pattern.taskId},{key:pattern.patternId},pattern.field,!0)})}function handlePatternAddition(patternsToBeAdded){patternsToBeAdded.map(function(pattern){pattern.value.map(function(value){$scope.saveFieldPattern(pattern.taskId,pattern.field,value,!0)})})}function getEntitiesAndIntents(){resolveEntitiesOrIntents("intents"),resolveEntitiesOrIntents("entities")}function resolveEntitiesOrIntents(type,intent,callbackFun){$scope.entities=[],BTFlowtaskService.getEntitiesOrIntents(streamId,type).then(function(res){res.data&&("entities"===type?getFlowTasks().then(function(response){var entitiesList=$scope.entities.concat(res.data);$scope.dialogs=response.data;var _entitiesInDialogs=[];$.each($scope.dialogs,function(i,dialog){var _entitynodes=_.filter(dialog.nodes,{type:"entity"}),_entityIds=_.pluck(_entitynodes,"componentId");_entitiesInDialogs=_.union(_entitiesInDialogs,_entityIds)});$scope.entities=entitiesList,prepareEntityPatternsArray()},function(err){}):(intent&&($scope.intents=[]),$scope.intents=$scope.intents.concat(res.data),getFlowTasks().then(function(response){$scope.dialogs=response.data;var hiddenHelpNodes=_.filter($scope.dialogs,function(dialog){return dialog.isHidden}),hiddenDialogTasks=_.filter($scope.dialogs,function(dialog){return dialog.isDeleted}),hiddenHelpIds=_.pluck(hiddenHelpNodes,"_id"),hiddenDialogTasksIds=_.pluck(hiddenDialogTasks,"_id");$scope.intents.map(function(intent){-1!==$.inArray(intent.dialogId,hiddenHelpIds)&&(intent.isHidden=!0),-1!==$.inArray(intent.dialogId,hiddenDialogTasksIds)&&(intent.isDeleted=!0)})}),$scope.allIntent=$scope.intents,$scope.findParenttasks($scope.intents),preapareIntentsPatternsArray(),callbackFun&&callbackFun(),$timeout(function(){$scope.loadingPatterns=!1},400)))},function(error){})}function preapareIntentsPatternsArray(){$scope.intents.map(function(intent){intent.patternsArray=[],intent.patterns=intent.patterns||[],intent.patterns.forEach(function(msg){msg.original=decodePattern(msg.original)}),intent.patterns.map(function(pattern){intent.patternsArray.push(pattern.original)})}),indexUpdateForEntitiesOrIntentsPatterns("intentPatterns")}function prepareEntityPatternsArray(){$scope.entities.map(function(entity){entity.patternsArray=[],entity.patterns=entity.patterns||[],entity.patterns.forEach(function(msg){msg.original=decodePattern(msg.original)}),entity.patterns.map(function(pattern){entity.patternsArray.push(pattern.original)})}),indexUpdateForEntitiesOrIntentsPatterns("entityPatterns")}function getErrorMsg(err,defaultMsg){return err=err&&err.data,err&&err.errors&&err.errors[0]&&err.errors[0].msg||defaultMsg}$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.filterToggle=$workflowService.selectedStreamState();var _notSupportedTrainLanguages=["en","de","es","fr"];$scope.training=i18n.i18nString("training_label2"),$scope.train=i18n.i18nString("train"),$scope.alert=i18n.i18nString("alert"),$scope.action=i18n.i18nString("action_label_lowercase"),$scope.showTrain=!1,$scope.tasks=[];$scope.newpattern={},$scope.upgradedTasks=[],$scope.constants=_constants_,$scope.patternModuleObj={triggeredFromSelect:!1},$scope.stream=angular.copy($workflowService.selectedStream()),$scope.intentSelect2Options={maxTagLength:2048,sortable:!1},$scope.entitySelect2Options={maxTagLength:2048,sortable:!0};var streamId=$scope.stream._id;$scope.title=i18n.i18nString("pattern_name"),$scope.intents=[],$scope.entities=[],$scope.saving=!1,$scope.assetsBase=env_conf["assets-url"],$scope.closeIconDark=$scope.assetsBase+"icons/closeIconDark.svg",$scope.orIcon=$scope.assetsBase+"icons/orIcon.svg",$scope.minusCircle=$scope.assetsBase+"icons/minus-circle.svg",$scope.editTaskPatternId=null,$scope.editTaskPattern=null,$scope.saveTaskPatternIdIndex=null,$scope.editFieldPatternId=null,$scope.editFieldPattern=null,$scope.editIntentPatternId=null,$scope.editIntentPattern=null,$scope.editEntityPatternId=null,$scope.editEntityPattern=null,$scope.helpIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/helpIcon.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.searchClose=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.pencilIcon=env_conf["context-url"]+"/assets/icons/pencilIcon.svg",$scope.trashIcon=env_conf["context-url"]+"/assets/icons/trashIcon.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.initialObject=[{a:[],b:[],c:[],d:[],e:[],f:[],g:[],h:[],i:[],j:[],k:[],l:[],m:[],n:[],o:[],p:[],q:[],r:[],s:[],t:[],u:[],v:[],w:[],x:[],y:[],z:[],other:[]}],$scope.taskPatternsObject=angular.copy($scope.initialObject),$scope.fieldPatternsObject=angular.copy($scope.initialObject),$scope.entityPatternsObject=[],$scope.intentPatternsObject=angular.copy($scope.initialObject),$scope.indexObject=angular.copy($scope.initialObject),$scope.iPatterns={},$scope.ePatterns={},$scope.tPattern={},$scope.allTasks=[],$scope.clickedTaskIndex=-1,$scope.clickedFieldIndex=-1,$scope.clickedIntentIndex=-1,$scope.clickedEntityIndex=-1;var dummy_traitAnd=[];if($scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.trainStatus={success:!1,failed:!1,saving:!1},$scope.patternsCB={},setTimeout(function(){$rootScope.$emit("pefectScrollUpdate")},2e3),$scope.onClickTaskindex=function(task,index){var taskId=task._id;"indevelopment"===$scope.filterToggle?"published"==task.state?($scope.currentTask=task,$scope.currentTab="task",$scope.currenttaskIndex=index,NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"))):(setTimeout(function(){"VIEW"!==$scope.displayMode&&$(".newPatternInput").trigger("focus")},350),$scope.clickedTaskIndex=index,$scope.selectedTask=_.filter($scope.allTasks,{_id:taskId})[0],$scope.openPatternModal("pattern"),$scope.patternsCB.loadingPatterns=!0,$scope.patternsCB.onClickTask($scope.selectedTask)):"published"===$scope.filterToggle&&($scope.clickedTaskIndex=index,$scope.editIntentPatternId=taskId)},$scope.selectTask=function(task){$scope.selectedTask=task},$scope.onClickFieldindex=function(task,index){var taskId=task._id;taskId==$scope.clickedFieldIndex?($scope.clickedFieldIndex=-1,$scope.selectedField=null):($scope.clickedFieldIndex=taskId,$scope.selectedField=$scope.allFields[taskId],$scope.selectedFieldPatterns=task)},$scope.selectField=function(field){$scope.selectedField=$scope.fieldPatternsObject.filter(function(item){return item.task.name===field.task.name})},$scope.selectIntent=function(intent){$scope.selectedIntent=intent},$scope.onClickEntityindex=function(taskId,index){if(taskId==$scope.clickedEntityIndex){$scope.clickedEntityIndex=-1,$scope.editEntityPatternId=null;var entity=_.filter($scope.allEntity,{_id:taskId})[0];entity=$scope.selectedEntity,$.each($scope.entityPatternsObject,function(i,entityCopy){taskId==entityCopy._id&&($scope.entityPatternsObject[i]=_.merge($scope.entityPatternsObject[i],$scope.selectedEntity))}),$scope.entities=$scope.entityPatternsObject}else"indevelopment"===$scope.filterToggle&&($scope.clickedEntityIndex=taskId,$scope.selectedEntity=_.filter($scope.allEntity,{_id:taskId})[0]);$scope.selectedEntity=_.filter($scope.allEntity,{_id:taskId})[0],$scope.openPatternModal("patterns"),$scope.patternsCB.onClickEntity($scope.selectedEntity)},$scope.selectEntity=function(entity){$scope.selectedEntity=entity},$(".patternSearchIcon").click(function(){$(this).hasClass("fa-remove")?($(this).removeClass("fa-remove"),$(this).addClass("fa-search"),$(".searchPattern").removeClass("searchExpand"),$scope.gSearchCb.search=""):(setTimeout(function(){$(".patternSearch").trigger("focus")},350),$(this).addClass("fa-remove"),$(this).removeClass("fa-search"),$(".searchPattern").addClass("searchExpand"))}),$scope.hideUi||$("#btPatternsModal").modal("show"),!_.isObject($scope.stream)||_.isObject($scope.stream)&&0===Object.keys($scope.stream).length)return void goBack();$scope.validateFieldPattern=function(){return{test:function(value){return value&&value.split("*").length-1===1?!0:!1}}}(),$scope.editFieldPatternObject=function(task,fieldId,index,event){$scope.fieldPatternName=fieldId,"indevelopment"===$scope.filterToggle&&("published"==task.state?($scope.currentTask=task,$scope.currentTab="field",$scope.currentFieldId=fieldId,$scope.currentIndex=index,NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"))):($(".fieldPatterns").removeClass("fieldPatternsaddStyleClass"),$scope.clickedFieldId==fieldId?($scope.clickedFieldId=-1,$scope.tempClickedFieldId=-1):(setTimeout(function(){$(".fieldPatternInput").trigger("focus")},350),$scope.cancelFieldPatternObject(),$scope.editFieldPatternId=task._id+fieldId,$scope.tempClickedFieldId=task._id+fieldId,$scope.clickedFieldId=fieldId,$(".fieldParentDiv"+index).addClass("fieldPatternsaddStyleClass"),$timeout(function(){$(".fieldPattern-select2 .select2-input").focus()},500)),event&&setTimeout(function(){var ele=event.currentTarget,_container=$(".bt-patterns").closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=$(ele.parentElement).offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"fast")}},350))),$scope.editFieldPattern=angular.copy(task),$scope.openPatternModal("patterns"),$scope.patternsCB.onClickField($scope.editFieldPattern,fieldId)},$scope.editTaskPatternObject=function(task){$scope.editTaskPatternId!==task._id?($scope.cancelTaskPattern(!1),$scope.editTaskPattern=angular.copy(task),$scope.editTaskPatternId=task._id,$scope.saveTaskPatternIdIndex!==$scope.editTaskPatternId&&($scope.saveTaskPatternIdIndex=null)):$scope.cancelTaskPattern(!1)},$scope.saveTaskPatternId=function(task){$scope.cancelTaskPatternId(),$scope.editTaskPattern=angular.copy(task),$scope.saveTaskPatternIdIndex=task._id,$scope.editTaskPatternId=task._id,$timeout(function(){$(".patternInput").focus()},250)},$scope.cancelTaskPatternId=function(){$scope.saveTaskPatternIdIndex=null,$scope.resetTaskPattern()},$scope.editEntityPatternObject=function(entity,event){return"published"==entity.status?void($scope.editEntityPatternId=entity._id):($scope.cancelEntityPattern(),$scope.editEntityPattern=angular.copy(entity),$scope.editEntityPatternId=entity._id,$timeout(function(){$(".entityPattern-select2 .select2-input").focus()},350),void setTimeout(function(){var ele=event.currentTarget,_container=$(".bt-patterns").closest(".ps-container");if(_container&&_container.offset()){var _scrollHeight=$(ele.parentElement).offset().top-_container.offset().top+_container.scrollTop();_container.animate({scrollTop:_scrollHeight},"fast")}},350))},$scope.onClickIntentindex=function(intent,event,index,selectedType,intentId){event&&event.stopPropagation();var type=(selectedType||"patterns")+intentId;$scope.traitRules={},"indevelopment"===$scope.filterToggle?"published"==intent.status?($scope.currentTask=intent,$scope.selectedType=selectedType,$scope.clickedIntentIndex=index,NotificationService.alert("",$scope.upgrade,{okText:i18n.i18nString("upgrade")},"",void 0,i18n.i18nString("add_utter_published_noty"))):($scope.dummyTraitOrCondition=[],$scope.dummyTraitOrCondition.push(angular.copy(dummy_traitAnd)),$scope.selectIntentSection=type,$scope.traitRules.traitMappings=intent.traitRules||[],$scope.clickedIntentIndex=index,$scope.editIntentPatternId=intentId,$scope.selectedTask=_.filter($scope.allIntent,{_id:intentId})[0],$scope.openPatternModal(selectedType),"patterns"===selectedType?$scope.patternsCB.onClickTask($scope.selectedTask):"traits"===selectedType&&$scope.patternsCB.onClickTraits($scope.selectedTask,"",$scope.traitRules)):"published"===$scope.filterToggle&&($scope.editIntentPatternId=intentId,$scope.traitRules.traitMappings=intent.traitRules||[],$scope.selectedTask=_.filter($scope.allIntent,{_id:intentId})[0],$scope.openPatternModal(),"patterns"===selectedType?$scope.patternsCB.onClickTask($scope.selectedTask):"traits"===selectedType&&$scope.patternsCB.onClickTraits($scope.selectedTask,"",$scope.traitRules))},$scope.openPatternModal=function(selectedType){
if($(".pattern-modal").modal("show"),selectedType){var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};"traits"===selectedType?mixPanel.postEvent("Add Rule",_botInfo):mixPanel.postEvent("Add Pattern",_botInfo)}},$timeout(function(){$scope.isTaskPatternsAvailable=function(currTasks){var available=!1;return currTasks.forEach(function(task,key){if("published"==task.state&&"published"==$scope.filterToggle){if(task.name.length>0)return void(available=!0)}else if("published"!=$scope.filterToggle&&"published"!=task.state&&task.name.length>0)return void(available=!0)}),available}},350),$scope.cancelTaskPattern=function(resetIndex){$scope.editTaskPatternId=null,resetIndex&&($scope.editTaskPattern=null),$scope.resetTaskPattern()},$scope.resetTaskPattern=function(){var indexTask=-1;$scope.tasks.map(function(task,index){task.newTaskPattern=null,$scope.editTaskPattern&&task._id===$scope.editTaskPattern._id&&(indexTask=index)}),-1!=indexTask&&($scope.tasks[indexTask]=$scope.editTaskPattern,indexUpdateForTaskPatterns())},$scope.cancelFieldPatternObject=function(resetIndex){$scope.editFieldPattern=null,$scope.editFieldPatternId=null;var indexTask=-1;$scope.tasks.map(function(task,index){$scope.editFieldPattern&&task._id===$scope.editFieldPattern._id&&(indexTask=index)}),-1!=indexTask&&($scope.tasks[indexTask]=$scope.editFieldPattern,prepareFieldIndexObject())},$scope.filterToggleTask=function(task){var taskType=$scope.getTaskType(task),key="state";return task&&"DialogIntent"===task.type?key="status":task&&"DialogEntity"===task.type&&(key="status"),"published"===$scope.filterToggle?"published"===task[key]?!0:!1:"published"!==task[key]||"alert"!==taskType&&"action"!==taskType&&"flowtask"!==taskType?"published"!==task[key]?!0:!1:task.isParent||task.isDeleted?!1:!0},$scope.cancelEntityPattern=function(resetIndex){resetIndex&&($scope.editEntityPatternId=null);var indexEntity=-1;$scope.entities.map(function(entity,index){$scope.editEntityPattern&&entity._id===$scope.editEntityPattern._id&&(indexEntity=index)}),-1!=indexEntity&&($scope.entities[indexEntity]=$scope.editEntityPattern,indexUpdateForEntitiesOrIntentsPatterns("entityPatterns"))},$scope.cancelIntentPattern=function(resetIndex){resetIndex&&($scope.editIntentPatternId=null);var indexIntent=-1;$scope.intents.map(function(intent,index){$scope.editIntentPattern&&intent._id===$scope.editIntentPattern._id&&(indexIntent=index)}),-1!=indexIntent&&indexUpdateForEntitiesOrIntentsPatterns("intentPatterns")},$scope.saveTaskPatternsObject=function(task){task.newTaskPattern&&null!==task.newTaskPattern&&""!==task.newTaskPattern?createPattern($scope.editTaskPattern,task.newTaskPattern,!0):null!==$scope.tPattern.newTaskPattern&&""!==$scope.tPattern.newTaskPattern&&createPattern(task,$scope.tPattern.newTaskPattern,!0)},$scope.saveFieldPatternsObject=function(newTask){return validateFieldPattern($scope.tPattern.newTaskPattern)?(pullRemovedPatterns(angular.copy($scope.editFieldPattern),newTask),$scope.editFieldPatternId=null,void($scope.editFieldPattern=null)):void NotificationService.notify(i18n.i18nString("patrn_module_valid_field_err"),"error")},$scope.removeEditModeEntity=function(index){index>=0&&($(".hidingEntityPatterns"+index).removeClass("hide"),$(".editingEntityPatterns"+index).addClass("hide"))},$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.moveScrollToThis=function(key){var keyEle="";keyEle=$scope.views.taskPatterns?"#task"+key:$scope.views.fieldPatterns?"#field"+key:$scope.views.intentPatterns?"#intent"+key:"#entity"+key,indexerUtil.isElementVisible(keyEle,!0,"#botPatternsScroll")||$("#botPatternsScroll").animate({scrollTop:$(keyEle).position().top},"slow")},$scope.editTaskPattern=function(selectedTask,index){selectedTask.task_patterns[index].original=selectedTask.task_patterns[index].original.replace(selectedTask.task_patterns[index].original,$scope.tPattern.editTaskPattern);for(var payload={patterns:[]},i=0;i<$scope.selectedTask.task_patterns.length;i++){var pattern={};pattern.intend=$scope.selectedTask.task_patterns[i].intend,pattern.key=$scope.selectedTask.task_patterns[i].key,pattern.input=$scope.selectedTask.task_patterns[i].original,payload.patterns.push(pattern)}payload.resourceId=$scope.selectedTask._id,BTStreamsService.taskPattern($scope.stream._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("patrn_module_pattern_updated_success"),"success"),$(".hidingIntentPatterns"+index).removeClass("hide"),$(".editingIntentPatterns"+index).addClass("hide")})},$scope.removeEditMode=function(index){index>=0&&($(".hidingIntentPatterns"+index).removeClass("hide"),$(".editingIntentPatterns"+index).addClass("hide"))},$scope.editFieldPatternData=function(selectedTask,index){selectedTask.fieldPatterns[$scope.fieldPatternName][index].original=selectedTask.fieldPatterns[$scope.fieldPatternName][index].original.replace(selectedTask.fieldPatterns[$scope.fieldPatternName][index].original,$scope.tPattern.editTaskPattern);for(var payload={fieldPatterns:[]},i=0;i<selectedTask.fieldPatterns[$scope.fieldPatternName].length;i++){var pattern={};pattern.key=selectedTask.fieldPatterns[$scope.fieldPatternName][i].key,pattern.input=selectedTask.fieldPatterns[$scope.fieldPatternName][i].original,payload.fieldPatterns.push(pattern)}payload.fieldName=$scope.fieldPatternName,payload.resourceId=selectedTask._id,BTStreamsService.fieldPatternSortOrEdit($scope.stream._id,payload).then(function(res){NotificationService.notify(i18n.i18nString("patrn_module_pattern_updated_success"),"success"),$(".hidingIntentPatterns"+index).removeClass("hide"),$(".editingIntentPatterns"+index).addClass("hide")})},$scope.processFieldPattern=function(inputArr){var outArray=[];return inputArr.forEach(function(input){input&&(input=input.split("_*").join("~~FP~~"),input=input.split("* ").join(""),input=input.split("~~FP~~").join("*"),outArray.push(input))}),outArray},$scope.steps={currentPatternStage:0,currentFieldPatternStage:0},$scope.views={taskPatterns:!1,fieldPatterns:!1,intentPatterns:!0,entityPatterns:!1},$scope.fieldPatternSearch="",$scope.taskPatternSearch="",$scope.currentScreen="",$scope.showType=function(screen){Object.keys($scope.views).map(function(key){$scope.views[key]=!1,$(".patternsScrollTop").scrollTop(0)}),$scope.views[screen]=!0,$scope.fieldPatternSearch="",$scope.taskPatternSearch="",updateIndexHeader(screen),$scope.currentScreen=screen,$scope.addFieldPatternClass=function(){$timeout(function(){$(".fieldPatterns").addClass("removeFieldPatternsBorders")},350)},$timeout(function(){$scope.selectedTask=null,$scope.clickedTaskIndex=-1,$scope.clickedFieldId=null,$scope.clickedFieldId=-1,$scope.clickedIntentIndex=-1,$scope.selectedIntent=null,$scope.editIntentPatternId=null,$scope.clickedEntityIndex=-1,$scope.selectedEntity=null,$scope.editEntityPatternId=null,$scope.selectIntentSection=null,$scope.selectedIntent=null},200)},$scope.gSearchCb.showType=$scope.showType,$workflowService.storeSearchQry().userSearchQueryFlag?$scope.gSearchCb.search=$workflowService.storeSearchQry().searchQry:$scope.gSearchCb.search="",$scope.context=$scope.context||{},$scope.context.addPattern=addPattern,$scope.context.addFieldPattern=addFieldPattern,$scope.$watch("context",function(newVal,oldVal){_.isObject(newVal)&&($scope.context.addPattern=addPattern,$scope.context.addFieldPattern=addFieldPattern)}),$scope.clearSearch=function(){$scope.$parent.goBack(".btPatternsModal"),$scope.$parent.resetDisplayTabID(),$timeout(function(){$scope.gSearchCb.search=""},150)},$scope.$on(),$scope.cancelAddPattern=function(){$(".add-pattern").modal("hide"),$scope.pattern.show=!1,$scope.pattern.showTaskPattern=!1},$scope.cancelFieldPattern=function(){},$scope.saveAddPattern=function(){var task=$scope.getSelectedTaskForPattern();createPattern(task,$scope.pattern.text,!1)},$scope.showPatterns=function(index){$scope.steps.currentPatternStage==index?$scope.steps.currentPatternStage=-1:$scope.steps.currentPatternStage=index},$scope.showFieldPatterns=function(index){$scope.steps.currentFieldPatternStage==index?$scope.steps.currentFieldPatternStage=-1:$scope.steps.currentFieldPatternStage=index},$scope.getSelectedTaskForPattern=function(){var task=$scope.tasks.filter(function(task){return task._id==($scope.pattern&&$scope.pattern.intent)})[0];return task},$scope.goBack=goBack;var getFlowTasks=function(){var deferred=$q.defer();return BTFlowtaskService.getFlowtaks($workflowService.selectedStream()._id).then(function(response){deferred.resolve(response)},function(err){deferred.reject(err)}),deferred.promise};$scope.upgrade=function(){$scope.isGlobalWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("upgrading_task_label");var taskType=$scope.getTaskType($scope.currentTask);$scope.upgradeWorkflow($scope.currentTask,taskType,$scope.selectedType,$scope.clickedIntentIndex)},$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?"action":task&&"DialogIntent"==task.type?"flowtask":""},$scope.upgradeWorkflow=function(task,type,selectedType,clickedIntentIndex){"alert"===type?BTAlertsService.upgradeBTAlert(task._id).then(function(response){BTAlertsService.upgradeMPAlert(task._id,response.data._id).then(function(upgradeRes){BTAlertsService.configured(upgradeRes.data._id).then(function(configRes){function callbackFun(){"task"===$scope.currentTab?$scope.onClickTaskindex(configRes.data[0],$scope.currenttaskIndex):"field"===$scope.currentTab&&$scope.editFieldPatternObject(configRes.data[0],$scope.currentFieldId,$scope.currentIndex)}$scope.intentPatternsObject[$scope.currenttaskIndex].isParent=!0,loadingEntities(null,configRes.data[0],callbackFun),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type?BTActionsService.upgradeBTAction(task._id).then(function(response){BTActionsService.upgradeMPAction(task._id,response.data._id).then(function(upgradeRes){BTActionsService.configured(upgradeRes.data._id).then(function(configRes){function callbackFun(){"task"===$scope.currentTab?$scope.onClickTaskindex(configRes.data[0],currenttaskIndex):"field"===$scope.currentTab&&$scope.editFieldPatternObject(configRes.data[0],$scope.currentFieldId,$scope.currentIndex)}$scope.intentPatternsObject[$scope.currenttaskIndex].isParent=!0,loadingEntities(null,configRes.data[0],callbackFun),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,task.dialogId).then(function(res){function callbackFun(){$scope.onClickIntentindex(res.data.nodes[0],0,clickedIntentIndex,selectedType,res.data.nodes[0].componentId)}resolveEntitiesOrIntents("intents",res.data,callbackFun),$scope.isGlobalWorkProgress=!1,$scope.cancelIntentPattern(),$scope.editIntentPatternId=res.data.nodes[0].componentId,$timeout(function(){$(".intentPattern-select2 .select2-input").focus()},350)},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},$scope.updateFooterHeader=function(){return $scope.footerInfoTitle=i18n.i18nString("pattern_name"),$scope.footerHeaderId="bt-Patterns",$scope.footerPanelId="bt-Patterns-panel",$scope.nameDescription=i18n.i18nString("patrn_module_upgrade_task_desc"),!0},angular.element($window).on("resize",function(e){var height=$window.innerHeight;height-=210,$("#botPatternsScroll").css("height",height-70+"px"),$(".pattern-parentDiv").css("height",height+"px")});(function(){$scope.loadingPatterns=!0,getDataFromServer($scope.stream._id),$timeout(function(){angular.element($window).trigger("resize")})})();$scope.$emit("nestedComponentLoaded",{id:"patterns",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.trainIntents=function(){$scope.trainStatus.saving=!0,BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){res&&($scope.trainStatus.saving=!0,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!1,$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$broadcast("getProgressDockStatus"),NotificationService.notify(i18n.i18nString("bot_train"),"info"))},function(err){$scope.trainStatus.saving=!1,$scope.trainStatus.success=!1,$scope.trainStatus.failed=!0,err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})},$rootScope.$on("patternTrainFinished",function($event){$scope.trainStatus={success:!0,failed:!1,saving:!1},NotificationService.notify(i18n.i18nString("bot_trained_successfully"),"success")}),$rootScope.$on("patternTrainFailed",function($event){$scope.trainStatus={success:!1,failed:!0,saving:!1},NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")});var checkForTrain=function(){var _currentLanguage=$workflowService.currentLanguage();_notSupportedTrainLanguages.indexOf(_currentLanguage)>=0?$scope.showTrain=!1:$scope.showTrain=!0};checkForTrain(),$scope.patternsCB.getDataFromServer=getDataFromServer,$scope.patternsCB.updateIntentPattern=function(res){$scope.intentPatternsObject[$scope.clickedIntentIndex]=res}}])}(angular),function(ng){"use strict";var _module=ng.module("synonyms-module",[]);_module.controller("SynonymsModuleCtrl",["$window","$element","$scope","$workflowService","$location","$routeParams","BTStreamsService","$q","BTAlertsService","BTActionsService","BTFlowtaskService","$timeout","color","$filter","_constants_","NotificationService","form_util","indexerUtil","env_conf","accessControlService","$rootScope","$interval","i18n","mixPanel",function($window,$element,$scope,$workflowService,$location,$routeParams,BTStreamsService,$q,BTAlertsService,BTActionsService,BTFlowtaskService,$timeout,color,$filter,_constants_,NotificationService,form_util,indexerUtil,env_conf,accessControlService,$rootScope,$interval,i18n,mixPanel){function synnoymsAutoTrainStatus(){BTStreamsService.getMLSynonym($workflowService.selectedStream()._id).then(function(res){(res.data.intentParams&&res.data.intentParams.hasOwnProperty("useSynonyms")||$scope.stream&&$scope.stream.confidenceConfigs&&$scope.stream.confidenceConfigs.length)&&($scope.enableSynonyms=res.data.intentParams&&res.data.intentParams.useSynonyms?res.data.intentParams.useSynonyms:$scope.stream.confidenceConfigs&&$scope.stream.confidenceConfigs.length&&$scope.stream.confidenceConfigs[1].useBotSynonyms?$scope.stream.confidenceConfigs[1].useBotSynonyms:!1),BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){$scope.enableSynonyms&&res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithSynonyms")&&!res.data.isMlInSyncWithSynonyms?$scope.trainShow=!0:$scope.trainShow=!1,"Finished"===res.data.trainingStatus?($scope.showTrainSavingSyn=!1,$scope.trainStatus.saving=!1):"Failed"===res.data.trainingStatus?($scope.showTrainSavingSyn=!1,$scope.trainStatus.saving=!1):$scope.enableSynonyms?($scope.showTrainSavingSyn=!0,$scope.trainStatus.saving=!0):$scope.trainStatus.saving=!0},function(err){$scope.showTrainSavingSyn=!1,$scope.trainStatus.saving=!1;var _msg=i18n.i18nString("fetching_ml_status_err");NotificationService.notify(_msg,"error")})},function(err){})}function transformBotSynonyms(dontAssignTosynonyms){synonyms=[];var synonymKeys=Object.keys($scope.stream.synonyms||{}).sort();synonymKeys.map(function(key){var obj={};obj.key=key,obj.value=_constants_.getAlphabeticallySortedArray($scope.stream.synonyms[key]),synonyms.push($workflowService.cloneData(obj))}),dontAssignTosynonyms||($scope.synonyms=$workflowService.cloneData(synonyms),indexUpdateForBotSynonyms()),$scope.oldSynonyms=$workflowService.cloneData(synonyms)}function indexUpdateForBotSynonyms(){$scope.botSynonymObject=$workflowService.cloneData($scope.initialObject),$scope.synonyms.map(function(val){$scope.botSynonymObject[val.key&&val.key[0]]?$scope.botSynonymObject[val.key&&val.key[0]].push(val):$scope.botSynonymObject.other.push(val)}),$scope.views.botsynonyms&&($scope.indexObject=$workflowService.cloneData($scope.botSynonymObject))}function indexUpdateForEntitySynonyms(){$scope.entitySynonymObject=$workflowService.cloneData($scope.initialObject),$scope.allEntity=$scope.entities,$scope.findParenttasks($scope.entities),$scope.entities.map(function(val){val.synonyms=_constants_.getAlphabeticallySortedArray(val.synonyms),$scope.entitySynonymObject[val.name[0]]?$scope.entitySynonymObject[val.name[0]].push(val):$scope.entitySynonymObject.other.push(val)}),$scope.views.entitysynonyms&&($scope.indexObject=$workflowService.cloneData($scope.entitySynonymObject))}function addTaskSynonym(pattern){$scope.synonym={},$scope.synonym.show=!0,$scope.synonym.pattern=pattern,$timeout(function(){$(".add-task-synonym").modal("show")})}function addFieldSynonym(pattern){$scope.synonym={},$scope.synonym.pattern=pattern,$timeout(function(){$(".add-field-synonym").modal("show")})}function saveTaskSynonyms(streamId,name,synonyms,forStream,updateKey){var payload={},deferred=$q.defer();return forStream?(synonyms=$workflowService.cloneData($scope.synonyms),synonyms=transformSynonymsToObject(synonyms),BTStreamsService.postSynonyms($scope.stream._id,{synonyms:synonyms}).then(function(res){return $workflowService.selectedStream(res.data),$workflowService.nlpStream(res.data),$scope.stream.synonyms=res.data.synonyms,mergeNewSyonymsToLocalStream(res.data.synonyms),updateKey?(NotificationService.notify(i18n.i18nString("synonyms_updated_sucess"),"success"),transformBotSynonyms(!1),$scope.editBotSynonym=null,$scope.editBotSynonymId=null):(NotificationService.notify($scope.synUpdateMsg,"success"),transformBotSynonyms(!0)),$scope.enableSynonyms&&($scope.trainShow=!0),deferred.resolve(res)},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_bot_synonym_failed");return NotificationService.notify(msg,"error"),$q.reject(err)})):(payload[name]=synonyms,BTStreamsService.postSynonyms(streamId,{synonyms:payload}).then(function(res){return $workflowService.selectedStream(res.data),$workflowService.nlpStream(res.data),mergeNewSyonymsToLocalStream(res.data.synonyms),transformBotSynonyms(!0),$scope.enableSynonyms&&($scope.trainShow=!0),deferred.resolve(res)},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_bot_synonym_failed");return NotificationService.notify(msg,"error"),$q.reject(err)}))}function mergeNewSyonymsToLocalStream(synonyms){synonyms=synonyms||{},$scope.stream.synonyms=$scope.stream.synonyms||{},Object.keys(synonyms).map(function(key){$scope.stream.synonyms[key]=synonyms[key]})}function transformSynonymsToObject(synonyms){var result={};return synonyms.map(function(synonym){result[synonym.key]=synonym.value}),result}function getLowerCasedSynonyms(synonyms){return synonyms.filter(function(synonym){return synonym=synonym||""})}function openManageTaskSynonym(pattern){$scope.manageSynonym={},$timeout(function(){$(".manage-task-synonym").modal("show")})}function openManageFieldSynonym(event,task){event&&(event.stopPropagation(),event.preventDefault()),$scope.manageFieldSynonym={task:task.name},$timeout(function(){$(".manage-field-synonym").modal("show")})}function saveManageBotSynonymsForm(key,synonyms,allSynonyms){BTStreamsService.postSynonyms($scope.stream._id,allSynonyms).then(function(res){$scope.stream=res.data,$workflowService.selectedStream($scope.stream,res.data),$scope.cancelManageTaskSynonym(),$scope.cancelAddTaskSynonym(),$workflowService.nlpStream().synonyms[key]=synonyms,$scope.synonyms&&$scope.synonyms.length>0&&_.find($scope.synonyms,{key:key})?($workflowService.nlpStream().synonyms[key]=synonyms,_.find($scope.synonyms,{key:key}).value=synonyms):$scope.synonyms.push({key:key,value:synonyms}),indexUpdateForBotSynonyms(),NotificationService.notify(i18n.i18nString("save_synonyms"),"success"),$scope.enableSynonyms&&($scope.trainShow=!0),$scope.saveStatusSynonym={initial:!1,pending:!1,completed:!0,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym),$timeout(function(){$scope.saveStatusSynonym={initial:!0,pending:!1,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym)},3e3)},function(err){var msg=getErrorMsg(err,i18n.i18nString("add_synonyms_failed"));NotificationService.notify(msg,"error")})}function saveSynonymAtBot(oldTask,task){var fields=compareSynonyms(oldTask,task);if(fields.length>0){var payload={};fields.map(function(field){var name=getFieldName(field,task);name&&(payload[name]=task.fieldSynonyms[field])}),Object.keys(payload).map(function(fieldName){var taskId=task._id?task._id:task.taskId;triggerFieldSynonymSave(taskId,fieldName,payload[fieldName])})}else if(0===fields.length){var taskId=task._id?task._id:task.taskId;triggerFieldSynonymSave(taskId,task.name,[])}}function getFieldName(field,task){for(var name,i=0;i<task.fields.length;i++)if(task.fields[i].title.toLowerCase()==field)return task.fields[i].title;return name}function triggerFieldSynonymSave(taskId,fieldName,synonyms){var payload={},deferred=$q.defer(),type="l"==taskId[0]?"alert":"d"==taskId[0]?"dialog":"action";return payload[fieldName]=synonyms,"alert"===type?($scope.saveStatusSynonym={initial:!1,pending:!0,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym),BTStreamsService.createAlertFieldSynonyms(taskId,fieldName,payload).then(function(res){return $scope.oldTasks=clone($scope.tasks),$scope.saveStatusSynonym={initial:!1,pending:!1,completed:!0,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym),$timeout(function(){$scope.saveStatusSynonym={initial:!0,pending:!1,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym)},3e3),prepareFieldIndexObject(),NotificationService.notify($scope.synUpdateMsg,"success"),$scope.enableSynonyms&&($scope.trainShow=!0),deferred.resolve()},function(err){if($scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym),$timeout(function(){$scope.saveStatusSynonym={initial:!0,pending:!1,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym)},3e3),err.data&&err.data.errors)NotificationService.notify(err.data.errors[0].msg,"error");else{var msg=i18n.i18nString("adding_as_field_synonym_failed");NotificationService.notify(msg,"error")}return deferred.resolve()})):"action"===type?BTStreamsService.createActionsFieldSynonyms(taskId,fieldName,payload).then(function(res){return $scope.oldTasks=clone($scope.tasks),NotificationService.notify($scope.synUpdateMsg,"success"),$scope.saveStatusSynonym={initial:!1,pending:!1,completed:!0,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym),$timeout(function(){$scope.saveStatusSynonym={initial:!0,pending:!1,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym)},3e3),prepareFieldIndexObject(),deferred.resolve()},function(err){$scope.saveStatusSynonym={initial:!1,pending:!1,completed:!1,failed:!0},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym),$timeout(function(){$scope.saveStatusSynonym={initial:!0,pending:!1,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym)},3e3);var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_field_synonym_failed");return NotificationService.notify(msg,"error"),deferred.resolve()}):void 0}function compareSynonyms(source,destination){var keys=[];return source.fieldSynonyms=source.fieldSynonyms||{},destination.fieldSynonyms=destination.fieldSynonyms||{},Object.keys(destination.fieldSynonyms).map(function(key){source.fieldSynonyms[key]=_constants_.getAlphabeticallySortedArray(source.fieldSynonyms[key]||[]),destination.fieldSynonyms[key]=_constants_.getAlphabeticallySortedArray(destination.fieldSynonyms[key]||[]),source.fieldSynonyms[key].join(",")!=destination.fieldSynonyms[key].join(",")&&keys.push(key)}),keys}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createEntitySynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Entity Synonym added"),"deleteEntitySynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Entity Synonym deleted"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function compareComponentSynonymsAndSave(old,comp,type){(old&&old.synonyms&&comp&&old.synonyms.join(",")!==comp.synonyms.join(",")||old&&!old.synonyms)&&($scope.saveStatusSynonym={initial:!1,pending:!0,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym),BTFlowtaskService.updateComponentSynonyms($scope.stream._id,old._id,{synonyms:comp.synonyms}).then(function(res){mixpanelEvent(type?"deleteEntitySynonyms":"createEntitySynonyms"),$scope.enableSynonyms&&($scope.trainShow=!0),$scope.entity.synonyms=res.data.synonyms,$scope.editEntitySynonym=res.data,NotificationService.notify($scope.synUpdateMsg,"success"),$scope.saveStatusSynonym={initial:!1,pending:!1,completed:!0,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym),$timeout(function(){$scope.saveStatusSynonym={initial:!0,pending:!1,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym)},3e3)},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_entity_synonym_failed");NotificationService.notify(msg,"error"),$scope.saveStatusSynonym={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatusSynonym={initial:!0,pending:!1,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym)},3e3)}))}function loadingEntities(id){$scope.tasks=[],$scope.oldTasks=[],prepareObject()}function getDataFromServer(id,transform){$scope.showLoading=!0,setTimeout(function(){$q.all([BTAlertsService.getAlerts(id),BTActionsService.getActions(id)]).then(function(res){$workflowService.alertTasks(res[0].data),$workflowService.actionTasks(res[1].data),resolveEntities()})},1e3),$q.all([BTStreamsService.getBTStream(id),BTStreamsService.getMPStream(id)]).then(function(res){$scope.stream={},$scope.stream=angular.extend($scope.stream,res[0].data),delete res[1].data.visibility,$scope.stream=angular.extend($scope.stream,res[1].data),$workflowService.selectedStream($scope.stream),loadingEntities(id),transform&&transformBotSynonyms()})}function updateIndexHeader(mode){switch(mode){case"botsynonyms":$scope.indexObject=$workflowService.cloneData($scope.botSynonymObject);break;case"fieldsynonyms":$scope.indexObject=$workflowService.cloneData($scope.fieldSynonymObject);break;case"entitysynonyms":$scope.indexObject=$workflowService.cloneData($scope.entitySynonymObject)}}function resolveEntities(){$scope.entities=[],BTFlowtaskService.getEntitiesOrIntents(streamId,"entities").then(function(res){res.data&&($scope.entities=$filter("orderBy")(res.data,"name"),indexUpdateForEntitySynonyms())},function(error){})}function prepareObject(task){$scope.showLoading=!1,task?$scope.tasks.push(task):($scope.tasks=$scope.tasks.concat($workflowService.alertTasks()),$scope.tasks=$scope.tasks.concat($workflowService.actionTasks())),$scope.findParenttasks($scope.tasks),$scope.tasks=$scope.tasks.map(function(task){return _.isArray(task.alertFieldsDefinition)?(task.fields=_.clone(task.alertFieldsDefinition||[]),task.fields.map(function(field){field._id=field.title})):_.isArray(task.payloadField)&&_.isArray(task.queryField)&&(task.fields=(task.payloadField||[]).concat(task.queryField),task.fields.map(function(field){field._id=field.title})),task}),prepareFieldIndexObject(),$scope.oldTasks=clone($scope.tasks)}function prepareFieldIndexObject(){var fieldsArray=[];$scope.tasks.map(function(task){task.fields.map(function(field){var object={task:task,fieldId:field._id,field:field};fieldsArray.push(object)})}),fieldsArray=$filter("orderBy")(fieldsArray,"fieldId"),$scope.fieldSynonymObject=$workflowService.cloneData($scope.initialObject),$scope.allFields=fieldsArray,$scope.allFields=_.uniq($scope.allFields,function(p){return p.task._id}),$scope.stream.taskCounts.actions.length>0||$scope.stream.taskCounts.alerts.length>0||$scope.stream.taskCounts.informationTasks.length>0?$scope.fieldSynLength=!0:$scope.fieldSynLength=!1,$scope.fieldPatternsObject=fieldsArray||[],$scope.views.fieldsynonyms&&($scope.indexObject=$workflowService.cloneData($scope.fieldSynonymObject))}function clone(obj){if(obj)try{return JSON.parse(JSON.stringify(obj))}catch(err){return $workflowService.cloneData(obj)}}function getErrorMsg(err,defaultMsg){return err=err&&err.data,err&&err.errors&&err.errors[0]&&err.errors[0].msg||defaultMsg}$scope.filterToggle=$workflowService.selectedStreamState(),$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.synonym={},$scope.synonymsSelect2Options={maxTagLength:128},$scope.constants=_constants_,$scope.stream=$workflowService.cloneData($workflowService.selectedStream()),$scope.tasks=[],$scope.oldTasks=[],$scope.title="Synonyms",$scope.entities=[],$scope.entity={},$scope.upgradedTasks=[],$scope.showLoading=!0,$scope.placeholderMsg=i18n.i18nString("Synonym_word_placeholder"),$scope.entityDevelopment=i18n.i18nString("entity_development"),$scope.entityPublished=i18n.i18nString("entity_published"),$scope.synonymsDevelopment=i18n.i18nString("synonyms_development"),$scope.synonymsPublished=i18n.i18nString("synonyms_published"),$scope.enableSynonyms="",$scope.ellipsisGray=env_conf["context-url"]+"/assets/icons-new/ellipsis/overflow-2.svg",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.searchClose=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.trashIcon=env_conf["context-url"]+"/assets/icons-new/delete-trash/trash-red.svg",$scope.pencilIcon=env_conf["context-url"]+"/assets/icons-new/edit-pencil/pencil-gray.svg",$scope.currentEditItem={};var updateKey=!1;$scope.initialObject={a:[],b:[],c:[],d:[],e:[],f:[],g:[],h:[],i:[],j:[],k:[],l:[],m:[],n:[],o:[],p:[],q:[],r:[],s:[],t:[],u:[],v:[],w:[],x:[],y:[],z:[],other:[]},"VIEW"===$scope.displayMode&&$(document).keydown(function(e){var keycode1=e.keyCode?e.keyCode:e.which;(0===keycode1||9===keycode1)&&(e.preventDefault(),e.stopPropagation())}),$scope.hideUi||$("#btSynonymsmodal").modal("show"),$scope.botSynonymObject=$workflowService.cloneData($scope.initialObject),$scope.fieldSynonymObject=$workflowService.cloneData($scope.initialObject),
$scope.entitySynonymObject=$workflowService.cloneData($scope.initialObject),$scope.indexObject=$workflowService.cloneData($scope.initialObject),$scope.showBotSynonymForm=!1,$scope.editBotSynonymId=null,$scope.editBotSynonym=null,$scope.editEntitySynonymId=null,$scope.editEntitySynonym=null,$scope.editFieldSynonym=null,$scope.editFieldSynonymId=null,$scope.assetsBase=env_conf["assets-url"];$workflowService.currentLanguage();if($scope.currentLanguage=$workflowService.currentLanguage(),$scope.supportedLanguages=$workflowService.supportedLanguages(),$scope.languageList={},$scope.trainShow=!1,$scope.showTrainSavingSyn=!1,$scope.editMode=[],$scope.trainStatus={success:!0,failed:!1,saving:!1},setTimeout(function(){$rootScope.$emit("pefectScrollUpdate")},2e3),$.each($scope.supportedLanguages,function(i,language){$scope.languageList[language.value]=language.name}),!_.isObject($scope.stream)||_.isObject($scope.stream)&&0===Object.keys($scope.stream).length)return void $scope.goBack();$scope.showEmojiModal=function(){$("#emojiModal").modal("show")},$scope.loadEmojis=function(){BTStreamsService.importEmojis($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.synonyms&&($scope.stream.synonyms=res.data.synonyms),transformBotSynonyms(),$("#emojiModal").modal("hide"),NotificationService.notify(i18n.i18nString("bot_train"),"info"),NotificationService.notify(i18n.i18nString("emojiImportedInfo"),"info")},function(err){err&&err.data&&err.data.errors&&err.data.errors.length>0&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})},$scope.changeEditBotSynonym=function(synonym,key2,index){$scope.currentEditItem=null,synonym&&synonym.key+key2===$scope.editBotSynonymId?($scope.editBotSynonym=null,$scope.editBotSynonymId=null):($scope.cancelBotSynonym(),$scope.editBotSynonym=synonym,$scope.editBotSynonymId=synonym.key+key2,$scope.editMode[key2]=[],$scope.editMode[key2][index]=!1,$timeout(function(){$("input[ti-autosize]").focus()},250))},$scope.changeEditEntitySynonym=function(entity){"indevelopment"===$scope.filterToggle&&($scope.editEntitySynonym=JSON.parse(JSON.stringify(entity)),$scope.editEntitySynonymId=entity._id,$timeout(function(){$scope.cb.loadingSynonyms=!1},200))},$scope.editSynonym=function(e,index,key,synonym){e.stopPropagation(),$scope.editMode[key]=[],$scope.editMode[key][index]=!0,$scope.currentSynonym=$workflowService.cloneData(synonym),$scope.previousValue=$scope.currentSynonym,setTimeout(function(){$(e.currentTarget).parent().find("input").focus(),$(".synonym-item-label").find("input").addClass("editExpand")},100)},$scope.closeEdit=function(e,index,key,synonym){e.stopPropagation(),$scope.editMode[key]=[],$scope.editMode[key][index]=!1,setTimeout(function(){$(".synonym-item-label").find("input").removeClass("editExpand")},100),synonym.key!==$scope.previousValue.key&&$scope.updateSynonymKey(synonym,index,key)},$scope.closeTrainSaveDiv=function(){$scope.showTrainSavingSyn=!1},$scope.updateSynonymKey=function(synonym,index,key){$scope.editMode[key]=[],$scope.editMode[key][index]=!1,_.map($scope.synonyms,function(s){s.key===synonym.key&&(s.key=$scope.previousValue.key)}),updateKey=!0,saveTaskSynonyms(null,null,null,!0,updateKey)},$scope.trainBot=function(){BTStreamsService.trainUtterances($workflowService.selectedStream()._id).then(function(res){$scope.showTrainSavingSyn=!0,$scope.trainShow=!1,$scope.trainStatus={success:!1,failed:!1,saving:!0},$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$broadcast("getProgressDockStatus"),$(".trainingProgress").addClass("open"),NotificationService.notify(i18n.i18nString("bot_train"),"info")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})};var getProgressDockStatusDestroy=$rootScope.$on("getProgressDockStatus",function(){$scope.trainStatus={success:!1,failed:!1,saving:!0}});$rootScope.$on("SynonymsTrainFinished",function(){$scope.trainStatus={success:!0,failed:!1,saving:!1}});var synonymsTrainFailedDestroy=$rootScope.$on("SynonymsTrainFailed",function(){$scope.trainStatus={success:!1,failed:!0,saving:!1}}),botSynonymsToggleDestroy=$rootScope.$on("botSynonymsToggle",$scope.trainBot);$scope.changeEditFieldSynonym=function(task,fieldId,upgradeViewMode){$scope.currentTask=task,$scope.currentFieldId=fieldId,upgradeViewMode&&($scope.upgradeViewMode=upgradeViewMode.toUpperCase()),$scope.viewMode&&($scope.viewMode=$scope.viewMode.toUpperCase()),task&&task._id+fieldId===$scope.editFieldSynonymId?($scope.editFieldSynonym=null,$scope.editFieldSynonymId=null):($scope.cancelFieldSynonymIndex(),$scope.currentEditItem=$workflowService.cloneData(task),$scope.editFieldSynonym=$workflowService.cloneData(task),$scope.editFieldSynonymId=task._id+fieldId,$timeout(function(){$("input[ti-autosize]").focus()},350))},$scope.api={addSynonym:addTaskSynonym,addFieldSynonym:addFieldSynonym,openManageTaskSynonym:openManageTaskSynonym,openManageFieldSynonym:openManageFieldSynonym},$scope.views={botsynonyms:!0,fieldsynonyms:!1,entitysynonyms:!1},$scope.botsearch="",$scope.fieldsearch="",$scope.context=$scope.api,$scope.synonymsCurrentPage=1,$scope.taskCurrentPage=1,$scope.showIndex=0,$scope.manageFieldSynonym={},$scope.manageSynonym={},$scope.manageBotSynonym={};var synonyms=[];$scope.stream.synonyms=_.isObject($scope.stream.synonyms)?$scope.stream.synonyms:{},$workflowService.nlpStream(ng.copy($scope.stream)),$scope.showType=function(screen){Object.keys($scope.views).map(function(key){$scope.views[key]=!1}),$scope.views[screen]=!0,!$workflowService.storeSearchQry().userSearchQueryFlag&&$scope.gSearchCb&&($scope.gSearchCb.text=""),updateIndexHeader(screen),$scope.fieldEntityCount()},$scope.gSearchCb&&($scope.gSearchCb.showType=$scope.showType),$workflowService.storeSearchQry().userSearchQueryFlag||$workflowService.storeSearchQry().userNavigateFlag||!$scope.gSearchCb||($scope.gSearchCb.text="");var searchBarListner=function(){$(this).hasClass("fa-remove")?($(".synSearch").removeClass("searchExpand"),$(this).removeClass("fa-remove"),$(this).addClass("fa-search"),$scope.gSearchCb.text=""):($(".synSearch").addClass("searchExpand"),$(this).addClass("fa-remove"),$(this).removeClass("fa-search"),$timeout(function(){$(".synSearchInput").focus()},350))};$(".searchBar").click(searchBarListner),$scope.moveScrollToThis=function(key){var keyEle="";keyEle=$scope.views.botsynonyms?"#bot"+key:$scope.views.fieldsynonyms?"#field"+key:"#entity"+key,indexerUtil.isElementVisible(keyEle,!0,"#botSynonymnScroll")||$("#botSynonymnScroll").animate({scrollTop:$(keyEle).position().top},"fast")},$scope.updateFooterHeader=function(){return $scope.footerInfoTitle="Synonyms",$scope.footerHeaderId="bt-Synonyms",$scope.footerPanelId="bt-Synonyms-panel",$scope.nameDescription=i18n.i18nString("add_synonyms_task_name"),!0},$scope.showAddSynonymForm=function(){$scope.showBotSynonymForm=!0,$timeout(function(){$(".synonym-keyword").focus()},350)},$scope.cancelAddSynonymForm=function(){$scope.showBotSynonymForm=!1,$scope.cancelManageTaskSynonym(),$scope.cancelAddTaskSynonym()},$scope.clearSearch=function(){$scope.$parent.goBack(".btSynonymsmodal"),$timeout(function(){$scope.gSearchCb.text=""},150),$scope.$parent.resetDisplayTabID()};var windowResizeListner=function(e){var height=$window.innerHeight;height-=210,$("#botSynonymnScroll").css("height",height-62+"px"),$(".synonym-parentDiv").css("height",height+"px")};angular.element($window).on("resize",windowResizeListner),$timeout(function(){angular.element($window).trigger("resize")},350),$scope.filterFn=function(task){var taskType=$scope.getTaskType(task),key="state";return"DialogEntity"===task.type&&(key="status"),"published"===$scope.filterToggle?"published"===task[key]?!0:!1:"published"!==task[key]||"alert"!==taskType&&"action"!==taskType?"published"!==task[key]?!0:!1:task.isParent?!1:!0},$scope.upgrade=function(){$scope.isGlobalWorkProgress=!0,$scope.loaderMessage=i18n.i18nString("upgrading_task_label");var taskType=$scope.getTaskType($scope.currentTask);$scope.upgradeWorkflow($scope.currentTask,taskType)},$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?"action":task&&"DialogEntity"==task.type?"flowtask":""},$scope.upgradeWorkflow=function(task,type){"alert"===type?BTAlertsService.upgradeBTAlert(task._id).then(function(response){BTAlertsService.upgradeMPAlert(task._id,response.data._id).then(function(upgradeRes){BTAlertsService.configured(upgradeRes.data._id).then(function(configRes){prepareObject(configRes.data[0]),$scope.isGlobalWorkProgress=!1,$scope.changeEditFieldSynonym(configRes.data[0],$scope.currentFieldId)},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type&&BTActionsService.upgradeBTAction(task._id).then(function(response){BTActionsService.upgradeMPAction(task._id,response.data._id).then(function(upgradeRes){BTActionsService.configured(upgradeRes.data._id).then(function(configRes){prepareObject(configRes.data[0]),$scope.isGlobalWorkProgress=!1,$scope.changeEditFieldSynonym(configRes.data[0],$scope.currentFieldId)},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})};var streamId=$scope.stream._id;$scope.cancelTaskSynonym=function(){$(".add-task-synonym").modal("hide"),$scope.synonym.show=!1},$scope.cancelFieldSynonym=function(){$(".add-field-synonym").modal("hide")},$scope.getActualSynonyms=function(){return $workflowService.nlpStream().synonyms},$scope.saveEntitySynonym=function(type){type?$scope.synUpdateMsg=i18n.i18nString("synonyms_deleted_success"):$scope.synUpdateMsg=i18n.i18nString("synonyms_added_sucess");var newEntity=null;$scope.entities.map(function(entity){$scope.editEntitySynonym&&entity._id===$scope.editEntitySynonym._id&&(newEntity=entity,setTimeout(function(){compareComponentSynonymsAndSave($scope.editEntitySynonym,newEntity)},500))})},$scope.saveEntitySynonymTraining=function(type,newEntity){type?$scope.synUpdateMsg=i18n.i18nString("synonyms_deleted_success"):$scope.synUpdateMsg=i18n.i18nString("synonyms_added_sucess"),$timeout(function(){compareComponentSynonymsAndSave($scope.editEntitySynonym,newEntity,type)},500)},$scope.saveBotSynonym=function(type){type?$scope.synUpdateMsg=i18n.i18nString("synonyms_deleted_success"):$scope.synUpdateMsg=i18n.i18nString("synonyms_added_sucess"),setTimeout(function(){saveTaskSynonyms(null,null,null,!0)},500)},$scope.combineSynonyms=function(entity){return entity.synonyms||[]},$scope.saveTaskFieldSynonyms=function(type){type?$scope.synUpdateMsg=i18n.i18nString("synonyms_deleted_success"):$scope.synUpdateMsg=i18n.i18nString("synonyms_added_sucess");var newTask=null;$scope.tasks.map(function(task){$scope.editFieldSynonym&&task._id===$scope.editFieldSynonym._id&&(newTask=$workflowService.cloneData(task),setTimeout(function(){saveSynonymAtBot($scope.editFieldSynonym,newTask)},500))})},$scope.saveTaskFieldSynonymsTraining=function(type,newField){type?$scope.synUpdateMsg=i18n.i18nString("synonyms_deleted_success"):$scope.synUpdateMsg=i18n.i18nString("synonyms_added_sucess"),setTimeout(function(){var syns=$scope.editFieldSynonym||$scope.currentEditItem;saveSynonymAtBot(syns,newField)},500)},$scope.cancelBotSynonym=function(resetIndex){resetIndex&&($scope.editBotSynonymId=null),transformBotSynonyms(!1)},$scope.cancelEntitySynonym=function(resetIndex){resetIndex&&($scope.editEntitySynonymId=null);var indexEntity=-1;$scope.entities.map(function(entity,index){$scope.editEntitySynonym&&entity._id===$scope.editEntitySynonym._id&&(indexEntity=index)}),-1!=indexEntity&&($scope.entities[indexEntity]=$scope.editEntitySynonym,indexUpdateForEntitySynonyms())},$scope.cancelFieldSynonymIndex=function(resetIndex){resetIndex&&($scope.editFieldSynonymId=null);var indexTask=-1;$scope.tasks.map(function(task,index){$scope.editFieldSynonym&&task._id===$scope.editFieldSynonym._id&&(indexTask=index)}),-1!=indexTask&&($scope.tasks[indexTask]=$workflowService.clone($scope.editFieldSynonym),prepareFieldIndexObject())},$scope.deleteSynonym=function(deletedSynonym,$event){function deleteSynonym(){var synonyms=$workflowService.cloneData($scope.synonyms);synonyms.splice(index,1),BTStreamsService.postSynonyms($scope.stream._id,{synonyms:transformSynonymsToObject(synonyms)}).then(function(res){$scope.synonyms.splice(index,1),$scope.stream=res.data,$workflowService.nlpStream($scope.stream),$workflowService.selectedStream($scope.stream),$scope.oldSynonyms=$workflowService.cloneData($scope.synonyms),NotificationService.notify(i18n.i18nString("synonyms_deleted_success"),"success"),$scope.enableSynonyms&&($scope.trainShow=!0),indexUpdateForBotSynonyms()},function(err){var msg=getErrorMsg(err,i18n.i18nString("synonyms_added_failure"));NotificationService.notify(msg,"error")})}$event.stopPropagation();var index=-1;$scope.synonyms.map(function(synonym,i){synonym.key==deletedSynonym.key&&(index=i)});$scope.synonyms[index];NotificationService.alert(i18n.i18nString("do_you_really_want_to_del_noty"),deleteSynonym,[$scope.stream._id,null,null,!0])},$scope.saveTaskSynonym=function(){var synonyms=$scope.stream.synonyms[$scope.synonym.intent]||[];synonyms.push($scope.synonym.pattern),synonyms=synonyms.map(function(synonym){return synonym}),$scope.stream.synonyms[$scope.synonym.intent]=synonyms,saveTaskSynonyms(streamId,$scope.synonym.intent,synonyms).then(function(res){$scope.cancelTaskSynonym()},function(err){})},$scope.saveFieldSynonym=function(){var task=$scope.getSelectedTask($scope.synonym.intent),type="l"==task._id[0]?"alert":"action",payload={},getSynonym="alert"==type?BTStreamsService.getAlertsFieldSynonyms:BTStreamsService.getActionsFieldSynonyms,saveSynonym="alert"==type?BTStreamsService.createAlertFieldSynonyms:BTStreamsService.createActionsFieldSynonyms;getSynonym(task._id,task.name).then(function(res){var synonyms=res.data[$scope.synonym.field]||[];synonyms.push($scope.synonym.pattern),payload[$scope.synonym.field]=getLowerCasedSynonyms(synonyms),saveSynonym(task._id,$scope.synonym.field,payload).then(function(res){NotificationService.notify($scope.synUpdateMsg,"success"),$scope.cancelFieldSynonym()},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_field_synonym_failed");NotificationService.notify(msg,"error")})},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_field_synonym_failed");NotificationService.notify(msg,"error")})},$scope.cancelManageTaskSynonym=function(form){$scope.manageSynonym={},$(".manage-task-synonym").modal("hide"),form_util.makeItClean($scope.manageTaskSynonymForm)},$scope.cancelAddTaskSynonym=function(form){$scope.manageBotSynonym={},form_util.makeItClean($scope.manageBotSynonymForm)},$scope.cancelManageFieldSynonym=function(form){$scope.manageFieldSynonym={},$(".manage-field-synonym").modal("hide"),form_util.makeItClean($scope.manageFieldSynonymForm)},$scope.saveManageTaskSynonym=function(form){var key,synonyms;if(form.$invalid)return void form_util.touch(form);key=_.isObject($scope.manageSynonym.keyword)?$scope.manageSynonym.keyword.key:$scope.manageSynonym.keyword,key&&(key=key),synonyms=$scope.manageSynonym.synonyms||[],synonyms=_.uniq(synonyms.concat(($workflowService.nlpStream().synonyms||{})[key]||[])),synonyms=synonyms.map(function(synonym){return synonym});var allSynonyms=$workflowService.cloneData($workflowService.nlpStream().synonyms);allSynonyms[key]=synonyms,allSynonyms={synonyms:allSynonyms},saveManageBotSynonymsForm(key,synonyms,allSynonyms)},$scope.saveManageBotTaskSynonym=function(form){$scope.saveStatusSynonym={initial:!1,pending:!0,completed:!1,failed:!1},$scope.cb&&$scope.cb.updateStatus&&$scope.cb.updateStatus($scope.saveStatusSynonym);var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};mixPanel.postEvent("Add Concept",_botInfo);var key,synonyms;if(form.$invalid)return void form_util.touch(form);key=_.isObject($scope.manageBotSynonym.keyword)?$scope.manageBotSynonym.keyword.key:$scope.manageBotSynonym.keyword,key&&(key=key),synonyms=$scope.manageBotSynonym.synonyms||[],synonyms=_.uniq(synonyms.concat(($workflowService.nlpStream().synonyms||{})[key]||[])),synonyms=synonyms.map(function(synonym){return synonym});var allSynonyms=$workflowService.cloneData($workflowService.nlpStream().synonyms);allSynonyms[key]=synonyms,allSynonyms={synonyms:allSynonyms},saveManageBotSynonymsForm(key,synonyms,allSynonyms)},$scope.saveManageFieldSynonym=function(form){if(form.$invalid)return void form_util.touch(form);var task=$scope.getSelectedTask($scope.manageFieldSynonym.task),type="l"==task._id[0]?"alert":"d"===task._id[0]?"dialog":"action",payload={};if("dialog"!==type){var getSynonym="alert"==type?BTStreamsService.getAlertsFieldSynonyms:BTStreamsService.getActionsFieldSynonyms,saveSynonym="alert"==type?BTStreamsService.createAlertFieldSynonyms:BTStreamsService.createActionsFieldSynonyms;getSynonym(task._id,task.name).then(function(res){var synonyms=res.data[$scope.manageFieldSynonym.field]||[];synonyms=synonyms.concat($scope.manageFieldSynonym.synonyms),payload[$scope.manageFieldSynonym.field]=getLowerCasedSynonyms(synonyms),saveSynonym(task._id,$scope.manageFieldSynonym.field,payload).then(function(res){NotificationService.notify($scope.synUpdateMsg,"success"),$scope.cancelManageFieldSynonym(),getDataFromServer(streamId)},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_field_synonym_failed");NotificationService.notify(msg,"error")})},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_field_synonym_failed");NotificationService.notify(msg,"error")})}else{var task1=$scope.tasks.filter(function(flowTask){return flowTask._id===task._id})[0],component=task1.nodes.filter(function(component){return component._id===$scope.manageFieldSynonym.field})[0],synonyms=component.synonyms[$scope.manageFieldSynonym.field]||[];synonyms=synonyms.concat($scope.manageFieldSynonym.synonyms),payload[$scope.manageFieldSynonym.field]=getLowerCasedSynonyms(synonyms),BTFlowtaskService.updateComponent($scope.stream._id,$scope.manageFieldSynonym.field,{synonyms:payload}).then(function(res){NotificationService.notify($scope.synUpdateMsg,"success"),$scope.cancelManageFieldSynonym(),getDataFromServer(streamId)},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_as_field_synonym_failed");NotificationService.notify(msg,"error")})}},$scope.fieldEntityCount=function(){$timeout(function(){$scope.activeFieldsLength=$(".segrigateFields").length,$scope.activeEntitiLengthIndevelopment=_.filter($scope.entities,function(data){return"configured"===data.status?data:void 0}),$scope.activeEntitiLengthPublished=_.filter($scope.entities,function(data){return"published"===data.status?data:void 0}),$(".synMainContainer").scrollTop(0),$scope.editEntitySynonymId=null,$scope.editEntitySynonym=null,$scope.editFieldSynonym=null,$scope.editFieldSynonymId=null,$scope.editBotSynonymId=null,$scope.editBotSynonym=null},350)},$scope.expand=function(index){$scope.showIndex=$scope.showIndex==index?-1:index},$scope.getSelectedTask=function(name){var task=$scope.tasks.filter(function(task){return task.name==name})[0];return task},$scope.goBack=function(){$location.path(window.appConfig.CONTEXT_PATH)},$scope.$emit("nestedComponentLoaded",{id:"synonyms",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),function(id){$timeout(function(){return $scope.hideUi?($scope.showLoading=!0,resolveEntities(),void $q.all([BTStreamsService.getBTStream(id),BTStreamsService.getMPStream(id)]).then(function(res){$scope.stream={},$scope.stream=angular.extend($scope.stream,res[0].data),delete res[1].data.visibility,$scope.stream=angular.extend($scope.stream,res[1].data),$workflowService.selectedStream($scope.stream),loadingEntities(id),transformBotSynonyms()})):(getDataFromServer(id,!0),void synnoymsAutoTrainStatus())})}(streamId),$scope.getTemplateUrl=function(){return $scope.templateUrl?window.appConfig.TMPLT_PRE_PATH+"js/modules/synonyms-module/synonyms-module-entity.html":window.appConfig.TMPLT_PRE_PATH+"js/modules/synonyms-module/synonyms-module.html"},$scope.$on("$destroy",function(){angular.element($window).off("resize",windowResizeListner),$(".searchBar").off("click",searchBarListner),getProgressDockStatusDestroy&&getProgressDockStatusDestroy(),synonymsTrainFailedDestroy&&synonymsTrainFailedDestroy(),botSynonymsToggleDestroy&&botSynonymsToggleDestroy()}),$scope.cb&&($scope.cb.changeEditEntitySynonym=$scope.changeEditEntitySynonym,$scope.cb.changeEditFieldSynonym=$scope.changeEditFieldSynonym)}])}(angular),function(ng){"use strict";var _module=ng.module("utterances-module",[]);_module.filter("filterTasks",function($applicationService){return function(tasks){return _.filter(tasks,function(task){return"_checkString"===task.state})}}),_module.directive("scrollPaginate",function(){return{restrict:"EA",link:function($scope,element,attrs){var _batchSize=20;element.bind("scroll",function(e){var _currEle=e.currentTarget;_currEle.scrollTop+_currEle.offsetHeight>=.9*_currEle.scrollHeight&&($scope.loadingClientBatch=!0,$scope.updateClientBatch(_batchSize))})}}}),_module.filter("objLength",function(){return function(object){var objectKeysArr=Object.keys(object);return objectKeysArr.filter(function(val){return"other"!==val&&object[val].length>0}).length}}),_module.directive("dropdownDirective",function($timeout){return{restrict:"EA",scope:{},template:'<span class="count entity-count" data-toggle="dropdown"></span><ul  class="dropdown-menu content-menu entity-dropdown-associates" dynamic-height dynaoffset="-415"><div class="position-relative" perfect-scroll dynamic-height dynaoffset="-415"><li ng-repeat="value in filteredValues track by $index"><a>{{value}}</a></li></div></ul>',link:{post:function($scope,$element,attr){function cb(){var _elements=$element.parent().find(".patterns");$scope.filteredValues=[];var filteredElements;_.map(_elements,function(e,i){if($(_elements[0]).offset().top&&$(e).offset().top>$(_elements[0]).offset().top+32&&$(e).css({display:"none"}),filteredElements=_.filter(_elements,function(e,i){return!$(e).is(":visible")}),filteredElements&&filteredElements.length){var _countTag=filteredElements.length,_ele=$element.find(".count");_ele&&_ele.length&&(_ele[0].innerText=_countTag),$element.find(".count").css({display:"block"})}else $element.find(".count").css({display:"none"})}),angular.forEach(filteredElements,function(e){$scope.filteredValues.push(e.innerText)})}$element.ready(cb)}}}}),_module.directive("insertTilde",function($timeout){return{link:function($scope,$element,attrs){$element.on("keyup",function(){$timeout(function(){var r,validReg,preValue;$scope.currentEditSynonym&&($scope.currentEditSynonym.key?$scope.currentEditSynonym.key&&$scope.currentEditSynonym.key.length&&(r=new RegExp("^[~]"),validReg=r.test($scope.currentEditSynonym.key),validReg||($element.prop("disabled",!0),preValue="~",$scope.currentEditSynonym.key=preValue.concat($scope.currentEditSynonym.key),setTimeout(function(){$element.prop("disabled",!1)},200))):$scope.currentEditSynonym.key="~"),$scope.manageBotSynonym&&($scope.manageBotSynonym.keyword?$scope.manageBotSynonym.keyword&&$scope.manageBotSynonym.keyword.length&&(r=new RegExp("^[~]"),validReg=r.test($scope.manageBotSynonym.keyword),validReg||($element.prop("disabled",!0),preValue="~",$scope.manageBotSynonym.keyword=preValue.concat($scope.manageBotSynonym.keyword),setTimeout(function(){$element.prop("disabled",!1)},200))):$scope.manageBotSynonym.keyword="~")})})}}}),_module.controller("UtterancesModuleCtrl",["$scope","$element","$rootScope","_constants_","$timeout","$window","$workflowService","$location","$routeParams","BTStreamsService","$q","BTAlertsService","BTActionsService","NotificationService","BTFlowtaskService","env_conf","$applicationService","BTFileUploadService","accessControlService","i18n","$sce","$filter","mixPanel","nlpService",function($scope,$element,$rootScope,_constants_,$timeout,$window,$workflowService,$location,$routeParams,BTStreamsService,$q,BTAlertsService,BTActionsService,NotificationService,BTFlowtaskService,env_conf,$applicationService,BTFileUploadService,accessControlService,i18n,$sce,$filter,mixPanel,nlpService){function getTextEncoded(name){return name?name.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function checkMLSyncStatus(disableNotify){BTStreamsService.autoTrainStatus($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithSentences")&&!res.data.isMlInSyncWithSentences||res&&res.data&&res.data.hasOwnProperty("isMlInSyncWithTraits")&&!res.data.isMlInSyncWithTraits?prepareTrainLabel(res.data):$scope.showTrainBtn=!1,res.data.kFold&&($scope.showKfoldTrainSaving=!1),"Waiting"===res.data.kFoldStatus&&($scope.kfoldtrainStatus.success=!1,$scope.kfoldtrainStatus.failed=!1,$scope.kfoldtrainStatus.training=!0,$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer")),res.data.kfoldTriggeredOn&&($scope.kfoldTriggeredOn=moment(res.data.kfoldTriggeredOn).format("MM-DD-YYYY, hh:mm A")),$scope.kfoldtrainStatus.kFold=res.data.kFold,$scope.kfoldtrainStatus.kFoldStatus=res.data.kFoldStatus,"Finished"===res.data.trainingStatus?($scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1):"Failed"===res.data.trainingStatus||res.data.isError?($scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1,res.data.isError&&($scope.failed_to_train_utt_msg=i18n.i18nString("failed_to_train_utt_msg"),res.data.errorDesc&&res.data.errorDesc.message&&($scope.showTrainBtn=!0),disableNotify||NotificationService.notify(failed_to_train_utt_msg,"error"))):res.data&&res.data.trainingStatus&&"waiting"===res.data.trainingStatus.toLowerCase()&&($scope.showTrainSavingDiv=!0,$scope.trainProgressLabel||prepareTrainProgressLabel(),$scope.trainStatus={success:!1,failed:!1,saving:!0})},function(err){$scope.showTrainSavingDiv=!1,$scope.trainStatus.saving=!1,$scope.err_on_fetching_msg=i18n.i18nString("err_on_fetching_msg"),NotificationService.notify(err_on_fetching_msg,"error")})}function getErrorMsg(err,defaultMsg){return err=err&&err.data,err&&err.errors&&err.errors[0]&&err.errors[0].msg||defaultMsg}function isBotPublished(){return"private"!==$scope.stream.visibility.namespace}function decodePattern(msg){try{return msg.replace(/&lt;/g,"<").replace(/&gt;/g,">")}catch(e){return msg}}function loadingEntities(id,type,cb,fromFlag){$scope.loadingUtterances=!0,$scope.fetchingTrainingData=!0;var state="published";("indevelopment"===$scope.filterToggle||"configured"===$scope.filterToggle)&&(state="configured"),$q.all([BTAlertsService.getAlerts(id),BTActionsService.getActions(id),BTFlowtaskService.getEntitiesOrIntents(id,"intents"),BTFlowtaskService.getFlowtaks(id),BTFlowtaskService.getComponentsByTypeAndState(id,"intent",state)]).then(function(res){nlpService.intents(res[2].data),nlpService.alerts(res[0].data),res[0].data=res[0].data.map(function(task){return task.taskType="alert",task.intentTypeName="Alert",task.state=task.state.toLowerCase(),("inprogress"===task.state||"suspended"===task.state||"rejected"===task.state)&&(task.hide=!0),task}),res[0].data=_.filter(res[0].data,function(d){return!d.hide}),$scope.alertTasks=res[0].data;var _alertTaskFound=_.find($scope.supportedIntents,{key:"alertTask"});$scope.alertTasks&&$scope.alertTasks.length&&!_alertTaskFound&&$scope.supportedIntents.push({name:"Alert",key:"alertTask",selected:!1}),res[1].data=res[1].data.map(function(task){return task.isReport?(task.taskType="information",task.intentTypeName="Information Task"):(task.intentTypeName="Action Task",task.taskType="action"),task.state=task.state.toLowerCase(),("inprogress"==task.state||"suspended"==task.state||"rejected"==task.state)&&(task.hide=!0),"published"!==task.state&&!task.hide&&isBotPublished()&&(task.taskstate="@development"),task}),res[1].data=_.filter(res[1].data,function(d){return!d.hide}),$scope.actionTasks=_.filter(res[1].data,{taskType:"action"}),$scope.informationTasks=_.filter(res[1].data,{taskType:"information"});var _actionTaskFound=_.find($scope.supportedIntents,{key:"actionTask"}),_informationTaskFound=_.find($scope.supportedIntents,{key:"informationTask"});$scope.actionTasks&&$scope.actionTasks.length&&!_actionTaskFound&&$scope.supportedIntents.push({name:"Action Tasks",key:"actionTask"}),$scope.informationTasks&&$scope.informationTasks.length&&!_informationTaskFound&&$scope.supportedIntents.push({name:"Information Tasks",key:"informationTask"});var componentIDs=[],_filteredNodes=[],filteredDialogTasks=[],_hiddenDialogTaskIds=[];filteredDialogTasks=_.filter(res[3].data,function(task,i){return"inprogress"!==task.state&&"suspended"!==task.state&&"rejected"!==task.state||!task.isDeleted}),$.each(filteredDialogTasks,function(i,dialog){_filteredNodes=_filteredNodes.concat(_.filter(dialog.nodes,{nodeId:"intent0"}))}),_.map(filteredDialogTasks,function(task){task.isDeleted&&_hiddenDialogTaskIds.push(task._id)});var hiddenHelpNodes=_.filter(filteredDialogTasks,function(dialog){return dialog.isHidden}),hiddenHelpIds=_.pluck(hiddenHelpNodes,"_id"),dialogSubIntents=_.filter(filteredDialogTasks,function(dialog){return dialog.isFollowUp}),dialogSubIntentsIds=_.pluck(dialogSubIntents,"_id");componentIDs=_.pluck(_filteredNodes,"componentId"),res[2].data=res[2].data.map(function(task){return task.taskType="DialogIntent",task.intentTypeName="Dialog Intent",task.status&&(task.status=task.status.toLowerCase()),task.hasOwnProperty("dialogId")||(task.hide=!0),-1!==$.inArray(task.dialogId,hiddenHelpIds)&&(task.isHidden=!0),-1!==$.inArray(task.dialogId,dialogSubIntentsIds)&&(task.subDialogIntent=!0,task.intentTypeName="Sub Intent Dialog"),-1!==$.inArray(task.dialogId,_hiddenDialogTaskIds)&&(task.isDeleted=!0),"published"!==task.status&&!task.hide&&isBotPublished()&&(task.taskstate="@development"),task}),res[4].data=res[2].data.filter(function(task){return task.hasOwnProperty("dialogId")?void 0:(task.taskType="DialogIntent",task.isSubIntent=!0,task.intentTypeName="Sub Intent",task)}),$scope.subIntentData=res[4].data,res[2].data=_.filter(res[2].data,function(task){return!task.hide}),$scope.callback.allIntents=res[2].data,$scope.intentdata=res[2].data,$.each(res[0].data,function(i,alertTask){alertTask.entitiesArray=alertTask.alertFieldsDefinition}),$.each(res[1].data,function(i,actionTask){actionTask.entitiesArray=[].concat(actionTask.payloadField,actionTask.queryField)}),$scope.tasks=[],$scope.tasks=$scope.tasks.concat(res[0].data),$scope.tasks=$scope.tasks.concat(res[1].data),$scope.tasks=$scope.tasks.concat(res[2].data),$scope.tasks=$scope.tasks.concat(res[4].data),$scope.findParenttasks($scope.tasks),$scope.totalTasks=$scope.tasks,$scope.alertActionTasks=$scope.totalTasks.filter(function(task){if("action"===task.taskType||"alert"===task.taskType||"information"===task.taskType){
_.isArray(task.alertFieldsDefinition)?task.fields=_.clone(task.alertFieldsDefinition||[]):_.isArray(task.payloadField)&&_.isArray(task.queryField)&&(task.fields=(task.payloadField||[]).concat(task.queryField));var patterns=[];return Object.keys(task.fieldPatterns||{}).map(function(field){var valueOfField=[];valueOfField=task.fieldPatterns[field].map(function(pattern){return pattern.original}),valueOfField.length&&patterns.push({key:task.fieldPatterns[field].map(function(pattern){return pattern.key}),fieldName:field,value:valueOfField,oldPatterns:task.fieldPatterns[field]})}),task.field_patterns=patterns,task}}),type?$scope.showType(type,cb,fromFlag):$scope.showType(),loadFields(),setTimeout(function(){$('[data-toggle="dropdown"').on("click",function(e){$scope.entityCmpt.showentityDropdown=!1,$element.find(".entity-selection-dropdown").removeClass("entity-selection-dropdown")}),$(".select2-choice").on("mousedown",function(e){$scope.entityCmpt.showentityDropdown=!1,$element.find(".entity-selection-dropdown").removeClass("entity-selection-dropdown")}),$(".timeInterval.tasks").on("mousedown",function(){$scope.entityCmpt.showentityDropdown=!1,$element.find(".entity-selection-dropdown").removeClass("entity-selection-dropdown")}),$("body .talkToBot").is(":visible")||$("body .talkToBot").css({display:"block"}),$scope.loadingUtterances=!1,$scope.fetchingTrainingData=!1},500)},function(error){$scope.loadingUtterances=!1,$scope.fetchingTrainingData=!1})}function initDragDropFile(){!function(window){function triggerCallback(e,callback){if(callback&&"function"==typeof callback){var files;e.dataTransfer?files=e.dataTransfer.files:e.target&&(files=e.target.files),callback.call(null,files)}}function makeDroppable(ele,callback){if(!($element.find('[type="file"]').length>0)){var input=document.createElement("input");input.setAttribute("type","file"),input.setAttribute("multiple",!0),input.style.display="none",input.id="fileInputID",input.addEventListener("change",function(e){triggerCallback(e,callback)}),ele=ele[0],ele.appendChild(input),ele.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.add("dragover")}),ele.addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover")}),ele.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),ele.classList.remove("dragover"),triggerCallback(e,callback)}),$(ele).find(".browseBtn")[0].addEventListener("click",function(){input.value=null,input.click()})}}window.makeDroppable=makeDroppable}(window),function(window){window.makeDroppable($(".fileDropContainer"),function(files){$scope.uploadJSONFile(files[0])})}(window)}function startPollImportStatus(timeout){return setInterval(function(){BTFlowtaskService.botutteranceImportStatus($applicationService.userInfo().userId,streamId,$scope.streamRefId).then(function(res){res&&res.data&&($scope.statusLogs=res.data.statusLogs||[],"success"===res.data.status?stopImportBotPolling("success"):"failed"===res.data.status&&($scope.importmessage=res.data.message,$scope.showFailedErrors=!1,stopImportBotPolling("failed")))},function(err){stopImportBotPolling(),$scope.bot_import_error=i18n.i18nString("bot_import_error"),err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(bot_import_error,"error")})},timeout)}function stopImportBotPolling(_status){void 0!==$scope._importStatusInit&&(clearTimeout($scope._importStatusInit),$scope._importStatusInit=null),"success"===_status?finishedImport():($scope.importing="failed",$scope.exportingUtter="failed")}function finishedImport(){setTimeout(function(){$scope.importing="finished",$scope.exportingUtter="finished"},2e3)}function writeAndDownloadLog(filename,data){var element=document.createElement("a");element.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(data)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}function startPollExportStatus(timeout){return setInterval(function(){BTStreamsService.utteranceStatus($applicationService.userInfo().userId,streamId).then(function(response){response&&response.data&&("success"===response.data.status&&response.data.downloadURL?($scope.downloadUrl=response.data.downloadURL,stopExportBotPolling("success")):"pending"===response.data.status&&stopExportBotPolling("pending"))},function(err){stopExportBotPolling("failed"),$scope.backup_err=i18n.i18nString("backup_err"),err.data&&err.data.errors&&err.data.errors.length>0&&(_msg=err.data.errors[0].msg),NotificationService.notify(backup_err,"error")})},timeout)}function stopExportBotPolling(_status){$scope._exportStatusInit&&(clearTimeout($scope._exportStatusInit),$scope._exportStatusInit=null),$scope.exporting=_status,"success"===_status&&$timeout(function(){$element.find("#backupUtterBtn")[0].click()},500)}function getNodeUsedList(tmpNode){var flowtaskNames=[];return $.each($scope.flowTasks,function(k,task){$.each(task.nodes,function(k,node){return node.type!==tmpNode.type||node.componentId!==tmpNode._id&&node.componentId!==tmpNode.parentId?void 0:(flowtaskNames.push(task.name),!1)}),task.child&&task.child.length&&$.each(task.child[0].nodes,function(k,node){return node.type!==tmpNode.type||node.componentId!==tmpNode._id&&node.componentId!==tmpNode.parentId?void 0:(flowtaskNames.push(task.name),!1)})}),_.uniq(flowtaskNames)}function indexUpdateForBotSynonyms(){$scope.botSynonymObject=angular.copy($scope.initialObject),$scope.synonyms.map(function(val){$scope.botSynonymObject[val.key&&val.key[0].toLowerCase()]?$scope.botSynonymObject[val.key&&val.key[0].toLowerCase()].push(val):val&&val.key.startsWith("~")?$scope.botSynonymObject.concepts.push(val):$scope.botSynonymObject.other.push(val)})}function removeTagValidation(){$(".tags").find("input").val("")}function mixpanelEvent(type){var _botInfo={streamId:$workflowService.selectedStream()._id,"Bot Name":$workflowService.selectedStream().name,Level:"Engagement L3",Category:"Engagement L3"},event="";"createBotSynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Bot Synonym Added"),"createConceptSynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Concept Synonym added"),"editSynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Bot Synonym edited"),"editConceptSynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Concept Synonym edited"),"deleteSynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Bot Synonym deleted"),"deleteConceptSynonyms"===type&&(_botInfo.Level="Engagement L3",_botInfo.Category="Engagement L3",_botInfo["Sub Category"]="NLP - Training",event="NLP - Concept Synonym deleted"),event&&event.trim()&&mixPanel.postEvent(event,_botInfo)}function saveManageBotSynonymsForm(key,synonyms,allSynonyms){$scope.saveStatus={initial:!1,pending:!0,completed:!1,failed:!1},BTStreamsService.postSynonyms($scope.stream._id,allSynonyms).then(function(res){mixpanelEvent($scope.views&&$scope.views.botsynonyms?"createBotSynonyms":"createConceptSynonyms"),$scope.saveStatus={initial:!1,pending:!1,completed:!0,failed:!1},$scope.stream=res.data,$workflowService.selectedStream($scope.stream,res.data),$workflowService.nlpStream().synonyms[key]=synonyms,$scope.synonyms&&$scope.synonyms.length>0&&_.find($scope.synonyms,{key:key})?($workflowService.nlpStream().synonyms[key]=synonyms,_.find($scope.synonyms,{key:key}).value=synonyms):$scope.synonyms.push({key:key,value:synonyms}),indexUpdateForBotSynonyms(),NotificationService.notify(i18n.i18nString("save_synonyms"),"success"),$scope.enableSynonyms&&($scope.trainShow=!0),$timeout(function(){$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)},function(err){var msg=getErrorMsg(err,i18n.i18nString("add_synonyms_failed"));NotificationService.notify(msg,"error"),$scope.saveStatus={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1}},3e3)})}function saveManageBotSynonyms(){var key,synonyms;({streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name});key=_.isObject($scope.manageBotSynonym.keyword)?$scope.manageBotSynonym.keyword.key:$scope.manageBotSynonym.keyword,key&&(key=key),$scope.manageBotSynonym.synonyms=_.map($scope.manageBotSynonym.synonyms,function(synonym){return _.isObject(synonym)?synonym.text:synonym}),synonyms=$scope.manageBotSynonym.synonyms||[],synonyms=_.uniq(synonyms.concat(($workflowService.nlpStream().synonyms||{})[key]||[])),synonyms=synonyms.map(function(synonym){return synonym});var allSynonyms=angular.copy($workflowService.nlpStream().synonyms);allSynonyms[key]=synonyms,allSynonyms={synonyms:allSynonyms},saveManageBotSynonymsForm(key,synonyms,allSynonyms)}function transformSynonymsToObject(synonyms){var result={};return synonyms.map(function(synonym){result[synonym.key]=synonym.value}),result}function mergeNewSyonymsToLocalStream(synonyms){synonyms=synonyms||{},$scope.stream.synonyms=$scope.stream.synonyms||{},Object.keys(synonyms).map(function(key){$scope.stream.synonyms[key]=synonyms[key]})}function saveTaskSynonyms(streamId,name,synonyms,forStream,updateKey,type){var payload={},deferred=$q.defer();return $scope.saveStatus={initial:!1,pending:!0,completed:!1,failed:!1},forStream?(synonyms=angular.copy($scope.synonyms),synonyms=transformSynonymsToObject(synonyms),BTStreamsService.postSynonyms($scope.stream._id,{synonyms:synonyms}).then(function(res){return mixpanelEvent(type?"deleteSynonyms":"editSynonyms"),$scope.saveStatus={initial:!1,pending:!1,completed:!0,failed:!1},$workflowService.selectedStream(res.data),$workflowService.nlpStream(res.data),$scope.stream.synonyms=res.data.synonyms,mergeNewSyonymsToLocalStream(res.data.synonyms),updateKey?(NotificationService.notify(i18n.i18nString("synonyms_updated_sucess"),"success"),transformBotSynonyms(!1),$scope.editBotSynonym=null,$scope.editBotSynonymId=null):(NotificationService.notify($scope.synUpdateMsg,"success"),transformBotSynonyms()),$scope.enableSynonyms&&($scope.trainShow=!0),$timeout(function(){$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1}},3e3),deferred.resolve(res)},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_bot_synonym_failed");return NotificationService.notify(msg,"error"),$scope.saveStatus={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1}},3e3),$q.reject(err)})):(payload[name]=synonyms,BTStreamsService.postSynonyms(streamId,{synonyms:payload}).then(function(res){return mixpanelEvent(type?$scope.views&&$scope.views.botsynonyms?"deleteSynonyms":"deleteConceptSynonyms":$scope.views&&$scope.views.botsynonyms?"editSynonyms":"editConceptSynonyms"),$scope.saveStatus={initial:!1,pending:!1,completed:!0,failed:!1},$workflowService.selectedStream(res.data),$workflowService.nlpStream(res.data),mergeNewSyonymsToLocalStream(res.data.synonyms),transformBotSynonyms(!0),$scope.enableSynonyms&&($scope.trainShow=!0),$timeout(function(){$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1}},3e3),deferred.resolve(res)},function(err){var msg=err.data&&err.data.errors&&err.data.errors[0]&&err.data.errors[0].msg||i18n.i18nString("adding_bot_synonym_failed");return NotificationService.notify(msg,"error"),$scope.saveStatus={initial:!1,pending:!1,completed:!1,failed:!0},$timeout(function(){$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1}},3e3),$q.reject(err)}))}$timeout(function(){window.inline_manual_player&&window.inline_manual_player.update()},3e3),$scope.loadingWarnings=!1,$scope.filterToggle=$workflowService.selectedStreamState(),$scope.displayMode=accessControlService.getAccessRight("BOTBUILDER_NATURAL_LANGUAGE"),$scope.assetsBase=env_conf["assets-url"],$scope.tmpltPrePath=$scope.$root.tmpltPrePath;var streamId=$workflowService.selectedStream()._id;$scope._constants_=_constants_,$scope.verifying=!1,$scope.tasks=[],$scope.utteranceSearch=[],$scope.totalTasks=[],$scope.activeTask=0,$scope.activeType="DialogIntent",$scope.utterences=[],$scope.autoTrainedUtterances=[],$scope.editId=-1,$scope.moreAvailable=!0,$scope.fetchingTrainingData=!0,$scope.moreAutoTrainedAvailable=!0,$scope.count=0,$scope.entityCmpt={},$scope.entityCmpt.showentityDropdown=!1,$scope.entityCmpt.fromEdit=!1,$scope.entityCmpt.offsetObject={},$scope.stream=$workflowService.selectedStream(),$scope.title=i18n.i18nString("machine_learning"),$scope.fetching=!1,$scope.autoTrainFetching=!1,$scope.focusedIndex=-1,$scope.activeTabType="developer",$scope.bulbIcon=window.appConfig.CONTEXT_PATH+"/assets/images/24x29-bulbicon.png",$scope.ellipsisGray=window.appConfig.CONTEXT_PATH+"/assets/icons-new/ellipsis/overflow-2.svg",$scope.searchIconGray=env_conf["context-url"]+"/assets/icons/searchIconGray.svg",$scope.searchIcon=env_conf["context-url"]+"/assets/icons/search.svg",$scope.closeIcon=env_conf["context-url"]+"/assets/icons-new/close/close-dark.svg",$scope.searchClose=env_conf["context-url"]+"/assets/icons/fa-close.svg",$scope.caretRight=env_conf["context-url"]+"/assets/icons/caretRight.svg",$scope.caretDown=env_conf["context-url"]+"/assets/icons-new/chevron/chevron-down-white.svg",$scope.emptyStateIcon=env_conf["context-url"]+"/assets/empty-state-images/k-folder.png",$scope.reloadpng=env_conf["context-url"]+"/assets/images/reload.png",$scope.spinnerIcon=env_conf["context-url"]+"/assets/images/spinner.svg",$scope.refreshIcon=env_conf["context-url"]+"/assets/icons-new/refresh/refresh-white.svg",$scope.emptyStateIcon_training=env_conf["context-url"]+"/assets/empty-state-images/empty-train.png",$scope.roundCheck=env_conf["context-url"]+"/assets/icons/round-check.svg",$scope.saving=env_conf["context-url"]+"/assets/gif/saving.gif",$scope.brokenImageSmall=env_conf["context-url"]+"/assets/images/brokenImageSmall.png",$scope.showTrainBtn=!1,$scope.showTrainSavingDiv=!1,$scope.trainTitle="",$scope.speechTrainTitle="",$scope.trainStatus={success:!1,failed:!1,saving:!1},$scope.kfoldtrainStatus={success:!0,failed:!1,training:!1},$scope.speechTrainStatus={success:!0,failed:!1,saving:!1},$scope.autoTrainedUtteranceCount=0,$scope.fetchingUtterances=!1,$scope.rightClass="right900",$scope.upgradedTasks=[],$scope.indexWatch=[],$scope.mlInfo=[],$scope.mlInfo.mlScore=!1,$scope.mlInfo.intents=[],$scope.mlInfo.filterToggle="indevelopment",$scope.taskTypes=[{name:i18n.i18nString("dialog_intents_label"),id:"DialogIntent",count:0},{name:i18n.i18nString("constants.alerts"),id:"alert",count:0},{name:i18n.i18nString("constants.reports"),id:"information",count:0},{name:i18n.i18nString("constants.actions"),id:"action",count:0}];var previousUtteranceIndex=-1;$scope.entityCallbacks={},$scope.btUtteranceObject={},$scope.streamstate={},$scope.streamstate.toggleState=$workflowService.selectedStreamState();var _selectedLanguage=$workflowService.currentLanguage();$scope.dragDropIcon=window.appConfig.CONTEXT_PATH+"/assets/images/import.png",$scope.wentWrongIcon=window.appConfig.CONTEXT_PATH+"/assets/images/wentwrong.png",$scope.importingIcon=env_conf["context-url"]+"/assets/images/importing.png",$scope.importDoneIcon=env_conf["context-url"]+"/img/import-success.png",$scope.helpIcon=window.appConfig.CONTEXT_PATH+"/assets/icons/helpIcon.svg",$scope.infoIcon=env_conf["context-url"]+"/assets/icons-new/info/info-gray.svg",$scope.dropdownToggle=env_conf["context-url"]+"/assets/icons-new/dropdown-toggle/dropdown-toggle.svg",$scope.config={},$scope.config.includeIsHidden=!0,$scope.doneButton=i18n.i18nString("done"),$scope.okButton=i18n.i18nString("ok_label"),$scope.showKfoldModal=!1,$scope.uiCopyTasks=[],$scope.constants=_constants_,$scope.search={},$scope.selectedIntent={},$scope.callback={},$scope.taskSearch={},$scope.select={},$scope.select.name="All Intents",$scope.select.key="allIntent",$scope.activeTab="intents",$scope.componentsCount=[],$scope.filteredResults=[],$scope.isInvalidTag=!1,$scope.viewMode=!1,$scope.notificationEnabled=!0,$scope.notificationInputEnabled=!0,$scope.warningBar=!0,$scope.supportedIntents=[{name:"Dialog Intent",key:"dialogIntent",selected:!1},{name:"Sub Intent Dialogs",key:"subDialogIntent",selected:!1},{name:"Sub-Intents",key:"subIntent",selected:!1}],$scope.saveStatus={initial:!0,pending:!1,completed:!1,failed:!1},$scope.modalSlider={},$scope.initialObject={a:[],b:[],c:[],d:[],e:[],f:[],g:[],h:[],i:[],j:[],k:[],l:[],m:[],n:[],o:[],p:[],q:[],r:[],s:[],t:[],u:[],v:[],w:[],x:[],y:[],z:[],concepts:[],other:[]},$scope.patternsCB={},$scope.synonymsCB={},$scope.manageBotSynonym={},$scope.manageBotSynonym.synonyms=[],$scope._selectedFilters=[];var _alertActionArray=["alert","action","information"];$scope.views={intents:!0,entity:!1,fields:!1,botsynonyms:!1,concepts:!1,traits:!1},$scope.gSearchCb={},$scope.gSearch={},$scope.upgrade={},$scope.searchTask="",$scope.exportStep=1,$scope.data={downloadURL:"",label:getTextEncoded($scope.stream.name)},$scope.requestStatus={interval:null},$scope.stream.synonyms=_.isObject($scope.stream.synonyms)?$scope.stream.synonyms:{},$workflowService.nlpStream(ng.copy($scope.stream)),$scope.traitsCb={},$scope.trainSyncData={},$scope.ob={};var _mode;"VIEW"===$scope.displayMode&&$(document).keydown(function(e){var keycode1=e.keyCode?e.keyCode:e.which;(0===keycode1||9===keycode1)&&(e.preventDefault(),e.stopPropagation())}),$scope.supportedLanguages=$workflowService.seedData().supportedLanguages,$scope.nluSupportedLanguages=$workflowService.seedData().nluSupportedLanguages,$scope.defaultLanguage=$workflowService.selectedStream().defaultLanguage,_.forEach($scope.supportedLanguages,function(eachLang){eachLang.value===_selectedLanguage&&($scope.selectedDefaultLanguage=eachLang)}),$scope.multiLingualConfigurations=$workflowService.selectedStream().multiLingualConfigurations,$scope.multiLingualConfigurations&&$scope.multiLingualConfigurations[_selectedLanguage]&&$scope.multiLingualConfigurations[_selectedLanguage].nluLanguage&&$scope.multiLingualConfigurations[_selectedLanguage].nluLanguage!==_selectedLanguage?($scope.notificationEnabled=!0,$scope.notificationInputEnabled=!0,_.forEach($scope.nluSupportedLanguages,function(eachLang){eachLang.value===$scope.multiLingualConfigurations[_selectedLanguage].nluLanguage&&($scope.selectedNluLanguage=eachLang)})):$scope.multiLingualConfigurations&&$scope.multiLingualConfigurations[_selectedLanguage]&&$scope.multiLingualConfigurations[_selectedLanguage].nluLanguage&&$scope.multiLingualConfigurations[_selectedLanguage].nluLanguage===_selectedLanguage?($scope.notificationInputEnabled=!1,$scope.notificationEnabled=!1):($scope.notificationEnabled=!1,$scope.notificationInputEnabled=!1),loadingEntities(streamId),$scope.showFailedErrors=!0,$(".dropdown-submenu a.test").on("click",function(e){$(this).next("ul").toggle(),e.stopPropagation(),e.preventDefault()}),$scope.showUtteranceInternalHeader=function(type){$scope.activeTabType=type,$(".utterances-content-view").bind("scroll",bindScroll)},$scope.closeTrainSaveDiv=function(){$scope.showTrainSavingDiv=!1,$scope.trainStatus={success:!0,failed:!1,saving:!1},$scope.speechTrainStatus={success:!0,failed:!1,saving:!1},$scope.trainTitle=""},$scope.toggleHiddenTasks=function(e){$scope.loadingWarnings=!0,e.stopPropagation(),e.stopImmediatePropagation(),$scope.config.includeIsHidden=!$scope.config.includeIsHidden;var _tasks;if(_tasks=$scope.concatedTasks&&$scope.concatedTasks.length?$scope.concatedTasks:mapTasks.allIntent(),$scope.config.includeIsHidden)$scope.config.includeIsHidden&&($scope.uiCopyTasks=_tasks.slice(0,20));else{var excludeHiddenTasks=_.filter(_tasks,function(task){return!task.isHidden});$scope.uiCopyTasks=excludeHiddenTasks.slice(0,20)}$scope.uiCopyTasks&&$scope.uiCopyTasks.length>=20?$(".utteranceScrollContainer").animate({scrollTop:10}):$(".utteranceScrollContainer").animate({scrollTop:0}),setTimeout(function(){$scope.loadingWarnings=!1},200)},$scope.updateFooterHeader=function(){return $scope.footerInfoTitle=i18n.i18nString("machine_learning"),$scope.footerHeaderId="bt-machineLearning",$scope.footerPanelId="bt-machineLearning-panel",$scope.nameDescription=i18n.i18nString("utterance_module_machine_learing_desc"),!0};var prepareTrainLabel=function(data){$scope.trainSyncData=data,$scope.trainStatus&&!$scope.trainStatus.saving&&($scope.showTrainBtn=!0),data.hasOwnProperty("isMlInSyncWithSentences")&&!data.isMlInSyncWithSentences&&data.hasOwnProperty("isMlInSyncWithTraits")&&!data.isMlInSyncWithTraits?$scope.trainLabel=i18n.i18nString("untrained_utterances_ml_traits"):data.hasOwnProperty("isMlInSyncWithSentences")&&!data.isMlInSyncWithSentences?$scope.trainLabel=i18n.i18nString("untrained_utterance_ml"):data.hasOwnProperty("isMlInSyncWithTraits")&&!data.isMlInSyncWithTraits&&($scope.trainLabel=i18n.i18nString("untrained_utterance_traits"))};checkMLSyncStatus(),$rootScope.$on("MLUtterencesTrainFinished",function($event){$scope.trainStatus={success:!0,failed:!1,saving:!1},$workflowService.currTrainStatus($scope.trainStatus),$scope.trainTitle="",setTimeout(function(){$scope.showTrainBtn=!1,$scope.showTrainSavingDiv=!1},3e3),$scope.invokedFrom&&$scope.cb.updateTrainStatus($scope.trainStatus)}),$rootScope.$on("kfoldTrainingSuccess",function($event){$scope.kfoldModalOpened&&$scope.kfoldtrainStatus.training&&($scope.viewKfold(!0),checkMLSyncStatus()),$scope.kfoldtrainStatus.success=!0,$scope.kfoldtrainStatus.failed=!1,$scope.kfoldtrainStatus.training=!1}),$rootScope.$on("kfoldTrainingFailed",function($event){$scope.kfoldModalOpened&&$scope.kfoldtrainStatus.training&&NotificationService.notify(i18n.i18nString("problm_in_training_kfold_noty"),"success"),$scope.kfoldtrainStatus.success=!1,$scope.kfoldtrainStatus.failed=!0,$scope.kfoldtrainStatus.training=!1}),$scope.trainKfold=function(hideNotify){if($scope.stream&&$scope.stream.nlMeta&&$scope.stream.nlMeta&&(!$scope.stream.nlMeta.mlUtterances||$scope.stream.nlMeta.mlUtterances<250))return void NotificationService.notify(i18n.i18nString("min_250_utterances_reqired"),"error");$scope.kfoldTraining=!0;var payload={crossValidation:!0};BTStreamsService.trainUtterances(streamId,payload).then(function(res){$scope.kfoldtrainStatus={success:!1,failed:!1,training:!0},$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),hideNotify||NotificationService.notify(i18n.i18nString("kfold_training_intiated"),"info")},function(err){err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("kfold_training_intiated_err"),"error")})},$rootScope.$on("MLUtterencesTrainFailed",function($event){$scope.trainStatus={success:!1,failed:!0,saving:!1},$scope.trainTitle=i18n.i18nString("problm_in_training_utter_noty"),$scope.speechTrainStatus.saving||setTimeout(function(){$scope.showTrainBtn=!0},350),$scope.invokedFrom&&$scope.cb.updateTrainStatus($scope.trainStatus)}),$rootScope.$on("MLSpeechTrainFinished",function($event){$scope.speechTrainStatus={success:!0,failed:!1,saving:!1},$scope.speechTrainTitle="",$scope.trainStatus.failed&&setTimeout(function(){$scope.showTrainBtn=!0,$scope.showTrainSavingDiv=!1},350)}),$rootScope.$on("MLSpeechTrainFailed",function($event){$scope.speechTrainStatus={success:!1,failed:!0,saving:!1},$scope.speechTrainTitle=i18n.i18nString("speech_training_intiated_err"),$scope.trainStatus.saving||setTimeout(function(){$scope.showTrainBtn=!0},350)}),$scope.exportKfoldData=function(){function startKfoldExport(){BTStreamsService.mlKfoldScoreDownload($workflowService.selectedStream()._id).then(function(res){if(res&&res.data){$scope.hrefURL=res.data.fileUrl+"&clientfilename=Kfold_"+($workflowService.selectedStream().name||"Kfold_Data")+"_"+moment().format("YYYYMMDDHHmmSS")+".csv&batchtesting=true";var xyz="#kfold_report";$(xyz).attr("href",$scope.hrefURL),$(xyz).attr("download",!0),$(xyz).on("click",function(e){e.stopPropagation()}),$timeout(function(){$(xyz).get(0).click(function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()})},750)}},function(err){err.data&&err.data.errors&&err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("prblm_in_fectching_kFold"),"error")})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startKfoldExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export")):startKfoldExport()},$scope.viewKfold=function(){$scope.LoadingKfold=!0,BTStreamsService.getBTStream($scope.stream._id).then(function(res){res.data.isInMarket=!0,$workflowService.selectedStream(res.data),$scope.stream=$workflowService.selectedStream(),BTStreamsService.mlKfoldScore($workflowService.selectedStream()._id).then(function(res){return res.data&&res.data.error?($scope.errorKfold=!0,$scope.showKfoldModal=!1,$scope.LoadingKfold=!1,$scope.kfoldObjErrorMsg=res.data.error,$scope.kfoldErrCode=res.data.errorCode):($scope.kfoldErrCode=null,$scope.showKfoldModal=!0,$scope.LoadingKfold=!1,$scope.errorKfold=!1),$scope.stream&&$scope.stream.nlMeta&&$scope.stream.nlMeta&&!(res&&res.data&&res.data.split_scores&&res.data.split_scores.length)&&(!$scope.stream.nlMeta.mlUtterances||$scope.stream.nlMeta.mlUtterances<250)?void NotificationService.notify(i18n.i18nString("min_250_utterances_reqired"),"error"):($scope.kfoldModalOpened=!0,$(".kfold-modal").modal("show"),$(".sidenav").addClass("zindex1"),$scope.kfoldObjErrorMsg=null,void($scope.kfoldObj=res.data))},function(err){$scope.errorKfold=!0,$scope.showKfoldModal=!1,$scope.LoadingKfold=!1,$scope.kfoldObjErrorMsg=null,err.data&&err.data.errors&&err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("prblm_in_fectching_kFold"),"error")})},function(err){$scope.LoadingKfold=!1})},$scope.closeKFoldModal=function(){$(".kfold-modal").modal("hide"),$(".sidenav").removeClass("zindex1"),$scope.showKfoldModal=!0,$scope.kfoldModalOpened=!1},$scope.viewMlScore=function(){return $scope.viewMlScoreInprogress=!0,$scope.isTrainInprogress()?void NotificationService.notify(i18n.i18nString("training_prog_pls_retry_err"),"error"):$scope.totalTasks.length?void BTStreamsService.mlUtterencesScore($scope.stream._id).then(function(res){$scope.mlInfo.MlScoreRes=res.data;var isEmpty=!res.data.count;return isEmpty?void($scope.utterences.length>0?(NotificationService.alert("",$scope.trainBot,{okText:i18n.i18nString("train")},"",void 0,i18n.i18nString("training_inti_ml_model")),$scope.viewMlScoreInprogress=!1):(NotificationService.notify(i18n.i18nString("viewml_model_err"),"error"),$scope.viewMlScoreInprogress=!1)):(!isEmpty&&res.data.hasOwnProperty("order")&&res.data.hasOwnProperty("count")?($scope.mlInfo.directiveLoading=!0,$(".mlScore-modal").modal("show"),$scope.mlInfo.intents=$scope.intentdata,$scope.mlInfo.filterToggle=$scope.filterToggle,$scope.mlInfo.checkMLSyncStatus=checkMLSyncStatus,$(".sidenav").addClass("zindex1"),setTimeout(function(){$scope.mlInfo.openMLScore=!0},100),setTimeout(function(){$scope.mlInfo.directiveLoading=!1},2e3)):NotificationService.alert("",$scope.trainBot,{okText:i18n.i18nString("train")},"",void 0,i18n.i18nString("training_inti_ml_model")),void($scope.viewMlScoreInprogress=!1))},function(err){$scope.viewMlScoreInprogress=!1,err.data&&err.data.errors&&err.data.errors.length>0?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("prblm_in_fectching_utter_err"),"error")}):void NotificationService.notify(i18n.i18nString("notasksfound_errr"),"error")},$scope.closeMlScore=function(){$scope.mlInfo.openMLScore=!1},$scope.isTrainInprogress=function(){return $scope.speechTrainStatus.saving||$scope.trainStatus.saving?!0:!1},$scope.trainBotSpeech=function(){$scope.speechTrainStatus.saving||($scope.speechTrainStatus={success:!1,failed:!1,saving:!0},BTStreamsService.trainBotSpeech(streamId).then(function(res){$rootScope.$emit("triggerSpeechTrainStatusPoll"),NotificationService.notify(i18n.i18nString("speech_training_intiated"),"info"),$scope.speechTrainTitle=""},function(err){$scope.speechTrainStatus={success:!1,failed:!0,saving:!1},err.data&&err.data.errors&&err.data.errors.length>0?(NotificationService.notify(err.data.errors[0].msg,"error"),$scope.speechTrainTitle=err.data.errors[0].msg):($scope.speechTrainTitle=i18n.i18nString("speech_training_intiated_err"),NotificationService.notify(i18n.i18nString("speech_training_intiated_err"),"error"))}))};var prepareTrainProgressLabel=function(){$scope.trainSyncData&&($scope.trainSyncData.hasOwnProperty("isMlInSyncWithSentences")&&!$scope.trainSyncData.isMlInSyncWithSentences&&$scope.trainSyncData.hasOwnProperty("isMlInSyncWithTraits")&&!$scope.trainSyncData.isMlInSyncWithTraits?$scope.trainProgressLabel=" Intent, Entity & Traits training are currently in progress. ":$scope.trainSyncData.hasOwnProperty("isMlInSyncWithSentences")&&!$scope.trainSyncData.isMlInSyncWithSentences?$scope.trainProgressLabel=" Intent & Entity training are currently in progress.  ":$scope.trainSyncData.hasOwnProperty("isMlInSyncWithTraits")&&!$scope.trainSyncData.isMlInSyncWithTraits&&($scope.trainProgressLabel="Traits training is currently in progress. "))};$scope.trainBot=function(source){source&&($scope.invokedFrom=source);var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};prepareTrainProgressLabel(),mixPanel.postEvent("ML Training Initiated",_botInfo),$scope.showTrainBtn=!1,$scope.showTrainSavingDiv=!0,$scope.trainStatus={success:!1,failed:!1,saving:!0},$workflowService.currTrainStatus($scope.trainStatus),BTStreamsService.trainUtterances(streamId).then(function(res){$rootScope.$emit("triggerAutoTrainStatusPoll"),$rootScope.$emit("clearTestTrainText"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open"),NotificationService.notify(i18n.i18nString("utterences_training_intiated"),"info"),$scope.trainTitle=""},function(err){$scope.trainStatus={success:!1,failed:!0,saving:!1},$workflowService.currTrainStatus($scope.trainStatus),$scope.showTrainBtn=!0,$scope.showTrainSavingDiv=!1,err.data.errors.length>0?(NotificationService.notify(err.data.errors[0].msg,"error"),$scope.trainTitle=err.data.errors[0].msg):($scope.trainTitle=i18n.i18nString("problm_in_training_utter_noty"),NotificationService.notify(i18n.i18nString("utterences_training_intiated_err"),"error"))})},$scope.cancelEditUtterance=function(){setTimeout(function(){$scope.utterences[previousUtteranceIndex].sentence=$scope.utterencesCopy[previousUtteranceIndex].sentence,$scope.editId=-1,savedUtteranceFlag=!0},5)},$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?task.isReport?"information":"action":task&&"DialogIntent"==task.taskType?"flowtask":""},$scope.filterFn=function(task,indexval){var type=$scope.getTaskType(task),key="state";return"DialogIntent"===task.taskType&&(key="status"),"published"===$scope.filterToggle?"published"===task[key]?!0:!1:"published"!==task[key]||"alert"!==type&&"action"!==type&&"flowtask"!==type&&"information"!==type?"published"!==task[key]?!0:!1:task.isParent||task.isDeleted||task.isSubIntent?!1:!0;
},$scope.getActiveTaskIndex=function(res){var index;return res.hasOwnProperty("nodes")?$.each($scope.tasks,function(i,task){task._id==res.nodes[0].componentId&&(index=i)}):$.each($scope.tasks,function(i,task){task._id==res._id&&(index=i)}),index},$scope.findParenttasks=function(taskObject){$.each(taskObject,function(i,task){task.hasOwnProperty("parentId")&&$scope.upgradedTasks.push(task.parentId)}),$.each(taskObject,function(i,task){$.each($scope.upgradedTasks,function(j,upgradedId){task._id===upgradedId&&(task.isParent=!0)})})},$scope.selectFirstTask=function(){$timeout(function(){var index=$($(".sagrigate-task")[0]).attr("task-index");$scope.activeTaskLength=$(".sagrigate-task").length,$scope.selectTask(+index)},100)},$workflowService.registerModalHiddenEvent();var loadUITasks=function(tasks,offset,limit){var _offset={};return _offset.start=offset?offset:0,_offset.limit=limit?limit:20,$scope.config.includeIsHidden||(tasks=_.filter(tasks,function(task){return!task.isHidden})),$scope.uiCopyTasks=tasks.slice(_offset.start,_offset.limit),$scope.uiCopyTasks};$scope.showType=function(type,cb,fromFlag){var _selectedIntent,_selectedNode;cb&&"fromUpgrade"===fromFlag&&"addUtterance"===$scope.upgrade.callbackType?("DialogIntent"===type?(_selectedNode=_.filter(cb.nodes,{nodeId:"intent0"})[0],_selectedIntent=_.find($scope.tasks,{_id:_selectedNode.componentId})):_selectedIntent=_.find($scope.tasks,{_id:cb._id}),$scope.selectedIntent=_selectedIntent,$scope.concatTasks(),$scope.callback.addUtteranceCall(null,$scope.upgrade.currentUtt,fromFlag,$scope.selectedIntent)):cb&&"fromUpgrade"===fromFlag?("DialogIntent"===type?(_selectedNode=_.filter(cb.nodes,{nodeId:"intent0"})[0],_selectedIntent=_.find($scope.tasks,{_id:_selectedNode.componentId})):_selectedIntent=_.find($scope.tasks,{_id:cb._id}),$scope.selectedIntent=_selectedIntent,NotificationService.notify(i18n.i18nString("upgraded_success"),"success"),$scope.callback.loadingMLUtterances=!0,$scope.callback.getUtterances($scope.selectedIntent,$scope.callback)):($scope.totalTasks=$filter("orderBy")($scope.totalTasks,"name"),$scope.tasks=$scope.totalTasks.filter(function(task){return $scope.filterFn(task)}),loadUITasks($scope.tasks))};var fetchEntities=function(id,type,cb,fromFlag){$scope.fetchingTrainingData=!0;var state="published";("indevelopment"===$scope.filterToggle||"configured"===$scope.filterToggle)&&(state="configured"),$q.all([BTAlertsService.getAlerts(id),BTActionsService.getActions(id),BTFlowtaskService.getEntitiesOrIntents(id,"intents"),BTFlowtaskService.getFlowtaks(id),BTFlowtaskService.getComponentsByTypeAndState(id,"intent",state)]).then(function(res){res[0].data=res[0].data.map(function(task){return task.taskType="alert",task.intentTypeName="Alert",task.state=task.state.toLowerCase(),("inprogress"===task.state||"suspended"===task.state||"rejected"===task.state)&&(task.hide=!0),task}),res[0].data=_.filter(res[0].data,function(d){return!d.hide}),$scope.alertTasks=res[0].data,res[1].data=res[1].data.map(function(task){return task.isReport?task.taskType="information":task.taskType="action",task.state=task.state.toLowerCase(),("inprogress"==task.state||"suspended"==task.state||"rejected"==task.state)&&(task.hide=!0),"published"!==task.state&&!task.hide&&isBotPublished()&&(task.taskstate="@development"),task}),res[1].data=_.filter(res[1].data,function(d){return!d.hide});var componentIDs=[],_filteredNodes=[],filteredDialogTasks=[],_hiddenDialogTaskIds=[];filteredDialogTasks=_.filter(res[3].data,function(task,i){return"inprogress"!==task.state&&"suspended"!==task.state&&"rejected"!==task.state||!task.isDeleted}),$.each(filteredDialogTasks,function(i,dialog){_filteredNodes=_filteredNodes.concat(_.filter(dialog.nodes,{nodeId:"intent0"}))}),_.map(filteredDialogTasks,function(task){task.isDeleted&&_hiddenDialogTaskIds.push(task._id)});var hiddenHelpNodes=_.filter(filteredDialogTasks,function(dialog){return dialog.isHidden}),hiddenHelpIds=_.pluck(hiddenHelpNodes,"_id"),dialogSubIntents=_.filter(filteredDialogTasks,function(dialog){return dialog.isFollowUp}),dialogSubIntentsIds=_.pluck(dialogSubIntents,"_id");componentIDs=_.pluck(_filteredNodes,"componentId"),res[2].data=res[2].data.map(function(task){return task.taskType="DialogIntent",task.intentTypeName="Dialog Intent",task.status&&(task.status=task.status.toLowerCase()),-1!==$.inArray(task.dialogId,hiddenHelpIds)&&(task.isHidden=!0),task.hasOwnProperty("dialogId")||(task.hide=!0),-1!==$.inArray(task.dialogId,dialogSubIntentsIds)&&(task.subDialogIntent=!0,task.intentTypeName="Sub Intent Dialog"),-1!==$.inArray(task.dialogId,_hiddenDialogTaskIds)&&(task.isDeleted=!0),"published"!==task.status&&!task.hide&&isBotPublished()&&(task.taskstate="@development"),task}),res[4].data=res[2].data.filter(function(task){return task.hasOwnProperty("dialogId")?void 0:(task.taskType="DialogIntent",task.isSubIntent=!0,task.intentTypeName="Sub Intent",task)}),$scope.subIntentData=res[4].data,res[2].data=_.filter(res[2].data,function(task){return!task.hide}),$scope.callback.allIntents=res[2].data,$scope.intentdata=res[2].data,$.each(res[0].data,function(i,alertTask){alertTask.entitiesArray=alertTask.alertFieldsDefinition}),$.each(res[1].data,function(i,actionTask){actionTask.entitiesArray=[].concat(actionTask.payloadField,actionTask.queryField)}),$scope.tasks=[],$scope.tasks=$scope.tasks.concat(res[0].data),$scope.tasks=$scope.tasks.concat(res[1].data),$scope.tasks=$scope.tasks.concat(res[2].data),$scope.tasks=$scope.tasks.concat(res[4].data),$scope.fetchingTrainingData=!1,$scope.findParenttasks($scope.tasks),mapPatternsArray($scope.tasks),$scope.totalTasks=$scope.tasks,type?$scope.showType(type,cb,fromFlag):$scope.showType()})},openManageTraining=function(){$scope.callback.showIntentsLabel=!0,$scope.intentStateData=$scope.totalIntentData.filter(function(intent){return $scope.filterFn(intent)});for(var i=0;i<$scope.intentStateData.length;i++)if($scope.intentStateData[i]._id===$scope.primaryIntent._id){$scope.selectedIntent=$scope.intentStateData[i];break}$scope.callback.allIntents=$scope.intentStateData,$scope.onClickIntent(null,$scope.selectedIntent,null,"DialogIntent")},fetchIntents=function(primaryIntent,displayMode){$scope.$watch("intentdata",function(newVal,oldVal){$scope.totalIntentData=newVal,$scope.primaryIntent=primaryIntent,displayMode&&"VIEW"===displayMode.toUpperCase()&&($scope.filterToggle="published"),primaryIntent&&($scope.callback.primaryIntentOb=JSON.parse(JSON.stringify(primaryIntent))),$scope.totalIntentData&&openManageTraining()})},mapPatternsArray=function(tasks){tasks.forEach(function(task){task.patterns=task.patterns||[],task.patternsArray=[],task.negativePatternsArray=[],task.negativePatterns=task.negativePatterns||[],task.patterns.forEach(function(msg){msg.original=decodePattern(msg.original),task.patternsArray.push(msg.original)}),task.negativePatterns.forEach(function(msg){msg.original=decodePattern(msg.original),task.negativePatternsArray.push(msg.original)})})};$scope.$watch("showTrainBtn",function(newVal,oldVal){newVal!==oldVal&&setTimeout(function(){},200)}),$scope.$watch("showTrainSavingDiv",function(newVal,oldVal){newVal!==oldVal&&setTimeout(function(){},100)}),$scope.importUtterancesModal=function(){$scope.importing="initial",$(".import-utterance-modal").modal("show"),$timeout(function(){initDragDropFile()},500)},$scope.exportUtterancesModal=function(filetype){function startExport(){var reqStatus;reqStatus="published"===$scope.filterToggle?"published":"indevelopment"===$scope.filterToggle?"configured":reqStatus,BTStreamsService.utteranceExport($applicationService.userInfo().userId,streamId,reqStatus,filetype).then(function(response){"IN_PROGRESS"===response.data.status||"SUCCESS"===response.data.status?(NotificationService.notify(i18n.i18nString("utterance_module_ml_utterances_export_in_progress"),"success"),$rootScope.$broadcast("getProgressDockStatus"),$rootScope.$broadcast("startTimer"),$(".trainingProgress").addClass("open")):"failed"===response.data.status&&console.log("ML utterance JSON export Failed")},function(error){if("RequestExists"===error.data.errors[0].code){var msg=error.data.errors[0].code;NotificationService.notify(msg,"warning")}})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_utterance")):startExport()},$scope.onCancel=function(){$(".import-utterance-modal").modal("hide"),$scope.fileName="",clearTimeout($scope._importStatusInit),$scope.exportingUtter="",loadingEntities($workflowService.selectedStream()._id)},$scope.onDone=function(){$scope.exportingUtter="success",$(".import-utterance-modal").modal("hide"),$scope.fileName="",clearTimeout($scope._importStatusInit),checkMLSyncStatus(),$scope.select.name="All Intents",$scope.config.includeIsHidden=!0,loadingEntities($workflowService.selectedStream()._id)},$scope.removeFile=function(){$scope.fileName=""},$scope.uploadJSONFile=function(fileObject){var _ext="";if(fileObject.name){_ext=fileObject.name.substring(fileObject.name.lastIndexOf(".")),_ext.slice(1).toUpperCase();var supportingFileFormats=[".json",".csv"];if(-1===$.inArray(_ext,supportingFileFormats))return NotificationService.notify(i18n.i18nString("upload_only_csv_json_error_noty"),"error"),void($scope.fileExtensionError=!0)}var reader=new FileReader;reader.readAsText(fileObject),reader.onload=function(e){var respnoseData=reader.result;if($scope.jsonData=respnoseData,!respnoseData||respnoseData&&!respnoseData.length)NotificationService.notify(i18n.i18nString("please_upload_valid_err")+_ext.slice(1).toUpperCase()+i18n.i18nString("file"),"error"),$scope.fileEmptyError=!0;else{console.log("fileobject",fileObject.name),$scope.fileName=fileObject.name,$scope.fileExtensionError=!1;var data=new FormData;data.append("file",fileObject),data.append("fileContext","bulkImport"),data.append("fileExtension",_ext.substring(_ext.lastIndexOf(".")+1)),data.append("Content-Type",fileObject.type),$scope.data=data,$scope.fileObject=fileObject}}},$scope.backup=function(){$scope.importing="backup"},$scope.startImport=function(){$scope.exportingUtter="pending",BTStreamsService.uploadBotFunctionsFile($applicationService.userInfo,$scope.data).then(function(res){var fileUploaded={fileName:$scope.fileObject.name,fileId:res.data.fileId};BTFlowtaskService.startImporting($applicationService.userInfo().userId,streamId,fileUploaded).then(function(res){res&&res.data&&($scope.streamRefId=res.data._id||"",$scope.statusLogs=res.data.statusLogs||[],"pending"===res.data.status?($scope.importing=res.data.status,$scope._importStatusInit=startPollImportStatus(3e3)):stopImportBotPolling("success"===res.data.status?"success":"failed"))},function(err){$scope.importing="failed",$scope.errorMsg=err.data.errors,$scope.exportingUtter="failed"})})},$scope.downloadLog=function(){$(".import-utterance-modal").modal("hide"),writeAndDownloadLog("botImportLog.json",JSON.stringify($scope.statusLogs)),loadingEntities($workflowService.selectedStream()._id),$scope.importing="initial",$scope.removeFile()},$scope.moveForward=function(step){$scope.importing=step,"initial"==step&&$scope.removeFile()},$scope.goToStep=function(step){"initial"==step&&$scope.moveForward(step)},$scope.backupUtterance=function(filetype){function startExport(){var reqStatus="published"===$scope.filterToggle?"published":"indevelopment"===$scope.filterToggle?"configured":reqStatus;BTStreamsService.utteranceExport($applicationService.userInfo().userId,streamId,reqStatus,filetype).then(function(response){response&&response.data&&("pending"===response.data.status?($scope.exporting=response.data.status,$scope._exportStatusInit=startPollExportStatus(3e3)):"success"===response.data.status?stopExportBotPolling("success"):"failed"===response.data.status&&stopExportBotPolling("success"))},function(error){if(error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("unexpected_err_while_backing_err_noty"),"error")})}function cancleExport(){}function checkBoxCb(checkValue){console.log(checkValue),$scope._constants_.updateDownloadPopUppreferance(checkValue)}$scope._constants_.config.showDownloadPopUps?NotificationService.userConfirm($scope._constants_.downloadPopUpMsg,[startExport,cancleExport],{okText:i18n.i18nString("confirm"),checkBox:{enable:!0,checkBoxCb:checkBoxCb}},"",void 0,i18n.i18nString("export_utterance")):startExport()},$scope.onmMenuOptionClicked=function(e){if(e.stopPropagation(),e.currentTarget){var _currEle=$(e.currentTarget);_currEle.siblings().removeClass("active"),_currEle.addClass("active"),_currEle.find(".dropdown").addClass("open")}},$scope.showCSVModal=function(){$(".export-csv-modal").modal("show")},$scope.canelExportCsv=function(){$(".export-csv-modal").modal("hide")},$scope.gSearchSelect&&($scope.gSearchSelect.showUtteranceInternalHeader=$scope.showUtteranceInternalHeader),$scope.$emit("nestedComponentLoaded",{id:"machineLearningUtterances",flag:!1}),$timeout(function(){$scope.$emit("gSearchLoad")}),$scope.getTaskType=function(task){return task&&task.hasOwnProperty("alertFieldsDefinition")?"alert":task&&task.hasOwnProperty("isReport")?task.isReport?"information":"action":task&&"DialogIntent"==task.taskType?"flowtask":""},$scope.cancel=function(){},$scope.upgradeWorkflow=function(task,type){"alert"===type?BTAlertsService.upgradeBTAlert(task._id).then(function(response){BTAlertsService.upgradeMPAlert(task._id,response.data._id).then(function(upgradeRes){BTAlertsService.configured(upgradeRes.data._id).then(function(configRes){loadingEntities($scope.streamId,type),$scope.isGlobalWorkProgress=!1,NotificationService.notify(i18n.i18nString("upgraded_success"),"success"),$scope.displayMode="FULL"},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"action"===type||"information"===type?BTActionsService.upgradeBTAction(task._id).then(function(response){BTActionsService.upgradeMPAction(task._id,response.data._id).then(function(upgradeRes){BTActionsService.configured(upgradeRes.data._id).then(function(configRes){loadingEntities($scope.streamId),$scope.isGlobalWorkProgress=!1},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")}):"flowtask"===type&&BTFlowtaskService.upgradeFlowtask($workflowService.selectedStream()._id,task.dialogId).then(function(res){$scope.isGlobalWorkProgress=!1,loadingEntities($scope.streamId),NotificationService.notify(i18n.i18nString("upgraded_success"),"success")},function(err){$scope.isGlobalWorkProgress=!1,NotificationService.notify(err.data.errors[0].msg,"error")})},$scope.upgrade=function(){$scope.isGlobalWorkProgress=!0,$scope.loaderMessage="Upgrading task..";var taskType=$scope.getTaskType($scope.selectedIntent);$scope.upgradeWorkflow($scope.selectedIntent,taskType)},$scope.upgradeAlertTask=function(){$scope.isGlobalWorkProgress=!0,$scope.loaderMessage="Upgrading task..";var taskType=$scope.getTaskType($scope.selectedTask);$scope.upgradeWorkflow($scope.selectedTask,taskType)},$scope.onClickIntent=function(e,intent,index,type){e&&(e.stopPropagation(),e.stopImmediatePropagation()),$scope.selectedIntent=intent,$scope.callback.showTrainBtn=$scope.showTrainBtn,$scope.selectedTask=_.filter($scope.totalTasks,{_id:intent._id})[0],$scope.selectedIntent&&-1===$scope.selectedIntent.type.indexOf(_alertActionArray)&&($scope.selectedIntent.patternsArray=[],$scope.selectedIntent.negativePatternsArray=[],$scope.selectedIntent.patterns=intent.patterns||[],$scope.selectedIntent.negativePatterns=intent.negativePatterns||[],$scope.selectedIntent.patterns.forEach(function(msg){msg.original=decodePattern(msg.original),$scope.selectedIntent.patternsArray.push(msg.original)}),$scope.selectedIntent.negativePatterns.forEach(function(msg){msg.original=decodePattern(msg.original),$scope.selectedIntent.negativePatternsArray.push(msg.original)})),$scope.callback.getUtterances($scope.selectedIntent,$scope.callback),$scope.callback.checkMLSyncStatus(),$(".builderMaincontainer").addClass("showBot");var _obj={showTrainBtn:$scope.showTrainBtn,showTrainSavingDiv:$scope.showTrainSavingDiv,trainStatus:$scope.trainStatus};switch(type){case"utterances":$scope.callback.showActiveType("utterances",null,_obj);break;case"patterns":$scope.selectedIntent.intentSection="patterns",$scope.callback.showActiveType("patterns",null,_obj);break;case"rules":$scope.selectedIntent.intentSection="traits",$scope.callback.showActiveType("rules",null,_obj);break;default:$scope.callback.showActiveType("utterances")}$scope.closeUtteranceDropdown(),$scope.modalSlider.open("#trainingFullModal");var _botInfo={streamId:$workflowService.selectedStream()._id,BotName:$workflowService.selectedStream().name};mixPanel.postEvent("Add ML Utterance",_botInfo)};var dialogIntent=function(){return $scope.tasks=$filter("orderBy")($scope.tasks,"name"),_.filter($scope.tasks,function(task){return"DialogIntent"===task.taskType&&!task.isSubIntent&&!task.subDialogIntent&&$scope.filterFn(task)})},subDialogIntent=function(){return $scope.tasks=$filter("orderBy")($scope.tasks,"name"),_.filter($scope.tasks,function(task){return"DialogIntent"===task.taskType&&task.subDialogIntent&&$scope.filterFn(task)})},subIntent=function(){return $scope.subIntentData=$filter("orderBy")($scope.subIntentData,"name"),_.filter($scope.subIntentData,function(task){return task.isSubIntent&&$scope.filterFn(task)})},alertTask=function(){return $scope.tasks=$filter("orderBy")($scope.tasks,"name"),_.filter($scope.tasks,function(task){return"alert"===task.taskType&&$scope.filterFn(task)})},actionTask=function(){return $scope.tasks=$filter("orderBy")($scope.tasks,"name"),_.filter($scope.tasks,function(task){return"action"===task.taskType&&$scope.filterFn(task)})},informationTask=function(){return $scope.tasks=$filter("orderBy")($scope.tasks,"name"),_.filter($scope.tasks,function(task){return"information"===task.taskType&&$scope.filterFn(task)})},allIntent=function(){return $scope.tasks=$filter("orderBy")($scope.tasks,"name"),$scope.tasks.filter(function(task){return $scope.filterFn(task)})},mapTasks={dialogIntent:dialogIntent,subDialogIntent:subDialogIntent,subIntent:subIntent,alertTask:alertTask,allIntent:allIntent,actionTask:actionTask,informationTask:informationTask};$scope.concatTasks=function(offset,limit){$scope.concatedTasks=[],$scope._selectedFilters=_.filter($scope.supportedIntents,{selected:!0});for(var i=0;i<$scope._selectedFilters.length;i++)$scope.concatedTasks=$scope.concatedTasks.concat(mapTasks[$scope._selectedFilters[i].key]()),$scope.concatedTasks=_.unique($scope.concatedTasks,"_id");return $scope._selectedFilters.length?loadUITasks($scope.concatedTasks,offset,limit):loadUITasks(mapTasks.allIntent(),offset,limit)},$scope.selectIntentType=function(e){e&&(e.stopPropagation(),e.stopImmediatePropagation()),$scope.concatTasks(),$(".utteranceScrollContainer").animate({scrollTop:0})},$scope.removeFilterTag=function(i,selectedFilter){var toRemoveIndex=_.findIndex($scope._selectedFilters,function(filter){return filter===selectedFilter}),intentFound=_.find($scope.supportedIntents,{key:selectedFilter.key});intentFound&&(intentFound.selected=!1),$scope._selectedFilters.splice(toRemoveIndex,1),$scope.selectIntentType()},$scope.clearFilters=function(){$scope._selectedFilters=[],loadUITasks(mapTasks.allIntent()),$scope.supportedIntents.forEach(function(intent){intent.selected=!1})},$scope.updateClientBatch=function(batchSize){$scope.search.searchTask?$scope.uiCopyTasks=$scope.uiCopyTasks.concat($scope.totalSearchRecords.slice($scope.uiCopyTasks.length,$scope.uiCopyTasks.length+batchSize)):$scope.uiCopyTasks=$scope.uiCopyTasks.concat($scope.concatTasks($scope.uiCopyTasks.length,$scope.uiCopyTasks.length+batchSize))},$scope.clearSearch=function(e){e&&e.stopPropagation(),$scope.gSearchCb.search=""},$scope.clearSearchUtter=function(e){e&&e.stopPropagation(),$scope.search.searchTask="",$(".utteranceScrollContainer").animate({scrollTop:0}),$scope.concatTasks(),setTimeout(function(){$scope.loadingWarnings=!1},300)},$scope.searchTasks=function(e,searchQuery){if($scope.search.searchTask=angular.copy(searchQuery),e&&13===e.keyCode&&searchQuery.length){$scope.loadingWarnings=!0;var _totalTasks=$scope.tasks;$scope.totalSearchRecords=_.filter(_totalTasks,function(task){var _expTask=new RegExp(searchQuery,"i"),searchResult=_expTask.test(task.intent?task.intent:task.name);return searchResult?task:void 0}),$(".utteranceScrollContainer").animate({scrollTop:0}),$scope.uiCopyTasks=$scope.totalSearchRecords.slice(0,20),setTimeout(function(){$scope.loadingWarnings=!1},200)}else searchQuery.length||($scope.loadingWarnings=!0,$scope.clearSearchUtter())},$scope.callback.updateTrainDetails=function(obj){$scope.showTrainBtn=obj.showTrainBtn,$scope.showTrainSavingDiv=obj.showTrainSavingDiv,$scope.trainStatus=obj.trainStatus,$scope.trainProgressLabel=obj.trainProgressLabel,$(".utteranceScrollContainer").animate({scrollTop:0}),$scope.clearSearch()},$scope.callback.updateTrainBtnDetails=function(obj){$scope.showTrainBtn=obj.showTrainBtn,$scope.trainLabel=obj.trainLabel,$scope.trainStatus=obj.trainStatus,$scope.trainProgressLabel=obj.trainProgressLabel},$scope.callback.loadingEntities=function(streamId,type,data,fromFlag){fetchEntities(streamId,type,data,fromFlag)},$scope.mlInfo.loadingEntities=function(streamId){$scope.select.name="All Intents",$scope.select.key="allIntent",loadingEntities(streamId)};var fetchComponentsByType=function(type){var state="published",_searchQuery=$workflowService.subTabSearchQuery();("indevelopment"===$scope.filterToggle||"configured"===$scope.filterToggle)&&(state="configured"),BTFlowtaskService.getComponentsByTypeAndState($scope.streamId,type,state).then(function(res){$scope._botComponents=[],res&&res.data&&res.data.length>0&&($.each(res.data,function(k,comp){comp.flowtasksInvolved=getNodeUsedList(comp),comp.status===state&&$scope._botComponents.push(comp),comp.status===state&&($scope.componentsCount[comp.type.toLowerCase()]=$scope.componentsCount[comp.type.toLowerCase()]+1)}),$scope._nodes=angular.copy($scope._botComponents)),$timeout(function(){$scope.entityLoading=!1},200),_searchQuery&&_searchQuery.searchQry&&_searchQuery.subTab&&"entity"===_searchQuery.subTab&&$timeout(function(){$("#entityTab").find(".synSearch .searchBar").trigger("click"),$scope.gSearchCb.search=_searchQuery.searchQry,$workflowService.subTabSearchQuery({searchQry:"",subTab:""})},1e3)},function(error){if($scope._botComponents=[],$scope.entityLoading=!1,error&&error.data&&error.data.errors){var _msg=error.data.errors[0].msg;NotificationService.notify(_msg,"error")}else if(error.errors&&_.isArray(error)){var msg=error.errors[0].msg;NotificationService.notify(msg,"error")}else NotificationService.notify(i18n.i18nString("fetch_error"),"error")})},loadFields=function(){$scope.alertActionCopy=$scope.alertActionTasks.filter(function(task){return $scope.filterFn(task)}),$scope._taskFields=[],$scope.alertActionCopy.forEach(function(task){task.fields&&task.fields.length&&$.each(task.fields,function(index,field){field.task={},field.task.name=task.name,field.task.taskId=task._id,field.task.fieldPatterns=task.fieldPatterns,field.task.fieldSynonyms=task.fieldSynonyms,$scope._taskFields.push(field)})}),console.log($scope._taskFields),$timeout(function(){$scope.fieldsLoading=!1},200)},transformBotSynonyms=function(dontAssignTosynonyms){var synonyms=[],_searchQuery=$workflowService.subTabSearchQuery(),synonymKeys=Object.keys($scope.stream.synonyms||{}).sort();synonymKeys.map(function(key){var obj={};obj.key=key,obj.value=_constants_.getAlphabeticallySortedArray($scope.stream.synonyms[key]),synonyms.push(angular.copy(obj))}),dontAssignTosynonyms||($scope.synonyms=angular.copy(synonyms),indexUpdateForBotSynonyms()),$scope.oldSynonyms=angular.copy(synonyms),$scope.synonymsLoading=!1,_searchQuery&&_searchQuery.searchQry&&_searchQuery.subTab&&("botsynonyms"===_searchQuery.subTab?$timeout(function(){$("#botSynonym").find(".synSearch .searchBar").trigger("click"),$scope.gSearchCb.search=_searchQuery.searchQry,$workflowService.subTabSearchQuery({searchQry:"",subTab:""})},3e3):"concepts"===_searchQuery.subTab&&$timeout(function(){$("#concepts").find(".synSearch .searchBar").trigger("click"),$scope.gSearchCb.search=_searchQuery.searchQry,$workflowService.subTabSearchQuery({searchQry:"",subTab:""})},3e3))},closeSearchSlider=function(_ele){_ele.hasClass("fa-remove")&&($(_ele[0]).parent().removeClass("searchExpand"),_ele.removeClass("fa-remove"),_ele.addClass("fa-search"))},openSearchSlider=function(_ele,_searchQuery){_ele.trigger("click"),$scope.gSearchCb.search=_searchQuery.searchQry,$workflowService.subTabSearchQuery({searchQry:"",subTab:""})},globalSearchForInternalTabs=function(_searchQuery){var _ele;_searchQuery&&_searchQuery.searchQry&&_searchQuery.subTab&&"entity"===_searchQuery.subTab?(_ele=$("#entityTab").find(".searchBar"),closeSearchSlider(_ele),$timeout(function(){openSearchSlider(_ele,_searchQuery)},1e3)):_searchQuery&&_searchQuery.searchQry&&_searchQuery.subTab&&("botsynonyms"===_searchQuery.subTab||"concepts"===_searchQuery.subTab)&&("botsynonyms"===_searchQuery.subTab?(_ele=$("#botSynonym").find(".searchBar"),closeSearchSlider(_ele),$timeout(function(){openSearchSlider(_ele,_searchQuery)},3e3)):"concepts"===_searchQuery.subTab&&(_ele=$("#concepts").find(".searchBar"),closeSearchSlider(_ele),$timeout(function(){openSearchSlider(_ele,_searchQuery)},3e3)))},loadAlertTasks=function(cb){BTAlertsService.getAlerts($workflowService.selectedStream()._id).then(function(res){var _alertTasks=res.data;_alertTasks=_alertTasks.map(function(task){return task.taskType="alert",task.intentTypeName="Alert",task.state=task.state.toLowerCase(),("inprogress"===task.state||"suspended"===task.state||"rejected"===task.state)&&(task.hide=!0),task}),_alertTasks=_.filter(_alertTasks,function(d){return!d.hide}),$scope.alertTasks=_alertTasks,$scope.findParenttasks($scope.alertTasks),$scope.alertActionTasks=$scope.alertTasks.filter(function(task){if("action"===task.taskType||"alert"===task.taskType||"information"===task.taskType){_.isArray(task.alertFieldsDefinition)?task.fields=_.clone(task.alertFieldsDefinition||[]):_.isArray(task.payloadField)&&_.isArray(task.queryField)&&(task.fields=(task.payloadField||[]).concat(task.queryField));var patterns=[];return Object.keys(task.fieldPatterns||{}).map(function(field){var valueOfField=[];valueOfField=task.fieldPatterns[field].map(function(pattern){return pattern.original}),valueOfField.length&&patterns.push({key:task.fieldPatterns[field].map(function(pattern){return pattern.key}),fieldName:field,value:valueOfField,oldPatterns:task.fieldPatterns[field]})}),task.field_patterns=patterns,task}}),cb()})};$scope.showActiveType=function(tab){if($scope.views[tab]){var _searchQuery=$workflowService.subTabSearchQuery();return void(_searchQuery&&globalSearchForInternalTabs(_searchQuery))}switch(Object.keys($scope.views).forEach(function(view){$scope.views[view]=!1}),$scope.views[tab]=!0,$scope.activeTab=tab,tab){case"intents":loadingEntities($scope.streamId);break;case"entity":$scope.flowTasks=$workflowService.dialogTasks(),$scope.synonymsTemplateUrl=window.appConfig.TMPLT_PRE_PATH+"js/forms/synonyms-module/synonyms-module-entity.html",$scope.entityLoading=!0,fetchComponentsByType(tab);break;case"fields":$scope.fieldsLoading=!0,$scope.synonymsTemplateUrl=window.appConfig.TMPLT_PRE_PATH+"js/forms/synonyms-module/synonyms-module-entity.html",loadAlertTasks(loadFields);break;case"botsynonyms":$scope.synonymsLoading=!0,transformBotSynonyms();break;case"concepts":$scope.synonymsLoading=!0,transformBotSynonyms();break;case"traits":$scope.traitTemplateUrl=window.appConfig.TMPLT_PRE_PATH+"js/forms/bt-traits/bt-traits-training.html"}};var invokeEditSlider=function(){$scope.openModalSlider("#editSlider"),$scope.currentEditTask&&$scope.currentEditTask.patterns&&($scope.currentEditTask.patternsArray=[],$scope.currentEditTask.patterns.map(function(pattern){$scope.currentEditTask.patternsArray.push(pattern.original)})),$scope.setEditActive("synonyms",$scope.currentType)};$("body").off("click").on("click",".fieldEditView",function(){$timeout(function(){$(".cancleUserConfirm").click(),$scope.upgradeViewMode="VIEW",invokeEditSlider()})}),$scope.openEditSlider=function(node,type){if($scope.editViews={synonyms:!0,patterns:!1},$scope.currentEditTask=node,$scope.currentType=type,"fields"===type){var _taskObj=_.find($scope.alertActionCopy,{_id:node.task.taskId});if($scope.selectedTask=angular.copy(_taskObj),node.task.fields=_taskObj.fields,"indevelopment"===$scope.filterToggle){var key="state";if("published"==_taskObj[key])return void NotificationService.userConfirm(i18n.i18nString("userconfirm_publish")+"</br>"+i18n.i18nString("upgrade_permission")+'</br><br></br><span class="grayInfoText">'+i18n.i18nString("alternatively")+'</br><span id="fieldEditView" class="marginLeft5 bthelpLinksTextcolor pointer-hand fieldEditView">'+i18n.i18nString("view_publish_version")+"</span></span>",[$scope.upgradeAlertTask,$scope.cancel],{okText:i18n.i18nString("upgrade"),addHtmlContent:!0},"",void 0,i18n.i18nString("confirm_proceed"));$scope.upgradeViewMode="FULL"}}invokeEditSlider()},$scope.closeEditTraining=function(){$timeout(function(){$scope.entityLoading=!1,removeTagValidation()},300),$scope.entityLoading=!0,$scope.closeModalSlider("#editSlider")},$scope.closeEditTrainingFields=function(){$timeout(function(){$scope.fieldsLoading=!1,removeTagValidation()},300),$scope.fieldsLoading=!0,$scope.closeModalSlider("#editSlider")},$scope.setEditActive=function(tab,type){switch(Object.keys($scope.editViews).forEach(function(view){$scope.editViews[view]=!1}),$scope.editViews[tab]=!0,type=$scope.activeTab,!0){case"patterns"===tab&&"entity"===type:$scope.patternsCB.loadingPatterns=!0,$scope.patternsCB.onClickEntity($scope.currentEditTask,"DialogEntity");break;case"synonyms"===tab&&"entity"===type:$scope.synonymsCB.type="entity",$scope.synonymsCB.loadingSynonyms=!0,setTimeout(function(){$scope.synonymsCB.changeEditEntitySynonym($scope.currentEditTask)},500);break;case"synonyms"===tab&&"fields"===type:$scope.synonymsCB.type="fields",setTimeout(function(){$scope.synonymsCB.changeEditFieldSynonym($scope.currentEditTask.task,void 0,$scope.upgradeViewMode)},500);break;case"patterns"===tab&&"fields"===type:$scope.patternsCB.loadingPatterns=!0,$scope.patternsCB.onClickField($scope.currentEditTask.task,$scope.currentEditTask.title)}$(".edit-modal").animate({scrollTop:0})},$scope.openEditSynonymSlider=function(currentEditSynonym){currentEditSynonym&&($scope.currentEditSynonym=angular.copy(currentEditSynonym),$scope.editSynonymCopy=angular.copy(currentEditSynonym)),$scope.openModalSlider("#editSynonymSlider")},$scope.closeEditSynonym=function(){$timeout(function(){$scope.synonymsLoading=!1,removeTagValidation()},300),$scope.synonymsLoading=!0,$scope.closeModalSlider("#editSynonymSlider")},$scope.closeTrainingModalSlider=function(){$scope.closeModalSlider("#trainingFullModal")},$scope.createSynonym=function(){$scope.openModalSlider("#createSynonymSlider"),
$scope.views&&$scope.views.concepts?$scope.manageBotSynonym.keyword="~":$scope.manageBotSynonym.keyword="",setTimeout(function(){$("#editInput").focus()},200)},$scope.closeCreateSynonym=function(){$scope.manageBotSynonym={},$scope.manageBotSynonym.synonyms=[],$timeout(function(){$scope.synonymsLoading=!1,removeTagValidation()},300),$scope.synonymsLoading=!0,$scope.closeModalSlider("#createSynonymSlider")};var saveSynonyms=function(){$timeout(function(){if($scope.manageBotSynonym.synonyms.length>1){var _editSynonym=_.find($scope.synonyms,{key:$scope.manageBotSynonym.keyword});_editSynonym&&(_editSynonym.value=$scope.manageBotSynonym.synonyms),$scope.saveBotSynonym()}else saveManageBotSynonyms()})};$scope.saveManageBotTaskSynonym=function(){return $scope.views.botsynonyms&&$scope.manageBotSynonym.keyword.startsWith("~")?(_mode="create",void $("#warningSynonymModal").modal("show")):void saveSynonyms()},$scope.saveAsConcepts=function(){"create"===_mode?$scope.manageBotSynonym&&$scope.manageBotSynonym.keyword&&$scope.manageBotSynonym.keyword.length>0&&(saveSynonyms(),$timeout(function(){$scope.closeCreateSynonym()},200)):"edit"===_mode&&$scope.currentEditSynonym&&$scope.currentEditSynonym.key&&$scope.currentEditSynonym.key.length>0&&($scope.updateSynonyms(),$timeout(function(){$scope.closeEditSynonym()},200)),$("#warningSynonymModal").modal("hide")},$scope.closeSynonymModal=function(){$("#warningSynonymModal").modal("hide"),"create"===_mode?$scope.manageBotSynonym.keyword=$scope.manageBotSynonym.keyword.substr(1,$scope.manageBotSynonym.keyword.length):"edit"===_mode&&($scope.currentEditSynonym.key=$scope.currentEditSynonym.key.substr(1,$scope.currentEditSynonym.key.length)),saveSynonyms()},$scope.proceedAsConcept=function(){$scope.saveAsConcepts(),Object.keys($scope.views).forEach(function(view){$scope.views[view]=!1}),$scope.views.concepts=!0,$scope.activeTab="concepts"},$scope.showEmojiModal=function(){$("#emojiModal").modal("show")},$scope.loadEmojis=function(){BTStreamsService.importEmojis($workflowService.selectedStream()._id).then(function(res){res&&res.data&&res.data.synonyms&&($scope.stream.synonyms=res.data.synonyms),transformBotSynonyms(),$("#emojiModal").modal("hide"),NotificationService.notify(i18n.i18nString("bot_train"),"info"),NotificationService.notify(i18n.i18nString("emojiImportedInfo"),"info")},function(err){err&&err.data&&err.data.errors&&err.data.errors.length>0&&err.data.errors[0]&&err.data.errors[0].msg?NotificationService.notify(err.data.errors[0].msg,"error"):NotificationService.notify(i18n.i18nString("bot_train_failure"),"error")})},$scope.updateSynonyms=function(type){$timeout(function(){var _synonym=_.find($scope.synonyms,{key:$scope.editSynonymCopy.key});_synonym&&(_synonym.key=$scope.currentEditSynonym.key,_synonym.value=$scope.currentEditSynonym.value),$scope.saveBotSynonym(type)})},$scope.saveBotSynonym=function(type){type?$scope.synUpdateMsg=i18n.i18nString("synonyms_deleted_success"):$scope.synUpdateMsg=i18n.i18nString("synonyms_added_sucess"),setTimeout(function(){saveTaskSynonyms(null,null,null,!0,"",type)},500)},$scope.saveEditBotSynonym=function(type){return $scope.views.botsynonyms&&$scope.currentEditSynonym&&$scope.currentEditSynonym.key&&$scope.currentEditSynonym.key.startsWith("~")?(_mode="edit",void $("#warningSynonymModal").modal("show")):void $scope.updateSynonyms(type)},$scope.deleteSynonym=function(deletedSynonym,type,$event){function deleteSynonym(){var synonyms=angular.copy($scope.synonyms);synonyms.splice(index,1),BTStreamsService.postSynonyms($scope.stream._id,{synonyms:transformSynonymsToObject(synonyms)}).then(function(res){$scope.synonyms.splice(index,1),$scope.stream=res.data,$workflowService.nlpStream($scope.stream),$workflowService.selectedStream($scope.stream),$scope.oldSynonyms=angular.copy($scope.synonyms),"synonym"===type?NotificationService.notify(i18n.i18nString("synonyms_deleted_success"),"success"):"concept"===type&&NotificationService.notify(i18n.i18nString("concept_deleted_success"),"success"),$scope.enableSynonyms&&($scope.trainShow=!0),indexUpdateForBotSynonyms()},function(err){var msg=getErrorMsg(err,i18n.i18nString("synonyms_added_failure"));NotificationService.notify(msg,"error")})}$event.stopPropagation();var index=-1;$scope.synonyms.map(function(synonym,i){synonym.key==deletedSynonym.key&&(index=i)});$scope.synonyms[index];"synonym"===type?NotificationService.alert(i18n.i18nString("do_you_really_want_to_del_noty"),deleteSynonym,[$scope.stream._id,null,null,!0]):"concept"===type&&NotificationService.alert(i18n.i18nString("do_you_really_want_to_del_noty_concept"),deleteSynonym,[$scope.stream._id,null,null,!0])},$scope.restrictDeletingTilde=function(e,keyword,type){if("concepts"!==type||!keyword||1!==keyword.length||"~"!==keyword||8!==e.keyCode&&46!==e.keyCode){if("synonyms"===type&&keyword.startsWith("~")&&13===e.keyCode&&keyword.length>1)return _mode="edit",void $("#warningSynonymModal").modal("show");13===e.keyCode&&keyword.length>1&&"concepts"===type?$scope.saveEditBotSynonym():13===e.keyCode&&keyword.length>0&&!keyword.startsWith("~")&&"synonyms"===type&&$scope.saveEditBotSynonym()}else e.preventDefault()},$scope.validateTilde=function(e,keyword){!keyword||1!==keyword.length||"~"!==keyword||8!==e.keyCode&&46!==e.keyCode||e.preventDefault()},$scope.createNewTraits=function(){$timeout(function(){$scope.traitsCb.createNewTraits()})};var updateStatus=function(status){$scope.saveStatus=status};$scope.onInvalidTag=function(){$scope.isInvalidTag=!0},$scope.updateTrainDataDetails=function(intentData){$scope.cb&&$scope.cb.updateTrainDataDetails&&$scope.cb.updateTrainDataDetails(intentData)},$scope.updateIntentData=function(trainData){$scope.cb&&$scope.cb.updateIntentData&&$scope.cb.updateIntentData(trainData)},$scope.deleteEnabledNotification=function(){$scope.notificationEnabled=!1,$scope.notificationInputEnabled=!0},$scope.closeWarningNotification=function(){$scope.notificationInputEnabled=!1},$scope.closeUtteranceDropdown=function(){$(".taskSelectContainer .kr-sg-dropdowns .dropdown.dropdown-open.open").length&&$(".taskSelectContainer .kr-sg-dropdowns .dropdown.dropdown-open.open").removeClass("open")},$scope.multiLinguale={};var enabledSupportedLanguages=$workflowService.currentLanguage();$workflowService.selectedStream()&&$workflowService.selectedStream().multiLingualConfigurations&&$workflowService.selectedStream().multiLingualConfigurations[enabledSupportedLanguages]&&$workflowService.selectedStream().multiLingualConfigurations[enabledSupportedLanguages].inputTranslation||$workflowService.selectedStream()&&$workflowService.selectedStream().multiLingualConfigurations&&$workflowService.selectedStream().multiLingualConfigurations[enabledSupportedLanguages]&&$workflowService.selectedStream().multiLingualConfigurations[enabledSupportedLanguages].nluLanguage&&"ge"===$workflowService.selectedStream().multiLingualConfigurations[enabledSupportedLanguages].nluLanguage?($scope.multiLinguale.inputTranslation=!0,$scope.multiLinguale.language=$workflowService.selectedStream().multiLingualConfigurations[enabledSupportedLanguages].nluLanguage):$scope.multiLinguale.inputTranslation=!1,$scope.configureInputTranslation=function(){$scope.rightPanelCb&&$scope.rightPanelCb.showView&&($workflowService.storeSearchQry({userSearchQueryFlag:!0,searchQry:"openInputTranslation"}),$scope.rightPanelCb.showView("languageManagement"))},$scope.synonymsCB.updateStatus=updateStatus,$scope.callback.closeTrainingModalSlider=$scope.closeTrainingModalSlider,$scope.cb&&($scope.cb.fetchIntents=fetchIntents,$scope.cb.trainBot=$scope.trainBot,$scope.cb.loadingEntities=loadingEntities),$scope.traitsCb.prepareTrainLabel=prepareTrainLabel,$scope.callback.fetchMLStatus=checkMLSyncStatus,$scope.rightPanelCb&&($scope.rightPanelCb.showActiveType=$scope.showActiveType,$scope.rightPanelCb.clearSearch=$scope.clearSearch),$scope.callback.updateTrainDataDetails=$scope.updateTrainDataDetails,$scope.callback.updateIntentData=$scope.updateIntentData}])}(angular);